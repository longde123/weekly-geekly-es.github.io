<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßëüèø‚Äçü§ù‚Äçüßëüèº üë®üèº‚Äçüîß üì™ C√≥mo extender Kubernetes ‚ûï üôá üëÖ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hoy hablaremos sobre DevOps, o m√°s bien, principalmente sobre Ops. Dicen que hay muy pocas personas que est√©n satisfechas con el nivel de automatizaci...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>C√≥mo extender Kubernetes</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/jugru/blog/424609/">  Hoy hablaremos sobre DevOps, o m√°s bien, principalmente sobre Ops.  Dicen que hay muy pocas personas que est√©n satisfechas con el nivel de automatizaci√≥n de sus operaciones.  Pero la situaci√≥n parece ser reparable.  En este art√≠culo, Nikolai Ryzhikov hablar√° sobre su experiencia con la expansi√≥n de Kubernetes. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b1a/4f7/1a2/b1a4f71a2809a5b098e738ed4e0b5d3f.png"><br><br>  El material fue preparado sobre la base del discurso de Nikolai en la conferencia de oto√±o DevOops 2017. Bajo el corte: transcripci√≥n de video y texto del informe. <br><a name="habracut"></a><br><iframe width="560" height="315" src="https://www.youtube.com/embed/3BMTNx2xCtQ" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  <i>Actualmente, Nikolai Ryzhikov est√° trabajando en el sector de TI de Salud para crear sistemas de informaci√≥n m√©dica.</i>  <i>Miembro de la comunidad de programadores funcionales de San Petersburgo FPROG.</i>  <i>Miembro activo de la comunidad Online Clojure, miembro del est√°ndar de intercambio de informaci√≥n m√©dica HL7 FHIR.</i>  <i>Ha estado programando durante 15 a√±os.</i> <br><hr><br>  ¬øQu√© lado tenemos para DevOps?  Durante 10 a√±os, nuestra f√≥rmula DevOps ha sido bastante simple: los desarrolladores son responsables de las operaciones, los desarrolladores se implementan, los desarrolladores se mantienen.  Con este arreglo, que se ve un poco duro, en cualquier caso, se convertir√° en DevOps.  Si desea implementar DevOps de forma r√°pida y dolorosa, haga que los desarrolladores sean responsables de su producci√≥n.  Si los muchachos son inteligentes, comenzar√°n a salir y entender todo. <br><img src="https://habrastorage.org/getpro/habr/post_images/8f4/799/e0d/8f4799e0d6f25b897b6bd72f2ba1081a.png"><br>  Nuestra historia: hace mucho tiempo, cuando no hab√≠a Chef y automatizaci√≥n, ya implementamos Capistrano autom√°tico.  Luego comenzaron a aburrirlo, para que √©l hiciera moda.  Pero entonces apareci√≥ Chef.  Nos cambiamos a √©l y nos fuimos a la nube: est√°bamos cansados ‚Äã‚Äãde nuestros centros de datos.  Entonces apareci√≥ Ansible, Docker se levant√≥.  Despu√©s de eso, nos mudamos a Terraform con el supervisor de estibador de condominios escrito a mano en Camel.  Y ahora nos estamos mudando a Kubernetes. <br><img src="https://habrastorage.org/getpro/habr/post_images/366/af1/be8/366af1be8b4c4cf204553b48c8a76e70.png"><br>  ¬øQu√© es lo peor de las operaciones?  Muy pocas personas est√°n satisfechas con el nivel de automatizaci√≥n de sus operaciones.  Esto es aterrador, confirmo: gastamos muchos recursos y esfuerzos para recolectar todas estas pilas para nosotros, y el resultado es insatisfactorio. <br><br>  Existe la sensaci√≥n de que con el advenimiento de Kubernetes, algo puede cambiar.  Estoy comprometido con la fabricaci√≥n ajustada y, desde su punto de vista, las operaciones generalmente no son √∫tiles.  Las operaciones ideales son la ausencia o el m√≠nimo de operaciones en un proyecto.  El valor se crea cuando un desarrollador hace un producto.  Cuando est√° listo, la entrega no agrega valor.  Pero necesita reducir costos. <br><img src="https://habrastorage.org/getpro/habr/post_images/731/1a4/6e3/7311a46e3eb4d1d73d788f6ee881be3a.png"><br>  Para m√≠, el ideal siempre fue heroku.  Lo usamos para aplicaciones simples, donde el desarrollador para implementar su servicio, fue suficiente para decir git push y configurar heroku.  Toma un minuto <br><img src="https://habrastorage.org/getpro/habr/post_images/a57/4c0/12b/a574c012ba1158086cd3578287d6d2a9.png"><br>  Como ser  Puedes comprar NoOps, tambi√©n heroku.  Y le aconsejo que compre, de lo contrario existe la posibilidad de gastar m√°s dinero en el desarrollo de operaciones normales. <br><br>  Hay muchachos Deis, est√°n tratando de hacer algo como heroku en Kubernetes.  Hay fundici√≥n en la nube, que tambi√©n proporciona una plataforma en la que trabajar. <br><img src="https://habrastorage.org/getpro/habr/post_images/bbd/7b9/7e0/bbd7b97e07aae6af9a54663d633e3cc2.png"><br>  Pero si te molestas con algo m√°s complejo o grande, puedes hacerlo t√∫ mismo.  Ahora, junto con Docker y Kubernetes, se convierte en una tarea que se puede completar en un tiempo razonable y a un costo razonable.  Sol√≠a ‚Äã‚Äãser demasiado duro. <br><img src="https://habrastorage.org/getpro/habr/post_images/299/2d2/90a/2992d290a7167b9fe4a8cf2320528b8e.png"><br><h2>  Un poco sobre Docker y Kubernetes </h2><br>  Uno de los problemas de las operaciones es la repetibilidad.  La gran cosa que trajo el acoplador es de dos fases.  Tenemos una fase de construcci√≥n. <br><br>  El segundo punto que agrada en la ventana acoplable es una interfaz universal para lanzar servicios arbitrarios.  Alguien ensambl√≥ Docker, coloc√≥ algo dentro y las operaciones son suficientes para decir que Docker corre y comienza. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0b4/ca2/5ad/0b4ca25ade4ae7d3513539aaa576d3e7.png"><br><br>  ¬øQu√© es kubernetes?  As√≠ que creamos Docker y necesitamos lanzarlo, integrarlo, configurarlo y conectarlo con otros en alg√∫n lugar.  Kubernetes te permite hacer esto.  Introduce una serie de abstracciones, que se denominan "recurso".  Los revisaremos r√°pidamente e incluso intentaremos crear. <br><br><h2>  Abstracci√≥n </h2><br>  La primera abstracci√≥n es un POD o un conjunto de contenedores.  Bien hecho, qu√© es exactamente un <b>conjunto de</b> contenedores, y no uno.  Los conjuntos pueden revolver entre ellos vol√∫menes que se ven a trav√©s de localhost.  Esto le permite usar un patr√≥n como el sidecar (esto es cuando lanzamos el contenedor principal, y hay contenedores auxiliares cercanos que lo ayudan). <br><br>  Por ejemplo, el enfoque de embajador.  Esto es cuando no desea que el contenedor piense d√≥nde se encuentran algunos servicios.  Pones un contenedor al lado que sabe d√≥nde est√°n estos servicios.  Y est√°n disponibles para el contenedor principal en localhost.  Por lo tanto, el entorno comienza a parecer que est√° trabajando localmente. <br><img src="https://habrastorage.org/getpro/habr/post_images/0b8/ab5/bda/0b8ab5bdae5f0d0e7375ff1b08efc6ee.png"><br>  Levantemos el POD y veamos c√≥mo se describe.  Localmente puedes desarrollar minikube.  Consume un mont√≥n de CPU, pero le permite levantar un peque√±o cl√∫ster de Kubernetes en una caja virtual y trabajar con √©l. <br><br>  Implementemos POD.  Dije que Kubernetes se aplic√≥ e inund√≥ el POD.  Puedo ver qu√© POD tengo: veo que un POD est√° implementado.  Esto significa que Kubernetes ha lanzado estos contenedores. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/970/862/d90/970862d90a9afea1066caa69c1af63c8.png"></div><br>  Incluso puedo entrar en este contenedor. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/122/603/8f7/1226038f78d2c9593826e7f26d611853.png"></div><br>  Desde esta perspectiva, Kubernetes est√° hecho para personas.  De hecho, lo que hacemos constantemente en las operaciones, en el enlace de Kubernetes, por ejemplo, usando la utilidad kubectl, se puede hacer f√°cilmente. <br><br>  Pero POD es mortal.  Comienza como una ejecuci√≥n de Docker: si alguien lo detiene, nadie lo levantar√°.  Adem√°s de esta abstracci√≥n, Kubernetes comienza a construir lo siguiente, por ejemplo, un conjunto de r√©plicas.  Este es un supervisor que monitorea los POD, monitorea su n√∫mero, y si los POD caen, los levanta.  Este es un importante concepto de autocuraci√≥n en Kubernetes que le permite dormir tranquilo por la noche. <br><br>  Sobre el conjunto de r√©plicas hay una abstracci√≥n de la implementaci√≥n, tambi√©n un recurso que le permite realizar una implementaci√≥n de tiempo cero.  Por ejemplo, un conjunto de r√©plicas funciona.  Cuando implementamos y cambiamos la versi√≥n del contenedor, por ejemplo el nuestro, dentro de la implementaci√≥n, se eleva otro conjunto de r√©plicas.  Esperamos hasta que estos contenedores comiencen, pasamos por sus comprobaciones de estado y luego cambiamos r√°pidamente al nuevo conjunto de r√©plicas.  Tambi√©n cl√°sico y buenas pr√°cticas. <br><img src="https://habrastorage.org/getpro/habr/post_images/02e/d07/f33/02ed07f333733af0155ee539be18c669.png"><br>  Tomemos un servicio simple.  Por ejemplo, tenemos una implementaci√≥n.  En el interior, describe el patr√≥n de POD que recoger√°.  Podemos aplicar esta implementaci√≥n, ver lo que tenemos.  Buena caracter√≠stica de Kubernetes: todo se encuentra en la base de datos y podemos ver lo que sucede en el sistema. <br><br>  Aqu√≠ vemos una implementaci√≥n.  Si tratamos de mirar los POD, vemos que algunos POD han aumentado.  Podemos tomar y eliminar este POD.  ¬øQu√© les sucede a los POD?  Uno es destruido, y el segundo se levanta inmediatamente.  Este controlador de r√©plica no encontr√≥ el POD deseado y lanz√≥ otro. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/524/7f4/0d4/5247f40d4fb21eb93bda0ce14124245e.png"></div><br>  Adem√°s, si se trata de alg√∫n tipo de servicio web, o dentro de nuestros servicios debe comunicarse, necesitamos un descubrimiento de servicio.  Debe dar al servicio un nombre y un punto de entrada.  Kubernetes ofrece un recurso llamado servicio para esto.  Puede manejar el equilibrio de carga y ser responsable del descubrimiento del servicio. <br><img src="https://habrastorage.org/getpro/habr/post_images/2fa/926/6e5/2fa9266e57c6718a81241ae1ac15da8e.png"><br>  Veamos un servicio simple.  Lo conectamos con la implementaci√≥n y los POD a trav√©s de etiquetas: un enlace tan din√°mico.  Un concepto muy importante en Kubernetes: el sistema es din√°mico.  No importa en qu√© orden se crear√° todo esto.  El servicio intentar√° encontrar POD con tales etiquetas y comenzar√° su equilibrio de carga. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b48/992/f7d/b48992f7dca832fce9b45276936a4914.png"></div><br>  Aplica el servicio, mira qu√© servicios tenemos.  Entramos en nuestro POD de prueba, que se plante√≥, y hacemos nslookup.  Kubernetes nos proporciona un DNS-ku a trav√©s del cual los servicios pueden verse y descubrirse entre s√≠. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b05/66f/01e/b0566f01e54210ea26c5b6526b0ed0de.png"></div><br>  El servicio es m√°s bien una interfaz.  Hay varias implementaciones diferentes, porque las tareas de equilibrio de carga y servicio son bastante complicadas: de una manera, trabajamos con bases de datos ordinarias, en la otra con las cargadas, y algunas simples se hacen bastante simples.  Este es tambi√©n un concepto importante en Kubernetes: algunas cosas pueden llamarse interfaces en lugar de implementaciones.  No est√°n fijados r√≠gidamente y son diferentes, por ejemplo, los proveedores de la nube ofrecen implementaciones diferentes.  Es decir, por ejemplo, hay un volumen persistente de recursos, que ya est√° implementado en cada nube en particular por sus medios regulares. <br><br>  A continuaci√≥n, generalmente queremos sacar el servicio web.  Kubernetes tiene una abstracci√≥n de entrada.  Por lo general, se agrega SSL all√≠. <br><img src="https://habrastorage.org/getpro/habr/post_images/fc7/69e/4e7/fc769e4e7a526588c3f3ae32388d9c11.png"><br>  La entrada m√°s simple se parece a esto.  All√≠ escribimos las reglas: para qu√© URL, para qu√© hosts, a qu√© servicio interno redirigir la solicitud.  Del mismo modo, podemos aumentar nuestra entrada. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/69d/79c/046/69d79c046478f1fde2a073f2fe37067f.png"></div><br>  Despu√©s de lo cual, habi√©ndose registrado localmente en los hosts, puede ver este servicio desde aqu√≠. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/73d/752/75c/73d75275c26a468f49cd192e781595db.png"></div><br>  Esta es una tarea tan regular: implementamos un determinado servicio web, nos reunimos un poco con Kubernetes. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1a3/1f8/c2f/1a31f8c2f639a4758d95719ee6dca1e0.png"></div><br>  Lo limpiaremos todo, eliminaremos el ingreso y veremos todos los recursos. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c75/990/40c/c7599040cd85c2c155e8acf057be0246.png"></div><br>  Hay una serie de recursos, como configmap y secret.  Estos son recursos de informaci√≥n pura que puede montar en un contenedor y transferir all√≠, por ejemplo, la contrase√±a de postgres.  Puede asociar esto con variables de entorno que se inyectar√°n en el contenedor al inicio.  Puedes montar el sistema de archivos.  Todo es bastante conveniente: tareas est√°ndar, buenas soluciones. <br><br>  Hay un volumen persistente, una interfaz que se implementa de manera diferente por diferentes proveedores de la nube.  Se divide en dos partes: hay un reclamo de volumen persistente (solicitud), y luego se crea algo de EBS que se arrastra al contenedor.  Puede trabajar con un servicio con estado. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/cd6/5c1/2f7/cd65c12f71d417ffd11e3e62c76b484c.png"><br><br>  ¬øPero c√≥mo funciona adentro?  El concepto en s√≠ es muy simple y transparente.  Kubernetes tiene dos partes.  Una es solo una base de datos en la que tenemos todos estos recursos.  Los recursos pueden considerarse tabletas: espec√≠ficamente, estas instancias son simplemente registros en tabletas.  Adem√°s de Kubernetes, se configura un servidor API.  Es decir, cuando tiene un cl√∫ster de Kubernetes, generalmente se comunica con el servidor API (m√°s precisamente, el cliente se comunica con √©l). <br><br>  En consecuencia, lo que creamos (POD, servicios, etc.) simplemente se escribe en la base de datos.  ETCD implementa esta base de datos, es decir  para que sea estable en el nivel de alta disponibilidad. <br><br>  ¬øQu√© viene despu√©s?  Adem√°s, debajo de cada tipo de recursos hay un cierto controlador.  Este es solo un servicio que monitorea su tipo de recurso y hace algo en el mundo exterior.  Por ejemplo, se ejecuta un Docker.  Si tenemos POD, para cada nodo hay un servicio de kubelet que monitorea los POD que est√°n conectados a este nodo.  Y todo lo que hace es ejecutar Docker despu√©s de la pr√≥xima verificaci√≥n peri√≥dica si este POD no est√° all√≠. <br><br>  Adem√°s, lo cual es muy importante: todo sucede en tiempo real, por lo que la potencia de este controlador es superior al m√≠nimo.  A menudo, el controlador a√∫n toma las m√©tricas y mira lo que comenz√≥.  Es decir  elimina los comentarios del mundo real y los escribe en la base de datos, para que usted u otros controladores puedan verlos.  Por ejemplo, el mismo estado de POD se volver√° a escribir en ETCD. <br><br>  Por lo tanto, todo se implementa en Kubernetes.  Es genial que el modelo de informaci√≥n est√© separado de la sala de operaciones.  En la base de datos a trav√©s de la interfaz CRUD habitual, declaramos lo que deber√≠a ser.  Entonces el conjunto de controladores intenta hacer que todo est√© bien.  Es cierto que esto no siempre sucede. <br><br>  Este es un modelo cibern√©tico.  Tenemos un cierto preajuste, hay alg√∫n tipo de m√°quina que est√° tratando de dirigir el mundo real o la m√°quina al lugar que se necesita.  No siempre sucede de esta manera: deber√≠amos tener un ciclo de retroalimentaci√≥n.  A veces una m√°quina no puede hacer esto y debe recurrir a una persona. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/59e/0a9/1e8/59e0a91e8974351a5f0f49fd94709c9a.png"><br><br>  En los sistemas reales, pensamos en abstracciones del siguiente nivel: tenemos algunos servicios, bases de datos y todos lo conectamos.  No pensamos en PODs e Ingresss, y queremos construir un pr√≥ximo nivel de abstracci√≥n. <br><img src="https://habrastorage.org/getpro/habr/post_images/77f/5cb/697/77f5cb6974c6ac85e0b5e8b13921d672.png"><br>  Para que el desarrollador fuera lo m√°s f√°cil posible: para que simplemente dijera: "Quiero comenzar tal o cual servicio", y todo lo dem√°s sucedi√≥ en el interior. <br><br>  Existe tal cosa como HELM.  Esta es la manera incorrecta: plantillas de estilo ansible, donde solo estamos tratando de generar un conjunto de recursos configurados y colocarlos en un cl√∫ster de Kubernetes. <br><br>  El problema, en primer lugar, es que esto solo se hace en el momento del rodaje.  Es decir, no puede implementar mucha l√≥gica.  En segundo lugar, en tiempo de ejecuci√≥n esta abstracci√≥n desaparece.  Cuando voy a mirar mi cl√∫ster, solo veo POD y servicios.  No veo que tal y tal servicio se implemente, que tal y tal base con replicaci√≥n se plantee all√≠.  Acabo de ver docenas de hogares all√≠.  La abstracci√≥n desaparece como en una matriz. <br><img src="https://habrastorage.org/getpro/habr/post_images/696/6e6/9bd/6966e69bd8b289229194911f62a11f84.png"><br><h2>  Modelo de soluci√≥n interna </h2><br>  Por otro lado, Kubernetes ya proporciona un modelo de extensi√≥n muy interesante y simple en su interior.  Podemos declarar nuevos tipos de recursos, por ejemplo, implementaci√≥n.  Este es un recurso creado sobre POD o conjunto de r√©plicas.  Podemos escribir un controlador en este recurso, poner este recurso en la base de datos y ejecutar nuestro bucle cibern√©tico para que todo funcione.  Esto suena interesante, y me parece que esta es la forma correcta de extender Kubernetes. <br><img src="https://habrastorage.org/getpro/habr/post_images/39e/491/c51/39e491c511ea25078eda191097d88b24.png"><br>  Me gustar√≠a poder escribir un manifiesto para mi servicio de estilo heroku.  Un ejemplo muy simple: quiero implementar alg√∫n tipo de aplicaci√≥n en mi entorno real.  Ya tiene acuerdos, SSL, dominios comprados.  Solo me gustar√≠a darles a los desarrolladores la interfaz m√°s simple posible.  El manifiesto me dice qu√© contenedor levantar, qu√© recursos a√∫n necesita este contenedor.  Lanza este anuncio al cl√∫ster y todo comienza a funcionar. <br><img src="https://habrastorage.org/getpro/habr/post_images/a91/24e/8a8/a9124e8a8309c952cc0a65b32f28d76f.png"><br><br>  ¬øC√≥mo se ver√° esto en t√©rminos de recursos y controladores personalizados?  Aqu√≠ tendremos una aplicaci√≥n de recursos en la base de datos.  Y el controlador de la aplicaci√≥n generar√° tres recursos.  Es decir, escribir√° las reglas al ingresar sobre c√≥mo dirigirse a este servicio, comenzar√° el servicio para el equilibrio de carga y lanzar√° la implementaci√≥n con alg√∫n tipo de configuraci√≥n. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/807/938/d22/807938d229cb312ca761214fa30829ed.png"><br><br>  Antes de crear un recurso personalizado en Kubernetes, debemos declararlo.  Para esto, hay un meta recurso llamado CustomResourceDefinition. <br><br>  Para declarar un nuevo recurso en Kubernetes, es suficiente para nosotros publicar dicho anuncio.  Considere esta tabla de creaci√≥n. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/09e/253/7d3/09e2537d3520f688c7029a357d9773dd.png"></div><br>  Cre√≥ una mesa.  Despu√©s de eso, podemos mirar a trav√©s del kubectl obtener esos recursos de terceros que tenemos.  Tan pronto como lo anunciamos, tambi√©n recibimos un banner.  Podemos hacer, por ejemplo, kubeclt obtener aplicaciones.  Pero hasta ahora no hay aplicaci√≥n. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d5b/c40/9ad/d5bc409ad70866a12358ccb68ba497f8.png"></div><br>  Escribamos alguna aplicaci√≥n.  Despu√©s de eso, podemos hacer una instancia de recurso personalizada.  Miremos en YAML y cre√©moslo publicando en una URL espec√≠fica. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/044/e55/454/044e554549dc4dc00d262ecf49d8d72d.png"></div><br>  Si corremos y miramos a trav√©s de kubectl, aparece una aplicaci√≥n.  Pero aunque no pasa nada, simplemente se encuentra en la base de datos.  Puede, por ejemplo, tomar y solicitar todos los recursos de la aplicaci√≥n. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/701/234/74d/70123474de1bf62ece27d49587098368.png"></div><br>  Podemos crear un segundo recurso a partir de la misma plantilla simplemente cambiando el nombre.  Aqu√≠ est√° el segundo recurso. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/842/a58/4b0/842a584b09631555234babcbd3c7e57c.png"></div><br>  Adem√°s, nuestro controlador debe hacer plantillas, similar a lo que hace HELM.  Es decir, despu√©s de recibir una descripci√≥n de nuestra aplicaci√≥n, debo generar una implementaci√≥n de recursos y un servicio de recursos, as√≠ como hacer una entrada en el ingreso.  Esta es la parte m√°s f√°cil: aqu√≠ en clojure est√° erlmacro.  Paso la estructura de datos, tira de la funci√≥n de implementaci√≥n, pasa a depurar, que es la tuber√≠a.  Y esta es una funci√≥n pura: plantillas simples.  En consecuencia, en la forma m√°s ingenua, pude crearlo de inmediato, convertirlo en una utilidad de consola y comenzar a distribuirlo. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b33/bf5/2cb/b33bf52cbd901d2c5e0a0641daed9161.png"></div><br>  Hacemos lo mismo para el servicio: la funci√≥n de servicio acepta la declaraci√≥n y genera el recurso de Kubernetes para nosotros. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c2e/daf/e7f/c2edafe7f36d7c0db4573054991c436a.png"></div><br>  Hacemos lo mismo para la l√≠nea de entrada. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/5d0/22f/156/5d022f15612aa3dcc19f635b0dd9b403.png"></div><br>  ¬øC√≥mo funcionar√° todo esto?  Habr√° algo en el mundo real y habr√° lo que queramos.  Lo que queremos: tomamos el recurso de la aplicaci√≥n y generamos en √©l lo que deber√≠a ser.  Y ahora necesitamos ver qu√© es.  Lo que solicitamos a trav√©s de la API REST.  Podemos obtener todos los servicios, todas las implementaciones. <br><br>  ¬øC√≥mo funcionar√° nuestro controlador personalizado?  Recibir√° lo que queremos y lo que es, tomar de este div y aplicar a Kubernetes.  Esto es similar a Reaccionar.  Se me ocurri√≥ un DOM virtual cuando algunas funciones simplemente generan un √°rbol de objetos JS.  Y luego un cierto algoritmo calcula el parche y lo aplica al DOM real. <br><br>  Haremos lo mismo aqu√≠.  Esto se hace en 50 l√≠neas de c√≥digo.  Quiero, todo est√° en Github.  Al final, deber√≠amos obtener la funci√≥n de reconciliar acciones. <br><br>  Tenemos una funci√≥n de acciones de reconciliaci√≥n que no hace nada y solo calcula este div.  Ella toma lo que es, m√°s lo que se necesita.  Y luego da lo que hay que hacer para llevar el primero al segundo. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/460/49b/90d/46049b90d8fa93dfe9279c02828cfa1c.png"></div><br>  Vamos a tirar de ella.  No hay nada malo en ella; puede ser debatida.  Ella dice que necesita crear un servicio de ingreso, hacer dos entradas en √©l, crear una implementaci√≥n 1 y 2, crear un servicio 1 y 2. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c72/c0a/c10/c72c0ac10e4924fde59ed749339345aa.png"></div><br>  En este caso, ya deber√≠a haber un solo servicio.  Vemos por ingreso que solo queda una entrada. <br><br>  Entonces todo lo que queda es escribir una funci√≥n que aplique este parche al cl√∫ster de Kubernetes.  Para hacer esto, simplemente pasamos las acciones de reconciliaci√≥n a la funci√≥n de reconciliaci√≥n, y todo se aplicar√°.  Y ahora vemos que el POD ha aumentado, la implementaci√≥n se ha convertido y el servicio ha comenzado. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/66b/144/1a5/66b1441a56d805344c7e734d3b9b2c80.png"></div><br>  Agreguemos otro servicio: ejecute la funci√≥n reconciliar-acciones nuevamente.  Veamos que pas√≥.  Todo comenz√≥, todo est√° bien. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/32a/f9f/c1e/32af9fc1e444ed1c135e4bbe828a946f.png"></div><br>  ¬øC√≥mo lidiar con esto?  Empacamos todo esto en un contenedor Docker.  Despu√©s de eso, escribimos una funci√≥n que peri√≥dicamente se despierta, se reconcilia y se duerme.  La velocidad no es muy importante, puede dormir durante cinco segundos y realizar acciones de reconciliaci√≥n con poca frecuencia. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/bec/04e/8d1/bec04e8d1791843d80aed4f2b3f2a673.png"></div><br>  Nuestro controlador personalizado es solo un servicio que se activar√° y calcular√° peri√≥dicamente el parche. <br><br>  Ahora tenemos dos servicios zaddeloino, eliminemos una de las aplicaciones.  Veamos c√≥mo reaccion√≥ nuestro cl√∫ster: todo est√° bien.  Eliminamos el segundo: todo se borra. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/5ff/a23/96e/5ffa2396ef22187604393a9ae657edd5.png"></div><br>  Veamos a trav√©s de los ojos del desarrollador.  Solo necesita decir que Kubernetes se postula y nombra el nuevo servicio.  Hacemos esto, nuestro controlador recogi√≥ todo y lo cre√≥. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/bd6/ca6/3d7/bd6ca63d77dfbadee1587b6f44a680bd.png"></div><br>  Luego recopilamos todo esto en un servicio de implementaci√≥n y lanzamos este controlador personalizado al cl√∫ster utilizando las herramientas est√°ndar de Kubernetes.  Creamos una abstracci√≥n para 200 l√≠neas de c√≥digo. <br><br>  Todo se parece a HELM, pero en realidad es m√°s poderoso.  El controlador funciona en un cl√∫ster: ve la base, ve el mundo exterior y puede ser lo suficientemente inteligente. <br><br><h2>  CI propio </h2><br>  Considere los ejemplos de extensi√≥n de Kubernetes.  Decidimos que CI deber√≠a ser parte de la infraestructura.  Esto es bueno, es conveniente desde el punto de vista de la seguridad: un repositorio privado.  Intentamos usar jenkins, pero es una herramienta obsoleta.  Quer√≠a un hacker CI.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No necesitamos interfaces, nos encantan los ChatOps: d√©jenos decir en el chat si la compilaci√≥n se ha ca√≠do o no. Adem√°s, quer√≠a depurar todo localmente. </font></font><br><img src="https://habrastorage.org/getpro/habr/post_images/9a4/ecf/86e/9a4ecf86e022a465ce11072352456728.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nos sentamos y escribimos nuestro CI en una semana. Solo como una extensi√≥n de Kubernetes. Si piensa en CI, entonces esta es solo una herramienta que ejecuta alg√∫n tipo de trabajo. Como parte de este trabajo, creamos algo, ejecutamos pruebas y, a menudo, lo implementamos. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øC√≥mo funciona todo? Se basa en el mismo concepto de controladores personalizados. Primero, colocamos en Kubernetes una descripci√≥n de los repositorios que estamos siguiendo. El controlador solo va a github y agrega web-hook. Todav√≠a tenemos introspecci√≥n.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Luego viene web-hook, cuya √∫nica tarea es procesar el JSON entrante y soltarlo en un recurso de compilaci√≥n personalizado, que tambi√©n se suma a la base de datos de Kubernetes. El controlador de compilaci√≥n supervisa el recurso de compilaci√≥n, que lee el manifiesto dentro del proyecto y lanza el POD. En este POD, se lanzan todos los servicios necesarios. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En POD, un agente muy simple que lee una declaraci√≥n al estilo de travis o circleci, y en YAML un conjunto de pasos. √âl comienza a cumplirlos. Luego, al final de la construcci√≥n, arroja su resultado en Telegram.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Otra caracter√≠stica que obtuvimos con Kubernetes es que uno de los comandos en la ejecuci√≥n de su CI o entrega continua se puede configurar simplemente mientras duerme verdadero 10, y su POD se congelar√° en este paso. </font><font style="vertical-align: inherit;">Haces kubectl exec, te encuentras dentro de tu build y puedes debutar. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Otra caracter√≠stica: todo est√° construido en las ventanas acoplables y puede depurar el script localmente iniciando la ventana acoplable. </font><font style="vertical-align: inherit;">Todo tom√≥ dos semanas y 300 l√≠neas de c√≥digo.</font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/72f/334/ec3/72f334ec33db75d3b32e4c464a24dc03.png"><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Trabaja con postgres </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nuestro producto est√° construido sobre postgres, utilizamos todo tipo de caracter√≠sticas interesantes. Incluso escribimos una serie de extensiones. Pero no podemos usar RDS ni nada m√°s. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ahora estamos en el proceso de desarrollar un operador para un postgres indestructible. Voy a sonar arquitectura. Quiero decir: "Cluster, dame un postgres que no pueda ser asesinado". Agregue a esto que necesito dos r√©plicas as√≠ncronas, una sincr√≥nica, copias de seguridad diarias y hasta un terabyte. Lo tiro todo, luego mi controlador de cl√∫ster comienza a hacer orquestaci√≥n y expandir mi contenedor. Crea recursos de instancia que son responsables de cada postgreso de istance. Esto ser√° postgres de cl√∫ster.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">M√°s controlador de pginstance, bastante simple, solo tratando de ejecutar POD o implementaci√≥n all√≠ con este postgres. El coraz√≥n es volumen persistente. Toda esta m√°quina toma el control total de postgres. Le das un contenedor Docker, que solo tiene postgres binarios. Todo lo dem√°s: el controlador mismo realiza la configuraci√≥n y creaci√≥n del cl√∫ster de inicio de postgres. Hace esto para que podamos reconfigurarlo m√°s tarde, y para que pueda configurar la replicaci√≥n, los niveles de registro, etc. Al principio, el POD temporal se ejecuta sobre el volumen persistente y crea un cl√∫ster de postgres para el maestro all√≠. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A continuaci√≥n, adem√°s de esto, la implementaci√≥n comienza con master. Luego se crea un volumen persistente de la misma manera. Otro POD pasa, realiza una copia de seguridad b√°sica, lo extrae y, adem√°s, la implementaci√≥n comienza con un esclavo.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A continuaci√≥n, el controlador del cl√∫ster crea un recurso de respaldo (despu√©s de que se haya descrito con los respaldos). Y el controlador de respaldo ya lo toma y lo arroja a alg√∫n S3.</font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/972/b42/457/972b42457c664d988fd8eeee0aaa603c.png"><br><br><h2>  Que sigue </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Perm√≠tanos presentarle el futuro cercano con usted. Puede suceder que tarde o temprano tengamos recursos personalizados tan interesantes, controladores personalizados que dir√© "Dame postgres, dame kafka, d√©jame CI y comienza todo". Todo ser√° simple. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si no estamos hablando del futuro cercano, entonces yo, como programador declarativo, creo que solo la programaci√≥n l√≥gica o relacional es m√°s alta que la programaci√≥n funcional. All√≠, nuestra sem√°ntica de operaciones est√° completamente separada de la sem√°ntica de informaci√≥n. Si observamos de cerca nuestros controladores personalizados que ten√≠amos, entonces tenemos, por ejemplo, una aplicaci√≥n de recursos en nuestra base de datos. Y derivamos de ello tres recursos adicionales m√°s. Esto es muy similar a la vista de la base de datos. Este es un hallazgo de hechos. Esta es una vista l√≥gica o de relaci√≥n.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El siguiente paso para Kubernetes es dar una cierta ilusi√≥n de una base relacional o l√≥gica en lugar de una API REST cortada, donde simplemente puede escribir una regla. Como tarde o temprano todo se acumula en la base de datos, incluidos los comentarios, las reglas pueden sonar as√≠: "Si la carga ha aumentado as√≠, entonces aumente la replicaci√≥n de esa manera". Tendremos una peque√±a sql o regla l√≥gica. Todo lo que necesitas es un motor gen√©rico que seguir√° esto. Pero este es un futuro brillante.</font></font><br><img src="https://habrastorage.org/getpro/habr/post_images/fb4/f1e/930/fb4f1e930029011d081eeb911203d289.png"><br><br><blockquote>    ‚Äî   <b>DevOops 2018</b> !     ‚Äî  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="></a> . <br><br>        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">¬´The DevOps Handbook¬ª</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">¬´Learning Chef: A Guide to Configuration Management and Automation¬ª</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">¬´How to containerize your Go code¬ª</a>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">¬´Liquid Software: How to Achieve Trusted Continuous Updates in the DevOps World¬ª</a> ‚Äî      .         -    . <br><br>  :       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="> </a> ! <br><br>    : <b> 1 </b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Puede</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> reservar un </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">boleto</font></a><font style="vertical-align: inherit;"> para DevOops 2018 con un descuento.</font></font></blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es424609/">https://habr.com/ru/post/es424609/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es424599/index.html">Debe elegir qu√© software necesita: escrito a tiempo o de alta calidad</a></li>
<li><a href="../es424601/index.html">Arquitectura de la informaci√≥n en Internet parte 1</a></li>
<li><a href="../es424603/index.html">El libro "¬øPor qu√© nos equivocamos? Trampas de pensamiento en acci√≥n ". Extractos Parte 1</a></li>
<li><a href="../es424605/index.html">Fondos de Zuckerberg: colaboraci√≥n + tecnolog√≠a + ciencia abierta</a></li>
<li><a href="../es424607/index.html">El ascenso de Helidon</a></li>
<li><a href="../es424611/index.html">C√≥mo crear un empleado de un profesional independiente</a></li>
<li><a href="../es424613/index.html">Experiencia usando redux sin reductores</a></li>
<li><a href="../es424615/index.html">Salida de funci√≥n de curva para limitar sin problemas par√°metros, se√±ales y no solo en Wolfram Mathematica</a></li>
<li><a href="../es424621/index.html">Superh√©roes no cinematogr√°ficos. ¬øQui√©n y c√≥mo protege el sitio de construcci√≥n del Centro Lakhta de los incendios?</a></li>
<li><a href="../es424623/index.html">Procesemos el sonido en Go</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>