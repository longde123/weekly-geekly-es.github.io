<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßìüèæ ü•´ üëÅ‚Äçüó® Operasi TA505, bagian empat. Kembar üôãüèª üçµ üé≠</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Kami terus berbicara tentang kegiatan grup peretas TA505. Ungkapan terkenal "yang baru adalah yang lama terlupakan" adalah yang paling cocok sebagai e...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Operasi TA505, bagian empat. Kembar</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pt/blog/475328/"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><img src="https://habrastorage.org/webt/79/gv/mv/79gvmv2kznpjzybycyw7scp5zus.jpeg"></a> <br><br>  Kami terus berbicara tentang kegiatan grup peretas TA505.  Ungkapan terkenal "yang baru adalah yang lama terlupakan" adalah yang paling cocok sebagai epigraf untuk bab selanjutnya dari kisah tentang grup TA505.  Benar, kali ini yang "lama" tidak begitu banyak "dilupakan" seperti yang dikerjakan ulang dan diperbaiki. <br><br>  Pada awal September, kami menemukan beberapa pengunduh berbahaya yang dikemas dengan PE-packer khusus dari grup yang kami <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">tulis sebelumnya</a> .  Pada pandangan pertama, mereka tampak seperti stager backdoor FlawedAmmyy yang terkenal.  Tetapi analisis yang lebih dalam menunjukkan bahwa ini tidak benar.  Bukan teknik yang paling canggih untuk menulis kode telah membawa kami ke muatan yang sangat berlawanan dalam hal kualitas eksekusi. <br><br>  Pada artikel ini, kita akan melihat lebih dekat pada alat yang ditemukan dan menggambar paralel dengan apa yang sudah diketahui. <a name="habracut"></a><br><br><h2>  Bootloader twein </h2><br>  Pertama-tama, yang berikut ini penasaran: dari semua sampel bootloader yang berhasil kami kumpulkan, hanya satu yang memiliki tanda tangan digital: <br><br><img src="https://habrastorage.org/webt/im/iu/-a/imiu-af4otgk3nhalsj7mhe3hwy.jpeg"><br><br>  <i>Fig.</i>  <i>1. Tanda tangan digital dari bootloader</i> <br><br>  Sertifikat dikeluarkan atas nama PEAR SOLUTIONS LTD.  Ngomong-ngomong, ini bukan pertama kalinya sebuah kelompok menandatangani alat-alatnya, menyerahkannya sebagai perangkat lunak yang sah untuk organisasi-organisasi fiktif.  Berikut adalah beberapa nama lain yang menggunakan TA505 untuk keluarga malware lain: <br><br><ul><li>  ET HOMES LTD, </li><li>  FIT DAN FLEX TERBATAS, </li><li>  MISHA LONDON LTD, </li><li>  SATOJI KAIDA MB, </li><li>  SANGAT TELE TERBATAS. </li></ul><br>  Karena bootloader yang terdeteksi tidak berbeda di antara mereka, kami memilih yang bertanda tangan yang disebutkan di atas dan membahasnya dengan lebih rinci. <br><br>  Sepanjang pekerjaan malware, hampir setiap tindakan disertai dengan menulis ke file log dan men-debug output dari semua yang terjadi: <br><br><img src="https://habrastorage.org/webt/dm/7f/1j/dm7f1jjwkhlfkj8k987uvp8ixjw.jpeg"><br><br>  <i>Fig.</i>  <i>2. Output debug dan logging</i> <br><br>  Penelusuran semacam itu tidak hanya menyederhanakan analisis statis file, tetapi juga membantu mencari tahu apa yang salah dalam sistem analisis dinamis: <br><br><img src="https://habrastorage.org/webt/d4/g1/kg/d4g1kgeiovdgo-ecz3ytg5ki26c.jpeg"><br><br>  <i>Fig.</i>  <i>3. Debug output di penganalisa online ANY.RUN</i> <br><br>  Troyan memeriksa tata bahasa keyboard - dan tidak berfungsi di Rusia dan negara-negara tetangga: <br><br><img src="https://habrastorage.org/webt/bz/hr/my/bzhrmynjo9dlc50xi_nucjdpuf4.jpeg"><br><br>  <i>Fig.</i>  <i>4. Memeriksa tata letak bahasa keyboard</i> <br>  Kemudian ia menciptakan <code>Global\system32_mutant_service</code> mutex dan memeriksa ketersediaan Internet menggunakan permintaan GET HTTP ke google.com.  Setelah itu, ia menentukan cara mengakses jaringan (alamat khusus atau <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">NAT</a> ) dengan menentukan alamat IP eksternal oleh layanan myexternalip.com, ipecho.net dan ifconfig.me dan membandingkan nilai yang diterima dengan yang ditentukan dalam parameter jaringan sistem sistem: <br><br><img src="https://habrastorage.org/webt/ld/80/7w/ld807wry4cgdc1qzj3mwjogabf8.jpeg"><br><br>  <i>Fig.</i>  <i>5. Perbandingan alamat IP internal dan eksternal</i> <br><br>  Selanjutnya, malware menentukan versi pustaka <code>%SystemRoot%\system32\crypt32.dll</code> dan, jika nomor build dan nomor revisi masing-masing kurang dari <code>7601</code> dan <code>18741</code> , unduhan dan menginstal pembaruan <code>KB3033929</code> sesuai dengan versi sistem operasi: <br><br><img src="https://habrastorage.org/webt/su/zu/ig/suzuighncp_psgtfbtnbvcdbb1y.jpeg"><br><br>  <i>Fig.</i>  <i>6. Unduh dan instal pembaruan sistem</i> <br><br>  Penyerang TA505 merawat korban dan menambal sistem sesuai kebutuhan?  Tidak semuanya.  Menginstal pembaruan dikaitkan dengan penghentian dukungan untuk sertifikat keamanan kode yang ditandatangani menggunakan SHA-1 dan pengabaiannya demi algoritma SHA-2.  Kemungkinan besar, peretas telah mengalami kesulitan menjalankan payload yang ditandatangani pada sistem yang tidak diperbarui.  Menariknya, setelah menginstal pembaruan, trojan mengirimkan log tindakan yang dihasilkan ke server manajemen, menghentikan pekerjaannya dan membersihkan sendiri, membersihkan jejak yang tersisa. <br><br><img src="https://habrastorage.org/webt/k6/jk/-y/k6jk-yijoanmpjtwath42fioh10.jpeg"><br><br>  <i>Fig.</i>  <i>7. Shutdown setelah menginstal pembaruan sistem</i> <br><br>  Jika instalasi pembaruan tidak diperlukan, bootloader mengumpulkan dan mengirimkan informasi berikut ke server manajemen: <br><br><ul><li>  informasi sistem </li><li>  informasi tentang perangkat lunak yang diinstal, </li><li>  informasi tentang perangkat lunak yang ditandatangani di direktori% ProgramFiles% dan% ProgramFiles (x86)% (jika ada), </li><li>  Informasi tentang driver yang ditandatangani di direktori% SystemRoot% \ drivers. </li></ul><br>  Perhatikan bahwa <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">kode yang sah</a> digunakan untuk mendapatkan informasi tentang tanda tangan. <br><br><img src="https://habrastorage.org/webt/z4/1o/p_/z41op_q3q8pzlli3zlapjreaxd0.jpeg"><br><br>  <i>Fig.</i>  <i>8. Memperoleh informasi sertifikat</i> <br><br>  Setelah itu, bootloader membuat direktori <code>C:\Windows\Logs\diag</code> dan memulai utas di mana ia melacak perubahan dalam direktori, mengirimkan pemberitahuan ke server pengelola: <br><br><img src="https://habrastorage.org/webt/ra/rh/-g/rarh-gd4x8yafwiipdft7r9duiq.jpeg"><br><br>  <i>Fig.</i>  <i>9. Memantau perubahan direktori</i> <br><br>  Kemudian ia menyiapkan informasi yang ada dan yang hilang tentang sistem (nama pengguna, versi sistem, domain, alamat IP, informasi kartu video, koneksi jaringan - NAT atau bukan NAT) dan menghasilkan file JSON dari jenis ini: <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"adm"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"bid"</span></span>: <span class="hljs-string"><span class="hljs-string">"M3xwwhqLH/AUOhmU2+W55A=="</span></span>, <span class="hljs-attr"><span class="hljs-attr">"bit"</span></span>: <span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"bnet"</span></span>: <span class="hljs-string"><span class="hljs-string">"ldr"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"cam"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"cis"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dmn"</span></span>: <span class="hljs-string"><span class="hljs-string">"WORKGROUP"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"hash_r"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"lip"</span></span>: <span class="hljs-string"><span class="hljs-string">"192.168.100.153"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"lvl"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"nat"</span></span>: <span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"osb"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"osv"</span></span>: <span class="hljs-string"><span class="hljs-string">"Windows 7 Professional"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pc"</span></span>: <span class="hljs-string"><span class="hljs-string">"USER-PC"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"proc_c"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"proc_n"</span></span>: <span class="hljs-string"><span class="hljs-string">"cpu"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"rep"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tmt"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ver"</span></span>: <span class="hljs-string"><span class="hljs-string">"163"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"video"</span></span>: <span class="hljs-string"><span class="hljs-string">"Standard VGA Graphics Adapter,"</span></span> }</code> </pre> <br>  Kemudian, data ini akan dienkripsi dengan RC4 (kunci enkripsi <code>gJypA9RWUlYpnBbzujVqE6fDcEAk0zoz</code> dienkripsi dalam tubuh Troya), disandikan dengan Base64 dan dikirim melalui permintaan HTTP POST ke server pengelola: <br><br><img src="https://habrastorage.org/webt/wu/4p/x8/wu4px8dxpkvy5mshywjkrskevlm.jpeg"><br><br>  <i>Fig.</i>  <i>10. Permintaan HTTP POST ke server manajemen</i> <br><br><img src="https://habrastorage.org/webt/uv/lw/bg/uvlwbgwcx0ejyfndmzdybhtqrsy.jpeg"><br><br>  <i>Fig.</i>  <i>11. Daftar server kontrol di bootloader</i> <br><br>  Respons dari server didekripsi oleh RC4 (kunci enkripsi sama dengan yang digunakan untuk mengirim data) dan diperiksa: dua byte pertama harus sesuai dengan garis MZ, yang merupakan tanda dari file PE.  Kami telah memenuhi urutan ini sebelumnya ketika kami menganalisis pemuat grup lain yang mengirimkan RAT FlawedAmmyy: <br><br><img src="https://habrastorage.org/webt/pb/oe/hi/pboehibfeoivvna7bl6xkumibuo.jpeg"><br><br>  <i>Fig.</i>  <i>12. Kode yang mirip untuk mendekripsi dan memeriksa file yang diunduh untuk bootloader yang dimaksud (kiri) dan bootloader FlawedAmmyy RAT (kanan)</i> <br><br>  Pemuatan muatan terjadi tidak hanya di utas utama, tetapi juga dalam yang dibuat secara terpisah.  Dengan kata lain, ada dua muatan.  Dalam satu kasus, mutex Global \ system32_host_service sudah diperiksa sebelumnya, dan jika tidak ada, komponen dimuat, yang disebut dalam informasi debug sebagai payload atau bot.  Menariknya, setelah menerima respons dari server, file PE tidak memulai dengan cara apa pun.  Sebagai gantinya, tubuhnya ditulis ke registri di bagian <code>HKEY_LOCAL_MACHINE\SYSTEM</code> di kunci <code>0x228028</code> .  Kemudian bootloader menonaktifkan pengalihan sistem file <code>Wow64DisableWow64FsRedirection</code> aplikasi 32-bit menggunakan <code>Wow64DisableWow64FsRedirection</code> dan memulai proses <code>%SystemRoot%\System32\services.exe</code> dengan parameter -ww.  Menggunakan parameter ini tidak masuk akal, tetapi ini menyelesaikan rantai instalasi dari muatan yang dihasilkan. <br><br><img src="https://habrastorage.org/webt/bn/eb/w1/bnebw1pcir-t8io211poejmlzbe.jpeg"><br><br>  <i>Fig.</i>  <i>13. Mengatur payload</i> <br><br>  Kami akan membicarakan tentang muatan kedua nanti. <br><br><h2>  Twein plugins </h2><br>  Meneliti trojan yang dibahas di atas, kami melihat fungsi yang menghapus dua file dari direktori <code>%SystemRoot%</code> - <code>twein_32.dll</code> dan <code>twein_64.dll</code> : <br><br><img src="https://habrastorage.org/webt/hk/v2/ht/hkv2ht9lipkhgz-ydz622exxzds.jpeg"><br><br>  <i>Fig.</i>  <i>14. Menghapus file twein_32.dll dan twein_64.dll</i> <br><br>  File-file ini tidak ditemukan di tempat lain, mereka tidak muncul dalam logika bootloader.  Namun, nama-nama perpustakaan mengingatkan kita pada kelompok malware lain, yang sekarang akan kita pertimbangkan. <br>  Dua bulan sebelumnya, kami menemukan Trojan dari grup TA505, berukuran sekitar 9 MB.  File ini dikemas oleh <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">UPX</a> .  Trojan diinstal ke dalam sistem sebagai layanan <code>WMDICToss</code> .  Sumber daya berisi tiga file: <code>systemdiron.bat</code> , <code>twein__32.dll</code> dan <code>twein__64.dll</code> , yang dienkripsi dengan XOR linier. <br><br><img src="https://habrastorage.org/webt/tj/op/xh/tjopxhpvsrbmlstkvm2fidukk7w.jpeg"><br><br>  <i>Fig.</i>  <i>15. Dekripsi salah satu sumber daya pipet</i> <br><br>  Perhatikan bahwa nama kedua file tersebut hampir bersamaan dengan yang telah disebutkan sebelumnya: perbedaannya hanya pada jumlah garis bawah. <br><br>  Salah satu sumber yang didekripsi dengan nama <code>systemdiron.bat</code> diharapkan menjadi skrip perintah yang menyediakan peluncuran komponen lain tergantung pada kapasitas sistem: <br><br><pre> <code class="bash hljs">@<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> off <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> defined PROCESSOR_ARCHITEW6432 (goto LABEL_X64) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> %PROCESSOR_ARCHITECTURE%==IA64 (goto LABEL_X64) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> %PROCESSOR_ARCHITECTURE%==AMD64 (goto LABEL_X64) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> %PROCESSOR_ARCHITECTURE%==x86 (goto LABEL_X86) goto LABEL_NON :LABEL_X64 <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> OS <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>: x64 copy c:\temp\tmp.log c:\i.txt rundll32.exe C:\Windows\twein__64.dll,Install copy c:\temp\tmp.log c:\i.txt rundll32.exe C:\Windows\twein__32.dll,Install del c:\temp\tmp.log del c:\i.txt shutdown.exe -r -t 00 goto LABEL_END :LABEL_X86 <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> OS <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>: x86 copy c:\temp\tmp.log c:\i.txt rundll32.exe C:\Windows\twein__32.dll,Install del c:\temp\tmp.log del c:\i.txt shutdown.exe -r -t 00 goto LABEL_END :LABEL_NON <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> OS <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>: undefined goto LABEL_END :LABEL_END pause</code> </pre> <br>  Kedua perpustakaan twein bertindak sama.  Dikemas dengan pengepak karakteristik grup TA505.  Nama perpustakaan asli: <code>av_block.dll</code> .  Analisis ini sangat rumit dengan penggunaan obfuscator, dan proporsi kode yang dikaburkan adalah sekitar 80%.  Sebagai hasil dari ini, eksekusi program dipenuhi dengan banyak transisi, decoding dari langkah-langkah kode berikutnya, panggilan fungsi non-linear. <br><br>  Perpustakaan berisi daftar string seperti Base64 yang mengesankan, yang didekripsi sebagai berikut: <br><br>  1. String input dibagi menjadi blok 4 byte; <br>  2. Setiap blok didekodekan menggunakan algoritma penggantian dan shift: <br><br><pre> <code class="bash hljs">import binascii def block_decode(input_str, len_of_block): alphabet = <span class="hljs-string"><span class="hljs-string">'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x3E\x00\x00\x00\x3F\x34\x35\x36\x37\x38\x39\x3A\x3B\x3C\x3D\x00\x00\x00\x00\x00\x00\x00\x00\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0A\x0B\x0C\x0D\x0E\x0F\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x00\x00\x00\x00\x00\x00\x1A\x1B\x1C\x1D\x1E\x1F\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2A\x2B\x2C\x2D\x2E\x2F\x30\x31\x32\x33\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'</span></span> int_result = 0 <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(len_of_block): alph = ord(alphabet[ord(input_str[i])]) alph &lt;&lt;= 0x6 * i int_result += alph str_result = hex(int_result)[2:] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(str_result) % 2 != 0: str_result = <span class="hljs-string"><span class="hljs-string">'0'</span></span> + str_result <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> binascii.unhexlify(str_result).decode(<span class="hljs-string"><span class="hljs-string">'latin1'</span></span>)[::-1]</code> </pre> <br><br>  3) blok dikumpulkan dalam satu baris; <br>  4) hasilnya didekripsi oleh algoritma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">eexec</a> dengan kunci byte ganda, dilewatkan sebagai parameter: <br><br><img src="https://habrastorage.org/webt/qs/mj/ah/qsmjah4gzyqwizgrothw1hlbkdc.jpeg"><br><br>  <i>Fig.</i>  <i>16. Implementasi dari algoritma eexec</i> <br><br>  Sebagian besar baris adalah nama dan jalur ke file produk anti-virus, namun beberapa dari mereka tidak termasuk alat keamanan sama sekali: MS Exchange Server, Server MySQL, SAP, Apache, PostgreSQL, Elasticsearch, dll. Bahkan ada jalur unik seperti itu: <br><br><ul><li>  C: \ Users \ tislam \ Desktop \ salik app \ Aye_salik_data \ Aye_salik_data \ bin \ Debug \ Aye_salik_data.exe </li><li>  C: \ oem13c \ agent13c \ agent_13.2.0.0.0 \ perl \ bin \ perl.exe </li><li>  C: \ Users \ adadmin \ Ubiquiti UniFi \ bin \ mongod.exe </li><li>  C: \ Users \ sakella \ AppData \ Local \ Microsoft \ OneDrive \ OneDrive.exe </li><li>  D: \ Add-ons \ IMI_CREDIT_POLICY Uji v 02.01 \ IMI_CREDIT_POLICY.exe </li></ul><br>  Jika perangkat lunak ditemukan dalam sistem dari daftar, file dan direktori dihapus. <br><br>  Untuk mengamankan diri mereka dalam sistem, perpustakaan menetapkan diri mereka sebagai <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">antarmuka Windows Sockets</a> Service Provider (SPI), yang disebut sebagai Intel dan IntelFiltr.  Selain itu, mereka mengubah urutan penangan dalam rantai protokol untuk menjadi SPI pertama yang menangani permintaan klien. <br><br>  Pada 2015, rekan FireEye kami memperkenalkan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">analisis</a> bot <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">LatentBot</a> .  Sangat aneh bahwa algoritma enkripsi string di LatentBot dan perpustakaan twein yang ditinjau sepenuhnya sama.  Selain itu, LatentBot menggunakan modul keamanan sebagai salah satu plug-in, yang mencari alat keamanan di sistem menggunakan jalur dan nama produk yang ditentukan, meskipun terbatas untuk memeriksa ketersediaan. <br><br><h2>  Rootkit twein </h2><br>  Kembali ke bootloader, yaitu payload kedua.  Dari baris debug mencoba membuka rootkit ... dan Driver% S diinstal, mudah untuk menebak format muatan berikutnya.  Setelah berhasil memuat, driver akan ditulis ke direktori <code>%SystemRoot%\System32\drivers</code> dengan nama yang dibentuk secara pseudo-acak dari nama-nama file sah lainnya.  Kemudian layanan akan dibuat dan diluncurkan: <br><br><img src="https://habrastorage.org/webt/hw/dp/vi/hwdpvipfgx2-rra5iqecj2o5t8w.jpeg"><br><br>  <i>Fig.</i>  <i>17. Menginstal dan memulai layanan</i> <br><br>  Pada tahap akhir pekerjaannya, bootloader akan mengonfigurasi driver untuk dimasukkan dalam daftar hitam di kunci registri: nama proses anti-virus, alat analisis, dan vendor perlindungan dalam tanda tangan file digital akan dimasukkan dalam nilai numerik tertentu dari kunci cabang <code>HKEY_LOCAL_MACHINE\SYSTEM</code> : <br><br><img src="https://habrastorage.org/webt/u2/fw/zj/u2fwzjlb_hjgmabjwa4filz9fn4.jpeg"><br><br>  <i>Fig.</i>  <i>18. Konfigurasi driver daftar hitam</i> <br><br>  Dalam proses meneliti bootloader, kami tidak dapat memperoleh driver sampel dari server manajemen.  Namun, kami menemukan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">penyebutan rootkit</a> yang dipompa oleh bootloader lain yang serupa. <br><br>  Pengemudi ditandatangani secara digital atas nama <code>Lizas Limited</code> dengan <code>administrator@lizaslimited.site</code> sebagai email: <br><br><img src="https://habrastorage.org/webt/o_/tm/yy/o_tmyyrx3dayywf-jnfkoijecvm.jpeg"><br><br>  <i>Fig.</i>  <i>19. Pengemudi yang ditandatangani secara digital</i> <br><br>  Selama penelitian, kami menemukan banyak <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">kesamaan</a> dengan rootkit terkenal dari botnet Necurs, yang secara aktif digunakan oleh grup TA505 untuk mengirim spam dan menyebarkan malware.  Mari kita perhatikan lebih detail fitur paling menarik dari karyanya. <br><br>  Pengemudi mendaftarkan penangan acara untuk memulai proses dan memuat gambar PE menggunakan <code>PsSetCreateProcessNotifyRoutine</code> dan <code>PsSetLoadImageNotifyRoutine</code> .  Dengan kata lain, ini memungkinkan pengemudi untuk mengontrol peluncuran semua proses dan layanan baru.  Menggunakan daftar hitam yang kami sebutkan sebelumnya, rootkit mengakhiri proses yang tidak diinginkan dengan ZwTerminateProcess dan mencegah driver lain yang berpotensi berbahaya untuk memuat, menimpa nilai titik masuk pada instruksi: <br><br><pre> <code class="bash hljs">mov eax, 0C0000001 retn 8</code> </pre> <br>  Akibatnya, layanan akan dibongkar dengan kesalahan <code>STATUS_UNSUCCESSFULL</code> . <br><br><img src="https://habrastorage.org/webt/td/l7/ea/tdl7ea03jvxszqftk9rks9wqgqc.jpeg"><br><br>  <i>Fig.</i>  <i>20. Proses penyelesaian</i> <br><br><img src="https://habrastorage.org/webt/va/6k/bb/va6kbbjuepdp1x99ktenowebmc0.jpeg"><br><br>  <i>Fig.</i>  <i>21. Menimpa titik masuk pengemudi</i> <br><br>  Dengan menggunakan CmRegisterCallback, pengemudi memotong acara akses registri sistem.  Secara khusus, karyanya lebih lanjut diparameterisasi dengan nilai numerik dari kunci yang diakses dalam peristiwa yang dicegat. <br><br><img src="https://habrastorage.org/webt/af/ka/b6/afkab6erynqiphtoyzztal2wjq8.jpeg"><br><br>  <i>Fig.</i>  <i>22. Manajemen rootkit akses kunci registri</i> <br><br>  Menariknya, di beberapa versi rootkit Necurs, nilai numerik yang sama digunakan sebagai kode permintaan ioctl. <br><br><img src="https://habrastorage.org/webt/nn/vx/rh/nnvxrhxmoftlziclt9dgak73ydk.jpeg"><br><br>  <i>Fig.</i>  <i>23. Mengelola rootkit Necurs menggunakan permintaan ioctl</i> <br><br>  Trik ini dapat dianggap sebagai langkah menuju kerahasiaan yang lebih besar: akses ke registri menyebabkan lebih sedikit kecurigaan daripada permintaan ioctl ke DeviceObject. <br><br>  Badan rootkit berisi pustaka DLL tambahan yang dienkripsi dengan XOR bita tunggal.  Saat membuat proses baru, driver menyuntikkan pustaka bersama dengan file PE lainnya, yang diekstrak dari registri dan didekripsi lagi dengan XOR byte tunggal. <br><br><img src="https://habrastorage.org/webt/nu/ze/03/nuze03jkif4-7sl9mux_j8_roz8.jpeg"><br><br>  <i>Fig.</i>  <i>24. Dekripsi dan injeksi perpustakaan bantu ke dalam proses yang dibuat</i> <br><br>  Komponen tambahan adalah <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">pemuat reflektif</a> khusus yang menempatkan file PE kedua dengan benar dalam memori, yang bertindak sebagai payload, dan mentransfer kontrol ke sana.  Sekarang menjadi jelas bagaimana sebenarnya muatan yang ditulis ke registri oleh bootloader dari bagian pertama artikel mulai berfungsi. <br><br><img src="https://habrastorage.org/webt/wa/zr/c3/wazrc3yxq9pul3vzf3jjbgsdeyg.jpeg"><br><br>  <i>Fig.</i>  <i>25. Mengisi tabel impor dengan perpustakaan bantu</i> <br><br><h2>  Kesimpulan </h2><br>  Dalam artikel itu, kami berkenalan dengan fitur-fitur karya banyak trojan kembar.  Mengapa kembar  Bootloader berbahaya yang digunakan untuk memulai penelitian kami sangat mirip dengan bootloader backdoor FlawedAmmyy yang terkenal dalam kualitas penulisan kode dan nuansa implementasi.  Perpustakaan twein yang ia coba hapus dari sistem kemungkinan besar adalah yang kita cari selanjutnya.  Perpustakaan sangat mirip dengan plugin keamanan LatentBot.  Salah satu muatan bootloader adalah driver yang merupakan turunan dari rootkit Necurs yang populer. <br><br>  Beberapa keluarga malware berusia di atas 5 tahun, namun, penyerang terus memperbarui dan memperbaikinya, dengan mempertimbangkan pengembangan sistem operasi dan alat keamanan. <br><br>  <b>Penulis</b> : Alexey Vishnyakov dan Daniil Koloskov, Positive Technologies <br><br><div class="spoiler">  <b class="spoiler_title">IOC</b> <div class="spoiler_text">  a28a54abc30805cc6ea2ce0732989287 - Twein bootloader <br>  f6b6526b8d494dce14568e3703368432 - twein penetes plugin <br>  983dd279722154a12093410067fe070e - rootkit Twein <br></div></div><br><h2>  Artikel sebelumnya dalam seri: </h2><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Operasi TA505: bagaimana kami menganalisis alat baru dari pencipta Trojan Dridex, ransomware Locky, dan botnet Neutrino.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Bagian 1</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Pengoperasian TA505: Mempelajari backdoor ServHelper dengan NetSupport RAT.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Bagian 2</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Pengoperasian TA505: Pengelompokan Infrastruktur Jaringan.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Bagian 3</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id475328/">https://habr.com/ru/post/id475328/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id475306/index.html">Gugatan: sejarah dan prospek</a></li>
<li><a href="../id475308/index.html">Bagaimana cara lulus untuk seorang programmer yang baik</a></li>
<li><a href="../id475314/index.html">Fantasi lingkungan untuk melindungi planet ini</a></li>
<li><a href="../id475320/index.html">Rekomendasi Microsoft untuk menonaktifkan kedaluwarsa kata sandi: konsekuensi dan kesimpulan</a></li>
<li><a href="../id475326/index.html">Bagaimana scammers melakukan ini. Alat curang</a></li>
<li><a href="../id475330/index.html">Kontes Plugin Platform Miro dengan Kelompok Hadiah $ 21.000</a></li>
<li><a href="../id475332/index.html">3. Desain Jaringan Perusahaan pada Sakelar Ekstrim</a></li>
<li><a href="../id475336/index.html">Cara berhenti dengan benar (instruksi)</a></li>
<li><a href="../id475338/index.html">Jika Anda tidak memiliki Python, tetapi ada model Keras dan Java</a></li>
<li><a href="../id475340/index.html">AMD memperkenalkan prosesor Threadripper - CPU desktop tercepat</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>