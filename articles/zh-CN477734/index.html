<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸŒˆ ğŸ† ğŸ™ï¸ ä½¿ç”¨Photosåº”ç”¨ç¨‹åºäº†è§£UICollectionViewLayout ğŸ‘ƒğŸ¾ ğŸ ğŸ¦—</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="å“ˆHaï¼ æˆ‘å«Nikitaï¼Œæˆ‘åœ¨ABBYYä¸Šä½¿ç”¨ç§»åŠ¨SDKï¼Œå¹¶ä¸”è¿˜å¤„ç†UIç»„ä»¶ï¼Œä»¥ä¾¿åœ¨æ™ºèƒ½æ‰‹æœºä¸Šæ‰«æå’Œæ–¹ä¾¿åœ°æŸ¥çœ‹å¤šé¡µæ–‡æ¡£ã€‚ è¯¥ç»„ä»¶ç”±å‡ ä¸ªéƒ¨åˆ†ç»„æˆï¼Œå¯å‡å°‘åŸºäºABBYY Mobile CaptureæŠ€æœ¯å¼€å‘åº”ç”¨ç¨‹åºçš„æ—¶é—´ã€‚ é¦–å…ˆï¼Œç”¨äºæ‰«ææ–‡ä»¶çš„ç…§ç›¸æœºï¼› å…¶æ¬¡ï¼Œå¸¦æœ‰æ•è·ç»“æœçš„ç¼–è¾‘å™¨å±å¹•ï¼ˆå³è‡ªåŠ¨æ‹æ‘„çš„ç…§ç‰‡...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ä½¿ç”¨Photosåº”ç”¨ç¨‹åºäº†è§£UICollectionViewLayout</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/abbyy/blog/477734/">å“ˆHaï¼ æˆ‘å«Nikitaï¼Œæˆ‘åœ¨ABBYYä¸Šä½¿ç”¨ç§»åŠ¨SDKï¼Œå¹¶ä¸”è¿˜å¤„ç†UIç»„ä»¶ï¼Œä»¥ä¾¿åœ¨æ™ºèƒ½æ‰‹æœºä¸Šæ‰«æå’Œæ–¹ä¾¿åœ°æŸ¥çœ‹å¤šé¡µæ–‡æ¡£ã€‚ è¯¥ç»„ä»¶ç”±å‡ ä¸ªéƒ¨åˆ†ç»„æˆï¼Œå¯å‡å°‘åŸºäº<a href="http://www.abbyy.com/ru-ru/mobile-capture-sdk/%3Futm_source%3Dhabr%26utm_medium%3Dpost%26utm_campaign%3D%25D0%25BF%25D0%25BE%25D0%25BD%25D0%25B8%25D0%25BC%25D0%25B0%25D0%25B5%25D0%25BC_ui">ABBYY Mobile CaptureæŠ€æœ¯</a>å¼€å‘åº”ç”¨ç¨‹åºçš„æ—¶é—´ã€‚ é¦–å…ˆï¼Œç”¨äºæ‰«ææ–‡ä»¶çš„ç…§ç›¸æœºï¼› å…¶æ¬¡ï¼Œå¸¦æœ‰æ•è·ç»“æœçš„ç¼–è¾‘å™¨å±å¹•ï¼ˆå³è‡ªåŠ¨æ‹æ‘„çš„ç…§ç‰‡ï¼‰å’Œç”¨äºæ ¡æ­£æ–‡æ¡£è¾¹æ¡†çš„å±å¹•ã€‚ <br><br> å¼€å‘äººå‘˜åªéœ€è°ƒç”¨å‡ ä¸ªæ–¹æ³•å°±è¶³å¤Ÿäº†-ç°åœ¨åœ¨ä»–çš„åº”ç”¨ç¨‹åºä¸­å·²ç»æœ‰ä¸€ä¸ªå¯ä»¥è‡ªåŠ¨æ‰«ææ–‡æ¡£çš„ç…§ç›¸æœºã€‚ ä½†æ˜¯ï¼Œé™¤äº†é…ç½®çš„æ‘„åƒæœºå¤–ï¼Œæ‚¨è¿˜éœ€è¦ä¸ºå®¢æˆ·æä¾›å¯¹æ‰«æç»“æœçš„ä¾¿æ·è®¿é—®ï¼Œå³ è‡ªåŠ¨æ‹ç…§ã€‚ å¦‚æœå®¢æˆ·æ‰«æåˆåŒæˆ–ç« ç¨‹ï¼Œåˆ™å¯èƒ½ä¼šæœ‰å¾ˆå¤šæ­¤ç±»ç…§ç‰‡ã€‚ <br><br> åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†è®¨è®ºåœ¨å®ç°ç¼–è¾‘å™¨å±å¹•ä»¥åŠæ–‡æ¡£æ•è·ç»“æœè¿‡ç¨‹ä¸­å‡ºç°çš„å›°éš¾ã€‚ å±å¹•æœ¬èº«æ˜¯ä¸¤ä¸ª<code>UICollectionView</code> ï¼Œæˆ‘å°†å®ƒä»¬ç§°ä¸ºå¤§å°ã€‚ æˆ‘å°†çœç•¥æ‰‹åŠ¨è°ƒæ•´æ–‡æ¡£è¾¹æ¡†å’Œæ–‡æ¡£å…¶ä»–å·¥ä½œçš„å¯èƒ½æ€§ï¼Œå¹¶ä¸”åœ¨æ»šåŠ¨è¿‡ç¨‹ä¸­æˆ‘å°†é‡ç‚¹ä»‹ç»åŠ¨ç”»å’Œå¸ƒå±€åŠŸèƒ½ã€‚ åœ¨GIFä¸‹æ–¹ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°æœ€ç»ˆå‘ç”Ÿäº†ä»€ä¹ˆã€‚ åˆ°èµ„æºåº“çš„é“¾æ¥å°†åœ¨æ–‡ç« çš„æœ«å°¾ã€‚ <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/r2/xs/of/r2xsofivnhzdmlxt67ld_2atq-q.gif"></div><br><br> ä½œä¸ºå‚è€ƒï¼Œæˆ‘ç»å¸¸å…³æ³¨Appleç³»ç»Ÿåº”ç”¨ç¨‹åºã€‚ å½“æ‚¨ä»”ç»†æŸ¥çœ‹å…¶åº”ç”¨ç¨‹åºçš„åŠ¨ç”»å’Œå…¶ä»–ç•Œé¢è§£å†³æ–¹æ¡ˆæ—¶ï¼Œæ‚¨ä¼šå¼€å§‹æ¬£èµå®ƒä»¬å¯¹å„ç§çäº‹çš„æ®·å‹¤æ€åº¦ã€‚ ç°åœ¨ï¼Œæˆ‘ä»¬å°†ä»¥â€œ <i>ç…§ç‰‡â€</i>åº”ç”¨ç¨‹åºï¼ˆiOS 12ï¼‰ä¸ºå‚è€ƒã€‚ æˆ‘å°†æè¯·æ‚¨æ³¨æ„æ­¤åº”ç”¨ç¨‹åºçš„ç‰¹å®šåŠŸèƒ½ï¼Œç„¶åæˆ‘ä»¬å°†å°è¯•å®ç°å®ƒä»¬ã€‚ <br><a name="habracut"></a><br> æˆ‘ä»¬å°†ä»‹ç»<code>UICollectionViewFlowLayout</code>å¤§å¤šæ•°è‡ªå®šä¹‰<code>UICollectionViewFlowLayout</code> ï¼Œäº†è§£å¦‚ä½•å®ç°è§†å·®å’Œè½®æ’­ç­‰å¸¸è§æŠ€æœ¯ï¼Œå¹¶è®¨è®ºåœ¨æ’å…¥å’Œåˆ é™¤å•å…ƒæ ¼æ—¶ä¸è‡ªå®šä¹‰åŠ¨ç”»ç›¸å…³çš„é—®é¢˜ã€‚ <br><br><h2> åŠŸèƒ½å›é¡¾ </h2><br> è¦æ·»åŠ ç»†èŠ‚ï¼Œæˆ‘å°†åœ¨â€œ <i>ç…§ç‰‡â€</i>åº”ç”¨ç¨‹åºä¸­æè¿°ä»¤æˆ‘æ»¡æ„çš„å…·ä½“å°äº‹æƒ…ï¼Œç„¶åä»¥é€‚å½“çš„é¡ºåºå®ç°å®ƒä»¬ã€‚ <br><br><ol><li> å¤§é›†åˆä¸­çš„è§†å·®æ•ˆæœ </li><li> å°‘é‡æ”¶è—çš„å…ƒç´ å±…ä¸­ã€‚ </li><li> å°é›†åˆä¸­é¡¹ç›®çš„åŠ¨æ€å¤§å° </li><li> æ”¾ç½®å°å•å…ƒæ ¼å…ƒç´ çš„é€»è¾‘ä¸ä»…å–å†³äºcontentOffsetï¼Œè¿˜å–å†³äºç”¨æˆ·äº¤äº’ </li><li> ç”¨äºç§»åŠ¨å’Œåˆ é™¤çš„è‡ªå®šä¹‰åŠ¨ç”» </li><li> æ›´æ”¹æ–¹å‘æ—¶ï¼Œâ€œæ´»åŠ¨â€å•å…ƒæ ¼çš„ç´¢å¼•ä¸ä¼šä¸¢å¤± </li></ol><br><h3>  1.è§†å·® </h3><br> ä»€ä¹ˆæ˜¯è§†å·®ï¼Ÿ <br><blockquote> è§†å·®æ»šåŠ¨æ˜¯è®¡ç®—æœºå›¾å½¢å­¦ä¸­çš„ä¸€ç§æŠ€æœ¯ï¼Œå…¶ä¸­èƒŒæ™¯å›¾åƒæ¯”å‰æ™¯å›¾åƒç§»åŠ¨é€šè¿‡ç›¸æœºçš„é€Ÿåº¦æ›´æ…¢ï¼Œä»è€Œåœ¨2Dåœºæ™¯ä¸­äº§ç”Ÿæ·±åº¦å¹»è§‰ï¼Œå¹¶å¢åŠ äº†è™šæ‹Ÿä½“éªŒçš„æ²‰æµ¸æ„Ÿã€‚ </blockquote> æ‚¨ä¼šæ³¨æ„åˆ°ï¼Œæ»šåŠ¨æ—¶ï¼Œå•å…ƒæ ¼çš„å¸§ç§»åŠ¨é€Ÿåº¦å¿«äºå…¶ä¸­çš„å›¾åƒã€‚ <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/9u/qc/7j/9uqc7jfa_e81lg-_9h6uleidmdg.gif"></div><div style="text-align:center;"><img src="https://habrastorage.org/webt/oc/jt/nv/ocjtnvvyckaotg52-tooulyfddq.png"></div><br> è®©æˆ‘ä»¬å¼€å§‹å§ï¼ åˆ›å»ºå•å…ƒçš„å­ç±»ï¼Œå°†UIImageViewæ”¾å…¥å…¶ä¸­ã€‚ <br><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PreviewCollectionViewCell</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UICollectionViewCell</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> imageView = <span class="hljs-type"><span class="hljs-type">UIImageView</span></span>()â€‹ <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>(frame: <span class="hljs-type"><span class="hljs-type">CGRect</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">init</span></span>(frame: frame) addSubview(imageView) clipsToBounds = <span class="hljs-literal"><span class="hljs-literal">true</span></span> imageView.snp.makeConstraints { $<span class="hljs-number"><span class="hljs-number">0</span></span>.edges.equalToSuperview() } } }</code> </pre><br> ç°åœ¨ï¼Œæ‚¨éœ€è¦äº†è§£å¦‚ä½•ç§»åŠ¨<code>imageView</code> ï¼Œä»¥åˆ›å»ºè§†å·®æ•ˆæœã€‚ ä¸ºæ­¤ï¼Œæ‚¨éœ€è¦åœ¨æ»šåŠ¨è¿‡ç¨‹ä¸­é‡æ–°å®šä¹‰å•å…ƒæ ¼çš„è¡Œä¸ºã€‚ è‹¹æœï¼š <br><blockquote> é¿å…å­ç±»åŒ–<code>UICollectionView</code> ã€‚ é›†åˆè§†å›¾å‡ ä¹æ²¡æœ‰æˆ–æ²¡æœ‰å®ƒè‡ªå·±çš„å¤–è§‚ã€‚ è€Œæ˜¯ä»æ•°æ®æºå¯¹è±¡ä¸­æå–æ‰€æœ‰è§†å›¾ï¼Œå¹¶ä»å¸ƒå±€å¯¹è±¡ä¸­æå–æ‰€æœ‰ä¸å¸ƒå±€æœ‰å…³çš„ä¿¡æ¯ã€‚ å¦‚æœè¦å°è¯•åœ¨ä¸‰ä¸ªç»´åº¦ä¸Šå¸ƒç½®é¡¹ç›®ï¼Œåˆ™æ­£ç¡®çš„æ–¹æ³•æ˜¯å®æ–½è‡ªå®šä¹‰å¸ƒå±€ï¼Œè¯¥å¸ƒå±€è®¾ç½®æ¯ä¸ªå•å…ƒçš„3Då˜æ¢å¹¶æ­£ç¡®æŸ¥çœ‹ã€‚ </blockquote> å¥½çš„ï¼Œè®©æˆ‘ä»¬åˆ›å»º<b>å¸ƒå±€å¯¹è±¡</b> ã€‚  <code>UICollectionView</code>å…·æœ‰å±æ€§<code>collectionViewLayout</code> ï¼Œå®ƒä»ä¸­å­¦ä¹ æœ‰å…³å•å…ƒæ ¼ä½ç½®çš„ä¿¡æ¯ã€‚  <code>UICollectionViewFlowLayout</code>æ˜¯æŠ½è±¡<code>UICollectionViewLayout</code>çš„å®ç°ï¼Œåè€…æ˜¯<code>collectionViewLayout</code>å±æ€§ã€‚ <br><blockquote>  <code>UICollectionViewLayout</code>æ­£åœ¨ç­‰å¾…æœ‰äººå¯¹å…¶è¿›è¡Œå­ç±»åŒ–å¹¶æä¾›é€‚å½“çš„å†…å®¹ã€‚  <code>UICollectionViewFlowLayout</code>æ˜¯<code>UICollectionViewFlowLayout</code>çš„å…·ä½“ç±»ï¼Œå·²å®ç°æ‰€æœ‰å››ä¸ªæˆå‘˜ï¼Œä»¥è¿™ç§æ–¹å¼å°†ä»¥ç½‘æ ¼æ–¹å¼æ’åˆ—å•å…ƒã€‚ <br></blockquote> åˆ›å»º<code>UICollectionViewFlowLayout</code>çš„å­ç±»å¹¶è¦†ç›–å…¶<code>layoutAttributesForElements(in:)</code> ã€‚ è¯¥æ–¹æ³•è¿”å›ä¸€ä¸ª<code>UICollectionViewLayoutAttributes</code>æ•°ç»„ï¼Œè¯¥æ•°ç»„æä¾›æœ‰å…³å¦‚ä½•æ˜¾ç¤ºç‰¹å®šå•å…ƒæ ¼çš„ä¿¡æ¯ã€‚ <br><br> æ¯å½“<code>contentOffset</code>æ›´æ”¹æ—¶ï¼Œä»¥åŠå¸ƒå±€æ— æ•ˆæ—¶ï¼Œæ”¶é›†è¯·æ±‚å±æ€§ã€‚ å¦å¤–ï¼Œæˆ‘ä»¬å°†é€šè¿‡æ·»åŠ <code>parallaxValue</code>å±æ€§æ¥åˆ›å»ºè‡ªå®šä¹‰å±æ€§ï¼Œè¯¥å±æ€§ç¡®å®šå›¾ç‰‡çš„å¸§ç›¸å¯¹äºå•å…ƒæ ¼çš„å¸§å»¶è¿Ÿäº†å¤šå°‘ã€‚ å¯¹äºå±æ€§å­ç±»ï¼Œå¿…é¡»<code>NSCopiyng</code>è¦†ç›–<code>NSCopiyng</code> ã€‚ è‹¹æœï¼š <br><blockquote> å¦‚æœæ‚¨ç»§æ‰¿å¹¶å®ç°äº†ä»»ä½•è‡ªå®šä¹‰å¸ƒå±€å±æ€§ï¼Œåˆ™è¿˜å¿…é¡»é‡å†™ç»§æ‰¿çš„isEqualï¼šæ–¹æ³•ä»¥æ¯”è¾ƒå±æ€§çš„å€¼ã€‚ åœ¨iOS 7å’Œæ›´é«˜ç‰ˆæœ¬ä¸­ï¼Œå¦‚æœé›†åˆå±æ€§æœªæ›´æ”¹ï¼Œåˆ™å®ƒä»¬ä¸ä¼šåº”ç”¨å¸ƒå±€å±æ€§ã€‚ å®ƒé€šè¿‡ä½¿ç”¨isEqualï¼šæ–¹æ³•æ¯”è¾ƒæ—§å±æ€§å¯¹è±¡å’Œæ–°å±æ€§å¯¹è±¡æ¥ç¡®å®šå±æ€§æ˜¯å¦å·²æ›´æ”¹ã€‚ å› ä¸ºæ­¤æ–¹æ³•çš„é»˜è®¤å®ç°ä»…æ£€æŸ¥æ­¤ç±»çš„ç°æœ‰å±æ€§ï¼Œæ‰€ä»¥æ‚¨å¿…é¡»å®ç°è‡ªå·±çš„æ–¹æ³•ç‰ˆæœ¬ä»¥æ¯”è¾ƒä»»ä½•å…¶ä»–å±æ€§ã€‚ å¦‚æœæ‚¨çš„è‡ªå®šä¹‰å±æ€§éƒ½ç›¸ç­‰ï¼Œè¯·è°ƒç”¨<code>super</code>å¹¶åœ¨å®ç°ç»“æŸæ—¶è¿”å›ç»“æœå€¼ã€‚ <br></blockquote> å¦‚ä½•æ‰¾å‡º<code>parallaxValue</code> ï¼Ÿ è®©æˆ‘ä»¬è®¡ç®—ä¸€ä¸‹æ‚¨éœ€è¦ç§»åŠ¨å¤šå°‘ä½ç½®æ‰èƒ½ä½¿å…¶ä½äºä¸­å¿ƒã€‚ å¦‚æœæ­¤è·ç¦»å¤§äºå•å…ƒæ ¼çš„å®½åº¦ï¼Œè¯·å¯¹å…¶è¿›è¡Œé”¤å‡»ã€‚ å¦åˆ™ï¼Œå°†æ­¤è·ç¦»é™¤ä»¥<b>å•å…ƒ</b>çš„å®½åº¦ã€‚ è¯¥è·ç¦»è¶Šæ¥è¿‘é›¶ï¼Œè§†å·®æ•ˆæœè¶Šå¼±ã€‚ <br><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ParallaxLayoutAttributes</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UICollectionViewLayoutAttributes</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> parallaxValue: <span class="hljs-type"><span class="hljs-type">CGFloat?</span></span> }â€‹ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PreviewLayout</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UICollectionViewFlowLayout</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> offsetBetweenCells: <span class="hljs-type"><span class="hljs-type">CGFloat</span></span> = <span class="hljs-number"><span class="hljs-number">44</span></span>â€‹ <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">shouldInvalidateLayout</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(forBoundsChange newBounds: CGRect)</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">Bool</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> }â€‹ <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">var</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">layoutAttributesClass</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AnyClass</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-type"><span class="hljs-type">ParallaxLayoutAttributes</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> }â€‹ <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">layoutAttributesForElements</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">in</span></span></span></span><span class="hljs-function"><span class="hljs-params"> rect: CGRect)</span></span></span></span> -&gt; [<span class="hljs-type"><span class="hljs-type">UICollectionViewLayoutAttributes</span></span>]? { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.layoutAttributesForElements(<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>: rect)? .compactMap { $<span class="hljs-number"><span class="hljs-number">0</span></span>.copy() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>? <span class="hljs-type"><span class="hljs-type">ParallaxLayoutAttributes</span></span> } .compactMap(prepareAttributes) }â€‹ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prepareAttributes</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(attributes: ParallaxLayoutAttributes)</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">ParallaxLayoutAttributes</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">guard</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> collectionView = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.collectionView <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> attributes }â€‹ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> width = itemSize.width <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> centerX = width / <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> distanceToCenter = attributes.center.x - collectionView.contentOffset.x <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> relativeDistanceToCenter = (distanceToCenter - centerX) / widthâ€‹ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-built_in"><span class="hljs-built_in">abs</span></span>(relativeDistanceToCenter) &gt;= <span class="hljs-number"><span class="hljs-number">1</span></span> { attributes.parallaxValue = <span class="hljs-literal"><span class="hljs-literal">nil</span></span> attributes.transform = .identity } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { attributes.parallaxValue = relativeDistanceToCenter attributes.transform = <span class="hljs-type"><span class="hljs-type">CGAffineTransform</span></span>(translationX: relativeDistanceToCenter * offsetBetweenCells, y: <span class="hljs-number"><span class="hljs-number">0</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> attributes } }</code> </pre> <div style="text-align:center;"><img src="https://habrastorage.org/webt/2u/pw/f3/2upwf3rrqmsjxh-btqrm3zau7tm.png"></div><br><br><img src="https://habrastorage.org/webt/bz/x_/ol/bzx_olvusogre4usqir2uvl3uxm.png" alt="å›¾ç‰‡"><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/fx/pi/9z/fxpi9zj22hrlkywk5ptjieqq9ma.png"></div><br> å½“é›†åˆæ”¶åˆ°å¿…è¦çš„å±æ€§æ—¶ï¼Œå•å…ƒ<b>å°†åº”ç”¨</b>å®ƒä»¬ã€‚ å¯ä»¥åœ¨å•å…ƒçš„å­ç±»ä¸­è¦†ç›–æ­¤è¡Œä¸ºã€‚ è®©æˆ‘ä»¬æ ¹æ®<code>parallaxValue</code>å€¼<code>imageView</code> ã€‚ ä½†æ˜¯ï¼Œ <code>contentMode == .aspectFit</code>çš„å›¾ç‰‡ç§»ä½æ­£å¸¸å·¥ä½œï¼Œè¿™è¿˜ä¸å¤Ÿï¼Œå› ä¸ºå›¾ç‰‡æ¡†ä¸<code>clipsToBounds == true</code>æ¡†ä¸ä¸€è‡´ï¼Œå½“<code>clipsToBounds == true</code>æ—¶ï¼Œå›¾åƒæ¡†å°†è¢«è£å‰ªã€‚ æ”¾ç½®ä¸€ä¸ªä¸å›¾åƒå¤§å°åŒ¹é…çš„é®ç½©ï¼Œå¹¶ä½¿ç”¨é€‚å½“çš„<code>contentMode</code> ï¼Œå¦‚æœ‰å¿…è¦ï¼Œæˆ‘ä»¬å°†å¯¹å…¶è¿›è¡Œæ›´æ–°ã€‚ ç°åœ¨ä¸€åˆ‡æ­£å¸¸ï¼ <br><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PreviewCollectionViewCell</span></span></span><span class="hljs-class"> </span></span>{â€‹ <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">layoutSubviews</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> {â€‹ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.layoutSubviews() <span class="hljs-keyword"><span class="hljs-keyword">guard</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> imageSize = imageView.image?.size <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> imageRect = <span class="hljs-type"><span class="hljs-type">AVMakeRect</span></span>(aspectRatio: imageSize, insideRect: bounds)â€‹ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> path = <span class="hljs-type"><span class="hljs-type">UIBezierPath</span></span>(rect: imageRect) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> shapeLayer = <span class="hljs-type"><span class="hljs-type">CAShapeLayer</span></span>() shapeLayer.path = path.cgPath layer.mask = shapeLayer } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">apply</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> layoutAttributes: UICollectionViewLayoutAttributes)</span></span></span></span> {â€‹ <span class="hljs-keyword"><span class="hljs-keyword">guard</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> attrs = layoutAttributes <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>? <span class="hljs-type"><span class="hljs-type">ParallaxLayoutAttributes</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.apply(layoutAttributes) } <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> parallaxValue = attrs.parallaxValue ?? <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> transition = -(bounds.width * <span class="hljs-number"><span class="hljs-number">0.3</span></span> * parallaxValue) imageView.transform = <span class="hljs-type"><span class="hljs-type">CGAffineTransform</span></span>(translationX: transition, y: .zero) } }</code> </pre> <div style="text-align:center;"><img src="https://habrastorage.org/webt/j_/9e/-h/j_9e-hdvix9nueitnhf0elsk80o.png"></div><br><br><h3>  2.å°‘é‡æ”¶è—çš„å…ƒç´ å±…ä¸­ </h3><br><img src="https://habrastorage.org/getpro/habr/post_images/6cc/d9e/a78/6ccd9ea78faa45a085233d593c6feddb.gif"><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/c9/ld/ra/c9ldral4qoinyvhoacyfveqbwtm.png"></div><br> è¿™é‡Œçš„ä¸€åˆ‡éƒ½å¾ˆç®€å•ã€‚ é€šè¿‡åœ¨å·¦å³ä¸¤ä¾§éƒ½è®¾ç½®è¾ƒå¤§çš„<code>inset</code> ï¼Œå¯ä»¥å®ç°æ­¤æ•ˆæœã€‚ å·¦å³æ»šåŠ¨æ—¶ï¼Œä»…å½“æœ€åä¸€ä¸ªå•å…ƒæ ¼ç¦»å¼€å¯è§å†…å®¹æ—¶æ‰éœ€è¦å¼€å§‹<code>bouncing</code> ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯è§å†…å®¹åº”ç­‰äºå•å…ƒæ ¼çš„å¤§å°ã€‚ <br><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ThumbnailFlowLayout</span></span></span><span class="hljs-class"> </span></span>{â€‹ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> farInset: <span class="hljs-type"><span class="hljs-type">CGFloat</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">guard</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> collection = collectionView <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> .zero } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (collection.bounds.width - itemSize.width) / <span class="hljs-number"><span class="hljs-number">2</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> insets: <span class="hljs-type"><span class="hljs-type">UIEdgeInsets</span></span> { <span class="hljs-type"><span class="hljs-type">UIEdgeInsets</span></span>(top: .zero, <span class="hljs-keyword"><span class="hljs-keyword">left</span></span>: farInset, bottom: .zero, <span class="hljs-keyword"><span class="hljs-keyword">right</span></span>: farInset) }â€‹ <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prepare</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { collectionView?.contentInset = insets <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.prepare() } }</code> </pre> <div style="text-align:center;"><img src="https://habrastorage.org/webt/vv/me/ty/vvmetyazz7-6mzze8-7knxoasxw.png"></div><br><br><img src="https://habrastorage.org/webt/hr/qa/k6/hrqak6wkoeqsf7nvy8bky_tauym.jpeg" alt="å›¾ç‰‡"><div style="text-align:center;"><img src="https://habrastorage.org/webt/he/pk/br/hepkbrq20vpteyatek3hv8pi8mg.png"></div><br><br> æœ‰å…³å±…ä¸­çš„æ›´å¤šä¿¡æ¯ï¼šå½“é›†åˆå®Œæˆæ»šåŠ¨æ—¶ï¼Œå¸ƒå±€å°†è¯·æ±‚<code>contentOffset</code>åœåœ¨è¯¥ä½ç½®ã€‚ ä¸ºæ­¤ï¼Œè¯·é‡å†™<code>targetContentOffset(forProposedContentOffset:withScrollingVelocity:)</code> ã€‚ è‹¹æœï¼š <br><blockquote> å¦‚æœå¸Œæœ›æ»šåŠ¨è¡Œä¸ºæ•æ‰åˆ°ç‰¹å®šè¾¹ç•Œï¼Œåˆ™å¯ä»¥è¦†ç›–æ­¤æ–¹æ³•ï¼Œå¹¶ä½¿ç”¨å®ƒæ¥æ›´æ”¹åœæ­¢ç‚¹ã€‚ ä¾‹å¦‚ï¼Œæ‚¨å¯èƒ½ä½¿ç”¨æ­¤æ–¹æ³•å§‹ç»ˆåœæ­¢åœ¨é¡¹ç›®ä¹‹é—´çš„è¾¹ç•Œä¸Šæ»šåŠ¨ï¼Œè€Œä¸æ˜¯åœ¨é¡¹ç›®ä¸­é—´åœæ­¢ã€‚ <br></blockquote> ä¸ºäº†ä½¿ä¸€åˆ‡å˜å¾—ç¾ä¸½ï¼Œæˆ‘ä»¬å°†<b>å§‹ç»ˆ</b>åœåœ¨æœ€è¿‘çš„å•å…ƒæ ¼çš„ä¸­å¿ƒã€‚ è®¡ç®—æœ€æ¥è¿‘çš„å•å…ƒæ ¼çš„ä¸­å¿ƒæ˜¯ä¸€ä»¶å¾®ä¸è¶³é“çš„ä»»åŠ¡ï¼Œä½†æ˜¯æ‚¨éœ€è¦å°å¿ƒå¹¶è€ƒè™‘<code>contentInset</code> ã€‚ <br><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">targetContentOffset</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(forProposedContentOffset proposedContentOffset: CGPoint, withScrollingVelocity velocity: CGPoint)</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">CGPoint</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">guard</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> collection = collectionView <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.targetContentOffset(forProposedContentOffset: proposedContentOffset, withScrollingVelocity: velocity) } <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> cellWithSpacing = itemSize.width + config.distanceBetween <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> relative = (proposedContentOffset.x + collection.contentInset.<span class="hljs-keyword"><span class="hljs-keyword">left</span></span>) / cellWithSpacing <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> leftIndex = <span class="hljs-built_in"><span class="hljs-built_in">max</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>, floor(relative)) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> rightIndex = <span class="hljs-built_in"><span class="hljs-built_in">min</span></span>(ceil(relative), <span class="hljs-type"><span class="hljs-type">CGFloat</span></span>(itemsCount)) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> leftCenter = leftIndex * cellWithSpacing - collection.contentInset.<span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> rightCenter = rightIndex * cellWithSpacing - collection.contentInset.<span class="hljs-keyword"><span class="hljs-keyword">left</span></span>â€‹ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-built_in"><span class="hljs-built_in">abs</span></span>(leftCenter - proposedContentOffset.x) &lt; <span class="hljs-built_in"><span class="hljs-built_in">abs</span></span>(rightCenter - proposedContentOffset.x) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-type"><span class="hljs-type">CGPoint</span></span>(x: leftCenter, y: proposedContentOffset.y) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-type"><span class="hljs-type">CGPoint</span></span>(x: rightCenter, y: proposedContentOffset.y) } }</code> </pre> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/n4/dj/ed/n4djedqhgual-kqq4o3vg-mjxay.gif"></div><div style="text-align:center;"><img src="https://habrastorage.org/webt/0x/bj/xn/0xbjxn8vk5gxiuwvjvjklvhfusa.png"></div><br><br><h3>  3.å°é›†åˆå…ƒç´ çš„åŠ¨æ€å¤§å° </h3><br> å¦‚æœæ»šåŠ¨å¤§é›†åˆï¼Œåˆ™<code>contentOffset</code>å°†æ›´æ”¹ä¸ºä¸€ä¸ªå°é›†åˆã€‚ è€Œä¸”ï¼Œå°‘é‡æ”¶è—å“çš„ä¸­å¤®å•å…ƒæ ¼æ²¡æœ‰å…¶ä½™éƒ¨åˆ†å¤§ã€‚ è¾¹å•å…ƒçš„å¤§å°å›ºå®šï¼Œä¸­é—´çš„è¾¹å•å…ƒä¸å…¶åŒ…å«çš„å›¾ç‰‡çš„çºµæ¨ªæ¯”ä¸€è‡´ã€‚ <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6e3/c61/03e/6e3c6103e3602c9a3cbf0b7553a05386.gif"><div style="text-align:center;"><img src="https://habrastorage.org/webt/hw/8q/ma/hw8qma82pik2sus_ul5rbvu8rbm.png"></div><br> æ‚¨å¯ä»¥ä½¿ç”¨ä¸è§†å·®ç›¸åŒçš„æŠ€æœ¯ã€‚ è®©æˆ‘ä»¬ä¸ºä¸€ä¸ªå°é›†åˆåˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰<code>UICollectionViewFlowLayout</code>å¹¶é‡æ–°å®šä¹‰<code>prepareAttributes(attributes:</code>é‰´äºè¯¥å°é›†åˆçš„å¸ƒå±€é€»è¾‘å°†å˜å¾—æ›´åŠ å¤æ‚ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„å®ä½“æ¥å­˜å‚¨å’Œè®¡ç®—å•å…ƒæ ¼å‡ ä½•ã€‚ <br><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Cell</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> indexPath: <span class="hljs-type"><span class="hljs-type">IndexPath</span></span>â€‹ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> dims: <span class="hljs-type"><span class="hljs-type">Dimensions</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> state: <span class="hljs-type"><span class="hljs-type">State</span></span>â€‹ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updated</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(new state: State)</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">Cell</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-type"><span class="hljs-type">Cell</span></span>(indexPath: indexPath, dims: dims, state: state) } }â€‹ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Cell</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Dimensions</span></span></span><span class="hljs-class"> </span></span>{â€‹ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> defaultSize: <span class="hljs-type"><span class="hljs-type">CGSize</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> aspectRatio: <span class="hljs-type"><span class="hljs-type">CGFloat</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> inset: <span class="hljs-type"><span class="hljs-type">CGFloat</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> insetAsExpanded: <span class="hljs-type"><span class="hljs-type">CGFloat</span></span> }â€‹ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">State</span></span></span><span class="hljs-class"> </span></span>{â€‹ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> expanding: <span class="hljs-type"><span class="hljs-type">CGFloat</span></span>â€‹ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> `<span class="hljs-keyword"><span class="hljs-keyword">default</span></span>`: <span class="hljs-type"><span class="hljs-type">State</span></span> { <span class="hljs-type"><span class="hljs-type">State</span></span>(expanding: .zero) } } }</code> </pre> <div style="text-align:center;"><img src="https://habrastorage.org/webt/0c/ma/im/0cmaim03nqx9dpkohrfumymr11a.png"></div><br>  <code>UICollectionViewFlowLayout</code>å…·æœ‰<code>collectionViewContentSize</code>å±æ€§ï¼Œè¯¥å±æ€§ç¡®å®šå¯ä»¥æ»šåŠ¨çš„åŒºåŸŸçš„å¤§å°ã€‚ ä¸ºäº†ä¸ä½¿æˆ‘ä»¬çš„ç”Ÿæ´»å¤æ‚åŒ–ï¼Œè®©æˆ‘ä»¬ä¿æŒå…¶æ’å®šä¸å˜ï¼Œè€Œä¸ä¸­å¤®å•å…ƒçš„å¤§å°æ— å…³ã€‚ ä¸ºäº†ä½¿æ¯ä¸ªå•å…ƒæ ¼å…·æœ‰æ­£ç¡®çš„å‡ ä½•å½¢çŠ¶ï¼Œæ‚¨éœ€è¦äº†è§£å›¾ç‰‡çš„<code>aspectRatio</code>å’Œè·<code>contentOffset</code>å•å…ƒæ ¼ä¸­å¿ƒçš„è·ç¦»ã€‚ å•å…ƒæ ¼è¶Šè¿‘ï¼Œå…¶<code>size.width / size.height</code>è¶Šæ¥è¿‘<code>aspectRatio</code> ã€‚ è°ƒæ•´ç‰¹å®šå•å…ƒæ ¼çš„å¤§å°æ—¶ï¼Œè¯·ä½¿ç”¨<code>affineTransform</code>ç§»åŠ¨å…¶ä½™å•å…ƒæ ¼ï¼ˆå‘å·¦å’Œå‘å³ï¼‰ã€‚ äº‹å®è¯æ˜ï¼Œè¦è®¡ç®—ç‰¹å®šå•å…ƒçš„å‡ ä½•å½¢çŠ¶ï¼Œæ‚¨éœ€è¦äº†è§£é‚»å±…ï¼ˆå¯è§ï¼‰çš„å±æ€§ã€‚ <br><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Cell</span></span></span><span class="hljs-class"> </span></span>{â€‹ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">attributes</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(from layout: ThumbnailLayout, with sideCells: [Cell])</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">UICollectionViewLayoutAttributes?</span></span> {â€‹ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> attributes = layout.layoutAttributesForItem(at: indexPath)â€‹ attributes?.size = size attributes?.center = centerâ€‹ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> translate = sideCells.<span class="hljs-built_in"><span class="hljs-built_in">reduce</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>) { (current, cell) -&gt; <span class="hljs-type"><span class="hljs-type">CGFloat</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> indexPath &lt; cell.indexPath { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> current - cell.additionalWidth / <span class="hljs-number"><span class="hljs-number">2</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> indexPath &gt; cell.indexPath { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> current + cell.additionalWidth / <span class="hljs-number"><span class="hljs-number">2</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> current } attributes?.transform = <span class="hljs-type"><span class="hljs-type">CGAffineTransform</span></span>(translationX: translate, y: .zero)â€‹ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> attributes } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> additionalWidth: <span class="hljs-type"><span class="hljs-type">CGFloat</span></span> { (dims.defaultSize.height * dims.aspectRatio - dims.defaultSize.width) * state.expanding } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> size: <span class="hljs-type"><span class="hljs-type">CGSize</span></span> { <span class="hljs-type"><span class="hljs-type">CGSize</span></span>(width: dims.defaultSize.width + additionalWidth, height: dims.defaultSize.height) } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> center: <span class="hljs-type"><span class="hljs-type">CGPoint</span></span> { <span class="hljs-type"><span class="hljs-type">CGPoint</span></span>(x: <span class="hljs-type"><span class="hljs-type">CGFloat</span></span>(indexPath.row) * (dims.defaultSize.width + dims.inset) + dims.defaultSize.width / <span class="hljs-number"><span class="hljs-number">2</span></span>, y: dims.defaultSize.height / <span class="hljs-number"><span class="hljs-number">2</span></span>) } }</code> </pre> <br>  <code>state.expanding</code>è¢«è®¤ä¸ºä¸<code>parallaxValue</code>å‡ ä¹ç›¸åŒã€‚ <br><br><pre> <code class="swift hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cell</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">for</span></span></span></span><span class="hljs-function"><span class="hljs-params"> index: IndexPath, offsetX: CGFloat)</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">Cell</span></span> {â€‹ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> cell = <span class="hljs-type"><span class="hljs-type">Cell</span></span>( indexPath: index, dims: <span class="hljs-type"><span class="hljs-type">Cell</span></span>.<span class="hljs-type"><span class="hljs-type">Dimensions</span></span>( defaultSize: itemSize, aspectRatio: dataSource(index.row), inset: config.distanceBetween, insetAsExpanded: config.distanceBetweenFocused), state: .<span class="hljs-keyword"><span class="hljs-keyword">default</span></span>)â€‹ <span class="hljs-keyword"><span class="hljs-keyword">guard</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> attribute = cell.attributes(from: <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, with: []) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cell }â€‹ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> cellOffset = attribute.center.x - itemSize.width / <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> widthWithOffset = itemSize.width + config.distanceBetween <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-built_in"><span class="hljs-built_in">abs</span></span>(cellOffset - offsetX) &lt; widthWithOffset { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> expanding = <span class="hljs-number"><span class="hljs-number">1</span></span> - <span class="hljs-built_in"><span class="hljs-built_in">abs</span></span>(cellOffset - offsetX) / widthWithOffset <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cell.updated(by: .expand(expanding)) } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cell }â€‹ <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">layoutAttributesForElements</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">in</span></span></span></span><span class="hljs-function"><span class="hljs-params"> rect: CGRect)</span></span></span></span> -&gt; [<span class="hljs-type"><span class="hljs-type">UICollectionViewLayoutAttributes</span></span>]? { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-number"><span class="hljs-number">0</span></span> ..&lt; itemsCount) .<span class="hljs-built_in"><span class="hljs-built_in">map</span></span> { <span class="hljs-type"><span class="hljs-type">IndexPath</span></span>(row: $<span class="hljs-number"><span class="hljs-number">0</span></span>, section: <span class="hljs-number"><span class="hljs-number">0</span></span>) } .<span class="hljs-built_in"><span class="hljs-built_in">map</span></span> { cell(<span class="hljs-keyword"><span class="hljs-keyword">for</span></span>: $<span class="hljs-number"><span class="hljs-number">0</span></span>, offsetX: offsetWithoutInsets.x) } .compactMap { $<span class="hljs-number"><span class="hljs-number">0</span></span>.attributes(from: <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, with: cells) } }</code> </pre> <br><br><h3>  4.æ”¾ç½®å°å•å…ƒæ ¼å…ƒç´ çš„é€»è¾‘ä¸ä»…å–å†³äºcontentOffsetï¼Œè€Œä¸”å–å†³äºç”¨æˆ·äº¤äº’ </h3><br> å½“ç”¨æˆ·æ»šåŠ¨æµè§ˆä¸€ä¸ªå°é›†åˆæ—¶ï¼Œæ‰€æœ‰å•å…ƒæ ¼çš„å¤§å°å‡ç›¸åŒã€‚ æ»šåŠ¨å¤§é›†åˆæ—¶ï¼Œæƒ…å†µå¹¶éå¦‚æ­¤ã€‚  ï¼ˆ <i>è¯·å‚è§gif 3å’Œ5</i> ï¼‰ã€‚ è®©æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªåŠ¨ç”»å™¨ï¼Œä»¥æ›´æ–°<code>ThumbnailLayout</code>å¸ƒå±€çš„å±æ€§ã€‚ åŠ¨ç”»å¸ˆå°†è‡ªå·±å­˜å‚¨<code>DisplayLink</code>å¹¶æ¯ç§’è°ƒç”¨è¯¥å—60æ¬¡ï¼Œä»è€Œå¯ä»¥è®¿é—®å½“å‰è¿›åº¦ã€‚  <code>easing functions</code>å„ç§<code>easing functions</code>åˆ°åŠ¨ç”»åˆ¶ä½œå™¨ä¸Šå¾ˆå®¹æ˜“ã€‚ å¯ä»¥åœ¨æ–‡ç« æœ«å°¾çš„é“¾æ¥ä¸Šçš„githubä¸ŠæŸ¥çœ‹å®ç°ã€‚ <br><br> è®©æˆ‘ä»¬åœ¨<code>ThumbnailLayout</code>è¾“å…¥<code>expandingRate</code>å±æ€§ï¼Œé€šè¿‡è¯¥å±æ€§<code>expanding</code>æ‰€æœ‰<code>Cell</code> <code>expanding</code>éƒ½å°†ç›¸ä¹˜ã€‚ äº‹å®è¯æ˜ï¼Œ <code>expandingRate</code>è¡¨ç¤ºå¦‚æœç‰¹å®šå›¾ç‰‡å±…ä¸­ï¼Œåˆ™å®ƒå°†åœ¨<code>aspectRatio</code>å½±å“å…¶å°ºå¯¸ã€‚ ä½¿ç”¨<code>expandingRate == 0</code>æ‰€æœ‰åƒå…ƒçš„å¤§å°ç›¸åŒã€‚ åœ¨ä¸€ä¸ªå°é›†åˆçš„æ»šåŠ¨å¼€å§‹æ—¶ï¼Œæˆ‘ä»¬å°†è¿è¡Œä¸€ä¸ªåŠ¨ç”»å™¨ï¼Œè¯¥åŠ¨ç”»å™¨å°†ExpandingRateè®¾ç½®ä¸º0ï¼Œåœ¨æ»šåŠ¨ç»“æŸæ—¶ï¼Œåä¹‹äº¦ç„¶ï¼Œå°†å…¶è®¾ç½®ä¸º1ã€‚å®é™…ä¸Šï¼Œåœ¨æ›´æ–°å¸ƒå±€æ—¶ï¼Œä¸­å¤®å•å…ƒå’Œä¾§é¢å•å…ƒçš„å¤§å°å°†å‘ç”Ÿå˜åŒ–ã€‚ ä¸<code>contentOffset</code>å’ŒæŠ½ææ²¡æœ‰<code>contentOffset</code> ï¼ <br><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ScrollAnimation</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSObject</span></span></span><span class="hljs-class"> </span></span>{â€‹ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">enum</span></span></span><span class="hljs-class"> `</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Type</span></span></span><span class="hljs-class">` </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> begin <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> end }â€‹ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> type: <span class="hljs-type"><span class="hljs-type">Type</span></span>â€‹ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(completion: @escaping </span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">()</span></span></span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">Void</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> toValue: <span class="hljs-type"><span class="hljs-type">CGFloat</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.type == .begin ? <span class="hljs-number"><span class="hljs-number">0</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> currentExpanding = thumbnails.config.expandingRate <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> duration = <span class="hljs-type"><span class="hljs-type">TimeInterval</span></span>(<span class="hljs-number"><span class="hljs-number">0.15</span></span> * <span class="hljs-built_in"><span class="hljs-built_in">abs</span></span>(currentExpanding - toValue))â€‹ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> animator = <span class="hljs-type"><span class="hljs-type">Animator</span></span>(onProgress: { current, <span class="hljs-number"><span class="hljs-number">_</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> rate = currentExpanding + (toValue - currentExpanding) * current <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.thumbnails.config.expandingRate = rate <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.thumbnails.invalidateLayout() }, easing: .easeInOut)â€‹ animator.animate(duration: duration) { <span class="hljs-number"><span class="hljs-number">_</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> completion() } } }</code> </pre> <div style="text-align:center;"><img src="https://habrastorage.org/webt/sy/sz/ff/syszffr_19xmccnvyw-do9lcqhy.png"></div><br><br><pre> <code class="swift hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">scrollViewWillBeginDragging</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> scrollView: UIScrollView)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> scrollView == thumbnails.collectionView { handle(event: .beginScrolling) <span class="hljs-comment"><span class="hljs-comment">// call ScrollAnimation.run(type: .begin) } }â€‹ func scrollViewDidEndDragging(_ scrollView: UIScrollView, willDecelerate decelerate: Bool) { if scrollView == thumbnails.collectionView &amp;&amp; !decelerate { thumbnailEndScrolling() } }â€‹ func scrollViewDidEndDecelerating(_ scrollView: UIScrollView) { if scrollView == thumbnails.collectionView { thumbnailEndScrolling() } }â€‹ func thumbnailEndScrolling() { handle(event: .endScrolling) // call ScrollAnimation.run(type: .end) }</span></span></code> </pre> <div style="text-align:center;"><img src="https://habrastorage.org/webt/nu/v0/x7/nuv0x7phez1lg2osumphtri1wao.png"></div><br><br><h3>  5.ç”¨äºç§»åŠ¨å’Œåˆ é™¤çš„è‡ªå®šä¹‰åŠ¨ç”» </h3><br> æœ‰å¾ˆå¤šæ–‡ç« è®²è¿°å¦‚ä½•åˆ¶ä½œè‡ªå®šä¹‰åŠ¨ç”»æ¥æ›´æ–°å•å…ƒæ ¼ï¼Œä½†åœ¨æˆ‘ä»¬çš„æƒ…å†µä¸‹ï¼Œå®ƒä»¬å¯¹æˆ‘ä»¬æ²¡æœ‰å¸®åŠ©ã€‚ æ–‡ç« å’Œæ•™ç¨‹æè¿°äº†å¦‚ä½•è¦†ç›–æ›´æ–°åçš„å•å…ƒæ ¼çš„å±æ€§ã€‚ åœ¨æˆ‘ä»¬çš„æƒ…å†µä¸‹ï¼Œæ›´æ”¹å·²åˆ é™¤å•å…ƒæ ¼çš„å¸ƒå±€ä¼šäº§ç”Ÿå‰¯ä½œç”¨-ç›¸é‚»å•å…ƒæ ¼çš„<code>expanding</code>ä¼šå‘ç”Ÿå˜åŒ–ï¼Œåœ¨åŠ¨ç”»è¿‡ç¨‹ä¸­ï¼Œè¯¥<code>expanding</code>å¾€å¾€ä¼šå–ä»£å·²åˆ é™¤å•å…ƒæ ¼çš„ä½ç½®ã€‚ <br><br> åœ¨<code>UICollectionViewFlowLayout</code>æ›´æ–°å†…å®¹çš„å·¥ä½œæ–¹å¼å¦‚ä¸‹ã€‚ åˆ é™¤/æ·»åŠ å•å…ƒæ ¼åï¼Œå°†å¼€å§‹<code>prepare(forCollectionViewUpdates:)</code>æ–¹æ³•ï¼Œå¹¶æä¾›ä¸€ä¸ª<code>UICollectionViewUpdateItem</code>æ•°ç»„ï¼Œè¯¥æ•°ç»„å¯å‘Šè¯‰æˆ‘ä»¬æ›´æ–°/åˆ é™¤/æ·»åŠ äº†å“ªäº›å•å…ƒæ ¼çš„ç´¢å¼•ã€‚ æ¥ä¸‹æ¥ï¼Œå¸ƒå±€å°†è°ƒç”¨ä¸€ç»„æ–¹æ³• <br><br><pre> <code class="swift hljs">finalLayoutAttributesForDisappearingItem(at:) initialLayoutAttributesForAppearingDecorationElement(ofKind:at:)</code> </pre> <br> å’Œä»–ä»¬çš„æœ‹å‹ä¸€èµ·è£…é¥°/è¡¥å……æ„è§ã€‚ æ”¶åˆ°æ›´æ–°æ•°æ®çš„å±æ€§åï¼Œå°†è°ƒç”¨<code>finalizeCollectionViewUpdates</code> ã€‚ è‹¹æœï¼š <br><blockquote> æ”¶é›†è§†å›¾å°†åœ¨æœ€åå¯¹æ‰€æœ‰æ›´æ”¹è¿›è¡ŒåŠ¨ç”»å¤„ç†ä¹‹å‰ï¼Œå°†æ­¤æ–¹æ³•ç§°ä¸ºæœ€åä¸€æ­¥ã€‚ åœ¨ç”¨äºæ‰§è¡Œæ‰€æœ‰æ’å…¥ï¼Œåˆ é™¤å’Œç§»åŠ¨åŠ¨ç”»çš„åŠ¨ç”»å—ä¸­è°ƒç”¨æ­¤æ–¹æ³•ï¼Œå› æ­¤æ‚¨å¯ä»¥æ ¹æ®éœ€è¦ä½¿ç”¨æ­¤æ–¹æ³•åˆ›å»ºå…¶ä»–åŠ¨ç”»ã€‚ å¦åˆ™ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å®ƒæ¥æ‰§è¡Œä¸ç®¡ç†å¸ƒå±€å¯¹è±¡çš„çŠ¶æ€ä¿¡æ¯ç›¸å…³çš„æ‰€æœ‰æœ€æ–°ä»»åŠ¡â€‹â€‹ã€‚ <br></blockquote> éº»çƒ¦çš„æ˜¯ï¼Œæˆ‘ä»¬åªèƒ½ä¸º<b>æ›´æ–°çš„</b>å•å…ƒæ ¼ä¸“é—¨è®¾ç½®å±æ€§ï¼Œè€Œæˆ‘ä»¬éœ€è¦ä»¥ä¸åŒçš„æ–¹å¼ä¸ºæ‰€æœ‰å•å…ƒæ ¼æ›´æ”¹å®ƒä»¬ã€‚ æ–°çš„ä¸­å¿ƒå•å…ƒæ ¼åº”æ›´æ”¹<code>aspectRatio</code> ï¼Œè€Œä¾§é¢å•å…ƒæ ¼åº”è¿›è¡Œ<code>transform</code> ã€‚ <br><br><img src="https://habrastorage.org/getpro/habr/post_images/223/6ad/9e0/2236ad9e0cff5fac58a4b490570340c4.gif"><div style="text-align:center;"><img src="https://habrastorage.org/webt/1b/wa/pf/1bwapfugwecsrwjnnw3imlnviyk.png"></div><br> åœ¨æ£€æŸ¥äº†åˆ é™¤/æ’å…¥æœŸé—´æ”¶é›†å•å…ƒçš„é»˜è®¤åŠ¨ç”»çš„å·¥ä½œåŸç†åï¼Œæˆ‘ä»¬çŸ¥é“<code>finalizeCollectionViewUpdates</code>ä¸­çš„å±‚å•å…ƒåŒ…å«<code>CABasicAnimation</code> ï¼Œå¦‚æœæ‚¨è¦ä¸ºå…¶ä½™å•å…ƒè‡ªå®šä¹‰åŠ¨ç”»ï¼Œåˆ™å¯ä»¥åœ¨å…¶ä¸­è¿›è¡Œæ›´æ”¹ã€‚ å½“æ—¥å¿—æ˜¾ç¤ºåœ¨<code>performBatchUpdates</code>å’Œ<code>prepare(forCollectionViewUpdates:)</code> <code>prepareAttributes(attributes:)</code> <code>prepare(forCollectionViewUpdates:)</code>è¢«è°ƒç”¨æ—¶ï¼Œæƒ…å†µå˜å¾—æ›´ç³Ÿäº†ï¼Œå•å…ƒæ ¼çš„æ•°é‡å¯èƒ½å·²ç»é”™è¯¯ï¼Œå°½ç®¡<code>collectionViewUpdates</code>å°šæœªå¯åŠ¨ï¼Œä½†å¾ˆéš¾ç»´æŠ¤å’Œç†è§£ã€‚ è¯¥æ€ä¹ˆåŠï¼Ÿ æ‚¨å¯ä»¥ç¦ç”¨è¿™äº›å†…ç½®åŠ¨ç”»ï¼ <br><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prepare</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(forCollectionViewUpdates updateItems: [UICollectionViewUpdateItem])</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.prepare(forCollectionViewUpdates: updateItems) <span class="hljs-type"><span class="hljs-type">CATransaction</span></span>.begin() <span class="hljs-type"><span class="hljs-type">CATransaction</span></span>.setDisableActions(<span class="hljs-literal"><span class="hljs-literal">true</span></span>) }â€‹ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">finalizeCollectionViewUpdates</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-type"><span class="hljs-type">CATransaction</span></span>.commit() }</code> </pre><div style="text-align:center;"><img src="https://habrastorage.org/webt/69/ja/x4/69jax4yhfpsjyr5jej-xxpb6pkc.png"></div><br> é…å¤‡äº†å·²ç»ç¼–å†™çš„åŠ¨ç”»åˆ¶ä½œå™¨ï¼Œæˆ‘ä»¬å°†æ ¹æ®è¦æ±‚åˆ é™¤æ‰€æœ‰å¿…éœ€çš„åŠ¨ç”»ï¼Œå¹¶åœ¨åŠ¨ç”»ç»“æŸæ—¶å¯åŠ¨<code>dataSource</code>æ›´æ–°ã€‚ å› æ­¤ï¼Œæˆ‘ä»¬å°†åœ¨æ›´æ–°æ—¶ç®€åŒ–é›†åˆçš„åŠ¨ç”»ï¼Œå› ä¸ºæˆ‘ä»¬è‡ªå·±æ§åˆ¶ä½•æ—¶æ›´æ”¹å•å…ƒæ ¼æ•°ã€‚ <br><br><pre> <code class="swift hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">delete</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( at indexPath: IndexPath, dataSourceUpdate: @escaping </span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">()</span></span></span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">Void</span></span>, completion: (() -&gt; <span class="hljs-type"><span class="hljs-type">Void</span></span>)?) {â€‹ <span class="hljs-type"><span class="hljs-type">DeleteAnimation</span></span>(thumbnails: thumbnails, preview: preview, index: indexPath).run { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> previousCount = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.thumbnails.itemsCount <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> previousCount == indexPath.row + <span class="hljs-number"><span class="hljs-number">1</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.activeIndex = previousCount - <span class="hljs-number"><span class="hljs-number">1</span></span> } dataSourceUpdate() <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.thumbnails.collectionView?.deleteItems(at: [indexPath]) <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.preview.collectionView?.deleteItems(at: [indexPath]) completion?() } }</code> </pre> <br> è¿™æ ·çš„åŠ¨ç”»å°†å¦‚ä½•å·¥ä½œï¼Ÿ åœ¨<code>ThumbnailLayout</code>æˆ‘ä»¬å­˜å‚¨å¯é€‰çš„æ‰‹å†Œï¼Œè¿™äº›æ‰‹å†Œå¯ä»¥æ›´æ–°ç‰¹å®šå•å…ƒæ ¼çš„å‡ ä½•å½¢çŠ¶ã€‚ <br><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ThumbnailLayout</span></span></span><span class="hljs-class"> </span></span>{â€‹ <span class="hljs-keyword"><span class="hljs-keyword">typealias</span></span> <span class="hljs-type"><span class="hljs-type">CellUpdate</span></span> = (<span class="hljs-type"><span class="hljs-type">Cell</span></span>) -&gt; <span class="hljs-type"><span class="hljs-type">Cell</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> updates: [<span class="hljs-type"><span class="hljs-type">IndexPath</span></span>: <span class="hljs-type"><span class="hljs-type">CellUpdate</span></span>] = [:] <span class="hljs-comment"><span class="hljs-comment">// ... override func layoutAttributesForElements(in rect: CGRect) -&gt; [UICollectionViewLayoutAttributes]? {â€‹ let cells = (0 ..&lt; itemsCount) .map { IndexPath(row: $0, section: 0) } .map { cell(for: $0, offsetX: offsetWithoutInsets.x) } .map { cell -&gt; Cell in if let update = self.config.updates[cell.indexPath] { return update(cell) } return cell } return cells.compactMap { $0.attributes(from: self, with: cells) } }</span></span></code> </pre> <br> æœ‰äº†è¿™æ ·çš„å·¥å…·ï¼Œæ‚¨å¯ä»¥å¯¹å•å…ƒçš„å‡ ä½•å½¢çŠ¶è¿›è¡Œä»»ä½•æ“ä½œï¼Œåœ¨åŠ¨ç”»åˆ¶ä½œå™¨å·¥ä½œæœŸé—´æŠ›å‡ºæ›´æ–°ï¼Œå¹¶åœ¨èµç¾ä¸­å°†å…¶åˆ é™¤ã€‚ ä¹Ÿæœ‰å¯èƒ½åˆå¹¶æ›´æ–°ã€‚ <br><br><pre> <code class="swift hljs">updates[index] = newUpdate(updates[index])</code> </pre><br> åˆ é™¤åŠ¨ç”»ä»£ç éå¸¸éº»çƒ¦ï¼›å®ƒä½äºå­˜å‚¨åº“ä¸­çš„<i>DeleteAnimation.swift</i>æ–‡ä»¶ä¸­ã€‚ å•å…ƒä¹‹é—´ç„¦ç‚¹åˆ‡æ¢çš„åŠ¨ç”»ä»¥ç›¸åŒçš„æ–¹å¼å®ç°ã€‚ <br><br><img src="https://habrastorage.org/getpro/habr/post_images/001/d8d/ca0/001d8dca06df6b68773652760a019bf3.gif"><div style="text-align:center;"><img src="https://habrastorage.org/webt/mi/6q/bs/mi6qbskcng_u5ehyixy1q0xp_ce.png"></div><br><br><h3>  6.æ›´æ”¹æ–¹å‘æ—¶ï¼Œâ€œæ´»åŠ¨â€å•å…ƒæ ¼çš„ç´¢å¼•ä¸ä¼šä¸¢å¤± </h3><br> å³ä½¿æ‚¨åªæ˜¯åœ¨<code>contentOffset</code>ä¸­ä»¥åŠåœ¨æ›´æ”¹æ–¹å‘æ—¶å¼¹å‡ºä¸€äº›å€¼ï¼Œä¹Ÿä¼šè°ƒç”¨<code>scrollViewDidScroll(_ scrollView:)</code> ã€‚ å½“ä¸¤ä¸ªé›†åˆçš„æ»šåŠ¨åŒæ­¥æ—¶ï¼Œåœ¨å¸ƒå±€æ›´æ–°æœŸé—´å¯èƒ½ä¼šå‡ºç°ä¸€äº›é—®é¢˜ã€‚ ä»¥ä¸‹æŠ€å·§å°†å¸®åŠ©æ‚¨ï¼šåœ¨å¸ƒå±€æ›´æ–°ä¸­ï¼Œå¯ä»¥å°†<code>scrollView.delegate</code>è®¾ç½®ä¸º<code>nil</code> ã€‚ <br><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ScrollSynchronizer</span></span></span><span class="hljs-class"> </span></span>{â€‹ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bind</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { preview.collectionView?.delegate = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span> thumbnails.collectionView?.delegate = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span> }â€‹ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">unbind</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { preview.collectionView?.delegate = <span class="hljs-literal"><span class="hljs-literal">nil</span></span> thumbnails.collectionView?.delegate = <span class="hljs-literal"><span class="hljs-literal">nil</span></span> } }</code> </pre> <br> åœ¨æ›´æ”¹æ–¹å‘æ—¶æ›´æ–°åƒå…ƒå¤§å°æ—¶ï¼Œå°†å¦‚ä¸‹æ‰€ç¤ºï¼š <br><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PhotosViewController</span></span></span><span class="hljs-class"> </span></span>{â€‹ <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">viewWillTransition</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(to size: CGSize, with coordinator: UIViewControllerTransitionCoordinator)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.viewWillTransition(to: size, with: coordinator)â€‹ contentView.synchronizer.unbind() coordinator.animate(alongsideTransition: <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) { [<span class="hljs-keyword"><span class="hljs-keyword">weak</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>] <span class="hljs-number"><span class="hljs-number">_</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>?.contentView.synchronizer.bind() } } }</code> </pre> <br> ä¸ºäº†åœ¨æ›´æ”¹æ–¹å‘æ—¶ä¸ä¼šä¸¢å¤±æœŸæœ›çš„<code>contentOffset</code> ï¼Œå¯ä»¥åœ¨<code>scrollView.delegate</code>æ›´æ–°<code>scrollView.delegate</code> ã€‚ æ›´æ”¹æ–¹å‘æ—¶ï¼Œå¦‚æœæ‚¨è¦†ç›–äº†<code>shouldInvalidateLayout(forBoundsChange:)</code> ï¼Œåˆ™å¸ƒå±€å°†è¢«ç¦ç”¨ã€‚ æ›´æ”¹<code>bounds</code>å¸ƒå±€å°†è¦æ±‚æ¾„æ¸…<code>contentOffset</code> ï¼Œä»¥ä½¿å…¶æ¾„æ¸…ï¼Œæ‚¨éœ€è¦é‡æ–°å®šä¹‰<code>targetContentOffset(forProposedContentOffset:)</code> ã€‚ è‹¹æœï¼š <br><blockquote> åœ¨å¸ƒå±€æ›´æ–°æœŸé—´æˆ–åœ¨å¸ƒå±€ä¹‹é—´è½¬æ¢æ—¶ï¼Œé›†åˆè§†å›¾å°†è°ƒç”¨æ­¤æ–¹æ³•ï¼Œä»¥ä½¿æ‚¨æœ‰æœºä¼šæ›´æ”¹å»ºè®®çš„å†…å®¹åç§»ä»¥åœ¨åŠ¨ç”»æœ«å°¾ä½¿ç”¨ã€‚ å¦‚æœåŠ¨ç”»æˆ–è¿‡æ¸¡å¯èƒ½å¯¼è‡´é¡¹ç›®ä»¥å¯¹æ‚¨çš„è®¾è®¡è€Œè¨€å¹¶éæœ€ä½³çš„æ–¹å¼æ”¾ç½®ï¼Œåˆ™å¯ä»¥è¦†ç›–æ­¤æ–¹æ³•ã€‚ <br><br> é›†åˆè§†å›¾åœ¨è°ƒç”¨<code>prepare()</code>å’Œ<code>collectionViewContentSize</code>æ–¹æ³•ä¹‹åè°ƒç”¨æ­¤æ–¹æ³•ã€‚ </blockquote><br><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">targetContentOffset</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(forProposedContentOffset proposedContentOffset: CGPoint)</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">CGPoint</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> targetOffset = <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.targetContentOffset(forProposedContentOffset: proposedContentOffset) <span class="hljs-keyword"><span class="hljs-keyword">guard</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> layoutHandler = layoutHandler <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> targetOffset } <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> offset = <span class="hljs-type"><span class="hljs-type">CGFloat</span></span>(layoutHandler.targetIndex) / <span class="hljs-type"><span class="hljs-type">CGFloat</span></span>(itemsCount) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-type"><span class="hljs-type">CGPoint</span></span>( x: collectionViewContentSize.width * offset - farInset, y: targetOffset.y) }</code> </pre> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/i5/5r/sf/i55rsfdujvblk7om3yq2yerabhu.gif"></div><div style="text-align:center;"><img src="https://habrastorage.org/webt/ng/ls/6w/ngls6wjfkhkajrg3706i_g11lyo.png"></div><br><hr><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ„Ÿè°¢æ‚¨çš„é˜…è¯»ï¼</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ‰€æœ‰ä»£ç éƒ½å¯ä»¥åœ¨</font><a href="https://github.com/YetAnotherRzmn/PhotosApp"><font style="vertical-align: inherit;">github.com/YetAnotherRzmn/PhotosAppä¸­</font></a><font style="vertical-align: inherit;">æ‰¾åˆ°</font></font><a href="https://github.com/YetAnotherRzmn/PhotosApp"><font style="vertical-align: inherit;"></font></a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN477734/">https://habr.com/ru/post/zh-CN477734/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN477722/index.html">C ++ä¸­çš„Googleæ ·å¼æŒ‡å—ã€‚ ç¬¬8éƒ¨åˆ†</a></li>
<li><a href="../zh-CN477724/index.html">HRå“ç‰Œhabraseminarï¼šå…³äºäººæ‰ï¼Œç‹©çŒå’Œå†…å®¹</a></li>
<li><a href="../zh-CN477728/index.html">å›¢é˜Ÿé¢†å¯¼åšä»€ä¹ˆï¼Œä»¥å…å›¢é˜Ÿç–²å€¦</a></li>
<li><a href="../zh-CN477730/index.html">ChipWhispererï¼šå¯¹å²©æµ†çš„èƒ½é‡æ”»å‡»</a></li>
<li><a href="../zh-CN477732/index.html">æ°´ä¸‹å¯¼èˆªç³»ç»Ÿçš„æ‰‹æŒ‡åˆ†ç±»é”™è¯¯</a></li>
<li><a href="../zh-CN477736/index.html">æµ‹è¯•äººå‘˜çš„è·¯å¾„ï¼šä»â€œæ‰‹åˆ¹â€åˆ°è‡ªåŠ¨åŒ–</a></li>
<li><a href="../zh-CN477738/index.html">iKassaæˆ–æˆ‘ä»¬å¦‚ä½•é©¯æœâ€œæ•°å­—æ”¶é“¶å‘˜â€</a></li>
<li><a href="../zh-CN477740/index.html">åœ¨å“ªé‡Œå¯ä»¥ç”¨çœ¼ç›è§‚å¯Ÿè¿™æ¶æœ›è¿œé•œï¼Ÿ</a></li>
<li><a href="../zh-CN477742/index.html">â€œä½ å¥½ï¼ŒCheckmarxï¼â€ å¦‚ä½•ç¼–å†™å¯¹Checkmarx SASTçš„è¯·æ±‚å¹¶æŸ¥æ‰¾å¾ˆé…·çš„æ¼æ´</a></li>
<li><a href="../zh-CN477744/index.html">ä¸ºä»€ä¹ˆä¸“ä¸šäººå£«æœ‰æ—¶ä¼šåˆ›å»ºä¸è‰¯çš„åº”ç”¨ç¨‹åºï¼Ÿ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>