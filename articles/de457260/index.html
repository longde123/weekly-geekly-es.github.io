<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèª‚Äçü§ù‚Äçüë®üèæ üàπ üßñ Dekodierung des LUKS-Containers beim Booten üë®üèæ‚Äç‚úàÔ∏è ‚è∞ üìé</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Guten Tag, Nacht! Dieser Beitrag ist n√ºtzlich f√ºr diejenigen, die LUKS-Datenverschl√ºsselung verwenden und die Entschl√ºsselung von Festplatten unter Li...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Dekodierung des LUKS-Containers beim Booten</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/457260/">  Guten Tag, Nacht!  Dieser Beitrag ist n√ºtzlich f√ºr diejenigen, die LUKS-Datenverschl√ºsselung verwenden und die Entschl√ºsselung von Festplatten unter Linux (Debian, Ubuntu) in der <b>Phase der Entschl√ºsselung der Root-Partition</b> <s>entschl√ºsseln</s> m√∂chten.  Und ich konnte solche Informationen im Internet nicht finden. <br><br>  In j√ºngerer Zeit stie√ü ich mit der Zunahme der Anzahl der Festplatten in den Regalen auf das Problem, Festplatten mit der mehr als bekannten Methode √ºber / etc / crypttab zu entschl√ºsseln.  Pers√∂nlich m√∂chte ich einige Probleme bei der Verwendung dieser Methode hervorheben, n√§mlich, dass die Datei <b>erst nach dem Mounten (Mounten) der Root-Partition</b> gelesen <b>wird</b> , was sich negativ auf den ZFS-Import auswirkt, insbesondere wenn sie von Partitionen auf dem * _crypt-Ger√§t oder von mdadm-Raids gesammelt wurden auch aus Abschnitten gesammelt.  <i>Wir alle wissen, dass Sie geteilte LUKS-Container verwenden k√∂nnen?</i>  Und auch das Problem des fr√ºhen Starts anderer Dienste, wenn noch keine Arrays vorhanden sind, aber etwas verwendet werden muss (ich arbeite mit Clustered Proxmox VE 5.x und ZFS √ºber iSCSI). <br><br><div class="spoiler">  <b class="spoiler_title">Ein bisschen √ºber ZFSoverISCSI</b> <div class="spoiler_text"> iSCSI funktioniert f√ºr mich √ºber LIO. Wenn das iscsi-Ziel gestartet wird und die ZVOL-Ger√§te nicht angezeigt werden, werden sie einfach aus der Konfiguration entfernt, wodurch das Laden der Gastsysteme verhindert wird.  Daher kann entweder eine JSON-Dateisicherung wiederhergestellt oder Ger√§te mit den Kennungen jeder VM manuell hinzugef√ºgt werden. Dies ist nur schrecklich, wenn Dutzende solcher Computer vorhanden sind und die Konfiguration jeweils mehr als eine Festplatte enth√§lt. <br></div></div><br>  Und die zweite Frage, die ich pr√ºfen werde, ist, wie man entschl√ºsselt (dies ist der Schl√ºsselpunkt des Artikels).  Und wir werden weiter unten dar√ºber sprechen, gehen Sie unter den Schnitt! <br><a name="habracut"></a><br>  Im Internet verwenden sie meistens eine Schl√ºsseldatei (den Befehl cryptsetup luksAddKey, der dem Slot vor sich selbst hinzugef√ºgt wurde) oder in seltenen Ausnahmen (die russische Sprache enth√§lt nur sehr wenige Informationen) - das Skript decrypt_derived in / lib / cryptsetup / script / (Nat√ºrlich gibt es immer noch M√∂glichkeiten, aber ich habe diese beiden verwendet, die die Grundlage des Artikels bildeten).  Ich bem√ºhte mich auch um eine vollst√§ndige autonome Aufnahme nach dem Neustart ohne zus√§tzliche Befehle in der Konsole, damit alles auf einmal ‚Äûabhebt‚Äú.  Warum also warten?  - - <br><br>  Fangen wir an! <br><br>  Wir gehen davon aus, dass ein System, beispielsweise Debian, auf der Kryptopartition sda3_crypt installiert ist und ein Dutzend Festplatten bereit sind, alles zu verschl√ºsseln und zu erstellen, was Sie m√∂chten.  Wir haben eine Passphrase zum Entsperren von sda3_crypt. In diesem Abschnitt entfernen wir auf einem laufenden (entschl√ºsselten) System den "Hash" aus dem Kennwort und f√ºgen ihn den anderen Laufwerken hinzu.  Alles ist elementar, in der Konsole, die wir ausf√ºhren: <br><br><pre><code class="plaintext hljs">/lib/cryptsetup/scripts/decrypt_derived sda3_crypt | cryptsetup luksFormat /dev/sdX</code> </pre> <br>  Dabei ist X unsere Festplatten, Partitionen usw. <br><br>  Nachdem Sie die Laufwerke mit einem "Hash" aus unserer Passphrase verschl√ºsselt haben, m√ºssen Sie die UUID oder ID herausfinden - je nachdem, an wen und was Sie gew√∂hnt sind.  Wir nehmen die Daten von / dev / disk / by-uuid bzw. by-id. <br><br>  Der n√§chste Schritt ist die Vorbereitung von Dateien und Miniskripten f√ºr die notwendigen Funktionen. Wir fahren fort: <br><br><pre> <code class="plaintext hljs">cp -p /usr/share/initramfs-tools/hooks/cryptroot /etc/initramfs-tools/hooks/ cp -p /usr/share/initramfs-tools/scripts/local-top/cryptroot /etc/initramfs-tools/scripts/local-top/</code> </pre> <br>  weiter <br><br><pre> <code class="plaintext hljs">touch /etc/initramfs-tools/hooks/decrypt &amp;&amp; chmod +x /etc/initramfs-tools/hooks/decrypt</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Inhalt ../decrypt</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh cp -p /lib/cryptsetup/scripts/decrypt_derived "$DESTDIR/bin/decrypt_derived"</span></span></code> </pre> <br></div></div><br>  weiter <br><br><pre> <code class="plaintext hljs">touch /etc/initramfs-tools/hooks/partcopy &amp;&amp; chmod +x /etc/initramfs-tools/hooks/partcopy</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Inhalt ../partcopy</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh cp -p /sbin/partprobe "$DESTDIR/bin/partprobe" cp -p /lib/x86_64-linux-gnu/libparted.so.2 "$DESTDIR/lib/x86_64-linux-gnu/libparted.so.2" cp -p /lib/x86_64-linux-gnu/libreadline.so.7 "$DESTDIR/lib/x86_64-linux-gnu/libreadline.so.7"</span></span></code> </pre> <br></div></div><br>  noch mehr <br><br><pre> <code class="plaintext hljs">touch /etc/initramfs-tools/scripts/local-bottom/partprobe &amp;&amp; chmod +x /etc/initramfs-tools/scripts/local-bottom/partprobe</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Inhalt ../partprobe</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh $DESTDIR/bin/partprobe</span></span></code> </pre> <br></div></div><br>  und zuletzt m√ºssen Sie vor update-initramfs die Datei / etc / initramfs-tools / scripts / local-top / cryptroot bearbeiten, beginnend mit Zeile ~ 360, ein St√ºck Code unten <br><br><div class="spoiler">  <b class="spoiler_title">Das Original</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># decrease $count by 1, apparently last try was successful. count=$(( $count - 1 )) message "cryptsetup ($crypttarget): set up successfully" break</span></span></code> </pre><br></div></div><br>  und zu dieser Form bringen <br><br><div class="spoiler">  <b class="spoiler_title">Bearbeitet</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># decrease $count by 1, apparently last try was successful. count=$(( $count - 1 )) /bin/decrypt_derived $crypttarget | cryptsetup luksOpen /dev/disk/by-uuid/ *CRYPT_MAP* /bin/decrypt_derived $crypttarget | cryptsetup luksOpen /dev/disk/by-id/ *CRYPT_MAP* message "cryptsetup ($crypttarget): set up successfully" break</span></span></code> </pre> <br></div></div><br>  Bitte beachten Sie, dass hier entweder UUID oder ID verwendet werden kann.  Die Hauptsache ist, dass die erforderlichen Treiber f√ºr die HDD / SSD-Ger√§te zu / etc / initramfs-tools / modules hinzugef√ºgt werden.  Sie k√∂nnen herausfinden, welcher Treiber von <i>udevadm info -a -n / dev / sdX | verwendet werden soll</i>  <i>egrep 'suchen | FAHRER'</i> . <br><br>  Nachdem wir fertig sind und alle Dateien vorhanden sind, f√ºhren Sie <i>update-initramfs -u -k all -v aus</i> . <b>Es sollte keine</b> Fehler bei der Ausf√ºhrung unserer Skripte in der Protokollierung geben.  Wir starten neu, geben die Passphrase ein und warten ein bisschen, abh√§ngig von der Anzahl der Festplatten.  Als n√§chstes wird das System gestartet und in der letzten Phase des Starts, dh nach dem "Mounten" der Root-Partition, wird der Befehl partprobe ausgef√ºhrt - es werden alle auf LUKS-Ger√§ten erstellten Partitionen gefunden und abgerufen, und alle Arrays, ob ZFS oder mdadm, werden problemlos zusammengesetzt!  Und das alles <b>vor dem Laden der</b> Basisdienste und Dienste, die diese Festplatten / Arrays ben√∂tigen. <br><br>  <b>update1</b> : Wie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link">AEP</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">feststellte</a> , funktioniert diese Methode nur f√ºr LUKS1. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de457260/">https://habr.com/ru/post/de457260/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de457248/index.html">JavaScript-Programmierung f√ºr eine Drehmaschine</a></li>
<li><a href="../de457250/index.html">Dunkler Tag f√ºr Vue.js.</a></li>
<li><a href="../de457254/index.html">Die Zusammenfassung interessanter Materialien f√ºr den mobilen Entwickler # 303 (17. - 23. Juni)</a></li>
<li><a href="../de457256/index.html">Internet-Verlauf: ARPANET - Paket</a></li>
<li><a href="../de457258/index.html">Die Piratenbucht seit 15 Jahren und konnte nicht t√∂ten</a></li>
<li><a href="../de457262/index.html">Analyse der Qualifikationen der Programmiermeisterschaft unter Backend-Entwicklern</a></li>
<li><a href="../de457266/index.html">Agile Krise. Was zu tun ist?</a></li>
<li><a href="../de457270/index.html">Prisma-CMS als Engine zur schnellen Erstellung von MVP</a></li>
<li><a href="../de457276/index.html">Sieben Bot-Bedrohungen f√ºr Ihre Site</a></li>
<li><a href="../de457282/index.html">"Tod Gottes" oder der Zusammenbruch allgemein anerkannter Gesetze zum Aufbau von IT-Teams und zur Schaffung von IT-Systemen im 21. Jahrhundert</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>