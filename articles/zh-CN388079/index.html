<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👼🏼 ⏸️ 🤲🏼 ATtiny85：无线传感器原型 🌅 💒 👷</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="通常，要从构思过渡到实现，需要设备的原型，便于现场检查和调试，这对于移动设备尤为重要。接下来，我将尝试尽可能详细地分析基于ATtiny85的无线传感器原型的创建过程。
 
 
 
 

 — , , : , , . CR2032, , 2.7V ( TMP36), 200mAh.
 
 

 ATt...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ATtiny85：无线传感器原型</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/388079/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">通常，要从构思过渡到实现，需要设备的原型，便于现场检查和调试，这对于移动设备尤为重要。</font><font style="vertical-align: inherit;">接下来，我将尝试尽可能详细地分析基于ATtiny85的无线传感器原型的创建过程。</font></font></p><br>
<br>
<img src="https://habrastorage.org/files/d4a/34b/4cc/d4a34b4cc32140169411513b17fdec48.png"><br>
<br>
<p> —   ,  ,                 : , , .          CR2032,  ,    2.7V (   TMP36),    200mAh.</p><br>
<br>
<p> ATtiny85   5  /    RESET    .      :</p><br>
<br>
<ul>
<li><b>3 </b> —  NRF24L01+,    ,           3-  ;</li>
<li><b>1 </b> —      BPW17N;</li>
<li><b>2 </b> —     TMP36,      ,       .</li>
</ul><br>
<br>
<p>  ,    .</p><br>
<br>
<a name="habracut"></a><br>
<br>
<h2>RESET    /</h2><br>
<br>
<p>   RESET    /.  RESET    ,        (Fuses). ,   RESET     .  ,    «»      (12V) ,   Fuse-.</p><br>
<br>
<p>     Arduino     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ATTiny Fuse Reset with 12 Volt Charge Pump</a>.      ,    12V   (Charge Pump).</p><br>
<br>
<div class="spoiler"><b class="spoiler_title">    </b><div class="spoiler_text"><p>     ,  .</p><br>
<br>
<p>  (4)   5V,     (2)    (),  <b>C1</b>   5V.   (2)  5V    <b>1</b>  10V,    <b>D2</b>,     (3),   <b>C2</b>.    (3)  (2)     15V   <b>C3</b>,    20V (   ~17V)  <b>C4</b>.     <b>R2</b>/<b>R3</b>     <b>A0</b>,     ,     12V,   (   (2)  (3)) .  <b>Q1</b>           .    ATtiny85       .</p><br>
</div></div><br>
<br>
<p>    :</p><br>
<p><img src="https://habrastorage.org/files/d3f/8d6/53f/d3f8d653fab249bc883b4fef0f8d2e65.png"></p><br>
<p><img src="https://habrastorage.org/files/553/45a/927/55345a92756444edb356d716f8bef41f.png"></p><br>
<br>
<div class="spoiler"><b class="spoiler_title">    (  )</b><div class="spoiler_text"><p><img src="https://habrastorage.org/files/d3f/91c/12b/d3f91c12b5d54ad1bff0e60c994864c7.png"></p><br>
<p>,  USB    ,    ,         .  ,    ,           :</p><br>
<p><img src="https://habrastorage.org/files/74a/4f7/0ac/74a4f70ac7d340ceb8da0e094202baef.png"></p><br>
<p>  ,            .</p><br>
</div></div><br>
<br>
<h2> </h2><br>
<br>
<p>         <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">KiCad EDA</a>,        .</p><br>
<br>
<p>  KiCad    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">GitHub</a>,   <b>attwlight_sensor.pcb</b>.</p><br>
<br>
<p>        ,      YouTube <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">KiCAD Quick-Start Tutorial</a>.</p><br>
<br>
<p>  ,        KiCad     <img src="https://habrastorage.org/files/064/b37/97b/064b3797b07241069c04bc5f903fecf0.png">     ,  :  <img src="https://habrastorage.org/files/da6/722/355/da6722355fd448ea9f06b0b674c410ff.png">,  <img src="https://habrastorage.org/files/9f1/1a0/70d/9f11a070de0d406da8616eea2bc91d7a.png">,  <img src="https://habrastorage.org/files/2d1/ab9/ff8/2d1ab9ff8d3e40a88c6d3c47453bd687.png">   <img src="https://habrastorage.org/files/d37/bd6/2b9/d37bd62b9ee242d88576266292b28d00.png">.</p><br>
<br>
<p> ,     .           .</p><br>
<br>
<p>                .            Ctrl+E (   )    :     <img src="https://habrastorage.org/files/e6b/bb4/568/e6bbb4568ff64160bed13da3c4fd2d81.png">,       <img src="https://habrastorage.org/files/763/6c0/d8f/7636c0d8f59347908f0661a462011b68.png">,      <img src="https://habrastorage.org/files/181/249/7c7/1812497c700545ffab1470e1e3720263.png">.</p><br>
<br>
<p>     ,     <nobr><b>Preferences → Component Libraries</b></nobr>,   <b>Add</b>   .      ,    <img src="https://habrastorage.org/files/657/aba/c57/657abac573bc43d9813798b767c9394c.png">     <img src="https://habrastorage.org/files/d3a/334/0d2/d3a3340d2c974b149518263928a43f7d.png">.</p><br>
<br>
<p> :</p><br>
<br>
<p><img src="https://habrastorage.org/files/9c9/7cf/978/9c97cf97834647c3a8349e205e576f69.png"></p><br>
<br>
<p> ,      .       ,        .     ,       . ,    ,    ,    .</p><br>
<br>
<h3>  TMP36</h3><br>
<br>
<p>         PB5 .             VCC  D10   P2.  RESET                      RESET.         ADC2.</p><br>
<br>
<p>     C1,      RESET . ,    RESET        ,   ,      ,      .   ,        ,       ,      —   .     ,     D1  SCK, ,         SCK  ,     .     C1  ,    ,     5V.     1.8-5.5V        3V  .     TMP36    10nF   ,      .       .</p><br>
<br>
<h3> NRF24L01+</h3><br>
<br>
<p>      KiCad      ,          NRF24L01+.     3       MISO  MOSI,     ,   : R3, D1  C2.      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">nRF24L01+ with ATtiny85 3 Pins</a>.</p><br>
<br>
<p>     ,   CE (chip enable)     ,  CSN (chip select)          ,       . , CSN       ,    SCK (clock).   SCK     C2   CSN   ,        SCK      ,      CSN.       MISO  MOSI   ,    .</p><br>
<br>
<p>       1-10μF    ,        C4.</p><br>
<br>
<p>     ,       ATtiny85   .   , avrdude     ,       …     .      ,    -      -   .         .   ,   .</p><br>
<br>
<h3> ATtiny85</h3><br>
<br>
<p>             8MHz,          .   ,         30cm,   ,   ,   , -  .      ,      ,      ,     .     ,      .  ATtiny85   1MHz     ,        .      .</p><br>
<br>
<h3>   BPW17N</h3><br>
<br>
<p>     ,      ,          .            PCINT3 (Pin Change Interrupt).</p><br>
<br>
<p> R1  C3 ,      ,    . 3    Q1  ,    .   ,       0.1μF,    10MΩ  ,       —  . ,      /    R2,    ,     .</p><br>
<br>
<p>     ,     ,     ,        .    ,       ,   7μA   260μA   .      ,  ,    (PCINT3  WDT),       ADC3,   ,       PCINT3.      ,   .</p><br>
<br>
<h2> </h2><br>
<br>
<p>     .      KiCad.        :</p><br>
<ol>
<li>    <img src="https://habrastorage.org/files/ecb/437/a7f/ecb437a7f0884d67aa271b329a7ebe0e.png">,      .</li>
<li>         <img src="https://habrastorage.org/files/d96/8d4/9e6/d968d49e6b9242c38d07813f40e5dbe1.png">.   :<br>
 <img src="https://habrastorage.org/files/9f1/cf7/17a/9f1cf717a5b941daa7eb78307ce7c03b.png"><br>
         <img src="https://habrastorage.org/files/384/222/f2d/384222f2d84b4d5eb72b60bf08856cdf.png">.<br>
        ,        1/10" (2.54mm).      ,   , ,    ,   (Ctrl+E)     .<br>
               .<br>
 </li>
<li> netlist <img src="https://habrastorage.org/files/cfa/5be/2ed/cfa5be2edda04027af5b9ceb7883f562.png">,     .</li>
</ol><br>
<br>
<p>          <img src="https://habrastorage.org/files/82e/ce9/570/82ece957077b42fc9c4930701c084145.png">.   <img src="https://habrastorage.org/files/cfa/5be/2ed/cfa5be2edda04027af5b9ceb7883f562.png">,     netlist <nobr>(Read Current Netlist)</nobr>, ,       .           ,   netlist     .</p><br>
<br>
<p>   netlist        .      1/10" (2.54mm),   (  m),    <nobr><b>Visibles → Render → Values</b></nobr> ,   ,   .</p><br>
<br>
<p>    :</p><br>
<br>
<p><img src="https://habrastorage.org/files/279/5a5/980/2795a598067c41d9801679a77502622a.png"></p><br>
<br>
<p>  ,       .    KiCad    ,         .         ,      :    <nobr><b>Visibles → Render → Footprints Front</b></nobr>,        .</p><br>
<br>
<p><img src="https://habrastorage.org/files/2af/a55/8e3/2afa558e3d154c998061b61f7d440b10.png"></p><br>
<br>
<p> :</p><br>
<br>
<p><img src="https://habrastorage.org/files/c71/ae0/90a/c71ae090a4264930bc785333e3dcd907.png"></p><br>
<br>
<p>     :     R1,C3      .</p><br>
<br>
<p><img src="https://habrastorage.org/files/f3a/791/c23/f3a791c2313b4204abec770239e3e924.png"></p><br>
<br>
<p>    ,      .   ,   ,   .</p><br>
<br>
<h2> IDE  </h2><br>
<br>
<p>Arduino IDE        AVR       .</p><br>
<br>
<p>   ,  Arduino IDE    ATtiny85,         .   ,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Programming an ATtiny w/ Arduino 1.6</a>.         ATtiny85     Arduino .     ,   ,      —         ,     .</p><br>
<br>
<p>  Arduino   ATtiny85,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">arduino-tiny</a>,   Arduino 1.5 .     ,   ,    ,  ,   .    ,   , Arduino IDE v1.6.6 - ,  c      1.6.5.</p><br>
<br>
<div class="spoiler"><b class="spoiler_title">   Arduino IDE v1.6.5</b><div class="spoiler_text"><ol>
<li>   Arduino     hardware;</li>
<li>     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">arduino-tiny-0150-0020.zip</a>   ;</li>
<li>  <nobr>«Prospective Boards.txt»</nobr>  boards.txt    ,      ,       ATtiny85,   ;</li>
<li>     Arudino IDE   <nobr><b>Tools → Board</b></nobr>       .</li>
</ol><br>
</div></div><br>
<br>
<p>  .        ,    Arduino    <nobr><b>File → Examples → ArduinoISP</b></nobr>,    ,     ,      10μF,     RST  GND  Arduino.</p><br>
<br>
<p><img src="https://habrastorage.org/files/b58/056/c5d/b58056c5d6d644e698a56c35a0a4b004.png"></p><br>
<br>
<p>       .   <nobr><b>Tools → Board</b></nobr>    ,   : <nobr>ATtiny85 @ 1 MHz (internal oscillator; BOD disabled)</nobr>,   <nobr><b>Tools → Port</b></nobr>  USB      <nobr><b>Tools → Programmer</b></nobr>   ,   : <nobr>Arduino as ISP</nobr>,    Upload.</p><br>
<br>
<h2> </h2><br>
<br>
<p>        ,       ,  :<br>
</p><ul>
<li>   NRF24L01+;</li>
<li>    ;</li>
<li>    ;</li>
<li>   WDT (WatchDog Timer);</li>
<li>  Pin Change  PCINT;</li>
<li>     .</li>
</ul><br>
<br>
<p>     :</p><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">TMRh20/RF24</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">TMRh20/RF24Network</a></li>
</ul><br>
<br>
<p>        NRF24L01+,     ATtiny85.        libraries     Arduino.</p><br>
<br>
<p>         .      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">GitHub</a>   <b>attwlight_sensor</b>,    <b>attwlight_rx</b>    .</p><br>
<br>
<h3>    </h3><br>
<br>
<p> void sleep()     void loop()             PCINIT3  WDT.         .</p><br>
<br>
<p>     ,        .           <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ATtiny85 datasheet</a>  «23. Register Summary»,                     .</p><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;avr/wdt.h&gt;</span></span></span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;avr/sleep.h&gt;</span></span></span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;avr/interrupt.h&gt;</span></span></span></span><font></font>
<font></font>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> WDTO_INFINITE 255</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SLEEP_PERIOD WDTO_8S</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SKIP_WDT_WAKEUPS 14 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// x SLEEP_PERIOD + SLEEP_PERIOD (14 ~= 120 sec)</span></span></span></span><font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">//  ()  PCINT,  ATtiny85   (B),     PCINT</span></span><font></font>
ISR(PCINT0_vect)<font></font>
{<font></font>
  light_pcint = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">//    WDT</span></span><font></font>
ISR(WDT_vect)<font></font>
{<font></font>
  wakeup_counter++;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sleep</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">
</span></span>{<font></font>
  GIMSK = _BV(PCIE); <span class="hljs-comment"><span class="hljs-comment">//  Pin Change </span></span>
  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (SLEEP_PERIOD == WDTO_INFINITE || payload.light != LIGHT_FUZZY)<font></font>
    PCMSK |= _BV(LIGHT_PIN); <span class="hljs-comment"><span class="hljs-comment">// PCINT3;           </span></span>
  ADCSRA &amp;= ~_BV(ADEN); <span class="hljs-comment"><span class="hljs-comment">//  ADC;  </span></span><font></font>
<font></font>
  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (SLEEP_PERIOD != WDTO_INFINITE) {<font></font>
    wdt_enable(SLEEP_PERIOD); <span class="hljs-comment"><span class="hljs-comment">//  </span></span>
    WDTCR |= _BV(WDIE); <span class="hljs-comment"><span class="hljs-comment">//    ;   ATtiny85</span></span><font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment"><span class="hljs-comment">//    Power-down; MCUSR &amp;= ~_BV(SM0); MCUSR |= _BV(SM1);</span></span><font></font>
  set_sleep_mode(SLEEP_MODE_PWR_DOWN);<font></font>
  sleep_enable(); <span class="hljs-comment"><span class="hljs-comment">//   ; MCUSR |= _BV(SE);</span></span>
  sei(); <span class="hljs-comment"><span class="hljs-comment">//  </span></span><font></font>
<font></font>
  sleep_cpu(); <span class="hljs-comment"><span class="hljs-comment">// </span></span><font></font>
<font></font>
  cli(); <span class="hljs-comment"><span class="hljs-comment">//  ;    PCINT3</span></span>
  PCMSK &amp;= ~_BV(LIGHT_PIN); <span class="hljs-comment"><span class="hljs-comment">// PCINT3; </span></span>
  sleep_disable(); <span class="hljs-comment"><span class="hljs-comment">//   ; MCUSR &amp;= ~_BV(SE);</span></span>
  ADCSRA |= _BV(ADEN); <span class="hljs-comment"><span class="hljs-comment">//  ADC</span></span>
  sei(); <span class="hljs-comment"><span class="hljs-comment">//  ;     </span></span><font></font>
}<font></font>
</code></pre><br>
<br>
<h3>  </h3><br>
<br>
<p>          « ».  ,     ,         20μA.</p><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> FUZZY_VOLTAGE 0.4 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//      ,  </span></span></span></span><font></font>
<font></font>
<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> fuzzy_start = <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>(<span class="hljs-number"><span class="hljs-number">1024.0</span></span> * (<span class="hljs-number"><span class="hljs-number">1.0</span></span> - FUZZY_VOLTAGE) / <span class="hljs-number"><span class="hljs-number">2.0</span></span>);
<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> fuzzy_stop = <span class="hljs-number"><span class="hljs-number">1023</span></span> - fuzzy_start;<font></font>
<font></font>
<span class="hljs-keyword"><span class="hljs-keyword">light_t</span></span> readLightStatus(<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ms)<font></font>
{<font></font>
  delay(ms); <span class="hljs-comment"><span class="hljs-comment">//     </span></span>
  <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> input = analogRead(LIGHT_PIN); <span class="hljs-comment"><span class="hljs-comment">// ADC3</span></span><font></font>
<font></font>
  <span class="hljs-comment"><span class="hljs-comment">//   </span></span>
  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (input &gt;= fuzzy_start &amp;&amp; input &lt;= fuzzy_stop)
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> LIGHT_FUZZY;
  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (input &lt; fuzzy_start)
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> LIGHT_OFF;
  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (input &gt; fuzzy_stop)
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> LIGHT_ON;<font></font>
<font></font>
  <span class="hljs-comment"><span class="hljs-comment">// ;     </span></span>
  <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> LIGHT_UNKNOWN;<font></font>
}<font></font>
</code></pre><br>
<br>
<h3>  </h3><br>
<br>
<p>    AREF ,      ,          .    ,       ,        .        .</p><br>
<br>
<p>  ,            Vbg (Bandgap reference voltage)  1.1V.   Vbg     1.0-1.2V,            1125300.</p><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readVcc</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">
</span></span>{
  <span class="hljs-comment"><span class="hljs-comment">//    Vcc    Vbg == 1.1V</span></span><font></font>
  ADMUX = _BV(MUX3) | _BV(MUX2);<font></font>
  delay(<span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-comment"><span class="hljs-comment">//   1ms  </span></span>
  ADCSRA |= _BV(ADSC); <span class="hljs-comment"><span class="hljs-comment">// ADC Start conversion -  </span></span>
  <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (bit_is_set(ADCSRA, ADSC)); <span class="hljs-comment"><span class="hljs-comment">// ADSC == 1   </span></span><font></font>
<font></font>
  <span class="hljs-comment"><span class="hljs-comment">//  ADCL  ADCH,  ADCH    =&gt; ADCL  </span></span>
  <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> low  = ADCL; <span class="hljs-comment"><span class="hljs-comment">//    ADC</span></span>
  <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> high = ADCH; <span class="hljs-comment"><span class="hljs-comment">//    ADC</span></span><font></font>
<font></font>
  <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> result = (high &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span>) | low;<font></font>
<font></font>
  result = <span class="hljs-number"><span class="hljs-number">1125300L</span></span> / result; <span class="hljs-comment"><span class="hljs-comment">// 1125300 = 1.1*1023*1000</span></span>
  <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; <span class="hljs-comment"><span class="hljs-comment">// Vcc  </span></span><font></font>
}<font></font>
</code></pre><br>
<br>
<h3> </h3><br>
<br>
<p>  ,             .</p><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">float</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readTmp36</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> vcc)</span></span></span><span class="hljs-function">
</span></span>{
  <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> input = analogRead(TMP36_PIN); <span class="hljs-comment"><span class="hljs-comment">//   refVolts</span></span>
  <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> refVolts = <span class="hljs-keyword"><span class="hljs-keyword">float</span></span>(vcc) / <span class="hljs-number"><span class="hljs-number">1000.0</span></span>;
  <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> voltage = <span class="hljs-keyword"><span class="hljs-keyword">float</span></span>(input) * refVolts / <span class="hljs-number"><span class="hljs-number">1024.0</span></span>; <span class="hljs-comment"><span class="hljs-comment">//  </span></span>
  <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> temperatureC = (voltage - <span class="hljs-number"><span class="hljs-number">0.5</span></span>) * <span class="hljs-number"><span class="hljs-number">100.0</span></span>; <span class="hljs-comment"><span class="hljs-comment">//  500mV &amp; 10mV == 1°C</span></span>
  <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> temperatureC;<font></font>
}<font></font>
</code></pre><br>
<br>
<p>   ,          ,    .    ,  , ,    ,     .</p><br>
<br>
<p>   ,  ,      8KiB     :</p><br>
<br>
<pre><code class="html hljs xml">Sketch uses 7,120 bytes (86%) of program storage space. Maximum is 8,192 bytes.<font></font>
Global variables use 227 bytes (44%) of dynamic memory, leaving 285 bytes for local variables. Maximum is 512 bytes.</code></pre><br>
<br>
<p> ,      ,    Fuses  RESET   /.    Arduino IDE   ,     :</p><br>
<br>
<pre><code class="bash hljs">avrdude -c stk500v1 -p attiny85 -P /dev/ttyUSB0 -v -C /etc/avrdude.conf -b 19200 -U lfuse:w:0x62:m -U hfuse:w:0x5f:m -U efuse:w:0xff:m
</code></pre><br>
<br>
<ul>
<li><b>avrdude</b> —    Arduino IDE    <b>hardware/tools/avr/bin/</b>;</li>
<li><b>/dev/ttyUSB0</b> —  ;</li>
<li><b>/etc/avrdude.conf</b> —        Arduino IDE   <b>hardware/tools/avr/etc/avrdude.conf</b>.</li>
</ul><br>
<br>
<p>     Fuses,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Engbedded Atmel AVR® Fuse Calculator</a>.</p><br>
<br>
<p> ,    :        8 (  1MHz);     ,    ;  BOD (Brown-out Detector) —           ;    ;    RESET.</p><br>
<br>
<p><img src="https://habrastorage.org/files/828/352/a08/828352a0834a4c28bd0e6738d6acaf92.png"></p><br>
<br>
<h2></h2><br>
<br>
<p>     .  :    120sec,      ,  ;      ;   200mAh.</p><br>
<br>
<table>
<tbody><tr>
<td><b></b></td>
<th>1MHz</th>
<th>8MHz</th>
</tr>
<tr>
<td><b></b> ()</td>
<td>15.7mA</td>
<td>18.3mA</td>
</tr>
<tr>
<td><b></b> ()</td>
<td>1.1mA</td>
<td>4.3mA</td>
</tr>
<tr>
<td><b> </b> ()</td>
<td>7μA</td>
<td>7μA</td>
</tr>
<tr>
<td><b></b> (  )</td>
<td>51ms</td>
<td>16ms</td>
</tr>
<tr>
<td><b></b> (  )</td>
<td>15ms</td>
<td>4ms</td>
</tr>
<tr>
<td><b>  </b> ()</td>
<td>513</td>
<td>739</td>
</tr>
</tbody></table><br>
<br>
<p> ,     .  ,   8MHz   .    ,   .</p><br>
<br>
<p>      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">GitHub</a></p></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN388079/">https://habr.com/ru/post/zh-CN388079/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN388069/index.html">看电视与认知功能低下相关</a></li>
<li><a href="../zh-CN388071/index.html">Автостёкла Ford GT наполовину сделали из Gorilla Glass</a></li>
<li><a href="../zh-CN388073/index.html">狂热者迫使飞利浦撤销该决定。色相灯泡不会阻碍竞争对手</a></li>
<li><a href="../zh-CN388075/index.html">氢燃料电池使多旋翼飞行时间增加了6倍</a></li>
<li><a href="../zh-CN388077/index.html">澳大利亚人正在研究可能比没有更好的水凝胶避孕套（18+）</a></li>
<li><a href="../zh-CN388081/index.html">福特将在加利福尼亚测试其无人驾驶汽车</a></li>
<li><a href="../zh-CN388085/index.html">年度最奇怪的小玩意</a></li>
<li><a href="../zh-CN388087/index.html">美国物理学家提出了利用“星球大战”创造光剑的技术</a></li>
<li><a href="../zh-CN388089/index.html">Irbis TZ94平板电脑评测-适量的大屏幕和英特尔®处理器</a></li>
<li><a href="../zh-CN388091/index.html">2015年最受欢迎的Google搜索</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>