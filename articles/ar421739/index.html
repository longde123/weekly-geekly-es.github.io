<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧘🏾 👸🏿 🎬 كيف استبدلت RxJava بالكوروتينات في مشروعي ولماذا يجب عليك أيضًا القيام بذلك ♀️ 🌠 🚣🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="مرحبا يا هبر! أقدم لكم ترجمة لمقالة بقلم باولو ساتو حول استخدام Kotlin Coroutines بدلاً من RxJava في مشاريع Android الخاصة بهم. 

 RxJava كبازوكا ، مع...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>كيف استبدلت RxJava بالكوروتينات في مشروعي ولماذا يجب عليك أيضًا القيام بذلك</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/421739/" style=";text-align:right;direction:rtl">  مرحبا يا هبر!  أقدم لكم ترجمة <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">لمقالة</a> بقلم باولو ساتو حول استخدام Kotlin Coroutines بدلاً من RxJava في مشاريع Android الخاصة بهم. <br><br>  RxJava كبازوكا ، معظم التطبيقات لا تستخدم حتى نصف قوتها النارية.  ستناقش المقالة كيفية استبداله بـ Corotines (Kotlin). <br><br>  أعمل مع RxJava منذ عدة سنوات.  هذه بالتأكيد واحدة من أفضل المكتبات لأي مشروع Android ، والتي لا تزال في حالة صدمة اليوم ، خاصة إذا كنت تقوم بالبرمجة في Java.  إذا كنت تستخدم Kotlin ، فيمكننا القول أن المدينة لديها شريف جديد. <br><br>  يستخدم معظم RxJava فقط للتحكم في سلاسل الرسائل ومنع رد الاتصال (إذا كنت لا تعرف ماهيتها ، اعتبر نفسك محظوظًا <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ولهذا السبب</a> ).  والحقيقة هي أنه يجب أن نضع في اعتبارنا أن القوة الحقيقية لـ RxJava هي البرمجة التفاعلية والضغط الخلفي.  إذا كنت تستخدمه للتحكم في الطلبات غير المتزامنة ، فإنك تستخدم البازوكا لقتل العنكبوت.  ستقوم بعملها ، لكنها مبالغة. <br><br>  أحد العوائق البارزة لـ RxJava هو عدد الطرق.  إنه ضخم ويميل إلى الانتشار في جميع أنحاء الكود.  في Kotlin ، يمكنك استخدام coroutines لتنفيذ معظم السلوك الذي قمت بإنشائه سابقًا باستخدام RxJava. <br><br>  ولكن ... ما هي coroutines؟ <br><br>  Corutin هو طريقة للتعامل مع المهام التنافسية في خيط.  ستعمل سلسلة المحادثات حتى يتم إيقافها وسيتغير السياق لكل coroutine دون إنشاء مؤشر ترابط جديد. <br>  لا تزال coroutines في Kotlin تجريبية ، ولكن تم تضمينها في Kotlin 1.3 ، لذلك كتبت فئة UseCase جديدة (للبناء النظيف) باستخدامها أدناه.  في هذا المثال ، يتم تغليف مكالمة coroutine في ملف واحد.  وبالتالي ، فإن الطبقات الأخرى لن تعتمد على الكورونات التي يتم تنفيذها ، مما يوفر بنية أكثر انقطاعًا. <br><a name="habracut"></a><br><pre style=";text-align:right;direction:rtl"><code class="hljs pgsql"><span class="hljs-comment"><span class="hljs-comment">/** * (C) Copyright 2018 Paulo Vitor Sato Open Source Project * * Licensed under the Apache License, Version 2.0 (the "License"); * you may not use this file except in compliance with the License. * You may obtain a copy of the License at * * http://www.apache.org/licenses/LICENSE-2.0 * * Unless required by applicable law or agreed to in writing, software * distributed under the License is distributed on an "AS IS" BASIS, * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. * See the License for the specific language governing permissions and * limitations under the License. * */</span></span> package com.psato.devcamp.interactor.usecase <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.util.<span class="hljs-keyword"><span class="hljs-keyword">Log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> kotlinx.coroutines.experimental.* <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> kotlinx.coroutines.experimental.android.UI <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> kotlin.coroutines.experimental.CoroutineContext <span class="hljs-comment"><span class="hljs-comment">/** * Abstract class for a Use Case (Interactor in terms of Clean Architecture). * This interface represents a execution unit for different use cases (this means any use case * in the application should implement this contract). * &lt;p&gt; * By convention each UseCase implementation will return the result using a coroutine * that will execute its job in a background thread and will post the result in the UI thread. */</span></span> abstract <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> UseCase&lt;T&gt; { protected var parentJob: Job = Job() //var backgroundContext: CoroutineContext = IO var backgroundContext: CoroutineContext = CommonPool var foregroundContext: CoroutineContext = UI protected abstract suspend fun executeOnBackground(): T fun <span class="hljs-keyword"><span class="hljs-keyword">execute</span></span>(onComplete: (T) -&gt; Unit, onError: (Throwable) -&gt; Unit) { parentJob.cancel() parentJob = Job() launch(foregroundContext, parent = parentJob) { try { val result = withContext(backgroundContext) { executeOnBackground() } onComplete.invoke(result) } catch (e: CancellationException) { <span class="hljs-keyword"><span class="hljs-keyword">Log</span></span>.d("UseCase", "canceled by user") } catch (e: <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>) { onError(e) } } } protected suspend fun &lt;X&gt; background(context: CoroutineContext = backgroundContext, block: suspend () -&gt; X): <span class="hljs-keyword"><span class="hljs-keyword">Deferred</span></span>&lt;X&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> async(context, parent = parentJob) { block.invoke() } } fun unsubscribe() { parentJob.cancel() } }</code> </pre> <br>  بادئ ذي بدء ، أنشأت مهمة رئيسية.  هذا هو مفتاح التراجع عن جميع coroutines التي تم إنشاؤها في فئة UseCase.  عندما نتصل بالتنفيذ ، من المهم إلغاء المهام القديمة ، للتأكد من أننا لم نفتقد أي كوروتين (هذا سيحدث أيضًا إذا قمنا بإلغاء الاشتراك في UseCase). <br><br>  أيضا ، أنا استدعاء بدء التشغيل (UI).  هذا يعني أنني أريد إنشاء coroutine التي سيتم تنفيذها في مؤشر ترابط واجهة المستخدم.  بعد ذلك ، أسمي طريقة الخلفية التي تخلق عدم التزامن في CommonPool (سيكون هذا الأسلوب في الواقع ضعيف الأداء).  بدوره ، سيعيد async Deffered ، وبعد ذلك ، سأدعو طريقة الانتظار الخاصة به.  وينتظر استكمال الخلفية الخلفية ، والتي ستؤدي إلى نتيجة أو خطأ. <br><br>  يمكن استخدام هذا لتنفيذ معظم كل ما قمنا به مع RxJava.  فيما يلي بعض الأمثلة. <br><br><h4 style=";text-align:right;direction:rtl">  <b>الخريطة</b> </h4><br>  لقد قمت بتنزيل نتائج searchShow وقمت بتغييرها لإرجاع اسم العرض الأول. <br>  كود RxJava: <br><pre style=";text-align:right;direction:rtl"> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SearchShows</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UseCase</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ShowRepository showRepository; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ResourceRepository resourceRepository; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String query; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SearchShows</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ShowRepository showRepository, ResourceRepository resourceRepository)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.showRepository = showRepository; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.resourceRepository = resourceRepository; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setQuery</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String query)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.query = query; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> Single&lt;String&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">buildUseCaseObservable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> showRepository.searchShow(query).map(showInfos -&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (showInfos != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; !showInfos.isEmpty() &amp;&amp; showInfos.get(<span class="hljs-number"><span class="hljs-number">0</span></span>).getShow() != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> showInfos.get(<span class="hljs-number"><span class="hljs-number">0</span></span>).getShow().getTitle(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> resourceRepository.getNotFoundShow(); } }); } }</code> </pre><br>  كود Coroutine: <br><br><pre style=";text-align:right;direction:rtl"> <code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SearchShows</span></span></span><span class="hljs-class"> </span><span class="hljs-meta"><span class="hljs-class"><span class="hljs-meta">@Inject</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">constructor</span></span></span></span>(<span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> showRepository: ShowRepository, <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> resourceRepository: ResourceRepository) : UseCase&lt;String&gt;() { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> query: String? = <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">suspend</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">executeOnBackground</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: String { query?.let { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> showsInfo = showRepository.searchShow(it) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> showName: String? = showsInfo?.getOrNull(<span class="hljs-number"><span class="hljs-number">0</span></span>)?.show?.title <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> showName ?: resourceRepository.notFoundShow } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span> } }</code> </pre><br><h4 style=";text-align:right;direction:rtl">  <b>الرمز البريدي</b> </h4><br>  سيأخذ Zip إنبعاث من الأوبزرفر ويجمعهما في انبعاث جديد.  لاحظ أنه مع RxJava يجب عليك تحديد إجراء مكالمة بالتوازي باستخدام SubscribeOn في كل واحدة.  نريد الحصول على كليهما في نفس الوقت وإعادتهما معًا. <br><br>  كود RxJava: <br><br><pre style=";text-align:right;direction:rtl"> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ShowDetail</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UseCase</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ShowRepository showRepository; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String id; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SearchShows</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ShowRepository showRepository)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.showRepository = showRepository; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String id)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.id = id; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> Single&lt;Show&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">buildUseCaseObservable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Single&lt;ShowDetail&gt; singleDetail = showRepository.showDetail(id).subscribeOn(Schedulers.io()); Single&lt;ShowBanner&gt; singleBanner = showRepository.showBanner(id).subscribeOn(Schedulers.io()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Single.zip(singleDetail, singleBanner, (detail, banner) -&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Show(detail,banner)); }</code> </pre><br>  كود Coroutine: <br><br><pre style=";text-align:right;direction:rtl"> <code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SearchShows</span></span></span><span class="hljs-class"> </span><span class="hljs-meta"><span class="hljs-class"><span class="hljs-meta">@Inject</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">constructor</span></span></span></span>(<span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> showRepository: ShowRepository, <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> resourceRepository: ResourceRepository) : UseCase&lt;Show&gt;() { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> id: String? = <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">suspend</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">executeOnBackground</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: Show { id?.let { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> showDetail = background{ showRepository.showDetail(it) } <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> showBanner = background{ showRepository.showBanner(it) } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Show(showDetail.await(), showBanner.await()) } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Show() } }</code> </pre><br><h4 style=";text-align:right;direction:rtl">  <b>خريطة مسطحة</b> </h4><br>  في هذه الحالة ، أبحث عن العروض التي تحتوي على سلسلة استعلام ولكل نتيجة (تقتصر على 200 نتيجة) ، أحصل أيضًا على تصنيف العرض.  في النهاية ، أعود قائمة بالعروض ذات التقييمات المقابلة. <br><br>  كود RxJava: <br><br><pre style=";text-align:right;direction:rtl"> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SearchShows</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UseCase</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ShowRepository showRepository; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String query; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SearchShows</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ShowRepository showRepository)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.showRepository = showRepository; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setQuery</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String query)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.query = query; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> Single&lt;List&lt;ShowResponse&gt;&gt; buildUseCaseObservable() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> showRepository.searchShow(query).flatMapPublisher( (Function&lt;List&lt;ShowInfo&gt;, Flowable&lt;ShowInfo&gt;&gt;) Flowable::fromIterable) .flatMapSingle((Function&lt;ShowInfo, SingleSource&lt;ShowResponse&gt;&gt;) showInfo -&gt; showRepository.showRating(showInfo.getShow().getIds().getTrakt()) .map(rating -&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ShowResponse(showInfo.getShow().getTitle(), rating .getRating())).subscribeOn(Schedulers.io()), <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>).toList(); } }</code> </pre><br>  كود Coroutine: <br><br><pre style=";text-align:right;direction:rtl"> <code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SearchShows</span></span></span><span class="hljs-class"> </span><span class="hljs-meta"><span class="hljs-class"><span class="hljs-meta">@Inject</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">constructor</span></span></span></span>(<span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> showRepository: ShowRepository) : UseCase&lt;List&lt;ShowResponse&gt;&gt;() { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> query: String? = <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">suspend</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">executeOnBackground</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: List&lt;ShowResponse&gt; { query?.let { query -&gt; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> showRepository.searchShow(query).map { background { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> rating: Rating = showRepository.showRating(it.show!!.ids!!.trakt!!) ShowResponse(it.show.title!!, rating.rating) } }.map { it.await() } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> arrayListOf() } }</code> </pre><br>  دعني أشرح.  باستخدام RxJava ، يقوم المستودع الخاص بي بإرجاع إصدار واحد من القائمة ، لذلك أحتاج إلى العديد من الانبعاثات ، واحد لكل ShowInfo.  للقيام بذلك ، دعوت flatMapPublisher.  لكل مشكلة ، يجب أن أسلط الضوء على ShowResponse ، وفي النهاية أجمعهم جميعًا في قائمة. <br><br>  ينتهي بنا المطاف بهذا البناء: List foreach → (ShowInfo → ShowRating → ShowResponse) → List. <br><br>  باستخدام coroutines ، قمت بعمل خريطة لكل عنصر قائمة لتحويله إلى قائمة &lt;Deffered&gt;. <br><br>  كما ترون ، فإن معظم ما قمنا به مع RxJava أسهل في التنفيذ مع المكالمات المتزامنة.  يمكن لـ Coroutines حتى التعامل مع FlatMap ، والتي أعتقد أنها واحدة من أكثر الوظائف تعقيدًا في RxJava. <br><br>  من المعروف جيدًا أن coroutines يمكن أن تكون خفيفة الوزن ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">هنا</a> مثال) ، لكن النتائج حيرتني.  في هذا المثال ، بدأ RxJava في حوالي 3.1 ثانية ، في حين استغرق coroutines حوالي 5.8 ثانية للتشغيل على CommonPool. <br><br>  أثارت هذه النتائج السؤال المطروح قبلي بأنه قد يكون هناك شيء غير مناسب فيها.  في وقت لاحق ، وجدت هذا.  لقد استخدمت التحديث التحديثي ، الذي منع التدفق. <br><br>  هناك طريقتان لإصلاح هذا الخطأ ، يعتمد الاختيار على إصدار Android Studio الذي تستخدمه.  في Android Studio 3.1 ، نحتاج إلى التأكد من عدم حظر سلسلة المحادثات في الخلفية.  لهذا ، استخدمت هذه المكتبة: <br><blockquote style=";text-align:right;direction:rtl">  تنفيذ "ru.gildor.coroutines: kotlin-coroutines-التحديثية: 0.12.0" <br></blockquote><br>  ينشئ هذا الرمز امتدادًا لوظيفة استدعاء التحديث لإيقاف الدفق مؤقتًا: <br><br><pre style=";text-align:right;direction:rtl"> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">suspend</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-type"><span class="hljs-function"><span class="hljs-type">&lt;T : Any&gt;</span></span></span><span class="hljs-function"> Call</span><span class="hljs-type"><span class="hljs-function"><span class="hljs-type">&lt;T&gt;</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">await</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: T { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> suspendCancellableCoroutine { continuation -&gt; enqueue(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> : Callback&lt;T&gt; { <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onResponse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(call: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Call</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">T</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt;?, response: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Response</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">T</span></span></span></span><span class="hljs-function"><span class="hljs-params">?&gt;)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (response.isSuccessful) { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> body = response.body() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (body == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { continuation.resumeWithException( NullPointerException(<span class="hljs-string"><span class="hljs-string">"Response body is null: </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$response</span></span></span><span class="hljs-string">"</span></span>) ) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { continuation.resume(body) } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { continuation.resumeWithException(HttpException(response)) } } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onFailure</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(call: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Call</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">T</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt;, t: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Throwable</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { <span class="hljs-comment"><span class="hljs-comment">// Don't bother with resuming the continuation if it is already cancelled. if (continuation.isCancelled) return continuation.resumeWithException(t) } }) registerOnCompletion(continuation) } }</span></span></code> </pre><br>  في Android Studio 3.2 ، يمكنك تحديث مكتبة corutin إلى الإصدار 0.25.0.  يحتوي هذا الإصدار على CoroutineContext IO (يمكنك مشاهدة التعليق المقابل في فئة UseCase الخاصة بي). <br><br>  استغرق العمل على CommonPool دون مكالمة حظر تستغرق 2.3 ثانية و 2.4 ثانية مع IO وحظر المكالمات. <br><br><img src="https://cdn-images-1.medium.com/max/1000/1*vUG7SROZLpFXX6PJk8CVmw.png" alt="الصورة"><br><br>  آمل أن تلهمك هذه المقالة لاستخدام corutin ، وهو بديل أخف وربما أسرع لـ RxJava ويجعل الأمر أسهل قليلاً لفهم أنك تقوم بكتابة كود متزامن يعمل بشكل غير متزامن. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar421739/">https://habr.com/ru/post/ar421739/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar421729/index.html">Timlid هو رقيب في قسم تكنولوجيا المعلومات</a></li>
<li><a href="../ar421731/index.html">ما هي تكلفة بناء البرمجيات: مما تتكون ميزانية تطوير التطبيقات</a></li>
<li><a href="../ar421733/index.html">خذها وافعلها: لماذا يكون من المفيد في بعض الأحيان التسجيل للتحليل والتطوير فقط</a></li>
<li><a href="../ar421735/index.html">"الفيروسات" في الملحقات باستخدام FastProxy كمثال</a></li>
<li><a href="../ar421737/index.html">تقوم الشركة الأمريكية بتقطيع موظفيها لمدة عام حتى الآن. لماذا يمكن أن يكون هناك مستقبل؟</a></li>
<li><a href="../ar421741/index.html">لماذا أصبح رجل في عالم جافا من المؤيدين المتحمسين لـ Node.js و JavaScript؟</a></li>
<li><a href="../ar421745/index.html">كيف أطلقت Ubisoft برنامجها Starlink: Battle for Atlas Hybrid Game Suite</a></li>
<li><a href="../ar421747/index.html">Parktronic على اردوينو</a></li>
<li><a href="../ar421749/index.html">"عدد قليل جدًا يكتب حقًا خلفية على Kotlin" - مقابلة مع Pasha Finkelstein</a></li>
<li><a href="../ar421751/index.html">أفضل المحررين المجانيين للتطوير والتوثيق: Atom</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>