<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ˜ï¸ ğŸ¤¦ğŸ¼ ğŸ™‹ğŸ½ ECSåº“çš„æœ¬æœºå®ç° ğŸ’†ğŸ¼ ğŸ‘¨ğŸ¿â€ğŸ”§ ğŸ‘¸ğŸ¾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="æœ¬å‘¨ï¼Œæˆ‘å¼€å§‹ç ”ç©¶Vagabondå¼•æ“ï¼Œå¹¶å¼€å§‹å®ç°å®ä½“ç»„ä»¶ç³»ç»Ÿæ¨¡æ¿ã€‚ 

 åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘æƒ³è°ˆä¸€è°ˆæˆ‘çš„å®ç°ï¼Œè¯¥å®ç°å¯åœ¨GitHubä¸Šå…è´¹è·å¾—ã€‚ ä½†æ˜¯ï¼Œæˆ‘ä¸ä»…è¦å¯¹ä»£ç è¿›è¡Œæ³¨é‡Šï¼Œè¿˜è¦è§£é‡Šå…¶ç»“æ„æ˜¯å¦‚ä½•è®¾è®¡çš„ã€‚ å› æ­¤ï¼Œæˆ‘å°†ä»ç¼–å†™çš„ç¬¬ä¸€ä¸ªå®ç°å¼€å§‹ï¼Œåˆ†æå…¶ä¼˜ç¼ºç‚¹ï¼Œç„¶åè¯´æ˜å¦‚ä½•æ”¹è¿›å®ƒã€‚ æœ€åï¼Œæˆ‘å°†åˆ—å‡ºä¹Ÿå¯ä»¥æ”¹è¿›çš„æ–¹é¢...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ECSåº“çš„æœ¬æœºå®ç°</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/459288/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4c9/fc6/23e/4c9fc623e0787518bde7823317b0e6af.png" alt="å›¾ç‰‡"></div><br> æœ¬å‘¨ï¼Œæˆ‘å¼€å§‹ç ”ç©¶Vagabondå¼•æ“ï¼Œå¹¶å¼€å§‹å®ç°<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å®ä½“ç»„ä»¶ç³»ç»Ÿ</a>æ¨¡æ¿ã€‚ <br><br> åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘æƒ³è°ˆä¸€è°ˆæˆ‘çš„å®ç°ï¼Œè¯¥å®ç°å¯åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">GitHubä¸Š</a>å…è´¹è·å¾—ã€‚ ä½†æ˜¯ï¼Œæˆ‘ä¸ä»…è¦å¯¹ä»£ç è¿›è¡Œæ³¨é‡Šï¼Œè¿˜è¦è§£é‡Šå…¶ç»“æ„æ˜¯å¦‚ä½•è®¾è®¡çš„ã€‚ å› æ­¤ï¼Œæˆ‘å°†ä»ç¼–å†™çš„ç¬¬ä¸€ä¸ªå®ç°å¼€å§‹ï¼Œåˆ†æå…¶ä¼˜ç¼ºç‚¹ï¼Œç„¶åè¯´æ˜å¦‚ä½•æ”¹è¿›å®ƒã€‚ æœ€åï¼Œæˆ‘å°†åˆ—å‡ºä¹Ÿå¯ä»¥æ”¹è¿›çš„æ–¹é¢ã€‚ <br><br><h1> å¼•è¨€ </h1><br><h2> åŠ¨æœº </h2><br> æˆ‘ä¸ä¼šè°ˆè®ºECSä¼˜äºé¢å‘å¯¹è±¡æ–¹æ³•çš„å¥½å¤„ï¼Œå› ä¸ºåœ¨æˆ‘ä¹‹å‰çš„å¾ˆå¤šäººéƒ½åšå¾—å¾ˆå¥½ã€‚ æ–¯ç§‘ç‰¹Â·æ¯”æ‹‰æ–¯ï¼ˆScott Bilasï¼‰æ˜¯<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://web.archive.org/web/20101011021902/">2002å¹´GDC</a>ä¸Šç¬¬ä¸€ä¸ªè°ˆè®ºECSçš„äººã€‚ è¯¥ä¸»é¢˜çš„å…¶ä»–å¼•äººæ³¨ç›®çš„ä»‹ç»åŒ…æ‹¬Mike Westçš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Evolve Your Hierarchy</a>å’ŒRobert Nistromä»¤äººæƒŠå¹çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Game Programming Patterns</a>ä¹¦ä¸­çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Components</a>ç« èŠ‚ã€‚ <br><br> ç®€è€Œè¨€ä¹‹ï¼Œæˆ‘å°†è¯´ECSçš„ä»»åŠ¡æ˜¯ä¸ºæ¸¸æˆå®ä½“åˆ›å»ºä¸€ç§é¢å‘æ•°æ®çš„æ–¹æ³•ï¼Œå¹¶æ–¹ä¾¿åœ°å°†æ•°æ®ä¸é€»è¾‘åˆ†ç¦»ã€‚ å®ä½“ç”±åŒ…å«æ•°æ®çš„ç»„ä»¶ç»„æˆã€‚ åŒ…å«é€»è¾‘çš„ç³»ç»Ÿå°†å¤„ç†è¿™äº›ç»„ä»¶ã€‚ <br><br> å¦‚æœæ‚¨è¦è¯¦ç»†ä»‹ç»ï¼ŒECSä¸­å°†ä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">compositionï¼ˆç»„åˆï¼‰</a> ï¼Œè€Œä¸æ˜¯<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ç»§æ‰¿</a> ã€‚ æ­¤å¤–ï¼Œè¿™ç§é¢å‘æ•°æ®çš„æ–¹æ³•å¯ä»¥æ›´å¥½åœ°åˆ©ç”¨ç¼“å­˜ï¼Œè¿™æ„å‘³ç€å®ƒå¯ä»¥å®ç°å‡ºè‰²çš„æ€§èƒ½ã€‚ <br><a name="habracut"></a><br><h2> ä¾‹å­ </h2><br> åœ¨æ·±å…¥ç ”ç©¶ä»£ç ä¹‹å‰ï¼Œæˆ‘æƒ³å‘æ‚¨å±•ç¤ºæˆ‘ä»¬å°†è¦è®¾è®¡çš„å†…å®¹ã€‚ <br><br> åˆ†é…ç»„ä»¶éå¸¸ç®€å•ï¼š <br><br><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Position</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Component&lt;Position&gt; { <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> x; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> y; }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Velocity</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Component&lt;Velocity&gt; { <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> x; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> y; };</code> </pre> <br> å¦‚æ‚¨æ‰€è§ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">CRTP</a>æ¨¡æ¿ã€‚ <br><br> ç„¶åï¼Œå‡ºäºæŠ€æœ¯åŸå› ï¼ˆæˆ‘å°†åœ¨åé¢è§£é‡Šï¼‰ï¼Œæˆ‘ä»¬éœ€è¦ç¡®å®šç»„ä»¶æ•°å’Œç³»ç»Ÿæ•°ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> ComponentCount = <span class="hljs-number"><span class="hljs-number">32</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> SystemCount = <span class="hljs-number"><span class="hljs-number">8</span></span>;</code> </pre> <br> æ¥ä¸‹æ¥ï¼Œæ‚¨å¯ä»¥æŒ‡å®šä¸€ä¸ªç³»ç»Ÿï¼Œè¯¥ç³»ç»Ÿå°†æ¥æ”¶åŒæ—¶å…·æœ‰ä¸¤ä¸ªç»„ä»¶çš„æ‰€æœ‰å®ä½“å¹¶æ›´æ–°å…¶ä½ç½®ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PhysicsSystem</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> System&lt;ComponentCount, SystemCount&gt; { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: PhysicsSystem(EntityManager&lt;ComponentCount, SystemCount&gt;&amp; entityManager) : mEntityManager(entityManager) { setRequirements&lt;Position, Velocity&gt;(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">update</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dt)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span>&amp; entity : getManagedEntities()) { <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> [position, velocity] = mEntityManager.getComponents&lt;Position, Velocity&gt;(entity); position.x += velocity.x * dt; position.y += velocity.y * dt; } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: EntityManager&lt;ComponentCount, SystemCount&gt;&amp; mEntityManager; };</code> </pre> <br> ç³»ç»Ÿä»…ä½¿ç”¨<code>setRequirements</code>æ–¹æ³•æ¥<code>setRequirements</code>å…¶<code>setRequirements</code>ç»„ä»¶ã€‚ ç„¶åï¼Œåœ¨<code>update</code>æ–¹æ³•ä¸­ï¼Œå®ƒå¯ä»¥è°ƒç”¨<code>getManagedEntities</code>æ¥è¿­ä»£éå†æ‰€æœ‰æ»¡è¶³è¦æ±‚çš„å®ä½“ã€‚ <br><br> æœ€åï¼Œè®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå®ä½“ç®¡ç†å™¨ï¼Œæ³¨å†Œç»„ä»¶ï¼Œåˆ›å»ºä¸€ä¸ªç³»ç»Ÿå’Œå‡ ä¸ªå®ä½“ï¼Œç„¶åä½¿ç”¨è¯¥ç³»ç»Ÿæ›´æ–°å®ƒä»¬çš„ä½ç½®ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> manager = EntityManager&lt;ComponentCount, SystemCount&gt;(); manager.registerComponent&lt;Position&gt;(); manager.registerComponent&lt;Velocity&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> system = manager.createSystem&lt;PhysicsSystem&gt;(manager); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>; ++i) { <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> entity = manager.createEntity(); manager.addComponent&lt;Position&gt;(entity); manager.addComponent&lt;Velocity&gt;(entity); } <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> dt = <span class="hljs-number"><span class="hljs-number">1.0f</span></span> / <span class="hljs-number"><span class="hljs-number">60.0f</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) system-&gt;update(dt);</code> </pre> <br><h3> åŸºå‡†æµ‹è¯• </h3><br> æˆ‘ä¸ä¼šå‡è£…åˆ›å»ºæœ€å¥½çš„ECSåº“ã€‚ æˆ‘åªæ˜¯æƒ³è‡ªå·±å†™ã€‚ å¦å¤–ï¼Œæˆ‘åªåšäº†ä¸€ä¸ªæ˜ŸæœŸã€‚ <br><br> ä½†æ˜¯ï¼Œè¿™ä¸æ˜¯åˆ¶é€ å®Œå…¨æ— æ•ˆçš„åŸå› ã€‚ å› æ­¤ï¼Œè®©æˆ‘ä»¬å®‰è£…åŸºå‡†æµ‹è¯•ï¼š <br><br><ul><li> ç¬¬ä¸€ä¸ªå°†åˆ›å»ºå®ä½“ï¼›ç¬¬äºŒä¸ªå°†åˆ›å»ºå®ä½“ã€‚ </li><li> ç¬¬äºŒä¸ªå°†ä½¿ç”¨è¯¥ç³»ç»Ÿè¿­ä»£éå†å®ä½“ï¼› </li><li> åè€…å°†åˆ›å»ºå¹¶é”€æ¯å®ä½“ï¼› </li></ul><br> æ‰€æœ‰è¿™äº›åŸºå‡†æµ‹è¯•çš„å‚æ•°æ˜¯å®ä½“æ•°ï¼Œæ¯ä¸ªå®ä½“çš„ç»„ä»¶æ•°ï¼Œæœ€å¤§ç»„ä»¶æ•°å’Œæœ€å¤§ç³»ç»Ÿæ•°ã€‚ é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„å®ç°æ‰©å±•çš„ç¨‹åº¦ã€‚ ç‰¹åˆ«æ˜¯ï¼Œæˆ‘å°†æ˜¾ç¤ºä¸‰ç§ä¸åŒé…ç½®æ–‡ä»¶çš„ç»“æœï¼š <br><br><ul><li> é…ç½®æ–‡ä»¶Aï¼š32ä¸ªç»„ä»¶å’Œ16ä¸ªç³»ç»Ÿï¼› </li><li>  AAé…ç½®æ–‡ä»¶ï¼š128ä¸ªç»„ä»¶å’Œ32ä¸ªç³»ç»Ÿï¼› </li><li>  AAAé…ç½®æ–‡ä»¶ï¼š512ä¸ªç»„ä»¶å’Œ64ä¸ªç³»ç»Ÿã€‚ </li></ul><br> å°½ç®¡è¿™äº›åŸºå‡†å°†ä½¿æˆ‘ä»¬å¯¹æ‰§è¡Œè´¨é‡æœ‰æ‰€äº†è§£ï¼Œä½†å®ƒä»¬éå¸¸ç®€å•ã€‚ ä¾‹å¦‚ï¼Œåœ¨è¿™äº›åŸºå‡†æµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬ä»…ä½¿ç”¨åŒç±»å®ä½“ï¼Œå¹¶ä¸”å®ƒä»¬çš„ç»„æˆå¾ˆå°ã€‚ <br><br><h1> å®ä½œ </h1><br><h2> ç²¾åæ¶² </h2><br> åœ¨æˆ‘çš„å®ç°ä¸­ï¼Œå®ä½“åªæ˜¯ä¸€ä¸ªIDï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Entity = <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span>;</code> </pre> <br> æ­¤å¤–ï¼Œåœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Entity.hä¸­ï¼Œ</a>æˆ‘ä»¬è¿˜å°†å®šä¹‰ä¸€ä¸ªåˆ«å<code>Index</code> ï¼Œç¨å<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å°†æ´¾</a>ä¸Šç”¨åœºï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Index = <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> InvalidIndex = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::numeric_limits&lt;Index&gt;::max();</code> </pre> <br> æˆ‘å†³å®šä½¿ç”¨<code>uint32_t</code>ä»£æ›¿64ä½ç±»å‹æˆ–<code>std::size_t</code>æ¥èŠ‚çœç©ºé—´å¹¶æ”¹å–„ç¼“å­˜ä¼˜åŒ–ã€‚ æˆ‘ä»¬ä¸ä¼šæŸå¤±é‚£ä¹ˆå¤šï¼šæŸäººæ‹¥æœ‰æ•°åäº¿ä¸ªå®ä½“çš„å¯èƒ½æ€§ä¸å¤§ã€‚ <br><br><h2> ç»„æˆéƒ¨åˆ† </h2><br> ç°åœ¨è®©æˆ‘ä»¬å®šä¹‰ç»„ä»¶çš„åŸºç±»ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T, <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> Type&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Component</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> type = <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span>&gt;(Type); };</code> </pre> <br> æ¨¡æ¿ç±»éå¸¸ç®€å•ï¼Œå®ƒåªå­˜å‚¨ç±»å‹IDï¼Œæˆ‘ä»¬ç¨åå°†ä½¿ç”¨è¯¥IDæ ¹æ®ç»„ä»¶çš„ç±»å‹ä¸ºæ•°æ®ç»“æ„å»ºç«‹ç´¢å¼•ã€‚ <br><br> ç¬¬ä¸€ä¸ªæ¨¡æ¿å‚æ•°æ˜¯ç»„ä»¶çš„ç±»å‹ã€‚ ç¬¬äºŒä¸ªæ˜¯è½¬æ¢ä¸º<code>std::size_t</code>çš„å€¼ï¼Œå®ƒå°†ç”¨ä½œç»„ä»¶ç±»å‹idã€‚ <br><br> ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥å¦‚ä¸‹å®šä¹‰<code>Position</code>ç»„ä»¶ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Positon</span></span></span><span class="hljs-class"> :</span></span> Component&lt;Position, <span class="hljs-number"><span class="hljs-number">0</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> x; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> y; };</code> </pre> <br> ä½†æ˜¯ï¼Œæšä¸¾å¯èƒ½æ›´æ–¹ä¾¿ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ComponentType</span></span></span><span class="hljs-class"> {</span></span> Position }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Positon</span></span></span><span class="hljs-class"> :</span></span> Component&lt;Position, ComponentType::Position&gt; { <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> x; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> y; };</code> </pre> <br> åœ¨ä»‹ç»æ€§ç¤ºä¾‹ä¸­ï¼Œåªæœ‰ä¸€ä¸ªæ¨¡æ¿å‚æ•°ï¼šæˆ‘ä»¬ä¸éœ€è¦æ‰‹åŠ¨æŒ‡å®šç±»å‹IDã€‚ ç¨åæˆ‘ä»¬å°†çœ‹åˆ°å¦‚ä½•æ”¹å–„ç»“æ„å¹¶è‡ªåŠ¨ç”Ÿæˆç±»å‹æ ‡è¯†ç¬¦ã€‚ <br><br><h2> å®ä½“å®¹å™¨ </h2><br>  <code>EntityContainer</code>ç±»å°†è´Ÿè´£ç®¡ç†å®ä½“å’Œæ¯ä¸ªå®ä½“çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code>std::bitset</code></a> ã€‚ è¿™ç»„ä½å°†æŒ‡ç¤ºå®ä½“æ‹¥æœ‰çš„ç»„ä»¶ã€‚ <br><br> å› ä¸ºæˆ‘ä»¬å°†ä½¿ç”¨å®ä½“æ¥ç´¢å¼•å®¹å™¨ï¼Œå°¤å…¶æ˜¯<code>std::vector</code> ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦idå°½å¯èƒ½å°å¹¶å ç”¨æ›´å°‘çš„å†…å­˜ã€‚ å› æ­¤ï¼Œæˆ‘ä»¬å°†é‡ç”¨è¢«ç ´åå®ä½“çš„IDã€‚ ä¸ºæ­¤ï¼Œå…è´¹IDå°†å­˜å‚¨åœ¨åä¸º<code>mFreeEntities</code>çš„å®¹å™¨ä¸­ã€‚ <br><br> è¿™æ˜¯<code>EntityContainer</code> ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> ComponentCount, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> SystemCount&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EntityContainer</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reserve</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> size)</span></span></span></span>; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">bitset</span></span>&lt;ComponentCount&gt;&gt;&amp; getEntityToBitset(); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">bitset</span></span>&lt;ComponentCount&gt;&amp; getBitset(Entity entity) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>; <span class="hljs-function"><span class="hljs-function">Entity </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">create</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">remove</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Entity entity)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">bitset</span></span>&lt;ComponentCount&gt;&gt; mEntityToBitset; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;Entity&gt; mFreeEntities; };</code> </pre> <br> è®©æˆ‘ä»¬çœ‹çœ‹è¿™äº›æ–¹æ³•æ˜¯å¦‚ä½•å®ç°çš„ã€‚ <br><br>  <code>getEntityToBitset</code>å’Œ<code>getBitset</code>æ˜¯é€šå¸¸çš„å°å¸æ°”å‰‚ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">bitset</span></span>&lt;ComponentCount&gt;&gt;&amp; getEntityToBitset() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mEntityToBitset; } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">bitset</span></span>&lt;ComponentCount&gt;&amp; getBitset(Entity entity) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mEntityToBitset[entity]; }</code> </pre> <br>  <code>create</code>æ–¹æ³•æ›´æœ‰è¶£ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">Entity </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">create</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> entity = Entity(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mFreeEntities.empty()) { entity = <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;Entity&gt;(mEntityToBitset.size()); mEntityToBitset.emplace_back(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { entity = mFreeEntities.back(); mFreeEntities.pop_back(); mEntityToBitset[entity].reset(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> entity; }</code> </pre> <br> å¦‚æœæœ‰è‡ªç”±å®ä½“ï¼Œä»–å°†é‡ç”¨å®ƒã€‚ å¦åˆ™ï¼Œè¯¥æ–¹æ³•å°†åˆ›å»ºä¸€ä¸ªæ–°å®ä½“ã€‚ <br><br>  <code>remove</code>æ–¹æ³•åªæ˜¯åœ¨<code>mFreeEntities</code>æ·»åŠ è¦åˆ é™¤çš„å®ä½“ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">remove</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Entity entity)</span></span></span><span class="hljs-function"> </span></span>{ mFreeEntities.push_back(entity); }</code> </pre> <br> æœ€åä¸€ç§æ–¹æ³•æ˜¯<code>reserve</code> ã€‚ å®ƒçš„ä»»åŠ¡æ˜¯ä¸ºå„ç§å®¹å™¨ä¿ç•™å†…å­˜ã€‚ å¦‚æˆ‘ä»¬æ‰€çŸ¥ï¼Œåˆ†é…å†…å­˜æ˜¯ä¸€é¡¹æ˜‚è´µçš„æ“ä½œï¼Œå› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬å¤§çº¦çŸ¥é“æ¸¸æˆä¸­æœªæ¥å®ä½“çš„æ•°é‡ï¼Œé‚£ä¹ˆé¢„ç•™å†…å­˜å°†åŠ å¿«å·¥ä½œï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reserve</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> size)</span></span></span><span class="hljs-function"> </span></span>{ mFreeEntities.resize(size); <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::iota(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::begin(mFreeEntities), <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::end(mFreeEntities), <span class="hljs-number"><span class="hljs-number">0</span></span>); mEntityToBitset.resize(size); }</code> </pre> <br> é™¤äº†ç®€å•çš„å†…å­˜å¤‡ä»½å¤–ï¼Œå®ƒè¿˜ä¼šå¡«å……<code>mFreeEntities</code> ã€‚ <br><br><h2> ç»„ä»¶å®¹å™¨ </h2><br>  <code>ComponentContainer</code>ç±»å°†è´Ÿè´£å­˜å‚¨æŒ‡å®šç±»å‹çš„æ‰€æœ‰ç»„ä»¶ã€‚ <br><br> åœ¨æˆ‘çš„ä½“ç³»ç»“æ„ä¸­ï¼Œç»™å®šç±»å‹çš„æ‰€æœ‰ç»„ä»¶éƒ½å­˜å‚¨åœ¨ä¸€èµ·ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯ç§ç±»å‹çš„ç»„ä»¶éƒ½æœ‰ä¸€ä¸ªå¤§æ•°ç»„ï¼Œç§°ä¸º<code>mComponents</code> ã€‚ <br><br> å¦å¤–ï¼Œä¸ºäº†èƒ½å¤Ÿåœ¨æ’å®šæ—¶é—´å†…æ·»åŠ ï¼Œæ¥æ”¶æˆ–ä»å®ä½“ä¸­åˆ é™¤ç»„ä»¶ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç§ä»å®ä½“ç§»åŠ¨åˆ°ç»„ä»¶ä»¥åŠä»ç»„ä»¶ç§»åŠ¨åˆ°å®ä½“çš„æ–¹æ³•ã€‚ ä¸ºæ­¤ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¸¤ä¸ªåä¸º<code>mComponentToEntity</code>å’Œ<code>mEntityToComponent</code>æ•°æ®ç»“æ„ã€‚ <br><br> è¿™æ˜¯<code>ComponentContainer</code>å£°æ˜ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> ComponentCount, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> SystemCount&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ComponentContainer</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> BaseComponentContainer { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: ComponentContainer(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">bitset</span></span>&lt;ComponentCount&gt;&gt;&amp; entityToBitset); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reserve</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> size)</span></span></span><span class="hljs-function"> override</span></span>; <span class="hljs-function"><span class="hljs-function">T&amp; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Entity entity)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> T&amp; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Entity entity)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span>... Args&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Entity entity, Args&amp;&amp;... args)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">remove</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Entity entity)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tryRemove</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Entity entity)</span></span></span><span class="hljs-function"> override</span></span>; <span class="hljs-function"><span class="hljs-function">Entity </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getOwner</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> T&amp; component)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;T&gt; mComponents; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;Entity&gt; mComponentToEntity; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">unordered_map</span></span>&lt;Entity, Index&gt; mEntityToComponent; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">bitset</span></span>&lt;ComponentCount&gt;&gt;&amp; mEntityToBitset; };</code> </pre> <br> æ‚¨å¯ä»¥çœ‹åˆ°å®ƒç»§æ‰¿è‡ª<code>BaseComponentContainer</code> ï¼Œå…¶è®¾ç½®å¦‚ä¸‹ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseComponentContainer</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> ~BaseComponentContainer() = <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reserve</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> size)</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tryRemove</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Entity entity)</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-number"><span class="hljs-number">0</span></span>; };</code> </pre> <br> è¯¥åŸºç±»çš„å”¯ä¸€ç›®çš„æ˜¯èƒ½å¤Ÿåœ¨å®¹å™¨ä¸­å­˜å‚¨<code>ComponentContainer</code>æ‰€æœ‰å®ä¾‹ã€‚ <br><br> ç°åœ¨è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹æ–¹æ³•çš„å®šä¹‰ã€‚ <br><br> é¦–å…ˆï¼Œè€ƒè™‘æ„é€ å‡½æ•°ï¼šå®ƒè·å¾—å¯¹åŒ…å«å®ä½“ä½é›†åˆçš„å®¹å™¨çš„å¼•ç”¨ã€‚ æ­¤ç±»å°†ä½¿ç”¨å®ƒæ¥æ£€æŸ¥å®ä½“ä¸­ç»„ä»¶çš„å­˜åœ¨ï¼Œå¹¶åœ¨æ·»åŠ æˆ–åˆ é™¤ç»„ä»¶æ—¶æ›´æ–°å®ä½“çš„ä½é›†ï¼š <br><br><pre> <code class="cpp hljs">ComponentContainer(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">bitset</span></span>&lt;ComponentCount&gt;&gt;&amp; entityToBitset) : mEntityToBitset(entityToBitset) { }</code> </pre> <br>  <code>get</code>æ–¹æ³•å¾ˆç®€å•ï¼Œæˆ‘ä»¬åªä½¿ç”¨<code>mEntityToComponent</code>åœ¨<code>mEntityToComponent</code>ä¸­æŸ¥æ‰¾å®ä½“ç»„ä»¶çš„<code>mComponents</code> ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">T&amp; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Entity entity)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mComponents[mEntityToComponent[entity]]; }</code> </pre> <br>  <code>add</code>æ–¹æ³•ä½¿ç”¨å…¶å‚æ•°åœ¨<code>mComponents</code>çš„æœ«å°¾æ’å…¥æ–°ç»„ä»¶ï¼Œç„¶åå‡†å¤‡ä»å®ä½“åˆ°ç»„ä»¶ä»¥åŠä»ç»„ä»¶åˆ°å®ä½“çš„é“¾æ¥ã€‚ æœ€åï¼Œå®ƒå°†ä¸ç»„ä»¶åŒ¹é…çš„<code>entity</code>ä½é›†ä¸­çš„ä½è®¾ç½®ä¸º<code>true</code> ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span>... Args&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Entity entity, Args&amp;&amp;... args)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> index = <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;Index&gt;(mComponents.size()); mComponents.emplace_back(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::forward&lt;Args&gt;(args)...); mComponentToEntity.emplace_back(entity); mEntityToComponent[entity] = index; mEntityToBitset[entity][T::type] = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; }</code> </pre> <br>  <code>remove</code>æ–¹æ³•å°†ç›¸åº”çš„ä½ç»„ä»¶è®¾ç½®ä¸º<code>false</code> ï¼Œç„¶åå°†æœ€åä¸€ä¸ª<code>mComponents</code>ç»„ä»¶ç§»åŠ¨åˆ°æˆ‘ä»¬è¦åˆ é™¤çš„ç»„ä»¶çš„ç´¢å¼•å¤„ã€‚ å®ƒæ›´æ–°åˆ°æˆ‘ä»¬åˆšåˆšç§»åŠ¨çš„ç»„ä»¶çš„é“¾æ¥ï¼Œå¹¶åˆ é™¤æˆ‘ä»¬è¦é”€æ¯çš„ç»„ä»¶ä¹‹ä¸€ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">remove</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Entity entity)</span></span></span><span class="hljs-function"> </span></span>{ mEntityToBitset[entity][T::type] = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> index = mEntityToComponent[entity]; <span class="hljs-comment"><span class="hljs-comment">// Update mComponents mComponents[index] = std::move(mComponents.back()); mComponents.pop_back(); // Update mEntityToComponent mEntityToComponent[mComponentToEntity.back()] = index; mEntityToComponent.erase(entity); // Update mComponentToEntity mComponentToEntity[index] = mComponentToEntity.back(); mComponentToEntity.pop_back(); }</span></span></code> </pre> <br> æˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨è¦ç ´åçš„ç´¢å¼•å¤„ç§»åŠ¨æœ€åä¸€ä¸ªç»„ä»¶æ¥æ‰§è¡Œæ’å®šæ—¶é—´çš„ç§»åŠ¨ã€‚ å®é™…ä¸Šï¼Œæˆ‘ä»¬åªéœ€è¦åˆ é™¤æœ€åä¸€ä¸ªç»„ä»¶ï¼Œå°±å¯ä»¥åœ¨æ’å®šæ—¶é—´<code>std::vector</code>ä¸­å®Œæˆæ­¤æ“ä½œã€‚ <br><br>  <code>tryRemove</code>æ–¹æ³•åœ¨å°è¯•åˆ é™¤å®ä½“ä¹‹å‰å…ˆæ£€æŸ¥å®ƒæ˜¯å¦å…·æœ‰ç»„ä»¶ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tryRemove</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Entity entity)</span></span></span><span class="hljs-function"> override </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mEntityToBitset[entity][T::type]) { remove(entity); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; }</code> </pre> <br>  <code>getOwner</code>æ–¹æ³•è¿”å›æ‹¥æœ‰ç»„ä»¶çš„å®ä½“ï¼Œä¸ºæ­¤ï¼Œå®ƒä½¿ç”¨æŒ‡é’ˆç®—æ³•å’Œ<code>mComponentToEntity</code> ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">Entity </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getOwner</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> T&amp; component)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> begin = mComponents.data(); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> index = <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span>&gt;(&amp;component - begin); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mComponentToEntity[index]; }</code> </pre> <br> æœ€åä¸€ä¸ªæ–¹æ³•æ˜¯<code>reserve</code> ï¼Œå…¶ç›®çš„ä¸<code>EntityContainer</code>çš„ç±»ä¼¼æ–¹æ³•ç›¸åŒï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reserve</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> size)</span></span></span><span class="hljs-function"> override </span></span>{ mComponents.reserve(size); mComponentToEntity.reserve(size); mEntityToComponent.reserve(size); }</code> </pre> <br><h2> ç³»ç»Ÿ </h2><br> ç°åœ¨è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹<code>System</code>ç±»ã€‚ <br><br> æ¯ä¸ªç³»ç»Ÿéƒ½æœ‰ä¸€ç»„<code>mRequirements</code>ä½ï¼Œ <code>mRequirements</code>ä½æè¿°äº†æ‰€éœ€çš„ç»„ä»¶ã€‚ æ­¤å¤–ï¼Œå®ƒå­˜å‚¨ä¸€ç»„æ»¡è¶³è¿™äº›è¦æ±‚çš„<code>mManagedEntities</code>å®ä½“ã€‚ æˆ‘é‡å¤ä¸€éï¼Œä¸ºäº†èƒ½å¤Ÿåœ¨æ’å®šæ—¶é—´å†…å®æ–½æ‰€æœ‰æ“ä½œï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç§ä»å®ä½“ç§»åˆ°<code>mManagedEntities</code>ç´¢å¼•çš„<code>mManagedEntities</code> ã€‚ ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨åä¸º<code>mEntityToManagedEntity</code> <code>std::unordered_map</code> ã€‚ <br><br> è¿™æ˜¯<code>System</code>å£°æ˜çš„æ ·å­ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> ComponentCount, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> SystemCount&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">System</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> ~System() = <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> ...Ts&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setRequirements</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;Entity&gt;&amp; getManagedEntities() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onManagedEntityAdded</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">([[maybe_unused]] Entity entity)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onManagedEntityRemoved</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">([[maybe_unused]] Entity entity)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">friend</span></span> EntityManager&lt;ComponentCount, SystemCount&gt;; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">bitset</span></span>&lt;ComponentCount&gt; mRequirements; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> mType; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;Entity&gt; mManagedEntities; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">unordered_map</span></span>&lt;Entity, Index&gt; mEntityToManagedEntity; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setUp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> type)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onEntityUpdated</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Entity entity, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">bitset</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;ComponentCount&gt;&amp; components)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onEntityRemoved</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Entity entity)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addEntity</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Entity entity)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">removeEntity</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Entity entity)</span></span></span></span>; };</code> </pre> <br>  <code>setRequirements</code>ä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å·ç§¯è¡¨è¾¾å¼</a>æ¥è®¾ç½®ä½å€¼ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> ...Ts&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setRequirements</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ (mRequirements.<span class="hljs-built_in"><span class="hljs-built_in">set</span></span>(Ts::type), ...); }</code> </pre> <br>  <code>getManagedEntities</code>æ˜¯ä¸€ä¸ªgetterï¼Œç”Ÿæˆçš„ç±»å°†ä½¿ç”¨è¯¥getteræ¥è®¿é—®æ­£åœ¨å¤„ç†çš„å®ä½“ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;Entity&gt;&amp; getManagedEntities() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mManagedEntities; }</code> </pre> <br> å®ƒè¿”å›ä¸€ä¸ªå¸¸é‡å¼•ç”¨ï¼Œä»¥ä½¿ç”Ÿæˆçš„ç±»ä¸ä¼šå°è¯•ä¿®æ”¹<code>mManagedEntities</code> ã€‚ <br><br>  <code>onManagedEntityAdded</code>å’Œ<code>onManagedEntityRemoved</code>ä¸ºç©ºã€‚ å®ƒä»¬å°†åœ¨ä»¥åé‡æ–°å®šä¹‰ã€‚ å°†å®ä½“æ·»åŠ åˆ°<code>mManagedEntities</code>æˆ–å°†å…¶åˆ é™¤æ—¶ï¼Œå°†è°ƒç”¨è¿™äº›æ–¹æ³•ã€‚ <br><br> ä»¥ä¸‹æ–¹æ³•å°†æ˜¯ç§æœ‰çš„ï¼Œå¹¶ä¸”åªèƒ½ä»å£°æ˜ä¸ºå‹å¥½ç±»çš„<code>EntityManager</code>è®¿é—®ã€‚ <br><br> å®ä½“ç®¡ç†å™¨å°†è°ƒç”¨<code>setUp</code>ä¸ºç³»ç»Ÿåˆ†é…IDã€‚ ç„¶åå¯ä»¥ä½¿ç”¨å®ƒæ¥ç´¢å¼•æ•°ç»„ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setUp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> type)</span></span></span><span class="hljs-function"> </span></span>{ mType = type; }</code> </pre> <br> å½“å®ä½“å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå³<code>onEntityUpdated</code>è¢«è°ƒç”¨ æ·»åŠ æˆ–åˆ é™¤ç»„ä»¶æ—¶ã€‚ ç³»ç»Ÿæ£€æŸ¥æ˜¯å¦æ»¡è¶³è¦æ±‚ä»¥åŠæ˜¯å¦å·²å¤„ç†å®ä½“ã€‚ å¦‚æœæ»¡è¶³è¦æ±‚å¹¶ä¸”å°šæœªå¤„ç†ï¼Œåˆ™ç³»ç»Ÿå°†å…¶æ·»åŠ ã€‚ ä½†æ˜¯ï¼Œå¦‚æœå®ä½“ä¸æ»¡è¶³è¦æ±‚å¹¶ä¸”å·²ç»è¢«å¤„ç†ï¼Œåˆ™ç³»ç»Ÿå°†å…¶åˆ é™¤ã€‚ åœ¨æ‰€æœ‰å…¶ä»–æƒ…å†µä¸‹ï¼Œç³»ç»Ÿä¸æ‰§è¡Œä»»ä½•æ“ä½œï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onEntityUpdated</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Entity entity, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">bitset</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;ComponentCount&gt;&amp; components)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> satisfied = (mRequirements &amp; components) == mRequirements; <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> managed = mEntityToManagedEntity.find(entity) != <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::end(mEntityToManagedEntity); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (satisfied &amp;&amp; !managed) addEntity(entity); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!satisfied &amp;&amp; managed) removeEntity(entity); }</code> </pre> <br> åˆ é™¤å®ä½“æ—¶ï¼Œå®ä½“ç®¡ç†å™¨å°†è°ƒç”¨<code>onEntityRemoved</code> ã€‚ å¦‚æœè¯¥å®ä½“å·²ç”±ç³»ç»Ÿå¤„ç†ï¼Œåˆ™å°†å…¶åˆ é™¤ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onEntityRemoved</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Entity entity)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mEntityToManagedEntity.find(entity) != <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::end(mEntityToManagedEntity)) removeEntity(entity); }</code> </pre> <br>  <code>addEntity</code>å’Œ<code>removeEntity</code>åªæ˜¯è¾…åŠ©æ–¹æ³•ã€‚ <br><br>  <code>addEntity</code>é€šè¿‡<code>mManagedEntities</code>ç´¢å¼•å°†é“¾æ¥è®¾ç½®ä¸ºä»æ·»åŠ çš„å®ä½“<code>mManagedEntities</code> ï¼Œæ·»åŠ å®ä½“å¹¶è°ƒç”¨<code>onManagedEntityAdded</code> ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addEntity</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Entity entity)</span></span></span><span class="hljs-function"> </span></span>{ mEntityToManagedEntity[entity] = <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;Index&gt;(mManagedEntities.size()); mManagedEntities.emplace_back(entity); onManagedEntityAdded(entity); }</code> </pre> <br>  <code>onManagedEntityRemoved</code>é¦–å…ˆè°ƒç”¨<code>onManagedEntityRemoved</code> ã€‚ ç„¶åï¼Œå®ƒå°†æœ€åå¤„ç†çš„å®ä½“ç§»åˆ°è¦åˆ é™¤çš„å®ä½“çš„ç´¢å¼•å¤„ã€‚ å®ƒæ›´æ–°å¯¹å·²ç§»åŠ¨å®ä½“çš„å¼•ç”¨ã€‚ æœ€åï¼Œå®ƒä»<code>mManagedEntities</code>å’Œ<code>mEntityToManagedEntity</code>åˆ é™¤è¦åˆ é™¤çš„å®ä½“ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">removeEntity</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Entity entity)</span></span></span><span class="hljs-function"> </span></span>{ onManagedEntityRemoved(entity); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> index = mEntityToManagedEntity[entity]; mEntityToManagedEntity[mManagedEntities.back()] = index; mEntityToManagedEntity.erase(entity); mManagedEntities[index] = mManagedEntities.back(); mManagedEntities.pop_back(); }</code> </pre> <br><h2> å®ä½“ç®¡ç†å™¨ </h2><br> æ‰€æœ‰é‡è¦çš„é€»è¾‘éƒ½åœ¨å…¶ä»–ç±»åˆ«ä¸­ã€‚ å®ä½“ç»ç†åªæ˜¯å°†æ‰€æœ‰å†…å®¹æ†ç»‘åœ¨ä¸€èµ·ã€‚ <br><br> è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹ä»–çš„å¹¿å‘Šï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> ComponentCount, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> SystemCount&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EntityManager</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">registerComponent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> ...Args&gt; <span class="hljs-function"><span class="hljs-function">T* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createSystem</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Args&amp;&amp; ...args)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reserve</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> size)</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">Entity </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createEntity</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">removeEntity</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Entity entity)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hasComponent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Entity entity)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> ...Ts&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hasComponents</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Entity entity)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T&gt; <span class="hljs-function"><span class="hljs-function">T&amp; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getComponent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Entity entity)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> T&amp; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getComponent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Entity entity)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> ...Ts&gt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::tuple&lt;Ts&amp;...&gt; getComponents(Entity entity); <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> ...Ts&gt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::tuple&lt;<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Ts&amp;...&gt; getComponents(Entity entity) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span>... Args&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addComponent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Entity entity, Args&amp;&amp;... args)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">removeComponent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Entity entity)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T&gt; <span class="hljs-function"><span class="hljs-function">Entity </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getOwner</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> T&amp; component)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">array</span></span>&lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">unique_ptr</span></span>&lt;BaseComponentContainer&gt;, ComponentCount&gt; mComponentContainers; EntityContainer&lt;ComponentCount, SystemCount&gt; mEntities; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">unique_ptr</span></span>&lt;System&lt;ComponentCount, SystemCount&gt;&gt;&gt; mSystems; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkComponentType</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> ...Ts&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkComponentTypes</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">auto</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getComponentContainer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">auto</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getComponentContainer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; };</code> </pre> <br>  <code>EntityManager</code>ç±»å…·æœ‰ä¸‰ä¸ªæˆå‘˜å˜é‡ï¼š <code>mComponentContainers</code> ï¼ˆç”¨äºå­˜å‚¨<code>std::unique_ptr</code> <code>BaseComponentContainer</code> <code>std::unique_ptr</code> ï¼Œ <code>mEntities</code> ï¼ˆä»…æ˜¯<code>EntityContainer</code>çš„å®ä¾‹ï¼‰å’Œ<code>mSystems</code> ï¼ˆç”¨äºå­˜å‚¨æŒ‡å‘<code>System</code> <code>unique_ptr</code>æŒ‡é’ˆï¼‰ã€‚ <br><br> ä¸€ä¸ªç±»æœ‰å¾ˆå¤šæ–¹æ³•ï¼Œä½†å®é™…ä¸Šå®ƒä»¬éƒ½å¾ˆç®€å•ã€‚ <br><br> é¦–å…ˆè®©æˆ‘ä»¬çœ‹ä¸€ä¸‹<code>getComponentContainer</code> ï¼Œå®ƒè¿”å›ä¸€ä¸ªæŒ‡å‘å¤„ç†<code>T</code>ç±»å‹ç»„ä»¶çš„ç»„ä»¶å®¹å™¨çš„æŒ‡é’ˆï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">auto</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getComponentContainer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;ComponentContainer&lt;T, ComponentCount, SystemCount&gt;*&gt;(mComponentContainers[T::type].get()); }</code> </pre> <br> å¦ä¸€ä¸ªè¾…åŠ©å‡½æ•°æ˜¯<code>checkComponentType</code> ï¼Œå®ƒä»…æ£€æŸ¥ç»„ä»¶ç±»å‹IDæ˜¯å¦ä½äºæœ€å¤§ç»„ä»¶æ•°ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkComponentType</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static_assert</span></span>(T::type &lt; ComponentCount); }</code> </pre> <br>  <code>checkComponentTypes</code>ä½¿ç”¨å·ç§¯è¡¨è¾¾å¼æ‰§è¡Œå‡ ç§ç±»å‹çš„æ£€æŸ¥ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> ...Ts&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkComponentTypes</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>{ (checkComponentType&lt;Ts&gt;(), ...); }</code> </pre> <br>  <code>registerComponent</code>åˆ›å»ºæŒ‡å®šç±»å‹çš„ç»„ä»¶çš„æ–°å®¹å™¨ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">registerComponent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ checkComponentType&lt;T&gt;(); mComponentContainers[T::type] = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::make_unique&lt;ComponentContainer&lt;T, ComponentCount, SystemCount&gt;&gt;( mEntities.getEntityToBitset()); }</code> </pre> <br>  <code>createSystem</code>åˆ›å»ºæŒ‡å®šç±»å‹çš„æ–°ç³»ç»Ÿå¹¶è®¾ç½®å…¶ç±»å‹ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> ...Args&gt; <span class="hljs-function"><span class="hljs-function">T* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createSystem</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Args&amp;&amp; ...args)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> type = mSystems.size(); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span>&amp; system = mSystems.emplace_back(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::make_unique&lt;T&gt;(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::forward&lt;Args&gt;(args)...)); system-&gt;setUp(type); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;T*&gt;(system.get()); }</code> </pre> <br>  <code>reserve</code>æ–¹æ³•è°ƒç”¨<code>ComponentContainer</code>å’Œ<code>EntityContainer</code>çš„<code>reserve</code>æ–¹æ³•ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reserve</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> size)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> i = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>); i &lt; ComponentCount; ++i) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mComponentContainers[i]) mComponentContainers[i]-&gt;reserve(size); } mEntities.reserve(size); }</code> </pre> <br>  <code>createEntity</code>æ–¹æ³•è¿”å›<code>EntityManager</code>ç®¡ç†å™¨çš„<code>create</code>æ–¹æ³•çš„ç»“æœï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">Entity </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createEntity</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mEntities.create(); }</code> </pre> <br>  <code>hasComponent</code>ä½¿ç”¨ä¸€ç»„å®ä½“ä½æ¥å¿«é€ŸéªŒè¯è¯¥å®ä½“æ˜¯å¦å…·æœ‰æŒ‡å®šç±»å‹çš„ç»„ä»¶ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hasComponent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Entity entity)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>{ checkComponentType&lt;T&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mEntities.getBitset(entity)[T::type]; }</code> </pre> <br>  <code>hasComponents</code>ä½¿ç”¨å·ç§¯è¡¨è¾¾å¼åˆ›å»ºä¸€ç»„è¡¨ç¤ºæ‰€éœ€ç»„ä»¶çš„ä½ï¼Œç„¶åå°†å…¶ä¸å®ä½“çš„ä¸€ç»„ä½ä¸€èµ·ä½¿ç”¨ä»¥æ£€æŸ¥è¯¥å®ä½“æ˜¯å¦å…·æœ‰æ‰€æœ‰å¿…éœ€çš„ç»„ä»¶ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> ...Ts&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hasComponents</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Entity entity)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>{ checkComponentTypes&lt;Ts...&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> requirements = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">bitset</span></span>&lt;ComponentCount&gt;(); (requirements.<span class="hljs-built_in"><span class="hljs-built_in">set</span></span>(Ts::type), ...); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (requirements &amp; mEntities.getBitset(entity)) == requirements; }</code> </pre> <br>  <code>getComponent</code>å°†è¯·æ±‚é‡å®šå‘åˆ°æ‰€éœ€çš„ç»„ä»¶å®¹å™¨ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T&gt; <span class="hljs-function"><span class="hljs-function">T&amp; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getComponent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Entity entity)</span></span></span><span class="hljs-function"> </span></span>{ checkComponentType&lt;T&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> getComponentContainer&lt;T&gt;()-&gt;get(entity); }</code> </pre> <br>  <code>getComponents</code>è¿”å›åˆ°è¯·æ±‚çš„ç»„ä»¶çš„é“¾æ¥çš„å…ƒç»„ã€‚ ä¸ºæ­¤ï¼Œå®ƒä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code>std::tie</code></a>å’Œä¸€ä¸ªå·ç§¯è¡¨è¾¾å¼ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> ...Ts&gt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::tuple&lt;Ts&amp;...&gt; getComponents(Entity entity) { checkComponentTypes&lt;Ts...&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::tie(getComponentContainer&lt;Ts&gt;()-&gt;get(entity)...); }</code> </pre> <br>  <code>addComponent</code>å’Œ<code>removeComponent</code>å°†è¯·æ±‚é‡å®šå‘åˆ°æ‰€éœ€çš„ç»„ä»¶å®¹å™¨ï¼Œç„¶åè°ƒç”¨<code>onEntityUpdated</code>ç³»ç»Ÿ<code>onEntityUpdated</code> ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span>... Args&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addComponent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Entity entity, Args&amp;&amp;... args)</span></span></span><span class="hljs-function"> </span></span>{ checkComponentType&lt;T&gt;(); getComponentContainer&lt;T&gt;()-&gt;add(entity, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::forward&lt;Args&gt;(args)...); <span class="hljs-comment"><span class="hljs-comment">// Send message to systems const auto&amp; bitset = mEntities.getBitset(entity); for (auto&amp; system : mSystems) system-&gt;onEntityUpdated(entity, bitset); } template&lt;typename T&gt; void removeComponent(Entity entity) { checkComponentType&lt;T&gt;(); getComponentContainer&lt;T&gt;()-&gt;remove(entity); // Send message to systems const auto&amp; bitset = mEntities.getBitset(entity); for (auto&amp; system : mSystems) system-&gt;onEntityUpdated(entity, bitset); }</span></span></code> </pre> <br> æœ€åï¼Œ <code>getOwner</code>å°†è¯·æ±‚é‡å®šå‘åˆ°æ‰€éœ€çš„å®¹å™¨ç»„ä»¶ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T&gt; <span class="hljs-function"><span class="hljs-function">Entity </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getOwner</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> T&amp; component)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>{ checkComponentType&lt;T&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> getComponentContainer&lt;T&gt;()-&gt;getOwner(component); }</code> </pre> <br> é‚£æ˜¯æˆ‘çš„ç¬¬ä¸€ä¸ªå®ç°ã€‚ å®ƒä»…åŒ…å«357è¡Œä»£ç ã€‚ æ‰€æœ‰ä»£ç éƒ½å¯ä»¥åœ¨æ­¤<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">çº¿ç¨‹ä¸­</a>æ‰¾åˆ°ã€‚ <br><br><h1> åˆ†æå’ŒåŸºå‡† </h1><br><h2> åŸºå‡†æµ‹è¯• </h2><br> ç°åœ¨æ˜¯å¯¹æˆ‘çš„ç¬¬ä¸€ä¸ªECSå®æ–½è¿›è¡ŒåŸºå‡†æµ‹è¯•çš„æ—¶å€™äº†ï¼ <br><br> ç»“æœå¦‚ä¸‹ï¼š <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4c9/fc6/23e/4c9fc623e0787518bde7823317b0e6af.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/bb0/323/9a9/bb03239a90cccf5f95ab47ecf94e3a4d.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/679/e54/f0e/679e54f0e32260a9f62621838b51a15e.png"></div><br> æ¨¡æ¿å¯ä¼¸ç¼©ï¼ å½“å¢åŠ å®ä½“æ•°é‡å¹¶æ›´æ”¹é…ç½®æ–‡ä»¶ï¼ˆAï¼ŒAAå’ŒAAAï¼‰æ—¶ï¼Œæ¯ç§’å¤„ç†çš„æ•°é‡å¤§çº¦ç›¸åŒã€‚ <br><br> æ­¤å¤–ï¼Œéšç€å®ä½“ä¸­ç»„ä»¶æ•°é‡çš„å¢åŠ ï¼Œå®ƒå¯ä»¥å¾ˆå¥½åœ°æ‰©å±•ã€‚ å½“æˆ‘ä»¬éå†å…·æœ‰ä¸‰ä¸ªç»„æˆéƒ¨åˆ†çš„å®ä½“æ—¶ï¼Œå®ƒä»¬å‘ç”Ÿçš„é€Ÿåº¦æ¯”éå†å…·æœ‰ä¸€ä¸ªç»„æˆéƒ¨åˆ†çš„å®ä½“æ…¢ä¸‰å€ã€‚ è¿™æ˜¯å¯ä»¥é¢„æœŸçš„ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦è·å¾—ä¸‰ä¸ªç»„æˆéƒ¨åˆ†ã€‚ <br><br><h2> ç¼“å­˜æœªå‘½ä¸­ </h2><br> ä¸ºäº†æ£€æŸ¥ç¼“å­˜æœªå‘½ä¸­çš„æ•°é‡ï¼Œæˆ‘è¿è¡Œäº†<a href="">ä»æ­¤å¤„</a>è·å–çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">cachegrind</a>ç¤ºä¾‹ã€‚ <br><br> è¿™æ˜¯10,000ä¸ªå®ä½“çš„ç»“æœï¼š <br><br> <code>==1652== D refs: 277,577,353 (254,775,159 rd + 22,802,194 wr) <br> ==1652== D1 misses: 20,814,368 ( 20,759,914 rd + 54,454 wr) <br> ==1652== LLd misses: 43,483 ( 7,847 rd + 35,636 wr) <br> ==1652== D1 miss rate: 7.5% ( 8.1% + 0.2% ) <br> ==1652== LLd miss rate: 0.0% ( 0.0% + 0.2% )</code> <br> <br> è¿™æ˜¯100,000ä¸ªå®ä½“çš„ç»“æœï¼š <br><br> <code>==1738== D refs: 2,762,879,670 (2,539,368,564 rd + 223,511,106 wr) <br> ==1738== D1 misses: 207,415,181 ( 206,902,072 rd + 513,109 wr) <br> ==1738== LLd misses: 207,274,328 ( 206,789,289 rd + 485,039 wr) <br> ==1738== D1 miss rate: 7.5% ( 8.1% + 0.2% ) <br> ==1738== LLd miss rate: 7.5% ( 8.1% + 0.2% )</code> <br> <br> ç»“æœå¾ˆå¥½ã€‚ ä¸ºä½•åœ¨100,000ä¸ªå®ä½“ä¸­æœ‰å¦‚æ­¤å¤šçš„LLdæœªå‘½ä¸­ï¼Œè¿™æœ‰ç‚¹å¥‡æ€ªã€‚ <br><br><h2> å‰–æ </h2><br> ä¸ºäº†äº†è§£å½“å‰å®ç°çš„å“ªäº›éƒ¨åˆ†éœ€è¦æ›´é•¿çš„æ—¶é—´ï¼Œæˆ‘ä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">gprof</a>å¯¹ç¤ºä¾‹è¿›è¡Œäº†<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">åˆ†æ</a> ã€‚ <br><br> ç»“æœå¦‚ä¸‹ï¼š <br><br> <code>Flat profile: <br> <br> Each sample counts as 0.01 seconds. <br> % cumulative self self total <br> time seconds seconds calls ms/call ms/call name <br> 57.45 1.16 1.16 200300000 0.00 0.00 std::__detail::_Map_base&lt;unsigned int, std::pair&lt;unsigned int const, unsigned int&gt;, std::allocator&lt;std::pair&lt;unsigned int const, unsigned int&gt; &gt;, std::__detail::_Select1st, std::equal_to&lt;unsigned int&gt;, std::hash&lt;unsigned int&gt;, std::__detail::_Mod_range_hashing, std::__detail::_Default_ranged_hash, std::__detail::_Prime_rehash_policy, std::__detail::_Hashtable_traits&lt;false, false, true&gt;, true&gt;::operator[](unsigned int const&amp;) <br> 19.31 1.55 0.39 main <br> 16.34 1.88 0.33 200500000 0.00 0.00 std::_Hashtable&lt;unsigned int, std::pair&lt;unsigned int const, unsigned int&gt;, std::allocator&lt;std::pair&lt;unsigned int const, unsigned int&gt; &gt;, std::__detail::_Select1st, std::equal_to&lt;unsigned int&gt;, std::hash&lt;unsigned int&gt;, std::__detail::_Mod_range_hashing, std::__detail::_Default_ranged_hash, std::__detail::_Prime_rehash_policy, std::__detail::_Hashtable_traits&lt;false, false, true&gt; &gt;::_M_find_before_node(unsigned long, unsigned int const&amp;, unsigned long) const <br> 3.96 1.96 0.08 300000 0.00 0.00 std::_Hashtable&lt;unsigned int, std::pair&lt;unsigned int const, unsigned int&gt;, std::allocator&lt;std::pair&lt;unsigned int const, unsigned int&gt; &gt;, std::__detail::_Select1st, std::equal_to&lt;unsigned int&gt;, std::hash&lt;unsigned int&gt;, std::__detail::_Mod_range_hashing, std::__detail::_Default_ranged_hash, std::__detail::_Prime_rehash_policy, std::__detail::_Hashtable_traits&lt;false, false, true&gt; &gt;::_M_insert_unique_node(unsigned long, unsigned long, std::__detail::_Hash_node&lt;std::pair&lt;unsigned int const, unsigned int&gt;, false&gt;*) <br> 2.48 2.01 0.05 300000 0.00 0.00 unsigned int&amp; std::vector&lt;unsigned int, std::allocator&lt;unsigned int&gt; &gt;::emplace_back&lt;unsigned int&amp;&gt;(unsigned int&amp;) <br> 0.50 2.02 0.01 3 3.33 3.33 std::_Hashtable&lt;unsigned int, std::pair&lt;unsigned int const, unsigned int&gt;, std::allocator&lt;std::pair&lt;unsigned int const, unsigned int&gt; &gt;, std::__detail::_Select1st, std::equal_to&lt;unsigned int&gt;, std::hash&lt;unsigned int&gt;, std::__detail::_Mod_range_hashing, std::__detail::_Default_ranged_hash, std::__detail::_Prime_rehash_policy, std::__detail::_Hashtable_traits&lt;false, false, true&gt; &gt;::~_Hashtable() <br> 0.00 2.02 0.00 200000 0.00 0.00 std::_Hashtable&lt;unsigned int, std::pair&lt;unsigned int const, unsigned int&gt;, std::allocator&lt;std::pair&lt;unsigned int const, unsigned int&gt; &gt;, std::__detail::_Select1st, std::equal_to&lt;unsigned int&gt;, std::hash&lt;unsigned int&gt;, std::__detail::_Mod_range_hashing, std::__detail::_Default_ranged_hash, std::__detail::_Prime_rehash_policy, std::__detail::_Hashtable_traits&lt;false, false, true&gt; &gt;::find(unsigned int const&amp;)</code> <br> <br> ç»“æœå¯èƒ½æœ‰äº›å¤±çœŸï¼Œå› ä¸ºæˆ‘ä½¿ç”¨<code>-O1</code>æ ‡å¿—è¿›è¡Œäº†ç¼–è¯‘ï¼Œ <code>-O1</code> gprof <code>-O1</code>æœ‰æ„ä¹‰çš„å†…å®¹ã€‚ çœ‹æ¥ï¼Œå½“æé«˜ä¼˜åŒ–çº§åˆ«æ—¶ï¼Œç¼–è¯‘å™¨å¼€å§‹ç§¯æåµŒå…¥æ‰€æœ‰å†…å®¹ï¼Œè€Œgprofå‡ ä¹ä»€ä¹ˆä¹Ÿæ²¡è¯´ã€‚ <br><br> æ ¹æ®gprofçš„è¯´æ³•ï¼Œæ­¤å®ç°ä¸­çš„æ˜æ˜¾ç“¶é¢ˆæ˜¯<code>std::unordered_map</code> ã€‚ å¦‚æœæˆ‘ä»¬æƒ³å¯¹å…¶è¿›è¡Œä¼˜åŒ–ï¼Œé‚£ä¹ˆå°±å€¼å¾—å°è¯•æ‘†è„±å®ƒä»¬ã€‚ <br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ä¸ä¹‹æ¯”è¾ƒ </font></font><code>std::map</code> </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æˆ‘å¼€å§‹å¥½å¥‡ä¸­ä¹‹é—´çš„æ€§èƒ½å·®å¼‚</font></font><code>std::unordered_map</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å’Œ</font></font><code>std::map</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œæ‰€ä»¥æˆ‘æ”¹å˜äº†ä»£ç å…¨éƒ¨</font></font><code>std::unordered_map</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸Š</font></font><code>std::map</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è¿™é‡Œ</font></font></a> <font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æä¾›</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">äº†</font></a><font style="vertical-align: inherit;">è¯¥å®ç°ï¼Œ</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸‹é¢æ˜¯åŸºå‡†æµ‹è¯•ç»“æœï¼š</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/611/50b/3da/61150b3da1ec1cf850a0ed5b761f03a1.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/136/3be/951/1363be95163a3dfb2ab968c1591c7c60.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d08/b4b/7f1/d08b4b7f1b5b35531bdc32a614ccbb81.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¿™æ¬¡éšç€å®ä½“æ•°é‡çš„å¢åŠ ï¼Œå®ç°æ— æ³•å¾ˆå¥½åœ°æ‰©å±•ã€‚</font><font style="vertical-align: inherit;">å³ä½¿æœ‰1000ä¸ªå®ä½“ï¼Œå…¶è¿­ä»£é€Ÿåº¦ä¹Ÿæ˜¯ç‰ˆæœ¬cçš„ä¸¤å€</font></font><code>std::unordered_map</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font><br><br><h1> ç»“è®º </h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æˆ‘ä»¬å·²ç»åˆ›å»ºäº†ä¸€ä¸ªç®€å•ä½†å·²ç»å®ç”¨çš„å®ä½“-ç»„ä»¶-ç³»ç»Ÿæ¨¡æ¿åº“ã€‚</font><font style="vertical-align: inherit;">å°†æ¥ï¼Œæˆ‘ä»¬å°†ä»¥æ­¤ä¸ºåŸºç¡€è¿›è¡Œæ”¹è¿›å’Œä¼˜åŒ–ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åœ¨ä¸‹ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å±•ç¤ºå¦‚ä½•é€šè¿‡æ›¿ä»£æ¥æé«˜ç”Ÿäº§åŠ›</font></font><code>std::unordered_map</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸Š</font></font><code>std::vector</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">æ­¤å¤–ï¼Œæˆ‘ä»¬å°†å±•ç¤ºå¦‚ä½•è‡ªåŠ¨å°†IDç±»å‹åˆ†é…ç»™ç»„ä»¶ã€‚</font></font><br><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ç”¨std :: vectoræ›¿æ¢std :: unordered_map </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ­£å¦‚æˆ‘ä»¬æ‰€çœ‹åˆ°çš„ï¼Œå®ƒä»¬</font></font><code>std::unordered_map</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ˜¯æˆ‘ä»¬å®æ–½çš„ç“¶é¢ˆã€‚</font><font style="vertical-align: inherit;">å› æ­¤ï¼Œè€Œä¸æ˜¯</font></font><code>std::unordered_map</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æˆ‘ä»¬ä½¿ç”¨</font></font><code>mEntityToComponent</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åˆ°</font></font><code>ComponentContainer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å’Œ</font></font><code>mEntityToManagedEntity</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åˆ°</font></font><code>System</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è½½ä½“</font></font><code>std::vector</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> å˜åŒ– </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ›´æ”¹å°†éå¸¸ç®€å•ï¼Œæ‚¨å¯ä»¥åœ¨</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ­¤å¤„</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æŸ¥çœ‹å®ƒä»¬</font><font style="vertical-align: inherit;">ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å”¯ä¸€çš„ç²¾å¦™ä¹‹å¤„åœ¨äºä¸€ä¸ªäº‹å®ï¼Œå³</font></font><code>vector</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åœ¨</font></font><code>mEntityToComponent</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å’Œ</font></font><code>mEntityToManagedEntity</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å·²ç»è¶³å¤Ÿé•¿ï¼Œä»¥æŒ‡æ•°çš„ä»»ä½•å®ä½“ã€‚</font><font style="vertical-align: inherit;">ä¸ºæ­¤ï¼Œæˆ‘å†³å®šå°†å®ƒä»¬å­˜å‚¨</font></font><code>vector</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åœ¨ä¸­</font></font><code>EntityContainer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œåœ¨å…¶ä¸­æˆ‘ä»¬çŸ¥é“å®ä½“çš„æœ€å¤§IDã€‚</font><font style="vertical-align: inherit;">ç„¶åï¼Œæˆ‘é€šè¿‡</font></font><code>vector</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å®ä½“ç®¡ç†å™¨ä¸­çš„å¼•ç”¨æˆ–æŒ‡é’ˆ</font><font style="vertical-align: inherit;">å°†å‘é‡ä¼ é€’åˆ°</font><font style="vertical-align: inherit;">ç»„ä»¶å®¹å™¨ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¿®æ”¹åçš„ä»£ç å¯ä»¥åœ¨æ­¤</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">çº¿ç¨‹ä¸­</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ‰¾åˆ°</font><font style="vertical-align: inherit;">ã€‚</font></font><br><br><h2> ç»“æœ </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> è®©æˆ‘ä»¬æ£€æŸ¥ä¸€ä¸‹è¯¥ç‰ˆæœ¬æ¯”ä¸Šä¸€ä¸ªç‰ˆæœ¬å¦‚ä½•æ›´å¥½åœ°å·¥ä½œï¼š </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/38a/1df/4bd/38a1df4bd3c8110d3873588854ffc314.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0f5/897/2ae/0f58972ae408b9726899597fbd774be1.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/22b/3f5/fcd/22b3f5fcd21c8285cc779f46ca3896a4.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¦‚æ‚¨æ‰€è§ï¼Œä½¿ç”¨å¤§é‡ç»„ä»¶å’Œç³»ç»Ÿè¿›è¡Œåˆ›å»ºå’Œåˆ é™¤å˜å¾—æœ‰ç‚¹</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ…¢ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä½†æ˜¯ï¼Œè¿­ä»£é€Ÿåº¦å¿«äº†åå€ï¼</font><font style="vertical-align: inherit;">è€Œä¸”æ‰©å±•æ€§éå¸¸å¥½ã€‚</font><font style="vertical-align: inherit;">è¿™ç§é€Ÿåº¦å¤§å¤§è¶…è¿‡äº†åˆ›å»ºå’Œåˆ é™¤çš„é€Ÿåº¦ã€‚</font><font style="vertical-align: inherit;">è¿™æ˜¯åˆä¹é€»è¾‘çš„ï¼šå®ä½“çš„è¿­ä»£å°†å‘ç”Ÿå¤šæ¬¡ï¼Œä½†ä»…åˆ›å»ºå’Œåˆ é™¤ä¸€æ¬¡ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç°åœ¨è®©æˆ‘ä»¬çœ‹çœ‹è¿™æ˜¯å¦å‡å°‘äº†é«˜é€Ÿç¼“å­˜æœªå‘½ä¸­çš„æ¬¡æ•°ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è¿™æ˜¯å…·æœ‰10,000ä¸ªå®ä½“çš„cachegrindçš„è¾“å‡ºï¼š</font><font style="vertical-align: inherit;">è¿™æ˜¯100,000ä¸ªå®ä½“çš„è¾“å‡ºï¼š</font><font style="vertical-align: inherit;">æˆ‘ä»¬çœ‹åˆ°æ­¤ç‰ˆæœ¬åˆ›å»ºçš„é“¾æ¥å‡å°‘äº†å¤§çº¦ä¸‰å€ï¼Œé«˜é€Ÿç¼“å­˜æœªå‘½ä¸­æ¬¡æ•°å‡å°‘äº†å››å€ã€‚</font></font><br><br> <code>==1374== D refs: 94,563,949 (72,082,880 rd + 22,481,069 wr) <br> ==1374== D1 misses: 4,813,780 ( 4,417,702 rd + 396,078 wr) <br> ==1374== LLd misses: 378,905 ( 9,626 rd + 369,279 wr) <br> ==1374== D1 miss rate: 5.1% ( 6.1% + 1.8% ) <br> ==1374== LLd miss rate: 0.4% ( 0.0% + 1.6% )</code> <br> <br><font style="vertical-align: inherit;"></font><br><br> <code>==1307== D refs: 938,405,796 (715,424,940 rd + 222,980,856 wr) <br> ==1307== D1 misses: 51,034,738 ( 44,045,090 rd + 6,989,648 wr) <br> ==1307== LLd misses: 5,866,508 ( 1,997,948 rd + 3,868,560 wr) <br> ==1307== D1 miss rate: 5.4% ( 6.2% + 3.1% ) <br> ==1307== LLd miss rate: 0.6% ( 0.3% + 1.7% )</code> <br> <br><font style="vertical-align: inherit;"></font><br><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> è‡ªåŠ¨ç±»å‹ </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> æˆ‘è¦è®¨è®ºçš„æœ€åä¸€ä¸ªæ”¹è¿›æ˜¯è‡ªåŠ¨ç”Ÿæˆç»„ä»¶ç±»å‹æ ‡è¯†ç¬¦ã€‚ </font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> å˜åŒ– </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¯åœ¨</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ­¤å¤„</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ‰¾åˆ°ç”¨äºå®ç°IDç±»å‹è‡ªåŠ¨ç”Ÿæˆçš„æ‰€æœ‰æ›´æ”¹</font><font style="vertical-align: inherit;">ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸ºæ­¤ï¼Œä¸ºäº†èƒ½å¤Ÿä¸ºæ¯ç§ç±»å‹çš„ç»„ä»¶åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„IDï¼Œæ‚¨éœ€è¦ä½¿ç”¨CRTPå’Œå¸¦æœ‰é™æ€è®¡æ•°å™¨çš„å‡½æ•°ï¼š</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Component</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> type; }; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> generateComponentType() { <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> counter = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> counter++; } <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T&gt; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> Component&lt;T&gt;::type = generateComponentType();</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ‚¨å¯èƒ½ä¼šæ³¨æ„åˆ°ç±»å‹IDç°åœ¨æ˜¯åœ¨è¿è¡Œæ—¶ç”Ÿæˆçš„ï¼Œä»¥å‰åœ¨ç¼–è¯‘æ—¶å°±å·²çŸ¥é“ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ›´æ”¹åçš„ä»£ç å¯ä»¥åœ¨æ­¤</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">çº¿ç¨‹ä¸­</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ‰¾åˆ°</font><font style="vertical-align: inherit;">ã€‚</font></font><br><br><h2> ç»“æœ </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ä¸ºäº†æµ‹è¯•æ­¤ç‰ˆæœ¬çš„æ€§èƒ½ï¼Œæˆ‘è¿›è¡Œäº†åŸºå‡†æµ‹è¯•ï¼š </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7bd/112/0da/7bd1120da37daac5e3ef48446776b6e7.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/234/f2f/937/234f2f9377a0f3ad8ea231f91e335ddf.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/101/4f2/ade/1014f2adebd6156bc48c9b6fe5670b43.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¯¹äºåˆ›å»ºå’Œåˆ é™¤ï¼Œç»“æœå¤§è‡´ç›¸åŒã€‚</font><font style="vertical-align: inherit;">ä½†æ˜¯ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°è¿­ä»£é€Ÿåº¦å˜æ…¢äº†ä¸€ç‚¹ï¼Œå¤§çº¦10ï¼…ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¯ä»¥é€šè¿‡ç¼–è¯‘å™¨åœ¨ç¼–è¯‘æ—¶çŸ¥é“ç±»å‹æ ‡è¯†ç¬¦è¿™ä¸€äº‹å®æ¥è§£é‡Šè¿™ç§é€Ÿåº¦ä¸‹é™ï¼Œè¿™æ„å‘³ç€å®ƒå¯ä»¥æ›´å¥½åœ°ä¼˜åŒ–ä»£ç ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ‰‹åŠ¨åˆ†é…IDç±»å‹æœ‰ç‚¹ä¸æ–¹ä¾¿ï¼Œå¹¶ä¸”å¯èƒ½å¯¼è‡´é”™è¯¯ã€‚</font><font style="vertical-align: inherit;">å› æ­¤ï¼Œå³ä½¿æˆ‘ä»¬ç¨å¾®é™ä½äº†æ€§èƒ½ï¼Œå®ƒä»ç„¶æ˜¯ECSåº“å¯ç”¨æ€§çš„æ”¹è¿›ã€‚</font></font><br><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> è¿›ä¸€æ­¥æ”¹è¿›çš„æƒ³æ³• </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åœ¨ç»“æŸæœ¬æ–‡ä¹‹å‰ï¼Œæˆ‘æƒ³ä¸æ‚¨åˆ†äº«å…¶ä»–æ”¹è¿›çš„æƒ³æ³•ã€‚</font><font style="vertical-align: inherit;">åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘è¿˜æ²¡æœ‰å®ç°å®ƒä»¬ï¼Œä½†ä¹Ÿè®¸å°†æ¥ä¼šå®ç°ã€‚</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ç»„ä»¶å’Œç³»ç»Ÿçš„åŠ¨æ€æ•°é‡ </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">äº‹å…ˆä»¥æ¨¡æ¿å‚æ•°çš„å½¢å¼æŒ‡ç¤ºç»„ä»¶å’Œç³»ç»Ÿçš„æœ€å¤§æ•°é‡æ˜¯ä¸æ–¹ä¾¿çš„ã€‚</font><font style="vertical-align: inherit;">æˆ‘è®¤ä¸ºè¿™å°†æœ‰å¯èƒ½å–ä»£</font></font><code>std::array</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åœ¨</font></font><code>EntityManager</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¯¹</font></font><code>std::vector</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ²¡æœ‰å¼ºå¤§çš„æ€§èƒ½ä¸‹é™ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä½†æ˜¯ï¼Œå®ƒ</font></font><code>std::bitset</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">éœ€è¦åœ¨ç¼–è¯‘æ—¶çŸ¥é“ä½æ•°ã€‚</font><font style="vertical-align: inherit;">è™½ç„¶æˆ‘æƒ³çº æ­£é€šè¿‡æ›´æ¢è¿™ä¸ªé—®é¢˜</font></font><code>std::vector&lt;bitset&lt;ComponentCount&gt;&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åœ¨</font></font><code>EntityContainer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸Š</font></font><code>std::vector&lt;char&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¹¶é‡Šæ”¾å‡ºè¶³å¤Ÿçš„å­—èŠ‚æ•°æ¥è¡¨ç¤ºæ‰€æœ‰å®ä½“çš„ä½é›†åˆã€‚</font><font style="vertical-align: inherit;">ç„¶åï¼Œæˆ‘ä»¬å®ç°ä¸€ä¸ªè½»é‡çº§ç±»</font></font><code>BitsetView</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œ</font><font style="vertical-align: inherit;">è¯¥ç±»</font><font style="vertical-align: inherit;">åœ¨è¾“å…¥å¤„æ¥æ”¶ä¸€å¯¹æŒ‡å‘è¯¥ä½é›†åˆçš„å¼€å§‹å’Œç»“æŸçš„æŒ‡é’ˆï¼Œç„¶å</font></font><code>std::bitset</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åœ¨æ­¤å­˜å‚¨èŒƒå›´å†…</font><font style="vertical-align: inherit;">æ‰§è¡Œæ‰€æœ‰å¿…è¦çš„æ“ä½œ</font><font style="vertical-align: inherit;">ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¦ä¸€ä¸ªæƒ³æ³•ï¼šä¸å†ä½¿ç”¨ä½é›†ï¼Œè€Œæ˜¯æ£€æŸ¥</font></font><code>mEntityToComponent</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å®ä½“æ˜¯å¦å…·æœ‰ç»„ä»¶ã€‚</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ç®€åŒ–çš„ç»„ä»¶è¿­ä»£ </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ç›®å‰ï¼Œå¦‚æœç³»ç»Ÿè¦è¿­ä»£å¤„ç†å…¶å¤„ç†çš„å®ä½“çš„ç»„ä»¶ï¼Œåˆ™éœ€è¦è¿™æ ·åšï¼š </font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span>&amp; entity : getManagedEntities()) { <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> [position, velocity] = mEntityManager.getComponents&lt;Position, Velocity&gt;(entity); ... }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> å¦‚æœæˆ‘ä»¬å¯ä»¥åšè¿™æ ·çš„äº‹æƒ…ï¼Œé‚£å°†æ˜¯æ›´æ¼‚äº®ï¼Œæ›´ç®€å•çš„ï¼š </font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">auto</span></span>&amp; [position, velocity] : mEntityManager.getComponents&lt;Position, Velocity&gt;(mManagedEntities)) { ... }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å€ŸåŠ©</font></font><code>std::view::transform</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C ++ 20 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸­</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">çš„rangesåº“</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œ</font><font style="vertical-align: inherit;">å°†æ›´å®¹æ˜“å®ç°è¿™ä¸€ç‚¹</font><font style="vertical-align: inherit;">ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸å¹¸çš„æ˜¯ï¼Œå®ƒè¿˜ä¸å­˜åœ¨ã€‚</font><font style="vertical-align: inherit;">æˆ‘å¯ä»¥ä½¿ç”¨</font><font style="vertical-align: inherit;">Eric Niblerçš„</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">èŒƒå›´åº“</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œä½†æ˜¯æˆ‘ä¸æƒ³æ·»åŠ ä¾èµ–é¡¹ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è§£å†³æ–¹æ¡ˆå¯èƒ½æ˜¯å®ç°ä¸€ä¸ªç±»</font></font><code>EntityRangeView</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œ</font><font style="vertical-align: inherit;">è¯¥ç±»</font><font style="vertical-align: inherit;">å°†æ¥æ”¶éœ€è¦æ¥æ”¶çš„ç»„ä»¶ç±»å‹ä½œä¸ºæ¨¡æ¿å‚æ•°ï¼Œå¹¶ä½¿ç”¨</font></font><code>std::vector</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å®ä½“</font><font style="vertical-align: inherit;">å¼•ç”¨ä½œä¸ºæ„é€ å‡½æ•°å‚æ•°</font><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">ç„¶åï¼Œæˆ‘ä»¬å°†ä¸å¾—ä¸æ‰æ„è¯†åˆ°</font></font><code>begin</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œ</font></font><code>end</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å’Œè¿­ä»£å™¨ç±»å‹ï¼Œä»¥å®ç°æ‰€éœ€çš„è¡Œä¸ºã€‚</font><font style="vertical-align: inherit;">è¿™ä¸æ˜¯å¾ˆå›°éš¾ï¼Œä½†æ˜¯ä¼šèŠ±è´¹ä¸€äº›æ—¶é—´ã€‚</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> æ´»åŠ¨ç®¡ç†ä¼˜åŒ– </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åœ¨å½“å‰çš„å®ç°ä¸­ï¼Œå½“ä»å®ä½“ä¸­æ·»åŠ æˆ–åˆ é™¤ç»„ä»¶æ—¶ï¼Œæˆ‘ä»¬ç§°</font></font><code>onEntityUpdated</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ‰€æœ‰ç³»ç»Ÿã€‚</font><font style="vertical-align: inherit;">è¿™æœ‰ç‚¹æ•ˆç‡ä½ä¸‹ï¼Œå› ä¸ºè®¸å¤šç³»ç»Ÿå¯¹åˆšåˆšæ›´æ”¹çš„ç»„ä»¶ç±»å‹ä¸æ„Ÿå…´è¶£ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸ºäº†æœ€å¤§ç¨‹åº¦åœ°å‡å°‘ç ´åï¼Œæˆ‘ä»¬å¯ä»¥å­˜å‚¨æŒ‡å‘å¯¹æ•°æ®ç»“æ„ä¸­æŒ‡å®šç±»å‹çš„ç»„ä»¶æ„Ÿå…´è¶£çš„ç³»ç»Ÿçš„æŒ‡é’ˆï¼Œä¾‹å¦‚</font></font><code>std::array&lt;std::vector&lt;System&lt;ComponentCount, SystemCount&gt;&gt;, ComponentCount&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">ç„¶åï¼Œåœ¨æ·»åŠ æˆ–åˆ é™¤ç»„ä»¶æ—¶ï¼Œæˆ‘ä»¬åªéœ€è°ƒç”¨</font></font><code>onEntityUpdated</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¯¹è¯¥ç»„ä»¶æ„Ÿå…´è¶£</font><font style="vertical-align: inherit;">çš„</font><font style="vertical-align: inherit;">ç³»ç»Ÿ</font><font style="vertical-align: inherit;">æ–¹æ³•å³å¯</font><font style="vertical-align: inherit;">ã€‚</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ç”±å®ä½“ç®¡ç†å™¨è€Œéç³»ç»Ÿç®¡ç†çš„å®ä½“å­é›† </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æˆ‘çš„æœ€åä¸€ä¸ªæƒ³æ³•å°†å¯¼è‡´å›¾ä¹¦é¦†ç»“æ„çš„æ›´å¹¿æ³›çš„å˜åŒ–ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä»£æ›¿ç®¡ç†å…¶å®ä½“é›†çš„ç³»ç»Ÿï¼Œå®ä½“ç®¡ç†å™¨å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ã€‚è¿™ç§æ–¹æ¡ˆçš„ä¼˜åŠ¿åœ¨äºï¼Œå¦‚æœä¸¤ä¸ªç³»ç»Ÿå¯¹ä¸€ç»„ç»„ä»¶æ„Ÿå…´è¶£ï¼Œæˆ‘ä»¬ä¸ä¼šå¤åˆ¶æ»¡è¶³è¿™äº›è¦æ±‚çš„å®ä½“å­é›†ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç³»ç»Ÿå¯ä»¥ç®€å•åœ°å‘å®ä½“ç»ç†å£°æ˜å…¶è¦æ±‚ã€‚ç„¶åï¼Œå®ä½“ç®¡ç†å™¨å°†å­˜å‚¨å®ä½“çš„æ‰€æœ‰ä¸åŒå­é›†ã€‚æœ€åï¼Œç³»ç»Ÿå°†ä½¿ç”¨ç±»ä¼¼çš„è¯­æ³•æŸ¥è¯¢å®ä½“ï¼š</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span>&amp; entity : mEntityManager.getEntitiesWith&lt;Position, Velocity&gt;()) { ... }</code> </pre> <br><h1> ç»“è®º </h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åˆ°ç›®å‰ä¸ºæ­¢ï¼Œè¿™æ˜¯å…³äºæˆ‘çš„å®ä½“ç»„ä»¶ç³»ç»Ÿå®ç°çš„æ–‡ç« çš„ç»“å°¾ã€‚</font><font style="vertical-align: inherit;">å¦‚æœæˆ‘è¿›è¡Œå…¶ä»–æ”¹è¿›ï¼Œå°†æ¥å¯èƒ½ä¼šå†™æ–°æ–‡ç« ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æœ¬æ–‡ä¸­æè¿°çš„å®ç°éå¸¸ç®€å•ï¼šå®ƒç”±å°‘äº500è¡Œä»£ç ç»„æˆï¼Œå¹¶ä¸”å…·æœ‰è‰¯å¥½çš„æ€§èƒ½ã€‚</font><font style="vertical-align: inherit;">æ‰€æœ‰äº¤æ˜“å‡åœ¨å›ºå®šæ—¶é—´å†…ï¼ˆæ‘Šé”€ï¼‰å®ç°ã€‚</font><font style="vertical-align: inherit;">æ­¤å¤–ï¼Œåœ¨å®è·µä¸­ï¼Œå®ƒæœ€ä½³åœ°ä½¿ç”¨äº†ç¼“å­˜å¹¶éå¸¸å¿«é€Ÿåœ°æ¥æ”¶å’Œè¿­ä»£å®ä½“ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æˆ‘å¸Œæœ›è¿™ç¯‡æ–‡ç« å¯¹æ‚¨å¾ˆæœ‰æ„æ€ç”šè‡³æœ‰ç”¨ã€‚</font></font><br><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> è¡¥å……é˜…è¯» </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ä»¥ä¸‹æ˜¯ä¸€äº›æœ‰ç”¨çš„èµ„æºï¼Œå¯ç”¨äºæ›´æ·±å…¥åœ°ç ”ç©¶å®ä½“ç»„ä»¶ç³»ç»Ÿæ¨¡å¼ï¼š </font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç±³æ­‡å°”è¯¥éšï¼Œç¬”è€…</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">entt</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œå†™äº†ä¸€ä¸ªéå¸¸æœ‰è¶£çš„ä¸€ç³»åˆ—å…³äºæ‰€è°“çš„å®ä½“ç»„ä»¶ç³»ç»Ÿæ–‡ç« </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">çš„ECSå›å¾€å¤</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font></li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å®ä½“ç³»ç»ŸWiki</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åŒ…å«éå¸¸æœ‰ç”¨çš„ä¿¡æ¯å’Œé“¾æ¥ã€‚</font></font></li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN459288/">https://habr.com/ru/post/zh-CN459288/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN459274/index.html">Astra Linuxç‰¹åˆ«ç‰ˆï¼ˆSmolenskï¼‰ä¸­çš„å±å¹•é”å®šæ¼æ´</a></li>
<li><a href="../zh-CN459276/index.html">å²è¯—èˆ¬çš„æŠ—æ•…éšœèƒ½åŠ›2æˆ–ä¸ºä½•ä¸åº”è¯¥ä½¿ç”¨FireFoxæ’ä»¶æ¥å‚ä¸éšç§ä¿æŠ¤</a></li>
<li><a href="../zh-CN459280/index.html">ä¸ºä»€ä¹ˆå¼€å‘äººå‘˜å–œæ¬¢æ„å»ºæœ¬æœºåº”ç”¨ç¨‹åºï¼Ÿ</a></li>
<li><a href="../zh-CN459284/index.html">äº§å“ç­–ç•¥å’ŒåŠŸèƒ½ä¼˜å…ˆçº§ç®€ä»‹</a></li>
<li><a href="../zh-CN459286/index.html">åŠé‡‘å±ç¢²åŒ–é’¨-çº³ç±³æŠ€æœ¯æ—¥çš„ç‘å£«åˆ€</a></li>
<li><a href="../zh-CN459292/index.html">ç§»åŠ¨åº”ç”¨æµ‹è¯•è‡ªåŠ¨åŒ–ï¼šå·¥å…·æ¯”è¾ƒ</a></li>
<li><a href="../zh-CN459294/index.html">æ›´é‡è¦çš„æ˜¯ï¼šäº†è§£ç¼–ç¨‹è¯­è¨€æˆ–èƒ½å¤Ÿè§£å†³ä¸šåŠ¡é—®é¢˜ï¼Ÿ</a></li>
<li><a href="../zh-CN459296/index.html">JavaScriptä»·æ ¼2019</a></li>
<li><a href="../zh-CN459298/index.html">Angularï¼š2019å¹´çŠ¶æ€</a></li>
<li><a href="../zh-CN459300/index.html">Quasar 1.0ï¼šVueå¼€å‘äººå‘˜çš„æ–°å®ç”¨å·¥å…·ï¼Œä¸ä»…é™äºä»–ä»¬</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>