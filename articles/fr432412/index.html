<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü¶à ‚èÆÔ∏è üë©‚Äç‚ù§Ô∏è‚Äçüíã‚Äçüë© Highload ++: Comment aider le syst√®me ERP √† faire face √† 500 000 requ√™tes par seconde üíú ‚óæÔ∏è üöµüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Chez X5, nous traitons beaucoup de donn√©es dans un syst√®me ERP. On pense que personne d'autre ne nous traite dans SAP ERP et SAP BW en Russie. Mais il...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Highload ++: Comment aider le syst√®me ERP √† faire face √† 500 000 requ√™tes par seconde</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/X5RetailGroup/blog/432412/">  Chez X5, nous traitons beaucoup de donn√©es dans un syst√®me ERP.  On pense que personne d'autre ne nous traite dans SAP ERP et SAP BW en Russie.  Mais il y a un autre point - le nombre d'op√©rations et la charge sur ce syst√®me augmentent rapidement.  Pendant 3 ans, nous nous sommes ¬´battus¬ª pour les performances de notre poids lourd ERP, nous avons obtenu beaucoup de c√¥nes, et avec quelles m√©thodes ils ont √©t√© trait√©s, nous disons sous la coupe. <br><br><img src="https://habrastorage.org/webt/5h/bu/5x/5hbu5xxbs9yb6vojgiy-2wl06hk.png" alt="image"><br><a name="habracut"></a><br><h2>  ERP X5 </h2><br>  D√©sormais, X5 exploite plus de 13 000 magasins.  La plupart des processus commerciaux de chacun d'entre eux passent par un seul syst√®me ERP.  Chaque magasin peut avoir de 3 000 √† 30 000 produits, ce qui cr√©e des probl√®mes de charge sur le syst√®me, car  des processus de recalcul r√©gulier des prix le traversent conform√©ment aux promotions et aux exigences l√©gislatives et au calcul de reconstitution des stocks.  Tout cela est critique, et s'il n'est pas calcul√© √† temps quelles marchandises en quelle quantit√© devraient √™tre livr√©es au magasin demain ou quel prix devrait √™tre sur les marchandises, les acheteurs ne trouveront pas ce qu'ils recherchaient sur les √©tag√®res ou ne pourront pas acheter les marchandises au prix de la promotion en cours stocks.  En g√©n√©ral, en plus de comptabiliser les transactions financi√®res, le syst√®me ERP est responsable de beaucoup dans la vie quotidienne de chaque magasin. <br><br>  Un peu des caract√©ristiques de performance d'un syst√®me ERP.  Son architecture est classique, √† trois niveaux avec des √©l√©ments orient√©s services: en plus, nous avons plus de 5000 clients √©pais et des t√©raoctets de flux d'informations provenant des magasins et des centres de distribution, dans la couche application - SAP ABAP avec plus de 10000 processus et, enfin, Oracle Database avec plus de 100 To de donn√©es.  Chaque processus ABAP est une machine virtuelle conditionnelle qui ex√©cute la logique m√©tier ABAP avec son propre dialecte DBSL et SQL, la mise en cache, la gestion de la m√©moire, l'ORM, etc.  Chaque jour, nous obtenons plus de 15 To de modifications dans le journal de la base de donn√©es.  Le niveau de charge est de 500 000 requ√™tes par seconde. <br><br>  Cette architecture est un environnement h√©t√©rog√®ne.  Chacun des composants est multiplateforme, nous pouvons le d√©placer sur diff√©rentes plates-formes, choisir les optimales, etc. <br><br>  Le fait que le syst√®me ERP soit sous charge 24 heures sur 24, 365 jours par an, ajoute du carburant √† l'incendie.  Disponibilit√© - 99,9% du temps tout au long de l'ann√©e.  La charge est divis√©e en profils jour et nuit et entretien m√©nager en temps libre. <br><br>  Mais ce n'est pas tout.  Le syst√®me a un cycle de lib√©ration serr√© et serr√©.  Il r√©alise plus de 2 000 changements de lots par an.  Cela peut √™tre un nouveau bouton, et de s√©rieux changements dans la logique des applications m√©tier. <br><br><img src="https://habrastorage.org/webt/xa/g3/xi/xag3xio65zfdslyhgosbjrmtakw.png" alt="image"><br><br>  En cons√©quence, il s'agit d'un syst√®me volumineux et tr√®s charg√©, mais en m√™me temps stable, pr√©visible et pr√™t pour la croissance qui peut h√©berger des dizaines de milliers de magasins.  Mais cela n'a pas toujours √©t√© le cas. <br><br><h2>  2014. Point de bifurcation </h2><br>  Pour plonger dans le mat√©riel pratique, vous devez remonter √† 2014.  Ensuite, il y a eu les t√¢ches les plus difficiles pour optimiser le syst√®me.  Il y avait environ 5 000 magasins. <br><br>  √Ä cette √©poque, le syst√®me √©tait dans un √©tat tel que la plupart des processus critiques n'√©taient pas √©volutifs et ne r√©pondaient pas ad√©quatement √† la charge croissante (c'est-√†-dire l'apparition de nouveaux magasins et marchandises).  De plus, deux ans plus t√¥t, un Hi-End cher a √©t√© achet√©, et pendant un certain temps, une mise √† niveau ne faisait pas partie de nos plans.  De plus, les processus de l'ERP √©taient d√©j√† sur le point de violer le SLA.  Le vendeur a conclu que la charge sur le syst√®me n'est pas √©volutive.  Personne ne savait si elle pouvait supporter au moins + 10% de l'augmentation de charge.  Et il √©tait pr√©vu d'ouvrir deux fois plus de magasins en trois ans. <br><br>  Il √©tait impossible d'alimenter simplement le syst√®me ERP avec du fer neuf, et cela n'aiderait pas.  Par cons√©quent, tout d'abord, nous avons d√©cid√© d'inclure une technique d'optimisation logicielle dans le cycle de publication et de suivre la r√®gle: une croissance de charge lin√©aire proportionnelle √† la croissance des inducteurs de charge est la cl√© de la pr√©visibilit√© et de l'√©volutivit√©. <br><br>  Quelle √©tait la technique d'optimisation?  Il s'agit d'un processus cyclique, divis√© en plusieurs √©tapes: <br><br><ul><li>  surveillance (identifier les goulots d'√©tranglement dans le syst√®me et identifier les principaux consommateurs de ressources) </li><li>  analyse (profilage des processus consommateurs, identification des structures avec le plus grand effet non lin√©aire sur la charge) </li><li>  d√©veloppement (r√©duction de l'influence des structures sur la charge, r√©alisation de la charge lin√©aire) </li><li>  tests dans un environnement d'√©valuation de la qualit√© ou mise en ≈ìuvre dans un environnement productif </li></ul><br>  Ensuite, le cycle a √©t√© r√©p√©t√©. <br><br>  Dans le processus, nous avons r√©alis√© que les outils de surveillance actuels ne nous permettent pas d'identifier rapidement les meilleurs consommateurs, d'identifier les goulots d'√©tranglement et les processus gourmands en ressources.  Par cons√©quent, pour acc√©l√©rer, nous avons essay√© les outils de recherche √©lastique et Grafana.  Pour ce faire, ils ont d√©velopp√© ind√©pendamment des collecteurs qui, √† partir d'outils de surveillance standard dans Oracle / SAP / AIX / Linux, ont transf√©r√© les m√©triques vers la recherche √©lastique et ont permis une surveillance en temps r√©el de l'int√©grit√© du syst√®me.  En outre, ils ont enrichi la surveillance avec leurs mesures personnalis√©es, par exemple, le temps de r√©ponse et le d√©bit de composants SAP sp√©cifiques ou la pr√©sentation de profils de charge pour les processus m√©tier. <br><img src="https://habrastorage.org/webt/m2/k3/dz/m2k3dzdu-nz384_pz4phtnlvkc0.png" alt="image"><br><br><h2>  Optimisation du code et des processus </h2><br>  Tout d'abord, pour un effet moindre des goulots d'√©tranglement sur la vitesse, ils ont assur√© une alimentation plus fluide de la charge du syst√®me. <br><br>  La plupart des processus commerciaux de notre syst√®me ERP, par exemple, comme la tarification r√©guli√®re ou la planification du r√©approvisionnement des stocks, sont un traitement s√©quentiel √©tape par √©tape d'une grande quantit√© de donn√©es (pour toutes les marchandises et tous les magasins).  Pour mettre en ≈ìuvre le traitement dans le cadre de t√¢ches aussi difficiles, nous avons √† un moment donn√© d√©velopp√© notre propre gestionnaire de traitement parall√®le par lots (ci-apr√®s appel√© le planificateur de charge).  Dans ce cas, sous la forme d'un package, une √©tape de traitement effectu√©e s√©par√©ment pour un magasin s√©par√© est pr√©sent√©e. <br><br>  Initialement, la logique de l'ordonnanceur √©tait telle que d'abord les packages de la premi√®re √©tape de traitement √©taient ex√©cut√©s pour tous les magasins, puis les packages de la deuxi√®me √©tape, etc.  Autrement dit, le syst√®me ex√©cutait simultan√©ment des processus qui cr√©aient le m√™me type de charge et provoquaient la d√©gradation de certaines ressources (entr√©es / sorties vers la base de donn√©es ou le processeur sur les serveurs d'applications, etc.). <br><img src="https://habrastorage.org/webt/kj/_r/sf/kj_rsf_nxsu309iuygujkxzavty.png" alt="image"><br><br>  Nous avons r√©√©crit la logique du planificateur afin que la cha√Æne de packages soit form√©e s√©par√©ment pour chaque magasin et que la priorit√© de lancement de nouveaux packages soit √©tablie non pas par √©tapes, mais par magasins. <br><img src="https://habrastorage.org/webt/rc/_3/kw/rc_3kwnwqdi_hemnvuxnpmps_q0.png" alt="image"><br><br>  En raison de la dur√©e diff√©rente des packages pour les diff√©rents magasins et du grand nombre contr√¥l√© de processus ex√©cut√©s simultan√©ment dans le cadre des t√¢ches de l'ordonnanceur de charge, nous avons r√©alis√© l'ex√©cution simultan√©e de processus h√©t√©rog√®nes, un chargement plus fluide de la charge et l'√©limination de certains goulots d'√©tranglement. <br><br>  Ensuite, ils ont commenc√© √† optimiser les conceptions individuelles.  Chaque paquet individuel a √©t√© examin√©, profil√© et assembl√© des conceptions non optimales et des approches appliqu√©es pour les optimiser.  Par la suite, ces approches ont √©t√© incluses dans la r√©glementation du d√©veloppeur afin d'emp√™cher une croissance ind√©sirable de la charge pendant le d√©veloppement du syst√®me.  Certains d'entre eux: <br><br><ul><li>  charge excessive sur le CPU des serveurs d'applications (Souvent g√©n√©r√©e par des algorithmes non lin√©aires dans le code du programme, par exemple, la bonne vieille recherche lin√©aire en boucles ou des algorithmes de recherche non lin√©aires pour les intersections d'ensembles d'√©l√©ments d√©sordonn√©s, etc. ... Elle a √©t√© trait√©e en rempla√ßant par des algorithmes lin√©aires: remplacer la recherche lin√©aire en boucles par des binaires; pour rechercher des intersections d'ensembles, nous utilisons des algorithmes lin√©aires, des √©l√©ments de pr√©commande, etc.) </li><li>  des appels identiques √† la base de donn√©es avec les m√™mes conditions dans le m√™me processus conduisent souvent √† une utilisation excessive du processeur de la base de donn√©es (elle est trait√©e en mettant en cache les r√©sultats du premier √©chantillon dans la m√©moire du programme ou au niveau du serveur d'applications et en utilisant des donn√©es mises en cache pour les √©chantillons suivants) </li><li>  demandes de jointure fr√©quentes (il est pr√©f√©rable de les ex√©cuter, bien s√ªr, au niveau de la base de donn√©es, mais parfois nous nous sommes permis de les diviser en √©chantillons simples, dont le r√©sultat est mis en cache, et de transf√©rer la logique de collage √† l'application. Ce sont des cas o√π il vaut mieux chauffer le serveur d'applications, et non la base de donn√©es. ) </li><li>  demandes de jointure importantes entra√Ænant un grand nombre d'E / S </li></ul><br>  √Ä propos de ce dernier plus en d√©tail.  Dans ce cas, le mod√®le de donn√©es a √©t√© traduit sous une forme moins normale.  Un exemple classique est une s√©lection de documents comptables pour une date sp√©cifique pour un magasin individuel.  De nombreux employ√©s le demandent.  La table principale (table d'en-t√™te) stocke les dates des documents, dans la table des positions - le magasin et les marchandises.  Les requ√™tes les plus courantes sont une s√©lection de tous les documents d'un magasin particulier pour une date sp√©cifique.  Avec cette demande, le filtre par date sur la table des en-t√™tes donne 500 000 enregistrements, le filtre par magasin - le m√™me montant.  Dans le m√™me temps, apr√®s avoir coll√© sur un magasin s√©par√© pour la bonne date, nous avons un terme de 3 mille.  Peu importe la table √† partir de laquelle nous commen√ßons √† filtrer et √† coller les donn√©es, nous obtenons toujours beaucoup d'E / S ind√©sirables. <br><img src="https://habrastorage.org/webt/rw/dp/kr/rwdpkruti_tjhpazqtcoonzpeq0.png" alt="image"><br><br>  Cela peut √™tre √©vit√© en pr√©sentant les donn√©es sous une forme moins normale.  Dans un cas, le champ de date a √©t√© dupliqu√© dans la table de position, il a √©t√© rempli lors de la cr√©ation de documents, les index ont √©t√© collect√©s pour une recherche rapide et ils √©taient d√©j√† filtr√©s selon la table de position.  Ainsi, apr√®s avoir sacrifi√© des frais g√©n√©raux insignifiants pour stocker un nouveau champ et des index, nous avons r√©duit √† plusieurs reprises le nombre d'op√©rations d'entr√©e / sortie g√©n√©r√©es par des requ√™tes probl√©matiques. <br><br><img src="https://habrastorage.org/webt/62/oh/gb/62ohgb45gxmmt9plaeuzdgckhds.png" alt="image"><br><br><h2>  2015. Le probl√®me d'un service </h2><br>  Depuis un an et demi, nous avons fait un excellent travail d'optimisation du syst√®me, il est devenu plus pr√©visible.  N√©anmoins, les plans visant √† doubler le nombre de magasins sont rest√©s pertinents, de sorte que les d√©fis auxquels nous √©tions confront√©s √©taient toujours d'actualit√©. <br><br>  En montant, nous avons rencontr√© divers goulets d'√©tranglement.  Par exemple, fin 2015, ils ont r√©alis√© qu'ils s'√©taient repos√©s sur les performances d'un core-service de la plateforme.  Il s'agit d'un service de verrouillage logique SAP ABAP.  √Ä cause de cela, le syst√®me ne r√©sisterait clairement pas √† la croissance de la charge.  Des pertes de grosses sommes d'argent se profilaient √† l'horizon. <br><br>  Pour clarifier, la t√¢che du service est d'apporter la transactionnalit√© logique au niveau du serveur d'applications.  Dans ABAP, une seule transaction peut passer par plusieurs √©tapes sur diff√©rents workflows.  Pour que la transaction soit compl√®te, il existe un service de verrouillage et des m√©canismes associ√©s.  Les op√©rations de verrouillage et de d√©verrouillage s'y produisent rapidement, mais elles sont atomiques, elles ne peuvent pas √™tre s√©par√©es.  Il y avait un probl√®me avec les E / S synchrones. <br><br>  Le service s'est acc√©l√©r√© un peu apr√®s que les d√©veloppeurs SAP aient publi√© un correctif sp√©cial, nous avons bascul√© le service sur un autre mat√©riel et travaill√© sur les param√®tres du syst√®me, mais ce n'√©tait toujours pas suffisant.  Le plafond du service des passeports √©tait d'environ 7 000 op√©rations par seconde, et pendant longtemps nous en avions d√©j√† besoin de 10 000. <br><br>  Apr√®s le test de charge synth√©tique, il a √©t√© constat√© que la d√©gradation n'est pas lin√©aire et nous sommes n√©anmoins √† la limite de performance de service au-dessus de laquelle se manifeste la d√©gradation inacceptable de l'ensemble du syst√®me ERP.  Des appels r√©p√©t√©s aux d√©veloppeurs n'ont donn√© qu'un verdict d√©cevant - le service fonctionne correctement, nous en demandons simplement trop dans l'architecture actuelle de la solution.  M√™me si nous nous engageions imm√©diatement √† refaire toute l'architecture de la solution, il nous faudrait plusieurs mois pour maintenir l'op√©rabilit√© du syst√®me actuel. <br><br>  L'une des premi√®res options pour essayer de prolonger la dur√©e de vie d'un service de verrouillage consiste √† acc√©l√©rer les E / S et l'√©criture dans le syst√®me de fichiers.  Quoi?  Exp√©riences avec une alternative √† AIX.  Transf√©r√© le service √† Linux sur la Power-machine la plus puissante, et gagn√© beaucoup de temps de r√©ponse.  Le service avec le syst√®me de fichiers activ√© s'est comport√© de la m√™me mani√®re que sur Aix avec les personnes handicap√©es.  Ensuite, nous avons transf√©r√© ce code sur l'une des lames x86_64 et obtenu une courbe de performance en pente encore plus fantastique que pr√©c√©demment.  √áa avait l'air dr√¥le. <br><br>  On peut supposer que les d√©veloppeurs sur AIX et Linux ont fait quelque chose de diff√©rent lors du dernier test, mais l'architecture du processeur a √©galement eu un effet ici. <br><img src="https://habrastorage.org/webt/73/1v/pl/731vplzz4ndclyo0l7tga0mlhv8.png" alt="image"><br><br>  Quelle a √©t√© la conclusion?  Certaines plates-formes conviennent parfaitement aux bases de donn√©es multithread, offrant √† la fois des performances et une tol√©rance aux pannes, mais un processeur sur une architecture diff√©rente peut mieux faire face √† des t√¢ches sp√©cifiques.  Si au d√©but de la construction d'une solution pour abandonner la multiplateforme, vous pouvez perdre de l'espace pour des man≈ìuvres √† l'avenir. <br><br>  N√©anmoins, nous avons compris ce probl√®me et le service a commenc√© √† fonctionner 3 √† 4 fois plus rapidement, ce qui est suffisant pour une tr√®s longue croissance. <br><br><h2>  2016. DB CPU Bottleneck </h2><br>  Litt√©ralement six mois plus tard, des probl√®mes exotiques ont commenc√© √† se faire sentir avec le processeur de la base de donn√©es.  Il semble clair qu'avec une augmentation de la charge, la consommation de ressources processeur augmente.  Mais SysTime a commenc√© √† en prendre la majeure partie, et il y avait clairement un probl√®me dans le noyau.  Ils ont commenc√© √† comprendre, √† faire des tests de charge synth√©tique et ont r√©alis√© que notre d√©bit √©tait de 300000 op√©rations par seconde, c'est-√†-dire  milliards de requ√™tes par heure, puis d√©gradation. <br><br>  En cons√©quence, nous sommes arriv√©s √† la conclusion que la demande parfaite est celle qui n'existe pas.  Nous avons √©largi notre technique d'optimisation avec de nouvelles approches et men√© un audit du syst√®me ERP: nous avons commenc√© √† rechercher des requ√™tes, par exemple, avec une faible efficacit√© (100000 s√©lections - √† la suite de 100 lignes ou 0 en g√©n√©ral) - √† refaire.  Si les demandes "vides" ne peuvent pas √™tre supprim√©es, alors laissez-les aller au "cache n√©gatif", le cas √©ch√©ant.  Si de nombreuses demandes pour les m√™mes donn√©es de produit sont trait√©es en parall√®le, laissez-les tourmenter le serveur d'applications et non la base de donn√©es, nous le mettons en cache.  Nous ¬´agrandissons¬ª √©galement un grand nombre de requ√™tes uniques fr√©quentes sur une cl√© dans le cadre d'un processus, en la rempla√ßant par des s√©lections plus rares sur une partie d'une cl√©.  Ou, par exemple, pour r√©partir la charge dans la cha√Æne de traitement, diff√©rentes √©tapes peuvent √™tre effectu√©es sur diff√©rents serveurs d'applications.  C'est bien, mais √† diff√©rentes √©tapes, ils peuvent demander la m√™me chose √† la base.  Ensuite, laissez la premi√®re √©tape apr√®s avoir d√©marr√© sur le cache d'application une partie des demandes, et il reste l√† pour terminer le reste de la cha√Æne. <br><img src="https://habrastorage.org/webt/ww/cx/uz/wwcxuzeyehn_idgaokwh2psy984.png" alt="image"><br><br>  Avec l'aide de telles astuces, nous avons gagn√© un peu partout, mais au final nous avons s√©rieusement d√©charg√© la base.  Le syst√®me a pris vie.  Pendant ce temps, nous sommes descendus √† Aix. <br><br>  D'autres exp√©riences ont r√©v√©l√© un plafond de performances - les 300 000 appels DataBase par seconde d√©j√† mentionn√©s.  La racine du probl√®me √©tait la performance de l'interface r√©seau, qui avait un plafond - environ 300 000 paquets par seconde dans une direction.  √Ä mesure que le plafond se rapprochait, le temps des appels syst√®me augmentait.  Comme il s'est av√©r√© plus tard, il s'agissait √©galement d'un h√©ritage de la pile r√©seau du noyau AIX. <br><br>  En g√©n√©ral, nous n'avons jamais eu de probl√®mes de latence, le c≈ìur du r√©seau √©tait productif, tous les cordons √©taient assembl√©s en un grand canal indestructible sur une seule interface.  Nous avons fait un contournement: nous avons divis√© l'ensemble du r√©seau entre les serveurs d'applications et la base de donn√©es en groupes sur diff√©rentes interfaces.  En cons√©quence, chaque groupe de serveurs d'applications a communiqu√© avec la base de donn√©es via sa propre interface distincte.  Les performances maximales de chaque interface ont √©t√© l√©g√®rement r√©duites, mais au total, nous avons overclock√© le r√©seau √† 1 million de paquets par seconde dans une direction. <br><br>  Et le principe "La meilleure requ√™te est celle qui n'existe pas" a √©t√© ajout√© au Talmud pour les d√©veloppeurs, afin que cela soit pris en compte lors de l'√©criture du code. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/u-/lo/qh/u-loqhu4_avqxvne0eam6lmittq.png" alt="image"></div><br><h2>  2017. Live to upgrade </h2><br>  Eh bien, la derni√®re √©tape de la r√©cup√©ration de notre syst√®me, pass√©e en 2017.  Il ne restait plus qu'√† vivre un peu jusqu'√† la mise √† niveau et il fallait tenir le SLA pour rien.  Le code a √©t√© optimis√©, mais nous avons vu que plus la charge sur le processeur de la base de donn√©es √©tait √©lev√©e, plus les processus fonctionnaient lentement, bien que la marge d'utilisation soit de 10 √† 20%.  Initialement, on estimait que 100% est deux fois plus que 50%.  Et quand il y a une r√©serve de 10-20%, c'est 10-20%.  En fait, √† une charge sup√©rieure √† 67-80%, la dur√©e des t√¢ches a augment√© de fa√ßon non lin√©aire, c'est-√†-dire  La loi d'Amdahl a fonctionn√©.  Le syst√®me avait une limite de parall√©lisation et lorsqu'il a √©t√© d√©pass√©, avec la participation d'un nombre croissant de processeurs dans le travail, les performances de chaque processeur individuel ont diminu√©. <br><br>  √Ä cette √©poque, nous utilisions 125 processeurs physiques, ou 500 processeurs logiques, compte tenu du multithreading au niveau AIX.  Que sugg√©reriez-vous?  Surclassement?  M√™me avant la fin de sa coordination, il a fallu attendre plusieurs mois et ne pas abandonner le SLA. <br><br>  √Ä un moment donn√©, ils ont r√©alis√© que les mesures traditionnelles d'utilisation des processeurs ne sont pas indicatives pour nous - elles ne montrent pas le d√©but r√©el de la d√©gradation.  Pour une √©valuation r√©aliste de la sant√© du syst√®me, nous avons commenc√© √† utiliser la m√©trique int√©gr√©e - le r√©sultat d'un test synth√©tique comme m√©trique pour les performances du processeur de base de donn√©es.  Une fois par minute, ils ont fait un test synth√©tique, mesur√© sa dur√©e et affich√© cette m√©trique sur nos moniteurs.  Et ils ont r√©agi si la m√©trique d√©passait le point critique d√©clar√©.  Nous avons un peu tenu la charge de nos planificateurs de charge afin qu'elle reste dans la zone ¬´couple maximal¬ª de la base de donn√©es. <br><img src="https://habrastorage.org/webt/fg/o0/0u/fgo00uye8ms6yklbxscplqcly7s.png" alt="image"><br><br>  Cependant, le contr√¥le manuel √©tait inefficace et nous √©tions fatigu√©s de nous r√©veiller la nuit.  Ensuite, nous avons r√©√©crit le planificateur de charge afin qu'il re√ßoive des commentaires sur les mesures de performances actuelles.  Si les mesures d√©passaient le seuil jaune (voir l'image), la planification des packages de faible priorit√© √©tait gel√©e et seuls les processus critiques de l'entreprise √©taient prioritaires.  Ainsi, nous avons pu contr√¥ler automatiquement l'intensit√© de la charge et les ressources ont √©t√© utilis√©es efficacement.  Et la chose la plus int√©ressante est que, en maintenant le syst√®me √† 80% de la charge, dans cette m√™me zone de couple maximal, nous avons finalement obtenu une r√©duction du temps total pour l'ex√©cution des processus m√©tier, car  chaque fil a commenc√© √† fonctionner beaucoup plus rapidement. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/gi/54/7w/gi547wixu3bnefxdvvy6wl-golc.png" alt="image"></div><br><h2>  Quelques conseils pour ceux qui travaillent avec un ERP tr√®s charg√© </h2><br><ul><li>  Il est tr√®s important de surveiller les performances des syst√®mes au d√©but d'un projet, en particulier avec leurs propres m√©triques. </li><li>  Assurer une augmentation lin√©aire de la charge proportionnelle √† l'augmentation du nombre de conducteurs de charge (dans notre cas, il s'agissait de marchandises et de magasins). </li><li>  √âliminez les constructions non lin√©aires dans le code, utilisez la mise en cache pour √©liminer les requ√™tes de base de donn√©es identiques. </li><li>  Si vous devez transf√©rer la charge de l'UC de la base de donn√©es vers l'UC du serveur d'applications, vous pouvez recourir √† la division des demandes de jointure en √©chantillons simples. </li><li>  Pour toutes les optimisations, n'oubliez pas qu'une demande rapide est bonne et qu'une demande rapide et fr√©quente est parfois mauvaise. </li><li>         . </li><li>        ,    ;       ‚Äú  ‚Äù  . </li><li>                       </li></ul><br> <i>  Highload         ,         . <br></i> <br> <i> ,  ,   SAP  #ITX5</i> <br><br> , #ITX5 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>  SAP. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr432412/">https://habr.com/ru/post/fr432412/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr432400/index.html">CS: GO est maintenant gratuit</a></li>
<li><a href="../fr432402/index.html">H√© HR, o√π est mon souvenir?</a></li>
<li><a href="../fr432404/index.html">La sauvegarde pour Linux n'√©crit pas de lettres</a></li>
<li><a href="../fr432408/index.html">Fintech digest: pr√©paration pour d√©connecter les petites banques de Visa et Mastercard, un calculateur de pension et pas seulement</a></li>
<li><a href="../fr432410/index.html">Entit√©s de style DDD avec Entity Framework Core</a></li>
<li><a href="../fr432414/index.html">De vieux secrets au d√©bogage rapide: animation du code source</a></li>
<li><a href="../fr432416/index.html">Types d√©pendants - L'avenir des langages de programmation</a></li>
<li><a href="../fr432418/index.html">Analyser des expressions lambda en Java</a></li>
<li><a href="../fr432420/index.html">Introduction √† Git Merge et Git Rebase: pourquoi et quand les utiliser</a></li>
<li><a href="../fr432422/index.html">Mode hors ligne sur iOS et caract√©ristiques de son impl√©mentation sur Realm</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>