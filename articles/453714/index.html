<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèª‚Äçüè´ üéµ ‚è¨ Cliente de prueba TON (Telegram Open Network) y el nuevo lenguaje Fift para contratos inteligentes üí™üèº üßñüèº üìâ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hace m√°s de un a√±o, se supo de los planes del Telegram Messenger para lanzar su propia red descentralizada Telegram Open Network . Luego se hizo dispo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Cliente de prueba TON (Telegram Open Network) y el nuevo lenguaje Fift para contratos inteligentes</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/453714/"><p>  Hace m√°s de un a√±o, se supo de los planes del Telegram Messenger para lanzar su propia red descentralizada <strong>Telegram Open Network</strong> .  Luego se hizo disponible un voluminoso documento t√©cnico que, presumiblemente, fue escrito por Nikolai Durov y describ√≠a la estructura de la red futura.  Para aquellos que se perdieron, le recomiendo que lea mi recuento de este documento ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">parte 1</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">parte 2</a> ; la tercera parte, por desgracia, todav√≠a est√° acumulando polvo en los borradores). </p><br><p> Desde entonces, no hubo noticias significativas sobre el estado de desarrollo de TON, hasta hace un par de d√≠as (en uno de los <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">canales no oficiales</a> ) apareci√≥ un enlace en la p√°gina <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://test.ton.org/download.html</a> , donde se encuentran: </p><br><p>  ‚ó¶ <a href="">ton-test-liteclient-full.tar.xz</a> : c√≥digo fuente de cliente ligero para la red de prueba TON; <br>  ‚ó¶ <a href="">ton-lite-client-test1.config.json</a> : archivo de configuraci√≥n para conectarse a una red de prueba; <br>  ‚ó¶ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">README</a> : informaci√≥n sobre la creaci√≥n y el inicio del cliente; <br>  ‚ó¶ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">C√ìMO</a> : instrucciones paso a paso sobre c√≥mo crear un contrato inteligente con un cliente; <br>  ‚ó¶ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ton.pdf</a> : documento actualizado (fechado el 2 de marzo de 2019) con una descripci√≥n t√©cnica de la red TON; <br>  ‚ó¶ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">tvm.pdf</a> : descripci√≥n t√©cnica de TVM (m√°quina virtual TON, m√°quina virtual TON); <br>  ‚ó¶ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">tblkch.pdf</a> : descripci√≥n t√©cnica de la cadena de bloques TON; <br>  ‚ó¶ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">fiftbase.pdf</a> : una descripci√≥n del nuevo lenguaje Fift, dise√±ado para crear contratos inteligentes en TON. </p><br><p>  Repito, el Telegram no confirm√≥ oficialmente la p√°gina y todos estos documentos, pero el volumen de estos materiales los hace bastante veros√≠miles.  Ejecute un cliente publicado <strong>bajo su propio riesgo</strong> . </p><a name="habracut"></a><br><h2 id="sborka-testovogo-klienta">  Prueba de compilaci√≥n del cliente </h2><br><p>  Primero, intentemos construir y ejecutar un cliente de prueba; afortunadamente, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">README</a> describe este sencillo proceso en detalle.  Har√© esto en el ejemplo de macOS 10.14.5, no puedo garantizar el √©xito del ensamblaje en otros sistemas. </p><br><ol><li><p>  Descargue y descomprima el <a href="">archivo con los c√≥digos fuente</a> .  Es importante descargar la √∫ltima versi√≥n, ya que la compatibilidad con versiones anteriores no est√° garantizada en esta etapa. </p><br></li><li><p>  Nos aseguramos de que las √∫ltimas versiones de make, cmake (versi√≥n 3.0.2 o superior), OpenSSL (incluidos los archivos de encabezado C), g ++ o clang est√©n instaladas en el sistema.  No tuve que reinstalar nada, todo se reuni√≥ de inmediato. </p><br></li><li><p> Supongamos que las fuentes se descomprimen en la carpeta <code>~/lite-client</code> .  Por separado, creamos una carpeta vac√≠a para el proyecto ensamblado (por ejemplo, <code>~/liteclient-build</code> ), y desde √©l ( <code>cd ~/liteclient-build</code> ) <code>cd ~/liteclient-build</code> comandos: </p><br><pre> <code class="bash hljs">cmake ~/lite-client cmake --build . --target <span class="hljs-built_in"><span class="hljs-built_in">test</span></span>-lite-client</code> </pre> <br><p><img src="https://habrastorage.org/webt/sr/lx/j8/srlxj8au48yus3uuddlpenvika0.png" alt="Construcci√≥n exitosa del cliente"><br><br>  Para construir el int√©rprete de lenguaje Fift para contratos inteligentes (ver m√°s abajo), tambi√©n llamamos </p><br><pre> <code class="plaintext hljs">cmake --build . --target fift</code> </pre> <br></li><li><p>  Descargue el <a href="">archivo de configuraci√≥n</a> actual para conectarse a la red de prueba y p√≥ngalo en la carpeta con el cliente ensamblado. </p><br></li><li><p>  <strong>Hecho</strong> , puede iniciar el cliente: </p><br><pre> <code class="plaintext hljs">./test-lite-client -C ton-lite-client-test1.config.json</code> </pre> <br></li></ol><br><p>  Si todo se hace correctamente, entonces deber√≠a ver algo como esto: </p><br><p><img src="https://habrastorage.org/webt/gl/gg/d3/glggd35dzg4vwogf9woibu43zrk.png" alt="Lanzamiento del cliente"></p><br><p>  Como puede ver, hay pocos comandos disponibles: </p><br><p>  ‚ó¶ <strong><code>help</code></strong> : muestra esta lista de comandos; <br>  ‚ó¶ <strong><code>quit</code></strong> - salir; <br>  ‚ó¶ <strong><code>time</code></strong> : muestra la hora actual en el servidor; <br>  ‚ó¶ <strong><code>status</code></strong> : muestra el estado de la conexi√≥n y la base de datos local; <br>  ‚ó¶ <strong><code>last</code></strong> : actualiza el estado de la cadena de bloques (carga el √∫ltimo bloque).  Es importante ejecutar este comando antes de cualquier solicitud para asegurarse de que ve exactamente el estado actual de la red. <br>  ‚ó¶ <strong><code>sendfile</code></strong> <code>&lt;filename&gt;</code> : sube un archivo local a la red TON.  Esta es la interacci√≥n con la red, que incluye, por ejemplo, la creaci√≥n de nuevos contratos inteligentes y solicitudes de transferencia de fondos entre cuentas; <br>  ‚ó¶ <strong><code>getaccount</code></strong> <code>&lt;address&gt;</code> : muestra el estado actual (en el momento en que se ejecut√≥ el <strong><code>last</code></strong> comando) con la direcci√≥n especificada; <br>  ‚ó¶ <strong><code>privkey</code></strong> <code>&lt;filename&gt;</code> : carga la clave privada desde el archivo local. </p><br><p>  Si en el inicio del cliente, le pasa la carpeta usando la opci√≥n <code>-D</code> , entonces agregar√° el √∫ltimo bloque de la cadena maestra: </p><br><pre> <code class="bash hljs">./<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>-lite-client -C ton-lite-client-test1.config.json -D ~/ton-db-dir</code> </pre> <br><p>  Ahora podemos pasar a cosas m√°s interesantes: aprender el lenguaje Fift, intentar compilar un contrato inteligente (por ejemplo, crear una billetera de prueba), subirlo a la red e intentar transferir fondos entre cuentas. </p><br><h2 id="yazyk-fift">  Lenguaje quincuag√©simo </h2><br><p>  A partir del documento <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">fiftbase.pdf,</a> puede descubrir que para crear contratos inteligentes, el equipo de Telegram cre√≥ un nuevo lenguaje de pila <strong>Fift</strong> (aparentemente, a partir del n√∫mero <em>quinto</em> , por analog√≠a con Forth, un lenguaje con el que Fift tiene mucho en com√∫n). </p><br><p>  El documento es bastante voluminoso, con 87 p√°ginas, y no volver√© a contar su contenido en detalle en el marco de este art√≠culo (al menos porque yo mismo no termin√© de leerlo :).  Me detendr√© en los puntos principales y dar√© un par de ejemplos de c√≥digo en este idioma. </p><br><p>  En un nivel b√°sico, la sintaxis de Fift es bastante simple: su c√≥digo consiste en <em>palabras</em> , generalmente separadas por espacios o saltos de l√≠nea (caso especial: algunas palabras no requieren un delimitador despu√©s de ellas mismas).  Cualquier <em>palabra</em> es una secuencia de caracteres que distingue entre may√∫sculas y min√∫sculas que corresponde a alguna <em>definici√≥n</em> (en t√©rminos generales, lo que el int√©rprete debe hacer cuando encuentra esta palabra).  Si no hay una definici√≥n de la palabra, el int√©rprete intenta analizarla como un n√∫mero y colocarla en la pila.  Por cierto, los n√∫meros aqu√≠ son, de repente, enteros de 257 bits, pero no hay n√∫meros fraccionarios en absoluto, m√°s precisamente, se convierten inmediatamente en un par de enteros, formando el numerador y el denominador de una fracci√≥n racional. </p><br><p>  Las palabras generalmente interact√∫an con significados en la parte superior de la pila.  Un tipo separado de palabras, <em>prefijo</em> , no usa la pila, sino los caracteres posteriores del archivo fuente.  Por ejemplo, los literales de cadena se implementan de esta manera: el car√°cter ‚Äúcomillas‚Äù ( <code>"</code> ) es una palabra de prefijo que busca la siguiente comilla (de cierre) y coloca la cadena entre ellos en la pila. La l√≠nea simple ( <code>//</code> ) y la l√≠nea m√∫ltiple ( <code>/*</code> ) se comportan de la misma manera. comentarios </p><br><p>  En esto, casi toda la estructura interna del lenguaje termina.  Todo lo dem√°s (incluidas las estructuras de control) se define como palabras (ya sea internas, como operaciones aritm√©ticas y la definici√≥n de nuevas palabras; o se define en la "biblioteca est√°ndar" <code>Fift.fif</code> , que se encuentra en la <code>crypto/fift</code> en la fuente). </p><br><p>  Un ejemplo simple de un programa Fift: </p><br><pre> <code class="plaintext hljs">{ dup =: x dup * =: y } : setxy 3 setxy x . y . xy + . 7 setxy x . y . xy + .</code> </pre> <br><p>  La primera l√≠nea define la nueva palabra <code>setxy</code> (tenga en cuenta el prefijo <code>{</code> , que crea el bloque antes del cierre <code>}</code> y el prefijo <code>:</code> que en realidad define la palabra).  <code>setxy</code> toma un n√∫mero de la parte superior de la pila, lo define (o lo redefine) como una <em>constante</em> global <code>x</code> , y el cuadrado de este n√∫mero como una constante <code>y</code> (dado que los valores de las constantes se pueden redefinir, prefiero llamarlos variables, pero sigo los nombres en el lenguaje). </p><br><p>  En las siguientes dos l√≠neas, se coloca un n√∫mero en la pila, se <code>setxy</code> , <code>setxy</code> se <code>setxy</code> los valores de las constantes <code>x</code> , <code>y</code> (la palabra se usa para la salida) <code>.</code> Ambas constantes se colocan en la pila, se suman y tambi√©n se muestra el resultado.  Como resultado, veremos: </p><br><pre> <code class="plaintext hljs">3 9 12 ok 7 49 56 ok</code> </pre> <br><p>  (El int√©rprete imprime la l√≠nea "ok" cuando termina de procesar la l√≠nea actual en modo de entrada interactiva) </p><br><p>  Bueno, un ejemplo de c√≥digo completo: </p><br><pre> <code class="plaintext hljs">"Asm.fif" include -1 constant wc // create a wallet in workchain -1 (masterchain) // Create new simple wallet &lt;{ SETCP0 DUP IFNOTRET INC 32 THROWIF // return if recv_internal, fail unless recv_external 512 INT LDSLICEX DUP 32 PLDU // sign cs cnt c4 PUSHCTR CTOS 32 LDU 256 LDU ENDS // sign cs cnt cnt' pubk s1 s2 XCPU // sign cs cnt pubk cnt' cnt EQUAL 33 THROWIFNOT // ( seqno mismatch? ) s2 PUSH HASHSU // sign cs cnt pubk hash s0 s4 s4 XC2PU // pubk cs cnt hash sign pubk CHKSIGNU // pubk cs cnt ? 34 THROWIFNOT // signature mismatch ACCEPT SWAP 32 LDU NIP DUP SREFS IF:&lt;{ 8 LDU LDREF // pubk cnt mode msg cs s0 s2 XCHG SENDRAWMSG // pubk cnt cs ; ( message sent ) }&gt; ENDS INC NEWC 32 STU 256 STU ENDC c4 POPCTR }&gt;c // code &lt;b 0 32 u, newkeypair swap dup constant wallet_pk "new-wallet.pk" B&gt;file B, b&gt; // data // no libraries &lt;bb{00110} s, rot ref, swap ref, b&gt; // create StateInit dup ."StateInit: " &lt;s csr. cr dup hash dup constant wallet_addr ."new wallet address = " wc . .": " dup x. cr wc over 7 smca&gt;$ type cr 256 u&gt;B "new-wallet.addr" B&gt;file &lt;b 0 32 u, b&gt; dup ."signing message: " &lt;s csr. cr dup hash wallet_pk ed25519_sign_uint rot &lt;bb{1000100} s, wc 8 i, wallet_addr 256 u, b{000010} s, swap &lt;ss, b{0} s, swap B, swap &lt;ss, b&gt; dup ."External message for initialization is " &lt;s csr. cr 2 boc+&gt;B dup Bx. cr "new-wallet-query.boc" tuck B&gt;file ."(Saved to file " type .")" cr</code> </pre> <br><p>  Este archivo de aspecto aterrador est√° dise√±ado para crear un contrato inteligente: se colocar√° en el <code>new-wallet-query.boc</code> despu√©s de la ejecuci√≥n.  Tenga en cuenta que aqu√≠ se usa otro lenguaje ensamblador para la m√°quina virtual TON (no me detendr√© en detalle), cuyas instrucciones se colocar√°n en la cadena de bloques. </p><br><p>  Por lo tanto, el ensamblador para TVM est√° escrito en Fift: las fuentes de este ensamblador se encuentran en el archivo <code>crypto/fift/Asm.fif</code> y est√°n conectadas al comienzo del c√≥digo anterior. </p><br><p>  ¬øQu√© puedo decir, aparentemente, a Nikolai Durov le encanta crear nuevos lenguajes de programaci√≥n :) </p><br><h2 id="sozdanie-smart-kontrakta-i-vzaimodeystvie-s-ton">  Crear un contrato inteligente e interactuar con TON </h2><br><p>  Entonces, supongamos que reunimos un cliente TON y un int√©rprete de Fift, como se describi√≥ anteriormente, y nos familiarizamos con el idioma.  ¬øC√≥mo crear un contrato inteligente ahora?  Esto se describe en el archivo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">HOWTO</a> adjunto a la fuente. </p><br><h3 id="akkaunty-v-ton">  TON Cuentas </h3><br><p>  Como describ√≠ en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">la revisi√≥n de TON</a> , esta red contiene m√°s de una cadena de bloques: hay una com√∫n, la llamada  "Cadena maestra", as√≠ como un n√∫mero arbitrario de "cadenas de trabajo" adicionales identificadas por un n√∫mero de 32 bits.  La cadena maestra tiene un identificador de -1, adem√°s de eso, tambi√©n se puede usar una cadena de trabajo "b√°sica" con el identificador 0. Cada cadena de trabajo puede tener su propia configuraci√≥n.  Internamente, cada grupo de trabajo se divide en cadenas de fragmentos, pero esto ya es un detalle de la implementaci√≥n, que no tiene que tenerse en cuenta. </p><br><p>  Muchas cuentas se almacenan dentro de una cadena de trabajo, que tienen sus propios identificadores account_id.  Para la cadena maestra y la cadena de trabajo cero, tienen una longitud de 256 bits.  Por lo tanto, el identificador de cuenta se escribe, por ejemplo, as√≠: </p><br><pre> <code class="plaintext hljs">-1:8156775b79325e5d62e742d9b96c30b6515a5cd2f1f64c5da4b193c03f070e0d</code> </pre> <br><p>  Este es un formato "en bruto": primero, el identificador de la cadena de trabajo, luego dos puntos y el identificador de la cuenta en notaci√≥n hexadecimal. </p><br><p>  Adem√°s, hay un formato abreviado: el n√∫mero de la cadena de trabajo y la direcci√≥n de la cuenta est√°n codificados en forma binaria, se les agrega una suma de verificaci√≥n y todo esto est√° codificado en Base64: </p><br><pre> <code class="plaintext hljs">Ef+BVndbeTJeXWLnQtm5bDC2UVpc0vH2TF2ksZPAPwcODSkb</code> </pre> <br><p>  Conociendo este formato de grabaci√≥n, podemos solicitar el estado actual de una cuenta a trav√©s de un cliente de prueba usando el comando </p><br><pre> <code class="plaintext hljs">getaccount -1:8156775b79325e5d62e742d9b96c30b6515a5cd2f1f64c5da4b193c03f070e0d</code> </pre> <br><p>  Recibimos una respuesta como esta: </p><br><pre> <code class="plaintext hljs">[ 3][t 2][1558746708.815218925][test-lite-client.cpp:631][!testnode] requesting account state for -1:8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D [ 3][t 2][1558746708.858564138][test-lite-client.cpp:652][!testnode] got account state for -1:8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D with respect to blocks (-1,8000000000000000,72355):F566005749C1B97F18EDE013EBA7A054B9014961BC1AD91F475B9082919A2296:1BD5DE54333164025EE39D389ECE2E93DA2871DA616D488253953E52B50DC03F and (-1,8000000000000000,72355):F566005749C1B97F18EDE013EBA7A054B9014961BC1AD91F475B9082919A2296:1BD5DE54333164025EE39D389ECE2E93DA2871DA616D488253953E52B50DC03F account state is (account addr:(addr_std anycast:nothing workchain_id:-1 address:x8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D) storage_stat:(storage_info used:(storage_used cells:(var_uint len:1 value:3) bits:(var_uint len:2 value:539) public_cells:(var_uint len:0 value:0)) last_paid:0 due_payment:nothing) storage:(account_storage last_trans_lt:74208000003 balance:(currencies grams:(nanograms amount:(var_uint len:7 value:999928362430000)) other:(extra_currencies dict:hme_empty)) state:(account_active ( split_depth:nothing special:nothing code:(just value:(raw@^Cell x{} x{FF0020DDA4F260D31F01ED44D0D31FD166BAF2A1F80001D307D4D1821804A817C80073FB0201FB00A4C8CB1FC9ED54} )) data:(just value:(raw@^Cell x{} x{0000000D} )) library:hme_empty)))) x{CFF8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D2068086C000000000000000451C90E00DC0E35B7DB5FB8C134_} x{FF0020DDA4F260D31F01ED44D0D31FD166BAF2A1F80001D307D4D1821804A817C80073FB0201FB00A4C8CB1FC9ED54} x{0000000D}</code> -client.cpp: <code class="plaintext hljs">[ 3][t 2][1558746708.815218925][test-lite-client.cpp:631][!testnode] requesting account state for -1:8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D [ 3][t 2][1558746708.858564138][test-lite-client.cpp:652][!testnode] got account state for -1:8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D with respect to blocks (-1,8000000000000000,72355):F566005749C1B97F18EDE013EBA7A054B9014961BC1AD91F475B9082919A2296:1BD5DE54333164025EE39D389ECE2E93DA2871DA616D488253953E52B50DC03F and (-1,8000000000000000,72355):F566005749C1B97F18EDE013EBA7A054B9014961BC1AD91F475B9082919A2296:1BD5DE54333164025EE39D389ECE2E93DA2871DA616D488253953E52B50DC03F account state is (account addr:(addr_std anycast:nothing workchain_id:-1 address:x8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D) storage_stat:(storage_info used:(storage_used cells:(var_uint len:1 value:3) bits:(var_uint len:2 value:539) public_cells:(var_uint len:0 value:0)) last_paid:0 due_payment:nothing) storage:(account_storage last_trans_lt:74208000003 balance:(currencies grams:(nanograms amount:(var_uint len:7 value:999928362430000)) other:(extra_currencies dict:hme_empty)) state:(account_active ( split_depth:nothing special:nothing code:(just value:(raw@^Cell x{} x{FF0020DDA4F260D31F01ED44D0D31FD166BAF2A1F80001D307D4D1821804A817C80073FB0201FB00A4C8CB1FC9ED54} )) data:(just value:(raw@^Cell x{} x{0000000D} )) library:hme_empty)))) x{CFF8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D2068086C000000000000000451C90E00DC0E35B7DB5FB8C134_} x{FF0020DDA4F260D31F01ED44D0D31FD166BAF2A1F80001D307D4D1821804A817C80073FB0201FB00A4C8CB1FC9ED54} x{0000000D}</code> por -1: 8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D con respecto a los bloques (-1,8000000000000000,72355): F566005749C1B97F18EDE013EBA7A054B9014961BC1AD91F475B9082919A2296: 1BD5DE54333164025EE39D389ECE2E93DA2871DA616D488253953E52B50DC03F y <code class="plaintext hljs">[ 3][t 2][1558746708.815218925][test-lite-client.cpp:631][!testnode] requesting account state for -1:8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D [ 3][t 2][1558746708.858564138][test-lite-client.cpp:652][!testnode] got account state for -1:8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D with respect to blocks (-1,8000000000000000,72355):F566005749C1B97F18EDE013EBA7A054B9014961BC1AD91F475B9082919A2296:1BD5DE54333164025EE39D389ECE2E93DA2871DA616D488253953E52B50DC03F and (-1,8000000000000000,72355):F566005749C1B97F18EDE013EBA7A054B9014961BC1AD91F475B9082919A2296:1BD5DE54333164025EE39D389ECE2E93DA2871DA616D488253953E52B50DC03F account state is (account addr:(addr_std anycast:nothing workchain_id:-1 address:x8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D) storage_stat:(storage_info used:(storage_used cells:(var_uint len:1 value:3) bits:(var_uint len:2 value:539) public_cells:(var_uint len:0 value:0)) last_paid:0 due_payment:nothing) storage:(account_storage last_trans_lt:74208000003 balance:(currencies grams:(nanograms amount:(var_uint len:7 value:999928362430000)) other:(extra_currencies dict:hme_empty)) state:(account_active ( split_depth:nothing special:nothing code:(just value:(raw@^Cell x{} x{FF0020DDA4F260D31F01ED44D0D31FD166BAF2A1F80001D307D4D1821804A817C80073FB0201FB00A4C8CB1FC9ED54} )) data:(just value:(raw@^Cell x{} x{0000000D} )) library:hme_empty)))) x{CFF8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D2068086C000000000000000451C90E00DC0E35B7DB5FB8C134_} x{FF0020DDA4F260D31F01ED44D0D31FD166BAF2A1F80001D307D4D1821804A817C80073FB0201FB00A4C8CB1FC9ED54} x{0000000D}</code> </pre> <br><p>  Vemos la estructura que se almacena en el DHT de la cadena de trabajo especificada.  Por ejemplo, en el campo <code>storage.balance</code> encuentra el saldo de la cuenta corriente, en <code>storage.state.code</code> encuentra el c√≥digo de contrato inteligente y en <code>storage.state.data</code> encuentran sus datos actuales.  Tenga en cuenta que el almac√©n de datos TON - Celda, celdas - es un √°rbol, cada celda puede tener sus propios datos, as√≠ como celdas secundarias.  Esto se muestra como sangr√≠a en las √∫ltimas l√≠neas. </p><br><h3 id="sborka-smart-kontrakta">  Asamblea de contrato inteligente </h3><br><p>  Ahora creemos una estructura como esta (se llama BOC - <em>bolsa de celdas</em> ) usando el lenguaje Fift.  Afortunadamente, no tendr√° que escribir un contrato inteligente usted mismo: en la carpeta <code>crypto/block</code> archivo de origen hay un archivo <code>new-wallet.fif</code> que nos ayudar√° a crear una nueva billetera.  C√≥pielo en la carpeta con el cliente ensamblado ( <code>~/liteclient-build</code> , si <code>~/liteclient-build</code> instrucciones anteriores).  Cit√© su contenido arriba como un ejemplo de c√≥digo en Fift. </p><br><p>  Ejecutamos este archivo de la siguiente manera: </p><br><pre> <code class="plaintext hljs">./crypto/fift -I"&lt;source-directory&gt;/crypto/fift" new-wallet.fif</code> </pre> <br><p>  Aqu√≠ <code>&lt;source-directory&gt;</code> debe reemplazarse con la ruta a las fuentes desempaquetadas (el s√≠mbolo "~" no se puede usar aqu√≠, desafortunadamente, necesita la ruta completa).  En lugar de usar el <code>FIFTPATH</code> <code>-I</code> puede definir la <code>FIFTPATH</code> entorno <code>FIFTPATH</code> y poner esta ruta en ella. </p><br><p>  Desde que lanzamos Fift con el nombre de archivo <code>new-wallet.fif</code> , lo ejecutar√° y completar√°.  Si omite el nombre del archivo, puede jugar con el int√©rprete en modo interactivo. </p><br><p>  Despu√©s de la ejecuci√≥n, algo como esto deber√≠a mostrarse en la consola: </p><br><pre> <code class="plaintext hljs">StateInit: x{34_} x{FF0020DDA4F260810200D71820D70B1FED44D0D31FD3FFD15112BAF2A122F901541044F910F2A2F80001D31F3120D74A96D307D402FB00DED1A4C8CB1FCBFFC9ED54} x{0000000055375F730EDC2292E8CB15C42E8036EE9C25AA958EE002D2DE48A205E3A3426B} new wallet address = -1 : 4fcd520b8fcca096b567d734be3528edc6bed005f6930a9ec9ac1aa714f211f2 0f9PzVILj8yglrVn1zS-NSjtxr7QBfaTCp7JrBqnFPIR8nhZ signing message: x{00000000} External message for initialization is x{89FEE120E20C7E953E31546F64C23CD654002C1AA919ADD24DB12DDF85C6F3B58AE41198A28AD8DAF3B9588E7A629252BA3DB88F030D00BC1016110B2073359EAC3C13823C53245B65D056F2C070B940CDA09789585935C7ABA4D2AD4BED139281CFA1200000001_} x{FF0020DDA4F260810200D71820D70B1FED44D0D31FD3FFD15112BAF2A122F901541044F910F2A2F80001D31F3120D74A96D307D402FB00DED1A4C8CB1FCBFFC9ED54} x{0000000055375F730EDC2292E8CB15C42E8036EE9C25AA958EE002D2DE48A205E3A3426B} B5EE9C724104030100000000D60002CF89FEE120E20C7E953E31546F64C23CD654002C1AA919ADD24DB12DDF85C6F3B58AE41198A28AD8DAF3B9588E7A629252BA3DB88F030D00BC1016110B2073359EAC3C13823C53245B65D056F2C070B940CDA09789585935C7ABA4D2AD4BED139281CFA1200000001001020084FF0020DDA4F260810200D71820D70B1FED44D0D31FD3FFD15112BAF2A122F901541044F910F2A2F80001D31F3120D74A96D307D402FB00DED1A4C8CB1FCBFFC9ED5400480000000055375F730EDC2292E8CB15C42E8036EE9C25AA958EE002D2DE48A205E3A3426B6290698B (Saved to file new-wallet-query.boc)</code> } <code class="plaintext hljs">StateInit: x{34_} x{FF0020DDA4F260810200D71820D70B1FED44D0D31FD3FFD15112BAF2A122F901541044F910F2A2F80001D31F3120D74A96D307D402FB00DED1A4C8CB1FCBFFC9ED54} x{0000000055375F730EDC2292E8CB15C42E8036EE9C25AA958EE002D2DE48A205E3A3426B} new wallet address = -1 : 4fcd520b8fcca096b567d734be3528edc6bed005f6930a9ec9ac1aa714f211f2 0f9PzVILj8yglrVn1zS-NSjtxr7QBfaTCp7JrBqnFPIR8nhZ signing message: x{00000000} External message for initialization is x{89FEE120E20C7E953E31546F64C23CD654002C1AA919ADD24DB12DDF85C6F3B58AE41198A28AD8DAF3B9588E7A629252BA3DB88F030D00BC1016110B2073359EAC3C13823C53245B65D056F2C070B940CDA09789585935C7ABA4D2AD4BED139281CFA1200000001_} x{FF0020DDA4F260810200D71820D70B1FED44D0D31FD3FFD15112BAF2A122F901541044F910F2A2F80001D31F3120D74A96D307D402FB00DED1A4C8CB1FCBFFC9ED54} x{0000000055375F730EDC2292E8CB15C42E8036EE9C25AA958EE002D2DE48A205E3A3426B} B5EE9C724104030100000000D60002CF89FEE120E20C7E953E31546F64C23CD654002C1AA919ADD24DB12DDF85C6F3B58AE41198A28AD8DAF3B9588E7A629252BA3DB88F030D00BC1016110B2073359EAC3C13823C53245B65D056F2C070B940CDA09789585935C7ABA4D2AD4BED139281CFA1200000001001020084FF0020DDA4F260810200D71820D70B1FED44D0D31FD3FFD15112BAF2A122F901541044F910F2A2F80001D31F3120D74A96D307D402FB00DED1A4C8CB1FCBFFC9ED5400480000000055375F730EDC2292E8CB15C42E8036EE9C25AA958EE002D2DE48A205E3A3426B6290698B (Saved to file new-wallet-query.boc)</code> </pre> <br><p>  Esto significa que la billetera con el identificador <code>-1:4fcd520b8fcca096b567d734be3528edc6bed005f6930a9ec9ac1aa714f211f2</code> (o, lo que es lo mismo, <code>0f9PzVILj8yglrVn1zS-NSjtxr7QBfaTCp7JrBqnFPIR8nhZ</code>  El c√≥digo correspondiente <code>new-wallet-query.boc</code> en el <code>new-wallet-query.boc</code> , su direcci√≥n en <code>new-wallet.addr</code> y la clave privada en <code>new-wallet.pk</code> (tenga cuidado: reiniciar el script sobrescribir√° estos archivos). </p><br><p>  Por supuesto, la red TON a√∫n no conoce esta billetera, solo se almacena en forma de estos archivos.  Ahora necesita subirlo a la red.  Es cierto que el problema es que para crear un contrato inteligente debe pagar una comisi√≥n, y el saldo de su cuenta sigue siendo cero. </p><br><p>  En el modo de trabajo, este problema se resolver√° comprando gramos en el intercambio (o transfiriendo desde otra billetera).  Bueno, en el modo de prueba actual, se ha instituido un contrato inteligente especial, desde el cual puede solicitar hasta 20 gramos de esa manera. </p><br><h3 id="formirovanie-zaprosa-k-chuzhomu-smart-kontraktu">  Formaci√≥n de una solicitud para el contrato inteligente de otra persona. </h3><br><p>  Solicite un contrato inteligente, distribuyendo gramos a izquierda y derecha, h√°galo.  En la misma carpeta <code>crypto/block</code> encontramos el archivo <code>testgiver.fif</code> : </p><br><pre> <code class="plaintext hljs">// "testgiver.addr" file&gt;B 256 B&gt;u@ 0x8156775b79325e5d62e742d9b96c30b6515a5cd2f1f64c5da4b193c03f070e0d dup constant wallet_addr ."Test giver address = " x. cr 0x4fcd520b8fcca096b567d734be3528edc6bed005f6930a9ec9ac1aa714f211f2 constant dest_addr -1 constant wc 0x00000011 constant seqno 1000000000 constant Gram { Gram swap */ } : Gram*/ 6.666 Gram*/ constant amount // bx --&gt; b' ( serializes a Gram amount ) { -1 { 1+ 2dup 8 * ufits } until rot over 4 u, -rot 8 * u, } : Gram, // create a message (NB: 01b00.., b = bounce) &lt;bb{010000100} s, wc 8 i, dest_addr 256 u, amount Gram, 0 9 64 32 + + 1+ 1+ u, "GIFT" $, b&gt; &lt;b seqno 32 u, 1 8 u, swap ref, b&gt; dup ."enveloping message: " &lt;s csr. cr &lt;bb{1000100} s, wc 8 i, wallet_addr 256 u, 0 Gram, b{00} s, swap &lt;ss, b&gt; dup ."resulting external message: " &lt;s csr. cr 2 boc+&gt;B dup Bx. cr "wallet-query.boc" B&gt;file</code> </pre> <br><p>  Tambi√©n lo <code>constant dest_addr</code> en la carpeta con el cliente ensamblado, pero arreglamos la quinta l√≠nea, antes de la l√≠nea " <code>constant dest_addr</code> ".  Reempl√°celo con la direcci√≥n de la billetera que cre√≥ antes (completa, no abreviada).  "-1:" no necesita escribir al principio, en su lugar, ponga "0x" al principio. </p><br><p>  Tambi√©n puede cambiar la l√≠nea <code>6.666 Gram*/ constant amount</code> : esta es la cantidad en gramos que solicita (no m√°s de 20).  Incluso si especifica un n√∫mero entero, deje el punto decimal. </p><br><p>  Finalmente, debe corregir la l√≠nea <code>0x00000011 constant seqno</code> .  El primer n√∫mero aqu√≠ es el n√∫mero de secuencia actual, que se almacena en la cuenta que emite los gramos.  ¬øDe d√≥nde conseguirlo?  Como se mencion√≥ anteriormente, inicie el cliente y ejecute: </p><br><pre> <code class="plaintext hljs">last getaccount -1:8156775b79325e5d62e742d9b96c30b6515a5cd2f1f64c5da4b193c03f070e0d</code> </pre> <br><p>  Al final en los datos del contrato inteligente ser√° </p><br><pre> <code class="plaintext hljs">... x{FF0020DDA4F260D31F01ED44D0D31FD166BAF2A1F80001D307D4D1821804A817C80073FB0201FB00A4C8CB1FC9ED54} x{0000000D}</code> </pre> <br><p>  El n√∫mero 0000000D (tendr√° m√°s) es el n√∫mero de secuencia, que debe sustituirse en <code>testgiver.fif</code> . </p><br><p>  Eso es todo, guarde el archivo y ejec√∫telo ( <code>./crypto/fift testgiver.fif</code> ).  El resultado ser√° el <code>wallet-query.boc</code> .  Este es el <em>mensaje</em> formado para el contrato inteligente de otra persona: la solicitud es "transferir tantos gramos a tal o cual cuenta". </p><br><p>  Usando el cliente, lo subimos a la red: </p><br><pre> <code class="plaintext hljs">&gt; sendfile wallet-query.boc [ 1][t 1][1558747399.456575155][test-lite-client.cpp:577][!testnode] sending query from file wallet-query.boc [ 3][t 2][1558747399.500236034][test-lite-client.cpp:587][!query] external message status is 1</code> </pre> <br><p>  Si ahora llamamos al <code>last</code> y luego volvemos a solicitar el estado de la cuenta desde la que solicitamos gramos, entonces deber√≠amos ver que su n√∫mero de secuencia ha aumentado en uno, esto significa que envi√≥ dinero a nuestra cuenta. </p><br><p>  El √∫ltimo paso permanece: cargamos el c√≥digo de nuestra billetera (su saldo ya se ha reabastecido, pero sin el c√≥digo de contrato inteligente no podremos administrarlo).  <code>sendfile new-wallet-query.boc</code> , y eso es todo, tiene su propia billetera en la red TON (aunque por ahora solo una de prueba). </p><br><h3 id="sozdanie-ishodyaschih-tranzakciy">  Crear transacciones salientes </h3><br><p>  Para transferir dinero del saldo de la cuenta creada, hay un <code>crypto/block/wallet.fif</code> , que tambi√©n debe colocarse en la carpeta con el cliente recopilado. </p><br><p>  De manera similar a los pasos anteriores, debe corregir la cantidad que transfiere, la direcci√≥n del destinatario (dest_addr) y la seqno de su billetera (es 1 despu√©s de que la billetera se inicializa y aumenta en 1 despu√©s de cada transacci√≥n saliente; puede verla solicitando el estado de su cuenta) .  Para las pruebas, puede usar, por ejemplo, mi billetera - <code>0x4fcd520b8fcca096b567d734be3528edc6bed005f6930a9ec9ac1aa714f211f2</code> . </p><br><p>  Cuando ejecuta ( <code>./crypto/fift wallet.fif</code> ), el script tomar√° la direcci√≥n de su billetera (desde donde la transfiere) y su clave privada de los archivos <code>new-wallet.addr</code> y <code>new-wallet.pk</code> , y escribir√° el mensaje recibido en <code>new-wallet-query.boc</code> . </p><br><p>  Como antes, para ejecutar directamente la transacci√≥n, llamamos a <code>sendfile new-wallet-query.boc</code> en el cliente.  Despu√©s de eso, no olvide actualizar el estado de la cadena de bloques ( <code>last</code> ) y verifique que el saldo y la seqno de nuestra billetera hayan cambiado ( <code>getaccount &lt;account_id&gt;</code> ). </p><br><p><img src="https://habrastorage.org/webt/fp/d1/is/fpd1is8dlh4_iz9rdbakflyeq5s.png" alt="Descripci√≥n de la cuenta"></p><br><p>  Eso es todo, ahora podemos crear contratos inteligentes en TON y enviarles solicitudes.  Como puede ver, la funcionalidad actual ya es suficiente para, por ejemplo, hacer una billetera m√°s amigable con una interfaz gr√°fica (sin embargo, se espera que est√© disponible como parte del messenger). </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/453714/">https://habr.com/ru/post/453714/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../453700/index.html">Lecciones sobre SDL 2: Lecci√≥n 1 - Hola, SDL 2</a></li>
<li><a href="../453706/index.html">C√≥mo pas√© el examen de certificaci√≥n de ingeniero de datos de Google Cloud Professional</a></li>
<li><a href="../453708/index.html">SO AQUA RTOS en tiempo real para MK AVR en el entorno BASCOM AVR</a></li>
<li><a href="../453710/index.html">Pr√°ctica de desarrollo en grandes proyectos: mitp SberPractice iOS # 1</a></li>
<li><a href="../453712/index.html">C√≥mo eBay hizo un esc√°ner de c√≥digo de barras en WebAssembly</a></li>
<li><a href="../453716/index.html">Coworking en el campo para personal de TI familiar: ¬øhay alguien?</a></li>
<li><a href="../453720/index.html">Sutilezas de las expresiones lambda en C #</a></li>
<li><a href="../453722/index.html">Sobre la investigaci√≥n de procesos no estacionarios</a></li>
<li><a href="../453728/index.html">Batalla de las hiperestrellas</a></li>
<li><a href="../453730/index.html">Odontolog√≠a moderna: implantaci√≥n dental simult√°nea y extensi√≥n de la mand√≠bula a trav√©s de los ojos del director t√©cnico</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>