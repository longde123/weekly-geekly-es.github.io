<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üêÑ üë©üèΩ‚Äçüè´ üí≥ RxJava √† Coroutines: migration des fonctionnalit√©s de bout en bout üêÅ üë®üèø‚Äçüé§ üç£</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="(initialement publi√© sur Medium ) 

 Les coroutines Kotlin sont bien plus que de simples threads l√©gers - c'est un nouveau paradigme qui aide les d√©ve...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>RxJava √† Coroutines: migration des fonctionnalit√©s de bout en bout</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/483832/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/jb/id/pq/jbidpqpivwqpagw9azop_fswram.png" alt="image"></div><br>  (initialement publi√© sur <a href="https://link.medium.com/OJ7ed2RCd3" rel="nofollow">Medium</a> ) <br><br>  Les coroutines Kotlin sont bien plus que de simples threads l√©gers - c'est un nouveau paradigme qui aide les d√©veloppeurs √† g√©rer la concurrence de mani√®re <a href="https://medium.com/%40elizarov/structured-concurrency-722d765aa952" rel="nofollow">structur√©e</a> et idiomatique. <br><br>  Lors du d√©veloppement d'une application Android, il faut consid√©rer de nombreuses choses diff√©rentes: supprimer les op√©rations de longue dur√©e du thread d'interface utilisateur, g√©rer les √©v√©nements du cycle de vie, annuler les abonnements, revenir au thread d'interface utilisateur pour mettre √† jour l'interface utilisateur.  Au cours des deux derni√®res ann√©es, RxJava est devenu l'un des cadres les plus couramment utilis√©s pour r√©soudre cet ensemble de probl√®mes.  Dans cet article, je vais vous guider √† travers la migration des fonctionnalit√©s de bout en bout de RxJava vers les coroutines. <br><a name="habracut"></a><br><h4>  Fonctionnalit√© </h4><br>  La fonctionnalit√© que nous allons convertir en coroutines est assez simple: lorsque l'utilisateur soumet un pays, nous faisons un appel API pour v√©rifier si le pays est √©ligible pour une recherche de d√©tails commerciaux via un fournisseur comme <a href="https://www.gov.uk/government/organisations/companies-house" rel="nofollow">Companies House</a> .  Si l'appel a r√©ussi, nous affichons la r√©ponse, sinon - le message d'erreur. <br><br><h4>  La migration </h4><br><img src="https://habrastorage.org/webt/j0/0h/kg/j00hkgwjgnuwnzz4lsgdf5ry_fa.png" align="left"><br>  Nous allons migrer notre code dans une approche ascendante en commen√ßant par le service Retrofit, en passant √† une couche Repository, puis √† une couche Interactor et enfin √† un ViewModel. <br><br>  Les fonctions qui renvoient actuellement Single devraient devenir des fonctions de suspension et les fonctions qui renvoient Observable devraient renvoyer Flow.  Dans cet exemple particulier, nous n'allons rien faire avec les flux. <br><br><h4>  Service de r√©novation </h4><br>  Passons directement au code et refactorisons la m√©thode businessLookupElmissibilit√© dans BusinessLookupService en coroutines.  Voil√† √† quoi √ßa ressemble maintenant. <br><br><pre><code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BusinessLookupService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@GET(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"v1/eligibility"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">businessLookupEligibility</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-meta"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">@Query(</span></span></span><span class="hljs-meta-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta"><span class="hljs-meta-string">"countryCode"</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">)</span></span></span></span><span class="hljs-function"><span class="hljs-params"> countryCode: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params"> )</span></span></span></span>: Single&lt;NetworkResponse&lt;BusinessLookupEligibilityResponse, ErrorResponse&gt;&gt; }</code> </pre> <br>  √âtapes de refactoring: <br><br><ol><li>  √Ä partir de la <a href="" rel="nofollow">version 2.6.0,</a> Retrofit prend en charge le modificateur de suspension.  Transformons la m√©thode businessLookupElmissibilit√© en fonction de suspension. </li><li>  Supprimez le wrapper unique du type de retour. </li></ol><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BusinessLookupService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@GET(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"v1/eligibility"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">suspend</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">businessLookupEligibility</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-meta"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">@Query(</span></span></span><span class="hljs-meta-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta"><span class="hljs-meta-string">"countryCode"</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">)</span></span></span></span><span class="hljs-function"><span class="hljs-params"> countryCode: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params"> )</span></span></span></span>: NetworkResponse&lt;BusinessLookupEligibilityResponse, ErrorResponse&gt; }</code> </pre><br>  NetworkResponse est une classe scell√©e qui repr√©sente BusinessLookupElmissibilit√©Response ou ErrorResponse.  NetworkResponse est construit dans un adaptateur d'appel Retrofit personnalis√©.  De cette fa√ßon, nous limitons le flux de donn√©es √† seulement deux cas possibles - succ√®s ou erreur, afin que les consommateurs de BusinessLookupService n'aient pas √† se soucier de la gestion des exceptions. <br><br><h4>  D√©p√¥t </h4><br>  Passons √† autre chose et voyons ce que nous avons dans BusinessLookupRepository.  Dans le corps de la m√©thode businessLookupElmissibilit√©, nous appelons businessLookupService.businessLookupElibility (celui que nous venons de refactoriser) et utilisons l'op√©rateur de carte de RxJava pour transformer NetworkResponse en un r√©sultat et mapper le mod√®le de r√©ponse au mod√®le de domaine.  Result est une autre classe scell√©e qui repr√©sente Result.Success et contient l'objetBusinessLookupElibility en cas de r√©ussite de l'appel r√©seau.  S'il y a eu une erreur dans l'appel r√©seau, une exception de d√©s√©rialisation ou quelque chose d'autre s'est mal pass√©, nous avons cr√©√© Result.Failure avec un message d'erreur significatif (ErrorMessage est un <a href="https://kotlinlang.org/docs/reference/type-aliases.html" rel="nofollow">typealias</a> pour String). <br><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BusinessLookupRepository</span></span></span><span class="hljs-class"> </span><span class="hljs-meta"><span class="hljs-class"><span class="hljs-meta">@Inject</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">constructor</span></span></span></span>( <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> businessLookupService: BusinessLookupService, <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> businessLookupApiToDomainMapper: BusinessLookupApiToDomainMapper, <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> responseToString: Mapper, <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> schedulerProvider: SchedulerProvider ) { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">businessLookupEligibility</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(countryCode: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: Single&lt;Result&lt;BusinessLookupEligibility, ErrorMessage&gt;&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> businessLookupService.businessLookupEligibility(countryCode) .map { response -&gt; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span><span class="hljs-symbol"><span class="hljs-symbol">@map</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> (response) { <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> NetworkResponse.Success -&gt; { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> businessLookupEligibility = businessLookupApiToDomainMapper.map(response.body) Result.Success&lt;BusinessLookupEligibility, ErrorMessage&gt;(businessLookupEligibility) } <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> NetworkResponse.Error -&gt; Result.Failure&lt;BusinessLookupEligibility, ErrorMessage&gt;( responseToString.transform(response) ) } }.subscribeOn(schedulerProvider.io()) } }</code> </pre><br>  √âtapes de refactoring: <br><br><ol><li>  businessLookupElmissibilit√© devient une fonction de suspension. </li><li>  Supprimez le wrapper unique du type de retour. </li><li>  Les m√©thodes du r√©f√©rentiel effectuent g√©n√©ralement des t√¢ches de longue dur√©e telles que les appels r√©seau ou les requ√™tes db.  Il est de la responsabilit√© du r√©f√©rentiel de sp√©cifier sur quel thread ce travail doit √™tre effectu√©.  Par subscribeOn (schedulerProvider.io ()), nous disons √† RxJava que le travail doit √™tre effectu√© sur le thread io.  Comment pourrait-on obtenir la m√™me chose avec les coroutines?  Nous allons utiliser withContext avec un r√©partiteur sp√©cifique pour d√©caler l'ex√©cution du bloc vers les diff√©rents threads et revenir au r√©partiteur d'origine une fois l'ex√©cution termin√©e.  C'est une bonne pratique pour vous assurer qu'une fonction est s√©curis√©e principale en utilisant withContext.  Les consommateurs de BusinessLookupRepository ne devraient pas penser au thread qu'ils devraient utiliser pour ex√©cuter la m√©thode businessLookupElibility, il devrait √™tre s√ªr de l'appeler √† partir du thread principal. </li><li>  Nous n'avons plus besoin de l'op√©rateur de carte car nous pouvons utiliser le r√©sultat de businessLookupService.businessLookupElibility dans un corps de fonction de suspension. </li></ol><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BusinessLookupRepository</span></span></span><span class="hljs-class"> </span><span class="hljs-meta"><span class="hljs-class"><span class="hljs-meta">@Inject</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">constructor</span></span></span></span>( <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> businessLookupService: BusinessLookupService, <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> businessLookupApiToDomainMapper: BusinessLookupApiToDomainMapper, <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> responseToString: Mapper, <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> dispatcherProvider: DispatcherProvider ) { <span class="hljs-keyword"><span class="hljs-keyword">suspend</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">businessLookupEligibility</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(countryCode: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: Result&lt;BusinessLookupEligibility, ErrorMessage&gt; = withContext(dispatcherProvider.io) { <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">val</span></span> response = businessLookupService.businessLookupEligibility(countryCode)) { <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> NetworkResponse.Success -&gt; { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> businessLookupEligibility = businessLookupApiToDomainMapper.map(response.body) Result.Success&lt;BusinessLookupEligibility, ErrorMessage&gt;(businessLookupEligibility) } <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> NetworkResponse.Error -&gt; Result.Failure&lt;BusinessLookupEligibility, ErrorMessage&gt;( responseToString.transform(response) ) } } }</code> </pre><br><h4>  Interactractor </h4><br>  Dans cet exemple sp√©cifique, BusinessLookupElibilityInteractor ne contient aucune logique suppl√©mentaire et sert de proxy √† BusinessLookupRepository.  Nous utilisons la <a href="https://kotlinlang.org/docs/reference/operator-overloading.html" rel="nofollow">surcharge d'op√©rateur d'</a> invocation afin que l'interaction puisse √™tre invoqu√©e en tant que fonction. <br><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BusinessLookupEligibilityInteractor</span></span></span><span class="hljs-class"> </span><span class="hljs-meta"><span class="hljs-class"><span class="hljs-meta">@Inject</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">constructor</span></span></span></span>( <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> businessLookupRepository: BusinessLookupRepository ) { <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">invoke</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(countryCode: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: Single&lt;Result&lt;BusinessLookupEligibility, ErrorMessage&gt;&gt; = businessLookupRepository.businessLookupEligibility(countryCode) }</code> </pre><br>  √âtapes de refactoring: <br><br><ol><li>  l'op√©rateur fun invoke devient suspendre l'op√©rateur fun invoke. </li><li>  Supprimez le wrapper unique du type de retour. </li></ol><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BusinessLookupEligibilityInteractor</span></span></span><span class="hljs-class"> </span><span class="hljs-meta"><span class="hljs-class"><span class="hljs-meta">@Inject</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">constructor</span></span></span></span>( <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> businessLookupRepository: BusinessLookupRepository ) { <span class="hljs-keyword"><span class="hljs-keyword">suspend</span></span> <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">invoke</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(countryCode: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: Result&lt;BusinessLookupEligibility, ErrorMessage&gt; = businessLookupRepository.businessLookupEligibility(countryCode) }</code> </pre><br><h4>  ViewModel </h4><br>  Dans BusinessProfileViewModel, nous appelons BusinessLookupElibilityInteractor qui renvoie Single.  Nous nous abonnons au flux et l'observons sur le thread d'interface utilisateur en sp√©cifiant le planificateur d'interface utilisateur.  En cas de succ√®s, nous attribuons la valeur d'un mod√®le de domaine √† un BusinessViewState LiveData.  En cas d'√©chec nous attribuons un message d'erreur. <br><br>  Nous ajoutons chaque abonnement √† un CompositeDisposable et les √©liminons dans la m√©thode onCleared () du cycle de vie d'un ViewModel. <br><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BusinessProfileViewModel</span></span></span><span class="hljs-class"> </span><span class="hljs-meta"><span class="hljs-class"><span class="hljs-meta">@Inject</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">constructor</span></span></span></span>( <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> businessLookupEligibilityInteractor: BusinessLookupEligibilityInteractor, <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> schedulerProvider: SchedulerProvider ) : ViewModel() { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> disposables = CompositeDisposable() <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> businessViewState: MutableLiveData&lt;ViewState&gt; = LiveDataFactory.createDefault(<span class="hljs-string"><span class="hljs-string">"Loading..."</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCountrySubmit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(country: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Country</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { disposables.add(businessLookupEligibilityInteractor(country.countryCode) .observeOn(schedulerProvider.ui()) .subscribe { state -&gt; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span><span class="hljs-symbol"><span class="hljs-symbol">@subscribe</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> (state) { <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> Result.Success -&gt; businessViewState.value = state.entity.provider <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> Result.Failure -&gt; businessViewState.value = state.failure } }) } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> void onCleared() { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCleared(); disposables.clear(); } }</code> </pre><br>  √âtapes de refactoring: <br><br><ol><li>  Au d√©but de l'article, j'ai mentionn√© l'un des principaux avantages des coroutines - la concurrence structur√©e.  Et c'est l√† que cela entre en jeu.  Chaque coroutine a une port√©e.  La port√©e a le contr√¥le d'une coroutine via son travail.  Si un travail est annul√©, toutes les coroutines de l'√©tendue correspondante seront √©galement annul√©es.  Vous √™tes libre de cr√©er vos propres √©tendues, mais dans ce cas, nous allons tirer parti du viewModelScope compatible avec le cycle de vie de ViewModel.  Nous allons d√©marrer une nouvelle coroutine dans un viewModelScope en utilisant viewModelScope.launch.  La coroutine sera lanc√©e dans le thread principal car viewModelScope a un r√©partiteur par d√©faut - Dispatchers.Main.  Une coroutine a d√©marr√© sur Dispatchers. Main ne bloquera pas le thread principal pendant la suspension.  Comme nous venons de lancer une coroutine, nous pouvons invoquer l'op√©rateur de suspension businessLookupElibilityInteractor et obtenir le r√©sultat.  businessLookupElibilityInteractor appelle BusinessLookupRepository.businessLookupElibility ce qui d√©place l'ex√©cution vers Dispatchers.IO et de nouveau vers Dispatchers.Main.  Comme nous sommes dans le thread d'interface utilisateur, nous pouvons mettre √† jour businessViewState LiveData en attribuant une valeur. </li><li>  Nous pouvons nous d√©barrasser des produits jetables car viewModelScope est li√© √† un cycle de vie ViewModel.  Toute coroutine lanc√©e dans cette √©tendue est automatiquement annul√©e si le ViewModel est effac√©. </li></ol><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BusinessProfileViewModel</span></span></span><span class="hljs-class"> </span><span class="hljs-meta"><span class="hljs-class"><span class="hljs-meta">@Inject</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">constructor</span></span></span></span>( <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> businessLookupEligibilityInteractor: BusinessLookupEligibilityInteractor ) : ViewModel() { <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> businessViewState: MutableLiveData&lt;ViewState&gt; = LiveDataFactory.createDefault(<span class="hljs-string"><span class="hljs-string">"Loading..."</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCountrySubmit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(country: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Country</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { viewModelScope.launch { <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">val</span></span> state = businessLookupEligibilityInteractor(country.countryCode)) { <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> Result.Success -&gt; businessViewState.value = state.entity.provider <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> Result.Failure -&gt; businessViewState.value = state.failure } } } }</code> </pre><br><h4>  Points cl√©s √† retenir </h4><br>  La lecture et la compr√©hension du code √©crit avec des coroutines est assez facile, n√©anmoins c'est un changement de paradigme qui n√©cessite un certain effort pour apprendre √† aborder l'√©criture de code avec des coroutines. <br><br>  Dans cet article, je n'ai pas couvert les tests.  J'ai utilis√© la biblioth√®que <a href="https://mockk.io/" rel="nofollow">mockk</a> car j'avais des probl√®mes pour tester les coroutines √† l'aide de Mockito. <br><br>  Tout ce que j'ai √©crit avec Rx Java, je l'ai trouv√© assez facile √† impl√©menter avec des coroutines, des <a href="https://kotlinlang.org/docs/reference/coroutines/flow.html" rel="nofollow">flux</a> et des <a href="https://kotlinlang.org/docs/reference/coroutines/channels.html" rel="nofollow">canaux</a> .  L'un des avantages des coroutines est qu'elles sont une fonctionnalit√© du langage Kotlin et qu'elles √©voluent avec le langage. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr483832/">https://habr.com/ru/post/fr483832/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr483818/index.html">Moteur, langage de script et roman visuel - en 45 heures</a></li>
<li><a href="../fr483820/index.html">Ce qui affecte l'√©mission de cr√©dit. Aper√ßu de la concurrence pour le risque de d√©faut de cr√©dit</a></li>
<li><a href="../fr483822/index.html">5 fonctionnalit√©s JavaScript sans lesquelles je ne pouvais pas √©crire de code</a></li>
<li><a href="../fr483826/index.html">Connexion d'un capteur de CO2 mod√®le MH-Z19B √† l'aide de la sortie analogique Vo</a></li>
<li><a href="../fr483828/index.html">√âchanges atomiques de brillance et de pauvret√©</a></li>
<li><a href="../fr483834/index.html">Debian: transformer simplement i386 en amd64</a></li>
<li><a href="../fr483842/index.html">L'histoire de la cr√©ation d'un cloud domestique. Partie 5. Mise √† jour 2019 - PHP 7.2, MariaDB 10.4 et Nextcloud 17</a></li>
<li><a href="../fr483844/index.html">Analyse des documents r√©glementaires sur la protection des informations dans le secteur russe du cr√©dit et des finances</a></li>
<li><a href="../fr483846/index.html">Gestion alternative des fen√™tres sous Linux</a></li>
<li><a href="../fr483850/index.html">Aucun dieux ne br√ªle de pots</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>