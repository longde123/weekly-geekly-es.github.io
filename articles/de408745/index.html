<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>📞 🕯️ 🕦 Freisprechen, aber kein Telefon. Gehorsames Zuhause, wenn nicht genügend Hände vorhanden sind 🙍🏾 🎋 🥧</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hallo Community! 

 Ich hatte den Wunsch, wieder mit dem Mikrocontroller herumzuspielen und etwas Nützliches zu tun. Das Ziel wurde fast sofort gebild...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Freisprechen, aber kein Telefon. Gehorsames Zuhause, wenn nicht genügend Hände vorhanden sind</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/408745/">  Hallo Community! <br><br>  Ich hatte den Wunsch, wieder mit dem Mikrocontroller herumzuspielen und etwas Nützliches zu tun.  Das Ziel wurde fast sofort gebildet, als mich etwas in der Wohnung störte. <br><br>  Wie Sie wissen, ist ein Computertisch ein Esstisch, an dem Sie Drobyshevsky beobachten oder Giktayms / Green Cat / usw. lesen können.  gleichzeitig mit dem Abendessen.  Aber es gibt ein Problem - ich gehe normalerweise mit <b>beiden</b> fleißigen Händen aus der Küche und auch zurück, <s>weil die Tassen in drei Teilen gestapelt sind.</s>  Ein- und Ausschalten des Lichts in der Küche (Dreifachschalter - Küche / Bad / WC) ist die Schulter, Nase, kleiner Finger.  Das heißt, es ist in keiner Weise unpraktisch, aber es ist unmöglich, es neu anzuordnen.  Es gab eine Aufgabe, die irgendwie aus der Ferne erledigt werden musste. <br><br>  Alle Anwesenheits- und Durchgangssensoren wurden sofort entlassen - nicht diese Genauigkeit, es gibt keine Kontrolle durch den Willen des Eigentümers.  Die Lösung liegt in der Klangsteuerung, Sprache.  Ich werde gleich sagen, dass ich keine Spracherkennung geplant habe, sie wird hier nicht benötigt.  Das von Pop eingeschaltete Licht wurde in Radio 80s beschrieben, aber das wollte ich nicht.  Es stellte sich heraus, dass die Hände frei waren, wenn die Hände beschäftigt waren.  Details sind auf. <br><a name="habracut"></a><br><h3>  Hardware-Teil. </h3><br>  Es gab eine Platine mit Atmega32 mit Quarz und Peripheriegeräten <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">SEM0007M-32A</a> und einer Streuung der Elektronik. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/geektimes/post_images/65f/1a8/7e9/65f1a87e9d6aad209f747a4419cab7ad.jpg" width="40%" alt="Bild"></div><br>  Es gab ein Mikrofon und einen Operationsverstärker.  Für den Ausgang befindet sich ein Transistor in einem sot32-Gehäuse auf der Platine sowie ein 7-Ampere-Relais.  Alles wird zusammengebaut in eine Box für Visitenkarten geschoben, das Relais ist parallel zum Schalter geschaltet, das Mikrofon ist unter der Steckdose versteckt.  Das Schema ist alltäglich, ich habe es nicht einmal gezeichnet.  Es werden nur ein Analogeingang und ein diskreter MK-Ausgang verwendet.  SEM ist redundant, aber lassen Sie es vorerst sein. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/geektimes/post_images/3c0/69f/b83/3c069fb831046a304627595be0730b70.jpg" width="350" alt="Bild"></div>  <i>Platine und nicht montierte Drähte.</i>  <i>Dann überarbeitete er es genauer.</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/geektimes/post_images/7ed/8ee/f59/7ed8eef59421665c5cef7009768a8a46.jpg" width="300" alt="Bild"></div>  <i>Der Schalter selbst, das Mikrofon, ist unter der zerlegten Steckdose nicht sichtbar.</i> <br><br><h3>  Suchen Sie nach einem Algorithmus. </h3><br>  Zweck: Der Sensor muss auf ein Wort reagieren, z. B. „ <i>Licht!</i>  »Mit einem Minimum an Code. <br>  Aufgabe: Identifizieren Sie das Befehlswort vor dem Hintergrund möglicher Geräusche, Klopfen und Klicks mit demselben Schalter.  Das heißt, nur die Amplitudenanalyse ist nicht geeignet, und die Spektralanalyse hat gezeigt, dass das Wort zu viele Harmonische enthält und sich diese natürlich ändern.  Daher war es notwendig, nach einer einfachen Lösung zu suchen, die jedoch eine akzeptable Störfestigkeit aufweist.  Sie können mehrere Zeit-Frequenz-Filter und einen Vergleich mit einer Stichprobe des Wortes durchführen, müssen sich jedoch nicht mit der Erkennung befassen.  Es wurde beschlossen, nur das Vorhandensein eines Vokaltons zu analysieren, beispielsweise des Tons „E“ oder „E“. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/geektimes/post_images/a55/5e2/6cf/a555e26cf616bfab31872bce1794d612.png" alt="Bild"></div>  <i>Der Ton ist "E".</i>  <i>Viele Harmonische sind sichtbar, daher ist die Analyse schwierig.</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/geektimes/post_images/18e/d5c/ab8/18ed5cab8307bf96a2fb8d2ae77e64dd.png" alt="Bild"></div>  <i>Der Ton ist "A."</i>  <i>Das Spektrum sieht sauberer aus, es gibt eine Hauptfrequenz.</i> <br><br><h3>  Software-Teil </h3><br>  Um die Spektralkomponenten des Signals zu kennen, können Sie digitale Filter verwenden.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Im</a> Internet gibt es ein <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">gutes Programm zum Erstellen digitaler FIR- und IIR-Filter</a> und zum Berechnen ihrer Koeffizienten - es ist dort klar und C-Code wird automatisch generiert. <br><br><div class="spoiler">  <b class="spoiler_title">Aber ich habe digitale Filter abgelehnt</b> <div class="spoiler_text">  Für eine akzeptable Filterung (4 oder mehr Ordnungen) wurden viele Koeffizienten und sogar ein Float erhalten.  So und alle Filterberechnungen im Float: <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">float</span></span> ACoef[NCoef+<span class="hljs-number"><span class="hljs-number">1</span></span>] = { <span class="hljs-number"><span class="hljs-number">0.00000347268864059354</span></span>, <span class="hljs-number"><span class="hljs-number">0.00000000000000000000</span></span>, <span class="hljs-number"><span class="hljs-number">-0.00001389075456237415</span></span>, <span class="hljs-number"><span class="hljs-number">0.00000000000000000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.00002083613184356122</span></span>, <span class="hljs-number"><span class="hljs-number">0.00000000000000000000</span></span>, <span class="hljs-number"><span class="hljs-number">-0.00001389075456237415</span></span>, <span class="hljs-number"><span class="hljs-number">0.00000000000000000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.00000347268864059354</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> BCoef[NCoef+<span class="hljs-number"><span class="hljs-number">1</span></span>] = { <span class="hljs-number"><span class="hljs-number">1.00000000000000000000</span></span>, <span class="hljs-number"><span class="hljs-number">-7.09708794063733790000</span></span>, <span class="hljs-number"><span class="hljs-number">22.77454294680684300000</span></span>, <span class="hljs-number"><span class="hljs-number">-43.03321836036351300000</span></span>, <span class="hljs-number"><span class="hljs-number">52.29813665034108500000</span></span>, <span class="hljs-number"><span class="hljs-number">-41.84199842886619100000</span></span>, <span class="hljs-number"><span class="hljs-number">21.53121088556695300000</span></span>, <span class="hljs-number"><span class="hljs-number">-6.52398963450972500000</span></span>, <span class="hljs-number"><span class="hljs-number">0.89383378261285684000</span></span> };</code> </pre> <br>  Der Mikrocontroller hätte es vielleicht getan, aber es hätte Probleme beim Debuggen gegeben - es ist nicht einfach, die Filtergrenzen zu verschieben - dies sind neue zu berechnende Koeffizienten. </div></div><br>  Nach einigem Suchen habe ich mich online für die Einzelfrequenz-Fourier-Transformation entschieden.  Das heißt, die klassische diskrete Fourier-Transformation, die beim Eintreffen jeder Abtastung des Signals mit einer Abtastfrequenz (1600 Hz) durchgeführt wird, es gibt keinen Durchgang durch die Frequenzen, es gibt nur eine Frequenz, so dass es einfach ist, sie während der Inbetriebnahme über RS-232 zu konfigurieren.  Als Ergebnis wurde die Analyse für eine Frequenz von 128 Hz durchgeführt. <br><br>  Aufgrund kurzer Abtastwerte (Blöcke) und eines rechteckigen Fensters ist die Frequenzauflösung niedrig, was eine selektive Empfindlichkeit im Bereich von 114 bis 140 Hz ergibt, <u>und dies ist der P-Filter, den ich erhalten wollte.</u> <br><br>  Zuerst müssen Sie verstehen, wo das Sprachbefehlssignal zu <s>schreien</s> beginnt.  Dazu wird zunächst durch <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">exponentielle Glättung</a> mit einer Glättungskonstante 1/64 ein Signalpegel von Null berechnet.  Der Code ist unten. <br><br><div class="spoiler">  <b class="spoiler_title">Teil des Timer-Codes für die Signalverarbeitung.</b>  <b class="spoiler_title">Timerfrequenz 1600 Hz</b> <div class="spoiler_text">  Das Signal normalisiert sich auf den Durchschnitt.  Zur Bestimmung des Schallpegels werden auch die Absolutwerte des Signals mit einer Konstanten von 1/16 gemittelt, um aus einzelnen Signalhalbwellen hochpassgefiltert zu werden (dies ist ein Analogon von RMS, aber einfacher zu berechnen).  Das Überschreiten dieses Pegels über dem Schwellenwert ist der Beginn eines Sprachbefehls, und eine sequentielle Analyse von 5 Blöcken mit 135 Abtastwerten (84,3 ms) beginnt. <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// Timer 0 output compare interrupt service routine interrupt [TIM0_COMP] void timer0_comp_isr(void) { a = adc_data[0] &lt;&lt; 2 ; //       4   . a0 = (a0*63 + a+ 63) &gt;&gt; 6; // .   "0".   10%  150  ae = (int)(a - a0); // a = ae; //      . ae = abs(ae); if (ae &lt; 32) { //      ae = 0; }; d = (int)((15 * (long int) d + ae + 15) &gt;&gt; 4); //  .  //   10%  35  if (d &gt; 100) { //    if (snd == 0) { Yz=0; snd++; } //    PORTB.1 = 1; //      }; .....</span></span></code> </pre></div></div><br>  Die folgende Abbildung zeigt das Signal, den Signalpegel, den Schwellenwert und 5 Blöcke. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/geektimes/post_images/bc9/b82/572/bc9b82572bd90ddb993e5933489e5f5b.png" alt="Bild"></div><br><h3>  Störschutz </h3><br>  Das Signal ist zum Schutz vor einem Impuls - einem Klicken oder einem Klopfen - in Blöcke unterteilt.  Wie Sie wissen, hat der Impuls einen gleichmäßigen Frequenzgang, dh in jedem Frequenzband gibt es ein Ergebnis ungleich Null und wahrscheinlich über dem Schwellenwert.  Aber die <s>Haare sind lang, aber der</s> Impuls <s>des Geistes</s> ist kurz.  Das heißt, im nächsten Block gibt es keinen Impuls mehr, was bedeutet, dass der Pegel im Frequenzband unter dem Schwellenwert liegt.  Gleichzeitig mit diesem Vorteil ergeben kurze Blöcke eine <u>niedrige</u> Frequenzauflösung.  Daher fallen einige Frequenzunterschiede im Signal immer noch in die ausgewählte Frequenzlinie. <br><br><h3>  Frequenzumwandlung </h3><br>  In jedem Block wird eine Einzelfrequenz-Fourier-Transformation für eine Frequenz f durchgeführt. <br><br>  Um die Berechnungen zu beschleunigen, werden die sin- und cos-Funktionen traditionell tabelliert und auf -127 .. + 127 skaliert. <br>  Der <code>ps</code> Index des <code>si(ps)</code> -Arrays wird aus dem Argument sin (2 * π * f * t / T) berechnet, natürlich mit einem Loopback innerhalb derselben Periode.  Der <code>pc</code> Index für cos (2 * π * f * t / T) wird im selben <code>si</code> Array einfach um 12 Positionen nach vorne verschoben. <br><br>  Ergebnis <b>Y</b> - Der Pegel der Spektrallinie wird als Summe der Absolutwerte des Real- und Imaginärteils während eines Blocks erhalten. <div class="spoiler">  <b class="spoiler_title">Also</b> <div class="spoiler_text">  Auf die richtige Weise müssen Sie die Summe der Quadrate und der Wurzel machen, aber das ist für einen 8-Bit-MK schrecklich. <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Im gleichen Timer:</b> <div class="spoiler_text"><pre> <code class="cs hljs"> a_si = (<span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) (a * si[ps]) &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-comment"><span class="hljs-comment">// a*sin a_co = (long int) (a * si[pc]) &gt;&gt; 4; // a*cos Ysi = Ysi + a_si ; // Yco = Yco + a_co; Y = (labs(Ysi) + labs(Yco)) &gt;&gt; 7; //   128    int    rs-232.</span></span></code> </pre></div></div><br>  Am Ende jedes Blocks wird <b>Y</b> mit einem Schwellenwert verglichen, die Anzahl der Blöcke wird berechnet, die den durch den Schwellenwert ausgelösten Block überschreitet.  Nach den Experimenten stellte sich heraus, dass die Mindestanzahl der ausgelösten Blöcke 3 von 5 beträgt. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/geektimes/post_images/499/6b1/cbe/4996b1cbe7750d3b010e9b430f391e67.png" alt="Bild"></div>  <i>Ein Beispiel für die spektrale Intensität in Blöcken mit einem Sprachbefehl.</i>  <i>Das Team hat bestanden.</i> <br><br>  Drei oder mehr ausgelöste Blöcke werden als korrekt empfangener Befehl interpretiert.  Das Signal am diskreten Ausgang des MK wird invertiert und das Licht ein- oder ausgeschaltet.  Da die gesamte Analyse innerhalb der Blöcke stattfindet, gibt es nach dem letzten Block keine Verzögerung im Betrieb. <br><br>  Die Rechenzeit beträgt ca. 1600 Zyklen, der Timer wird alle 9000 Zyklen aufgerufen, so dass die Last des MK gering ist - es gibt Raum für weitere Experimente mit Erkennung.  Oder Sie können eine Komplettlösung in kleineren Größen und auf einem schwachen MK erstellen. <br><br>  Die Richtigkeit der Algorithmen wurde durch den Austausch der notwendigen Variablen (log) über RS-232 mit dem Programm auf VBasic überprüft.  Frequenz f und Schwellenwerte werden in eeprom gespeichert. <br><br>  Als Ergebnis: Der Sensor erwies sich als sehr praktisch und reagiert auf Wörter aus " <i>A</i> ", z. B. <b>" <i>Waaau</i> ", " <i>Taaam</i> ", " <i>Laite</i> ", " <i>Miaaa</i> ", " <i>Yao-Yao</i> "</b> .  Lautstärke ist für menschliche Gespräche üblich.  Das Wort " <i>Lit</i> " weigert sich hartnäckig zuzuhören.  Klicks, Klopfen an Türen, Stufen, Gießen von Wasser ignoriert.  Jetzt können Sie mit vollen Händen Tassen und Teller gehen)). </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de408745/">https://habr.com/ru/post/de408745/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de408735/index.html">Der 800-Dollar-Humanoidroboter hatte nicht die Größe eines Menschen. Entschuldigung ...</a></li>
<li><a href="../de408737/index.html">QardioBase 2 Smart Scales: Immer besser werden</a></li>
<li><a href="../de408739/index.html">Supraleitende Photosynthese oder wie man ein kugelförmiges Vakuumpferd</a></li>
<li><a href="../de408741/index.html">Qualcomm Centriq 2400 Prozessor Pionier. Intel Killer?</a></li>
<li><a href="../de408743/index.html">Der kleinste GPD WIN Gaming Laptop - Was kann er und wer braucht ihn?</a></li>
<li><a href="../de408747/index.html">Das Erscheinen des neuen Rovers, des ersten Fluges von Falcon Heavy, bezweifelt die Zuverlässigkeit von Dragon und Starliner</a></li>
<li><a href="../de408749/index.html">Alles Gute zum Geburtstag, Computermaus</a></li>
<li><a href="../de408751/index.html">Amazon stellt die 3D-, VR- und AR-Entwicklungsplattform vor</a></li>
<li><a href="../de408753/index.html">Nachricht an unfreundliche künstliche Intelligenz</a></li>
<li><a href="../de408755/index.html">Wie Sie den perfekten Arbeitstag planen, je nachdem, wie Sie schlafen</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>