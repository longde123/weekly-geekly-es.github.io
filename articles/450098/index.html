<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©‚Äçüî¨ üë®üèª‚Äç‚öïÔ∏è üêä Yuri Bushmelev "Mapa de rastrillo en el campo de recolecci√≥n y entrega de registros" - transcripci√≥n del informe üòï üßòüèº üßóüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Los registros son una parte importante del sistema, lo que le permite comprender que funciona (o no funciona), como se esperaba. En las condiciones de...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Yuri Bushmelev "Mapa de rastrillo en el campo de recolecci√≥n y entrega de registros" - transcripci√≥n del informe</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/450098/"><p>  Los registros son una parte importante del sistema, lo que le permite comprender que funciona (o no funciona), como se esperaba.  En las condiciones de la arquitectura de microservicios, el trabajo con registros se convierte en una disciplina separada de una Olimpiada especial.  Debe resolver de inmediato un mont√≥n de preguntas: </p><br><ul><li>  c√≥mo escribir registros desde la aplicaci√≥n; </li><li>  donde escribir registros; </li><li>  c√≥mo entregar registros para almacenamiento y procesamiento; </li><li>  c√≥mo procesar y almacenar registros. </li></ul><br><p>  El uso de tecnolog√≠as de contenedorizaci√≥n, ahora populares, agrega arena sobre el rastrillo al campo de opciones de soluci√≥n. </p><br><p>  Sobre esta decodificaci√≥n del informe de Yuri Bushmelev "Rastrillo de mapa en el campo de la recolecci√≥n y entrega de registros" </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/NAeedJv-S3I" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  A qui√©n le importa, por favor, debajo del gato. </p><a name="habracut"></a><br><p>  Me llamo Yuri Bushmelev.  Yo trabajo en Lazada.  Hoy hablar√© sobre c√≥mo hicimos nuestros registros, c√≥mo los recolectamos y qu√© escribimos all√≠. </p><br><p><img src="https://habrastorage.org/webt/_9/te/o5/_9teo5cvnhsihs4lyyyc_8pcx-m.png"></p><br><p>  De donde somos  Quienes somos  Lazada es la tienda en l√≠nea n√∫mero 1 en seis pa√≠ses del sudeste asi√°tico.  Todos estos pa√≠ses est√°n distribuidos por centros de datos.  Ahora hay 4 centros de datos, ¬øpor qu√© es esto importante?  Porque algunas decisiones se debieron al hecho de que existe un v√≠nculo muy d√©bil entre los centros.  Tenemos una arquitectura de microservicios.  Me sorprendi√≥ descubrir que ya tenemos 80 microservicios.  Cuando comenc√© la tarea con registros, solo hab√≠a 20. Adem√°s, hay una parte bastante grande del legado de PHP, que tambi√©n tiene que vivir y soportar.  Todo esto nos genera actualmente m√°s de 6 millones de mensajes por minuto en todo el sistema en su conjunto.  Adem√°s, mostrar√© c√≥mo estamos tratando de vivir con eso y por qu√© esto es as√≠. </p><br><p><img src="https://habrastorage.org/webt/gy/fj/du/gyfjduafaipfx1ay5efm8xpwtdc.png"></p><br><p>  Necesitamos vivir de alguna manera con estos 6 millones de mensajes.  ¬øQu√© debemos hacer con ellos?  6 millones de mensajes que necesitas: </p><br><ul><li>  enviar desde la aplicaci√≥n </li><li>  aceptar para la entrega </li><li>  entregar para an√°lisis y almacenamiento. </li><li>  para analizar </li><li>  de alguna manera almacenar. </li></ul><br><p><img src="https://habrastorage.org/webt/vq/kr/yt/vqkrytwk4c_gjs9fza8_zn9hanu.png"></p><br><p>  Cuando aparecieron tres millones de mensajes, ten√≠a el mismo aspecto.  Porque comenzamos con algunos centavos.  Est√° claro que los registros de aplicaciones est√°n escritos all√≠.  Por ejemplo, no pude conectarme a la base de datos, pude conectarme a la base de datos, pero no pude leer algo.  Pero adem√°s de esto, cada uno de nuestros microservicios tambi√©n escribe un registro de acceso.  Cada solicitud que llega a un microservicio cae en el registro.  ¬øPor qu√© estamos haciendo esto?  Los desarrolladores quieren poder rastrear.  En cada registro de acceso hay un campo traza, a lo largo del cual una interfaz especial desenrolla a√∫n m√°s toda la cadena y muestra bellamente la traza.  El seguimiento muestra c√≥mo fue la solicitud, y esto ayuda a nuestros desarrolladores a lidiar r√°pidamente con cualquier basura no identificada. </p><br><p><img src="https://habrastorage.org/webt/me/fd/7d/mefd7deeshbhsvsjb8n7dh81ok4.png"></p><br><p>  ¬øC√≥mo vivir con eso?  Ahora describir√© brevemente el campo de opciones: c√≥mo en general se resuelve este problema.  C√≥mo resolver el problema de recopilar, transferir y almacenar registros. </p><br><p><img src="https://habrastorage.org/webt/0m/f8/4r/0mf84rxvsn0ewrqui_4egxgb2hk.png"></p><br><p>  ¬øC√≥mo escribir desde la aplicaci√≥n?  Est√° claro que hay diferentes formas.  En particular, hay mejores pr√°cticas, como nos dicen los camaradas de moda.  Hay una vieja escuela en dos formas, como dijeron los abuelos.  Hay otras formas </p><br><p><img src="https://habrastorage.org/webt/le/7-/_n/le7-_n8o7wl8nh4g0qadwz-jucq.png"></p><br><p>  Con la recopilaci√≥n de registros sobre la misma situaci√≥n.  No hay muchas opciones para resolver esta parte en particular.  Ya hay m√°s, pero no tantos. </p><br><p><img src="https://habrastorage.org/webt/kn/id/o2/knido22_ecpa0cgvfjzissz3fei.png"></p><br><p>  Pero con la entrega y el an√°lisis posterior, el n√∫mero de variaciones comienza a explotar.  No describir√© cada opci√≥n ahora.  Creo que todas las personas interesadas en el tema escuchan las principales opciones. </p><br><p><img src="https://habrastorage.org/webt/qu/zg/z0/quzgz0a21pgjdb0o8ek5d3nxmwc.png"></p><br><p>  Mostrar√© c√≥mo lo hicimos en Lazada, y c√≥mo comenz√≥ todo. </p><br><p><img src="https://habrastorage.org/webt/tu/b_/xt/tub_xtgrnyznjspm2vxf_lepv7o.png"></p><br><p>  Hace un a√±o, vine a Lazada y me enviaron a un proyecto sobre troncos.  Fue asi.  El registro de la aplicaci√≥n se escribi√≥ en stdout y stderr.  Hicieron todo de manera elegante.  Pero luego los desarrolladores lo eliminaron de los flujos est√°ndar, y luego los especialistas en infraestructura lo resolver√°n de alguna manera.  Entre los especialistas en infraestructura y los desarrolladores tambi√©n hay versiones que dicen: "uh ... bueno, envu√©lvalos en un archivo con un shell, eso es todo".  Y como todo esto est√° en el contenedor, lo envolvieron en el contenedor, descargaron el cat√°logo y lo pusieron all√≠.  Creo que es aproximadamente obvio para todos lo que surgi√≥. </p><br><p><img src="https://habrastorage.org/webt/l2/pl/lz/l2pllz5jvccjhbz0zzxcitkrmsk.png"></p><br><p>  Veamos un poco m√°s lejos.  ¬øC√≥mo entregamos estos registros?  Alguien eligi√≥ td-agent, que en realidad es fluido, pero no con bastante fluidez.  Todav√≠a no entend√≠a la relaci√≥n de estos dos proyectos, pero parecen ser casi lo mismo.  Y este fluido, escrito en Ruby, lee los archivos de registro, los analiza en JSON durante algunos per√≠odos regulares.  Luego los envi√≥ a Kafka.  Y en Kafka para cada API ten√≠amos 4 temas separados.  ¬øPor qu√© 4?  Porque hay vivo, hay puesta en escena, y porque hay stdout y stderr.  Los desarrolladores los dan a luz, y los ingenieros de infraestructura deben crearlos en Kafka.  Adem√°s, Kafka estaba controlada por otro departamento.  Por lo tanto, era necesario crear un ticket para que crearan 4 temas para cada API all√≠.  Todos lo olvidaron.  En general, hab√≠a basura y humos. </p><br><p><img src="https://habrastorage.org/webt/x9/2-/5s/x92-5sqis-vgly1ccyh0gjt2mxy.png"></p><br><p>  ¬øQu√© hicimos despu√©s con esto?  Lo enviamos a kafka.  M√°s all√° de Kafka, la mitad de los troncos volaron a Logstash.  La otra mitad de los registros fue compartida.  Parte vol√≥ en un Graylog, parte - en otro Graylog.  Como resultado, todo esto vol√≥ en un cl√∫ster Elasticsearch.  Es decir, todo este desastre finalmente cay√≥ all√≠.  ¬°No tienes que hacer esto! </p><br><p><img src="https://habrastorage.org/webt/ge/w9/kz/gew9kzazsmr5pwee16cuyor6n2w.png"></p><br><p>  As√≠ es como se ve si miras remotamente desde arriba.  ¬°No hagas esto!  Aqu√≠, los n√∫meros indican inmediatamente las √°reas problem√°ticas.  En realidad, hay m√°s de ellos, pero 6 son realmente bastante problem√°ticos, con lo que debes hacer algo.  Hablar√© de ellos por separado ahora. </p><br><p><img src="https://habrastorage.org/webt/2w/xu/eb/2wxuebmewhsjvjbr_9taaq5zhn4.png"></p><br><p>  Aqu√≠ (1,2,3) estamos escribiendo archivos y, en consecuencia, aqu√≠ hay tres rastrillos a la vez. </p><br><p>  El primero (1) es que necesitamos escribirlos en alguna parte.  No siempre quisiera darle a la API la capacidad de escribir directamente en un archivo.  Es deseable que la API est√© aislada en el contenedor, y a√∫n mejor, que sea de solo lectura.  Soy un administrador de sistemas, as√≠ que tengo una visi√≥n ligeramente alternativa de estas cosas. </p><br><p>  El segundo punto (2,3): tenemos muchas solicitudes que llegan a la API.  La API escribe muchos datos en un archivo.  Los archivos est√°n creciendo.  Necesitamos rotarlos.  Porque de lo contrario no hay forma de obtener ning√∫n disco.  Rotarlos es malo porque se redirigen a trav√©s del shell a un directorio.  No podemos moverlo de ninguna manera.  No se le puede decir a una aplicaci√≥n que redescubra los descriptores.  Porque los desarrolladores te mirar√°n como un tonto: ‚Äú¬øCu√°les son los descriptores?  Generalmente escribimos a stdout ".  Los ingenieros de infraestructura hicieron copytruncate en logrotate, lo que hace solo una copia del archivo y trankeytit el original.  En consecuencia, entre estos procesos de copia, el espacio en disco generalmente termina. </p><br><p>  (4) Ten√≠amos diferentes formatos y est√°bamos en diferentes API.  Eran ligeramente diferentes, pero la expresi√≥n regular tuvo que escribirse de manera diferente.  Como todo esto estaba controlado por Puppet, hab√≠a un gran paquete de clases con sus cucarachas.  Adem√°s, td-agent la mayor parte del tiempo podr√≠a comer memoria, est√∫pido, simplemente podr√≠a fingir que funciona y no hacer nada.  Afuera, era imposible entender que no estaba haciendo nada.  En el mejor de los casos, se caer√° y alguien lo recoger√° m√°s tarde.  M√°s precisamente, llegar√° la alerta, y alguien ir√° con sus manos. </p><br><p><img src="https://habrastorage.org/webt/x9/8i/a-/x98ia-rs9owg6hl2qqkfjpza-yg.png"></p><br><p>  (6) Y la mayor√≠a de la basura y el desperdicio: fue la b√∫squeda el√°stica.  Porque era una versi√≥n antigua.  Porque no ten√≠amos maestros dedicados en ese momento.  Ten√≠amos registros heterog√©neos en los que los campos pod√≠an cruzarse.  Se podr√≠an escribir diferentes registros de diferentes aplicaciones con los mismos nombres de campo, pero al mismo tiempo podr√≠a haber diferentes datos en su interior.  Es decir, un registro viene con Integer en el campo, por ejemplo, nivel.  Otro registro viene con String en el campo de nivel.  En ausencia de mapeo est√°tico, se obtiene algo tan maravilloso.  Si, despu√©s de la rotaci√≥n del √≠ndice en elasticsearch, llega el primer mensaje con una cadena, entonces vivimos normalmente.  Y si lleg√≥ primero con Integer, entonces todos los mensajes posteriores que llegaron con String simplemente se descartan.  Porque el tipo de campo no coincide. </p><br><p><img src="https://habrastorage.org/webt/c9/ym/lq/c9ymlqxv89qg1oohi-lnhknyedg.png"></p><br><p>  Comenzamos a hacer estas preguntas.  Decidimos no buscar al culpable. </p><br><p><img src="https://habrastorage.org/webt/fl/r1/kv/flr1kvyks_o2kdciv4pekiwtbiy.png"></p><br><p>  ¬°Pero hay que hacer algo!  Lo obvio es establecer est√°ndares.  Ya ten√≠amos algunos est√°ndares.  Algunos los conseguimos un poco m√°s tarde.  Afortunadamente, un formato de registro uniforme para todas las API ya estaba aprobado en ese momento.  Est√° escrito directamente en los est√°ndares para la interacci√≥n de servicios.  En consecuencia, aquellos que quieran recibir registros deben escribirlos en este formato.  Si alguien no escribe registros en este formato, no garantizamos nada. </p><br><p>  Adem√°s, me gustar√≠a establecer un est√°ndar √∫nico para los m√©todos de grabaci√≥n, entrega y recolecci√≥n de registros.  En realidad, d√≥nde escribirlos y c√≥mo entregarlos.  La situaci√≥n ideal es cuando los proyectos usan la misma biblioteca.  Aqu√≠ hay una biblioteca de registro separada para Go, hay una biblioteca separada para PHP.  Todos los que tenemos, todos deber√≠an usarlos.  Por el momento, dir√≠a que lo conseguimos en un 80 por ciento.  Pero algunos contin√∫an comiendo cactus. </p><br><p>  Y all√≠ (en la diapositiva) apenas apareci√≥ "SLA para la entrega de registros".  Todav√≠a no est√° all√≠, pero estamos trabajando en ello.  Porque es muy conveniente cuando el infra dice que si escribe en tal y tal formato en tal y tal lugar y no m√°s de N mensajes por segundo, entonces es probable que entreguemos tal y tal cosa all√≠.  Esto alivia un mont√≥n de dolores de cabeza.  Si hay un SLA, ¬°esto es simplemente maravilloso! </p><br><p><img src="https://habrastorage.org/webt/im/aq/aj/imaqajo2oi-qoyb--oja3i2fnyy.png"></p><br><p>  ¬øC√≥mo comenzamos a resolver el problema?  El rastrillo principal fue con td-agent.  No estaba claro a d√≥nde iban los registros.  ¬øSe entregan?  Van a?  ¬øD√≥nde est√°n en absoluto?  Por lo tanto, el primer elemento se decidi√≥ reemplazar td-agent.  Esboc√© brevemente las opciones con las que reemplazarlo. </p><br><p>  Fluido  En primer lugar, me encontr√© con √©l en un trabajo anterior, y √©l tambi√©n cay√≥ all√≠ peri√≥dicamente.  En segundo lugar, esto es lo mismo, solo en el perfil. </p><br><p>  Filebeat.  ¬øC√≥mo fue conveniente para nosotros?  El hecho de que √©l est√° en Go, y tenemos mucha experiencia en Go.  En consecuencia, si eso, de alguna manera podr√≠amos agregarlo por nosotros mismos.  Por lo tanto, no lo tomamos.  De modo que incluso ninguna tentaci√≥n fue comenzar a reescribirlo por ti mismo. </p><br><p>  La soluci√≥n obvia para el administrador del sistema es todos los registros del sistema en esta cantidad (syslog-ng / rsyslog / nxlog). </p><br><p>  O escribimos algo propio, pero lo dejamos caer, al igual que filebeat.  Si escribe algo, es mejor escribir algo √∫til para los negocios.  Para la entrega de registros es mejor llevar algo listo. </p><br><p>  Por lo tanto, la elecci√≥n en realidad se redujo a la elecci√≥n entre syslog-ng y rsyslog.  Se inclin√≥ hacia rsyslog simplemente porque ya ten√≠amos clases para rsyslog en Puppet, y no encontr√© ninguna diferencia obvia entre ellos.  Qu√© es syslog, qu√© es syslog.  S√≠, alguien tiene peor documentaci√≥n, alguien tiene mejor.  √âl sabe c√≥mo y √©l, de una manera diferente. </p><br><p><img src="https://habrastorage.org/webt/xl/wg/7y/xlwg7yv4du2k8ktumnmdltwci78.png"></p><br><p>  Y un poco sobre rsyslog.  En primer lugar, es genial porque tiene muchos m√≥dulos.  Tiene RainerScript legible por humanos (un lenguaje de configuraci√≥n moderno).  Una ventaja incre√≠ble es que podr√≠amos emular el comportamiento de td-agent utilizando sus medios habituales, y nada ha cambiado para las aplicaciones.  Es decir, estamos cambiando td-agent a rsyslog, pero no estamos tocando todo lo dem√°s.  E inmediatamente recibimos una entrega de trabajo.  A continuaci√≥n, mmnormalize es algo incre√≠ble en rsyslog.  Le permite analizar registros, pero no usar Grok y regexp.  Ella hace un √°rbol de sintaxis abstracta.  Analiza los registros aproximadamente, como el compilador analiza los c√≥digos fuente.  Esto le permite trabajar muy r√°pido, comer poca CPU y, en general, es algo muy bueno.  Hay toneladas de otras bonificaciones.  No me detendr√© sobre ellos. </p><br><p><img src="https://habrastorage.org/webt/tf/6w/c0/tf6wc0eulg65fu-dy64mmkjyr4g.png"></p><br><p>  Rsyslog todav√≠a tiene muchos defectos.  Son casi lo mismo que los bonos.  Los principales problemas: necesita poder cocinarlo y debe seleccionar la versi√≥n. </p><br><p><img src="https://habrastorage.org/webt/p-/2l/l5/p-2ll5-sxmfivl2136kopu1oipi.png"></p><br><p>  Decidimos que escribir√≠amos registros en el socket Unix.  Y no en / dev / log, porque all√≠ tenemos gachas de ave de los registros del sistema, hay un diario en esta tuber√≠a.  As√≠ que vamos a escribir en un socket personalizado.  Lo adjuntamos a un conjunto de reglas separado.  No vamos a interferir  Todo ser√° transparente y claro.  As√≠ que en realidad lo hicimos.  El directorio con estos sockets est√° estandarizado y se reenv√≠a a todos los contenedores.  Los contenedores pueden ver el socket que necesitan, abrirlo y escribirlo. </p><br><p>  ¬øPor qu√© no un archivo?  Porque todos leyeron <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">un art√≠culo sobre Badushechka</a> que intent√≥ reenviar el archivo a Docker, y result√≥ que despu√©s de que rsyslog reiniciara, el descriptor de archivo cambia y Docker pierde este archivo.  Mantiene abierto algo m√°s, pero no el mismo z√≥calo donde escriben.  Decidimos que pasar√≠amos por alto este problema y, al mismo tiempo, pasar√≠amos por alto el problema de bloqueo. </p><br><p><img src="https://habrastorage.org/webt/ri/kn/r9/riknr9odspcwgtmywqapeq1htmi.png"></p><br><p>  Rsyslog realiza las acciones indicadas en la diapositiva y env√≠a los registros al rel√© o a Kafka.  Kafka coincide con la vieja manera.  Retransmisi√≥n: intent√© usar rsyslog puro para entregar registros.  Sin Message Queue, herramientas est√°ndar de rsyslog.  B√°sicamente funciona. </p><br><p><img src="https://habrastorage.org/webt/wh/bl/fv/whblfvj4lnbmdryfev1fypctp74.png"></p><br><p>  Pero hay matices sobre c√≥mo incluirlos m√°s adelante en esta parte (Logstash / Graylog / ES).  Esta parte (rsyslog-rsyslog) se usa entre centros de datos.  Aqu√≠ hay un enlace tcp comprimido, que le permite ahorrar ancho de banda y, en consecuencia, de alguna manera aumentar la probabilidad de que recibamos alg√∫n tipo de registros de otro centro de datos en condiciones cuando el canal est√© lleno.  Porque tenemos a Indonesia, en la que todo est√° mal.  Aqu√≠ es donde est√° este problema constante. </p><br><p><img src="https://habrastorage.org/webt/zx/bx/gi/zxbxgimmd3xniduuuw0spq0vg1o.png"></p><br><p>  Pensamos en c√≥mo monitoreamos realmente, ¬øcon qu√© probabilidad llegan a ese fin los registros que registramos desde la aplicaci√≥n?  Decidimos obtener las m√©tricas.  Rsyslog tiene su propio m√≥dulo de recopilaci√≥n de estad√≠sticas, que tiene alg√∫n tipo de contadores.  Por ejemplo, puede mostrarle el tama√±o de la cola o cu√°ntos mensajes llegaron en dicha acci√≥n.  Ya se les puede quitar algo.  Adem√°s, tiene contadores personalizados que se pueden configurar y le mostrar√°, por ejemplo, la cantidad de mensajes que escribieron algunas API.  Luego, escrib√≠ rsyslog_exporter en Python, y lo enviamos todo a Prometheus y lo trazamos.  Las m√©tricas de Graylog realmente se quer√≠an, pero hasta ahora no hemos tenido tiempo de configurarlas. </p><br><p><img src="https://habrastorage.org/webt/kq/b0/-1/kqb0-1ox3sevtkje8qnb7ekp1is.png"></p><br><p>  Cuales son los problemas?  Surgieron problemas con el hecho de que descubrimos (¬°REPENTINAMENTE!) Que nuestras API en vivo escriben 50 mil mensajes por segundo.  Esta es solo una API en vivo sin puesta en escena.  Y Graylog nos muestra solo 12 mil mensajes por segundo.  Y surgi√≥ una pregunta razonable, pero ¬ød√≥nde est√°n las sobras?  De lo cual concluimos que Graylog simplemente no puede hacer frente.  Miraron y, de hecho, Graylog con Elasticsearch no domin√≥ esta corriente. </p><br><p>  Adem√°s, otros descubrimientos que hicimos en el proceso. </p><br><p>  Escribir en el socket est√°n bloqueados.  ¬øC√≥mo sucedi√≥ esto?  Cuando utilic√© rsyslog para la entrega, en alg√∫n momento nuestro canal entre los centros de datos se rompi√≥.  La entrega se levant√≥ en un lugar, la entrega se levant√≥ en otro lugar.  Todo esto ha llegado a una m√°quina con API que escriben en el socket rsyslog.  Hab√≠a una cola  Luego se complet√≥ la cola para escribir en el socket de Unix, que por defecto es de 128 paquetes.  Y el siguiente write () en la aplicaci√≥n est√° bloqueado.  Cuando miramos la biblioteca que usamos en las aplicaciones en Go, se escribi√≥ all√≠ que la escritura en el socket ocurre en modo sin bloqueo.  Est√°bamos seguros de que nada est√° bloqueando.  Porque leemos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">un art√≠culo sobre Badushechka</a> que escribi√≥ al respecto.  Pero hay un momento.  Alrededor de esta llamada todav√≠a hab√≠a un ciclo interminable en el que se hac√≠a un intento constante de insertar el mensaje en el socket.  No lo notamos.  Tuve que reescribir la biblioteca.  Desde entonces, ha cambiado varias veces, pero ahora hemos eliminado los bloqueos en todos los subsistemas.  Por lo tanto, puede detener rsyslog y nada caer√°. </p><br><p>  Es necesario controlar el tama√±o de las colas, lo que ayuda a no pisar este rastrillo.  Primero, podemos monitorear cuando comenzamos a perder mensajes.  En segundo lugar, podemos controlar que, en principio, tenemos problemas de entrega. </p><br><p>  Y otro momento desagradable - amplificaci√≥n 10 veces en arquitectura de microservicio - es muy f√°cil.  No tenemos muchas solicitudes entrantes, pero debido al gr√°fico que atraviesan estos mensajes, debido a los registros de acceso, realmente aumentamos la carga en los registros aproximadamente una vez cada diez.  Lamentablemente, no tuve tiempo para calcular los n√∫meros exactos, pero s√≠ los microservicios.  Esto debe tenerse en cuenta.  Resulta que en este momento el subsistema de recopilaci√≥n de registros es el m√°s cargado en Lazada. </p><br><p><img src="https://habrastorage.org/webt/6a/fd/mi/6afdmitt6iid3yqd6cmdgq8_lkq.png"></p><br><p>  ¬øC√≥mo resolver el problema de Elasticsearch?  Si necesita obtener r√°pidamente los registros en un solo lugar, para no ejecutarlos en todas las m√°quinas y no recopilarlos all√≠, use el almacenamiento de archivos.  Esto est√° garantizado para trabajar.  Est√° hecho desde cualquier servidor.  Solo necesita pegar los discos all√≠ y colocar syslog.  Despu√©s de eso, tiene la garant√≠a de tener todos los registros en un solo lugar.  Adem√°s, ya ser√° posible ajustar lentamente Elasticsearch, Graylog, algo m√°s.  Pero ya tendr√° todos los registros y, adem√°s, puede almacenarlos en una cantidad suficiente de matrices de discos. </p><br><p><img src="https://habrastorage.org/webt/cx/1d/g3/cx1dg33kkvufonoxpwrrpmmabza.png"></p><br><p>  En el momento de mi informe, el circuito comenz√≥ a verse as√≠.  Pr√°cticamente dejamos de escribir en el archivo.  Ahora, muy probablemente, apagaremos las sobras.  En las m√°quinas locales que ejecutan la API, dejaremos de escribir en archivos.  En primer lugar, hay un almacenamiento de archivos que funciona muy bien.  En segundo lugar, el lugar en estas m√°quinas se agota constantemente, es necesario controlarlo constantemente. </p><br><p>  Esta parte con Logstash y Graylog, realmente se dispara.  Por lo tanto, debemos deshacernos de √©l.  Tienes que elegir una cosa. </p><br><p><img src="https://habrastorage.org/webt/w4/bj/po/w4bjpoxgbdggewegwtrg1ao9mpi.png"></p><br><p>  Decidimos lanzar Logstash y Kibana.  Porque tenemos un departamento de seguridad.  ¬øCu√°l es la conexi√≥n?  La conexi√≥n es que Kibana sin X-Pack y sin Shield no permite diferenciar los derechos de acceso a los registros.  Por lo tanto, tomaron Graylog.  El lo tiene todo.  No me gusta, pero funciona.  Compramos hierro nuevo, pusimos Graylog fresco all√≠ y movimos todos los registros con formatos estrictos a un Graylog separado.  Resolvimos el problema con diferentes tipos de campos id√©nticos organizacionalmente. </p><br><p><img src="https://habrastorage.org/webt/cn/hr/41/cnhr41tyx4sf0c0skbjqrgbyb90.png"></p><br><p>  Qu√© se incluye exactamente en el nuevo Graylog.  Acabamos de grabar todo en la ventana acoplable.  Tomamos un mont√≥n de servidores, implementamos tres instancias de Kafka, 7 servidores Graylog versi√≥n 2.3 (porque quer√≠a Elasticsearch versi√≥n 5).  Todo esto en las redadas del disco duro planteado.  Vimos una tasa de indexaci√≥n de hasta 100 mil mensajes por segundo.  Vimos la cifra de 140 terabytes de datos por semana. </p><br><p><img src="https://habrastorage.org/webt/wv/yd/yj/wvydyj9d_mfo3xztj9elcbvpdaa.png"></p><br><p>  Y de nuevo un rastrillo!  Se acercan dos ventas.  Nos hemos movido por 6 millones de mensajes.  A nosotros Graylog no tiene tiempo para masticar.  De alguna manera tenemos que sobrevivir de nuevo. </p><br><p><img src="https://habrastorage.org/webt/xf/2j/lc/xf2jlclf52i3oi3nsxdksth-xpe.png"></p><br><p>  Sobrevivimos as√≠.  Agregamos algunos servidores y SSD m√°s.  Por el momento, vivimos de esta manera.  Ahora ya estamos masticando 160k mensajes por segundo.  Todav√≠a no hemos alcanzado el l√≠mite, por lo que a√∫n no est√° claro cu√°nto podemos realmente sacar de esto. </p><br><p><img src="https://habrastorage.org/webt/bn/ck/ss/bnckssznjbmcrm7v4zh7yhgoltw.png"></p><br><p>  Estos son nuestros planes para el futuro.  De estos, realmente, el m√°s importante es probablemente la alta disponibilidad.  A√∫n no lo tenemos.  Varios autom√≥viles est√°n configurados de la misma manera, pero hasta ahora todo pasa por un solo autom√≥vil.   ,   failover  . </p><br><p>    Graylog. </p><br><p>  rate limit    ,    API,    bandwidth   . </p><br><p>  ,  - SLA c ,      .    ,  . </p><br><p>   . </p><br><p><img src="https://habrastorage.org/webt/cc/hr/az/cchrazzrhareykxd78meljitrso.png"></p><br><p> ,  ,   . -, . -, syslog ‚Äî . -, rsyslog    ,    .     . </p><br><p> <strong></strong> . </p><br><p> <strong></strong> :  -   ‚Ä¶ (filebeat?) </p><br><p> <strong></strong> :    .   .    API     ,        ,      .    pipe.     : ¬´   ,     , ¬ª?    ,   ,  : ¬´ ,      ¬ª. </p><br><p> <strong></strong> :        HDFS? </p><br><p> <strong></strong> :   .      , , ,       ,       long term solution. </p><br><p> <strong></strong> :      . </p><br><p> <strong></strong> :   .  ""  . </p><br><p> <strong></strong> :    rsyslog.    TCP,  UDP.   UDP,      ? </p><br><p> <strong></strong> :   . ,    ,      .  ,     : ¬´       ,      -   ,  - ¬ª,    ¬´!        ,     ,          ,       .¬ª         .    ,     ?        ,     ?   best effort.           ,     100% .       .       . </p><br><p> <strong></strong> :  API  -       ,       ,         ? -   . </p><br><p> <strong></strong> :  ,      .     .         ,       .    ,   API     .   rsyslog    .   API    ,     ,    timestamp      .      Graylog,      timestamp.    . </p><br><p> <strong></strong> : Timestamp    . </p><br><p> <strong></strong> : Timestamp   API.  , ,  .    NTP. API  timestamp    .   rsyslog . </p><br><p> <strong></strong> :      .       , .     ?      ? </p><br><p> <strong></strong> : .       -  .       ,        .     .     Log Relay.  Rsyslog .      .   .         .    .        .   ,       (),       Graylog.        storage.  ,     ,     .   .    . </p><br><p> <strong></strong> :       ? </p><br><p> <strong></strong> :    (  )  . </p><br><p> <strong></strong> :    ,     ? </p><br><p> <strong></strong> :      ,    .    .  ,   Go API,  .   ,        socket.       .   .        socket.   ,    .      .     ,    .      prometheus,   Grafana   .   .   ,   . </p><br><p> <strong></strong> :  elasticsearch     .    ? </p><br><p> <strong></strong> :  . </p><br><p> <strong></strong> :    ? </p><br><p> <strong></strong> :    .     . </p><br><p> <strong></strong> :   rsyslog  - ? </p><br><p> <strong></strong> :      unix socket.       128 .       .     .     ,   128 . , , ,   ,   .        ,          .         . </p><br><p> <strong>c</strong> :     JSON? </p><br><p> <strong></strong> :  JSON      relay,     .    Graylog,     JSON .    ,   ,       rsyslog.      issue,     . </p><br><p> <strong>c</strong> :  Kafka?   RabbitMQ?   Graylog   ? </p><br><p> <strong></strong> :    Graylog  .  Graylog   .    .   . ,   ,   .      rsyslog   elasticsearch    Kibana.      .     ,    Graylog    Kibana. Logstash    .  ,        rsyslog.         elasticsearch.  Graylog   - .     .       . </p><br><p>  Kafka.   .   ,   ,      .          .   ,  ,    .  RabbitMQ‚Ä¶     c RabbitMQ.  RabbitMQ   .     ,     .      ,     .           .    . Graylog    AMQP 0.9,  rsyslog    AMQP 1.0.     ,     ,  .     .      Kafka.     .   omkafka   rsyslog,   ,      ,     rsyslog.     . </p><br><p> <strong>Pregunta</strong> : ¬øUtiliza Kafka porque lo ten√≠a?  ¬øNo se usa para ning√∫n otro prop√≥sito? </p><br><p>  <strong>Respuesta</strong> : Kafka, que fue utilizada por el equipo de Data Science.  Este es un proyecto completamente separado, sobre el cual, desafortunadamente, no puedo decir nada.  No lo se.  Fue dirigida por el equipo de Data Science.  Cuando comenzaron los registros, decidieron usarlo, para no poner los suyos.  Ahora hemos actualizado Graylog y hemos perdido la compatibilidad, porque hay una versi√≥n antigua de Kafka.  Ten√≠amos que conseguir el nuestro.  Al mismo tiempo, eliminamos estos cuatro temas para cada API.  Hicimos un tema amplio para todo en vivo, un tema amplio para toda la puesta en escena y simplemente vi√±etas todo all√≠.  Graylog rastrilla todo esto en paralelo. </p><br><p>  <strong>Pregunta</strong> : ¬øPor qu√© es necesario este chamanismo con enchufes?  ¬øHas intentado usar el controlador de registro syslog para contenedores? </p><br><p>  <strong>Respuesta</strong> : En ese momento cuando hicimos esta pregunta, tuvimos una relaci√≥n tensa con el acoplador.  Fue docker 1.0 o 0.9.  Docker en s√≠ era extra√±o.  En segundo lugar, si tambi√©n empujas los registros en √©l ... Tengo una sospecha no verificada de que √©l pasa todos los registros a trav√©s de s√≠ mismo, a trav√©s del demonio acoplable.  Si tenemos una API que se est√° volviendo loca, entonces el resto de las API est√°n estancadas en el hecho de que no pueden enviar stdout y stderr.  No s√© a d√≥nde llevar√° esto.  Tengo la sospecha a nivel de sensaci√≥n de que no necesita utilizar el controlador syslog de Docker en este lugar.  Nuestro departamento de pruebas funcionales tiene su propio cl√∫ster Graylog con registros.  Usan controladores de registro de Docker y todo parece estar bien all√≠.  Pero inmediatamente escriben GELF a Graylog.  En ese momento, cuando todo esto estaba en marcha, lo necesit√°bamos para funcionar.  Quiz√°s m√°s tarde, cuando alguien venga y diga que ha estado funcionando normalmente durante cien a√±os, lo intentaremos. </p><br><p>  <strong>Pregunta</strong> : Realiza entregas entre centros de datos en rsyslog.  ¬øPor qu√© no en Kafka? </p><br><p>  <strong>Respuesta</strong> : Estamos haciendo ambas cosas, y as√≠ en realidad.  Por dos razones  Si el canal est√° completamente muerto, entonces tenemos todos los registros, incluso en forma comprimida, no se arrastrar√°n a trav√©s de √©l.  Y kafka les permite simplemente perderse en el proceso.  De esta forma nos deshacemos de pegar estos registros.  Simplemente usamos Kafka en este caso directamente.  Si tenemos un buen canal y queremos liberarlo, entonces usamos su rsyslog.  Pero, de hecho, puede configurarlo para que √©l mismo descarte lo que no se arrastr√≥.  Por el momento, estamos en alg√∫n lugar utilizando la entrega de rsyslog directamente, en alg√∫n lugar de Kafka. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/450098/">https://habr.com/ru/post/450098/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../450088/index.html">C√≥mo dibujo ilustraciones para res√∫menes matem√°ticos en Inkscape</a></li>
<li><a href="../450090/index.html">Noticias del mundo de OpenStreetMap No. 457 (16.04.2019-22.04.2019)</a></li>
<li><a href="../450092/index.html">Qu√© es qu√© y qui√©n es qui√©n en el mercado de protecci√≥n DDoS</a></li>
<li><a href="../450094/index.html">Caf√© solar: aumenta la eficiencia de las c√©lulas solares debido a la cafe√≠na</a></li>
<li><a href="../450096/index.html">Inodoro autom√°tico para gatos</a></li>
<li><a href="../450100/index.html">Generaci√≥n de c√≥digo para el backend. ¬øQu√© generar, c√≥mo y por qu√©?</a></li>
<li><a href="../450102/index.html">Reloj autoajustable con pantalla electr√≥nica.</a></li>
<li><a href="../450104/index.html">Muy dif√≠cil y muy interesante: comunidades de TI en TechTrain</a></li>
<li><a href="../450106/index.html">El proyecto de la organizaci√≥n de construcci√≥n y reconstrucci√≥n en condiciones de hacinamiento en el sitio de construcci√≥n SPDS</a></li>
<li><a href="../450110/index.html">Patentes de dise√±o: segunda parte (ejemplos de Microsoft, Snapchat, Samsung, Netflix, Airbnb, Tinder)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>