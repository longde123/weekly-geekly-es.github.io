<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ¤¥ ğŸ¤²ğŸ» ğŸ’ å½“â€œ aâ€ä¸ç­‰äºâ€œ aâ€æ—¶ã€‚ åœ¨ä¸€æ¬¡é»‘å®¢è¢­å‡»ä¹‹å ğŸ‘â€ğŸ—¨ ğŸ’…ğŸ½ â™Ÿï¸</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="æˆ‘çš„ä¸€ä¸ªæœ‹å‹å‘ç”Ÿäº†ä¸€ä¸ªä¸æ„‰å¿«çš„æ•…äº‹ã€‚ ä½†æ˜¯ï¼Œå¯¹äºç±³å“ˆä¼Šå°”æ¥è¯´ï¼Œè¿™çœŸæ˜¯ä»¤äººä¸å¿«ï¼Œä½†å¯¹æˆ‘æ¥è¯´ä¹Ÿå¾ˆæœ‰è¶£ã€‚ 

 æˆ‘å¿…é¡»è¯´ï¼Œæˆ‘çš„æœ‹å‹æ˜¯ä¸€ä¸ªUNIXç”¨æˆ·ï¼šä»–å¯ä»¥è‡ªå·±å®‰è£…ç³»ç»Ÿï¼Œå®‰è£…mysqlå’Œphpå¹¶è¿›è¡Œæœ€ç®€å•çš„nginxè®¾ç½®ã€‚ 
 ä»–æœ‰åäºŒä¸ªä¸“é—¨ä»äº‹å»ºç­‘å·¥å…·çš„ç½‘ç«™ã€‚ 

 è¿™äº›ä¸“ç”¨äºç”µé”¯çš„ç½‘ç«™ä¹‹ä¸€ä½äºTOPæœ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>å½“â€œ aâ€ä¸ç­‰äºâ€œ aâ€æ—¶ã€‚ åœ¨ä¸€æ¬¡é»‘å®¢è¢­å‡»ä¹‹å</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/465355/"> æˆ‘çš„ä¸€ä¸ªæœ‹å‹å‘ç”Ÿäº†ä¸€ä¸ªä¸æ„‰å¿«çš„æ•…äº‹ã€‚ ä½†æ˜¯ï¼Œå¯¹äºç±³å“ˆä¼Šå°”æ¥è¯´ï¼Œè¿™çœŸæ˜¯ä»¤äººä¸å¿«ï¼Œä½†å¯¹æˆ‘æ¥è¯´ä¹Ÿå¾ˆæœ‰è¶£ã€‚ <br><br> æˆ‘å¿…é¡»è¯´ï¼Œæˆ‘çš„æœ‹å‹æ˜¯ä¸€ä¸ª<i>UNIX</i>ç”¨æˆ·ï¼šä»–å¯ä»¥è‡ªå·±å®‰è£…ç³»ç»Ÿï¼Œå®‰è£…<i>mysql</i>å’Œ<i>php</i>å¹¶è¿›è¡Œæœ€ç®€å•çš„<i>nginx</i>è®¾ç½®ã€‚ <br> ä»–æœ‰åäºŒä¸ªä¸“é—¨ä»äº‹å»ºç­‘å·¥å…·çš„ç½‘ç«™ã€‚ <br><br> è¿™äº›ä¸“ç”¨äºç”µé”¯çš„ç½‘ç«™ä¹‹ä¸€ä½äºTOPæœç´¢å¼•æ“ä¸­ã€‚ è¯¥ç½‘ç«™æ˜¯éè¥åˆ©æ€§è¯„è®ºè€…ï¼Œä½†æœ‰äººç¢°åˆ°ä»–çš„å–‰å’™å¹¶è¢­å‡»äº†ä»–ã€‚ è¦ä¹ˆ<i>DDoS</i> ï¼Œç„¶åæ˜¯è›®åŠ›ï¼Œç„¶åè¯„è®ºå°†å‘è¡¨æ·«ç§½å†…å®¹ï¼Œå¹¶å°†æ»¥ç”¨è¡Œä¸ºå‘é€ç»™æ‰˜ç®¡æœåŠ¡å™¨å’ŒILVã€‚ <br> çªç„¶ï¼Œä¸€åˆ‡éƒ½å¹³é™ä¸‹æ¥äº†ï¼Œè¿™ç§å¹³é™å¹¶ä¸ç¾å¥½ï¼Œè¯¥ç«™ç‚¹å¼€å§‹é€æ¸ç¦»å¼€ç»“æœçš„é¡¶ç«¯ã€‚ <br><br><img src="https://habrastorage.org/getpro/habr/post_images/528/5d5/582/5285d55827ddf5cb5705b364a417828f.png" alt="å›¾ç‰‡"><br><br> é‚£æ˜¯ä¸€å¥è¯ï¼Œç„¶åæ˜¯ç®¡ç†è‡ªè¡Œè½¦æœ¬èº«ã€‚ <br><br> ç”µè¯å“äº†ï¼Œæ—¶é—´å¿«è¦ç¡è§‰äº†ï¼šâ€œä¸‰äºšï¼Œæ‚¨ä¸ä¼šçœ‹æˆ‘çš„æœåŠ¡å™¨å—ï¼Ÿ åœ¨æˆ‘çœ‹æ¥ï¼Œä»–ä»¬ç æ­»äº†æˆ‘ï¼Œæˆ‘æ— æ³•è¯æ˜è¿™ä¸€ç‚¹ï¼Œä½†æ˜¯è¿™ç§æ„Ÿè§‰å¹¶æ²¡æœ‰ç¦»å¼€ç¬¬ä¸‰å‘¨ã€‚ ä¹Ÿè®¸æˆ‘åªéœ€è¦æ¥å—åæ‰§ç‹‚æ²»ç–—ï¼Ÿâ€ <br><a name="habracut"></a><br> æ¥ä¸‹æ¥æ˜¯ä¸€ä¸ªåŠå°æ—¶çš„è®¨è®ºï¼Œæ€»ç»“å¦‚ä¸‹ï¼š <br><br><ul><li> ç¹æ®–åœ°è‚¥æ²ƒã€‚ </li><li> ç ´è§£è€…å¯ä»¥è·å¾—è¶…çº§ç”¨æˆ·æƒé™ï¼› </li><li> æ”»å‡»ï¼ˆå¦‚æœå‘ç”Ÿï¼‰ä¸“é—¨é’ˆå¯¹æ­¤ç«™ç‚¹ï¼› </li><li> é—®é¢˜åŒºåŸŸæ˜¯å›ºå®šçš„ï¼Œæ‚¨åªéœ€è¦äº†è§£æ˜¯å¦å­˜åœ¨æ¸—é€äº‹å®ï¼› </li><li> é»‘å®¢æ— æ³•è§¦åŠç«™ç‚¹ä»£ç å’Œæ•°æ®åº“ã€‚ </li></ul><br> å…³äºæœ€åä¸€æ®µã€‚ <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f7f/a85/93d/f7fa8593d835c577dd321eec9e30e2e4.png" alt="å›¾ç‰‡"><br><br> åªæœ‰ç™½è‰²IPå‰ç«¯æ­£åœ¨å‘ä¸–ç•Œå±•ç¤ºã€‚ åç«¯å’Œå‰ç«¯ä¹‹é—´æ²¡æœ‰äº¤æ¢ï¼Œé™¤äº†httpï¼ˆsï¼‰ä¹‹å¤–ï¼Œç”¨æˆ·/å¯†ç ä¸åŒï¼Œå¯†é’¥ä¸äº¤æ¢ã€‚ åœ¨ç°è‰²åœ°å€ä¸Šï¼Œé™¤80/443ä»¥å¤–çš„æ‰€æœ‰ç«¯å£éƒ½å·²å…³é—­ã€‚ åªæœ‰è¿ˆå…‹å°”å®Œå…¨ä¿¡ä»»çš„ä¸¤ä¸ªç”¨æˆ·æ‰çŸ¥é“ç™½è‰²IPåç«¯ã€‚ <br><br>  <i>Debian 9</i>å®‰è£…åœ¨å‰ç«¯ï¼Œåœ¨é€šè¯æ—¶ï¼Œç³»ç»Ÿå·²é€šè¿‡å¤–éƒ¨é˜²ç«å¢™ä¸å¤–ç•Œéš”ç¦»å¹¶åœæ­¢äº†è¿è¡Œã€‚ <br><br>  â€œå¥½å§ï¼Œè¯·å…è®¸æˆ‘è¿›å…¥ã€‚â€æˆ‘å†³å®šå°†ç¡çœ æ—¶é—´æ¨è¿Ÿä¸€ä¸ªå°æ—¶ã€‚  â€œæˆ‘ä¼šäº²çœ¼çœ‹åˆ°ã€‚â€ <br><br> ä»¥ä¸‹ï¼š <br><br><pre><code class="plaintext hljs">$ grep -F PRETTY_NAME /etc/*releas* PRETTY_NAME="Debian GNU/Linux 9 (stretch)" $ `echo $SHELL` --version GNU bash, version 4.4.12(1)-release (x86_64-pc-linux-gnu) $ nginx -v nginx version: nginx/1.10.3 $ gdb --version GNU gdb (Debian 8.2.1-2) 8.2.1</code> </pre> <br><h2> å¯»æ‰¾å¯èƒ½çš„éª‡å®¢ </h2><br> æˆ‘é¦–å…ˆä»¥<i>æ•‘æ´æ¨¡å¼</i>å¯åŠ¨æœåŠ¡å™¨ã€‚ æˆ‘å®‰è£…ç£ç›˜ï¼Œç¿»é˜…èº«ä»½éªŒè¯ï¼Œ <i>å†å²è®°å½•</i> ï¼Œç³»ç»Ÿæ—¥å¿—ç­‰ï¼Œå¦‚æœå¯èƒ½ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶åˆ›å»ºæ—¥æœŸï¼Œå°½ç®¡æˆ‘çŸ¥é“æ­£å¸¸çš„ç ´è§£è€…ä¼šåœ¨ä»–èº«åâ€œå†’æ±—â€ï¼Œè€ŒMishaåœ¨æœå¯»è‡ªå·±æ—¶å·²ç»â€œè¸©è¸â€äº†ã€‚ <br><br> æˆ‘ä»æ™®é€šæ¨¡å¼å¼€å§‹ï¼Œå°¤å…¶æ˜¯åœ¨ä¸çŸ¥é“è¦å¯»æ‰¾ä»€ä¹ˆçš„åŒæ—¶ï¼Œæˆ‘æ­£åœ¨ç ”ç©¶é…ç½®ã€‚ ä»–ä¸»è¦å¯¹<i>nginx</i>æ„Ÿå…´è¶£ï¼Œå› ä¸ºä¸€èˆ¬è€Œè¨€ï¼Œå‰ç«¯æ²¡æœ‰å…¶ä»–ä¸œè¥¿ã€‚ <br> è¿™äº›é…ç½®å¾ˆå°ï¼Œç»“æ„åˆç†ï¼Œå¯ä»¥æ‰“åŒ…æˆåå‡ ä¸ªæ–‡ä»¶ï¼›æˆ‘åªæ˜¯é€šè¿‡<i>cat'</i>ä¾æ¬¡æµè§ˆå®ƒä»¬ã€‚ ä¸€åˆ‡ä¼¼ä¹éƒ½å¾ˆå¹²å‡€ï¼Œä½†æ˜¯æ‚¨æ°¸è¿œä¸ä¼šé”™è¿‡å…¶ä¸­çš„<i>include</i> ï¼Œæˆ‘å°†è¿›è¡Œå®Œæ•´åˆ—å‡ºï¼š <br><br><pre> <code class="plaintext hljs">$ nginx -T nginx: the configuration file /usr/local/etc/nginx/nginx.conf syntax is ok nginx: configuration file /usr/local/etc/nginx/nginx.conf test is successful</code> </pre><br> æˆ‘ä¸æ˜ç™½ï¼šâ€œå•†å®¶ä¿¡æ¯åœ¨å“ªé‡Œï¼Ÿâ€ <br><br><pre> <code class="plaintext hljs">$ nginx -V nginx version: nginx/1.10.3 TLS SNI support enabled configure arguments: --with-cc-opt='-g -O2' --with-ld-opt='-Wl,-z,relro -Wl,-z,now' --prefix=/usr/share/nginx --conf-path=/etc/nginx/nginx.conf --http-log-path=/var/log/nginx/access.log --error-log-path=/var/log/nginx/error.log --lock-path=/var/lock/nginx.lock --pid-path=/run/nginx.pid --modules-path=/usr/lib/nginx/modules --http-client-body-temp-path=/var/lib/nginx/body --http-fastcgi-temp-path=/var/lib/nginx/fastcgi --http-proxy-temp-path=/var/lib/nginx/proxy --http-scgi-temp-path=/var/lib/nginx/scgi --http-uwsgi-temp-path=/var/lib/nginx/uwsgi --with-debug --with-pcre-jit --with-ipv6 --with-http_ssl_module --with-http_stub_status_module --with-http_realip_module --with-http_auth_request_module --with-http_v2_module --with-http_dav_module --with-http_slice_module --with-threads --with-http_addition_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_sub_module --with-stream=dynamic --with-stream_ssl_module --with-mail=dynamic --with-mail_ssl_module</code> </pre><br> ç¬¬äºŒä¸ªæ·»åŠ åˆ°åˆ—è¡¨é—®é¢˜ä¸­ï¼šâ€œä¸ºä»€ä¹ˆè¦ä½¿ç”¨è¿™ä¹ˆå¤è€çš„nginxç‰ˆæœ¬ï¼Ÿâ€ <br><br> æ­¤å¤–ï¼Œç³»ç»Ÿè®¤ä¸ºè¯¥ç‰ˆæœ¬æ˜¯å…¨æ–°å®‰è£…çš„ï¼š <br><br><pre> <code class="plaintext hljs">$ dpkg -l nginx | grep "[n]ginx" ii nginx 1.14.2-2+deb10u1 all small, powerful, scalable web/proxy server</code> </pre><br> æˆ‘åœ¨æ‰“ç”µè¯ï¼š <br>  -Mishaï¼Œæ‚¨ä¸ºä»€ä¹ˆè¦é‡å»º<i>nginx</i> ï¼Ÿ <br>  -å¥½çš„ï¼Œæˆ‘ä»€è‡³ä¸çŸ¥é“è¯¥æ€ä¹ˆåšï¼ <br>  -å¥½å§ï¼Œç¡å§... <br><br>  <i>Nginxè¿›è¡Œäº†</i>æ˜ç¡®çš„é‡ç»„ï¼Œå¹¶ä¸”å‡ºäºæŸç§åŸå› éšè—äº†â€œ -Tâ€çš„åˆ—è¡¨ã€‚ æ¯«æ— ç–‘é—®ï¼Œé»‘å®¢æ”»å‡»æ˜¯å¯ä»¥æ¥å—çš„ï¼Œå¹¶ä¸”ï¼ˆå› ä¸ºMishaå§‹ç»ˆç”¨æ–°æœåŠ¡å™¨æ›¿æ¢äº†æœåŠ¡å™¨ï¼‰ï¼Œè¯·è€ƒè™‘å·²è§£å†³çš„é—®é¢˜ã€‚ <br><br> ç¡®å®ï¼Œç”±äºæŸäººè·å¾—äº†<i>rootç‰¹æƒ</i> ï¼Œå› æ­¤ä»…<i>é‡æ–°å®‰è£…ç³»ç»Ÿ</i>å¹¶æŸ¥æ‰¾åœ¨é‚£é‡Œæ¶ˆè€—å¾ˆå°‘çš„ä¸œè¥¿æ˜¯æœ‰æ„ä¹‰çš„ï¼Œä½†æ˜¯è¿™æ¬¡å¥½å¥‡å¿ƒå‡»è´¥äº†æ¢¦æƒ³ã€‚ å¦‚ä½•æ‰¾å‡ºä»–ä»¬æƒ³å¯¹æˆ‘ä»¬éšè—çš„ä¸œè¥¿ï¼Ÿ <br><br> è®©æˆ‘ä»¬å°è¯•è·Ÿè¸ªï¼š <br><br><pre> <code class="plaintext hljs">$ strace nginx -T</code> </pre><br> æˆ‘ä»¬çœ‹ç©¿çš„ç—•è¿¹æ˜¾ç„¶æ˜¯è¡Œæ•°ä¸å¤Ÿå•¦ <br><br><pre> <code class="plaintext hljs">write(1, "/etc/nginx/nginx.conf", 21/etc/nginx/nginx.conf) = 21 write(1, "... write(1, "\n", 1</code> </pre><br> ä¸ºäº†å¥½ç©ï¼Œæ¯”è¾ƒç»“è®º <br><br><pre> <code class="plaintext hljs">$ strace nginx -T 2&gt;&amp;1 | wc -l 264 $ strace nginx -t 2&gt;&amp;1 | wc -l 264</code> </pre><br> æˆ‘è®¤ä¸ºä»£ç çš„ä¸€éƒ¨åˆ†<i>/src/core/nginx.c</i> <br><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'t'</span></span>: ngx_test_config = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'T'</span></span>: ngx_test_config = <span class="hljs-number"><span class="hljs-number">1</span></span>; ngx_dump_config = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;</code> </pre><br> ç®€åŒ–ä¸ºä»¥ä¸‹å½¢å¼ï¼š <br><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'t'</span></span>: ngx_test_config = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'T'</span></span>: ngx_test_config = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-comment"><span class="hljs-comment">//ngx_dump_config = 1; break;</span></span></code> </pre><br> æˆ– <br><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'t'</span></span>: ngx_test_config = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'T'</span></span>: ngx_test_config = <span class="hljs-number"><span class="hljs-number">1</span></span>; ngx_dump_config = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;</code> </pre><br> å› æ­¤ï¼Œä¸ä¼šæ˜¾ç¤ºæŒ‰-Tåˆ—å‡ºã€‚ <br><br><h2> ä½†æ˜¯å¦‚ä½•æŸ¥çœ‹æˆ‘ä»¬çš„é…ç½®ï¼Ÿ </h2><br> å¦‚æœæˆ‘çš„æƒ³æ³•æ˜¯æ­£ç¡®çš„ï¼Œå¹¶ä¸”é—®é¢˜ä»…å­˜åœ¨äºå˜é‡<i>ngx_dump_configä¸­ï¼Œ</i>æˆ‘ä»¬å°†å°è¯•ä½¿ç”¨<i>gdb</i>è¿›è¡Œå®‰è£…ï¼Œå› ä¸ºå­˜åœ¨å¯†é’¥<i>--with-cc-opt</i> <i>-g</i> ï¼Œå¹¶ä¸”æˆ‘ä»¬å¸Œæœ›ä¼˜åŒ–<i>-O2</i>ä¸ä¼šå¯¹æˆ‘ä»¬é€ æˆä¼¤å®³ã€‚ åŒæ—¶ï¼Œç”±äºæˆ‘ä¸çŸ¥é“åœ¨<i>'T'ï¼šæƒ…å†µä¸‹</i>å¦‚ä½•å¤„ç†<i>ngx_dump_config</i> <i>ï¼Œå› æ­¤</i>æˆ‘ä»¬ä¸ä¼šè°ƒç”¨æ­¤å—ï¼Œè€Œæ˜¯ä½¿ç”¨<i>æ¡ˆä¾‹'t'è¿›è¡Œ</i>å®‰è£…<i>ï¼š</i> <br><br><div class="spoiler">  <b class="spoiler_title">ä¸ºä»€ä¹ˆæˆ‘å¯ä»¥åŒæ—¶ä½¿ç”¨â€œ -tâ€å’Œâ€œ -Tâ€</b> <div class="spoiler_text"> åœ¨<i>ifï¼ˆngx_test_configï¼‰</i>å†…éƒ¨å¤„ç†<i>ifï¼ˆngx_dump_configï¼‰</i>å—ï¼š <br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ngx_test_config) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!ngx_quiet_mode) { ngx_log_stderr(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"configuration file %s test is successful"</span></span>, cycle-&gt;conf_file.data); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ngx_dump_config) { cd = cycle-&gt;config_dump.elts; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; cycle-&gt;config_dump.nelts; i++) { ngx_write_stdout(<span class="hljs-string"><span class="hljs-string">"# configuration file "</span></span>); (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) ngx_write_fd(ngx_stdout, cd[i].name.data, cd[i].name.len); ngx_write_stdout(<span class="hljs-string"><span class="hljs-string">":"</span></span> NGX_LINEFEED); b = cd[i].buffer; (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) ngx_write_fd(ngx_stdout, b-&gt;pos, b-&gt;last - b-&gt;pos); ngx_write_stdout(NGX_LINEFEED); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre><br> å½“ç„¶ï¼Œå¦‚æœåœ¨æ­¤éƒ¨åˆ†ä¸­æ›´æ”¹äº†ä»£ç ï¼Œè€Œä¸æ˜¯<i>å¤§å°å†™â€œ Tâ€ ï¼šï¼Œ</i>é‚£ä¹ˆæˆ‘çš„æ–¹æ³•å°†ä¸èµ·ä½œç”¨ã€‚ <br></div></div><br><div class="spoiler">  <b class="spoiler_title">æµ‹è¯•nginx.conf</b> <div class="spoiler_text"> å·²ç»å‡­ç»éªŒè§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œå‘ç°å¯¹äºæ¶æ„è½¯ä»¶çš„æ“ä½œï¼Œéœ€è¦ä½¿ç”¨ä»¥ä¸‹å½¢å¼çš„æœ€å°<i>nginx</i>é…ç½®ï¼š <br><br><pre> <code class="nginx hljs"><span class="hljs-section"><span class="hljs-section">events</span></span> { } <span class="hljs-section"><span class="hljs-section">http</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">include</span></span> /etc/nginx/sites-enabled/*; }</code> </pre><br> ä¸ºäº†ç®€æ´èµ·è§ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨å®ƒã€‚ <br></div></div><br><div class="spoiler">  <b class="spoiler_title">è¿è¡Œè°ƒè¯•å™¨</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">$ gdb --silent --args nginx -t Reading symbols from nginx...done. (gdb) break main Breakpoint 1 at 0x1f390: file src/core/nginx.c, line 188. (gdb) run Starting program: nginx -t [Thread debugging using libthread_db enabled] Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1". Breakpoint 1, main (argc=2, argv=0x7fffffffebc8) at src/core/nginx.c:188 188 src/core/nginx.c: No such file or directory. (gdb) print ngx_dump_config=1 $1 = 1 (gdb) continue Continuing. nginx: the configuration file /etc/nginx/nginx.conf syntax is ok nginx: configuration file /etc/nginx/nginx.conf test is successful # configuration file /etc/nginx/nginx.conf: events { } http { map $http_user_agent $sign_user_agent { "~*yandex.com/bots" 1; "~*www.google.com/bot.html" 1; default 0; } map $uri $sign_uri { "~*/wp-" 1; default 0; } map :$sign_user_agent:$sign_uri $sign_o { :1:0 o; default ; } map :$sign_user_agent:$sign_uri $sign_a { :1:0 a; default ; } sub_filter_once off; sub_filter '' $sign_o; sub_filter '' $sign_a; include /etc/nginx/sites-enabled/*; } # configuration file /etc/nginx/sites-enabled/default: [Inferior 1 (process 32581) exited normally] (gdb) quit</code> </pre><br></div></div><br> æ­¥éª¤å¦‚ä¸‹ï¼š <br><br><ul><li> åœ¨<i>mainï¼ˆï¼‰</i>å‡½æ•°ä¸­è®¾ç½®ä¸€ä¸ªæ–­ç‚¹ </li><li> è¿è¡Œç¨‹åº </li><li> æ›´æ”¹å®šä¹‰<i>config</i>çš„è¾“å‡ºçš„å˜é‡çš„å€¼<i>ngx_dump_config = 1</i> </li><li> ç»§ç»­/ç»“æŸç¨‹åº </li></ul><br> å¦‚æ‚¨æ‰€è§ï¼Œå®é™…é…ç½®ä¸æˆ‘ä»¬çš„ä¸åŒï¼Œæˆ‘ä»¬ä»ä¸­é€‰æ‹©ä¸€ä¸ªè™šå‡çš„éƒ¨åˆ†ï¼š <br><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">map</span></span> <span class="hljs-variable"><span class="hljs-variable">$http_user_agent</span></span> <span class="hljs-variable"><span class="hljs-variable">$sign_user_agent</span></span> { "~*yandex.com/bots" 1; "~*www.google.com/bot.html" 1; <span class="hljs-attribute"><span class="hljs-attribute">default</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">map</span></span> <span class="hljs-variable"><span class="hljs-variable">$uri</span></span> <span class="hljs-variable"><span class="hljs-variable">$sign_uri</span></span> { "~*/wp-" 1; <span class="hljs-attribute"><span class="hljs-attribute">default</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">map</span></span> :<span class="hljs-variable"><span class="hljs-variable">$sign_user_agent</span></span>:<span class="hljs-variable"><span class="hljs-variable">$sign_uri</span></span> <span class="hljs-variable"><span class="hljs-variable">$sign_o</span></span> { :1:0 o; <span class="hljs-attribute"><span class="hljs-attribute">default</span></span> ; } <span class="hljs-attribute"><span class="hljs-attribute">map</span></span> :<span class="hljs-variable"><span class="hljs-variable">$sign_user_agent</span></span>:<span class="hljs-variable"><span class="hljs-variable">$sign_uri</span></span> <span class="hljs-variable"><span class="hljs-variable">$sign_a</span></span> { :1:0 a; <span class="hljs-attribute"><span class="hljs-attribute">default</span></span> ; } <span class="hljs-attribute"><span class="hljs-attribute">sub_filter_once</span></span> <span class="hljs-literal"><span class="hljs-literal">off</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">sub_filter</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-variable"><span class="hljs-variable">$sign_o</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">sub_filter</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-variable"><span class="hljs-variable">$sign_a</span></span>;</code> </pre><br> è®©æˆ‘ä»¬æŒ‰é¡ºåºè€ƒè™‘è¿™é‡Œå‘ç”Ÿäº†ä»€ä¹ˆã€‚ <br><br> ç”±<i>User-Agent</i>çš„yandex / googleå®šä¹‰ï¼š <br><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">map</span></span> <span class="hljs-variable"><span class="hljs-variable">$http_user_agent</span></span> <span class="hljs-variable"><span class="hljs-variable">$sign_user_agent</span></span> { "~*yandex.com/bots" 1; "~*www.google.com/bot.html" 1; <span class="hljs-attribute"><span class="hljs-attribute">default</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre><br>  WordPressæœåŠ¡é¡µé¢ä¸<i>åŒ…æ‹¬åœ¨å†…</i> ï¼š <br><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">map</span></span> <span class="hljs-variable"><span class="hljs-variable">$uri</span></span> <span class="hljs-variable"><span class="hljs-variable">$sign_uri</span></span> { "~*/wp-" 1; <span class="hljs-attribute"><span class="hljs-attribute">default</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre><br> å¯¹äºåŒæ—¶å±äºä¸Šè¿°ä¸¤ç§æƒ…å†µçš„äºº <br><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">map</span></span> :<span class="hljs-variable"><span class="hljs-variable">$sign_user_agent</span></span>:<span class="hljs-variable"><span class="hljs-variable">$sign_uri</span></span> <span class="hljs-variable"><span class="hljs-variable">$sign_o</span></span> { :1:0 o; <span class="hljs-attribute"><span class="hljs-attribute">default</span></span> ; } <span class="hljs-attribute"><span class="hljs-attribute">map</span></span> :<span class="hljs-variable"><span class="hljs-variable">$sign_user_agent</span></span>:<span class="hljs-variable"><span class="hljs-variable">$sign_uri</span></span> <span class="hljs-variable"><span class="hljs-variable">$sign_a</span></span> { :1:0 a; <span class="hljs-attribute"><span class="hljs-attribute">default</span></span> ; }</code> </pre><br> åœ¨<i>html</i>é¡µé¢çš„æ–‡æœ¬ä¸­ï¼Œå°†<i>'o'</i>æ›´æ”¹ä¸º<i>'o'</i> ï¼Œå°†<i>'a'</i>æ›´æ”¹ä¸º<i>'a'</i> ï¼š <br><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">sub_filter_once</span></span> <span class="hljs-literal"><span class="hljs-literal">off</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">sub_filter</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-variable"><span class="hljs-variable">$sign_o</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">sub_filter</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-variable"><span class="hljs-variable">$sign_a</span></span>;</code> </pre><br> ç¡®å®å¦‚æ­¤ï¼Œå¾®å¦™ä¹‹å¤„åœ¨äº<i>'a'ï¼='A'</i>ä¸<i>'o'ï¼='O'ç›¸åŒ</i> ï¼š <br><br><img src="https://habrastorage.org/getpro/habr/post_images/528/5d5/582/5285d55827ddf5cb5705b364a417828f.png" alt="å›¾ç‰‡"><br><br> å› æ­¤ï¼Œæœç´¢å¼•æ“æœºå™¨äººä¼šæ”¶åˆ°ç”¨æ‹‰ä¸è¯­<i>'a'</i>å’Œ<i>'o'</i>ç¨€é‡Šçš„ä¿®æ”¹åçš„åƒåœ¾ï¼Œè€Œä¸æ˜¯æ­£å¸¸çš„100ï¼…è¥¿é‡Œå°”æ–‡å­—ã€‚ æˆ‘ä¸æ‰“ç®—è®¨è®ºè¿™å¦‚ä½•å½±å“SEOï¼Œä½†è¿™æ ·çš„æ–‡å­—æ•£åˆ—ä¸å¤ªå¯èƒ½å¯¹SERPä¸­çš„ä½ç½®äº§ç”Ÿç§¯æå½±å“ã€‚ <br><br> æœ‰å¹»æƒ³çš„å®¶ä¼™æ€ä¹ˆè¯´ã€‚ <br><br><h2> å‚è€ƒæ–‡çŒ® </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä½¿ç”¨GDBè¿›è¡Œè°ƒè¯•</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">gdbï¼ˆ1ï¼‰-Linuxæ‰‹å†Œé¡µ</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">straceï¼ˆ1ï¼‰-Linuxæ‰‹å†Œé¡µ</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=http://nginx.org/en/docs/http/ngx_">Nginx-æ¨¡å—ngx_http_sub_module</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å…³äºç”µé”¯ï¼Œé“¾é”¯å’Œç”µé”¯</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN465355/">https://habr.com/ru/post/zh-CN465355/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN465343/index.html">æˆ‘ä»¬å¦‚ä½•åˆ¶ä½œå¼•æ“å’Œæ¸¸æˆé•¿è¾¾ä¸€å¹´åŠã€‚ ç¬¬äºŒéƒ¨åˆ† åŸºç¡€è®¾æ–½</a></li>
<li><a href="../zh-CN465345/index.html">FunCorpç§»åŠ¨æ‹›è˜æ´»åŠ¨</a></li>
<li><a href="../zh-CN465349/index.html">æ‚¨æ˜¯å¦éœ€è¦æ•æ·ï¼š5ä¸ªæ¨¡å‹è¿›è¡Œæµ‹è¯•</a></li>
<li><a href="../zh-CN465351/index.html">èµ¢å¾—Gostenderçš„äººçš„å¸¸è§é—®é¢˜</a></li>
<li><a href="../zh-CN465353/index.html">ICSå®‰å…¨å®¡æ ¸</a></li>
<li><a href="../zh-CN465357/index.html">é€‰æ‹©ï¼š9ç§æœ‰å…³â€œä¸“ä¸šâ€ç§»æ°‘åˆ°ç¾å›½çš„æœ‰ç”¨ææ–™</a></li>
<li><a href="../zh-CN465359/index.html">åä¸ºCloudCampusï¼šé«˜äº‘æœåŠ¡åŸºç¡€æ¶æ„</a></li>
<li><a href="../zh-CN465361/index.html">å–€å±±æ•°å­—åå­—è·¯å£ï¼šå¦‚ä½•åœ¨åŸå¸‚ä¸­å¼•å…¥é“è·¯å®‰å…¨æŠ€æœ¯</a></li>
<li><a href="../zh-CN465363/index.html">Natasç½‘ç«™ã€‚ é€šè¿‡CTFå¹³å°æ—¨åœ¨åˆ©ç”¨Webæ¼æ´ã€‚ ç¬¬5éƒ¨åˆ†</a></li>
<li><a href="../zh-CN465365/index.html">Windows 10å®‰è£…è„šæœ¬</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>