<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨‍🚀 ✡️ 🕥 基于Icinga2和Puppet的监控系统的自动化 🔀 🛒 🤮</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="基于Icinga2和Puppet的监控系统的自动化 
 让我们谈谈...基础架构即代码（IaC）。 
 在Habré上有一些关于Icinga2的很好的文章，也有关于Puppet的很好的文章： 

 Icinga2是一个简单的选择 
 我们以最低的费用在icinga2上进行微监控 
 从头开始设置现代...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>基于Icinga2和Puppet的监控系统的自动化</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/420199/"><h1><img src="https://habrastorage.org/webt/do/po/ex/dopoexqmfbzwvbyt6vlwvvaqqus.png"> 基于Icinga2和Puppet的监控系统的自动化 </h1><br><h3> 让我们谈谈...基础架构即代码（IaC）。 </h3><br> 在Habré上有一些关于Icinga2的很好的文章，也有关于Puppet的很好的文章： <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Icinga2是一个简单的选择</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">我们以最低的费用在icinga2上进行微监控</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">从头开始设置现代Puppet服务器</a> <br><br> 但是，这两个惊人的系统的自动化和集成的主题根本没有公开。 <br> 在本指南中，我将在一个“活着的”示例中展示如何将这两者结合 <br> 系统，请使用功能强大的工具来监视具有所有必要功能的基础架构。 本文是有关“全部装在一个瓶子中”安装软件包的一种操作指南。 完成本指南后，您将获得完整的运行监控解决方案，可以自己进一步“完成”。 试试吧！ <br><a name="habracut"></a><br><h1> 因此： </h1><br><h2> 我们提出了一个新主人。 我们需要： </h2><br><h2>  1.使其监视自动出现在Icinga2中，并创建基本检查： </h2><br><table><tbody><tr><td>  <font color="#337788"><b>支票</b></font> <br></td><td>  <font color="#337788"><b>快照</b></font> <br></td><td>  <font color="#337788"><b>说明</b></font> <br></td></tr><tr><td>  <font color="#337788"><b>主持人</b></font> <font color="#337788"><br></font> <br></td><td> <a href=""><img src="https://habrastorage.org/webt/kj/3z/hj/kj3zhjnnftl0e_bymn0ffsp-cps.png"><br></a> <br></td><td> 在给定的频率下，我们使用ping命令检查主机是否处于“活动状态”。 <br></td></tr><tr><td>  <font color="#337788"><b>磁盘使用率</b></font> <font color="#337788"><br></font> <br></td><td> <a href=""><img src="https://habrastorage.org/webt/_k/od/6-/_kod6-txtpme2ygoeq_y5ixhpga.png"><br></a> <br></td><td> 检查我们是否有足够的可用磁盘空间。 </td></tr><tr><td>  <font color="#337788"><b>平均负载</b></font> <font color="#337788"><br></font> <br></td><td> <a href=""><img src="https://habrastorage.org/webt/ts/4x/nm/ts4xnmllobanjgmtc-nzlgp5o2i.png"><br></a> <br></td><td> 我们动态监视服务器上的负载。 考虑到其上的处理器数量。 </td></tr><tr><td>  <font color="#337788"><b>可用内存</b></font> <font color="#337788"><br></font> <br></td><td> <a href=""><img src="https://habrastorage.org/webt/m0/c_/7k/m0c_7kx6vpz7x6lmdyzhs1nxqgw.png"><br></a> <br></td><td> 我们检查服务器上是否有足够的可用内存。 </td></tr><tr><td>  <font color="#337788"><b>开放端口</b></font> <font color="#337788"><br></font> <br></td><td> <a href=""><img src="https://habrastorage.org/webt/qe/ww/d6/qewwd6qbleu9rokn11av0bbesge.png"><br></a> <br></td><td> 我们扫描服务器上的端口并创建开放端口的映射。 我们监视我们没有新的打开或关闭的端口。 </td></tr><tr><td>  <font color="#337788"><b>重要更新</b></font> <font color="#337788"><br></font> <br></td><td> <a href=""><img src="https://habrastorage.org/webt/ac/in/y5/aciny5yddcavhdjfrfjxitrn4fo.png"><br></a> <br></td><td> 我们监视服务器上关键更新的存在。 </td></tr></tbody></table><br><br><h2>  2.以方便易懂的方式为各种服务添加自定义检查。 然后会向导演展示什么，我们是好伙伴，并获得奖赏！ <br></h2><br> 一些例子： <br><table><tbody><tr><th>  <font color="#337788"><b>服务专区</b></font> <br></th><th>  <font color="#337788"><b>YAML验证码</b></font> <br></th></tr><tr><td><div class="spoiler">  <b class="spoiler_title">虚拟主机</b> <div class="spoiler_text"> 是否检查“实时”主机。 <br></div></div><br><br> <a href=""><img src="https://habrastorage.org/webt/fa/q_/8m/faq_8muc2rwor0d9jp4ywh86qe8.png"><br></a> <br></td><td><pre><code class="hljs ruby"><span class="hljs-string"><span class="hljs-string">'%{::fqdn} virtual host'</span></span> : <span class="hljs-symbol"><span class="hljs-symbol">target:</span></span> /etc/icinga2/zones.d/master/<span class="hljs-string"><span class="hljs-string">%{::fqdn}</span></span>.conf <span class="hljs-symbol"><span class="hljs-symbol">apply:</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-symbol"><span class="hljs-symbol">assign:</span></span> [ <span class="hljs-string"><span class="hljs-string">'host.name == %{::fqdn}'</span></span> ] <span class="hljs-symbol"><span class="hljs-symbol">display_name:</span></span> <span class="hljs-string"><span class="hljs-string">'%{::fqdn} virtualhost'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">check_command:</span></span> <span class="hljs-string"><span class="hljs-string">'http'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">vars:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">http_uri:</span></span> / <span class="hljs-symbol"><span class="hljs-symbol">http_ssl:</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-symbol"><span class="hljs-symbol">http_vhost:</span></span> <span class="hljs-string"><span class="hljs-string">'hostname'</span></span> <span class="hljs-symbol"><span class="hljs-symbol">http_address:</span></span> <span class="hljs-string"><span class="hljs-string">"%{lookup('host_address')}"</span></span></code> </pre> <br></td></tr><tr><td><div class="spoiler">  <b class="spoiler_title">PostgreSQL的</b> <div class="spoiler_text"> 检查我们是否可以连接到PostgreSQL数据库。 <br></div></div><br><br> <a href=""><img src="https://habrastorage.org/webt/ct/c2/wz/ctc2wzluely2l7lsbkxwx5du8i4.png"><br></a> <br></td><td><pre> <code class="hljs javascript"> <span class="hljs-string"><span class="hljs-string">'%{::fqdn} PostgreSQL'</span></span>: target: <span class="hljs-regexp"><span class="hljs-regexp">/etc/i</span></span>cinga2/zones.d/master/%{::fqdn}.conf apply: <span class="hljs-literal"><span class="hljs-literal">true</span></span> assign: [ <span class="hljs-string"><span class="hljs-string">'host.name == %{::fqdn}'</span></span> ] display_name: <span class="hljs-string"><span class="hljs-string">'PostgreSQL'</span></span> command_endpoint: <span class="hljs-string"><span class="hljs-string">'%{::fqdn}'</span></span> check_command: <span class="hljs-string"><span class="hljs-string">"postgres"</span></span> vars: postgres_host: <span class="hljs-string"><span class="hljs-string">"localhost"</span></span> postgres_action: <span class="hljs-string"><span class="hljs-string">"connection"</span></span> phone_notifications: <span class="hljs-literal"><span class="hljs-literal">true</span></span></code> </pre><br></td></tr><tr><td><div class="spoiler">  <b class="spoiler_title">Nginx状态</b> <div class="spoiler_text"> 我们通过stub_status监视Nginx的状态。 <br></div></div><br><br> <a href=""><img src="https://habrastorage.org/webt/ht/el/a9/htela9efivyadlyw4vuxdouiqbk.png"><br></a> <br></td><td><pre> <code class="hljs pgsql"> <span class="hljs-string"><span class="hljs-string">'%{::fqdn} nginx status'</span></span> : target: /etc/icinga2/zones.d/master/%{::fqdn}.conf apply: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> assign: [ <span class="hljs-string"><span class="hljs-string">'host.name == %{::fqdn}'</span></span> ] command_endpoint: <span class="hljs-string"><span class="hljs-string">'%{::fqdn}'</span></span> display_name: <span class="hljs-string"><span class="hljs-string">'nginx status'</span></span> check_command: <span class="hljs-string"><span class="hljs-string">'nginx_status'</span></span> vars: nginx_status_host_address: localhost nginx_status_servername: <span class="hljs-keyword"><span class="hljs-keyword">server</span></span>.com nginx_status_critical: <span class="hljs-string"><span class="hljs-string">'1600,60,30'</span></span> nginx_status_warn: <span class="hljs-string"><span class="hljs-string">'1500,55,25'</span></span></code> </pre><br></td></tr></tbody></table><br><h2>  3.一切都整洁，可靠和美丽。 最重要的是，花费不超过30分钟的时间进行初始设置。 <br></h2><br>  <i>您必须具有Docker的经验，因此必须具有Linux的经验-本身。</i> <i><br><br></i>  <i>该设置在Debian / Ubuntu下进行了描述。</i>  <i>而且，尽管我没有理由不让他不在其他类似Unix的系统上工作，但我本人无法提供此类保证。</i>  <i>我有几台使用CentOS的计算机，它可以在其中运行，但是尽管如此，大多数还是Debian / Ubuntu。</i> <i><br></i> <br><h2> 让我们开始吧 </h2><br> 我马上说，当整个主机配置为服务，配置，软件，帐户等时，这对我来说很方便。  -它们由一个yaml文件描述，实际上避免了记录基础结构并提供了清晰的配置。 他在git存储库中打开了相应的项目，文件名与主机名相对应，然后打开所需主机的配置。 您可以立即查看主机上有哪些服务，从中备份了哪些内容，监视了哪些内容等。 <br><br>  <b>这是存储库中的项目结构的外观：</b> <br><br><pre> <code class="hljs">project_1/hostname1.com.yaml project_2/hostname2.com.yaml project_3/hostname3.com.yaml</code> </pre><br> 我在这里使用这样的模板，它描述了我们任何服务器的配置： <br><br><div class="spoiler">  <b class="spoiler_title">完整范本</b> <div class="spoiler_text"><pre> <code class="hljs smalltalk">#============================|<span class="hljs-type"><span class="hljs-type">INPUT</span></span> <span class="hljs-type"><span class="hljs-type">DATA</span></span>|=================================# #---------------------------------------|<span class="hljs-type"><span class="hljs-type">VARS</span></span>|----------------------------# #---//<span class="hljs-type"><span class="hljs-type">Information</span></span> about variables, keys &amp; contacts//----------------------# host_address: xxxx my_company: my_mail_domain: my_ssh_port: #---------------------------------------|<span class="hljs-type"><span class="hljs-type">CLASSES</span></span>|-------------------------# #---//<span class="hljs-type"><span class="hljs-type">Classes</span></span> are modules installed on the server.//----------------------# #---//<span class="hljs-type"><span class="hljs-type">These</span></span> modules process the arguments typed below.//------------------# #---//<span class="hljs-type"><span class="hljs-type">Without</span></span> classes nothing will work.//--------------------------------# #---//<span class="hljs-type"><span class="hljs-type">Class</span></span> default_role is mandatory. <span class="hljs-type"><span class="hljs-type">This</span></span> class will install//----------# #---//etckeeper, some required perl modules and manages all the logics.//-# classes: - default_role #---------------------------------------|<span class="hljs-type"><span class="hljs-type">TIMEZONE</span></span>|------------------------# #---//<span class="hljs-type"><span class="hljs-type">Set</span></span> timezone, which will be used on the host.//---------------------# timezone::timezone: <span class="hljs-type"><span class="hljs-type">Europe</span></span>/<span class="hljs-type"><span class="hljs-type">Moscow</span></span> #---------------------------------------|<span class="hljs-type"><span class="hljs-type">FACTS</span></span>|---------------------------# #---//<span class="hljs-type"><span class="hljs-type">Facts</span></span> are variables which puppet agent uses.//----------------------# facter::facts_hash: role: value: <span class="hljs-string"><span class="hljs-string">'name'</span></span> company: value: <span class="hljs-string"><span class="hljs-string">'name of company'</span></span> file: <span class="hljs-string"><span class="hljs-string">'location.txt'</span></span> #=========================================================================# #============================|<span class="hljs-type"><span class="hljs-type">PUPPET</span></span>|=====================================# #---//<span class="hljs-type"><span class="hljs-type">Settings</span></span> for puppet agent.//----------------------------------------# puppet::runmode: cron puppet::ca_server: <span class="hljs-comment"><span class="hljs-comment">"%{lookup('puppet_ca')}"</span></span> puppet::puppetmaster: <span class="hljs-comment"><span class="hljs-comment">"%{lookup('puppet_master')}"</span></span> #=========================================================================# #============================|<span class="hljs-type"><span class="hljs-type">CRON</span></span> <span class="hljs-type"><span class="hljs-type">TASKS</span></span>|=================================# cron_tasks: <span class="hljs-type"><span class="hljs-type">Name</span></span>: command: <span class="hljs-comment"><span class="hljs-comment">""</span></span> user: minute: <span class="hljs-string"><span class="hljs-string">''</span></span> hour: <span class="hljs-string"><span class="hljs-string">''</span></span> #=========================================================================# #============================|<span class="hljs-type"><span class="hljs-type">SUPERVISOR</span></span>|=================================# #---//<span class="hljs-type"><span class="hljs-type">Supervisor</span></span> is a process manager//-----------------------------------# supervisord::install_pip: <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> supervisord::install_init: <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> supervisord::service_name: supervisor supervisord::package_provider: apt supervisord::executable: /usr/bin/supervisord supervisord::executable_ctl: /usr/bin/supervisorctl supervisord::config_file: /etc/supervisor/supervisord.conf supervisord::programs: <span class="hljs-string"><span class="hljs-string">'name'</span></span>: ensure: present command: <span class="hljs-string"><span class="hljs-string">'su - rails -c "/home/name/s2"'</span></span> autostart: no autorestart: <span class="hljs-string"><span class="hljs-string">'false'</span></span> directory: /home/name/domainName/current #=========================================================================# #============================|<span class="hljs-type"><span class="hljs-type">SECURITY</span></span>|===================================# #-------------------------------------|<span class="hljs-type"><span class="hljs-type">FIREWALL</span></span>|--------------------------# #---//<span class="hljs-type"><span class="hljs-type">Iptables</span></span> rules//----------------------------------------------------# firewall: <span class="hljs-number"><span class="hljs-number">096</span></span> <span class="hljs-type"><span class="hljs-type">Allow</span></span> inbound <span class="hljs-type"><span class="hljs-type">SSH</span></span>: dport: <span class="hljs-comment"><span class="hljs-comment">"%{lookup('my_ssh_port')}"</span></span> proto: tcp action: accept #-------------------------------------|<span class="hljs-type"><span class="hljs-type">FAIL2BAN</span></span>|--------------------------# #-------------------------------------|<span class="hljs-type"><span class="hljs-type">ACCESS</span></span>|----------------------------# #--------------------------------------------|<span class="hljs-type"><span class="hljs-type">ACCOUNTS</span></span>|-------------------# #---//<span class="hljs-type"><span class="hljs-type">Discription</span></span> of accounts which will be created on server.//----------# accounts: user: shell: <span class="hljs-string"><span class="hljs-string">'/bin/bash'</span></span> password: <span class="hljs-string"><span class="hljs-string">''</span></span> locked: <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> purge_sshkeys: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> groups: - docker sshkeys: - <span class="hljs-comment"><span class="hljs-comment">"%{alias('admins_ssh_keys')}"</span></span> #--------------------------------------------|<span class="hljs-type"><span class="hljs-type">SUDO</span></span>|-----------------------# #---//<span class="hljs-type"><span class="hljs-type">Appointment</span></span> permissions for users.//--------------------------------# sudo::config_file_replace: <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> sudo::configs: user: content: <span class="hljs-comment"><span class="hljs-comment">"user ALL=(ALL) NOPASSWD: ALL"</span></span> #--------------------------------------------|<span class="hljs-type"><span class="hljs-type">SSH</span></span>|------------------------# #--------//<span class="hljs-type"><span class="hljs-type">Settings</span></span> for ssh server.//-------------------------------------# ssh::storeconfigs_enabled: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> ssh::server_options: <span class="hljs-type"><span class="hljs-type">Protocol</span></span>: <span class="hljs-string"><span class="hljs-string">'2'</span></span> <span class="hljs-type"><span class="hljs-type">Port</span></span>: <span class="hljs-comment"><span class="hljs-comment">"%{lookup('my_ssh_port')}"</span></span> <span class="hljs-type"><span class="hljs-type">PasswordAuthentication</span></span>: <span class="hljs-string"><span class="hljs-string">'yes'</span></span> <span class="hljs-type"><span class="hljs-type">PermitRootLogin</span></span>: <span class="hljs-string"><span class="hljs-string">'without-password'</span></span> <span class="hljs-type"><span class="hljs-type">SyslogFacility</span></span>: <span class="hljs-string"><span class="hljs-string">'AUTHPRIV'</span></span> <span class="hljs-type"><span class="hljs-type">UsePAM</span></span>: <span class="hljs-string"><span class="hljs-string">'yes'</span></span> <span class="hljs-type"><span class="hljs-type">X11Forwarding</span></span>: <span class="hljs-string"><span class="hljs-string">'no'</span></span> #--------------------------------------------|<span class="hljs-type"><span class="hljs-type">VPN</span></span>|------------------------# #---//<span class="hljs-type"><span class="hljs-type">Settings</span></span> for vpn server.//------------------------------------------# openvpn::servers: <span class="hljs-string"><span class="hljs-string">'namehost'</span></span>: country: <span class="hljs-string"><span class="hljs-string">''</span></span> province: <span class="hljs-string"><span class="hljs-string">''</span></span> city: <span class="hljs-string"><span class="hljs-string">''</span></span> organization: <span class="hljs-string"><span class="hljs-string">''</span></span> email: <span class="hljs-string"><span class="hljs-string">''</span></span> server: <span class="hljs-string"><span class="hljs-string">'xxxx 255.255.255.0'</span></span> dev: tun local: <span class="hljs-comment"><span class="hljs-comment">"%{lookup('host_address')}"</span></span> openvpn::client_defaults: server: <span class="hljs-string"><span class="hljs-string">'namehost'</span></span> openvpn::clients: # <span class="hljs-type"><span class="hljs-type">Firstname</span></span> <span class="hljs-type"><span class="hljs-type">Lastname</span></span> <span class="hljs-string"><span class="hljs-string">'user'</span></span>: {} openvpn::client_specific_configs: <span class="hljs-string"><span class="hljs-string">'user'</span></span>: server: <span class="hljs-string"><span class="hljs-string">'namehost'</span></span> redirect_gateway: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> route: - xxxx <span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span> #=========================================================================# #============================|<span class="hljs-type"><span class="hljs-type">OPERATING</span></span> <span class="hljs-type"><span class="hljs-type">SYSTEM</span></span>|===========================# #---------------------------------------------|<span class="hljs-type"><span class="hljs-type">SYSCTL</span></span>|--------------------# #---//set sysctl parameters//---------------------------------------------# sysctl::base::values: fs.file-max: value: <span class="hljs-string"><span class="hljs-string">'2097152000'</span></span> net.netfilter.nf_conntrack_max: value: <span class="hljs-string"><span class="hljs-string">'1048576'</span></span> net.nf_conntrack_max: value: <span class="hljs-string"><span class="hljs-string">'1048576'</span></span> net.ipv6.conf.all.disable_ipv6: value: <span class="hljs-string"><span class="hljs-string">'1'</span></span> vm.oom_kill_allocating_task: value: <span class="hljs-string"><span class="hljs-string">'1'</span></span> net.ipv4.ip_forward: value: <span class="hljs-string"><span class="hljs-string">'0'</span></span> net.ipv4.tcp_keepalive_time: value: <span class="hljs-string"><span class="hljs-string">'3'</span></span> net.ipv4.tcp_keepalive_intvl: value: <span class="hljs-string"><span class="hljs-string">'60'</span></span> net.ipv4.tcp_keepalive_probes: value: <span class="hljs-string"><span class="hljs-string">'9'</span></span> #---------------------------------------------|<span class="hljs-type"><span class="hljs-type">RCS</span></span>|-----------------------# #---//<span class="hljs-type"><span class="hljs-type">Managment</span></span> of <span class="hljs-type"><span class="hljs-type">RC</span></span> scenario//------------------------------------------# rcs::tmptime: <span class="hljs-string"><span class="hljs-string">'-1'</span></span> #---------------------------------------------|<span class="hljs-type"><span class="hljs-type">WEB</span></span> <span class="hljs-type"><span class="hljs-type">SERVERS</span></span>|---------------# #---------------------------------------------------------|<span class="hljs-type"><span class="hljs-type">HAPROXY</span></span>|-------# #---//<span class="hljs-type"><span class="hljs-type">HAProxy</span></span> is software that provides a high availability load//--------# #---//balancer and proxy server for <span class="hljs-type"><span class="hljs-type">TCP</span></span> and <span class="hljs-type"><span class="hljs-type">HTTP</span></span>-based applications//-----# #---// that spreads requests across multiple servers.//-------------------# haproxy::merge_options: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> haproxy::defaults_options: log: global maxconn: <span class="hljs-number"><span class="hljs-number">20000</span></span> option: [ <span class="hljs-string"><span class="hljs-string">'tcplog'</span></span>, <span class="hljs-string"><span class="hljs-string">'redispatch'</span></span>, <span class="hljs-string"><span class="hljs-string">'dontlognull'</span></span> ] retries: <span class="hljs-number"><span class="hljs-number">3</span></span> stats: enable timeout: [ <span class="hljs-string"><span class="hljs-string">'http-request 10s'</span></span>, <span class="hljs-string"><span class="hljs-string">'queue 1m'</span></span>, <span class="hljs-string"><span class="hljs-string">'check 10s'</span></span>, <span class="hljs-string"><span class="hljs-string">'connect 300000000ms'</span></span>, <span class="hljs-string"><span class="hljs-string">'client 300000000ms'</span></span>, <span class="hljs-string"><span class="hljs-string">'server 300000000ms'</span></span> ] haproxy_server: stats: ipaddress: <span class="hljs-comment"><span class="hljs-comment">"%{lookup('host_address')}"</span></span> ports: <span class="hljs-string"><span class="hljs-string">'9090'</span></span> options: mode: <span class="hljs-string"><span class="hljs-string">'http'</span></span> stats: [ <span class="hljs-string"><span class="hljs-string">'uri /'</span></span>, <span class="hljs-string"><span class="hljs-string">'auth puppet:123123123'</span></span> ] postgres: collect_exported: <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> ipaddress: <span class="hljs-string"><span class="hljs-string">'0.0.0.0'</span></span> ports: <span class="hljs-string"><span class="hljs-string">'5432'</span></span> options: option: - tcplog balance: roundrobin haproxy_balancemember: hostname1: listening_service: postgres server_names: hostname1 ipaddresses: <span class="hljs-comment"><span class="hljs-comment">"%{lookup('host1_ip')}"</span></span> ports: <span class="hljs-number"><span class="hljs-number">6432</span></span> options: check hostname2: listening_service: postgres server_names: hostname2 ipaddresses: <span class="hljs-comment"><span class="hljs-comment">"%{lookup('host2_ip')}"</span></span> ports: <span class="hljs-number"><span class="hljs-number">6432</span></span> options: - check - backup #---------------------------------------------|<span class="hljs-type"><span class="hljs-type">NGINX</span></span>|---------------------# #---//<span class="hljs-type"><span class="hljs-type">Nginx</span></span> is a web server which can also be used as a reverse proxy,//--# #---//load balancer, mail proxy and <span class="hljs-type"><span class="hljs-type">HTTP</span></span> cache//--------------------------# nginx::nginx_cfg_prepend: <span class="hljs-string"><span class="hljs-string">'load_module'</span></span>: - modules/ngx_http_geoip_module.so nginx::http_raw_append: - <span class="hljs-string"><span class="hljs-string">'real_ip_header X-Forwarded-For;'</span></span> - <span class="hljs-string"><span class="hljs-string">'geoip_country /usr/share/GeoIP/GeoIP.dat;'</span></span> - <span class="hljs-string"><span class="hljs-string">'set_real_ip_from 0.0.0.0/0;'</span></span> nginx::worker_rlimit_nofile: <span class="hljs-number"><span class="hljs-number">16384</span></span> nginx::confd: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> nginx::server_purrge: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> nginx::server::maintenance: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> #---------------------------------------------nginx-|<span class="hljs-type"><span class="hljs-type">MAPS</span></span>|----------------# nginx::string_mappings: allowed_country: ensure: present string: <span class="hljs-string"><span class="hljs-string">'$geoip_country_code'</span></span> mappings: - key: <span class="hljs-string"><span class="hljs-string">'default'</span></span> value: <span class="hljs-string"><span class="hljs-string">'yes'</span></span> - key: <span class="hljs-string"><span class="hljs-string">'US'</span></span> value: <span class="hljs-string"><span class="hljs-string">'no'</span></span> #---------------------------------------------nginx-|<span class="hljs-type"><span class="hljs-type">UPSTREAMS</span></span>|-----------# nginx::nginx_upstreams: <span class="hljs-comment"><span class="hljs-comment">"upstreamName"</span></span>: ensure: present members: - <span class="hljs-comment"><span class="hljs-comment">"localhost:9999"</span></span> #---------------------------------------------nginx-|<span class="hljs-type"><span class="hljs-type">VHOSTS</span></span>|--------------# nginx::nginx_servers: <span class="hljs-string"><span class="hljs-string">'hostname'</span></span>: proxy: <span class="hljs-string"><span class="hljs-string">'http://'</span></span> location_raw_append: - <span class="hljs-string"><span class="hljs-string">'if ($allowed_country = no) {return 403;}'</span></span> try_files: - <span class="hljs-string"><span class="hljs-string">''</span></span> - /index.html - =<span class="hljs-number"><span class="hljs-number">404</span></span> ssl: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> ssl_cert: <span class="hljs-comment"><span class="hljs-comment">"/etc/letsencrypt/live/hostname/fullchain.pem"</span></span> ssl_key: <span class="hljs-comment"><span class="hljs-comment">"/etc/letsencrypt/live/hostname/privkey.pem"</span></span> ssl_trusted_cert: <span class="hljs-comment"><span class="hljs-comment">"/etc/letsencrypt/live/hostname/chain.pem"</span></span> ssl_redirect: <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> ssl_port: <span class="hljs-number"><span class="hljs-number">443</span></span> error_pages: <span class="hljs-string"><span class="hljs-string">'403'</span></span>: /usa-restrict.html #---------------------------------------------nginx-|<span class="hljs-type"><span class="hljs-type">HTTPAUTH</span></span>|------------# httpauth: <span class="hljs-string"><span class="hljs-string">'admin'</span></span>: file: <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/htaccess"</span></span> password: <span class="hljs-string"><span class="hljs-string">''</span></span> realm: realm mechanism: basic ensure: present #---------------------------------------------nginx-|<span class="hljs-type"><span class="hljs-type">LOCATIONS</span></span>|-----------# nginx::nginx_locations: <span class="hljs-string"><span class="hljs-string">'domain1.com/usa-restricted'</span></span>: location: /usa-restrict.html www_root: /home/clientName1/clientName1-client-release/current/dist server: domain1.com ssl: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> <span class="hljs-string"><span class="hljs-string">'^~ domain2.com/resources/upload/'</span></span>: location: <span class="hljs-string"><span class="hljs-string">'^~ /resources/upload/'</span></span> server: domain2.com location_alias: <span class="hljs-string"><span class="hljs-string">'/home/clientName2/upload/'</span></span> raw_append: - <span class="hljs-string"><span class="hljs-string">'if ($allowed_country = no) {return 403;}'</span></span> <span class="hljs-string"><span class="hljs-string">'/nginx_status-domain3.com'</span></span>: location: /nginx_status stub_status: on raw_append: - access_log off; - allow <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>; - deny all; #---------------------------------------------nginx-|<span class="hljs-type"><span class="hljs-type">WELL</span></span>-<span class="hljs-type"><span class="hljs-type">KNOWN</span></span>|----------# #---//<span class="hljs-type"><span class="hljs-type">These</span></span> locations are needed for <span class="hljs-type"><span class="hljs-type">SSL</span></span> certificates generating//--------# #---//with <span class="hljs-type"><span class="hljs-type">Letsencrypt</span></span>.//-------------------------------------------------# <span class="hljs-string"><span class="hljs-string">'x.hostname.zz/.well-known'</span></span>: location: <span class="hljs-string"><span class="hljs-string">'/.well-known'</span></span> server: x.hostname.zz proxy: <span class="hljs-string"><span class="hljs-string">'http://kibana'</span></span> auth_basic: <span class="hljs-comment"><span class="hljs-comment">"ciao"</span></span> auth_basic_user_file: <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/htaccess www_root: /var/www/html ssl: true 'hostname.zz/~* \.(?:ico|css|js|html|map|gif|jpg|png|svg|ttf|woff|appcache|pdf)$': location: '~* \.(?:ico|css|js|html|map|gif|jpg|png|svg|ttf|woff|appcache|pdf)$' www_root: '/home/hostname/hostname-client-release/current/dist' expires: max raw_append: - "</span></span>add_header <span class="hljs-type"><span class="hljs-type">Pragma</span></span> public;<span class="hljs-comment"><span class="hljs-comment">" - 'add_header Cache-Control "</span></span>public, must-revalidate, proxy-revalidate<span class="hljs-comment"><span class="hljs-comment">";' #---------------------------------------------------|NGINS STATUS|--------# #----------------------------|LETSENCRYPT|--------------------------------# #---//Let's Encrypt is a certificate authority that provides #---//free X.509 certificates for Transport Layer Security (TLS)//--------# #---//encryption via an automated process designed to eliminate//---------# #---//the hitherto complex process of manual creation, validation,//------# #---//signing, installation, and renewal of certificates//----------------# #---//for secure websites.//----------------------------------------------# letsencrypt::email: client@mail.com letsencrypt_certonly: hostname: manage_cron: true domains: - hostname plugin: webroot webroot_paths: - '/var/www/html' #----------------------------|FILE SERVERS|-------------------------------# #-----------------------------------------|FILES|-------------------------# #---//Creating files &amp; folders on the server.//---------------------------# file: "</span></span>/home/hostname/hostname-release/shared/ecosystem.config.js<span class="hljs-comment"><span class="hljs-comment">": ensure: present owner: hostname content: | module.exports = { /** * Application configuration section * http://pm2.keymetrics.io/docs/usage/application-declaration/ */ apps : [ // First application { name : 'api', script : '/home/hostname/hostname-release/current/dist/index.js', cwd : '/home/hostname/hostname-release/current/dist/', watch : false, ignore_watch : ["</span></span>logs<span class="hljs-comment"><span class="hljs-comment">"], "</span></span>log_type<span class="hljs-comment"><span class="hljs-comment">": "</span></span>format<span class="hljs-comment"><span class="hljs-comment">", env: { COMMON_VARIABLE: 'true' }, env_production : { NODE_ENV: 'production', PORT: 9999, DEBUG : '*' }, env_development : { NODE_ENV: 'development', PORT: 9999, DEBUG : '*' } }, // Second application { name : 'WEB', script : 'web.js' } ], /** * Deployment section * http://pm2.keymetrics.io/docs/usage/deployment/ */ deploy : { production : { user : 'node', host : '0.0.0.0', ref : 'origin/master', repo : 'name@name.com:repo.git', path : '/var/www/production', 'post-deploy' : 'npm install &amp;&amp; pm2 reload ecosystem.config.js --env production' }, dev : { user : 'node', host : '0.0.0.0', ref : 'origin/master', repo : 'name@name.com:repo.git', path : '/var/www/development', 'post-deploy' : 'npm install &amp;&amp; pm2 reload ecosystem.config.js --env dev', env : { NODE_ENV: 'dev' } } } }; #-----------------------------------------|FTP|----------------------------# #---//Very Secure FTP Daemon is an FTP server for Unix-like systems.//-----# vsftpd::ftpd_banner: 'ASCII FTP Server' vsftpd::anonymous_enable: 'NO' vsftpd::write_enable: 'YES' vsftpd::chroot_local_user: 'YES' vsftpd::allow_writeable_chroot: 'YES' vsftpd::userlist_enable: 'YES' vsftpd::userlist_deny: 'NO' #-----------------------------------------|NFS|---------------------------# #---//Network File System is a distributed file system protocol,//--------# #---//allowing a user on a client computer to access files over//---------# #---//a computer network much like local storage is accessed.//-----------# nfs::server_enabled: true nfs::client_enabled : false nfs::nfs_v4: true nfs::nfs_v4_idmap_domain: "</span></span>%{::domain}<span class="hljs-comment"><span class="hljs-comment">" nfs::nfs_v4_export_root: '/share' nfs::nfs_v4_export_root_clients: "</span></span>%{lookup(<span class="hljs-string"><span class="hljs-string">'host_address'</span></span>)}/<span class="hljs-number"><span class="hljs-number">32</span></span>(rw,fsid=root,insecure,no_subtree_check,async,no_root_squash)<span class="hljs-comment"><span class="hljs-comment">" nfs::nfs_exports_global: /var/www: {} /var/smb: {} #----------------------------|PACKAGES|-----------------------------------# #---//Install of packages to server.//------------------------------------# packages: namePackage: ensure: installed #-------------------------------------|APT|-------------------------------# #---//Management of repository of packages.//---# apt::sources: 'debian_unstable': comment: 'This is the iWeb Debian unstable mirror' location: 'http://debian.mirror.iweb.ca/debian/' release: 'unstable' repos: 'main contrib non-free' pin: '-10' key: id: 'IDIDIDIDIDIDIDIDIDIDIDIDIDIDIDID' server: 'subkeys.pgp.net' include: src: true deb: true 'puppetlabs': location: 'http://apt.puppetlabs.com' repos: 'main' key: id: 'IDIDIDIDIDIDIDIDIDIDIDIDIDIDIDID' server: 'pgp.mit.edu' #-------------------------------------|PHP|-------------------------------# php_pool: myadmin: listen: 'xxxx:x' #-------------------------------------|RVM|-------------------------------# #---//Ruby Version Manager is a unix-like software platform designed//---# #---//to manage multiple installations of Ruby on the same device.//------# rvm_ruby: user1_rvm: user: user1 version: ruby-2.5.1 white_label_platform: default #-------------------------------------|PYTHON|----------------------------# python::version: system python::dev: present python::virtualenv: true #----------------------------|NODEJS|-------------------------------------# #-----------------------------------|NVM|---------------------------------# #---//Node Version Manager for Node.js//----------------------------------# #---//Node.js lets developers use JavaScript to write Command Line//------# #---//tools and for server-side scripting—running scripts server-side//---# #---//to produce dynamic web page content before the page is sent//-------# #---//to the user's web browser.//----------------------------------------# nodejs::repo_url_suffix: '8.x' nvm::user: name nvm::install_node: 8.10.0 #----------------------------|DOCKER|-------------------------------------# #---//Docker's management//-----------------------------------------------# docker::run_instance::instance: nats: image: 'nats' extra_parameters: '-p 8222:8222 -p 4222:4222 -p 6222:6222 --name nats --network admin_default' docker::compose::ensure: present docker_compose: /etc/admin/gitlab/docker-compose.yaml: ensure: present docker::iptables: false docker::tcp_bind: tcp://0.0.0.0:2375 docker::compose::ensure: present docker_swarm: 'agent': ensure: present join: true advertise_addr: '%{::ipaddress_enp2s0}' listen_addr: '%{::ipaddress_enp2s0}' manager_ip: '%{lookup("</span></span>host_address<span class="hljs-comment"><span class="hljs-comment">")}' token: '' docker_registry: 'host.com:5000': username: '' password: '' email: 'mail@mail.com' #=========================================================================# #============================|BACKUPS UPDATES|============================# #--------------------------------------------|UPDATES|--------------------# #---//Unattended upgrades is the linux-like mechanism//-------------------# #---//automatic updates.//------------------------------------------------# unattended_upgrades::origins: - "</span></span>o=<span class="hljs-type"><span class="hljs-type">Debian</span></span>,n=<span class="hljs-string"><span class="hljs-string">${</span></span>distro_codename}<span class="hljs-comment"><span class="hljs-comment">" - "</span></span>o=<span class="hljs-type"><span class="hljs-type">Debian</span></span>,n=<span class="hljs-string"><span class="hljs-string">${</span></span>distro_codename}-security<span class="hljs-comment"><span class="hljs-comment">" - "</span></span>o=<span class="hljs-type"><span class="hljs-type">Debian</span></span>,n=<span class="hljs-string"><span class="hljs-string">${</span></span>distro_codename}-updates<span class="hljs-comment"><span class="hljs-comment">" - "</span></span>o=<span class="hljs-type"><span class="hljs-type">Debian</span></span>,n=<span class="hljs-string"><span class="hljs-string">${</span></span>distro_codename}-proposed<span class="hljs-comment"><span class="hljs-comment">" - "</span></span>o=<span class="hljs-type"><span class="hljs-type">Debian</span></span>,n=<span class="hljs-string"><span class="hljs-string">${</span></span>distro_codename}-backports<span class="hljs-comment"><span class="hljs-comment">" - "</span></span>o=debian icinga,n=icinga-<span class="hljs-string"><span class="hljs-string">${</span></span>distro_codename}<span class="hljs-comment"><span class="hljs-comment">" - "</span></span>o=<span class="hljs-type"><span class="hljs-type">Zabbix</span></span>,n=<span class="hljs-string"><span class="hljs-string">${</span></span>distro_codename}<span class="hljs-comment"><span class="hljs-comment">" #--------------------------------------------|BACKUPS|--------------------# #---//The backups are processed by gembackup.//---------------------------# backup_jobs: #Creates full backup type_files: types: ['archive'] add: - '/path' storage_type: 'ftp' storage_host: "</span></span>%{lookup(<span class="hljs-string"><span class="hljs-string">'my_ftp_hostname'</span></span>)}<span class="hljs-comment"><span class="hljs-comment">" path: '/files/' storage_username: "</span></span>%{lookup(<span class="hljs-string"><span class="hljs-string">'my_backup_ftp_username'</span></span>)}<span class="hljs-comment"><span class="hljs-comment">" storage_password: "</span></span>%{lookup(<span class="hljs-string"><span class="hljs-string">'my_backup_ftp_password'</span></span>)}<span class="hljs-comment"><span class="hljs-comment">" compressor: "</span></span>%{lookup(<span class="hljs-string"><span class="hljs-string">'my_backup_compressor'</span></span>)}<span class="hljs-comment"><span class="hljs-comment">" keep: 7 weekday: [1-7] hour: 0 minute: 0 #--------------------------------------------|MOUNT|----------------------# #---//ontrol the mounting of remote &amp; local mount points.//--------------# mount: #Mount folder from other server to keep backups "</span></span>/tmp/mediastagetv_netbynet<span class="hljs-comment"><span class="hljs-comment">": device: "</span></span>%{lookup(<span class="hljs-string"><span class="hljs-string">'host_address'</span></span>)}:/<span class="hljs-comment"><span class="hljs-comment">" ensure: mounted fstype: nfs4 options: defaults atboot: false #--------------------------------------------|S3 AMAZON|------------------# #---//Simple Storage Service is a cloud computing web service.//----------# hostname1-archives: '/home/hostname1/hostname1/shared/log_amazon' hostname2-archives: '/home/hostname2/hostname2/shared/log_amazon' yas3fs::mounts: #=========================================================================# #============================|MONITORING|=================================# #---------------------------------------|ICINGA SERVICES|-----------------# #---//Managment of monitoring system.//-----------------------------------# icinga2_service: '%{::fqdn} virtual host' : target: /etc/icinga2/zones.d/master/%{::fqdn}.conf apply: true assign: [ 'host.name == %{::fqdn}' ] display_name: '%{::fqdn} virtualhost' check_command: 'http' vars: http_uri: / http_ssl: true http_vhost: 'hostname' http_address: "</span></span>%{lookup(<span class="hljs-string"><span class="hljs-string">'host_address'</span></span>)}<span class="hljs-comment"><span class="hljs-comment">" '%{::fqdn} nginx status' : target: /etc/icinga2/zones.d/master/%{::fqdn}.conf apply: true assign: [ 'host.name == %{::fqdn}' ] command_endpoint: '%{::fqdn}' display_name: 'nginx status' check_command: 'nginx_status' vars: nginx_status_host_address: localhost nginx_status_servername: server.com nginx_status_critical: '1600,60,30' nginx_status_warn: '1500,55,25' '%{::fqdn} redis': target: /etc/icinga2/zones.d/master/%{::fqdn}.conf apply: true assign: [ 'host.name == %{::fqdn}' ] display_name: 'Redis' command_endpoint: '%{::fqdn}' check_command: "</span></span>redis<span class="hljs-comment"><span class="hljs-comment">" vars: redis_hostname: localhost redis_port: 6379 redis_perfvars: '*' #=========================================================================# #============================|MAIL &amp; LOGS|================================# #----------------------------------------|MAIL|---------------------------# #---------------------------------------------|POSTFIX|-------------------# #---//Management of mail-server Postfix.//--------------------------------# postfix::manage_conffiles: false postfix_config: relayhost: ensure: present value: "</span></span>%{lookup(<span class="hljs-string"><span class="hljs-string">'host_address'</span></span>)}<span class="hljs-comment"><span class="hljs-comment">" virtual_maps: value: hash:/etc/postfix/virtual ensure: present sender_canonical_map: value: hash:/etc/postfix/canonical_sender ensure: present postfix_hash: '/etc/postfix/virtual': ensure: present content: | root %{lookup('hostname_admin_emails')} rails %{lookup('hostname_emails')} '/etc/postfix/canonical_sender': ensure: present content: | name@%{lookup('my_domain')} name@my_domain.com root@%{lookup('my_domain')} root@my_domain.com #----------------------------------------|LOGS|---------------------------# #---------------------------------------------|RSYSLOG|-------------------# #---//Rsyslog is a software utility for forwarding log messages//---------# #---//in an IP network. It implements the basic syslog protocol,//--------# #---//extends it with content-based filtering, rich filtering//-----------# #---//capabilities, flexible configuration options and adds features//----# #---//such as using TCP for transport.//----------------------------------# rsyslog::client: log_local: true my_rsyslog_snippet: 99_everything: content: "</span></span>*.*;auth,authpriv.none /var/log/syslog\n<span class="hljs-comment"><span class="hljs-comment">" 01_mail: content: "</span></span>mail.* -/var/log/mail.log\n&amp; stop<span class="hljs-comment"><span class="hljs-comment">" 02_auth: content: "</span></span>auth,authpriv.* /var/log/auth\n&amp; stop<span class="hljs-comment"><span class="hljs-comment">" 03_puppetagent: content: "</span></span>:programname,contains,\<span class="hljs-comment"><span class="hljs-comment">"puppet-agent\"</span></span> /var/log/puppetlabs/puppet/puppet-agent.log\n&amp; stop<span class="hljs-comment"><span class="hljs-comment">" 04_iptables: content: "</span></span>:msg,contains,\<span class="hljs-comment"><span class="hljs-comment">"IPTABLES INPUT\"</span></span> /var/log/iptables/iptables.log\n&amp; stop<span class="hljs-comment"><span class="hljs-comment">" 05_pam_unix: content: "</span></span>:msg,regex,\<span class="hljs-comment"><span class="hljs-comment">".*session opened for.*(uid=0)\"</span></span> /var/log/admin/auth.log\n&amp; stop<span class="hljs-comment"><span class="hljs-comment">" 06_sshd: content: "</span></span>:msg,regex,\<span class="hljs-comment"><span class="hljs-comment">".*publickey for username.*0.0.0.0\"</span></span> /var/log/admin/auth.log\n&amp; stop #---------------------------------------------|<span class="hljs-type"><span class="hljs-type">LOGWATCH</span></span>|------------------# #---//<span class="hljs-type"><span class="hljs-type">Logwatch</span></span> is a log-analysator for create short reports.//------------# logwatch::format: text logwatch::service: # <span class="hljs-type"><span class="hljs-type">Ignore</span></span> this servie - -http - -iptables #---------------------------------------------|<span class="hljs-type"><span class="hljs-type">LOGROTATE</span></span>|-----------------# #---//<span class="hljs-type"><span class="hljs-type">Management</span></span> of rotation of log files.//------------------------------# my_rclogs_path: <span class="hljs-string"><span class="hljs-string">'/home/hostname/hostname/shared/log'</span></span> my_rclogs_amazon_path: <span class="hljs-string"><span class="hljs-string">'/home/hostname1/hostname1/shared/log_amazon'</span></span> my_ttlogs_path: <span class="hljs-string"><span class="hljs-string">'/home/hostname2/hostname2/shared/log'</span></span> my_ttlogs_amazon_path: <span class="hljs-string"><span class="hljs-string">'/home/hostname/hostname/shared/log_amazon'</span></span> logrotate::ensure: latest logrotate::config: dateext: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> compress: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> logrotate::rules: booking-logs: path: <span class="hljs-string"><span class="hljs-string">'%{lookup("my_rclogs_path")}/booking_com.log'</span></span> size: <span class="hljs-number"><span class="hljs-number">2500</span></span>M rotate: <span class="hljs-number"><span class="hljs-number">20</span></span> copytruncate: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> delaycompress: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> dateext: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> dateformat: -%<span class="hljs-type"><span class="hljs-type">Y</span></span>%m%d-%s compress: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> postrotate: mv %{lookup(<span class="hljs-string"><span class="hljs-string">'my_rclogs_path'</span></span>)}/booking_com.log*.gz %{lookup(<span class="hljs-string"><span class="hljs-string">'my_rclogs_amazon_path'</span></span>)}/ #---------------------------------------------|<span class="hljs-type"><span class="hljs-type">ATOP</span></span>|----------------------# #---//<span class="hljs-type"><span class="hljs-type">ATOP</span></span> service displays a new information about <span class="hljs-type"><span class="hljs-type">CPU</span></span>//-----------------# #---//and memory utilization.//-------------------------------------------# atop::service: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> atop::interval: <span class="hljs-number"><span class="hljs-number">30</span></span> #----------------------------------------|<span class="hljs-type"><span class="hljs-type">DNS</span></span>|----------------------------# #---//<span class="hljs-type"><span class="hljs-type">Management</span></span> of file /etc/resolv.conf//-------------------------------# resolv_conf::nameservers: - <span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> - <span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> #=========================================================================# #============================|<span class="hljs-type"><span class="hljs-type">DATABASES</span></span>|==================================# #--------------------------------------|<span class="hljs-type"><span class="hljs-type">MYSQL</span></span>|----------------------------# #---//<span class="hljs-type"><span class="hljs-type">MySQL</span></span> is a relational database management system.//-----------------# mysql::server::package_ensure: <span class="hljs-string"><span class="hljs-string">'installed'</span></span> #· mysql::server::root_password: <span class="hljs-comment"><span class="hljs-comment">"ooy5ieneePahnei"</span></span> mysql::server::manage_config_file: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> mysql::server::service_name: <span class="hljs-string"><span class="hljs-string">'mysql'</span></span> # required for puppet module mysql::server::override_options: <span class="hljs-string"><span class="hljs-string">'mysqld'</span></span>: <span class="hljs-string"><span class="hljs-string">'bind-address'</span></span>: <span class="hljs-string"><span class="hljs-string">'*'</span></span> <span class="hljs-comment"><span class="hljs-comment">"userName"</span></span>: <span class="hljs-comment"><span class="hljs-comment">""</span></span>, <span class="hljs-comment"><span class="hljs-comment">"password"</span></span>: <span class="hljs-comment"><span class="hljs-comment">""</span></span>, <span class="hljs-comment"><span class="hljs-comment">"databaseName"</span></span>: <span class="hljs-comment"><span class="hljs-comment">""</span></span>, mysql::server::db: <span class="hljs-comment"><span class="hljs-comment">"hostname"</span></span>: user: <span class="hljs-comment"><span class="hljs-comment">""</span></span> password: <span class="hljs-comment"><span class="hljs-comment">""</span></span> host: <span class="hljs-comment"><span class="hljs-comment">"%"</span></span> grant: - <span class="hljs-comment"><span class="hljs-comment">"ALL"</span></span> #-------------------------------------|<span class="hljs-type"><span class="hljs-type">ELASTICSEARCH</span></span>|---------------------# #---//<span class="hljs-type"><span class="hljs-type">Elasticsearch</span></span> is a search engine based on <span class="hljs-type"><span class="hljs-type">Lucene</span></span>.//-----------------# #---//<span class="hljs-type"><span class="hljs-type">It</span></span> provides a distributed, multitenant-capable full-text search//---# #---//engine with an <span class="hljs-type"><span class="hljs-type">HTTP</span></span> web interface and schema-free <span class="hljs-type"><span class="hljs-type">JSON</span></span> documents.//-# elasticsearch::version: <span class="hljs-number"><span class="hljs-number">5.5</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> elasticsearch::manage_repo: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> elasticsearch::repo_version: <span class="hljs-number"><span class="hljs-number">5.</span></span>x elasticsearch::java_install: <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> elasticsearch::restart_on_change: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> elasticsearch_instance: <span class="hljs-string"><span class="hljs-string">'es-01'</span></span>: ensure: <span class="hljs-string"><span class="hljs-string">'present'</span></span> #-------------------------------------|<span class="hljs-type"><span class="hljs-type">REDIS</span></span>|-----------------------------# #---//<span class="hljs-type"><span class="hljs-type">Redis</span></span> is an in-memory database project implementing//---------------# #---//a distributed, in-memory key-value store with//---------------------# #---//optional durability.//----------------------------------------------# redis::bind: <span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> #-------------------------------------|<span class="hljs-type"><span class="hljs-type">ZOOKEPER</span></span>|--------------------------# #---//<span class="hljs-type"><span class="hljs-type">Zooker</span></span> is a centralized service for distributed systems//-----------# #---//to a hierarchical key-value store, which is used to provide//-------# #---//a distributed configuration service, synchronization service,//-----# #---//and naming registry for large distributed systems.//----------------# zookeeper::init_limit: <span class="hljs-string"><span class="hljs-string">'1000'</span></span> zookeeper::id: <span class="hljs-string"><span class="hljs-string">'1'</span></span> zookeeper::purge_interval: <span class="hljs-string"><span class="hljs-string">'1'</span></span> zookeeper::servers: - <span class="hljs-comment"><span class="hljs-comment">"%{lookup('host')}"</span></span> #-------------------------------------|<span class="hljs-type"><span class="hljs-type">POSTGRES</span></span>|--------------------------# #---//<span class="hljs-type"><span class="hljs-type">Postgres</span></span>, is an object-relational database management system//------# #---//with an emphasis on extensibility and standards compliance.//-------# #---//<span class="hljs-type"><span class="hljs-type">As</span></span> a database server, its primary functions are to store data//----# #---//securely and return that data in response to requests from other//--# #---//software applications.//--------------------------------------------# postgresql::server::postgres_password: postgresql::server::ip_mask_allow_all_users: <span class="hljs-string"><span class="hljs-string">'0.0.0.0/0'</span></span> postgresql::postgresql::server: ip_mask_allow_all_users: <span class="hljs-string"><span class="hljs-string">'0.0.0.0/32'</span></span> postgres_db: master: user: password: confluence: user: password: postgres_config: <span class="hljs-string"><span class="hljs-string">'max_connections'</span></span>: value: <span class="hljs-number"><span class="hljs-number">300</span></span> postgres_hba: <span class="hljs-string"><span class="hljs-string">'Allow locals without password'</span></span>: order: <span class="hljs-number"><span class="hljs-number">1</span></span> description: <span class="hljs-string"><span class="hljs-string">'locals postgres no password'</span></span> type: <span class="hljs-string"><span class="hljs-string">'host'</span></span> address: <span class="hljs-string"><span class="hljs-string">'127.0.0.1/32'</span></span> database: <span class="hljs-string"><span class="hljs-string">'all'</span></span> user: <span class="hljs-string"><span class="hljs-string">'all'</span></span> auth_method: <span class="hljs-string"><span class="hljs-string">'trust'</span></span> #----------------------------------------------|<span class="hljs-type"><span class="hljs-type">PGBOUNCER</span></span>|----------------# #---//<span class="hljs-type"><span class="hljs-type">PgBouncer</span></span> is a connection pooler for <span class="hljs-type"><span class="hljs-type">PostgreSQL</span></span>//-------------------# pgbouncer::group: postgres pgbouncer::user: postgres pgbouncer::userlist: - user: password: pgbouncer::databases: - source_db: recommender host: <span class="hljs-comment"><span class="hljs-comment">"%{lookup('')}"</span></span> dest_db: recommender auth_user: recommender pool_size: <span class="hljs-number"><span class="hljs-number">200</span></span> auth_pass: - source_db: master host: <span class="hljs-comment"><span class="hljs-comment">"%{lookup('')}"</span></span> dest_db: recommender auth_user: recommender pool_size: <span class="hljs-number"><span class="hljs-number">50</span></span> auth_pass: - source_db: slave host: <span class="hljs-comment"><span class="hljs-comment">"%{lookup('')}"</span></span> dest_db: recommender auth_user: recommender pool_size: <span class="hljs-number"><span class="hljs-number">200</span></span> auth_pass: #=========================================================================# #==============================|<span class="hljs-type"><span class="hljs-type">APPLICATION</span></span> <span class="hljs-type"><span class="hljs-type">SERVICES</span></span>|=====================# #---------------------------------------------------|<span class="hljs-type"><span class="hljs-type">CONFLUENCE</span></span>|----------# #---------------------------------------------------|<span class="hljs-type"><span class="hljs-type">JENKINS</span></span>|-------------# #=========================================================================#</code> </pre><br></div></div><br><br><h3> 监视部分示例： </h3><br><pre> <code class="hljs smalltalk">#============================|<span class="hljs-type"><span class="hljs-type">MONITORING</span></span>|=================================# #---------------------------------------|<span class="hljs-type"><span class="hljs-type">ICINGA</span></span> <span class="hljs-type"><span class="hljs-type">SERVICES</span></span>|-----------------# #---//<span class="hljs-type"><span class="hljs-type">Managment</span></span> of monitoring system.//-----------------------------------# icinga2_service: <span class="hljs-string"><span class="hljs-string">'%{::fqdn} virtual host'</span></span> : target: /etc/icinga2/zones.d/master/%{::fqdn}.conf apply: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> assign: [ <span class="hljs-string"><span class="hljs-string">'host.name == %{::fqdn}'</span></span> ] display_name: <span class="hljs-string"><span class="hljs-string">'%{::fqdn} virtualhost'</span></span> check_command: <span class="hljs-string"><span class="hljs-string">'http'</span></span> vars: http_uri: / http_ssl: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> http_vhost: <span class="hljs-string"><span class="hljs-string">'hostname'</span></span> http_address: <span class="hljs-comment"><span class="hljs-comment">"%{lookup('host_address')}"</span></span> <span class="hljs-string"><span class="hljs-string">'%{::fqdn} nginx status'</span></span> : target: /etc/icinga2/zones.d/master/%{::fqdn}.conf apply: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> assign: [ <span class="hljs-string"><span class="hljs-string">'host.name == %{::fqdn}'</span></span> ] command_endpoint: <span class="hljs-string"><span class="hljs-string">'%{::fqdn}'</span></span> display_name: <span class="hljs-string"><span class="hljs-string">'nginx status'</span></span> check_command: <span class="hljs-string"><span class="hljs-string">'nginx_status'</span></span> vars: nginx_status_host_address: localhost nginx_status_servername: server.com nginx_status_critical: <span class="hljs-string"><span class="hljs-string">'1600,60,30'</span></span> nginx_status_warn: <span class="hljs-string"><span class="hljs-string">'1500,55,25'</span></span> <span class="hljs-string"><span class="hljs-string">'%{::fqdn} redis'</span></span>: target: /etc/icinga2/zones.d/master/%{::fqdn}.conf apply: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> assign: [ <span class="hljs-string"><span class="hljs-string">'host.name == %{::fqdn}'</span></span> ] display_name: <span class="hljs-string"><span class="hljs-string">'Redis'</span></span> command_endpoint: <span class="hljs-string"><span class="hljs-string">'%{::fqdn}'</span></span> check_command: <span class="hljs-comment"><span class="hljs-comment">"redis"</span></span> vars: redis_hostname: localhost redis_port: <span class="hljs-number"><span class="hljs-number">6379</span></span> redis_perfvars: <span class="hljs-string"><span class="hljs-string">'*'</span></span> #=========================================================================#</code> </pre><br><br><h2> 这种方案的一般操作方案仅包含两个简单的操作： </h2><br><ol><li>  <b>我们在主机上启动puppet-主机看到属于它的支票并将其导出到puppetDB。</b> <b><br></b> <br></li><li>  <b>在icinga2容器中运行puppet-来自puppetdb的检查将转换为真正的Icinga2配置。</b> <b><br></b> <br></li></ol><br> 在这里，许多人会说： <i>“如果我能举起平常的icinga2并用手或通过Web界面添加支票，为什么要使这一切成为现实？”</i> <br><br> 的确，如果您需要监视十二个主机并提供​​数百种服务，并且您是一个非常整洁的人，并且拥有良好的记忆力（自然界中找不到），那么围堵花园毫无意义。 如果您拥有相当大的基础架构，并且感觉到您可能忘记了某个地方，那就完全不同了。 在这样的时刻，自动化有很大帮助，因为 有助于将所有物品放在货架上，并在许多方面避免了人为因素。 <br><br><h2> 表示主要优点： </h2><br>  <b>让我们看一下这个模板：</b> <br><br><pre> <code class="hljs pgsql">icinga2_service: <span class="hljs-string"><span class="hljs-string">'%{::fqdn} disk service'</span></span>: target: /etc/icinga2/zones.d/master/%{::fqdn}.conf apply: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> assign: [ <span class="hljs-string"><span class="hljs-string">'host.name == %{::fqdn}'</span></span> ] display_name: <span class="hljs-string"><span class="hljs-string">'Disk usage'</span></span> command_endpoint: <span class="hljs-string"><span class="hljs-string">'%{::fqdn}'</span></span> check_command: <span class="hljs-string"><span class="hljs-string">'disk'</span></span> vars: #<span class="hljs-keyword"><span class="hljs-keyword">All</span></span> disks disk_all: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> disk_exclude_type: - aufs - tmpfs disk_ignore_ereg_path: - /run/docker<span class="hljs-comment"><span class="hljs-comment">/* - /sys/* - /var/lib/docker* - /var/lib/ureadahead/debugfs/* - /run/user/*</span></span></code> </pre><br> <b>+ 1.     Hiera            — ..  .    Icinga2,   ,         .   ,     , ,    . <br></b> <br> <b>+ 2.    ,     .       —           . <br></b> <br> <b>+ 3.        , ..       ,          Icinga2     ,  puppet   Icinga2. <br></b> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">+ 4.因此，我们已将所有检查存储在一个puppetDB数据库中，我们可以创建功能强大的脚本来进一步自动化，我们将在其中使用此信息。 </font></font><br></b> <br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 所以走吧 </font></font></h2><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 1.设置人偶。 </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">希望您已经配置了docker和docker-compose。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果没有，那么您需要安装它们：</font></font><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">安装Docker ... </font></font></a> <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">安装Docker-compose ...</font></font></a> <br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 2.我们将存储库克隆到我们的服务器： </font></font></h3><br><pre> <code class="bash hljs">git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> http://git.comgress64.com/external/puppet-icinga2-how-to.git</code> </pre><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 3.使用您喜欢的编辑器打开docker-compose.yaml并查看它。 </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们看到在这个包中，我们有几个容器同时出现-PuppetServer，PuppetDb，PostgreSQL服务器和PuppetBoard。</font><font style="vertical-align: inherit;">还从当前目录装入卷。</font><font style="vertical-align: inherit;">此配置并非所有人都最佳，因此请考虑您的基础架构。</font><font style="vertical-align: inherit;">某人已经拥有PostgreSQL服务器，某人想将代码存储在另一部分中-这是创造的自由。</font><font style="vertical-align: inherit;">在此阶段，我建议保留默认模板-您以后可以随时返回它。</font><font style="vertical-align: inherit;">让我们拿起我们的容器包，看看发生了什么：</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 4.启动Puppet，Postgres，Puppetdb和Graphite容器。 </font></font></h3><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#  Puppet, Postgres  Puppetdb #  Puppet, Postgres, Puppetdb  Graphite cd puppet-icinga2-how-to docker-compose up -d puppet puppetdb-postgres puppetdb graphite &amp;&amp; docker-compose logs -f</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">现在，我们已经加载了多个映像并启动了容器，并在PostgreSQL中创建了数据库。</font><font style="vertical-align: inherit;">让我们等待所有服务器启动-错误可以忽略，因为它们会在一段时间后稳定下来。</font><font style="vertical-align: inherit;">按Ctrl + C退出日志查看模式。</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 5.检查我们的木偶大师的工作： </font></font></h3><br><pre> <code class="bash hljs">docker run --net puppeticinga2howto_default --link puppet:puppet puppet/puppet-agent</code> </pre><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 6.如果一切正常，您将看到以下结论： </font></font></h3><br><pre> <code class="bash hljs">Notice: Applied catalog <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 0.03 seconds Changes: Total: 1 Events: Success: 1 Total: 1 Resources: Changed: 1 Out of sync: 1 Total: 8 Time: Schedule: 0.00 File: 0.00 Transaction evaluation: 0.01 Catalog application: 0.03 Convert catalog: 0.04 Config retrieval: 0.45 Node retrieval: 1.38 Last run: 1532605377 Fact generation: 2.24 Plugin sync: 4.50 Filebucket: 0.00 Total: 8.65 Version: Config: 1532605376 Puppet: 5.5.1</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 设置Icinga2服务器。 </font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 7.通过执行以下操作从Dockerfile中创建映像： </font></font></h3><br><pre> <code class="bash hljs">docker-compose build icinga</code> </pre><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 8.运行将容纳Icinga2服务器的容器。 </font></font></h3><br><pre> <code class="bash hljs">docker-compose up -d icinga</code> </pre><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">9.到目前为止，我们的容器是空的。</font><font style="vertical-align: inherit;">让我们通过执行以下操作来使用我们的Puppet服务器配置icinga2服务器：</font></font></h3><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   puppet  librarian-puppet   puppet docker-compose exec puppet bash -c 'cd /etc/puppetlabs/code &amp;&amp; gem install librarian-puppet &amp;&amp; librarian-puppet install --verbose' # Puppet   Icinga     docker-compose exec icinga puppet agent --server puppet --waitforcert 60 --test</span></span></code> </pre><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 10.安装并配置Icinga，Icingaweb2和Apache。 </font></font></h3><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 您的Icinga2服务器已准备就绪！ </font></font></h2><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Icingaweb2 </font></font></h2><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 1.让我们看看我们得到了什么。 </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在浏览器中查看监视系统的状态很方便，请执行以下操作：</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在浏览器中打开</font></font><font color="#0000aa"><u><code>http://ip___:8081/icingaweb2</code></u></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">并使用默认用户名</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">icingaadmin / icinga转到Icinga</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们看到这张图片：</font></font></b> <br><br><img src="https://habrastorage.org/webt/vg/hr/zn/vghrznlioinsw68lgide-onot9o.png"><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">几分钟后，我们看到所有检查都对我们</font></font></b> <font style="vertical-align: inherit;"><font style="vertical-align: inherit;">有用</font><b><font style="vertical-align: inherit;">：</font></b></font><br><br><img src="https://habrastorage.org/webt/ju/5a/ds/ju5adsckudygkhbejybx4k7fmz4.png"><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图形也起作用：</font></font></b> <br><br><img src="https://habrastorage.org/webt/hy/6i/lw/hy6ilwnlp0ua6fdoouzo-8t7rog.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们有一个适用于Icinga2的Web环境，但是还没有主机连接到Icinga，让我们连接第一个主机。</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 2.将新主机连接到监视系统 </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">现在，我们只有一台主机连接到icinga2-Icinga本身。</font><font style="vertical-align: inherit;">让我们连接另一个。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我在docker中显示一个示例，但是所有这些都可以在裸机上运行：</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">首先，您需要准备一个模板，并提供一些有关木偶主机的信息：</font></font></b> <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#    cd puppet-icinga2-how-to/code/environments/production/hieradata/nodes #    (   ) cp template.yaml example.com.yaml #       : host_address: 172.18.0.7 my_company: COMGRESS64 my_package_manager: apt my_ssh_port: 22 #   </span></span></code> </pre><br> <b>  .      hostname      ,     :</b> <br><br><pre> <code class="bash hljs">docker run --hostname example.com --rm -t --link puppet:puppet --net puppeticinga2howto_default -i phusion/baseimage:latest /sbin/my_init -- bash -l</code> </pre><br> <b> puppet   :</b> <br><br><pre> <code class="bash hljs">apt-get update &amp;&amp; apt-get install -y ruby make gcc perl-modules &amp;&amp; gem install --no-ri --no-rdoc puppet</code> </pre><br> <b> puppet:</b> <br><br><pre> <code class="bash hljs">puppet agent --server puppet --waitforcert 60 --<span class="hljs-built_in"><span class="hljs-built_in">test</span></span></code> </pre><br> <b>    icinga2             puppetDB.   ,  puppet   icinga2:</b> <br><br><pre> <code class="bash hljs">docker-compose <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> icinga puppet agent --server puppet --waitforcert 60 --<span class="hljs-built_in"><span class="hljs-built_in">test</span></span></code> </pre><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们通过浏览器查看得到的结果：</font></font></b> <br><br><img src="https://habrastorage.org/webt/tc/ko/uc/tckoucinbkuwoqh_bhquehthj-i.png"><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已添加检查并等待完成。</font></font></b> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5分钟后：</font></font></b> <br><br><img src="https://habrastorage.org/webt/-9/va/dv/-9vadvzxjwxepukpbjoinxt0h9a.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以同样的方式，将所有其他主机添加到系统中。我想提请您注意这个指南是一个概念证明，未经修改就不能在生产环境中使用。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果这篇文章看起来很有趣，那么下一次我将展示如何添加各种有趣的自定义检查，共享秘密以及讲述各种微妙之处。另外，如果有需要，我会从内部更详细地介绍这一切的工作方式。</font></font><br><br>  <b>感谢您的关注！</b> <br><br><hr><br> <b>      Confluence:</b> <br> <i>/    ./</i> <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><b>docs.comgress64.com/...</b></a> <br><br> <b>  :</b> <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://github.com/Icinga/puppet-icinga2</a> <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://forge.puppet.com/icinga/icingaweb2</a> <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://docs.docker.com/</a> <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://docs.puppet.com/</a> <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://docs.puppet.com/hiera/</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN420199/">https://habr.com/ru/post/zh-CN420199/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN420189/index.html">没有借口俱乐部：Massimiliano Sichi的无限毅力</a></li>
<li><a href="../zh-CN420191/index.html">SONIA团队：自动驾驶水下航行器的未来</a></li>
<li><a href="../zh-CN420193/index.html">带有CISS的打印机：选择并比较打印成本</a></li>
<li><a href="../zh-CN420195/index.html">在首都工作的地方-莫斯科15合作的简要概述</a></li>
<li><a href="../zh-CN420197/index.html">使用glock cuzdra方法创建AI。 智力奥德赛</a></li>
<li><a href="../zh-CN420201/index.html">为什么西方人害怕机器人，而日本人却不害怕？</a></li>
<li><a href="../zh-CN420203/index.html">这位少年阻止了量子计算的成功</a></li>
<li><a href="../zh-CN420205/index.html">基于DNA的ROM，核酸存储器和OxRAM的底物</a></li>
<li><a href="../zh-CN420209/index.html">OpenAI演示了复杂操作从模拟到现实世界的转移</a></li>
<li><a href="../zh-CN420211/index.html">关于机器学习的神奇思维不会使真正的AI更加紧密</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>