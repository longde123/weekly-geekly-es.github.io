<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü¶ì üë™ ‚¨ÖÔ∏è Voller I / O-Naked-C-Reaktor ü•í üé≤ üé°</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Einleitung 


 I / O-Reaktor (Single-Threaded- Ereignisschleife ) ist ein Muster zum Schreiben von hoch geladener Software, das in vielen g√§ngigen L√∂s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Voller I / O-Naked-C-Reaktor</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/475896/"><p><img src="https://habrastorage.org/webt/2g/w7/vr/2gw7vrlwgzkro-gf3hkbj7jxqzu.png"></p><br><h1 id="vvedenie">  Einleitung </h1><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">I / O-Reaktor</a> (Single-Threaded- <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">Ereignisschleife</a> ) ist ein Muster zum Schreiben von hoch geladener Software, das in vielen g√§ngigen L√∂sungen verwendet wird: </p><br><ul>
<li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">Node.js</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">Tor</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">√úbertragung</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">Chrom</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">Memcached</a> </li><li>  ... </li></ul><br><p>  In diesem Artikel werden wir die Vor- und Nachteile des E / A-Reaktors und das Funktionsprinzip betrachten, eine Implementierung f√ºr weniger als 200 Codezeilen schreiben und einen einfachen HTTP-Server zwingen, mehr als 40 Millionen Anforderungen pro Minute zu verarbeiten. </p><a name="habracut"></a><br><h1 id="predislovie">  Vorwort </h1><br><ul><li>  Der Artikel wurde mit dem Ziel verfasst, die Funktionsweise des E / A-Reaktors zu verstehen und damit die Risiken bei seiner Verwendung zu erkennen. </li><li>  Um den Artikel zu beherrschen, sind Kenntnisse der Grundlagen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">der C-Sprache</a> und ein wenig Erfahrung in der Entwicklung von Netzwerkanwendungen erforderlich. </li><li>  Der gesamte Code ist in C geschrieben und entspricht ( <strong>Achtung: langes PDF</strong> ) <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">dem C11-Standard</a> f√ºr Linux und ist auf <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">GitHub</a> verf√ºgbar. </li></ul><br><h1 id="zachem-eto-nuzhno">  Warum ist das n√∂tig? </h1><br><p>  Mit der wachsenden Popularit√§t des Internets mussten Webserver eine gro√üe Anzahl von Verbindungen gleichzeitig verarbeiten, und daher wurden zwei Ans√§tze ausprobiert: Blockieren von E / A auf einer gro√üen Anzahl von Betriebssystemthreads und nicht blockierende E / A in Kombination mit einem Ereignisbenachrichtigungssystem, das auch als "System" bezeichnet wird Selektor "( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">epoll</a> / <a href="" rel="nofollow">kqueue</a> / <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">IOCP</a> / etc). </p><br><p>  Der erste Ansatz bestand darin, f√ºr jede eingehende Verbindung einen neuen Betriebssystem-Thread zu erstellen.  Der Nachteil ist die schlechte Skalierbarkeit: Das Betriebssystem muss viele <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">Kontext√ºberg√§nge</a> und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">Systemaufrufe durchf√ºhren</a> .  Sie sind kostspielig und k√∂nnen zu einem Mangel an freiem RAM mit einer beeindruckenden Anzahl von Verbindungen f√ºhren. </p><br><p>  Die ge√§nderte Version weist eine <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">feste Anzahl von Threads</a> (Thread-Pool) zu, wodurch verhindert wird, dass das System die Ausf√ºhrung abnormal stoppt, gleichzeitig jedoch ein neues Problem einbringt: Wenn der Thread-Pool zum gegebenen Zeitpunkt durch lange Leseoperationen blockiert wird, k√∂nnen andere Sockets bereits Daten empfangen wird dies nicht tun k√∂nnen. </p><br><p>  Der zweite Ansatz verwendet <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">das</a> vom Betriebssystem bereitgestellte <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">Ereignisbenachrichtigungssystem</a> (Systemauswahl).  In diesem Artikel wird die h√§ufigste Art der Systemauswahl beschrieben, die auf Warnungen (Ereignissen, Benachrichtigungen) zur Bereitschaft f√ºr E / A-Vorg√§nge und nicht auf <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">Warnungen zu deren Abschluss</a> basiert.  Ein vereinfachtes Beispiel seiner Verwendung kann durch das folgende Flussdiagramm dargestellt werden: </p><br><p><img src="https://habrastorage.org/webt/rw/kb/yo/rwkbyokmirpu7hpd6yzc47-k4va.png"></p><br><p>  Der Unterschied zwischen diesen Ans√§tzen ist wie folgt: </p><br><ul><li>  Durch das Blockieren von E / A-Vorg√§ngen wird <strong>der</strong> Benutzer-Stream <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">angehalten,</a> <strong>bis das</strong> Betriebssystem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">die</a> eingehenden <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">IP-Pakete</a> ordnungsgem√§√ü in den Byte-Stream ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">TCP</a> , Datenempfang) <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">defragmentiert</a> oder gen√ºgend Speicherplatz in den internen Schreibpuffern f√ºr das anschlie√üende Senden √ºber die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">Netzwerkkarte</a> (Datenversand) <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">freigegeben hat</a> . </li><li>  <strong>Nach einer Weile</strong> benachrichtigt <strong>die</strong> Systemauswahl das Programm, dass das Betriebssystem <strong>bereits</strong> IP-Pakete defragmentiert hat (TCP, Daten empfangen) oder dass bereits gen√ºgend Speicherplatz in den internen Aufzeichnungspuffern verf√ºgbar ist (Daten senden). </li></ul><br><p>  Zusammenfassend ist das Reservieren des Betriebssystemthreads f√ºr jedes E / A eine Verschwendung von Rechenleistung, da die Threads in der Realit√§t nicht mit n√ºtzlicher Arbeit besch√§ftigt sind (der Begriff <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">"Softwareunterbrechung"</a> hat seine Wurzeln).  Die Systemauswahl l√∂st dieses Problem, indem das Benutzerprogramm die CPU-Ressourcen wesentlich sparsamer nutzen kann. </p><br><h1 id="model-io-reaktora">  Reaktor-I / O-Modell </h1><br><p>  Eine E / A-Drossel fungiert als Schicht zwischen dem Systemselektor und dem Benutzercode.  Das Funktionsprinzip wird durch das folgende Flussdiagramm beschrieben: </p><br><p><img src="https://habrastorage.org/webt/6j/v9/-m/6jv9-mplsvirwimvaej1zzyu2oa.png"></p><br><ul><li>  Lassen Sie mich daran erinnern, dass ein Ereignis eine Benachrichtigung ist, dass ein bestimmter Socket eine nicht blockierende E / A-Operation ausf√ºhren kann. </li><li>  Ein Ereignishandler ist eine Funktion, die vom E / A-Reaktor aufgerufen wird, wenn ein Ereignis empfangen wird, das dann eine nicht blockierende E / A-Operation ausf√ºhrt. </li></ul><br><p>  Es ist wichtig anzumerken, dass die E / A-Drossel per Definition ein Thread ist, aber nichts hindert die Verwendung des Konzepts in einer Umgebung mit mehreren Threads in Bezug auf 1 Stream: 1-Drossel, wodurch alle CPU-Kerne verwendet werden. </p><br><h1 id="realizaciya">  Implementierung </h1><br><p> Wir haben die √∂ffentliche Schnittstelle in die Datei " <a href="" rel="nofollow"><code>reactor.h</code></a> " und die Implementierung in die Datei " <a href="" rel="nofollow"><code>reactor.h</code></a> <a href="" rel="nofollow"><code>reactor.c</code></a> .  <code>reactor.h</code> wird aus den folgenden Erkl√§rungen bestehen: </p><br><div class="spoiler">  <b class="spoiler_title">Zeige Anzeigen in Reaktor.h</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">reactor</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Reactor</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-comment"><span class="hljs-comment">/* *   ,    I/O    *    . */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">typedef</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*Callback)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *arg, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fd, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> events)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/* *  `NULL`   , -`NULL`   `Reactor`  *  . */</span></span> <span class="hljs-function"><span class="hljs-function">Reactor *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reactor_new</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/* *   ,       *    I/O . * *    -1   , 0   . */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reactor_destroy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Reactor *reactor)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reactor_register</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Reactor *reactor, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fd, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> interest, Callback callback, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *callback_arg)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reactor_deregister</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Reactor *reactor, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fd)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reactor_reregister</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Reactor *reactor, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fd, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> interest, Callback callback, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *callback_arg)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/* *     - `timeout`. * *           * /    . */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reactor_run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Reactor *reactor, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">time_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> timeout)</span></span></span></span>;</code> </pre> </div></div><br><p>  Die E / A-Struktur des Reaktors besteht aus einem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">Epoll-</a> Selector- <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">Dateideskriptor</a> und einer <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><code>GHashTable</code></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">Hash-Tabelle</a> , die jeder Socket <code>CallbackData</code> (einer Struktur aus einer Ereignisbehandlungsroutine und einem Benutzerargument daf√ºr) zuordnet. </p><br><div class="spoiler">  <b class="spoiler_title">Reactor und CallbackData anzeigen</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">reactor</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> epoll_fd; GHashTable *table; <span class="hljs-comment"><span class="hljs-comment">// (int, CallbackData) }; typedef struct { Callback callback; void *arg; } CallbackData;</span></span></code> </pre> </div></div><br><p>  Bitte beachten Sie, dass wir die M√∂glichkeit genutzt haben, einen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">unvollst√§ndigen Typ</a> per Zeiger zu behandeln.  In <code>reactor.h</code> deklarieren wir den Aufbau des <code>reactor</code> und in <code>reactor.c</code> definieren <code>reactor.c</code> ihn, wodurch der Benutzer daran <code>reactor.c</code> wird, seine Felder explizit zu √§ndern.  Dies ist eines der Muster <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">des Versteckens von Daten</a> , das sich organisch in die Semantik von C einf√ºgt. </p><br><p>  Die Funktionen <code>reactor_register</code> , <code>reactor_deregister</code> und <code>reactor_reregister</code> aktualisieren die Liste der Sockets von Interesse und die entsprechenden Ereignishandler in der Systemauswahl und in der Hash-Tabelle. </p><br><div class="spoiler">  <b class="spoiler_title">Registrierungsfunktionen anzeigen</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> REACTOR_CTL(reactor, op, fd, interest) \ </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (epoll_ctl(reactor-&gt;epoll_fd, op, fd, \ &amp;(struct epoll_event){.events = interest, \ .data = {.fd = fd}}) == -1) { \ perror(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"epoll_ctl"</span></span></span><span class="hljs-meta">); \ return -1; \ } int reactor_register(const Reactor *reactor, int fd, uint32_t interest, Callback callback, void *callback_arg) { REACTOR_CTL(reactor, EPOLL_CTL_ADD, fd, interest) g_hash_table_insert(reactor-&gt;table, int_in_heap(fd), callback_data_new(callback, callback_arg)); return 0; } int reactor_deregister(const Reactor *reactor, int fd) { REACTOR_CTL(reactor, EPOLL_CTL_DEL, fd, 0) g_hash_table_remove(reactor-&gt;table, &amp;fd); return 0; } int reactor_reregister(const Reactor *reactor, int fd, uint32_t interest, Callback callback, void *callback_arg) { REACTOR_CTL(reactor, EPOLL_CTL_MOD, fd, interest) g_hash_table_insert(reactor-&gt;table, int_in_heap(fd), callback_data_new(callback, callback_arg)); return 0; }</span></span></code> </pre> </div></div><br><p>  Nachdem der E / A-Reaktor das Ereignis mit dem <code>fd</code> Deskriptor abgefangen hat, ruft er den entsprechenden Ereignishandler auf, in den er <code>fd</code> √ºbergibt, die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">Bitmaske der</a> generierten Ereignisse und den Benutzerzeiger auf <code>void</code> . </p><br><div class="spoiler">  <b class="spoiler_title">Reaktor_Run () Funktion anzeigen</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reactor_run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Reactor *reactor, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">time_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> timeout)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> result; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">epoll_event</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">events</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((events = <span class="hljs-built_in"><span class="hljs-built_in">calloc</span></span>(MAX_EVENTS, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(*events))) == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">abort</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">time_t</span></span> start = time(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">time_t</span></span> passed = time(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) - start; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> nfds = epoll_wait(reactor-&gt;epoll_fd, events, MAX_EVENTS, timeout - passed); <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (nfds) { <span class="hljs-comment"><span class="hljs-comment">//  case -1: perror("epoll_wait"); result = -1; goto cleanup; //   case 0: result = 0; goto cleanup; //   default: //    for (int i = 0; i &lt; nfds; i++) { int fd = events[i].data.fd; CallbackData *callback = g_hash_table_lookup(reactor-&gt;table, &amp;fd); callback-&gt;callback(callback-&gt;arg, fd, events[i].events); } } } cleanup: free(events); return result; }</span></span></code> </pre> </div></div><br><p>  Zusammenfassend wird die Kette von Funktionsaufrufen im Benutzercode die folgende Form annehmen: </p><br><p><img src="https://habrastorage.org/webt/5r/zj/wu/5rzjwuyiu4e3f-wfvtumltvuz3i.png"></p><br><h1 id="odnopotochnyy-server">  Single-Thread-Server </h1><br><p>  Um den E / A-Reaktor unter hoher Last zu testen, schreiben wir einen einfachen HTTP-Webserver, um auf jede Anfrage mit einem Bild zu antworten. </p><br><div class="spoiler">  <b class="spoiler_title">HTTP-Protokoll-Kurz√ºbersicht</b> <div class="spoiler_text"><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">HTTP</a> ist ein Protokoll auf <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">Anwendungsebene</a> , das haupts√§chlich f√ºr die Serverinteraktion mit einem Browser verwendet wird. </p><br><p>  HTTP kann problemlos √ºber das <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">TCP-</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">Transportprotokoll hinaus</a> verwendet werden und sendet und empf√§ngt Nachrichten in dem in der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">Spezifikation</a> festgelegten Format. </p><br><h3 id="format-zaprosa">  Anforderungsformat </h3><br><pre> <code class="plaintext hljs">&lt;&gt; &lt;URI&gt; &lt; HTTP&gt;CRLF &lt; 1&gt;CRLF &lt; 2&gt;CRLF &lt; N&gt;CRLF CRLF &lt;&gt;</code> </pre> <br><ul><li>  <code>CRLF</code> ist eine Folge von zwei Zeichen: <code>\r</code> und <code>\n</code> , die die erste Abfragezeile, die √úberschriften und die Daten voneinander trennen. </li><li>  <code>&lt;&gt;</code> ist eines von <code>CONNECT</code> , <code>DELETE</code> , <code>GET</code> , <code>HEAD</code> , <code>OPTIONS</code> , <code>PATCH</code> , <code>POST</code> , <code>PUT</code> , <code>TRACE</code> .  Der Browser sendet einen <code>GET</code> Befehl an unseren Server mit der Bedeutung "Senden Sie mir den Inhalt der Datei." </li><li>  <code>&lt;URI&gt;</code> ist die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">einheitliche Ressourcenkennung</a> .  Wenn beispielsweise URI = <code>/index.html</code> , fordert der Client die Hauptseite der Site an. </li><li>  <code>&lt; HTTP&gt;</code> - HTTP-Protokollversion im <code>HTTP/XY</code> Format.  Die bislang am h√§ufigsten verwendete Version ist <code>HTTP/1.1</code> . </li><li>  <code>&lt; N&gt;</code> ist ein Schl√ºssel-Wert-Paar im Format <code>&lt;&gt;: &lt;&gt;</code> , das zur weiteren Analyse an den Server gesendet wird. </li><li>  <code>&lt;&gt;</code> - Daten, die der Server ben√∂tigt, um den Vorgang abzuschlie√üen.  Oft ist es nur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">JSON</a> oder ein anderes Format. </li></ul><br><h3 id="format-otveta">  Antwortformat </h3><br><pre> <code class="plaintext hljs">&lt; HTTP&gt; &lt; &gt; &lt; &gt;CRLF &lt; 1&gt;CRLF &lt; 2&gt;CRLF &lt; N&gt;CRLF CRLF &lt;&gt;</code> </pre> <br><ul><li>  <code>&lt; &gt;</code> ist eine Zahl, die das Ergebnis einer Operation darstellt.  Unser Server gibt immer den Status 200 zur√ºck (erfolgreicher Betrieb). </li><li>  <code>&lt; &gt;</code> - Zeichenfolgendarstellung des Statuscodes.  F√ºr Statuscode 200 ist dies <code>OK</code> . </li><li>  <code>&lt; N&gt;</code> - Ein Header mit demselben Format wie in der Anforderung.  Wir werden die Header <code>Content-Length</code> (Dateigr√∂√üe) und <code>Content-Type: text/html</code> (R√ºckgabetyp Daten) zur√ºckgeben. </li><li>  <code>&lt;&gt;</code> - vom Benutzer angeforderte Daten.  In unserem Fall ist dies der Pfad zum Bild in <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">HTML</a> . </li></ul></div></div><br><p>  Die <a href="https://github.com/Hippolot/reactor-c/blob/master/" rel="nofollow"><code>http_server.c</code></a> (Single-Threaded-Server) enth√§lt die Datei <a href="" rel="nofollow"><code>common.h</code></a> , die die folgenden Funktionsprototypen enth√§lt: </p><br><div class="spoiler">  <b class="spoiler_title">Funktionsprototypen in common.h anzeigen</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* *  ,    ,    *    . */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_accept</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *arg, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fd, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> events)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/* *  ,    ,    *   HTTP . */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_send</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *arg, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fd, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> events)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/* *  ,    ,    *    HTTP . */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_recv</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *arg, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fd, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> events)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/* *      . */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">set_nonblocking</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fd)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/* *     stderr      *  `EXIT_FAILURE`. */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> noreturn </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fail</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *format, ...)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/* *    ,    * TCP . */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">new_server</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> reuse_port)</span></span></span></span>;</code> </pre> </div></div><br><p>  Das Funktionsmakro <code>SAFE_CALL()</code> ebenfalls beschrieben und die Funktion <code>fail()</code> definiert.  Das Makro vergleicht den Wert des Ausdrucks mit dem Fehler. Wenn die Bedingung erf√ºllt ist, ruft es die Funktion <code>fail()</code> : </p><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SAFE_CALL(call, </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">error</span></span></span><span class="hljs-meta">) \ do { \ </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ((call) == </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">error</span></span></span><span class="hljs-meta">) { \ fail(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"%s"</span></span></span><span class="hljs-meta">, #call); \ } \ } while (false)</span></span></code> </pre> <br><p>  Die Funktion <code>fail()</code> die √ºbergebenen Argumente an das Terminal aus (wie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><code>printf()</code></a> ) und beendet das Programm mit dem <code>EXIT_FAILURE</code> Code: </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> noreturn </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fail</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *format, ...)</span></span></span><span class="hljs-function"> </span></span>{ va_list args; va_start(args, format); <span class="hljs-built_in"><span class="hljs-built_in">vfprintf</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">stderr</span></span>, format, args); va_end(args); <span class="hljs-built_in"><span class="hljs-built_in">fprintf</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">stderr</span></span>, <span class="hljs-string"><span class="hljs-string">": %s\n"</span></span>, strerror(errno)); <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span>(EXIT_FAILURE); }</code> </pre> <br><p>  Die Funktion <code>new_server()</code> gibt den Dateideskriptor des vom System erstellten "Server" <code>new_server()</code> zur√ºck, der die <code>new_server()</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><code>socket()</code></a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><code>bind()</code></a> und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><code>listen()</code></a> aufruft und eingehende Verbindungen im nicht blockierenden Modus annehmen kann. </p><br><div class="spoiler">  <b class="spoiler_title">Funktion anzeigen new_server ()</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">new_server</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> reuse_port)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> fd; SAFE_CALL((fd = socket(AF_INET, SOCK_STREAM | SOCK_NONBLOCK, IPPROTO_TCP)), <span class="hljs-number"><span class="hljs-number">-1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (reuse_port) { SAFE_CALL( setsockopt(fd, SOL_SOCKET, SO_REUSEPORT, &amp;(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>){<span class="hljs-number"><span class="hljs-number">1</span></span>}, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)), <span class="hljs-number"><span class="hljs-number">-1</span></span>); } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sockaddr_in</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">addr</span></span></span><span class="hljs-class"> = {</span></span>.sin_family = AF_INET, .sin_port = htons(SERVER_PORT), .sin_addr = {.s_addr = inet_addr(SERVER_IPV4)}, .sin_zero = {<span class="hljs-number"><span class="hljs-number">0</span></span>}}; SAFE_CALL(bind(fd, (struct sockaddr *)&amp;addr, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(addr)), <span class="hljs-number"><span class="hljs-number">-1</span></span>); SAFE_CALL(listen(fd, SERVER_BACKLOG), <span class="hljs-number"><span class="hljs-number">-1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fd; }</code> </pre> </div></div><br><ul><li>  Beachten Sie, dass der Socket anf√§nglich im nicht blockierenden Modus mit dem <code>SOCK_NONBLOCK</code> Flag erstellt wird, sodass der <code>on_accept()</code> Funktion <code>on_accept()</code> die Ausf√ºhrung des Streams nicht <code>on_accept()</code> . </li><li>  Wenn <code>reuse_port</code> <code>true</code> , konfiguriert diese Funktion den Socket mit der Option <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><code>SO_REUSEPORT</code></a> Verwendung von <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><code>setsockopt()</code></a> , um denselben Port in einer Umgebung mit mehreren Threads zu verwenden (siehe Abschnitt "Server mit mehreren Threads"). </li></ul><br><p>  Die Ereignisbehandlungsroutine <code>on_accept()</code> wird aufgerufen, nachdem das Betriebssystem ein <code>EPOLLIN</code> Ereignis generiert hat. In diesem Fall kann eine neue Verbindung akzeptiert werden.  <code>on_accept()</code> akzeptiert eine neue Verbindung, wechselt in den nicht blockierenden Modus und registriert sich beim <code>on_recv()</code> in der E / A-Drossel. </p><br><div class="spoiler">  <b class="spoiler_title">Funktion on_accept () anzeigen</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_accept</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *arg, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fd, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> events)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> incoming_conn; SAFE_CALL((incoming_conn = accept(fd, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>)), <span class="hljs-number"><span class="hljs-number">-1</span></span>); set_nonblocking(incoming_conn); SAFE_CALL(reactor_register(reactor, incoming_conn, EPOLLIN, on_recv, request_buffer_new()), <span class="hljs-number"><span class="hljs-number">-1</span></span>); }</code> </pre> </div></div><br><p>  Die Ereignisbehandlungsroutine <code>on_recv()</code> wird aufgerufen, nachdem das Betriebssystem ein <code>EPOLLIN</code> Ereignis generiert hat. In diesem Fall ist die von <code>on_accept()</code> registrierte Verbindung bereit, Daten zu akzeptieren. </p><br><p>  <code>on_recv()</code> liest die Daten von der Verbindung, bis die vollst√§ndige HTTP-Anforderung empfangen wurde, und registriert dann den <code>on_send()</code> Handler, um die HTTP-Antwort zu senden.  Wenn der Client die Verbindung trennt, wird die Registrierung des Sockets aufgehoben und mit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><code>close()</code></a> . </p><br><div class="spoiler">  <b class="spoiler_title">Funktion on_recv () anzeigen</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_recv</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *arg, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fd, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> events)</span></span></span><span class="hljs-function"> </span></span>{ RequestBuffer *buffer = arg; <span class="hljs-comment"><span class="hljs-comment">//      ,  recv  0   ssize_t nread; while ((nread = recv(fd, buffer-&gt;data + buffer-&gt;size, REQUEST_BUFFER_CAPACITY - buffer-&gt;size, 0)) &gt; 0) buffer-&gt;size += nread; //    if (nread == 0) { SAFE_CALL(reactor_deregister(reactor, fd), -1); SAFE_CALL(close(fd), -1); request_buffer_destroy(buffer); return; } // read  ,   ,     //  if (errno != EAGAIN &amp;&amp; errno != EWOULDBLOCK) { request_buffer_destroy(buffer); fail("read"); } //   HTTP   .    //     if (request_buffer_is_complete(buffer)) { request_buffer_clear(buffer); SAFE_CALL(reactor_reregister(reactor, fd, EPOLLOUT, on_send, buffer), -1); } }</span></span></code> </pre> </div></div><br><p>  Die Ereignisbehandlungsroutine <code>on_send()</code> wird aufgerufen, nachdem das Betriebssystem ein <code>EPOLLOUT</code> Ereignis generiert hat. <code>EPOLLOUT</code> bedeutet, dass die von <code>on_recv()</code> registrierte Verbindung zum Senden von Daten bereit ist.  Diese Funktion sendet eine HTTP-Antwort mit HTML mit dem Bild an den Client und √§ndert dann die Ereignisbehandlungsroutine erneut in <code>on_recv()</code> . </p><br><div class="spoiler">  <b class="spoiler_title">Funktion on_send () anzeigen</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_send</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *arg, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fd, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> events)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *content = <span class="hljs-string"><span class="hljs-string">"&lt;img "</span></span> <span class="hljs-string"><span class="hljs-string">"src=\"https://habrastorage.org/webt/oh/wl/23/"</span></span> <span class="hljs-string"><span class="hljs-string">"ohwl23va3b-dioerobq_mbx4xaw.jpeg\"&gt;"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> response[<span class="hljs-number"><span class="hljs-number">1024</span></span>]; <span class="hljs-built_in"><span class="hljs-built_in">sprintf</span></span>(response, <span class="hljs-string"><span class="hljs-string">"HTTP/1.1 200 OK"</span></span> CRLF <span class="hljs-string"><span class="hljs-string">"Content-Length: %zd"</span></span> CRLF <span class="hljs-string"><span class="hljs-string">"Content-Type: "</span></span> <span class="hljs-string"><span class="hljs-string">"text/html"</span></span> DOUBLE_CRLF <span class="hljs-string"><span class="hljs-string">"%s"</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>(content), content); SAFE_CALL(send(fd, response, <span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>(response), <span class="hljs-number"><span class="hljs-number">0</span></span>), <span class="hljs-number"><span class="hljs-number">-1</span></span>); SAFE_CALL(reactor_reregister(reactor, fd, EPOLLIN, on_recv, arg), <span class="hljs-number"><span class="hljs-number">-1</span></span>); }</code> </pre> </div></div><br><p>  Und schlie√ülich erstellen wir in der Datei <code>http_server.c</code> in der <code>main()</code> -Funktion einen E / A-Reaktor mit <code>reactor_new()</code> , erstellen einen Server-Socket und registrieren ihn, starten den Reaktor mit <code>reactor_run()</code> genau eine Minute und geben dann die Ressourcen frei und <code>reactor_run()</code> aus dem Programm. </p><br><div class="spoiler">  <b class="spoiler_title">Zeigen Sie http_server.c an</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"reactor.h"</span></span></span><span class="hljs-meta"> static Reactor *reactor; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"common.h"</span></span></span><span class="hljs-meta"> int main(void) { SAFE_CALL((reactor = reactor_new()), NULL); SAFE_CALL( reactor_register(reactor, new_server(false), EPOLLIN, on_accept, NULL), -1); SAFE_CALL(reactor_run(reactor, SERVER_TIMEOUT_MILLIS), -1); SAFE_CALL(reactor_destroy(reactor), -1); }</span></span></code> </pre> </div></div><br><p>  √úberpr√ºfen Sie, ob alles wie erwartet funktioniert.  Wir kompilieren ( <code>chmod a+x compile.sh &amp;&amp; ./compile.sh</code> im Stammverzeichnis des Projekts) und starten den selbstgeschriebenen Server, √∂ffnen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">http://127.0.0.1:18470</a> im Browser und beobachten, was erwartet wurde: </p><br><p><img src="https://habrastorage.org/webt/i0/za/5u/i0za5um7tbcnzqt2x7sp_vey0p8.png"></p><br><h1 id="zamer-proizvoditelnosti">  Leistungsmessung </h1><br><div class="spoiler">  <b class="spoiler_title">Zeigen Sie die Eigenschaften meines Autos</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">$ screenfetch MMMMMMMMMMMMMMMMMMMMMMMMMmds+. OS: Mint 19.1 tessa MMm----::-://////////////oymNMd+` Kernel: x86_64 Linux 4.15.0-20-generic MMd /++ -sNMd: Uptime: 2h 34m MMNso/` dMM `.::-. .-::.` .hMN: Packages: 2217 ddddMMh dMM :hNMNMNhNMNMNh: `NMm Shell: bash 4.4.20 NMm dMM .NMN/-+MMM+-/NMN` dMM Resolution: 1920x1080 NMm dMM -MMm `MMM dMM. dMM DE: Cinnamon 4.0.10 NMm dMM -MMm `MMM dMM. dMM WM: Muffin NMm dMM .mmd `mmm yMM. dMM WM Theme: Mint-Y-Dark (Mint-Y) NMm dMM` ..` ... ydm. dMM GTK Theme: Mint-Y [GTK2/3] hMM- +MMd/-------...-:sdds dMM Icon Theme: Mint-Y -NMm- :hNMNNNmdddddddddy/` dMM Font: Noto Sans 9 -dMNs-``-::::-------.`` dMM CPU: Intel Core i7-6700 @ 8x 4GHz [52.0¬∞C] `/dMNmy+/:-------------:/yMMM GPU: NV136 ./ydNMMMMMMMMMMMMMMMMMMMMM RAM: 2544MiB / 7926MiB \.MMMMMMMMMMMMMMMMMMM</code> </pre> </div></div><br><p>  Wir messen die Leistung eines Singlethread-Servers.  √ñffnen wir zwei Terminals: In einem f√ºhren wir <code>./http_server</code> , in dem anderen - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">wrk</a> .  Nach einer Minute werden die folgenden Statistiken im zweiten Terminal angezeigt: </p><br><pre> <code class="plaintext hljs">$ wrk -c100 -d1m -t8 http://127.0.0.1:18470 -H "Host: 127.0.0.1:18470" -H "Accept-Language: en-US,en;q=0.5" -H "Connection: keep-alive" Running 1m test @ http://127.0.0.1:18470 8 threads and 100 connections Thread Stats Avg Stdev Max +/- Stdev Latency 493.52us 76.70us 17.31ms 89.57% Req/Sec 24.37k 1.81k 29.34k 68.13% 11657769 requests in 1.00m, 1.60GB read Requests/sec: 193974.70 Transfer/sec: 27.19MB</code> </pre> <br><p>  Unser Single-Threaded-Server konnte √ºber 11 Millionen Anfragen pro Minute aus 100 Verbindungen verarbeiten.  Kein schlechtes Ergebnis, aber kann es verbessert werden? </p><br><h1 id="mnogopotochnyy-server">  Multithread-Server </h1><br><p>  Wie oben erw√§hnt, kann eine E / A-Drossel in getrennten Str√∂men erstellt werden, wodurch alle CPU-Kerne verwendet werden.  Wenden wir diesen Ansatz in der Praxis an: </p><br><div class="spoiler">  <b class="spoiler_title">Zeigen Sie http_server_multithreaded.c an</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"reactor.h"</span></span></span><span class="hljs-meta"> static Reactor *reactor; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> omp threadprivate(reactor) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"common.h"</span></span></span><span class="hljs-meta"> int main(void) { #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> omp parallel { SAFE_CALL((reactor = reactor_new()), NULL); SAFE_CALL(reactor_register(reactor, new_server(true), EPOLLIN, on_accept, NULL), -1); SAFE_CALL(reactor_run(reactor, SERVER_TIMEOUT_MILLIS), -1); SAFE_CALL(reactor_destroy(reactor), -1); } }</span></span></code> </pre> </div></div><br><p>  Jetzt <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">besitzt</a> jeder Thread <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">einen eigenen</a> Reaktor: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Reactor *reactor; <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> omp threadprivate(reactor)</span></span></code> </pre> <br><p>  Beachten Sie, dass das Argument f√ºr <code>new_server()</code> <code>true</code> .  Dies bedeutet, dass wir den Server-Socket auf die Option <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><code>SO_REUSEPORT</code></a> , um ihn in einer Umgebung mit mehreren Threads zu verwenden.  Sie k√∂nnen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">hier</a> mehr lesen. </p><br><h1 id="vtoroy-zahod">  Zweiter Lauf </h1><br><p>  Jetzt messen wir die Leistung eines Multithread-Servers: </p><br><pre> <code class="plaintext hljs">$ wrk -c100 -d1m -t8 http://127.0.0.1:18470 -H "Host: 127.0.0.1:18470" -H "Accept-Language: en-US,en;q=0.5" -H "Connection: keep-alive" Running 1m test @ http://127.0.0.1:18470 8 threads and 100 connections Thread Stats Avg Stdev Max +/- Stdev Latency 1.14ms 2.53ms 40.73ms 89.98% Req/Sec 79.98k 18.07k 154.64k 78.65% 38208400 requests in 1.00m, 5.23GB read Requests/sec: 635876.41 Transfer/sec: 89.14MB</code> </pre> <br><p>  Die Anzahl der bearbeiteten Anfragen in 1 Minute hat sich um das 3,28-fache erh√∂ht!  Aber bis auf die runde Zahl waren nur ~ zwei Millionen nicht genug, versuchen wir es zu beheben. </p><br><p>  Schauen Sie sich zun√§chst die von <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">perf</a> generierten Statistiken an: </p><br><pre> <code class="plaintext hljs">$ sudo perf stat -B -e task-clock,context-switches,cpu-migrations,page-faults,cycles,instructions,branches,branch-misses,cache-misses ./http_server_multithreaded Performance counter stats for './http_server_multithreaded': 242446,314933 task-clock (msec) # 4,000 CPUs utilized 1 813 074 context-switches # 0,007 M/sec 4 689 cpu-migrations # 0,019 K/sec 254 page-faults # 0,001 K/sec 895 324 830 170 cycles # 3,693 GHz 621 378 066 808 instructions # 0,69 insn per cycle 119 926 709 370 branches # 494,653 M/sec 3 227 095 669 branch-misses # 2,69% of all branches 808 664 cache-misses 60,604330670 seconds time elapsed</code> </pre> <br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">Bei Verwendung der CPU-Affinit√§t</a> f√ºhrte das Kompilieren mit <code>-march=native</code> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">PGO</a> , Erh√∂hen der Anzahl der Treffer im <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">Cache</a> , Erh√∂hen von <code>MAX_EVENTS</code> und Verwenden von <code>EPOLLET</code> zu keiner signifikanten Leistungssteigerung.  Aber was passiert, wenn Sie die Anzahl der gleichzeitigen Verbindungen erh√∂hen? </p><br><p>  Statistik f√ºr 352 gleichzeitige Verbindungen: </p><br><pre> <code class="plaintext hljs">$ wrk -c352 -d1m -t8 http://127.0.0.1:18470 -H "Host: 127.0.0.1:18470" -H "Accept-Language: en-US,en;q=0.5" -H "Connection: keep-alive" Running 1m test @ http://127.0.0.1:18470 8 threads and 352 connections Thread Stats Avg Stdev Max +/- Stdev Latency 2.12ms 3.79ms 68.23ms 87.49% Req/Sec 83.78k 12.69k 169.81k 83.59% 40006142 requests in 1.00m, 5.48GB read Requests/sec: 665789.26 Transfer/sec: 93.34MB</code> </pre> <br><p>  Man erhielt das gew√ºnschte Ergebnis und damit ein interessantes Diagramm, das die Abh√§ngigkeit der Anzahl der bearbeiteten Anfragen in 1 Minute von der Anzahl der Verbindungen zeigt: </p><br><p><img src="https://habrastorage.org/webt/od/8c/lv/od8clvvdlprsdcmslba9fz_rmmq.png"></p><br><p>  Wir sehen, dass nach ein paar hundert Verbindungen die Anzahl der verarbeiteten Anforderungen von beiden Servern stark abnimmt (in einer Multithread-Version ist dies auff√§lliger).  Hat dies mit der Implementierung des Linux TCP / IP-Stacks zu tun?  F√ºhlen Sie sich frei, Ihre Annahmen √ºber ein solches Diagrammverhalten und Optimierungen von Multithread- und Singlethread-Optionen in die Kommentare einzutragen. </p><br><hr><br><p>  Wie in den Kommentaren erw√§hnt, zeigt dieser Leistungstest nicht das Verhalten des E / A-Reaktors bei tats√§chlichen Lasten, da der Server fast immer mit der Datenbank interagiert, Protokolle anzeigt, Kryptografie mit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">TLS verwendet</a> usw., wodurch die Last heterogen (dynamisch) wird.  Tests zusammen mit Komponenten von Drittanbietern werden in einem Artikel √ºber den E / A-Prozessor durchgef√ºhrt. </p><br><h1 id="nedostatki-io-reaktora">  Nachteile des E / A-Reaktors </h1><br><p>  Sie m√ºssen verstehen, dass die E / A-Drossel nicht ohne Nachteile ist, und zwar: </p><br><ul><li>  Die Verwendung eines E / A-Reaktors in einer Umgebung mit mehreren Threads ist etwas schwieriger, weil  Sie m√ºssen die Abl√§ufe manuell verwalten. </li><li>  Die Praxis zeigt, dass die Last in den meisten F√§llen heterogen ist, was dazu f√ºhren kann, dass ein Thread abgelegt wird, w√§hrend der andere mit Arbeit geladen wird. </li><li>  Wenn eine Ereignisbehandlungsroutine den Stream blockiert, wird auch die Systemauswahl selbst blockiert, was zu schwer zu findenden Fehlern f√ºhren kann. </li></ul><br><p>  Diese Probleme werden vom <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">E / A-Proktor</a> gel√∂st, h√§ufig mit einem Scheduler, der die Last gleichm√§√üig auf den Thread-Pool verteilt, und der √ºber eine komfortablere API verf√ºgt.  Es wird sp√§ter in meinem anderen Artikel besprochen. </p><br><h1 id="zaklyuchenie">  Fazit </h1><br><p>  Damit endete unsere Reise von der Theorie direkt in den Auspuff-Profiler. </p><br><p>  Machen Sie sich keine Gedanken dar√ºber, denn es gibt viele andere, gleicherma√üen interessante Ans√§tze zum Schreiben von Netzwerksoftware mit unterschiedlichem Komfort und Geschwindigkeit.  Interessant, meiner Meinung nach, Links sind unten angegeben. </p><br><p>  Bis bald </p><br><h1 id="interesnye-proekty">  Interessante Projekte </h1><br><ul><li>  Si <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">libevent</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">libev</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">libuv</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">libevhtp</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">befreiend</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">DPDK</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">netmap</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">Pf_ring</a> </li></ul></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">Rust</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">Mio</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">Tokio</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">smoltcp</a> </li></ul></li></ul><br><h1 id="chto-eschyo-pochitat">  Was gibt es noch zu lesen? </h1><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">https://linux.die.net/man/7/socket</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">https://stackoverflow.com/questions/1050222/was-ist-der- Unterschied- zwischen-W√§hrung-und-Parallelit√§t</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">http://www.kegel.com/c10k.html</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">https://kernel.dk/io_uring.pdf</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">https://aturon.github.io/blog/2016/09/07/futures-design/</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">https://tokio.rs/blog/2019-10-scheduler/</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">https://www.artima.com/articles/io_design_patterns.html</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">https://habr.com/de/post/183832/</a> </li></ul><br></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de475896/">https://habr.com/ru/post/de475896/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de475884/index.html">L√∂sen des Problems von gezackten Linien in Verl√§ufen</a></li>
<li><a href="../de475886/index.html">Mit Amazon AI ist es ganz einfach, von Nutzern obsz√∂ne Inhalte zu verarbeiten</a></li>
<li><a href="../de475888/index.html">Vorteile der Wolkengesichtserkennung</a></li>
<li><a href="../de475892/index.html">Wie wir die Bestellung des Mittagessens im B√ºro verbessert haben (ohne Zugang zum Server)</a></li>
<li><a href="../de475894/index.html">Drei-Pass-Protokolle</a></li>
<li><a href="../de475900/index.html">Die 6 neuesten Azure-Kurse</a></li>
<li><a href="../de475902/index.html">Workflow Core - eine Business Process Engine f√ºr .Net Core</a></li>
<li><a href="../de475904/index.html">5 Notizen f√ºr den neuen Manager</a></li>
<li><a href="../de475908/index.html">10 beliebtesten Microsoft-Kurse in Russisch</a></li>
<li><a href="../de475912/index.html">So bewerten und vergleichen Sie Verschl√ºsselungsger√§te f√ºr Ethernet-Netzwerke</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>