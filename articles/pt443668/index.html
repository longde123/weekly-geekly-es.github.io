<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëµüèΩ ü§¶ üíô Voltar aos microsservi√ßos com Istio. Parte 3 üõÅ üë®üèΩ‚Äç‚úàÔ∏è üêÖ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nota perev. : A primeira parte desta s√©rie foi dedicada √† introdu√ß√£o dos recursos do Istio e √† demonstra√ß√£o deles em a√ß√£o, o segundo ao roteamento e g...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Voltar aos microsservi√ßos com Istio. Parte 3</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/443668/"><img src="https://habrastorage.org/webt/bj/j4/oy/bjj4oyjxqshrbjf5eks9sgsvbeg.png"><br><br>  <i><b>Nota</b></i>  <i><b>perev.</b></i>  <i>: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">A primeira parte</a> desta s√©rie foi dedicada √† introdu√ß√£o dos recursos do Istio e √† demonstra√ß√£o deles em a√ß√£o, o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">segundo</a> ao roteamento e gerenciamento de tr√°fego de rede bem ajustados.</i>  <i>Agora falaremos sobre seguran√ßa: para demonstrar as fun√ß√µes b√°sicas associadas a ele, o autor usa o servi√ßo de identidade Auth0, mas outros provedores podem ser configurados por analogia com ele.</i> <br><br>  Montamos um cluster Kubernetes no qual o exemplo de aplicativo de microsservi√ßo Istio e Sentiment Analysis foi implantado - foi assim que as capacidades do Istio foram demonstradas. <br><br>  Com o Istio, conseguimos manter os servi√ßos de tamanho pequeno, pois eles n√£o precisam implementar "camadas" como tentativas, Retouts, Timeouts, Disjuntores, Rastreio, Monitoramento .  Al√©m disso, usamos t√©cnicas avan√ßadas de teste e implanta√ß√£o: teste A / B, espelhamento e lan√ßamentos de can√°rios. <a name="habracut"></a><br><br><img src="https://habrastorage.org/webt/bs/x7/sc/bsx7sci6cfghlpg8_crfjyutiuk.png"><br><br>  No novo material, trataremos das camadas finais no caminho para o valor comercial: autentica√ß√£o e autoriza√ß√£o - e no Istio isso √© um verdadeiro prazer! <br><br><h2>  Autentica√ß√£o e autoriza√ß√£o no Istio </h2><br>  Eu nunca teria acreditado que me inspiraria na autentica√ß√£o e autoriza√ß√£o.  O que o Istio pode oferecer do ponto de vista tecnol√≥gico para tornar esses t√≥picos fascinantes e ainda mais, para que eles tamb√©m o inspirem? <br><br>  A resposta √© simples: o Istio transfere a responsabilidade por esses recursos dos seus servi√ßos para os proxies do Envoy.  Quando as solicita√ß√µes chegam aos servi√ßos, elas j√° est√£o autenticadas e autorizadas, ent√£o voc√™ s√≥ precisa escrever um c√≥digo √∫til para os neg√≥cios. <br><br>  Parece bom?  Vamos olhar para dentro! <br><br><h2>  Autentica√ß√£o com Auth0 </h2><br>  Usaremos o Auth0 como servidor de controle de identidade e acesso, que possui uma vers√£o de teste, que √© intuitiva de usar e eu gosto disso.  No entanto, os mesmos princ√≠pios podem ser aplicados a qualquer outra <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">implementa√ß√£o do OpenID Connect</a> : KeyCloak, IdentityServer e muitos outros. <br><br>  Primeiro, v√° para o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Portal Auth0</a> com sua conta, crie um inquilino <i>(inquilino - "inquilino", unidade l√≥gica de isolamento) para obter mais detalhes, consulte a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documenta√ß√£o</a> - aprox. Transl.)</i> E v√° para <i>Aplicativos&gt; Aplicativo padr√£o</i> , escolhendo <i>Dom√≠nio</i> , conforme mostrado na captura de tela abaixo : <br><br><img src="https://habrastorage.org/webt/1z/x1/ir/1zx1irb-9tqksk6gd8eb0feubdm.png"><br><br>  Especifique este dom√≠nio no <code>resource-manifests/istio/security/auth-policy.yaml</code> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">origem</a> ): <br><br><pre> <code class="plaintext hljs">apiVersion: authentication.istio.io/v1alpha1 kind: Policy metadata: name: auth-policy spec: targets: - name: sa-web-app - name: sa-feedback origins: - jwt: issuer: "https://{YOUR_DOMAIN}/" jwksUri: "https://{YOUR_DOMAIN}/.well-known/jwks.json" principalBinding: USE_ORIGIN</code> </pre> <br>  Com esse recurso, o Pilot <i>(um dos tr√™s componentes b√°sicos do Control Plane no Istio - aprox. Transl.)</i> Configura os Envoys para autenticar solicita√ß√µes antes de redirecion√°-las para os servi√ßos: <b><code>sa-web-app</code></b> e <b><code>sa-feedback</code></b> .  Ao mesmo tempo, a configura√ß√£o n√£o se aplica aos Envoys do <b><code>sa-frontend</code></b> , permitindo que deixemos o front-end n√£o autenticado.  Para aplicar uma pol√≠tica, execute o comando: <br><br><pre> <code class="bash hljs">$ kubectl apply -f resource-manifests/istio/security/auth-policy.yaml policy.authentication.istio.io ‚Äúauth-policy‚Äù created</code> </pre> <br>  Volte √† p√°gina e fa√ßa uma solicita√ß√£o - voc√™ ver√° que ela termina no status <i>401 N√£o autorizado</i> .  Agora redirecionamos os usu√°rios front-end para autentica√ß√£o com Auth0. <br><br><h2>  Solicitar autentica√ß√£o com Auth0 </h2><br>  Para autenticar solicita√ß√µes de usu√°rio final, voc√™ precisa criar uma API em Auth0 que represente servi√ßos autenticados (revis√µes, detalhes e classifica√ß√µes).  Para criar uma API, acesse <i>Portal Auth0&gt; APIs&gt; Criar API</i> e preencha o formul√°rio: <br><br><img src="https://habrastorage.org/webt/96/_g/b5/96_gb5wcteuxtvt-yakzlsu4a4g.png"><br><br>  As informa√ß√µes importantes aqui s√£o o <i>identificador</i> , que usaremos mais adiante no script.  Vamos escrever para n√≥s mesmos assim: <br><br><ul><li>  <b>P√∫blico</b> - <b>alvo</b> : {YOUR_AUDIENCE} </li></ul><br>  Os detalhes restantes que precisamos est√£o localizados no Portal Auth0 na se√ß√£o <i>Aplicativos</i> - selecione <i>Aplicativo de Teste</i> (ele √© criado automaticamente com a API). <br><br>  Aqui escrevemos: <br><br><ul><li>  <b>Dom√≠nio</b> : {YOUR_DOMAIN} </li><li>  <b>ID do cliente</b> : {YOUR_CLIENT_ID} </li></ul><br>  Role no <i>aplicativo de teste</i> at√© a caixa de texto URLs de retorno de chamada permitidos (URLs permitidos para o retorno de chamada), na qual indicamos o URL para o qual a chamada deve ser enviada ap√≥s a conclus√£o da autentica√ß√£o.  No nosso caso, √©: <br><br><pre> <code class="plaintext hljs">http://{EXTERNAL_IP}/callback</code> </pre> <br>  E para <i>URLs de logoff</i> permitido ( <i>URLs</i> permitidos para fazer logout), adicione: <br><br><pre> <code class="plaintext hljs">http://{EXTERNAL_IP}/logout</code> </pre> <br>  Vamos para o frontend. <br><br><h2>  Atualiza√ß√£o de front-end </h2><br>  Alterne para o ramo <code>[istio-mastery]</code> reposit√≥rio <code>[istio-mastery]</code> .  Nesse encadeamento, o c√≥digo de front-end √© alterado para redirecionar os usu√°rios para Auth0 para autentica√ß√£o e usar o token JWT em solicita√ß√µes para outros servi√ßos.  O √∫ltimo √© implementado da seguinte forma ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">App.js</a> ): <br><br><pre> <code class="javascript hljs">analyzeSentence() { fetch(<span class="hljs-string"><span class="hljs-string">'/sentiment'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">method</span></span>: <span class="hljs-string"><span class="hljs-string">'POST'</span></span>, <span class="hljs-attr"><span class="hljs-attr">headers</span></span>: { <span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>: <span class="hljs-string"><span class="hljs-string">'application/json'</span></span>, <span class="hljs-string"><span class="hljs-string">'Authorization'</span></span>: <span class="hljs-string"><span class="hljs-string">`Bearer </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${auth.getAccessToken()}</span></span></span><span class="hljs-string">`</span></span> <span class="hljs-comment"><span class="hljs-comment">// Access Token }, body: JSON.stringify({ sentence: this.textField.getValue() }) }) .then(response =&gt; response.json()) .then(data =&gt; this.setState(data)); }</span></span></code> </pre> <br>  Para converter o frontend em usar dados do inquilino em Auth0, abra <code>sa-frontend/src/services/Auth.js</code> e substitua os valores que escrevemos acima ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Auth.js</a> ): <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Config = { <span class="hljs-attr"><span class="hljs-attr">clientID</span></span>: <span class="hljs-string"><span class="hljs-string">'{YOUR_CLIENT_ID}'</span></span>, <span class="hljs-attr"><span class="hljs-attr">domain</span></span>:<span class="hljs-string"><span class="hljs-string">'{YOUR_DOMAIN}'</span></span>, <span class="hljs-attr"><span class="hljs-attr">audience</span></span>: <span class="hljs-string"><span class="hljs-string">'{YOUR_AUDIENCE}'</span></span>, <span class="hljs-attr"><span class="hljs-attr">ingressIP</span></span>: <span class="hljs-string"><span class="hljs-string">'{EXTERNAL_IP}'</span></span> <span class="hljs-comment"><span class="hljs-comment">//      }</span></span></code> </pre> <br>  O aplicativo est√° pronto.  Indique seu ID do Docker nos comandos abaixo ao criar e implantar as altera√ß√µes feitas: <br><br><pre> <code class="bash hljs">$ docker build -f sa-frontend/Dockerfile \ -t <span class="hljs-variable"><span class="hljs-variable">$DOCKER_USER_ID</span></span>/sentiment-analysis-frontend:istio-auth0 \ sa-frontend $ docker push <span class="hljs-variable"><span class="hljs-variable">$DOCKER_USER_ID</span></span>/sentiment-analysis-frontend:istio-auth0 $ kubectl <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> image deployment/sa-frontend \ sa-frontend=<span class="hljs-variable"><span class="hljs-variable">$DOCKER_USER_ID</span></span>/sentiment-analysis-frontend:istio-auth0</code> </pre> <br>  Experimente o app!  Voc√™ ser√° redirecionado para o Auth0, onde precisar√° fazer login (ou registrar-se), ap√≥s o qual ser√° enviado de volta √† p√°gina a partir da qual as solicita√ß√µes j√° autenticadas ser√£o feitas.  Se voc√™ tentar os comandos curl mencionados nas primeiras partes do artigo, receber√° um <i>C√≥digo de Status 401</i> , que indica que a solicita√ß√£o n√£o est√° autorizada. <br><br>  Vamos dar o pr√≥ximo passo - autorizar solicita√ß√µes. <br><br><h2>  Autoriza√ß√£o com Auth0 </h2><br>  A autentica√ß√£o nos permite entender quem √© o usu√°rio, mas para descobrir a que ele tem acesso, √© necess√°ria autoriza√ß√£o.  O Istio tamb√©m oferece ferramentas para isso. <br><br>  Como exemplo, criaremos dois grupos de usu√°rios (veja o diagrama abaixo): <br><br><ul><li>  <b>Usu√°rios</b> <i>(usu√°rios)</i> - com acesso apenas aos servi√ßos SA-WebApp e SA-Frontend; </li><li>  <b>Moderadores</b> - com acesso aos tr√™s servi√ßos. </li></ul><br><img src="https://habrastorage.org/webt/01/i-/dc/01i-dccinr9i1aq81atcf_qze90.png"><br>  <i>Conceito de autoriza√ß√£o</i> <br><br>  Para criar esses grupos, usaremos a extens√£o de autoriza√ß√£o Auth0 e usaremos o Istio para fornecer a eles diferentes n√≠veis de acesso. <br><br><h2>  Instala√ß√£o e configura√ß√£o da autoriza√ß√£o Auth0 </h2><br>  No portal Auth0, v√° para <i>Extens√µes</i> e instale a <i>Autoriza√ß√£o Auth0</i> .  Ap√≥s a instala√ß√£o, v√° para a <i>Extens√£o de autoriza√ß√£o</i> e, em seguida, para a configura√ß√£o do inquilino, clicando no canto superior direito e selecionando a op√ß√£o de menu apropriada <i>(Configura√ß√£o)</i> .  Ative <i>Grupos</i> e clique no bot√£o <i>Publicar regra</i> . <br><br><img src="https://habrastorage.org/webt/qo/tz/5n/qotz5nt8hpt0jcoyjav3rhkrn9g.png"><br><br><h2>  Cria√ß√£o de grupo </h2><br>  Na extens√£o de autoriza√ß√£o, v√° para <i>grupos</i> e crie um grupo de <i>moderadores</i> .  Como consideraremos todos os usu√°rios autenticados como comuns, n√£o h√° necessidade de criar um grupo adicional para eles. <br><br>  Selecione o grupo <i>Moderadores</i> , clique em <i>Adicionar membros</i> , adicione sua conta principal.  Deixe alguns usu√°rios sem nenhum grupo para garantir que o acesso seja negado a eles.  (Novos usu√°rios podem ser criados manualmente atrav√©s do <i>Portal Auth0&gt; Usu√°rios&gt; Criar Usu√°rio</i> .) <br><br><h2>  Adicionar reivindica√ß√£o de grupo ao token de acesso </h2><br>  Os usu√°rios s√£o adicionados aos grupos, mas essas informa√ß√µes devem ser refletidas nos tokens de acesso.  Para estar em conformidade com o OpenID Connect e, ao mesmo tempo, retornar os grupos de que precisamos, o token precisar√° adicionar sua <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">reivindica√ß√£o personalizada</a> .  √â implementado atrav√©s das regras de Auth0. <br><br>  Para criar uma regra, acesse o Portal Auth0 para <i>Regras</i> , clique em <i>Criar regra</i> e selecione uma regra vazia nos modelos. <br><br><img src="https://habrastorage.org/webt/k0/v6/di/k0v6diyfaeiftxaknnbfbnvfxq0.png"><br><br>  Copie o c√≥digo abaixo e salve-o como a nova regra <i>Adicionar reivindica√ß√£o de grupo</i> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">namespacedGroup.js</a> ): <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">user, context, callback</span></span></span><span class="hljs-function">) </span></span>{ context.accessToken[<span class="hljs-string"><span class="hljs-string">'https://sa.io/group'</span></span>] = user.groups[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> callback(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, user, context); }</code> </pre> <br>  <b>Nota</b> : esse c√≥digo pega o primeiro grupo de usu√°rios definido na Extens√£o de autoriza√ß√£o e o adiciona ao token de acesso como uma declara√ß√£o personalizada (em seu espa√ßo de nome, conforme exigido por Auth0). <br><br>  Volte para a p√°gina <i>Regras</i> e verifique se voc√™ tem duas regras escritas na seguinte ordem: <br><br><ul><li>  auth0-autoriza√ß√£o-extens√£o </li><li>  Adicionar reivindica√ß√£o de grupo </li></ul><br>  A ordem √© importante porque o campo do grupo recebe assincronamente a <i>regra auth0-autoriza√ß√£o-extens√£o</i> e √© adicionada como uma declara√ß√£o pela segunda regra.  O resultado √© um token de acesso: <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"https://sa.io/group"</span></span>: <span class="hljs-string"><span class="hljs-string">"Moderators"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"iss"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://sentiment-analysis.eu.auth0.com/"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"sub"</span></span>: <span class="hljs-string"><span class="hljs-string">"google-oauth2|196405271625531691872"</span></span> // [  ] }</code> </pre> <br>  Agora voc√™ precisa configurar o proxy Envoy para verificar o acesso do usu√°rio, para o qual o grupo ser√° retirado da reivindica√ß√£o ( <code>https://sa.io/group</code> ) no token de acesso retornado.  Este √© o t√≥pico da pr√≥xima se√ß√£o do artigo. <br><br><h2>  Configura√ß√£o de autoriza√ß√£o do Istio </h2><br>  Para que a autoriza√ß√£o funcione, voc√™ deve ativar o RBAC para Istio.  Para fazer isso, use a seguinte configura√ß√£o: <br><br><pre> <code class="plaintext hljs">apiVersion: "rbac.istio.io/v1alpha1" kind: RbacConfig metadata: name: default spec: mode: 'ON_WITH_INCLUSION' # 1 inclusion: services: # 2 - "sa-frontend.default.svc.cluster.local" - "sa-web-app.default.svc.cluster.local" - "sa-feedback.default.svc.cluster.local"</code> </pre> <br>  Explica√ß√µes: <br><ul><li>  1 - habilitar o RBAC apenas para servi√ßos e espa√ßos de nomes listados no campo <code>Inclusion</code> ; </li><li>  2 - liste a lista de nossos servi√ßos. </li></ul><br><br>  N√≥s aplicamos a configura√ß√£o com este comando: <br><br><pre> <code class="bash hljs">$ kubectl apply -f resource-manifests/istio/security/<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-rbac.yaml rbacconfig.rbac.istio.io/default created</code> </pre> <br>  Agora todos os servi√ßos exigem controle de acesso baseado em fun√ß√£o.  Em outras palavras, o acesso a todos os servi√ßos √© negado e resultar√° em uma resposta do <code>RBAC: access denied</code> .  Agora permita o acesso a usu√°rios autorizados. <br><br><h2>  Configura√ß√£o de acesso para usu√°rios regulares </h2><br>  Todos os usu√°rios devem ter acesso aos servi√ßos SA-Frontend e SA-WebApp.  Implementado usando os seguintes recursos do Istio: <br><br><ul><li>  <b>ServiceRole</b> - define os direitos que o usu√°rio possui; </li><li>  <b>ServiceRoleBinding</b> - Determina a quem esse ServiceRole pertence. </li></ul><br>  Para usu√°rios comuns, permita o acesso a determinados servi√ßos ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">servicerole.yaml</a> ): <br><br><pre> <code class="plaintext hljs">apiVersion: "rbac.istio.io/v1alpha1" kind: ServiceRole metadata: name: regular-user namespace: default spec: rules: - services: - "sa-frontend.default.svc.cluster.local" - "sa-web-app.default.svc.cluster.local" paths: ["*"] methods: ["*"]</code> </pre> <br>  E por meio <code>regular-user-binding</code> aplique um ServiceRole a todos os visitantes da p√°gina ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">regular-user-service-function-binding.yaml</a> ): <br><br><pre> <code class="plaintext hljs">apiVersion: "rbac.istio.io/v1alpha1" kind: ServiceRoleBinding metadata: name: regular-user-binding namespace: default spec: subjects: - user: "*" roleRef: kind: ServiceRole name: "regular-user"</code> </pre> <br>  "Todos os usu√°rios" significa que usu√°rios n√£o autenticados ter√£o acesso ao SA WebApp?  N√£o, a pol√≠tica verificar√° a validade do token JWT. <br><br>  Aplique a configura√ß√£o: <br><br><pre> <code class="bash hljs">$ kubectl apply -f resource-manifests/istio/security/user-role.yaml servicerole.rbac.istio.io/regular-user created servicerolebinding.rbac.istio.io/regular-user-binding created</code> </pre> <br><h2>  Configura√ß√£o de acesso para moderadores </h2><br>  Para moderadores, queremos habilitar o acesso a todos os servi√ßos ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">mod-service-role.yaml</a> ): <br><br><pre> <code class="plaintext hljs">apiVersion: "rbac.istio.io/v1alpha1" kind: ServiceRole metadata: name: mod-user namespace: default spec: rules: - services: ["*"] paths: ["*"] methods: ["*"]</code> </pre> <br>  Mas queremos esses direitos apenas para os usu√°rios cujo token de acesso tem uma reivindica√ß√£o <code>https://sa.io/group</code> com o valor <code>Moderators</code> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">mod-service-role-binding.yaml</a> ): <br><br><pre> <code class="plaintext hljs">apiVersion: "rbac.istio.io/v1alpha1" kind: ServiceRoleBinding metadata: name: mod-user-binding namespace: default spec: subjects: - properties: request.auth.claims[https://sa.io/group]: "Moderators" roleRef: kind: ServiceRole name: "mod-user"</code> </pre> <br>  Aplique a configura√ß√£o: <br><br><pre> <code class="bash hljs">$ kubectl apply -f resource-manifests/istio/security/mod-role.yaml servicerole.rbac.istio.io/mod-user created servicerolebinding.rbac.istio.io/mod-user-binding created</code> </pre> <br>  Devido ao armazenamento em cache em enviados, pode levar alguns minutos para que as regras de autoriza√ß√£o entrem em vigor.  Depois disso, voc√™ pode garantir que usu√°rios e moderadores tenham n√≠veis de acesso diferentes. <br><br><h2>  Conclus√£o sobre esta parte </h2><br>  Bem, falando s√©rio: voc√™ j√° viu uma abordagem mais simples, sem esfor√ßo, escal√°vel e segura para autentica√ß√£o e autoriza√ß√£o? <br><br>  Apenas tr√™s recursos do Istio (RbacConfig, ServiceRole e ServiceRoleBinding) foram necess√°rios para obter um controle mais preciso da autentica√ß√£o e autoriza√ß√£o do acesso do usu√°rio final aos servi√ßos. <br><br>  Al√©m disso, resolvemos esses problemas de nossos servi√ßos no enviado, conseguindo: <br><br><ul><li>  Reduzir a quantidade de c√≥digo de amostra que pode incluir problemas e bugs de seguran√ßa; </li><li>  reduzindo o n√∫mero de situa√ß√µes est√∫pidas nas quais um ponto final se tornou acess√≠vel a partir do exterior e esqueceu de denunci√°-lo; </li><li>  eliminando a necessidade de atualizar todos os servi√ßos sempre que uma nova fun√ß√£o ou direito √© adicionado; </li><li>  que os novos servi√ßos permane√ßam simples, seguros e r√°pidos. </li></ul><br><h2>  Conclus√£o </h2><br>  O Istio permite que as equipes concentrem seus recursos em tarefas essenciais aos neg√≥cios sem adicionar sobrecarga aos servi√ßos, retornando-os ao status micro. <br><br>  O artigo (em tr√™s partes) forneceu conhecimentos b√°sicos e instru√ß√µes pr√°ticas prontas para iniciar o trabalho com o Istio em projetos reais. <br><br><h2>  PS do tradutor </h2><br>  Leia tamb√©m em nosso blog: <br><br><ul><li>  "Voltar aos microsservi√ßos com o Istio": <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">parte 1 (familiaridade com os principais recursos)</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">parte 2 (roteamento, gerenciamento de tr√°fego)</a> ; </li><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Condu√≠te - uma malha de servi√ßo leve para o Kubernetes</a> "; </li><li>  ‚Äú <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O que √© uma malha de servi√ßo e por que preciso dela [para um aplicativo em nuvem com microsservi√ßos]?</a>  " </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt443668/">https://habr.com/ru/post/pt443668/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt443658/index.html">Configurando o cluster de alta disponibilidade do Kubernetes em bare metal, monitoramento, logs e exemplos de uso. Parte 3/3</a></li>
<li><a href="../pt443660/index.html">Especialistas: ‚ÄúUm scanner 3D custa 10 vezes mais barato que um erro no controle de qualidade tradicional‚Äù</a></li>
<li><a href="../pt443662/index.html">Entendendo o c√≥digo limpo no Android</a></li>
<li><a href="../pt443664/index.html">Esta√ß√£o Meteorol√≥gica Arduino</a></li>
<li><a href="../pt443666/index.html">Nossa abordagem para colorir linhas</a></li>
<li><a href="../pt443670/index.html">Erro na nova vers√£o do Google Chrome (73.0.3683.75)</a></li>
<li><a href="../pt443672/index.html">Teste Baseado em Risco</a></li>
<li><a href="../pt443676/index.html">Vinil em vez de selo postal: raridade incomum</a></li>
<li><a href="../pt443678/index.html">Legibilidade do c√≥digo</a></li>
<li><a href="../pt443680/index.html">Semana de trabalho de quatro dias. Experi√™ncia russa</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>