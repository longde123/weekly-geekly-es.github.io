<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>âºï¸ ğŸï¸ ğŸ“¡ Spark SQLã€‚ å…³äºæŸ¥è¯¢ä¼˜åŒ–å™¨çš„ä¸€äº›çŸ¥è¯† âï¸ â˜¦ï¸ ğŸ‘©â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="å¤§å®¶å¥½ ä½œä¸ºä»‹ç»ï¼Œæˆ‘æƒ³å‘Šè¯‰ä½ æˆ‘æ˜¯å¦‚ä½•ç”Ÿæ´»çš„ã€‚ 



 ç‰¹åˆ«æ˜¯åœ¨ä¸å¤§æ•°æ®å’ŒSparkä¼šé¢ä¹‹å‰ï¼Œæˆ‘ç»å¸¸è¦ä¼˜åŒ–SQLæŸ¥è¯¢ï¼Œé¦–å…ˆæ˜¯é’ˆå¯¹MSSQLï¼Œç„¶åé’ˆå¯¹Oracleï¼Œç„¶åé‡åˆ°äº†SparkSQLã€‚ 



 è€Œä¸”ï¼Œå¦‚æœå·²ç»æœ‰å¾ˆå¤šå…³äºDBMSçš„å¥½ä¹¦æ¥æè¿°æ–¹æ³•è®ºå’Œâ€œç¬”â€ï¼Œæ‚¨å¯ä»¥å°†å®ƒä»¬å¼„å¼¯ä»¥è·å¾—æœ€ä½³çš„æŸ¥è¯¢è®¡åˆ’ï¼Œ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Spark SQLã€‚ å…³äºæŸ¥è¯¢ä¼˜åŒ–å™¨çš„ä¸€äº›çŸ¥è¯†</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/neoflex/blog/417103/"><p> å¤§å®¶å¥½ ä½œä¸ºä»‹ç»ï¼Œæˆ‘æƒ³å‘Šè¯‰ä½ æˆ‘æ˜¯å¦‚ä½•ç”Ÿæ´»çš„ã€‚ <br></p><br><p> ç‰¹åˆ«æ˜¯åœ¨ä¸å¤§æ•°æ®å’ŒSparkä¼šé¢ä¹‹å‰ï¼Œæˆ‘ç»å¸¸è¦ä¼˜åŒ–SQLæŸ¥è¯¢ï¼Œé¦–å…ˆæ˜¯é’ˆå¯¹MSSQLï¼Œç„¶åé’ˆå¯¹Oracleï¼Œç„¶åé‡åˆ°äº†SparkSQLã€‚ <br></p><br><p> è€Œä¸”ï¼Œå¦‚æœå·²ç»æœ‰å¾ˆå¤šå…³äºDBMSçš„å¥½ä¹¦æ¥æè¿°æ–¹æ³•è®ºå’Œâ€œç¬”â€ï¼Œæ‚¨å¯ä»¥å°†å®ƒä»¬å¼„å¼¯ä»¥è·å¾—æœ€ä½³çš„æŸ¥è¯¢è®¡åˆ’ï¼Œé‚£ä¹ˆæˆ‘è¿˜æ²¡æœ‰çœ‹åˆ°å…³äºSparkçš„è¿™äº›ä¹¦ã€‚ æˆ‘é‡åˆ°äº†æ›´å¤šçš„æ–‡ç« å’Œå®è·µé›†ï¼Œå®ƒä»¬ä¸é€šè¿‡RDD / Dataset APIè€Œéçº¯SQLè¿›è¡Œå·¥ä½œæœ‰å…³ã€‚ å¯¹æˆ‘è€Œè¨€ï¼Œå…³äºSQLä¼˜åŒ–çš„å‚è€ƒä¹¦ä¹‹ä¸€æ˜¯J. Lewisçš„ä¹¦Oracleã€‚ æˆæœ¬ä¼˜åŒ–çš„åŸºç¡€ã€‚â€ æˆ‘åœ¨å¯»æ‰¾æ·±åº¦ç›¸ä¼¼çš„ä¸œè¥¿ã€‚ ä¸ºä»€ä¹ˆç ”ç©¶ä¸»é¢˜ä¸“é—¨æ˜¯SparkSQLï¼Œè€Œä¸æ˜¯åŸºç¡€APIï¼Ÿ ç„¶åï¼Œå…´è¶£æ˜¯ç”±æˆ‘æ­£åœ¨ä»äº‹çš„é¡¹ç›®çš„åŠŸèƒ½å¼•èµ·çš„ã€‚ <br></p><br><img src="https://habrastorage.org/webt/po/1f/un/po1fun6vgbktou6lykepwmrncci.jpeg"><br><a name="habracut"></a><br><p> å¯¹äºæˆ‘ä»¬çš„ä¸€ä½å®¢æˆ·ï¼Œæˆ‘ä»¬å…¬å¸æ­£åœ¨å¼€å‘ä¸€ä¸ªæ•°æ®ä»“åº“ï¼Œè¯¥ä»“åº“çš„è¯¦ç»†å±‚å’Œéƒ¨åˆ†å±•ç¤ºç”¨ä¾‹åœ¨Hadoopé›†ç¾¤ä¸­ï¼Œè€Œæœ€ç»ˆå±•ç¤ºç”¨ä¾‹åœ¨Oracleä¸­ã€‚ è¯¥é¡¹ç›®æ¶‰åŠå¹¿æ³›çš„æ•°æ®è½¬æ¢å±‚ï¼Œè¯¥å±‚åœ¨Sparkä¸Šå®ç°ã€‚ ä¸ºäº†åŠ å¿«ä¸ç†Ÿæ‚‰å¤æ‚çš„å¤§æ•°æ®æŠ€æœ¯ä½†ç†Ÿæ‚‰SQLå’ŒETLå·¥å…·çš„ETLå¼€å‘äººå‘˜çš„å¼€å‘å’Œè¿æ¥é€Ÿåº¦ï¼Œå¼€å‘äº†ä¸€ç§å·¥å…·ï¼Œè¯¥å·¥å…·åœ¨æ„è¯†å½¢æ€ä¸Šæé†’å…¶ä»–ETLå·¥å…·ï¼Œä¾‹å¦‚Informaticaï¼Œå¹¶å…è®¸æ‚¨åœ¨å¯è§†åŒ–çš„æƒ…å†µä¸‹è®¾è®¡ä¸‹ä¸€ä»£ETLæµç¨‹ã€‚ Sparkçš„ä»£ç ã€‚ ç”±äºç®—æ³•çš„å¤æ‚æ€§å’Œå¤§é‡çš„è½¬æ¢ï¼Œå¼€å‘äººå‘˜ä¸»è¦ä½¿ç”¨SparkSQLæŸ¥è¯¢ã€‚ <br></p><br><p> è¿™å°±æ˜¯æ•…äº‹çš„å¼€å§‹ï¼Œå› ä¸ºæˆ‘ä¸å¾—ä¸å›ç­”è®¸å¤šå½¢å¼çš„é—®é¢˜ï¼šâ€œä¸ºä»€ä¹ˆæŸ¥è¯¢ä¸èƒ½åƒåœ¨Oracleä¸­é‚£æ ·å·¥ä½œ/å·¥ä½œç¼“æ…¢/ä¸èƒ½åƒåœ¨Oracleä¸­é‚£æ ·å·¥ä½œï¼Ÿâ€ã€‚ è¿™å¯¹æˆ‘æ¥è¯´æ˜¯æœ€æœ‰è¶£çš„éƒ¨åˆ†ï¼šâ€œä¸ºä»€ä¹ˆå®ƒå·¥ä½œç¼“æ…¢ï¼Ÿâ€ã€‚ æ­¤å¤–ï¼Œä¸æˆ‘ä¹‹å‰ä½¿ç”¨è¿‡çš„DBMSä¸åŒï¼Œæ‚¨å¯ä»¥è¿›å…¥æºä»£ç å¹¶è·å¾—é—®é¢˜çš„ç­”æ¡ˆã€‚ <br></p><cut text="    "></cut><br><h2> å±€é™æ€§å’Œå‡è®¾ </h2><br><p>  Spark 2.3.0ç”¨äºè¿è¡Œç¤ºä¾‹å’Œåˆ†ææºä»£ç ã€‚ <br> å‡å®šè¯»è€…ç†Ÿæ‚‰Sparkæ¶æ„ä»¥åŠå…¶ä¸­ä¸€ç§DBMSçš„æŸ¥è¯¢ä¼˜åŒ–å™¨çš„ä¸€èˆ¬åŸç†ã€‚ è‡³å°‘ï¼Œâ€œæŸ¥è¯¢è®¡åˆ’â€è¿™ä¸€çŸ­è¯­å½“ç„¶åº”è¯¥ä¸è¶³ä¸ºå¥‡ã€‚ <br></p><br><p> æ­¤å¤–ï¼Œæœ¬æ–‡ä¹Ÿå°è¯•ä¸å°†Sparkä¼˜åŒ–å™¨ä»£ç ç¿»è¯‘æˆä¿„æ–‡ï¼Œå› æ­¤å¯¹äºä»ä¼˜åŒ–å™¨çš„è§’åº¦æ¥çœ‹éå¸¸æœ‰è¶£ä½†å¯ä»¥åœ¨æºä»£ç ä¸­è¯»å–çš„å†…å®¹ï¼Œæ­¤å¤„å°†ç®€å•åœ°é€šè¿‡å¼•ç”¨ç›¸åº”ç±»çš„é“¾æ¥è¿›è¡Œç®€è¦ä»‹ç»ã€‚ <br></p><br><h2> ç»§ç»­å­¦ä¹  </h2><br><p> è®©æˆ‘ä»¬ä»ä¸€ä¸ªå°çš„æŸ¥è¯¢å¼€å§‹ï¼Œæ¢ç´¢å®ƒä»è§£æåˆ°æ‰§è¡Œçš„åŸºæœ¬é˜¶æ®µã€‚ <br></p><br><pre><code class="scala hljs">scala&gt; spark.read.orc(<span class="hljs-string"><span class="hljs-string">"/user/test/balance"</span></span>).createOrReplaceTempView(<span class="hljs-string"><span class="hljs-string">"bal"</span></span>) scala&gt; spark.read.orc(<span class="hljs-string"><span class="hljs-string">"/user/test/customer"</span></span>).createOrReplaceTempView(<span class="hljs-string"><span class="hljs-string">"cust"</span></span>) scala&gt; <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> df = spark.sql(<span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">" | select bal.account_rk, cust.full_name | from bal | join cust | on bal.party_rk = cust.party_rk | and bal.actual_date = cust.actual_date | where bal.actual_date = cast('2017-12-31' as date) | "</span></span><span class="hljs-string"><span class="hljs-string">""</span></span>) df: org.apache.spark.sql.<span class="hljs-type"><span class="hljs-type">DataFrame</span></span> = [account_rk: decimal(<span class="hljs-number"><span class="hljs-number">38</span></span>,<span class="hljs-number"><span class="hljs-number">18</span></span>), full_name: string] scala&gt; df.explain(<span class="hljs-literal"><span class="hljs-literal">true</span></span>)</code> </pre> <br><p> è´Ÿè´£è§£æSQLå’Œä¼˜åŒ–æŸ¥è¯¢æ‰§è¡Œè®¡åˆ’çš„ä¸»è¦æ¨¡å—æ˜¯Spark Catalystã€‚ <br></p><br><p> è¯·æ±‚è®¡åˆ’è¯´æ˜ä¸­çš„æ‰©å±•è¾“å‡ºï¼ˆdf.explainï¼ˆtrueï¼‰ï¼‰ä½¿æ‚¨å¯ä»¥è·Ÿè¸ªè¯·æ±‚ç»è¿‡çš„æ‰€æœ‰é˜¶æ®µï¼š <br></p><br><ul><li> è§£æçš„é€»è¾‘è®¡åˆ’-è§£æSQLåè·å–ã€‚ åœ¨æ­¤é˜¶æ®µï¼Œä»…æ£€æŸ¥è¯·æ±‚çš„è¯­æ³•æ­£ç¡®æ€§ã€‚ </li></ul><br><pre> <code class="hljs rust">== Parsed Logical Plan == <span class="hljs-symbol"><span class="hljs-symbol">'Project</span></span> [<span class="hljs-symbol"><span class="hljs-symbol">'bal</span></span>.account_rk, <span class="hljs-symbol"><span class="hljs-symbol">'cust</span></span>.full_name] +- <span class="hljs-symbol"><span class="hljs-symbol">'Filter</span></span> (<span class="hljs-symbol"><span class="hljs-symbol">'bal</span></span>.actual_date = cast(<span class="hljs-number"><span class="hljs-number">2017</span></span>-<span class="hljs-number"><span class="hljs-number">12</span></span>-<span class="hljs-number"><span class="hljs-number">31</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> date)) +- <span class="hljs-symbol"><span class="hljs-symbol">'Join</span></span> Inner, ((<span class="hljs-symbol"><span class="hljs-symbol">'bal</span></span>.party_rk = <span class="hljs-symbol"><span class="hljs-symbol">'cust</span></span>.party_rk) &amp;&amp; (<span class="hljs-symbol"><span class="hljs-symbol">'bal</span></span>.actual_date = <span class="hljs-symbol"><span class="hljs-symbol">'cust</span></span>.actual_date)) :- <span class="hljs-symbol"><span class="hljs-symbol">'UnresolvedRelation</span></span> `bal` +- <span class="hljs-symbol"><span class="hljs-symbol">'UnresolvedRelation</span></span> `cust`</code> </pre><br><ul><li> åˆ†æçš„é€»è¾‘è®¡åˆ’-åœ¨æ­¤é˜¶æ®µï¼Œå°†æ·»åŠ æœ‰å…³æ‰€ç”¨å®ä½“çš„ç»“æ„çš„ä¿¡æ¯ï¼Œå¹¶æ£€æŸ¥ç»“æ„ä¸æ‰€è¯·æ±‚å±æ€§çš„å¯¹åº”å…³ç³»ã€‚ </li></ul><br><pre> <code class="hljs delphi">== Analyzed Logical Plan == account_rk: decimal(<span class="hljs-number"><span class="hljs-number">38</span></span>,<span class="hljs-number"><span class="hljs-number">18</span></span>), full_name: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Project [account_rk<span class="hljs-string"><span class="hljs-string">#1</span></span>, full_name<span class="hljs-string"><span class="hljs-string">#59</span></span>] +- Filter (actual_date<span class="hljs-string"><span class="hljs-string">#27</span></span> = cast(<span class="hljs-number"><span class="hljs-number">2017</span></span>-<span class="hljs-number"><span class="hljs-number">12</span></span>-<span class="hljs-number"><span class="hljs-number">31</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> date)) +- Join Inner, ((party_rk<span class="hljs-string"><span class="hljs-string">#18</span></span> = party_rk<span class="hljs-string"><span class="hljs-string">#57</span></span>) &amp;&amp; (actual_date<span class="hljs-string"><span class="hljs-string">#27</span></span> = actual_date<span class="hljs-string"><span class="hljs-string">#88</span></span>)) :- SubqueryAlias bal : +- Relation[ACTUAL_END_DATE<span class="hljs-string"><span class="hljs-string">#0</span></span>,ACCOUNT_RK<span class="hljs-string"><span class="hljs-string">#1</span></span>,... <span class="hljs-number"><span class="hljs-number">4</span></span> more fields] orc +- SubqueryAlias cust +- Relation[ACTUAL_END_DATE<span class="hljs-string"><span class="hljs-string">#56</span></span>,PARTY_RK<span class="hljs-string"><span class="hljs-string">#57</span></span>... <span class="hljs-number"><span class="hljs-number">9</span></span> more fields] orc</code> </pre><br><ul><li> ä¼˜åŒ–é€»è¾‘è®¡åˆ’å¯¹æˆ‘ä»¬æ¥è¯´æ˜¯æœ€æœ‰è¶£çš„ã€‚ åœ¨æ­¤é˜¶æ®µï¼Œå°†åŸºäºå¯ç”¨çš„ä¼˜åŒ–è§„åˆ™æ¥è½¬æ¢ç»“æœæŸ¥è¯¢æ ‘ã€‚ </li></ul><br><pre> <code class="hljs delphi">== Optimized Logical Plan == Project [account_rk<span class="hljs-string"><span class="hljs-string">#1</span></span>, full_name<span class="hljs-string"><span class="hljs-string">#59</span></span>] +- Join Inner, ((party_rk<span class="hljs-string"><span class="hljs-string">#18</span></span> = party_rk<span class="hljs-string"><span class="hljs-string">#57</span></span>) &amp;&amp; (actual_date<span class="hljs-string"><span class="hljs-string">#27</span></span> = actual_date<span class="hljs-string"><span class="hljs-string">#88</span></span>)) :- Project [ACCOUNT_RK<span class="hljs-string"><span class="hljs-string">#1</span></span>, PARTY_RK<span class="hljs-string"><span class="hljs-string">#18</span></span>, ACTUAL_DATE<span class="hljs-string"><span class="hljs-string">#27</span></span>] : +- Filter ((isnotnull(actual_date<span class="hljs-string"><span class="hljs-string">#27</span></span>) &amp;&amp; (actual_date<span class="hljs-string"><span class="hljs-string">#27</span></span> = <span class="hljs-number"><span class="hljs-number">17531</span></span>)) &amp;&amp; isnotnull(party_rk<span class="hljs-string"><span class="hljs-string">#18</span></span>)) : +- Relation[ACTUAL_END_DATE<span class="hljs-string"><span class="hljs-string">#0</span></span>,ACCOUNT_RK<span class="hljs-string"><span class="hljs-string">#1</span></span>,... <span class="hljs-number"><span class="hljs-number">4</span></span> more fields] orc +- Project [PARTY_RK<span class="hljs-string"><span class="hljs-string">#57</span></span>, FULL_NAME<span class="hljs-string"><span class="hljs-string">#59</span></span>, ACTUAL_DATE<span class="hljs-string"><span class="hljs-string">#88</span></span>] +- Filter ((isnotnull(actual_date<span class="hljs-string"><span class="hljs-string">#88</span></span>) &amp;&amp; isnotnull(party_rk<span class="hljs-string"><span class="hljs-string">#57</span></span>)) &amp;&amp; (actual_date<span class="hljs-string"><span class="hljs-string">#88</span></span> = <span class="hljs-number"><span class="hljs-number">17531</span></span>)) +- Relation[ACTUAL_END_DATE<span class="hljs-string"><span class="hljs-string">#56</span></span>,PARTY_RK<span class="hljs-string"><span class="hljs-string">#57</span></span>,... <span class="hljs-number"><span class="hljs-number">9</span></span> more fields] orc</code> </pre><br><ul><li> ç‰©ç†è®¡åˆ’-å¼€å§‹è€ƒè™‘è®¿é—®æºæ•°æ®çš„åŠŸèƒ½ï¼ŒåŒ…æ‹¬ä¼˜åŒ–è¿‡æ»¤åˆ†åŒºå’Œæ•°æ®ä»¥æœ€å°åŒ–ç»“æœæ•°æ®é›†çš„åŠŸèƒ½ã€‚ é€‰æ‹©äº†è”æ¥æ‰§è¡Œç­–ç•¥ï¼ˆæœ‰å…³å¯ç”¨é€‰é¡¹çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§ä¸‹æ–‡ï¼‰ã€‚ </li></ul><br><pre> <code class="hljs pgsql">== Physical Plan == *(<span class="hljs-number"><span class="hljs-number">2</span></span>) Project [account_rk#<span class="hljs-number"><span class="hljs-number">1</span></span>, full_name#<span class="hljs-number"><span class="hljs-number">59</span></span>] +- *(<span class="hljs-number"><span class="hljs-number">2</span></span>) BroadcastHashJoin [party_rk#<span class="hljs-number"><span class="hljs-number">18</span></span>, actual_date#<span class="hljs-number"><span class="hljs-number">27</span></span>], [party_rk#<span class="hljs-number"><span class="hljs-number">57</span></span>, actual_date#<span class="hljs-number"><span class="hljs-number">88</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">Inner</span></span>, BuildRight :- *(<span class="hljs-number"><span class="hljs-number">2</span></span>) Project [ACCOUNT_RK#<span class="hljs-number"><span class="hljs-number">1</span></span>, PARTY_RK#<span class="hljs-number"><span class="hljs-number">18</span></span>, ACTUAL_DATE#<span class="hljs-number"><span class="hljs-number">27</span></span>] : +- *(<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">Filter</span></span> isnotnull(party_rk#<span class="hljs-number"><span class="hljs-number">18</span></span>) : +- *(<span class="hljs-number"><span class="hljs-number">2</span></span>) FileScan orc [ACCOUNT_RK#<span class="hljs-number"><span class="hljs-number">1</span></span>,PARTY_RK#<span class="hljs-number"><span class="hljs-number">18</span></span>,ACTUAL_DATE#<span class="hljs-number"><span class="hljs-number">27</span></span>] Batched: <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">Format</span></span>: ORC, <span class="hljs-keyword"><span class="hljs-keyword">Location</span></span>: InMemoryFileIndex[hdfs://<span class="hljs-keyword"><span class="hljs-keyword">cluster</span></span>:<span class="hljs-number"><span class="hljs-number">8020</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>/test/balance], PartitionCount: <span class="hljs-number"><span class="hljs-number">1</span></span>, PartitionFilters: [isnotnull(ACTUAL_DATE#<span class="hljs-number"><span class="hljs-number">27</span></span>), (ACTUAL_DATE#<span class="hljs-number"><span class="hljs-number">27</span></span> = <span class="hljs-number"><span class="hljs-number">17531</span></span>)], PushedFilters: [IsNotNull(PARTY_RK)], ReadSchema: struct&lt;ACCOUNT_RK:<span class="hljs-type"><span class="hljs-type">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">38</span></span>,<span class="hljs-number"><span class="hljs-number">18</span></span>),PARTY_RK:<span class="hljs-type"><span class="hljs-type">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">38</span></span>,<span class="hljs-number"><span class="hljs-number">18</span></span>)&gt; +- BroadcastExchange HashedRelationBroadcastMode(List(<span class="hljs-keyword"><span class="hljs-keyword">input</span></span>[<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-type"><span class="hljs-type">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">38</span></span>,<span class="hljs-number"><span class="hljs-number">18</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">input</span></span>[<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-type"><span class="hljs-type">date</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>])) +- *(<span class="hljs-number"><span class="hljs-number">1</span></span>) Project [PARTY_RK#<span class="hljs-number"><span class="hljs-number">57</span></span>, FULL_NAME#<span class="hljs-number"><span class="hljs-number">59</span></span>, ACTUAL_DATE#<span class="hljs-number"><span class="hljs-number">88</span></span>] +- *(<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">Filter</span></span> isnotnull(party_rk#<span class="hljs-number"><span class="hljs-number">57</span></span>) +- *(<span class="hljs-number"><span class="hljs-number">1</span></span>) FileScan orc [PARTY_RK#<span class="hljs-number"><span class="hljs-number">57</span></span>,FULL_NAME#<span class="hljs-number"><span class="hljs-number">59</span></span>,ACTUAL_DATE#<span class="hljs-number"><span class="hljs-number">88</span></span>] Batched: <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">Format</span></span>: ORC, <span class="hljs-keyword"><span class="hljs-keyword">Location</span></span>: InMemoryFileIndex[hdfs://<span class="hljs-keyword"><span class="hljs-keyword">cluster</span></span>:<span class="hljs-number"><span class="hljs-number">8020</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>/test/customer], PartitionCount: <span class="hljs-number"><span class="hljs-number">1</span></span>, PartitionFilters: [isnotnull(ACTUAL_DATE#<span class="hljs-number"><span class="hljs-number">88</span></span>), (ACTUAL_DATE#<span class="hljs-number"><span class="hljs-number">88</span></span> = <span class="hljs-number"><span class="hljs-number">17531</span></span>)], PushedFilters: [IsNotNull(PARTY_RK)], ReadSchema: struct&lt;PARTY_RK:<span class="hljs-type"><span class="hljs-type">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">38</span></span>,<span class="hljs-number"><span class="hljs-number">18</span></span>),FULL_NAME:string&gt;</code> </pre><br><p> ä¼˜åŒ–å’Œæ‰§è¡Œçš„ä»¥ä¸‹é˜¶æ®µï¼ˆä¾‹å¦‚ï¼ŒWholeStageCodegenï¼‰ä¸åœ¨æœ¬æ–‡è®¨è®ºèŒƒå›´ä¹‹å†…ï¼Œä½†åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Mastering Spark Sql</a>ä¸­è¿›è¡Œäº†è¯¦ç»†æè¿°ï¼ˆä»¥åŠä¸Šè¿°é˜¶æ®µï¼‰ã€‚ <br></p><br><p> è¯»å–æŸ¥è¯¢æ‰§è¡Œè®¡åˆ’é€šå¸¸æ˜¯â€œä»å†…éƒ¨â€å’Œâ€œä»åº•éƒ¨åˆ°é¡¶éƒ¨â€è¿›è¡Œçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæœ€åµŒå¥—çš„éƒ¨åˆ†é¦–å…ˆæ‰§è¡Œï¼Œç„¶åé€æ¸å‰è¿›åˆ°ä½äºæœ€é¡¶éƒ¨çš„æœ€ç»ˆæŠ•å½±ã€‚ <br></p><br><h2> æŸ¥è¯¢ä¼˜åŒ–å™¨çš„ç±»å‹ </h2><br><p> å¯ä»¥åŒºåˆ†ä¸¤ç§ç±»å‹çš„æŸ¥è¯¢ä¼˜åŒ–å™¨ï¼š </p><br><ul><li> åŸºäºè§„åˆ™çš„ä¼˜åŒ–å™¨ï¼ˆRBOï¼‰ã€‚ </li><li> ä¼˜åŒ–ç¨‹åºåŸºäºå¯¹æŸ¥è¯¢æ‰§è¡Œæˆæœ¬çš„ä¼°ç®—ï¼ˆåŸºäºæˆæœ¬çš„ä¼˜åŒ–å™¨ï¼ŒCBOï¼‰ã€‚ </li></ul><br><p> ç¬¬ä¸€ä¸ªé›†ä¸­åœ¨ä¸€ç»„å›ºå®šè§„åˆ™çš„ä½¿ç”¨ä¸Šï¼Œä¾‹å¦‚ï¼Œåœ¨è¾ƒæ—©é˜¶æ®µä»é‚£é‡Œè¿‡æ»¤æ¡ä»¶çš„åº”ç”¨ï¼Œå¦‚æœå¯èƒ½çš„è¯ï¼Œå¸¸æ•°çš„è®¡ç®—ç­‰ã€‚ <br></p><br><p> ä¸ºäº†è¯„ä¼°ç»“æœè®¡åˆ’çš„è´¨é‡ï¼ŒCBOä¼˜åŒ–å™¨ä½¿ç”¨äº†æˆæœ¬å‡½æ•°ï¼Œè¯¥å‡½æ•°é€šå¸¸å–å†³äºå¤„ç†çš„æ•°æ®é‡ï¼Œè¿‡æ»¤å™¨ä¸‹çš„è¡Œæ•°ä»¥åŠæ‰§è¡ŒæŸäº›æ“ä½œçš„æˆæœ¬ã€‚ <br></p><br><p> è¦äº†è§£æœ‰å…³Apache Sparkçš„CBOè®¾è®¡è§„èŒƒçš„æ›´å¤šä¿¡æ¯ï¼Œè¯·è®¿é—®ä»¥ä¸‹é“¾æ¥ï¼š <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è§„èŒƒ</a>å’Œå®ç°çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä¸»è¦JIRAä»»åŠ¡</a> ã€‚ <br></p><br><p> æ¢ç´¢å…¨éƒ¨ç°æœ‰ä¼˜åŒ–çš„èµ·ç‚¹æ˜¯Optimizer.scalaä»£ç ã€‚ <br></p><br><p> ä»¥ä¸‹æ˜¯ä¸€é•¿ä¸²å¯ç”¨ä¼˜åŒ–çš„æ‘˜å½•ï¼š <br></p><br><pre> <code class="hljs perl">def batches: Se<span class="hljs-string"><span class="hljs-string">q[Batch]</span></span> = { val operatorOptimizationRuleSet = Se<span class="hljs-string"><span class="hljs-string">q( // Operator push down PushProjectionThroughUnion, ReorderJoin, EliminateOuterJoin, PushPredicateThroughJoin, PushDownPredicate, LimitPushDown, ColumnPruning, InferFiltersFromConstraints, // Operator combine CollapseRepartition, CollapseProject, CollapseWindow, CombineFilters, CombineLimits, CombineUnions, // Constant folding and strength reduction NullPropagation, ConstantPropagation, ........</span></span></code> </pre><br><p> åº”å½“æ³¨æ„ï¼Œè¿™äº›ä¼˜åŒ–çš„åˆ—è¡¨åŒ…æ‹¬åŸºäºè§„åˆ™çš„ä¼˜åŒ–å’ŒåŸºäºæŸ¥è¯¢æˆæœ¬ä¼°ç®—çš„ä¼˜åŒ–ï¼Œè¿™å°†åœ¨ä¸‹é¢è¿›è¡Œè®¨è®ºã€‚ <br></p><br><p>  CBOçš„ä¸€ä¸ªåŠŸèƒ½æ˜¯ï¼Œä¸ºäº†è¿›è¡Œæ­£ç¡®çš„æ“ä½œï¼Œå®ƒéœ€è¦çŸ¥é“å¹¶å­˜å‚¨æœ‰å…³æŸ¥è¯¢ä¸­ä½¿ç”¨çš„æ•°æ®çš„ç»Ÿè®¡ä¿¡æ¯-è®°å½•æ•°ï¼Œè®°å½•å¤§å°ï¼Œè¡¨åˆ—ä¸­æ•°æ®åˆ†å¸ƒçš„ç›´æ–¹å›¾ã€‚ <br></p><br><p> ä¸ºäº†æ”¶é›†ç»Ÿè®¡ä¿¡æ¯ï¼Œä½¿ç”¨äº†ä¸€ç»„SQLå‘½ä»¤ANALYZE TABLE ... COMPUTE STATISTICSï¼Œæ­¤å¤–ï¼Œè¿˜éœ€è¦ä¸€ç»„è¡¨æ¥å­˜å‚¨ä¿¡æ¯ï¼Œè¯¥APIé€šè¿‡ExternalCatalogï¼ˆæ›´ç¡®åˆ‡åœ°è¯´æ˜¯é€šè¿‡HiveExternalCatalogï¼‰æä¾›ã€‚ <br></p><br><p> ç”±äºé»˜è®¤æƒ…å†µä¸‹å½“å‰ç¦ç”¨CBOï¼Œå› æ­¤ä¸»è¦é‡ç‚¹å°†æ”¾åœ¨ç ”ç©¶RBOçš„å¯ç”¨ä¼˜åŒ–å’Œç»†å¾®å·®åˆ«ä¸Šã€‚ <br></p><br><h2> åŠ ç›Ÿç­–ç•¥çš„ç±»å‹å’Œé€‰æ‹© </h2><br><p> åœ¨å½¢æˆç”¨äºæ‰§è¡Œè¯·æ±‚çš„ç‰©ç†è®¡åˆ’çš„é˜¶æ®µï¼Œé€‰æ‹©åŠ å…¥ç­–ç•¥ã€‚ ç›®å‰ï¼ŒSparkä¸­æä¾›ä»¥ä¸‹é€‰é¡¹ï¼ˆæ‚¨å¯ä»¥ä»SparkStrategies.scalaä¸­çš„ä»£ç å¼€å§‹å­¦ä¹ ä»£ç ï¼‰ã€‚ <br></p><br><h3> å¹¿æ’­å“ˆå¸Œè”æ¥ </h3><br><p> æœ€å¥½çš„é€‰æ‹©æ˜¯å¦‚æœå…¶ä¸­ä¸€ä¸ªå‚ä¸æ–¹è¶³å¤Ÿå°ï¼ˆå……åˆ†æ€§æ ‡å‡†ç”±<em>SQLConf</em>ä¸­çš„<em>spark.sql.autoBroadcastJoinThreshold</em>å‚æ•°è®¾ç½®ï¼‰ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¿™ä¸€é¢å°†å®Œå…¨å¤åˆ¶åˆ°æ‰€æœ‰æ‰§è¡Œç¨‹åºï¼Œåœ¨è¯¥æ‰§è¡Œç¨‹åºä¸­ä¸»è¡¨å…·æœ‰å“ˆå¸Œè¿æ¥ã€‚ é™¤äº†å¤§å°å¤–ï¼Œè¿˜åº”æ³¨æ„ï¼Œåœ¨å¤–éƒ¨è”æ¥çš„æƒ…å†µä¸‹ï¼Œåªèƒ½å¤åˆ¶å¤–ä¾§ï¼Œå› æ­¤ï¼Œå¦‚æœå¯èƒ½ï¼Œä½œä¸ºå¤–éƒ¨è”æ¥çš„å‰å¯¼è¡¨ï¼Œå¿…é¡»ä½¿ç”¨æ•°æ®é‡æœ€å¤§çš„è¡¨ã€‚ <br></p><br><pre> <code class="hljs pgsql">  ,    ,     <span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span>      Oracle,   <span class="hljs-comment"><span class="hljs-comment">/*+ broadcast(t1, t2) */</span></span></code> </pre><br><h3> æ’åºåˆå¹¶è”æ¥ </h3><br><p> é»˜è®¤æƒ…å†µä¸‹<em>å¯ç”¨spark.sql.join.preferSortMergeJoin</em>æ—¶ï¼Œå¦‚æœå¯ä»¥å¯¹è¿æ¥çš„é”®è¿›è¡Œæ’åºï¼Œåˆ™é»˜è®¤æƒ…å†µä¸‹å°†åº”ç”¨æ­¤æ–¹æ³•ã€‚ <br> åœ¨è¿™äº›åŠŸèƒ½ä¸­ï¼Œå¯ä»¥æ³¨æ„åˆ°ï¼Œä¸å…ˆå‰çš„æ–¹æ³•ä¸åŒï¼Œç”¨äºæ‰§è¡Œè¯¥æ“ä½œçš„ä»£ç ç”Ÿæˆä¼˜åŒ–ä»…å¯ç”¨äºå†…éƒ¨è”æ¥ã€‚ <br></p><br><h3> éšæœºå“ˆå¸Œè”æ¥ </h3><br><p> å¦‚æœæ— æ³•å¯¹é”®è¿›è¡Œæ’åºï¼Œæˆ–è€…ç¦ç”¨äº†é»˜è®¤çš„æ’åºåˆå¹¶è”æ¥é€‰æ‹©é€‰é¡¹ï¼Œåˆ™Catalystä¼šå°è¯•åº”ç”¨æ´—ç‰Œå“ˆå¸Œè”æ¥ã€‚ é™¤äº†æ£€æŸ¥è®¾ç½®ä¹‹å¤–ï¼Œè¿˜æ£€æŸ¥Sparkæ˜¯å¦æœ‰è¶³å¤Ÿçš„å†…å­˜æ¥ä¸ºä¸€ä¸ªåˆ†åŒºæ„å»ºæœ¬åœ°å“ˆå¸Œæ˜ å°„ï¼ˆåˆ†åŒºæ€»æ•°é€šè¿‡è®¾ç½®<em>spark.sql.shuffle.partitions</em>æ¥è®¾ç½®ï¼‰ </p><br><h3> å¹¿æ’­åµŒå¥—å¾ªç¯åŠ å…¥å’Œç¬›å¡å°”ç§¯ </h3><br><p> å¦‚æœä¸å¯èƒ½é€šè¿‡é”®ç›´æ¥è¿›è¡Œæ¯”è¾ƒï¼ˆä¾‹å¦‚ï¼Œç±»ä¼¼æ¡ä»¶ï¼‰ï¼Œæˆ–è€…æ²¡æœ‰ç”¨äºè¿æ¥è¡¨çš„é”®ï¼Œåˆ™å–å†³äºè¡¨çš„å¤§å°ï¼Œè¯·é€‰æ‹©æ­¤ç±»å‹æˆ–CartesianProductã€‚ <br></p><br><h3>  join'ahä¸­æŒ‡å®šè¡¨çš„é¡ºåº </h3><br><p> åœ¨ä»»ä½•æƒ…å†µä¸‹ï¼Œè”æ¥éƒ½éœ€è¦æŒ‰é”®å¯¹è¡¨è¿›è¡Œæ´—ç‰Œã€‚ å› æ­¤ï¼Œæ­¤åˆ»ï¼ŒæŒ‡å®šè¡¨çš„é¡ºåºå¾ˆé‡è¦ï¼Œå°¤å…¶æ˜¯åœ¨è¿ç»­æ‰§è¡Œå¤šä¸ªè”æ¥çš„æƒ…å†µä¸‹ï¼ˆå¦‚æœæ‚¨å¾ˆæ— èŠï¼Œåˆ™å¦‚æœæœªå¯ç”¨CBOå¹¶ä¸”æœªå¯ç”¨JOIN_REORDER_ENABLEDè®¾ç½®ï¼‰ã€‚ <br></p><br><p> å¦‚æœå¯èƒ½çš„è¯ï¼Œè¿æ¥è¡¨çš„é¡ºåºåº”æœ€å¤§ç¨‹åº¦åœ°å‡å°‘å¤§å‹è¡¨çš„æ··æ´—æ“ä½œæ¬¡æ•°ï¼Œå¯¹äºå¤§å‹è¡¨ï¼Œåº”æŒ‰é¡ºåºæ‰§è¡ŒåŒä¸€é”®ä¸Šçš„è¿æ¥ã€‚ å¦å¤–ï¼Œä¸è¦å¿˜è®°æœ€å°åŒ–è¦åŠ å…¥çš„æ•°æ®ï¼Œä»¥å¯ç”¨å¹¿æ’­å“ˆå¸ŒåŠ å…¥ã€‚ <br></p><br><h2> è¿‡æ»¤æ¡ä»¶çš„ä¼ é€’åº”ç”¨ </h2><br><p> è€ƒè™‘ä»¥ä¸‹æŸ¥è¯¢ï¼š <br></p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> bal.account_rk, cust.full_name <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> balance bal <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> customer cust <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> bal.party_rk = cust.party_rk <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> bal.actual_date = cust.actual_date <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> bal.actual_date = <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span>(<span class="hljs-string"><span class="hljs-string">'2017-12-31'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">date</span></span>)</code> </pre><br><p> åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬æ ¹æ®actual_dateå­—æ®µè¿æ¥ä»¥ç›¸åŒæ–¹å¼åˆ†åŒºçš„ä¸¤ä¸ªè¡¨ï¼Œå¹¶æ ¹æ®ä½™é¢è¡¨ä»…å¯¹åˆ†åŒºåº”ç”¨æ˜¾å¼è¿‡æ»¤å™¨ã€‚ <br></p><br><p> ä»ä¼˜åŒ–çš„æŸ¥è¯¢è®¡åˆ’å¯ä»¥çœ‹å‡ºï¼ŒæŒ‰æ—¥æœŸè¿‡æ»¤ä¹Ÿé€‚ç”¨äºå®¢æˆ·ï¼Œå¹¶ä¸”åœ¨ä»ç£ç›˜è¯»å–æ•°æ®æ—¶ï¼Œç¡®å®šæ°å¥½éœ€è¦ä¸€ä¸ªåˆ†åŒºã€‚ <br></p><br><pre> <code class="hljs delphi">== Optimized Logical Plan == Project [account_rk<span class="hljs-string"><span class="hljs-string">#1</span></span>, full_name<span class="hljs-string"><span class="hljs-string">#59</span></span>] +- Join Inner, ((party_rk<span class="hljs-string"><span class="hljs-string">#18</span></span> = party_rk<span class="hljs-string"><span class="hljs-string">#57</span></span>) &amp;&amp; (actual_date<span class="hljs-string"><span class="hljs-string">#27</span></span> = actual_date<span class="hljs-string"><span class="hljs-string">#88</span></span>)) :- Project [ACCOUNT_RK<span class="hljs-string"><span class="hljs-string">#1</span></span>, PARTY_RK<span class="hljs-string"><span class="hljs-string">#18</span></span>, ACTUAL_DATE<span class="hljs-string"><span class="hljs-string">#27</span></span>] : +- Filter ((isnotnull(actual_date<span class="hljs-string"><span class="hljs-string">#27</span></span>) &amp;&amp; (actual_date<span class="hljs-string"><span class="hljs-string">#27</span></span> = <span class="hljs-number"><span class="hljs-number">17531</span></span>)) &amp;&amp; isnotnull(party_rk<span class="hljs-string"><span class="hljs-string">#18</span></span>)) : +- Relation[,... <span class="hljs-number"><span class="hljs-number">4</span></span> more fields] orc +- Project [PARTY_RK<span class="hljs-string"><span class="hljs-string">#57</span></span>, FULL_NAME<span class="hljs-string"><span class="hljs-string">#59</span></span>, ACTUAL_DATE<span class="hljs-string"><span class="hljs-string">#88</span></span>] +- Filter (((actual_date<span class="hljs-string"><span class="hljs-string">#88</span></span> = <span class="hljs-number"><span class="hljs-number">17531</span></span>) &amp;&amp; isnotnull(actual_date<span class="hljs-string"><span class="hljs-string">#88</span></span>)) &amp;&amp; isnotnull(party_rk<span class="hljs-string"><span class="hljs-string">#57</span></span>)) +- Relation[,... <span class="hljs-number"><span class="hljs-number">9</span></span> more fields] orc</code> </pre><br><p> ä½†æ˜¯ï¼Œæ‚¨åªéœ€è¦åœ¨æŸ¥è¯¢ä¸­ç”¨å·¦å¤–éƒ¨æ›¿æ¢å†…éƒ¨è”æ¥ï¼Œå› ä¸ºcustomerè¡¨çš„æ¨å¼è°“è¯ä¼šç«‹å³æ¶ˆå¤±ï¼Œå¹¶ä¸”ä¼šè¿›è¡Œå…¨æ‰«æï¼Œè¿™æ˜¯ä¸å¸Œæœ›çš„ç»“æœã€‚ <br></p><br><pre> <code class="hljs delphi">== Optimized Logical Plan == Project [account_rk<span class="hljs-string"><span class="hljs-string">#1</span></span>, full_name<span class="hljs-string"><span class="hljs-string">#59</span></span>] +- Join LeftOuter, ((party_rk<span class="hljs-string"><span class="hljs-string">#18</span></span> = party_rk<span class="hljs-string"><span class="hljs-string">#57</span></span>) &amp;&amp; (actual_date<span class="hljs-string"><span class="hljs-string">#27</span></span> = actual_date<span class="hljs-string"><span class="hljs-string">#88</span></span>)) :- Project [ACCOUNT_RK<span class="hljs-string"><span class="hljs-string">#1</span></span>, PARTY_RK<span class="hljs-string"><span class="hljs-string">#18</span></span>, ACTUAL_DATE<span class="hljs-string"><span class="hljs-string">#27</span></span>] : +- Filter (isnotnull(actual_date<span class="hljs-string"><span class="hljs-string">#27</span></span>) &amp;&amp; (actual_date<span class="hljs-string"><span class="hljs-string">#27</span></span> = <span class="hljs-number"><span class="hljs-number">17531</span></span>)) : +- Relation[,... <span class="hljs-number"><span class="hljs-number">4</span></span> more fields] orc +- Project [PARTY_RK<span class="hljs-string"><span class="hljs-string">#57</span></span>, FULL_NAME<span class="hljs-string"><span class="hljs-string">#59</span></span>, ACTUAL_DATE<span class="hljs-string"><span class="hljs-string">#88</span></span>] +- Relation[,... <span class="hljs-number"><span class="hljs-number">9</span></span> more fields] orc</code> </pre><br><h2> ç±»å‹è½¬æ¢ </h2><br><p> è€ƒè™‘ä¸€ä¸ªä»è¡¨ä¸­è¿›è¡Œé€‰æ‹©çš„ç®€å•ç¤ºä¾‹ï¼Œè¯¥è¡¨æŒ‰å®¢æˆ·ç«¯ç±»å‹è¿›è¡Œè¿‡æ»¤ï¼Œåœ¨è¯¥æ–¹æ¡ˆä¸­ï¼Œparty_typeå­—æ®µçš„ç±»å‹ä¸ºå­—ç¬¦ä¸²ã€‚ <br></p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> party_rk, full_name <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> cust <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> actual_date = cast(<span class="hljs-string"><span class="hljs-string">'2017-12-31'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-type"><span class="hljs-type">date</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> party_type = <span class="hljs-number"><span class="hljs-number">101</span></span> <span class="hljs-comment"><span class="hljs-comment">--   -- and party_type = '101' --    </span></span></code> </pre><br><p> å¹¶æ¯”è¾ƒä¸¤ä¸ªç»“æœè®¡åˆ’ï¼Œç¬¬ä¸€ä¸ª-å½“æˆ‘ä»¬å¼•ç”¨ä¸æ­£ç¡®çš„ç±»å‹ï¼ˆå°†éšå¼è½¬æ¢ä¸ºintï¼‰æ—¶ï¼Œç¬¬äºŒä¸ª-å½“ç±»å‹ä¸æ–¹æ¡ˆç›¸å¯¹åº”æ—¶ã€‚ <br></p><br><pre> <code class="hljs powershell">PushedFilters: [<span class="hljs-type"><span class="hljs-type">IsNotNull</span></span>(<span class="hljs-type"><span class="hljs-type">PARTY_TYPE</span></span>)] //            . PushedFilters: [<span class="hljs-type"><span class="hljs-type">IsNotNull</span></span>(<span class="hljs-type"><span class="hljs-type">PARTY_TYPE</span></span>), <span class="hljs-type"><span class="hljs-type">EqualTo</span></span>(<span class="hljs-type"><span class="hljs-type">PARTY_TYPE</span></span>,<span class="hljs-number"><span class="hljs-number">101</span></span>)] //             .</code> </pre><br><p> å¯¹äºå°†æ—¥æœŸä¸å­—ç¬¦ä¸²è¿›è¡Œæ¯”è¾ƒçš„æƒ…å†µï¼Œä¹Ÿè§‚å¯Ÿåˆ°ç±»ä¼¼çš„é—®é¢˜ï¼Œå°†æœ‰ä¸€ä¸ªç”¨äºæ¯”è¾ƒå­—ç¬¦ä¸²çš„è¿‡æ»¤å™¨ã€‚ ä¸€ä¸ªä¾‹å­ï¼š <br></p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">where</span></span> OPER_DATE = <span class="hljs-string"><span class="hljs-string">'2017-12-31'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Filter</span></span> (isnotnull(oper_date#<span class="hljs-number"><span class="hljs-number">0</span></span>) &amp;&amp; (cast(oper_date#<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> string) = <span class="hljs-number"><span class="hljs-number">2017</span></span><span class="hljs-number"><span class="hljs-number">-12</span></span><span class="hljs-number"><span class="hljs-number">-31</span></span>) PushedFilters: [IsNotNull(OPER_DATE)] <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> OPER_DATE = cast(<span class="hljs-string"><span class="hljs-string">'2017-12-31'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-type"><span class="hljs-type">date</span></span>) PushedFilters: [IsNotNull(OPER_DATE), EqualTo(OPER_DATE,<span class="hljs-number"><span class="hljs-number">2017</span></span><span class="hljs-number"><span class="hljs-number">-12</span></span><span class="hljs-number"><span class="hljs-number">-31</span></span>)]</code> </pre><br><p> å¯¹äºå¯èƒ½è¿›è¡Œéšå¼ç±»å‹è½¬æ¢çš„æƒ…å†µï¼Œä¾‹å¦‚int-&gt;åè¿›åˆ¶ï¼Œä¼˜åŒ–å™¨å°†è‡ªè¡Œè¿›è¡Œè½¬æ¢ã€‚ <br></p><br><h2> è¿›ä¸€æ­¥ç ”ç©¶ </h2><br><p> å¯ä»¥ä»SQLConf.scalaè·å¾—è®¸å¤šæœ‰å…³å¯ç”¨äºå¾®è°ƒCatalystçš„â€œæ—‹é’®â€çš„æœ‰è¶£ä¿¡æ¯ï¼Œä»¥åŠæœ‰å…³ä¼˜åŒ–å™¨çš„å¯èƒ½æ€§ï¼ˆç°åœ¨å’Œå°†æ¥ï¼‰çš„ä¿¡æ¯ã€‚ <br></p><br><p> ç‰¹åˆ«æ˜¯ï¼Œå¦‚æ‚¨æ‰€è§ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œæˆæœ¬ä¼˜åŒ–å™¨ç›®å‰ä»å¤„äºå…³é—­çŠ¶æ€ã€‚ <br></p><br><pre> <code class="hljs scala"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> <span class="hljs-type"><span class="hljs-type">CBO_ENABLED</span></span> = buildConf(<span class="hljs-string"><span class="hljs-string">"spark.sql.cbo.enabled"</span></span>) .doc(<span class="hljs-string"><span class="hljs-string">"Enables CBO for estimation of plan statistics when set true."</span></span>) .booleanConf .createWithDefault(<span class="hljs-literal"><span class="hljs-literal">false</span></span>)</code> </pre><br><p> ä»¥åŠä¸é‡æ–°æ’åºjoin'ovç›¸å…³çš„ä¾èµ–ä¼˜åŒ–ã€‚ <br></p><br><pre> <code class="hljs scala"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> <span class="hljs-type"><span class="hljs-type">JOIN_REORDER_ENABLED</span></span> = buildConf(<span class="hljs-string"><span class="hljs-string">"spark.sql.cbo.joinReorder.enabled"</span></span>) .doc(<span class="hljs-string"><span class="hljs-string">"Enables join reorder in CBO."</span></span>) .booleanConf .createWithDefault(<span class="hljs-literal"><span class="hljs-literal">false</span></span>)</code> </pre><br><p> æˆ– </p><br><pre> <code class="hljs scala"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> <span class="hljs-type"><span class="hljs-type">STARSCHEMA_DETECTION</span></span> = buildConf(<span class="hljs-string"><span class="hljs-string">"spark.sql.cbo.starSchemaDetection"</span></span>) .doc(<span class="hljs-string"><span class="hljs-string">"When true, it enables join reordering based on star schema detection. "</span></span>) .booleanConf .createWithDefault(<span class="hljs-literal"><span class="hljs-literal">false</span></span>)</code> </pre><br><h2> ç®€è¦æ€»ç»“ </h2><br><p> ä»…è§¦åŠäº†ç°æœ‰ä¼˜åŒ–çš„ä¸€å°éƒ¨åˆ†ï¼Œå³å°†è¿›è¡Œæˆæœ¬ä¼˜åŒ–çš„å®éªŒï¼Œè¯¥ä¼˜åŒ–å¯ä»¥ä¸ºæŸ¥è¯¢è½¬æ¢æä¾›æ›´å¤šçš„ç©ºé—´ã€‚ å¦å¤–ï¼Œå¦ä¸€ä¸ªæœ‰è¶£çš„é—®é¢˜æ˜¯ï¼Œä»Parquetå’ŒOrcè¯»å–æ–‡ä»¶æ—¶ï¼Œæ ¹æ®é¡¹ç›®çš„jiraåˆ¤æ–­ï¼Œä¸€ç»„ä¼˜åŒ–çš„æ¯”è¾ƒä¸å¥‡å¶æ€§æœ‰å…³ï¼Œä½†æ˜¯çœŸçš„å—ï¼Ÿ <br></p><br><p> å¦å¤–ï¼š </p><br><ul><li> è¯·æ±‚çš„åˆ†æå’Œä¼˜åŒ–æ˜¯æœ‰è¶£è€Œä»¤äººå…´å¥‹çš„ï¼Œå°¤å…¶æ˜¯è€ƒè™‘åˆ°æºä»£ç çš„å¯ç”¨æ€§ã€‚ </li><li> åŒ…å«CBOå°†ä¸ºè¿›ä¸€æ­¥çš„ä¼˜åŒ–å’Œç ”ç©¶æä¾›èŒƒå›´ã€‚ </li><li> æœ‰å¿…è¦ç›‘è§†åŸºæœ¬è§„åˆ™çš„é€‚ç”¨æ€§ï¼Œè¿™äº›åŸºæœ¬è§„åˆ™å…è®¸æ‚¨åœ¨æœ€æ—©çš„é˜¶æ®µå°½å¯èƒ½å¤šåœ°è¿‡æ»¤æ‰â€œé¢å¤–â€æ•°æ®ã€‚ </li><li> åŠ å…¥æ˜¯å¿…ç„¶çš„æ¶ä½œå‰§ï¼Œä½†å¦‚æœå¯èƒ½çš„è¯ï¼Œå°†å®ƒä»¬æœ€å°åŒ–å¹¶è·Ÿè¸ªåœ¨å¹•åä½¿ç”¨å“ªç§å®ç°æ˜¯å€¼å¾—çš„ã€‚ </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN417103/">https://habr.com/ru/post/zh-CN417103/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN417091/index.html">ä¸ºç½‘ç»œåˆ›å»ºå¡é€šæ°´ç€è‰²å™¨ã€‚ ç¬¬ä¸‰éƒ¨åˆ†</a></li>
<li><a href="../zh-CN417093/index.html">å¸¦æœ‰Modbusçš„è§¦æ‘¸å¼€å…³ï¼šä¸ºä»€ä¹ˆéœ€è¦å®ƒä»¬ä»¥åŠå¦‚ä½•åœ¨æ™ºèƒ½å…¬å¯“ä¸­åº”ç”¨å®ƒä»¬</a></li>
<li><a href="../zh-CN417097/index.html">JavaScriptå…ƒç¼–ç¨‹</a></li>
<li><a href="../zh-CN417099/index.html">æˆ‘å¦‚ä½•ç¼–å†™æ ‡å‡†çš„C ++ 11åº“ï¼Œæˆ–è€…ä¸ºä»€ä¹ˆboostå¦‚æ­¤ä»¤äººææƒ§ã€‚ ç¬¬äºŒç« </a></li>
<li><a href="../zh-CN417101/index.html">Readyçš„å®šä¹‰-æˆ‘ä»¬å¿˜äº†å‘Šè¯‰æˆ‘ä»¬çš„</a></li>
<li><a href="../zh-CN417105/index.html">åœ¨3Dæ‰“å°æœºä¸Šæ‰“å°ã€‚ 3Dtoolçš„ç§˜å¯†ç»å†</a></li>
<li><a href="../zh-CN417107/index.html">Trueæ—¶æ¸¸æˆçš„åˆ›é€ è€…ï¼šäº†è§£ï¼ˆï¼‰æ¸¸æˆå¼€å‘ï¼ŒVRé—®é¢˜å’ŒMLæ¨¡æ‹Ÿçš„çŸ¥è¯†</a></li>
<li><a href="../zh-CN417109/index.html">ç†æŸ¥å¾·Â·æ±‰æ˜ï¼ˆRichard Hammingï¼‰ï¼šç¬¬10ç« ã€‚</a></li>
<li><a href="../zh-CN417111/index.html">åœ¨çº¿ä¼šè®®ï¼šæµåª’ä½“vsç½‘ç»œç ”è®¨ä¼š</a></li>
<li><a href="../zh-CN417113/index.html">ä¿„ç½—æ–¯çš„3Dæ„å¤§åˆ©æ‰“å°æœºï¼šRaise3D N1 Dual-å»ºæ¨¡å’ŒåŸå‹åˆ¶ä½œ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>