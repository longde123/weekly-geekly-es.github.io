<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚úäüèæ ‚ú≥Ô∏è ‚ûó Hydroponique sur un rebord de fen√™tre ou C ++ 11 dans les microcontr√¥leurs AVR üóìÔ∏è üë©üèª‚Äçüåæ üé™</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Le projet ne contient pas Arduino
 
 
 Ce projet devait √† l'origine √™tre diff√©rent - une structure monumentale compos√©e d'un pi√©destal avec des bo√Ætes...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Hydroponique sur un rebord de fen√™tre ou C ++ 11 dans les microcontr√¥leurs AVR</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/385135/"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le projet ne contient pas Arduino</font></font></i><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/911/af2/659/911af265948b47c6933b93c9ff846e34.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce projet devait √† l'origine √™tre diff√©rent - une structure monumentale compos√©e d'un pi√©destal avec des bo√Ætes et des pompes, un aquarium mont√© dessus et une oasis de tomates au-dessus. Une cascade √©tait pr√©vue dans le paradis d'une oasis de tomates et des formes de vie de poissons dans l'aquarium, dont la principale exigence √©tait la capacit√© de manger les habitants impr√©vus de l'aquarium et de garder le verre propre; les principaux candidats sont le somiki et le gourami. Comme vous l‚Äôavez peut-√™tre devin√©, ma devise est ¬´la paresse est le moteur du progr√®s¬ª (et que pouvez-vous faire pour ne pas nettoyer l‚Äôaquarium et ne pas arroser les tomates).</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un monument √† cette devise aurait probablement √©t√© √©rig√© s'il ne s'√©tait pas d√©j√† effondr√© au stade de la coordination des √©bauches avec sa femme. Elle n'a pas √©t√© inspir√©e par l'id√©e de faire de cette bandura la d√©coration principale du salon, et m√™me la cascade ne l'a pas convaincue. Mais l'id√©e d'un syst√®me autonome, une symbiose de la biologie et de l'√©lectronique, ne voulait pas sortir de ma t√™te, et le projet s'est r√©duit √† la taille d'un pot de fleur - l'aquaponie s'est transform√©e en hydroponie, la vie des poissons a √©t√© sauv√©e.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'id√©e principale de la culture hydroponique est l'utilisation d'une solution aqueuse de nutriments au lieu du sol. Cela permet √† un ordre de grandeur d'acc√©l√©rer la croissance des plantes. Cependant, on ne peut pas simplement abaisser les racines dans l'eau - elles ont besoin d'oxyg√®ne, sans quoi elles commenceront √† mourir. √Ä cet √©gard, il existe des options - souffler constamment de l'eau avec un compresseur, comme dans un aquarium, ou inonder p√©riodiquement les racines avec une solution nutritive, et l'√©goutter apr√®s un certain temps. La premi√®re option a un inconv√©nient - le bourdonnement constant du compresseur. La deuxi√®me option a un avantage - la plupart des racines sont dans l'air, respirent activement et l'effet d'acc√©l√©ration de la croissance devrait √™tre encore plus important. De plus, ils sont immerg√©s dans un substrat de granules poreux sp√©ciaux qui retiennent l'humidit√©. Le choix √©tait √©vident, j'ai pris la deuxi√®me option comme base.Dans le cas des poissons, le syst√®me pourrait se r√©v√©ler presque compl√®tement ferm√© - les s√©cr√©tions de poissons sont trait√©es par des bact√©ries sp√©ciales dans un biofiltre, le produit transform√© est introduit dans les plantes, une couche de sable filtre l'eau, de l'eau propre est renvoy√©e dans l'aquarium. Dans un cas id√©al, les aliments sont parfois saupoudr√©s dans un chargeur automatique et les tomates se rassemblent dans les buissons. Mais cela n'a pas grandi ensemble, c'est peut-√™tre pour le mieux - qui sait comment se terminerait la commande par courrier d'une souche de bact√©ries n√©cessaires.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En cons√©quence, l'appareil de la tomate a pris des contours. </font><font style="vertical-align: inherit;">Deux vaisseaux - le bas avec de l'eau, le sup√©rieur avec un substrat et une plante. </font><font style="vertical-align: inherit;">Pour les inondations, nous utiliserons une petite pompe chinoise avec un moteur √† courant continu, pour le drainage, nous utiliserons un siphon automatique. </font><font style="vertical-align: inherit;">Le principe de fonctionnement du siphon dans la vid√©o:</font></font><br>
<iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://www.youtube.com/embed/5wZ9PQepQYI%3Ffeature%3Doembed&amp;usg=ALkJrhgHOUX-FZs10VTEsodi7qh1FZzofw" frameborder="0" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hydroponie avec un siphon similaire:</font></font><br>
<iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://www.youtube.com/embed/ZHaiVhVZ3kM%3Ffeature%3Doembed&amp;usg=ALkJrhg3B1pM1BVzk38BfMc_c5Zymhg1Cw" frameborder="0" allowfullscreen=""></iframe><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le cerveau de l'appareil est le microcontr√¥leur ATMEGA328P (simplement parce que le placer √©tait √† port√©e de main). Ses t√¢ches comprennent la gestion des inondations et des rejets selon un calendrier, la surveillance du niveau d'eau dans le r√©servoir et la signalisation de son manque, le contr√¥le de l'√©clairage de la plante (nous voulons avoir une certaine longueur minimale de lumi√®re du jour; √† la fin de la lumi√®re naturelle, la lumi√®re artificielle s'allume progressivement), une interface utilisateur pour la visualisation l'√©tat, la gestion et la configuration de toute cette √©conomie. De toute √©vidence, cela n√©cessite une sorte de solution pour le capteur de niveau d'eau, les capteurs de lumi√®re, une horloge en temps r√©el et une sorte de terminal utilisateur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avant de d√©crire les d√©tails, une liste des ressources du projet: </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> vous pouvez voir des photos du r√©sultat et du processus de fabrication. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Petite vid√©o:</font></font><br>
<br>
<iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://www.youtube.com/embed/C_qit2_2rrY%3Ffeature%3Doembed&amp;usg=ALkJrhjJkkK0oFFUQs3BzmnYRGGTRIcTAA" frameborder="0" allowfullscreen=""></iframe><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le projet est disponible sur </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">L√†, dans les </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">versions, un</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> fichier avec le projet de pi√®ce √©lectronique dans KiCAD et les projets de conception de cloches et de sifflets dans SolidWorks est dispos√© (des fichiers STL pour l'impression sont joints).</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Caract√©ristiques de l'assemblage du firmware</font></font></b><div class="spoiler_text">      ‚Äî <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>    ¬´ ¬ª.    ,   , ,        USB    AVR (,   ,    ,     ,      ),               .  -    ,     ,    'ADK_ROOT'     ,        'scons'.<br>
</div></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sch√©ma de la partie √©lectronique: </font></font><br>
<br>
<img src="https://habrastorage.org/files/cfc/96b/dad/cfc96bdad51648caa640d661ac6ffc40.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Plus de d√©tails, une description des pi√®ges et un peu de code. </font><font style="vertical-align: inherit;">Description des probl√®mes logiciels </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√† la toute fin</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Peut-√™tre que quelqu'un sera int√©ress√© de voir un nouvel exemple de travail avec I2C, un valcoder, un module RTC et un affichage graphique. </font><font style="vertical-align: inherit;">Tout le code du projet a √©t√© √©crit ¬´√† partir de z√©ro¬ª sans utiliser de solutions tierces (car je le peux).</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Capteur de niveau d'eau</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La question la plus sensible a √©t√© d√©cid√©e en premier. Il y avait, bien s√ªr, une variante d'une sorte de flotteur de sorte que, par exemple, il d√©placerait le rail sur lequel le code Gray est appliqu√©, et les capteurs optiques seraient lus. Mais cela semblait vraiment peu fiable. La recherche sur eBay n'a pas donn√© de r√©sultat - il y avait soit des interrupteurs √† flotteur (atteint ou non le niveau souhait√©), soit des √©lectrodes immerg√©es et des lectures bas√©es sur la conductivit√© du milieu, mais cela a √©t√© imm√©diatement not√©, car la composition de l'eau changerait constamment avec la conductivit√© des engrais ajout√©s et la dissolution impuret√©s du substrat. En cons√©quence, l'id√©e est venue d'utiliser un t√©l√©m√®tre √† ultrasons, l'un de ceux qui sont g√©n√©ralement plac√©s sur diff√©rents robots. Comme pr√©vu, le capteur est plac√© dans le couvercle du r√©servoir et le signal est r√©fl√©chi directement depuis la surface de l'eau. A √©t√© achet√© HC-SR04 (le choix de la plus petite valeur de la distance de travail minimale - il a 2 cm),et le concept a √©t√© v√©rifi√© sur un seau d'eau. Il s'est av√©r√© que cela fonctionnait pour lui-m√™me (on craignait qu'il n'y ait pas de r√©flexion normale √† la surface de l'eau, ou qu'il n'y ait pas assez de directivit√© du faisceau et qu'il y ait des r√©flexions ind√©sirables des parois du r√©servoir). Soit dit en passant, le t√©l√©m√®tre √©tait √©galement une option de sauvegarde, mais infrarouge. √Ä la surface de l'eau √©tait cens√© lancer un flotteur avec un r√©flecteur. Le seul probl√®me est leur distance de travail minimale de 10 cm (de celles que j'ai trouv√©es), ce qui est d√©j√† un peu trop pour les dimensions donn√©es.√Ä la surface de l'eau √©tait cens√© lancer un flotteur avec un r√©flecteur. Le seul probl√®me est leur distance de travail minimale de 10 cm (de celles que j'ai trouv√©es), ce qui est d√©j√† un peu trop pour les dimensions donn√©es.√Ä la surface de l'eau √©tait cens√© lancer un flotteur avec un r√©flecteur. Le seul probl√®me est leur distance de travail minimale de 10 cm (de celles que j'ai trouv√©es), ce qui est d√©j√† un peu trop pour les dimensions donn√©es.</font></font><br>
<br>
<img src="https://habrastorage.org/files/ee1/7ac/b85/ee17acb8500c4a94b65014c08d3df694.jpg"><br>
<img src="https://habrastorage.org/files/cd2/558/d46/cd2558d46164418f95b883a60c20c213.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selon les r√©sultats du projet, cette approche fonctionne et peut √™tre utilis√©e dans la pratique, aucun probl√®me n'a √©t√© constat√©. Il vaut la peine de prendre des mesures pour isoler la planche de l'humidit√© (scellement dans le bo√Ætier). C'est juste que les capteurs eux-m√™mes restent ouverts, peut-√™tre que √ßa revient toujours.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'interface du capteur est simple - une impulsion est envoy√©e √† l'entr√©e de d√©clenchement, ce qui d√©clenche un signal d'√©cho. Une impulsion est g√©n√©r√©e √† la sortie d'√©cho, dont la longueur est √©gale au temps √©coul√© entre le d√©but du rayonnement et l'acceptation du signal d'√©cho r√©fl√©chi. En mesurant la longueur d'impulsion, en connaissant la vitesse du son et le fait que le signal va √† l'objet et vice-versa, vous pouvez calculer la distance. Dans le projet, cela est impl√©ment√© dans la classe LevelGauge. Pour mesurer la longueur d'impulsion, la capacit√© mat√©rielle de la ¬´capture d'entr√©e¬ª MK AVR est utilis√©e. Dans ce cas, le temporisateur mat√©riel est r√©initialis√© sur le front montant de l'impulsion et sur la valeur descendante du temporisateur, le mat√©riel est stock√© dans le registre ICR1 et une interruption est g√©n√©r√©e. Ainsi, il est possible de mesurer la dur√©e d'impulsion avec une pr√©cision suffisante et une consommation minimale de temps processeur.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
M√™me avec ce mod√®le de capteur, un probl√®me a √©t√© remarqu√© - lorsque l'alimentation a √©t√© appliqu√©e, la ligne d'√©cho est rest√©e constamment active. </font><font style="vertical-align: inherit;">Il a contourn√© en appliquant une impulsion au d√©clencheur et en attendant que le premier cycle de localisation d'√©cho soit pass√©.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R√©tro√©clairage</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le r√©tro-√©clairage est compos√© de trois LED de pr√©hension. </font><font style="vertical-align: inherit;">J'ai pli√© le cadre triangulaire du profil en aluminium, coll√© les LED dessus avec de l'√©poxy. </font><font style="vertical-align: inherit;">J'ai command√© un stabilisateur de courant chinois √† 700mA pour l'alimentation. </font><font style="vertical-align: inherit;">Environ trois volts tombent sur chaque diode, le stabilisateur n√©cessite une diff√©rence entre les tensions d'entr√©e et de sortie d'au moins deux volts, et j'allais alimenter la wunderwafer enti√®re √† partir d'une alimentation de 12 volts. </font><font style="vertical-align: inherit;">De l√†, il est facile de calculer pourquoi exactement trois LED.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les diodes sont d'un blanc chaud. Cela me semblait naturel, le spectre solaire et tout √ßa. Mais comme je l'ai d√©couvert plus tard, apr√®s les avoir command√©es, les plantes utilisent g√©n√©ralement une combinaison de rouge et de bleu. Pour autant que je sache, toute la question n'est que de l'efficacit√©. Si vous avez une grande ferme avec un √©clairage 24h / 24, alors vous √™tes int√©ress√© par le fait que toute l'√©nergie d√©pens√©e est d√©pens√©e pour de bon. Sous un √©clairage blanc, les feuilles vertes refl√©teront la composante verte, une partie importante de l'√©nergie d√©pens√©e pour l'√©clairage sera gaspill√©e.</font></font><br>
<br>
<img src="https://habrastorage.org/files/b75/39b/561/b7539b5610cf43039f95a393567ce5ce.jpg"><br>
<img src="https://habrastorage.org/files/6e3/a21/084/6e3a2108427a44518658b276d5affe3c.JPG"><br>
<img src="https://habrastorage.org/files/1af/253/8d1/1af2538d188c4dfe962d915a09bb2fba.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une caract√©ristique importante du stabilisateur est la pr√©sence d'une entr√©e pour la r√©gulation PWM, que j'utilise pour r√©gler la luminosit√©. Voici un autre r√¢teau chinois. Tout d'abord, il s'est av√©r√© √™tre simplement une fonction d'activation / d√©sactivation actuelle. Autrement dit, je m'attendais √† ce que le courant de sortie ne soit pas modul√©, et sa valeur d√©pendrait du rapport cyclique du signal PWM, mais le courant r√©p√©tait simplement les impulsions √† l'entr√©e de commande. Mais ce n'est pas si mal, une autre embuscade √©tait que le r√©gulateur r√©agit de mani√®re inad√©quate au PWM avec une fr√©quence assez √©lev√©e. J'ai d√ª le baisser √† 300 Hz, auquel il fonctionnait plus ou moins normalement. Le signal PWM est g√©n√©r√© par le microcontr√¥leur dans le mat√©riel en utilisant l'un des temporisateurs.</font></font><br>
<br>
<img src="https://habrastorage.org/files/fde/4a1/3d6/fde4a13d69f04e909fe2fafbcb526ed4.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les capteurs de lumi√®re constituent une autre partie importante de l'ensemble de r√©tro√©clairage. Des phototransistors ont √©t√© s√©lectionn√©s dans ce r√¥le. Et oui, il y en a deux - un au-dessus des LED pour mesurer la lumi√®re naturelle, le second sous les LED pour fournir un retour. Certes, la fonctionnalit√© d'extension automatique de la lumi√®re du jour n'a pas encore √©t√© impl√©ment√©e, comme c'√©tait le cas en √©t√©, et elle n'√©tait pas n√©cessaire (et la motivation est une affaire s√©rieuse). Il a √©t√© suppos√© que d√®s que le premier capteur d√©tecte une diminution du niveau d'√©clairage (et que le temps allou√© pour les heures de clart√© n'a pas encore expir√©), la lumi√®re est r√©gl√©e de sorte que le deuxi√®me capteur produise un niveau correspondant √† l'√©clairage souhait√©. Pour ce faire, vous devez impl√©menter un contr√¥leur PID simple dans le code. Mais dans l'interface, vous ne pouvez voir que les lectures actuelles du capteur et enrouler manuellement la luminosit√© de r√©tro-√©clairage souhait√©e.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Faites attention √† la connexion des capteurs. </font><font style="vertical-align: inherit;">Chacun d'eux a deux plages fixes, qui sont s√©lectionn√©es en connectant √† z√©ro la r√©sistance correspondante. </font><font style="vertical-align: inherit;">Le pied du microcontr√¥leur, connect√© √† la deuxi√®me r√©sistance, est alors transf√©r√© dans un √©tat de haute r√©sistance. </font><font style="vertical-align: inherit;">Vous pouvez activer les deux r√©sistances simultan√©ment, puis il y aura trois plages de mesure fixes. </font><font style="vertical-align: inherit;">Le signal des r√©sistances d'√©metteur passe √† travers un circuit RC pour filtrer les impulsions modulantes - la lumi√®re des LEDs pulsent avec le signal PWM sur le r√©gulateur de courant.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pompe</font></font></h4><br>
<img src="https://habrastorage.org/files/a13/933/895/a13933895d9f4546a4ab7e54e87c056b.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'√©quipement chinois le moins cher, avec un moteur √† courant continu. </font><font style="vertical-align: inherit;">Des embuscades, bien s√ªr, sont disponibles. </font><font style="vertical-align: inherit;">Malgr√© le fait qu'il indique 12V, il ne fonctionne pas longtemps √† cette tension. </font><font style="vertical-align: inherit;">Un a br√ªl√© avant l'assemblage de la structure. </font><font style="vertical-align: inherit;">Le sch√©ma pr√©voit pour PWM pour cela, la puissance maximale est configur√©e dans l'interface, dans la pratique, il n'a pas r√©gl√© au-dessus de 70%. </font><font style="vertical-align: inherit;">D√©j√† √† ce niveau, il hurle sauvagement au travail, mais la plupart du temps, il travaille √† une puissance beaucoup plus faible - environ 30% et gronde assez silencieusement. </font><font style="vertical-align: inherit;">A propos de ses modes de fonctionnement ci-dessous, dans la description de la logique de l'inondation. </font><font style="vertical-align: inherit;">Le plus grand condensateur (C8 dans le diagramme) doit √™tre positionn√© plus pr√®s du circuit d'alimentation de la pompe, sinon il y aura de grandes interf√©rences sur l'ensemble du circuit (en pratique, il s'est av√©r√© que le r√©gulateur de courant pour les LED y est le plus sensible, la musique l√©g√®re commence).</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Horloge temps r√©el</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y avait une id√©e folle d'utiliser les ressources du microcontr√¥leur √† ces fins. Le g√©n√©rateur d'horloge √† quartz a une assez bonne pr√©cision, dans un autre projet, cette approche a bien fonctionn√©. Mais le probl√®me est qu'absolument tous les temporisateurs mat√©riels ont d√©j√† √©t√© utilis√©s √† d'autres fins. Il n'y avait pas d'autre choix que de trouver le module RTC externe. Louez les Chinois, ils sont l√† et ils sont bon march√©. </font></font><br>
<br>
<img src="https://habrastorage.org/files/16f/8e2/404/16f8e24047b9445f969a1d1e9333b4bc.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le module bas√© sur le DS3231 poss√®de une interface I2C, sa propre alimentation redondante - le temps ne se passera pas mal avec une panne de courant. Il y a une sortie en m√©andre √† plusieurs fr√©quences fixes - 1 kHz, 4 kHz et 8 kHz. C'√©tait tr√®s utile pour les signaux audio - encore une fois, vous n'avez pas besoin de charger le MCU, et il n'y avait pas de minuteries gratuites pour cela. L'EEPROM 32Kbit est un bonus, mais il n'est pas utilis√© dans ce projet.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√âtonnamment, il est tr√®s pr√©cis - en quelques mois, il a perdu sa force pendant plusieurs secondes. </font><font style="vertical-align: inherit;">Il a d√©clar√© qu'il tenait compte de l'influence de la temp√©rature sur la fr√©quence du g√©n√©rateur, et apparemment cela fonctionne. </font><font style="vertical-align: inherit;">Si, n√©anmoins, le temps passe, il existe la possibilit√© d'une correction de fr√©quence logicielle. </font><font style="vertical-align: inherit;">Les lectures du capteur de temp√©rature sont disponibles et dans ce projet sont affich√©es dans l'interface. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La classe Rtc est responsable de travailler avec ce module dans le code.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Afficher</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai longtemps voulu faire quelque chose avec un √©cran graphique. </font><font style="vertical-align: inherit;">La recherche du moins cher avec l'interface I2C a donn√© cette option.</font></font><br>
<br>
<img src="https://habrastorage.org/files/629/1fb/ecc/6291fbeccac04dfe854f3a3e45b2a2a3.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Affichage OLED monochrome 128x64 pixels bas√© sur le contr√¥leur SSD1306 plut√¥t populaire. Lors du choix, vous devez examiner attentivement la description - la m√™me puce prend en charge d'autres interfaces, √† l'exception d'I2C, et il existe des options sans elle. Ou ils √©crivent que c'est universel, il prend √©galement en charge I2C, mais en r√©alit√©, il sera n√©cessaire de modifier l√©g√®rement la carte en r√©organisant les valeurs nulles sur d'autres sites. Par cons√©quent, si vous pr√©voyez d'utiliser I2C, il est pr√©f√©rable d'en choisir un o√π seul I2C est affich√© sur la carte, il y aura moins de probl√®mes avec une carte qui n'a presque pas de documentation (documentation uniquement pour la puce). Cette version fonctionne √† partir de 5V, la carte a un r√©gulateur 3,3V requis pour le contr√¥leur. J'ai rencontr√© des critiques que dans certaines versions, il se peut que ce ne soit pas le cas.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'affichage est g√©n√©ralement satisfait. Je n'ai remarqu√© qu'une seule caract√©ristique d√©sagr√©able - la luminosit√© d'une rang√©e de pixels d√©pend du nombre de pixels qui y sont allum√©s. Plus il est √©clair√©, plus la luminosit√© est faible. Le contraste entre les lignes peut √™tre visible si des zones compl√®tement remplies avec des √©l√©ments √©troits alternent sur l'√©cran. Mais en pratique, cela n'est pas visible sur mes photos et n'est pas frappant. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le contr√¥leur peut √™tre configur√© pour fonctionner dans diff√©rents modes d'affichage du contenu de la m√©moire d'√©cran sur une matrice de pixels. C'√©tait plus pratique pour moi lorsque chaque octet est mapp√© sur une colonne verticale de huit pixels de haut, et que les colonnes vont horizontalement de gauche √† droite, remplissant l'√©cran de lignes de huit pixels de haut. Dans ce mode, il est plus pratique de dessiner du texte.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Souvent, une approche est pratiqu√©e dans laquelle la m√©moire d'affichage est dupliqu√©e dans la RAM MCU - tout d'abord, toutes les actions avec l'image sont effectu√©es dans la RAM, puis tous les pixels modifi√©s sont copi√©s dans la m√©moire d'affichage. Dans ce projet, cette approche n'est pas utilis√©e pour √©conomiser des ressources. Tous les emplacements modifi√©s sont imm√©diatement redessin√©s dans la m√©moire d'affichage. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme sugg√©r√© dans les commentaires, les √©crans OLED s'estompent avec le temps. J'ai √©galement soup√ßonn√© cela (en me souvenant de ce qu'est l'√©conomiseur d'√©cran) et j'ai pr√©vu que l'affichage s'√©teigne quelques minutes apr√®s la derni√®re activit√© sur les commandes. Il s'allume lorsque vous tournez ou appuyez sur l'encodeur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le code, le travail avec l'affichage est impl√©ment√© dans la classe Display. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Valkoder:</font></font><br>
<br>
<img src="https://habrastorage.org/files/ee6/a1e/6b5/ee6a1e6b5921493bb395675e2805f2c6.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä mon avis, le valcoder est la meilleure option de contr√¥le pour ces appareils qui ont au moins une certaine interface utilisateur. Il est compact et tr√®s confortable. Il leur est pratique de parcourir et de s√©lectionner des √©l√©ments de menu, de modifier les valeurs de tout param√®tre, de changer de mode, etc. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour se connecter, trois pattes d'entr√©e du microcontr√¥leur sont n√©cessaires. Un pour le bouton (vous pouvez appuyer sur la poign√©e), deux pour le valcoder lui-m√™me. Il y a un signal de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">code gris</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de l'encodeur </font><font style="vertical-align: inherit;">. A chaque tour, un bit change sur deux lignes. La s√©quence d√©termine le sens de rotation.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout semble simple, mais apparemment, les d√©veloppeurs ne sont pas toujours en mesure de fournir un support de haute qualit√© pour un tel appareil. Par exemple, sur mon imprimante 3D, il y a une carte RAMPS et une carte avec un √©cran et le m√™me encodeur est connect√©. Le firmware Marlin fonctionne avec, mais l'exp√©rience de son utilisation est tr√®s mauvaise - il n'y a aucun sentiment de fiabilit√© - lorsque vous cliquez sur le bouton lorsque vous le tournez, l'interface s'arr√™te souvent au mauvais √©l√©ment de menu ou √† la valeur de param√®tre sur laquelle il √©tait attendu. Avec une rotation rapide, on a l'impression que les clics sautent. √Ä un moment donn√©, la commutation ne commence pas lors des clics, mais quelque part entre les deux, est tr√®s d√©sagr√©able. Oui, qu'est-ce que Marlin, j'ai parfois le m√™me sentiment sur le syst√®me multim√©dia int√©gr√© dans la voiture. √Ä cet √©gard, quelques conseils (et, bien s√ªr, regardez le code √† proximit√© de la classe RotEnc).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, un point assez √©vident pour quiconque connecte des boutons au microcontr√¥leur - vous devez g√©rer le rebond. Cet encodeur m√©canique et ses lignes de signaux sont, en fait, les m√™mes boutons, et ils ont √©galement un bavardage. D'abord, nous filtrons le bavardage, puis nous traitons la s√©quence d'√©tats des lignes de signal. Il peut y avoir des valcoders avec des capteurs optiques, cela d√©pend d√©j√† des sch√©mas de traitement du signal d'eux. Si les jambes d'un phototransistor sont directement mises en √©vidence, il peut y vibrer lentement, mais s'il existe un sch√©ma de traitement introduisant une hyst√©r√©sis, une suppression logicielle n'est pas n√©cessaire. Mais ces appareils sont plus chers et sont rarement utilis√©s dans les appareils amateurs, les plus courants sont m√©caniques, quelques dollars par groupe.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Deuxi√®mement, un point un peu moins √©vident, probablement l'un de ceux sur lesquels Marlin s'est br√ªl√© - la poign√©e a des positions stables pendant la rotation - clics (clics). Ce mod√®le comporte quatre √©tapes d'une s√©quence de codes pour chaque clic. Vous devez donc r√©pondre aux clics et non aux √©tapes de la s√©quence. Et le plus important est de se synchroniser avec des positions stables. Beaucoup entrent simplement la constante STEPS_PER_CLICK et, par exemple, r√©pondent √† chaque quatri√®me √©tape. Mais le probl√®me est que le signal n'est pas parfait, les s√©quences peuvent ne pas √™tre enti√®rement correctes. Avec une certaine orthographe, le code peut ¬´s'√©garer¬ª, par cons√©quent, chaque quatri√®me √©tape sera obtenue quelque part au milieu du clic, ce qui sera inconfortable pour l'utilisateur. Dans le m√™me temps, la position fixe de la poign√©e pour un mod√®le particulier correspond √† une valeur de code fixe,il doit y √™tre attach√©.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Troisi√®mement, encore une fois, un point assez √©vident pour les d√©veloppeurs plus ou moins exp√©riment√©s de syst√®mes de microcontr√¥leurs - utiliser des interruptions mat√©rielles pour changer l'√©tat des lignes d'entr√©e. </font><font style="vertical-align: inherit;">Au minimum, il y aura moins de risque de ¬´perdre¬ª les √©tapes de la s√©quence. </font><font style="vertical-align: inherit;">Mais en g√©n√©ral, comme vous le savez, les interruptions sont notre tout. </font><font style="vertical-align: inherit;">Le MCU doit √™tre mis en veille dans la mesure du possible, ne se r√©veillant que sur des interruptions - soit depuis la p√©riph√©rie externe, soit √† partir d'une minuterie pour effectuer une t√¢che retard√©e. </font><font style="vertical-align: inherit;">Ce sont les principes d'une bonne conception de l'architecture du syst√®me.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le design dans son ensemble</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est fait de mat√©riaux improvis√©s et de diff√©rentes pi√®ces imprim√©s sur une imprimante 3D en ABS. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le principe de fonctionnement du siphon est illustr√© dans la vid√©o ci-dessus. Pour moi, c'est un tube externe en PVC et un tube interne avec un entonnoir √† l'extr√©mit√©. Pour le siphon classique, un autre genou est n√©cessaire, mais il √©tait d√©j√† difficile de le fabriquer de mani√®re constructive pour moi. Lorsque des probl√®mes avec le drain ont √©t√© trouv√©s, un petit bain a √©t√© coll√© sur la paroi du r√©servoir inf√©rieur, dans lequel l'extr√©mit√© du tube int√©rieur a √©t√© immerg√©, et cr√©ant une r√©sistance au drain, afin que le siphon puisse fonctionner.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il s'est av√©r√© que l'ABS est un mat√©riau tr√®s hydrophobe. L'eau ne d√©borde litt√©ralement pas; j'ai m√™me d√ª refaire l'entonnoir √† siphon. Cela vaut la peine de consid√©rer cette propri√©t√©, il est impossible de cr√©er des syst√®mes hydrauliques miniatures (par exemple, je voulais faire des surfaces de guidage sur l'entonnoir √† siphon, pour tordre l'eau, pour am√©liorer la r√©ponse du siphon. Mais avec de telles dimensions et l'hydrophobicit√© de l'ABS, cela n'a pas de sens) . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai aussi d'abord essay√© de tout coller avec un pistolet √† colle chaude. Cela ne fonctionne pas - au d√©but, tout semblait tenir bien, mais apr√®s quelques jours, il est tomb√© de lui-m√™me. La meilleure option est l'Asie centrale. Les d√©tails, m√™me sous l'eau, tiennent bien.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La plus grande erreur de calcul dans la conception est les conteneurs transparents. J'ai compl√®tement oubli√© le fait que l'eau fleurit dans la lumi√®re. J'ai d√ª l'envelopper avec un mat√©riau opaque. Eh bien, vous pouvez ajouter p√©riodiquement du permanganate de potassium pour la d√©sinfection, cela ne semble pas nuire aux plantes.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'algorithme d'inondation est le suivant - d'abord la pompe est allum√©e √† faible puissance et remplit tranquillement le r√©servoir sup√©rieur entier. Le processus est surveill√© par un capteur de niveau. Lorsque l'eau commence √† d√©border √† travers l'entonnoir √† siphon, la baisse de niveau dans le r√©servoir inf√©rieur s'arr√™te, ce qui est d√©tect√© par le capteur. Un petit d√©bit cr√©√© √† faible puissance n'est pas suffisant pour d√©clencher un siphon. La pompe s'arr√™te, le volume pomp√© dans le r√©servoir sup√©rieur est m√©moris√©. Les racines sont maintenues dans la solution pendant plusieurs minutes, apr√®s quoi la pompe se rallume. Tout d'abord, √† faible puissance, jusqu'√† ce que l'eau atteigne √† nouveau l'entonnoir (pendant les temps d'arr√™t, elle baisse plus bas en raison de l'effet du siphon), et lorsque le niveau de l'entonnoir est atteint, la pompe se met en marche pour augmenter la puissance, fournissant un d√©bit suffisant pour que le siphon fonctionne. Le d√©bit √† travers le siphon est garanti sup√©rieur au d√©bit de la pompe,en cons√©quence, le niveau dans le r√©servoir inf√©rieur commence √† augmenter, cela est d√©tect√© par le capteur et la pompe s'arr√™te.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les cycles d'inondation commencent p√©riodiquement, √† des intervalles de temps fixes et configurables, de l'aube au cr√©puscule. </font><font style="vertical-align: inherit;">Selon le plan, l'aube √©tait cens√©e √™tre fix√©e par le capteur de lumi√®re et la longueur de la lumi√®re du jour, si n√©cessaire, √©tait √©tendue √† la valeur d√©finie, mais jusque-l√† les mains ne l'avaient pas atteinte. </font><font style="vertical-align: inherit;">L'heure de l'aube est simplement d√©finie dans les param√®tres.</font></font><br>
<br>
<a name="cpp11"></a><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Et o√π est C ++ 11?</font></font></h4><br>
<a name="cpp11"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Peut-√™tre que quelqu'un doutera que C ++ 11 puisse √™tre utile dans la programmation de microcontr√¥leurs (parmi ceux qui sont g√©n√©ralement conscients que les microcontr√¥leurs peuvent √™tre programm√©s en C ++). </font><font style="vertical-align: inherit;">Je vais essayer de donner des exemples sp√©cifiques des avantages du C ++ 11 dans ce domaine (en plus de petites choses √©videntes et agr√©ables comme constexpr, override, default, etc.).</font></font><br>
<br>
<h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Placement des ressources de cha√Æne</font></font></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beaucoup de gens savent que la RAM dans les microcontr√¥leurs est une ressource tr√®s limit√©e. Cela peut √™tre un probl√®me si votre application, par exemple, poss√®de une interface utilisateur et que votre programme utilise un nombre assez important de lignes. Si dans le code pour √©crire quelque chose comme</font></font><br>
<pre><code class="cpp hljs">PromptUser(<span class="hljs-string">"Are you sure you want to format SD-card?"</span>);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
puis la ligne pass√©e dans les arguments sera plac√©e dans la section des donn√©es initialis√©es (ci-apr√®s, le comportement du compilateur GCC pour la plate-forme AVR) - c'est-√†-dire, dans la zone RAM, qui au d√©marrage (avant l'appel de la fonction principale) est initialis√©e √† partir de la m√©moire flash du programme. La fonction PromptUser () recevra un pointeur vers l'emplacement souhait√© dans la RAM. Si vous utilisez une approche similaire tout au long du programme, la RAM se terminera assez rapidement (dans l'ATMEGA328P utilis√© dans ce projet, il ne fait que 2 kilo-octets, et cela vaut √©galement pour BSS, tas et pile). Pour contourner cette limitation, des fonctions comme PromptUser () apprennent √† fonctionner non pas avec des pointeurs vers la RAM, mais avec des pointeurs vers une r√©gion dans la m√©moire flash du programme. Vous ne pouvez y lire qu'√† l'aide d'instructions sp√©ciales, qui, par exemple, dans avr-libc sont envelopp√©es dans des fonctions de la famille </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">eeprom_read_ [byte | word | dword | ...]</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans ce cas, la cha√Æne doit d'abord √™tre plac√©e dans une variable √©quip√©e de l'attribut PROGMEM, qui indique au compilateur qu'elle doit √™tre plac√©e dans la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">m√©moire du programme</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<pre><code class="cpp hljs"><span class="hljs-keyword">char</span> prompt[] PROGMEM = <span class="hljs-string">"Are you sure you want to format SD-card?"</span>;<font></font>
PromptUser(prompt);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela n'est pas pratique si vous souhaitez d√©clarer toutes les lignes de mani√®re centrale. </font><font style="vertical-align: inherit;">Ensuite, vous devez d'abord d√©clarer leur d√©claration dans le fichier d'en-t√™te:</font></font><br>
<pre><code class="cpp hljs"><span class="hljs-keyword">extern</span> <span class="hljs-keyword">char</span> prompt[] PROGMEM;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et dans un fichier .cpp distinct, d√©finissez:</font></font><br>
<pre><code class="cpp hljs"><span class="hljs-keyword">char</span> prompt[] PROGMEM = <span class="hljs-string">"Are you sure you want to format SD-card?"</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Duplication de code, ce qui n'est pas bon, et tr√®s g√™nant quand il y a beaucoup de telles lignes. </font><font style="vertical-align: inherit;">Oui, cela peut √™tre contourn√© en cr√©ant une macro d√©licate et en incluant le fichier d'en-t√™te dans un fichier .cpp distinct, dans lequel la macro sera d√©velopp√©e dans la d√©finition, tandis que dans d'autres contextes, elle sera d√©velopp√©e dans la d√©claration. </font><font style="vertical-align: inherit;">Mais avec C ++ 11, il existe une option plus propre si vous utilisez l'initialisation des membres de classe lors de la d√©claration. </font><font style="vertical-align: inherit;">Dans le fichier d'en-t√™te, d√©clarez la classe avec les lignes:</font></font><br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DEF_STR(__name, __text) \
    const char __name[sizeof(__text)] = __text;</span><font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Strings</span> {</span>
<span class="hljs-keyword">public</span>:<font></font>
    DEF_STR(Prompt, <span class="hljs-string">"Are you sure you want to format SD-card?"</span>)<font></font>
    DEF_STR(OtherString, <span class="hljs-string">"..."</span>)<font></font>
    ‚Ä¶<font></font>
} __attribute__((packed));<font></font>
<font></font>
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">const</span> Strings strings PROGMEM;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le fichier .cpp:</font></font><br>
<pre><code class="cpp hljs"><span class="hljs-keyword">const</span> Strings strings PROGMEM;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, toutes les lignes sont d√©clar√©es en un seul endroit, plac√©es dans la m√©moire du programme, et vous pouvez y acc√©der comme ceci:</font></font><br>
<pre><code class="cpp hljs">PromptUser(strings.prompt);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans ce projet, une approche bas√©e sur le m√™me principe est utilis√©e pour d√©terminer les bitmaps - diff√©rentes images affich√©es sur un √©cran graphique.</font></font><br>
<pre><code class="cpp hljs"><span class="hljs-comment">/** Bitmap descriptor. */</span>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Bitmap</span> {</span>
    <span class="hljs-comment">/** Pointer to data array if in data memory. Offset of data array relatively
     * to Bitmaps class instance start address if in program memory.
     */</span>
    <span class="hljs-keyword">const</span> u8 *data;
    <span class="hljs-comment">/** Number of pages in the bitmap. */</span><font></font>
    u8 numPages,<font></font>
    <span class="hljs-comment">/** Number of columns in the bitmap. */</span><font></font>
       numColumns;<font></font>
} __PACKED;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">template</span>&lt;u8... data&gt;
<span class="hljs-keyword">constexpr</span> <span class="hljs-keyword">static</span> u8
<span class="hljs-title">Bitmap_NumDataBytes</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">sizeof</span>...(data);<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">/** Define bitmap.
 * @param __name Name for accessing.
 * @param __numPages Number of pages in the bitmap. Number of columns defined as
 *      total number of data bytes divided by number of pages.
 * @param __VA_ARGS__ Data bytes.
 */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DEF_BITMAP(__name, __numPages, ...) \
    const u8 __CONCAT(__name, __data__) \
        [Bitmap_NumDataBytes<span class="hljs-meta-string">&lt;__VA_ARGS__&gt;()] = { __VA_ARGS__ }; \</span></span>
    <span class="hljs-keyword">const</span> Bitmap __name { \
        <span class="hljs-keyword">reinterpret_cast</span>&lt;<span class="hljs-keyword">const</span> u8 *&gt;(OFFSETOF(Bitmaps, __CONCAT(__name, __data__))), \<font></font>
        __numPages, \<font></font>
        <span class="hljs-keyword">sizeof</span>(__CONCAT(__name, __data__)) / __numPages};<font></font>
<font></font>
<span class="hljs-comment">/** Global bitmaps repository. Stored in program memory. */</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Bitmaps</span> {</span>
<span class="hljs-keyword">public</span>:<font></font>
<font></font>
    <span class="hljs-comment">/** Thermometer icon. */</span>
    DEF_BITMAP(Thermometer, <span class="hljs-number">1</span>,
        <span class="hljs-number">0b01101010</span>,
        <span class="hljs-number">0b10011110</span>,
        <span class="hljs-number">0b10000001</span>,
        <span class="hljs-number">0b10011110</span>,
        <span class="hljs-number">0b01101010</span><font></font>
    )<font></font>
<font></font>
    <span class="hljs-comment">/** Sun icon. */</span>
    DEF_BITMAP(Sun, <span class="hljs-number">1</span>,
        <span class="hljs-number">0b00100100</span>,
        <span class="hljs-number">0b00011000</span>,
        <span class="hljs-number">0b10100101</span>,
        <span class="hljs-number">0b01000010</span>,
        <span class="hljs-number">0b01000010</span>,
        <span class="hljs-number">0b10100101</span>,
        <span class="hljs-number">0b00011000</span>,
        <span class="hljs-number">0b00100100</span><font></font>
    )<font></font>
    ...<font></font>
};<font></font>
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">const</span> Bitmaps bitmaps PROGMEM;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La diff√©rence est qu'en plus des donn√©es d'image elles-m√™mes, il est √©galement n√©cessaire de placer des attributs (tailles d'image). </font><font style="vertical-align: inherit;">Chaque octet d√©finit une colonne de huit pixels. </font><font style="vertical-align: inherit;">Les colonnes peuvent remplir une ou plusieurs lignes; leur nombre est indiqu√© par le deuxi√®me param√®tre apr√®s le nom. </font><font style="vertical-align: inherit;">Il s'av√®re que la hauteur des bitmaps doit √™tre un multiple de huit pour une largeur arbitraire, ce qui est tout √† fait acceptable pour ce projet.</font></font><br>
<br>
<h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Litt√©raux binaires</font></font></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous avez peut-√™tre d√©j√† remarqu√© que les bitmaps de l'exemple pr√©c√©dent utilisent des litt√©raux binaires pour d√©terminer. </font><font style="vertical-align: inherit;">C'est vraiment tr√®s pratique - vous pouvez √©diter des bitmaps simples directement dans le code, surtout si l'√©diteur permet de les mettre en √©vidence. </font><font style="vertical-align: inherit;">Par exemple, les d√©finitions des caract√®res de police dans le fichier font.h:</font></font><br>
<br>
<img src="https://habrastorage.org/files/8f4/a54/0c9/8f4a540c9a8a42ff9315c8d4cd307d93.png"><br>
<br>
<h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mod√®les variadic</font></font></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O√π alors sans eux alors. </font><font style="vertical-align: inherit;">Eh bien, par exemple, les commandes du contr√¥leur d'affichage peuvent avoir une longueur d'un √† plusieurs octets. </font><font style="vertical-align: inherit;">Envoy√© avec le code suivant:</font></font><br>
<br>
<pre><code class="cpp hljs">SendCommand(Command::DISPLAY_ON);<font></font>
SendCommand(Command::SET_COM_PINS, COM_PINS | COM_PINS_ALTERNATIVE);<font></font>
SendCommand(Command::SET_COLUMN_ADDRESS, curVp.minCol, curVp.maxCol);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pratique, non?</font></font><br>
<pre><code class="cpp hljs">    <span class="hljs-comment">/** Queue command sending.
     * @param bytes Up to MAX_CMD_SIZE bytes of command data.
     */</span>
    <span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span>... TByte&gt;
    <span class="hljs-function"><span class="hljs-keyword">void</span>
    <span class="hljs-title">SendCommand</span><span class="hljs-params">(TByte... bytes)</span>
    </span>{<font></font>
        cmdSize = <span class="hljs-keyword">sizeof</span>...(bytes);<font></font>
        controlSent = <span class="hljs-literal">false</span>;<font></font>
        cmdInProgress = <span class="hljs-literal">true</span>;<font></font>
        SetCmdByte(<span class="hljs-keyword">sizeof</span>...(bytes) - <span class="hljs-number">1</span>, bytes...);<font></font>
        i2cBus.RequestTransfer(DISPLAY_ADDRESS, <span class="hljs-literal">true</span>,<font></font>
                               CommandTransferHandler);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span>... TByte&gt;
    <span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-keyword">void</span>
    <span class="hljs-title">SetCmdByte</span><span class="hljs-params">(<span class="hljs-keyword">int</span> idx, u8 byte, TByte... bytes)</span>
    </span>{<font></font>
        cmdBuf[idx] = byte;<font></font>
        SetCmdByte(idx - <span class="hljs-number">1</span>, bytes...);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-keyword">void</span>
    <span class="hljs-title">SetCmdByte</span><span class="hljs-params">(<span class="hljs-keyword">int</span>, u8 byte)</span>
    </span>{<font></font>
        cmdBuf[<span class="hljs-number">0</span>] = byte;<font></font>
    }<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le fichier variant.h d√©crit une classe qui ressemble vaguement √† boost :: variant √† l'aide de mod√®les variadic. Il est utilis√© pour organiser les pages de l'interface utilisateur. Il s'agit encore une fois d'√©conomiser de la m√©moire - o√π la gestion dynamique de la m√©moire est un luxe inacceptable, vous devez esquiver (bien que 2K soit encore beaucoup, vous ne pouvez pas esquiver, mais dans la m√™me ligne ATMEGA, sa taille atteint 512 octets, et chaque octet par Compte). Dans mon interface, une page est affich√©e √† l'√©cran √† tout moment. Par cons√©quent, pour toutes les pages, vous pouvez utiliser le m√™me morceau de m√©moire, ce qu'on appelle l'union en C. Pour les classes en C ++, cela est g√©n√©ralement appel√© variante. Contrairement √† l'union, nous devons nous rappeler d'appeler le destructeur du contenu pr√©c√©dent avant d'appeler le constructeur du nouveau.</font></font><br>
<br>
<pre><code class="cpp hljs">    Variant&lt;MainPage,<font></font>
            Menu,<font></font>
            LinearValueSelector,<font></font>
            TimeSelector&gt; curPage;<font></font>
    ...<font></font>
    <span class="hljs-comment">/** Get type code for the specified page class. */</span>
    <span class="hljs-keyword">template</span> &lt;<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TPage</span>&gt;
    <span class="hljs-title">static</span> <span class="hljs-title">constexpr</span> <span class="hljs-title">u8</span>
    <span class="hljs-title">GetPageTypeCode</span>()
    {</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">decltype</span>(curPage)::GetTypeCode&lt;TPage&gt;();<font></font>
    }<font></font>
...<font></font>
curPage.Engage(nextPageTypeCode, page);<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour la compilation, les binutils GCC et GNU sont utilis√©s pour la plate-forme AVR (dans Ubuntu il y a un paquet pr√™t √† l'emploi gcc-avr). </font><font style="vertical-align: inherit;">Les d√©tails du processus d'assemblage ont √©t√© donn√©s ci-dessus. </font><font style="vertical-align: inherit;">Les param√®tres du compilateur ressemblent √† ceci (les financements et les inclusions sp√©cifiques au projet sont omis): </font><font style="vertical-align: inherit;">
Lien: </font><font style="vertical-align: inherit;">
Convertissez la section de code au format hexad√©cimal: </font><font style="vertical-align: inherit;">
Cr√©ez une image EEPROM: </font><font style="vertical-align: inherit;">
Micrologiciel pour le microcontr√¥leur: </font><font style="vertical-align: inherit;">
PS Les premi√®res tomates √©taient d√©j√† m√ªres et n'avaient pas tr√®s bon go√ªt. </font><font style="vertical-align: inherit;">Apparemment, ils n'aimaient pas quelque chose dans l'alimentation. </font><font style="vertical-align: inherit;">Il faudra probablement changer de culture.</font></font><br>
<code>avr-g++ -o build/native-debug/src/firmware/cpu/lighting.cpp.o -c -fno-exceptions -fno-rtti -std=c++1y -Wall -Werror -Wextra -ggdb3 -Os -mcall-prologues -mmcu=atmega328p -fshort-wchar -fshort-enums src/firmware/cpu/lighting.cpp<br>
</code><br><font style="vertical-align: inherit;"></font><br>
<code>avr-g++ -o build/native-debug/src/firmware/cpu/cpu -mmcu=atmega328p build/native-debug/src/firmware/cpu/adc.cpp.o build/native-debug/src/firmware/cpu/application.cpp.o ‚Ä¶<br>
</code><br><font style="vertical-align: inherit;"></font><br>
<code>avr-objcopy -j .text -j .data -O ihex build/native-debug/src/firmware/cpu/cpu build/native-debug/src/firmware/cpu/cpu_rom.hex<br>
</code><br><font style="vertical-align: inherit;"></font><br>
<code>avr-objcopy -j .eeprom --change-section-lma .eeprom=0 -O ihex build/native-debug/src/firmware/cpu/cpu build/native-debug/src/firmware/cpu/cpu_eeprom.hex<br>
</code><br><font style="vertical-align: inherit;"></font><br>
<code>avrdude -p atmega328p -c avrisp2 -P /dev/avrisp -U flash:w:build/native-debug/src/firmware/cpu/cpu_rom.hex:i<br>
</code><br>
<br><font style="vertical-align: inherit;"></font></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr385135/">https://habr.com/ru/post/fr385135/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr385121/index.html">Surr√©alisme algorithmique: un guide du trading haute fr√©quence pour 900 millions de microsecondes. Partie 1</a></li>
<li><a href="../fr385123/index.html">Station New Horizons a envoy√© une photo d'un petit satellite de Pluton Styx</a></li>
<li><a href="../fr385125/index.html">Reddit a choisi la photo qui ira sur la lune en 2017</a></li>
<li><a href="../fr385129/index.html">Capteur d'√©clairage sans fil CR2450</a></li>
<li><a href="../fr385131/index.html">Calme dans la nuit, ne dors pas du PC: aller en silence</a></li>
<li><a href="../fr385137/index.html">Mouvement mondial de d√©mant√®lement des panneaux d'affichage urbains</a></li>
<li><a href="../fr385139/index.html">Robots Tesla Motors</a></li>
<li><a href="../fr385141/index.html">Cannybots: des robots pour apprendre aux enfants √† programmer</a></li>
<li><a href="../fr385143/index.html">Poudre pour le cerveau ou comment faire de la poudre pour le lave-vaisselle 9,7 fois moins cher</a></li>
<li><a href="../fr385145/index.html">Une s√©lection de trackers o√π vous pouvez changer les sangles</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>