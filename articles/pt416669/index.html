<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§∏ üèÇüèª üëáüèæ Toda a verdade sobre o linux epoll üëÑ üÉè üçé</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bem, ou quase tudo ... 





 Eu acredito que o problema na Internet moderna √© uma superabund√¢ncia de informa√ß√µes de qualidade diferente. Encontrar ma...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Toda a verdade sobre o linux epoll</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/416669/"><p>  Bem, ou quase tudo ... </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/91f/776/71c/91f77671c2186bc1f2393c47e0696ee9.png"></p><br><p>  Eu acredito que o problema na Internet moderna √© uma superabund√¢ncia de informa√ß√µes de qualidade diferente.  Encontrar material sobre um t√≥pico de interesse n√£o √© um problema; o problema √© distinguir material bom de material ruim se voc√™ tiver pouca experi√™ncia nesse campo.  Observo uma figura quando h√° muitas informa√ß√µes gerais "no topo" (quase no n√≠vel de uma simples enumera√ß√£o), muito poucos artigos detalhados e nenhum artigo de transi√ß√£o do simples ao complexo.  No entanto, √© o conhecimento das caracter√≠sticas de um mecanismo espec√≠fico que nos permite fazer uma escolha informada durante o desenvolvimento. </p><br><p>  No artigo, tentarei revelar qual √© a diferen√ßa fundamental entre <strong>epoll</strong> e outros mecanismos, o que o torna √∫nico, al√©m de citar artigos que voc√™ s√≥ precisa ler para entender melhor as possibilidades e os problemas do <strong>epoll</strong> . </p><br><blockquote> Qualquer um pode usar um machado, mas √© preciso um verdadeiro guerreiro para faz√™-lo cantar melodia melee. </blockquote><p>  Presumo que o leitor esteja familiarizado com <strong>epoll</strong> , pelo menos leia a p√°gina de manual.  J√° foi escrito o suficiente sobre <strong>epoll</strong> , <strong>poll</strong> , <strong>select</strong> , para que todos que desenvolvem no Linux tenham ouvido falar sobre isso pelo menos uma vez. </p><a name="habracut"></a><br><h1 id="mnoga--fd">  Muito fd </h1><br><p>  Quando as pessoas falam sobre <strong>epoll,</strong> basicamente, ou√ßo a tese de que "seu desempenho √© melhor quando h√° muitos descritores de arquivos". </p><br><p>  S√≥ quero fazer uma pergunta - quanto √© quanto?  Quantas conex√µes s√£o necess√°rias e, o mais importante, sob quais condi√ß√µes a <strong>epoll</strong> come√ßar√° a dar ganhos tang√≠veis de desempenho? </p><br><p>  Para quem estudou <strong>epoll</strong> (h√° muito material, incluindo artigos cient√≠ficos), a resposta √© √≥bvia - √© melhor se e somente se o n√∫mero de compostos "aguardando um evento" exceder significativamente o n√∫mero de "prontos para processamento".  A marca da quantidade, quando o ganho se torna t√£o significativo que simplesmente n√£o h√° urina para ignorar esse fato, 10 mil compostos s√£o considerados [4]. </p><br><p>  A suposi√ß√£o de que a maioria das conex√µes estar√° pendente vem da l√≥gica do som e do monitoramento de carga dos servidores que est√£o em uso ativo. </p><br><p>  Se o n√∫mero de compostos ativos se esfor√ßar para o n√∫mero total, <del>  n√£o haver√° ganho </del>  n√£o haver√° ganho significativo, um ganho significativo √© devido <strong>ae</strong> somente porque <strong>epoll</strong> retorna apenas descritores que requerem aten√ß√£o e a <strong>pesquisa</strong> retorna todos os descritores que foram adicionados para observa√ß√£o. </p><br><p>  Obviamente, no √∫ltimo caso, passamos um tempo percorrendo todos os descritores + sobrecarga de copiar uma matriz de eventos do kernel. </p><br><p>  De fato, na medi√ß√£o de desempenho inicial, que foi anexada ao patch [9], esse ponto n√£o est√° sublinhado e s√≥ podemos adivinhar pela presen√ßa do utilit√°rio deadcon mencionado no artigo (infelizmente, o c√≥digo do utilit√°rio pipetest.c foi perdido).  Por outro lado, em outras fontes [6, 8] √© muito dif√≠cil n√£o notar, porque esse fato est√° praticamente se destacando. </p><br><p>  A quest√£o surge imediatamente, mas e agora, se n√£o estiver planejado atender a um n√∫mero t√£o grande de <strong>descritores de</strong> arquivos <strong>epoll</strong> , por assim dizer, e n√£o for necess√°rio? </p><br><p>  Apesar de o <strong>epoll ter</strong> sido originalmente criado especificamente para essas situa√ß√µes [5, 8, 9], isso est√° longe de ser a √∫nica diferen√ßa entre <strong>epoll</strong> . </p><br><h1 id="epollet">  EPOLLET </h1><br><p>  Para come√ßar, entenderemos a diferen√ßa entre gatilhos de gatilho de borda e gatilhos de gatilho de n√≠vel. H√° uma declara√ß√£o muito boa sobre esse t√≥pico no artigo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Borda acionada contra interrup√ß√µes de</a> gatilho de n√≠vel <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">- Venkatesh Yadav</a> : </p><br><blockquote>  Interrup√ß√£o de n√≠vel, √© como uma crian√ßa.  Se o beb√™ estiver chorando, voc√™ deve desistir de tudo o que fez e correr para o beb√™ para aliment√°-lo.  Ent√£o voc√™ coloca o beb√™ de volta no ber√ßo.  Se ele chorar novamente, voc√™ n√£o o deixar√° em lugar nenhum, mas tentar√° acalm√°-lo.  E enquanto a crian√ßa estiver chorando, voc√™ n√£o a deixar√° nem por um momento e s√≥ retornar√° ao trabalho quando se acalmar.  Mas digamos que sa√≠mos para o jardim (interrup√ß√£o desativada) quando a crian√ßa come√ßou a chorar; depois, quando voc√™ voltou para casa (interrup√ß√£o ligada), a primeira coisa que voc√™ fez foi ir verificar a crian√ßa.  Mas voc√™ nunca saber√° que ele estava chorando enquanto voc√™ estava no jardim. <br><br>  A interrup√ß√£o na frente √© como uma bab√° eletr√¥nica para pais surdos.  Assim que a crian√ßa come√ßa a chorar no dispositivo, uma luz vermelha acende e acende at√© voc√™ pressionar o bot√£o.  Mesmo que a crian√ßa comece a chorar, mas rapidamente pare e adorme√ßa, voc√™ ainda saber√° que a crian√ßa estava chorando.  Mas se ele come√ßou a chorar e voc√™ pressionou o bot√£o (confirma√ß√£o de interrup√ß√£o), a luz n√£o acender√°, mesmo que ele continue chorando.  O n√≠vel do som na sala deve cair e subir novamente para que a luz acenda. </blockquote><p>  Se o <strong>epoll</strong> (assim como <strong>pesquisar</strong> / <strong>selecionar</strong> ) for desbloqueado no comportamento acionado por n√≠vel, se o descritor estiver no estado especificado e ser√° considerado ativo at√© que esse estado seja limpo, o acionado por borda ser√° desbloqueado apenas alterando o estado ordenado atual. </p><br><p>  Isso permite que voc√™ lide com o evento posteriormente, e n√£o imediatamente ap√≥s o recebimento (quase uma analogia direta com a metade superior e a metade inferior do manipulador de interrup√ß√µes). </p><br><p>  Exemplo espec√≠fico com epoll: </p><br><p>  N√≠vel acionado </p><br><ul><li>  identificador adicionado ao <strong>epoll</strong> com a bandeira <strong>EPOLLIN</strong> </li><li>  <strong>O epoll_wait ()</strong> bloqueia enquanto aguarda um evento </li><li>  escreva no descritor de arquivo 19 bytes </li><li>  <strong>epoll_wait () √©</strong> desbloqueado com o evento <strong>EPOLLIN</strong> </li><li>  n√≥s n√£o fazemos nada com os dados que vieram </li><li>  <strong>epoll_wait () √©</strong> desbloqueado novamente com o evento <strong>EPOLLIN</strong> </li></ul><br><p>  E isso continuar√° at√© contarmos ou redefinirmos completamente os dados do descritor. </p><br><p>  Borda acionada </p><br><ul><li>  identificador adicionado ao <strong>epoll</strong> com sinalizadores <strong>EPOLLIN |</strong>  <strong>EPOLLET</strong> </li><li>  <strong>O epoll_wait ()</strong> bloqueia enquanto aguarda um evento </li><li>  escreva no descritor de arquivo 19 bytes </li><li>  <strong>epoll_wait () √©</strong> desbloqueado com o evento <strong>EPOLLIN</strong> </li><li>  n√≥s n√£o fazemos nada com os dados que vieram </li><li>  <strong>epoll_wait () est√°</strong> bloqueado aguardando um novo evento </li><li>  escreva outros 19 bytes no descritor de arquivo </li><li>  <strong>epoll_wait () √©</strong> desbloqueado com o novo evento <strong>EPOLLIN</strong> </li><li>  <strong>epoll_wait () est√°</strong> bloqueado aguardando um novo evento </li></ul><br><p>  exemplo simples: <a href="">epollet_socket.c</a> </p><br><p>  Este mecanismo foi <strong>projetado</strong> para impedir o retorno de <strong>epoll_wait ()</strong> devido a um evento que j√° est√° sendo processado. </p><br><p>  Se, no caso de level, ao chamar <strong>epoll_wait (), o</strong> kernel verifica se fd est√° nesse estado, o edge ignora essa verifica√ß√£o e coloca imediatamente o processo de chamada no estado de suspens√£o. </p><br><p>  <strong>O pr√≥prio EPOLLET</strong> √© o que torna o <strong>epoll</strong> O (1) um multiplexador para eventos. </p><br><p>  √â necess√°rio explicar sobre o <strong>EAGAIN</strong> e o <strong>EPOLLET</strong> - a recomenda√ß√£o com o <strong>EAGAIN</strong> n√£o <strong>√©</strong> tratar o fluxo de bytes, o perigo no √∫ltimo caso surge apenas se voc√™ n√£o leu o descritor at√© o final e novos dados n√£o chegaram.  A cauda ficar√° no descritor, mas voc√™ n√£o receber√° uma nova notifica√ß√£o.  Com <strong>accept (), a</strong> situa√ß√£o √© apenas diferente; voc√™ deve continuar at√© o <strong>accept ()</strong> retornar <strong>EAGAIN</strong> , somente neste caso a opera√ß√£o correta √© garantida. </p><br><pre><code class="hljs lua">// TCP socket (<span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> stream) //  fd    EPOLLIN      int <span class="hljs-built_in"><span class="hljs-built_in">len</span></span> = <span class="hljs-built_in"><span class="hljs-built_in">read</span></span>(fd, buffer, BUFFER_LEN); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">len</span></span> &lt; BUFFER_LEN) { //   } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { //         //  -       epoll_wait, //      }</code> </pre> <br><pre> <code class="hljs ruby"> /<span class="hljs-regexp"><span class="hljs-regexp">/ accept /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  listenfd    EPOLLIN      event.events = EPOLLIN | EPOLLERR; epoll_ctl(epoll_fd, EPOLL_CTL_ADD, server_fd, &amp;event); sleep(5); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/       &gt;1  /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   while(epoll_wait()) { newfd = accept(listenfd, ...); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/      /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/        /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  epoll_wait    listenfd    } /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   while(epoll_wait()) { while((newfd = accept(...)) &gt; 0) { /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  -  } if(newfd == -1 &amp;&amp; errno = EAGAIN) { /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/       /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/       } }</span></span></code> </pre> <br><p>  Com essa propriedade, basta a fome: </p><br><ul><li>  pacotes v√™m para o descritor </li><li>  ler pacotes para o buffer </li><li>  outro pacote vem </li><li>  ler pacotes para o buffer </li><li>  vem uma pequena por√ß√£o </li><li>  ... </li></ul><br><p>  Portanto <strong>,</strong> n√£o receberemos o <strong>EAGAIN em</strong> breve, mas podemos n√£o receb√™-lo. </p><br><p>  Assim, outros descritores de arquivo n√£o recebem tempo para processamento e estamos ocupados lendo constantemente pequenas por√ß√µes de dados que chegam constantemente. </p><br><h1 id="thundering-nerd-herd">  estrondoso <del>  nerd </del>  manada </h1><br><p>  Para ir para a √∫ltima flag, voc√™ precisa entender por que ela foi realmente criada e um dos problemas que surgiram para os desenvolvedores com a evolu√ß√£o da tecnologia e do software. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://en.wikipedia.org/wiki/">Problema do rebanho trovejante</a> </p><br><blockquote>  Problema do rebanho do trov√£o <br><br>  Imagine um grande n√∫mero de processos aguardando um evento.  Se um evento ocorrer, eles ser√£o despertados e a luta por recursos come√ßar√°, embora apenas um processo seja necess√°rio para lidar com o processamento adicional do evento.  O restante dos processos dormir√° novamente. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Terminologia de TI - Vasily Alekseenko</a> </blockquote><p>  Nesse caso, estamos interessados ‚Äã‚Äãno problema de <strong>accept ()</strong> e <strong>read ()</strong> distribu√≠dos por fluxos em conjunto com <strong>epoll</strong> . </p><br><h1 id="accept">  aceitar </h1><br><p>  Na verdade, com uma chamada de bloqueio para <strong>accept (),</strong> n√£o h√° problemas h√° muito tempo.  O kernel cuidar√° para que apenas um processo tenha sido desbloqueado para este evento e todas as conex√µes recebidas sejam serializadas. </p><br><p>  Mas com <strong>epoll,</strong> esse truque n√£o vai funcionar.  Se tivermos <strong>listen () feito</strong> em um soquete sem bloqueio, quando a conex√£o for estabelecida, todos os <strong>epoll_wait () aguardar√£o</strong> o evento desse descritor. </p><br><p>  Obviamente, o <strong>accept ()</strong> poder√° fazer apenas um thread, o restante receber√° <strong>EAGAIN</strong> , mas isso √© um desperd√≠cio de recursos. </p><br><p>  Al√©m disso, o <strong>EPOLLET</strong> tamb√©m n√£o nos ajuda, pois n√£o sabemos exatamente quantas conex√µes h√° na fila de conex√µes ( <strong>lista de pend√™ncias</strong> ).  Como lembramos, ao usar o <strong>EPOLLET</strong> , o processamento do soquete deve continuar at√© que retorne com o <strong>c√≥digo de</strong> erro <strong>EAGAIN</strong> , para que haja uma chance de que todos os <strong>accept ()</strong> sejam processados ‚Äã‚Äãpor um thread e o restante n√£o funcione. </p><br><p>  E isso novamente nos leva a uma situa√ß√£o em que a corrente vizinha foi acordada em v√£o. </p><br><p>  Tamb√©m podemos obter um tipo diferente de inani√ß√£o - teremos apenas um encadeamento carregado e o restante n√£o receber√° conex√µes para processamento. </p><br><h1 id="epolloneshot">  EPOLLONESHOT </h1><br><p>  Antes da vers√£o 4.5, a √∫nica maneira correta de processar o <strong>epoll</strong> distribu√≠do em um descritor <strong>listen ()</strong> sem bloqueio com a pr√≥xima chamada <strong>accept ()</strong> era definir o sinalizador <strong>EPOLLONESHOT</strong> , que novamente nos levou a <strong>aceitar ()</strong> sendo processado apenas em um encadeamento por vez. </p><br><p>  Em resumo - se <strong>EPOLLONESHOT for</strong> usado <strong>, o</strong> evento associado a um descritor em particular ser√° <strong>acionado</strong> apenas uma vez, ap√≥s o que √© necess√°rio <strong>rearmar</strong> os sinalizadores usando <strong>epoll_ctl ()</strong> . </p><br><h1 id="epollexclusive">  EPOLLEXCLUSIVE </h1><br><p>  Aqui, o <strong>EPOLLEXCLUSIVE</strong> e acionado por n√≠vel vem em nosso aux√≠lio. </p><br><p>  <strong>EPOLLEXCLUSIVE</strong> desbloqueia um <strong>epoll_wait ()</strong> pendente de <strong>cada</strong> vez para um evento. </p><br><p>  O esquema √© bastante simples (na verdade n√£o): </p><br><ul><li>  Temos N threads aguardando um evento de conex√£o </li><li>  O primeiro cliente se conecta a n√≥s </li><li>  O segmento 0 ser√° disperso e iniciar√° o processamento, outros segmentos permanecer√£o bloqueados </li><li>  Um segundo cliente se conecta a n√≥s, se o segmento 0 ainda estiver ocupado com o processamento, o segmento 1 ser√° desbloqueado </li><li>  Continuamos mais at√© que o pool de threads esteja esgotado (ningu√©m espera um evento em <strong>epoll_wait ()</strong> ) </li><li>  Outro cliente est√° se conectando a n√≥s </li><li>  E seu processamento receber√° o primeiro thread, que chamar√° <strong>epoll_wait ()</strong> </li><li>  O segundo thread receber√° o segundo cliente, que chamar√° <strong>epoll_wait ()</strong> </li></ul><br><p>  Assim, toda a manuten√ß√£o √© distribu√≠da uniformemente pelos fluxos. </p><br><pre> <code class="bash hljs">$ ./epollexclusive --<span class="hljs-built_in"><span class="hljs-built_in">help</span></span> -i, --ip=ADDR specify ip address -p, --port=PORT specify port -n, --threads=NUM specify number of threads to use <span class="hljs-comment"><span class="hljs-comment">#    -  n*8 -t, --thunder not adding EPOLLEXCLUSIVE #     thunder herd -h, --help prints this message $ sudo taskset -c 0-7 ./epollexclusive -i 10.56.75.201 -p 40000 -n 8 2&gt;&amp;1</span></span></code> </pre> <br><p>  c√≥digo de exemplo: <a href="">epollexclusive.c</a> (funcionar√° apenas com a vers√£o do kernel da 4.5) </p><br><p>  Temos um modelo pr√©-fork no epoll.  Esse esquema √© bem aplic√°vel para conex√µes TCP de <strong>curto prazo</strong> . </p><br><h1 id="read">  ler </h1><br><p>  Mas com <strong>read ()</strong> no caso de fluxo de bytes, <strong>EPOLLEXCLUSIVE</strong> , como <strong>EPOLLET,</strong> n√£o nos ajudar√°. </p><br><p>  Por raz√µes √≥bvias, sem <strong>EPOLLEXCLUSIVE</strong> , n√£o podemos usar, de maneira alguma, acionados por n√≠vel.  Com o <strong>EPOLLEXCLUSIVE, nem</strong> tudo est√° melhor, pois podemos espalhar um pacote pelos fluxos, al√©m de ter chegado uma ordem desconhecida de bytes. </p><br><p>  Com <strong>EPOLLET, a</strong> situa√ß√£o √© a mesma. </p><br><p>  E aqui a <strong>EPOLLONESHOT</strong> com reinicializa√ß√£o ap√≥s a conclus√£o do trabalho ser√° a sa√≠da.  Portanto, assim que um thread trabalhar com este descritor de arquivo e buffer: </p><br><ul><li>  identificador adicionado ao <strong>epoll</strong> com sinalizadores <strong>EPOLLONESHOT |</strong>  <strong>EPOLLET</strong> </li><li>  esperando <strong>epoll_wait ()</strong> </li><li>  ler do soquete para o buffer at√© <strong>read ()</strong> retornar <strong>EAGAIN</strong> </li><li>  reinicializar com sinalizadores de <strong>EPOLLONESHOT |</strong>  <strong>EPOLLET</strong> </li></ul><br><h1 id="struct--epoll_event">  struct epoll_event </h1><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> epoll_data { <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *ptr; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> fd; <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> u32; <span class="hljs-keyword"><span class="hljs-keyword">uint64_t</span></span> u64; } <span class="hljs-keyword"><span class="hljs-keyword">epoll_data_t</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">epoll_event</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> events; <span class="hljs-comment"><span class="hljs-comment">/* Epoll events */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">epoll_data_t</span></span> data; <span class="hljs-comment"><span class="hljs-comment">/* User data variable */</span></span> };</code> </pre> <br><p>  Este item √© talvez o √∫nico no meu artigo meu IMHO pessoal.  A capacidade de usar um ponteiro ou um n√∫mero √© √∫til.  Por exemplo, usar um ponteiro ao usar epoll permite que voc√™ fa√ßa um truque como este: </p><br><pre> <code class="hljs go">#define container_of(ptr, <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>, member) ({ \ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> typeof( ((<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> *)<span class="hljs-number"><span class="hljs-number">0</span></span>)-&gt;member ) *__mptr = (ptr); \ (<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> *)( (char *)__mptr - offsetof(<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>,member) );}) <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> epoll_client { <span class="hljs-comment"><span class="hljs-comment">/** some usefull associated data...*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> epoll_event event; }; <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> epoll_client* to_epoll_client(<span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> epoll_event* event) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> container_of(event, <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> epoll_client, event); } <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> epoll_client ec; ... epoll_ctl(efd, EPOLL_CTL_ADD, fd, &amp;ec.e); ... epoll_wait (efd, events, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">-1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> epoll_client* ec_ = to_epoll_client(events[<span class="hljs-number"><span class="hljs-number">0</span></span>].data.ptr);</code> </pre> <br><p>  Acho que todo mundo sabe de onde veio essa t√©cnica. </p><br><h1 id="zaklyuchenie">  Conclus√£o </h1><br><p>  Espero que possamos abrir o t√≥pico <strong>epoll</strong> .  Quem deseja usar esse mecanismo conscientemente, s√≥ precisa ler os artigos na lista de refer√™ncias [1, 2, 3, 5]. </p><br><p>  Com base nesse material (ou, melhor ainda, na leitura cuidadosa dos materiais a partir das refer√™ncias), voc√™ pode criar um servidor pr√©-fork multi-threaded (gera√ß√£o avan√ßada do processo) sem bloqueio (sem bloqueio) ou revisar estrat√©gias existentes com base nas propriedades especiais do <strong>epoll ()</strong> ). </p><br><p>  <strong>O epoll √©</strong> um dos mecanismos √∫nicos que as pessoas que escolheram seus caminhos de programa√ß√£o Linux precisam conhecer, pois oferecem uma vantagem s√©ria sobre outros sistemas operacionais) e, possivelmente, recusar√£o a plataforma cruzada para um caso espec√≠fico (deixe funcionar) somente no Linux, mas far√° bem). </p><br><h2 id="rassuzhdeniya-ob-specifichnosti-zadachi">  Racioc√≠nio sobre a "especificidade" do problema </h2><br><p>  Antes de algu√©m falar sobre a especificidade desses sinalizadores e padr√µes de uso, quero fazer uma pergunta: </p><br><p>  "Mas n√£o √© nada que estamos tentando discutir a especificidade do mecanismo que foi criado para tarefas espec√≠ficas inicialmente [9, 11]? Ou servimos at√© conex√µes 1k √© uma tarefa di√°ria para um programador?" </p><br><p>  N√£o compreendo o conceito de "especificidade da tarefa", ele me lembra todos os tipos de gritos sobre a utilidade e a futilidade das v√°rias disciplinas ensinadas.  Permitindo-nos raciocinar dessa maneira, arrogamos para n√≥s mesmos o direito de decidir para os outros quais informa√ß√µes s√£o √∫teis para eles e quais s√£o in√∫teis, enquanto, lembre-se, voc√™ n√£o participa do processo educacional como um todo. </p><br><p>  Para os c√©ticos, alguns links: </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Aumentando o desempenho com SO_REUSEPORT no NGINX 1.9.1 - VBart</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Aprendendo com o Unicorn: o problema n√£o resolvido do rebanho trovejante - Chris Siebenmann</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Serializing accept (), tamb√©m conhecido como Thundering Herd, tamb√©m conhecido como o problema de Zeeg - Roberto De Ioris</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Como o modo EPOLLEXCLUSIVE do epoll interage com o acionamento de n√≠vel?</a> </p><br><h1 id="spisok-literatury">  Refer√™ncias </h1><br><ol><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Select √© fundamentalmente quebrado - Marek</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Epoll √© fundamentalmente quebrado 1/2 - Marek</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Epoll √© fundamentalmente quebrado 2/2 - Marek</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O problema do C10K - Dan Kegel</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Poll vs Epoll, mais uma vez - Jacques Mattheij</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">epoll - recurso de notifica√ß√£o de eventos de E / S - The Mann</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O m√©todo para epollar a loucura - Cindy Sridharan</a> </li></ol><br><h2 id="benchmarks">  Benchmarks </h2><br><ol><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://www.kernel.org/doc/ols/2004/ols2004v1-pages-215-226.pdf</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">http://lse.sourceforge.net/epoll/index.html</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://mvitolin.wordpress.com/2015/12/05/endurox-testing-epollexclusive-flag/</a> </li></ol><br><h2 id="evolyuciya-epoll">  A evolu√ß√£o do epoll </h2><br><ol><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://lwn.net/Articles/13918/</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://lwn.net/Articles/520012/</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://lwn.net/Articles/520198/</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://lwn.net/Articles/542629/</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://lwn.net/Articles/633422/</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://lwn.net/Articles/637435/</a> </li></ol><br><h1 id="postskriptum">  Postscript </h1><br><p>  Muito obrigado a Sergey ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">dlinyj</a> ) e Peter Ovchenkov por valiosas discuss√µes, coment√°rios e ajuda! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt416669/">https://habr.com/ru/post/pt416669/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt416657/index.html">Dois ter√ßos dos cart√µes de mem√≥ria usados ‚Äã‚Äãcont√™m dados pessoais de propriet√°rios anteriores</a></li>
<li><a href="../pt416659/index.html">Devido a que o volume de pagamentos digitais para a economia do show chegar√° a US $ 1,2 trilh√£o de d√≥lares</a></li>
<li><a href="../pt416661/index.html">Quais tend√™ncias devem ser consideradas pelos usu√°rios e fornecedores de banco m√≥vel</a></li>
<li><a href="../pt416665/index.html">Reutilizando Bibliotecas Privadas do Android com o Sonatype Nexus Repository OSS</a></li>
<li><a href="../pt416667/index.html">Or√ßamento de isolamento de poeira e ru√≠do da antiga unidade de sistema</a></li>
<li><a href="../pt416673/index.html">Solu√ß√£o anal√≠tica para gerente</a></li>
<li><a href="../pt416677/index.html">Cyberpunk e Mirror Glasses: reflex√µes sobre moda e cultura</a></li>
<li><a href="../pt416679/index.html">Computa√ß√£o perif√©rica: uma combina√ß√£o amig√°vel de "nevoeiro" com "nuvens"</a></li>
<li><a href="../pt416681/index.html">Como do PostgreSQL e ClickHouse em Python muito, r√°pida e imediatamente em numpy</a></li>
<li><a href="../pt416683/index.html">O que vem a seguir? Ou como escolher recursos para desenvolvimento</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>