<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßëüèº üí∂ ‚ö∞Ô∏è Wie wir unsere Android Gallery-Bibliothek zum Anzeigen von Medieninhalten erstellt haben üìÑ üë®üèæ‚Äçü§ù‚Äçüë®üèª ü§üüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hallo Habr! Vor nicht allzu langer Zeit war ich auf der Suche nach Abenteuern, neuen Projekten und Technologien  wurde ein Roboter  in Redmadrobot ang...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Wie wir unsere Android Gallery-Bibliothek zum Anzeigen von Medieninhalten erstellt haben</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/redmadrobot/blog/433076/"><p><img src="https://habrastorage.org/webt/fl/a3/rh/fla3rh2hkzl_guxybjkro7f8hua.png"><br><br>  Hallo Habr!  Vor nicht allzu langer Zeit war ich auf der Suche nach Abenteuern, neuen Projekten und Technologien <del>  wurde ein Roboter </del>  in Redmadrobot angesiedelt.  Ich bekam einen Stuhl, einen Monitor und ein Macbook und ein kleines internes Projekt zum Aufw√§rmen.  Es war notwendig, eine selbst geschriebene Bibliothek fertigzustellen und zu ver√∂ffentlichen, um die Medieninhalte anzuzeigen, die wir in unseren Projekten verwenden.  In diesem Artikel werde ich Ihnen erkl√§ren, wie Sie Ber√ºhrungsereignisse in einer Woche verstehen, Open Source werden, einen Fehler in Android SDK finden und eine Bibliothek ver√∂ffentlichen. </p><a name="habracut"></a><br><h2 id="nachalo">  Starten Sie </h2><br><p>  Eine der wichtigen Funktionen unserer Store-Apps ist die M√∂glichkeit, Videos und Fotos von Waren und Dienstleistungen in der N√§he und von allen Seiten anzuzeigen.  Wir wollten das Rad nicht neu erfinden und machten uns auf die Suche nach einer fertigen Bibliothek, die zu uns passen w√ºrde. </p><br><p>  Wir wollten eine solche L√∂sung finden, damit der Benutzer: </p><br><ul><li>  Fotos anzeigen; </li><li>  Skalieren Sie Fotos mit einer Prise zum Zoomen und zweimaligen Tippen. </li><li>  Sehen Sie sich ein Video an </li><li>  Medieninhalte umdrehen; </li><li>  Schlie√üen Sie die Fotokarte mit einem vertikalen Wisch (Wischen zum Entlassen). </li></ul><br><p>  Folgendes haben wir gefunden: </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">FrescoImageViewer</a> - unterst√ºtzt das Anzeigen und Scrollen durch Fotos und grundlegende Gesten, unterst√ºtzt jedoch nicht das Anzeigen von Videos und ist f√ºr die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Fresco-</a> Bibliothek vorgesehen. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">PhotoView</a> - unterst√ºtzt das Anzeigen von Fotos. Die meisten Hauptsteuerungsgesten, au√üer Scrollen, Wischen zum Schlie√üen, unterst√ºtzen das Anzeigen von Videos nicht. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">PhotoDraweeView</a> - √§hnlich wie PhotoView, jedoch f√ºr Fresco gedacht. </li></ul><br><p>  Da keine der gefundenen Bibliotheken die Anforderungen vollst√§ndig erf√ºllte, mussten wir unsere eigenen schreiben. </p><br><h2 id="realizuem-biblioteku">  Wir realisieren die Bibliothek </h2><br><p>  Um die erforderliche Funktionalit√§t zu erhalten, haben wir vorhandene L√∂sungen aus anderen Bibliotheken fertiggestellt.  Sie beschlossen, dem Geschehenen den bescheidenen Namen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Android Gallery zu geben</a> . </p><br><h3 id="realizuem-funkcionalnost">  Wir implementieren Funktionalit√§t </h3><br><p>  <strong>Fotos anzeigen und zoomen</strong> <br>  Zum Anzeigen von Fotos haben wir die PhotoView-Bibliothek verwendet, die das sofortige Skalieren unterst√ºtzt. </p><br><p>  <strong>Video ansehen</strong> <br>  Um das Video anzusehen, haben sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">ExoPlayer verwendet</a> , der im <a href="">MediaPagerAdapter</a> wiederverwendet <a href="">wird</a> .  Wenn ein Benutzer zum ersten Mal ein Video √∂ffnet, wird ExoPlayer erstellt.  Wenn Sie zu einem anderen Element wechseln, wird es in die Warteschlange gestellt. Wenn Sie das Video das n√§chste Mal starten, wird die bereits erstellte ExoPlayer-Instanz verwendet.  Dies macht den √úbergang zwischen Elementen reibungsloser. </p><br><p> <strong>Scrollen von Medieninhalten</strong> <br>  Hier haben wir den <a href="">MultiTouchViewPager</a> von FrescoImageViewer verwendet, der keine Multi-Touch-Ereignisse abf√§ngt, sodass wir ihm Gesten hinzuf√ºgen konnten, um das Bild zu skalieren. </p><br><p>  <strong>Wischen Sie, um zu entlassen</strong> <br>  PhotoView unterst√ºtzte das Streichen und Entprellen nicht (Wiederherstellen der urspr√ºnglichen Bildgr√∂√üe, wenn das Bild vergr√∂√üert oder verkleinert wird). <br>  So haben wir es geschafft. </p><br><h3 id="izuchaem-touch-events-dlya-realizacii-swipe-to-dismiss">  Lernen von Touch-Ereignissen zum Implementieren von Swipe zum Entlassen </h3><br><p> Bevor Sie Swipe zum Schlie√üen unterst√ºtzen, m√ºssen Sie wissen, wie Ber√ºhrungsereignisse funktionieren.  Wenn der Benutzer den Bildschirm ber√ºhrt, wird die Methode <code>dispatchTouchEvent(motionEvent: MotionEvent)</code> in der aktuellen Aktivit√§t aufgerufen, zu der <code>MotionEvent.ACTION_DOWN</code> .  Diese Methode entscheidet √ºber das Schicksal des Ereignisses.  Sie k√∂nnen <code>motionEvent</code> zur <code>motionEvent</code> an <code>onTouchEvent(motionEvent: MotionEvent)</code> √ºbergeben <code>motionEvent</code> in der <code>onTouchEvent(motionEvent: MotionEvent)</code> von oben nach unten weiter <code>onTouchEvent(motionEvent: MotionEvent)</code> .  View, das an einem Ereignis und / oder nachfolgenden Ereignissen vor <code>ACTION_UP</code> , gibt true zur√ºck. </p><br><p>  Danach fallen alle Ereignisse der aktuellen Geste in diese Ansicht, bis die Geste mit dem Ereignis <code>ACTION_UP</code> endet oder die √ºbergeordnete ViewGroup die Kontrolle √ºbernimmt (dann wird das Ereignis <code>ACTION_CANCELED</code> ).  Wenn sich das Ereignis um die gesamte <code>onTouchEvent(motionEvent: MotionEvent)</code> und niemand interessiert war, kehrt es zur Aktivit√§t in <code>onTouchEvent(motionEvent: MotionEvent)</code> . <br><br><img src="https://habrastorage.org/webt/yz/np/jd/yznpjdfaodnwmd3tzy_wldagyak.png"><br><br>  In unserer Android Gallery-Bibliothek kommt das erste <code>ACTION_DOWN</code> Ereignis zu <code>dispatchTouchEvent()</code> in PhotoView, wo <code>motionEvent</code> an die <code>onTouch()</code> <code>motionEvent</code> , die true zur√ºckgibt.  Dar√ºber hinaus durchlaufen alle Ereignisse dieselbe Kette, bis eines der folgenden Ereignisse: </p><br><ul><li>  <code>ACTION_UP</code> ; </li><li>  ViewPager versucht, das Ereignis zum Scrollen abzufangen. </li><li>  <a href="">VerticalDragLayout</a> versucht, das Ereignis abzufangen, damit Swipe geschlossen wird. </li></ul><br><p>  Nur ViewGroup in der Methode <code>onInterceptTouchEvent(motionEvent: MotionEvent)</code> kann Ereignisse abfangen.  Selbst wenn die Ansicht an einem MotionEvent interessiert ist, durchl√§uft das Ereignis selbst das <code>dispatchTouchEvent(motionEvent: MotionEvent)</code> gesamten vorherigen ViewGroup-Kette.  Dementsprechend ‚Äûbeobachten‚Äú Eltern ihre Kinder immer.  Jede √ºbergeordnete ViewGroup kann das Ereignis abfangen und in der <code>onInterceptTouchEvent(motionEvent: MotionEvent)</code> . Anschlie√üend erhalten alle <code>MotionEvent.ACTION_CANCEL</code> in <code>onTouchEvent(motionEvent: MotionEvent)</code> . </p><br><p>  Beispiel: Der Benutzer h√§lt einen Finger auf ein Element in einer RecyclerView, dann werden Ereignisse im selben Element verarbeitet.  Sobald er jedoch anf√§ngt, seinen Finger nach oben / unten zu bewegen, f√§ngt der RecyclerView die Ereignisse ab, und der <code>ACTION_CANCEL</code> beginnt, und die Ansicht empf√§ngt das Ereignis <code>ACTION_CANCEL</code> . <br><br><img src="https://habrastorage.org/webt/yp/x9/kf/ypx9kf8alvwtag0jfihj-jrzjmo.png"><br><br>  In der Android-Galerie kann VerticalDragLayout Ereignisse abfangen, die durch Wischen geschlossen werden sollen, oder ViewPager zum Scrollen.  View kann jedoch verhindern, dass das √ºbergeordnete <code>requestDisallowInterceptTouchEvent(true)</code> Ereignisse <code>requestDisallowInterceptTouchEvent(true)</code> indem die Methode <code>requestDisallowInterceptTouchEvent(true)</code> wird.  Dies kann erforderlich sein, wenn die Ansicht Aktionen ausf√ºhren muss, deren Abfangen durch die Eltern f√ºr uns nicht w√ºnschenswert ist. </p><br><p>  Zum Beispiel, wenn ein Benutzer in einem Player einen Titel zu einer bestimmten Zeit √ºberspringt.  Wenn der √ºbergeordnete ViewPager einen horizontalen Bildlauf abf√§ngt, erfolgt ein √úbergang zum n√§chsten Titel. </p><br><p>  Wir haben VerticalDragLayout geschrieben, aber keine Touch-Ereignisse von PhotoView empfangen.  Um zu verstehen, warum dies passiert, musste ich herausfinden, wie Ber√ºhrungsereignisse in PhotoView verarbeitet werden. </p><br><p>  Bearbeitungsauftrag: </p><br><ol><li>  Wenn MotionEvent.ACTION_DOWN in VerticalDragLayout ausgef√ºhrt wird, wird <code>interceptTouchEvent()</code> ausgel√∂st, das false zur√ºckgibt, weil  Diese ViewGroup interessiert sich nur f√ºr vertikale ACTION_MOVE.  Die Richtung ACTION_MOVE wird in <code>dispatchTouchEvent()</code> definiert. Anschlie√üend wird das Ereignis an die Methode <code>super.dispatchTouchEvent()</code> in der ViewGroup √ºbergeben, wo das Ereignis an die Implementierung <code>interceptTouchEvent()</code> in VerticalDragLayout √ºbergeben wird. <br><br><img src="https://habrastorage.org/webt/le/zg/xb/lezgxbf8n-_tnhdpqc96drpjqvm.png"><br><br></li><li>  Wenn das Ereignis <code>onTouch()</code> Methode <code>onTouch()</code> in PhotoView erreicht, wird durch die Ansicht die M√∂glichkeit zum Abfangen der Ereignisverwaltung beeintr√§chtigt.  Alle nachfolgenden Gestenereignisse fallen nicht in die <code>interceptTouchEvent()</code> -Methode.  Die M√∂glichkeit, die Kontrolle abzufangen, wird dem √ºbergeordneten <code>ACTION_MOVE</code> nur gegeben, wenn die Geste abgeschlossen ist oder wenn horizontale <code>ACTION_MOVE</code> am rechten / linken Rand des Bildes <code>ACTION_MOVE</code> . <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mAllowParentInterceptOnEdge &amp;&amp; !mScaleDragDetector.isScaling() &amp;&amp; !mBlockParentIntercept) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mScrollEdge == EDGE_BOTH || (mScrollEdge == EDGE_LEFT &amp;&amp; dx &gt;= <span class="hljs-number"><span class="hljs-number">1f</span></span>) || (mScrollEdge == EDGE_RIGHT &amp;&amp; dx &lt;= -<span class="hljs-number"><span class="hljs-number">1f</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parent != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { parent.requestDisallowInterceptTouchEvent(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); } } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parent != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { parent.requestDisallowInterceptTouchEvent(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } }</code> </pre> <br><p><img src="https://habrastorage.org/webt/kk/s3/pj/kks3pjkovqsyiyiaif64bc_qh3e.png"><br><br>  Da PhotoView es dem √ºbergeordneten Element erm√∂glicht, die Steuerung nur bei horizontaler <code>ACTION_MOVE</code> , und das Wischen zum <code>ACTION_MOVE</code> vertikale <code>ACTION_MOVE</code> , kann VerticalDragLayout die Ereignissteuerung nicht abfangen, um eine Geste zu implementieren.  Um dies zu beheben, m√ºssen Sie die M√∂glichkeit hinzuf√ºgen, die Steuerung bei vertikalem <code>ACTION_MOVE</code> . <br></p><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mAllowParentInterceptOnEdge &amp;&amp; !mScaleDragDetector.isScaling() &amp;&amp; !mBlockParentIntercept) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mHorizontalScrollEdge == HORIZONTAL_EDGE_BOTH || (mHorizontalScrollEdge == HORIZONTAL_EDGE_LEFT &amp;&amp; dx &gt;= <span class="hljs-number"><span class="hljs-number">1f</span></span>) || (mHorizontalScrollEdge == HORIZONTAL_EDGE_RIGHT &amp;&amp; dx &lt;= -<span class="hljs-number"><span class="hljs-number">1f</span></span>) || mVerticalScrollEdge == VERTICAL_EDGE_BOTH || (mVerticalScrollEdge == VERTICAL_EDGE_TOP &amp;&amp; dy &gt;= <span class="hljs-number"><span class="hljs-number">1f</span></span>) || (mVerticalScrollEdge == VERTICAL_EDGE_BOTTOM &amp;&amp; dy &lt;= -<span class="hljs-number"><span class="hljs-number">1f</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parent != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { parent.requestDisallowInterceptTouchEvent(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); } } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parent != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { parent.requestDisallowInterceptTouchEvent(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } }</code> </pre> <br><p>  Im Fall der ersten vertikalen <code>ACTION_MOVE</code> bietet PhotoView nun die M√∂glichkeit, das √ºbergeordnete Element abzufangen: <br><br><img src="https://habrastorage.org/webt/j7/ea/_z/j7ea_zwmamtooghpppzcyxl-bne.png"><br><br>  Die folgende <code>ACTION_MOVE</code> wird in VerticalDragLyout abgefangen, und das Ereignis <code>ACTION_CANCEL</code> wird in die <code>ACTION_CANCEL</code> Ansicht √ºbertragen: <br><br><img src="https://habrastorage.org/webt/jb/ag/tz/jbagtzmul81dakmf0nujxzumw6u.png"><br><br>  Alle anderen <code>ACTION_MOVE</code> fliegen entlang der Standardkette zu VerticalDragLayout.  Es ist wichtig, dass die untergeordnete Ansicht die Kontrolle nicht wiedererlangen kann, nachdem die ViewGroup die Kontrolle √ºber Ereignisse aus der untergeordneten Ansicht √ºbernommen hat. <br><br><img src="https://habrastorage.org/webt/ud/ql/yv/udqlyv7d4-aigffi5hdwypwfy5u.png"><br><br>  Deshalb haben wir Swipe implementiert, um die Unterst√ºtzung f√ºr die PhotoView-Bibliothek zu beenden.  In unserer Bibliothek haben wir die ge√§nderten Quellen von PhotoView verwendet, die in einem separaten Modul herausgenommen wurden, und eine <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Zusammenf√ºhrungsanforderung</a> im urspr√ºnglichen PhotoView-Repository erstellt. <br><br></p><h3 id="realizuem-debauns-v-photoview">  Wir implementieren Debinds in PhotoView </h3><br><p>  Denken Sie daran, dass eine Entprellung eine Animationswiederherstellung mit einem akzeptablen Ma√üstab ist, wenn das Bild √ºber seine Grenzen hinaus skaliert wird. <br><br><img src="https://habrastorage.org/webt/op/rv/wb/oprvwbemhg9ikmrm1zfv45w6fvo.gif"><br><br>  In PhotoView gab es keine solche M√∂glichkeit.  Aber seit wir angefangen haben, Open Source von jemand anderem zu graben, warum sollten wir dort aufh√∂ren?  In PhotoView k√∂nnen Sie eine Zoomgrenze festlegen.  Dies ist zun√§chst das Minimum - x1 und das Maximum - x3.  Das Bild kann diese Grenzen nicht √ºberschreiten. </p><br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onScale</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> scaleFactor, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> focusX, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> focusY)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((getScale() &lt; mMaxScale || scaleFactor &lt; <span class="hljs-number"><span class="hljs-number">1f</span></span>) &amp;&amp; (getScale() &gt; mMinScale || scaleFactor &gt; <span class="hljs-number"><span class="hljs-number">1f</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mScaleChangeListener != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { mScaleChangeListener.onScaleChange(scaleFactor, focusX, focusY); } mSuppMatrix.postScale(scaleFactor, scaleFactor, focusX, focusY); <span class="hljs-comment"><span class="hljs-comment">//      checkAndDisplayMatrix(); } }</span></span></code> </pre> <br><p>  Zun√§chst haben wir beschlossen, die Bedingung ‚ÄûSkalierungsverbot beim Erreichen eines Minimums‚Äú <code>getScale() &gt; mMinScale || scaleFactor &gt; 1f</code> : Wir haben einfach die Bedingung <code>getScale() &gt; mMinScale || scaleFactor &gt; 1f</code>  <code>getScale() &gt; mMinScale || scaleFactor &gt; 1f</code> .  Und dann pl√∂tzlich ... <br><br><img src="https://habrastorage.org/webt/z_/ra/xg/z_raxgeezaf7o0h0zprufgrtggq.jpeg"><br><br>  Debuns verdient!  Anscheinend geschah dies aufgrund der Tatsache, dass die Sch√∂pfer der Bibliothek beschlossen, zweimal auf Nummer sicher zu gehen, was sowohl eine Entprellung als auch eine Einschr√§nkung der Skalierung zur Folge hatte.  Wenn bei der Implementierung des onTouch-Ereignisses, n√§mlich im Fall von <code>MotionEvent.ACTION_UP</code> , der Benutzer mehr / weniger als das Maximum / Minimum skaliert hat, wird <a href="">AnimatedZoomRunnable</a> gestartet, wodurch das Bild auf seine urspr√ºngliche Gr√∂√üe zur√ºckgesetzt wird. </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onTouch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(View v, MotionEvent ev)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> handled = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (ev.getAction()) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MotionEvent.ACTION_UP: <span class="hljs-comment"><span class="hljs-comment">// If the user has zoomed less than min scale, zoom back // to min scale if (getScale() &lt; mMinScale) { RectF rect = getDisplayRect(); if (rect != null) { v.post(new AnimatedZoomRunnable(getScale(), mMinScale, rect.centerX(), rect.centerY())); handled = true; } } else if (getScale() &gt; mMaxScale) { RectF rect = getDisplayRect(); if (rect != null) { v.post(new AnimatedZoomRunnable(getScale(), mMaxScale, rect.centerX(), rect.centerY())); handled = true; } } break; } }</span></span></code> </pre> <br><p>  Neben dem Wischen zum Entlassen haben wir PhotoView in den Quellen unserer Bibliothek finalisiert und eine <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Pull-Anfrage</a> mit dem ‚ÄûHinzuf√ºgen‚Äú einer Entprellung zum urspr√ºnglichen PhotoView erstellt. </p><br><h3 id="ispravlyaem-vnezapnyy-bag-v-photoview">  Beheben Sie einen pl√∂tzlichen Fehler in PhotoView </h3><br><p>  PhotoView hat einen sehr b√∂sen Fehler.  Wenn der Benutzer das Bild durch zweimaliges Tippen auf und vergr√∂√üern m√∂chte <del>  Er hat einen Anfall von Epilepsie </del>  Das Bild beginnt zu skalieren und kann vertikal um 180 Grad gedreht werden.  Dieser Fehler kann sogar in beliebten Anwendungen von Google Play gefunden werden, beispielsweise in Cyan. <br><br><img src="https://habrastorage.org/webt/m7/y1/hm/m7y1hmgkwqachpwst660vkrilwa.gif"><br><br>  Nach einer langen Suche haben wir diesen Fehler immer noch lokalisiert: Manchmal wird der Eingangsmatrix ein negativer scaleFactor zur Bildskalierung zur Skalierung zugef√ºhrt, wodurch das Bild umgedreht wird. </p><br><p>  <a href="">CustomGestureDetector</a> </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onScale</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ScaleGestureDetector detector)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//  -   scaleFactor &lt; 0 //      float scaleFactor = detector.getScaleFactor(); if (Float.isNaN(scaleFactor) || Float.isInfinite(scaleFactor)) return false; //    scaleFactor   callback //      mListener.onScale(scaleFactor, detector.getFocusX(), detector.getFocusY()); return true; }</span></span></code> </pre> <br><p>  Um vom Android ScaleGestureDetector aus zu skalieren, erhalten <a href="">wir</a> scaleFactor, der wie folgt berechnet wird: </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">float</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getScaleFactor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (inAnchoredScaleMode()) { <span class="hljs-comment"><span class="hljs-comment">// Drag is moving up; the further away from the gesture // start, the smaller the span should be, the closer, // the larger the span, and therefore the larger the scale final boolean scaleUp = (mEventBeforeOrAboveStartingGestureEvent &amp;&amp; (mCurrSpan &lt; mPrevSpan)) || (!mEventBeforeOrAboveStartingGestureEvent &amp;&amp; (mCurrSpan &gt; mPrevSpan)); final float spanDiff = (Math.abs(1 - (mCurrSpan / mPrevSpan)) * SCALE_FACTOR); return mPrevSpan &lt;= 0 ? 1 : scaleUp ? (1 + spanDiff) : (1 - spanDiff); } return mPrevSpan &gt; 0 ? mCurrSpan / mPrevSpan : 1; }</span></span></code> </pre> <br><p>  Wenn Sie diese Methode mit Debug-Protokollen √ºberschreiben, k√∂nnen Sie verfolgen, bei welchen bestimmten Werten der Variablen ein negativer scaleFactor erhalten wird: </p><br><pre> <code class="plaintext hljs">mEventBeforeOrAboveStartingGestureEvent is true; SCALE_FACTOR is 0.5; mCurrSpan: 1075.4398; mPrevSpan 38.867798; scaleUp: false; spanDiff: 13.334586; eval result is -12.334586</code> </pre> <br><p>  Es besteht der Verdacht, dass sie versucht haben, dieses Problem durch Multiplikation von spanDiff mit SCALE_FACTOR == 0.5 zu l√∂sen.  Diese L√∂sung hilft jedoch nicht, wenn der Unterschied zwischen mCurrSpan und mPrevSpan mehr als dreimal betr√§gt.  F√ºr diesen Fehler wurde bereits ein <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Ticket</a> gestartet, das jedoch noch nicht behoben wurde. <br><del>  Kr√ºcke </del>  Die einfachste L√∂sung f√ºr dieses Problem besteht darin, negative scaleFactor-Werte einfach zu √ºberspringen.  In der Praxis wird der Benutzer nicht bemerken, dass das Bild manchmal etwas weniger sanft als gew√∂hnlich vergr√∂√üert wird. </p><br><h1 id="vmesto-zaklyucheniya">  Anstelle einer Schlussfolgerung </h1><br><h3 id="sudba-pull-rekvestov">  Das Schicksal von Pull-Anfragen </h3><br><p>  Wir haben eine lokale Korrektur vorgenommen und die letzte <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Pull-Anforderung</a> in PhotoView erstellt.  Trotz der Tatsache, dass einige PRs seit einem Jahr dort h√§ngen, wurden unsere PRs in die Hauptniederlassung aufgenommen und sogar eine neue Version von PhotoView wurde ver√∂ffentlicht.  Danach haben wir beschlossen, das lokale Modul aus der Android-Galerie auszuschneiden und die offiziellen PhotoView-Quellen aufzurufen.  Dazu musste ich Unterst√ºtzung f√ºr AndroidX hinzuf√ºgen, das in Version <a href="">2.1.3</a> zu PhotoView <a href="">hinzugef√ºgt wurde</a> . </p><br><h3 id="gde-nayti-biblioteku">  Wo finde ich die Bibliothek? </h3><br><p>  Suchen Sie hier nach dem Quellcode der Android Gallery-Bibliothek - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">https://github.com/redmadrobot-spb/android-gallery</a> - sowie nach einer Gebrauchsanweisung.  Und um Projekte zu unterst√ºtzen, die weiterhin die Support-Bibliothek verwenden, haben wir eine separate Version von <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">android-gallery-veraltet erstellt</a> .  Aber seien Sie vorsichtig, denn in einem Jahr wird die Support Library zu einem K√ºrbis! </p><br><h3 id="chto-dalshe">  Was weiter </h3><br><p>  Jetzt passt die Bibliothek ganz zu uns, aber im Laufe der Entwicklung entstanden neue Ideen.  Hier sind einige davon: </p><br><ul><li>  die M√∂glichkeit, die Bibliothek in jedem Layout und nicht nur in einem separaten FragmentDialog zu verwenden; </li><li>  die M√∂glichkeit, die Benutzeroberfl√§che anzupassen; </li><li>  die F√§higkeit, Gilde und ExoPlayer zu ersetzen; </li><li>  die M√∂glichkeit, etwas anstelle von ViewPager zu verwenden. </li></ul><br><h3 id="ssylki">  Referenzen </h3><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Das Android Touch System aus einer etwas anderen Perspektive</a> - ein sehr guter Artikel zum Thema mit Links zu anderen gro√üartigen Artikeln und Videos, in denen die Funktionsweise des Android Touch Systems beschrieben wird. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Gestenbeherrschung in Android</a> - Artikel √ºber Android Touch System in russischer Sprache. </li></ul><br><h3 id="upd">  UPD </h3><br><p>  Beim Schreiben eines Artikels kam eine √§hnliche <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Bibliothek</a> der Entwickler von <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">FrescoImageViewer heraus</a> .  Sie haben Unterst√ºtzung f√ºr <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">√úbergangsanimationen</a> hinzugef√ºgt, aber bisher haben wir nur Video-Unterst√ºtzung.  :) :) </p></li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de433076/">https://habr.com/ru/post/de433076/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de433064/index.html">Incident Management: "Sie k√∂nnen nicht aufgeben" oder die Kunst, Kommas zu setzen</a></li>
<li><a href="../de433066/index.html">HighLoad Cup # 2. Meisterschaft f√ºr Backend-Entwickler wieder in Betrieb</a></li>
<li><a href="../de433070/index.html">Wie man Shampoo von Champignons und Spie√üe von Champagner unterscheidet ... Elasticsearch - Suche nach Produkten in Gesch√§ftsdatenbanken</a></li>
<li><a href="../de433072/index.html">So hacken Sie den Kopierschutz der Sega Dreamcast-Konsole</a></li>
<li><a href="../de433074/index.html">In einem Android-Projekt zu Kotlin wechseln: Tipps und Tricks</a></li>
<li><a href="../de433078/index.html">Wir schreiben Handelsroboter mit dem grafischen Framework von StockSharp. Teil 2</a></li>
<li><a href="../de433082/index.html">Das Pumpen der Konten anderer Personen ist in S√ºdkorea zu einer Straftat geworden</a></li>
<li><a href="../de433084/index.html">Offene Lektion "Feature Engineering am Beispiel des klassischen Titanic-Datensatzes"</a></li>
<li><a href="../de433086/index.html">Tinkoff und alles, alles, alles: IoT, Analyse und √úberwachung f√ºr Banken</a></li>
<li><a href="../de433088/index.html">Wie gef√§llt es Ihnen, Elon Musk: BMW und Porsche haben eine Aufladung entwickelt, die 100 km Fahrt in 3 Minuten erm√∂glicht</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>