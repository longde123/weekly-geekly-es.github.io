<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëàüèΩ üëâ üöò Astuces pour lier et t√©l√©charger des fichiers Mach-O üëäüèæ üë®üèæ‚Äç‚öïÔ∏è üíî</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Je vous pr√©sente la traduction de mon article du blog du Darling Project. Un peu d'aide sur les concepts utilis√©s: Darwin - un syst√®me d'exploitation ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Astuces pour lier et t√©l√©charger des fichiers Mach-O</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/417507/"><p> <em>Je vous pr√©sente la traduction de mon article du blog du Darling Project.</em>  <em>Un peu d'aide sur les concepts utilis√©s: Darwin - un syst√®me d'exploitation open source qui sous-tend macOS, iOS et d'autres syst√®mes d'exploitation d'Apple;</em>  <em>Mach-O est un format binaire de fichiers ex√©cutables et de biblioth√®ques utilis√©s dans Darwin;</em>  <em>dyld - chargeur de d√©marrage dynamique utilis√© par Darwin pour t√©l√©charger des fichiers Mach-O;</em>  <em>dylib est une biblioth√®que chargeable dynamiquement (a g√©n√©ralement l'extension <code>.dylib</code> ).</em> </p><br><p><img src="https://habrastorage.org/webt/q4/to/tb/q4totbx7ltcbh_gj58-qnayiffg.png" alt="Une image pour attirer l'attention"></p><br><p>  L'objectif du projet Darling est de permettre aux applications macOS de s'ex√©cuter sur Linux, et la possibilit√© de t√©l√©charger des fichiers binaires au format Mach-O est l'une des √©tapes cl√©s vers cet objectif. </p><br><p>  Initialement, Darling a √©t√© construit autour de sa propre impl√©mentation du chargeur Mach-O et de l'id√©e de diffuser des appels entre l'API Darwin de haut niveau et ses homologues Linux.  Depuis lors, nous nous sommes concentr√©s sur l'ex√©cution de code dans un conteneur Darwin de plus en plus isol√©.  Depuis que nous sommes <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pass√©s √† l‚Äôutilisation de Mach-O pour les composants internes de Darling</a> , nous avons pu utiliser le colorant original d‚ÄôApple, ainsi que cr√©er de nombreux autres composants Darwin open source.  Nous avons encore besoin d'un simple chargeur de d√©marrage Mach-O pour d√©marrer le colorant lui-m√™me. </p><a name="habracut"></a><br><p>  Mach-O, avec Mach lui-m√™me, sont probablement les caract√©ristiques les plus remarquables de Darwin, et les diverses biblioth√®ques et frameworks fournis par Apple utilisent largement de nombreuses fonctionnalit√©s obscures du format Mach-O.  Cela fait du travail avec Mach-O l'une des t√¢ches les plus importantes et les plus notables du d√©veloppement de Darling.  De l'impl√©mentation de chargeurs Mach-O natifs √† l'assemblage de composants Darwin (d'abord sous la forme de fichiers ELF sp√©ciaux, et maintenant sous la forme de vrais Mach-O) - nous devons comprendre la structure interne de Mach-O √† un niveau beaucoup plus profond que ce qui est habituellement exig√© de l'ordinaire d√©veloppeurs pour la plate-forme Darwin. </p><br><p>  Nous terminons cette introduction et passons √† l'examen de certaines des astuces que le format Mach-O peut nous offrir. </p><br><h2 id="ustanovochnye-imena">  Noms d'installation </h2><br><p>  Sous Windows et Linux, les biblioth√®ques dynamiques sont r√©f√©renc√©es par leur nom (par exemple, <code>libc.so</code> ), apr√®s quoi la t√¢che de l'√©diteur de liens dynamiques est de trouver une biblioth√®que avec un nom correspondant dans l'un des r√©pertoires de biblioth√®que standard.  Darwin utilise imm√©diatement le chemin d'acc√®s (presque) complet au fichier de biblioth√®que, qui est appel√© le nom d'installation de cette biblioth√®que.  Vraisemblablement, cela a √©t√© fait pour emp√™cher la <em>substitution de dylib</em> [d√©tournement de dylib] - une attaque dans laquelle un faux dylib est plac√© dans un r√©pertoire dans lequel il sera trouv√© par un √©diteur de liens dynamique plus t√¥t que le vrai, ce qui permet √† un faux dylib d'ex√©cuter du code arbitraire au nom du programme, ce qui l'a donc convaincu t√©l√©chargement de dylib. </p><br><p>  Non seulement les ex√©cutables et les biblioth√®ques stockent les noms d'installation complets de leurs d√©pendances, mais les d√©pendances Mach-O elles-m√™mes ¬´connaissent¬ª leurs propres noms d'installation.  En fait, c'est ainsi que l'√©diteur de liens apprend quels noms d'installation utiliser pour les d√©pendances: il les lit √† partir des d√©pendances elles-m√™mes. </p><br><p>  Lors de la liaison de dylib, vous sp√©cifiez son nom d'installation √† l'aide des options ld <code>-install_name</code> ou <code>-dylib_install_name</code> : </p><br><pre> <code class="bash hljs">$ ld -o libfoo.dylib foo.o -install_name /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/lib/libfoo.dylib</code> </pre> <br><p>  Maintenant, lorsque vous liez un autre fichier Mach-O (par exemple <code>libbar.dylib</code> ) √† <code>libfoo.dylib</code> , ld √©crira le nom d'installation de libfoo - <code>/usr/local/lib/libfoo.dylib</code> - dans la <code>libbar</code> d√©pendances de <code>libbar</code> , et c'est l√† que se trouve dyld recherchera <code>libfoo</code> lors de l'ex√©cution. </p><br><p>  L'utilisation du chemin complet fonctionne assez bien pour les biblioth√®ques syst√®me, qui, en fait, sont install√©es √† des emplacements pr√©c√©demment connus du syst√®me de fichiers;  mais avec les biblioth√®ques qui font partie des ensembles d'applications, il y a un probl√®me.  Bien que chaque application puisse supposer qu'elle sera install√©e dans <code>/Applications/AppName.app</code> , d'une mani√®re g√©n√©rale, cela signifie que les assemblys d'application sont portables et peuvent √™tre librement d√©plac√©s dans le syst√®me de fichiers, de sorte que le chemin de biblioth√®que sp√©cifique √† l'int√©rieur de ces assemblys ne peut pas √™tre connu √† l'avance. </p><br><p>  Pour r√©soudre ce probl√®me, Darwin permet aux noms d'installation de commencer par <code>@executable_path</code> , <code>@loader_path</code> ou <code>@rpath</code> - qui n'est pas absolu, mais indique le chemin de la biblioth√®que par rapport au chemin d'acc√®s au fichier ex√©cutable principal, le chemin d'acc√®s au "chargement" (fichier ex√©cutable ou biblioth√®que, qui d√©pend directement de cette biblioth√®que) ou par rapport √† la liste des chemins d√©finis respectivement par le fichier ex√©cutable principal.  <code>@executable_path</code> et <code>@loader_path</code> fonctionnent sans complexit√© suppl√©mentaire, mais si au moins une de vos d√©pendances (ou leurs d√©pendances transitives) a un nom de configuration utilisant <code>@rpath</code> , vous devez explicitement d√©finir <code>@rpath</code> lors de la liaison de votre fichier ex√©cutable en utilisant <code>-rpath</code> option ld <code>-rpath</code> fois combien vous avez besoin: </p><br><pre> <code class="bash hljs">$ ld -o runme -rpath @executable_path/../Frameworks -rpath @executable_path/../bin/lib</code> </pre> <br><p>  (Le concept rpath d√©truit dans une certaine mesure l'id√©e originale de chemins de biblioth√®que bien connus et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ouvre la</a> possibilit√© d'attaques d'usurpation de dylib. Nous pouvons supposer que cela rend tout ce qui concerne les noms d'installation assez inutile.) </p><br><h2 id="ciklicheskie-zavisimosti">  D√©pendances cycliques </h2><br><p>  Lorsque le code source d'un projet occupe plusieurs fichiers, il est tout √† fait normal que ces fichiers soient mutuellement d√©pendants les uns des autres.  Cela fonctionne bien tant que tous ces fichiers sont compil√©s en un seul binaire - un fichier ex√©cutable ou une biblioth√®que.  Ce qui ne fonctionne pas, c'est lorsque plusieurs biblioth√®ques dynamiques d√©pendent les unes des autres. </p><br><p>  Vous pouvez affirmer qu'au lieu d'utiliser des d√©pendances cycliques entre biblioth√®ques dynamiques, il vaut la peine de repenser l'architecture du projet, et je suis d'accord avec vous.  Mais s'il y a quelque chose de typique chez Apple, c'est qu'ils n'arr√™tent jamais de r√©fl√©chir et de bien faire les choses;  au lieu de cela, ils posent des b√©quilles et des tours les uns sur les autres.  Dans ce cas, pour Darling, nous devons faire fonctionner les d√©pendances circulaires, car les diff√©rentes <code>libSystem</code> <code>libsystem_dyld</code> , telles que <code>libsystem_dyld</code> , <code>libsystem_kernel</code> et <code>libsystem_pthread</code> , d√©pendent toutes les unes des autres.  (Jusqu'√† r√©cemment, nous devions √©galement lier cycliquement les frameworks Cocoa tels que AppKit, Core Graphics et Core OpenGL, en raison de la fa√ßon dont Core OpenGL a √©t√© impl√©ment√© dans The Cocotron, mais nous avons <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">repens√© l'</a> architecture de notre impl√©mentation de Core OpenGL et avons pu nous d√©barrasser de cette cyclique d√©pendances.) </p><br><p>  En principe, les d√©pendances circulaires devraient fonctionner correctement: un √©diteur de liens dynamique ne sait d√©j√† comment charger chaque biblioth√®que qu'une seule fois, il n'aura donc pas de probl√®mes de r√©cursion infinie.  Le probl√®me est que de telles biblioth√®ques ne peuvent pas √™tre simplement <em>li√©es</em> , car chaque appel de l'√©diteur de liens cr√©e une seule biblioth√®que et lors de la liaison de binaires, toutes ses d√©pendances d√©j√† li√©es doivent √™tre transf√©r√©es vers l'√©diteur de liens.  Nous devons d'abord lier une de nos biblioth√®ques, et pour le moment, les autres ne sont pas encore pr√™tes, nous ne pourrons donc pas les transf√©rer vers l'√©diteur de liens. </p><br><p>  L'astuce ici est de lier deux (ou pour plus de simplicit√©, toutes) ces biblioth√®ques <em>deux fois</em> .  Pour la premi√®re fois, dites √† l'√©diteur de liens d'ignorer les d√©pendances manquantes et, en r√©alit√©, ne transmettez pas les d√©pendances: </p><br><pre> <code class="bash hljs">$ ld -o libfoo.dylib foo.o -flat_namespace -undefined suppress $ ld -o libbar.dylib bar.o -flat_namespace -undefined suppress</code> </pre> <br><p>  (Voir ci-dessous pour <code>-flat_namespace</code> .) </p><br><p>  Bien s√ªr, si vous essayez d'utiliser directement les dylibs r√©sultants, vous obtiendrez des erreurs de lien dynamique au moment de l'ex√©cution.  Au lieu de cela, liez ces biblioth√®ques une deuxi√®me fois, en passant les dylibs r√©sultantes en tant que d√©pendances: </p><br><pre> <code class="bash hljs">$ ld -o libfoo.dylib foo.o libbar.dylib $ ld -o libbar.dylib bar.o libfoo.dylib</code> </pre> <br><p>  Cette fois, l'√©diteur de liens voit tous les caract√®res, nous ne lui demandons donc pas d'ignorer les erreurs (et si certains caract√®res sont vraiment manquants, vous obtiendrez une erreur). </p><br><p>  Malgr√© le fait que certaines, sinon toutes, des biblioth√®ques li√©es aux ¬´mauvaises¬ª copies de leurs d√©pendances, dyld verra les versions correctes au moment de l'ex√©cution.  Pour que cela fonctionne, assurez-vous que les deux copies de chaque biblioth√®que ont le m√™me nom d'installation. </p><br><p>  Un autre d√©tail ici est l'ordre d'initialisation.  Tout code peut d√©clarer des fonctions d'initialisation √† l'aide de la commande magique du compilateur <code>__attribute__((constructor))</code> (la liste de ces initialiseurs tombe dans la section <code>__mod_init_func</code> du fichier Mach-O).  Ces fonctions sont appel√©es par dyld lors du chargement du binaire dans lequel elles se trouvent avant d'appeler <code>main()</code> .  En r√®gle g√©n√©rale, les initialiseurs de chaque biblioth√®que sont ex√©cut√©s apr√®s les initialiseurs de ses d√©pendances, de sorte que chaque initialiseur peut s'attendre √† ce que les biblioth√®ques de d√©pendances soient d√©j√† initialis√©es et pr√™tes √† fonctionner.  Bien s√ªr, cela ne peut pas √™tre garanti pour les d√©pendances cycliques;  dyld ex√©cutera leurs initialiseurs dans un <em>certain</em> ordre.  Vous pouvez marquer les d√©pendances comme des d√©pendances ascendantes pour personnaliser cet ordre;  dyld initialisera en dernier les biblioth√®ques que quelqu'un a marqu√©es comme sa d√©pendance.  Donc, pour faire initialiser <code>libfoo</code> apr√®s <code>libbar</code> , liez-les comme ceci: </p><br><pre> <code class="bash hljs">$ ld -o libfoo.dylib foo.o libbar.dylib $ ld -o libbar.dylib bar.o -upward_library libfoo.dylib</code> </pre> <br><p>  Pour le rendre plus pratique, nous avons une fonction Darling CMake appel√©e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>add_circular</code></a> , qui s'occupe de toutes les difficult√©s et vous permet de l'utiliser comme √ßa simplement et de mani√®re d√©clarative: </p><br><pre> <code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(DYLIB_INSTALL_NAME <span class="hljs-string"><span class="hljs-string">"/usr/lib/system/libdispatch.dylib"</span></span>) add_circular(libdispatch_shared FAT SOURCES <span class="hljs-variable"><span class="hljs-variable">${dispatch_SRCS}</span></span> SIBLINGS system_c system_kernel system_malloc system_blocks system_pthread system_dyld system_duct unwind platform compiler_rt UPWARD objc )</code> </pre> <br><h2 id="dvuhurovnevoe-prostranstvo-imyon-simvolov">  Espace de noms de caract√®res √† deux niveaux </h2><br><p>  Les tables de symboles dans Mach-O ne stockent pas seulement les noms de symboles, elles ¬´se souviennent¬ª √©galement de quelle biblioth√®que (ou fichier ex√©cutable) quel symbole est extrait.  En d'autres termes, les noms de symboles existent dans des espaces de noms d√©finis par quel binaire les d√©finit;  d'o√π ¬´l'espace de noms √† deux niveaux¬ª (un autre niveau signifie les noms de symboles eux-m√™mes). </p><br><p>  Un espace de noms √† deux niveaux a √©t√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">introduit</a> pour √©viter les conflits de noms de symboles.  Habituellement, si plusieurs biblioth√®ques d√©finissent des caract√®res avec le m√™me nom, vous obtiendrez une erreur lors de la liaison;  mais cela peut ne pas fonctionner si vous chargez des biblioth√®ques au moment de l'ex√©cution (par exemple, des plug-ins) ou lorsque les versions des biblioth√®ques au moment du lien et √† l'ex√©cution diff√®rent.  Pour les biblioth√®ques qui utilisent un espace de noms √† deux niveaux, ce n'est pas un probl√®me - cela permet √† plusieurs biblioth√®ques de d√©finir des caract√®res avec le m√™me nom sans cr√©er de conflits. </p><br><p>  Un espace de noms √† deux niveaux peut √™tre d√©sactiv√© en revenant √† l'utilisation d'un "espace de noms plat" (l'une des raisons en est que l'utilisation d'un espace de noms √† deux niveaux implique que chaque caract√®re doit √™tre autoris√© pendant la liaison, donc un espace de noms plat est requis pour <code>-undefined_suppress</code> , comme nous avons vu ci-dessus).  Ld a deux indicateurs qui permettent de d√©sactiver l'espace de noms √† deux niveaux lors de la liaison: <code>-flat_namespace</code> , qui affecte un seul fichier Mach-O, et <code>-force_flat_namespace</code> , qui fonctionne uniquement avec les fichiers ex√©cutables, pas les biblioth√®ques, et force l'ensemble du processus √† utiliser un flat espace de noms.  De plus, vous pouvez forcer dyld √† utiliser un espace de noms plat lors de l'ex√©cution en d√©finissant la variable d'environnement <code>DYLD_FORCE_FLAT_NAMESPACE</code> . </p><br><p>  L'une des caract√©ristiques de l'utilisation d'un espace de noms √† deux niveaux est que vous devez toujours lier explicitement chaque Mach-O √† toutes les biblioth√®ques et infrastructures dont il d√©pend.  Par exemple, si vous vous connectez √† AppKit, vous ne pouvez pas simplement utiliser Foundation;  vous devez √©tablir un lien explicite avec elle.  Une autre caract√©ristique est que, en tant qu'auteur d'une biblioth√®que ou d'un framework, vous ne pouvez pas d√©placer librement l'impl√©mentation du symbole "vers le bas" le long de la cha√Æne de d√©pendance, comme vous pourriez vous y habituer (par exemple, vous ne pouvez pas simplement d√©placer du code d'AppKit vers Foundation).  Pour permettre cela, Mach-O, ld et dyld ont plusieurs fonctionnalit√©s suppl√©mentaires, √† savoir les <em>sous-biblioth√®ques</em> , la <em>r√©exportation des</em> <em>caract√®res</em> et les <em>m√©ta-caract√®res</em> . </p><br><h2 id="podbiblioteki">  Sous-biblioth√®ques </h2><br><p>  Sous-biblioth√®ques - un m√©canisme qui permet √† une biblioth√®que (appel√©e biblioth√®que de <em>fa√ßade</em> [biblioth√®que parapluie] ou biblioth√®que parapluie [biblioth√®que parapluie]) de d√©l√©guer la mise en ≈ìuvre d'une partie de ses fonctionnalit√©s √† une autre biblioth√®que (appel√©e sa sous-biblioth√®que [sous-biblioth√®que]);  ou, si vous le regardez de l'autre c√¥t√©, permettre √† la biblioth√®que de r√©exporter publiquement les symboles fournis par une autre biblioth√®que. </p><br><p>  L'endroit principal o√π cela est utilis√© est, encore une fois, <code>libSystem</code> avec ses sous-biblioth√®ques qui sont dans <code>/usr/lib/system</code> ;  mais il peut √™tre utilis√© avec n'importe quelle paire de biblioth√®ques: </p><br><pre> <code class="bash hljs">$ ld -o libfoo.dylib foo.o -lobjc -sub_library libobjc <span class="hljs-comment"><span class="hljs-comment"># : $ ld -o libfoo.dylib foo.o -reexport-lobjc</span></span></code> </pre> <br><p>  La seule chose qui affecte cela par rapport √† la simple liaison √† cette biblioth√®que est que la commande <code>LC_REEXPORT_DYLIB</code> est √©crite dans le fichier r√©sultant au lieu de la <code>LC_LOAD_DYLIB</code> habituelle (y compris les symboles de la sous-biblioth√®que lors de la liaison <em>ne</em> sont <em>pas</em> copi√©s dans la biblioth√®que parapluie, donc elle n'a m√™me pas √† lien si de nouveaux caract√®res sont ajout√©s √† la sous-biblioth√®que ult√©rieurement).  Au moment de l'ex√©cution, <code>LC_REEXPORT_DYLIB</code> fonctionne √©galement de la m√™me mani√®re que <code>LC_LOAD_DYLIB</code> : dyld chargera la sous-biblioth√®que et mettra ses caract√®res √† la disposition du reste (mais contrairement √† <code>LC_LOAD_DYLIB</code> , en termes d'espace de noms √† deux niveaux, les caract√®res proviendront de la biblioth√®que parapluie). </p><br><p>  Ce qui diff√®re vraiment √† propos de <code>LC_REEXPORT_DYLIB</code> c'est ce que ld fait lorsque vous liez <em>une autre</em> biblioth√®que √† <code>libfoo</code> : au lieu de simplement rechercher les symboles dans tous les fichiers objet et dylib qui lui ont √©t√© transmis, ld ouvrira et affichera √©galement la sous-biblioth√®que r√©export√©e (dans ce exemple <code>libobjc</code> ). </p><br><p>  Comment sait-il o√π la chercher?  La seule chose enregistr√©e dans <code>libfoo.dylib</code> est le nom d'installation <code>libobjc.dylib</code> , c'est donc l√† que ld s'attend √† le trouver.  Cela signifie que la biblioth√®que doit √™tre install√©e √† sa place avant de pouvoir √™tre utilis√©e comme sous-biblioth√®que pour autre chose;  cela fonctionne bien pour les biblioth√®ques syst√®me comme <code>libobjc</code> , mais cela peut √™tre tr√®s g√™nant ou compl√®tement impossible si vous essayez de r√©exporter votre propre sous-biblioth√®que. </p><br><p>  Pour r√©soudre ce probl√®me, ld fournit l'option <code>-dylib_file</code> , qui vous permet de sp√©cifier un chemin dylib diff√©rent √† utiliser lors de la liaison: </p><br><pre> <code class="bash hljs">$ ld -o libfoo.dylib foo.o -reexport_library /path/to/libsubfoo.dylib $ ld -o libbar.dylib bar.o libfoo.dylib -dylib_file @executable_path/lib/foo/libsubfoo.dylib:/path/to/libsubfoo.dylib</code> </pre> <br><p>  Bien que <code>libSystem</code> et certaines autres biblioth√®ques syst√®me r√©exportent leurs sous-biblioth√®ques, vous n'avez pas besoin d'utiliser <code>-dylib_file</code> lors de la liaison de chacun des fichiers ex√©cutables sur macOS;  cela est d√ª au fait que les biblioth√®ques syst√®me sont d√©j√† install√©es en fonction de leur nom d'installation.  Mais lors de la construction de Darling sur Linux, nous devons passer quelques options <code>-dylib_file</code> (et d'autres arguments courants) √† chaque appel ld.  Nous le faisons avec une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">fonction sp√©ciale</a> qui est automatiquement appliqu√©e lors de l'utilisation de <code>add_darling_library</code> , <code>add_darling_executable</code> et autres. </p><br><h2 id="pereeksportirovanie-simvolov">  R√©exporter des personnages </h2><br><p>  Parfois, une biblioth√®que peut avoir besoin de r√©exporter certains des caract√®res - mais pas tous en m√™me temps - √† partir d'une autre biblioth√®que.  Par exemple, Core Foundation <code>NSObject</code> , qui, dans les versions r√©centes, est impl√©ment√© dans l'environnement d'ex√©cution Objective-C, pour des raisons de compatibilit√©. </p><br><p>  (Si vous √™tes int√©ress√© par la raison pour laquelle <code>NSObject</code> √©tait une fois dans la Core Foundation au lieu de la Foundation, c'est parce que la <em>conversion gratuite</em> [pontage sans frais, la possibilit√© de diffuser directement entre les types de Core Foundation et Foundation correspondants sans conversion suppl√©mentaire], n√©cessite que les classes wrapper priv√©es sur les types de Core Foundation (par exemple, <code>__NSCFString</code> ) soient impl√©ment√©es dans Core Foundation; et en tant qu'objets Objective-C, elles doivent √™tre h√©rit√©es de <code>NSObject</code> . Probablement, tout cela pourrait √™tre r√©alis√© par √† un autre, laissant <code>NSObject</code> avec tous ses h√©ritiers dans la Fondation et la boucle  esky reliant la Core Foundation et la Foundation, mais Apple a d√©cid√© de migrer ces classes priv√©es d'assistance avec <code>NSObject</code> vers la Core Foundation, et dans Darling, nous proc√©dons de la m√™me mani√®re pour maintenir la compatibilit√©.) </p><br><p>  Vous pouvez transmettre √† ld une liste de caract√®res √† <code>-reexported_symbols_list</code> aide de son option <code>-reexported_symbols_list</code> : </p><br><pre> <code class="bash hljs">$ <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> .objc_class_name_NSObject &gt; reexport_list.exp $ ld -o CoreFoundation CFFiles.o -lobjc -reexported_symbols_list reexport_list.exp</code> </pre> <br><p>  Bien que la r√©exportation de <em>certains</em> symboles semble tr√®s similaire √† la r√©exportation de <em>tous les</em> symboles, le m√©canisme par lequel cela est impl√©ment√© est tr√®s diff√©rent de la fa√ßon dont les sous-biblioth√®ques fonctionnent.  Aucune commande <code>LC_*_DYLIB</code> n'est utilis√©e;  √† la place, un <em>symbole indirect</em> sp√©cial (indiqu√© par l'indicateur <code>N_INDIR</code> ) est ins√©r√© dans la table de noms et il se comporte comme le symbole d√©fini dans cette biblioth√®que.  Si la biblioth√®que elle-m√™me utilise ce symbole, la <em>deuxi√®me</em> copie ¬´ind√©finie¬ª du symbole <em>appara√Ætra</em> dans la table des noms (comme cela se produit sans aucune r√©exportation). </p><br><p>  Une petite chose importante √† garder √† l'esprit lors de l'utilisation de la r√©exportation explicite de caract√®res est que vous devez probablement r√©exporter des caract√®res avec des noms diff√©rents pour diff√©rentes architectures.  En effet, la convention de d√©nomination [convention de d√©nomination des noms] pour Objective-C et l'interface binaire Objective-C [ABI] pour i386 et x86-64 sont diff√©rentes, donc sur i386 vous n'avez qu'√† <code>.objc_class_name_NSObject</code> , et sur x86-64 - <code>_OBJC_CLASS_$_NSObject</code> , <code>_OBJC_IVAR_$_NSObject.isa</code> et <code>_OBJC_METACLASS_$_NSObject</code> .  Vous n'avez pas √† y penser lorsque vous utilisez des sous-biblioth√®ques, car tous les symboles disponibles automatiquement pour chaque architecture sont automatiquement r√©export√©s. </p><br><p>  La plupart des outils pour travailler avec Mach-O traitent de mani√®re transparente les binaires ¬´√©pais¬ª ou universels (fichiers Mach-O contenant plusieurs sous-Mach-O pour plusieurs architectures).  Clang peut compiler des binaires universels avec toutes les architectures demand√©es, dyld s√©lectionne l'architecture √† charger √† partir de dylib, en examinant les architectures prises en charge par l'ex√©cutable et des outils comme ld, otool et nm fonctionnent avec l'architecture correspondant √† l'architecture de l'ordinateur (c.-√†-d. . x86-64), sauf si vous avez explicitement besoin d'une architecture diff√©rente avec un indicateur sp√©cial. ,  -   ,     ‚Äì  ,         ,      . </p><br><p>         .  ld          ,  ,     dylib-           lipo: </p><br><pre> <code class="bash hljs">$ ld -o CF_i386.dylib CFFiles.o -arch i386 -lobjc -reexported_symbols_list reexport_i386.exp $ ld -o CF_x86-64.dylib CFFiles.o -arch x86_64 -lobjc -reexported_symbols_list reexport_x86_64.exp $ lipo -arch i386 CF_i386.dylib -arch x86_64 CF_x86-64.dylib -create -output CoreFoundation</code> </pre> <br><p>  Darling   CMake-   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>add_separated_framework</code></a> ,        lipo,    CMake-   Core Foundation <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">  </a> : </p><br><pre> <code class="cmake hljs">add_separated_framework(CoreFoundation CURRENT_VERSION SOURCES <span class="hljs-variable"><span class="hljs-variable">${cf_sources}</span></span> VERSION <span class="hljs-string"><span class="hljs-string">"A"</span></span> DEPENDENCIES objc system icucore LINK_FLAGS <span class="hljs-comment"><span class="hljs-comment"># ...    ) set_property(TARGET CoreFoundation_i386 APPEND_STRING PROPERTY LINK_FLAGS " -Wl,-reexported_symbols_list,${CMAKE_CURRENT_SOURCE_DIR}/reexport_i386.exp") set_property(TARGET CoreFoundation_x86_64 APPEND_STRING PROPERTY LINK_FLAGS " -Wl,-reexported_symbols_list,${CMAKE_CURRENT_SOURCE_DIR}/reexport_x86_64.exp")</span></span></code> </pre> <br><h2 id="meta-simvoly"> - </h2><br><p> - ‚Äì   , ,   Apple     ,    . </p><br><p>   Mach-O-       macOS,   ,     <code>-mmacosx-version-min=10.x</code> (    iOS, tvOS, watchOS    ,  Apple      ).     ;   ,         <code>AVAILABLE_MAC_OS_X_VERSION_10_13_AND_LATER</code>      C++  <code>libstdc++</code> (  GNU)  <code>libc++</code> (  LLVM).      ,        Mach-O.  ,   ld   <code>-macosx_version_min</code> (        <code>m</code> ),     Mach-O- <code>LC_VERSION_MIN_MACOSX</code> ( dyld,    ,        ). </p><br><p>    ,  ld  <code>-macosx_version_min</code>   ,  - <em></em> Mach-O- . - ‚Äì  ,     <code>$ld$</code> ,  ld,    ,    :     ,   .      <code>$ld$$$</code> .  <code></code>   <code>os10.5</code>  ,       - ‚Äì  ,        <em></em>   Mach-O-   <em></em> ,   ; <code></code>   <code>add</code> , <code>hide</code> , <code>install_name</code>  <code>compatibility_version</code> ,   ld ,          <code></code> ,  <code></code>          ( )  , . </p><br><p>  <code></code>     , ,  ,             ; ,   -,   <code>libobjc</code> ,   <code>NSObject</code>  ,      macOS: </p><br><pre> <code class="hljs perl">$ld$hide$os10.<span class="hljs-number"><span class="hljs-number">0</span></span>$_OBJC_CLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">0</span></span>$_OBJC_IVAR_$_NSObject.isa $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">0</span></span>$_OBJC_METACLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">1</span></span>$_OBJC_CLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">1</span></span>$_OBJC_IVAR_$_NSObject.isa $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">1</span></span>$_OBJC_METACLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">2</span></span>$_OBJC_CLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">2</span></span>$_OBJC_IVAR_$_NSObject.isa $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">2</span></span>$_OBJC_METACLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">3</span></span>$_OBJC_CLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">3</span></span>$_OBJC_IVAR_$_NSObject.isa $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">3</span></span>$_OBJC_METACLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">4</span></span>$_OBJC_CLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">4</span></span>$_OBJC_IVAR_$_NSObject.isa $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">4</span></span>$_OBJC_METACLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">5</span></span>$_OBJC_CLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">5</span></span>$_OBJC_IVAR_$_NSObject.isa $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">5</span></span>$_OBJC_METACLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">6</span></span>$_OBJC_CLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">6</span></span>$_OBJC_IVAR_$_NSObject.isa $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">6</span></span>$_OBJC_METACLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">7</span></span>$_OBJC_CLASS_$_NSObject $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">7</span></span>$_OBJC_IVAR_$_NSObject.isa $ld$hide$os10.<span class="hljs-number"><span class="hljs-number">7</span></span>$_OBJC_METACLASS_$_NSObject</code> </pre> <br><p>           ,   ,   ,          ,   <em></em>   . </p><br><h2 id="rezolvery-simvolov">   </h2><br><p>      dyld ‚Äì   <em> </em> [symbol resolvers],     .    ,  ,          ,  dyld     ,     . </p><br><p>         ld,     .          <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a> <code>.symbol_resolver</code> : </p><br><pre> <code class="hljs mel">;    foo _foo1: movl <span class="hljs-number"><span class="hljs-number">1</span></span>, %eax ret _foo2: movl <span class="hljs-number"><span class="hljs-number">2</span></span>, %eax ret .symbol_resolver _foo ;  -  call _condition jz .ret_foo2 movq _foo1, %rax ret .ret_foo2: movq _foo2, %rax ret ;   ,   _foo  ;   ,     , ;     . .<span class="hljs-keyword"><span class="hljs-keyword">global</span></span> _foo _foo:</code> </pre> <br><p>    C          ,    ,     C: </p><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo1</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo2</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//         return 0; } static void *foo_resolver() { __asm__(".symbol_resolver _foo"); return condition() ? &amp;foo1 : &amp;foo2; }</span></span></code> </pre> <br><p> (     <code>_foo</code>   <code>foo</code> ,    Darwin        C,          .  ,      Mach-O    Darling,            ELF-,     .) </p><br><p>   <code>_foo</code>     ,          (           ),  <code>foo()</code>  <code>foo_resolver()</code>     ,  : </p><br><pre> <code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ __asm__(<span class="hljs-string"><span class="hljs-string">".symbol_resolver _foo"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> condition() ? &amp;foo1 : &amp;foo2; }</code> </pre> <br><p>   ,    ‚Äì     - ,   <code>foo()</code>   ,      (      <code>int</code> -).  ,  ,       :  <code>dlsym("_foo")</code>    <code>_foo</code> ‚Äì  ,      ,       , ‚Äì         . ,       ,    ,      <code>foo()</code>    <code>_foo</code> . </p><br><p>         .  Apple    <code>libplatform</code>                     : </p><br><pre> <code class="hljs tex">#define _OS_VARIANT_RESOLVER(s, v, ...) <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>__attribute__((visibility(OS_STRINGIFY(v)))) extern void* s(void); <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>void* s(void) { <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>__asm__(".symbol_resolver _" OS_STRINGIFY(s)); <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>__VA_ARGS__ <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>} #define _OS_VARIANT_UPMP_RESOLVER(s, v) <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>_OS_VARIANT_RESOLVER(s, v, <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>uint32_t *_c = (void*)(uintptr_t)_COMM_PAGE_CPU_CAPABILITIES; <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>if (*_c &amp; kUP) { <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>extern void OS_VARIANT(s, up)(void); <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>return &amp;OS_VARIANT(s, up); <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>} else { <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>extern void OS_VARIANT(s, mp)(void); <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>return &amp;OS_VARIANT(s, mp); <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>})</code> </pre> <br><p>    ,  ‚Äì    ‚Äì     (   <code>kUP</code>    ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">commpage</a> ), , ,       [spinlock].            ,                . </p><br><p>  Darling          :    Mach-O-   ELF-  Linux,    [host,    ,      Darling] ‚Äì ,   <code>libX11</code>  <code>libcairo</code> . </p><br><p>     ELF- ‚Äì  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>libelfloader</code></a> ,     ELF,        ,   ld-linux,  dyld  Linux,    ld-linux      ELF-.    <code>libelfloader</code>  Mach-O     <code>/usr/lib/darling/libelfloader.dylib</code>   Darwin-chroot-;  ,       Darwin-. </p><br><p>     ,  <code>libelfloader</code>  <em></em>     Mach-O  ELF.    ( <code>_elfcalls</code> ),  <a href=""> </a> <code>libSystem</code> ,  Darwin      ,        ELF-  Linux. ¬´¬ª Darwin  Linux         ‚Äì   ,      C ( <code>libSystem_c</code>  <code>glibc</code> , ). </p><br><p>     ELF-   Darwin,   - <code>libelfloader</code> API  <code>_elfcalls-&gt;dlsym_fatal(_elfcalls-&gt;dlopen_fatal("libX11.so"), "XOpenDisplay")</code> . ,       <a href="">wrapgen</a> ,   ELF-    ,       ,   The Cocotron ‚Äì          Linux ‚Äì   .   wrapgen  ELF- (, <code>libX11.so</code> ),           : </p><br><pre> <code class="hljs delphi">#include &lt;elfcalls.h&gt; extern struct elf_calls* _elfcalls; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> void* lib_handle; __attribute__((<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constructor</span></span></span><span class="hljs-function">)) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">static</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initializer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-comment">{ lib_handle = _elfcalls-&gt;dlopen_fatal("libX11.so"); }</span></span></span><span class="hljs-function"> __</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">attribute__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">((</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">destructor</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">static</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">destructor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-comment">{ _elfcalls-&gt;dlclose_fatal(lib_handle); }</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function">* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">XOpenDisplay</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-comment">{ __asm__(".symbol_resolver _XOpenDisplay"); return _elfcalls-&gt;dlsym_fatal(lib_handle, "XOpenDisplay"); }</span></span></span></span></code> </pre> <br><p>       Mach-O-     <code>/usr/lib/native/libX11.dylib</code> ,   Mach-O-     ,     <em></em> <code>libX11.so</code> ,    Mach-O.  ,    CMake-   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>wrap_elf</code></a> ,    wrapgen,  Mach-O-     <code>/usr/lib/native</code> :   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a> <code>wrap_elf(X11 libX11.so)</code>      <code>libX11</code> ,         Mach-O-. </p><br><p>       Linux        <em></em> .    ,   Darling   ,      Darwin    Linux,     .  Darling ‚Äì     Darwin ( ,  Darwin); , , ,           Darwin,   <code>libSystem</code> , dyld, XNU  launchd,        ,     ,   commpage.       ,   <code>libsystem_kernel</code> ,    ,         Linux,   ¬´¬ª   Darwin- ‚Äì Linux  GNU/Linux   .          Linux-    ,   Linux   (  X server)      ,     [witnessing a magic trick] ‚Äì     <code>libelfloader</code> ,    wrapgen, ,  .   ,    ,   , ,  ,   . </p><br><h2 id="poryadok-simvolov">   </h2><br><p>   -   ,      Mach-O-,    ld      . ( ,     ‚Äì <em></em> ,  Apple,  ,  .) </p><br><p>   ,   ,     ,      ,  <em> </em> [order file],     ld   : </p><br><pre> <code class="bash hljs">$ ld -o libfoo.dylib foo.o -order_file foo.order</code> </pre> <br><p>     <code>-reexported_symbols_list</code> ,     , <code>-order_file</code>  ,    : </p><br><pre> <code class="hljs 1c">symbol1 symbol2 <span class="hljs-meta"><span class="hljs-meta">#  . # #    ,     , # </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta">   (   C)  #        . foo.o: _static_function3 #  ,   ,     #     ;    # </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta">       #  lipo,   </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta">  # . i386:symbol4</span></span></code> </pre> <br><p>   ( ,    ,  )         ¬´¬ª        .         ,       ,    ,        ,       <code>.subsections_via_symbols</code> ,    Mach-O-   ,     , ,   ,   . </p><br><p>   ,   Apple    ‚Äì     <code>libdispatch</code> . <code>libdispatch</code>     , ¬´OS object¬ª,     ,       .          Objective-C,  <code>libdispatch</code>   <em> </em> (    Core Foundation),     <code>libdispatch</code> -  Objective-C-    ,     Objective-C-.  ,      <code>dispatch_data_t</code>  <code>NSData *</code>      API  Cocoa (    ). </p><br><p>   <a href=""></a>     ,    ,   Objective-C-   <em>OS object vtables</em>     .   ,    <a href=""><code>DISPATCH_OBJECT_TFB</code></a> , ,   Objective-C     <code>libdispatch</code> -,    <code>isa</code>  <code>vtable</code> - <code>dispatch_object</code>  <code>object</code> : </p><br><pre> <code class="hljs tex">#define DISPATCH_OBJECT_TFB(f, o, ...) <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>if (slowpath((uintptr_t)((o)._os_obj-&gt;os_obj_isa) &amp; 1) || <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>slowpath((Class)((o)._os_obj-&gt;os_obj_isa) &lt; <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>(Class)OS_OBJECT_VTABLE(dispatch_object)) || <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>slowpath((Class)((o)._os_obj-&gt;os_obj_isa) &gt;= <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>(Class)OS_OBJECT_VTABLE(object))) { <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>return f((o), ##__VA_ARGS__); <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>}</code> </pre> <br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">  </a> ,   ,     <code>libdispatch</code> . </p><br><h2 id="podmena-simvolov">   </h2><br><p>       (   ) ‚Äì    <code>DYLD_INSERT_LIBRARIES</code> ,  dyld     Mach-O-          . ,         ,    ,          <code>DYLD_FORCE_FLAT_NAMESPACE</code> . </p><br><p>  ,      ,    <em></em> -  .     (   ),     <code>dlsym()</code>   <code>RTLD_NEXT</code> ,  : </p><br><pre> <code class="hljs lua">int <span class="hljs-built_in"><span class="hljs-built_in">open</span></span>(const <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>* <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>, int flags, mode_t mode) { printf(<span class="hljs-string"><span class="hljs-string">" open(%s)\n"</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>); // <span class="hljs-string"><span class="hljs-string">"  "</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strcmp(<span class="hljs-built_in"><span class="hljs-built_in">path</span></span>, <span class="hljs-string"><span class="hljs-string">"foo"</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">path</span></span> = <span class="hljs-string"><span class="hljs-string">"bar"</span></span>; } int (*original_open)(const <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> *, int, mode_t); original_open = dlsym(RTLD_NEXT, <span class="hljs-string"><span class="hljs-string">"open"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> original_open(<span class="hljs-built_in"><span class="hljs-built_in">path</span></span>, flags, mode); }</code> </pre> <br><p>    , dyld     ,  <em>dyld-</em> [dyld iterposing].      Mach-O-   <code>__interpose</code> , dyld      ,    ‚Äì    . </p><br><p>   ,       ‚Äì ,        <code>__interpose</code> ‚Äì    <em> </em> [implicit interposing].   ,  <code>__interpose</code>       (     ),  dyld      .  , dyld- <em></em>       ,      - .  , dyld  ,      -    ,     - (   Mach-O-): </p><br><pre> <code class="hljs pgsql">static <span class="hljs-type"><span class="hljs-type">int</span></span> my_open(const <span class="hljs-type"><span class="hljs-type">char</span></span>* <span class="hljs-type"><span class="hljs-type">path</span></span>, <span class="hljs-type"><span class="hljs-type">int</span></span> flags, mode_t mode) { printf("Called open(%s)\n", <span class="hljs-type"><span class="hljs-type">path</span></span>); // "  " <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strcmp(<span class="hljs-type"><span class="hljs-type">path</span></span>, "foo") == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-type"><span class="hljs-type">path</span></span> = "bar"; } //    ,    //  <span class="hljs-keyword"><span class="hljs-keyword">open</span></span>()      my_open(). <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">open</span></span>(<span class="hljs-type"><span class="hljs-type">path</span></span>, flags, mode); } //      __interpose __attribute__ ((section ("__DATA,__interpose"))) static struct { <span class="hljs-type"><span class="hljs-type">void</span></span> *replacement, *replacee; } replace_pair = { my_open, <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> };</code> </pre> <br><p>  ,      ‚Äì          ‚Äì       Mach-O-  -        [relocation table].        ,   dyld      (    ),     . </p><br><p> ,      <code>dyld_dynamic_interpose</code> ,       : </p><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *replacement, *replacee; } replacement_tuple; <span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mach_header</span></span></span><span class="hljs-class"> __</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dso_handle</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dyld_dynamic_interpose</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> struct mach_header*, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> replacement_tuple replacements[], </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> count)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">interpose</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ replacement_tuple replace_pair = { my_open, open }; dyld_dynamic_interpose(&amp;__dso_handle, &amp;replace_pair, <span class="hljs-number"><span class="hljs-number">1</span></span>); }</code> </pre> <br><p> ,     ,         ,     . </p><br><p> <code>DYLD_INSERT_LIBRARIES</code>  dyld-         Objective-C,   C,  - ,       Objective-C- ( <code>IMP</code> ),    Objective-C       ,   <em>method swizzling</em> ( <em>isa swizzling</em> ). </p><br><p>      Darling     xtrace,       . </p><br><p>   Darwin    Darwin (    ‚Äì   BSD    Mach- [Mach traps]).        <code>libsystem_kernel</code> ,   ABI     userspace.  Darling,    <code>libsystem_kernel</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>    Darwin     Linux    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Darling-Mach</a> ,    Linux,  Mach   . </p><br><p> strace,       Linux,    ,  Linux-;  strace    Darwin,   Darling,     Linux,       Darwin (    Linux,    ELF- ).   ,    Darwin  Linux      ,   ,    Darwin   ‚Äì  ,       ‚Äì   . </p><br><p>        , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">xtrace</a> .    strace,           ,   <code>ptrace()</code> API, xtrace          .    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a> <code>DYLD_INSERT_LIBRARIES=/usr/lib/darling/libxtrace.dylib</code> ,   - [trampoline functions]       ,        .  xtrace   ,  strace,       ,       ,   : </p><br><pre> <code class="bash hljs">Darling [~]$ xtrace arch &lt;......&gt; [223] mach_timebase_info_trap (...) [223] mach_timebase_info_trap () -&gt; KERN_SUCCESS [223] issetugid (...) [223] issetugid () -&gt; 0 [223] host_self_trap () [223] host_self_trap () -&gt; port right 2563 [223] mach_msg_trap (...) [223] mach_msg_trap () -&gt; KERN_SUCCESS [223] _kernelrpc_mach_port_deallocate_trap (task=2563, name=-6) [223] _kernelrpc_mach_port_deallocate_trap () -&gt; KERN_SUCCESS [223] ioctl (...) [223] ioctl () -&gt; 0 [223] fstat64 (...) [223] fstat64 () -&gt; 0 [223] ioctl (...) [223] ioctl () -&gt; 0 [223] write_nocancel (...) i386 [223] write_nocancel () -&gt; 5 [223] <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span> (...)</code> </pre> <br><p>    ,       BSD  Mach.   ,   <code>write()</code>  <code>exit()</code> ,     Linux-,       . ,  Mach-   <code>ioctl</code> -   <code>/dev/mach</code> ,     ;   BSD- <code>ioctl()</code> ,   stdio   ,      stdin  stdout (    tty) <a href=""></a>     <code>readlink()</code>    <code>/proc/self/fd/</code> . </p><br><hr><br><p>          Mach-O,        ,     dyld.      : </p><br><ul><li>    ,       ,     dylib,  ,  <em> </em>  . ld       <code>-bundle_loader</code> . </li><li>   ,  <code>LC_LOAD_DYLIB</code> , <code>LC_REEXPORT_DYLIB</code>  <code>LC_DYLIB_ID</code>    ,   <em></em>  <em></em>  [compatibility version, current version] ,    ‚Äì    ,    .              ld <code>-current_version</code>  <code>-compatibility_version</code> , .     dyld ,       ,    ,     . </li><li>      ,  Mach-O     <em>  </em> [source version].     , <code>LC_SOURCE_VERSION</code> .        ld <code>-source_version</code> ,    ,       Mach-O- ‚Äì    <code>-add_source_version</code>  <code>-no_source_version</code> . </li><li>    <code>Info.plist</code>   <code>__info_plist</code> Mach-O-    [codesign] ,           <code>Info.plist</code> .    <a href="">ad-hoc </a>  Security.framework,  ,      <code>CFBundle</code> / <code>NSBundle</code> API,       ,     ,  . </li></ul><br><p> ,  ,       , ld  dyld    ,    ¬´ ¬ª,   <code>libSystem</code> ,  -.            <code>/usr/lib/</code> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr417507/">https://habr.com/ru/post/fr417507/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr417495/index.html">Les √©quipes russes et ukrainiennes ont domin√© les Europ√©ens lors de la finale europ√©enne du concours InnovateFPGA d'Intel</a></li>
<li><a href="../fr417497/index.html">4 ans de Data Science au Schibsted Media Group</a></li>
<li><a href="../fr417501/index.html">Lifehacks fabrique des panneaux √† deux couches (LUT)</a></li>
<li><a href="../fr417503/index.html">Ce qu'un d√©veloppeur Web doit se rappeler de faire SEO-Feng Shui</a></li>
<li><a href="../fr417505/index.html">Intel publie des correctifs pour les nouvelles vuln√©rabilit√©s du micrologiciel ME</a></li>
<li><a href="../fr417509/index.html">Trucs et astuces Kubernetes: acc√©l√©rer le bootstrap de grandes bases de donn√©es</a></li>
<li><a href="../fr417511/index.html">Intel acquiert eASIC - D√©veloppeur structurel ASIC</a></li>
<li><a href="../fr417513/index.html">Analogues en Python et JavaScript. Deuxi√®me partie</a></li>
<li><a href="../fr417515/index.html">Ce que j'ai appris en cr√©ant 100 jeux en 5 ans</a></li>
<li><a href="../fr417517/index.html">Pages de l'histoire d'Intel. Chronique photo et quiz</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>