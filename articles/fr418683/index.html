<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🥦 👨🏾‍🤝‍👨🏼 💣 Création d'une machine d'arcade d'émulation. 2e partie 📓 🙏🏼 🦁</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="La première partie est ici . 

 Démonteur du processeur 8080 
 Connaissance 
 Nous aurons besoin d'informations sur les opcodes et leurs commandes res...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Création d'une machine d'arcade d'émulation. 2e partie</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/418683/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f48/668/8f8/f486688f8d67a372f8911558cc312204.jpg" alt="image"></div><br>  La première partie est <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . <br><br><h1>  Démonteur du processeur 8080 </h1><br><h2>  Connaissance </h2><br>  Nous aurons besoin d'informations sur les opcodes et leurs commandes respectives.  Lorsque vous recherchez des informations sur Internet, vous remarquerez qu'il y a beaucoup d'informations mitigées sur le 8080 et le Z80.  Le Z80 était un adepte du 8080 - il exécute toutes les instructions du 8080 avec les mêmes codes hexadécimaux, mais a également des instructions supplémentaires.  Je pense, alors que vous devez éviter les informations sur le Z80, afin de ne pas vous tromper.  J'ai créé une table d'opcode pour notre travail, elle est <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . <br><br>  Chaque processeur possède un guide de référence écrit par le fabricant.  Habituellement, cela s'appelle quelque chose comme "Manuel de l'environnement du programmeur".  Le manuel 8080 est appelé le Manuel de l'utilisateur des systèmes de micro-ordinateurs Intel 8080.  Il a toujours été appelé «livre de données», je l'appellerai donc également ainsi.  J'ai pu télécharger la référence 8080 sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">http://www.datasheetarchive.com/</a> .  Ce PDF est une numérisation de faible qualité, donc si vous trouvez une meilleure version, utilisez-la. <br><a name="habracut"></a><br>  Commençons et jetons un œil à la ROM Space Invaders.  (Le fichier ROM peut être trouvé sur Internet.) Je travaille sur Mac OS X, donc j'utilise simplement la commande hexdump pour afficher son contenu.  Pour continuer à travailler, trouvez l'éditeur hexadécimal pour votre plateforme.  Voici les 128 premiers octets du fichier invaders.h: <br><br><pre><code class="hljs dos">$ hexdump -v invaders.h <span class="hljs-number"><span class="hljs-number">0000000</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> c3 d4 <span class="hljs-number"><span class="hljs-number">18</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> f5 c5 d5 e5 c3 <span class="hljs-number"><span class="hljs-number">8</span></span>c <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">0000010</span></span> f5 c5 d5 e5 <span class="hljs-number"><span class="hljs-number">3</span></span>e <span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-number"><span class="hljs-number">32</span></span> <span class="hljs-number"><span class="hljs-number">72</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span> c0 <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">35</span></span> <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span> <span class="hljs-number"><span class="hljs-number">0000020</span></span> db <span class="hljs-number"><span class="hljs-number">01</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>f da <span class="hljs-number"><span class="hljs-number">67</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>a ea <span class="hljs-number"><span class="hljs-number">20</span></span> a7 ca <span class="hljs-number"><span class="hljs-number">42</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>a eb <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">0000030</span></span> fe <span class="hljs-number"><span class="hljs-number">99</span></span> ca <span class="hljs-number"><span class="hljs-number">3</span></span>e <span class="hljs-number"><span class="hljs-number">00</span></span> c6 <span class="hljs-number"><span class="hljs-number">01</span></span> <span class="hljs-number"><span class="hljs-number">27</span></span> <span class="hljs-number"><span class="hljs-number">32</span></span> eb <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> <span class="hljs-number"><span class="hljs-number">47</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span> af <span class="hljs-number"><span class="hljs-number">32</span></span> <span class="hljs-number"><span class="hljs-number">0000040</span></span> ea <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>a e9 <span class="hljs-number"><span class="hljs-number">20</span></span> a7 ca <span class="hljs-number"><span class="hljs-number">82</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>a ef <span class="hljs-number"><span class="hljs-number">20</span></span> a7 c2 <span class="hljs-number"><span class="hljs-number">6</span></span>f <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">0000050</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>a eb <span class="hljs-number"><span class="hljs-number">20</span></span> a7 c2 <span class="hljs-number"><span class="hljs-number">5</span></span>d <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> bf <span class="hljs-number"><span class="hljs-number">0</span></span>a c3 <span class="hljs-number"><span class="hljs-number">82</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>a <span class="hljs-number"><span class="hljs-number">93</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">0000060</span></span> a7 c2 <span class="hljs-number"><span class="hljs-number">82</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> c3 <span class="hljs-number"><span class="hljs-number">65</span></span> <span class="hljs-number"><span class="hljs-number">07</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>e <span class="hljs-number"><span class="hljs-number">01</span></span> <span class="hljs-number"><span class="hljs-number">32</span></span> ea <span class="hljs-number"><span class="hljs-number">20</span></span> c3 <span class="hljs-number"><span class="hljs-number">3</span></span>f <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> <span class="hljs-number"><span class="hljs-number">0000070</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>a <span class="hljs-number"><span class="hljs-number">32</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">32</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">01</span></span> <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> <span class="hljs-number"><span class="hljs-number">48</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span> <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> <span class="hljs-number"><span class="hljs-number">13</span></span> ...</code> </pre> <br>  C'est le début du programme Space Invaders.  Chaque nombre hexadécimal est une commande ou des données pour le programme.  Nous pouvons utiliser une référence ou d'autres informations de référence pour comprendre ce que signifient ces codes hexadécimaux.  Explorons un peu plus le code image ROM. <br><br>  Le premier octet de ce programme est 00 $.  En regardant le tableau, nous voyons qu'il s'agit de NOP, ainsi que des deux commandes suivantes.  (Mais ne vous découragez pas, Space Invaders a probablement utilisé ces commandes comme un délai pour laisser le système se calmer un peu après la mise sous tension.) <br><br>  La quatrième commande est $ C3, c'est-à-dire, à en juger par la table, c'est JMP.  La définition d'une commande JMP indique qu'elle reçoit une adresse à deux octets, c'est-à-dire que les deux octets suivants sont l'adresse de saut JMP.  Ensuite, deux NOP supplémentaires viennent ... alors, vous savez quoi?  Permettez-moi de signer moi-même les premières instructions ... <br><br><pre> <code class="hljs pgsql"> <span class="hljs-number"><span class="hljs-number">0000</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> NOP <span class="hljs-number"><span class="hljs-number">0001</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> NOP <span class="hljs-number"><span class="hljs-number">0002</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> NOP <span class="hljs-number"><span class="hljs-number">0003</span></span> c3 d4 <span class="hljs-number"><span class="hljs-number">18</span></span> JMP <span class="hljs-meta"><span class="hljs-meta">$18</span></span>d4 <span class="hljs-number"><span class="hljs-number">0006</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> NOP <span class="hljs-number"><span class="hljs-number">0007</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> NOP <span class="hljs-number"><span class="hljs-number">0008</span></span> f5 PUSH PSW <span class="hljs-number"><span class="hljs-number">0009</span></span> c5 PUSH B <span class="hljs-number"><span class="hljs-number">000</span></span>a d5 PUSH D <span class="hljs-number"><span class="hljs-number">000</span></span>b e5 PUSH H <span class="hljs-number"><span class="hljs-number">000</span></span>c c3 <span class="hljs-number"><span class="hljs-number">8</span></span>c <span class="hljs-number"><span class="hljs-number">00</span></span> JMP <span class="hljs-meta"><span class="hljs-meta">$008</span></span>c <span class="hljs-number"><span class="hljs-number">000</span></span>f <span class="hljs-number"><span class="hljs-number">00</span></span> NOP <span class="hljs-number"><span class="hljs-number">0010</span></span> f5 PUSH PSW <span class="hljs-number"><span class="hljs-number">0011</span></span> c5 PUSH B <span class="hljs-number"><span class="hljs-number">0012</span></span> d5 PUSH D <span class="hljs-number"><span class="hljs-number">0013</span></span> e5 PUSH H <span class="hljs-number"><span class="hljs-number">0014</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>e <span class="hljs-number"><span class="hljs-number">80</span></span> MVI A,#<span class="hljs-number"><span class="hljs-number">0x80</span></span> <span class="hljs-number"><span class="hljs-number">0016</span></span> <span class="hljs-number"><span class="hljs-number">32</span></span> <span class="hljs-number"><span class="hljs-number">72</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> STA <span class="hljs-meta"><span class="hljs-meta">$2072</span></span></code> </pre> <br>  Il semble qu'il y ait un moyen d'automatiser ce processus ... <br><br><h2>  Démonteur, partie 1 </h2><br>  Un désassembleur est un programme qui traduit simplement un flux de nombres hexadécimaux en code source en langage assembleur.  C'est exactement la tâche que nous avons effectuée à la main dans la section précédente - une excellente occasion d'automatiser ce travail.  En écrivant ce morceau de code, nous nous familiarisons avec le processeur et obtenons un morceau de code de débogage pratique, qui est utile lors de l'écriture d'un émulateur de CPU. <br><br>  Voici l'algorithme de démontage du code 8080: <br><br><ol><li>  Lire le code dans le tampon </li><li>  Nous obtenons un pointeur vers le début du tampon </li><li>  Utilisez l'octet du pointeur pour déterminer l'opcode. </li><li>  Afficher le nom de l'opcode, si nécessaire en utilisant des octets après l'opcode comme données </li><li>  Déplacez le pointeur sur le nombre d'octets utilisés par cette commande (1, 2 ou 3 octets) </li><li>  Si le tampon ne se termine pas, passez à l'étape 3 </li></ol><br>  Pour jeter les bases de la procédure, j'ai ajouté quelques instructions ci-dessous.  Je vais exposer la procédure complète de téléchargement, mais je vous recommande d'essayer de l'écrire vous-même.  Cela ne prendra pas beaucoup de temps, et en parallèle, vous apprendrez le jeu d'instructions du processeur 8080. <br><br><pre> <code class="cpp hljs"> <span class="hljs-comment"><span class="hljs-comment">/* *codebuffer -       8080 pc -          */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Disassemble8080Op</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *codebuffer, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pc)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *code = &amp;codebuffer[pc]; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> opbytes = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span> (<span class="hljs-string"><span class="hljs-string">"%04x "</span></span>, pc); <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (*code) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0x00</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"NOP"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0x01</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"LXI B,#$%02x%02x"</span></span>, code[<span class="hljs-number"><span class="hljs-number">2</span></span>], code[<span class="hljs-number"><span class="hljs-number">1</span></span>]); opbytes=<span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0x02</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"STAX B"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0x03</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"INX B"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0x04</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"INR B"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0x05</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"DCR B"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0x06</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"MVI B,#$%02x"</span></span>, code[<span class="hljs-number"><span class="hljs-number">1</span></span>]); opbytes=<span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0x07</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"RLC"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0x08</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"NOP"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* ........ */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0x3e</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"MVI A,#0x%02x"</span></span>, code[<span class="hljs-number"><span class="hljs-number">1</span></span>]); opbytes = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* ........ */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0xc3</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"JMP $%02x%02x"</span></span>,code[<span class="hljs-number"><span class="hljs-number">2</span></span>],code[<span class="hljs-number"><span class="hljs-number">1</span></span>]); opbytes = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* ........ */</span></span> } <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"\n"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> opbytes; }</code> </pre><br>  En écrivant cette procédure et en étudiant chaque opcode, j'ai beaucoup appris sur le processeur 8080. <br><br><ol><li>  J'ai réalisé que la plupart des équipes prenaient un octet, les deux ou trois restants.  Le code ci-dessus suppose que la commande a une taille d'un octet, mais les instructions à deux et trois octets modifient la valeur de la variable «opbytes» pour renvoyer la taille correcte de la commande. </li><li>  Le 8080 a des registres avec les noms A, B, C, D, E, H et L. Il y a aussi un compteur de programme (compteur de programme, PC) et un pointeur de pile séparé (pointeur de pile, SP). </li><li>  Certaines instructions fonctionnent avec des registres par paires: B et C sont une paire, ainsi que DE et HL. </li><li>  A est un registre spécial, de nombreuses instructions fonctionnent avec. </li><li>  HL est également un registre spécial, il est utilisé comme adresse pour chaque lecture et écriture de données en mémoire. </li><li>  Je suis devenu curieux au sujet de l'équipe «RST», alors j'ai lu un peu le guide.  J'ai remarqué qu'il exécute le code à des endroits fixes et la référence mentionne la gestion des interruptions.  Après lecture, il s'est avéré que tout ce code au début de la ROM était des routines de service d'interruption (ISR).  Les interruptions peuvent être générées par programme à l'aide de la commande RST ou générées par des sources tierces (pas le processeur 8080). </li></ol><br>  Pour transformer tout cela en programme de travail, je viens de préparer une procédure qui effectue les étapes suivantes: <br><br><ol><li>  Il ouvre un fichier rempli de code compilé 8080 </li><li>  Le lit dans la mémoire tampon </li><li>  Passe à travers la mémoire tampon, provoquant le démontage8080Op </li><li>  Augmente le PC renvoyé par Disassemble8080Op </li><li>  Quitte à la fin du tampon </li></ol><br>  Cela pourrait ressembler à ceci: <br><br><pre> <code class="cpp hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> argc, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">**argv)</span></span></span><span class="hljs-function"> </span></span>{ FILE *f= fopen(argv[<span class="hljs-number"><span class="hljs-number">1</span></span>], <span class="hljs-string"><span class="hljs-string">"rb"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (f==<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"error: Couldn't open %s\n"</span></span>, argv[<span class="hljs-number"><span class="hljs-number">1</span></span>]); <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>); } <span class="hljs-comment"><span class="hljs-comment">//         fseek(f, 0L, SEEK_END); int fsize = ftell(f); fseek(f, 0L, SEEK_SET); unsigned char *buffer=malloc(fsize); fread(buffer, fsize, 1, f); fclose(f); int pc = 0; while (pc &lt; fsize) { pc += Disassemble8080Op(buffer, pc); } return 0; }</span></span></code> </pre> <br>  Dans la deuxième partie, nous examinerons la sortie obtenue en démontant les ROM Space Invaders. <br><br><h2>  Allocation de mémoire </h2><br>  Avant de commencer à écrire un émulateur de processeur, nous devons étudier un autre aspect.  Tous les CPU ont la capacité de communiquer avec un certain nombre d'adresses.  Les processeurs plus anciens avaient des adresses 16, 24 ou 32 bits.  Le 8080 a 16 contacts d'adresse, donc les adresses sont comprises entre 0 et $ FFFF. <br><br>  Pour comprendre l'allocation de mémoire du jeu, nous devons mener une petite enquête.  Après avoir collecté les informations <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> , j'ai découvert que la ROM se trouve à l'adresse 0 et que le jeu a 8 Ko de RAM à partir de 2000 $. <br><br>  L'auteur d'une des pages a découvert que le tampon vidéo commence en RAM avec une adresse de 2400 $ et nous a également expliqué comment les ports d'entrée-sortie 8080 sont utilisés pour communiquer avec les commandes et l'équipement audio.  Super! <br><br>  Le fichier ROM invaders.zip, qui se trouve sur Internet, contient quatre fichiers: invaders.e, .f, .g et .h.  Après avoir googlé, je suis tombé sur un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article</a> informatif qui explique comment mettre ces fichiers en mémoire: <br><br> <code>Space Invaders, (C) Taito 1978, Midway 1979 <br> <br> : Intel 8080, 2  (     Zilog Z80) <br> <br> : $cf (RST 8)   vblank, $d7 (RST $10)   vblank. <br> <br> : 256(x)*224(y), 60 ,  .   <br>      . <br>   :   7168 , 1    (32    ). <br> <br> : SN76477  . <br> <br>  : <br> ROM <br> $0000-$07ff: invaders.h <br> $0800-$0fff: invaders.g <br> $1000-$17ff: invaders.f <br> $1800-$1fff: invaders.e <br> <br> RAM <br> $2000-$23ff:   <br> $2400-$3fff:  <br> <br> $4000-:  </code> <br> <br>  Il existe encore quelques informations utiles, mais nous ne sommes pas encore prêts à les utiliser. <br><br><h2>  Détails sanglants </h2><br>  Si vous voulez connaître la taille de l'espace d'adressage du processeur, vous pouvez le comprendre en examinant ses caractéristiques.  La spécification 8080 nous indique que le processeur possède 16 contacts d'adresse, c'est-à-dire qu'il utilise un adressage 16 bits.  (Au lieu de spécifications, il suffit de lire le manuel, Wikipedia, google, etc.) <br><br>  Sur Internet, il y a beaucoup d'informations sur le matériel de Space Invaders.  Si vous n'avez pas pu trouver ces informations, vous pouvez les obtenir de plusieurs manières: <br><br><ul><li>  Regardez le code s'exécuter dans l'émulateur et voyez ce qu'il fait.  Prenez des notes et regardez attentivement.  Il doit être assez simple pour comprendre, par exemple, où, de l'avis du jeu, la RAM doit être située.  Il est également facile de déterminer l'endroit où elle recherche une mémoire vidéo (nous allons passer un peu de temps à l'étudier). </li><li>  Trouvez le schéma de circuit de la machine d'arcade et suivez les signaux des contacts d'adresse de la CPU.  Voyez où ils vont.  Par exemple, A15 (adresse la plus ancienne) ne peut accéder qu'à la ROM.  De cela, nous pouvons conclure que les adresses de la ROM commencent à 8000 $. </li></ul><br>  Il peut être très intéressant et instructif de le découvrir vous-même en observant l'exécution du code.  Quelqu'un a dû faire face à tout cela pour la première fois. <br><br><h1>  Développement en ligne de commande </h1><br>  Le but de ce didacticiel n'est pas de vous apprendre à écrire du code pour une plate-forme spécifique, bien que nous ne puissions pas éviter le code spécifique à la plate-forme.  J'espère qu'avant le début du projet, vous saviez déjà comment compiler pour votre plateforme cible. <br><br>  Lorsque vous travaillez avec du code autonome, qui lit simplement des fichiers et affiche du texte dans la console, il n'est pas nécessaire d'utiliser un système de développement trop compliqué.  En fait, cela ne fait que compliquer les choses.  Tout ce dont vous avez besoin est un éditeur de texte et un terminal. <br><br>  Je pense que quiconque veut programmer à un niveau bas devrait savoir comment créer des programmes simples à partir de la ligne de commande.  Vous pouvez considérer que je vous taquine, mais vos compétences de pirate d'élite ne valent pas grand-chose si vous ne pouvez pas fonctionner en dehors de Visual Studio. <br><br>  Sur Mac, vous pouvez utiliser TextEdit et Terminal pour compiler.  Sous Linux, vous pouvez utiliser gedit et Konsole.  Sous Windows, vous pouvez installer cygwin et les outils, puis utiliser N ++ ou un autre éditeur de texte.  Si vous voulez être vraiment cool, alors toutes ces plates-formes prennent en charge vi et emacs pour l'édition de texte. <br><br>  La compilation de programmes à partir d'un seul fichier à l'aide de la ligne de commande est une tâche triviale.  Supposons que vous ayez enregistré votre programme dans un fichier appelé <code>8080dis.c</code> .  Accédez au dossier contenant ce fichier texte et compilez-le comme <code>cc 8080dis.c</code> : <code>cc 8080dis.c</code> .  Si vous ne spécifiez pas le nom du fichier de sortie, il sera appelé <code>a.out</code> et vous pouvez l'exécuter en tapant <code>./a.out</code> . <br><br>  En fait, c'est tout. <br><br><h3>  Utiliser un débogueur </h3><br>  Si vous travaillez sur l'un des systèmes basés sur Unix, voici une brève introduction au débogage de programmes en ligne de commande à l'aide de GDB.  Vous devez compiler le programme comme ceci: <code>cc -g -O0 8080dis.c</code> .  Le paramètre <code>-g</code> génère des informations de débogage (c'est-à-dire que vous pouvez effectuer le débogage en fonction du texte source) et le paramètre <code>-O0</code> désactive les optimisations de sorte que lorsque vous parcourez le programme, le débogueur puisse suivre avec précision le code en pleine conformité avec le texte source. <br><br>  Voici le journal annoté du début d'une session de débogage.  Mes commentaires sont sur des lignes marquées d'un signe dièse (#). <br><br><pre> <code class="hljs vhdl"> $ gdb a.<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> GNU gdb <span class="hljs-number"><span class="hljs-number">6.3</span></span>.<span class="hljs-number"><span class="hljs-number">50</span></span>-<span class="hljs-number"><span class="hljs-number">20050815</span></span> (Apple version gdb-<span class="hljs-number"><span class="hljs-number">1708</span></span>) (Mon Aug <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span>:<span class="hljs-number"><span class="hljs-number">32</span></span>:<span class="hljs-number"><span class="hljs-number">45</span></span> UTC <span class="hljs-number"><span class="hljs-number">2011</span></span>) Copyright <span class="hljs-number"><span class="hljs-number">2004</span></span> Free Software Foundation, Inc. GDB <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> free software, covered by the GNU General Public License, <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> you are welcome <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> change it <span class="hljs-keyword"><span class="hljs-keyword">and</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">or</span></span> distribute copies <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> it under certain conditions. <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> <span class="hljs-string"><span class="hljs-string">"show copying"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> see the conditions. There <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> absolutely no warranty <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> GDB. <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> <span class="hljs-string"><span class="hljs-string">"show warranty"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> details. This GDB was configured as <span class="hljs-string"><span class="hljs-string">"x86_64-apple-darwin"</span></span>...Reading symbols <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">shared</span></span> libraries .. done #  ,       (gdb) b Disassemble8080Op Breakpoint <span class="hljs-number"><span class="hljs-number">1</span></span> at <span class="hljs-number"><span class="hljs-number">0</span></span>x1000012ef: <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> <span class="hljs-number"><span class="hljs-number">8080</span></span>dis.c, <span class="hljs-literal"><span class="hljs-literal">line</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span>. #   <span class="hljs-string"><span class="hljs-string">"invaders.h"</span></span>    (gdb) run invaders.h Starting program: /Users/bob/Desktop/invaders/a.<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> invaders.h Reading symbols <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">shared</span></span> libraries +........................ done Breakpoint <span class="hljs-number"><span class="hljs-number">1</span></span>, Disassemble8080Op (codebuffer=<span class="hljs-number"><span class="hljs-number">0</span></span>x100801000 <span class="hljs-string"><span class="hljs-string">""</span></span>, pc=<span class="hljs-number"><span class="hljs-number">0</span></span>) at <span class="hljs-number"><span class="hljs-number">8080</span></span>dis.c:<span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-built_in"><span class="hljs-built_in">unsigned</span></span> char *code = &amp;codebuffer[pc]; #gdb  n  <span class="hljs-string"><span class="hljs-string">"next"</span></span>.    <span class="hljs-string"><span class="hljs-string">"next"</span></span> (gdb) n <span class="hljs-number"><span class="hljs-number">8</span></span> int opbytes = <span class="hljs-number"><span class="hljs-number">1</span></span>; #p -    <span class="hljs-string"><span class="hljs-string">"print"</span></span>,     *code (gdb) p *code $<span class="hljs-number"><span class="hljs-number">1</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span> '\<span class="hljs-number"><span class="hljs-number">0</span></span>' (gdb) n <span class="hljs-number"><span class="hljs-number">9</span></span> printf(<span class="hljs-string"><span class="hljs-string">"%04x "</span></span>, pc); #    <span class="hljs-string"><span class="hljs-string">""</span></span>, gdb     ,    <span class="hljs-string"><span class="hljs-string">"next"</span></span> (gdb) <span class="hljs-number"><span class="hljs-number">10</span></span> switch (*code) (gdb) n #   ,    <span class="hljs-string"><span class="hljs-string">"NOP"</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>x00: printf(<span class="hljs-string"><span class="hljs-string">"NOP"</span></span>); break; (gdb) n <span class="hljs-number"><span class="hljs-number">285</span></span> printf(<span class="hljs-string"><span class="hljs-string">"\n"</span></span>); #c -  <span class="hljs-string"><span class="hljs-string">"continue"</span></span>,        (gdb) c Continuing. <span class="hljs-number"><span class="hljs-number">0000</span></span> NOP #     Disassemble8080Op.   *opcode, # ,      NOP,    . Breakpoint <span class="hljs-number"><span class="hljs-number">1</span></span>, Disassemble8080Op (codebuffer=<span class="hljs-number"><span class="hljs-number">0</span></span>x100801000 <span class="hljs-string"><span class="hljs-string">""</span></span>, pc=<span class="hljs-number"><span class="hljs-number">1</span></span>) at <span class="hljs-number"><span class="hljs-number">8080</span></span>dis.c:<span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-built_in"><span class="hljs-built_in">unsigned</span></span> char *code = &amp;codebuffer[pc]; (gdb) c Continuing. <span class="hljs-number"><span class="hljs-number">0001</span></span> NOP Breakpoint <span class="hljs-number"><span class="hljs-number">1</span></span>, Disassemble8080Op (codebuffer=<span class="hljs-number"><span class="hljs-number">0</span></span>x100801000 <span class="hljs-string"><span class="hljs-string">""</span></span>, pc=<span class="hljs-number"><span class="hljs-number">2</span></span>) at <span class="hljs-number"><span class="hljs-number">8080</span></span>dis.c:<span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-built_in"><span class="hljs-built_in">unsigned</span></span> char *code = &amp;codebuffer[pc]; (gdb) n <span class="hljs-number"><span class="hljs-number">8</span></span> int opbytes = <span class="hljs-number"><span class="hljs-number">1</span></span>; (gdb) p *code $<span class="hljs-number"><span class="hljs-number">2</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span> '\<span class="hljs-number"><span class="hljs-number">0</span></span>' #  NOP,   (gdb) c Continuing. <span class="hljs-number"><span class="hljs-number">0002</span></span> NOP Breakpoint <span class="hljs-number"><span class="hljs-number">1</span></span>, Disassemble8080Op (codebuffer=<span class="hljs-number"><span class="hljs-number">0</span></span>x100801000 <span class="hljs-string"><span class="hljs-string">""</span></span>, pc=<span class="hljs-number"><span class="hljs-number">3</span></span>) at <span class="hljs-number"><span class="hljs-number">8080</span></span>dis.c:<span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-built_in"><span class="hljs-built_in">unsigned</span></span> char *code = &amp;codebuffer[pc]; (gdb) n <span class="hljs-number"><span class="hljs-number">8</span></span> int opbytes = <span class="hljs-number"><span class="hljs-number">1</span></span>; #   ! (gdb) p *code $<span class="hljs-number"><span class="hljs-number">3</span></span> = <span class="hljs-number"><span class="hljs-number">195</span></span> '?' # print     ,    /x    (gdb) p /x *code $<span class="hljs-number"><span class="hljs-number">4</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>xc3 (gdb) n <span class="hljs-number"><span class="hljs-number">9</span></span> printf(<span class="hljs-string"><span class="hljs-string">"%04x "</span></span>, pc); (gdb) <span class="hljs-number"><span class="hljs-number">10</span></span> switch (*code) (gdb) # C3 -  JMP. . <span class="hljs-number"><span class="hljs-number">219</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>xc3: printf(<span class="hljs-string"><span class="hljs-string">"JMP $%02x%02x"</span></span>,code[<span class="hljs-number"><span class="hljs-number">2</span></span>],code[<span class="hljs-number"><span class="hljs-number">1</span></span>]); opbytes = <span class="hljs-number"><span class="hljs-number">3</span></span>; break; (gdb) <span class="hljs-number"><span class="hljs-number">285</span></span> printf(<span class="hljs-string"><span class="hljs-string">"\n"</span></span>);</code> </pre> <br><h1>  Démonteur, partie 2 </h1><br>  Exécutez le désassembleur du fichier ROM invaders.h et examinez les informations affichées. <br><br><pre> <code class="hljs pgsql"> <span class="hljs-number"><span class="hljs-number">0000</span></span> NOP <span class="hljs-number"><span class="hljs-number">0001</span></span> NOP <span class="hljs-number"><span class="hljs-number">0002</span></span> NOP <span class="hljs-number"><span class="hljs-number">0003</span></span> JMP <span class="hljs-meta"><span class="hljs-meta">$18</span></span>d4 <span class="hljs-number"><span class="hljs-number">0006</span></span> NOP <span class="hljs-number"><span class="hljs-number">0007</span></span> NOP <span class="hljs-number"><span class="hljs-number">0008</span></span> PUSH PSW <span class="hljs-number"><span class="hljs-number">0009</span></span> PUSH B <span class="hljs-number"><span class="hljs-number">000</span></span>a PUSH D <span class="hljs-number"><span class="hljs-number">000</span></span>b PUSH H <span class="hljs-number"><span class="hljs-number">000</span></span>c JMP <span class="hljs-meta"><span class="hljs-meta">$008</span></span>c <span class="hljs-number"><span class="hljs-number">000</span></span>f NOP <span class="hljs-number"><span class="hljs-number">0010</span></span> PUSH PSW <span class="hljs-number"><span class="hljs-number">0011</span></span> PUSH B <span class="hljs-number"><span class="hljs-number">0012</span></span> PUSH D <span class="hljs-number"><span class="hljs-number">0013</span></span> PUSH H <span class="hljs-number"><span class="hljs-number">0014</span></span> MVI A,#<span class="hljs-meta"><span class="hljs-meta">$80</span></span> <span class="hljs-number"><span class="hljs-number">0016</span></span> STA <span class="hljs-meta"><span class="hljs-meta">$2072</span></span> <span class="hljs-number"><span class="hljs-number">0019</span></span> LXI H,#<span class="hljs-meta"><span class="hljs-meta">$20</span></span>c0 <span class="hljs-number"><span class="hljs-number">001</span></span>c DCR M <span class="hljs-number"><span class="hljs-number">001</span></span>d <span class="hljs-keyword"><span class="hljs-keyword">CALL</span></span> <span class="hljs-meta"><span class="hljs-meta">$17</span></span>cd <span class="hljs-number"><span class="hljs-number">0020</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> #<span class="hljs-meta"><span class="hljs-meta">$01</span></span> <span class="hljs-number"><span class="hljs-number">0022</span></span> RRC <span class="hljs-number"><span class="hljs-number">0023</span></span> JC <span class="hljs-meta"><span class="hljs-meta">$0067</span></span> <span class="hljs-number"><span class="hljs-number">0026</span></span> LDA <span class="hljs-meta"><span class="hljs-meta">$20</span></span>ea <span class="hljs-number"><span class="hljs-number">0029</span></span> ANA A <span class="hljs-number"><span class="hljs-number">002</span></span>a JZ <span class="hljs-meta"><span class="hljs-meta">$0042</span></span> <span class="hljs-number"><span class="hljs-number">002</span></span>d LDA <span class="hljs-meta"><span class="hljs-meta">$20</span></span>eb <span class="hljs-number"><span class="hljs-number">0030</span></span> CPI #<span class="hljs-meta"><span class="hljs-meta">$99</span></span> <span class="hljs-number"><span class="hljs-number">0032</span></span> JZ <span class="hljs-meta"><span class="hljs-meta">$003</span></span>e <span class="hljs-number"><span class="hljs-number">0035</span></span> ADI #<span class="hljs-meta"><span class="hljs-meta">$01</span></span> <span class="hljs-number"><span class="hljs-number">0037</span></span> DAA <span class="hljs-number"><span class="hljs-number">0038</span></span> STA <span class="hljs-meta"><span class="hljs-meta">$20</span></span>eb <span class="hljs-number"><span class="hljs-number">003</span></span>b <span class="hljs-keyword"><span class="hljs-keyword">CALL</span></span> <span class="hljs-meta"><span class="hljs-meta">$1947</span></span> <span class="hljs-number"><span class="hljs-number">003</span></span>e SRA A <span class="hljs-number"><span class="hljs-number">003</span></span>f STA <span class="hljs-meta"><span class="hljs-meta">$20</span></span>ea <span class="hljs-comment"><span class="hljs-comment">/* 0000000 00 00 00 c3 d4 18 00 00 f5 c5 d5 e5 c3 8c 00 00 0000010 f5 c5 d5 e5 3e 80 32 72 20 21 c0 20 35 cd cd 17 0000020 db 01 0f da 67 00 3a ea 20 a7 ca 42 00 3a eb 20 0000030 fe 99 ca 3e 00 c6 01 27 32 eb 20 cd 47 19 af 32 */</span></span></code> </pre> <br>  Les premières instructions correspondent à celles que nous avons notées manuellement précédemment.  Après eux, il y a plusieurs nouvelles instructions.  Ci-dessous, j'ai inséré des données hexadécimales pour référence.  Notez que si vous comparez la mémoire avec les commandes, les adresses sont comme si elles étaient stockées en mémoire dans l'ordre inverse.  Il en est ainsi.  C'est ce qu'on appelle le petit endian - les machines avec peu d'endian, comme le 8080, stockent d'abord les octets de nombres les moins significatifs.  (Plus sur l'endian est décrit ci-dessous.) <br><br>  J'ai mentionné ci-dessus que ce code est le code ISR du jeu Space Invaders.  Le code des interruptions 0, 1, 2, ... 7 commence par l'adresse $ 0, $ 8, $ 20, ... $ 38.  Il semble que le 8080 ne donne que 8 octets pour chaque ISR.  Parfois, le programme Space Invaders contourne ce système en se déplaçant simplement vers une autre adresse avec plus d'espace.  (Cela se produit à 000c $). <br><br>  De plus, ISR 2 semble être plus long que la mémoire qui lui est allouée.  Son code passe à 0018 $ (c'est l'endroit pour ISR 3).  Je pense que Space Invaders ne s'attend pas à voir quoi que ce soit qui utilise l'interruption 3. <br><br>  Le fichier ROM Space Invaders sur Internet se compose de quatre parties.  Je vais l'expliquer ci-dessous, mais pour l'instant, pour passer à la section suivante, nous devons fusionner ces quatre fichiers en un seul.  Sous Unix: <br><br><pre> <code class="hljs matlab"> <span class="hljs-built_in"><span class="hljs-built_in">cat</span></span> invaders.h &gt; invaders <span class="hljs-built_in"><span class="hljs-built_in">cat</span></span> invaders.g &gt;&gt; invaders <span class="hljs-built_in"><span class="hljs-built_in">cat</span></span> invaders.f &gt;&gt; invaders <span class="hljs-built_in"><span class="hljs-built_in">cat</span></span> invaders.e &gt;&gt; invaders</code> </pre> <br>  Exécutez maintenant le désassembleur avec le fichier «envahisseurs» résultant.  Lorsqu'un programme démarre à $ 0000, la première chose qu'il fait est de passer à $ 18d4.  Je considérerai cela comme le début du programme.  Jetons un coup d'œil à ce code. <br><br><pre> <code class="hljs pgsql"> <span class="hljs-number"><span class="hljs-number">18</span></span>d4 LXI SP,#<span class="hljs-meta"><span class="hljs-meta">$2400</span></span> <span class="hljs-number"><span class="hljs-number">18</span></span>d7 MVI B,#<span class="hljs-meta"><span class="hljs-meta">$00</span></span> <span class="hljs-number"><span class="hljs-number">18</span></span>d9 <span class="hljs-keyword"><span class="hljs-keyword">CALL</span></span> <span class="hljs-meta"><span class="hljs-meta">$01</span></span>e6</code> </pre> <br>  Ainsi, il effectue deux opérations et appelle $ 01e6.  Je vais insérer une partie du code avec des transitions dans ce code: <br><br><pre> <code class="hljs mel"> <span class="hljs-number"><span class="hljs-number">01e6</span></span> LXI D,#$1b00 <span class="hljs-number"><span class="hljs-number">01e9</span></span> LXI H,#$2000 <span class="hljs-number"><span class="hljs-number">01</span></span>ec JMP $1a32 ..... <span class="hljs-number"><span class="hljs-number">1</span></span>a32 LDAX D <span class="hljs-number"><span class="hljs-number">1</span></span>a33 MOV M,A <span class="hljs-number"><span class="hljs-number">1</span></span>a34 INX H <span class="hljs-number"><span class="hljs-number">1</span></span>a35 INX D <span class="hljs-number"><span class="hljs-number">1</span></span>a36 DCR B <span class="hljs-number"><span class="hljs-number">1</span></span>a37 JNZ $1a32 <span class="hljs-number"><span class="hljs-number">1</span></span>a3a RET</code> </pre> <br>  Comme nous l'avons vu à partir de l'allocation de mémoire Space Invaders, certaines de ces adresses sont intéressantes.  2000 $ est le début d'un programme de «RAM de travail».  2400 $ est le début de la mémoire vidéo. <br><br>  Ajoutons des commentaires au code pour expliquer ce qu'il fait directement au démarrage: <br><br><pre> <code class="hljs mel"> <span class="hljs-number"><span class="hljs-number">18</span></span>d4 LXI SP,#$2400 ; SP=$2400 -      <span class="hljs-number"><span class="hljs-number">18</span></span>d7 MVI B,#$00 ; B=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">18</span></span>d9 CALL $01e6 ..... <span class="hljs-number"><span class="hljs-number">01e6</span></span> LXI D,#$1b00 ; DE=$1B00 <span class="hljs-number"><span class="hljs-number">01e9</span></span> LXI H,#$2000 ; HL=$2000 <span class="hljs-number"><span class="hljs-number">01</span></span>ec JMP $1a32 ..... <span class="hljs-number"><span class="hljs-number">1</span></span>a32 LDAX D ; A = (DE),   ,       $1B00 <span class="hljs-number"><span class="hljs-number">1</span></span>a33 MOV M,A ;  A  (HL),     $2000 <span class="hljs-number"><span class="hljs-number">1</span></span>a34 INX H ; HL = HL + <span class="hljs-number"><span class="hljs-number">1</span></span> ( $2001) <span class="hljs-number"><span class="hljs-number">1</span></span>a35 INX D ; DE = DE + <span class="hljs-number"><span class="hljs-number">1</span></span> ( $1B01) <span class="hljs-number"><span class="hljs-number">1</span></span>a36 DCR B ; B = B - <span class="hljs-number"><span class="hljs-number">1</span></span> ( <span class="hljs-number"><span class="hljs-number">0xff</span></span>,      <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>a37 JNZ $1a32 ; ,   ,     b=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>a3a RET</code> </pre> <br>  Il semble que ce code copiera 256 octets de 1b00 $ à 2000 $.  Pourquoi?  Je ne sais pas.  Vous pouvez étudier le programme plus en détail et réfléchir à ce qu'il fait. <br><br>  <strong>Il y a un problème ici.</strong>  Si nous avons un morceau de mémoire arbitraire contenant du code, alors les données alterneront probablement avec lui. <br><br>  Par exemple, les sprites pour les personnages du jeu peuvent être mélangés avec du code.  Lorsqu'un désassembleur tombe dans un tel fragment de mémoire, il pense que c'est du code et continue de le «mâcher».  Si vous n'avez pas de chance, tout code désassemblé après cette donnée peut être incorrect. <br><br>  Bien que nous ne puissions presque rien y faire.  Gardez juste à l'esprit qu'un tel problème existe.  Si vous voyez quelque chose comme ça: <br><br><ul><li>  transition d'un code exactement bon à une équipe qui ne figure pas dans la liste des désassembleurs </li><li>  flux de code sans signification (par exemple POP B POP B POP B POP C XTHL XTHL XTHL) </li></ul><br>  ici, probablement, il y a des données qui ont ruiné une partie du code démonté.  Si cela se produit, vous devez recommencer à partir du décalage. <br><br>  Il s'avère que les Space Invaders rencontrent périodiquement des zéros.  Si notre démontage s'arrête un jour, les zéros le forceront à effectuer une réinitialisation. <br><br>  Une analyse détaillée du code Space Invaders peut être trouvée <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . <br><br><h4>  Endian </h4><br>  Les octets sont stockés différemment dans différents modèles de processeur, et le stockage dépend de la taille des données.  Les machines big-endian stockent les données des plus anciennes aux plus jeunes.  Le petit-endian les garde du plus jeune au plus vieux.  Si un entier 32 bits 0xAABBCCDD est écrit dans la mémoire de chaque machine, il ressemblera à ceci: <br><br>  En petit-boutien: $ DD $ CC $ BB $ AA <br><br>  Big-endian: $ AA $ BB $ CC $ DD <br><br>  J'ai commencé à programmer sur des processeurs Motorola qui utilisaient le big-endian, donc cela me semblait plus «naturel», mais ensuite je me suis habitué au little-endian. <br><br>  Mon désassembleur et mon émulateur évitent complètement le problème endian car ils ne lisent qu'un octet à la fois.  Si vous souhaitez, par exemple, utiliser un lecteur 16 bits pour lire l'adresse de la ROM, notez que ce code n'est pas portable entre les architectures CPU. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr418683/">https://habr.com/ru/post/fr418683/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr418673/index.html">Pourquoi le marché ERP se développe: statistiques et tendances</a></li>
<li><a href="../fr418675/index.html">Comment je suis allé à Droidcon Berlin</a></li>
<li><a href="../fr418677/index.html">Toute la vérité sur RTOS. Article # 6. Autres services RTOS</a></li>
<li><a href="../fr418679/index.html">Nous écrivons un composant avec des boutons «matériel» pour Svelte</a></li>
<li><a href="../fr418681/index.html">Journée de l'amitié - 50% de réduction sur tous les IDE JetBrains pour nos amis</a></li>
<li><a href="../fr418685/index.html">Génération de niveau procédural</a></li>
<li><a href="../fr418687/index.html">Révolution 3,5 ": détails d'un petit boom de disquettes avec vapeurs</a></li>
<li><a href="../fr418689/index.html">Comment créer des bibliothèques de composants dans Figma, économiser un budget, en utilisant l'exemple d'une vente aux enchères en ligne</a></li>
<li><a href="../fr418691/index.html">Rancher: Kubernetes en 5 minutes sur du métal nu</a></li>
<li><a href="../fr418693/index.html">Pourquoi le bonheur est-il si difficile à détecter dans le cerveau</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>