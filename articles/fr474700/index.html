<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë≤üèº üìÜ ü§æüèΩ Cloud Smart Home. Partie 2: Service cloud üßíüèº üöÄ ü•ê</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Je continue la s√©rie de trois articles sur la maison intelligente cloud. 

 Dans un article pr√©c√©dent , l'√©quipement pour d√©tecter une maison intellig...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Cloud Smart Home. Partie 2: Service cloud</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/474700/"><img src="https://habrastorage.org/webt/iq/e3/kt/iqe3kte_k_di5dqmevpvprwojee.jpeg" alt="image"><br><br>  Je continue la s√©rie de trois articles sur la maison intelligente cloud. <br><br>  Dans un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article pr√©c√©dent</a> , l'√©quipement pour d√©tecter une maison intelligente a √©t√© examin√©, ainsi que des algorithmes pour convertir les donn√©es sensorielles en commandes de contr√¥le pour les appareils ex√©cutifs.  Le composant principal d'une maison intelligente est un contr√¥leur qui, la plupart du temps, fonctionne de mani√®re autonome conform√©ment √† la logique d√©finie lors de la configuration.  Divers appareils (cam√©ras IP, capteurs, actionneurs) sont connect√©s au contr√¥leur, qui envoie les donn√©es re√ßues de ces appareils vers le cloud. <br><br>  Parlons maintenant de l'architecture d'un service cloud pour le stockage et le traitement des informations des capteurs et des cam√©ras. <br><a name="habracut"></a><br><h2>  Avantages du service cloud </h2><br>  Un service cloud de maison intelligente offre un moyen simple, flexible et peu co√ªteux de stocker et d'acc√©der aux donn√©es re√ßues des appareils de la maison intelligente.  L'utilisateur du service cloud n'a pas √† se soucier de la s√©curit√© de ses donn√©es.  Les capacit√©s d'un serveur multim√©dia multiprocesseur, √©quip√© d'un panier de disques avec une matrice RAID de plusieurs disques de 10 √† 12 To, d√©passent de loin la capacit√© d'une carte SD ou Flash √† l'int√©rieur d'un contr√¥leur domestique intelligent.  De plus, les cartes m√©moire ne sont pas fiables car elles ont un nombre limit√© de cycles de r√©√©criture et √©chouent souvent.  La profondeur de stockage des donn√©es dans le cloud est d√©termin√©e par le tarif de l'utilisateur et est facilement configurable dans son compte personnel. <br><br>  De plus, pour acc√©der aux donn√©es, il n'est pas n√©cessaire de ¬´rediriger les ports¬ª sur le routeur de l'utilisateur lorsque les appareils domestiques intelligents sont cach√©s des r√©seaux externes par le protocole NAT.  Dans votre compte personnel, accessible depuis des appareils mobiles, vous pouvez facilement configurer la configuration et la logique de la maison intelligente. <br><br>  Il est pratique non seulement de stocker des donn√©es dans le cloud, mais aussi de les traiter, fournissant √† l'utilisateur des statistiques pour diff√©rentes p√©riodes.  Ci-dessous, nous consid√©rerons un exemple de calcul de la temp√©rature ambiante moyenne par semaine sur la base de mesures multicapteurs. <br><br><h2>  Architecture de service cloud </h2><br>  Dans un article pr√©c√©dent, nous avons parl√© d'un contr√¥leur de maison intelligente install√© c√¥t√© utilisateur et interagissant avec un service cloud √† l'aide de plusieurs protocoles: <br><br><ul><li>  MQTT est utilis√© pour √©changer des messages JSON entre le contr√¥leur et le serveur de logique m√©tier; </li><li>  HTTP pour obtenir l'adresse IP du serveur multim√©dia le moins charg√© √† partir de l'√©quilibreur de charge du cluster de serveurs multim√©dia; </li><li>  RTMP pour transf√©rer le flux H.264 + AAC vers le serveur multim√©dia. </li></ul><br>  Nous allons maintenant examiner le service cloud d'une maison intelligente - les principaux composants qui le composent, et comment l'interaction avec le contr√¥leur de maison intelligente se produit. <br><br> <a href=""><img src="https://habrastorage.org/webt/os/bd/xi/osbdxiktvu-cla3sizuxjoaxbfu.png"></a> <br>  <font color="grey">(cliquez sur l'image pour l'ouvrir en plus haute r√©solution)</font> <br><br>  <b>Le serveur de logique m√©tier</b> est un √©l√©ment cl√© de l'ensemble du syst√®me d'√©change d'informations au sein du service cloud.  Son objectif principal est de g√©rer divers sous-syst√®mes de serveur via les interfaces API RESTful.  Il impl√©mente la logique du service cloud bas√©e sur <b>le mod√®le utilisateur</b> : enregistrement d'une archive vid√©o et mesures de capteurs en fonction du tarif s√©lectionn√©, interaction entre l'utilisateur et le contr√¥leur de maison intelligente, etc. <br><br>  <b>Le courtier MQTT est</b> n√©cessaire pour √©changer des messages JSON entre des contr√¥leurs de maison intelligente install√©s c√¥t√© client et le serveur de logique m√©tier.  Les clients s'abonnent aux sujets du courtier qui servent de canaux de messages.  En tant que courtier MQTT, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Eclipse Mosquitto est utilis√©</a> . <br><br>  <b>Un cluster de serveurs multim√©dias</b> est un syst√®me distribu√© de stockage, de traitement, de recherche et de lecture d'informations vid√©o pour les cam√©ras IP d'une maison intelligente nuageuse.  Un √©quilibreur de charge sp√©cial collecte des informations sur les performances actuelles de chaque serveur du cluster, calcule le moins charg√© et communique son adresse IP au contr√¥leur de maison intelligente, qui lui transf√®re la vid√©o des cam√©ras. <br><br>  <b>Une base de donn√©es cloud est</b> n√©cessaire pour stocker le mod√®le utilisateur du service cloud, la configuration et l'√©tat actuel de son √©quipement, ainsi que des m√©ta-informations sur les entr√©es d'archives vid√©o.  En tant qu'impl√©mentation de la base de donn√©es cloud, le SGBD MySQL est utilis√©. <br><br>  <b>Touch Database</b> est une base de donn√©es NoSQL non relationnelle.  Il stocke les √©v√©nements et les mesures des capteurs de maison intelligente, class√©s par heure.  L'utilisation du SGBD <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">InfluxDB</a> , optimis√© pour travailler avec ce type de donn√©es, am√©liore consid√©rablement les performances du service cloud. <br><br>  <b>Le backend d'application client</b> est une application serveur dont la fonction principale est de fournir des donn√©es re√ßues du cloud et des bases de donn√©es tactiles dans un format pratique pour un affichage ult√©rieur par l'application client sur l'appareil de l'utilisateur.  Le backend g√©n√®re √©galement des commandes de contr√¥le au format JSON pour le contr√¥leur de maison intelligente.  Le backend est bas√© sur le framework PHP <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Laravel</a> .  Il sera discut√© plus en d√©tail dans le prochain article sur une application client pour interagir avec une maison intelligente cloud. <br><br>  <b>Le fournisseur de notifications push envoie</b> des messages sur les √©v√©nements de la maison intelligente √† l'appareil mobile de l'utilisateur afin qu'il puisse intervenir rapidement dans la situation (par exemple, lorsqu'une fuite d'eau ou de la fum√©e appara√Æt, appelez les services de r√©ponse appropri√©s).  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Le</a> service <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">OneSignal</a> a √©t√© choisi comme fournisseur de notifications push, qui poss√®de une interface API RESTful pratique et la fonction d'identification des appareils mobiles, qui est n√©cessaire pour le bon fonctionnement des notifications dans le compte personnel de l'utilisateur. <br><br><h2>  Serveur de logique m√©tier </h2><br>  Comme mentionn√© pr√©c√©demment, le serveur de logique m√©tier est un composant cl√© de la maison intelligente cloud.  Sur la base <b>du mod√®le utilisateur</b> (description informative de l'utilisateur du syst√®me, qui comprend les fonctionnalit√©s syst√®me, personnelles, financi√®res et logiques), il g√®re une vari√©t√© de services dans le cloud qui ont diff√©rentes impl√©mentations et fonctionnalit√©s et communiquent entre eux via des interfaces API RESTful. <br><br><img src="https://habrastorage.org/webt/m0/vl/vj/m0vlvjztjnmvtrckqgvefi2ht80.png"><br><br>  Le module de logique m√©tier √† l'int√©rieur du serveur est responsable des op√©rations suivantes: <br><br><ol><li>  g√©rer le stockage des mesures des capteurs et des √©v√©nements des d√©tecteurs de mouvement des cam√©ras IP d'une maison intelligente √† l'int√©rieur d'une base de donn√©es tactile; </li><li>  g√©rer l'enregistrement du flux multim√©dia de la cam√©ra IP diffus√© par le contr√¥leur de maison intelligente dans l'archive du serveur multim√©dia (constant / par d√©tecteur de mouvement); </li><li>  traduction des commandes de l'application client vers le contr√¥leur de maison intelligente; </li><li>  diffuser la configuration du contr√¥leur de maison intelligente (appareils connect√©s, r√®gles de logique de production d√©finies par l'utilisateur); </li><li>  envoyer des notifications push sur l'√©tat du contr√¥leur de maison intelligente et des appareils connect√©s √† l'application cliente. </li></ol><br>  Une caract√©ristique du serveur de logique m√©tier est la communication interprocessus avec des applications distantes ex√©cut√©es sur plusieurs serveurs sur Internet.  La plupart du temps, l'application serveur de logique m√©tier est inactive sur les verrous d'E / S, elle est donc con√ßue sur la base d'une architecture multithread et se compose d'un ensemble de sous-t√¢ches finies. <br><br>  Pour garantir une efficacit√© maximale, l'impl√©mentation interne du serveur de logique m√©tier doit √™tre la plus simple ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">principe KISS</a> ).  √âtant donn√© que le mod√®le utilisateur est compl√®tement d√©terministe et ne contient pas de relations changeantes entre les fonctionnalit√©s, il n'est pas n√©cessaire d'avoir un m√©canisme d'inf√©rence flexible (comme dans un contr√¥leur de maison intelligente, o√π la logique utilisateur est configur√©e par l'utilisateur).  Par cons√©quent, le fonctionnement du module de logique m√©tier √† l'int√©rieur du serveur peut √™tre d√©crit par un sch√©ma fonctionnel algorithmique classique avec des transitions conditionnelles. <br><br> <a href=""><img src="https://habrastorage.org/webt/fh/xf/70/fhxf703hqjqjjhzg9i_uuxv2qqo.png"></a> <br>  <font color="grey">(cliquez sur l'image pour l'ouvrir en plus haute r√©solution)</font> <br><br>  Imm√©diatement apr√®s le d√©marrage, le serveur de logique m√©tier passe en √©tat d'attente pour les messages √† l'aide des protocoles MQTT (des contr√¥leurs de maison intelligente) et HTTP (du serveur principal de l'application client).  Dans le cas o√π le message arrive via HTTP, cela signifie que l'utilisateur interagit avec l'application cliente et envoie des commandes au contr√¥leur de maison intelligente ou met √† jour sa configuration.  Pour que le message du client tombe dans le contr√¥leur de maison intelligente, il est transmis par le serveur de logique m√©tier au sujet correspondant du courtier MQTT, auquel le contr√¥leur est abonn√© (sous- <b>t√¢che SendGatewayMessage</b> ). <br><br>  Au stade de l'initialisation, le contr√¥leur de maison intelligente attend que l'utilisateur l'enregistre dans son compte personnel.  Par cons√©quent, la sous-t√¢che <b>CheckGatewayExistance est effectu√©e</b> , qui v√©rifie l'√©tat correspondant dans la base de donn√©es cloud MySQL.  Pour vous inscrire dans votre compte personnel, le contr√¥leur envoie sa configuration compl√®te au serveur de logique m√©tier, qui √† son tour diffuse son backend √† l'application cliente (sous- <b>t√¢che SendBackend</b> ), qui cr√©e et met √† jour les enregistrements de configuration dans le cloud et les bases de donn√©es tactiles. <br><br>  Lorsque le contr√¥leur domestique intelligent est enregistr√© avec succ√®s dans le compte personnel de l'utilisateur, le serveur de logique m√©tier charge le mod√®le utilisateur de la base de donn√©es cloud dans sa RAM et commence √† traiter les messages des cam√©ras IP et des capteurs Z-Wave conform√©ment √† l'algorithme de logique m√©tier suivant. <br><br>  Message JSON du capteur Z-Wave avec champs d'information: <br><br><pre><code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"vendor"</span></span>: <span class="hljs-string"><span class="hljs-string">"*****"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"version"</span></span>: <span class="hljs-string"><span class="hljs-string">"3.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"timestampMs"</span></span>: <span class="hljs-string"><span class="hljs-string">"1571754749561"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"clientType"</span></span>: <span class="hljs-string"><span class="hljs-string">"gateway"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"deviceId"</span></span>: <span class="hljs-string"><span class="hljs-string">"c8e8de37-d301-45f4-ba01-************"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"deviceType"</span></span>: <span class="hljs-string"><span class="hljs-string">"sensor"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"protocol"</span></span>: <span class="hljs-string"><span class="hljs-string">"zwave"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"messageType"</span></span>: <span class="hljs-string"><span class="hljs-string">"sensorData"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"homeId"</span></span>: <span class="hljs-string"><span class="hljs-string">"0xefa0cfa7"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"nodeId"</span></span>: <span class="hljs-string"><span class="hljs-string">"19"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"sensorType"</span></span>: <span class="hljs-string"><span class="hljs-string">"SENSOR MULTILEVEL"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"label"</span></span>: <span class="hljs-string"><span class="hljs-string">"Temperature"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"sensorData"</span></span>: <span class="hljs-string"><span class="hljs-string">"26.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"units"</span></span>: <span class="hljs-string"><span class="hljs-string">"C"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"gatewayId"</span></span>: <span class="hljs-string"><span class="hljs-string">"6774f85a-0a5b-4059-9b68-************"</span></span> }</code> </pre> <br>  Lorsqu'un message du capteur Z-Wave arrive via le protocole MQTT, les sous-t√¢ches suivantes sont effectu√©es: <br><br><ul><li>  <b>StoreSensorDataMySQL</b> met √† jour (UPDATE) un enregistrement existant dans la base de donn√©es cloud MySQL, o√π les informations sur l'√©tat actuel et les mesures du capteur sont stock√©es.  Cela est n√©cessaire pour une application client qui affiche l'√©tat actuel de la maison intelligente pour l'utilisateur; </li><li>  <b>StoreSensorDataInfluxDB</b> ajoute (INS√âRER) un nouvel enregistrement √† la base de donn√©es tactile InfluxDB, o√π l'historique des mesures du capteur est stock√©.  Ces informations sont utilis√©es dans le calcul des donn√©es statistiques pour diff√©rentes p√©riodes (par exemple, la consommation d'√©nergie par jour, mois ou ann√©e) et affich√©es dans l'application client sous forme de graphiques et de tableaux; </li><li>  <b>SendPushNotification</b> g√©n√®re un message JSON contenant un horodatage, un nom de capteur, une description textuelle de l'√©v√©nement, l'identifiant du smartphone de l'utilisateur avec lequel il est entr√© dans son compte personnel, l'identifiant interne de l'application dans le syst√®me du fournisseur OneSignal.  De plus, ce message est envoy√© au fournisseur de notifications push via l'API RESTful <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://onesignal.com/api/v1/notifications</a> , qui le transmet au smartphone de l'utilisateur. </li></ul><br>  Un exemple de message JSON d'une cam√©ra IP avec des champs d'informations: <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"vendor"</span></span>: <span class="hljs-string"><span class="hljs-string">"*****"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"version"</span></span>: <span class="hljs-string"><span class="hljs-string">"3.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"timestampMs"</span></span>: <span class="hljs-string"><span class="hljs-string">"1571753150317"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"clientType"</span></span>: <span class="hljs-string"><span class="hljs-string">"gateway"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"deviceId"</span></span>: <span class="hljs-string"><span class="hljs-string">"1616453d-30cd-44b7-9bf0-************"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"deviceType"</span></span>: <span class="hljs-string"><span class="hljs-string">"camera"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"protocol"</span></span>: <span class="hljs-string"><span class="hljs-string">"onvif"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"messageType"</span></span>: <span class="hljs-string"><span class="hljs-string">"deviceState"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"deviceState"</span></span>: <span class="hljs-string"><span class="hljs-string">"streamingOn"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"mediaserverIp"</span></span>: <span class="hljs-string"><span class="hljs-string">"***.***.***.***"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"applicationName"</span></span>: <span class="hljs-string"><span class="hljs-string">"rtp-live-iot"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"gatewayId"</span></span>: <span class="hljs-string"><span class="hljs-string">"6774f85a-0a5b-4059-9b68-************"</span></span> }</code> </pre><br>  Lorsqu'un message arrive de la cam√©ra IP √† l'aide du protocole MQTT, le serveur de logique m√©tier extrait son type du champ <b>messageType</b> .  Selon la valeur de ce champ, les actions suivantes sont effectu√©es: <br><br><ul><li>  <b>"MessageType": "deviceState"</b> - le message contient des informations sur le changement d'√©tat de la cam√©ra IP.  La sous-t√¢che <b>UpdateCameraState est effectu√©e</b> , mettant √† jour les informations dans la base de donn√©es cloud.  Si le champ <b>deviceState</b> est <b>streamingOn</b> ou <b>streamingOff</b> (la cam√©ra IP envoie / arr√™te le flux de donn√©es au serveur multim√©dia), la sous-t√¢che <b>RecordMediaStream</b> est <b>ex√©cut√©e</b> , qui g√©n√®re une commande pour activer / d√©sactiver le mode d'enregistrement d'archive et l'envoie au serveur multim√©dia; </li><li>  <b>"MessageType": "sensorData"</b> - informations sur le fonctionnement du d√©tecteur de mouvement sur la cam√©ra IP.  Si dans le mod√®le utilisateur le mode d'enregistrement d'archive est r√©gl√© sur ¬´par d√©tecteur de mouvement¬ª, la sous-t√¢che <b>RecordMediaStream</b> est <b>ex√©cut√©e</b> .  Ensuite, les sous-t√¢ches <b>StoreSensorDataInfluxDB</b> (sauvegarde de l'historique du d√©tecteur dans la base de donn√©es tactile) et <b>SendPushNotification</b> (envoi de notifications push via le fournisseur) sont effectu√©es; </li><li>  <b>"MessageType": "aper√ßu"</b> - le message contient un cadre d'une image miniature de la cam√©ra IP, qui est p√©riodiquement envoy√©e au cloud.  La sous-t√¢che <b>StorePreview l'</b> enregistre dans une base de donn√©es cloud.  Il est ensuite utilis√© dans l'application client lors de l'affichage d'une liste de cam√©ras; </li><li>  <b>"MessageType": "commande"</b> - une commande envoy√©e par le contr√¥leur de maison intelligente lorsque l'utilisateur modifie ses param√®tres via l'interface Web.  La sous-t√¢che <b>RecordMediaStream est ex√©cut√©e</b> , ce qui, selon le mod√®le utilisateur, active / d√©sactive le mode d'enregistrement sur le serveur multim√©dia. </li></ul><br> <a href=""><img src="https://habrastorage.org/webt/8o/_u/gy/8o_ugygyf5hm0nlyd6aw8zwge8s.png"></a> <br>  <font color="grey">(cliquez sur l'image pour l'ouvrir en plus haute r√©solution)</font> <br><br>  √Ä la suite du travail du module de logique m√©tier, une <b>file d'attente de t√¢ches</b> est form√©e - une s√©quence de sections minimales de code qui sont ex√©cut√©es ind√©pendamment les unes des autres.  La file d'attente des t√¢ches est transf√©r√©e au <b>pool de threads</b> , qui r√©partit les t√¢ches entre les c≈ìurs libres du processeur central.  Lorsqu'un verrouillage d'E / S se produit pendant l'ex√©cution, le thread se met en pause et entre dans l'√©tat inactif et lib√®re le c≈ìur du processeur central, ce qui permet au pool de threads de d√©marrer imm√©diatement la t√¢che suivante √† partir de la file d'attente.  Au moment o√π le verrou d'E / S est lib√©r√©, le thread bloqu√© passe √† son √©tat de fonctionnement et continue son ex√©cution d√®s que l'un des c≈ìurs du processeur central est lib√©r√©. <br><br>  Ainsi, en d√©composant la t√¢che de logique m√©tier en de nombreuses sous-t√¢ches distinctes qui sont ex√©cut√©es simultan√©ment, les performances du serveur de logique m√©tier sont augment√©es.  La mise √† l'√©chelle du syst√®me est obtenue en augmentant le nombre de c≈ìurs du processeur central et en augmentant le nombre de serveurs de logique m√©tier dans le syst√®me. <br><br>  L'application serveur de logique m√©tier est d√©velopp√©e en C ++ et fonctionne comme le service <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">systemd</a> du syst√®me d'exploitation Linux Debian Sarge.  Pour une surveillance suppl√©mentaire des performances, le syst√®me de surveillance des ressources <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Monit</a> est utilis√©, ce qui red√©marre le service en cas de probl√®mes de performances. <br><br>  Actuellement, le service cloud ex√©cute un serveur de logique m√©tier s'ex√©cutant sur la machine virtuelle cloud Yandex.  Param√®tres de la machine virtuelle - 4 c≈ìurs vCPU avec une part garantie de 20%, 2 Go de RAM, 100 Go de disque dur.  Selon les calculs, ces performances sont suffisantes pour traiter les messages de ~ 1000 contr√¥leurs de maison intelligente avec 3 cam√©ras IP et 5 capteurs Z-Wave chacun (les calculs seront clarifi√©s pendant le fonctionnement du syst√®me). <br><br><h2>  Serveur multim√©dia </h2><br>  Un serveur multim√©dia est un serveur d√©di√© sur lequel un logiciel sp√©cial est install√© pour: <br><br><ul><li>  recevoir des flux de donn√©es vid√©o et audio √† partir de dispositifs d'encodage en utilisant des protocoles r√©seau sp√©cialis√©s; </li><li>  stocker des donn√©es sous forme de fichiers d'archives dans son syst√®me de fichiers; </li><li>  Diffusez des informations √† partir de fichiers d'archives dans un format de streaming standard pour la lecture sur les appareils clients. </li></ul><br>  Le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">moteur de streaming Wowza 4.7.2</a> avec des modules suppl√©mentaires d√©velopp√©s en Java est utilis√© comme serveur multim√©dia dans le syst√®me de maison intelligente cloud pour enregistrer des donn√©es de streaming dans une archive de fichiers et pour travailler avec une base de donn√©es cloud. <br><br> <a href=""><img src="https://habrastorage.org/webt/va/du/c-/vaduc-wwi67k2367aoez0bnqx_s.png"></a> <br>  <font color="grey">(cliquez sur l'image pour l'ouvrir en plus haute r√©solution)</font> <br><br>  Le flux multim√©dia du contr√¥leur de maison intelligente au format RTMP entre dans le serveur multim√©dia et est align√© avec les horodatages dans le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">tampon de gigue</a> .  Cela est n√©cessaire pour compenser l'effet des retards de paquets r√©seau lors de la transmission du flux de donn√©es sur Internet. <br><br>  Pour enregistrer le flux vid√©o sur le syst√®me de fichiers du serveur multim√©dia en tant que fichier MP4, le serveur de logique m√©tier envoie la commande suivante au serveur multim√©dia via l'API HTTP RESTful: <br><br><pre> <code class="json hljs">http://&lt;mediaserverIp&gt;:&lt;port&gt;/v<span class="hljs-number"><span class="hljs-number">2</span></span>/servers/_defaultServer_/vhosts/_defaultVHost_/applications/rtp-live-iot/instances/_definst_/streamrecorders/<span class="hljs-number"><span class="hljs-number">1616453</span></span>d<span class="hljs-number"><span class="hljs-number">-30</span></span>cd<span class="hljs-number"><span class="hljs-number">-44</span></span>b<span class="hljs-number"><span class="hljs-number">7</span></span><span class="hljs-number"><span class="hljs-number">-9</span></span>bf<span class="hljs-number"><span class="hljs-number">0</span></span>-************ { <span class="hljs-attr"><span class="hljs-attr">"instanceName"</span></span>: <span class="hljs-string"><span class="hljs-string">"_definst_"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"fileVersionDelegateName"</span></span>: <span class="hljs-string"><span class="hljs-string">"CustomFileVersionDelegate"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"serverName"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"recorderName"</span></span>: <span class="hljs-string"><span class="hljs-string">"1616453d-30cd-44b7-9bf0-************"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"segmentSchedule"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"outputPath"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"currentFile"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"applicationName"</span></span>: <span class="hljs-string"><span class="hljs-string">"rtp-live-iot"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"fileTemplate"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"segmentationType"</span></span>: <span class="hljs-string"><span class="hljs-string">"SegmentByDuration"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"fileFormat"</span></span>: <span class="hljs-string"><span class="hljs-string">"MP4"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"recorderState"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"option"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"currentSize"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"segmentSize"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"segmentDuration"</span></span>: <span class="hljs-string"><span class="hljs-string">"1800000"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"backBufferTime"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"currentDuration"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"startOnKeyFrame"</span></span>: <span class="hljs-string"><span class="hljs-string">"true"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"recordData"</span></span>: <span class="hljs-string"><span class="hljs-string">"false"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"moveFirstVideoFrameToZero"</span></span>: <span class="hljs-string"><span class="hljs-string">"true"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"defaultRecorder"</span></span>: <span class="hljs-string"><span class="hljs-string">"false"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"splitOnTcDiscontinuity"</span></span>: <span class="hljs-string"><span class="hljs-string">"false"</span></span> }</code> </pre><br>  Le nom du flux vid√©o (l'identifiant de la cam√©ra IP sur le contr√¥leur de maison intelligente) est indiqu√© dans le champ <b>recorderName</b> , dans le champ <b>fileVersionDelegateName</b> est le nom de la classe h√©rit√©e pour d√©terminer le chemin d'acc√®s au dossier et le nom de fichier.  Le code de classe Java est indiqu√© dans la liste suivante: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.File; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Calendar; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.TimeZone; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.wowza.wms.livestreamrecord.manager.IStreamRecorder; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.wowza.wms.livestreamrecord.manager.IStreamRecorderFileVersionDelegate; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.wowza.wms.logging.WMSLoggerFactory; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomFileVersionDelegate</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IStreamRecorderFileVersionDelegate</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getFilename</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(IStreamRecorder recorder)</span></span></span><span class="hljs-function"> </span></span>{ String sDisk = GetDisk(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(sDisk == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { WMSLoggerFactory.getLogger(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>).error(<span class="hljs-string"><span class="hljs-string">"CustomFileVersionDelegate::getFilename(): No drive chosen"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } String sStreamName = recorder.getStreamName(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> nCameraId = Integer.parseUnsignedInt(ServiceQueries.GetCameraId(sStreamName)); TimeZone tz = TimeZone.getTimeZone(<span class="hljs-string"><span class="hljs-string">"Europe/Moscow"</span></span>); Calendar now = Calendar.getInstance(tz); String sDirPath = ServerParams.m_sServerContentPath + <span class="hljs-string"><span class="hljs-string">"/"</span></span> + sDisk + <span class="hljs-string"><span class="hljs-string">"/"</span></span> + Integer.toString(nCameraId / <span class="hljs-number"><span class="hljs-number">200</span></span>) + <span class="hljs-string"><span class="hljs-string">"/"</span></span> + sStreamName + <span class="hljs-string"><span class="hljs-string">"/"</span></span> + String.format(<span class="hljs-string"><span class="hljs-string">"%1$tY/%1$tm/%1$td"</span></span>, now); String sFullFilePath = sDirPath + <span class="hljs-string"><span class="hljs-string">"/"</span></span> + sStreamName + <span class="hljs-string"><span class="hljs-string">"_"</span></span> + String.format(<span class="hljs-string"><span class="hljs-string">"%1$tH_%1$tM_%1$tS"</span></span>, now) + <span class="hljs-string"><span class="hljs-string">".mp4"</span></span>; File dirs = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> File(sDirPath); dirs.setExecutable(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); dirs.setWritable(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); dirs.mkdirs(); WMSLoggerFactory.getLogger(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>).info( <span class="hljs-string"><span class="hljs-string">"CustomFileVersionDelegate::getFilename(): Filename created: "</span></span> + sFullFilePath); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sFullFilePath; } }</code> </pre><br>  Dans la classe <b>CustomFileVersionDelegate</b> , la fonction virtuelle <b>getFilename</b> de la classe de base <b>IStreamRecorderFileVersionDelegate</b> est <b>surcharg√©e</b> , qui est appel√©e par le serveur de m√©dias avant que le flux ne commence √† √©crire dans le fichier.  La fonction cr√©e un dossier sur le disque avec le chemin d'acc√®s <b>sDirPath</b> et renvoie le chemin d'acc√®s complet au fichier <b>sFullFilePath</b> . <br><br>  Le volume des donn√©es multim√©dias √©tant tr√®s important, le syst√®me de fichiers comprend plusieurs disques physiques de gros volume (8 √† 12 To) mont√©s en sous-r√©pertoires.  Le disque avec la plus grande quantit√© d'espace libre est s√©lectionn√© comme disque de destination pendant l'enregistrement.  Pour un fonctionnement optimal du syst√®me de fichiers lors de l'acc√®s au fichier, le chemin d'acc√®s au dossier cible est form√© comme suit: <br><br><pre> <code class="plaintext hljs">/content/&lt;diskId&gt;/&lt;cameraIdDivideBy200&gt;/&lt;streamUuid&gt;/&lt;year&gt;/&lt;month&gt;/&lt;day&gt;/</code> </pre><br>  o√π <b>diskId</b> est l'identifiant du disque (dossier mont√©), <br>  <b>cameraIdDivideBy200</b> - le r√©sultat d'une division enti√®re de l'identifiant de la cam√©ra par 200, <br>  <b>streamUuid</b> - identifiant de flux multim√©dia, <br>  <b>ann√©e, mois, jour</b> - ann√©e, mois et jour d'enregistrement, respectivement. <br><br>  Cela √©vite un grand nombre de sous-dossiers dans un dossier et, par cons√©quent, une baisse spectaculaire des performances de l'ensemble du syst√®me de fichiers avec une augmentation du nombre de cam√©ras IP dans les maisons intelligentes nuageuses. <br><br>  Les informations sur l'adresse IP du serveur multim√©dia, le chemin d'acc√®s au fichier contenant les donn√©es multim√©dias, l'heure de d√©but et de fin d'√©criture dans le fichier sont stock√©es dans la base de donn√©es cloud, puis utilis√©es par l'application cliente pour afficher la chronologie d'archivage sur laquelle la vid√©o peut √™tre s√©lectionn√©e et lue. <br><br>  Pour obtenir le flux vid√©o, le frontal de l'application client acc√®de au serveur multim√©dia, en envoyant les commandes suivantes via le protocole HTTP.  Pour un flux vid√©o "en direct": <br><br><pre> <code class="plaintext hljs">https://&lt;mediaserverIp&gt;:&lt;port&gt;/rtp-live-iot/&lt;streamUuid&gt;/playlist.m3u8</code> </pre><br>  Pour le flux vid√©o archiv√©: <br><br><pre> <code class="plaintext hljs">https://&lt;mediaserverIp&gt;:&lt;port&gt;/vod/_definst_/mp4:&lt;diskId&gt;/&lt;cameraIdDivideBy200&gt;/&lt;streamUuid&gt;/&lt;year&gt;/&lt;month&gt;/&lt;day&gt;/&lt;fileName&gt;/playlist.m3u8?wowzaplaystart=&lt;offsetMs&gt;&amp;wowzaplayduration=&lt;durationMs&gt;</code> </pre><br>  o√π <b>fileName</b> est le nom du fichier d'archive sur le disque, <br>  <b>offsetMs</b> - d√©calage de lecture par rapport au d√©but du fichier en millisecondes, <br>  <b>durationMs</b> - dur√©e de lecture en millisecondes. <br><br>  Le serveur multim√©dia envoie un flux au format <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">HLS</a> , qui vous permet d'afficher la vid√©o H.264 + AAC dans tous les navigateurs et appareils mobiles modernes avec les syst√®mes d'exploitation iOS et Android.  Le packetizer HLS code le flux sous la forme de blocs s√©par√©s et l'envoie sur HTTP en r√©ponse √† une demande d'une application mobile. <br><br>  Pour optimiser les co√ªts de stockage et l'acc√®s aux fichiers d'archives, le serveur multim√©dia domestique intelligent cloud a √©t√© d√©velopp√© sur la plate-forme mat√©rielle Supermicro CSE-825TQ, carte m√®re X8DT6, 2xCPU Intel Xeon E5645 2,4 GHz, 32 Go de RAM, 44 To HDD Adaptec AAC-RAID.  Le serveur multim√©dia est install√© en tant que serveur d√©di√© sur le site d'h√©bergement et se connecte au canal Internet avec une largeur garantie de 400 Mbps.  Les performances d'un serveur multim√©dia sont suffisantes pour traiter les flux multim√©dias de ~ 400 cam√©ras IP avec le codec H.264, la r√©solution de trame 720p et le d√©bit binaire de 1 Mbps. <br><br><img src="https://habrastorage.org/webt/zr/-n/sy/zr-nsyuedb8wtbakou5rzfnsyo8.png"><br><br>  En cons√©quence, afin de pouvoir traiter les flux de 1000 cam√©ras IP, il est n√©cessaire d'installer 3 serveurs multim√©dias et de r√©partir uniform√©ment la charge entre eux.  Pour cela, un √©quilibreur de charge est utilis√©, qui est connect√© au serveur de m√©dias Wowza Streaming Engine en tant que plug-in <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">AddOn d'√©quilibrage de charge dynamique</a> distinct.  Cela distingue, en fait, l'√©quilibreur de charge (ou <b>serveur d'origine</b> ), qui re√ßoit p√©riodiquement les m√©triques de performance des serveurs de m√©dias finaux (ou <b>serveurs de p√©riph√©rie</b> ) et, sur la base de ces informations, trouve le serveur le moins charg√© dans le cluster. <br><br>  Le contr√¥leur de maison intelligente acc√®de √† l'√©quilibreur via HTTP et re√ßoit en r√©ponse l'adresse IP de ce serveur, √† laquelle le contr√¥leur transmet le flux multim√©dia de la cam√©ra IP via RTMP.  La mesure des performances comprend le nombre de connexions √©tablies avec les sources et les consommateurs de flux multim√©dias et la bande passante actuelle du canal Internet sur le serveur.  Dans les param√®tres de l'√©quilibreur, vous pouvez √©galement sp√©cifier le choix du serveur Edge, en tenant compte de sa position g√©ospatiale, ce qui vous permet d'h√©berger des serveurs dans diff√©rentes villes et pays pour cr√©er un r√©seau distribu√© pour la livraison de contenu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">CDN</a> . <br><br><h2>  Base de donn√©es tactile </h2><br>  Comme mentionn√© pr√©c√©demment dans l'article pr√©c√©dent, les lectures des capteurs Z-Wave, ainsi que l'√©tat actuel et les √©v√©nements des cam√©ras IP sont envoy√©s au format JSON par le contr√¥leur de maison intelligente vers le cloud en utilisant le protocole MQTT.  Le serveur de logique m√©tier d√©code ces messages et ex√©cute la sous-t√¢che <b>StoreSensorDataInfluxDB</b> , qui transmet les donn√©es √† la base de donn√©es tactile via HTTP. <br><br> <a href=""><img src="https://habrastorage.org/webt/14/lv/rv/14lvrvrra0js_mzifmrwszu9c68.png"></a> <br>  <font color="grey">(cliquez sur l'image pour l'ouvrir en plus haute r√©solution)</font> <br><br>  La base de donn√©es des capteurs de la maison intelligente cloud est d√©velopp√©e sur la base d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">InfluxDB 1.7.x</a> - un syst√®me de gestion de base de donn√©es open source pour travailler avec des s√©quences temporelles, qui est utilis√© dans de nombreux projets de l'Internet des objets pour stocker des donn√©es provenant de capteurs et d'analyses.  Les requ√™tes vers la base de donn√©es tactile sont g√©n√©r√©es dans le langage <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">InfluxQL</a> similaire au SQL traditionnel. <br><br>  La dur√©e de stockage des donn√©es dans la maison intelligente cloud est d√©termin√©e par le tarif s√©lectionn√© en fonction du mod√®le utilisateur.  En raison de la diff√©rence significative dans la quantit√© de donn√©es vid√©o et de donn√©es de capteur, leur dur√©e de stockage sera diff√©rente.  La taille de l'archive vid√©o est mesur√©e en jours (7, 14, 30 jours √† des taux diff√©rents) et la taille de l'archive de capteurs est mesur√©e en ann√©es (3, 5, 7 ans, respectivement).  Par cons√©quent, pour chaque contr√¥leur de maison intelligente, lorsqu'il est enregistr√© dans le compte personnel de l'utilisateur, 2 bases de donn√©es distinctes avec diff√©rentes politiques de r√©tention sont cr√©√©es dans la base de donn√©es tactile: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> <span class="hljs-string"><span class="hljs-string">"gateway_6774f85a_0a5b_4059_9b68_************_cameras"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DURATION</span></span> <span class="hljs-number"><span class="hljs-number">720</span></span>h SHARD <span class="hljs-keyword"><span class="hljs-keyword">DURATION</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>h; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> <span class="hljs-string"><span class="hljs-string">"gateway_6774f85a_0a5b_4059_9b68_************_sensors"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DURATION</span></span> <span class="hljs-number"><span class="hljs-number">61320</span></span>h SHARD <span class="hljs-keyword"><span class="hljs-keyword">DURATION</span></span> <span class="hljs-number"><span class="hljs-number">24</span></span>h;</code> </pre><br>  Le backend de l'application cliente est responsable de la cr√©ation, de l'√©dition et de la suppression de la base de donn√©es √† l'int√©rieur de la base de donn√©es tactile.  Par exemple, si un utilisateur du cloud smart home modifie le tarif, le backend envoie les commandes suivantes pour apporter des modifications √† la politique de stockage: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RETENTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">POLICY</span></span> <span class="hljs-string"><span class="hljs-string">"autogen"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-string"><span class="hljs-string">"gateway_6774f85a_0a5b_4059_9b68_************_cameras"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DURATION</span></span> <span class="hljs-number"><span class="hljs-number">168</span></span>h SHARD <span class="hljs-keyword"><span class="hljs-keyword">DURATION</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>h;</code> </pre><br>  Lors de la suppression du contr√¥leur de maison intelligente du compte personnel de l'utilisateur, le backend supprime les bases de donn√©es correspondantes: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> <span class="hljs-string"><span class="hljs-string">"gateway_6774f85a_0a5b_4059_9b68_************_cameras"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> <span class="hljs-string"><span class="hljs-string">"gateway_6774f85a_0a5b_4059_9b68_************_sensors"</span></span>;</code> </pre><br>  √Ä la r√©ception d'un message d'information du contr√¥leur de maison intelligente, le serveur de logique m√©tier ex√©cute une demande d'insertion de donn√©es dans la base de donn√©es tactile: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> device_20873eb0_dd5e_4213_a175_************,<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>=METER,label=Energy,units=kWh value_float=<span class="hljs-number"><span class="hljs-number">0.05</span></span> <span class="hljs-number"><span class="hljs-number">1572194550125</span></span>;</code> </pre><br>  Un exemple de tableau avec les donn√©es des capteurs Z-Wave pour un contr√¥leur domestique intelligent: <br><br><img src="https://habrastorage.org/webt/bc/ic/ht/bcicht3izpojrvpo2bsp2347p5w.png"><br><br>  L'une des fonctionnalit√©s les plus utiles d'une maison cloud est le calcul de statistiques sur la base des donn√©es re√ßues.  L'utilisateur doit conna√Ætre la temp√©rature moyenne de la pi√®ce ou la quantit√© d'√©lectricit√© qu'il a d√©pens√©e par mois. <br><br>  Le langage InfluxQL vous permet d'effectuer des requ√™tes √† l'aide de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">fonctions analytiques</a> .  Par exemple, pour calculer la temp√©rature moyenne d'une semaine, vous devez ex√©cuter la requ√™te suivante: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> MEAN(<span class="hljs-string"><span class="hljs-string">"value_float"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> device_63c660da_f0e8_4eca_8d5f_************ <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> label = <span class="hljs-string"><span class="hljs-string">'Temperature'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> &gt;= <span class="hljs-string"><span class="hljs-string">'2019-10-21T00:00:00.000Z'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> &lt;= <span class="hljs-string"><span class="hljs-string">'2019-10-27T23:59:59.999Z'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>d) fill(<span class="hljs-literal"><span class="hljs-literal">null</span></span>);</code> </pre><br>  Les r√©sultats de cette requ√™te sont pr√©sent√©s dans le tableau: <br><br><img src="https://habrastorage.org/webt/ze/ac/wb/zeacwb7cqvnei_raajemgoebauq.png"><br><br>  Dans le prochain article, enti√®rement consacr√© √† l'application client, nous examinerons en d√©tail le calcul des statistiques pour diff√©rents param√®tres et la construction de tableaux et de graphiques bas√©s sur celui-ci. <br><br>  Dans le syst√®me domestique intelligent cloud, le SGBD InfluxDB est d√©ploy√© sur une machine virtuelle cloud Yandex avec les param√®tres suivants: 4 c≈ìurs vCPU avec une part garantie de 20%, 2 Go de RAM, 100 Go de disque dur.  Selon les calculs de cette configuration, il suffit de stocker les donn√©es des capteurs de 3 000 cam√©ras IP et 5 000 capteurs Z-Wave pendant 7 ans. <br><br><h2>  Conclusion </h2><br>  L'article a examin√© l'architecture d'un service cloud pour une maison intelligente, l'algorithme d'un serveur de logique m√©tier, l'architecture d'un serveur multim√©dia pour l'enregistrement, le stockage et la lecture de flux multim√©dias √† partir de cam√©ras IP, ainsi que l'architecture d'une base de donn√©es tactile pour stocker et analyser les donn√©es de capteurs de maison intelligente.  Le syst√®me de service cloud fonctionne √† la fois sur des serveurs d√©di√©s et virtuels, pour une plus grande stabilit√© situ√©e sur diff√©rents sites d'h√©bergement.  Le syst√®me est actuellement en cours d'essai. <br><br>  Plus les donn√©es stock√©es dans le cloud sont anciennes, moins l'utilisateur y acc√®de.  Dans la prochaine version du service cloud, il est propos√© d'utiliser le m√©canisme d'amincissement (ou de sur√©chantillonnage) des donn√©es √† l'aide d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">InfluxDB Continuous Queries</a> pour r√©duire la quantit√© de donn√©es stock√©es √† l'aide de fonctions d'agr√©gation et, ainsi, augmenter la capacit√© de la base de donn√©es tactile. <br><br><img src="https://habrastorage.org/webt/4x/s-/jl/4xs-jlindsjesrddtgfb8nbstxu.png"><br><br>  De plus, dans la prochaine version du service cloud, un cluster de serveurs de logique m√©tier sera impl√©ment√© selon le principe d'un cluster de serveurs de m√©dias, discut√© dans cet article.  La figure montre l'architecture d'un tel cluster, o√π plusieurs serveurs de p√©riph√©rie (dont chacun a un courtier MQTT distinct et un logiciel de serveur de logique m√©tier) envoient des m√©triques de performances au serveur d'origine, qui calcule l'adresse IP du serveur le moins charg√©.  Cela vous permettra de faire √©voluer le syst√®me dans une plus large mesure et de d√©passer la limite actuelle de 1 000 maisons intelligentes. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr474700/">https://habr.com/ru/post/fr474700/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr474690/index.html">Cr√©ation d'une console √† hauteur variable pour un travail plus pratique sur un ordinateur</a></li>
<li><a href="../fr474692/index.html">Revue Skaffold pour le d√©veloppement de Kubernetes</a></li>
<li><a href="../fr474694/index.html">Comment nous avons s√©lectionn√© et modifi√© le cadre pour les tests de performances</a></li>
<li><a href="../fr474696/index.html">Billet de p√©trole ou billet Rosneft pour Seismic Challenge</a></li>
<li><a href="../fr474698/index.html">Utilisation de fen√™tres modales dans les interfaces utilisateur</a></li>
<li><a href="../fr474702/index.html">Programmation fonctionnelle du point de vue d'EcmaScript. Fonctions pures, lambdas, immunit√©</a></li>
<li><a href="../fr474704/index.html">Interview de Playboy: Steve Jobs, partie 2</a></li>
<li><a href="../fr474706/index.html">Algorithme de recherche floue TextRadar - Approches de base</a></li>
<li><a href="../fr474708/index.html">Internet est plus fragment√© que jamais: o√π plus d'un million de nouveaux utilisateurs ¬´viennent¬ª quotidiennement? Partie 1</a></li>
<li><a href="../fr474710/index.html">c.tech: Frontend Meetup # 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>