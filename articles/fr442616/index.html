<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßïüèª üà¥ üßí Nous acc√©l√©rons le traitement des √©v√©nements √† 1,6 million par seconde üö£ ‚è∞ ‚úèÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Lorsque les participants de HighLoad ++ sont arriv√©s au rapport d' Alexander Krasheninnikov , ils esp√©raient entendre parler du traitement de 1 600 00...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Nous acc√©l√©rons le traitement des √©v√©nements √† 1,6 million par seconde</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/badoo/blog/442616/">  Lorsque les participants de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">HighLoad ++</a> sont arriv√©s au rapport d' <b>Alexander Krasheninnikov</b> , ils esp√©raient entendre parler du traitement de 1 600 000 √©v√©nements par seconde.  Les attentes ne se sont pas r√©alis√©es ... Parce que lors de la pr√©paration de la performance, ce chiffre a vol√© jusqu'√† <b>1 800 000</b> - donc, sur HighLoad ++, la r√©alit√© d√©passe les attentes. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Il y a 3 ans, Alexander a expliqu√©</a> comment il avait construit un syst√®me √©volutif de traitement des √©v√©nements en temps quasi r√©el √† Badoo.  Depuis lors, il a √©volu√©, les volumes ont augment√© dans le processus, il √©tait n√©cessaire de r√©soudre les probl√®mes de mise √† l'√©chelle et de tol√©rance aux pannes, et √† un moment donn√©, des mesures radicales √©taient n√©cessaires - un <b>changement dans la pile technologique</b> . <br><br><img src="https://habrastorage.org/webt/q8/s-/cq/q8s-cqlxfrv8abkdotnudzeq1u8.jpeg"><br><br>  Gr√¢ce au d√©chiffrement, vous apprendrez comment, dans Badoo, vous avez remplac√© le pack Spark + Hadoop par ClickHouse, <b>√©conomis√© 3 fois le mat√©riel et augment√© la charge 6 fois</b> , pourquoi et par quels moyens collecter des statistiques dans le projet, puis quoi faire avec ces donn√©es. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/5KQsNmRTQmg" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  <b>√Ä propos de l'orateur:</b> Alexander Krasheninnikov ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">alexkrash</a> ) - Responsable de l'ing√©nierie des donn√©es chez Badoo.  Il est engag√© dans l'infrastructure BI, la mise √† l'√©chelle des charges de travail et g√®re les √©quipes qui construisent l'infrastructure de traitement des donn√©es.  Il aime tout ce qui est distribu√©: Hadoop, Spark, ClickHouse.  Je suis s√ªr que des syst√®mes distribu√©s sympas peuvent √™tre pr√©par√©s √† partir d'OpenSource. <a name="habracut"></a><br><br><h2>  Collecte de statistiques </h2><br>  Si nous n'avons pas de donn√©es, nous sommes aveugles et ne pouvons pas g√©rer notre projet.  C'est pourquoi nous avons besoin de statistiques - pour <strong>contr√¥ler la viabilit√© du projet.</strong>  En tant qu'ing√©nieurs, nous devons nous efforcer d'am√©liorer nos produits et, si <strong>vous voulez vous am√©liorer, les mesurer.</strong>  C'est ma devise au travail.  Tout d'abord, notre objectif est les avantages commerciaux.  Les statistiques <strong>fournissent des r√©ponses aux questions des entreprises</strong> .  Les m√©triques techniques sont des m√©triques techniques, mais l'entreprise est √©galement int√©ress√©e par les indicateurs, et ils doivent √©galement √™tre pris en consid√©ration. <br><br><h2>  Cycle de vie des statistiques </h2><br>  Je d√©finis le cycle de vie des statistiques par 4 points, dont nous discuterons chacun s√©par√©ment. <br><br><img src="https://habrastorage.org/webt/pp/kb/p5/ppkbp5uw_stwtzdgmakh9z_ffbw.jpeg"><br><br><h2>  D√©finir la phase - Formalisation </h2><br>  Dans l'application, nous collectons plusieurs m√©triques.  Tout d'abord, ce sont <strong>des mesures commerciales</strong> .  Si vous avez un service photo, par exemple, vous vous demandez combien de photos sont t√©l√©charg√©es par jour, par heure, par seconde.  Les m√©triques suivantes sont <strong>¬´semi-techniques¬ª</strong> : r√©activit√© d'une application ou d'un site mobile, travail de l'API, rapidit√© avec laquelle un utilisateur interagit avec un site, installation d'application, UX.  <strong>Le suivi du comportement des utilisateurs</strong> est la troisi√®me mesure importante.  Ce sont des syst√®mes comme Google Analytics et Yandex.Metrics.  Nous avons notre propre syst√®me de suivi cool, dans lequel nous investissons beaucoup. <br><br>  Dans le processus de travail avec les statistiques, de nombreux utilisateurs sont impliqu√©s - ce sont des d√©veloppeurs et des analyses commerciales.  Il est important que tout le monde parle la m√™me langue, vous devez donc √™tre d'accord. <br><br><blockquote>  Il est possible de n√©gocier verbalement, mais c'est beaucoup mieux lorsque cela se produit formellement - dans une structure claire des √©v√©nements. </blockquote><br>  <strong>Formaliser la structure des √©v√©nements commerciaux,</strong> c'est lorsque le d√©veloppeur dit combien d'inscriptions nous avons, l'analyste comprend qu'il a re√ßu des informations non seulement sur le nombre total d'inscriptions, mais aussi par pays, sexe et autres param√®tres.  Et toutes ces informations sont formalis√©es et sont <strong>dans le domaine public pour tous les utilisateurs de l'entreprise</strong> .  L'√©v√©nement a une structure typ√©e et une description formelle.  Par exemple, nous stockons ces informations au format <strong>Protocol Buffers</strong> . <br><br>  Description de l'√©v√©nement "Inscription": <br><br><pre><code class="plaintext hljs">enum Gender { FEMALE = 1; MALE = 2; } message Registration { required int32 userid =1; required Gender usergender = 2; required int32 time =3; required int32 countryid =4; }</code> </pre> <br>  L'√©v√©nement d'enregistrement contient des informations sur l' <strong>utilisateur, le champ, l'heure de l'</strong> √©v√©nement et le <strong>pays d'</strong> enregistrement de l'utilisateur.  Ces informations sont disponibles pour les analystes et, √† l'avenir, l'entreprise comprend ce que nous collectons. <br><br><h3>  Pourquoi ai-je besoin d'une description formelle? </h3><br>  Une description formelle est l' <strong>uniformit√© pour les d√©veloppeurs, les analystes et le service produit.</strong>  Ensuite, ces informations impr√®gnent la description de la logique m√©tier de l'application.  Par exemple, nous avons un syst√®me interne pour d√©crire les processus m√©tier et c'est dans un √©cran que nous avons une nouvelle fonctionnalit√©. <br><br><img src="https://habrastorage.org/webt/qf/cv/hg/qfcvhgvo39rtidli5fxdq65hx2q.jpeg"><br><br>  Dans le <strong>document des exigences</strong> du <strong>produit,</strong> il y a une section avec l'instruction que lorsque l'utilisateur interagit avec l'application de cette mani√®re, nous devons envoyer un √©v√©nement avec exactement les m√™mes param√®tres.  Par la suite, nous serons en mesure de valider le fonctionnement de nos fonctionnalit√©s et de les mesurer correctement.  Une description formelle nous permet de mieux comprendre comment enregistrer ces donn√©es dans une base de donn√©es: NoSQL, SQL ou autres.  Nous avons <strong>un sch√©ma de donn√©es</strong> , et c'est cool. <br><br>  Dans certains syst√®mes analytiques fournis en tant que service, il n'y a que 10 √† 15 √©v√©nements dans le stockage secret.  Dans notre pays, ce nombre a augment√© de plus de 1000 et ne va pas s'arr√™ter - <strong>il est impossible de vivre sans un seul registre</strong> . <br><br><h3>  D√©finir le r√©sum√© de la phase </h3><br>  Nous avons d√©cid√© que les <strong>statistiques - c'est important</strong> et <strong>d√©crit un certain sujet</strong> - c'est bien, vous pouvez vivre. <br><br><h2>  Phase de collecte - collecte de donn√©es </h2><br>  Nous avons d√©cid√© de construire le syst√®me de sorte que lorsqu'un √©v√©nement commercial se produit - enregistrement, envoi d'un message, comme - en m√™me temps que l'enregistrement de ces informations, nous envoyions s√©par√©ment un certain √©v√©nement statistique. <br><br><blockquote>  Dans le code, les statistiques sont envoy√©es simultan√©ment avec l'√©v√©nement commercial. </blockquote><br>  Il est trait√© compl√®tement ind√©pendamment des magasins de donn√©es dans lesquels l'application s'ex√©cute, car le <strong>flux de donn√©es passe par un pipeline de traitement distinct.</strong> <br><br>  Description via EDL: <br><br><pre> <code class="plaintext hljs">enum Gender { FEMALE = 1; MALE = 2; } message Registration { required int32 user_id =1; required Gender user_gender = 2; required int32 time =3; required int32 country_id =4; }</code> </pre> <br>  Nous avons une description de l'√©v√©nement d'inscription.  Une API est g√©n√©r√©e automatiquement, accessible aux d√©veloppeurs √† partir de code, qui en 4 lignes vous permet d'envoyer des statistiques. <br><br>  API bas√©e sur EDL: <br><br><pre> <code class="plaintext hljs">\EDL\Event\Regist ration::create() -&gt;setUserId(100500) -&gt;setGender(Gender: :MALE) -&gt;setTime(time()) -&gt;send();</code> </pre> <br><h3>  Livraison d'√©v√©nement </h3><br>  Ceci est notre syst√®me externe.  Nous le faisons parce que nous avons des services incroyables qui fournissent une API pour travailler avec des donn√©es photo, sur autre chose.  Ils stockent tous des donn√©es dans des bases de donn√©es innovantes, telles que Aerospike et CockroachDB. <br><br>  Lorsque vous avez besoin de cr√©er une sorte de rapport, vous n'avez pas √† vous battre: "Les gars, combien avez-vous et combien?"  - Toutes les donn√©es sont envoy√©es dans un flux s√©par√©.  Convoyeur de traitement - syst√®me externe.  Dans le contexte de l'application, nous d√©lions toutes les donn√©es du r√©f√©rentiel de logique m√©tier et les envoyons vers un pipeline s√©par√©. <br><br>  La phase de collecte suppose la disponibilit√© des serveurs d'applications.  Nous avons ce PHP. <br><br><img src="https://habrastorage.org/webt/az/vo/va/azvova-esx681etff8drvvkigeq.gif"><br><br><h3>  Le transport </h3><br>  Il s'agit d'un sous-syst√®me qui nous permet d'envoyer √† un autre pipeline ce que nous avons fait √† partir du contexte d'application.  Le transport est s√©lectionn√© uniquement selon vos besoins, en fonction de la situation du projet. <br><br>  Le transport a des caract√©ristiques, et le premier est <strong>les garanties de livraison.</strong>  Caract√©ristiques du transport: au moins une fois, exactement une fois, vous choisissez des statistiques pour vos t√¢ches, en fonction de l'importance de ces donn√©es.  Par exemple, pour les syst√®mes de facturation, il est inacceptable que les statistiques montrent plus de transactions qu'il n'y en a - c'est de l'argent, ce n'est pas possible. <br><br>  Le deuxi√®me param√®tre concerne les <strong>liaisons pour les langages de programmation.</strong>  Nous devons en quelque sorte interagir avec le transport, il est donc s√©lectionn√© en fonction de la langue dans laquelle le projet est √©crit. <br><br>  Le troisi√®me param√®tre est l' <strong>√©volutivit√©.</strong>  Comme nous parlons de millions d'√©v√©nements par seconde, il serait bon de garder √† l'esprit la future √©volutivit√©. <br><br>  Il existe de nombreuses options de transport: applications RDBMS, Flume, Kafka ou LSD.  Nous utilisons du <strong>LSD</strong> - c'est notre fa√ßon sp√©ciale. <br><br><h3>  D√©mon de streaming en direct </h3><br>  Le LSD n'a rien √† voir avec les substances interdites.  Il s'agit d'un <strong>d√©mon de streaming tr√®s rapide et dynamique</strong> qui ne fournit aucun agent pour y √©crire.  Nous pouvons le r√©gler, nous avons l' <strong>int√©gration avec d'autres syst√®mes</strong> : HDFS, Kafka - nous pouvons r√©organiser les donn√©es envoy√©es.  Le LSD n'a pas d'appel r√©seau sur INSERT et vous pouvez y contr√¥ler la topologie du r√©seau. <br><br>  Plus important encore, c'est <strong>OpenSource de Badoo</strong> - il n'y a aucune raison de ne pas faire confiance √† ce logiciel. <br><br>  Si c'√©tait un d√©mon parfait, au lieu de Kafka, nous discuterions du LSD √† chaque conf√©rence, mais chaque LSD a une mouche dans la pommade.  Nous avons nos propres limites avec lesquelles nous sommes √† l'aise: nous n'avons <strong>pas de support de r√©plication en LSD</strong> et il a <strong>au moins une</strong> garantie de livraison.  En outre, pour les transactions mon√©taires, ce n'est pas le moyen de transport le plus appropri√©, mais vous devez g√©n√©ralement communiquer avec de l'argent exclusivement via des bases de donn√©es "acides" - prenant en charge <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ACID</a> . <br><br><h3>  R√©capitulatif de la phase de collecte </h3><br>  Sur la base des r√©sultats de la s√©rie pr√©c√©dente, nous avons re√ßu une <strong>description formelle des</strong> donn√©es, g√©n√©r√© une excellente <strong>API</strong> pratique <strong>pour les r√©partiteurs d'√©v√©nements</strong> , et trouv√© comment <strong>transf√©rer</strong> ces donn√©es <strong>du contexte d'application vers un pipeline s√©par√©</strong> .  D√©j√† pas mal, et nous approchons de la prochaine phase. <br><br><h2>  Processus de phase - Traitement des donn√©es </h2><br>  Nous avons collect√© des donn√©es sur les inscriptions, t√©l√©charg√© des photos, des sondages - que faire de tout cela?  √Ä partir de ces donn√©es, nous voulons obtenir des <strong>graphiques</strong> avec une longue histoire et <strong>des donn√©es brutes</strong> .  Les graphiques comprennent tout - vous n'avez pas besoin d'√™tre un d√©veloppeur pour comprendre √† partir de la courbe que les revenus de l'entreprise augmentent.  Nous utilisons des donn√©es brutes pour les rapports en ligne et ad-hoc.  Pour les cas plus complexes, nos analystes souhaitent effectuer des requ√™tes analytiques sur ces donn√©es.  Cela et cette fonctionnalit√© nous sont n√©cessaires. <br><br><h3>  Graphiques </h3><br>  Les graphiques se pr√©sentent sous plusieurs formes. <br><br><img src="https://habrastorage.org/webt/hu/c7/ap/huc7apcxpcajxhc5k3an8ken4wk.jpeg"><br><br>  Ou, par exemple, un graphique avec un historique qui montre les donn√©es sur 10 ans. <br><br><img src="https://habrastorage.org/webt/cq/_z/pc/cq_zpcmcbe2b_nipvwhbtnkme94.jpeg"><br><br>  Les graphiques sont m√™me comme √ßa. <br><br><img src="https://habrastorage.org/webt/rs/76/eg/rs76eg23gglv8m1xlaby2gr8vzg.jpeg"><br><br>  C'est le r√©sultat d'un test AB, et il est √©tonnamment similaire au b√¢timent Chrysler √† New York. <br><br>  Il existe deux fa√ßons de dessiner un graphique: une <strong>requ√™te de donn√©es brutes</strong> et une <strong>s√©rie chronologique</strong> .  Les deux approches pr√©sentent des inconv√©nients et des avantages sur lesquels nous ne nous attarderons pas en d√©tail.  Nous utilisons une <strong>approche hybride</strong> : nous nous tenons √† l'√©cart des donn√©es brutes pour les rapports op√©rationnels et des s√©ries chronologiques pour le stockage √† long terme.  Le second est calcul√© √† partir du premier. <br><br><h3>  Comment nous sommes pass√©s √† 1,8 million d'√©v√©nements par seconde </h3><br>  C'est une longue histoire - des millions de RPS n'arrivent pas en une journ√©e.  Badoo est une entreprise avec une d√©cennie d'histoire, et nous pouvons dire que le syst√®me de traitement des donn√©es a grandi avec l'entreprise. <br><br><img src="https://habrastorage.org/webt/av/o3/04/avo304ko07jkl4szc5dnz2x7zc8.jpeg"><br><br>  Au d√©but, nous n'avions rien.  Nous avons commenc√© √† collecter des donn√©es - il s'est av√©r√© <strong>5000 √©v√©nements par seconde.</strong>  Un h√¥te MySQL et rien d'autre!  N'importe quel SGBD relationnel fera face √† cette t√¢che, et il sera √† l'aise avec cela: vous aurez la transactionnalit√© - mettez les donn√©es, recevez des requ√™tes - tout fonctionne bien et bien.  Nous avons donc v√©cu un certain temps. <br><br>  √Ä un moment donn√©, un partage fonctionnel s'est produit: les donn√©es d'enregistrement - ici et sur les photos - l√†.  Nous avons donc v√©cu jusqu'√† <strong>200 000 √©v√©nements par seconde</strong> et avons commenc√© √† utiliser diverses approches combin√©es: pour stocker non pas des donn√©es brutes, mais <strong>agr√©g√©es</strong> , mais jusqu'√† pr√©sent dans la base de donn√©es relationnelle.  Nous stockons des compteurs, mais l'essence de la plupart des bases de donn√©es relationnelles est telle qu'il sera alors impossible d'ex√©cuter une <strong>requ√™te DISTINCT</strong> sur ces donn√©es - le mod√®le alg√©brique des compteurs ne permet pas de calculer DISTINCT. <br><br>  Chez Badoo, nous avons la devise <strong>¬´Force imparable¬ª</strong> .  Nous n'allions pas nous arr√™ter et grandir davantage.  Au moment o√π nous avons franchi le seuil des <strong>200 000 √©v√©nements par seconde</strong> , nous avons d√©cid√© de cr√©er une description formelle, dont j'ai parl√© plus haut.  Avant cela, il y avait du chaos, et maintenant nous avons un registre structur√© des √©v√©nements: nous avons commenc√© √† faire √©voluer le syst√®me, <strong>Hadoop connect√©</strong> , toutes les donn√©es sont <strong>entr√©es</strong> dans les <strong>tables Hive.</strong> <br><br>  Hadoop est un √©norme progiciel, syst√®me de fichiers.  Pour l'informatique distribu√©e, Hadoop dit: ¬´Mettez les donn√©es ici, je vous laisse effectuer des requ√™tes analytiques sur elles.¬ª  Nous avons donc fait - √©crit un <strong>calcul r√©gulier de tous les graphiques</strong> - cela s'est bien pass√©.  Mais les graphiques sont utiles lorsqu'ils sont mis √† jour rapidement - une fois par jour, regarder une mise √† jour des graphiques n'est pas si amusant.  Si nous d√©ployions quelque chose conduisant √† une erreur fatale sur la production, nous aimerions voir le graphique tomber imm√©diatement, et pas tous les deux jours.  Par cons√©quent, l'ensemble du syst√®me a commenc√© √† se d√©grader apr√®s un certain temps.  Cependant, nous avons r√©alis√© qu'√† ce stade, vous pouvez vous en tenir √† la pile technologique s√©lectionn√©e. <br><br><blockquote>  Pour nous, Java √©tait nouveau, nous l'avons aim√© et nous avons compris ce qui pouvait √™tre fait diff√©remment. </blockquote><br>  Au stade de 400 000 √† <strong>800 000 √©v√©nements par seconde</strong> , nous avons remplac√© Hadoop dans sa forme la plus pure et Hive, car l'ex√©cuteur des requ√™tes analytiques, avec <strong>Spark Streaming</strong> , a √©crit une <strong>carte g√©n√©rique / r√©duire</strong> et un calcul incr√©mentiel des m√©triques.  Il y a 3 ans, j'ai <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">racont√©</a> comment nous l'avons fait.  Ensuite, il nous a sembl√© que Spark vivrait √©ternellement, mais la vie en a d√©cid√© autrement - nous avons rencontr√© les limites de Hadoop.  Peut-√™tre que si nous avions d'autres conditions, nous continuerions √† vivre avec Hadoop. <br><br>  Un autre probl√®me, en plus du calcul des graphiques sur Hadoop, √©tait les incroyables requ√™tes SQL √† quatre √©tages qui √©taient conduites par les analystes, et les graphiques n'√©taient pas mis √† jour rapidement.  Le fait est qu'il y a un travail assez d√©licat avec le traitement des donn√©es op√©rationnelles, de sorte qu'il est en temps r√©el, rapide et cool. <br><br>  Badoo est desservi par deux centres de donn√©es situ√©s des deux c√¥t√©s de l'oc√©an Atlantique - en Europe et en Am√©rique du Nord.  Pour cr√©er un rapport unifi√©, vous devez envoyer des donn√©es d'Am√©rique vers l'Europe.  C'est dans le centre de donn√©es europ√©en que nous conservons toutes les statistiques statistiques, car il y a plus de puissance de calcul.  <strong>Un aller</strong> - <strong>retour</strong> entre les centres de donn√©es d'environ <strong>200 ms</strong> - le r√©seau est assez d√©licat - faire une demande √† un autre contr√¥leur de domaine n'est pas la m√™me chose que d'aller au rack suivant. <br><br>  Lorsque nous avons commenc√© √† formaliser les √©v√©nements et les d√©veloppeurs, et que les chefs de produit se sont impliqu√©s, tout le monde a tout aim√© - il y avait juste une <strong>croissance explosive des √©v√©nements</strong> .  √Ä cette √©poque, il √©tait temps d'acheter du fer dans le cluster, mais nous ne voulions pas vraiment le faire. <br><br>  Lorsque nous avons d√©pass√© le pic de <strong>800 000 √©v√©nements par seconde</strong> , nous avons d√©couvert ce que Yandex avait t√©l√©charg√© sur OpenSource <strong>ClickHouse</strong> et <strong>avons</strong> d√©cid√© de l'essayer.  <strong>Ils ont rempli un train de c√¥nes</strong> pendant qu'ils essayaient de faire quelque chose, et en cons√©quence, quand tout a fonctionn√©, ils ont fait un petit buffet au sujet du premier million d'√©v√©nements.  Probablement, ClickHouse aurait pu terminer le rapport. <br><br><blockquote>  Prenez ClickHouse et vivez avec. </blockquote><br>  Mais ce n'est pas int√©ressant, nous allons donc continuer √† parler de traitement des donn√©es. <br><br><h3>  Clickhouse </h3><br>  ClickHouse est un battage m√©diatique des deux derni√®res ann√©es et n'a pas besoin d'√™tre introduit: seulement dans HighLoad ++ en 2018, je me souviens d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">environ cinq rapports</a> √† ce sujet, ainsi que de s√©minaires et de r√©unions. <br><br>  Cet outil est con√ßu pour r√©soudre exactement les t√¢ches que nous nous fixons.  Il existe des <strong>mises √† jour</strong> et des puces en <strong>temps r√©el</strong> que nous avons re√ßues √† un moment donn√© de Hadoop: r√©plication, partitionnement.  Il n'y avait aucune raison de ne pas essayer ClickHouse, car ils comprenaient qu'avec l'impl√©mentation sur Hadoop, nous avions d√©j√† cass√© le fond.  L'outil est cool, et la documentation est g√©n√©ralement du feu - j'y ai √©crit moi-m√™me, j'aime vraiment tout, et tout est super.  Mais nous avons d√ª r√©soudre un certain nombre de probl√®mes. <br><br>  <strong>Comment d√©placer l'int√©gralit√© du flux d'√©v√©nements dans ClickHouse?</strong>  <strong>Comment combiner les donn√©es de deux centres de donn√©es?</strong>  Du fait que nous sommes venus aux administrateurs et avons dit: "Les gars, installons ClickHouse", ils ne rendront pas le r√©seau deux fois plus √©pais, et le retard est moiti√© moins.  Non, le r√©seau est toujours aussi mince et petit que le premier salaire. <br><br>  <strong>Comment conserver les r√©sultats</strong> ?  Chez Hadoop, nous avons compris comment dessiner des graphiques - mais comment le faire sur la ClickHouse magique?  La baguette magique n'est pas incluse.  <strong>Comment fournir des r√©sultats</strong> au stockage de s√©ries chronologiques? <br><br>  Comme mon professeur √† l'institut l'a dit, consid√©rez 3 sch√©mas de donn√©es: strat√©gique, logique et physique. <br><br><h4>  Sch√©ma de stockage strat√©gique </h4><br>  Nous avons <strong>2 centres de donn√©es</strong> .  Nous avons appris que ClickHouse ne sait rien des contr√¥leurs de domaine et nous avons simplement ajout√© le cluster dans chaque contr√¥leur de domaine.  Maintenant, les <strong>donn√©es ne transitent pas par le c√¢ble transatlantique</strong> - toutes les donn√©es qui se sont produites dans le contr√¥leur de domaine sont stock√©es localement dans son cluster.  Lorsque nous voulons faire une demande sur les donn√©es combin√©es, par exemple, pour savoir combien d'inscriptions sont dans les deux contr√¥leurs de domaine, ClickHouse nous donne cette opportunit√©.  Faible latence et disponibilit√© pour la demande - juste un chef-d'≈ìuvre! <br><br><img src="https://habrastorage.org/webt/mr/dc/-2/mrdc-205rzloz1c2oemavnikcxu.jpeg"><br><br><h4>  Sch√©ma de stockage physique </h4><br>  Encore une fois, des questions: comment nos donn√©es entreront-elles dans le mod√®le relationnel ClickHouse, que faire pour ne pas perdre la r√©plication et le sharding?  Tout est largement d√©crit dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation ClickHouse</a> , et si vous avez plusieurs serveurs, vous rencontrerez cet article.  Par cons√©quent, nous ne nous pencherons pas sur ce qui est dans le manuel: r√©plications, partitionnement et requ√™tes sur toutes les donn√©es sur les fragments. <br><br><h4>  Logique de stockage </h4><br>  Le diagramme logique est le plus int√©ressant.  Dans un pipeline, nous traitons des √©v√©nements h√©t√©rog√®nes.  Cela signifie que nous avons un <strong>flux d'√©v√©nements h√©t√©rog√®nes</strong> : enregistrement, voix, t√©l√©chargement de photos, mesures techniques, suivi du comportement des utilisateurs - tous ces √©v√©nements ont <strong>des attributs</strong> compl√®tement <strong>diff√©rents</strong> .  Par exemple, j'ai regard√© l'√©cran sur un t√©l√©phone mobile - j'ai besoin d'un identifiant d'√©cran, j'ai vot√© pour quelqu'un - vous devez comprendre si le vote √©tait pour ou contre.  Tous ces √©v√©nements ont des attributs diff√©rents, diff√©rents graphiques sont dessin√©s dessus, mais tout cela doit √™tre trait√© dans un seul pipeline.  Comment le mettre dans le mod√®le ClickHouse? <br><br>  <strong>Approche n ¬∞ 1 - par table d'√©v√©nements.</strong>  Cette premi√®re approche, nous avons extrapol√© √† partir de l'exp√©rience acquise avec MySQL - nous avons cr√©√© une <strong>tablette pour chaque √©v√©nement</strong> dans ClickHouse.  Cela semble assez logique, mais nous avons rencontr√© un certain nombre de difficult√©s. <br><br>  Nous n'avons aucune restriction quant au fait que l'√©v√©nement changera de structure lorsque la version d'aujourd'hui sera publi√©e.  Ce patch peut √™tre r√©alis√© par n'importe quel d√©veloppeur.  Le sch√©ma est g√©n√©ralement modifiable dans toutes les directions.  Le seul <strong>champ obligatoire</strong> est l' <strong>√©v√©nement d'horodatage</strong> et ce qu'√©tait l'√©v√©nement.  Tout le reste change √† la vol√©e et, en cons√©quence, ces plaques doivent √™tre modifi√©es.  ClickHouse a la capacit√© d'effectuer <strong>ALTER sur un cluster</strong> , mais c'est une proc√©dure d√©licate d√©licate qui est difficile √† automatiser pour le faire fonctionner en douceur.  Par cons√©quent, c'est un inconv√©nient. <br><br>  Nous avons plus d'un millier d'√©v√©nements diff√©rents, ce qui nous donne un <strong>taux d'insertion √©lev√© par machine</strong> - nous enregistrons constamment toutes les donn√©es dans mille tableaux.  Pour ClickHouse, il s'agit d'un anti-motif.  Si Pepsi a le slogan - "Live in big sips", alors ClickHouse - <strong>"Live in big batch"</strong> .  Si cela n'est pas fait, la r√©plication est √©touff√©e, ClickHouse refuse d'accepter de nouvelles insertions - un sch√©ma d√©sagr√©able. <br><br>  <strong>Approche n ¬∞ 2 - une large table</strong> .  Des hommes sib√©riens ont tent√© de glisser la tron√ßonneuse sur le rail et d'appliquer un mod√®le de donn√©es diff√©rent.  Nous faisons un tableau avec <strong>mille colonnes</strong> , o√π chaque √©v√©nement a des colonnes r√©serv√©es √† ses donn√©es.  Nous obtenons une √©norme <strong>table clairsem√©e</strong> - heureusement, cela ne va pas au-del√† de l'environnement de d√©veloppement, car d√®s les premiers inserts, il est devenu clair que le sch√©ma est absolument mauvais, et nous ne le ferons pas. <br><br>  Mais je veux toujours utiliser un produit logiciel aussi cool, un peu plus pour terminer - et ce sera ce dont vous avez besoin. <br><br>  <strong>Approche n ¬∞ 3 - tableau g√©n√©rique.</strong>  Nous avons une √©norme table dans laquelle nous stockons les donn√©es dans des tableaux, car ClickHouse prend en charge <strong>les types de donn√©es non scalaires</strong> .  Autrement dit, nous commen√ßons une colonne dans laquelle les noms des attributs sont stock√©s, et une colonne distincte avec un tableau dans lequel les valeurs des attributs sont stock√©es. <br><br><img src="https://habrastorage.org/webt/ot/s3/ro/ots3ronbcjh69ssxujqvbuxeghc.jpeg"><br><br>  ClickHouse ici remplit tr√®s bien sa t√¢che.  Si nous n'avions qu'√† ins√©rer des donn√©es, nous serions probablement extirper 10 fois de plus dans l'installation actuelle. <br><br>  Cependant, la mouche dans la pommade est qu'elle est √©galement un anti-mod√®le pour ClickHouse - <strong>pour stocker des tableaux de cha√Ænes</strong> .  C'est mauvais car les tableaux de lignes <strong>occupent plus d'espace disque</strong> - ils r√©tr√©cissent moins que les colonnes simples et sont <strong>plus difficiles √† traiter</strong> .  Mais pour notre t√¢che, nous fermons les yeux sur cela, car les avantages l'emportent. <br><br>  Comment faire SELECT √† partir d'une telle table?  Notre t√¢che consiste √† compter les inscriptions group√©es par sexe.  Vous devez d'abord trouver dans un tableau quelle position correspond √† la colonne genre, puis monter dans une autre colonne avec cet index et obtenir les donn√©es. <br><br><img src="https://habrastorage.org/webt/gh/pw/ek/ghpwekgjjrr0eisi8_zjmoi48tk.jpeg"><br><br><h4>  Comment dessiner des graphiques sur ces donn√©es </h4><br>  √âtant donn√© que tous les √©v√©nements sont d√©crits, ils ont une structure stricte, nous formons une requ√™te SQL √† quatre √©tages pour chaque type d'√©v√©nement, l'ex√©cutons et enregistrons les r√©sultats dans une autre table. <br><br>  Le probl√®me est que pour dessiner deux points adjacents sur le graphique, vous devez <strong>num√©riser la table enti√®re</strong> .  Exemple: nous regardons l'inscription par jour.  Cet √©v√©nement va de la premi√®re ligne √† l'avant-derni√®re.  Num√©ris√© une fois - excellent.  Apr√®s 5 minutes, nous voulons dessiner un nouveau point sur le graphique - encore une fois, nous analysons la plage de donn√©es qui croise avec l'analyse pr√©c√©dente, et ainsi de suite pour chaque √©v√©nement.  Cela semble logique, mais √ßa n'a pas l'air g√©nial. <br><br>  De plus, lorsque nous prenons certaines lignes, nous devons √©galement <strong>lire les r√©sultats sous agr√©gation</strong> .  Par exemple, il est un fait que le serviteur de Dieu √©tait enregistr√© en Scandinavie et √©tait un homme, et nous devons calculer les statistiques sommaires: combien d'inscriptions, combien d'hommes, combien d'entre eux sont des personnes et combien sont de Norv√®ge.  Cela s'appelle en termes de bases de donn√©es analytiques <strong>ROLLUP, CUBE</strong> et <strong>GROUPING SETS</strong> - transformez une ligne en plusieurs. <br><br><h4>  Comment traiter </h4><br>  Heureusement, ClickHouse dispose d'un outil pour r√©soudre ce probl√®me, √† savoir l' <strong>√©tat s√©rialis√© des fonctions d'agr√©gation</strong> .  Cela signifie que vous pouvez num√©riser une fois une donn√©e et enregistrer ces r√©sultats.  Ceci est une <strong>fonctionnalit√© qui tue</strong> .  Il y a 3 ans, nous avons fait exactement cela sur Spark et Hadoop, et c'est cool qu'en parall√®le avec nous, les meilleurs esprits Yandex aient impl√©ment√© un analogue dans ClickHouse. <br><br><h4>  Demande lente </h4><br>  Nous avons une demande lente - compter les utilisateurs uniques pour aujourd'hui et hier. <br><br><pre> <code class="plaintext hljs">SELECT uniq(user_id) FROM table WHERE dt IN (today(), yesterday())</code> </pre> <br>  Dans le plan physique, nous pouvons faire SELECT pour l'√©tat d'hier, obtenir sa repr√©sentation binaire, l'enregistrer quelque part. <br><br><pre> <code class="plaintext hljs">SELECT uniq(user_id), 'xxx' AS ts, uniqState(user id) AS state FROM table WHERE dt IN (today(), yesterday())</code> </pre> <br>  Pour aujourd'hui, nous modifions simplement la condition qu'il sera aujourd'hui: <code>'yyy' AS ts</code> et <code>WHERE dt = today()</code> et horodatage que nous appellerons ¬´xxx¬ª et ¬´yyy¬ª.            ,        ,    2 . <br><br><pre> <code class="plaintext hljs">SELECT uniqMerge(state) FROM ageagate_table WHERE ts IN ('xxx', 'yyy')</code> </pre> <br><h4>   </h4><br>  : <br><br><ul><li>    ,       ; </li><li>       ; </li><li>  . </li></ul><br>         ,   -      .     <strong>    </strong> .    ,     ,  ,   ,       ClickHouse,  : ¬´,      ! ,    !¬ª <br><br><h4>     </h4><br>   ,      ,    .      <strong>  ,</strong>          .    .    ‚Äî     SQL-,       . ,        ,      . <br><br><img src="https://habrastorage.org/webt/df/0b/o6/df0bo6pb7l6t94sxnrwtpctfcxk.jpeg"><br><br>     ,   -  time series.      :      ,  ,      ,    time series. <br><br>   time series    :   ,    ,    timestamp       .        ,    ,    .              .   ,        ,       ,      ‚Äî  ,    . ,     ,   ClickHouse  -,     ,     . <br><br>      ,       ,      ClickHouse: <br><br><blockquote> ‚Äî    ¬´ ¬ª,    ‚Äî      . </blockquote><br>     time series  2 ,     20   20-80 .   .  ClickHouse   <strong>GraphiteMergeTree</strong> ,    time series,      . <br><br><h4>    </h4><br> <strong>8  ClickHouse</strong> ,   6  -  ,  2  :    2 ‚Äî     ,    . <strong>  1.8 .   </strong>  ,     <strong>500</strong> <strong>   </strong> . ,   1,8 ,       500 !       . <br><br><h3>    Hadoop </h3><br> <strong>   2 </strong> .          .     <strong>3 </strong> ,   CPU ‚Äî  <strong>4</strong> .  ,        . <br><br><h3>   Process </h3><br>     <strong>   </strong> , ,   ,        .   ,    ,    ClickHouse    3 000   . ,  ,   ,      overkill. <br><br>   ,   ,     .   ClickHouse,   <strong>   </strong> . ,  ,   ,    .   ,  8      3‚Äì4     .  ‚Äî     . <br><br><h2>  Present ‚Äî    </h2><br>      ,     ?   time series,     <strong>  time series</strong> ,           ,   ,   . <br><br><img src="https://habrastorage.org/webt/82/uo/qq/82uoqq4jw6amtxph_jgcjpjnwkm.jpeg"><br><br> <strong>Drop Detect ‚Äî    SQL</strong> :  SQL-    ,     ,      . <br><br><img src="https://habrastorage.org/webt/ru/1v/up/ru1vuporiqj-suncjyc-sh06xrk.jpeg"><br><br>     <strong>Anomaly Detection</strong> ‚Äî      .    ,  ,       2%   ,    ‚Äî   40,    ,     ,        ,    . <br><br>    ‚Äî   ,  ,   - ,    Anomaly Detection. <br><br><h3> Anomaly Detection </h3><br>  ,   time series .    : ,  ,    .   time series     <strong></strong> .  ,       ,  .    ,   <strong>drop detection</strong> ‚Äî       ,  . <br><br>     UI. <br><br><img src="https://habrastorage.org/webt/sk/mg/hn/skmghn7mirsubwu-vpm2dq5tols.jpeg"><br><br>    .  -  ,       ‚Äî  .    -,  . <br><br><h3>   Present </h3><br>    ,      ,     <strong> </strong> .     <strong> </strong>    ,   :     1000 ‚Äî alarm,     0 ‚Äî alarm.    . <br><br>   <strong>Anomaly Detection</strong>    ,    .    Anomaly Detection     <strong>Exasol</strong> ,        ClickHouse.        Anomaly Detection  2 ,   . <br><br><h2>   </h2><br>  ,  ,  4    . <br><br>  , <strong>  </strong>  ,     ,     .  , <strong>    </strong> ,      . ,  <strong>    </strong> <strong> </strong> . <br><br><blockquote>     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">HighLoad++</a>  ,    HighLoad++    -       .        ,        , <strong>    </strong> :) <br><br>  ,    <u><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">PHP Russia</a></u> ,  ,       .  , ,   ,      1,8 /,     ,      1 . </blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr442616/">https://habr.com/ru/post/fr442616/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr442606/index.html">Objet de domaine avec Lombok: Battle Classic</a></li>
<li><a href="../fr442608/index.html">Les portefeuilles froids de l'√©change de crypto-monnaie QuadrigaCX, dont le fondateur est d√©c√©d√©, se sont av√©r√©s vides</a></li>
<li><a href="../fr442610/index.html">T√©l√©gramme-bot + Google Analytics</a></li>
<li><a href="../fr442612/index.html">Moteur en carton pour un jeu de soci√©t√© √©lectrique. Comment nous l'avons rapproch√© de la r√©alit√©</a></li>
<li><a href="../fr442614/index.html">CI / CD utilisant Jenkins sur Kubernetes</a></li>
<li><a href="../fr442618/index.html">Pas pour le selfie: test immuno-enzymatique num√©rique utilisant une nouvelle puce int√©gr√©e dans un smartphone</a></li>
<li><a href="../fr442620/index.html">Apprentissage automatique dans la surveillance informatique</a></li>
<li><a href="../fr442622/index.html">Comment rendre les coroutines dans Unity un peu plus pratiques</a></li>
<li><a href="../fr442624/index.html">Le livre ¬´Algorithme parfait. Les bases</a></li>
<li><a href="../fr442626/index.html">Habraiting: construction d'un nuage de mots russophones sur l'exemple des en-t√™tes Habra</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>