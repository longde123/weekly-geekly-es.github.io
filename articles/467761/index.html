<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§® üë©üèæ‚Äçüç≥ ‚úãüèæ Energ√≠a, calor y agua, tercera parte: ve a la radio üë®‚Äçüé§ üë©üèΩ‚Äçüî¨ ü§ß</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Entrada 
 En el proceso de elegir soluciones para un hogar inteligente, trato de evitar soluciones en caja que requieren comunicaci√≥n con nubes extern...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Energ√≠a, calor y agua, tercera parte: ve a la radio</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/467761/"><h2>  Entrada </h2><br>  En el proceso de elegir soluciones para un hogar inteligente, trato de evitar soluciones en caja que requieren comunicaci√≥n con nubes externas o tienen sus propias aplicaciones, especialmente soluciones sin la capacidad de conectarse directamente al dispositivo.  Todas las m√©tricas disponibles se reducen a una interfaz: zabbix, donde se organiza un sistema de alerta para las partes interesadas.  Las perillas de control se implementan en una interfaz web localmente localizada. <br><br><h2>  Art√≠culos anteriores: </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">primera parte</a> (1 temperatura del cable, ups, medidor de agua ...) <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">segunda parte</a> (redes, gidrolock, sensores de presi√≥n ...) <br><br><h2>  Tareas resueltas en este art√≠culo </h2><br><ul><li>  Protecci√≥n de fugas de agua flexible y escalable con alerta zabbix </li><li>  Otros dispositivos a 433 mhz: campana, puerta abierta, etc. </li><li>  Empujamos 1 cable en MQTT </li></ul><br><h2>  Sistema de protecci√≥n contra fugas </h2><br><h3>  Requerimientos del sistema: </h3><br><ul><li>  muchos sensores dispersos por la casa (en mi caso, 6 piezas en diferentes lugares) </li><li>  sin cables en los sensores </li><li>  apagado r√°pido al detectar fugas </li><li>  toda la informaci√≥n del estado actual en zabbix.  Hay una alerta </li></ul><br><h3>  Composici√≥n del sistema </h3><br><ul><li>  Raspberry PI </li><li>  Sintonizador USB RTL2832U </li><li>  Sensores de fugas 433mhz </li><li>  Red + gr√∫a gidrolock (ver art√≠culo anterior) para apagar el maletero </li></ul><a name="habracut"></a><br><h3>  Sobre el hierro </h3><br>  En un art√≠culo anterior, describ√≠ la soluci√≥n de cerrar el suministro de agua usando una red.  Tengo un sensor con cable para esta soluci√≥n.  Esto es conveniente si todos los puntos donde pueden ocurrir fugas est√°n aproximadamente en el mismo lugar.  En mi caso, la red se instala directamente en la entrada de la carretera y controla la gr√∫a electromec√°nica gidrolock en el mismo lugar (ver el art√≠culo anterior).  La red de dispersi√≥n + gidrolock + sensor con cable en todos los puntos es costosa y engorrosa.  Adem√°s, ya no tengo la oportunidad de arrastrar nuevos cables por la casa.  Ocupar enchufes y respirar gr√∫as el√©ctricas es una soluci√≥n regular.  La soluci√≥n esperada: utilizamos la superposici√≥n de la autopista com√∫n en funci√≥n de las se√±ales de los sensores de radio distribuidos por las ubicaciones. <br>  De lo que se encontr√≥ en Internet: un mont√≥n de diferentes sensores de radio de sistemas prefabricados.  Algunos se pueden comprar por separado, no compr√© controladores para sensores, para no producir elementos adicionales en el circuito. <br><br>  ¬øC√≥mo puedo atrapar 433mhz?  Resulta que un sintonizador de TV en un chipset espec√≠fico.  Y ahora vale un centavo (asum√≠ Avito por 300r) as√≠: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b84/efb/7c8/b84efb7c88ad3e4a89edbb470a653843.png" alt="imagen"><br><br>  Ped√≠ una antena separada para ella en 12dbi, porque la actual no cubr√≠a toda la casa. <br><br>  Como intent√© minimizar los componentes de control del circuito, hab√≠a un deseo de apretar el sintonizador en el enrutador de mi casa con Openwrt, que hasta ahora era el n√∫cleo de la soluci√≥n de casa inteligente para 1 cable, modbus, sensores / protocolos wifi, pero, desafortunadamente, agot√© algunos de sus recursos ( el espacio en la unidad flash incorporada para el software necesario termina, el procesador se carga con algo: ya habr√° problemas con la red y todav√≠a tenemos 4k para buscar en l√≠nea :), + ya hay demasiadas cosas colgadas en USB, lo que afecta la estabilidad de la recopilaci√≥n de datos).  Se decidi√≥ transferir gradualmente la funcionalidad de la casa inteligente a un dispositivo externo: rarpberry pi (una de las primeras versiones disponible). <br><br><h3>  Sobre el software </h3><br>  Despu√©s de jugar con un sintonizador de TV sdr-sharp en una computadora de escritorio con ventanas (despu√©s de haber intentado captar las negociaciones de radios y aviones de otras personas), comenc√© a ver si los sensores mismos vieron el "silbato".  S√≠, se ve perfectamente: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/37e/68a/4d6/37e68a4d69b575f74e47db6ae45b0d4b.jpg" alt="imagen"><br><br><h4>  Ajuste de frambuesa </h4><br>  Eleg√≠ raspbian nativo.  Escrib√≠ la √∫ltima imagen en la unidad flash USB en mac / linux: <br><br><pre><code class="bash hljs">sudo dd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=2019-07-10-raspbian-buster-lite.img of=/dev/disk2 bs=1048576 conv=sync</code> </pre> <br>  Arranque, configure la red y ssh. <br><br>  A continuaci√≥n, coloque los paquetes de frambuesa rtl-sdr, rtl_433: <br><br><pre> <code class="bash hljs">sudo apt-get install cmake build-essential python-pip libusb-1.0-0-dev libusb-1.0 python-numpy git git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/merbanan/rtl_433.git <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> rtl_433/ mkdir build <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> build cmake .. make make install</code> </pre> <br>  rtl_433 tiene protocolos incorporados que descifran datos de diferentes dispositivos que operan en el rango de 433mhz. <br><br><h4>  Comenzamos rtl_433 </h4><br><pre> <code class="bash hljs">rtl_433 -f 433.9e6</code> </pre> <br>  Bajamos los sensores al agua y obtenemos lo que m√°s apreciamos: <br><br><pre> <code class="bash hljs">time : 2019-09-17 15:04:39 model : Smoke detector GS 558 id : 16919 unit : 1 learn : 0 Raw Code : c842e1</code> </pre><br>  Detector de humo?  Ok, pongamos la canci√≥n "Smoke on the water" en la alerta de estos sensores ... :) <br>  Pero en serio: tenemos la identificaci√≥n de cada sensor, de acuerdo con la cual en el futuro entenderemos exactamente d√≥nde tenemos una fuga (y nos desconectaremos en cualquier caso). <br><br><h4>  Acerca de los sensores de fugas </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/47a/255/60d/47a25560dd09554b0749dc171502c71b.png" alt="imagen"><img src="https://habrastorage.org/getpro/habr/post_images/710/dd8/917/710dd891751f85699ed64c30b180c443.png" alt="imagen"><img src="https://habrastorage.org/getpro/habr/post_images/b56/f4b/a31/b56f4ba310bd674da8b16171c5112806.png" alt="imagen"><br><br>  Despu√©s de configurar la parte del software, not√© que los sensores con aliexpress (foto izquierda) env√≠an una sola se√±al cuando el agua entra en los contactos.  Adem√°s de una sola se√±al si el agua deja de cerrar los contactos.  Esto no me conviene de ninguna manera (comportamiento esperado: env√≠a constantemente una se√±al de alarma cuando el sensor detecta agua, ya que puede perderse una sola se√±al).  Se observa un comportamiento similar si cierra los contactos con un cable.  Pero lo que es extra√±o: la alarma se produce cada 2-3 segundos, si cierra los contactos con las manos (piel).  Aqu√≠ todav√≠a tengo dos suposiciones: o los chinos se equivocaron con las mediciones de resistencia, o los sensores tienen alg√∫n otro modo de operaci√≥n en el que se comportan de manera diferente (por ejemplo, emparejado con un controlador), o hay otras frecuencias (hasta que encontr√© ) <br><br>  <i>Por cierto, escriba en los comentarios, tal vez alguien trabaj√≥ con estos sensores, ¬øse les puede "ense√±ar" de alguna manera a enviar una se√±al sobre una fuga constantemente?</i> <br><br>  Puse estos sensores a un lado, en el arsenal hab√≠a otro de rubetek (foto de la derecha) y compr√© en Leroy: GAL SHW-1005 (foto del medio). <br><br>  El comportamiento del sensor rubetek parec√≠a completamente impredecible (la reacci√≥n impredecible "ve agua / no ve"). <br><br>  Pero el sensor de Leroy en movimiento mostr√≥ exactamente lo que necesitaba: hay agua, lo env√≠o al aire, no hay agua, estoy en silencio.  Su √∫nico inconveniente es un radio de acci√≥n m√°s peque√±o que otros sensores.  Pero el problema se resolvi√≥ comprando una antena m√°s sensible para el receptor. <br><br><h4>  MQTT </h4><br>  ¬øC√≥mo enviar la salida rtl_433 a zabbix?  ¬øAlimentar al agente?  ¬øEnviar a zabbix_sender, analizando el proceso?  Tal vez a trav√©s de syslog? <br><br>  Aqu√≠ debes recordar que mi zabbix est√° en alg√∫n lugar de las nubes.  Y ciertamente no es necesario bloquear el agua con la ayuda de sus desencadenantes.  El piso de la casa se inundar√° hasta que tome una decisi√≥n (si est√° disponible). <br><br>  La buena noticia es que rtl_433 puede enviar informaci√≥n sobre MQTT.  Fuera de la caja  Al mismo tiempo, los datos se env√≠an al corredor en formato json. <br><br>  Entonces necesitas: <br><br><ul><li>  Coloque un agente local de mosquitto (h√°galo en la frambuesa). </li><li>  Combine la informaci√≥n en el intermediario con el tema deseado, para que luego pueda analizarse. </li><li>  Con√©ctese al agente localmente en la frambuesa y env√≠e comandos a la red </li><li>  Con√©ctese al agente desde el lugar donde tendr√° lugar la redirecci√≥n a zabbix (el servidor de zabbix en mi caso tambi√©n es un cliente MQTT) </li></ul><br><h4>  Instalaci√≥n-configuraci√≥n mosquitto MQTT: </h4><br><pre> <code class="bash hljs">apt-get install mosquitto mosquitto-clients systemctl <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> mosquitto systemctl start mosquitto</code> </pre> <br><h4>  Enviamos informaci√≥n al corredor indicando la identificaci√≥n del dispositivo: </h4><br><pre> <code class="bash hljs">rtl_433 -f 433.88e6 -F mqtt://127.0.0.1,events=/433/[id]</code> </pre> <br>  En el cliente mqtt obtendremos algo como lo siguiente: <br><br><pre> <code class="bash hljs">mosquitto_sub -h 127.0.0.1 -t <span class="hljs-string"><span class="hljs-string">'#'</span></span> (   ) /433/16919 {<span class="hljs-string"><span class="hljs-string">"time"</span></span>:<span class="hljs-string"><span class="hljs-string">"2019-09-18 11:55:29"</span></span>,<span class="hljs-string"><span class="hljs-string">"model"</span></span>:<span class="hljs-string"><span class="hljs-string">"Smoke detector GS 558"</span></span>,<span class="hljs-string"><span class="hljs-string">"id"</span></span>:16919,<span class="hljs-string"><span class="hljs-string">"unit"</span></span>:1,<span class="hljs-string"><span class="hljs-string">"learn"</span></span>:0,<span class="hljs-string"><span class="hljs-string">"code"</span></span>:<span class="hljs-string"><span class="hljs-string">"c842e1"</span></span>}</code> </pre> <br><h4>  Script para conectarse al intermediario y enviar el comando a netping </h4><br>  Esboc√© un simple cliente de script MQTT que le permite ejecutar el script asociado con el tema cuando aparece el tema especificado en la configuraci√≥n.  Por lo tanto, cuando se activa un determinado sensor y aparece informaci√≥n sobre √©l en el aire (por ejemplo, / 433/16919), puede realizar alguna acci√≥n (en el caso de una red, env√≠e una solicitud de rizo para cerrar la gr√∫a, consulte el art√≠culo anterior).  Un enlace al gui√≥n se encuentra al final del art√≠culo. <br><br><h4>  Redirecci√≥n en zabbix </h4><br>  Us√© la soluci√≥n mqtt-zabbix preparada.  En su nivel, entendemos en qu√© elemento enviar el valor (por id). <br><br>  En keys.cfg, especifique: <br><br><pre> <code class="bash hljs">/433/16919,mqtt.ventilation.waterleak::hostname</code> </pre> <br>  donde hostname es el nombre de host con el tipo de vagabundo del elemento en Zabbix. <br><br>  Importante !!!  El nombre de host en la configuraci√≥n debe corresponder al nombre que se enviar√° en el script, el tipo de elemento (elemento de datos) debe ser adecuado para los datos que se env√≠an (por ejemplo, para json - texto), de lo contrario, detectar√° errores de la forma: <br><br><pre> <code class="bash hljs">2019-09-18 14:29:48,749 Got response from Zabbix: {u<span class="hljs-string"><span class="hljs-string">'info'</span></span>: u<span class="hljs-string"><span class="hljs-string">'processed: 0; failed: 1; total: 1; seconds spent: 0.000055'</span></span>, u<span class="hljs-string"><span class="hljs-string">'response'</span></span>: u<span class="hljs-string"><span class="hljs-string">'success'</span></span>}</code> </pre> <br>  Adem√°s, es dif√≠cil lograr m√°s depuraci√≥n (y por qu√© fall√≥) de zabbix. <br><br>  Configuramos /etc/mqtt-zabbix/mqtt-zabbix.cfg (especifique el intermediario ip mqtt y la direcci√≥n del servidor zabbix). <br><br><h3>  ¬øQu√© m√°s conectar a 433? </h3><br>  <i>Si, cualquier cosa!</i>  <i>:)</i> <br><br><h4>  Sensores de estaci√≥n meteorol√≥gica </h4><br>  Mientras jugueteaba con los sensores de fuga inal√°mbricos, accidentalmente capt√© la se√±al de un sensor externo de una estaci√≥n meteorol√≥gica.  Se ve√≠a as√≠: <br><br><pre> <code class="bash hljs">time : 2019-09-19 10:48:54 Protocol : 56 model : TFA pool temperature sensor Id : 182 Channel : 3 Temperature: 19.3 C Modulation: ASK Freq : 433.9 MHz RSSI : -0.1 dB SNR : 35.0 dB Noise : -35.2 dB time : 2019-09-20 10:57:29 Protocol : 12 brand : OS model : THN132N House Code: 4 Channel : 3 Battery : OK Celsius : 20.00 C Modulation: ASK Freq : 432.9 MHz RSSI : -0.2 dB SNR : 31.5 dB Noise : -31.7 dB</code> </pre><br>  Por lo tanto, la ventaja era la capacidad de controlar la temperatura de los puntos en el aire con visualizaci√≥n en zabbix.  Solo en algunas habitaciones no puedo estirar el cable. <br><br><h4>  Timbre </h4><br>  Muchas llamadas de radio funcionan en el mismo rango de frecuencia ~ 433 mhz.  Por lo tanto, podemos interceptar la presi√≥n del bot√≥n de llamada (ni siquiera es necesario tener la llamada en s√≠, solo el bot√≥n es suficiente).  Por qu√©  Por ejemplo, para configurar una notificaci√≥n adicional por SMS / telegrama / lo que sea o mostrar la imagen de la c√°mara en el monitor. <br><br>  Compr√© una llamada: Evology QA-688-E RU. <br><br>  Para que el bot√≥n rtl_433 vea el bot√≥n de llamada, debe activar los protocolos de "prueba", por ejemplo, ejecutando con la opci√≥n "G" o especificando un protocolo adicional espec√≠fico, al mismo tiempo agregaremos la salida de informaci√≥n sobre el protocolo y la frecuencia: <br><br><pre> <code class="bash hljs">rtl_433 -f 433.9e6 -G -M protocol -M level -F mqtt://127.0.0.1,events=/433/[id] &amp;</code> </pre> <br>  Entra en MQTT: <br><br><pre> <code class="bash hljs">{<span class="hljs-string"><span class="hljs-string">"time"</span></span>:<span class="hljs-string"><span class="hljs-string">"2019-09-30 10:57:00"</span></span>,<span class="hljs-string"><span class="hljs-string">"protocol"</span></span>:72,<span class="hljs-string"><span class="hljs-string">"model"</span></span>:<span class="hljs-string"><span class="hljs-string">"RF-tech"</span></span>,<span class="hljs-string"><span class="hljs-string">"id"</span></span>:0,<span class="hljs-string"><span class="hljs-string">"battery"</span></span>:<span class="hljs-string"><span class="hljs-string">"LOW"</span></span>,<span class="hljs-string"><span class="hljs-string">"temperature_C"</span></span>:0,<span class="hljs-string"><span class="hljs-string">"button"</span></span>:0,<span class="hljs-string"><span class="hljs-string">"mod"</span></span>:<span class="hljs-string"><span class="hljs-string">"ASK"</span></span>,<span class="hljs-string"><span class="hljs-string">"freq"</span></span>:433.84822,<span class="hljs-string"><span class="hljs-string">"rssi"</span></span>:-3.5981,<span class="hljs-string"><span class="hljs-string">"snr"</span></span>:33.77488,<span class="hljs-string"><span class="hljs-string">"noise"</span></span>:-37.373}</code> </pre> <br>  Aqu√≠ puedes ver id = 0.  Al mismo tiempo, ten√≠a varios dispositivos identificados como tecnolog√≠a RF.  Todos ellos ten√≠an una identificaci√≥n igual a 0. Como resultado, todos los dispositivos en zabbix se muestran como un elemento.  Es posible distinguir exactamente qu√© dispositivo funcion√≥, solo por frecuencia. <br><br>  Extraemos la frecuencia a un elemento dependiente separado: mqtt.outside.doorbell.freq con preprocesamiento JSON en $ .freq (zabbix puede hacer esto desde la cuarta versi√≥n). <br><br>  En este elemento, active un disparador con la expresi√≥n: <br><br><pre> <code class="bash hljs">{HOME_PI:mqtt.outside.doorbell.freq.last()}&gt;433.8 and {HOME_PI:mqtt.outside.doorbell.freq.last()}&lt;433.81 and {HOME_PI:mqtt.outside.doorbell.freq.nodata(30)}=0</code> </pre> <br>  Es decir  si de repente aparece un valor en el elemento general mqtt.outside.doorbell.freq (nodata) y la frecuencia est√° en el rango especificado entre 433.8 y 433.81, podemos concluir que nos est√°n llamando (y, por ejemplo, para duplicar una llamada a SMS). <br><br><h4>  Sensores de puerta / ventana </h4><br>  Tengo un sensor de penetraci√≥n de rubetek.  Env√≠a lo siguiente: <br><br><pre> <code class="bash hljs">{<span class="hljs-string"><span class="hljs-string">"time"</span></span>:<span class="hljs-string"><span class="hljs-string">"2019-09-30 14:11:28"</span></span>,<span class="hljs-string"><span class="hljs-string">"protocol"</span></span>:86,<span class="hljs-string"><span class="hljs-string">"model"</span></span>:<span class="hljs-string"><span class="hljs-string">"Smoke detector GS 558"</span></span>,<span class="hljs-string"><span class="hljs-string">"id"</span></span>:12262,<span class="hljs-string"><span class="hljs-string">"unit"</span></span>:16,<span class="hljs-string"><span class="hljs-string">"learn"</span></span>:0,<span class="hljs-string"><span class="hljs-string">"code"</span></span>:<span class="hljs-string"><span class="hljs-string">"e5fcd0"</span></span>,<span class="hljs-string"><span class="hljs-string">"mod"</span></span>:<span class="hljs-string"><span class="hljs-string">"ASK"</span></span>,<span class="hljs-string"><span class="hljs-string">"freq"</span></span>:433.85021,<span class="hljs-string"><span class="hljs-string">"rssi"</span></span>:-3.99241,<span class="hljs-string"><span class="hljs-string">"snr"</span></span>:33.38058,<span class="hljs-string"><span class="hljs-string">"noise"</span></span>:-37.373}  : {<span class="hljs-string"><span class="hljs-string">"time"</span></span>:<span class="hljs-string"><span class="hljs-string">"2019-09-30 14:11:28"</span></span>,<span class="hljs-string"><span class="hljs-string">"protocol"</span></span>:68,<span class="hljs-string"><span class="hljs-string">"model"</span></span>:<span class="hljs-string"><span class="hljs-string">"Kerui Security"</span></span>,<span class="hljs-string"><span class="hljs-string">"id"</span></span>:46074,<span class="hljs-string"><span class="hljs-string">"cmd"</span></span>:7,<span class="hljs-string"><span class="hljs-string">"state"</span></span>:<span class="hljs-string"><span class="hljs-string">"close"</span></span>,<span class="hljs-string"><span class="hljs-string">"mod"</span></span>:<span class="hljs-string"><span class="hljs-string">"ASK"</span></span>,<span class="hljs-string"><span class="hljs-string">"freq"</span></span>:433.85021,<span class="hljs-string"><span class="hljs-string">"rssi"</span></span>:-3.99241,<span class="hljs-string"><span class="hljs-string">"snr"</span></span>:33.38058,<span class="hljs-string"><span class="hljs-string">"noise"</span></span>:-37.373}  : {<span class="hljs-string"><span class="hljs-string">"time"</span></span>:<span class="hljs-string"><span class="hljs-string">"2019-09-30 14:11:21"</span></span>,<span class="hljs-string"><span class="hljs-string">"protocol"</span></span>:68,<span class="hljs-string"><span class="hljs-string">"model"</span></span>:<span class="hljs-string"><span class="hljs-string">"Kerui Security"</span></span>,<span class="hljs-string"><span class="hljs-string">"id"</span></span>:46074,<span class="hljs-string"><span class="hljs-string">"cmd"</span></span>:14,<span class="hljs-string"><span class="hljs-string">"state"</span></span>:<span class="hljs-string"><span class="hljs-string">"open"</span></span>,<span class="hljs-string"><span class="hljs-string">"mod"</span></span>:<span class="hljs-string"><span class="hljs-string">"ASK"</span></span>,<span class="hljs-string"><span class="hljs-string">"freq"</span></span>:433.85005,<span class="hljs-string"><span class="hljs-string">"rssi"</span></span>:-11.0148,<span class="hljs-string"><span class="hljs-string">"snr"</span></span>:25.1088,<span class="hljs-string"><span class="hljs-string">"noise"</span></span>:-36.1236}</code> </pre> <br>  Tan pronto como se agreg√≥ el √∫ltimo sensor de radio a zabbix, quise rehacer todo en MQTT.  Catalogaci√≥n conveniente, puede determinar el tema-ah y la ubicaci√≥n y los tipos de dispositivos.  Obtienes la transmisi√≥n general de todos los eventos. <br><br><h2>  1 cable a MQTT </h2><br>  Quiero que todo est√© en MQTT, al menos para el mismo tipo de implementaci√≥n.  Quiero obtener un "√©ter" general de eventos y un enfoque general en reacci√≥n a estos eventos.  Por supuesto, zabbix resuelve el problema de reacci√≥n, y dejo alertas sobre √©l.  Pero quiero que la administraci√≥n sea m√°s alegre, cercana al sistema y al "√©ter". <br><br>  Existen soluciones listas para transmitir estados de sensores desde una red de 1 cable a MQTT, pero no me conven√≠an.  Las soluciones listas para usar en el nodo llevan muchas dependencias detr√°s de ellas o se comen todo el procesador de frambuesa.  Algunas de las soluciones de los 10 principales en la b√∫squeda de Google son abandonadas por los autores, algunas solo son compatibles con sensores de temperatura.  Tambi√©n hay una clase de puertas de enlace que recopilan informaci√≥n a trav√©s de la interfaz de gpio.  Todo esto no me conven√≠a. <br><br>  Tengo un sistema de pseudoarchivo montado con dispositivos 1wire en / mnt / 1wire, de ah√≠ quiero obtener toda la informaci√≥n necesaria.  Para hacer esto, es suficiente hacer una l√≠nea simple en bash, enviando datos a trav√©s de mosquitto_pub para cada uno de los sensores.  Sin embargo, hay preguntas sobre el lanzamiento de estos scripts (¬øsobre la corona, para conducir a alg√∫n tipo de demonio?), Presentaci√≥n normal de datos (obteniendo el mismo json), agregando un nuevo sensor, etc. Mientras m√°s se desarrollaba el pensamiento, nac√≠an m√°s muletas.  Result√≥ ser m√°s f√°cil escribir una puerta de enlace para otros owfs a mqtt para esta tarea. <br><br>  Hay un archivo de configuraci√≥n en el que necesitamos ingresar la identificaci√≥n de los sensores y los archivos de fuse.OWFS que queremos publicar en mqtt. <br><br>  La salida en mqtt es el siguiente json: <br><br><pre> <code class="bash hljs">/1wire/28.0425260a0000 {<span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"DS18B20"</span></span>, <span class="hljs-string"><span class="hljs-string">"temperature"</span></span>: <span class="hljs-string"><span class="hljs-string">"30"</span></span>} /1wire/28.bf16270a0000 {<span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"DS18B20"</span></span>, <span class="hljs-string"><span class="hljs-string">"temperature"</span></span>: <span class="hljs-string"><span class="hljs-string">"7.9375"</span></span>} /1wire/26.da2f71010000 {<span class="hljs-string"><span class="hljs-string">"temperature"</span></span>: <span class="hljs-string"><span class="hljs-string">"25.2812"</span></span>, <span class="hljs-string"><span class="hljs-string">"IAD"</span></span>: <span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-string"><span class="hljs-string">"CA"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-string"><span class="hljs-string">"VAD"</span></span>: <span class="hljs-string"><span class="hljs-string">"0.91"</span></span>, <span class="hljs-string"><span class="hljs-string">"VDD"</span></span>: <span class="hljs-string"><span class="hljs-string">"4.59"</span></span>, <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"DS2438"</span></span>} /1wire/28.48b3010b0000 {<span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"DS18B20"</span></span>, <span class="hljs-string"><span class="hljs-string">"temperature"</span></span>: <span class="hljs-string"><span class="hljs-string">"40.5625"</span></span>} /1wire/1d.6a9306000000 {<span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"DS2423"</span></span>, <span class="hljs-string"><span class="hljs-string">"counter.B"</span></span>: <span class="hljs-string"><span class="hljs-string">"9"</span></span>, <span class="hljs-string"><span class="hljs-string">"counter.A"</span></span>: <span class="hljs-string"><span class="hljs-string">"9219"</span></span>} /1wire/28.61cc260a0000 {<span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"DS18B20"</span></span>, <span class="hljs-string"><span class="hljs-string">"temperature"</span></span>: <span class="hljs-string"><span class="hljs-string">"12.5"</span></span>}</code> </pre> <br>  Agregar a ejecuci√≥n autom√°tica, establecer el intervalo de sondeo.  El problema est√° resuelto. <br><br><h3>  Referencias </h3><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">github.com/merbanan/rtl_433</a> - una herramienta para decodificar protocolos de radio <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">github.com/kylegordon/mqtt-zabbix</a> - MQTT en Zabbix <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">github.com/unlo/1wire2mqtt</a> - 1wire en MQTT, cliente MQTT que le permite ejecutar scripts cuando aparece el tema </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/467761/">https://habr.com/ru/post/467761/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../467749/index.html">GCP: an√°lisis de la pila de computaci√≥n de Google Cloud Platform</a></li>
<li><a href="../467751/index.html">¬øC√≥mo funciona un mensajero descentralizado en la cadena de bloques</a></li>
<li><a href="../467753/index.html">R√©cord mundial de transmisi√≥n inal√°mbrica de datos: 40 Gb / s por 11 kil√≥metros</a></li>
<li><a href="../467755/index.html">Priones, calcio, microbiota, hormonas alimentarias y Alzheimer.</a></li>
<li><a href="../467759/index.html">Dise√±o de sistema operativo tipo Unix: espacio de direcciones virtuales (6)</a></li>
<li><a href="../467763/index.html">Toda la verdad sobre RTOS. Art√≠culo # 33. Uso del sistema operativo Nucleus SE en tiempo real</a></li>
<li><a href="../467765/index.html">Wi-Fi y muchas otras abreviaturas. C√≥mo obtener datos en nodos de Wi-Fi en una aplicaci√≥n de Android y no aumentar</a></li>
<li><a href="../467769/index.html">En un √∫nico recurso de informaci√≥n federal que contiene informaci√≥n de poblaci√≥n</a></li>
<li><a href="../467771/index.html">Al igual que un autocargador junior verde, escribi√≥ su <s> caliente </s>. Parte 2. CSS</a></li>
<li><a href="../467775/index.html">5 mitos sobre los negocios: por qu√© el cliente est√° equivocado y c√≥mo superar a Apple</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>