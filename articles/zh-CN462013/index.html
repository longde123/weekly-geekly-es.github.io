<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👊🏿 🎤 🕖 Docker存储（Docker根）迁移问题历史记录 🚣🏿 🌖 🖇️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="不迟于几天前，决定在其中一台服务器上将docker存储（docker存储所有容器，图像文件的目录）移动到一个单独的分区，该分区 
 拥有更多的能力。 看起来，这项任务是微不足道的，并且没有预示着麻烦…… 

 入门： 

 1.停止并终止我们应用程序的所有容器： 



docker-compose...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Docker存储（Docker根）迁移问题历史记录</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/462013/">不迟于几天前，决定在其中一台服务器上将docker存储（docker存储所有容器，图像文件的目录）移动到一个单独的分区，该分区 <br> 拥有更多的能力。 看起来，这项任务是微不足道的，并且没有预示着麻烦…… <br><a name="habracut"></a><br> 入门： <br><br>  1.停止并终止我们应用程序的所有容器： <br><br><pre><code class="bash hljs">docker-compose down</code> </pre> <br> 如果有很多容器，并且它们的组成不同，则可以执行以下操作： <br><br><pre> <code class="bash hljs">docker rm -f $(docker ps -q)</code> </pre> <br>  2.停止docker守护程序： <br><br><pre> <code class="bash hljs">systemctl stop docker</code> </pre> <br>  3.将目录移动到所需位置： <br><br><pre> <code class="bash hljs">cp -r /var/lib/docker /docker/data/storage</code> </pre> <br>  4.我们通知docker的恶魔查看新目录。 有几个选项：使用-g标志将守护程序指向新路径，或者使用我们使用的systemd配置。 好吧，还是符号链接。 我不会多说，互联网上有<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">很多</a>手册将Docker root移植到新位置。 <br><br>  5.我们启动docker恶魔，然后看它应该在哪里： <br><br><pre> <code class="bash hljs">systemctl status docker</code> </pre> <br> 在输出的其中一行中，我们应该看到： <br><pre> <code class="bash hljs">├─19493 /usr/bin/dockerd --data-root=/docker/data/storage</code> </pre> <br> 我们确保已将选项传递给守护程序，现在我们<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" class="user_link">将</a>检查它是否已应用（感谢<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" class="user_link">inkvizitor68sl</a> ）！ <br><pre> <code class="bash hljs">docker info | awk <span class="hljs-string"><span class="hljs-string">'/Root Dir/ {print $NF}'</span></span></code> </pre> <br>  6.我们开始应用程序： <br><pre> <code class="bash hljs">docker-compose up -d</code> </pre> <br>  7.检查 <br><br> 有趣的开始了，DBMS，MQ一切都很好！ 该基础完好无损，除nginx之外，其他所有功能都适用。 我们有自己的nginx程序集和kerberos <s>和妓女</s> 。 并且查看容器的日志表明他无法写入/ var / tmp-权限被拒绝。 我用威士忌拉伸手指，然后尝试分析情况……那是什么？ 泊坞窗映像未更改。 我们只是移动了目录。 它一直都有效，这是给您的...为了进行实验，我用笔进入了容器，并更改了该目录的权限，其中有<u>root（根755）</u> ， <u>root（根777）</u> 。 一切都开始了……我的脑海里响起了一个念头-一种胡话...我以为，也许我没有考虑到某些东西... <br><br> 我决定我们喜欢传输过程中对文件的访问权限。 他们停止了应用程序docker守护程序，删除了新目录，并使用<code>rsync -a</code>复制了/ var / lib / docker目录。 <br><br> 我认为现在一切都很好，我们正在提升docker应用程序。 <br><br>  III ...问题仍然存在...我的眼睛抽搐了。 我冲到虚拟机的控制台，在其中运行各种测试，得到了nginx映像，然后爬入了容器，这里的根777根权限位于/ var / tmp目录中，也就是说，我必须忍受相同的操作。 但是图像是相同的！ <br><br>  <u>到处都使用FS xfs。</u> <br><br> 我通过命令比较 <br><br><pre> <code class="bash hljs">docker inspect my-nginx:12345</code> </pre> <br> 所有哈希都是相同的，都是一对一的。 在服务器和我的virtualka上。 我删除了本地nginx映像，并再次使用注册表假脱机，由于多种原因，该注册表位于同一台计算机上。 问题是一样的...现在我的第二只眼睛抽搐了。 <br><br> 除了“ AAAAAAA”的尖叫声和其他东西，我不记得在想什么。 在凌晨4点的大街上，泊坞窗消息源被用来了解哈希图像层的原理。 他打开了第三罐能量。 最后，我突然意识到，哈希仅考虑文件及其内容，而不考虑<b>访问权限</b> ！ 也就是说，以某种神秘的方式，权利被击败，并且selinux被禁用，acl不被使用，粘性位不存在。 <br><br> 我删除了本地映像，也从Docker注册表中删除了该映像，然后再次启动它。 而且有效。 事实证明，在传输过程中，在本地映像内和注册表中的映像内，权利都遭到了殴打。 正如我所说，由于多种原因，它位于同一辆车上。 结果是在一个目录/ var / lib / docker中。 <br><br> 并预料到他们是否会尝试将docker的目光恢复到旧目录的问题-不，可惜，情况不允许。 是的，我真的很想弄清楚。 <br><br> 写完这篇文章后，问题的解决方案对我来说似乎很明显，但在分析时似乎并非如此。 老实说，我用谷歌搜索，没有发现类似情况。 <br><br> 底线：我解决了问题，我不明白原因=（ <br><br> 如果有人知道/猜想/对这个问题的可能原因有见识，我将非常高兴见到您在评论中！ </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN462013/">https://habr.com/ru/post/zh-CN462013/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN462003/index.html">我如何在Google Play的Svelte上发布PWA</a></li>
<li><a href="../zh-CN462005/index.html">Google PageSpeed的功能：改进了网站评分和搜索排名</a></li>
<li><a href="../zh-CN462007/index.html">开发健壮的Python脚本</a></li>
<li><a href="../zh-CN462009/index.html">编程趋势：2020年可以期待什么？</a></li>
<li><a href="../zh-CN462011/index.html">Web地理服务。 现代解决方案概述</a></li>
<li><a href="../zh-CN462015/index.html">SAP Reporting Universe</a></li>
<li><a href="../zh-CN462021/index.html">如何停止做同一件事</a></li>
<li><a href="../zh-CN462023/index.html">Cascadeur：游戏动画的未来</a></li>
<li><a href="../zh-CN462025/index.html">关系网络数据模型</a></li>
<li><a href="../zh-CN462027/index.html">Dark如何部署50ms代码</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>