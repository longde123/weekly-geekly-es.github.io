<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèø üë®‚Äç‚öñÔ∏è üç® HomeKit y ioBroker Hagamos amigos en casa üë®‚Äçüç≥ ‚úåüèæ üë≤üèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Sin lugar a dudas, Apple iOS sigue siendo uno de los sistemas operativos m√≥viles m√°s populares, lo que significa que los sistemas de automatizaci√≥n mo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>HomeKit y ioBroker Hagamos amigos en casa</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/iobroker/blog/433798/"><p><img src="https://habrastorage.org/webt/r6/5c/kp/r65ckpg2b-xatrgqefbyo7lflxa.png"></p><br><p>  Sin lugar a dudas, Apple iOS sigue siendo uno de los sistemas operativos m√≥viles m√°s populares, lo que significa que los sistemas de automatizaci√≥n modernos deben poder integrarse en este ecosistema y brindar la oportunidad de interacci√≥n.  Esto es exactamente para lo que est√° dise√±ado el marco Homekit, que le permite trabajar con dispositivos inteligentes desde la pantalla del iPhone / iPad / iWatch, y m√°s recientemente, Mac (macOS Mojave). </p><br><p>  La mayor√≠a de los sistemas de automatizaci√≥n (no me gusta el nombre comercial "casa inteligente") han incluido m√≥dulos para integrarse con Homekit, pero incluso un usuario capacitado no siempre puede descubrir c√≥mo hacer que su dispositivo est√© disponible en la aplicaci√≥n Home (o Eve). </p><br><p>  Hoy les dir√© c√≥mo hacer estas manipulaciones en el sistema ioBroker (este es un sistema de automatizaci√≥n abierto y gratuito).  Pero para no dar est√∫pidamente todos los ejemplos de dispositivos, quiero explicar algunos principios y mostrar enfoques, sabiendo cu√°les, usted puede implementar f√°cilmente otros ejemplos. </p><br><p>  <em>"Conocer algunos principios compensa f√°cilmente la ignorancia de algunos hechos".</em> <em><br></em>  <em>Claude Adrian Helvetius</em> </p><a name="habracut"></a><br><h3 id="iobroker-drayvery-ustroystva-i-sostoyaniya">  ioBroker.  Controladores, dispositivos y estados </h3><br><p>  En primer lugar, quiero explicar qu√© es un dispositivo en el sistema ioBroker y c√≥mo se presenta. </p><br><p>  Perm√≠tame recordarle que el sistema ioBroker es modular y que los m√≥dulos de extensi√≥n se denominan controladores (o adaptadores).  Un controlador es un m√≥dulo de integraci√≥n con alg√∫n dispositivo o grupo de dispositivos, unidos por una funcionalidad, protocolo o fabricante com√∫n, y por lo tanto puede "arrastrar" de uno a varios dispositivos al sistema ioBroker.  Otra caracter√≠stica es la capacidad de crear m√∫ltiples instancias del mismo controlador, que difieren en cualquier configuraci√≥n. </p><br><p>  Pero cada dispositivo es √∫nico e inimitable, tiene diferentes caracter√≠sticas y capacidades.  En base a esto, ioBroker se enfoca principalmente no en el dispositivo en s√≠, sino en sus caracter√≠sticas, que est√°n representadas por estados.  <strong>Un estado</strong> es un objeto interno ioBroker que acepta y almacena un valor.  Se pueden considerar los sin√≥nimos del estado: signos, atributos, caracter√≠sticas, propiedades, eventos.  Ejemplos de condiciones: "temperatura", "nivel de brillo", "nivel de bater√≠a", "indicador de encendido", "indicador de error", "indicador de presi√≥n", "indicador de doble presi√≥n", etc.  Por lo tanto, cada dispositivo est√° representado por muchos estados diferentes. </p><br><p><img src="https://habrastorage.org/webt/oc/mn/q_/ocmnq_d-zdyhjj7bflfxaa3dxb8.png" alt="Estructura del objeto" title="Estructura del objeto"></p><br><p>  Los estados se pueden dividir en informativos (muestran informaci√≥n del dispositivo y mutables), el usuario o el script pueden cambiarlos y enviar estos cambios al dispositivo.  En consecuencia, cuando algo cambia en el dispositivo (estos datos se muestran en los estados y cuando el estado cambia de ioBroker (por el usuario o por el script)), el dispositivo recibe una se√±al sobre el cambio y debe responder en consecuencia (depende del dispositivo en s√≠ y del controlador que lo acompa√±a) obras). </p><br><p>  Todos los estados del dispositivo se combinan en un solo √°rbol (registro) de estados.  Se agrupan primero por dispositivo (en algunos casos, la canalizaci√≥n todav√≠a se usa) y luego por instancias de controladores. </p><br><p>  El concepto de temas de protocolo MQTT se adapta f√°cilmente a dicho √°rbol de estado.  De esta manera, puede conectar equipos adicionales o sistemas de terceros que admitan el protocolo MQTT.  Es suficiente instalar el controlador MQTT: la rama correspondiente aparecer√° en el √°rbol de estado. </p><br><p>  Y hay todo tipo de servicios en l√≠nea que pueden proporcionar informaci√≥n √∫til y / o hacer posible controlar otros equipos (alarmas de autom√≥viles, por ejemplo).  El resultado de la interacci√≥n con estos servicios tambi√©n se representa como un conjunto de estados. </p><br><p><img src="https://habrastorage.org/webt/xi/qk/ay/xiqkay8bgotkcb7qjhouj5-zln4.png" alt="√Årbol de estado" title="√Årbol de estado"></p><br><p>  En total, un dispositivo en ioBroker est√° representado por un conjunto de estados que caracterizan el dispositivo y permiten interactuar con √©l. </p><br><h3 id="homekit-aksessuary-servisy-i-harakteristiki">  Homekit  Accesorios, servicios y especificaciones. </h3><br><p>  Ahora recurra a Homekit.  Aqu√≠ se aplica la clasificaci√≥n de dispositivos, su funcionalidad y caracter√≠sticas. </p><br><p><img src="https://habrastorage.org/webt/xk/ch/8m/xkch8mdj6gv4zxw5g-kapazvuyy.png" alt="Categor√≠as de dispositivos de Homekit" title="Categor√≠as de dispositivos de Homekit"></p><br><p>  <strong>Los accesorios</strong> son el equivalente de un dispositivo f√≠sico.  El accesorio tiene una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">categor√≠a</a> para asignarlo a un grupo espec√≠fico. </p><br><p>  <strong>Los servicios</strong> son el equivalente de la funcionalidad que tiene un accesorio.  Un accesorio puede tener varios servicios. </p><br><p>  Los servicios indican las capacidades del dispositivo: l√°mpara, bater√≠a, bot√≥n, sensor de calidad del aire, puerta, filtro de aire, c√°mara ... </p><br><p>  Es el servicio el que determina la pantalla, el comportamiento del dispositivo y el conjunto de caracter√≠sticas. </p><br><p>  <strong>Caracter√≠stica</strong> es el equivalente de los atributos / propiedades que caracterizan un servicio.  Son las caracter√≠sticas las que determinan si el dispositivo est√° encendido, el nivel de brillo de la l√°mpara o cu√°ntas veces se presiona el bot√≥n.  Un solo servicio puede tener muchas caracter√≠sticas. </p><br><p><img src="https://habrastorage.org/webt/2f/rl/io/2frliotkqesh2zanlhpfiaskmaq.png" alt="Estructura del objeto" title="Estructura del objeto"></p><br><p>  Las aplicaciones que funcionan con Homekit leen los servicios y las caracter√≠sticas de los accesorios, y luego muestran y le permiten cambiar los valores en las caracter√≠sticas a trav√©s de la interfaz de usuario.  Los valores modificados se env√≠an a los dispositivos Homekit para aplicarlos, y desde los dispositivos Homekit, respectivamente, tambi√©n se env√≠an los valores de las caracter√≠sticas con algunos cambios desde el lado del dispositivo. </p><br><p>  En total, el dispositivo en HomeKit parece ser un accesorio con un conjunto de servicios y caracter√≠sticas. </p><br><h3 id="yahka-stykuem-koncepcii">  Yahka  Nos unimos al concepto </h3><br><p>  Para trabajar con Homekit, ioBroker utiliza el controlador <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Yahka</a> (se deben <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">instalar m√≥dulos adicionales</a> antes de la instalaci√≥n), un complemento de una biblioteca conocida <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://github.com/KhaosT/HAP-NodeJS</a> , que tambi√©n construye el popular proyecto HomeBridge.  Esta biblioteca est√° dise√±ada para crear una puerta de enlace / puente virtual que proporciona un conjunto de dispositivos virtuales en HomeKit.  Configurando los dispositivos y servicios virtuales en consecuencia, estableciendo los valores de las caracter√≠sticas, obtenemos el dispositivo terminado en Homekit y la aplicaci√≥n Home, y tambi√©n podemos pedirle a Siri que lo administre. </p><br><p>  El controlador Yahka est√° dise√±ado para configurar accesorios, agregarles servicios e indicar la correspondencia de caracter√≠sticas (HomeKit) y estados (ioBroker). </p><br><p>  Pero primero, despu√©s de la instalaci√≥n, debe configurar la puerta de enlace y acceder a la aplicaci√≥n de inicio.  Despu√©s de la configuraci√≥n, todos los dispositivos agregados a la puerta de enlace se agregar√°n autom√°ticamente al Inicio.  Para hacer esto, especifique "Nombre del dispositivo" (es conveniente especificar solo letras latinas) y recuerde el c√≥digo PIN (o establezca el suyo). </p><br><p><img src="https://habrastorage.org/webt/mj/b9/lf/mjb9lfsfvknvbjjmec9x0nexnns.png" alt="Configuraci√≥n de puerta de enlace" title="Configuraci√≥n de puerta de enlace"></p><br><div class="spoiler">  <b class="spoiler_title">Vamos a la aplicaci√≥n Inicio y agregamos un nuevo accesorio.</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/5k/m1/hr/5km1hrkrxh6whzmb8dn5zcvqtm4.png"><br><img src="https://habrastorage.org/webt/fo/p-/oz/fop-oz-o99nnegmciq7drkxjdyu.png"></p></div></div><br><p>  Ahora vamos a los dispositivos.  Todo estar√≠a bien si el conjunto de estados para el dispositivo en ioBroker correspondiera claramente al conjunto de servicios y caracter√≠sticas en HomeKit.  Y ser√≠a a√∫n mejor si los valores en los estados fueran adecuados para los valores de las caracter√≠sticas.  Pero a menudo esto no es as√≠, y tienes que encontrar formas inusuales de atracar.  Hablar√© sobre algunos de ellos a continuaci√≥n, y tendr√° que implementar todas las dem√°s opciones usted mismo "a imagen y semejanza". </p><br><p>  Por conveniencia, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">cre√© un documento</a> con la traducci√≥n de servicios y tipos, as√≠ como los posibles valores de las caracter√≠sticas.  Todos los tipos y servicios utilizados corresponden a la <a href="">biblioteca HAP-NodeJS</a> . </p><br><h3 id="datchik-temperatury">  Sensor de temperatura </h3><br>  Este es el ejemplo m√°s simple: todo lo que tiene que hacer es tener un estado que contenga el valor num√©rico de la temperatura.  Se puede obtener desde cualquier lugar: desde sensores o desde servicios de Internet (clima). <br><p>  Debe agregar un dispositivo de la categor√≠a Sensor, agregar el servicio Sensor de temperatura al dispositivo y asignarle un nombre a este servicio.  Hay 5 caracter√≠sticas en este servicio, de las cuales la m√°s importante para nosotros es CurrentTemperature. </p><br><p><img src="https://habrastorage.org/webt/xn/yr/k7/xnyrk7hwwcmtwhiy_kcbub-nlms.png" alt="Term√≥metro accesorio" title="Term√≥metro accesorio"></p><br><p><img src="https://habrastorage.org/webt/j4/bj/bn/j4bjbnuijam7qadtoq9r9eh16ns.png" alt="Servicio de sensor de temperatura" title="Servicio de sensor de temperatura"></p><br><p>  Es suficiente para indicar el nombre del estado correspondiente a la temperatura en la caracter√≠stica CurrentTemperature. </p><br><p>  Agregue aqu√≠ tambi√©n el servicio de humedad del sensor de humedad, y se crear√° un icono de accesorio separado en Homekit. </p><br><p><img src="https://habrastorage.org/webt/ag/na/90/agna90qhvaz84v3qutrvu4dltei.png" alt="Servicio de sensor de humedad" title="Servicio de sensor de humedad"></p><br><p>  Ahorre, y ya est√°.  Ahora puedes recurrir a Siri y preguntarle sobre la temperatura y la humedad. </p><br><p><img src="https://habrastorage.org/webt/s4/cx/kg/s4cxkg72-7ycfuaentktjrhpdjy.png"></p><br><div class="spoiler">  <b class="spoiler_title">Conversaci√≥n con siri</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/ff/p9/tt/ffp9ttfpcj3_wcbt4ztgisnwxzi.png"><br><img src="https://habrastorage.org/webt/ax/7z/1i/ax7z1ioiynurem96c3gof_2gnha.png"></p></div></div><br><h3 id="batareyka">  Bater√≠a </h3><br><p>  Otro servicio simple.  Su truco es que se puede agregar a casi cualquier accesorio.  Agregue el servicio BatteryService e indique en la caracter√≠stica BatteryLevel un estado que contenga el porcentaje de carga de la bater√≠a.  Despu√©s de eso, los datos de carga aparecer√°n en los datos adicionales sobre el dispositivo. </p><br><p><img src="https://habrastorage.org/webt/pd/4p/ib/pd4pibwilwjymthk2g30ldqneey.png" alt="Servicio de bater√≠a" title="Servicio de bater√≠a"></p><br><p>  Puede configurar inmediatamente el signo de "carga baja" (caracter√≠stica StatusLowBattery), si el valor del estado especificado es igual a 1, el icono correspondiente se mostrar√° en la imagen del dispositivo. </p><br><p>  Pero, ¬øqu√© pasa si no tiene ese estado, pero quiere ver el icono de bater√≠a baja?  Debe crear este estado manualmente o con un script e indicar el estado creado en las caracter√≠sticas. </p><br><p>  Ahora solo queda establecer correctamente el valor verdadero en este estado.  Para hacer esto, utilizaremos el script: se establecer√° cuando la bater√≠a alcance el 30 por ciento. </p><br><pre><code class="javascript hljs">createState(<span class="hljs-string"><span class="hljs-string">""</span></span>); on({<span class="hljs-attr"><span class="hljs-attr">id</span></span>: <span class="hljs-string"><span class="hljs-string">"zigbee.0.00158d0001f41725.battery"</span></span>, <span class="hljs-attr"><span class="hljs-attr">change</span></span>: <span class="hljs-string"><span class="hljs-string">"ne"</span></span>}, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">obj</span></span></span><span class="hljs-function">) </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> value = obj.state.val; setState(<span class="hljs-string"><span class="hljs-string">"javascript.0."</span></span>, (value &lt;= <span class="hljs-number"><span class="hljs-number">30</span></span>)); });</code> </pre> <br><p>  Despu√©s de la primera ejecuci√≥n, el script crear√° un estado y se puede seleccionar en las caracter√≠sticas. </p><br><p><img src="https://habrastorage.org/webt/tx/2z/6r/tx2z6r4deofbbram-k_muwaxut0.png"></p><br><p>  Este letrero se mostrar√° en im√°genes de accesorios. </p><br><p><img src="https://habrastorage.org/webt/9o/nu/it/9onuitzmxs8exjofr7cfkwtwrqi.png"></p><br><div class="spoiler">  <b class="spoiler_title">y detalles del dispositivo</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/fx/jg/av/fxjgavhu-spu27lskbzkmvb_dh8.png"></p></div></div><br><h3 id="lampy">  L√°mparas </h3><br><p>  Las bombillas son diferentes: brillantes, c√°lidas, rojas.  Hay 4 casos: </p><br><ul><li>  Simple: controlado por encendido y apagado </li><li>  Regulable: tambi√©n controlado por nivel de brillo </li><li>  Con temperatura: es posible controlar la temperatura del brillo </li><li>  Color: puede controlar el color del brillo </li></ul><br><p>  Para cada uno de estos casos, hay una caracter√≠stica correspondiente en el servicio de Bombilla: </p><br><ul><li>  Encendido - encendido / apagado </li><li>  Brillo - nivel de brillo </li><li>  Hue - sombra </li><li>  Saturaci√≥n - Saturaci√≥n </li><li>  Temperatura de color - temperatura de color </li></ul><br><p>  En el caso simple, en la caracter√≠stica "Encendido", indicamos el estado responsable de encender y apagar. </p><br><p><img src="https://habrastorage.org/webt/7p/2j/l2/7p2jl2cqi7q8rbw98d_ytedxwke.png"></p><br><p>  Si la l√°mpara es regulable, tambi√©n indicamos el estado con el nivel de brillo. </p><br><p><img src="https://habrastorage.org/webt/b6/da/n1/b6dan1fjltcn8sry8doex2hl6ck.png"></p><br><p>  ¬°Adem√°s de asignar estados correctos, es importante observar el intervalo de valores aceptables! </p><br><p>  Ejemplo: en algunos casos, el estado responsable del brillo de la l√°mpara puede tomar valores de 0 a 255, pero en Homekit estos valores est√°n limitados a un intervalo de 0 a 100. Para este caso, puede usar las <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">funciones de conversi√≥n del</a> controlador Yahka.  La funci√≥n "nivel255" simplemente convierte el intervalo de valores 0..255 en el intervalo 0..100 (y viceversa). </p><br><p>  Las siguientes dificultades pueden surgir si su l√°mpara es de color, pero el color utilizado es RGB.  Puede ser tres estados diferentes o un n√∫mero (o cadena).  En este caso, deber√° convertir de un espacio de color RGB a otro espacio XYB (HomeKit usa este espacio), o al plano XY. </p><br><p>  Para hacer esto, necesita hacer 2 nuevos estados (Hue y Saturaci√≥n), en los que convertiremos los valores del estado RGB y viceversa. </p><br><div class="spoiler">  <b class="spoiler_title">La secuencia de comandos resultante para el color es</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//       createState("Hue"); createState("Sat"); //      RGB- on({id: "Hue", ack: false, change: 'any'}, function (obj) {  var hue = parseInt(obj.state.val);  var sat = parseInt(getState('Sat').val);  var res = hsvToRgb(hue, sat, 100);  setRGB(parseInt(res[0]), parseInt(res[1]), parseInt(res[2])); }); //    RGB- function setRGB(r, g, b){  var val = ('00'+r.toString(16)).slice(-2)+('00'+g.toString(16)).slice(-2)+('00'+b.toString(16)).slice(-2);  // RGB-   setState('zigbee.0.00124b0014d016ab.color', val, false); } //   HSV   RGB function hsvToRgb(h, s, v) {  var r, g, b;  var i;  var f, p, q, t;   h = Math.max(0, Math.min(360, h));  s = Math.max(0, Math.min(100, s));  v = Math.max(0, Math.min(100, v));  s /= 100;  v /= 100;   if(s == 0) {      r = g = b = v;      return [          Math.round(r * 255),          Math.round(g * 255),          Math.round(b * 255)      ];  }   h /= 60;  i = Math.floor(h);  f = h - i;  p = v * (1 - s);  q = v * (1 - s * f);  t = v * (1 - s * (1 - f));   switch(i) {      case 0:          r = v;          g = t;          b = p;          break;       case 1:          r = q;          g = v;          b = p;          break;       case 2:          r = p;          g = v;          b = t;          break;       case 3:          r = p;          g = q;          b = v;          break;       case 4:          r = t;          g = p;          b = v;          break;       default: // case 5:          r = v;          g = p;          b = q;  }   return [      Math.round(r * 255),      Math.round(g * 255),      Math.round(b * 255)  ]; }</span></span></code> </pre> </div></div><br><p>  La temperatura de color se puede hacer m√°s f√°cilmente: si se conoce el rango de valores disponibles para su l√°mpara, se puede convertir al intervalo disponible para HomeKit (a trav√©s de la funci√≥n <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">scaleInt</a> ). </p><br><p><img src="https://habrastorage.org/webt/f0/vm/xh/f0vmxhpcndendf_efjf9xrmjxke.png" alt="Servicio de bombilla" title="Servicio de bombilla"></p><br><p><img src="https://habrastorage.org/webt/et/sp/fg/etspfg0idwn5v-cun2hh2y9xmm0.png"></p><br><div class="spoiler">  <b class="spoiler_title">M√°s profundo en la l√°mpara</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/w_/q8/8p/w_q88pboeca8hl0fygtssrjegim.png"><br><img src="https://habrastorage.org/webt/bt/5c/bc/bt5cbc59jttu8ibjev1hfnnwkdm.png"></p></div></div><br><h3 id="termostat">  Termostato </h3><br><p>  Termostato: un dispositivo para mantener la temperatura establecida (servicio del termostato).  En consecuencia, la caracter√≠stica principal del termostato es la temperatura deseada (temperatura objetivo).  Adem√°s de la temperatura establecida, se puede indicar la temperatura actual (CurrentTemperature), que es de naturaleza informativa (ya que el dispositivo solo la lee desde los sensores). </p><br><p>  Desde la aplicaci√≥n Inicio, la temperatura objetivo se establece en el termostato y se rastrea la temperatura actual.  En mi termostato (Zont) solo hab√≠a estos dos estados: estaban disponibles a trav√©s de la API de servicio en la nube. </p><br><p>  Por la belleza de mostrar el dispositivo en HomeKit, tuve que agregar un par de constantes: el estado actual de calentamiento est√° activo (1), el estado objetivo de calentamiento es autom√°tico (3). </p><br><p><img src="https://habrastorage.org/webt/vn/dd/ey/vnddeyypjlofn2jkxrqwe5ybwuw.png" alt="Servicio de termostato" title="Servicio de termostato"></p><br><p><img src="https://habrastorage.org/webt/pk/9u/k3/pk9uk3vfurepl1kfgow5lrp66dc.png"></p><br><div class="spoiler">  <b class="spoiler_title">Selecci√≥n de temperatura</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/_4/g8/co/_4g8coln1rlsodscr8sah8p_h9o.png"></p></div></div><br><h3 id="vorota">  Puertas </h3><br><p>  Con una puerta de garaje (servicio GarageDoorOpener), todo es m√°s complicado que con un termostato. </p><br><p>  De las caracter√≠sticas disponibles, la puerta tiene un estado objetivo (TargetDoorState), que indica nuestro deseo de que la puerta est√© "abierta" o "cerrada".  Pero tambi√©n debe mostrar correctamente el estado actual de la puerta (CurrentDoorState): ¬øest√°n abiertos o cerrados, o tal vez se abren o cierran? </p><br><p>  En mi caso, las puertas se abrieron a trav√©s de mqtt en ioBroker con varios estados de informaci√≥n: </p><br><ul><li>  signo de apertura de puerta (OB) </li><li>  se√±al de movimiento de la puerta (LW) </li></ul><br><p><img src="https://habrastorage.org/webt/aw/b3/ip/awb3ipo5vz8qrn8jawhcfunuouc.png" alt="Estados de control de puertas de garaje" title="Estados de control de puertas de garaje"></p><br><p>  Gracias a estos estados, puede calcular el estado actual de la puerta: </p><br><ul><li>  si no hay OB ni DV, entonces las puertas est√°n cerradas </li><li>  si no hay OB y ‚Äã‚Äãhay un DV, entonces las puertas se abren </li><li>  si hay un OB y ‚Äã‚Äãno DV, entonces las puertas est√°n abiertas </li><li>  si hay un OB y ‚Äã‚Äãhay un DV, entonces la puerta se cierra </li></ul><br><p>  Para enviar una se√±al para abrir y cerrar la puerta, tengo dos estados separados (ser√≠a posible administrar con un estado, pero tengo dos), que env√≠an un mensaje a trav√©s de mqtt al controlador de control de la puerta: </p><br><ul><li>  se√±al de apertura </li><li>  se√±al de cierre </li></ul><br><p>  Para enviar una se√±al, debe simular un bot√≥n de "clic": establezca el valor en verdadero y, despu√©s de un tiempo, rein√≠cielo en falso.  En este sentido, para integrarse con HomeKit, era necesario crear otro estado: el "estado objetivo de la puerta", cuando se cambia, se enviar√° la se√±al correspondiente. </p><br><p>  El signo de apertura de la puerta se puede reemplazar por el estado objetivo (es decir, para qu√© apuntar√° el objetivo) </p><br><ul><li>  si la CA est√° "cerrada" y no hay DV, entonces la puerta est√° cerrada </li><li>  si la CA est√° "cerrada" y hay un DV, entonces las puertas se abren </li><li>  si la CA est√° "abierta" y no hay DV, entonces la puerta est√° abierta </li><li>  si la CA est√° "abierta" y hay un DV, entonces la puerta se cierra </li></ul><br><p>  Tambi√©n crearemos un estado separado "estado de puerta actual", y lo rellenaremos en el script dependiendo del valor de los signos y del estado de destino. </p><br><div class="spoiler">  <b class="spoiler_title">Script de cambio de estado para puertas de garaje</b> <div class="spoiler_text"><pre> <code class="javascript hljs">createState(<span class="hljs-string"><span class="hljs-string">"gate_0.current"</span></span>); <span class="hljs-comment"><span class="hljs-comment">//   createState("gate_0.target"); //   //    0,   300 on({id: "mqtt.0.gate.gpio.13", ack: false, val: 1}, function (obj) {  setStateDelayed("mqtt.0.gate.gpio.13", 0,  300); }); on({id: "mqtt.0.gate.gpio.12", ack: false, val: 1}, function (obj) {  setStateDelayed("mqtt.0.gate.gpio.12", 0,  300); }); //     on({id: "mqtt.0.gate.is_open", ack: false, val: 1}, function (obj) {  // ""  setState("javascript.0.gate_0.current", 0, true); }); on({id: "mqtt.0.gate.is_open", ack: false, val: 0}, function (obj) {  // ""  setState("javascript.0.gate_0.current", 1, true); }); //    - ,      on({id: "javascript.0.gate_0.target", ack: false, val: 0}, function (obj) {  setState("mqtt.0.gate.gpio.12", 1); }); //    - ,      on({id: "javascript.0.gate_0.target", ack: false, val: 1}, function (obj) {  setState("mqtt.0.gate.gpio.13", 1); }); on({id: "mqtt.0.gate.in_progress", ack: true, change: 'any'}, function (obj) {  //    " ",      if (obj.state.val === 1) {      //    "",         const target = getState("javascript.0.gate_0.target");      if (target.val === 0) {          // ""          setState("javascript.0.gate_0.current", 2, true);      } else {          // ""          setState("javascript.0.gate_0.current", 3, true);      }  }  //    " ",      if (obj.state.val === 0) {      //    "",         const target = getState("javascript.0.gate_0.target");      if (target.val === 0) {          // ""          setState("javascript.0.gate_0.current", 0, true);      } else {          // ""          setState("javascript.0.gate_0.current", 1, true);      }  } });</span></span></code> </pre> </div></div><br><p>  Despu√©s de ejecutar el script, puede configurar las caracter√≠sticas del servicio de puerta de garaje: </p><br><p><img src="https://habrastorage.org/webt/lb/cm/t5/lbcmt51du7vnivrjbj2o_h_u28u.png" alt="Servicio GarageDoorOpener" title="Servicio GarageDoorOpener"></p><br><p><img src="https://habrastorage.org/webt/pg/rh/ey/pgrhey_qs-cxm8rg6yj_lufgmgs.png"></p><br><h3 id="kamera">  C√°mara </h3><br><p>  Para agregar una c√°mara a HomeKit, se utilizar√° el m√©todo "cl√°sico".  Se organiza la transmisi√≥n de la imagen desde la c√°mara a trav√©s del m√≥dulo ffmpeg.  A trav√©s de √©l, la secuencia de entrada se codificar√°, cifrar√° y se entregar√° a Homekit. </p><br><p>  En primer lugar, debe instalar ffmpeg en el servidor donde se encuentra ioBroker. </p><br><p>  Para cada plataforma, se instala de diferentes maneras, puede ensamblarlo desde la fuente o buscar un ensamblaje listo, por ejemplo, aqu√≠: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://www.johnvansickle.com/ffmpeg/</a> Debe tener un codificador libx264.  Puede verificar el codificador despu√©s de instalar ffmpeg con el comando: </p><br><pre> <code class="plaintext hljs">ffmpeg -codecs | grep 264</code> </pre> <br><p>  Los resultados deben contener una l√≠nea del formulario: </p><br><pre> <code class="plaintext hljs">DEV.LS h264                 H.264 / AVC / MPEG-4 AVC / MPEG-4 part 10 (decoders: h264 h264_v4l2m2m h264_vdpau ) (encoders: libx264 libx264rgb h264_v4l2m2m )</code> </pre> <br><p>  Para Raspberry Pi 3, puede usar el <a href="">ensamblaje listo para</a> usar, que tiene un c√≥dec compatible con la codificaci√≥n de hardware de GPU (h264_omx, consume menos recursos).  Ponlo as√≠: </p><br><pre> <code class="plaintext hljs">wget https://github.com/legotheboss/YouTube-files/raw/master/ffmpeg_3.1.4-1_armhf.deb sudo dpkg -i ffmpeg_3.1.4-1_armhf.deb</code> </pre> <br><p>  Ambos c√≥decs est√°n presentes en este ensamblado: libx264 y h264_omx </p><br><p>  A continuaci√≥n, debe obtener la direcci√≥n de la transmisi√≥n de la c√°mara que debe transmitirse (este paso est√° m√°s all√° del alcance de este art√≠culo).  Por ejemplo, puede tomar una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">transmisi√≥n p√∫blica preparada</a> . </p><br><p>  Ahora agregue la c√°mara a Yahka, indique la direcci√≥n de la transmisi√≥n y, si es necesario, cambie los par√°metros del c√≥dec, el tama√±o de la imagen y la velocidad de fotogramas. </p><br><p>  <strong>Importante: las combinaciones de par√°metros son muy importantes para la visualizaci√≥n correcta de la c√°mara en Homekit y dependen de la c√°mara y la transmisi√≥n.</strong>  <strong>Tambi√©n afecta el rendimiento del sistema, ya que</strong>  <strong>El proceso de ejecuci√≥n de ffmpeg consume muchos recursos.</strong> </p><br><p><img src="https://habrastorage.org/webt/zh/uj/6g/zhuj6gv7alolh2nfvmpyxgmnoju.png" alt="Agregar una c√°mara" title="Agregar una c√°mara"></p><br><p><img src="https://habrastorage.org/webt/w7/_z/pl/w7_zplfretbtbw0v66nb9ip9ira.png" alt="Configuraci√≥n de transmisi√≥n" title="Configuraci√≥n de transmisi√≥n"></p><br><div class="spoiler">  <b class="spoiler_title">Las c√°maras se agregan como dispositivos separados fuera de la puerta de enlace, y deben agregarse de la misma manera que la puerta de enlace</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/ib/8v/s9/ib8vs9ksuw5mk4ese_-gg6rnrv4.png"></p></div></div><br><p><img src="https://habrastorage.org/webt/0d/hp/qd/0dhpqdbfe_hgez4u7x2edcu92za.png" alt="Miniatura de la c√°mara" title="Miniatura de la c√°mara"></p><br><p><img src="https://habrastorage.org/webt/ue/tj/o4/uetjo4rqvi-fsae2rlkt56cmaji.png" alt="Transmitido desde la c√°mara" title="Transmitido desde la c√°mara"></p><br><h3 id="bonus">  Bono </h3><br><p>  Como beneficio adicional, hablar√© sobre el uso inusual de la transmisi√≥n de la c√°mara. </p><br><p>  Usando el mismo ffmpeg, en lugar de la c√°mara, puede intentar transmitir la imagen, cualquier imagen.  Estas im√°genes tambi√©n se pueden combinar con la transmisi√≥n de video.  Puede mostrar texto, gr√°ficos y otra informaci√≥n en la imagen. </p><br><p><img src="https://habrastorage.org/webt/sg/cl/f7/sgclf7ssws1pkm_rlf3qy_avmhi.png" alt="Texto superpuesto" title="Texto superpuesto"></p><br><p>  Como resultado, puede obtener un tablero interesante.  Y si actualiza la imagen peri√≥dicamente, obtiene datos din√°micos. </p><br><p>  Como ejemplo, saqu√© un gr√°fico de cambios en algunos indicadores en forma de una imagen (archivo en el disco).  Este gr√°fico se actualiza una vez por minuto y sobrescribe la imagen en el archivo. </p><br><div class="spoiler">  <b class="spoiler_title">(las funciones createImage1, createImage2, la formaci√≥n de un gr√°fico y la imposici√≥n de texto en una imagen est√°n fuera del alcance de este art√≠culo, pero dar√© una pista).</b> <div class="spoiler_text"><p>  Te dir√© c√≥mo puedes obtener un gr√°fico en forma de imagen. </p><br><p>  IoBroker tiene una forma est√°ndar de crear gr√°ficos: el controlador Flot.  Este controlador est√° emparejado con un controlador web y muestra el resultado en un navegador.  Pero para obtener el gr√°fico creado en el servidor (en el script) como una imagen, se necesita un controlador PhantomJS adicional, que toma una "captura de pantalla" de la p√°gina (en la que dibujaremos un gr√°fico Flot). </p><br><p>  Pero hablar√© sobre una forma alternativa de construir gr√°ficos en el servidor en un script. </p><br><p>  Existe una biblioteca de Chart.js <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">http://www.chartjs.org/</a> que le permite dibujar gr√°ficos atractivos en el navegador (ejemplos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">http://www.chartjs.org/samples/latest/</a> ). </p><br><p>  Para dibujar, utiliza el "lienzo" (lienzo, lienzo) del navegador.  Por lo tanto, para dibujar con esta biblioteca en el servidor, debe usar la versi√≥n "servidor" de los objetos "lienzo" y DOM.  Esto es lo que hace el paquete chartjs-node ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://github.com/vmpowerio/chartjs-node</a> ). </p><br><p>  La dependencia principal para este paquete es el paquete de lienzo ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://github.com/Automattic/node-canvas</a> ), que debe instalarse globalmente (o en la carpeta iobroker).  Es importante instalar todas las dependencias para la plataforma donde coloque <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://github.com/Automattic/node-canvas#compiling</a> . </p><br><p>  Despu√©s de eso, puede agregar chart.js, m√≥dulos chartjs-node en la configuraci√≥n del controlador de JavaScript.  Deben instalarse correctamente, sin errores.  De lo contrario, lidie con los errores y resu√©lvalos. </p><br><p>  Y luego, puedes escribir un gui√≥n. </p><br><p>  A continuaci√≥n se muestra un script para un ejemplo, como  incluye el uso del controlador Historial y usa nombres de estado espec√≠ficos. </p><br><p>  Atencion  El gui√≥n tiene construcciones complicadas para principiantes: Promise.  Esta es una forma conveniente de no escribir funciones con devoluci√≥n de llamada, sino de hacer cadenas de pasos.  Entonces, por ejemplo, es conveniente hacer esto para obtener datos de la historia de los estados. </p><br><pre> <code class="javascript hljs"><span class="hljs-meta"><span class="hljs-meta">'use strict'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ChartjsNode = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'chartjs-node'</span></span>); <span class="hljs-comment"><span class="hljs-comment">/** *  sendTo  Promise,      */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendToPromise</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">adapter, cmd, params</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">resolve, reject</span></span></span><span class="hljs-function">) =&gt;</span></span> { sendTo(adapter, cmd, params, (result) =&gt; { resolve(result); }); }); } <span class="hljs-comment"><span class="hljs-comment">//    const chartColors = { black: 'rgb(0, 0, 0)', red: 'rgb(255, 99, 132)', orange: 'rgb(255, 159, 64)', yellow: 'rgb(255, 205, 86)', green: 'rgb(75, 192, 192)', blue: 'rgb(54, 162, 235)', purple: 'rgb(153, 102, 255)', grey: 'rgb(201, 203, 207)' }; /** *        * : * @param config -     * @param filename -     * : * @param Promise -    */ function doDraw(config, filename) { //     640x480  var chartNode = new ChartjsNode(640, 480); return chartNode.drawChart(config) .then(() =&gt; { //     return chartNode.writeImageToFile('image/png', filename); }); } /** *     ChartJS. * : * @param Promise -    */ function prepareDraw0(){ // ,    var ; //  Promise     return new Promise((resolve, reject)=&gt;{resolve()}) //       ,      .then(()=&gt;{ //  ,   ,      = [ {"val":3,"ack":1,"ts":1539063874301}, {"val":5,"ack":1,"ts":1539063884299}, {"val":5.3,"ack":1,"ts":1539063894299}, {"val":3.39,"ack":1,"ts":1539063904301}, {"val":5.6,"ack":1,"ts":1539063914300}, {"val":-1.3,"ack":1,"ts":1539063924300}, {"val":-6.3,"ack":1,"ts":1539063934302}, {"val":1.23,"ack":1,"ts":1539063944301}, ]; }) //   -    .then(()=&gt;{ const chartJsOptions = { //   -  type: 'line', data: { //    datasets: [ { //   label: '', //  backgroundColor: chartColors.black, borderColor: chartColors.black, //   pointRadius: 3, //    borderWidth: 3, //     ''        data: .map((item) =&gt; { return {y: item.val, t: new Date(item.ts)} }), //   -  fill: false, } ] }, options: { //   legend: { labels: { //   fontSize: 20, }, }, //   scales: { //  X xAxes: [{ //  -   type: 'time', display: true, //   scaleLabel: { display: true, labelString: '' }, }], //  Y yAxes: [{ //  -  type: 'linear', display: true, //   scaleLabel: { display: true, labelString: '' }, }] } } }; return chartJsOptions; }); } /** *     ChartJS. *         , *     . * * : * @param hours -  ,     * : * @param Promise -    */ function prepareDraw1(hours){ //   ,      const end = new Date().getTime(), start = end - 3600000*(hours || 1); // 1 =   //  ,       //   var , 2, 1, 2, 2; //  Promise     return new Promise((resolve, reject)=&gt;{resolve()}) //       'mqtt.0.ESP_Easy..Temperature' .then(() =&gt; { return sendToPromise('history.0', 'getHistory', { id: 'mqtt.0.ESP_Easy..Temperature', options: { start: start, end: end, aggregate: 'onchange' } } ).then((result) =&gt; { //     ''  = result.result; }); }) //       'sonoff.0.chicken2.DS18B20_Temperature' .then(() =&gt; { return sendToPromise('history.0', 'getHistory', { id: 'sonoff.0.chicken2.DS18B20_Temperature', options: { start: start, end: end, aggregate: 'onchange' } }).then((result)=&gt;{ //     '2' 2 = result.result; }); }) .then(() =&gt; { return sendToPromise('history.0', 'getHistory', { id: 'sonoff.0.sonoff_chicken_vent.DS18B20_Temperature', options: { start: start, end: end, aggregate: 'onchange' } }).then((result)=&gt;{ 1 = result.result; }); }) .then(() =&gt; { return sendToPromise('history.0', 'getHistory', { id: 'sonoff.0.chicken2.POWER1', options: { start: start, end: end, aggregate: 'onchange' } }).then((result)=&gt;{ 2 = result.result; }); }) .then(() =&gt; { return sendToPromise('history.0', 'getHistory', { id: 'sonoff.0.chicken2.POWER2', options: { start: start, end: end, aggregate: 'onchange' } }).then((result)=&gt;{ 2 = result.result; }); }) //   -    .then(()=&gt;{ const chartJsOptions = { //   -  type: 'line', data: { //    datasets: [ { //           label: ' ('+[.length - 1].val+')', //  backgroundColor: chartColors.blue, borderColor: chartColors.blue, //  . 0 -   pointRadius: 0, //    borderWidth: 3, //     ''        data: .map((item) =&gt; { return {y: item.val, t: new Date(item.ts)} }), //   -  fill: false, //   Y yAxisID: 'y-axis-1', },{ label: ' 1 ('+1[1.length - 1].val+')', backgroundColor: chartColors.green, borderColor: chartColors.green, pointRadius: 0, borderWidth: 3, data: 1.map((item) =&gt; { return {y: item.val, t: new Date(item.ts)} }), fill: false, yAxisID: 'y-axis-1', },{ label: ' 2 ('+2[2.length - 1].val+')', backgroundColor: chartColors.red, borderColor: chartColors.red, pointRadius: 0, borderWidth: 3, data: 2.map((item) =&gt; { return {y: item.val, t: new Date(item.ts)} }), fill: false, yAxisID: 'y-axis-1', },{ label: ' 2  ('+2[2.length - 1].val+')', backgroundColor: chartColors.yellow, borderColor: chartColors.yellow, pointRadius: 0, borderWidth: 1, data: 2.map((item) =&gt; { return {y: (item.val) ? 1 : 0, t: new Date(item.ts)} }), fill: true, lineTension: 0, steppedLine: true, yAxisID: 'y-axis-2', },{ label: ' 2  ('+2[2.length - 1].val+')', backgroundColor: chartColors.grey, borderColor: chartColors.grey, pointRadius: 0, borderWidth: 1, data: 2.map((item) =&gt; { return {y: (item.val) ? -1 : 0, t: new Date(item.ts)} }), fill: true, lineTension: 0, steppedLine: true, yAxisID: 'y-axis-2', } ] }, options: { //   legend: { labels: { //   fontSize: 20, }, }, //   scales: { //  X xAxes: [{ //  -   type: 'time', display: true, //   scaleLabel: { display: true, labelString: '' }, //    () time: { unit: 'minute', displayFormats: { minute: 'HH:mm' } }, }], //  Y yAxes: [{ //  -  type: 'linear', display: true, //   scaleLabel: { display: true, labelString: '' }, //   -  position: 'left', //   id: 'y-axis-1', },{ type: 'linear', display: true, scaleLabel: { display: true, labelString: '  ' }, ticks: { min: -4, max: 2 }, //   -  position: 'right', id: 'y-axis-2', }] } } }; return chartJsOptions; }); } function createImage(filename, callback){ // filename -  ,       //    prepareDraw1(2) //     .then((result) =&gt; { //        return doDraw(result, filename); }) .then(()=&gt;{ if (callback) callback(); }) .catch((err)=&gt;{ console.error(err); }); }</span></span></code> </pre> </div></div><br><p><img src="https://habrastorage.org/webt/4c/d5/bs/4cd5bslfzniznrd16qfmqu0tuly.png" alt="Transmitir imagen en lugar de transmitir" title="Transmitir imagen en lugar de transmitir"></p><br><p>  La imagen en miniatura se actualiza aproximadamente una vez por minuto, por lo que configuraremos la imagen para que se actualice cada 10 segundos: </p><br><pre> <code class="plaintext hljs">var fs = require('fs'); //  10    schedule("*/10 * * * * *", () =&gt; {  createImage1('/tmp/1_new.jpg', ()=&gt; {      fs.renameSync('/tmp/1_new.jpg', '/tmp/1.jpg');  });  createImage2('/tmp/2_new.jpg', ()=&gt; {      fs.renameSync('/tmp/2_new.jpg', '/tmp/2.jpg');  }); });</code> </pre> <br><p>  La peculiaridad es que en el proceso de transmisi√≥n de la imagen, es necesario reemplazar la imagen lo suficientemente r√°pido para que ffmpeg no se bloquee :) Por lo tanto, la imagen se forma primero en un archivo, y luego el archivo se renombra al que se utiliz√≥ para la traducci√≥n. </p><br><p>  Ahora, en la configuraci√≥n de la c√°mara, especifique el nombre del archivo generado en lugar de la direcci√≥n de transmisi√≥n y agregue la configuraci√≥n de que la imagen est√° "actualizada" (par√°metro "-loop 1").  Esto se configura en las propiedades avanzadas de la c√°mara.  Estas propiedades no son m√°s que opciones de l√≠nea de comandos para ejecutar ffmpeg.  Por lo tanto, se deben encontrar combinaciones de par√°metros en la documentaci√≥n y ejemplos de ffmpeg. </p><br><p>  Las propiedades se dividen en 2 tipos: para recibir una "vista previa" (una peque√±a imagen de la c√°mara) y para transmitir.  Por lo tanto, puede especificar diferentes archivos de origen de imagen, por ejemplo con diferentes detalles. </p><br><p><img src="https://habrastorage.org/webt/zy/30/b4/zy30b4wc2zud54wr-px_ezovdgu.png" alt="Opciones de inicio de ffmpeg" title="Opciones de inicio de ffmpeg"></p><br><p><img src="https://habrastorage.org/webt/mk/l5/qi/mkl5qizqb41if_youa62qrgm9hc.png" alt="Imagen de transmisi√≥n en vivo" title="Imagen de transmisi√≥n en vivo"></p><br><h3 id="zaklyuchenie">  Conclusi√≥n </h3><br><p>         ioBroker     .       ,       . ,   ,        . </p><br><p>  ,    Yahka       ,      Material.           ,            HomeKit. </p><br><p>       Yahka,    HomeKit     ‚Äî  Ham,     HomeBridge         .       . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es433798/">https://habr.com/ru/post/es433798/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es433786/index.html">Fintech Digest: la criptomoneda es propiedad, se ha emitido un n√∫mero r√©cord de tarjetas de cr√©dito en la Federaci√≥n Rusa</a></li>
<li><a href="../es433788/index.html">Oferta segura y nuevas revisiones independientes</a></li>
<li><a href="../es433790/index.html">Plantillas avanzadas de compilaci√≥n de varias etapas</a></li>
<li><a href="../es433792/index.html">Scripts de shell en Ansible</a></li>
<li><a href="../es433796/index.html">C√≥mo el Homo Sapiens conquist√≥ el mundo. Habilidades de comunicaci√≥n y negociaci√≥n.</a></li>
<li><a href="../es433800/index.html">Usando los controladores UDB PSoC de Cypress para reducir las interrupciones en una impresora 3D</a></li>
<li><a href="../es433802/index.html">C√≥mo y por qu√© ganamos la pista de Big Data en el Hackathon Urban Tech Challenge</a></li>
<li><a href="../es433804/index.html">Redes de densidad de mezclas</a></li>
<li><a href="../es433806/index.html">Cuando el archivo en l√≠nea se olvida</a></li>
<li><a href="../es433808/index.html">5 errores m√°s comunes que cometen los programadores en la entrevista</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>