<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>⏸️ 📶 🎤 如何在Swift框架中嵌入C库 👩‍🎓 👱🏿 👐🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="2014年，Swift被引入，这是一种用于开发Apple生态系统应用程序的新语言。 对于那些想使用旧的C库的人来说，新颖性不仅带来了新的特性和功能，还带来了问题。 在本文中，我将考虑其中之一-Swift框架中的C库捆绑。 有几种解决方法。 在这种情况下，我将说明如何使用clang显式模块执行此操作。...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>如何在Swift框架中嵌入C库</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/badoo/blog/435650/"><img src="https://habrastorage.org/webt/gg/tp/h0/ggtph083gn7erbdli6yhp2kxh_k.jpeg"><br><br>  2014年，Swift被引入，这是一种用于开发Apple生态系统应用程序的新语言。 对于那些想使用旧的C库的人来说，新颖性不仅带来了新的特性和功能，还带来了问题。 在本文中，我将考虑其中之一-Swift框架中的C库捆绑。 有几种解决方法。 在这种情况下，我将说明如何使用clang显式模块执行此操作。 <br><br> 例如，我们采用外部<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">libgif</a> C库并将其嵌入到我们的Swift GifSwift框架中。 如果要立即查看结果，可以在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">此处</a>查看整个项目。 <br><a name="habracut"></a><br><h1> 准备libgif </h1><br> 在将libgif库嵌入我们的项目之前，您需要从源代码进行编译。 <br><br><ol><li> 在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">此处</a>下载最新的tarball。 <br></li><li> 使用控制台解压缩存档，转到文件夹并运行： <br><br><pre><code class="plaintext hljs">./configure &amp;&amp; make check</code> </pre> <br>  <b>注意：</b>为简单起见，我们正在为x86-64平台编译一个库，因此该库仅可在iOS模拟器或macOS上运行。 构建多体系结构静态库是一个单独的主题，在本文中我不会涉及。 有用的说明可以在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">这里</a>找到。 <br></li><li> 如果一切顺利，则可以在<code>${lib_gif_source}/lib/.libs</code>找到库文件。 我们对两个文件感兴趣： <br><br><pre> <code class="plaintext hljs">lib/.libs/libgif.a #   lib/gif_lib.h # </code> </pre></li></ol><br><h1> 项目设置 </h1><br> 现在，我们将根据需要定制项目。 <br><br><ol><li> 使用Cocoa Touch Framework模板创建一个新项目，并将其命名为<i>GifSwift</i> 。 <br></li><li> 将我们创建的<i>libgif</i>库文件添加到项目中的单独组中。 <br></li><li> 将测试应用程序的新目标添加到项目中以查看结果。 <br></li></ol><br> 项目的最终结构应如下所示： <br><br><img src="https://habrastorage.org/webt/jz/7_/fw/jz7_fw3f9ht0opyxv5moxnr8v18.png"><br><br><h1> 导入到Swift </h1><br> 为了将C库导入Swift，我们必须将其描述为一个<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">模块</a> 。 描述是一个<b>.modulemap</b>文件，其中包含用于导入的头文件列表和用于链接的静态库列表。 可以将生成的模块导入到Swift或Objective-C代码中（使用<code>@import</code> ）。 <br><br> 这种将库导入框架的方法在大多数情况下都可以使用（ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">在此处</a>了解有关此方法的更多信息）。 如果您正在创建内部框架或只是将应用程序分解为模块，那么它会非常有用。 但是这种方法也有缺点。 例如，如果您想将库转移给使用迦太基，可可足类的人或由于二进制工件而无效。 原因是所生成的框架通常不可移植，因为编译时它会绑定到计算机上模块映射中的头文件和库的特定位置。 <br><br><h1> 显式模块 </h1><br> 为了克服这些限制，我们将使用另一种方法-库的<b>显式</b>模块。 显式模块是使用<i>explicit</i>关键字声明为子模块的模块，位于父模块中， <i>不会</i>自动<i>导入</i> 。 它与用于Objective-C框架的<code>*_Private.h</code>类似。 如果要使用其中声明的API，则必须<b>显式（显式）</b>导入模块<b>。</b> <br><br> 我们正在为框架内的C库创建一个显式模块。 为此，我们需要重新定义生成的Xcode模块。 另外，请注意，我们没有为链接（link gif）指定libgif.a库，而是使用Xcode接口直接在项目中进行设置。 <br><br>  <i>注意：要了解有关显式模块的更多信息<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">，请单击此处。</a></i> <br><br><ol><li> 将一个名为<i>GifSwift.modulemap</i>的文件添加到项目的根文件夹： <br><br><pre> <code class="plaintext hljs">framework module GifSwift { umbrella header "GifSwift.h" explicit module CLibgif { private header "gif_lib.h" } export * }</code> </pre><br> 该文件包含显式<i>CLibgif</i>模块的规范，并包含一个声明的头文件（因为我们的库中只有一个）。 该文件被加载到框架的结果模块中。 <br></li><li> 模块描述文件不需要添加到框架，但是必须在目标设置中指定： <br><br><pre> <code class="plaintext hljs">Build Settings — Packaging — Module Map (MODULEMAP_FILE) = $SRCROOT/GifSwift/GifSwift.modulemap</code> </pre> </li><li>  libgif文件应作为专用标头（ <i>gif_lib.h</i> ）和静态库（ <i>libgif.a</i> ）添加到框架目标。 请注意，C库的头文件已作为私有文件添加到目标中。 这对于我们的显式模块是必需的。 没有什么可以阻止将此头文件公开添加的，但是我们的任务是尽可能简单地隐藏实现细节。 <br><br><img src="https://habrastorage.org/webt/7d/jm/vv/7djmvvleep47_kqy7za8yys17f8.png"><br></li><li> 现在，您可以使用<code>import GifSwift.CLibgif</code>将显式模块<code>import GifSwift.CLibgif</code> <br></li></ol><br><h1> 迅捷包装 </h1><br> 现在，您可以执行我们框架的接口。 一个类就足够了，这是一个具有两个属性的gif： <br><br><pre> <code class="plaintext hljs">import Foundation import GifSwift.CLibgif public class GifFile { private let path: URL private let fileHandlePtr: UnsafeMutablePointer&lt;GifFileType&gt; private var fileHandle: GifFileType { return self.fileHandlePtr.pointee } deinit { DGifCloseFile(self.fileHandlePtr, nil) } // MARK: - API public init?(path: URL) { self.path = path let errorCode = UnsafeMutablePointer&lt;Int32&gt;.allocate(capacity: 1) if let handle = path.path.withCString({ DGifOpenFileName($0, errorCode) }) { self.fileHandlePtr = handle DGifSlurp(handle) } else { debugPrint("Error opening file \(errorCode.pointee)") return nil } } public var size: CGSize { return CGSize(width: Double(fileHandle.SWidth), height: Double(fileHandle.SHeight)) } public var imagesCount: Int { return Int(fileHandle.ImageCount) } }</code> </pre> <br>  <code>GifFile.swift</code>包装了用于处理文件的低级编程接口，并访问了一些属性，将它们映射到更方便的Foundation类型。 <br><br><h1> 检查一下 </h1><br> 为了测试我们的库，我在项目中添加了<i>cat.gif</i>文件： <br><br><pre> <code class="plaintext hljs">import UIKit import GifSwift class ViewController: UIViewController {   override func viewDidLoad() {       super.viewDidLoad()       if let file = GifFile(path: Bundle.main.url(forResource: "cat", withExtension: "gif")!) {           debugPrint("Image has size: \(file.size) and contains \(file.imagesCount) images")       }   } }</code> </pre> <br> 在控制台中运行此代码时，将看到以下内容： <br><br>  <b>“ <i>图片的大小：（250.0，208.0），包含44张图片”</i></b> <b><br><br></b> <h1>  <b>结论</b> </h1> <b><br></b> 生成的框架包含您需要使用的所有内容，具有Swift界面，并且默认情况下对客户端隐藏C代码。 但是，这并非完全正确。 如我上面所述，导入<i>GifSwift.CLibgif</i>可以访问所有私有模块，但是，默认情况下，此封装方法足以隐藏框架实现的细节。 </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN435650/">https://habr.com/ru/post/zh-CN435650/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN435640/index.html">IT领域HR专业人员的事件摘要（2019年1月）</a></li>
<li><a href="../zh-CN435642/index.html">宾得汽车110：“相机在哪个拳头？”</a></li>
<li><a href="../zh-CN435644/index.html">动物园AFL移相器</a></li>
<li><a href="../zh-CN435646/index.html">NB-IoT，窄带物联网。 一般信息，技术功能</a></li>
<li><a href="../zh-CN435648/index.html">Bot从Wikipedia文章中生成教程</a></li>
<li><a href="../zh-CN435652/index.html">如何在Python脚本中不输入密码</a></li>
<li><a href="../zh-CN435654/index.html">自定义CSS属性的陷阱</a></li>
<li><a href="../zh-CN435656/index.html">踏板车劳斯莱斯-Ninebot KickScooter ES4 by Segway</a></li>
<li><a href="../zh-CN435662/index.html">“与Google一样的可靠性和可靠性”-不仅如此：“服务可靠性的计算”一词的翻译</a></li>
<li><a href="../zh-CN435664/index.html">Google搜索引擎欺骗</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>