<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>âœ‹ğŸ» ğŸ¤³ğŸ¾ â¬›ï¸ åœ¨.NET Coreä¸­ä½¿ç”¨DiagnosticSourceï¼šç†è®º âšœï¸ ğŸ§œğŸ½ ğŸˆ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="DiagnosticSourceæ˜¯ä¸€ç»„ç®€å•ä½†éå¸¸æœ‰ç”¨çš„APIï¼ˆåœ¨NuGetåŒ…System.Diagnostics.DiagnosticSourceä¸­æä¾› ï¼‰ï¼Œä¸€æ–¹é¢ï¼Œè¯¥APIå…è®¸å„ç§åº“å‘é€æœ‰å…³å…¶å·¥ä½œçš„å‘½åäº‹ä»¶ï¼Œå¦ä¸€æ–¹é¢ï¼Œå…è®¸åº”ç”¨ç¨‹åºè®¢é˜…è¿™äº›äº‹ä»¶å’Œè¿›ç¨‹ä»–ä»¬ã€‚ 


 æ¯ä¸ªæ­¤ç±»äº‹ä»¶éƒ½åŒ…å«å…¶ä»–ä¿¡æ¯ï¼ˆæœ‰æ•ˆè´Ÿ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>åœ¨.NET Coreä¸­ä½¿ç”¨DiagnosticSourceï¼šç†è®º</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ozontech/blog/435896/"><p>  DiagnosticSourceæ˜¯ä¸€ç»„ç®€å•ä½†éå¸¸æœ‰ç”¨çš„APIï¼ˆåœ¨NuGetåŒ…<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">System.Diagnostics.DiagnosticSourceä¸­æä¾›</a> ï¼‰ï¼Œä¸€æ–¹é¢ï¼Œè¯¥APIå…è®¸å„ç§åº“å‘é€æœ‰å…³å…¶å·¥ä½œçš„å‘½åäº‹ä»¶ï¼Œå¦ä¸€æ–¹é¢ï¼Œå…è®¸åº”ç”¨ç¨‹åºè®¢é˜…è¿™äº›äº‹ä»¶å’Œè¿›ç¨‹ä»–ä»¬ã€‚ </p><br><p> æ¯ä¸ªæ­¤ç±»äº‹ä»¶éƒ½åŒ…å«å…¶ä»–ä¿¡æ¯ï¼ˆæœ‰æ•ˆè´Ÿè½½ï¼‰ï¼Œå¹¶ä¸”ç”±äºäº‹ä»¶æ˜¯åœ¨ä¸å‘é€ç›¸åŒçš„è¿‡ç¨‹ä¸­å¤„ç†çš„ï¼Œå› æ­¤è¯¥ä¿¡æ¯å‡ ä¹å¯ä»¥åŒ…å«ä»»ä½•å¯¹è±¡ï¼Œè€Œæ— éœ€åºåˆ—åŒ–/ååºåˆ—åŒ–ã€‚ </p><br><p> DiagnosticSourceå·²ç»åœ¨AspNetCoreï¼ŒEntityFrameworkCoreï¼ŒHttpClientå’ŒSqlClientä¸­ä½¿ç”¨ï¼Œå®ƒä»¬å®é™…ä¸Šä½¿å¼€å‘äººå‘˜èƒ½å¤Ÿæ‹¦æˆªä¼ å…¥/ä¼ å‡ºçš„HTTPè¯·æ±‚ï¼Œæ•°æ®åº“è¯·æ±‚ä»¥åŠè¯¸å¦‚<code>HttpContext</code> ï¼Œ <code>DbConnection</code> ï¼Œ <code>DbCommand</code> ï¼Œ <code>HttpRequestMessage</code>ç±»çš„è®¿é—®å¯¹è±¡å¦‚æœ‰å¿…è¦çš„å¯¹è±¡ã€‚ </p><br><p> æˆ‘å†³å®šå°†æœ‰å…³DiagnosticSourceçš„æ•…äº‹åˆ†ä¸ºä¸¤ç¯‡ã€‚ åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†é€šè¿‡ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹æ¥åˆ†æè¯¥æœºåˆ¶çš„å·¥ä½œåŸç†ï¼Œ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ¥ä¸‹æ¥ï¼Œ</a>æˆ‘å°†è®¨è®º.NETä¸­å­˜åœ¨çš„å¯ä»¥ä½¿ç”¨å®ƒå¤„ç†çš„äº‹ä»¶ï¼Œå¹¶å±•ç¤ºä¸€äº›åœ¨OZON.ruä¸­ä½¿ç”¨å®ƒçš„ç¤ºä¾‹ã€‚ </p><a name="habracut"></a><br><h2 id="primer"> ä¾‹å­ </h2><br><p> ä¸ºäº†æ›´å¥½åœ°äº†è§£DiagnosticSourceçš„å·¥ä½œæ–¹å¼ï¼Œè¯·è€ƒè™‘ä¸€ä¸ªæ‹¦æˆªæ•°æ®åº“æŸ¥è¯¢çš„å°ä¾‹å­ã€‚ å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªç®€å•çš„æ§åˆ¶å°åº”ç”¨ç¨‹åºï¼Œå®ƒå‘æ•°æ®åº“å‘å‡ºè¯·æ±‚å¹¶åœ¨æ§åˆ¶å°ä¸­æ˜¾ç¤ºç»“æœã€‚ </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConnectionString = <span class="hljs-string"><span class="hljs-string">@"Data Source=localhost;Initial Catalog=master;User ID=sa;Password=Password12!;"</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> answer = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> GetAnswerAsync(); Console.WriteLine(answer); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetAnswerAsync</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> connection = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SqlConnection(ConnectionString)) { <span class="hljs-comment"><span class="hljs-comment">// using Dapper return await connection.QuerySingleAsync&lt;int&gt;("SELECT 42;"); } } }</span></span></code> </pre> <br><p> ä¸ºç®€å•èµ·è§ï¼Œæˆ‘åœ¨Dockerå®¹å™¨ä¸­æå‡ºäº†SQL Serverã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">dockerè¿è¡Œ</b> <div class="spoiler_text"><pre> <code class="bash hljs">docker run --rm --detach --name mssql-server \ --publish 1433:1433 \ --env ACCEPT_EULA=Y \ --env SA_PASSWORD=Password12! \ mcr.microsoft.com/mssql/server:2017-latest</code> </pre> </div></div><br><p> ç°åœ¨ï¼Œå‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªä»»åŠ¡ï¼šæˆ‘ä»¬éœ€è¦ä½¿ç”¨<code>Stopwatch</code>æµ‹é‡å¯¹æ•°æ®åº“çš„æ‰€æœ‰æŸ¥è¯¢çš„æ‰§è¡Œæ—¶é—´ï¼Œå¹¶åœ¨æ§åˆ¶å°ä¸­æ˜¾ç¤ºâ€œè¯·æ±‚â€-â€œè¿è¡Œæ—¶â€å¯¹ã€‚ </p><br><p> å½“ç„¶ï¼Œæ‚¨å¯ä»¥<code>QuerySingleAsync</code>åˆ›å»ºå’Œå¯åŠ¨<code>Stopwatch</code>å®ä¾‹çš„ä»£ç åŒ…è£…<code>QuerySingleAsync</code>è°ƒç”¨<code>QuerySingleAsync</code>åœ¨æ‰§è¡ŒæŸ¥è¯¢ååœæ­¢å®ƒå¹¶æ˜¾ç¤ºç»“æœï¼Œä½†æ˜¯åŒæ—¶å­˜åœ¨ä¸€äº›å›°éš¾ï¼š </p><br><ul><li> å¦‚æœåº”ç”¨ç¨‹åºæœ‰å¤šä¸ªè¯·æ±‚æ€ä¹ˆåŠï¼Ÿ </li><li> å¦‚æœæ‰§è¡Œè¯·æ±‚çš„ä»£ç å·²è¢«ç¼–è¯‘ï¼Œå¹¶ä½œä¸ºNuGetåŒ…è¿æ¥åˆ°åº”ç”¨ç¨‹åºï¼Œè€Œæˆ‘ä»¬æ— æ³•æ›´æ”¹å®ƒï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿ </li><li> å¦‚æœå¯¹æ•°æ®åº“çš„æŸ¥è¯¢ä¸æ˜¯é€šè¿‡Dapperè€Œæ˜¯é€šè¿‡EntityFrameworkè¿›è¡Œçš„ï¼Œå¹¶ä¸”æˆ‘ä»¬æ— æƒè®¿é—®<code>DbCommand</code>å¯¹è±¡æˆ–å°†å®é™…æ‰§è¡Œçš„ç”ŸæˆæŸ¥è¯¢æ–‡æœ¬ï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿ </li></ul><br><p> è®©æˆ‘ä»¬å°è¯•ä½¿ç”¨DiagnosticSourceè§£å†³æ­¤é—®é¢˜ã€‚ </p><br><h3 id="ispolzovanie-nuget-paketa-systemdiagnosticsdiagnosticsource"> ä½¿ç”¨NuGet System.Diagnostics.DiagnosticSourceåŒ… </h3><br><p> è¿æ¥<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">System.Diagnostics.DiagnosticSource</a>çš„NuGetåŒ…åï¼Œè¦åšçš„ç¬¬ä¸€ä»¶äº‹æ˜¯åˆ›å»ºä¸€ä¸ªç±»æ¥å¤„ç†æˆ‘ä»¬æ„Ÿå…´è¶£çš„äº‹ä»¶ï¼š </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ExampleDiagnosticObserver</span></span> { }</code> </pre> <br><p> ä¸ºäº†å¼€å§‹å¤„ç†äº‹ä»¶ï¼Œæ‚¨éœ€è¦åˆ›å»ºæ­¤ç±»çš„å®ä¾‹ï¼Œå¹¶å°†å…¶æ³¨å†Œä¸ºé™æ€å¯¹è±¡<code>DiagnosticListener.AllListeners</code> ï¼ˆä½äº<code>System.Diagnostics</code>å‘½åç©ºé—´ä¸­ï¼‰ä¸­çš„è§‚å¯Ÿè€…ã€‚ æˆ‘ä»¬åœ¨<code>Main</code>å‡½æ•°çš„å¼€å§‹å°±è¿™æ ·åšï¼š </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> observer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ExampleDiagnosticObserver(); IDisposable subscription = DiagnosticListener.AllListeners.Subscribe(observer); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> answer = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> GetAnswerAsync(); Console.WriteLine(answer); }</code> </pre> <br><p> åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç¼–è¯‘å™¨å°†æ­£ç¡®åœ°å‘Šè¯‰æˆ‘ä»¬<code>ExampleDiagnosticObserver</code>ç±»åº”å®ç°<code>IObserver&lt;DiagnosticListener&gt;</code>æ¥å£ã€‚ è®©æˆ‘ä»¬å®ç°å®ƒï¼š </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ExampleDiagnosticObserver</span></span> : <span class="hljs-title"><span class="hljs-title">IObserver</span></span>&lt;<span class="hljs-title"><span class="hljs-title">DiagnosticListener</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> IObserver&lt;DiagnosticListener&gt;.OnNext(DiagnosticListener diagnosticListener) { Console.WriteLine(diagnosticListener.Name); } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> IObserver&lt;DiagnosticListener&gt;.OnError(Exception error) { } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> IObserver&lt;DiagnosticListener&gt;.OnCompleted() { } }</code> </pre> <br><p> å¦‚æœæˆ‘ä»¬ç°åœ¨è¿è¡Œæ­¤ä»£ç ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°ä»¥ä¸‹å†…å®¹å°†æ˜¾ç¤ºåœ¨æ§åˆ¶å°ä¸­ï¼š </p><br><pre> <code class="plaintext hljs">SqlClientDiagnosticListener SqlClientDiagnosticListener 42</code> </pre> <br><p> è¿™æ„å‘³ç€åœ¨.NETä¸­çš„æŸä¸ªåœ°æ–¹ï¼Œä½¿ç”¨åç§°<code>"SqlClientDiagnosticListener"</code>æ³¨å†Œäº†<code>DiagnosticListener</code>ç±»å‹çš„ä¸¤ä¸ªå¯¹è±¡ï¼Œè¯¥å¯¹è±¡åœ¨æ‰§è¡Œæ­¤ä»£ç æ—¶èµ·ä½œç”¨ã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">å®ƒä»¬åœ¨github.comä¸Š</b> <div class="spoiler_text"><p> å®é™…ä¸Šæœ‰ä¸‰ä¸ªï¼Œä½†æ˜¯ç”±äºæˆ‘ä»¬æ²¡æœ‰ä½¿ç”¨<code>SqlTransaction</code> ï¼Œæ‰€ä»¥åªæœ‰ä¸¤ä¸ªèµ·ä½œç”¨ï¼š </p><br><ul><li>  <a href="">https://github.com/dotnet/corefx/blob/v2.2.1/src/System.Data.SqlClient/src/System/Data/SqlClient/SqlConnection.cs#L50</a> </li><li>  <a href="">https://github.com/dotnet/corefx/blob/v2.2.1/src/System.Data.SqlClient/src/System/Data/SqlClient/SqlCommand.cs#L31</a> </li><li>  <a href="">https://github.com/dotnet/corefx/blob/v2.2.1/src/System.Data.SqlClient/src/System/Data/SqlClient/SqlTransaction.cs#L16</a> </li></ul></div></div><br><p>  <code>IObserver&lt;DiagnosticListener&gt;.OnNext</code> <strong>åœ¨é¦–æ¬¡ä½¿ç”¨</strong>åœ¨åº”ç”¨ç¨‹åºä¸­åˆ›å»ºçš„<code>DiagnosticListener</code>æ¯ä¸ªå®ä¾‹<strong>æ—¶</strong>å°±ä¼šè¢«è°ƒç”¨<strong>ä¸€æ¬¡</strong> ï¼ˆé€šå¸¸å®ƒä»¬æ˜¯ä½œä¸ºé™æ€å±æ€§åˆ›å»ºçš„ï¼‰ã€‚ ç°åœ¨ï¼Œæˆ‘ä»¬ä»…åœ¨æ§åˆ¶å°ä¸­æ˜¾ç¤ºäº†<code>DiagnosticListener</code>å®ä¾‹çš„åç§°ï¼Œä½†æ˜¯å®é™…ä¸Šï¼Œæ­¤æ–¹æ³•éœ€è¦æ£€æŸ¥æ­¤åç§°ï¼Œå¹¶ä¸”ï¼Œå¦‚æœæˆ‘ä»¬å¯¹å¤„ç†æ¥è‡ªè¯¥å®ä¾‹çš„äº‹ä»¶æ„Ÿå…´è¶£ï¼Œè¯·ä½¿ç”¨<code>Subscribe</code>æ–¹æ³•è¿›è¡Œ<code>Subscribe</code> ã€‚ </p><br><p> æˆ‘è¿˜æƒ³æŒ‡å‡ºï¼Œå½“æˆ‘ä»¬è°ƒç”¨<code>DiagnosticListener.AllListeners.Subscribe</code>å°†å¾—åˆ°ä¸€ä¸ª<code>subscription</code>å¯¹è±¡ï¼Œè¯¥å¯¹è±¡å®ç°äº†<code>IDisposable</code>æ¥å£ã€‚ åœ¨æ­¤å¯¹è±¡ä¸Šè°ƒç”¨<code>Dispose</code>æ–¹æ³•å°†å¯¼è‡´å–æ¶ˆè®¢é˜…ï¼Œè¯¥è®¢é˜…å¿…é¡»åœ¨<code>IObserver&lt;DiagnosticListener&gt;.OnCompleted</code> ã€‚ </p><br><p> è®©æˆ‘ä»¬å†æ¬¡å®ç°<code>IObserver&lt;DiagnosticListener&gt;</code> ï¼š </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ExampleDiagnosticObserver</span></span> : <span class="hljs-title"><span class="hljs-title">IObserver</span></span>&lt;<span class="hljs-title"><span class="hljs-title">DiagnosticListener</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> List&lt;IDisposable&gt; _subscriptions = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;IDisposable&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> IObserver&lt;DiagnosticListener&gt;.OnNext(DiagnosticListener diagnosticListener) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (diagnosticListener.Name == <span class="hljs-string"><span class="hljs-string">"SqlClientDiagnosticListener"</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> subscription = diagnosticListener.Subscribe(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); _subscriptions.Add(subscription); } } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> IObserver&lt;DiagnosticListener&gt;.OnError(Exception error) { } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> IObserver&lt;DiagnosticListener&gt;.OnCompleted() { _subscriptions.ForEach(x =&gt; x.Dispose()); _subscriptions.Clear(); } }</code> </pre> <br><p> ç°åœ¨ï¼Œç¼–è¯‘å™¨å°†å‘Šè¯‰æˆ‘ä»¬ï¼Œ <code>ExampleDiagnosticObserver</code>ç±»ä¹Ÿåº”å®ç°<code>IObserver&lt;KeyValuePair&lt;string, object&gt;&gt;</code>æ¥å£ã€‚ åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬éœ€è¦å®ç°<code>IObserver&lt;KeyValuePair&lt;string, object&gt;&gt;.OnNext</code> ï¼Œè¯¥<code>IObserver&lt;KeyValuePair&lt;string, object&gt;&gt;.OnNext</code>ä½œä¸ºå‚æ•°æ¥å—<code>KeyValuePair&lt;string, object&gt;</code> ï¼Œå…¶ä¸­é”®æ˜¯äº‹ä»¶çš„åç§°ï¼Œå€¼æ˜¯ä¸€ä¸ªåŒ¿åå¯¹è±¡ï¼ˆé€šå¸¸ï¼‰ï¼Œå®ƒå¸¦æœ‰æˆ‘ä»¬å¯ä»¥ä½¿ç”¨çš„ä»»æ„å‚æ•°è‡ªè¡Œå†³å®šã€‚ è®©æˆ‘ä»¬æ·»åŠ æ­¤æ¥å£çš„å®ç°ï¼š </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ExampleDiagnosticObserver</span></span> : <span class="hljs-title"><span class="hljs-title">IObserver</span></span>&lt;<span class="hljs-title"><span class="hljs-title">DiagnosticListener</span></span>&gt;, <span class="hljs-title"><span class="hljs-title">IObserver</span></span>&lt;<span class="hljs-title"><span class="hljs-title">KeyValuePair</span></span>&lt;<span class="hljs-title"><span class="hljs-title">string</span></span>, <span class="hljs-title"><span class="hljs-title">object</span></span>&gt;&gt; { <span class="hljs-comment"><span class="hljs-comment">// IObserver&lt;DiagnosticListener&gt; implementation // ... void IObserver&lt;KeyValuePair&lt;string, object&gt;&gt;.OnNext(KeyValuePair&lt;string, object&gt; pair) { Write(pair.Key, pair.Value); } void IObserver&lt;KeyValuePair&lt;string, object&gt;&gt;.OnError(Exception error) { } void IObserver&lt;KeyValuePair&lt;string, object&gt;&gt;.OnCompleted() { } private void Write(string name, object value) { Console.WriteLine(name); Console.WriteLine(value); Console.WriteLine(); } }</span></span></code> </pre> <br><p> å¦‚æœç°åœ¨è¿è¡Œç»“æœä»£ç ï¼Œåˆ™æ§åˆ¶å°ä¸­å°†æ˜¾ç¤ºä»¥ä¸‹å†…å®¹ï¼š </p><br><pre> <code class="plaintext hljs">System.Data.SqlClient.WriteConnectionOpenBefore { OperationId = 3da1b5d4-9ce1-4f28-b1ff-6a5bfc9d64b8, Operation = OpenAsync, Connection = System.Data.SqlClient.SqlConnection, Timestamp = 26978341062 } System.Data.SqlClient.WriteConnectionOpenAfter { OperationId = 3da1b5d4-9ce1-4f28-b1ff-6a5bfc9d64b8, Operation = OpenAsync, ConnectionId = 84bd0095-9831-456b-8ebc-cb9dc2017368, Connection = System.Data.SqlClient.SqlConnection, Statistics = System.Data.SqlClient.SqlStatistics+StatisticsDictionary, Timestamp = 26978631500 } System.Data.SqlClient.WriteCommandBefore { OperationId = 5c6d300c-bc49-4f80-9211-693fa1e2497c, Operation = ExecuteReaderAsync, ConnectionId = 84bd0095-9831-456b-8ebc-cb9dc2017368, Command = System.Data.SqlClient.SqlComman d } System.Data.SqlClient.WriteCommandAfter { OperationId = 5c6d300c-bc49-4f80-9211-693fa1e2497c, Operation = ExecuteReaderAsync, ConnectionId = 84bd0095-9831-456b-8ebc-cb9dc2017368, Command = System.Data.SqlClient.SqlComman d, Statistics = System.Data.SqlClient.SqlStatistics+StatisticsDictionary, Timestamp = 26978709490 } System.Data.SqlClient.WriteConnectionCloseBefore { OperationId = 3f6bfd8f-e5f6-48b7-82c7-41aeab881142, Operation = Close, ConnectionId = 84bd0095-9831-456b-8ebc-cb9dc2017368, Connection = System.Data.SqlClient.SqlConnection, Stat istics = System.Data.SqlClient.SqlStatistics+StatisticsDictionary, Timestamp = 26978760625 } System.Data.SqlClient.WriteConnectionCloseAfter { OperationId = 3f6bfd8f-e5f6-48b7-82c7-41aeab881142, Operation = Close, ConnectionId = 84bd0095-9831-456b-8ebc-cb9dc2017368, Connection = System.Data.SqlClient.SqlConnection, Stat istics = System.Data.SqlClient.SqlStatistics+StatisticsDictionary, Timestamp = 26978772888 } 42</code> </pre> <br><p> æ€»å…±ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°å…­ä¸ªäº‹ä»¶ã€‚ å…¶ä¸­ä¸¤ä¸ªåœ¨æ‰“å¼€ä¸æ•°æ®åº“çš„è¿æ¥ä¹‹å‰å’Œä¹‹åæ‰§è¡Œï¼Œä¸¤ä¸ªåœ¨å‘½ä»¤æ‰§è¡Œä¹‹å‰å’Œä¹‹åï¼Œå¦å¤–ä¸¤ä¸ªåœ¨å…³é—­ä¸æ•°æ®åº“çš„è¿æ¥ä¹‹å‰å’Œä¹‹åæ‰§è¡Œã€‚ </p><br><p> æ¯ä¸ªäº‹ä»¶éƒ½åŒ…å«ä¸€ç»„å‚æ•°ï¼Œä¾‹å¦‚<code>OperationId</code> ï¼Œ <code>ConnectionId</code> ï¼Œ <code>Connection</code> ï¼Œ <code>Command</code> ï¼Œé€šå¸¸ä½œä¸ºåŒ¿åå¯¹è±¡çš„å±æ€§ä¼ é€’ã€‚ æ‚¨å¯ä»¥è·å–è¿™äº›å±æ€§çš„ç±»å‹åŒ–å€¼ï¼Œä¾‹å¦‚ï¼Œä½¿ç”¨åå°„ã€‚  ï¼ˆå®é™…ä¸Šï¼Œä½¿ç”¨åå°„å¯èƒ½ä¸æ˜¯å¾ˆç†æƒ³ã€‚æˆ‘ä»¬ä½¿ç”¨DynamicMethodæ¥è·å–äº‹ä»¶å‚æ•°ã€‚ï¼‰ </p><br><p> ç°åœ¨ï¼Œæˆ‘ä»¬å‡†å¤‡è§£å†³æœ€åˆçš„é—®é¢˜-æµ‹é‡å¯¹æ•°æ®åº“çš„æ‰€æœ‰è¯·æ±‚çš„æ‰§è¡Œæ—¶é—´ï¼Œå¹¶å°†å…¶ä¸åŸå§‹è¯·æ±‚ä¸€èµ·æ˜¾ç¤ºåœ¨æ§åˆ¶å°ä¸­ã€‚ </p><br><p> æ›´æ”¹<code>Write</code>æ–¹æ³•çš„å®ç°ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ExampleDiagnosticObserver</span></span> : <span class="hljs-title"><span class="hljs-title">IObserver</span></span>&lt;<span class="hljs-title"><span class="hljs-title">DiagnosticListener</span></span>&gt;, <span class="hljs-title"><span class="hljs-title">IObserver</span></span>&lt;<span class="hljs-title"><span class="hljs-title">KeyValuePair</span></span>&lt;<span class="hljs-title"><span class="hljs-title">string</span></span>, <span class="hljs-title"><span class="hljs-title">object</span></span>&gt;&gt; { <span class="hljs-comment"><span class="hljs-comment">// IObserver&lt;DiagnosticListener&gt; implementation // ... // IObserver&lt;KeyValuePair&lt;string, object&gt;&gt; implementation // ... private readonly AsyncLocal&lt;Stopwatch&gt; _stopwatch = new AsyncLocal&lt;Stopwatch&gt;(); private void Write(string name, object value) { switch (name) { case "System.Data.SqlClient.WriteCommandBefore": { //           _stopwatch.Value = Stopwatch.StartNew(); break; } case "System.Data.SqlClient.WriteCommandAfter": { //           var stopwatch = _stopwatch.Value; stopwatch.Stop(); var command = GetProperty&lt;SqlCommand&gt;(value, "Command"); Console.WriteLine($"CommandText: {command.CommandText}"); Console.WriteLine($"Elapsed: {stopwatch.Elapsed}"); Console.WriteLine(); break; } } } private static T GetProperty&lt;T&gt;(object value, string name) { return (T) value.GetType() .GetProperty(name) .GetValue(value); } }</span></span></code> </pre> <br><p> åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬æˆªå–åˆ°æ•°æ®åº“çš„è¯·æ±‚çš„å¼€å§‹å’Œç»“æŸäº‹ä»¶ã€‚ åœ¨æ‰§è¡Œè¯·æ±‚ä¹‹å‰ï¼Œæˆ‘ä»¬åˆ›å»ºå¹¶å¯åŠ¨ç§’è¡¨ï¼Œå°†å…¶ä¿å­˜åœ¨<code>AsyncLocal&lt;Stopwatch&gt;</code>çš„å˜é‡ä¸­ï¼Œä»¥ä¾¿ç¨åå°†å…¶å–å›ã€‚ æ‰§è¡Œå®Œè¯·æ±‚åï¼Œæˆ‘ä»¬å¾—åˆ°äº†å…ˆå‰å¯åŠ¨çš„ç§’è¡¨ï¼Œå°†å…¶åœæ­¢ï¼Œé€šè¿‡åå°„ä»<code>value</code>å‚æ•°ä¸­è·å–å·²æ‰§è¡Œçš„å‘½ä»¤ï¼Œå¹¶å°†ç»“æœæ‰“å°åˆ°æ§åˆ¶å°ã€‚ </p><br><p> å¦‚æœç°åœ¨è¿è¡Œç»“æœä»£ç ï¼Œåˆ™æ§åˆ¶å°ä¸­å°†æ˜¾ç¤ºä»¥ä¸‹å†…å®¹ï¼š </p><br><pre> <code class="plaintext hljs">CommandText: SELECT 42; Elapsed: 00:00:00.0341357 42</code> </pre> <br><p> çœ‹æ¥æˆ‘ä»¬å·²ç»è§£å†³äº†é—®é¢˜ï¼Œä½†è¿˜æœ‰ä¸€ä¸ªå°ç»†èŠ‚ã€‚ äº‹å®æ˜¯ï¼Œå½“æˆ‘ä»¬è®¢é˜…<code>DiagnosticListener</code>äº‹ä»¶æ—¶ï¼Œæˆ‘ä»¬ç”šè‡³ä»ä¸­å¼€å§‹æ¥æ”¶é‚£äº›æˆ‘ä»¬ä¸æ„Ÿå…´è¶£çš„äº‹ä»¶ï¼Œå¹¶ä¸”ç”±äºå‘æ¯ä¸ªäº‹ä»¶å‘é€äº†å¸¦æœ‰å‚æ•°çš„åŒ¿åå¯¹è±¡ï¼Œå› æ­¤è¿™ä¼šç»™GCé€ æˆé¢å¤–çš„è´Ÿæ‹…ã€‚ </p><br><p> ä¸ºäº†é¿å…è¿™ç§æƒ…å†µå¹¶å‘Šè¯‰æ‚¨æˆ‘ä»¬å°†è¦å¤„ç†<code>DiagnosticListener</code>å“ªäº›äº‹ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è®¢é˜…æ—¶æŒ‡å®š<code>Predicate&lt;string&gt;</code>ç±»å‹çš„ç‰¹æ®Šå§”æ‰˜ï¼Œè¯¥å§”æ‰˜å°†äº‹ä»¶çš„åç§°ä½œä¸ºå‚æ•°ï¼Œå¦‚æœåº”è¯¥å¤„ç†æ­¤äº‹ä»¶ï¼Œåˆ™è¿”å›<code>true</code> ã€‚ </p><br><p>  <code>IObserver&lt;DiagnosticListener&gt;.OnNext</code> ï¼š </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> IObserver&lt;DiagnosticListener&gt;.OnNext(DiagnosticListener diagnosticListener) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (diagnosticListener.Name == <span class="hljs-string"><span class="hljs-string">"SqlClientDiagnosticListener"</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> subscription = diagnosticListener.Subscribe(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, IsEnabled); _subscriptions.Add(subscription); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsEnabled</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> name</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> name == <span class="hljs-string"><span class="hljs-string">"System.Data.SqlClient.WriteCommandBefore"</span></span> || name == <span class="hljs-string"><span class="hljs-string">"System.Data.SqlClient.WriteCommandAfter"</span></span>; }</code> </pre> <br><p> ç°åœ¨ï¼Œä»…å¯¹äº‹ä»¶<code>"System.Data.SqlClient.WriteCommandBefore"</code>å’Œ<code>"System.Data.SqlClient.WriteCommandAfter"</code>è°ƒç”¨æˆ‘ä»¬çš„<code>Write</code>æ–¹æ³•ã€‚ </p><br><h3 id="ispolzovanie-nuget-paketa-microsoftextensionsdiagnosticadapter"> ä½¿ç”¨Microsoftçš„NuGet Package.Extensions.DiagnosticAdapter </h3><br><p> ç”±äºæˆ‘ä»¬é€šå¸¸ä»<code>DiagnosticListener</code>æ¥æ”¶åˆ°çš„äº‹ä»¶å‚æ•°æ˜¯ä½œä¸ºåŒ¿åå¯¹è±¡ä¼ é€’çš„ï¼Œå› æ­¤é€šè¿‡åå°„æ£€ç´¢å®ƒä»¬å¯èƒ½å¤ªæ˜‚è´µäº†ã€‚ å¹¸è¿çš„æ˜¯ï¼Œæœ‰ä¸€ä¸ª<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Microsoft.Extensions.DiagnosticAdapter</a> NuGetåŒ…å¯ä»¥ä½¿ç”¨ä»<code>System.Reflection.Emit</code>ç”Ÿæˆçš„è¿è¡Œæ—¶ä»£ç æ¥ä¸ºæˆ‘ä»¬å®Œæˆæ­¤æ“ä½œã€‚ </p><br><p> ä¸ºäº†ä»<code>DiagnosticListener</code>å®ä¾‹è€Œä¸æ˜¯<code>Subscribe</code>æ–¹æ³•è®¢é˜…äº‹ä»¶æ—¶ä½¿ç”¨æ­¤ç¨‹åºåŒ…ï¼Œå¿…é¡»ä½¿ç”¨<code>SubscribeWithAdapter</code>æ‰©å±•æ–¹æ³•ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸å†éœ€è¦å®ç°<code>IObserver&lt;KeyValuePair&lt;string, object&gt;&gt;</code>æ¥å£ã€‚ è€Œæ˜¯ï¼Œå¯¹äºæˆ‘ä»¬è¦å¤„ç†çš„æ¯ä¸ªäº‹ä»¶ï¼Œæˆ‘ä»¬éœ€è¦å£°æ˜ä¸€ä¸ªå•ç‹¬çš„æ–¹æ³•ï¼Œå¹¶ä½¿ç”¨<code>DiagnosticNameAttribute</code>å±æ€§ï¼ˆä»<code>Microsoft.Extensions.DiagnosticAdapter</code>å‘½åç©ºé—´ï¼‰å¯¹å…¶è¿›è¡Œæ ‡è®°ã€‚ è¿™äº›æ–¹æ³•çš„å‚æ•°å°†æ˜¯æ­£åœ¨å¤„ç†çš„äº‹ä»¶çš„å‚æ•°ã€‚ </p><br><p> å¦‚æœä½¿ç”¨æ­¤NuGetåŒ…é‡å†™<code>ExampleDiagnosticObserver</code>ç±»ï¼Œåˆ™ä¼šå¾—åˆ°ä»¥ä¸‹ä»£ç ï¼š </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ExampleDiagnosticObserver</span></span> : <span class="hljs-title"><span class="hljs-title">IObserver</span></span>&lt;<span class="hljs-title"><span class="hljs-title">DiagnosticListener</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> List&lt;IDisposable&gt; _subscriptions = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;IDisposable&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> IObserver&lt;DiagnosticListener&gt;.OnNext(DiagnosticListener diagnosticListener) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (diagnosticListener.Name == <span class="hljs-string"><span class="hljs-string">"SqlClientDiagnosticListener"</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> subscription = diagnosticListener.SubscribeWithAdapter(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); _subscriptions.Add(subscription); } } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> IObserver&lt;DiagnosticListener&gt;.OnError(Exception error) { } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> IObserver&lt;DiagnosticListener&gt;.OnCompleted() { _subscriptions.ForEach(x =&gt; x.Dispose()); _subscriptions.Clear(); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> AsyncLocal&lt;Stopwatch&gt; _stopwatch = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AsyncLocal&lt;Stopwatch&gt;(); [DiagnosticName(<span class="hljs-string"><span class="hljs-string">"System.Data.SqlClient.WriteCommandBefore"</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnCommandBefore</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { _stopwatch.Value = Stopwatch.StartNew(); } [DiagnosticName(<span class="hljs-string"><span class="hljs-string">"System.Data.SqlClient.WriteCommandAfter"</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnCommandAfter</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DbCommand command</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> stopwatch = _stopwatch.Value; stopwatch.Stop(); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">$"CommandText: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{command.CommandText}</span></span></span><span class="hljs-string">"</span></span>); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">$"Elapsed: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{stopwatch.Elapsed}</span></span></span><span class="hljs-string">"</span></span>); Console.WriteLine(); } }</code> </pre> <br><p> å› æ­¤ï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥æµ‹é‡ä»æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå¯¹æ•°æ®åº“çš„æ‰€æœ‰æŸ¥è¯¢çš„æ‰§è¡Œæ—¶é—´ï¼Œè€Œå®é™…ä¸Šæ— éœ€æ›´æ”¹åº”ç”¨ç¨‹åºæœ¬èº«çš„ä»£ç ã€‚ </p><br><h2 id="sozdanie-sobstvennyh-ekzemplyarov-diagnosticlistener"> åˆ›å»ºè‡ªå·±çš„DiagnosticListenerå®ä¾‹ </h2><br><p> åœ¨å®è·µä¸­ä½¿ç”¨DiagnosticSourceæ—¶ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæ‚¨å°†è®¢é˜…ç°æœ‰äº‹ä»¶ã€‚ æ‚¨å¾ˆå¯èƒ½ä¸å¿…åˆ›å»ºè‡ªå·±çš„<code>DiagnosticListener</code>å®ä¾‹å¹¶å‘é€æ‚¨è‡ªå·±çš„äº‹ä»¶ï¼ˆä»…å½“æ‚¨ä¸å¼€å‘ä»»ä½•åº“æ—¶ï¼‰ï¼Œå› æ­¤æˆ‘ä¸ä¼šåœ¨æ­¤éƒ¨åˆ†ä¸Šè¿›è¡Œè¿‡å¤šä»‹ç»ã€‚ </p><br><p> è¦åˆ›å»ºè‡ªå·±çš„<code>DiagnosticListener</code>å®ä¾‹ï¼Œæ‚¨éœ€è¦åœ¨ä»£ç ä¸­çš„æŸå¤„å°†å…¶å£°æ˜ä¸ºé™æ€å˜é‡ï¼š </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> DiagnosticSource _myDiagnosticSource = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DiagnosticListener(<span class="hljs-string"><span class="hljs-string">"MyLibraty"</span></span>);</code> </pre> <br><p> ä¹‹åï¼Œè¦å‘é€äº‹ä»¶ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å½¢å¼çš„è®¾è®¡ï¼š </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_myDiagnosticSource.IsEnabled(<span class="hljs-string"><span class="hljs-string">"MyEvent"</span></span>)) _myDiagnosticSource.Write(<span class="hljs-string"><span class="hljs-string">"MyEvent"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { <span class="hljs-comment"><span class="hljs-comment">/* parameters */</span></span> });</code> </pre> <br><p> æœ‰å…³åˆ›å»ºè‡ªå·±çš„<code>DiagnosticListener</code>å®ä¾‹çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…ã€Š <a href="">DiagnosticSourceç”¨æˆ·æŒ‡å—ã€‹</a> ï¼Œå…¶ä¸­è¯¦ç»†ä»‹ç»äº†ä½¿ç”¨DiagnosticSourceçš„æœ€ä½³å®è·µã€‚ </p><br><h2 id="zaklyuchenie"> ç»“è®º </h2><br><p> æˆ‘ä»¬ç ”ç©¶çš„ç¤ºä¾‹å½“ç„¶éå¸¸æŠ½è±¡ï¼Œä¸å¤ªå¯èƒ½åœ¨å®é™…é¡¹ç›®ä¸­æœ‰ç”¨ã€‚ ä½†æ˜¯ï¼Œå®ƒå®Œç¾åœ°è¯´æ˜äº†å¦‚ä½•ä½¿ç”¨è¿™ç§æœºåˆ¶æ¥ç›‘è§†å’Œè¯Šæ–­æ‚¨çš„åº”ç”¨ç¨‹åºã€‚ </p><br><p> åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†æä¾›å¯ä»¥é€šè¿‡DiagnosticSourceå¤„ç†çš„æˆ‘æ‰€çŸ¥é“çš„äº‹ä»¶åˆ—è¡¨ï¼Œå¹¶æ˜¾ç¤ºä¸€äº›ä½¿ç”¨å®ƒçš„å®é™…ç¤ºä¾‹ã€‚ </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN435896/">https://habr.com/ru/post/zh-CN435896/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN435884/index.html">é‡‘å±æœç´¢å’Œç¥ç»ç½‘ç»œ</a></li>
<li><a href="../zh-CN435886/index.html">SpaceXå±•ç¤ºäº†StarshipåŸå‹ï¼Œå¹¶å°†å‡å°‘10ï¼…çš„å‘˜å·¥</a></li>
<li><a href="../zh-CN435890/index.html">æ´»è·ƒäººå£«çš„é˜´æš—é¢</a></li>
<li><a href="../zh-CN435892/index.html">ï¼ƒ281ç§»åŠ¨å¼€å‘äººå‘˜çš„æœ‰è¶£ææ–™æ‘˜è¦ï¼ˆ1æœˆ7æ—¥è‡³13æ—¥ï¼‰</a></li>
<li><a href="../zh-CN435894/index.html">ç§äººç­ã€‚ éšè—åœ¨PHPä¸­</a></li>
<li><a href="../zh-CN435898/index.html">åœ¨NALSDé¢è¯•ä¸­åº”è¯¥è€ƒè™‘çš„é—®é¢˜</a></li>
<li><a href="../zh-CN435900/index.html">å°è£…å®ƒ</a></li>
<li><a href="../zh-CN435902/index.html">å¦‚æœä¾›åº”å•†ä¸å…è®¸ï¼Œæ‚¨ä¸èƒ½åªæ¥å—å¹¶ç¼–å†™SELECT ...ï¼Œä½†æ˜¯æˆ‘ä»¬ä¼šå†™</a></li>
<li><a href="../zh-CN435904/index.html">AIå°†å¤§è„‘æ´»åŠ¨è½¬åŒ–ä¸ºè¯­éŸ³</a></li>
<li><a href="../zh-CN435906/index.html">Pacemakerç¾¤é›†å­˜å‚¨+ DRBDï¼ˆåŒä¸»ï¼‰+ ctdb</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>