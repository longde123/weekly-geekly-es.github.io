<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèº‚Äç‚öñÔ∏è üë®üèø‚Äçüî¨ üåÜ Configurar un servidor para desplegar una aplicaci√≥n Rails usando Ansible üíÜüèΩ ‚òÇÔ∏è ü§¶</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="No hace mucho tiempo, necesitaba escribir varios libros de jugadas ansibles para preparar el servidor para implementar la aplicaci√≥n de rieles. Y, sor...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Configurar un servidor para desplegar una aplicaci√≥n Rails usando Ansible</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/460769/"><p>  No hace mucho tiempo, necesitaba escribir varios libros de jugadas ansibles para preparar el servidor para implementar la aplicaci√≥n de rieles.  Y, sorprendentemente, no encontr√© un manual simple paso a paso.  No quer√≠a copiar el libro de jugadas de otra persona sin comprender lo que estaba sucediendo y, como resultado, tuve que leer la documentaci√≥n y recopilar todo yo mismo.  Quiz√°s alguien a quien pueda ayudar a acelerar este proceso con este art√≠culo. </p><br><p>  Lo primero que debe entender es que ansible le proporciona una interfaz conveniente para realizar una lista predefinida de acciones en los servidores remotos a trav√©s de SSH.  Aqu√≠ no hay magia, no puede instalar el complemento y salir de la caja de tiempo de inactividad cero la implementaci√≥n de su aplicaci√≥n con docker, monitoreo y otras cosas.  Para escribir un libro de jugadas, debe saber qu√© es exactamente lo que quiere hacer y c√≥mo hacerlo.  Por lo tanto, no me gustan los libros de jugadas listos para usar del github, o art√≠culos como: "Copiar y ejecutar, funcionar√°". </p><a name="habracut"></a><br><h2 id="chto-nam-nuzhno">  Que necesitamos </h2><br><p>  Como dije, para escribir un libro de jugadas necesitas saber qu√© quieres hacer y c√≥mo hacerlo.  Decidamos lo que necesitamos.  Para una aplicaci√≥n Rails, necesitaremos varios paquetes del sistema: nginx, postgresql (redis, etc.).  Adem√°s, necesitamos un rub√≠ de cierta versi√≥n.  Lo mejor es instalarlo a trav√©s de rbenv (rvm, asdf ...).  Ejecutar todo esto desde la ra√≠z del usuario siempre es una mala idea, por lo que debe crear un usuario separado y configurar los derechos para √©l.  Despu√©s de eso, debe cargar nuestro c√≥digo en el servidor, copiar las configuraciones para nginx, postgres, etc. e iniciar todos estos servicios. </p><br><p>  <strong>Como resultado, la secuencia de acciones es la siguiente:</strong> </p><br><ol><li>  Inicie sesi√≥n como root </li><li>  instalar paquetes del sistema </li><li>  crear un nuevo usuario, configurar derechos, clave ssh </li><li>  configurar paquetes del sistema (nginx, etc.) y ejecutarlos </li><li>  Cree un usuario en la base de datos (puede crear inmediatamente una base de datos) </li><li>  Inicie sesi√≥n como nuevo usuario </li><li>  Instalar rbenv y ruby </li><li>  Instalar el paquete </li><li>  Rellene el c√≥digo de solicitud </li><li>  Iniciamos el servidor Puma </li></ol><br><p>  Adem√°s, los √∫ltimos pasos se pueden hacer usando capistrano, al menos ella puede copiar el c√≥digo en los directorios de lanzamiento desde el cuadro, cambiar el lanzamiento con un enlace simb√≥lico en una implementaci√≥n exitosa, copiar configuraciones desde el directorio compartido, reiniciar puma, etc.  Todo esto se puede hacer con Ansible, pero ¬øpor qu√©? </p><br><h2 id="faylovaya-struktura">  Estructura de archivo </h2><br><p>  Ansible tiene una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">estructura de archivos</a> estricta para todos sus archivos, por lo que es mejor mantenerlo todo en un directorio separado.  Y no es tan importante si estar√° en la aplicaci√≥n de rieles en s√≠ o por separado.  Puede almacenar archivos en un repositorio git separado.  Personalmente, me pareci√≥ m√°s conveniente crear el directorio ansible en el directorio / config de la aplicaci√≥n rails y almacenar todo en un repositorio. </p><br><h3 id="simple-playbook">  Libro de jugadas simple </h3><br><p>  Playbook es un archivo yml que describe qu√© y c√≥mo debe hacer ansible usando una sintaxis especial.  Creemos el primer libro de jugadas que no hace nada: </p><br><pre><code class="plaintext hljs">--- - name: Simple playbook hosts: all</code> </pre> <br><p>  Aqu√≠, simplemente decimos que nuestro libro de jugadas se llama <code>Simple Playbook</code> y que su contenido deber√≠a ejecutarse para todos los hosts.  Podemos guardarlo en el directorio / ansible con el nombre <code>playbook.yml</code> e intentar ejecutar: </p><br><pre> <code class="plaintext hljs">ansible-playbook ./playbook.yml PLAY [Simple Playbook] ************************************************************************************************************************************ skipping: no hosts matched</code> </pre> <br><p>  Ansible dice que no conoce hosts que coincidan con la lista de todos.  Deben figurar en un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">archivo de inventario</a> especial. </p><br><p>  Vamos a crearlo en el mismo directorio ansible: </p><br><pre> <code class="plaintext hljs">123.123.123.123</code> </pre> <br><p>  As√≠ que solo especifique el host (idealmente, el host de su VPS para las pruebas, o puede registrar localhost) y gu√°rdelo bajo el nombre de <code>inventory</code> . <br>  Puede intentar ejecutar ansible con un archivo invetory: </p><br><pre> <code class="plaintext hljs">ansible-playbook ./playbook.yml -i inventory PLAY [Simple Playbook] ************************************************************************************************************************************ TASK [Gathering Facts] ************************************************************************************************************************************ PLAY RECAP ************************************************************************************************************************************</code> </pre> <br><p>  Si tiene acceso ssh al host especificado, ansible se conectar√° y recopilar√° informaci√≥n sobre el sistema remoto.  (TAREA predeterminada [Hechos de recopilaci√≥n]) despu√©s de lo cual dar√° un breve informe de progreso (REPRODUCCI√ìN DE REPRODUCCI√ìN). </p><br><p>  Por defecto, el nombre de usuario con el que ha iniciado sesi√≥n en el sistema se utiliza para la conexi√≥n.  Lo m√°s probable es que no est√© en el host.  En el archivo de libro de jugadas, puede especificar qu√© usuario usar para conectarse usando la directiva remote_user.  Adem√°s, la informaci√≥n sobre un sistema remoto a menudo puede ser innecesaria para usted y no debe perder el tiempo reuni√©ndola.  Tambi√©n puedes desactivar esta tarea: </p><br><pre> <code class="plaintext hljs">--- - name: Simple playbook hosts: all remote_user: root become: true gather_facts: no</code> </pre> <br><p>  Intente ejecutar el libro de jugadas nuevamente y aseg√∫rese de que la conexi√≥n est√© funcionando.  (Si especific√≥ la ra√≠z del usuario, tambi√©n debe especificar la directiva Become: true para obtener derechos elevados. Como dice la documentaci√≥n: <code>become set to 'true'/'yes' to activate privilege escalation.</code> Aunque no est√° claro por qu√©) . </p><br><p>  Quiz√°s reciba un error causado por el ansible que el int√©rprete de Python no puede determinar, luego puede especificarlo manualmente: </p><br><pre> <code class="plaintext hljs">ansible_python_interpreter: /usr/bin/python3</code> </pre> <br><p>  donde tiene python se puede encontrar con el comando <code>whereis python</code> . </p><br><h3 id="ustanovka-sistemnyh-paketov">  Instalar paquetes del sistema </h3><br><p>  Ansible viene con muchos m√≥dulos para trabajar con varios paquetes del sistema, por lo que no tenemos que escribir scripts de bash por ning√∫n motivo.  Ahora necesitamos uno de estos m√≥dulos para actualizar el sistema e instalar paquetes del sistema.  Tengo Ubuntu Linux en VPS, respectivamente, para instalar paquetes, uso <code>apt-get</code> y un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">m√≥dulo para ello</a> .  Si utiliza un sistema operativo diferente, es posible que necesite un m√≥dulo diferente (recuerde, dije al principio que necesitamos saber de antemano qu√© y c√≥mo lo haremos).  Sin embargo, es probable que la sintaxis sea similar. </p><br><p>  Complementamos nuestro libro de jugadas con las primeras tareas: </p><br><pre> <code class="plaintext hljs">--- - name: Simple playbook hosts: all remote_user: root become: true gather_facts: no tasks: - name: Update system apt: update_cache=yes - name: Install system dependencies apt: name: git,nginx,redis,postgresql,postgresql-contrib state: present</code> </pre> <br><p>  La tarea es solo la tarea que ansible realizar√° en servidores remotos.  Le damos un nombre a la tarea para seguir su progreso en el registro.  Y describimos, utilizando la sintaxis de un m√≥dulo espec√≠fico, lo que debe hacer.  En este caso, <code>apt: update_cache=yes</code> - dice que actualice los paquetes del sistema usando el m√≥dulo apt.  El segundo equipo es un poco m√°s complicado.  Pasamos la lista de paquetes al m√≥dulo apt, y decimos que su <code>state</code> debe estar <code>present</code> , es decir, decimos instalar estos paquetes.  Del mismo modo, podemos decirles que se eliminen o actualicen simplemente cambiando el <code>state</code> .  Tenga en cuenta que para que los rieles funcionen con postgresql, necesitamos el paquete postgresql-contrib que estamos instalando actualmente.  Esto nuevamente necesita ser conocido y hecho, ansible por s√≠ mismo no lo har√°. </p><br><p>  Intente ejecutar el libro de jugadas nuevamente y verifique que los paquetes est√©n instalados. </p><br><h3 id="sozdanie-novyh-polzovateley">  Creaci√≥n de nuevos usuarios. </h3><br><p>  Para trabajar con usuarios, Ansible tambi√©n tiene un m√≥dulo: usuario.  Agregue otra tarea (escond√≠ las partes ya conocidas del libro de jugadas detr√°s de los comentarios, para no copiarlo por completo cada vez): </p><br><pre> <code class="plaintext hljs">--- - name: Simple playbook # ... tasks: # ... - name: Add a new user user: name: my_user shell: /bin/bash password: "{{ 123qweasd | password_hash('sha512') }}"</code> </pre> <br><p>  Creamos un nuevo usuario, le configuramos un esquema y una contrase√±a.  Y luego nos enfrentamos a varios problemas.  ¬øQu√© pasa si los nombres de usuario deben ser diferentes para diferentes hosts?  S√≠, y mantener la contrase√±a abierta en el libro de jugadas es una muy mala idea.  Para comenzar, colocaremos el nombre de usuario y la contrase√±a en variables, y hacia el final del art√≠culo mostrar√© c√≥mo cifrar la contrase√±a. </p><br><pre> <code class="plaintext hljs">--- - name: Simple playbook # ... tasks: # ... - name: Add a new user user: name: "{{ user }}" shell: /bin/bash password: "{{ user_password | password_hash('sha512') }}"</code> </pre> <br><p>  Las variables se establecen usando llaves dobles en los libros de jugadas. </p><br><p>  Indicaremos los valores de las variables en el archivo de inventario: </p><br><pre> <code class="plaintext hljs">123.123.123.123 [all:vars] user=my_user user_password=123qweasd</code> </pre> <br><p>  Preste atenci√≥n a la directiva <code>[all:vars]</code> : dice que el siguiente bloque de texto son variables (vars) y son aplicables a todos los hosts (todos). </p><br><p>  La construcci√≥n de <code>"{{ user_password | password_hash('sha512') }}"</code> tambi√©n <code>"{{ user_password | password_hash('sha512') }}"</code> interesante.  El hecho es que ansible no establece el usuario a trav√©s de <code>user_add</code> como lo har√≠a manualmente.  Y guarda todos los datos directamente, por lo que tambi√©n debemos convertir la contrase√±a a un hash por adelantado, lo que hace este comando. </p><br><p>  Agreguemos nuestro usuario al grupo sudo.  Sin embargo, antes de esto, debe asegurarse de que dicho grupo exista porque nadie har√° esto por nosotros: </p><br><pre> <code class="plaintext hljs">--- - name: Simple playbook # ... tasks: # ... - name: Ensure a 'sudo' group group: name: sudo state: present - name: Add a new user user: name: "{{ user }}" shell: /bin/bash password: "{{ user_password | password_hash('sha512') }}" groups: "sudo"</code> </pre> <br><p>  Es bastante simple, tambi√©n tenemos un m√≥dulo de grupo para crear grupos, con una sintaxis muy similar a apt.  Entonces es suficiente registrar este grupo para el usuario ( <code>groups: "sudo"</code> ). <br>  Tambi√©n es √∫til agregar una clave ssh a este usuario para que podamos iniciar sesi√≥n sin contrase√±a: </p><br><pre> <code class="plaintext hljs">--- - name: Simple playbook # ... tasks: # ... - name: Ensure a 'sudo' group group: name: sudo state: present - name: Add a new user user: name: "{{ user }}" shell: /bin/bash password: "{{ user_password | password_hash('sha512') }}" groups: "sudo" - name: Deploy SSH Key authorized_key: user: "{{ user }}" key: "{{ lookup('file', '~/.ssh/id_rsa.pub') }}" state: present</code> </pre> <br><p>  En este caso, la construcci√≥n <code>"{{ lookup('file', '~/.ssh/id_rsa.pub') }}"</code> es interesante: copia el contenido del archivo id_rsa.pub (su nombre puede diferir), es decir, la parte p√∫blica de la clave ssh y lo carga en la lista de claves autorizadas para el usuario en el servidor. </p><br><h3 id="roli">  Roles </h3><br><p>  Las tres tareas para la creaci√≥n se pueden usar f√°cilmente como un grupo de tareas, y ser√≠a bueno mantener este grupo separado del libro de jugadas principal para que no crezca demasiado.  Hay <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">roles</a> para esto en ansible. <br>  De acuerdo con la estructura de archivos indicada al principio, los roles deben colocarse en un directorio de roles separado, para cada rol: un directorio separado con el mismo nombre, dentro del directorio de tareas, archivos, plantillas, etc. <br>  <code>./ansible/roles/user/tasks/main.yml</code> estructura del archivo: <code>./ansible/roles/user/tasks/main.yml</code> (main es el archivo principal que se cargar√° y ejecutar√° cuando el rol est√© conectado al libro de jugadas, se pueden conectar otros archivos de rol en √©l).  Ahora puede transferir a este archivo todas las tareas relacionadas con el usuario: </p><br><pre> <code class="plaintext hljs"># Create user and add him to groups - name: Ensure a 'sudo' group group: name: sudo state: present - name: Add a new user user: name: "{{ user }}" shell: /bin/bash password: "{{ user_password | password_hash('sha512') }}" groups: "sudo" - name: Deploy SSH Key authorized_key: user: "{{ user }}" key: "{{ lookup('file', '~/.ssh/id_rsa.pub') }}" state: present</code> </pre> <br><p>  En el libro de jugadas principal, debe especificar el uso de la funci√≥n de usuario: </p><br><pre> <code class="plaintext hljs">--- - name: Simple playbook hosts: all remote_user: root gather_facts: no tasks: - name: Update system apt: update_cache=yes - name: Install system dependencies apt: name: git,nginx,redis,postgresql,postgresql-contrib state: present roles: - user</code> </pre> <br><p>  Adem√°s, puede tener sentido realizar una actualizaci√≥n del sistema antes que todas las dem√°s tareas, para esto puede cambiar el nombre del bloque de <code>tasks</code> en el que est√°n definidas en <code>pre_tasks</code> . </p><br><h3 id="nastroyka-nginx">  Configuraci√≥n de Nginx </h3><br><p>  Nginx ya deber√≠a estar instalado con nosotros, debe configurarlo y ejecutarlo.  Hag√°moslo de inmediato en el papel.  Crea una estructura de archivo: </p><br><pre> <code class="plaintext hljs">- ansible - roles - nginx - files - tasks - main.yml - templates</code> </pre> <br><p>  Ahora necesitamos archivos y plantillas.  La diferencia entre los dos es que los archivos ansibles se copian directamente, tal como est√°n.  Y las plantillas deben tener la extensi√≥n j2 y pueden usar los valores de las variables usando los mismos corchetes dobles. </p><br><p>  <code>main.yml</code> nginx en el archivo <code>main.yml</code> .  Para esto, tenemos un m√≥dulo systemd: </p><br><pre> <code class="plaintext hljs"># Copy nginx configs and start it - name: enable service nginx and start systemd: name: nginx state: started enabled: yes</code> </pre> <br><p>  Aqu√≠ no solo decimos que nginx debe iniciarse (es decir, ejecutarlo), sino que inmediatamente decimos que debe estar habilitado. <br>  Ahora copie los archivos de configuraci√≥n: </p><br><pre> <code class="plaintext hljs"># Copy nginx configs and start it - name: enable service nginx and start systemd: name: nginx state: started enabled: yes - name: Copy the nginx.conf copy: src: nginx.conf dest: /etc/nginx/nginx.conf owner: root group: root mode: '0644' backup: yes - name: Copy template my_app.conf template: src: my_app_conf.j2 dest: /etc/nginx/sites-available/my_app.conf owner: root group: root mode: '0644'</code> </pre> <br><p>  Creamos el archivo de configuraci√≥n principal de nginx (puede tomarlo directamente del servidor o escribirlo usted mismo).  Y tambi√©n el archivo de configuraci√≥n para nuestra aplicaci√≥n en el directorio sites_available (esto no es necesario pero es √∫til).  En el primer caso, usamos el m√≥dulo de copia para copiar archivos (el archivo debe estar en <code>/ansible/roles/nginx/files/nginx.conf</code> ).  En el segundo, copie la plantilla, sustituyendo los valores de las variables.  La plantilla debe estar en <code>/ansible/roles/nginx/templates/my_app.j2</code> ).  Y puede verse m√°s o menos as√≠: </p><br><pre> <code class="plaintext hljs">upstream {{ app_name }} { server unix:{{ app_path }}/shared/tmp/sockets/puma.sock; } server { listen 80; server_name {{ server_name }} {{ inventory_hostname }}; root {{ app_path }}/current/public; try_files $uri/index.html $uri.html $uri @{{ app_name }}; .... }</code> </pre> <br><p>  Preste atenci√≥n a los insertos <code>{{ app_name }}</code> , <code>{{ app_path }}</code> , <code>{{ server_name }}</code> , <code>{{ inventory_hostname }}</code> : estas son todas las variables cuyos valores ansibles sustituir√°n en la plantilla antes de copiar.  Esto es √∫til si usa el libro de jugadas para diferentes grupos de hosts.  Por ejemplo, podemos complementar nuestro archivo de inventario: </p><br><pre> <code class="plaintext hljs">[production] 123.123.123.123 [staging] 231.231.231.231 [all:vars] user=my_user user_password=123qweasd [production:vars] server_name=production app_path=/home/www/my_app app_name=my_app [staging:vars] server_name=staging app_path=/home/www/my_stage app_name=my_stage_app</code> </pre> <br><p>  Si ejecutamos nuestro libro de jugadas ahora, realizar√° las tareas especificadas para ambos hosts.  Pero al mismo tiempo, para el host de preparaci√≥n, las variables diferir√°n de la producci√≥n, y no solo en roles y libros de jugadas, sino tambi√©n en configuraciones nginx.  <code>{{ inventory_hostname }}</code> no necesita especificarse en el archivo de inventario; esta es una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">variable especial ansible</a> y el host para el que se est√° ejecutando el libro de jugadas se almacena all√≠. <br>  Si desea tener un archivo de inventario para varios hosts y ejecutar solo para un grupo, esto se puede hacer con el siguiente comando: </p><br><pre> <code class="plaintext hljs">ansible-playbook -i inventory ./playbook.yml -l "staging"</code> </pre> <br><p>  Otra opci√≥n es tener archivos de inventario separados para diferentes grupos.  O puede combinar dos enfoques si tiene muchos hosts diferentes. </p><br><p>  Volvamos a la configuraci√≥n de nginx.  Despu√©s de copiar los archivos de configuraci√≥n, necesitamos crear un enlace simb√≥lico en sitest_enabled en my_app.conf desde sites_available.  Y reinicie nginx. </p><br><pre> <code class="plaintext hljs">... # old code in mail.yml - name: Create symlink to sites-enabled file: src: /etc/nginx/sites-available/my_app.conf dest: /etc/nginx/sites-enabled/my_app.conf state: link - name: restart nginx service: name: nginx state: restarted</code> </pre> <br><p>  Aqu√≠ todo es simple: de nuevo, m√≥dulos ansibles con una sintaxis bastante est√°ndar.  Pero hay un punto.  Reiniciar nginx cada vez no tiene sentido.  Not√≥ que no estamos escribiendo comandos de la forma: "haga esto as√≠", la sintaxis se parece m√°s a "esto deber√≠a tener este estado".  Y a menudo as√≠ es como funciona ansible.  Si el grupo ya existe o el paquete del sistema ya est√° instalado, ansible lo comprobar√° y omitir√° la tarea.  Adem√°s, los archivos no se copiar√°n si coinciden completamente con lo que ya est√° en el servidor.  Podemos aprovechar esto y reiniciar nginx solo si se han cambiado los archivos de configuraci√≥n.  Hay una directiva de registro para esto: </p><br><pre> <code class="plaintext hljs"># Copy nginx configs and start it - name: enable service nginx and start systemd: name: nginx state: started enabled: yes - name: Copy the nginx.conf copy: src: nginx.conf dest: /etc/nginx/nginx.conf owner: root group: root mode: '0644' backup: yes register: restart_nginx - name: Copy template my_app.conf template: src: my_app_conf.j2 dest: /etc/nginx/sites-available/my_app.conf owner: root group: root mode: '0644' register: restart_nginx - name: Create symlink to sites-enabled file: src: /etc/nginx/sites-available/my_app.conf dest: /etc/nginx/sites-enabled/my_app.conf state: link - name: restart nginx service: name: nginx state: restarted when: restart_nginx.changed</code> </pre> <br><p>  Si cambia uno de los archivos de configuraci√≥n, se realizar√° la copia y se registrar√° la variable <code>restart_nginx</code> .  Y solo si esta variable se ha registrado, el servicio se reiniciar√°. </p><br><p>  Bueno, por supuesto, debe agregar el rol nginx al libro de jugadas principal. </p><br><h3 id="nastroyka-postgresql">  Configuraci√≥n de Postgresql </h3><br><p>  Necesitamos habilitar postgresql con systemd, tal como lo hicimos con nginx, y tambi√©n crear un usuario que usaremos para acceder a la base de datos y a la base de datos misma. <br>  Cree el rol <code>/ansible/roles/postgresql/tasks/main.yml</code> : </p><br><pre> <code class="plaintext hljs"># Create user in postgresql - name: enable postgresql and start systemd: name: postgresql state: started enabled: yes - name: Create database user become_user: postgres postgresql_user: name: "{{ db_user }}" password: "{{ db_password }}" role_attr_flags: SUPERUSER - name: Create database become_user: postgres postgresql_db: name: "{{ db_name }}" encoding: UTF-8 owner: "{{ db_user }}"</code> </pre> <br><p>  No describir√© c√≥mo agregar variables al inventario, esto ya se ha hecho muchas veces, as√≠ como la sintaxis de los m√≥dulos postgresql_db y postgresql_user.  Se pueden encontrar m√°s datos en la documentaci√≥n.  La directiva <code>become_user: postgres</code> m√°s interesante <code>become_user: postgres</code> .  El hecho es que, de manera predeterminada, solo el usuario postgres tiene acceso a la base de datos postgresql y solo localmente.  Esta directiva nos permite ejecutar comandos en nombre de este usuario (a menos, por supuesto, que tengamos acceso). <br>  Adem√°s, es posible que deba agregar una l√≠nea a pg_hba.conf para abrir el acceso a la base de datos para un nuevo usuario.  Esto se puede hacer de la misma manera que cambiamos la configuraci√≥n de nginx. </p><br><p>  Y, por supuesto, debe agregar el rol de postgresql al libro de jugadas principal. </p><br><h3 id="ustanovka-ruby-cherez-rbenv">  Instalar ruby ‚Äã‚Äãa trav√©s de rbenv </h3><br><p>  Ansible no tiene m√≥dulos para trabajar con rbenv, pero se instala clonando un repositorio git.  Por lo tanto, esta tarea se convierte en la m√°s no est√°ndar.  <code>/ansible/roles/ruby_rbenv/main.yml</code> el rol <code>/ansible/roles/ruby_rbenv/main.yml</code> para ella y comencemos a llenarlo: </p><br><pre> <code class="plaintext hljs"># Install rbenv and ruby - name: Install rbenv become_user: "{{ user }}" git: repo=https://github.com/rbenv/rbenv.git dest=~/.rbenv</code> </pre> <br><p>  Nuevamente usamos la directiva Become_user para trabajar desde debajo del usuario que creamos para estos fines.  Dado que rbenv est√° instalado en su directorio de inicio, no globalmente.  Y tambi√©n usamos el m√≥dulo git para clonar el repositorio especificando repo y dest. </p><br><p>  Luego, necesitamos registrar rbenv init en bashrc y agregar rbenv a PATH en el mismo lugar.  Para esto, tenemos el m√≥dulo lineinfile: </p><br><pre> <code class="plaintext hljs">- name: Add rbenv to PATH become_user: "{{ user }}" lineinfile: path: ~/.bashrc state: present line: 'export PATH="${HOME}/.rbenv/bin:${PATH}"' - name: Add rbenv init to bashrc become_user: "{{ user }}" lineinfile: path: ~/.bashrc state: present line: 'eval "$(rbenv init -)"'</code> </pre> <br><p>  Luego instale ruby_build: </p><br><pre> <code class="plaintext hljs">- name: Install ruby-build become_user: "{{ user }}" git: repo=https://github.com/rbenv/ruby-build.git dest=~/.rbenv/plugins/ruby-build</code> </pre> <br><p>  Y finalmente instalar ruby.  Esto se hace a trav√©s de rbenv, es decir, solo un comando bash: </p><br><pre> <code class="plaintext hljs">- name: Install ruby become_user: "{{ user }}" shell: | export PATH="${HOME}/.rbenv/bin:${PATH}" eval "$(rbenv init -)" rbenv install {{ ruby_version }} args: executable: /bin/bash</code> </pre> <br><p>  Decimos qu√© equipo ejecutar y c√≥mo.  Sin embargo, aqu√≠ nos encontramos con el hecho de que ansible no ejecuta el c√≥digo contenido en bashrc antes de ejecutar los comandos.  Por lo tanto, rbenv tendr√° que definirse directamente en el mismo script. </p><br><p>  El siguiente problema es que el comando de shell no tiene estado en t√©rminos de ansible.  Es decir, una comprobaci√≥n autom√°tica de si esta versi√≥n de ruby ‚Äã‚Äãest√° instalada o no no lo har√°.  Podemos hacerlo nosotros mismos: </p><br><pre> <code class="plaintext hljs">- name: Install ruby become_user: "{{ user }}" shell: | export PATH="${HOME}/.rbenv/bin:${PATH}" eval "$(rbenv init -)" if ! rbenv versions | grep -q {{ ruby_version }} then rbenv install {{ ruby_version }} &amp;&amp; rbenv global {{ ruby_version }} fi args: executable: /bin/bash</code> </pre> <br><p>  Y queda por instalar el paquete: </p><br><pre> <code class="plaintext hljs">- name: Install bundler become_user: "{{ user }}" shell: | export PATH="${HOME}/.rbenv/bin:${PATH}" eval "$(rbenv init -)" gem install bundler</code> </pre> <br><p>  Y nuevamente, agregue nuestro rol ruby_rbenv al libro de jugadas principal. </p><br><h3 id="shared-files">  Archivos compartidos </h3><br><p>  En general, esta configuraci√≥n podr√≠a completarse.  Luego queda ejecutar capistrano y copiar√° el c√≥digo en s√≠, crear√° los directorios necesarios y ejecutar√° la aplicaci√≥n (si todo est√° configurado correctamente).  Sin embargo, a menudo capistrano necesita archivos de configuraci√≥n adicionales, como <code>database.yml</code> o <code>.env</code> copiarlos como archivos y plantillas para nginx.  Solo hay una sutileza.  Antes de copiar archivos, debe crear una estructura de directorio para ellos, algo como esto: </p><br><pre> <code class="plaintext hljs"># Copy shared files for deploy - name: Ensure shared dir become_user: "{{ user }}" file: path: "{{ app_path }}/shared/config" state: directory</code> </pre> <br><p>  especificamos solo un directorio y ansible crear√° autom√°ticamente el padre, si es necesario. </p><br><h2 id="ansible-vault">  B√≥veda Ansible </h2><br><p>  Ya nos hemos topado con el hecho de que los datos secretos como la contrase√±a del usuario pueden aparecer en las variables.  Si cre√≥ un archivo <code>.env</code> para la aplicaci√≥n y <code>database.yml</code> entonces deber√≠a haber a√∫n m√°s datos cr√≠ticos.  Ser√≠a bueno esconderlos de miradas indiscretas.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">La b√≥veda de Ansible se</a> utiliza para esto. </p><br><p>  <code>/ansible/vars/all.yml</code> un archivo para las variables <code>/ansible/vars/all.yml</code> (aqu√≠ puede crear diferentes archivos para diferentes grupos de hosts, al igual que en el archivo de inventario: production.yml, staging.yml, etc.). <br>  En este archivo, debe transferir todas las variables que deben cifrarse con la sintaxis est√°ndar yml: </p><br><pre> <code class="plaintext hljs"># System vars user_password: 123qweasd db_password: 123qweasd # ENV vars aws_access_key_id: xxxxx aws_secret_access_key: xxxxxx aws_bucket: bucket_name rails_secret_key_base: very_secret_key_base</code> </pre> <br><p>  Entonces este archivo se puede cifrar con el comando: </p><br><pre> <code class="plaintext hljs">ansible-vault encrypt ./vars/all.yml</code> </pre> <br><p>  Naturalmente, durante el cifrado ser√° necesario establecer una contrase√±a para el descifrado.  Puede ver lo que aparece dentro del archivo despu√©s de llamar a este comando. </p><br><p>  Usando el <code>ansible-vault decrypt</code> archivo puede ser descifrado, modificado y luego encriptado nuevamente. </p><br><p>  Para trabajar, descifrar el archivo no es necesario.  Lo almacena en forma cifrada y ejecuta el libro de jugadas con el argumento <code>--ask-vault-pass</code> .  Ansible le pedir√° una contrase√±a, obtendr√° las variables y completar√° las tareas.  Todos los datos permanecer√°n encriptados. </p><br><p>  Un comando completo para varios grupos de hosts y una b√≥veda ansible se ver√≠a as√≠: </p><br><pre> <code class="plaintext hljs">ansible-playbook -i inventory ./playbook.yml -l "staging" --ask-vault-pass</code> </pre> <br><p>  Y no te dar√© el texto completo de libros de jugadas y roles, escribe por ti mismo.  Porque lo m√°s sensible es esto: si no entiendes lo que hay que hacer, entonces √©l no lo har√°. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/460769/">https://habr.com/ru/post/460769/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../460743/index.html">Gu√≠a para principiantes de Flutter</a></li>
<li><a href="../460745/index.html">Experiencia en el uso de un m√≥dulo GSM en dom√≥tica</a></li>
<li><a href="../460747/index.html">Busque ganancias o apriete las tuercas: Spotify ha dejado de trabajar directamente con los autores, ¬øqu√© significa?</a></li>
<li><a href="../460751/index.html">C√≥mo lanzamos robots en el peque√±o Chernobyl. Parte 1</a></li>
<li><a href="../460755/index.html">ROS Trolley Robot - Parte 1: Hierro</a></li>
<li><a href="../460773/index.html">Implementaci√≥n de coincidencia de patrones en Java</a></li>
<li><a href="../460777/index.html">Este es el turno: por qu√© Apple ha cambiado los requisitos para los desarrolladores de aplicaciones</a></li>
<li><a href="../460779/index.html">Depuraci√≥n avanzada</a></li>
<li><a href="../460783/index.html">Consenso sobre la reputaci√≥n del nodo. ¬øEs necesario?</a></li>
<li><a href="../460785/index.html">Aplicaciones para libros electr√≥nicos en el sistema operativo Android. Parte 1. Introducci√≥n y aplicaciones de oficina.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>