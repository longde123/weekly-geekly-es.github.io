<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üçë üé∏ üë©üèº‚Äçü§ù‚Äçüë®üèæ Como fizemos amigos na infraestrutura banc√°ria usando o ManageIQ ü•Ñ üë®üèª‚Äç‚úàÔ∏è üëèüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="H√° alguns anos, as principais tend√™ncias eram automa√ß√£o, pr√°ticas de DevOps e a acelera√ß√£o da entrega de valores ao mercado. O Home Credit Bank decidi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como fizemos amigos na infraestrutura banc√°ria usando o ManageIQ</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/homecredit/blog/461891/"><p>  H√° alguns anos, as principais tend√™ncias eram automa√ß√£o, pr√°ticas de DevOps e a acelera√ß√£o da entrega de valores ao mercado.  O Home Credit Bank decidiu acompanhar e se encaminhar para o desenvolvimento da tecnologia, tanto mais que o sussurro aberto de usu√°rios que estavam cansados ‚Äã‚Äãde esperar v√°rios dias para esperar novos recursos para seus importantes projetos se espalhava mais alto no espa√ßo aberto. </p><br><p>  Decidimos come√ßar com o processo de aprova√ß√£o de aplicativos pelos departamentos, que, como em muitas grandes empresas, exigiam tempo e esfor√ßo.  Como primeira tarefa, escolhemos o processo de cria√ß√£o de uma m√°quina virtual, independentemente do ambiente de virtualiza√ß√£o.  Ao fazer uma lista de tarefas, percebemos que seria necess√°rio integrar-se a outros sistemas usados ‚Äã‚Äãna infraestrutura de nosso banco, por exemplo, via API. </p><br><p><img src="https://habrastorage.org/webt/tt/h7/br/tth7br6euodgo1dklwgmaqhdxu4.png" alt="imagem"></p><a name="habracut"></a><br><p> A solu√ß√£o mais adequada foi o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ManageIQ</a> .  Este √© um projeto que a Red Hat adquiriu em 2012 e com base nele criou o produto comercial <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Red Hat CloudForms</a> .  Ao mesmo tempo, o ManageIQ permaneceu no status de um produto de c√≥digo aberto e est√° desenvolvendo paralelamente ao CloudForms. </p><br><p>  O ManageIQ √© escrito em Ruby e suporta um grande n√∫mero de diferentes provedores de virtualiza√ß√£o, nuvens p√∫blicas e containeriza√ß√£o.  No momento, estamos usando uma vers√£o do Gaprindashvili na configura√ß√£o de alta disponibilidade em casa. </p><br><h2>  Como o processo mudou </h2><br><p>  Anteriormente, cada equipe exigia configura√ß√µes separadas em sua √°rea de responsabilidade.  Ap√≥s a prepara√ß√£o preliminar, todos os dados foram coletados e enviados ao administrador, que implantou e configurou a m√°quina virtual.  Em seguida, foi necess√°rio informar, por exemplo, a equipe de monitoramento que um novo host havia aparecido e que precisava ser adicionado ao monitoramento.  Atrasos na comunica√ß√£o, carga de trabalho de especialistas, erros causados ‚Äã‚Äãpelo fator humano podem levar esse processo a v√°rios dias. </p><br><p>  Tendo encaixado todo o processo no ManageIQ, obtivemos os seguintes resultados: </p><br><div class="scrollable-table"><table><thead><tr><th>  Tipo de recurso virtual </th><th>  Antes de introduzir o ManageIQ </th><th>  Depois de implementar o ManageIQ </th></tr></thead><tbody><tr><td>  M√°quina virtual Linux no VMware / oVirt </td><td>  Para um </td><td>  ~ 10 minutos </td></tr><tr><td>  Ambiente de m√°quina virtual do Rancher </td><td>  trabalhando </td><td>  ~ 15 minutos </td></tr><tr><td>  M√°quina virtual do Windows no VMware </td><td>  semanas </td><td>  ~ 25 minutos </td></tr></tbody></table></div><br><p>  A diferen√ßa de hor√°rio se deve ao fato de que, no segundo caso, √© necess√°rio tempo adicional para preparar o host para trabalhar com o Docker, fazer o download e integrar imagens para cont√™ineres de infraestrutura do Artifactory, porque ainda n√£o h√° acesso ao Docker Hub nesse est√°gio.  No caso do Windows, a diferen√ßa √© alcan√ßada devido ao fato de que, em primeiro lugar, o tempo de cria√ß√£o de uma VM do Linux sem personaliza√ß√£o √© de aproximadamente 2 minutos e o de uma VM do Windows √© de 6 minutos.  Em segundo lugar, personalizar o pr√≥prio Windows leva cerca de 10 minutos, contra 2 minutos no Linux. </p><br><p>  10 minutos n√£o √© t√£o r√°pido, j√° que aproximadamente 2 a 3 minutos s√£o gastos diretamente no processo de cria√ß√£o de uma VM.  Durante o tempo restante, o ManageIQ consegue fazer o seguinte: </p><br><ol><li>  O sistema coleta os par√¢metros especificados pelo usu√°rio no formul√°rio de pedido e os decomp√µe em vari√°veis. </li><li>  Uma nova solicita√ß√£o de mudan√ßa √© criada no sistema de gerenciamento de incidentes, que exibe dados sobre o novo recurso. </li><li>  O sistema de consulta de nome de recurso ManageIQ envia um valor para um novo recurso. </li><li>  O sistema de gerenciamento de endere√ßos IP emite um novo endere√ßo com base nos par√¢metros inseridos. </li><li>  Um novo registro DNS √© registrado no servidor DNS local. </li><li>  Com base nos par√¢metros, ambiente e carga de recursos, o tipo de virtualiza√ß√£o e cluster para posicionamento s√£o selecionados. </li><li>  Em seguida, o processo de cria√ß√£o de uma m√°quina virtual com os par√¢metros especificados. </li><li>  Quando a m√°quina virtual √© implantada a partir do modelo, voc√™ precisa executar scripts que far√£o as configura√ß√µes finais: <br><ul><li>  expans√£o de disco para um tamanho especificado, </li><li>  gerando uma nova senha root, alterando-a em um host Linux e gravando em um gerenciador de senhas, </li><li>  criando um arquivo YAML de configura√ß√£o para o Puppet no GitLab, </li><li>  execute runbooks que trazem as configura√ß√µes e atualiza√ß√µes necess√°rias para VMs do Windows ou </li><li>  Inicie o Puppet, que atualizar√° e configurar√° as m√°quinas Linux. </li></ul></li><li>  Depois de tudo isso, a solicita√ß√£o de altera√ß√£o criada na etapa 2 √© fechada.  Dados novos s√£o adicionados a ele, como o endere√ßo IP e o nome do host. </li><li>  Uma nova unidade √© registrada na Base de Gerenciamento de Recursos de Computa√ß√£o (CMDB). </li><li>  A m√°quina virtual √© registrada no Zabbix e adicionada ao monitoramento. </li><li>  O cliente e outras partes interessadas recebem um e-mail com informa√ß√µes sobre a nova unidade criada usando o ManageIQ. </li></ol><br><h2 id="chto-vnutri">  O que h√° dentro </h2><br><p>  Vamos nos aprofundar nos detalhes t√©cnicos do produto.  Por padr√£o, o ManageIQ pode criar uma m√°quina virtual a partir de um modelo.  Como isso difere do que fazemos, por exemplo, no vCenter?  A resposta correta √© nada.  O ManageIQ usa os mesmos m√©todos que os sistemas de virtualiza√ß√£o, mas usa-o em um √∫nico local.  Al√©m disso, voc√™ pode adicionar seus pr√≥prios scripts que n√£o se encaixam no conjunto padr√£o de recursos.  Portanto, se voc√™ possui recursos, por exemplo, no Azure p√∫blico, no vCenter, que √© implantado em seu pr√≥prio hardware, e o cluster Kubernetes est√° girando em outro lugar, tudo isso pode ser gerenciado convenientemente no ManageIQ. </p><br><p>  Al√©m de uma ampla variedade de fornecedores para integra√ß√£o, o ManageIQ possui ferramentas convenientes para personaliza√ß√£o.  Por exemplo, criando formul√°rios convenientes para resolver seu problema: </p><br><p><img src="https://habrastorage.org/webt/ku/7y/l3/ku7yl3xi9trq-9wndv-ad_vlpvu.png"></p><br><p>  Gra√ßas a isso, foi poss√≠vel construir uma interface completa para solicitar uma m√°quina virtual, ajustando todos os par√¢metros necess√°rios nela: </p><br><p><img src="https://habrastorage.org/webt/v7/ey/tf/v7eytf_hbcxxjcpw4hvrzuwyzve.png"></p><br><p>  Selecionamos a quantidade de recursos de computa√ß√£o, SO, preenchemos todas as informa√ß√µes adicionais necess√°rias para a integra√ß√£o com sistemas externos.  Al√©m disso, usando mecanismos internos (sobre eles um pouco mais tarde), o sistema escolhe onde novos recursos ser√£o colocados: o datacenter, cluster, host e armazenamento de dados s√£o selecionados dependendo de todos os par√¢metros inseridos e os recursos s√£o carregados. </p><br><p>  N√£o esque√ßa que as pessoas podem pedir muitos recursos ou nem o que realmente precisam.  Aqui o sistema de solicita√ß√µes e confirma√ß√µes entra em jogo: </p><br><p><img src="https://habrastorage.org/webt/mj/yv/28/mjyv28hsy0ggf6t68jjdkgc8mwc.png"></p><br><p>  Quaisquer recursos solicitados pelo usu√°rio devem ser aprovados pela pessoa respons√°vel.  Em casa, um grupo de arquitetos faz isso. </p><br><h2 id="struktura-avtomatizacii">  Estrutura de automa√ß√£o </h2><br><p>  Se voc√™ decompor todos os processos de automa√ß√£o no ManageIQ em pequenas partes, notar√° uma certa estrutura. </p><br><h3 id="automate-domain">  Automatizar dom√≠nio </h3><br><img align="right" src="https://habrastorage.org/webt/xy/ea/c_/xyeac_nx3if-e4txuiuriic4h0w.png"><br><p>  O armazenamento de dados hospeda todos os dom√≠nios que o ManageIQ possui. </p><br><p>  Por padr√£o, h√° um dom√≠nio ManageIQ, que est√° bloqueado e √© como um modelo de refer√™ncia.  Se voc√™ precisar fazer altera√ß√µes, outro dom√≠nio √© criado, no qual os elementos do dom√≠nio ManageIQ s√£o copiados e alterados para suas pr√≥prias tarefas. </p><br><h3 id="automate-namespace">  Automatizar espa√ßo para nome </h3><br><img align="right" src="https://habrastorage.org/webt/yf/e1/t3/yfe1t3kjxb4rhvenndkfkwtsad4.png"><br><p>  No interior, os dom√≠nios s√£o divididos em partes respons√°veis ‚Äã‚Äãpor processos individuais: essa pode ser a se√ß√£o respons√°vel pelo gerenciamento da infraestrutura (Infraestrutura) ou pelo trabalho com servi√ßos (Servi√ßo).  Temos nosso pr√≥prio espa√ßo para nome, que cont√©m tudo relacionado aos sistemas do banco. </p><br><p>  Considere a estrutura em mais detalhes usando o exemplo do processo de provisionamento para uma nova m√°quina virtual.  √â descrito na classe Automatizar chamada <em>VMProvision_VM</em> . </p><br><h3 id="automate-class">  Automatizar Classe </h3><br><p>  A classe possui uma estrutura que inclui <strong>Inst√¢ncias</strong> , <strong>M√©todos</strong> , <strong>Propriedades</strong> e <strong>Esquema</strong> .  Do ponto de vista da automa√ß√£o, o esquema √© de maior interesse: <br><img src="https://habrastorage.org/webt/vm/jt/lf/vmjtlfd9qpyrqpdpemtxfw2yczs.png"></p><br><p>  O layout √© semelhante ao pipeline nos sistemas de CI / CD.  Ele descreve as etapas que ser√£o executadas no processo de automa√ß√£o. </p><br><h3 id="automate-instance">  Automatizar inst√¢ncia </h3><br><img align="right" src="https://habrastorage.org/webt/ie/wj/fj/iewjfjuzq9rplkcszwsh7wemsqu.png"><br><p>  A classe descrita acima possui duas Inst√¢ncias de Automa√ß√£o.  Cada um deles herda do circuito os est√°gios para os quais o <em>Valor Padr√£o</em> est√° definido.  Os est√°gios que possuem valores nulos s√£o descritos na inst√¢ncia. </p><br><p><img src="https://habrastorage.org/webt/wy/sl/5c/wysl5c2zze_9_sfplsnykplbf_m.png"></p><br><p>  Na inst√¢ncia, os valores apareceram para as etapas que estavam vazias na descri√ß√£o do esquema.  Voc√™ tamb√©m pode ver quem e quando fez a √∫ltima altera√ß√£o. </p><br><p>  Vamos ver o que um dos valores de valor representa: <br><img src="https://habrastorage.org/webt/rd/j_/v7/rdj_v7hc3wgt7dty2zckjltiacg.png"></p><br><p>  Esta √© uma classe Automatizar chamada M√©todos, que possui uma Inst√¢ncia Automatizada.  Seu diagrama descreve o atributo <em>ipam_base_uri</em> e o m√©todo <em>execute</em> .  O m√©todo execute, por sua vez, chama o m√©todo Automatize <em>adquirir_ip</em> . </p><br><h3 id="automate-method">  M√©todo Automatizado </h3><br><p>  Este √© um script Ruby que permite que uma m√°quina virtual se comunique via API REST com outros sistemas.  Por exemplo, como √© o caso do sistema de gerenciamento de espa√ßo de endere√ßo do IPAM.  No IPAM, obtemos o endere√ßo, a m√°scara, a sub-rede e a VLAN da VM.  A dificuldade √© que a m√°quina pode ser implantada em um ambiente de teste ou produtivo, para aplicativos ou bancos de dados.  Ou talvez o servi√ßo de seguran√ßa tenha decidido coloc√°-lo no loop PCI-DSS.  Todas essas informa√ß√µes s√£o coletadas no est√°gio de cria√ß√£o da VM ou transmitidas nos par√¢metros da inst√¢ncia chamada (na captura de tela acima, voc√™ pode ver que o par√¢metro cont√©m a uri pela qual o m√©todo acessar√° o IPAM): </p><br><div class="spoiler">  <b class="spoiler_title">Aqui est√° um c√≥digo Ruby</b> <div class="spoiler_text"><pre><code class="ruby hljs">base_uri = $evm.object[<span class="hljs-string"><span class="hljs-string">'ipam_base_uri'</span></span>] prov = $evm.root[<span class="hljs-string"><span class="hljs-string">"miq_provision"</span></span>] site = prov.get_option(<span class="hljs-symbol"><span class="hljs-symbol">:site</span></span>) app = prov.get_option(<span class="hljs-symbol"><span class="hljs-symbol">:dialog_dropdown_list_information_system</span></span>) crq = prov.get_option(<span class="hljs-symbol"><span class="hljs-symbol">:crq</span></span>) descr = prov.get_option(<span class="hljs-symbol"><span class="hljs-symbol">:dialog_textarea_box_usernotes</span></span>) owner = $evm.root[<span class="hljs-string"><span class="hljs-string">'user'</span></span>].name scope = prov.get_option(<span class="hljs-symbol"><span class="hljs-symbol">:dialog_dropdown_scope</span></span>) environment = prov.get_option(<span class="hljs-symbol"><span class="hljs-symbol">:landscape</span></span>)</code> </pre> <br><p>  <em>$ evm.root</em> √© um m√©todo que retorna tudo o que pode ser armazenado no ManageIQ.  Podem ser informa√ß√µes sobre o usu√°rio, ambiente, vari√°veis, a solicita√ß√£o atual ('miq_request'), etc.  Estamos interessados ‚Äã‚Äãno atual processo de provis√£o. <br><img src="https://habrastorage.org/webt/4m/hz/lm/4mhzlmb6p_lvkagsl7apu41mpdm.png"></p><br><p>  Em seguida, podemos escolher os valores necess√°rios: <em>get_option (: site)</em> escolhe o valor que foi transferido em um dos est√°gios anteriores e, por exemplo, <em>get_option (: dialog_dropdown_list_information_system)</em> seleciona o formul√°rio que o usu√°rio preenche ao solicitar novos recursos. <br>  Todos os valores recebidos s√£o transmitidos por vari√°veis ‚Äã‚Äãno corpo da solicita√ß√£o no formato JSON: </p><br><pre> <code class="ruby hljs">options = { <span class="hljs-symbol"><span class="hljs-symbol">verify:</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">headers:</span></span> {<span class="hljs-string"><span class="hljs-string">"Content-Type"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"application/json"</span></span>}, <span class="hljs-symbol"><span class="hljs-symbol">body:</span></span> { <span class="hljs-string"><span class="hljs-string">"site"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{site}</span></span></span><span class="hljs-string">"</span></span>, <span class="hljs-string"><span class="hljs-string">"env"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{env}</span></span></span><span class="hljs-string">"</span></span>, <span class="hljs-string"><span class="hljs-string">"app"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{app}</span></span></span><span class="hljs-string">"</span></span>, <span class="hljs-string"><span class="hljs-string">"scope"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{scope}</span></span></span><span class="hljs-string">"</span></span>, <span class="hljs-string"><span class="hljs-string">"role"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{role}</span></span></span><span class="hljs-string">"</span></span>, <span class="hljs-string"><span class="hljs-string">"crq"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{crq}</span></span></span><span class="hljs-string">"</span></span>, <span class="hljs-string"><span class="hljs-string">"descr"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{descr}</span></span></span><span class="hljs-string">"</span></span>, <span class="hljs-string"><span class="hljs-string">"owner"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{owner}</span></span></span><span class="hljs-string">"</span></span>, }.to_json, }</code> </pre> <br><p>  Usando esse conjunto de par√¢metros, o IPAM determinar√° inequivocamente em qual VLAN a m√°quina virtual deve estar localizada e retornar√° os par√¢metros de rede. </p></div></div><br><p>  Al√©m de receber dados para a configura√ß√£o correta da VM, o ManageIQ tamb√©m pode gerar informa√ß√µes adicionais para fazer algumas configura√ß√µes no est√°gio do chamado p√≥s-provisionamento (ap√≥s a implanta√ß√£o e o lan√ßamento da m√°quina virtual).  Em Casa, usamos o Puppet para gerenciar configura√ß√µes de host do Linux.  Para cada unidade de computa√ß√£o, crie um arquivo GAML no YAML com um conjunto de grupos: </p><br><div class="spoiler">  <b class="spoiler_title">Um pouco mais de c√≥digo Ruby</b> <div class="spoiler_text"><pre> <code class="ruby hljs">options = { <span class="hljs-symbol"><span class="hljs-symbol">headers:</span></span> {<span class="hljs-string"><span class="hljs-string">"Private-Token"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{api_token}</span></span></span><span class="hljs-string">"</span></span>, <span class="hljs-string"><span class="hljs-string">"Content-Type"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"application/json"</span></span>}, } body = { <span class="hljs-string"><span class="hljs-string">"branch"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{branch}</span></span></span><span class="hljs-string">"</span></span>, <span class="hljs-string"><span class="hljs-string">"author_email"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"email@your.domain"</span></span>, <span class="hljs-string"><span class="hljs-string">"author_name"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"ManageIQ Bot"</span></span>, <span class="hljs-string"><span class="hljs-string">"content"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"commit_message"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"New host created by ManageIQ"</span></span>, } descr = prov.get_option(<span class="hljs-symbol"><span class="hljs-symbol">:long_description</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> descr.<span class="hljs-keyword"><span class="hljs-keyword">include</span></span>?(<span class="hljs-string"><span class="hljs-string">'rancher'</span></span>) &amp;&amp; descr.<span class="hljs-keyword"><span class="hljs-keyword">include</span></span>?(<span class="hljs-string"><span class="hljs-string">'test'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> body[<span class="hljs-symbol"><span class="hljs-symbol">:content</span></span>] = <span class="hljs-string"><span class="hljs-string">"---\ngroups:\n - </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{yaml_server}</span></span></span><span class="hljs-string">\n - rancher\n - user-devops-UDCR"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unless</span></span> descr.<span class="hljs-keyword"><span class="hljs-keyword">include</span></span>?(<span class="hljs-string"><span class="hljs-string">'test'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> descr.<span class="hljs-keyword"><span class="hljs-keyword">include</span></span>?(<span class="hljs-string"><span class="hljs-string">'rancher'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> body[<span class="hljs-symbol"><span class="hljs-symbol">:content</span></span>] = <span class="hljs-string"><span class="hljs-string">"---\ngroups:\n - </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{yaml_server}</span></span></span><span class="hljs-string">\n - rancher\n"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unless</span></span> descr.<span class="hljs-keyword"><span class="hljs-keyword">include</span></span>?(<span class="hljs-string"><span class="hljs-string">'rancher'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> body[<span class="hljs-symbol"><span class="hljs-symbol">:content</span></span>] = <span class="hljs-string"><span class="hljs-string">"---\ngroups:\n - </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{yaml_server}</span></span></span><span class="hljs-string">\n - </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{$is_id}</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> </div></div><br><p>  Os grupos dependem do tipo de m√°quina virtual, do ambiente em que √© criada e do sistema de informa√ß√µes. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/1i/hv/ig/1ihvigmykpbqlihq2l8oturxxk0.png"></div><br><p>  Ap√≥s a conclus√£o bem-sucedida do procedimento, o usu√°rio recebe um email com informa√ß√µes: <br><img src="https://habrastorage.org/webt/qf/j-/br/qfj-brpfqe1ukkcvrw_jdtdpigm.png"></p><br><p>  O texto da carta tamb√©m pode ser ajustado adicionando as informa√ß√µes necess√°rias. <br>  Se ocorrer um erro em qualquer um dos est√°gios cr√≠ticos do processo, voc√™ poder√° adicionar uma condi√ß√£o que declare explicitamente que o processo deve ser interrompido.  Se o erro n√£o tiver consequ√™ncias fatais, indique tamb√©m o que pode ser continuado, apesar do problema. </p><br><h2 id="logirovanie">  Registo </h2><br><p>  O ManageIQ grava logs de tudo o que pode ser rastreado.  O processo de automa√ß√£o √© escrito em automation.log.  Al√©m disso, existem logs de API, v√°rios provedores de nuvem, logs de seguran√ßa e at√© a sa√≠da do comando top √© registrada. </p><br><p>  Para cada evento no circuito, voc√™ pode configurar uma entrada de log do in√≠cio e do fim: <br><img src="https://habrastorage.org/webt/tv/z0/yy/tvz0yyygspvyltb6d_x4ja00hpg.png"></p><br><p>  Al√©m disso, voc√™ pode escrever suas mensagens nos logs: </p><br><pre> <code class="ruby hljs">$evm.log(<span class="hljs-symbol"><span class="hljs-symbol">:info</span></span>, <span class="hljs-string"><span class="hljs-string">"Call job status uri: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{item_uri}</span></span></span><span class="hljs-string">/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{job_id}</span></span></span><span class="hljs-string">/api/json"</span></span>)</code> </pre> <br><p>  Isso √© muito √∫til ao acessar sistemas pela API para entender por que algo deu errado.  Ou, para acompanhar o status atual de um processo demorado, como a execu√ß√£o de um trabalho Jenkins ou o Runbook do SCCM: </p><br><pre> <code class="ruby hljs">$evm.log(<span class="hljs-symbol"><span class="hljs-symbol">:info</span></span>, <span class="hljs-string"><span class="hljs-string">"acquire_osname --- naming jobStatus: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{jobStatus}</span></span></span><span class="hljs-string">"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> jobStatus.to_s == <span class="hljs-string"><span class="hljs-string">"Completed"</span></span></code> </pre> <br><p>  Voc√™ pode usar as fun√ß√µes padr√£o para exce√ß√µes para gravar nos logs: </p><br><pre> <code class="ruby hljs">raise ‚ÄúVM <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> specified‚Äù <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> vm.<span class="hljs-literal"><span class="hljs-literal">nil</span></span>?</code> </pre> <br><p>  Por padr√£o, todos os logs s√£o armazenados na se√ß√£o / var / log / manageiq / *, mas, por experi√™ncia pr√≥pria, posso dizer que procurar um problema atrav√©s do tail e grep n√£o √© a solu√ß√£o mais conveniente.  Como o ManageIQ grava muitos logs diferentes, voc√™ deve redirecionar os logs, por exemplo, para a pilha ELK. </p><br><h2 id="manageiq-api">  API ManageIQ </h2><br><p>  Al√©m de uma interface web amig√°vel, o ManageIQ possui uma API funcional.  Com isso, por exemplo, resolvemos o problema de determinar dinamicamente o identificador do modelo a ser especificado </p><br><div class="spoiler">  <b class="spoiler_title">ao criar uma VM:</b> <div class="spoiler_text"><pre> <code class="ruby hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_template</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(vendor, os, ems)</span></span></span></span> user = <span class="hljs-string"><span class="hljs-string">'</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{user}</span></span></span><span class="hljs-string">'</span></span> pass = <span class="hljs-string"><span class="hljs-string">'</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{pass}</span></span></span><span class="hljs-string">'</span></span> options = { <span class="hljs-symbol"><span class="hljs-symbol">verify:</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">headers:</span></span> {<span class="hljs-string"><span class="hljs-string">"Accept"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"*/*"</span></span>, <span class="hljs-string"><span class="hljs-string">"accept-encoding"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"gzip, deflate"</span></span>}, <span class="hljs-symbol"><span class="hljs-symbol">basic_auth:</span></span> { <span class="hljs-symbol"><span class="hljs-symbol">username:</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{user}</span></span></span><span class="hljs-string">"</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">password:</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{pass}</span></span></span><span class="hljs-string">"</span></span> }, } response = HTTParty.get(<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{host}</span></span></span><span class="hljs-string">/api/templates?filter[]=vendor=%27</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{vendor}</span></span></span><span class="hljs-string">%27&amp;filter[]=name=%27%2A</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{os}</span></span></span><span class="hljs-string">%2A%27&amp;filter[]=ems_id=%27</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{ems}</span></span></span><span class="hljs-string">%27"</span></span>, options).to_s link = JSON.parse(response) link[<span class="hljs-string"><span class="hljs-string">"resources"</span></span>].each <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|r|</span></span> $url = r[<span class="hljs-string"><span class="hljs-string">"href"</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> response = HTTParty.get($url,options).to_s template = [<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{JSON.parse(response)[</span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">'id'</span></span></span></span><span class="hljs-string"><span class="hljs-subst">]}</span></span></span><span class="hljs-string">"</span></span>+<span class="hljs-string"><span class="hljs-string">", "</span></span>+<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{JSON.parse(response)[</span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">'name'</span></span></span></span><span class="hljs-string"><span class="hljs-subst">]}</span></span></span><span class="hljs-string">"</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> template <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> </div></div><br><p>  Usando uma solicita√ß√£o POST e especificando filtros para a pesquisa, obtemos o modelo desejado. <br>  Al√©m de resolver problemas internos, voc√™ pode criar novos m√©todos de API para uso por sistemas externos.  No in√≠cio do artigo, foi mostrado o processo de pedido de uma nova m√°quina virtual usando a interface da web.  E √© assim que parece se voc√™ fizer isso com </p><br><div class="spoiler">  <b class="spoiler_title">Pedido POST:</b> <div class="spoiler_text"><pre> <code class="ruby hljs">curl -X POST \ <span class="hljs-symbol"><span class="hljs-symbol">http:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/Manageiq.hostname/api</span></span><span class="hljs-regexp"><span class="hljs-regexp">/service_catalogs/</span></span><span class="hljs-number"><span class="hljs-number">4</span></span>/service_templates/<span class="hljs-number"><span class="hljs-number">31</span></span> \ -H <span class="hljs-string"><span class="hljs-string">'Authorization: Basic Token-Value'</span></span> \ -H <span class="hljs-string"><span class="hljs-string">'Content-Type: application/json'</span></span> \ -d <span class="hljs-string"><span class="hljs-string">'{ "action": "order", "resource": { "radio_button_vcpu": "a_2", "radio_button_vram": "a_2", "hdd_size": "40", "dropdown_os": "CentOS", "text_box_filter": "dns", "dropdown_list_information_system": "DNS ", "text_box_validator": "OK (DNS )", "textarea_box_usernotes": " ", "dropdown_env": "production", "date_control_retirement_dt": "2022-05-21", "dropdown_scope": "-" } }'</span></span></code> </pre> </div></div><br><h2 id="zaklyuchenie">  Conclus√£o </h2><br><h3 id="plyusy">  Pr√≥s: </h3><br><ul><li>  Incr√≠vel flexibilidade: o ManageIQ n√£o apenas permite que voc√™ personalize o processo de automa√ß√£o conforme necess√°rio, mas tamb√©m permite alterar sua parte visual adicionando bot√µes, campos, etc. </li><li>  Editor de c√≥digo interno com destaque de sintaxe e valida√ß√£o de c√≥digo.  Pareceu-me uma solu√ß√£o muito boa, se voc√™ precisar consertar algo rapidamente. </li><li>  Um grande n√∫mero de fontes com as quais o sistema pode trabalhar.  Nuvens: Amazon EC2, Google Compute Engine, Azure, OpenStack, VMware vCloud.  Infraestrutura: Microsoft SCVMM, diretor da plataforma OpenStack, virtualiza√ß√£o Red Hat, VMware vCenter.  Recipientes: Kubernetes, OpenShift. </li></ul><br><h3 id="minusy">  Contras: </h3><br><ul><li>  Os grandes recursos da ferramenta tamb√©m carregam um ponto negativo.  Nem toda a documenta√ß√£o est√° bem estruturada e, √†s vezes, √© dif√≠cil descobrir onde procurar o que voc√™ precisa.  No entanto, vale ressaltar que a situa√ß√£o est√° mudando para melhor, a documenta√ß√£o √© complementada e aprimorada. </li><li>  Pequena comunidade.  Se voc√™ encontrar algum problema muito espec√≠fico, talvez n√£o consiga "pesquisar" rapidamente a resposta.  Ou n√£o ter sucesso. </li><li>  Um par√°grafo que segue dos dois anteriores.  Algumas coisas, configura√ß√µes e cen√°rios b√°sicos podem ser encontrados na documenta√ß√£o ou na Internet, mas perguntas mais espec√≠ficas e restritas exigiram muito tempo para serem compreendidas e estudadas, incluindo o m√©todo de cutucadas cient√≠ficas: smile: </li></ul><br><h3 id="kak-u-nas-seychas">  Como temos agora: </h3><br><p>  Devido ao fato de o ManageIQ poder aproveitar ao m√°ximo a linguagem Ruby, pudemos integr√°-la para trabalhar com as seguintes APIs: </p><br><ul><li>  Gerenciador de Senhas  Ele gera uma senha root de acordo com os requisitos do servi√ßo de seguran√ßa, grava-a em seu banco de dados e o ManageIQ a usa dentro do sistema operacional; </li><li>  Servi√ßos de orquestra√ß√£o do centro de servi√ßos para gerenciar registros DNS e nomes de host; </li><li>  Rem√©dio BMC.  Todo o processo √© registrado como coment√°rios sobre a solicita√ß√£o.  Ap√≥s a execu√ß√£o bem-sucedida, a solicita√ß√£o √© fechada; </li><li>  CMDB  Informa√ß√µes sobre novas unidades de configura√ß√£o s√£o criadas no banco de dados com todos os dados necess√°rios. </li><li>  Zabbix  Dependendo da afilia√ß√£o com o sistema e o ambiente de informa√ß√µes, os hosts s√£o adicionados aos grupos de monitoramento correspondentes. </li><li>  Rancheiro.  Implementou a cria√ß√£o de novos ambientes, a instala√ß√£o de agentes e o registro de hosts nos ambientes existentes. </li><li>  Jenkins  Jenkins executa tarefas para configurar VMs no oVirt; </li><li>  LDAP  Crie novos grupos que s√£o usados ‚Äã‚Äãpara controlar o acesso em ambientes Rancher e para configurar pol√≠ticas no Vault; </li><li>  Vault  Em Casa, a integra√ß√£o deste produto nos processos banc√°rios est√° apenas come√ßando, mas j√° criamos m√©todos para criar novos grupos, pol√≠ticas e se√ß√µes para armazenamento; </li><li>  O Puppet e o IPAM foram mencionados anteriormente. </li></ul><br><p>  A funcionalidade e os recursos do sistema s√£o muito extensos e eu me familiarizei com muitos deles e continuo me familiarizando no processo de implementa√ß√£o do sistema. <br>  Por exemplo, n√£o mencionei que o sistema tem a capacidade de criar seus pr√≥prios pain√©is com estat√≠sticas, configura√ß√µes de faturamento ou bot√µes, aos quais voc√™ pode anexar scripts individuais ou scripts inteiros.  Voc√™ pode adicionar seus pr√≥prios campos para registrar informa√ß√µes adicionais sobre servi√ßos e m√°quinas virtuais etc. </p><br><h3 id="k-chemu-stremitsya-houm">  O que o Lar busca: </h3><br><ul><li>  Uma atualiza√ß√£o para a vers√£o Hammer, na qual no modo HA voc√™ pode tentar trabalhar com o Ansible embutido. </li><li>  A transi√ß√£o da coordena√ß√£o para cada unidade de recursos virtuais para o gerenciamento.  As equipes poder√£o receber novas VMs ainda mais rapidamente se a cota n√£o estiver esgotada. </li><li>  Desenvolvimento de novos m√©todos para provis√£o adicional a sistemas externos. </li><li>  Por exemplo, v√°rios SaaS, como Jenkins, Logstash, etc. </li><li>  Implementa√ß√£o de novos m√©todos de API em um portal existente para propriet√°rios de sistemas de informa√ß√£o.  Os usu√°rios n√£o precisar√£o pensar em como se integrar ao novo elemento de infraestrutura, apenas o usar√£o como um servi√ßo para obter novos recursos ou alterar os existentes. </li></ul><br><p>  <em>No final, gostaria de lembrar que as ferramentas s√£o √≥timas, mas n√£o se esque√ßa da import√¢ncia da intera√ß√£o entre equipes diferentes.</em>  <em>As altera√ß√µes descritas no artigo n√£o seriam poss√≠veis sem comunica√ß√£o bem estabelecida e intera√ß√£o constante sobre quest√µes emergentes de todas as partes interessadas.</em> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt461891/">https://habr.com/ru/post/pt461891/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt461877/index.html">Java vs Kotlin para Android: opini√µes dos desenvolvedores</a></li>
<li><a href="../pt461879/index.html">O livro "Linux em a√ß√£o"</a></li>
<li><a href="../pt461881/index.html">Guia de registro do Node.js.</a></li>
<li><a href="../pt461885/index.html">EDS √© outro tipo de fraude</a></li>
<li><a href="../pt461887/index.html">Entrando no Aeronet Epis√≥dio 2: Homing Drone</a></li>
<li><a href="../pt461895/index.html">Aprenda enquanto viaja - como dirigimos no 1¬∫ Dia Europeu da An√°lise de Neg√≥cios</a></li>
<li><a href="../pt461897/index.html">Como mantemos a estabilidade do aplicativo Lamoda</a></li>
<li><a href="../pt461899/index.html">Gera√ß√£o de Eventos, CQRS e Laravel</a></li>
<li><a href="../pt461901/index.html">Tr√™s anos de autoteste: como aumentar a velocidade e n√£o apenas</a></li>
<li><a href="../pt461903/index.html">Advers√°rio misterioso: empr√©stimos confusos</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>