<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üîñ üéÖüèº üëú Errores enmascarados en embedd üéå üë©üèª‚Äçü§ù‚Äçüë®üèº üë©üèø‚Äçüè´</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Los enchufes son inevitables al desarrollar cualquier software. En una incrustaci√≥n, sus generosos cinco centavos tambi√©n pueden provocar problemas de...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Errores enmascarados en embedd</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/453944/">  Los enchufes son inevitables al desarrollar cualquier software.  En una incrustaci√≥n, sus generosos cinco centavos tambi√©n pueden provocar problemas de hardware, pero esta es una canci√≥n separada.  Pero emboscadas puramente programadas, cuando te quedas atrapado en un lugar aparentemente vac√≠o ... Para m√≠ hay tres tipos de ellas. <br><br>  La forma m√°s f√°cil es cuando el manual, el est√°ndar o, por ejemplo, el procedimiento para configurar la biblioteca para el hierro no se entiende completamente.  Aqu√≠ est√° claro: no todos los movimientos se han agotado, la paciencia y el trabajo, otros cinco o dos experimentos, y cobrar√°n vida.  Osciloscopio y tyk cient√≠fico para ayudar. <br><br><img src="https://habrastorage.org/webt/uy/nn/ia/uynniacpwibqxoyroe7zgfjijjy.png"><br>  <i>Elegir un divisor de frecuencia para configurar el bus CAN</i> <br><br>  Peor a√∫n, cuando el problema es un error tipogr√°fico o un error en la l√≥gica, que no puede ver en blanco hasta que pase por este lugar veinte veces con los ojos y la depuraci√≥n paso a paso.  Luego amanece, un golpe sonoro en la frente, un grito: "¬°Bueno, eres una especie de babai!", Edici√≥n.  Funciona <br><br>  Y una tercera visi√≥n sombr√≠a: un problema t√©cnico arraigado en una biblioteca extranjera y que se arrastra en el cruce con hierro.  Las pasiones de Shakespeare dan lugar a la luz constante de un monitor.  ‚Äú¬°Por ‚Äã‚Äãqu√© no puede, el sistema no puede comportarse de esta manera, porque nunca puede!  Bueno, de verdad!  ¬°Ah!  No  Recibe, firma. <br><br>  Como resultado, la realidad es m√°s amplia, m√°s amplia y m√°s amplia de lo esperado.  Un par de ejemplos: <br><a name="habracut"></a><br><h2>  Historia No. 1.  Unidad flash MicroSD y trabajo DMA </h2><br><h3>  Anamnesis </h3><br>  Necesita volcar los datos en un archivo en la tarjeta SD.  Por supuesto, no tengo tiempo ni deseo de escribir el sistema de archivos y el controlador SDIO, as√≠ que tomo la biblioteca terminada.  Lo configur√© para hierro, y todo funciona bien.  Al principio  Y luego resulta que los datos se graban salvajemente: los vol√∫menes son precisos, pero en los archivos mismos, se duplican pares separados de bytes triples, luego desaparecen, sin ninguna regularidad.  No esta bien! <br><br>  Los experimentos comienzan.  Estoy escribiendo datos de prueba, todo est√° bien.  Estoy escribiendo combate, una especie de demonio.  Cambio el tama√±o de los b√∫feres de datos, la frecuencia de su descarga, las plantillas de datos son in√∫tiles.  En las memorias intermedias, todo es siempre excelente, los datos en la memoria est√°n en todas partes lo que necesita.  Y, sin embargo, fallas en una unidad flash, aqu√≠ est√°n. <br><br>  Le llev√≥ un par de d√≠as cavar al perro. <br><br><h3>  El diagnostico </h3><br>  El problema estaba en la interacci√≥n de la biblioteca con el equipo <abbr title="Acceso directo a la memoria. Transferencia de datos desde la RAM a la periferia o viceversa sin la participaci√≥n del procesador.">DMA</abbr> . <br><br>  Las tarjetas SD tienen una peculiaridad: est√°n escritas solo en bloques de 512 bytes.  Para hacer esto, la biblioteca almacena los datos en una matriz de 512 bytes, y al llenarlos se descarga desde all√≠ a trav√©s de DMA para flashear.  Pero! <br><br>  Si transfiero al registro un fragmento mayor que &lt;512xN + espacio vac√≠o en el b√∫fer de la biblioteca&gt; bytes, entonces la biblioteca (obviamente, para no empujar la memoria de un lado a otro) hace esto: repone su b√∫fer, lo escribe para flashear , y los siguientes 512xN bytes se lanzan directamente a mi DMA desde mi b√∫fer.  Bueno, si algo queda sin terminar, nuevamente se copia a s√≠ mismo, hasta la pr√≥xima vez. <br><br>  Y todo estar√≠a bien, pero el controlador DMA requiere que los datos se coloquen en la memoria alineada en un l√≠mite de 4 bytes.  El b√∫fer de la biblioteca siempre est√° tan alineado que el lenguaje lo garantiza.  Pero con qu√© direcci√≥n, despu√©s de copiar una parte de los datos, los restantes 512xN con un peque√±o byte comienzan conmigo: Dios sabe.  Y la biblioteca no verifica esto en absoluto: la direcci√≥n, tal como est√°, se pasa al controlador DMA. <br><br>  "Enviaron algo torpe ... Un perro con √©l".  El controlador restablece silenciosamente los 2 bits inferiores de la direcci√≥n transmitida.  Y comienza la transferencia. <br><img src="https://habrastorage.org/webt/cj/vt/eg/cjvtegekkqclanfzdkv8v0xhfsy.png"><br><br>  La direcci√≥n, inicialmente no un m√∫ltiplo de 4, se reemplaza por un m√∫ltiplo - voila, hasta los √∫ltimos tres bytes del b√∫fer de la biblioteca se reescriben en el archivo desde el m√≠o, y el mismo n√∫mero de bytes de mi b√∫fer se pierde sin dejar rastro.  Como resultado, la cantidad total de datos es correcta, las operaciones se realizan sin problemas, pero el disco no tiene sentido. <br><br><h3>  Tratamiento </h3><br>  Tuve que agregar otro b√∫fer inmediatamente antes de llamar a la funci√≥n de grabaci√≥n de hardware.  Si la direcci√≥n de escritura no es un m√∫ltiplo de 4, primero se copian los datos.  Al mismo tiempo, la velocidad promedio aument√≥ debido a una elecci√≥n razonable del tama√±o del b√∫fer.  Por supuesto, tom√≥ memoria, pero lo que son 4 kilobytes por una buena causa, cuando tienes a tu disposici√≥n: ¬°192 ilimitados! <br><br><h2>  Historia No. 2.  Rantime y un mont√≥n </h2><br><h3>  Prologo </h3><br>  Despu√©s del siguiente cambio, el programa comenz√≥ a caer, y de alguna manera cay√≥ muy duro, arrojando el procesador al controlador de <abbr title="Falla severa. El estado del procesador en el que cae despu√©s de que algo realmente sali√≥ mal: por ejemplo, se produjo una interrupci√≥n de hardware y el procesador no pudo leer la direcci√≥n de la funci√≥n del controlador correspondiente">Falla Dif√≠cil</abbr> .  Y lo arroj√≥ all√≠ justo despu√©s del inicio, incluso antes de que la ejecuci√≥n llegara a main (), es decir, ni una sola l√≠nea de mi c√≥digo tuvo tiempo de ejecutarse. <br><br>  La primera impresi√≥n es "el castor est√° muerto, el chip es para reemplazarlo".  Y luego el programador le dio el roble.  Pero no, la versi√≥n anterior del firmware funciona de manera estable, pero la nueva cae constantemente en algunas oscuras profundidades de ensamblaje entre el lanzamiento y mi c√≥digo.  No ten√≠a suposiciones de qu√© tipo de herej√≠a se trataba. <br><br><h3>  Capitulo 1 </h3><br>  Ayud√© a Internet a ver c√≥mo obtener al menos informaci√≥n adicional.  Se busc√≥ en Google el procedimiento para analizar las consecuencias de un incumplimiento por defecto: estado de los registros, volcado de la pila.  Dopilil  Lo us√© <br><br>  Result√≥ que se bloquea debido a un error de operaci√≥n en el bus.  Decid√≠ que este era nuevamente el acceso desequilibrado, un problema del mismo tipo que en la primera historia, pero desde una perspectiva diferente.  Pero lo m√°s opuesto es d√≥nde ocurri√≥ el error.  Y surgi√≥ dentro de la biblioteca de tiempo de ejecuci√≥n, es decir, en el c√≥digo, que, en teor√≠a, se lami√≥ como los moretones del gato en un d√≠a soleado. <br><br>  La continuaci√≥n del an√°lisis mostr√≥ que la falla es una consecuencia de un intento de inicializar variables est√°ticas locales. <br><br><div class="spoiler">  <b class="spoiler_title">Digresi√≥n l√≠rica</b> <div class="spoiler_text">  Por cierto, considerando el c√≥digo desensamblado, simult√°neamente encontr√© la respuesta a una pregunta que a veces me hac√≠a, pero fui demasiado flojo para googlear de inmediato: ¬øc√≥mo se resuelve la situaci√≥n cuando 2 o m√°s hilos pueden intentar inicializar dicha variable al mismo tiempo?  Result√≥ que en este caso, el compilador organiza la inicializaci√≥n con sem√°foros, garantizando que solo un hilo a la vez pasar√° por todo el procedimiento, y el resto esperar√° hasta que termine el primero.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Este comportamiento se ha estandarizado desde C ++ 11.</a>  Sabias  Yo no </div></div><br><h3>  Cap√≠tulo 2 </h3><br>  Una vez que el tiempo de ejecuci√≥n se dedica a la construcci√≥n de variables, tambi√©n le corresponde llamar a los destructores al finalizar el programa (incluso si el programa nunca completa realmente el trabajo, que es la norma absoluta para los microcontroladores).  Para hacer esto, necesita un lugar para almacenar informaci√≥n sobre todas las variables que logr√≥ inicializar. <br><br>  Eso es justo en el lugar donde dicha informaci√≥n se almacena en alg√∫n tipo de lista interna, el tiempo de ejecuci√≥n tambi√©n cay√≥.  Debido a que la funci√≥n malloc (), a trav√©s de la cual se asign√≥ memoria para los elementos de esta lista y que, seg√∫n el est√°ndar, produce bloques garantizados para estar alineados <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">al menos en el l√≠mite de 8 bytes</a> , despu√©s de un en√©simo n√∫mero de llamadas exitosas, produce una pieza que no est√° alineada en este l√≠mite. <br><br><img src="https://habrastorage.org/webt/sx/0c/bw/sx0cbwlau__vlj2kwrdznxmehew.jpeg"><br><br>  Los cambios en el nuevo c√≥digo de firmware rompieron malloc?!  Pero, ¬øc√≥mo es esto posible?  No redefin√≠ exactamente malloc; ¬°yo mismo no lo necesito en ning√∫n otro lado! <br><br>  √ötil en las opciones del compilador, para buscar algunas palabras clave, ayuda, pero se dijo claramente en todas partes: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">malloc () garantiza la salida de memoria alineada a lo largo del l√≠mite fundamental.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">O puntero nulo en caso de que no haya suficiente memoria</a> . <br><br><h3>  Capitulo 3 </h3><br>  Durante mucho tiempo me qued√© sin sentido en el c√≥digo, establec√≠ los puntos de interrupci√≥n, sufr√≠ y no entend√≠ nada, hasta que en alg√∫n momento no me toc√≥ y mir√© las direcciones devueltas por Malloc con cuidado.  Antes de esto, todo el an√°lisis era para ver si el √∫ltimo d√≠gito de la direcci√≥n es 0x4.  Y ahora comenz√≥ a comparar completamente entre s√≠ las direcciones emitidas por llamadas sucesivas a Malloc. <br><br>  Y oh, un milagro! <br><br>  Todas las llamadas exitosas emitieron direcciones desde el espacio RAM (0x20000000 y anteriores para esta piedra), aumentando secuencialmente de llamada a llamada.  Y el primero que no tuvo √©xito devolvi√≥ 0x00000036.  Es decir, la direcci√≥n no es solo que no estaba alineada, ¬°sino que tampoco estaba en el espacio de direcciones de la RAM!  El procesador intent√≥ escribir algo all√≠ y, naturalmente, cay√≥. <br><br>  Y, sorprendentemente, incluso si malloc () actu√≥ de acuerdo con el est√°ndar y devolvi√≥ 0 si no hubiera suficiente espacio, esto no habr√≠a cambiado nada en el sentido de un bloqueo del programa (a menos que la causa del error se hubiera aclarado antes).  El valor devuelto por malloc todav√≠a no se verifica de ninguna manera, pero inmediatamente entra en acci√≥n.  Esto es en tiempo de ejecuci√≥n. <br><br><h3>  Ep√≠logo </h3><br>  Aument√≥ el tama√±o de almacenamiento din√°mico en el archivo de configuraci√≥n, y todo se solucion√≥. <br><br>  Pero antes de ese momento ni siquiera pensaba en su volumen.  Si el infierno se rindi√≥ ante m√≠, pens√©.  De todos modos, tengo todas las variables y objetos est√°ticos o en la pila.  Entonces, solo por inercia, dej√© 0x300 bytes debajo, ya que se asigna un volumen bajo el mont√≥n en todos los proyectos de plantilla.  Pero no, el tiempo de ejecuci√≥n de C ++ todav√≠a necesita memoria asignada din√°micamente, y en cantidades bastante notables, seg√∫n los est√°ndares de los controladores. <br><br>  Vive y aprende. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/453944/">https://habr.com/ru/post/453944/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../453930/index.html">Comparaci√≥n y selecci√≥n de sistemas de migraci√≥n de datos.</a></li>
<li><a href="../453932/index.html">Unas palabras en defensa del monolito</a></li>
<li><a href="../453934/index.html">11 preguntas para discutir antes de comenzar a trabajar</a></li>
<li><a href="../453938/index.html">Seguimiento de bicicletas robadas NB-IoT</a></li>
<li><a href="../453942/index.html">Acerca de la √©tica con el ejemplo de PMI Codex</a></li>
<li><a href="../453950/index.html">Se supone que debes estar aqu√≠! 22 a√±os del lanzamiento del legendario juego Duke Nukem 3D</a></li>
<li><a href="../453952/index.html">"La solicitud ha madurado": Alexei Fedorov sobre una nueva conferencia sobre sistemas distribuidos</a></li>
<li><a href="../453956/index.html">Datos del museo Art. Terminal de video ADM-3A. El auto es pesado, confiable, masacre</a></li>
<li><a href="../453958/index.html">Monorepositorios: por favor</a></li>
<li><a href="../453960/index.html">Global DevOps Bootcamp 2019 en Mosc√∫</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>