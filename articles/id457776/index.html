<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚õ±Ô∏è üòµ ü•ù Tambang di bawah kinerja sedang menunggu di sayap: bagian 2 ü¶Ü üîå üé∑</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dalam persiapan artikel terakhir, satu contoh aneh yang tertangkap dalam salah satu aplikasi kami membuat perhatian saya meleset. Saya mendesainnya se...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Tambang di bawah kinerja sedang menunggu di sayap: bagian 2</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/457776/"><p> Dalam persiapan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">artikel terakhir,</a> satu contoh aneh yang tertangkap dalam salah satu aplikasi kami membuat perhatian saya meleset.  Saya mendesainnya sebagai artikel terpisah, yang sedang Anda baca. </p><a name="habracut"></a><br><p>  Intinya sangat sederhana: ketika membuat laporan dan menulisnya ke database, dari waktu ke waktu kami mulai menerima OOME.  Kesalahan mengambang: pada beberapa data itu direproduksi terus-menerus, pada yang lain itu tidak pernah direproduksi. </p><br><p>  Saat memeriksa penyimpangan tersebut, urutan tindakannya jelas: </p><br><ul><li> kami meluncurkan aplikasi dalam lingkungan yang terisolasi dengan pengaturan seperti sebelumnya, tanpa melupakan flag yang diidam <code>-XX:+HeapDumpOnOutOfMemoryError</code> , sehingga VM membuat heap of heap ketika penuh </li><li>  melakukan tindakan yang mengarah ke jatuh </li><li>  ambil gips yang dihasilkan dan mulai memeriksanya </li></ul><br><div class="spoiler">  <b class="spoiler_title">Pendekatan pertama menyediakan bahan yang dibutuhkan untuk penelitian.</b>  <b class="spoiler_title">Gambar berikut dibuka</b> <div class="spoiler_text"><p>  Para pemain diambil dari aplikasi tes yang tersedia di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">sini</a> .  Untuk melihat ukuran penuh, klik kanan pada gambar dan pilih "Buka Gambar di Tab Baru": </p><br><p><img src="https://habrastorage.org/webt/h6/u7/pe/h6u7peoapauqu_qs8hwj8eitnmk.png"></p></div></div><br><p>  Dalam perkiraan pertama, dua bagian yang sama dari 71 MB terlihat jelas, dan yang terbesar adalah 6 kali lebih besar. </p><br><p>  Merokok singkat dari rantai panggilan dan kode sumber membantu mengatasi semua "". </p><br><div class="spoiler">  <b class="spoiler_title">10 baris pertama sudah cukup</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">Exception in thread "main" java.lang.OutOfMemoryError: Java heap space at java.base/java.util.Arrays.copyOf(Arrays.java:3745) at java.base/java.lang.AbstractStringBuilder.ensureCapacityInternal(AbstractStringBuilder.java:172) at java.base/java.lang.AbstractStringBuilder.append(AbstractStringBuilder.java:538) at java.base/java.lang.StringBuilder.append(StringBuilder.java:174) at com.p6spy.engine.common.Value.quoteIfNeeded(Value.java:167) at com.p6spy.engine.common.Value.convertToString(Value.java:116) at com.p6spy.engine.common.Value.toString(Value.java:63) at com.p6spy.engine.common.PreparedStatementInformation.getSqlWithValues(PreparedStatementInformation.java:56) at com.p6spy.engine.common.P6LogQuery.logElapsed(P6LogQuery.java:203) at com.p6spy.engine.logging.LoggingEventListener.logElapsed(LoggingEventListener.java:107) at com.p6spy.engine.logging.LoggingEventListener.onAfterAnyExecute(LoggingEventListener.java:44) at com.p6spy.engine.event.SimpleJdbcEventListener.onAfterExecuteUpdate(SimpleJdbcEventListener.java:121) at com.p6spy.engine.event.CompoundJdbcEventListener.onAfterExecuteUpdate(CompoundJdbcEventListener.java:157) at com.p6spy.engine.wrapper.PreparedStatementWrapper.executeUpdate(PreparedStatementWrapper.java:100) at org.hibernate.engine.jdbc.internal.ResultSetReturnImpl.executeUpdate(ResultSetReturnImpl.java:175) at org.hibernate.persister.entity.AbstractEntityPersister.insert(AbstractEntityPersister.java:3176) at org.hibernate.persister.entity.AbstractEntityPersister.insert(AbstractEntityPersister.java:3690) at org.hibernate.action.internal.EntityInsertAction.execute(EntityInsertAction.java:90) at org.hibernate.engine.spi.ActionQueue.executeActions(ActionQueue.java:604) at org.hibernate.engine.spi.ActionQueue.executeActions(ActionQueue.java:478) at org.hibernate.event.internal.AbstractFlushingEventListener.performExecutions(AbstractFlushingEventListener.java:356) at org.hibernate.event.internal.DefaultFlushEventListener.onFlush(DefaultFlushEventListener.java:39) at org.hibernate.internal.SessionImpl.doFlush(SessionImpl.java:1454) at org.hibernate.internal.SessionImpl.managedFlush(SessionImpl.java:511) at org.hibernate.internal.SessionImpl.flushBeforeTransactionCompletion(SessionImpl.java:3290) at org.hibernate.internal.SessionImpl.beforeTransactionCompletion(SessionImpl.java:2486) at org.hibernate.engine.jdbc.internal.JdbcCoordinatorImpl.beforeTransactionCompletion(JdbcCoordinatorImpl.java:473) at org.hibernate.resource.transaction.backend.jdbc.internal.JdbcResourceLocalTransactionCoordinatorImpl.beforeCompletionCallback(JdbcResourceLocalTransactionCoordinatorImpl.java:178) at org.hibernate.resource.transaction.backend.jdbc.internal.JdbcResourceLocalTransactionCoordinatorImpl.access$300(JdbcResourceLocalTransactionCoordinatorImpl.java:39) at org.hibernate.resource.transaction.backend.jdbc.internal.JdbcResourceLocalTransactionCoordinatorImpl$TransactionDriverControlImpl.commit(JdbcResourceLocalTransactionCoordinatorImpl.java:271) at org.hibernate.engine.transaction.internal.TransactionImpl.commit(TransactionImpl.java:104) at org.springframework.orm.jpa.JpaTransactionManager.doCommit(JpaTransactionManager.java:532)</code> </pre></div></div><br><p>  Proyek ini menggunakan kombinasi Spring + Hibernate biasa untuk aplikasi seperti itu.  Pada titik tertentu, untuk mempelajari lonjakan aplikasi dalam basis data (yang merupakan hal yang paling sering dilakukan), DataSource dibungkus <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">p6spy</a> .  Ini adalah perpustakaan sederhana dan sangat berguna yang dirancang untuk mencegat dan mencatat permintaan basis data, serta mengukur waktu pelaksanaannya.  Sorotnya adalah rekaman kueri yang masuk ke basis data dengan semua argumen, mis., Mengambil kueri dari log dapat langsung mengeksekusinya di konsol tanpa repot dengan konversi argumen (apakah Hibernate menulis alih-alih <code>?</code> ), Mana yang nyaman saat menggunakan <code>@Convert</code> atau di hadapan bidang tipe <code>Date</code> / <code>LocalDate</code> / <code>LocalTime</code> dan turunannya.  IMHO, suatu hal yang sangat berguna dalam ekonomi pengembang E. </p><br><p>  Seperti inilah bentuk entitas yang berisi laporan: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Entity</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ReportEntity</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Id</span></span> <span class="hljs-meta"><span class="hljs-meta">@GeneratedValue</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> id; <span class="hljs-meta"><span class="hljs-meta">@Lob</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] reportContent; }</code> </pre> <br><p>  Menggunakan array byte sangat nyaman ketika entitas digunakan hanya untuk menyimpan / membongkar laporan, dan sebagian besar alat untuk bekerja dengan xslx / pdf di luar kotak mendukung kemampuan untuk membuat buku / dokumen dalam formulir ini. </p><br><p>  Dan kemudian hal yang mengerikan dan tidak terduga terjadi: kombinasi Hibernate, array byte dan p6spy berubah menjadi bom waktu, yang diam-diam terus berdetak untuk saat ini, dan ketika ada terlalu banyak data, ada ledakan. </p><br><p>  Seperti disebutkan di atas, saat menyimpan entitas, p6spy mencegat permintaan dan menulisnya ke log dengan semua argumen.  Dalam hal ini, hanya ada 2 di antaranya: kunci dan laporan itu sendiri.  Pengembang P6spy memutuskan bahwa jika argumennya adalah array byte, maka alangkah baiknya mengonversinya menjadi heksadesimal.  Di versi 3.6.0 yang kami gunakan, ini dilakukan seperti ini: </p><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">// class com.p6spy.engine.common.Value private String toHexString(byte[] bytes) { StringBuilder sb = new StringBuilder(); for (byte b : bytes) { int temp = (int) b &amp; 0xFF; sb.append(HEX_CHARS[temp / 16]); sb.append(HEX_CHARS[temp % 16]); } return sb.toString(); }</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Catatan</b> <div class="spoiler_text"><p>  Setelah menyuntikkan dua perubahan ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">tyts</a> dan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">tyts</a> ), kode akan terlihat seperti ini (versi saat ini 3.8.2): </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toHexString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] bytes)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>[] result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>[bytes.length * <span class="hljs-number"><span class="hljs-number">2</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> idx = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> b : bytes) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> temp = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) b &amp; <span class="hljs-number"><span class="hljs-number">0xFF</span></span>; result[idx++] = HEX_CHARS[temp / <span class="hljs-number"><span class="hljs-number">16</span></span>]; result[idx++] = HEX_CHARS[temp % <span class="hljs-number"><span class="hljs-number">16</span></span>]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> String(result); }</code> </pre> <br><p>  di masa depan kita akan dipandu oleh edisi ini, karena itu yang digunakan dalam aplikasi demonstrasi. </p></div></div><br><p>  Akibatnya, sesuatu seperti ini ditulis ke log </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> report_entity (report_content, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-string"><span class="hljs-string">'6C6F..........7565'</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>);</code> </pre> <br><p>  Anda mengerti, ya?  Jika terjadi kombinasi keadaan yang tidak berhasil, berikut ini dapat muncul dalam memori aplikasi: </p><br><ul><li>  laporan, sebagai array byte </li><li>  array karakter diturunkan dari byte array </li><li>  string yang diperoleh dari array karakter diperoleh dari byte array </li><li>  <code>StringBuilder</code> , yang mencakup salinan string yang diperoleh dari array karakter yang diperoleh dari array byte </li><li>  string yang menyertakan salinan array di dalam <code>StringBuilder</code> , yang mencakup salinan string yang diperoleh dari array karakter yang diperoleh dari array byte. </li></ul><br><p>  Dalam kondisi ini, aplikasi demonstrasi yang terdiri dari 2 kelas, setelah dirakit dan diluncurkan di Java 11 (mis. Dengan saluran terkompresi) dengan 1 GB tumpukan, Anda dapat menempatkan laporan dengan berat hanya 71 MB! </p><br><p>  Ada dua cara untuk mengatasi masalah ini tanpa membuang p6spy: </p><br><ul><li>  ganti <code>byte[]</code> dengan <code>java.sql.Clob</code> (solusi begitu-begitu, karena data tidak dimuat segera dan rewel dengan <code>InputStream</code> / <code>OutputStream</code> ) </li><li>  tambahkan <code>excludebinary=true</code> properti ke file <code>excludebinary=true</code> (ini telah ditambahkan dalam aplikasi tes, Anda hanya perlu membukanya) </li></ul><br><p>  Dalam hal ini, log kueri ringan dan indah: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> report_entity (report_content, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-string"><span class="hljs-string">'[binary]'</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>);</code> </pre> <br><p>  Panduan Putar <a href="">Ulang</a> Lihat <a href="">README.MD</a> </p><br><p>  Kesimpulan: </p><br><ul><li>  kekekalan (khususnya baris) bernilai <del>  mahal </del><del>  Mahal </del>  SANGAT SAYANG </li><li>  jika Anda memiliki tabel dengan data sensitif (penampilan, kata sandi, dll.), Anda menggunakan p6spy, dan log-nya buruk, maka ... yah, Anda mengerti </li><li>  jika Anda memiliki p6spy dan Anda yakin itu akan secara permanen / permanen, maka untuk entitas besar masuk akal untuk melihat <code>@DynamicInsert</code> / <code>@DynamicUpdate</code> .  Intinya adalah untuk mengurangi volume log dengan membuat permintaan untuk setiap pembaruan / penyisipan individu.  Ya, pertanyaan ini akan dibuat setiap saat sekali lagi, tetapi dalam kasus di mana entitas memperbarui 1 bidang dari 20, kompromi semacam ini mungkin berguna.  Lihat dokumentasi untuk penjelasan di atas untuk informasi lebih lanjut. </li></ul><br><p>  Itu saja untuk hari ini :) </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id457776/">https://habr.com/ru/post/id457776/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id457764/index.html">10 kesalahan PO muda (bagian II)</a></li>
<li><a href="../id457766/index.html">Kami menghasilkan tingkat ubin dan menyembunyikan kotak dari pemain</a></li>
<li><a href="../id457768/index.html">Bagaimana saya menjadi rentan: memindai infrastruktur TI dengan Qualys</a></li>
<li><a href="../id457770/index.html">Kami menulis AST transformator khusus pada TypeScript</a></li>
<li><a href="../id457774/index.html">Belajar sebagai pilot pribadi di Middle-earth: pindah dan tinggal di desa Selandia Baru</a></li>
<li><a href="../id457784/index.html">Kalibrasi Pelacak Mata Kustom</a></li>
<li><a href="../id457786/index.html">Diperbarui Anet A8 Plus. Besar dan logam</a></li>
<li><a href="../id457790/index.html">Ponsel BuratinoPhone</a></li>
<li><a href="../id457794/index.html">Properti simetri dari hubungan kointegrasi</a></li>
<li><a href="../id457796/index.html">Fitur RTC M41T56</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>