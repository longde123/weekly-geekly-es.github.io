<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü•¢ üë®üèæ‚Äçüè≠ ‚ûó Docker + Laravel = ‚ù§ üßõüèΩ üåä ‚úäüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En este art√≠culo, hablar√© sobre mi experiencia de "envolver" una aplicaci√≥n Laravel en un contenedor Docker para que los desarrolladores frontend y ba...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Docker + Laravel = ‚ù§</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/425101/"><p><img src="https://habrastorage.org/getpro/habr/post_images/89c/b0e/91f/89cb0e91fd1efafb24b66b7ee44dc1b0.png" alt="laravel-in-docker"></p><br><p> En este art√≠culo, hablar√© sobre mi experiencia de "envolver" una aplicaci√≥n Laravel en un contenedor Docker para que los desarrolladores frontend y backend puedan trabajar localmente con ella, y lanzarla en producci√≥n fue lo m√°s simple posible.  Adem√°s, CI ejecutar√° autom√°ticamente analizadores de c√≥digo est√°tico, pruebas de <code>phpunit</code> y <code>phpunit</code> im√°genes. </p><br><p>  "¬øY qu√© es, de hecho, la complejidad?"  - Puedes decir, y estar√°s en parte en lo cierto.  El hecho es que muchas discusiones en las comunidades de habla rusa e inglesa est√°n dedicadas a este tema, y ‚Äã‚Äãdividir√≠a condicionalmente casi todos los hilos estudiados en las siguientes categor√≠as: </p><br><ul><li>  "Estoy usando Docker para el desarrollo local. Puse <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">laradock</a> y no s√© los problemas".  Genial, pero ¬øqu√© pasa con el lanzamiento de automatizaci√≥n y producci√≥n? </li><li>  "Recopilo un contenedor <em>(monolito)</em> basado en <code>fedora:latest</code> (~ 230 Mb), pongo todos los servicios (nginx, db, cach√©, etc.), ejecuto todo dentro del supervisor".  Tambi√©n excelente, f√°cil de comenzar, pero ¬øqu√© pasa con la ideolog√≠a de "un contenedor - un proceso"?  ¬øQu√© pasa con el equilibrio y la gesti√≥n de procesos?  ¬øCu√°l es el tama√±o de la imagen? </li><li>  "Aqu√≠ hay piezas de configuraciones, sazona con extractos de scripts de sh, agrega valores m√°gicos del entorno, √∫salo".  Gracias, pero ¬øqu√© pasa con al menos un ejemplo vivo que podr√≠a bifurcar y jugar completamente? </li></ul><br><p>  Todo lo que lees a continuaci√≥n es una experiencia subjetiva que no pretende ser la verdad √∫ltima.  Si tiene adiciones o indicaciones de inexactitudes, bienvenido a los comentarios. </p><br><blockquote>  Para los impacientes: un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">enlace al repositorio</a> , clone en el que puede iniciar la aplicaci√≥n Laravel con un comando.  Tampoco es dif√≠cil ejecutarlo en el mismo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ranchero</a> , "vincular" correctamente los contenedores, o usar la versi√≥n de supermercado <code>docker-compose.yml</code> como punto de partida. </blockquote><a name="habracut"></a><br><h2 id="chast-teoreticheskaya">  Parte te√≥rica </h2><br><p>  ¬øQu√© herramientas usaremos en nuestro trabajo y en qu√© nos centraremos?  En primer lugar, necesitamos instalar en el host: </p><br><ul><li>  <code>docker</code> : al momento de escribir, us√© la versi√≥n <code>18.06.1-ce</code> </li><li>  <code>docker-compose</code> : se encarga de vincular contenedores y almacenar los valores de entorno necesarios;  versi√≥n <code>1.22.0</code> </li><li>  <code>make</code> : puede que se sorprenda, pero encaja perfectamente en el contexto de trabajar con docker </li></ul><br><blockquote>  Puede <code>curl -fsSL get.docker.com | sudo sh</code> <code>docker</code> en sistemas similares a <code>debian</code> con el comando <code>curl -fsSL get.docker.com | sudo sh</code>  <code>curl -fsSL get.docker.com | sudo sh</code> , pero <code>docker-compose</code> mejor para instalar usando <code>pip</code> , ya que las versiones m√°s recientes viven en sus repositorios (por lo general, <code>apt</code> muy retrasado). </blockquote><p>  Esto completa la lista de dependencias.  Lo que usar√° para trabajar con el c√≥digo fuente ( <code>phpstorm</code> , <code>netbeans</code> o dead <code>vim</code> ) depende de usted. </p><br><p>  El siguiente es un control de calidad improvisado en el contexto del dise√±o de imagen <em>(no tengo miedo de esta palabra)</em> : </p><br><ul><li><p>  <strong>P: Imagen b√°sica: ¬øcu√°l es mejor elegir?</strong> </p><br></li><li><p>  <strong>A:</strong> El que es "m√°s delgado", sin lujos.  Sobre la base de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><code>alpine</code></a> <em>(~ 5 Mb),</em> puedes recolectar lo que tu coraz√≥n desee, pero lo m√°s probable es que tengas que jugar con el conjunto de servicios desde la fuente.  Como alternativa, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><code>jessie-slim</code></a> <em>(~ 30 Mb)</em> .  O use el que se usa con mayor frecuencia en sus proyectos. </p><br></li><li><p>  <strong>P: ¬øPor qu√© es importante el peso de la imagen?</strong> </p><br></li><li><p>  <strong>R:</strong> Disminuci√≥n en el volumen de tr√°fico, disminuci√≥n en la probabilidad de un error al descargar (menos datos - menos probabilidad), disminuci√≥n en el lugar consumido.  La regla "La gravedad es confiable" (¬© "Snatch") no funciona muy bien aqu√≠. </p><br></li><li><p>  <strong>P: Pero mi amigo <code>%friend_name%</code> dice que una imagen "monol√≠tica" con todas las dependencias es la mejor manera.</strong> </p><br></li><li><p>  <strong>A:</strong> Solo cuentemos.  La aplicaci√≥n tiene 3 dependencias: PG, Redis, PHP.  Y quer√≠a probar c√≥mo se comportar√° en paquetes de diferentes versiones de estas dependencias.  PG - versiones 9.6 y 10, Redis - 3.2 y 4.0, PHP - 7.0 y 7.2.  En caso de que cada adicci√≥n sea una imagen separada, necesita 6 de ellas, que ni siquiera necesita recopilar, todo est√° listo y se encuentra en <code>hub.docker.com</code> .  Si, por razones ideol√≥gicas, todas las dependencias est√°n "empaquetadas" en un contenedor, debe volver a armarlo con plumas ... ¬ø8 veces?  Ahora agregue la condici√≥n que todav√≠a desea jugar con <code>opcache</code> .  En el caso de descomposici√≥n, esto es simplemente un cambio en las etiquetas de las im√°genes utilizadas.  Un monolito es m√°s f√°cil de ejecutar y mantener, pero es el camino a ninguna parte. </p><br></li><li><p>  <strong>P: ¬øPor qu√© es malo el supervisor en el contenedor?</strong> </p><br></li><li><p>  <strong>A:</strong> Porque <code>PID 1</code> .  Si no desea una gran cantidad de problemas con los procesos zombie y tiene la capacidad de "agregar capacidad" de manera flexible cuando sea necesario, intente ejecutar un proceso por contenedor.  Una excepci√≥n peculiar es <code>nginx</code> con sus trabajadores y <code>php-fpm</code> , que tienen la capacidad de producir procesos, pero tienen que soportar esto (adem√°s, no son malos para reaccionar a <code>SIGTERM</code> , "matando" a sus trabajadores de manera bastante correcta).  Al lanzar a todos los demonios como supervisor, es casi seguro que te est√°s condenando a problemas.  Aunque, en algunos casos, es dif√≠cil prescindir de √©l, pero estas ya son excepciones. </p><br></li></ul><br><p>  Habiendo decidido los enfoques principales, pasemos a nuestra aplicaci√≥n.  Debe ser capaz de: </p><br><ul><li>  <code>web|api</code> : proporcione est√°tica con <code>nginx</code> y genere contenido din√°mico con <code>fpm</code> </li><li>  <code>scheduler</code> : ejecuta el planificador de tareas nativo </li><li>  <code>queue</code> - procesa trabajos desde colas </li></ul><br><p>  Un conjunto b√°sico que se puede ampliar si es necesario.  Ahora pasemos a las im√°genes que tenemos que recopilar para que nuestra aplicaci√≥n "despegue" (sus nombres en clave se dan entre par√©ntesis): </p><br><ul><li>  <code>PHP + PHP-FPM</code> ( <strong>aplicaci√≥n</strong> ): el entorno en el que se ejecutar√° nuestro c√≥digo.  Dado que las versiones de PHP y FPM ser√°n las mismas para nosotros, las recopilamos en una imagen.  Por lo tanto, es m√°s f√°cil de administrar con configuraciones, y la composici√≥n de los paquetes ser√° id√©ntica.  Por supuesto, FPM y los procesos de aplicaci√≥n se ejecutar√°n en diferentes contenedores </li><li>  <code>nginx</code> ( <strong>nginx</strong> ), que no molestar√≠a con la entrega de configuraciones y m√≥dulos opcionales para <code>nginx</code> , recopilaremos una imagen separada con √©l.  Dado que es un servicio separado, tiene su propio archivo acoplable y su contexto </li><li>  Fuentes de la aplicaci√≥n ( <strong>fuentes</strong> ): la fuente se entregar√° utilizando una imagen separada, montando el <code>volume</code> con ellas en un contenedor con la aplicaci√≥n.  La imagen base es <code>alpine</code> , en el interior solo hay fuentes con dependencias instaladas y recopiladas utilizando activos de paquete web (artefactos de compilaci√≥n) </li></ul><br><p>  Otros servicios de desarrollo se lanzan en contenedores, extray√©ndolos de <code>hub.docker.com</code> ;  en producci√≥n, por otro lado, se ejecutan en servidores separados, agrupados.  Todo lo que nos queda es decirle a la aplicaci√≥n <em>(a trav√©s del entorno)</em> en qu√© direcciones / puertos y con qu√© detalles es necesario tocarlos.  A√∫n m√°s genial es usar el descubrimiento de servicios para este prop√≥sito, pero no en este momento. </p><br><p>  Habiendo decidido la parte te√≥rica, propongo pasar a la siguiente parte. </p><br><h2 id="chast-prakticheskaya">  La parte pr√°ctica </h2><br><p>  Sugiero organizar los archivos en el repositorio de la siguiente manera: </p><br><pre> <code class="hljs css">. ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">docker</span></span> #    <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>   ‚îÇ  ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">app</span></span> ‚îÇ  ‚îÇ  ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">Dockerfile</span></span> ‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ ... ‚îÇ  ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">nginx</span></span> ‚îÇ  ‚îÇ  ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">Dockerfile</span></span> ‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ ... ‚îÇ  ‚îî‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">sources</span></span> ‚îÇ    ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">Dockerfile</span></span> ‚îÇ    ‚îî‚îÄ‚îÄ ... ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">src</span></span> #   ‚îÇ ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">app</span></span> ‚îÇ ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">bootstrap</span></span> ‚îÇ ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">config</span></span> ‚îÇ ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">artisan</span></span> ‚îÇ ‚îî‚îÄ‚îÄ ... ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">docker-compose</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yml</span></span> # <span class="hljs-selector-tag"><span class="hljs-selector-tag">Compose-</span></span>    ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">Makefile</span></span> ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">CHANGELOG</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.md</span></span> ‚îî‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">README</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.md</span></span></code> </pre> <br><blockquote>  Puede familiarizarse con la estructura y los archivos haciendo clic en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">este enlace</a> . </blockquote><p>  Para construir un servicio, puede usar el comando: </p><br><pre> <code class="bash hljs">$ docker build \ --tag %local_image_name% \ -f ./docker/%service_directory%/Dockerfile ./docker/%service_directory%</code> </pre> <br><p>  La √∫nica diferencia ser√° el ensamblaje de la imagen con las fuentes; para ello, el contexto de ensamblaje (argumento extremo) <code>./src</code> establecerse en <code>./src</code> . </p><br><p>  Las reglas para nombrar im√°genes en el registro local recomiendan usar las que <code>docker-compose</code> usa de manera predeterminada, a saber: <code>%root_directory_name%_%service_name%</code> .  Si el directorio del proyecto se llama <code>my-awesome-project</code> , y el servicio se llama <code>redis</code> , entonces el nombre de la imagen (local) es mejor elegir <code>my-awesome-project_redis</code> respectivamente. </p><br><blockquote>  Para acelerar el proceso de compilaci√≥n, puede indicarle a la ventana acoplable que use el cach√© de la imagen ensamblada previamente, y para esto, se <code>--cache-from %full_registry_name%</code> inicio <code>--cache-from %full_registry_name%</code> .  Por lo tanto, el docker daemon se ver√° antes de comenzar una instrucci√≥n particular en el Dockerfile: ¬øha cambiado?  Y si no (el hash converge), se saltar√° la instrucci√≥n, usando la capa ya preparada de la imagen, que le indicar√° que use como cach√©.  Esto no es malo, por lo que reconstruir√° el proceso, especialmente si nada ha cambiado :) <br><br>  Preste atenci√≥n a los scripts de <code>ENTRYPOINT</code> para iniciar contenedores de aplicaciones. </blockquote><p>  La imagen del entorno para iniciar la aplicaci√≥n (aplicaci√≥n) se recopil√≥ teniendo en cuenta el hecho de que funcionar√° no solo en la producci√≥n, sino tambi√©n a nivel local, los desarrolladores deben interactuar con ella de manera efectiva.  La instalaci√≥n y eliminaci√≥n de las dependencias del <code>composer</code> , la ejecuci√≥n de pruebas <code>unit</code> , los registros de <code>tail</code> y el uso de alias familiares ( <code>php /app/artisan</code> ‚Üí <code>art</code> , <code>composer</code> ‚Üí <code>c</code> ) deben realizarse sin molestias.  Adem√°s, tambi√©n se utilizar√° para ejecutar pruebas <code>unit</code> y analizadores de c√≥digo est√°tico ( <code>phpstan</code> en nuestro caso) en CI.  Es por eso que su Dockerfile, por ejemplo, contiene la <code>xdebug</code> instalaci√≥n <code>xdebug</code> , pero el m√≥dulo en s√≠ no est√° habilitado (solo se habilita mediante CI). </p><br><blockquote>  Tambi√©n para el <code>composer</code> el paquete <code>hirak/prestissimo</code> se <code>hirak/prestissimo</code> , lo que aumenta enormemente la instalaci√≥n de todas las dependencias. </blockquote><p>  En producci√≥n, montamos el contenido del directorio <code>/src</code> de la imagen con las fuentes (fuentes) dentro del directorio <code>/app</code> .  Para el desarrollo, "desplazamos" el directorio local con las fuentes de la aplicaci√≥n ( <code>-v "$(pwd)/src:/app:rw"</code> ). </p><br><p>  Y aqu√≠ radica una complejidad: estos son <strong>los derechos de acceso a los archivos</strong> que se crean desde el contenedor.  El hecho es que, por defecto, los procesos que se ejecutan dentro del contenedor comienzan desde la ra√≠z ( <code>root:root</code> ), los archivos creados por estos procesos (cach√©, registros, sesiones, etc.), tambi√©n, y como resultado, no tiene nada "localmente" con ellos puede hacerlo sin ejecutar <code>sudo chown -R $(id -u):$(id -g) /path/to/sources</code> . </p><br><p>  Como una soluci√≥n, use <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">fixuid</a> , pero esta soluci√≥n es sencilla.  La mejor forma me pareci√≥ <code>USER_ID</code> local y su <code>GROUP_ID</code> dentro del contenedor, y <a href="">comenzar los procesos con estos valores</a> .  De forma predeterminada, al sustituir los valores <code>1000:1000</code> (los valores predeterminados para el primer usuario local) se elimin√≥ la llamada <code>$(id -u):$(id -g)</code> , y si es necesario, siempre puede anularlos ( <code>$ USER_ID=666 docker-compose up -d</code> ) o coloque el archivo docker-compose en el archivo <code>.env</code> . </p><br><p>  Adem√°s, cuando <code>php-fpm</code> inicie localmente <code>php-fpm</code> no olvide deshabilitar <code>opcache</code> de lo contrario, habr√° un mont√≥n de "¬°s√≠, qu√© demonios!"  se le proporcionar√° </p><br><p>  Para una conexi√≥n "directa" a redis y postgres, arroj√© puertos adicionales "fuera" ( <code>15432</code> y <code>15432</code> respectivamente), por lo que no hay problemas con "conectarse y ver qu√© y c√≥mo es realmente" en principio. </p><br><p>  Mantengo el contenedor con la <code>app</code> nombre en c√≥digo ejecut√°ndose ( <code>--command keep-alive.sh</code> ) con el fin de tener un acceso conveniente a la aplicaci√≥n. </p><br><p>  Estos son algunos ejemplos de resoluci√≥n de problemas cotidianos con <code>docker-compose</code> : </p><br><table><thead><tr><th>  Operaci√≥n </th><th>  Comando en ejecuci√≥n </th></tr></thead><tbody><tr><td>  Instalar paquete <code>composer</code> </td><td> <code>$ docker-compose exec app composer require package/name</code> </td> </tr><tr><td>  Ejecutando phpunit </td><td> <code>$ docker-compose exec app php ./vendor/bin/phpunit --no-coverage</code> </td> </tr><tr><td>  Instalar todas las dependencias de nodo </td><td> <code>$ docker-compose run --rm node npm install</code> </td> </tr><tr><td>  Instalar paquete de nodos </td><td> <code>$ docker-compose run --rm node npm i package_name</code> </td> </tr><tr><td>  Lanzar una reconstrucci√≥n en vivo de activos </td><td> <code>$ docker-compose run --rm node npm run watch</code> </td> </tr></tbody></table><br><p>  Puede encontrar todos los detalles de inicio en el <strong><a href="">archivo docker-compose.yml</a></strong> . </p><br><h4 id="coy-make-zhiv"><del>  Choi </del>  <code>make</code> vivo! </h4><br><p>  Escribir los mismos comandos cada vez se vuelve aburrido despu√©s de la segunda vez, y dado que los programadores son criaturas perezosas por naturaleza, entremos en su "automatizaci√≥n".  Mantener un conjunto de scripts es una opci√≥n, pero no tan atractiva como un solo <code>Makefile</code> , especialmente porque su aplicabilidad en el desarrollo moderno est√° muy subestimada. </p><br><blockquote>  Puede encontrar el manual completo en ruso en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">este enlace</a> . </blockquote><p>  Veamos c√≥mo se ve la ejecuci√≥n de ejecuci√≥n en la ra√≠z del repositorio: </p><br><pre> <code class="bash hljs">[user@host ~/projects/app] $ make <span class="hljs-built_in"><span class="hljs-built_in">help</span></span> Show this <span class="hljs-built_in"><span class="hljs-built_in">help</span></span> app-pull Application - pull latest Docker image (from remote registry) app Application - build Docker image locally app-push Application - tag and push Docker image into remote registry sources-pull Sources - pull latest Docker image (from remote registry) sources Sources - build Docker image locally sources-push Sources - tag and push Docker image into remote registry nginx-pull Nginx - pull latest Docker image (from remote registry) nginx Nginx - build Docker image locally nginx-push Nginx - tag and push Docker image into remote registry pull Pull all Docker images (from remote registry) build Build all Docker images push Tag and push all Docker images into remote registry login Log <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> to a remote Docker registry clean Remove images from <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> registry --------------- --------------- up Start all containers (<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> background) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> development down Stop all started <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> development containers restart Restart all started <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> development containers shell Start shell into application container install Install application dependencies into application container watch Start watching assets <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> changes (node) init Make full application initialization (install, seed, build assets) <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> Execute application tests Allowed <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> overriding next properties: PULL_TAG - Tag <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> pulling images before building own (<span class="hljs-string"><span class="hljs-string">'latest'</span></span> by default) PUBLISH_TAGS - Tags list <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> building and pushing into remote registry (delimiter - single space, <span class="hljs-string"><span class="hljs-string">'latest'</span></span> by default) Usage example: make PULL_TAG=<span class="hljs-string"><span class="hljs-string">'v1.2.3'</span></span> PUBLISH_TAGS=<span class="hljs-string"><span class="hljs-string">'latest v1.2.3 test-tag'</span></span> app-push</code> </pre> <br><p>  Es muy bueno en objetivos adictivos.  Por ejemplo, para ejecutar <code>watch</code> ( <code>docker-compose run --rm node npm run watch</code> ), necesita que la aplicaci√≥n sea "activada", solo necesita especificar el objetivo <code>up</code> como dependiente, y no tiene que preocuparse por olvidar hacer esto antes de llamar a <code>watch</code> - <code>make</code> s√≠ mismo har√° todo por ti.  Lo mismo se aplica a la ejecuci√≥n de pruebas y analizadores est√°ticos, por ejemplo, antes de realizar cambios: ejecute una <code>make test</code> y ¬°toda la magia suceder√° por usted! </p><br><p>  No hace falta decir que no tiene que preocuparse por ensamblar im√°genes, descargarlas, especificar - <code>--cache-from</code> y casi todo. </p><br><p>  Puede ver el contenido del <code>Makefile</code> en <strong><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">este enlace</a></strong> . </p><br><h2 id="chast-avtomaticheskaya">  Parte auto </h2><br><p>  Pasemos a la parte final de este art√≠culo: esta es la automatizaci√≥n del proceso de actualizaci√≥n de im√°genes en el Registro de Docker.  Aunque en mi ejemplo se usa GitLab CI, para transferir la idea a otro servicio de integraci√≥n, creo que ser√° bastante posible. </p><br><p>  En primer lugar, determinaremos el nombre de las etiquetas de imagen utilizadas: </p><br><table><thead><tr><th>  Nombre de etiqueta </th><th>  Destino </th></tr></thead><tbody><tr><td> <code>latest</code> </td> <td>  Im√°genes recopiladas de la rama <code>master</code> . <br>  El estado del c√≥digo es el m√°s reciente, pero a√∫n no est√° listo para entrar en el lanzamiento. </td></tr><tr><td> <code>some-branch-name</code> </td> <td>  Im√°genes recopiladas en el brunch de <code>some-branch-name</code> . <br>  Por lo tanto, podemos "implementar" cambios en cualquier entorno que se implementaron solo en el marco de un brunch espec√≠fico, incluso antes de fusionarlos con la luz <code>master</code> : es suficiente para "estirar" las im√°genes con esta etiqueta. <br>  Y, s√≠, ¬°los cambios pueden referirse tanto al c√≥digo como a las im√°genes de todos los servicios en general! </td></tr><tr><td> <code>vX.XX</code> </td> <td>  En realidad, el lanzamiento de la aplicaci√≥n (se usa para implementar una versi√≥n espec√≠fica) </td></tr><tr><td> <code>stable</code> </td> <td>  Alias, para la etiqueta con la √∫ltima versi√≥n (se usa para implementar la √∫ltima versi√≥n estable) </td></tr></tbody></table><br><p>  El lanzamiento se lleva a cabo mediante la publicaci√≥n de una etiqueta en un formato <code>vX.XX</code> . </p><br><p>  Para acelerar la compilaci√≥n, <code>docker build</code> el almacenamiento en cach√© de los directorios <code>./src/vendor</code> y <code>./src/node_modules</code> + <code>--cache-from</code> para la <code>docker build</code> , y consta de las siguientes etapas: </p><br><table><thead><tr><th>  Nombre del escenario </th><th>  Destino </th></tr></thead><tbody><tr><td> <code>prepare</code> </td> <td>  La fase preparatoria: el ensamblaje de im√°genes de todos los servicios, <strong>excepto la</strong> imagen con la fuente </td></tr><tr><td> <code>test</code> </td> <td>  Probar la aplicaci√≥n (ejecutando <code>phpunit</code> , analizadores de c√≥digo est√°tico) usando im√°genes <strong>recopiladas en la etapa de preparaci√≥n</strong> </td></tr><tr><td> <code>build</code> </td> <td>  Instalar todas las dependencias del <code>composer</code> ( <code>--no-dev</code> ), ensamblar <code>assets</code> <code>webpack</code> y <code>webpack</code> imagen con el c√≥digo fuente, <strong>incluidos los artefactos recibidos</strong> ( <code>vendor/*</code> , <code>app.js</code> , <code>app.css</code> ) </td></tr></tbody></table><br><p><img src="https://habrastorage.org/getpro/habr/post_images/8c2/873/625/8c2873625893ec1a0605e24bf85ef541.png" alt="captura de pantalla de tuber√≠as"></p><br><blockquote>  El ensamblaje en la rama <code>master</code> produce <code>push</code> con las <code>latest</code> etiquetas y <code>master</code> </blockquote><p>  En promedio, todas las etapas del ensamblaje toman <strong>4 minutos</strong> , lo cual es un resultado bastante bueno (la ejecuci√≥n paralela de tareas es nuestro todo). </p><br><p>  Puede familiarizarse con el contenido de la configuraci√≥n ( <strong><code>.gitlab-ci.yml</code></strong> ) del recopilador en <strong><a href="">este enlace</a></strong> . </p><br><h2 id="vmesto-zaklyucheniya">  En lugar de una conclusi√≥n </h2><br><p>  Como puede ver, organizar el trabajo con una aplicaci√≥n php (usando <code>Laravel</code> como ejemplo) usando Docker no es tan dif√≠cil.  Como prueba, puede bifurcar el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">repositorio</a> y reemplazar todos los casos de <code>tarampampam/laravel-in-docker</code> con los suyos: intente todo "en vivo" por su cuenta. </p><br><p>  Para el lanzamiento local: ejecute solo 2 comandos: </p><br><pre> <code class="bash hljs">$ git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://gitlab.com/tarampampam/laravel-in-docker.git ./laravel-in-docker &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> <span class="hljs-variable"><span class="hljs-variable">$_</span></span> $ make init</code> </pre> <br><p>  Luego abra <code>http://127.0.0.1:9999</code> en su navegador favorito. </p><br><p>  <strong><em>... aprovechando la oportunidad</em></strong> </p><br><p>  <em>En este momento estoy trabajando en el "autoc√≥digo" del proyecto TL, y estamos buscando desarrolladores de php talentosos y administradores de sistemas (la oficina de desarrollo se encuentra en Ekaterimburgo).</em>  <em>Si te consideras el primero o el segundo, escribe nuestra carta de RR. HH. Con el texto "Quiero ser un equipo de desarrollo, resume:% link_on_summary%" al correo electr√≥nico <code>hr@avtocod.ru</code> , te ayudamos con la reubicaci√≥n.</em> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es425101/">https://habr.com/ru/post/es425101/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es425089/index.html">TI en el mundo animal: Ant Food Search y TCP / IP</a></li>
<li><a href="../es425091/index.html">¬øQu√© demonios est√° pasando con las calificaciones de popularidad de los lenguajes de programaci√≥n?</a></li>
<li><a href="../es425093/index.html">Soluciones de IoT para vivienda y servicios comunales: ¬øcu√°les ser√°n los medidores inteligentes y qui√©n deber√≠a prestarles servicio?</a></li>
<li><a href="../es425095/index.html">Abrir webinar "Juego" 2048 "</a></li>
<li><a href="../es425099/index.html">Lo que entend√≠ y los problemas que encontr√© al crear un clon de Hacker News</a></li>
<li><a href="../es425103/index.html">Detener a los depredadores de Google que persiguen a sus hijos</a></li>
<li><a href="../es425105/index.html">Modo de fabricaci√≥n Intel ME: una amenaza oculta, o lo que est√° detr√°s de la vulnerabilidad CVE-2018-4251 en el MacBook</a></li>
<li><a href="../es425107/index.html">Fintech digest: problemas de biometr√≠a en dispositivos m√≥viles, arrendamiento de tel√©fonos Samsung, valores en blockchain</a></li>
<li><a href="../es425109/index.html">El libro "Java en la nube. Spring Boot, Spring Cloud, Cloud Foundry ¬ª</a></li>
<li><a href="../es425111/index.html">Trucos publicitarios que pueden costarle dinero y reputaci√≥n</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>