<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ…ğŸ» ğŸ‘¨ğŸ½â€ğŸ³ ğŸ… FreeBSDä¸Šçš„postfix + dovecot + mysql ğŸ‘©ğŸ½â€ğŸ¤â€ğŸ‘©ğŸ» ğŸ· ğŸ¥</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="å¼•è¨€ 
 æˆ‘æƒ³ç ”ç©¶é‚®ä»¶æœåŠ¡å™¨å¾ˆé•¿æ—¶é—´ï¼Œä½†ç›´åˆ°ç°åœ¨æˆ‘çš„æ‰‹éƒ½ä¼¸æ‰‹ï¼Œæ‰¾ä¸åˆ°æ­£ç¡®çš„ä¿¡æ¯ï¼Œæ‰€ä»¥æˆ‘å†³å®šå†™å°½å¯èƒ½è¯¦ç»†çš„å‡ºç‰ˆç‰©ã€‚ è¯¥å‡ºç‰ˆç‰©å°†ä¸ä»…è®¨è®ºpostfixï¼Œdovecotï¼Œmysqlï¼Œpostfixadminï¼Œè¿˜è®¨è®ºspamassassinï¼Œclamav-milterï¼ˆç”¨äºé‚®ä»¶æœåŠ¡å™¨çš„clamavçš„ç‰¹æ®Šç‰ˆæœ¬...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>FreeBSDä¸Šçš„postfix + dovecot + mysql</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/476148/"><h2> å¼•è¨€ </h2><br> æˆ‘æƒ³ç ”ç©¶é‚®ä»¶æœåŠ¡å™¨å¾ˆé•¿æ—¶é—´ï¼Œä½†ç›´åˆ°ç°åœ¨æˆ‘çš„æ‰‹éƒ½ä¼¸æ‰‹ï¼Œæ‰¾ä¸åˆ°æ­£ç¡®çš„ä¿¡æ¯ï¼Œæ‰€ä»¥æˆ‘å†³å®šå†™å°½å¯èƒ½è¯¦ç»†çš„å‡ºç‰ˆç‰©ã€‚ è¯¥å‡ºç‰ˆç‰©å°†ä¸ä»…è®¨è®ºpostfixï¼Œdovecotï¼Œmysqlï¼Œpostfixadminï¼Œè¿˜è®¨è®ºspamassassinï¼Œclamav-milterï¼ˆç”¨äºé‚®ä»¶æœåŠ¡å™¨çš„clamavçš„ç‰¹æ®Šç‰ˆæœ¬ï¼‰ï¼Œpostgreyï¼Œä»¥åŠå°†åƒåœ¾é‚®ä»¶è½¬ç§»åˆ°Spamæ–‡ä»¶å¤¹çš„å¯èƒ½æ€§ï¼ˆdovecot-é¸½æ´ï¼‰ã€‚ <br><a name="habracut"></a><br><h3> å‡†å¤‡å·¥ä½œ </h3><br> é¦–å…ˆï¼Œæˆ‘ä»¬å°†å®‰è£…å·¥ä½œæ‰€éœ€çš„è½¯ä»¶åŒ…ï¼ˆå¿…é¡»ä»ç«¯å£å®‰è£…postfixï¼Œdovecotå’Œdovecot-pigeonholeï¼Œå¯ä»¥ä»è½¯ä»¶åŒ…å®‰è£…dovecot-sieveï¼ŒåŸåˆ™ä¸Šï¼Œç«¯å£ä¸­æœ‰è¾ƒæ–°çš„ç‰ˆæœ¬ï¼Œå› æ­¤ï¼Œdovecotä¸dovecot-ç­›å­ï¼‰ã€‚ å®‰è£…ä»¥ä¸‹è½¯ä»¶åŒ…ï¼š <br><br><pre><code class="plaintext hljs">pkg install apache24 php73 mod_php73 php73-extensions php73-mysqli php73-mbstring php73-openssl clamav-milter postgrey spamassassin mysql57-server openssl wget</code> </pre> <br> å®‰è£…åï¼Œæˆ‘ä»¬å°†å¿…è¦çš„æœåŠ¡ç½®äºè‡ªåŠ¨è¿è¡ŒçŠ¶æ€ï¼š <br><br><pre> <code class="plaintext hljs">#postfix  dovecot  ,       sysrc postfix_enable="YES" sysrc dovecot_enable="YES" sysrc mysql_enable="YES" sysrc apache24_enable="YES" sysrc spamd_flags="-u spamd -H /var/spool/spamd" sysrc spamd_enable="YES" sysrc postgrey_enable="YES" sysrc clamav_clamd_enable="YES" sysrc clamav_milter_enable="YES" sysrc clamav_freshclam_enable="YES" #freshclam        12  sysrc clamav_freshclam_flags="--daemon --checks=12"</code> </pre><br> è¿è¡ŒæœåŠ¡ï¼š <br><br><pre> <code class="plaintext hljs">service apache24 start service mysql-server start #  spamassassin       sa-update sa-compile service sa-spamd start #   clamav   freshclam service clamav-clamd start service clamav-freshclam start service clamav-milter start #  postgrey    (/usr/local/etc/rc.d/postgrey),       ""   4-   ,    : ${postgrey_flags:=--inet=10023}     : : ${postgrey_flags:=--inet=10023 --auto-whitelist-clients=4} service postgrey start</code> </pre><br> ä¸è¦å¿˜è®°åœ¨httpd.confä¸­æ·»åŠ ä½¿phpåœ¨apacheä¸­å·¥ä½œä»¥åŠpostfixadminæ­£å¸¸å·¥ä½œæ‰€å¿…éœ€çš„è¡Œï¼š <br><br><pre> <code class="plaintext hljs">&lt;FilesMatch "\.php$"&gt; SetHandler application/x-httpd-php &lt;/FilesMatch&gt; &lt;FilesMatch "\.phps$"&gt; SetHandler application/x-httpd-php-source &lt;/FilesMatch&gt; &lt;IfModule dir_module&gt; DirectoryIndex index.php &lt;/IfModule&gt; #         postfixadmin DocumentRoot "/usr/local/www/apache24/data/postfixadmin-3.2/public"</code> </pre><br> æ¥ä¸‹æ¥ï¼Œè½¬åˆ°ç›®å½•å¹¶ä¸‹è½½postfixadmin <br><br><pre> <code class="plaintext hljs">cd /usr/local/www/apache24/data</code> </pre><br> ä¸‹è½½postfixadminï¼ˆåœ¨æ’°å†™æœ¬æ–‡æ—¶ï¼Œå½“å‰ç‰ˆæœ¬ä¸º3.2ï¼‰ <br><br><pre> <code class="plaintext hljs">wget --no-check-certificate https://sourceforge.net/projects/postfixadmin/files/postfixadmin/postfixadmin-3.2/postfixadmin-3.2.tar.gz</code> </pre><br> ä¹‹åï¼Œæ‚¨éœ€è¦å°†å½’æ¡£æ–‡ä»¶è§£å‹ç¼©åˆ°æ­¤ç›®å½•å¹¶æ›´æ”¹ç›®å½•çš„æ‰€æœ‰è€…ï¼š <br><br><pre> <code class="plaintext hljs">gzip -d postfixadmin-3.2.tar.gz tar -xvf postfixadmin-3.2.tar chown -R www:www /usr/local/www/apache24/data service apache24 restart</code> </pre><br> æ¥ä¸‹æ¥ï¼Œä¸ºpostfixadminå‡†å¤‡æ•°æ®åº“ï¼Œè¿è¡Œmysql-secure-installationè„šæœ¬ï¼ˆåœ¨æ­¤è„šæœ¬ä¸­åˆ›å»ºçš„å¯†ç å°†éœ€è¦ä½¿ç”¨alter userå‘½ä»¤åœ¨mysqlä¸­åˆ›å»ºï¼‰ï¼Œç”¨äºmysqlçš„åˆå§‹è®¾ç½®ï¼Œç„¶åè¾“å…¥mysqlï¼Œåˆ›å»ºæ•°æ®åº“å¹¶è®¾ç½®æƒé™ä¸ºå¥¹ï¼š <br><br><pre> <code class="plaintext hljs">mysql -p -r alter user 'root'@'localhost' identified by 'password123'; create database postfix; grant all privileges on postfix.* to 'postfix'@'localhost' identified by 'password123'; exit</code> </pre><br> é…ç½®æ•°æ®åº“åï¼Œæ‚¨éœ€è¦ç¼–è¾‘config.inc.phpæ–‡ä»¶ï¼Œåœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæ­¤æ–‡ä»¶ä½äº/usr/local/www/apache24/data/postfixadmin-3.2/ç›®å½•ä¸­ï¼Œåœ¨æ­¤æ–‡ä»¶ä¸­ï¼Œæ‚¨éœ€è¦ç¼–è¾‘å‡ è¡Œå¹¶å°†å…¶ç§»è‡³è¯·æ³¨æ„ï¼Œæ›´æ”¹è®¾ç½®åï¼Œé‡æ–°å¯åŠ¨apacheï¼Œè¿˜éœ€è¦åœ¨/usr/local/www/apache24/data/postfixadmin-3.2ç›®å½•ä¸­åˆ›å»ºtemplates_cç›®å½•ï¼Œå¹¶å°†wwwæ‰€æœ‰è€…åˆ†é…ç»™å®ƒï¼š <br><br><pre> <code class="plaintext hljs">mkdir /usr/local/www/apache24/data/postfixadmin-3.2/templates_c chown -R www:www /usr/local/www/apache24/data/postfixadmin-3.2/templates_c $CONF['configured'] = true #       postfixadmin     . $CONF['setup_password'] = 'dd28fb2139a3bca426f02f60e6877fd5:13d2703c477b0ab85858e3ac5e076a0a7a477315'; $CONF['default_language'] = 'ru' $CONF['database_type'] = 'mysqli'; $CONF['database_host'] = 'localhost'; $CONF['database_user'] = 'postfix'; #           $CONF['database_password'] = 'password123'; $CONF['database_name'] = 'postfix'; service apache24 restart</code> </pre><br><h4>  SSLåè®® </h4><br> è¦ç”Ÿæˆå¯†é’¥ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨postfix.orgä¸Šæå‡ºçš„æ–¹æ³•ï¼Œå¹¶åˆ›å»ºè‡ªå·±çš„è¯ä¹¦é¢å‘æœºæ„ï¼Œæˆ‘ä»¬éœ€è¦è½¬åˆ°/ etc / sslç›®å½•å¹¶æ‰§è¡Œè„šæœ¬ï¼š <br><br><pre> <code class="plaintext hljs">cd /etc/ssl /usr/local/openssl/misc/CA.pl -newca</code> </pre><br> åœ¨è„šæœ¬æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå°†è¦æ±‚è¾“å…¥è¯ä¹¦åç§°ï¼Œä¸è¾“å…¥ä»»ä½•å†…å®¹ï¼ŒæŒ‰Enteré”®ï¼Œç„¶åè„šæœ¬å°†è¦æ±‚æ‚¨ä¸ºè¯ä¹¦åˆ›å»ºå¯†ç ï¼Œç„¶åä¼šå‡ºç°åˆ›å»ºè¯ä¹¦çš„æ ‡å‡†é—®é¢˜ã€‚ <br><br> æ¥ä¸‹æ¥ï¼Œæ‚¨éœ€è¦åˆ›å»ºä¸€ä¸ªç§˜å¯†å¯†é’¥ï¼ˆæ²¡æœ‰å¯†ç ï¼‰å’Œä¸€ä¸ªæœªç­¾åçš„å…¬å…±å¯†é’¥è¯ä¹¦ï¼ˆç»„ç»‡å•ä½åç§°ï¼ˆä¾‹å¦‚ï¼Œéƒ¨åˆ†ï¼‰[]åº”è¯¥ä¸ä¸Šé¢åˆ›å»ºçš„è¯ä¹¦ä¸­æŒ‡å®šçš„åç§°ä¸åŒï¼‰ï¼š <br><br><pre> <code class="plaintext hljs">openssl req -new -newkey rsa:4096 -nodes -keyout foo-key.pem -out foo-req.pem</code> </pre><br> æˆ‘ä»¬å°†ç­¾ç½²å…¬å…±å¯†é’¥è¯ä¹¦ï¼ˆæŒ‡å®šæ‚¨éœ€è¦çš„å¤©æ•°ï¼‰ï¼š <br><br><pre> <code class="plaintext hljs">openssl ca -out foo-cert.pem -days 365 -infiles foo-req.pem</code> </pre><br> å°†åˆ›å»ºçš„è¯ä¹¦ä¿ç•™åœ¨è¯¥ç›®å½•ä¸­ï¼Œæˆ–å°†å…¶è½¬ç§»åˆ°æ›´æ–¹ä¾¿çš„ç›®å½•ä¸­ï¼Œå°†è€ƒè™‘åˆ°è¯ä¹¦å°†åœ¨æ­¤ç›®å½•ä¸­çš„äº‹å®æ¥é…ç½®â€œ postfixâ€å’Œâ€œ dovecoteâ€é…ç½®ã€‚ <br><br><h4>  Vmailç”¨æˆ· </h4><br> åœ¨å¼€å§‹å®‰è£…postfixï¼Œdovecotå’Œdovecot-pigeonholeä¹‹å‰ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªç”¨æˆ·å’Œä¸€ä¸ªç»„ï¼ˆå°†è‡ªåŠ¨åˆ›å»ºä¸€ä¸ªç»„ï¼‰vmailï¼Œä»¥åŠä¸€ä¸ªé‚®ä»¶å°†ä½äºçš„ç›®å½•ã€‚ <br><br><pre> <code class="plaintext hljs">pw useradd -n vmail -s /usr/sbin/nologin -u 1000 -d /var/vmail</code> </pre><br> åˆ›å»ºé‚®ä»¶ç›®å½•å¹¶è®¾ç½®vmailç”¨æˆ·çš„æ‰€æœ‰è€…ï¼š <br><br><pre> <code class="plaintext hljs">mkdir /var/vmail chown -R vmail:vmail /var/vmail chmod -R 744 /var/vmail</code> </pre><br><h2>  Postfixï¼Œé¸½èˆï¼Œé¸½èˆé¸½å­æ´ </h2><br> å¦‚æˆ‘å…ˆå‰æ‰€å†™ï¼Œæˆ‘ä»¬å°†ä»ç«¯å£ç»„è£…åº”ç”¨ç¨‹åºæ•°æ®ï¼Œè¿è¡Œå‘½ä»¤ä»¥ä¸‹è½½å’Œè§£å‹ç¼©ç«¯å£ï¼š <br><br><pre> <code class="plaintext hljs">portsnap fetch extract</code> </pre><br> æ‰“å¼€ç«¯å£çš„åŒ…è£…åï¼Œè½¬åˆ°dovecotç›®å½•ï¼Œé…ç½®ç«¯å£ï¼ˆæ³¨æ„å¯¹mysqlçš„æ”¯æŒï¼‰å¹¶è¿è¡Œæ„å»ºï¼ˆBATCH = yeså°†å‘Šè¯‰makeåœ¨å®‰è£…è¿‡ç¨‹ä¸­ä¸è¦é—®é—®é¢˜ï¼‰ï¼š <br><br><pre> <code class="plaintext hljs">cd /usr/ports/mail/dovecot make config make BATCH=yes install clean</code> </pre><br> ç”¨postfixå’Œdovecot-pigeonholeåšåŒæ ·çš„äº‹æƒ… <br><br> é¸½å­çªï¼š <br><br><pre> <code class="plaintext hljs">cd /usr/ports/mail/dovecot-pigeonhole make BATCH=yes install clean</code> </pre><br> åç¼€ï¼šè¿˜æ£€æŸ¥ç«¯å£è®¾ç½®ä¸­çš„mysqlæ”¯æŒ <br><br><pre> <code class="plaintext hljs">cd /usr/ports/mail/postfix-sasl make config make BATCH=yes install clean</code> </pre><br> åœ¨å¯åŠ¨é¸½èˆä¹‹å‰ï¼Œè¯·å¤åˆ¶â€œ configsâ€ï¼š <br><br><pre> <code class="plaintext hljs"> cp -R /usr/local/etc/dovecot/example-config/* /usr/local/etc/dovecot</code> </pre><br> å®‰è£…postfixå’Œdovecotä¹‹åï¼Œå¯åŠ¨æœåŠ¡ï¼š <br><br><pre> <code class="plaintext hljs">service postfix start service dovecot start</code> </pre><br> è¿˜å¿…é¡»åˆ›å»ºä¸€ä¸ªç›®å½•ï¼Œåœ¨è¯¥ç›®å½•ä¸­å°†ç¼–è¯‘ç”¨äºå°†åƒåœ¾é‚®ä»¶å‘é€åˆ°spamæ–‡ä»¶å¤¹çš„æ¨¡å—ï¼Œåœ¨æˆ‘çš„æƒ…å†µä¸‹ï¼Œè¯¥ç›®å½•ä½äº/usr/local/etc/dovecot/conf.dæ–‡ä»¶å¤¹ä¸­ï¼Œç›®å½•åä¸ºdefï¼Œåˆ›å»ºæ­¤ç›®å½•ä»¥åŠå¸¦æœ‰ç¼–è¯‘ä»£ç çš„æ–‡ä»¶å¹¶è®¾ç½®ç»™å®švmailç”¨æˆ·ç›®å½•çš„æ‰€æœ‰è€…ï¼š <br><br><pre> <code class="plaintext hljs">mkdir /usr/local/etc/dovecot/conf.d/def touch /usr/local/etc/dovecot/conf.d/def/default.sieve chown -R vmail:vmail /usr/local/etc/dovecot/conf.d/def chmod -R 744 /usr/local/etc/dovecot/conf.d/def</code> </pre><br> å°†è¡Œæ”¾åœ¨æ­¤æ–‡ä»¶ä¸­ï¼š <br><br><pre> <code class="plaintext hljs">require "fileinto"; if header :contains "X-Spam-Flag" "YES" { fileinto "Junk"; }</code> </pre><br><h3> è®¾å®šæ¡£ </h3><br> åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘å°†ç»™å‡ºå¸¦æœ‰æ³¨é‡Šçš„â€œ configsâ€ç¤ºä¾‹ï¼Œæˆ‘åªæ€€ç–‘spamassassinçš„â€œ configâ€ï¼Œå› ä¸ºæˆ‘æ²¡æœ‰åœ¨ç½‘ç»œä¸Šæ‰¾åˆ°æ­£ç¡®çš„æè¿°ï¼ˆé»˜è®¤æƒ…å†µä¸‹ï¼Œæˆ‘ä¿ç•™äº†â€œ configâ€ï¼‰ï¼Œè¯·åœ¨æ³¨é‡Šä¸­æ·»åŠ å¦‚ä½•æœ€å¥½åœ°é…ç½®spamassassinã€‚ <br><br><h4> åç¼€ </h4><br> é¦–å…ˆï¼Œæ‚¨éœ€è¦åˆ›å»ºæ–‡ä»¶ä»¥ä»æ•°æ®åº“ä¸­æå–ç”¨æˆ·ï¼ŒåŸŸï¼Œé…é¢ã€‚ åˆ›å»ºä¸€ä¸ªç›®å½•æ¥å­˜å‚¨æ•°æ®æ–‡ä»¶å’Œå¿…è¦çš„æ–‡ä»¶ï¼š <br><br><pre> <code class="plaintext hljs">mkdir /usr/local/etc/postfix/mysql touch /usr/local/etc/postfix/mysql/relay_domains.cf touch /usr/local/etc/postfix/mysql/virtual_alias_maps.cf touch /usr/local/etc/postfix/mysql/virtual_alias_domain_maps.cf touch /usr/local/etc/postfix/mysql/virtual_mailbox_maps.cf</code> </pre><br> è¿™äº›æ–‡ä»¶çš„å†…å®¹å°†æ˜¯ï¼š <br>  relay_domains.cf <br><br><pre> <code class="plaintext hljs">hosts = 127.0.0.1 user = postfix password = password123 dbname = postfix query = SELECT domain FROM domain WHERE domain='%s' and backupmx = '1'</code> </pre><br>  virtual_alias_maps.cf <br><br><pre> <code class="plaintext hljs">hosts = 127.0.0.1 user = postfix password = password123 dbname = postfix query = SELECT goto FROM alias WHERE address='%s' AND active ='1'</code> </pre><br>  virtual_alias_domain_maps.cf <br><br><pre> <code class="plaintext hljs">hosts = 127.0.0.1 user = postfix password = password123 dbname = postfix query = SELECT goto FROM alias,alias_domain WHERE alias_domain.alias_domain = '%d' and alias.address = CONCAT('%u', '@', alias_domain.target_domain) AND alias.active = '1'</code> </pre><br>  virtual_mailbox_maps.cf <br><br><pre> <code class="plaintext hljs">hosts = 127.0.0.1 user = postfix password = password123 dbname = postfix query = SELECT maildir FROM mailbox WHERE username='%s' AND active = '1'</code> </pre><br>  master.cf <br><br><pre> <code class="plaintext hljs"># postfix  ,    dovecot    dovecot unix - nn - - pipe flags=DRhu user=vmail:vmail argv=/usr/local/libexec/dovecot/deliver -f ${sender} -d ${recipient} #  smtpd     sasl,    ,  spamassassin    smtp inet n - n - - smtpd -o content_filter=spamassassin -o smtpd_sasl_auth_enable=yes #  587     sasl submission inet n - n - - smtpd -o smtpd_sasl_auth_enable=yes #  smtp    SASL smtps inet n - n - - smtpd -o smtpd_sasl_auth_enable=yes -o smtpd_tls_wrappermode=yes # Spamassassin spamassassin unix - nn - - pipe flags=DROhu user=vmail:vmail argv=/usr/local/bin/spamc -f -e /usr/local/libexec/dovecot/deliver -f ${sender} -d ${user}@${nexthop} #628 inet n - n - - qmqpd pickup unix n - n 60 1 pickup cleanup unix n - n - 0 cleanup qmgr unix n - n 300 1 qmgr #qmgr unix n - n 300 1 oqmgr tlsmgr unix - - n 1000? 1 tlsmgr rewrite unix - - n - - trivial-rewrite bounce unix - - n - 0 bounce defer unix - - n - 0 bounce trace unix - - n - 0 bounce verify unix - - n - 1 verify flush unix n - n 1000? 0 flush proxymap unix - - n - - proxymap proxywrite unix - - n - 1 proxymap smtp unix - - n - - smtp relay unix - - n - - smtp -o syslog_name=postfix/$service_name # -o smtp_helo_timeout=5 -o smtp_connect_timeout=5 showq unix n - n - - showq error unix - - n - - error retry unix - - n - - error discard unix - - n - - discard local unix - nn - - local virtual unix - nn - - virtual lmtp unix - - n - - lmtp anvil unix - - n - 1 anvil scache unix - - n - 1 scache postlog unix-dgram n - n - 1 postlogd</code> </pre><br>  main.cf <br><br><pre> <code class="plaintext hljs">#       dovecot,       local_transport = dovecot #      ,  SMTP-      EHLO  SMTP  smtpd_discard_ehlo_keywords = CONNECT GET POST #            smtpd_delay_reject = yes #     smtpd_helo_required = yes #     ,   disable_vrfy_command = yes #       broken_sasl_auth_clients = yes #   smtpd_sasl_security_options = noanonymous noactive nodictionary smtp_sasl_security_options = noanonymous noactive nodictionary # dovecot  (  cyrus) smtpd_sasl_type = dovecot smtp_sasl_type = dovecot #    smtpd_sasl_path = private/auth #   local_recipient_maps = $virtual_mailbox_maps $virtual_alias_maps #   ,    smtpd_reject_unlisted_recipient = yes #   message_size_limit = 10485760 #     spamassassin spamassassin_destination_recipient_limit = 1 # milter_default_action = accept milter_protocol = 2 #   clamav smtpd_milters = unix:/var/run/clamav/clmilter.sock non_smtpd_milters = unix:/var/run/clamav/clmilter.sock #MYSQL relay_domains = mysql:/usr/local/etc/postfix/mysql/relay_domains.cf virtual_alias_maps = mysql:/usr/local/etc/postfix/mysql/virtual_alias_maps.cf, mysql:/usr/local/etc/postfix/mysql/virtual_alias_domain_maps.cf virtual_mailbox_maps = mysql:/usr/local/etc/postfix/mysql/virtual_mailbox_maps.cf # HELO smtpd_helo_restrictions = permit_sasl_authenticated, reject_non_fqdn_helo_hostname, reject_invalid_hostname #    smtpd_data_restrictions = permit_sasl_authenticated reject_unauth_pipelining, reject_multi_recipient_bounce #   smtpd_sender_restrictions = permit_sasl_authenticated reject_sender_login_mismatch,reject_unauthenticated_sender_login_mismatch, reject_non_fqdn_sender, reject_unknown_sender_domain #  (check_policy_service inet:127.0.0.1:10023  postgrey -      ) smtpd_recipient_restrictions = permit_sasl_authenticated reject_non_fqdn_recipient, reject_unknown_recipient_domain, reject_multi_recipient_bounce, reject_unknown_client_hostname, reject_unauth_destination, check_policy_service inet:127.0.0.1:10023 #   virtual_mailbox_base = /var/vmail #uid  gid vmail virtual_minimum_uid = 1000 virtual_uid_maps = static:1000 virtual_gid_maps = static:1000 #   virtual_transport = devecot dovecot_destination_recipient_limit = 1 #  smtp_use_tls=yes smtp_tls_note_starttls_offer=yes # smtp_tls_security_level=encrypt       ssl,        ssl,    smtp_tls_security_level=may(    ssl,     ) smtp_tls_security_level=encrypt smtp_tls_session_cache_database=btree:$data_directory/smtp_tls_session_cache smtp_tls_CAfile=/etc/ssl/demoCA/cacert.pem smtp_tls_key_file=/etc/ssl/foo-key.pem smtp_tls_cert_file=/etc/ssl/foo-cert.pem smtp_tls_session_cache_timeout=3600s smtp_tls_protocols=!TLSv1.2 smtp_tls_loglevel=1 # smtpd_tls_security_level=encrypt       ssl,        ssl,    smtpd_tls_security_level=may(    ssl,     ) smtpd_tls_security_level=encrypt smtpd_use_tls=yes smtpd_tls_auth_only=yes smtpd_tls_loglevel=1 smtpd_tls_received_header=yes smtpd_tls_session_cache_timeout=3600s smtpd_tls_session_cache_database=btree:$data_directory/smtpd_tls_session_cache smtpd_tls_key_file=/etc/ssl/foo-key.pem smtpd_tls_cert_file=/etc/ssl/foo-cert.pem smtpd_tls_CAfile= /etc/ssl/demoCA/cacert.pem smtpd_tls_protocols=!TLSv1.2 #      tls_random_source=dev:/dev/urandom #  compatibility_level = 2 #   ,    ,      ,    soft_bounce = no #   UNIX       postfix mail_owner = postfix #     postfix(        ) myhostname = $mydomain #       mydomain = virusslayer.su myorigin = $myhostname #    inet_interfaces = all #        mydestination = $mydomain, localhost, localhost.$mydomain #   550         unknown_local_recipient_reject_code = 550 #    localhost mynetworks_style = host #       , -         mynetworks = #  ip inet_protocols = ipv4 #  (   ) alias_maps = hash:/etc/mail/aliases alias_database = dbm:/etc/mail/aliases.db #          smtpd_banner = $myhostname ESMTP $mail_name #       debug_peer_level = 2 #      (   ,    yandex.ru gmail.ru mail.ru  ..) debug_peer_list = 127.0.0.1 #   debugger_command = PATH=/bin:/usr/bin:/usr/local/bin:/usr/X11R6/bin ddd $daemon_directory/$process_name $process_id &amp; sleep 5 #  sendmail sendmail_path = /usr/local/sbin/sendmail mailq_path = /usr/local/bin/mailq setgid_group = maildrop #    html_directory = /usr/local/share/doc/postfix manpage_directory = /usr/local/man sample_directory = /usr/local/etc/postfix readme_directory = /usr/local/share/doc/postfix meta_directory = /usr/local/libexec/postfix shlib_directory = /usr/local/lib/postfix queue_directory = /var/spool/postfix command_directory = /usr/local/sbin daemon_directory = /usr/local/libexec/postfix data_directory = /var/db/postfix</code> </pre><br><h4> å¤šç§‘ç‰¹ </h4><br>  dovecot.conf <br><br><pre> <code class="plaintext hljs">#     dovecot protocols = imap pop3 #    listen = *, :: #        mysql dict { quota = mysql:/usr/local/etc/dovecot/dovecot-dict-sql.conf.ext } #   !include conf.d/*.conf !include_try local.conf</code> </pre><br>  dovecot-dict-sql.conf.ext <br><br><pre> <code class="plaintext hljs">connect = host=127.0.0.1 dbname=postfix user=postfix password=password123 map { pattern = priv/quota/storage table = quota2 username_field = username value_field = bytes } map { pattern = priv/quota/messages table = quota2 username_field = username value_field = messages }</code> </pre><br>  dovecot-sql.conf.ext <br><br><pre> <code class="plaintext hljs">#    MYSQL driver = mysql connect = host=127.0.0.1 dbname=postfix user=postfix password=password123 #     default_pass_scheme = MD5 #  ,    user_query = SELECT '/var/mail/%d/%n/' AS home, 'maildir:/var/vmail/%d/%n' AS mail, 1000 AS uid, 1000 AS gid, concat('*:bytes=',quota) as quota_rule FROM mailbox \ WHERE username ='%u' AND active = '1' password_query = SELECT username as user, password, '/var/vmail/%d/%n' as userdb_home, 'maildir:/var/vmail/%d/%n' as userdb_mail, 1000 as userdb_uid, \ 1000 as userdb_gid, concat('*:bytes=',quota) AS userdb_quota_rule FROM mailbox WHERE username ='%u' AND active ='1'</code> </pre><br>  10-èº«ä»½éªŒè¯ <br><br><pre> <code class="plaintext hljs">#   SSL disable_plaintext_auth = yes #   auth_realms = virusslayer.su auth_default_realm = virusslayer.su #    ( ,         ssl) auth_mechanisms = plain login #   ,  !include auth-sql.conf.ext,        mysql #!include auth-deny.conf.ext #!include auth-master.conf.ext #!include auth-system.conf.ext !include auth-sql.conf.ext #!include auth-ldap.conf.ext #!include auth-passwdfile.conf.ext #!include auth-checkpassword.conf.ext #!include auth-vpopmail.conf.ext #!include auth-static.conf.ext</code> </pre><br>  10ä¸ªé‚®ä»¶ <br><br><pre> <code class="plaintext hljs">#    mail_location = maildir:/var/vmail/%d/%n #       namespace inbox { inbox = yes } #uid  gid vmail mail_uid = 1000 mail_gid = 1000 # ,    quota mail_plugins = quota</code> </pre><br>  10-master.conf <br><br><pre> <code class="plaintext hljs">#     ssl service imap-login { inet_listener imap { port = 143 } inet_listener imaps { port = 993 ssl = yes } } service pop3-login { inet_listener pop3 { port = 110 } inet_listener pop3s { port = 995 ssl = yes } } service submission-login { inet_listener submission { port = 587 } } #           (   ,       ) service auth { unix_listener auth-userdb { mode = 0600 user = vmail group = vmail } # Postfix smtp-auth unix_listener /var/spool/postfix/private/auth { mode = 0666 user = postfix group = postfix } } #  vmail   service dict { unix_listener dict { mode = 0660 user = vmail group = vmail } }</code> </pre><br>  10-ssl.conf <br><br><pre> <code class="plaintext hljs"># ssl  (    sll  ) ssl = required #   ssl_cert = &lt;/etc/ssl/foo-cert.pem ssl_key = &lt;/etc/ssl/foo-key.pem ssl_ca = &lt;/etc/ssl/demoCA/cacert.pem #    ssl_min_protocol = TLSv1.2</code> </pre><br>  15-lda.conf <br><br><pre> <code class="plaintext hljs">quota_full_tempfail = no lda_mailbox_autosubscribe = yes protocol lda { #      sieve,        mail_plugins = $mail_plugins sieve quota }</code> </pre><br>  90-æ’ä»¶.conf <br><br><pre> <code class="plaintext hljs">#             "",       chown -R vmail:vmail #          "" plugin { #setting_name = value sieve = /usr/local/etc/dovecot/conf.d/def/default.sieve }</code> </pre><br>  auth-sql.conf.ext <br><br><pre> <code class="plaintext hljs">#      MYSQL passdb { driver = sql # Path for SQL configuration file, see example-config/dovecot-sql.conf.ext args = /usr/local/etc/dovecot/dovecot-sql.conf.ext } userdb { driver = sql args = /usr/local/etc/dovecot/dovecot-sql.conf.ext }</code> </pre><br><h3>  Spamassassin </h3><br>  â€œ spamassassinâ€çš„â€œé…ç½®â€çœ‹èµ·æ¥åƒè¿™æ ·ï¼Œä½†æ˜¯æœ‰äº›ä¿¡æ¯å‘Šè¯‰æˆ‘æ•°æ®è¿˜ä¸å¤Ÿï¼Œè¯·å¸®åŠ©â€œ configâ€ä¸­çš„æ•°æ®ï¼š <br><br>  local.cf <br><br><pre> <code class="plaintext hljs">rewrite_header Subject *****SPAM***** report_safe 0 required_score 5.0 use_bayes 1 bayes_auto_learn 1 ifplugin Mail::SpamAssassin::Plugin::Shortcircuit endif # Mail::SpamAssassin::Plugin::Shortcircuit</code> </pre><br> è¿˜éœ€è¦å¯¹æœ‰åƒåœ¾é‚®ä»¶å’Œæ²¡æœ‰åƒåœ¾é‚®ä»¶çš„ä¿¡ä»¶è¿›è¡ŒåŸ¹è®­ï¼š <br><br><pre> <code class="plaintext hljs">sa-learn --spam /path/spam/folder sa-learn --ham /path/ham/folder</code> </pre><br><h2> é€‰é… </h2><br> åœ¨æœ¬éƒ¨åˆ†ä¸­ï¼Œæˆ‘å°†åŸºäºpfæŒ‡å®šé˜²ç«å¢™è®¾ç½®ï¼Œå°†pfæ·»åŠ åˆ°è‡ªåŠ¨è¿è¡Œå¹¶ä½¿ç”¨ä»¥ä¸‹è§„åˆ™æŒ‡å®šæ–‡ä»¶ï¼š <br><br><pre> <code class="plaintext hljs">sysrc pf_enable="YES" sysrc pf_rules="/etc/0.pf"</code> </pre><br> ä½¿ç”¨è§„åˆ™åˆ›å»ºæ–‡ä»¶ï¼š <br><br><pre> <code class="plaintext hljs">ee /etc/0.pf</code> </pre><br> å¹¶æ·»åŠ è§„åˆ™ï¼š <br><br><pre> <code class="plaintext hljs"># (   lo0)    ,     set skip on lo0 #      deovecot, postfix, root pass in quick proto { tcp, udp } from any to any port {53,25,465,587,110,143,993,995} user {dovecot,postfix,root} flags S/SA modulate state pass out quick proto { tcp, udp } from any to any port {53,25,465,587,110,143,993,995} user {dovecot,postfix,root} #      root pass out quick proto {tcp,udp} from any to any user root #     pass in quick proto tcp from any to any port 80 flags S/SA modulate state #SSH pass in quick proto tcp from any to any port 22 flags S/SA modulate state #     clamav  spamd pass out quick proto {tcp,udp} from any to any user {clamav,spamd} #DNS  ICMP pass out quick proto {tcp,udp} from any to any port=53 keep state pass out quick proto icmp from any to any block from any to any fragment block from any to any block all</code> </pre><br> æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿è¡Œpfï¼š <br><br><pre> <code class="plaintext hljs">service pf start</code> </pre><br><h2> æµ‹è¯•ä¸­ </h2><br> è¦æµ‹è¯•æ‰€æœ‰å¯èƒ½çš„è¿æ¥ï¼ˆSTARTTLSï¼ŒSLLï¼‰ï¼Œå¯ä»¥å°†MyOffice Mailå®¢æˆ·ç«¯ç”¨äºç§»åŠ¨è®¾å¤‡ï¼ˆåœ¨æˆ‘çš„æƒ…å†µä¸‹ä¸ºiosï¼‰ï¼Œåœ¨æ­¤åº”ç”¨ç¨‹åºä¸­ï¼Œæœ‰è®¸å¤šå‚æ•°ç”¨äºé…ç½®ä¸é‚®ä»¶æœåŠ¡å™¨çš„è¿æ¥ã€‚ <br><br> è¦æµ‹è¯•spaassasinï¼Œæˆ‘ä»¬ä½¿ç”¨GTUBEç­¾åï¼Œåœ¨æ¶ˆæ¯ä¸­æ·»åŠ ä»¥ä¸‹è¡Œï¼š <br><br><pre> <code class="plaintext hljs">XJS*C4JDBQADN1.NSBN3*2IDNEN*GTUBE-STANDARD-ANTI-UBE-TEST-EMAIL*C.34X</code> </pre><br> å¦‚æœä¸€åˆ‡æ­£ç¡®ï¼Œè¯¥é‚®ä»¶å°†è¢«æ ‡è®°ä¸ºåƒåœ¾é‚®ä»¶ï¼Œå¹¶ç›¸åº”åœ°ç§»è‡³åƒåœ¾é‚®ä»¶æ–‡ä»¶å¤¹ã€‚ <br><br> è¦æµ‹è¯•é˜²ç—…æ¯’è½¯ä»¶ï¼Œæ‚¨éœ€è¦å‘é€å¸¦æœ‰æ–‡æœ¬æ–‡ä»¶çš„ç”µå­é‚®ä»¶ï¼Œè¯¥æ–‡ä»¶ä¸­å°†åŒ…å«ä¸€ä¸ªEICARåºåˆ—ï¼š <br><br><pre> <code class="plaintext hljs">X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*</code> </pre><br> è‡ªç„¶éœ€è¦ä»å¤–éƒ¨é‚®ç®±å‘é€ä¿¡ä»¶ã€‚ <br> è¦å®æ—¶æŸ¥çœ‹æ—¥å¿—ï¼Œè¯·è¿è¡Œï¼š <br><br><pre> <code class="plaintext hljs">tail -f /var/log/maillog</code> </pre><br> å¦å¤–ï¼Œä¸ºäº†æ­£ç¡®æµ‹è¯•å°†é‚®ä»¶å‘é€åˆ°å¤–éƒ¨é‚®ç®±ï¼ˆä¾‹å¦‚yandex.ruï¼Œmail.ruï¼Œgmail.comç­‰ï¼‰ï¼Œæ‚¨éœ€è¦æ³¨å†Œåå‘DNSåŒºåŸŸï¼ˆPTRè®°å½•ï¼‰ï¼Œå¯ä»¥é€šè¿‡ä¸æä¾›å•†è”ç³»æ¥è¿›è¡Œï¼ˆå¦‚æœæ‚¨å½“ç„¶æ²¡æœ‰è‡ªå·±çš„DNSæœåŠ¡å™¨ï¼‰ã€‚ <br><br><h2> ç»“è®º </h2><br> å½“ç„¶ï¼Œé‚®ä»¶æœåŠ¡å™¨ä¼¼ä¹æ˜¯ä¸€ä»¶ç›¸å½“å¤æ‚çš„äº‹æƒ…ï¼Œä½†æ˜¯å¦‚æœæ‚¨å¼„æ¸…æ¥šäº†ï¼Œå®ƒæ ¹æœ¬ä¸æ˜¯é‚£æ ·ï¼ŒèŠ±äº†ä¸€äº›æ—¶é—´è¿›è¡Œé…ç½®åï¼Œæ‚¨å¯ä»¥å¾—åˆ°ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„é‚®ä»¶æœåŠ¡å™¨ï¼Œå¹¶ä¸”å¯ä»¥æŠµå¾¡åƒåœ¾é‚®ä»¶å’Œç—…æ¯’ã€‚ <br><br>  PSï¼šå¦‚æœæ‚¨æ‰“ç®—ç”¨æ³¨é‡Šâ€œå¤åˆ¶-ç²˜è´´â€ï¼Œåˆ™éœ€è¦å°†rootç”¨æˆ·ï¼ˆä»¥åŠéœ€è¦å®ƒçš„ç”¨æˆ·ï¼‰æ·»åŠ åˆ°ä¿„è¯­ç±»æ—¥å¿—ä¸­ï¼š <br><br><pre> <code class="plaintext hljs">pw usermod root -L russian</code> </pre><br> è¿™äº›æ“ä½œä¹‹åï¼Œä¿„è¯­å­—ç¬¦å°†æ­£ç¡®æ˜¾ç¤ºã€‚ </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN476148/">https://habr.com/ru/post/zh-CN476148/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN476138/index.html">å¤©æ–‡å­¦å®¶è®¤ä¸ºï¼Œé€šä¿¡å«æ˜ŸSpaceXï¼ŒOneWebå’Œå…¶ä»–å…¬å¸å¨èƒç€å¤©æ–‡å­¦çš„æœªæ¥</a></li>
<li><a href="../zh-CN476140/index.html">å¦‚æœæ‚¨çŸ¥é“7000ä¸ªå•è¯ä½†å¬ä¸æ‡‚ï¼Œè¯¥å¦‚ä½•æé«˜å¬åŠ›ï¼Ÿ</a></li>
<li><a href="../zh-CN476142/index.html">ä¸ºä»€ä¹ˆè¦é¿å…ä½¿ç”¨å¼‚å¸¸æ¥æ§åˆ¶Javaæµ</a></li>
<li><a href="../zh-CN476144/index.html">ä½¿ç”¨æˆ‘ç©â€œç§˜å¯†åœ£è¯è€äººâ€çš„æœºå™¨äººç¤ºä¾‹ï¼Œæ‚¨å¦‚ä½•ä»¥åŠä¸éœ€è¦ä¸ºæœºå™¨äººç¼–å†™èŠå¤©è®°å½•</a></li>
<li><a href="../zh-CN476146/index.html">å¦‚ä½•æ‰©å±•æ•°æ®ä¸­å¿ƒã€‚ YandexæŠ¥å‘Š</a></li>
<li><a href="../zh-CN476156/index.html">ä½¿ç”¨Apache Kafkaçš„åŒæ­¥è¯·æ±‚-å“åº”</a></li>
<li><a href="../zh-CN476160/index.html">æ•™è‚²è½¯ä»¶çš„è¯ç”ŸåŠå…¶å†å²ï¼šä»æœºæ¢°æœºå™¨åˆ°ç¬¬ä¸€å°è®¡ç®—æœº</a></li>
<li><a href="../zh-CN476162/index.html">æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªç°ä»£çš„Webåº”ç”¨ç¨‹åºã€‚ ç†Ÿæ‚‰é¡¹ç›®å¹¶åšå¥½å·¥ä½œå‡†å¤‡ã€‚ ç¬¬ä¸€éƒ¨åˆ†</a></li>
<li><a href="../zh-CN476164/index.html">â€œè¿™ä¹Ÿæ˜¯æ•°æ®åˆ†æã€‚â€ ä¸Mikhail Gelfandè°ˆç”Ÿç‰©ä¿¡æ¯å­¦</a></li>
<li><a href="../zh-CN476166/index.html">â€œçœŸæ­£çš„é’¢é“ä¾ â€æ‰“ç ´äº†é£è¡Œé€Ÿåº¦çºªå½•</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>