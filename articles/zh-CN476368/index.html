<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘ ğŸ”º ğŸ™†ğŸ¾ ä½¿ç”¨GitHub Actionså’ŒPythonæ„å»ºHome CI / CD ğŸ’™ â˜•ï¸ ğŸ’…ğŸ¾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ä¸€ä¸ªæ™šä¸Šï¼Œå½“æˆ‘ä¸‹ç­å›å®¶æ—¶ï¼Œæˆ‘å†³å®šåšä¸€äº›åŠŸè¯¾ã€‚ æˆ‘è¿›è¡Œäº†å‡ æ¬¡ç¼–è¾‘ï¼Œå¹¶ç«‹å³æƒ³å°è¯•ä¸€ä¸‹ã€‚ ä½†æ˜¯åœ¨å®éªŒä¹‹å‰ï¼Œæˆ‘å¿…é¡»è¿›å…¥VPSï¼Œæ¨é€æ›´æ”¹ï¼Œé‡å»ºå®¹å™¨å¹¶è¿è¡Œå®ƒã€‚ ç„¶åæˆ‘å†³å®šæ˜¯æ—¶å€™åº”å¯¹æŒç»­äº¤ä»˜äº†ã€‚ 



 æœ€åˆï¼Œæˆ‘åœ¨Circle CIï¼ŒTravisæˆ–Jenkinsä¹‹é—´è¿›è¡Œé€‰æ‹©ã€‚ ç”±äºå‡ ä¹ä¸éœ€è¦å¦‚æ­¤å¼ºå¤§çš„å·¥å…·ï¼Œå› æ­¤...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ä½¿ç”¨GitHub Actionså’ŒPythonæ„å»ºHome CI / CD</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/476368/"><p>ä¸€ä¸ªæ™šä¸Šï¼Œå½“æˆ‘ä¸‹ç­å›å®¶æ—¶ï¼Œæˆ‘å†³å®šåšä¸€äº›åŠŸè¯¾ã€‚ æˆ‘è¿›è¡Œäº†å‡ æ¬¡ç¼–è¾‘ï¼Œå¹¶ç«‹å³æƒ³å°è¯•ä¸€ä¸‹ã€‚ ä½†æ˜¯åœ¨å®éªŒä¹‹å‰ï¼Œæˆ‘å¿…é¡»è¿›å…¥VPSï¼Œæ¨é€æ›´æ”¹ï¼Œé‡å»ºå®¹å™¨å¹¶è¿è¡Œå®ƒã€‚ ç„¶åæˆ‘å†³å®šæ˜¯æ—¶å€™åº”å¯¹æŒç»­äº¤ä»˜äº†ã€‚ <br><img src="https://habrastorage.org/webt/xa/l4/dm/xal4dmowtxwpuoxxrutujwwy4fm.jpeg"></p><a name="habracut"></a><br><p> æœ€åˆï¼Œæˆ‘åœ¨Circle CIï¼ŒTravisæˆ–Jenkinsä¹‹é—´è¿›è¡Œé€‰æ‹©ã€‚ ç”±äºå‡ ä¹ä¸éœ€è¦å¦‚æ­¤å¼ºå¤§çš„å·¥å…·ï¼Œå› æ­¤æˆ‘å‡ ä¹ç«‹å³æ’é™¤äº†è©¹é‡‘æ–¯ã€‚ å¿«é€Ÿäº†è§£Travisä¹‹åï¼Œæˆ‘å¾—å‡ºçš„ç»“è®ºæ˜¯ï¼Œåœ¨å…¶ä¸­ç»„è£…å’Œæµ‹è¯•å¾ˆæ–¹ä¾¿ï¼Œä½†æ˜¯æ‚¨æ— æ³•æƒ³è±¡å®ƒä¼šå¸¦æ¥ä»»ä½•äº¤ä»˜ã€‚ æˆ‘ä»youtubeä¸Šçš„è¿‡åº¦ä¾µå…¥å¼å¹¿å‘Šä¸­äº†è§£äº†Circle CIã€‚ æˆ‘å¼€å§‹å°è¯•ä½¿ç”¨ç¤ºä¾‹ï¼Œä½†æ˜¯åœ¨æŸä¸ªæ—¶å€™æˆ‘è¢«å¼„é”™äº†ï¼Œå¹¶ä¸”ç»è¿‡äº†æ°¸æ’çš„æµ‹è¯•ï¼Œè¿™èŠ±äº†æˆ‘å¾ˆå¤šå®è´µçš„æ—¶é—´ï¼ˆæ€»çš„æ¥è¯´ï¼Œä¸å¿…æ‹…å¿ƒï¼Œä½†æœ‰è¶³å¤Ÿçš„é™åˆ¶ï¼Œä½†è¿™æ‰“å‡»äº†æˆ‘ï¼‰ã€‚ å†æ¬¡è¿›è¡Œæœç´¢æ—¶ï¼Œæˆ‘å¶ç„¶å‘ç°äº†Github Actionsã€‚ åœ¨é˜…è¯»äº†â€œå…¥é—¨â€ç¤ºä¾‹ä¹‹åï¼Œæˆ‘ç»™äººç•™ä¸‹äº†å¾ˆå¥½çš„å°è±¡ï¼Œå¹¶ä¸”å¿«é€Ÿæµè§ˆäº†æ–‡æ¡£ä¹‹åï¼Œå¾—å‡ºçš„ç»“è®ºæ˜¯ï¼Œæˆ‘å¯ä»¥ç§˜å¯†åœ°è¿›è¡Œç»„è£…ï¼Œæ”¶é›†å’Œå®é™…éƒ¨ç½²é¡¹ç›®åœ¨ä¸€ä¸ªåœ°æ–¹ï¼Œè¿™æ˜¯éå¸¸é…·çš„ã€‚ ä»–ç”¨å‘å…‰çš„çœ¼ç›è¿…é€Ÿç”»å‡ºæ‰€éœ€çš„æ–¹æ¡ˆï¼Œç„¶åé½¿è½®å¼€å§‹æ—‹è½¬ã€‚ </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/h1/fp/rv/h1fprvm3jru4em3vj0ae6xruu5i.jpeg" alt="è®¡åˆ’"></div><br><p> é¦–å…ˆï¼Œæˆ‘ä»¬å°†å°è¯•è¿›è¡Œæµ‹è¯•ã€‚ ä½œä¸ºå®éªŒï¼Œæˆ‘åœ¨Flaskä¸Šç¼–å†™äº†ä¸€ä¸ªç®€å•çš„WebæœåŠ¡å™¨ï¼Œå…¶ä¸­åŒ…å«2ä¸ªç«¯ç‚¹ï¼š </p><br><div class="spoiler">  <b class="spoiler_title">åˆ—å‡ºä¸€ä¸ªç®€å•çš„Webåº”ç”¨ç¨‹åº</b> <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> flask <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Flask <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> flask <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> request, jsonify app = Flask(__name__) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">validate_post_data</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(data: dict)</span></span></span><span class="hljs-function"> -&gt; bool:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> isinstance(data, dict): <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> data.get(<span class="hljs-string"><span class="hljs-string">'name'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> isinstance(data[<span class="hljs-string"><span class="hljs-string">'name'</span></span>], str): <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> data.get(<span class="hljs-string"><span class="hljs-string">'age'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> isinstance(data[<span class="hljs-string"><span class="hljs-string">'age'</span></span>], int): <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> @app.route(<span class="hljs-string"><span class="hljs-string">'/'</span></span>, methods=[<span class="hljs-string"><span class="hljs-string">'GET'</span></span>]) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hello</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'Hello World!'</span></span> @app.route(<span class="hljs-string"><span class="hljs-string">'/api'</span></span>, methods=[<span class="hljs-string"><span class="hljs-string">'GET'</span></span>, <span class="hljs-string"><span class="hljs-string">'POST'</span></span>]) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">api</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">""" /api entpoint GET - returns json= {'status': 'test'} POST - { name - str not null age - int optional } :return: """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> request.method == <span class="hljs-string"><span class="hljs-string">'GET'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> jsonify({<span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-string"><span class="hljs-string">'test'</span></span>}) <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> request.method == <span class="hljs-string"><span class="hljs-string">'POST'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> validate_post_data(request.json): <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> jsonify({<span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-string"><span class="hljs-string">'OK'</span></span>}) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> jsonify({<span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-string"><span class="hljs-string">'bad input'</span></span>}), <span class="hljs-number"><span class="hljs-number">400</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> app.run(host=<span class="hljs-string"><span class="hljs-string">'0.0.0.0'</span></span>, port=<span class="hljs-number"><span class="hljs-number">8080</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> __name__ == <span class="hljs-string"><span class="hljs-string">'__main__'</span></span>: main()</code> </pre> </div></div><br><p> å’Œä¸€äº›æµ‹è¯•ï¼š </p><br><div class="spoiler">  <b class="spoiler_title">åº”ç”¨æµ‹è¯•æ¸…å•</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> unittest <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> app <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> tested_app <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FlaskAppTests</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(unittest.TestCase)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setUp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> tested_app.app.config[<span class="hljs-string"><span class="hljs-string">'TESTING'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> self.app = tested_app.app.test_client() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_get_hello_endpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> r = self.app.get(<span class="hljs-string"><span class="hljs-string">'/'</span></span>) self.assertEqual(r.data, <span class="hljs-string"><span class="hljs-string">b'Hello World!'</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_post_hello_endpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> r = self.app.post(<span class="hljs-string"><span class="hljs-string">'/'</span></span>) self.assertEqual(r.status_code, <span class="hljs-number"><span class="hljs-number">405</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_get_api_endpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> r = self.app.get(<span class="hljs-string"><span class="hljs-string">'/api'</span></span>) self.assertEqual(r.json, {<span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-string"><span class="hljs-string">'test'</span></span>}) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_correct_post_api_endpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> r = self.app.post(<span class="hljs-string"><span class="hljs-string">'/api'</span></span>, content_type=<span class="hljs-string"><span class="hljs-string">'application/json'</span></span>, data=json.dumps({<span class="hljs-string"><span class="hljs-string">'name'</span></span>: <span class="hljs-string"><span class="hljs-string">'Den'</span></span>, <span class="hljs-string"><span class="hljs-string">'age'</span></span>: <span class="hljs-number"><span class="hljs-number">100</span></span>})) self.assertEqual(r.json, {<span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-string"><span class="hljs-string">'OK'</span></span>}) self.assertEqual(r.status_code, <span class="hljs-number"><span class="hljs-number">200</span></span>) r = self.app.post(<span class="hljs-string"><span class="hljs-string">'/api'</span></span>, content_type=<span class="hljs-string"><span class="hljs-string">'application/json'</span></span>, data=json.dumps({<span class="hljs-string"><span class="hljs-string">'name'</span></span>: <span class="hljs-string"><span class="hljs-string">'Den'</span></span>})) self.assertEqual(r.json, {<span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-string"><span class="hljs-string">'OK'</span></span>}) self.assertEqual(r.status_code, <span class="hljs-number"><span class="hljs-number">200</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_not_dict_post_api_endpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> r = self.app.post(<span class="hljs-string"><span class="hljs-string">'/api'</span></span>, content_type=<span class="hljs-string"><span class="hljs-string">'application/json'</span></span>, data=json.dumps([{<span class="hljs-string"><span class="hljs-string">'name'</span></span>: <span class="hljs-string"><span class="hljs-string">'Den'</span></span>}])) self.assertEqual(r.json, {<span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-string"><span class="hljs-string">'bad input'</span></span>}) self.assertEqual(r.status_code, <span class="hljs-number"><span class="hljs-number">400</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_no_name_post_api_endpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> r = self.app.post(<span class="hljs-string"><span class="hljs-string">'/api'</span></span>, content_type=<span class="hljs-string"><span class="hljs-string">'application/json'</span></span>, data=json.dumps({<span class="hljs-string"><span class="hljs-string">'age'</span></span>: <span class="hljs-number"><span class="hljs-number">100</span></span>})) self.assertEqual(r.json, {<span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-string"><span class="hljs-string">'bad input'</span></span>}) self.assertEqual(r.status_code, <span class="hljs-number"><span class="hljs-number">400</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_bad_age_post_api_endpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> r = self.app.post(<span class="hljs-string"><span class="hljs-string">'/api'</span></span>, content_type=<span class="hljs-string"><span class="hljs-string">'application/json'</span></span>, data=json.dumps({<span class="hljs-string"><span class="hljs-string">'name'</span></span>: <span class="hljs-string"><span class="hljs-string">'Den'</span></span>, <span class="hljs-string"><span class="hljs-string">'age'</span></span>: <span class="hljs-string"><span class="hljs-string">'100'</span></span>})) self.assertEqual(r.json, {<span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-string"><span class="hljs-string">'bad input'</span></span>}) self.assertEqual(r.status_code, <span class="hljs-number"><span class="hljs-number">400</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> __name__ == <span class="hljs-string"><span class="hljs-string">'__main__'</span></span>: unittest.main()</code> </pre> </div></div><br><p> è¦†ç›–èŒƒå›´è¾“å‡ºï¼š </p><br><pre> <code class="plaintext hljs">coverage report Name Stmts Miss Cover ------------------------------------------------------------------ src/app.py 28 2 93% src/tests.py 37 0 100% ------------------------------------------------------------------ TOTAL 65 2 96%</code> </pre> <br><p> ç°åœ¨åˆ›å»ºæˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªåŠ¨ä½œï¼Œå®ƒå°†è¿è¡Œæµ‹è¯•ã€‚ æ ¹æ®æ–‡æ¡£ï¼Œæ‰€æœ‰æ“ä½œåº”å­˜å‚¨åœ¨ä¸€ä¸ªç‰¹æ®Šç›®å½•ä¸­ï¼š </p><br><pre> <code class="bash hljs">$ mkdir -p .github/workflows $ touch .github/workflows/test_on_push.yaml</code> </pre> <br><p> æˆ‘å¸Œæœ›æ­¤æ“ä½œå¯ä»¥åœ¨ä»»ä½•åˆ†æ”¯ä¸­çš„ä»»ä½•pushäº‹ä»¶ä¸Šè¿è¡Œï¼Œä½†å‘è¡Œç‰ˆé™¤å¤–ï¼ˆæ ‡è®°ï¼Œå› ä¸ºä¼šæœ‰å•ç‹¬çš„æµ‹è¯•ï¼‰ï¼š </p><br><pre> <code class="plaintext hljs">on: push: tags: - '!refs/tags/*' branches: - '*'</code> </pre> <br><p> ç„¶åï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªä»»åŠ¡ï¼Œè¯¥ä»»åŠ¡å°†åœ¨æœ€æ–°å¯ç”¨çš„Ubuntuç‰ˆæœ¬ä¸­è¿è¡Œï¼š </p><br><pre> <code class="plaintext hljs">jobs: run_tests: runs-on: [ubuntu-latest]</code> </pre> <br><p> åœ¨æ­¥éª¤ä¸­ï¼Œæˆ‘ä»¬å°†æ£€æŸ¥ä»£ç ï¼Œå®‰è£…pythonï¼Œå®‰è£…ä¾èµ–é¡¹ï¼Œè¿è¡Œæµ‹è¯•å¹¶æ˜¾ç¤ºè¦†ç›–èŒƒå›´ï¼š </p><br><pre> <code class="plaintext hljs">steps: #   - uses: actions/checkout@master #  python   - uses: actions/setup-python@v1 with: python-version: '3.8' architecture: 'x64' - name: Install requirements #   run: pip install -r requirements.txt - name: Run tests run: coverage run src/tests.py - name: Tests report run: coverage report</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">ä¸€èµ·</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">name: Run tests on any Push event #    push    ,    . #      on: push: tags: - '!refs/tags/*' branches: - '*' jobs: run_tests: runs-on: [ubuntu-latest] steps: #   - uses: actions/checkout@master #  python   - uses: actions/setup-python@v1 with: python-version: '3.8' architecture: 'x64' - name: Install requirements #   run: pip install -r requirements.txt - name: Run tests run: coverage run src/tests.py - name: Tests report run: coverage report</code> </pre> </div></div><br><p> è®©æˆ‘ä»¬å°è¯•åˆ›å»ºä¸€ä¸ªæäº¤ï¼Œçœ‹çœ‹æˆ‘ä»¬çš„åŠ¨ä½œå¦‚ä½•å·¥ä½œã€‚ <br><img src="https://habrastorage.org/webt/qy/v7/by/qyv7byybfnvpnkurriqvydsp_xk.png"><br>  <em>é€šè¿‡åŠ¨ä½œç•Œé¢ä¸­çš„æµ‹è¯•</em> </p><br><p> å—¨ï¼Œæˆ‘ä»¬è®¾æ³•åˆ›å»ºäº†ç¬¬ä¸€ä¸ªåŠ¨ä½œå¹¶è¿è¡Œå®ƒï¼ è®©æˆ‘ä»¬å°è¯•ç ´åæŸç§æµ‹è¯•å¹¶æŸ¥çœ‹è¾“å‡ºï¼š <br><img src="https://habrastorage.org/webt/dr/vn/_s/drvn_sgrq-esw6sgxjiylhhy02w.png"><br>  <em>æµ‹è¯•åœ¨åŠ¨ä½œç•Œé¢ä¸­å´©æºƒ</em> </p><br><p> æµ‹è¯•å¤±è´¥ã€‚ æŒ‡ç¤ºç¯å˜æˆçº¢è‰²ï¼Œç”šè‡³åœ¨é‚®ä»¶ä¸­æ”¶åˆ°é€šçŸ¥ã€‚ ä½ éœ€è¦ä»€ä¹ˆï¼ ç›®æ ‡æ–¹æ¡ˆçš„8åˆ†ä¸­æœ‰3åˆ†å¯ä»¥è®¤ä¸ºå·²å®ç°ã€‚ ç°åœ¨ï¼Œè®©æˆ‘ä»¬å°è¯•å¤„ç†dockeræ˜ åƒçš„ç»„è£…ï¼Œå­˜å‚¨ã€‚ </p><br><p>  <strong>æ³¨æ„ï¼</strong>  <strong>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ª<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">docker</a>å¸æˆ·</strong> </p><br><p> é¦–å…ˆï¼Œæˆ‘ä»¬å°†ç¼–å†™ä¸€ä¸ªç®€å•çš„Dockerfileï¼Œåœ¨å…¶ä¸­æ‰§è¡Œæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">Dockeræ–‡ä»¶</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">#     FROM python:3.8-alpine #        /app  COPY ./ /app #    RUN apk update &amp;&amp; pip install -r /app/requirements.txt --no-cache-dir #   (  Distutils) RUN pip install -e /app #      EXPOSE 8080 #       CMD web_server #    distutils      #CMD python /app/src/app.py</code> </pre> </div></div><br><p> è¦å°†å®¹å™¨å‘é€åˆ°é›†çº¿å™¨ï¼Œå¿…é¡»ç™»å½•åˆ°dockerï¼Œä½†æ˜¯ç”±äºæˆ‘ä¸å¸Œæœ›å…¨ä¸–ç•Œå­¦ä¹ è¯¥å¸æˆ·çš„å¯†ç ï¼Œå› æ­¤æˆ‘å°†ä½¿ç”¨GitHubä¸­å†…ç½®çš„ç§˜å¯†ã€‚ é€šå¸¸ï¼Œåªèƒ½å°†å¯†ç è®¾ç½®ä¸ºç§˜å¯†ï¼Œå…¶ä½™å¯†ç å°†ä»¥* .yamlè¿›è¡Œç¡¬ç¼–ç ï¼Œå¹¶ä¸”å¯ä»¥ä½¿ç”¨ã€‚ ä½†æ˜¯æˆ‘æƒ³å¤åˆ¶å¹¶ç²˜è´´æˆ‘çš„æ“ä½œè€Œä¸è¿›è¡Œä»»ä½•æ›´æ”¹ï¼Œå¹¶ä»ç§˜å¯†ä¸­æå–æ‰€æœ‰ç‰¹å®šä¿¡æ¯ã€‚ </p><br><p><img src="https://habrastorage.org/webt/2c/h8/5t/2ch85tdbuovsc7ywejh5gmrmvgw.png"><br>  <em>Githubçš„ç§˜å¯†</em> </p><br><p>  DOCKER_LOGIN-ç™»å½•hub.docker.com <br>  DOCKER_PWD-å¯†ç  <br>  DOCKER_NAME-æ­¤é¡¹ç›®çš„dockerä»“åº“åç§°ï¼ˆå¿…é¡»æå‰åˆ›å»ºï¼‰ </p><br><p> å¥½çš„ï¼Œå‡†å¤‡å·¥ä½œå·²ç»å®Œæˆï¼Œç°åœ¨è®©æˆ‘ä»¬åˆ›å»ºç¬¬äºŒä¸ªåŠ¨ä½œï¼š </p><br><pre> <code class="bash hljs">$ touch .github/workflows/pub_on_release.yaml</code> </pre> <br><p> æˆ‘ä»¬å¤åˆ¶å‰ä¸€ä¸ªåŠ¨ä½œçš„æµ‹è¯•ï¼Œä½†å¯åŠ¨è§¦å‘å™¨é™¤å¤–ï¼ˆæˆ‘æ²¡æœ‰æ‰¾åˆ°å¦‚ä½•å¯¼å…¥åŠ¨ä½œï¼‰ã€‚ æˆ‘ä»¬å°†å…¶æ›¿æ¢ä¸ºâ€œå‘å¸ƒæ—¶å¯åŠ¨â€ï¼š </p><br><pre> <code class="plaintext hljs">on: release: types: [published]</code> </pre> <br><p>  <strong>é‡è¦ï¼</strong>  <strong>åœ¨äº‹ä»¶ä¸Šåšå‡ºæ­£ç¡®çš„æ¡ä»¶éå¸¸é‡è¦ã€‚</strong> <br> ä¾‹å¦‚ï¼Œå¦‚æœon.releaseæ²¡æœ‰æŒ‡å®šç±»å‹ï¼Œåˆ™æ­¤äº‹ä»¶å°†è§¦å‘è‡³å°‘ä¸¤ä¸ªäº‹ä»¶ï¼šå·²å‘å¸ƒå’Œå·²åˆ›å»ºã€‚ å³ï¼Œå°†ç«‹å³å¯åŠ¨2ä¸ªç»„è£…è¿‡ç¨‹ã€‚ </p><br><p> ç°åœ¨ï¼Œåœ¨åŒä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å°†æ ¹æ®ç¬¬ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå¦ä¸€ä¸ªä»»åŠ¡ï¼š </p><br><pre> <code class="plaintext hljs">build_and_pub: needs: [run_tests]</code> </pre> <br><p> éœ€è¦-è¡¨ç¤ºè¯¥ä»»åŠ¡ç›´åˆ°run_testsç»“æŸæ‰å¼€å§‹ </p><br><p>  <strong>é‡è¦ï¼</strong>  <strong>å¦‚æœæ‚¨æœ‰å¤šä¸ªæ“ä½œæ–‡ä»¶ï¼Œå¹¶ä¸”å…¶ä¸­æœ‰å¤šä¸ªä»»åŠ¡ï¼Œé‚£ä¹ˆå®ƒä»¬éƒ½å°†åœ¨ä¸åŒçš„ç¯å¢ƒä¸­åŒæ—¶è¿è¡Œã€‚</strong> ä¸ºæ¯ä¸ªä»»åŠ¡åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„ç¯å¢ƒï¼Œä¸å…¶ä»–ä»»åŠ¡æ— å…³ã€‚ å¦‚æœæ‚¨æ²¡æœ‰æŒ‡å®šéœ€æ±‚ï¼Œé‚£ä¹ˆæµ‹è¯•ä»»åŠ¡å’Œç¨‹åºé›†å°†åŒæ—¶å¹¶å½¼æ­¤ç‹¬ç«‹åœ°å¯åŠ¨ã€‚ </p><br><p> æ·»åŠ ç¯å¢ƒå˜é‡ï¼Œå…¶ä¸­æˆ‘ä»¬çš„ç§˜å¯†å°†æ˜¯ï¼š </p><br><pre> <code class="plaintext hljs">env: LOGIN: ${{ secrets.DOCKER_LOGIN }} NAME: ${{ secrets.DOCKER_NAME }}</code> </pre> <br><p> ç°åœ¨ï¼Œæˆ‘ä»¬çš„ä»»åŠ¡æ­¥éª¤å¿…é¡»åœ¨å…¶ä¸­ç™»å½•åˆ°dockerï¼Œæ”¶é›†å®¹å™¨å¹¶å°†å…¶å‘å¸ƒåœ¨æ³¨å†Œè¡¨ä¸­ï¼š </p><br><pre> <code class="plaintext hljs">steps: - name: Login to docker.io run: echo ${{ secrets.DOCKER_PWD }} | docker login -u ${{ secrets.DOCKER_LOGIN }} --password-stdin - uses: actions/checkout@master - name: Build image run: docker build -t $LOGIN/$NAME:${GITHUB_REF:11} -f Dockerfile . - name: Push image to docker.io run: docker push $LOGIN/$NAME:${GITHUB_REF:11}</code> </pre> <br><p>  $ {GITHUB_REFï¼š11}æ˜¯ä¸€ä¸ªgithubå˜é‡ï¼Œç”¨äºå­˜å‚¨è¡Œï¼Œè¯¥è¡Œå¸¦æœ‰å¯¹è§¦å‘å™¨èµ·ä½œç”¨çš„äº‹ä»¶çš„å¼•ç”¨ï¼ˆåˆ†æ”¯åç§°ï¼Œæ ‡ç­¾ç­‰ï¼‰ï¼Œå¦‚æœæˆ‘ä»¬æœ‰æ ¼å¼ä¸ºâ€œ v0.0.0â€çš„æ ‡ç­¾ï¼Œåˆ™éœ€è¦ä¿®å‰ªå‰11ä¸ªå­—ç¬¦ï¼Œåˆ™ä¿ç•™â€œ 0.0.0â€ã€‚ </p><br><p> æ¨é€ä»£ç å¹¶åˆ›å»ºä¸€ä¸ªæ–°æ ‡ç­¾ã€‚ è€Œä¸”æˆ‘ä»¬çœ‹åˆ°æˆ‘ä»¬çš„å®¹å™¨å·²æˆåŠŸç»„è£…å¹¶å‘é€åˆ°æ³¨å†Œè¡¨ï¼Œå¹¶ä¸”æˆ‘ä»¬æ²¡æœ‰åœ¨ä»»ä½•åœ°æ–¹æ‰“å¼€å¯†ç ã€‚ </p><br><p><img src="https://habrastorage.org/webt/mg/yt/i-/mgyti-mww_fcqsmbiqk6zli7swo.png"><br>  <em>åœ¨Actionsç•Œé¢ä¸­æ„å»ºå’Œè¿é€å®¹å™¨</em> </p><br><p> æ£€æŸ¥é›†çº¿å™¨ï¼š </p><br><p><img src="https://habrastorage.org/webt/ut/nw/vd/utnwvdtcprbqfpavnnirqmqim0s.png"><br>  <em>å®¹å™¨å­˜å‚¨åœ¨Docker Hubä¸­</em> </p><br><p> ä¸€åˆ‡æ­£å¸¸ï¼Œä½†æ˜¯æœ€å›°éš¾çš„ä»»åŠ¡ä»ç„¶æ˜¯-éƒ¨ç½²ã€‚ åœ¨è¿™é‡Œï¼Œæ‚¨å°†å·²ç»éœ€è¦ä¸€ä¸ªVPSå’Œä¸€ä¸ªç™½è‰²IPåœ°å€ï¼Œæˆ‘ä»¬å°†åœ¨å…¶ä¸­éƒ¨ç½²å®¹å™¨å¹¶åœ¨å…¶ä¸­å‘é€æŒ‚æ¥ã€‚ ä»ç†è®ºä¸Šè®²ï¼Œæ‚¨å¯ä»¥åœ¨VPSæˆ–å®¶åº­æœåŠ¡å™¨çš„ä¾§é¢è¿è¡Œè„šæœ¬ï¼Œå¦‚æœå‡ºç°æ–°å›¾åƒï¼Œåˆ™å¯ä»¥è§¦å‘è¯¥è„šæœ¬ï¼Œæˆ–è€…ä»¥æŸç§æ–¹å¼ä¸ç”µæŠ¥æœºå™¨äººä¸€èµ·ç©ã€‚ å½“ç„¶ï¼Œæœ‰å¾ˆå¤šæ–¹æ³•å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ã€‚ ä½†æ˜¯æˆ‘å°†ä½¿ç”¨å¤–éƒ¨IPã€‚ ä¸ºäº†ä¸å˜å¾—èªæ˜ï¼Œæˆ‘ç”¨ç®€å•çš„APIåœ¨Flaskä¸­ç¼–å†™äº†ä¸€ä¸ªå°å‹WebæœåŠ¡ã€‚ <br> ç®€è€Œè¨€ä¹‹ï¼Œæœ‰1ä¸ªç«¯ç‚¹â€œ /â€ã€‚ <br>  GETè¯·æ±‚è¿”å›JSONä»¥åŠä¸»æœºä¸Šçš„æ‰€æœ‰æ´»åŠ¨å®¹å™¨ã€‚ <br>  POST-æ¥æ”¶ä»¥ä¸‹æ ¼å¼çš„æ•°æ®ï¼š </p><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"owner"</span></span>: <span class="hljs-string"><span class="hljs-string">"  "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"repository"</span></span>: <span class="hljs-string"><span class="hljs-string">"  "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tag"</span></span>: <span class="hljs-string"><span class="hljs-string">"v0.0.1"</span></span>, #    <span class="hljs-attr"><span class="hljs-attr">"ports"</span></span>: {<span class="hljs-attr"><span class="hljs-attr">"8080"</span></span>: <span class="hljs-number"><span class="hljs-number">8080</span></span>, â€œ443â€: <span class="hljs-number"><span class="hljs-number">443</span></span>} #      }</code> </pre> <br><p> åœ¨ä¸»æœºä¸Šä¼šå‘ç”Ÿä»€ä¹ˆï¼š </p><br><ol><li> ä»æ”¶åˆ°çš„jsonä¸­æ”¶é›†æ–°å›¾åƒçš„åç§° </li><li> ä¸€ä¸ªæ–°çš„å›¾åƒæ­£åœ¨è†¨èƒ€ </li><li> å¦‚æœå›¾åƒå·²ä¸‹è½½ï¼Œåˆ™å½“å‰å®¹å™¨å°†åœæ­¢å¹¶åˆ é™¤ </li><li> å¯åŠ¨ä¸€ä¸ªæ–°å®¹å™¨ï¼Œå¹¶å‘å¸ƒç«¯å£ï¼ˆ-pæ ‡å¿—ï¼‰ </li></ol><br><p> ä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">docker-py</a>åº“å®Œæˆä¸dockerçš„æ‰€æœ‰å·¥ä½œ </p><br><p> åœ¨æ²¡æœ‰ä»»ä½•æœ€å°ä¿æŠ¤çš„æƒ…å†µä¸‹åœ¨Internetä¸Šå‘å¸ƒè¿™æ ·çš„æœåŠ¡æ˜¯éå¸¸é”™è¯¯çš„ï¼Œæˆ‘åšäº†ä¸€ä¸ªç±»ä¼¼çš„API KEYï¼Œè¯¥æœåŠ¡ä»ç¯å¢ƒå˜é‡ä¸­è¯»å–ä»¤ç‰Œï¼Œç„¶åå°†å…¶ä¸æ ‡å¤´{Authorizationï¼šCI_TOKEN}è¿›è¡Œæ¯”è¾ƒ </p><br><div class="spoiler">  <b class="spoiler_title">ç”¨äºéƒ¨ç½²çš„WebæœåŠ¡å™¨åˆ—è¡¨</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># coding=utf-8 import os import sys import logging import logging.config import logging.handlers from flask import Flask from flask import request, jsonify import docker log = logging.getLogger(__name__) app = Flask(__name__) docker_client = docker.from_env() MY_AUTH_TOKEN = os.getenv('CI_TOKEN', None) #       def init_logging(): """   :return: """ log_format = f"[%(asctime)s] [ CI/CD server ] [%(levelname)s]:%(name)s:%(message)s" formatters = {'basic': {'format': log_format}} handlers = {'stdout': {'class': 'logging.StreamHandler', 'formatter': 'basic'}} level = 'INFO' handlers_names = ['stdout'] loggers = { '': { 'level': level, 'propagate': False, 'handlers': handlers_names }, } logging.basicConfig(level='INFO', format=log_format) log_config = { 'version': 1, 'disable_existing_loggers': False, 'formatters': formatters, 'handlers': handlers, 'loggers': loggers } logging.config.dictConfig(log_config) def get_active_containers(): """     :return: """ containers = docker_client.containers.list() result = [] for container in containers: result.append({ 'short_id': container.short_id, 'container_name': container.name, 'image_name': container.image.tags, 'created': container.attrs['Created'], 'status': container.status, 'ports': container.ports, }) return result def get_container_name(item: dict) -&gt; [str, str]: """   image  POST  :param item: :return: """ if not isinstance(item, dict): return '' owner = item.get('owner') repository = item.get('repository') tag = item.get('tag', 'latest').replace('v', '') if owner and repository and tag: return f'{owner}/{repository}:{tag}', repository if repository and tag: return f'{repository}:{tag}', repository return '', '' def kill_old_container(container_name: str) -&gt; bool: """    ,   :param container_name: :return: """ try: #    container = docker_client.containers.get(container_name) #  container.kill() except Exception as e: #       log.warning(f'Error while delete container {container_name}, {e}') return False finally: #   ,     log.debug(docker_client.containers.prune()) log.info(f'Container deleted. container_name = {container_name}') return True def deploy_new_container(image_name: str, container_name: str, ports: dict = None): try: #   image  docker hub'a log.info(f'pull {image_name}, name={container_name}') docker_client.images.pull(image_name) log.debug('Success') kill_old_container(container_name) log.debug('Old killed') #    docker_client.containers.run(image=image_name, name=container_name, detach=True, ports=ports) except Exception as e: log.error(f'Error while deploy container {container_name}, \n{e}') return {'status': False, 'error': str(e)}, 400 log.info(f'Container deployed. container_name = {container_name}') return {'status': True}, 200 @app.route('/', methods=['GET', 'POST']) def MainHandler(): """ GET -      POST -      : { "owner": "gonfff", "repository": "ci_example", "tag": "v0.0.1", "ports": {"8080": 8080} } :return: """ if request.headers.get('Authorization') != MY_AUTH_TOKEN: return jsonify({'message': 'Bad token'}), 401 if request.method == 'GET': return jsonify(get_active_containers()) elif request.method == 'POST': log.debug(f'Recieved {request.data}') image_name, container_name = get_container_name(request.json) ports = request.json.get('ports') if request.json.get('ports') else None result, status = deploy_new_container(image_name, container_name, ports) return jsonify(result), status def main(): init_logging() if not MY_AUTH_TOKEN: log.error('There is no auth token in env') sys.exit(1) app.run(host='0.0.0.0', port=5000) if __name__ == '__main__': main()</span></span></code> </pre> </div></div><br><p> å¯¹äºæ­¤åº”ç”¨ç¨‹åºï¼Œæˆ‘è¿˜åšäº†setup.pyä»¥ä¾¿å°†å…¶å®‰è£…åœ¨ç³»ç»Ÿä¸Šã€‚ æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•å®‰è£…å®ƒï¼š </p><br><pre> <code class="bash hljs">$ python3 setup.sy install</code> </pre> <br><p> å‰ææ˜¯æ‚¨å·²ä¸‹è½½æ–‡ä»¶å¹¶ä¸”ä½äºæ­¤åº”ç”¨ç¨‹åºçš„ç›®å½•ä¸­ã€‚ <br> å®‰è£…åï¼Œå¿…é¡»å°†åº”ç”¨ç¨‹åºä½œä¸ºæœåŠ¡å¯ç”¨ï¼Œä»¥ä¾¿åœ¨æœåŠ¡å™¨é‡æ–°å¯åŠ¨æ—¶å¯åŠ¨è¯¥åº”ç”¨ç¨‹åºï¼Œä¸ºæ­¤ï¼Œæˆ‘ä»¬ä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">systemd</a> <br> è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹é…ç½®æ–‡ä»¶ï¼š </p><br><pre> <code class="plaintext hljs">[Unit] Description=Deployment web server After=network-online.target [Service] Type=simple RestartSec=3 ExecStart=/usr/local/bin/ci_example Environment=CI_TOKEN=#&lt;I generate it with $(openssl rand -hex 20)&gt; [Install] WantedBy=multi-user.target</code> </pre><br><p> åªèƒ½è¿è¡Œå®ƒï¼š </p><br><pre> <code class="bash hljs">$ sudo systemctl daemon-reload $ sudo systemctl <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> ci_example.service $ sudo systemctl start ci_example.service</code> </pre> <br><p> æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹Web DeliveryæœåŠ¡å™¨çš„æ—¥å¿— </p><br><pre> <code class="bash hljs">$ sudo systemctl status ci_example.service</code> </pre> <br><p> æœåŠ¡å™¨éƒ¨åˆ†å·²å‡†å¤‡å°±ç»ªï¼Œä»…éœ€ä¸ºæˆ‘ä»¬çš„æ“ä½œæ·»åŠ ä¸€ä¸ªé’©å­å³å¯ã€‚ ä¸ºæ­¤ï¼Œè¯·æ·»åŠ æœåŠ¡å™¨IPåœ°å€çš„æœºå¯†å’Œå®‰è£…åº”ç”¨ç¨‹åºæ—¶ç”Ÿæˆçš„CI_TOKENã€‚ <br> èµ·åˆï¼Œæˆ‘æƒ³å¯¹githubå¸‚åœºä½¿ç”¨å·æ›²çš„ç°æˆåŠ¨ä½œï¼Œä½†æ˜¯ä¸å¹¸çš„æ˜¯ï¼Œå®ƒä»POSTè¯·æ±‚çš„ä¸»ä½“ä¸­åˆ é™¤äº†å¼•å·ï¼Œè¿™ä½¿å¾—æ— æ³•è§£æjsonã€‚ è¿™æ˜¾ç„¶ä¸é€‚åˆæˆ‘ï¼Œå› æ­¤æˆ‘å†³å®šåœ¨ubuntuä¸­ä½¿ç”¨å†…ç½®çš„curlï¼ˆæˆ‘åœ¨ä¸Šé¢æ”¶é›†å®¹å™¨ï¼‰ï¼Œè¿™å¯¹æ€§èƒ½äº§ç”Ÿç§¯æå½±å“ï¼Œå› ä¸ºå®ƒä¸éœ€è¦ç»„è£…å…¶ä»–å®¹å™¨ï¼š </p><br><pre> <code class="plaintext hljs">deploy: needs: [build_and_pub] runs-on: [ubuntu-latest] steps: - name: Set tag to env run: echo ::set-env name=TAG::$(echo ${GITHUB_REF:11}) - name: Send webhook for deploy run: "curl --silent --show-error --fail -X POST ${{ secrets.DEPLOYMENT_SERVER }} -H 'Authorization: ${{ secrets.DEPLOYMENT_TOKEN }}' -H 'Content-Type: application/json' -d '{\"owner\": \"${{ secrets.DOCKER_LOGIN }}\", \"repository\": \"${{ secrets.DOCKER_NAME }}\", \"tag\": \"${{ env.TAG }}\", \"ports\": {\"8080\": 8080}}'"</code> </pre><br><p>  <strong>æ³¨æ„ï¼šæŒ‡å®š--failå¼€å…³éå¸¸é‡è¦ï¼Œå¦åˆ™ï¼Œå³ä½¿æ”¶åˆ°å“åº”é”™è¯¯ï¼Œä»»ä½•è¯·æ±‚éƒ½å°†æˆåŠŸã€‚</strong> <br> è¿˜å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¯·æ±‚ä¸­ä½¿ç”¨çš„å˜é‡ä¸æ˜¯çœŸæ­£çš„å˜é‡ï¼Œè€Œæ˜¯GITHUB_REFä¾‹å¤–è°ƒç”¨çš„ç‰¹æ®Šå‡½æ•°ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘å¾ˆé•¿ä¸€æ®µæ—¶é—´æ— æ³•ç†è§£ä¸ºä»€ä¹ˆè¯·æ±‚æ— æ³•æ­£å¸¸å·¥ä½œçš„åŸå› ã€‚ ä½†æ˜¯ï¼Œé€šè¿‡å‘æŒ¥ä½œç”¨ï¼Œä¸€åˆ‡éƒ½å®Œæˆäº†ã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">è¡ŒåŠ¨å»ºç«‹å¹¶éƒ¨ç½²</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">name: Publish on Docker Hub and Deploy on: release: types: [published] #       jobs: run_tests: #          runs-on: [ubuntu-latest] steps: #   - uses: actions/checkout@master #  python   - uses: actions/setup-python@v1 with: python-version: '3.8' architecture: 'x64' - name: Install requirements #   run: pip install -r requirements.txt - name: Run tests #   run: coverage run src/tests.py - name: Tests report run: coverage report build_and_pub: #      needs: [run_tests] runs-on: [ubuntu-latest] env: LOGIN: ${{ secrets.DOCKER_LOGIN }} NAME: ${{ secrets.DOCKER_NAME }} steps: - name: Login to docker.io #     docker.io run: echo ${{ secrets.DOCKER_PWD }} | docker login -u ${{ secrets.DOCKER_LOGIN }} --password-stdin #   - uses: actions/checkout@master - name: Build image #  image        hub.docker .. login/repository:version run: docker build -t $LOGIN/$NAME:${GITHUB_REF:11} -f Dockerfile . - name: Push image to docker.io #    registry run: docker push $LOGIN/$NAME:${GITHUB_REF:11} deploy: #         registry,      #    curl   needs: [build_and_pub] runs-on: [ubuntu-latest] steps: - name: Set tag to env run: echo ::set-env name=RELEASE_VERSION::$(echo ${GITHUB_REF:11}) - name: Send webhook for deploy run: "curl --silent --show-error --fail -X POST ${{ secrets.DEPLOYMENT_SERVER }} -H 'Authorization: ${{ secrets.DEPLOYMENT_TOKEN }}' -H 'Content-Type: application/json' -d '{\"owner\": \"${{ secrets.DOCKER_LOGIN }}\", \"repository\": \"${{ secrets.DOCKER_NAME }}\", \"tag\": \"${{ env.RELEASE_VERSION }}\", \"ports\": {\"8080\": 8080}}'"</code> </pre> </div></div><br><p> å¥½çš„ï¼Œæˆ‘ä»¬å°†æ‰€æœ‰å†…å®¹æ”¾åœ¨ä¸€èµ·ï¼Œç°åœ¨æˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªæ–°ç‰ˆæœ¬å¹¶æŸ¥çœ‹æ“ä½œã€‚ <br><img src="https://habrastorage.org/webt/07/dn/5q/07dn5qrqodyyfaulm6gpey7w8my.png"><br>  <em>Webhookéƒ¨ç½²åº”ç”¨ç¨‹åºæ“ä½œç•Œé¢</em> </p><br><p> äº‹å®è¯æ˜ï¼Œæˆ‘ä»¬å‘éƒ¨ç½²æœåŠ¡å‘å‡ºGETè¯·æ±‚ï¼ˆæ˜¾ç¤ºä¸»æœºä¸Šçš„æ‰€æœ‰æ´»åŠ¨å®¹å™¨ï¼‰ï¼š <br><img src="https://habrastorage.org/webt/gq/1w/yg/gq1wygbewjefugj8itjchn2ucki.png"><br>  <em>éƒ¨ç½²åœ¨VPSå®¹å™¨ä¸Š</em> </p><br><p> ç°åœ¨ï¼Œæˆ‘ä»¬å°†è¯·æ±‚å‘é€åˆ°å·²éƒ¨ç½²çš„åº”ç”¨ç¨‹åºï¼š <br><img src="https://habrastorage.org/webt/hs/9x/hz/hs9xhzawrwliyoptcccjd-48bco.png"><br>  <em>GETè¯·æ±‚åˆ°å·²éƒ¨ç½²çš„å®¹å™¨</em> </p><br><img src="https://habrastorage.org/webt/jf/fy/xc/jffyxcdf8zyzfylylyufv8wlcp0.png" alt="å¯¹å·²éƒ¨ç½²å®¹å™¨çš„POSTè¯·æ±‚"><br><p>  <em>å¯¹å·²éƒ¨ç½²å®¹å™¨çš„POSTè¯·æ±‚</em> </p><br><p>  <strong>ç»“è®º</strong> <br>  GitHub Actionsæ˜¯ä¸€ä¸ªéå¸¸æ–¹ä¾¿ä¸”çµæ´»çš„å·¥å…·ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å®ƒæ¥åšå¾ˆå¤šäº‹æƒ…ï¼Œä»è€Œå¤§å¤§ç®€åŒ–æ‚¨çš„ç”Ÿæ´»ã€‚ è¿™ä¸€åˆ‡éƒ½å–å†³äºæƒ³è±¡åŠ›ã€‚ <br> ä»–ä»¬æ”¯æŒä¸æœåŠ¡çš„é›†æˆæµ‹è¯•ã€‚ <br> ä½œä¸ºè¯¥é¡¹ç›®çš„é€»è¾‘ç»§ç»­ï¼Œæ‚¨å¯ä»¥å‘webhookæ·»åŠ ä¼ é€’è‡ªå®šä¹‰å‚æ•°ä»¥å¯åŠ¨å®¹å™¨çš„åŠŸèƒ½ã€‚ <br> å°†æ¥ï¼Œå½“æˆ‘ç ”ç©¶å’Œè¯•éªŒk8sæ—¶ï¼Œæˆ‘å°†å°è¯•ä»¥è¯¥é¡¹ç›®ä¸ºåŸºç¡€æ¥éƒ¨ç½²å¤´ç›”å›¾ </p><br><p> å¦‚æœæ‚¨æœ‰æŸç§å®¶åº­é¡¹ç›®ï¼Œé‚£ä¹ˆGitHub Actionså¯ä»¥å¤§å¤§ç®€åŒ–ä½¿ç”¨å­˜å‚¨åº“çš„è¿‡ç¨‹ã€‚ </p><br><p> è¯­æ³•è¯¦ç»†ä¿¡æ¯å¯ä»¥åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è¿™é‡Œ</a>æ‰¾åˆ°<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ã€‚</a> <br> æ‰€æœ‰<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">é¡¹ç›®</a>æ¥æº </p><cut text=" "></cut></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN476368/">https://habr.com/ru/post/zh-CN476368/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN476348/index.html">å·ç«‹å¤§å­¦çš„åŒ–å­¦å®¶å¦‚ä½•å°†ITåŸç†å¼•å…¥ä»–ä»¬çš„å·¥ä½œå¹¶æˆä¸ºå›¢é˜Ÿè´Ÿè´£äºº</a></li>
<li><a href="../zh-CN476352/index.html">ç°åœºæœåŠ¡ç®¡ç†å’Œç°åœºæœåŠ¡ã€‚ ä¿„ç½—æ–¯æ˜¯å¦è¾¾åˆ°äº†ç®¡ç†ç°åœºæœåŠ¡å·¥ç¨‹å¸ˆçš„åœ°æ­¥ï¼Ÿ</a></li>
<li><a href="../zh-CN476354/index.html">èŠ‚çœå¯åŠ¨èµ„æºçš„ä¸‰ä¸ªå®ç”¨æ­¥éª¤</a></li>
<li><a href="../zh-CN476358/index.html">å¾®æœåŠ¡çš„æœåŠ¡ç½‘æ ¼ã€‚ ç¬¬ä¸€éƒ¨åˆ†</a></li>
<li><a href="../zh-CN476366/index.html">å±‹é¡¶ç ´äº†ï¼šå¦‚ä½•ç†è§£æ²»ç–—å¸ˆçš„æ—¶æœºä»¥åŠå¦‚ä½•æ‰¾åˆ°ä»–</a></li>
<li><a href="../zh-CN476370/index.html">JetBrainså®˜æ–¹ç½‘ç«™ç°å·²æä¾›ä¿„æ–‡ç‰ˆ</a></li>
<li><a href="../zh-CN476372/index.html">èŒƒç•´è®ºå…è®¸æ•°å­¦æ”¾å¼ƒå¹³ç­‰</a></li>
<li><a href="../zh-CN476374/index.html">è±ç‰¹å…„å¼Ÿï¼šç¬¬ä¸€ä¸ªä¸“åˆ©å·¨é­”</a></li>
<li><a href="../zh-CN476378/index.html">æ¢å¤ï¼ŒCUDA-è‹±ç‰¹å°”å®£å¸ƒæ¨å‡ºç”¨äºæ•°æ®ä¸­å¿ƒçš„7çº³ç±³GPU</a></li>
<li><a href="../zh-CN476380/index.html">åŠ å¯†è´§å¸äº¤æ˜“-å¦‚ä½•åˆ¶å®šå¯æŒç»­å‘å±•ç­–ç•¥</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>