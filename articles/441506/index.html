<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèº‚ÄçüöÄ üëáüèº ‚òÇÔ∏è Protocolo de transmisi√≥n de paquetes para microcontroladores PSP1N üÜñ üë©üèø‚Äçüç≥ ‚ûñ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Declaraci√≥n del problema. 


 Al desarrollar otro dispositivo en un microcontrolador, me encontr√© con una situaci√≥n en la que se requer√≠a el registro ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Protocolo de transmisi√≥n de paquetes para microcontroladores PSP1N</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/441506/"><h3 id="postanovka-zadachi">  Declaraci√≥n del problema. </h3><br><p>  Al desarrollar otro dispositivo en un microcontrolador, me encontr√© con una situaci√≥n en la que se requer√≠a el registro continuo de una gran cantidad de datos.  El dispositivo tuvo que guardar un conjunto de datos que consta de una marca de tiempo y seis mediciones de ADC de 100 veces por segundo en una tarjeta SD (llamemos a este conjunto de datos un paquete), y luego analizar estos datos en una computadora en forma de gr√°ficos.  Tambi√©n era necesario en paralelo con la escritura de datos en una tarjeta SD, transfiri√©ndolos a trav√©s de UART.  Estos datos deber√≠an haber ocupado el menor espacio posible, ya que hay muchos datos.  Al mismo tiempo, era necesario separar de alguna manera estos paquetes, ya que los datos se transmit√≠an de forma continua.  No busqu√© nada bueno en Internet, no lo encontr√©, as√≠ que decid√≠ crear mi propio protocolo y bibliotecas para √©l. </p><br><h3 id="i-tut-poyavilsya-on--packet-streaming-protocol-psp1n">  Y luego apareci√≥: protocolo de transmisi√≥n de paquetes (PSP1N) </h3><br><p>  Como resultado de algunas consideraciones, se decidi√≥ lo siguiente: en el protocolo, los datos se transmitir√°n en paquetes que consisten en N bytes, donde el primer bit de cada byte se asigna al signo de bit de inicio para la sincronizaci√≥n del paquete (de ah√≠ el nombre del protocolo), los siete bits restantes se asignan a los datos.  La secuencia y el tama√±o de los datos se conocen de antemano. </p><a name="habracut"></a><br><p>  <strong><em>Un ejemplo:</em></strong> </p><br><p>  Asignamos 32 bits para la marca de tiempo, 60 bits para las mediciones ADC (6 canales de 10 bits), con un total de 92 bits.  Como puede transferir 7 bits de datos √∫tiles en un byte, el paquete constar√° de 14 bytes (92 bits / 7 bits = 13.14 ... redondeado a 14).  Hay 112 bits de informaci√≥n en 14 bytes, de los cuales 14 bits est√°n ocupados por el atributo de bit de inicio de 92 bits de datos √∫tiles, hay 6 bits no utilizados (en los que podemos escribir m√°s informaci√≥n, pero por simplicidad no los usaremos). </p><br><p><img src="https://habrastorage.org/webt/ze/mf/lf/zemflfgwrxlos_oeqmzl8n08w88.gif"></p><br><p>  Donde el s√©ptimo bit es un signo del bit de inicio (indica el comienzo del paquete), 6,5,4,3,2,1,0 son bits de datos. </p><br><p>  El lado receptor tambi√©n sabe que recibe un paquete de 14 bytes en el que el primer bit del primer byte es el bit de inicio (1) (en los bytes restantes, los bits de inicio son 0), luego en los bits de datos en orden hay 32 bits de la marca de tiempo, luego 10 bits de la medici√≥n de ADC No. 1, luego 10 bits de ADC # 2 y as√≠ sucesivamente ... </p><br><p>  Del mismo modo, tiene lugar la escritura en la tarjeta SD y la lectura de acuerdo con el protocolo.  En total, para un d√≠a de grabaci√≥n en una tarjeta SD, obtenemos 115.4 MB de informaci√≥n (14 bytes x 100 mediciones por segundo x 3600 segundos x 24 horas). </p><br><p>  Tal estructura de datos sigue siendo conveniente porque en el futuro podemos seleccionar bloques de datos desde cualquier parte del archivo y mostrarlos en forma de gr√°ficos, sin cargar el archivo completo en la RAM (que puede alcanzar varias decenas de gigabytes).  Y tambi√©n podemos implementar un desplazamiento conveniente de estos gr√°ficos cargando los paquetes necesarios. </p><br><p><img src="https://habrastorage.org/webt/dy/wi/_a/dywi_a67ztu05h5o-bpnetlfmge.gif"></p><br><h4 id="pora-pristupit-k-programmnoy-realizacii-dlya-mikrokontrollera">  Es hora de comenzar la implementaci√≥n de software para el microcontrolador </h4><br><p>  Escribimos la biblioteca para el microcontrolador en C ++. </p><br><p>  Por conveniencia, cree una clase: </p><br><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PSP</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-comment"><span class="hljs-comment">/*   init: startBit -   0  1 *arrayByte -      sizeArrayByte -     */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(byte startBit, byte* arrayByte, byte sizeArrayByte)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/*      pushData: sizeBit -     value -   (       ) */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pushData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(byte sizeBit, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> value)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/*       popData: return     . */</span></span> <span class="hljs-function"><span class="hljs-function">byte* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">popData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span>: byte startBit; <span class="hljs-comment"><span class="hljs-comment">//  byte* arrayByte; //   byte sizeArrayByte; //   byte position = 0; //    bool clearFlag = false; //   void setStartBit(byte &amp;value); //     void clearStartBit(byte &amp;value); //     };</span></span></code> </pre> <br><p>  Con el m√©todo de inicializaci√≥n, creo que todo est√° claro: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> PSP::init(byte startBit, byte* arrayByte, byte sizeArrayByte) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;startBit = startBit; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;arrayByte = arrayByte; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;sizeArrayByte = sizeArrayByte; }</code> </pre> <br><p>  El m√©todo de agregar datos es m√°s complicado, aqu√≠, mediante astutas manipulaciones bit a bit, colocamos los datos en nuestra matriz de bytes. </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> PSP::pushData(byte sizeBit, <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> value) { byte <span class="hljs-built_in"><span class="hljs-built_in">free</span></span>; byte y; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> remBit = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">//      //   ,     if (!clearFlag) { for (byte i = 0; i &lt; sizeArrayByte; i++) { arrayByte[i] = 0; } clearFlag = true; } //        7      while (remBit &gt; -1) { free = 7 - (position) % 7; //        y = (position) / 7; //     //       remBit = sizeBit - free; //      if (remBit &lt; 0) { arrayByte[y] |= value &lt;&lt; ~remBit + 1; //   ,    position += sizeBit; //        remBit = -1; //      } //      else if (remBit &gt; 0) { arrayByte[y] |= value &gt;&gt; remBit; //     ,    position += sizeBit - remBit; sizeBit = remBit; //        } //         else if (remBit == 0) { arrayByte[y] |= value; //    position += sizeBit; remBit = -1; //      } clearStartBit(arrayByte[y]); //   } setStartBit(arrayByte[0]); //   }</span></span></code> </pre> <br><p>  M√©todo para obtener una matriz de bytes de un paquete: </p><br><pre> <code class="cpp hljs">byte* PSP::popData() { position = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">//   clearFlag = false; //    return arrayByte; //   }</span></span></code> </pre> <br><p>  Y finalmente, un par de funciones auxiliares: </p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//      void PSP::setStartBit(byte &amp;value) { if (startBit == 0) value &amp;= ~(1 &lt;&lt; 7); else value |= 1 &lt;&lt; 7; } //      void PSP::clearStartBit(byte &amp;value) { if (startBit == 1) value &amp;= ~(1 &lt;&lt; 7); else value |= 1 &lt;&lt; 7; }</span></span></code> </pre> <br><h3 id="podvedem-itogi">  Para resumir </h3><br><p>  Como resultado del trabajo realizado, el protocolo compacto para la transmisi√≥n de datos PSP1N y las bibliotecas listas para usar que se pueden descargar desde <a href="">GitHub aqu√≠</a> "nacieron".  En este repositorio encontrar√°: </p><br><blockquote><ol><li>  Ejemplo de uso de la biblioteca ColsolePSP1N / C # </li><li>  PSP1N_CPP / contiene la biblioteca PSP para trabajar con el protocolo y un ejemplo de su uso en Arduino </li><li>  PSP1N_CSHARP / biblioteca de protocolos para .NET </li></ol><br></blockquote><p>  Para demostrar el funcionamiento del protocolo, puede actualizar el boceto en Arduino y, en el ejemplo ExampleSerialPortRead de la computadora, recibir datos del microcontrolador a trav√©s del puerto COM.  All√≠, estos datos se descifran y se muestran en una aplicaci√≥n de consola.  Hablar√© sobre la biblioteca escrita en C # para el lado receptor en otra ocasi√≥n. </p><br><p>  <em>TestingConsole:</em> </p><br><p><img src="https://habrastorage.org/webt/td/eo/mt/tdeomt1j388ttvmrfcb25s9lcnm.gif"></p><br><blockquote>  ACTUALIZACI√ìN (31/03/19): Se modific√≥ el algoritmo de codificaci√≥n y decodificaci√≥n. </blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/441506/">https://habr.com/ru/post/441506/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../441490/index.html">Qu√© buscar al elegir un lector: sistemas operativos y hardware</a></li>
<li><a href="../441496/index.html">Sonido en el cable: la historia del tel√©grafo</a></li>
<li><a href="../441498/index.html">Kuril en l√≠nea</a></li>
<li><a href="../441500/index.html">Antepasados ‚Äã‚Äãde helic√≥pteros. La verdadera causa del descontento entre los adolescentes brit√°nicos.</a></li>
<li><a href="../441502/index.html">¬øPor qu√© la aplicaci√≥n de control remoto necesita saber mi ubicaci√≥n?</a></li>
<li><a href="../441508/index.html">Habraiting 2017: los mejores materiales para 2017</a></li>
<li><a href="../441510/index.html">Stonehenge Los secretos de los megalitos.</a></li>
<li><a href="../441514/index.html">C√≥mo "dividir" el ADC correctamente</a></li>
<li><a href="../441516/index.html">Fractales en n√∫meros irracionales</a></li>
<li><a href="../441518/index.html">Lo que da un enfoque cient√≠fico a las cuestiones √©ticas: el c√≥digo fuente de la correcci√≥n pol√≠tica</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>