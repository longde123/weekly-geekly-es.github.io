<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèá ü§±üèæ üë®üèΩ‚Äç‚öñÔ∏è Tel√©fono SIP en STM32F7-Discovery üçÆ ü§Ωüèæ ‚òùÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hola a todos 

 Hace alg√∫n tiempo, escribimos sobre c√≥mo logramos lanzar un tel√©fono SIP en el STM32F4-Discovery con 1 MB de ROM y 192 KB de RAM) basa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Tel√©fono SIP en STM32F7-Discovery</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/embox/blog/431134/">  Hola a todos <br><br>  Hace alg√∫n tiempo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">escribimos</a> sobre c√≥mo logramos lanzar un tel√©fono SIP en el STM32F4-Discovery con 1 MB de ROM y 192 KB de RAM) basado en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Embox</a> .  Aqu√≠ hay que decir que esa versi√≥n era m√≠nima y conectaba dos tel√©fonos directamente sin un servidor y con transmisi√≥n de voz solo en una direcci√≥n.  Por lo tanto, decidimos lanzar un tel√©fono m√°s completo con una llamada a trav√©s del servidor, transmisi√≥n de voz en ambas direcciones, pero al mismo tiempo mantener el tama√±o de memoria m√°s peque√±o posible. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/W6wuEIZJf8o" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><a name="habracut"></a><br>  Para el tel√©fono, se decidi√≥ elegir la aplicaci√≥n <i>simple_pjsua</i> como parte de la biblioteca PJSIP.  Esta es una aplicaci√≥n m√≠nima que puede registrarse en el servidor, recibir y responder llamadas.  A continuaci√≥n, dar√© inmediatamente una descripci√≥n de c√≥mo ejecutar esto en el STM32F7-Discovery. <br><br><h3>  Como correr </h3><br><ol><li>  Configurar Embox <pre><code class="bash hljs">make confload-platform/pjsip/stm32f7cube</code> </pre> </li><li>  En el archivo conf / mods.config, configure la cuenta SIP deseada. <br><br><pre> <code class="bash hljs">include platform.pjsip.cmd.simple_pjsua_imported( sip_domain=<span class="hljs-string"><span class="hljs-string">"server"</span></span>, sip_user=<span class="hljs-string"><span class="hljs-string">"username"</span></span>, sip_passwd=<span class="hljs-string"><span class="hljs-string">"password"</span></span>)</code> </pre><br>  donde <i>servidor</i> es el servidor SIP (por ejemplo, sip.linphone.org), <i>nombre de usuario</i> y <i>contrase√±a</i> son el nombre de usuario y la contrase√±a de la cuenta. <br></li><li>  Construye Embox con el comando <i>make</i> .  Sobre el firmware de la placa que tenemos en la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">wiki</a> y en el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">art√≠culo</a> . <br></li><li>  Ejecute el comando "simple_pjsua_imported" en la consola de Embox <br><br><pre> <code class="bash hljs">00:00:12.870 pjsua_acc.c ....SIP outbound status <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> acc 0 is not active 00:00:12.884 pjsua_acc.c ....sip:alexk2222@sip.linphone.org: registration success, status=200 (Registration succes 00:00:12.911 pjsua_acc.c ....Keep-alive timer started <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> acc 0, destination:91.121.209.194:5060, interval:15s</code> </pre><br></li><li>  Finalmente, queda insertar altavoces o auriculares en la salida de audio y hablar en dos peque√±os micr√≥fonos MEMS cerca de la pantalla.  Llamamos desde Linux a trav√©s de la aplicaci√≥n simple_pjsua, pjsua.  Bueno, o puedes usar cualquier otro tipo de linphone. <br></li></ol><br>  Todo esto se describe en nuestra <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">wiki</a> . <br><br><h3>  ¬øC√≥mo llegamos a esto? </h3><br>  Entonces, inicialmente surgi√≥ la pregunta acerca de elegir una plataforma de hardware.  Como estaba claro que el STM32F4-Discovery no cab√≠a en la memoria, se eligi√≥ el STM32F7-Discovery.  Ella tiene una unidad flash de 1 MB y 256 KB de RAM (+ 64 memoria r√°pida especial, que tambi√©n usaremos).  Adem√°s, no hay muchas llamadas a trav√©s del servidor, pero decid√≠ intentar entrar. <br><br>  Convencionalmente, la tarea se dividi√≥ en varias etapas: <br><br><ul><li>  Ejecutando PJSIP en QEMU.  Era conveniente para la depuraci√≥n, adem√°s de que ya ten√≠amos compatibilidad con el c√≥dec AC97. </li><li>  Grabaci√≥n y reproducci√≥n de voz en QEMU y STM32. </li><li>  Portar una aplicaci√≥n <i>simple_pjsua</i> desde PJSIP.  Le permite registrarse en el servidor SIP y hacer llamadas. </li><li>  Implemente su propio servidor basado en Asterisk y pru√©belo en √©l, luego pruebe los externos como sip.linphone.org </li></ul><br>  El sonido en Embox funciona a trav√©s de Portaudio, que tambi√©n se usa en PISIP.  Los primeros problemas aparecieron en QEMU - WAV jug√≥ bien a 44100 Hz, pero obviamente algo sali√≥ mal en 8000.  Result√≥ que era una cuesti√≥n de establecer la frecuencia; por defecto, era 44100 en el equipo, y esto no cambi√≥ program√°ticamente con nosotros. <br><br>  Aqu√≠, probablemente valga la pena explicar un poco c√≥mo se reproduce el sonido en general.  La tarjeta de sonido puede establecer alg√∫n puntero en un trozo de memoria desde el que desea reproducir o grabar a una frecuencia predeterminada.  Una vez que finaliza el almacenamiento intermedio, se genera una interrupci√≥n y la ejecuci√≥n contin√∫a desde el siguiente almacenamiento intermedio.  El hecho es que estos b√∫feres deben llenarse con anticipaci√≥n antes de jugar el anterior.  Este problema nos encontraremos m√°s adelante en el STM32F7. <br><br>  Luego, alquilamos un servidor e implementamos Asterisk en √©l.  Como era necesario depurar mucho, pero no quer√≠a hablar mucho en el micr√≥fono, era necesario hacer una reproducci√≥n y grabaci√≥n autom√°ticas.  Para hacer esto, parcheamos simple_pjsua para que fuera posible deslizar archivos en lugar de dispositivos de audio.  En PJSIP, esto se hace de manera bastante simple, ya que tienen el concepto de un puerto, que puede ser un dispositivo o un archivo.  Y estos puertos se pueden conectar de manera flexible a otros puertos.  Puedes ver el c√≥digo en nuestro <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">repositorio</a> pjsip.  Como resultado, el esquema fue el siguiente.  Cre√© dos cuentas en el servidor Asterisk: para Linux y para Embox.  Luego, el comando <i>simple_pjsua_imported</i> se ejecuta en Embox, Embox se registra en el servidor, despu√©s de lo cual llamamos a Embox desde Linux.  En el momento de la conexi√≥n, verificamos en el servidor Asterisk que toda la conexi√≥n est√° establecida, y despu√©s de un tiempo deben escuchar el sonido de Linux en Embox, y en Linux guardamos el archivo que se reproduce desde Embox. <br><br>  Despu√©s de que funcion√≥ en QEMU, cambiamos a portar a STM32F7-Discovery.  El primer problema: no entraron en 1 MB de ROM sin la optimizaci√≥n incluida del compilador "-Os" en t√©rminos de tama√±o de imagen.  Por lo tanto incluido "-Os".  Adem√°s, el parche deshabilit√≥ la compatibilidad con C ++, por lo que solo es necesario para pjsua, y usamos simple_pjsua. <br><br>  Despu√©s de <i>ajustar simple_pjsua</i> , decidimos que ahora hay posibilidades de lanzarlo.  Pero primero, ten√≠a que lidiar con la grabaci√≥n y reproducci√≥n de voz.  Pregunta: ¬ød√≥nde escribir?  Elegimos una memoria externa: SDRAM (128 MB).  Puedes probarlo t√∫ mismo: <br><br>  Crea WAV est√©reo con una frecuencia de 16000 Hz y una duraci√≥n de 10 segundos: <br><br><pre> <code class="bash hljs">record -r 16000 -c 2 -d 10000 -m C0000000</code> </pre><br>  Perdemos: <br><br><pre> <code class="bash hljs">play -m C0000000</code> </pre><br>  Hubo dos problemas.  El primero con un c√≥dec es WM8994, y tiene un concepto como una ranura, y estas ranuras son 4. Entonces, de forma predeterminada, si esto no est√° configurado, cuando se reproduce audio, la reproducci√≥n se produce en las cuatro ranuras.  Por lo tanto, a una frecuencia de 16000 Hz, recibimos 8000 Hz, pero para 8000 Hz la reproducci√≥n simplemente no funcion√≥.  Cuando solo se seleccionaron las ranuras 0 y 2, funcion√≥ como deber√≠a.  Otro problema era la interfaz de audio en el STM32Cube, en el que la salida de audio funciona a trav√©s de SAI (Interfaz de audio serie) de forma sincronizada con la entrada de audio (no entend√≠a los detalles, pero resulta que comparten un reloj com√∫n y de alguna manera el audio est√° conectado al inicializar la salida de audio) entrada).  Es decir, no se pueden iniciar por separado, por lo que hicieron lo siguiente: la entrada de audio y la salida de audio siempre funcionan (incluidas las interrupciones generadas).  Pero cuando no se pierde nada en el sistema, simplemente deslizamos un b√∫fer vac√≠o en la salida de audio, y cuando comienza la reproducci√≥n, honestamente comenzamos a llenarlo. <br><br>  Adem√°s, se encontraron con el hecho de que el sonido al grabar la voz era muy silencioso.  Esto se debe al hecho de que los micr√≥fonos MEMS en el STM32F7-Discovery de alguna manera no funcionan bien en frecuencias inferiores a 16000 Hz.  Por lo tanto, establecemos 16000 Hz, incluso si viene 8000 Hz.  Para hacer esto, la verdad era agregar una conversi√≥n de software de una frecuencia a otra. <br><br>  Luego, tuve que aumentar el tama√±o del mont√≥n, que se encuentra en la RAM.  Seg√∫n nuestras estimaciones, pjsip requer√≠a aproximadamente 190 Kb, y solo ten√≠amos unos 100 Kb.  Aqu√≠ tuve que usar un poco de memoria externa: SDRAM (aproximadamente 128 Kb). <br><br>  Despu√©s de todas estas ediciones, vi los primeros paquetes entre Linux y Embox, ¬°y escuch√© un sonido!  Pero el sonido era terrible, para nada como en QEMU, no se pod√≠a distinguir nada.  Luego pensamos en lo que podr√≠a ser el problema.  La depuraci√≥n mostr√≥ que Embox simplemente no tiene tiempo para llenar / descargar buffers de audio.  Mientras pjsip est√° procesando un cuadro, se han producido 2 interrupciones antes de completar el procesamiento del b√∫fer, que es demasiado.  El primer pensamiento para acelerar fue optimizar el compilador, pero ya estaba incluido en PJSIP.  El segundo es un punto flotante de hardware, hablamos de ello en el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">art√≠culo</a> .  Pero como ha demostrado la pr√°ctica, FPU no dio un aumento significativo en la velocidad.  El siguiente paso fue priorizar los hilos.  Embox tiene diferentes estrategias de programaci√≥n, e inclu√≠ una que admite prioridades y establece transmisiones de audio a la m√°xima prioridad.  Tampoco ayud√≥. <br><br>  La siguiente fue la idea de que estamos trabajando con memoria externa y ser√≠a bueno mover las estructuras all√≠, a las que se accede con mucha frecuencia.  Hice un an√°lisis preliminar de cu√°ndo y bajo qu√© <i>simple_pjsua</i> asigna memoria.  Result√≥ que de 190 Kb, los primeros 90 Kb se asignan para las necesidades internas de PJSIP y no se accede a ellos con mucha frecuencia.  Luego, durante una llamada entrante, se llama a la funci√≥n pjsua_call_answer, en la que se asignan las memorias intermedias para trabajar con tramas entrantes y salientes.  Fue alrededor de 100 kb.  Y aqu√≠ actuamos de la siguiente manera.  Antes de la llamada, los datos se colocan en la memoria externa.  Tan pronto como la llamada, reemplace inmediatamente el mont√≥n con otro, en RAM.  Por lo tanto, todos los datos "activos" se transfirieron a una memoria m√°s r√°pida y predecible. <br><br>  Como resultado, todo esto en conjunto permiti√≥ iniciar <i>simple_pjsua</i> y hacer una llamada a trav√©s de su servidor.  Y luego a trav√©s de otros servidores como sip.linphone.org. <br><br><h3>  Conclusiones </h3><br>  Como resultado, result√≥ ejecutar <i>simple_pjsua</i> con transmisi√≥n de voz en ambas direcciones a trav√©s del servidor.  El problema con la SDRAM de 128 Kb adicionalmente gastada se puede resolver utilizando un Cortex-M7 un poco m√°s potente (por ejemplo, STM32F769NI con 512 Kb de RAM), pero al mismo tiempo todav√≠a no tenemos la esperanza de encajar en 256 Kb :) Nos alegrar√° que alguien est√© interesado y a√∫n mejor, int√©ntalo.  Todas las fuentes, como de costumbre, est√°n en nuestro <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">repositorio</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es431134/">https://habr.com/ru/post/es431134/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es431124/index.html">"La ciencia de datos, como las matem√°ticas y la f√≠sica, es otra forma de explorar el mundo que te rodea".</a></li>
<li><a href="../es431126/index.html">¬øPor qu√© no deber√≠a ahorrar en PM profesional?</a></li>
<li><a href="../es431128/index.html">Hackear DDR3 SPD</a></li>
<li><a href="../es431130/index.html">Semana de la Seguridad 48: Hack Black Friday</a></li>
<li><a href="../es431132/index.html">Reuters: Rusia aumentar√° las multas para las compa√±√≠as de Internet al 1% de los ingresos anuales</a></li>
<li><a href="../es431136/index.html">Terabytes sin peso en el bolsillo: ¬øest√° el futuro aqu√≠? Explorando las caracter√≠sticas de HyperX SAVAGE EXO</a></li>
<li><a href="../es431138/index.html">Biometr√≠a con la clave Rostelecom: c√≥mo el FSB lanz√≥ por primera vez la criptograf√≠a rusa en las tiendas de aplicaciones</a></li>
<li><a href="../es431140/index.html">Informe de la metapa de Go in Production: video, fotos, presentaciones</a></li>
<li><a href="../es431142/index.html">¬øC√≥mo ejecutar SQL Profiler Trace en la noche, a una hora espec√≠fica?</a></li>
<li><a href="../es431144/index.html">Micr√≥fono Far Fields (matriz de micr√≥fonos): h√©roe discreto en una columna inteligente</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>