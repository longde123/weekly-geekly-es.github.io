<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üîπ ü§∞üèΩ üíª Comment se faire des amis Ovirt et Let's Encrypt ü§±üèø ‚ÜôÔ∏è üõÄüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En marchant sur le chemin de l'am√©lioration de l'infrastructure, j'ai d√©cid√© de terminer la question ancienne et douloureuse - donner aux coll√®gues (d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment se faire des amis Ovirt et Let's Encrypt</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/424127/"> En marchant sur le chemin de l'am√©lioration de l'infrastructure, j'ai d√©cid√© de terminer la question ancienne et douloureuse - donner aux coll√®gues (d√©veloppeurs, testeurs, administrateurs, etc.) la possibilit√© de g√©rer ind√©pendamment leurs machines virtuelles en ovirt sans aucun geste suppl√©mentaire.  Il y a plusieurs composants dans ovirt que je dois configurer pour r√©soudre ma question: l'interface Web elle-m√™me, la console noVNC et le remplissage des images disque. <br><br>  Je n'ai pas trouv√© les boutons "Faire scintiller", donc je montre quels stylos j'ai tourn√© pour r√©soudre ce probl√®me.  Instructions compl√®tes sous la coupe: <br><br><img src="https://habrastorage.org/webt/pv/uo/ax/pvuoaxsmb0cnk7ifn-sjjh2aal0.jpeg"><br><br><a name="habracut"></a><br><br><h4>  AVIS DE NON-RESPONSABILIT√â: </h4><br>  Avant de commencer, je voudrais attirer l'attention sur le fait que, pour une raison que je ne connais pas, les domaines d'infrastructure sont cr√©√©s dans des zones priv√©es lan, locales, etc. <br><br>  Ce qui m'emp√™che d'utiliser le domaine de l'organisation dans la zone publique m'est inconnu.  Par exemple, au lieu du domaine Alex-GLuck-Awesome-Company.local, vous pouvez utiliser en toute s√©curit√© le domaine pour le site de la soci√©t√© Alex-GLuck-Awesome-Company.com. <br><br>  Si vous avez peur de ne pas pouvoir suivre les domaines de votre organisation, et cela cassera quelque chose, alors pour un modeste 100 roubles par an, vous pouvez prendre un domaine s√©par√© pour l'infrastructure aglac.com. <br><br>  Pourquoi il est plus rentable d'utiliser des domaines dans les zones publiques: <br><br>  1. Services apparaissant dans votre espace public au sein de votre organisation: VPN, partage de fichiers (seafile, nextcloud) et autres.  La configuration du chiffrement du trafic sur de tels services ressemble g√©n√©ralement √† un b√™tisier, et nous ne nous prot√©gerons pas de MitM, car c'est difficile (en fait non). <br><br>  Ou √† l'int√©rieur du bureau, vous avez une adresse de service et une autre √† partir d'Internet, et ces communications doivent √™tre maintenues, sur lesquelles nos ressources sp√©cialis√©es limit√©es sont d√©pens√©es.  Eh bien, les employ√©s doivent se souvenir de diff√©rentes adresses, ce qui n'est pas pratique. <br><br>  2. Vous pouvez utiliser des autorit√©s de certification gratuites pour crypter vos services internes. <br><br>  Own PKI est un service qui doit √™tre pris en charge, 100 roubles par an pour avoir la possibilit√© d'utiliser PKI aupr√®s des autorit√©s de certification gratuites plus que de payer le temps des employ√©s qui pourraient le consacrer √† d'autres t√¢ches. <br><br>  3. Lorsque vous utilisez votre propre autorit√© de certification, vous mettrez des b√¢tons dans les roues de vos employ√©s et coll√®gues distants qui souhaitent travailler avec BYOD (apportez leurs ordinateurs portables, t√©l√©phones, tablettes) et vous ne pouvez pas contr√¥ler leurs appareils.  Ils apportent des coquelicots, Linux, andro√Ødes, iOS, Windows - il est inutile de soutenir un tel zoo. <br><br>  En tout, bien s√ªr, il y a des exceptions, et les banques avec d'autres entreprises difficiles qui ont √©tabli des politiques de s√©curit√© ne pourront jamais am√©liorer le service pour leurs employ√©s. <br><br>  Il existe pour eux des autorit√©s de certification payantes qui, pour un certain montant, peuvent signer leur certificat CA (google ¬´root signature service¬ª). <br><br>  Il existe d'autres raisons pour lesquelles il est plus rentable d'utiliser un domaine public (la chose la plus importante est qu'il vous appartient), mais l'article ne traite pas de cela. <br><br><h2>  L'essentiel, mais le point ... </h2><br>  <b>ATTENTION!</b>  <b>Si vous ajoutez un certificat d'autorit√© de certification de Let's Encrypt √† la liste de confiance d'Ovirt, cela peut affecter la s√©curit√© de vos syst√®mes!</b> <br><br>  La premi√®re chose √† laquelle vous devez faire attention est que mettre l'interface Internet sur Internet est une mauvaise pratique, car  cela n'a aucun sens pratique et cr√©e des menaces de s√©curit√© suppl√©mentaires. <br><br>  Par cons√©quent, vous devez obtenir un certificat sur certains de nos h√¥tes bastions, puis transf√©rer le certificat et la cl√© sur notre h√¥te avec ovirt-engine. <br><br>  Nous ajoutons l'adresse externe de notre h√¥te bastion dans le DNS avec notre nom ovirtengine.example.com <i>ovirt</i> , je laisserai l'installation de certbot et nginx dans les coulisses (comment faire cela sur le hub a d√©j√† √©t√© d√©crit). <br><br>  Configuration de la version Nginx&gt; = 1.15.7 <br><br><div class="spoiler">  <b class="spoiler_title">/etc/nginx/conf.d/default.conf</b> <div class="spoiler_text"><pre><code class="plaintext hljs">server { server_name _; listen 80 default_server; location /robots.txt { alias /usr/share/nginx/html/robots.txt; } location /.well-known { root /usr/share/nginx/html; } location / { return 444; } } server { server_name _; listen 443 ssl http2 default_server; location /robots.txt { alias /usr/share/nginx/html/robots.txt; } location /.well-known { root /usr/share/nginx/html; } ssl_certificate /etc/nginx/ssl/$ssl_server_name/fullchain.pem; ssl_certificate_key /etc/nginx/ssl/$ssl_server_name/privkey.pem; ssl_protocols TLSv1.2; ssl_prefer_server_ciphers on; ssl_dhparam /etc/nginx/ssl/dhparam.pem; ssl_ciphers 'ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:AES:CAMELLIA:DES-CBC3-SHA:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!aECDH:!EDH-DSS-DES-CBC3-SHA:!EDH-RSA-DES-CBC3-SHA:!KRB5-DES-CBC3-SHA'; ssl_session_timeout 1d; ssl_session_cache shared:SSL:50m; #    OCSP-,         ssl_stapling on; ssl_stapling_verify on; add_header Strict-Transport-Security max-age=15768000; location / { return 444; } }</code> </pre> <br></div></div><br>  Ensuite, nous obtenons notre certificat et notre cl√©: <br><br><pre> <code class="bash hljs">certbot certonly --nginx -d ovirtengine.example.com</code> </pre><br>  Nous archivons notre certificat et notre cl√©: <br><br><pre> <code class="bash hljs">tar Phczf /tmp/ovirtengine.example.com.tgz /etc/letsencrypt/live/ovirtengine.example.com</code> </pre><br>  T√©l√©chargez l'archive de l'h√¥te bastion, t√©l√©chargez-la sur notre ovirt-enzhin: <br><br><pre> <code class="bash hljs">scp bastion-host:/tmp/ovirtengine.example.com.tgz /tmp/ scp /tmp/ovirtengine.example.com.tgz ovirtengine.example.com:/</code> </pre><br><h3>  Aller √† l'objectif </h3><br>  Ensuite, nous d√©compressons notre archive et cr√©ons des liens symboliques pour simplifier la compr√©hension du syst√®me de localisation de fichiers: <br><br><pre> <code class="bash hljs">tar Pxzf /ovirtengine.example.com.tgz &amp;&amp; rm -f ovirtengine.example.com.tgz mkdir -p /etc/letsencrypt/live ln -f -s /etc/letsencrypt/live /etc/pki/letsencrypt</code> </pre><br>  Nous configurons le pki int√©gr√© dans l'ovirt pour utiliser le magasin de certificats java (openjdk) pour la v√©rification des certificats: <br><br><pre> <code class="bash hljs">cat &lt;&lt; EOF &gt; /etc/ovirt-engine/engine.conf.d/99-setup-pki.conf ENGINE_HTTPS_PKI_TRUST_STORE=<span class="hljs-string"><span class="hljs-string">"/etc/pki/java/cacerts"</span></span> ENGINE_HTTPS_PKI_TRUST_STORE_PASSWORD=<span class="hljs-string"><span class="hljs-string">""</span></span> EOF</code> </pre><br>  Nous convertissons l'autorit√© de certification de Let's Encrypt au format der et ajoutons un ovirt au magasin de certificats du magasin de confiance Java (c'est un tel conteneur o√π se trouve la liste des certificats, un tel syst√®me est utilis√© en Java): <br><br><pre> <code class="bash hljs">openssl x509 -outform der -<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> /etc/pki/letsencrypt/ovirtengine.example.com/chain.pem -out /tmp/ovirtengine.example.com.chain.der keytool -import -<span class="hljs-built_in"><span class="hljs-built_in">alias</span></span> <span class="hljs-string"><span class="hljs-string">"Let's Encrypt Authority X3"</span></span> -file /tmp/ovirtengine.example.com.chain.der -keystore /etc/pki/ovirt-engine/.truststore -storepass $(grep <span class="hljs-string"><span class="hljs-string">'^ENGINE_PKI_TRUST_STORE_PASSWORD'</span></span> /etc/ovirt-engine/engine.conf.d/10-setup-pki.conf | cut -f 2 -d <span class="hljs-string"><span class="hljs-string">'"'</span></span>) rm -f /tmp/ovirtengine.example.com.chain.der</code> </pre><br>  Nous modifions les param√®tres SSL pour apache, ajoutons le param√®tre pour prendre en charge les liens symboliques et supprimons le param√®tre pour CA, qui v√©rifiera les certificats (par d√©faut, le syst√®me utilisera le jeu de CA de confiance pour v√©rification): <br><br><pre> <code class="bash hljs">sed -r -i <span class="hljs-string"><span class="hljs-string">'s|^(SSLCACertificateFile.*)|#\1|g'</span></span> /etc/httpd/conf.d/ssl.conf sed -r -i <span class="hljs-string"><span class="hljs-string">'0,/(^#?SSLCACertificateFile.*)/ s//\1\nOptions FollowSymlinks/'</span></span> /etc/httpd/conf.d/ssl.conf</code> </pre><br>  Apr√®s cela, juste au cas o√π, nous sauvegarderons automatiquement les fichiers originaux g√©n√©r√©s via PKI ovirt'a et remplacerons les liens symboliques par des fichiers de Let's Encrypt: <br><br><pre> <code class="bash hljs">ln -f -s /etc/pki/letsencrypt/ovirtengine.example.com/fullchain.pem /etc/pki/ovirt-engine/apache-chain.pem services=( <span class="hljs-string"><span class="hljs-string">'apache'</span></span> <span class="hljs-string"><span class="hljs-string">'imageio-proxy'</span></span> <span class="hljs-string"><span class="hljs-string">'websocket-proxy'</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${services[@]}</span></span></span><span class="hljs-string">"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> cp /etc/pki/ovirt-engine/certs/<span class="hljs-variable"><span class="hljs-variable">$i</span></span>.cer{,.<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$( date +%F )</span></span></span><span class="hljs-string">"</span></span>.bak} cp /etc/pki/ovirt-engine/keys/<span class="hljs-variable"><span class="hljs-variable">$i</span></span>.key.nopass{,.<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$( date +%F )</span></span></span><span class="hljs-string">"</span></span>.bak} ln -f -s /etc/pki/letsencrypt/ovirtengine.example.com/privkey.pem /etc/pki/ovirt-engine/keys/<span class="hljs-variable"><span class="hljs-variable">$i</span></span>.key.nopass ln -f -s /etc/pki/letsencrypt/ovirtengine.example.com/cert.pem /etc/pki/ovirt-engine/certs/{apache,imageio-proxy,websocket-proxy}.cer <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre><br>  Nous restaurons les contextes SElinux sur les fichiers et red√©marrons nos services (httpd, ovirt-engine, ovirt-imageio-proxy, ovirt-websocket-proxy): <br><br><pre> <code class="bash hljs">restorecon -Rv /etc/pki systemctl restart httpd ovirt-engine ovirt-imageio-proxy ovirt-websocket-proxy</code> </pre><br>  httpd - serveur web apache <br>  ovirt-engine - interface web ovirt <br>  ovirt-imageio-proxy - d√©mon pour le chargement d'images disque <br>  ovirt-websocket-proxy - service pour ex√©cuter la console noVNC <br><br>  Tout ce qui pr√©c√®de a √©t√© test√© sur la version 4.2 de l'ovirt. <br><br><h2>  Renouvellement automatique des certificats pour ovirt </h2><br>  Conform√©ment aux bonnes pratiques de s√©curit√©, il ne doit pas y avoir de connexion entre l'h√¥te bastion et l'ovirt, et le certificat n'est d√©livr√© que pour 3 mois.  C'est l√† qu'un point controvers√© appara√Æt sur la fa√ßon dont j'ai mis en ≈ìuvre le renouvellement des certificats. <br><br>  J'ai un livre de jeu d'ensemble qui fonctionne sur le contrema√Ætre tous les jours √† 5 heures du matin selon un horaire.  Ce playbook entre dans l'ovirt, v√©rifie la p√©riode de validit√© du certificat et s'il reste moins de 5 jours avant l'expiration, il va √† l'h√¥te bastion et commence le renouvellement du certificat. <br><br>  Apr√®s avoir mis √† jour le certificat, il archive le dossier avec les fichiers, t√©l√©charge le formulaire sur l'h√¥te et d√©compresse l'h√¥te ovirt.  Ensuite, il restaure les contextes SElinux sur les fichiers et red√©marre nos services. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr424127/">https://habr.com/ru/post/fr424127/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr424111/index.html">Vagues de contrats intelligents. Premi√®re exp√©rience</a></li>
<li><a href="../fr424113/index.html">Processus de conception, recherche et recherche d'emploi</a></li>
<li><a href="../fr424115/index.html">Cas d'utilisation ou manque d'√©quilibreurs de charge</a></li>
<li><a href="../fr424119/index.html">Y avait-il un Scrum *?</a></li>
<li><a href="../fr424121/index.html">Cr√©ation d'une fonction de d√©clenchement dans pgModeler</a></li>
<li><a href="../fr424129/index.html">D√©veloppement Android. Un peu de travail rapide avec les listes</a></li>
<li><a href="../fr424131/index.html">Manifeste des d√©veloppeurs de syst√®mes intelligents: 15 principes</a></li>
<li><a href="../fr424133/index.html">Virtualisation des emplois pour le bureau d'architecture √† travers les yeux des sciences humaines</a></li>
<li><a href="../fr424135/index.html">L'Union europ√©enne approuve la nouvelle directive sur le droit d'auteur - son impact sur Internet</a></li>
<li><a href="../fr424137/index.html">Et comment avez-vous c√©l√©br√© la journ√©e du programmeur?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>