<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>⚙️ 🤚🏻 ♋️ Ofuscación de datos para pruebas de rendimiento 🧚🏻 🥇 💽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Los usuarios de ClickHouse saben que su principal ventaja es la alta velocidad de procesamiento de consultas analíticas. Pero, ¿cómo podemos hacer tal...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Ofuscación de datos para pruebas de rendimiento</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yandex/blog/457354/">  Los usuarios de ClickHouse saben que su principal ventaja es la alta velocidad de procesamiento de consultas analíticas.  Pero, ¿cómo podemos hacer tales declaraciones?  Esto debería estar respaldado por pruebas de rendimiento confiables.  Hablaremos de ellos hoy. <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><img src="https://habrastorage.org/webt/ds/2m/sd/ds2msd5-4zeahpzlzptlqz8wgs8.png"></a> <br><br>  Comenzamos a realizar tales pruebas en 2013, mucho antes de que el producto estuviera disponible en código abierto.  Como ahora, estábamos más interesados ​​en la velocidad del servicio de datos Yandex.Metrica.  Ya hemos almacenado datos en ClickHouse desde enero de 2009.  Parte de los datos se ha escrito en la base de datos desde 2012, y parte, se ha <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">convertido</a> de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">OLAPServer y Metrage</a> , estructuras de datos que se utilizaron en Yandex.Metrica antes.  Por lo tanto, para las pruebas, tomamos el primer subconjunto disponible de mil millones de datos de páginas vistas.  Todavía no había consultas en Metric, y se nos ocurrieron consultas que nos resultaron más interesantes (todo tipo de filtrado, agregación y clasificación). <br><br>  ClickHouse se probó en comparación con sistemas similares, por ejemplo, Vertica y MonetDB.  Para ser sincero, fue realizado por un empleado que no había sido previamente desarrollador de ClickHouse, y los casos particulares en el código no fueron optimizados para obtener resultados.  Del mismo modo, obtuvimos un conjunto de datos para pruebas funcionales. <br><br>  Después de que ClickHouse se uniera al código abierto en 2016, hubo más preguntas para las pruebas. <br><br><a name="habracut"></a><h2>  Desventajas de las pruebas en datos propietarios </h2><br>  Pruebas de rendimiento: <br><br><ol><li> No son reproducibles desde el exterior, porque su lanzamiento requiere datos cerrados que no se pueden publicar.  Por la misma razón, algunas pruebas funcionales no están disponibles para usuarios externos. </li><li>  No te desarrolles.  Existe la necesidad de una expansión significativa de su conjunto, de modo que sea posible verificar de manera aislada los cambios en la velocidad de las partes individuales del sistema. </li><li>  No se ejecutan de manera comprometida para solicitudes de grupo, los desarrolladores externos no pueden verificar su código para la regresión del rendimiento. </li></ol><br>  Puede resolver estos problemas: descarte las pruebas antiguas y cree otras nuevas basadas en datos abiertos.  Entre los datos abiertos, puede tomar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">datos sobre vuelos a los EE</a> . <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">UU.</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Viajes en taxi en Nueva York</a> o utilizar puntos de referencia TPC-H, TPC-DS, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Star Schema Benchmark</a> .  El inconveniente es que estos datos están lejos de los datos de Yandex.Metrica, y me gustaría guardar las solicitudes de prueba. <br><br><h2>  Es importante utilizar datos reales. </h2><br>  Debe probar el rendimiento del servicio solo en datos reales de producción.  Veamos algunos ejemplos. <br><br>  <strong>Ejemplo 1</strong> <br><br>  Suponga que llena una base de datos con números pseudoaleatorios distribuidos uniformemente.  En este caso, la compresión de datos no funcionará.  Pero la compresión de datos es una propiedad importante para los DBMS analíticos.  Elegir el algoritmo de compresión correcto y la forma correcta de integrarlo en el sistema es una tarea no trivial en la que no hay una solución correcta, porque la compresión de datos requiere un compromiso entre la velocidad de compresión y descompresión y la relación de compresión potencial.  Los sistemas que no saben cómo comprimir datos pierden garantía.  Pero si usamos números pseudoaleatorios distribuidos uniformemente para las pruebas, este factor no se considera y todos los demás resultados se distorsionarán. <br><br>  Conclusión: los datos de prueba deben tener una relación de compresión realista. <br><br>  Sobre la optimización de los algoritmos de compresión de datos en ClickHouse, hablé en una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">publicación anterior</a> . <br><br>  <strong>Ejemplo 2</strong> <br><br>  Interesémonos en la velocidad de la consulta SQL: <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> RegionID, uniq(UserID) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> visitors     <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> test.hits     <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> RegionID     <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> visitors <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span>     <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span></code> </pre> <br>  Esta es una solicitud típica para Yandex.Metrica.  ¿Qué es importante para su velocidad? <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">¿Cómo se realiza GROUP BY</a> ? </li><li>  Qué estructura de datos se utiliza para calcular la función agregada uniq. </li><li>  Cuántos RegionID diferentes son y cuánta RAM requiere cada estado de la función uniq. </li></ul><br>  Pero también es muy importante que la cantidad de datos para diferentes regiones se distribuya de manera desigual.  (Probablemente, se distribuye de acuerdo con la ley de potencia. Construí un gráfico en la escala log-log, pero no estoy seguro). Y si es así, es importante para nosotros que los estados de la función agregada uniq con un pequeño número de valores usen poca memoria.  Cuando hay muchas claves de agregación diferentes, el recuento va a unidades de bytes.  ¿Cómo obtener los datos generados que tienen todas estas propiedades?  Por supuesto, es mejor usar datos reales. <br><br>  Muchos DBMS implementan una estructura de datos HyperLogLog para el cálculo aproximado de COUNT (DISTINCT), pero todos funcionan relativamente mal porque esta estructura de datos utiliza una cantidad fija de memoria.  Y ClickHouse tiene una función que utiliza una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">combinación de tres estructuras de datos diferentes</a> , dependiendo del tamaño del conjunto. <br><br>  Conclusión: los datos de prueba deben representar las propiedades de la distribución de valores en los datos: cardinalidad (el número de valores en las columnas) y cardinalidad mutua de varias columnas diferentes. <br><br>  <strong>Ejemplo 3</strong> <br><br>  Bueno, probemos el rendimiento no del DBMS analítico ClickHouse, sino de algo más simple, por ejemplo, tablas hash.  Para las tablas hash, elegir la función hash correcta es muy importante.  Para std :: unordered_map, es un poco menos importante, porque es una tabla hash basada en cadena y se utiliza un número primo como el tamaño de la matriz.  En la implementación estándar de la biblioteca en gcc y clang, se utiliza una función hash trivial como la función hash predeterminada para los tipos numéricos.  Pero std :: unordered_map no es la mejor opción cuando queremos obtener la máxima velocidad.  Cuando se usan tablas hash de direccionamiento abierto, la elección correcta de la función hash se convierte en un factor decisivo, y no podemos usar la función hash trivial. <br><br>  Es fácil encontrar pruebas de rendimiento de tablas hash en datos aleatorios, sin tener en cuenta las funciones hash utilizadas.  También es fácil encontrar pruebas de función hash con énfasis en la velocidad de cálculo y algunos criterios de calidad, sin embargo, de forma aislada de las estructuras de datos utilizadas.  Pero el hecho es que las tablas hash y HyperLogLog requieren diferentes criterios de calidad para las funciones hash. <br><br><img src="https://habrastorage.org/webt/bp/3h/32/bp3h320eztrirqzhm-lexeuhmbq.png"><br><br>  Lea más sobre esto en el informe <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">"Cómo se organizan las tablas hash en ClickHouse"</a> .  Está un poco desactualizado ya que no considera las <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">tablas suizas</a> . <br><br><h2>  Desafío </h2><br>  Queremos obtener los datos para las pruebas de rendimiento por estructura, igual que los datos de Yandex.Metrica, para los que se almacenan todas las propiedades importantes para los puntos de referencia, pero para que no queden rastros de visitantes reales del sitio en estos datos.  Es decir, los datos deben ser anonimizados y se debe almacenar lo siguiente: <br><br><ul><li>  relaciones de compresión </li><li>  cardinalidad (número de valores diferentes), </li><li>  cardinalidades mutuas de varias columnas diferentes, </li><li>  propiedades de las distribuciones de probabilidad con las que puede simular datos (por ejemplo, si creemos que las regiones se distribuyen de acuerdo con una ley de potencia, entonces el exponente - parámetro de distribución - para datos artificiales debería ser casi igual que para los reales). </li></ul><br>  ¿Y qué se necesita para que los datos tengan una relación de compresión similar?  Por ejemplo, si se usa LZ4, entonces las subcadenas en los datos binarios deben repetirse aproximadamente a las mismas distancias y las repeticiones deben tener aproximadamente la misma longitud.  Para ZSTD, se agrega una coincidencia de entropía de bytes. <br><br>  El objetivo máximo: hacer que una herramienta esté disponible para personas externas, con la que todos puedan anonimizar su conjunto de datos para su publicación.  Para que podamos depurar y probar el rendimiento en los datos de otras personas de forma similar a los datos de producción.  Y me gustaría que fuera interesante ver los datos generados. <br><br>  Esta es una declaración informal del problema.  Sin embargo, nadie iba a dar una declaración formal. <br><br><h2>  Intentos de resolver </h2><br>  La importancia de esta tarea no debe exagerarse para nosotros.  De hecho, nunca estuvo en los planes y nadie lo iba a hacer.  Simplemente no perdí la esperanza de que algo surgiría solo, y de repente tendría un buen humor y muchas cosas que podrían posponerse hasta más tarde. <br><br><h2>  Modelos probabilísticos explícitos </h2><br>  La primera idea es seleccionar una familia de distribuciones de probabilidad que la modele para cada columna de la tabla.  Luego, en función de las estadísticas de los datos, seleccione los parámetros de ajuste del modelo y genere nuevos datos utilizando la distribución seleccionada.  Puede usar un generador de números pseudoaleatorio con una semilla predefinida para obtener un resultado reproducible. <br><br>  Para los campos de texto, puede usar las cadenas de Markov, un modelo comprensible para el que puede realizar una implementación efectiva. <br><br>  Es cierto que se requieren algunos trucos: <br><br><ul><li>  Queremos preservar la continuidad de las series de tiempo, lo que significa que para algunos tipos de datos es necesario modelar no el valor en sí, sino la diferencia entre los vecinos. </li><li>  Para simular la cardinalidad condicional de las columnas (por ejemplo, que generalmente hay pocas direcciones IP por identificador de visitante), también deberá anotar explícitamente las dependencias entre las columnas (por ejemplo, para generar una dirección IP, se utiliza un hash del identificador de visitante, pero también se agregan algunos otros datos pseudoaleatorios). </li><li>  No está claro cómo expresar la dependencia de que un visitante aproximadamente al mismo tiempo a menudo visita URL con dominios coincidentes. </li></ul><br>  Todo esto se presenta en forma de un programa en el que todas las distribuciones y dependencias están codificadas, el llamado "script C ++".  Sin embargo, los modelos de Markov todavía se calculan a partir de la suma de estadísticas, suavizado y rugosidad con ruido.  Comencé a escribir este script, pero por alguna razón, después de escribir explícitamente el modelo para diez columnas, de repente se volvió insoportablemente aburrido.  Y en la tabla de éxitos en Yandex. Métrica en 2012 había más de 100 columnas. <br><br><pre> <code class="cpp hljs">EventTime.day(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::discrete_distribution&lt;&gt;({    <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">13</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">14</span></span>, <span class="hljs-number"><span class="hljs-number">42</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-number"><span class="hljs-number">31</span></span>, <span class="hljs-number"><span class="hljs-number">17</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">23</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>, ...})(random)); EventTime.hour(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::discrete_distribution&lt;&gt;({    <span class="hljs-number"><span class="hljs-number">13</span></span>, <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">23</span></span>, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-number"><span class="hljs-number">23</span></span>, <span class="hljs-number"><span class="hljs-number">18</span></span>, <span class="hljs-number"><span class="hljs-number">19</span></span>, <span class="hljs-number"><span class="hljs-number">19</span></span>, ...})(random)); EventTime.minute(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::uniform_int_distribution&lt;UInt8&gt;(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">59</span></span>)(random)); EventTime.second(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::uniform_int_distribution&lt;UInt8&gt;(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">59</span></span>)(random)); UInt64 UserID = hash(<span class="hljs-number"><span class="hljs-number">4</span></span>, powerLaw(<span class="hljs-number"><span class="hljs-number">5000</span></span>, <span class="hljs-number"><span class="hljs-number">1.1</span></span>)); UserID = UserID / <span class="hljs-number"><span class="hljs-number">10000000000U</span></span>LL * <span class="hljs-number"><span class="hljs-number">10000000000U</span></span>LL    + <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">time_t</span></span>&gt;(EventTime) + UserID % <span class="hljs-number"><span class="hljs-number">1000000</span></span>; random_with_seed.seed(powerLaw(<span class="hljs-number"><span class="hljs-number">5000</span></span>, <span class="hljs-number"><span class="hljs-number">1.1</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> get_random_with_seed = [&amp;]{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> random_with_seed(); };</code> </pre><br>  Este enfoque de la tarea fue un fracaso.  Si me acercara a ella más diligentemente, seguro que el guión habría sido escrito. <br><br>  Ventajas: <br><br><ul><li>  simplicidad ideológica </li></ul><br>  Desventajas <br><br><ul><li>  la complejidad de la implementación, </li><li>  La solución implementada es adecuada para un solo tipo de datos. </li></ul><br>  Y me gustaría una solución más general, para que pueda aplicarse no solo a los datos de Yandex.Metrica, sino también para ofuscar cualquier otro dato. <br><br>  Sin embargo, las mejoras son posibles aquí.  No puede seleccionar modelos manualmente, sino implementar un catálogo de modelos y elegir el mejor entre ellos (mejor ajuste + algún tipo de regularización).  O tal vez pueda usar los modelos de Markov para todo tipo de campos, y no solo para el texto.  Las dependencias entre los datos también se pueden entender automáticamente.  Para hacer esto, debe calcular las <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">entropías relativas</a> (cantidad relativa de información) entre las columnas, o más simplemente, las cardinalidades relativas (algo así como “cuántos valores A diferentes en promedio para un valor B fijo”) para cada par de columnas.  Esto dejará en claro, por ejemplo, que URLDomain depende completamente de la URL, y no al revés. <br><br>  Pero también rechacé esta idea, porque hay demasiadas opciones para lo que debe tenerse en cuenta, y tomará mucho tiempo escribirlo. <br><br><h2>  Redes neuronales </h2><br>  Ya dije lo importante que es esta tarea para nosotros.  Nadie pensó siquiera en detenerse en su implementación.  Afortunadamente, el colega Ivan Puzyrevsky luego trabajó como maestro en HSE y al mismo tiempo estaba desarrollando el núcleo de YT.  Me preguntó si tenía alguna tarea interesante que pudiera ofrecerse a los estudiantes como tema de diploma.  Le ofrecí este y me aseguró que era adecuado.  Entonces le di esta tarea a una buena persona "de la calle": Sharif Anvardinov (la NDA está firmada para trabajar con datos). <br><br>  Le contó todas sus ideas, pero lo más importante, explicó que el problema se puede resolver de cualquier manera.  Y una buena opción sería usar esos enfoques que no entiendo en absoluto: por ejemplo, generar un volcado de datos de texto usando LSTM.  Parecía alentador gracias al <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">artículo La efectividad irracional de las redes neuronales recurrentes</a> , que luego me llamó la atención. <br><br>  La primera característica de la tarea es que necesita generar datos estructurados, no solo texto.  No era obvio si una red neuronal recurrente podría generar datos con la estructura deseada.  Hay dos formas de resolver esto.  El primero es usar modelos separados para generar la estructura y para el "relleno": la red neuronal solo debe generar valores.  Pero esta opción fue pospuesta hasta más tarde, después de lo cual nunca lo hicieron.  La segunda forma es simplemente generar un volcado de TSV como texto.  La práctica ha demostrado que en el texto parte de las líneas no se corresponderá con la estructura, pero estas líneas se pueden tirar al cargar. <br><br>  La segunda característica: una red neuronal recurrente genera una secuencia de datos, y las dependencias en los datos solo pueden seguir en el orden de esta secuencia.  Pero en nuestros datos, tal vez el orden de las columnas se invierte con respecto a las dependencias entre ellas.  No hicimos nada con esta función. <br><br>  Hacia el verano, apareció el primer script de Python que generaba datos.  A primera vista, la calidad de los datos es decente: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6f4/816/f70/6f4816f70912c3fb348f505d3073eded.jpg"><br><br>  Es cierto que se revelaron dificultades: <br><br><ol><li>  El tamaño del modelo es de aproximadamente un gigabyte.  Y tratamos de crear un modelo para datos cuyo tamaño era del orden de varios gigabytes (para empezar).  El hecho de que el modelo resultante sea tan grande suscita inquietud: de repente será posible obtener datos reales del mismo en el que se formó.  Lo más probable es que no.  Pero no entiendo el aprendizaje automático y las redes neuronales y no he leído el código Python de esta persona, entonces, ¿cómo puedo estar seguro?  Luego hubo artículos sobre cómo comprimir redes neuronales sin perder calidad, pero esto se dejó sin implementación.  Por un lado, esto no parece un problema: puede negarse a publicar el modelo y publicar solo los datos generados.  Por otro lado, en el caso del reciclaje, los datos generados pueden contener alguna parte de los datos de origen. </li><li>  En una sola máquina con una CPU, la tasa de generación de datos es de aproximadamente 100 líneas por segundo.  Teníamos una tarea: generar al menos mil millones de líneas.  El cálculo mostró que esto no podía hacerse antes de la defensa del diploma.  Y usar otro hardware no es práctico, porque tenía un objetivo: hacer que la herramienta de generación de datos esté disponible para un uso amplio. </li></ol><br>  Sharif trató de estudiar la calidad de los datos mediante la comparación de estadísticas.  Por ejemplo, calculé la frecuencia con la que aparecen diferentes símbolos en la fuente y en los datos generados.  El resultado fue sorprendente: los personajes más comunes son Ð y Ñ. <br><br>  No se preocupe, defendió su diploma perfectamente, después de lo cual nos olvidamos de este trabajo. <br><br><h2>  Mutación de datos comprimidos </h2><br>  Suponga que la declaración del problema se reduce a un punto: necesita generar datos para los cuales las relaciones de compresión serán exactamente las mismas que los datos originales, mientras que los datos deben expandirse exactamente a la misma velocidad.  Como hacerlo  ¡Necesita editar bytes de datos comprimidos directamente!  Entonces, el tamaño de los datos comprimidos no cambiará, pero los datos en sí lo harán.  Sí, y todo funcionará rápidamente.  Cuando apareció esta idea, inmediatamente quise implementarla, a pesar del hecho de que resuelve algún otro problema en lugar del original.  Siempre pasa. <br><br>  ¿Cómo editar un archivo comprimido directamente?  Supongamos que solo estamos interesados ​​en LZ4.  Los datos comprimidos con LZ4 constan de dos tipos de instrucciones: <br><br><ol><li>  Literales: copie los siguientes N bytes tal como están. </li><li>  Coincidencia (coincidencia, la longitud mínima de repetición es 4): repita N bytes que estaban en el archivo a una distancia de M. </li></ol><br>  Datos de origen: <br>  <code>Hello world Hello</code> <br><br>  Datos comprimidos (condicionalmente): <br>  <code>literals 12 "Hello world " match 5 12</code> . <br><br>  En el archivo comprimido, deje la coincidencia como está, y en literales cambiaremos los valores de bytes.  Como resultado, después de la descompresión, obtenemos un archivo en el que todas las secuencias repetidas de al menos 4 también se repiten, y se repiten a las mismas distancias, pero al mismo tiempo consisten en un conjunto diferente de bytes (en sentido figurado, no se tomó un solo byte del archivo original en el archivo modificado ) <br><br>  ¿Pero cómo cambiar los bytes?  Esto no es obvio porque, además de los tipos de columna, los datos también tienen su propia estructura interna implícita, que nos gustaría preservar.  Por ejemplo, el texto a menudo se almacena en codificación UTF-8, y también queremos UTF-8 válido en los datos generados.  Hice una simple heurística para satisfacer varias condiciones: <br><br><ul><li>  bytes nulos y caracteres de control ASCII se almacenaron tal cual, </li><li>  persistió alguna puntuación, </li><li>  ASCII se tradujo a ASCII y, por lo demás, se guardó el bit más significativo (o puede escribir explícitamente un conjunto if para diferentes longitudes UTF-8).  Entre una clase de bytes, se selecciona un nuevo valor de manera uniforme al azar; </li><li>  y también para guardar fragmentos de <code>https://</code> y similares, de lo contrario todo parece demasiado tonto. </li></ul><br>  La peculiaridad de este enfoque es que los datos iniciales en sí mismos actúan como un modelo para los datos, lo que significa que el modelo no se puede publicar.  Le permite generar la cantidad de datos no más que el original.  A modo de comparación, en enfoques anteriores era posible crear un modelo y generar una cantidad ilimitada de datos sobre la base. <br><br>  Ejemplo para URL: <br><br> <code>http://ljc.she/kdoqdqwpgafe/klwlpm&amp;qw=962788775I0E7bs7OXeAyAx <br> http://ljc.she/kdoqdqwdffhant.am/wcpoyodjit/cbytjgeoocvdtclac <br> http://ljc.she/kdoqdqwpgafe/klwlpm&amp;qw=962788775I0E7bs7OXe <br> http://ljc.she/kdoqdqwdffhant.am/wcpoyodjit/cbytjgeoocvdtclac <br> http://ljc.she/kdoqdqwdbknvj.s/hmqhpsavon.yf#aortxqdvjja <br> http://ljc.she/kdoqdqw-bknvj.s/hmqhpsavon.yf#aortxqdvjja <br> http://ljc.she/kdoqdqwpdtu-Unu-Rjanjna-bbcohu_qxht <br> http://ljc.she/kdoqdqw-bknvj.s/hmqhpsavon.yf#aortxqdvjja <br> http://ljc.she/kdoqdqwpdtu-Unu-Rjanjna-bbcohu_qxht <br> http://ljc.she/kdoqdqw-bknvj.s/hmqhpsavon.yf#aortxqdvjja <br> http://ljc.she/kdoqdqwpdtu-Unu-Rjanjna-bbcohu-702130 <br></code> <br>  El resultado me gustó: fue interesante mirar los datos.  Pero aún así, algo estaba mal.  Las URL todavía están estructuradas, pero en algunos lugares fue demasiado fácil adivinar yandex o avito.  Hizo una heurística que a veces reorganiza algunos bytes en algunos lugares. <br><br>  Otras consideraciones preocupadas.  Por ejemplo, la información confidencial se puede representar en una columna de tipo FixedString en forma binaria y, por alguna razón, consiste en caracteres de control ASCII y puntuación, que decidí guardar.  Y no considero los tipos de datos. <br><br>  Otro problema: si los datos del tipo "longitud, valor" se almacenan en una columna (así es como se almacenan las columnas del tipo Cadena), ¿cómo garantizar que la longitud siga siendo correcta después de la mutación?  Cuando traté de arreglarlo, la tarea inmediatamente se volvió poco interesante. <br><br><h2>  Permutaciones aleatorias </h2><br>  Pero el problema no está resuelto.  Llevamos a cabo varios experimentos, y solo empeoró.  Solo queda no hacer nada y leer páginas aleatorias en Internet, porque el estado de ánimo ya está echado a perder.  Afortunadamente, en una de estas páginas había un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">análisis del algoritmo para</a> representar la escena de la muerte del protagonista en el juego Wolfenstein 3D. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a5d/8a2/291/a5d8a229119786bc45f48fb74cfb956d.gif" width="640" height="480"><br><br>  Hermosa animación: la pantalla se llena de sangre.  El artículo explica que esto es en realidad una permutación pseudoaleatoria.  Permutación aleatoria: una transformación uno a uno de un conjunto seleccionada al azar.  Es decir, la visualización de todo el conjunto en el que no se repiten los resultados para diferentes argumentos.  En otras palabras, esta es una forma de iterar sobre todos los elementos de un conjunto en un orden aleatorio.  Es un proceso que se muestra en la imagen: pintamos sobre cada píxel, seleccionados al azar de todos, sin repetición.  Si solo escogiéramos un píxel aleatorio en cada paso, nos llevaría mucho tiempo pintar sobre el último. <br><br>  El juego utiliza un algoritmo muy simple para la permutación pseudoaleatoria: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">LFSR</a> (registro de desplazamiento de retroalimentación lineal).  Al igual que los generadores de números pseudoaleatorios, las permutaciones aleatorias, o más bien sus familias, parametrizadas por la clave, pueden ser criptográficamente fuertes; esto es exactamente lo que necesitamos para convertir los datos.  Aunque puede haber detalles obvios.  Por ejemplo, parece que el cifrado criptográficamente fuerte de N bytes a N bytes con una clave prefijada y un vector de inicialización puede usarse como una permutación pseudoaleatoria de muchas cadenas de N bytes.  De hecho, tal transformación es uno a uno y parece aleatoria.  Pero si usamos la misma transformación para todos nuestros datos, entonces el resultado puede estar sujeto a análisis, porque el mismo vector de inicialización y los valores clave se usan varias veces.  Esto es similar al modo de cifrado de bloque del <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Libro de códigos electrónico</a> . <br><br>  ¿Cuáles son las formas de obtener una permutación pseudoaleatoria?  Puede tomar transformaciones simples uno a uno y ensamblar una función bastante compleja a partir de ellas que se verá aleatoria.  Permíteme darte un ejemplo de algunas de mis transformaciones individuales favoritas: <br><br><ul><li>  multiplicación por un número impar (por ejemplo, un primo grande) en aritmética del complemento a dos, </li><li>  xor-shift: <code>x ^= x &gt;&gt; N</code> , </li><li>  CRC-N, donde N es el número de bits del argumento. </li></ul><br>  Entonces, por ejemplo, a partir de tres multiplicaciones y dos operaciones xor-shift, se <a href="">ensambla el</a> finalizador <a href="">murmurhash</a> .  Esta operación es una permutación pseudoaleatoria.  Pero por si acaso, observo que las funciones hash, incluso N bits en N bits, no tienen que ser mutuamente únicas. <br><br>  O aquí hay otro <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ejemplo</a> interesante <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">de la teoría de números elementales</a> del sitio de Jeff Preshing. <br><br>  ¿Cómo podemos usar permutaciones pseudoaleatorias para nuestra tarea?  Puede convertir todos los campos numéricos usándolos.  Entonces será posible preservar todas las cardinalidades y cardinalidades mutuas de todas las combinaciones de campos.  Es decir, COUNT (DISTINCT) devolverá el mismo valor que antes de la conversión, y con cualquier GROUP BY. <br><br>  Vale la pena señalar que la preservación de todas las cardinalidades es ligeramente contraria a la declaración del problema del anonimato de datos. ,  ,         ,      10  ,        .           10   —   ,    .    ,    ,     ,         — ,    ,    .       . ,    ,         ,     Google,       ,  -          Google.       — ,      ,          ( )     ( ).  ,        ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="></a> . <br><br>           ,      . ,       10,        .   ? <br><br> ,       size classes         (  ).       size class        ,    .  0  1    .  2  3   1/2        1/2      .   1024..2047     1024! () .  Y así sucesivamente.        . <br><br>  ,     . ,      -.    ,      . <br><br>       ,     ,      ,             . <br><br>    —             ,       .   .            .   Fabien Sanglard   c <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Hackers News</a> ,      .      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">    Redis</a> —  .    ,            <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="> </a> . <br><br>     .   —  ,        . ,   . <br><br><ol><li>      : <br> <code>arg: xxxxyyyy <br> <font color="#0fc000">arg_l</font> : xxxx <br> <font color="#0000ff">arg_r</font> : yyyy</code> </li> <li>      .      xor        : <br> <code>res: yyyyzzzz <br> <font color="#0000ff">res_l</font> = yyyy = <font color="#0000ff">arg_r</font> <br> <font color="#FF6600">res_r</font> = zzzz = <font color="#0fc000">arg_l</font> ^ F( <font color="#0000ff">arg_r</font> )</code> </li> </ol><br>   ,     F            4 ,      . <br><br>   :  ,       ,      —      ,       ,     ! <br><br>         .  ,    ,      ,    .     : <br><br><ul><li>     ,  ,  Electronic Codebook mode of operation; </li><li>        (  )   ,     ,      . </li></ul><br>           . ,     LZ4     ,             ,        . <br><br><h2>   </h2><br>    ,  ,  ,         .   —     .  , ,      ,    .                ( ,    ).          ? <br><br> -,         : ,  256^10     10 ,      ,          . -,      ,     . <br><br>        ,      . ,    ,       .    ,       .    ,   -   . <br><br>             ,       —  ,     N   . N —   . , N = 5,       «»   «».       Order-N. <br><br> <code>P( <font color="#ff0000"></font> | ) = 0.9 <br> P( <font color="#ff0000"></font> | ) = 0.05 <br> P( <font color="#ff0000"></font> | ) = 0.01 <br> ...</code> <br> <br>         <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">.</a> ( vesna.yandex.ru).      LSTM,           N,    ,  .          —           ,    .  :      ,  ,      . <br><br>   Title: <br><br><blockquote>   — . —     ,   .   ,   ,      — .@Mail.Ru —   — -    . ) — AUTO.ria.ua        </blockquote><br> ,       ,          .       () ,           —   .        0  N,         N    N − 1). <br><br>       . ,      123456   URL,          .                    .      -.       .      ,    . <br><br>   :         URL,        ,   -. : <code>https://www.yandex.ru/images/cats/?id=xxxxxx</code> .  ,      URL,      ,   . : <code>http://ftp.google.kz/cgi-bin/index.phtml?item=xxxxxx</code> .                  -     ,      8    . <br><br> <code>https://www.yandex.ru/ <font color="#0fc000">images/c</font> ats/?id=12345 <br> ^^^^^^^^ <br> <br> distribution: [aaaa][b][cc][dddd][e][ff][g <font color="#ff0000">g</font> ggg][h]... <br> hash(" <font color="#0fc000">images/c</font> ") % total_count:           ^ <br> <br></code> <code>http://ftp.google.kz/c <font color="#ff0000">g</font> ...</code> <br> <br>    ,  .     : <br><br><blockquote><pre> -        | . -    <font></font>
-  — .:      Lore - dfghf — . -   )  473682  -  <font></font>
- !   »  -  —      <font></font>
- !   » , <font></font>
-  .  c      @Mail.Ru - <font></font>
-     ,  2010 |  . <font></font>
- !    : 820 0000 .,    -<font></font>
-   - DoramaTv.ru -   . -  ..    <font></font>
-  .  2013 ,       -&gt;  80 .<font></font>
-  -    (.    , ,  <font></font>
-   . 5, 69,  W* - ., ,      World of Tanks<font></font>
- ,     . 2     @Mail.Ru<font></font>
-      ,  .   <font></font>
</pre></blockquote><br><h2>  Resultado </h2><br>        ,     - ,        -   .          ,  .      clickhouse obfuscator,     :          (, CSV, JSONEachRow),        (   )    ( ,       ).         . <br><br>     clickhouse-client,         Linux.        ,   ClickHouse. ,         MySQL  PostgreSQL ,        . <br><br> <code>clickhouse obfuscator \ <br> --seed "$(head -c16 /dev/urandom | base64)" \ <br> --input-format TSV --output-format TSV \ <br> --structure 'CounterID UInt32, URLDomain String, \ <br> URL String, SearchPhrase String, Title String' \ <br> &lt; table.tsv &gt; result.tsv <br> <br> clickhouse obfuscator --help <br></code> <br>    ,        .     ,   ?      ,        ,    .        ,    ,      .   ,     (  <code>--help</code> )   . <br><br>     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">   </a> ,        . <br><br> <a href="">clickhouse-datasets.s3.yandex.net/hits/tsv/hits_v1.tsv.xz</a> <br> <a href="">clickhouse-datasets.s3.yandex.net/visits/tsv/visits_v1.tsv.xz</a> <br><br>                ClickHouse.          ,       ClickHouse  . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/457354/">https://habr.com/ru/post/457354/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../457340/index.html">10 complementos PostCSS que le ahorrarán tiempo de diseño</a></li>
<li><a href="../457342/index.html">Señales desde arriba: cómo salvamos a los cartógrafos del trabajo innecesario y los ojos rojos</a></li>
<li><a href="../457348/index.html">Implementación en PythonAnywhere desde GitHub</a></li>
<li><a href="../457350/index.html">¿Por qué el osciloscopio necesita soporte de criptografía?</a></li>
<li><a href="../457352/index.html">Conclusión de la información en la pantalla del comprador.</a></li>
<li><a href="../457362/index.html">Promoción de RUVDS: prepara el servidor en verano</a></li>
<li><a href="../457366/index.html">Un fanático, una pieza de hierro o un espectador: ¿qué tipo de jugador eres?</a></li>
<li><a href="../457374/index.html">Reduce el tiempo de construcción de tus proyectos de Android</a></li>
<li><a href="../457378/index.html">Cómo id Software creó Wolfenstein 3D basado en tecnología de Commander Keen</a></li>
<li><a href="../457380/index.html">OpenGL ultramoderno. Parte 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>