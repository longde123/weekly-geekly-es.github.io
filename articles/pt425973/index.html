<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§ë üë®üèæ‚Äçü§ù‚Äçüë®üèΩ üé† Como criamos o armazenamento do S3 DataLine. Experimentos, testes e um pouco sobre hipop√≥tamos üïë üë©üèø‚Äçüåæ üåì</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√° novamente, Alexey Pristavko est√° em contato, e esta √© a segunda parte da minha hist√≥ria sobre o DataLine de armazenamento de objetos S3 baseado no...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como criamos o armazenamento do S3 DataLine. Experimentos, testes e um pouco sobre hipop√≥tamos</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dataline/blog/425973/"><img src="https://habrastorage.org/webt/0k/od/i7/0kodi796iwhoi16frktb7mytx_4.png"><br><br>  Ol√° novamente, Alexey Pristavko est√° em contato, e esta √© a segunda parte da minha hist√≥ria sobre o DataLine de armazenamento de objetos S3 baseado no Cloudian HyperStore. <br><br>  Hoje vou falar detalhadamente sobre como nosso armazenamento S3 √© organizado e quais dificuldades encontramos no processo de cria√ß√£o.  Certifique-se de tocar no t√≥pico ‚Äúferro‚Äù e analisar o equipamento no qual acabamos ficando. <br><br>  Vamos l√°! <br><a name="habracut"></a><br>  Se, durante a leitura, voc√™ deseja se familiarizar com a arquitetura de aplicativos da solu√ß√£o Cloudian, encontrar√° sua an√°lise detalhada no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">artigo anterior</a> .  Aqui discutimos em detalhes o dispositivo interno Cloudian, a toler√¢ncia a falhas e a l√≥gica do SDS embutido. <br><br><h2>  O esquema final do equipamento f√≠sico </h2><br>  Como mais tarde falaremos sobre o nosso "tormento de escolha", darei imediatamente a lista final de ferro a que chegamos.  Pequeno aviso: a escolha do equipamento de rede deveu-se em grande parte √† sua presen√ßa em nosso (a prop√≥sito, muito s√≥lido) armaz√©m. <br><br>  Portanto, no n√≠vel f√≠sico do armazenamento, temos o seguinte equipamento: <br><table><tbody><tr><td>  <b>Nome</b> <br></td><td>  <b>Fun√ß√£o</b> <br></td><td>  <b>Configura√ß√£o</b> <br></td><td>  <b>Qtde</b> <br></td></tr><tr><td>  Servidor Lenovo System x3650 M5 <br></td><td>  N√≥ de trabalho <br></td><td>  1x Xeon E5-2630v4 2.2GHz, <br>  4x DDR4 de 16 GB, <br>  14x 10 TB 7.2K 6Gbps SATA 3.5 ", <br>  2x SSD de 480 GB, <br>  Intel x520 de porta dupla 10GbE SFP +, <br>  PSU HS de 2x750W <br></td><td>  4 <br></td></tr><tr><td>  Servidor HP ProLiant DL360 G9 <br></td><td>  N√≥ do balanceador de carga <br></td><td>  2 E5-2620 v3, <br>  128G RAM, <br>  2 SSD de 600 GB, <br>  4 SAS HDD, <br>  SFP + 10GbE de porta dupla Intel x520 <br></td><td>  2 <br></td></tr><tr><td>  Switch Cisco C4500 <br></td><td>  Gateway de fronteira <br></td><td>  Catalisador WS-C4500X-16SFP + <br></td><td>  2 <br></td></tr><tr><td>  Switch Cisco C3750 <br></td><td>  Extensor de porta <br></td><td>  Catalisador WS-C3750X-24T com C3KX-NM-10G <br></td><td>  2 <br></td></tr><tr><td>  Switch Cisco C2960 <br></td><td>  plano de controle <br></td><td>  Catalisador WS-C2960 + 48PST-L <br></td><td>  1 <br></td></tr></tbody></table><br>  Para uma melhor compreens√£o da arquitetura, examinaremos todos os elementos e falaremos sobre seus recursos e tarefas. <br><br>  Vamos come√ßar com os servidores.  Os servidores Lenovo t√™m uma configura√ß√£o especial implementada em conjunto e em total conformidade com as recomenda√ß√µes e especifica√ß√µes da Cloudian.  Por exemplo, eles usam um controlador com acesso direto ao disco.  Como no nosso caso, o RAID √© organizado no n√≠vel do software aplicativo, esse modo aumenta a confiabilidade e acelera o subsistema de disco.  Exatamente os mesmos servidores podem ser adquiridos como um Cloudian Appliance junto com todas as licen√ßas. <br><br>  Os servidores de balanceamento de carga com o Nginx for CentOS garantem uma distribui√ß√£o de carga uniforme nos n√≥s de trabalho e abstraem o usu√°rio da organiza√ß√£o de tr√°fego interno.  E como um b√¥nus agrad√°vel - se necess√°rio, voc√™ pode organizar um cache neles. <br><br>  O par Cisco 4500X dezesseis 10 GB SFP + serve como o n√∫cleo e a fronteira de nossa pequena, mas orgulhosa rede de armazenamento.  Obviamente, o ferro √© um pouco antiquado, mas n√£o √© inferior ao ‚Äúnovo‚Äù em confiabilidade, possui redund√¢ncia interna e sua funcionalidade atende a todos os nossos requisitos.  C3750 desempenha o papel de extensor de f√°brica, n√£o h√° necessidade de empurrar transceptores 1G em slots 10G.  E mudar completamente para links de 10 GB tamb√©m n√£o faz muito sentido ainda.  Como os testes demonstraram, encontramos o processador e os discos anteriormente. <br><br>  O diagrama abaixo ilustra com detalhes suficientes a organiza√ß√£o f√≠sica descrita por mim: <br><br><img src="https://habrastorage.org/webt/jj/cs/mr/jjcsmrwqvzkqrder_z9zv3pr4ca.jpeg">  <i>1. Esquema da organiza√ß√£o de armazenamento f√≠sico</i> <br><br>  Vamos seguir o esquema.  Como voc√™ pode ver, a toler√¢ncia a falhas no n√≠vel f√≠sico √© realizada duplicando e conectando cada um dos dispositivos com pelo menos dois links √≥pticos, um para cada dispositivo em um par.  Isso nos garante a manuten√ß√£o da conectividade f√≠sica no circuito durante um acidente de qualquer dispositivo de rede ou dois dispositivos de pares diferentes ao mesmo tempo. <br><br>  Vamos abaixo do esquema.  Os dois pares da Cisco (4500/4500, 3750/3750) s√£o combinados em um √∫nico dispositivo l√≥gico usando a pilha e o VSS.  A pilha √© montada com dois cabos, VSS atrav√©s de tr√™s links √≥pticos de 10G.  Isso permite garantir que os dois dispositivos de cada par interajam como um todo.  Esse agrupamento nos permite trabalhar na estrutura de um segmento L2 transparente por meio de ambos os dispositivos de um par e fazer agrega√ß√£o geral de links usando o LACP, uma vez que essa tecnologia √© suportada nativamente pelo SO do servidor e pelo Cisco IOS.  Do lado do servidor, parece que ele est√° trabalhando com um switch em vez de dois e, acima do aplicativo, h√° um canal agregado de capacidade dupla. <br><br>  Todo o equipamento de rede que alterna entre si e para os canais de entrada √© feito usando links 10G √≥pticos, o equipamento para servidor √© conectado usando cabos 10G Twinax Cisco e cobre 1G. <br><br>  O BGP √© usado para toler√¢ncia a falhas no canal de entrada e o Round Robin DNS √© usado para equilibrar entre endere√ßos IP externos.  Os pr√≥prios endere√ßos externos est√£o estacionados nos servidores de balanceamento de carga e, se necess√°rio, migram entre os n√≥s usando o pacote Pacemaker / Corosync. <br><br>  O monitoramento e controle via IPMI s√£o realizados atrav√©s de um link interno direto.  Todas as interfaces de gerenciamento (servidores e Cisco) s√£o conectadas atrav√©s de comutadores de plano de controle separados.  Eles, por sua vez, est√£o inclu√≠dos na rede de controle do data center.  Isso nos garante a impossibilidade de perder a comunica√ß√£o com o equipamento durante o trabalho ou como resultado de um acidente em uma rede externa.  Para o caso mais extremo, h√° atendentes na KVM. <br><br><h2>  Rede l√≥gica </h2><br>  Para entender como funciona a rede l√≥gica S3 do armazenamento DataLine, passemos para outro esquema: <br><br><img src="https://habrastorage.org/webt/lp/zn/ub/lpznubpzqosgkhzts8tm7sp0ssi.png"><br>  <i>2. Diagrama de rede l√≥gica de armazenamento</i> <br><br>  Como voc√™ pode ver, a l√≥gica da rede consiste em v√°rios segmentos. <br><br>  Uma rede externa (Q) com capacidade total de 20G √© conectada diretamente ao Provider Edge.  Isto √© seguido pelo Cisco 4500 e balanceadores. <br><br>  O pr√≥ximo bloco l√≥gico (X) √© a VLAN entre os balanceadores e os n√≥s de trabalho.  Os balanceadores usam a mesma conex√£o que para o tr√°fego recebido.  Os n√≥s de trabalho s√£o conectados via pilha 3750 com 4 links 1G (dois para cada 3750).  Todos os links f√≠sicos s√£o montados em um √∫nico l√≥gico usando o LACP tamb√©m.  Essa rede √© usada apenas para processar o tr√°fego do cliente. <br><br>  Todas as conex√µes no cluster Cloudian (Y) passam por um terceiro segmento l√≥gico constru√≠do sobre o 10G.  Essa organiza√ß√£o ajuda a evitar problemas no canal externo devido ao tr√°fego interno e vice-versa.  Este √© um segmento extremamente carregado e importante para a opera√ß√£o do cluster.  √â atrav√©s dele que dados e metadados s√£o replicados, usados ‚Äã‚Äãpor quaisquer procedimentos de reequil√≠brio etc., portanto, distinguimos sua ‚Äúimpossibilidade de afundar‚Äù como uma tarefa separada. <br><br><h2>  Um pouco de beleza </h2><br>  √â assim que tudo se parece: <br><br><img src="https://habrastorage.org/webt/_m/_1/sd/_m_1sd2pvc2h5nbt2wco5bdkl4s.png"><br>  <i>3. Equipamento de rede e balanceadores completos</i> <br><br><img src="https://habrastorage.org/webt/xo/q0/e4/xoq0e4outgmbcgswdzb4uzs4bsg.png"><br>  <i>4. A mesma vista traseira</i> <br><br>  Preste aten√ß√£o √† mudan√ßa.  Em artigos anteriores, meus colegas escreveram sobre a import√¢ncia dos cabos de marca√ß√£o de cores, mas n√£o ser√° fora do lugar abordar esse t√≥pico aqui. <br><br>  Usamos a troca de cores n√£o apenas para a rede, mas tamb√©m para energia.  Isso permite que nossos engenheiros naveguem rapidamente no rack e reduz a influ√™ncia do fator humano durante a troca. <br><br><img src="https://habrastorage.org/webt/uu/8x/tw/uu8xtwvqpdcvw45xlugyfysq5is.png"><br>  <i>5. N√≥s de trabalho</i> <br><br><img src="https://habrastorage.org/webt/wl/gn/5g/wlgn5gc7cttpbkra7cpmnza_pdo.png"><br>  <i>6. Vista traseira</i> <br><br>  Nesta foto, voc√™ pode ver claramente como os servidores em funcionamento est√£o cheios de discos - praticamente n√£o h√° slots vazios nem na parte de tr√°s.  A prop√≥sito, essa organiza√ß√£o de cabos em feixes compactos desempenha n√£o apenas uma fun√ß√£o est√©tica, mas tamb√©m evita a sobreposi√ß√£o de ventiladores de fontes de alimenta√ß√£o, poupando ferro do superaquecimento. <br><br><h3>  Lista de permiss√µes </h3><br>  Nos coment√°rios do √∫ltimo artigo, prometi falar mais sobre o dispositivo da lista de permiss√µes. <br><br>  Se, por algum motivo, concordamos com o cliente em excluir das contas todo o trabalho com armazenamento do interior do datacenter ou atrav√©s de canais diretos para o equipamento, precisamos organizar uma conex√£o privada com o armazenamento. <br><br>  Lembre-se, no primeiro diagrama, havia um ramo no DIST e no Cloud?  Al√©m do principal canal da Internet de 20Gb, usamos um canal agregado para comutadores, ao qual conectamos todos os clientes no n√≠vel do datacenter.  Se o cliente desejar um link direto para o armazenamento, podemos configurar a VLAN do cliente para o nosso 4500X com a constru√ß√£o de uma rota separada (ou sem ela) e iniciar o L3.  Depois disso, a liga√ß√£o ao plano tarif√°rio √© configurada nos endere√ßos do cliente j√° no pr√≥prio Cloudian.  Ent√£o, para todos os que est√£o conectados a esse plano tarif√°rio, o uso do S3 nos endere√ßos da lista de permiss√µes n√£o ser√° considerado. <br><br><img src="https://habrastorage.org/webt/mr/nc/yd/mrncyda-0oquwo4kpos3snsyp2e.png"><br>  <i>7. E aqui est√° uma interface especial no Cloudian.</i> <br><br>  Agora n√£o temos essa tarifa na rede, mas se voc√™ realmente quiser, podemos fornec√™-la. <br><br><h2>  Hist√≥ria da constru√ß√£o </h2><br>  Estamos gradualmente nos aproximando da parte mais interessante da hist√≥ria - a constru√ß√£o de uma instala√ß√£o de armazenamento.  Haver√° muitas fotos, at√© tr√™s tentativas de organizar o balanceamento de tr√°fego e algumas dicas ruins.  Espero que a an√°lise dos problemas que encontramos no caminho seja √∫til para aqueles que est√£o se preparando para trabalhar com velocidades de 10Gb + na web. <br><br><h3>  Experimentando 10G </h3><br>  Antes de ir diretamente para a ess√™ncia desta se√ß√£o, permito-me fazer outro pequeno aviso. <br><br>  De acordo com uma tradi√ß√£o estabelecida, antes de comprar novos equipamentos auxiliares, vamos ao armaz√©m e selecionamos componentes mais ou menos adequados.  Isso permite que voc√™ realize testes rapidamente e decida uma lista de compras futura.  Obviamente, enquanto n√£o estamos alcan√ßando um resultado 100% confi√°vel, nada √© gasto na produtividade. <br><br>  Ent√£o foi dessa vez.  E se a Cisco n√£o lan√ßou nenhuma surpresa, ent√£o os balanceadores de carga "gan√¢ncia" quase nos arruinaram. <br><br><h4>  A primeira experi√™ncia.  Servidores Supermicro </h4><br>  Aqui, ficamos decepcionados com o desejo de realizar um teste r√°pido com custo m√≠nimo.  No armaz√©m, encontramos servidores Supermicro com tudo bem, exceto pela falta de interfaces SFP.  Decidimos instalar o nosso amado Intel 520DA2 neles e enfrentamos imediatamente o primeiro problema: as m√°quinas s√£o de unidade √∫nica, mas n√£o h√° risers.  Ao mesmo tempo, por algum motivo, nosso corpo n√£o estava em listas de compatibilidade, mas havia muitos risers nativos. <br><br>  A conselho do diretor de desenvolvimento inovador, Misha Solovyov, conectamos tudo com risers flex√≠veis para fazendas de minera√ß√£o.  O resultado foi um "cad√°ver": <br><br><img src="https://habrastorage.org/webt/lf/wx/t6/lfwxt6csco5ndrm--6qzy4kqfhi.png"><br>  <i>8. Prot√≥tipo n¬∫ 1</i> <br><br>  Eu tive que usar a famosa fita el√©trica azul em alguns lugares, para que, Deus me livre, fa√ßa qualquer coisa curta.  Sim, a fazenda coletiva.  Sim, envergonhado.  Mas essa "configura√ß√£o" √© bastante aceit√°vel para o per√≠odo do experimento. <br><br><img src="https://habrastorage.org/webt/sp/to/af/sptoaf-lv4w_imfhvnro9i12f1y.png"><br>  <i>9. Vista traseira</i> <br><br>  O que veio disso √© claramente vis√≠vel na captura de tela do iperf: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/494/311/900/494311900ac9a09852f260ebbfb4e4b8.png"><br>  <i>10. Na verdade, isso n√£o √© uma captura de tela :)</i> <br><br>  As m√©tricas s√£o muito interessantes, certo?  Ent√£o ficamos tristes.  A princ√≠pio, pensamos em chips espi√µes, desmontamos e ajeitamos tudo. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/082/bb2/6ac/082bb26ac22d6de01f22f464b778314b.png"><br>  <i>11. √Ä primeira vista, n√£o h√° chips de espionagem aqui</i> <br><br>  Eles recordaram o curso da f√≠sica: interfer√™ncia eletromagn√©tica, sinais de alta frequ√™ncia, etc. ... √â claro que continuar o experimento com uma quantidade e qualidade dessa "fazenda coletiva" n√£o fazia sentido.  Finalmente, desmontamos o sistema e colocamos os servidores de volta no lugar. <br><br><h4>  A segunda experi√™ncia.  Citrix Netscaler MPX8005 </h4><br>  No processo de devolu√ß√£o dos servidores ao local, encontramos novos her√≥is: Citrix Netscaler MPX8005.  Al√©m disso, este √© um ferro de marca maravilhoso, quase nunca usado.  Eles se parecem com isso: <br><br><img src="https://habrastorage.org/webt/dq/v1/va/dqv1vawcvfgpmmijwrie29ewkgy.png"><br>  <i>12. O slide no rack n√£o cabia no comprimento, mas n√≥s, vision√°rios, decidimos adi√°-lo para mais tarde</i> <br><br>  Equipamento colocado em um rack, comutado e configurado.  Estes s√£o realmente excelentes peda√ßos de ferro ‚Äúadultos‚Äù, 2 slots SFP para 10 GB cada, HA, algoritmos avan√ßados, h√° at√© L7.  √â verdade, at√© 5 gigabits sob licen√ßa, mas ainda usamos L3, mas n√£o existem limites. <br><br>  Dedos cruzados, teste.  N√£o h√° velocidade.  Nas interfaces - erros s√≥lidos sobre transceptores inadequados, velocidade de cerca de 5 gigabits, quedas constantes.  Lembraram-se dos tirantes flex√≠veis, ficaram tristes novamente.  Mesmo l√°, a velocidade era maior e menos erros.  Come√ßamos a entender: <br><br><pre><code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">show</span></span> channel LA/<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>)  Interface LA/<span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-number"><span class="hljs-number">802.3</span></span>ad Link <span class="hljs-keyword"><span class="hljs-keyword">Aggregate</span></span>) #<span class="hljs-number"><span class="hljs-number">10</span></span>  flags=<span class="hljs-number"><span class="hljs-number">0x4100c020</span></span> &lt;ENABLED, UP, <span class="hljs-keyword"><span class="hljs-keyword">AGGREGATE</span></span>, UP, HAMON, HEARTBEAT, <span class="hljs-number"><span class="hljs-number">802.1</span></span>q&gt;  MTU=<span class="hljs-number"><span class="hljs-number">9000</span></span>, native vlan=<span class="hljs-number"><span class="hljs-number">1</span></span>, MAC=XXX, uptime <span class="hljs-number"><span class="hljs-number">0</span></span>h03m23s  Requested: media <span class="hljs-keyword"><span class="hljs-keyword">NONE</span></span>, speed AUTO, duplex <span class="hljs-keyword"><span class="hljs-keyword">NONE</span></span>, fctl <span class="hljs-keyword"><span class="hljs-keyword">NONE</span></span>,        throughput <span class="hljs-number"><span class="hljs-number">160000</span></span>  Link Redundancy Throughput <span class="hljs-number"><span class="hljs-number">80000</span></span>  Actual: throughput <span class="hljs-number"><span class="hljs-number">20000</span></span>  LLDP Mode: <span class="hljs-keyword"><span class="hljs-keyword">NONE</span></span>  RX: Pkts(<span class="hljs-number"><span class="hljs-number">9388</span></span>) Bytes(<span class="hljs-number"><span class="hljs-number">557582</span></span>) Errs(<span class="hljs-number"><span class="hljs-number">0</span></span>) Drops(<span class="hljs-number"><span class="hljs-number">1225</span></span>) Stalls(<span class="hljs-number"><span class="hljs-number">0</span></span>)  TX: Pkts(<span class="hljs-number"><span class="hljs-number">10514</span></span>) Bytes(<span class="hljs-number"><span class="hljs-number">574232</span></span>) Errs(<span class="hljs-number"><span class="hljs-number">0</span></span>) Drops(<span class="hljs-number"><span class="hljs-number">0</span></span>) Stalls(<span class="hljs-number"><span class="hljs-number">0</span></span>)  NIC: InDisc(<span class="hljs-number"><span class="hljs-number">0</span></span>) OutDisc(<span class="hljs-number"><span class="hljs-number">0</span></span>) Fctls(<span class="hljs-number"><span class="hljs-number">0</span></span>) Stalls(<span class="hljs-number"><span class="hljs-number">0</span></span>) Hangs(<span class="hljs-number"><span class="hljs-number">0</span></span>) Muted(<span class="hljs-number"><span class="hljs-number">0</span></span>)  bandwidthHigh: <span class="hljs-number"><span class="hljs-number">160000</span></span> Mbits/sec, bandwidthNormal: <span class="hljs-number"><span class="hljs-number">160000</span></span> Mbits/sec.  LA mode: AUTO &gt; <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> interface <span class="hljs-number"><span class="hljs-number">10</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>)  Interface <span class="hljs-number"><span class="hljs-number">10</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-number"><span class="hljs-number">10</span></span>G Ethernet, unsupported fiber SFP+, <span class="hljs-number"><span class="hljs-number">10</span></span> Gbit) #<span class="hljs-number"><span class="hljs-number">1</span></span>  flags=<span class="hljs-number"><span class="hljs-number">0x400c020</span></span> &lt;ENABLED, UP, BOUND <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> LA/<span class="hljs-number"><span class="hljs-number">1</span></span>, UP, autoneg, <span class="hljs-number"><span class="hljs-number">802.1</span></span>q&gt;  LACP &lt;Active, Long timeout, key <span class="hljs-number"><span class="hljs-number">1</span></span>, priority <span class="hljs-number"><span class="hljs-number">32768</span></span>&gt;  MTU=<span class="hljs-number"><span class="hljs-number">9000</span></span>, MAC=XXX, uptime <span class="hljs-number"><span class="hljs-number">0</span></span>h05m44s  Requested: media AUTO, speed AUTO, duplex AUTO, fctl <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>,        throughput <span class="hljs-number"><span class="hljs-number">0</span></span>  Actual: media FIBER, speed <span class="hljs-number"><span class="hljs-number">10000</span></span>, duplex <span class="hljs-keyword"><span class="hljs-keyword">FULL</span></span>, fctl <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, throughput <span class="hljs-number"><span class="hljs-number">10000</span></span>  LLDP Mode: TRANSCEIVER,    LR Priority: <span class="hljs-number"><span class="hljs-number">1024</span></span>  RX: Pkts(<span class="hljs-number"><span class="hljs-number">8921</span></span>) Bytes(<span class="hljs-number"><span class="hljs-number">517626</span></span>) Errs(<span class="hljs-number"><span class="hljs-number">0</span></span>) Drops(<span class="hljs-number"><span class="hljs-number">585</span></span>) Stalls(<span class="hljs-number"><span class="hljs-number">0</span></span>)  TX: Pkts(<span class="hljs-number"><span class="hljs-number">9884</span></span>) Bytes(<span class="hljs-number"><span class="hljs-number">545408</span></span>) Errs(<span class="hljs-number"><span class="hljs-number">0</span></span>) Drops(<span class="hljs-number"><span class="hljs-number">3</span></span>) Stalls(<span class="hljs-number"><span class="hljs-number">0</span></span>)  NIC: InDisc(<span class="hljs-number"><span class="hljs-number">0</span></span>) OutDisc(<span class="hljs-number"><span class="hljs-number">0</span></span>) Fctls(<span class="hljs-number"><span class="hljs-number">0</span></span>) Stalls(<span class="hljs-number"><span class="hljs-number">0</span></span>) Hangs(<span class="hljs-number"><span class="hljs-number">0</span></span>) Muted(<span class="hljs-number"><span class="hljs-number">0</span></span>)  Bandwidth thresholds are <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>. &gt; <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> interface <span class="hljs-number"><span class="hljs-number">10</span></span>/<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>)  Interface <span class="hljs-number"><span class="hljs-number">10</span></span>/<span class="hljs-number"><span class="hljs-number">2</span></span> (<span class="hljs-number"><span class="hljs-number">10</span></span>G Ethernet, unsupported fiber SFP+, <span class="hljs-number"><span class="hljs-number">10</span></span> Gbit) #<span class="hljs-number"><span class="hljs-number">0</span></span>  flags=<span class="hljs-number"><span class="hljs-number">0x400c020</span></span> &lt;ENABLED, UP, BOUND <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> LA/<span class="hljs-number"><span class="hljs-number">1</span></span>, UP, autoneg, <span class="hljs-number"><span class="hljs-number">802.1</span></span>q&gt;  LACP &lt;Active, Long timeout, key <span class="hljs-number"><span class="hljs-number">1</span></span>, priority <span class="hljs-number"><span class="hljs-number">32768</span></span>&gt;  MTU=<span class="hljs-number"><span class="hljs-number">9000</span></span>, MAC=XXX, uptime <span class="hljs-number"><span class="hljs-number">0</span></span>h05m58s  Requested: media AUTO, speed AUTO, duplex AUTO, fctl <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>,        throughput <span class="hljs-number"><span class="hljs-number">0</span></span>  Actual: media FIBER, speed <span class="hljs-number"><span class="hljs-number">10000</span></span>, duplex <span class="hljs-keyword"><span class="hljs-keyword">FULL</span></span>, fctl <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, throughput <span class="hljs-number"><span class="hljs-number">10000</span></span>  LLDP Mode: TRANSCEIVER,    LR Priority: <span class="hljs-number"><span class="hljs-number">1024</span></span>  RX: Pkts(<span class="hljs-number"><span class="hljs-number">8944</span></span>) Bytes(<span class="hljs-number"><span class="hljs-number">530975</span></span>) Errs(<span class="hljs-number"><span class="hljs-number">0</span></span>) Drops(<span class="hljs-number"><span class="hljs-number">911</span></span>) Stalls(<span class="hljs-number"><span class="hljs-number">0</span></span>)  TX: Pkts(<span class="hljs-number"><span class="hljs-number">10819</span></span>) Bytes(<span class="hljs-number"><span class="hljs-number">785347</span></span>) Errs(<span class="hljs-number"><span class="hljs-number">0</span></span>) Drops(<span class="hljs-number"><span class="hljs-number">3</span></span>) Stalls(<span class="hljs-number"><span class="hljs-number">0</span></span>)  NIC: InDisc(<span class="hljs-number"><span class="hljs-number">0</span></span>) OutDisc(<span class="hljs-number"><span class="hljs-number">0</span></span>) Fctls(<span class="hljs-number"><span class="hljs-number">0</span></span>) Stalls(<span class="hljs-number"><span class="hljs-number">0</span></span>) Hangs(<span class="hljs-number"><span class="hljs-number">0</span></span>) Muted(<span class="hljs-number"><span class="hljs-number">0</span></span>)  Bandwidth thresholds are <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>.</code> </pre> <br><br>  Usamos transceptores nativos da Cisco, com os quais, em teoria, n√£o devem surgir problemas.  Eles at√© checaram a √≥tica e, por precau√ß√£o, mudaram os transceptores - a mesma imagem.  Nosso carro n√£o vai, e √© isso!  N√≥s olhamos mais de perto. <br><br>  Transceptores Cisco "bonitos": <br><br><pre> <code class="hljs vhdl">ix1: &lt;Intel(R) PRO/<span class="hljs-number"><span class="hljs-number">10</span></span>GbE PCI-Express Network Driver, Version - <span class="hljs-number"><span class="hljs-number">2.7</span></span>.<span class="hljs-number"><span class="hljs-number">4</span></span>&gt; <span class="hljs-keyword"><span class="hljs-keyword">port</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>xe000-<span class="hljs-number"><span class="hljs-number">0</span></span>xe01f mem <span class="hljs-number"><span class="hljs-number">0</span></span>xf7800000-<span class="hljs-number"><span class="hljs-number">0</span></span>xf781ffff,<span class="hljs-number"><span class="hljs-number">0</span></span>xf7840000-<span class="hljs-number"><span class="hljs-number">0</span></span>xf7843fff irq <span class="hljs-number"><span class="hljs-number">17</span></span> at device <span class="hljs-number"><span class="hljs-number">0.1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> pci1 ix1: ixgbe <span class="hljs-keyword"><span class="hljs-keyword">bus</span></span> speed = <span class="hljs-number"><span class="hljs-number">5.0</span></span>Gbps <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> PCIe lane <span class="hljs-literal"><span class="hljs-literal">width</span></span> = <span class="hljs-number"><span class="hljs-number">8</span></span> SFP+/SFP, vendor CISCO-AVAGO , part number XXX , <span class="hljs-number"><span class="hljs-number">10</span></span>G <span class="hljs-number"><span class="hljs-number">0</span></span>x10 <span class="hljs-number"><span class="hljs-number">1</span></span>G <span class="hljs-number"><span class="hljs-number">0</span></span>x00 CT <span class="hljs-number"><span class="hljs-number">0</span></span>x00 *** Unsupported SFP+/SFP <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>!</code> </pre> <br><br>  Os transceptores n√£o s√£o detectados normalmente, sem suporte! <br><br>  Eu tive que encontrar a maioria dos "parentes": <br><br><img src="https://habrastorage.org/webt/wi/-i/sw/wi-iswj9672s8q0skvpw4s3s2xw.png"><br>  <i>13. Os transceptores mais nativos do oeste selvagem</i> <br><br><pre> <code class="hljs powershell">ix0: &lt;Intel(R) PRO/<span class="hljs-number"><span class="hljs-number">10</span></span>GbE PCI<span class="hljs-literal"><span class="hljs-literal">-Express</span></span> Network Driver, Version - <span class="hljs-number"><span class="hljs-number">2.7</span></span>.<span class="hljs-number"><span class="hljs-number">4</span></span>&gt; port <span class="hljs-number"><span class="hljs-number">0</span></span>xe020<span class="hljs-literal"><span class="hljs-literal">-0xe03f</span></span> mem <span class="hljs-number"><span class="hljs-number">0</span></span>xf7820000<span class="hljs-literal"><span class="hljs-literal">-0xf783ffff</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>xf7844000<span class="hljs-literal"><span class="hljs-literal">-0xf7847fff</span></span> irq <span class="hljs-number"><span class="hljs-number">16</span></span> at device <span class="hljs-number"><span class="hljs-number">0.0</span></span> on pci1 platform: Manufacturer Citrix Inc. platform: NSMPX<span class="hljs-literal"><span class="hljs-literal">-8000</span></span><span class="hljs-literal"><span class="hljs-literal">-10G</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>*CPU+<span class="hljs-number"><span class="hljs-number">6</span></span>*E1K+<span class="hljs-number"><span class="hljs-number">2</span></span>*IX+<span class="hljs-number"><span class="hljs-number">1</span></span>*E1K+<span class="hljs-number"><span class="hljs-number">4</span></span>*CVM <span class="hljs-number"><span class="hljs-number">1620</span></span> <span class="hljs-number"><span class="hljs-number">675320</span></span> (<span class="hljs-number"><span class="hljs-number">28</span></span>), manufactured at <span class="hljs-number"><span class="hljs-number">8</span></span>/<span class="hljs-number"><span class="hljs-number">10</span></span>/<span class="hljs-number"><span class="hljs-number">2015</span></span> platform: serial <span class="hljs-number"><span class="hljs-number">4</span></span>NP602H7H0 platform: sysid <span class="hljs-number"><span class="hljs-number">675320</span></span> - NSMPX<span class="hljs-literal"><span class="hljs-literal">-8000</span></span><span class="hljs-literal"><span class="hljs-literal">-10G</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>*CPU+<span class="hljs-number"><span class="hljs-number">6</span></span>*E1K+<span class="hljs-number"><span class="hljs-number">2</span></span>*IX+<span class="hljs-number"><span class="hljs-number">1</span></span>*E1K+<span class="hljs-number"><span class="hljs-number">4</span></span>*CVM <span class="hljs-number"><span class="hljs-number">1620</span></span> ix0: ixgbe bus speed = <span class="hljs-number"><span class="hljs-number">5.0</span></span>Gbps and PCIe lane width = <span class="hljs-number"><span class="hljs-number">8</span></span> SFP+/SFP, vendor CITRIX           , part number XXX   , <span class="hljs-number"><span class="hljs-number">10</span></span>G <span class="hljs-number"><span class="hljs-number">0</span></span>x10 <span class="hljs-number"><span class="hljs-number">1</span></span>G <span class="hljs-number"><span class="hljs-number">0</span></span>x01 CT <span class="hljs-number"><span class="hljs-number">0</span></span>x00 ix0: [<span class="hljs-type"><span class="hljs-type">ITHREAD</span></span>] <span class="hljs-number"><span class="hljs-number">10</span></span>/<span class="hljs-number"><span class="hljs-number">2</span></span>: Ethernet address: <span class="hljs-number"><span class="hljs-number">00</span></span>:e0:ed:<span class="hljs-number"><span class="hljs-number">45</span></span>:<span class="hljs-number"><span class="hljs-number">39</span></span>:f8 ix1: &lt;Intel(R) PRO/<span class="hljs-number"><span class="hljs-number">10</span></span>GbE PCI<span class="hljs-literal"><span class="hljs-literal">-Express</span></span> Network Driver, Version - <span class="hljs-number"><span class="hljs-number">2.7</span></span>.<span class="hljs-number"><span class="hljs-number">4</span></span>&gt; port <span class="hljs-number"><span class="hljs-number">0</span></span>xe000<span class="hljs-literal"><span class="hljs-literal">-0xe01f</span></span> mem <span class="hljs-number"><span class="hljs-number">0</span></span>xf7800000<span class="hljs-literal"><span class="hljs-literal">-0xf781ffff</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>xf7840000<span class="hljs-literal"><span class="hljs-literal">-0xf7843fff</span></span> irq <span class="hljs-number"><span class="hljs-number">17</span></span> at device <span class="hljs-number"><span class="hljs-number">0.1</span></span> on pci1 ix1: ixgbe bus speed = <span class="hljs-number"><span class="hljs-number">5.0</span></span>Gbps and PCIe lane width = <span class="hljs-number"><span class="hljs-number">8</span></span> SFP+/SFP, vendor CITRIX           , part number XXX  , <span class="hljs-number"><span class="hljs-number">10</span></span>G <span class="hljs-number"><span class="hljs-number">0</span></span>x10 <span class="hljs-number"><span class="hljs-number">1</span></span>G <span class="hljs-number"><span class="hljs-number">0</span></span>x01 CT <span class="hljs-number"><span class="hljs-number">0</span></span>x00</code> </pre> <br><br>  Esses transceptores foram determinados sem problemas, mas isso n√£o salvou a situa√ß√£o.  Firmware atualizado - a mesma coisa.  O suporte da Citrix decidiu ficar quieto com muito tato (n√£o, n√£o por causa do pedigree do transceptor). <br><br>  Respiramos fundo e enterramos as especifica√ß√µes de hardware.  Aconteceu que a resposta todo esse tempo estava diante de nossos olhos: <i><b>velocidade do barramento ixgbe = 5,0 Gbps e largura da pista PCIe = 8.</b></i> Esse √© um problema com a placa.  Ela pr√≥pria n√£o tem velocidade PCIe.  Nosso Citrix tem o desempenho m√°ximo do slot PCI-e para uma placa com transceptores de <i><b>5,0 Gbps,</b></i> que ele gritou para n√≥s durante todo esse tempo.  Como o Citrix no MPX8015 (√© exatamente o mesmo em hardware!) Eles queriam distribuir 15 gigabits, n√£o est√° claro.  Mas entendemos por que esses balanceadores "legais" todo esse tempo estavam em um armaz√©m.  Eles n√£o podem funcionar corretamente com links 10G em princ√≠pio. <br><br><h4>  A √∫ltima experi√™ncia.  Usamos o ferro certo e o tornamos bonito </h4><br>  Aqui, nossa paci√™ncia terminou com nossa f√© na humanidade, e tivemos que usar a tecnologia "sobressalente" para obter o hardware normal na forma do HP ProLiant DL360 G9 nas fotos acima.  Eles n√£o come√ßaram a arranjar surpresas para n√≥s, eles baixam o 10G e n√£o reclamam.  :) <br><br><h2>  Teste de carga </h2><br>  Como n√£o aceitamos a abordagem hujak-hujak-and-production, e sabemos por experi√™ncia pr√≥pria que um sistema n√£o testado ap√≥s a montagem com quase 100% de garantia ser√° inoperante, decidimos realizar testes de estresse.  Al√©m disso, com sua ajuda, voc√™ pode fazer alguns ajustes para o futuro. <br><br>  Para gerar a carga, foi escolhida a ferramenta usual - Apache Jmetr.  Por si s√≥, √© muito bom, como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">escrevi</a> alguns artigos, e esta √© uma das solu√ß√µes mais flex√≠veis do mercado, mesmo que o Java goste de comer.  Para trabalhar com o S3, usamos um m√≥dulo auto-escrito usando o AWS SDK, tamb√©m em Java.  Nos testes, conseguimos atingir uma velocidade de 12,5 Gbps para gravar arquivos com mais de 250 megabytes com carregamento paralelo por partes de 5 megabytes e arquivos com menos de 5 megabytes - processando cerca de 3000 solicita√ß√µes HTTP por segundo.  Ao executar os dois testes em paralelo, resultou em cerca de 11 Gigabits e 2200 solicita√ß√µes por segundo.  Ao mesmo tempo, existe a possibilidade de melhorar o trabalho com uma carga mista e com pequenos objetos.  N√≥s "enterramos" na CPU, e o segundo soquete √© gratuito.  No gerador de carga, os arquivos de teste foram retirados da RAM para excluir a influ√™ncia nos resultados do subsistema de disco do pr√≥prio gerador.  Para testes, lembrando o amor do Java pela RAM e a necessidade de trabalhar com um grande n√∫mero de threads durante o carregamento paralelo, usamos o servidor HP DL980 g7 como gerador.  Este √© um servidor de oito unidades com 8 processadores Intel E7-4870 e 512 GB de RAM a bordo. <br><br>  Dentro da equipe, o apelido carinhoso Behemoth grudava nele. <br><br><img src="https://habrastorage.org/webt/yl/ef/wb/ylefwbgvc4ypecxwot1jtcr7yrc.png"><br>  <i>14. Nosso hipop√≥tamo.</i>  <i>Verdade, algo semelhante?</i> <br><br><img src="https://habrastorage.org/webt/b8/ql/an/b8qlan70ud31dkucw7dt252sbxi.png"><br>  <i>15. Vista traseira.</i>  <i>Os cabos assustadores no centro inferior s√£o uma conex√£o cruzada do barramento interno da ponte</i> <br><br><img src="https://habrastorage.org/webt/6c/xe/ni/6cxeniwbbzfcuh7e06brn-ko7pe.png"><br>  <i>16. Este √© um dos dois objetivos do servidor.</i>  <i>Cada um possui 4 processadores e 16 slots de 16 gigabytes de RAM</i> <br><br><img src="https://habrastorage.org/webt/wx/vt/p9/wxvtp91ap3cdeu0y0kmn9komqwo.png"><br>  <i>17. Para usar o Htop confortavelmente no console desse servidor, voc√™ precisa de um monitor grande :)</i> <br><br>  Na pr√°tica, um teste misto carregou notavelmente at√© um servidor t√£o poderoso. <br>  Para chegar aos resultados de desempenho obtidos, tivemos que transferir a rede interna do cluster para jumbo frames de 9k e ajustar ligeiramente a pilha de balanceadores e n√≥s de trabalho da rede (usamos o CentOS Linux), al√©m de otimizar v√°rios outros par√¢metros do kernel nos n√≥s de trabalho: <br><br><pre> <code class="hljs dos">cat /etc/sysctl.conf ‚Ä¶ kernel.printk = <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> read_ahead_kb = <span class="hljs-number"><span class="hljs-number">1024</span></span> write_expire = <span class="hljs-number"><span class="hljs-number">250</span></span> read_expire = <span class="hljs-number"><span class="hljs-number">250</span></span> fifo_batch = <span class="hljs-number"><span class="hljs-number">128</span></span> front_merges = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-built_in"><span class="hljs-built_in">net</span></span>.core.wmem_default = <span class="hljs-number"><span class="hljs-number">16777216</span></span> <span class="hljs-built_in"><span class="hljs-built_in">net</span></span>.core.wmem_max = <span class="hljs-number"><span class="hljs-number">16777216</span></span> <span class="hljs-built_in"><span class="hljs-built_in">net</span></span>.core.rmem_default = <span class="hljs-number"><span class="hljs-number">16777216</span></span> <span class="hljs-built_in"><span class="hljs-built_in">net</span></span>.core.rmem_max = <span class="hljs-number"><span class="hljs-number">16777216</span></span> <span class="hljs-built_in"><span class="hljs-built_in">net</span></span>.core.somaxconn = <span class="hljs-number"><span class="hljs-number">5120</span></span> <span class="hljs-built_in"><span class="hljs-built_in">net</span></span>.core.netdev_max_backlog = <span class="hljs-number"><span class="hljs-number">50000</span></span> <span class="hljs-built_in"><span class="hljs-built_in">net</span></span>.ipv4.tcp_tw_reuse = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">net</span></span>.ipv4.tcp_rmem = <span class="hljs-number"><span class="hljs-number">4096</span></span> <span class="hljs-number"><span class="hljs-number">87380</span></span> <span class="hljs-number"><span class="hljs-number">16777216</span></span> <span class="hljs-built_in"><span class="hljs-built_in">net</span></span>.ipv4.tcp_wmem = <span class="hljs-number"><span class="hljs-number">4096</span></span> <span class="hljs-number"><span class="hljs-number">65536</span></span> <span class="hljs-number"><span class="hljs-number">16777216</span></span> <span class="hljs-built_in"><span class="hljs-built_in">net</span></span>.ipv4.tcp_slow_start_after_idle = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-built_in"><span class="hljs-built_in">net</span></span>.ipv4.tcp_max_syn_backlog = <span class="hljs-number"><span class="hljs-number">30000</span></span> <span class="hljs-built_in"><span class="hljs-built_in">net</span></span>.ipv4.tcp_max_tw_buckets = <span class="hljs-number"><span class="hljs-number">2000000</span></span> <span class="hljs-built_in"><span class="hljs-built_in">fs</span></span>.file-max = <span class="hljs-number"><span class="hljs-number">196608</span></span> vm.overcommit_memory = <span class="hljs-number"><span class="hljs-number">1</span></span> vm.overcommit_ratio = <span class="hljs-number"><span class="hljs-number">100</span></span> vm.max_map_count = <span class="hljs-number"><span class="hljs-number">65536</span></span> vm.dirty_ratio = <span class="hljs-number"><span class="hljs-number">40</span></span> vm.dirty_background_ratio = <span class="hljs-number"><span class="hljs-number">5</span></span> vm.dirty_expire_centisecs = <span class="hljs-number"><span class="hljs-number">100</span></span> vm.dirty_writeback_centisecs = <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-built_in"><span class="hljs-built_in">net</span></span>.ipv4.tcp_fin_timeout=<span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-built_in"><span class="hljs-built_in">net</span></span>.ipv4.tcp_congestion_control=htcp <span class="hljs-built_in"><span class="hljs-built_in">net</span></span>.ipv4.netfilter.ip_conntrack_max=<span class="hljs-number"><span class="hljs-number">1048576</span></span> <span class="hljs-built_in"><span class="hljs-built_in">net</span></span>.core.rmem_default=<span class="hljs-number"><span class="hljs-number">65536</span></span> <span class="hljs-built_in"><span class="hljs-built_in">net</span></span>.core.wmem_default=<span class="hljs-number"><span class="hljs-number">65536</span></span> <span class="hljs-built_in"><span class="hljs-built_in">net</span></span>.core.rmem_max=<span class="hljs-number"><span class="hljs-number">16777216</span></span> <span class="hljs-built_in"><span class="hljs-built_in">net</span></span>.core.wmem_max=<span class="hljs-number"><span class="hljs-number">16777216</span></span> <span class="hljs-built_in"><span class="hljs-built_in">net</span></span>.ipv4.ip_local_port_range=<span class="hljs-number"><span class="hljs-number">1024</span></span> <span class="hljs-number"><span class="hljs-number">65535</span></span></code> </pre> <br><br>  As principais configura√ß√µes submetidas ao ajuste s√£o o tamanho dos buffers, o n√∫mero de conex√µes de rede, o n√∫mero de conex√µes √† porta e as conex√µes monitoradas por firewalls, al√©m de tempos limite. <br><br>  <b>Cisco C3750 + LACP = dor</b> <br>  Outra armadilha no desempenho da rede √© o balanceamento de carga ao usar o LACP / LAGp.  Infelizmente, o Cisco 3750s n√£o pode equilibrar a carga entre portas, apenas nos endere√ßos de origem e destino.  Para obter o balanceamento correto do tr√°fego, tive que pendurar 12 endere√ßos IP nas interfaces de v√≠nculo dos n√≥s em funcionamento, "olhando" para os clientes.  Condicionalmente, 3 para cada link f√≠sico.  Com essa configura√ß√£o, era poss√≠vel ficar sem o LACP nas interfaces "externas" dos n√≥s em funcionamento, pois todos os endere√ßos s√£o especificados na configura√ß√£o do Nginx, mas se o link fosse perdido, reduzir√≠amos automaticamente o peso do n√≥ no balanceamento.  Com o "dump", o link LACP permite manter a acessibilidade total a todos os endere√ßos. <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">bond0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span>  <span class="hljs-selector-tag"><span class="hljs-selector-tag">Link</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">encap</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:Ethernet</span></span>  <span class="hljs-selector-tag"><span class="hljs-selector-tag">HWaddr</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">XXX</span></span>       <span class="hljs-selector-tag"><span class="hljs-selector-tag">inet</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">addr</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:192.168.XX</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Bcast</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:192.168.XX</span></span>  <span class="hljs-selector-tag"><span class="hljs-selector-tag">Mask</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:255.255.255.0</span></span>       <span class="hljs-selector-tag"><span class="hljs-selector-tag">UP</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">BROADCAST</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">RUNNING</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">MULTICAST</span></span>  <span class="hljs-selector-tag"><span class="hljs-selector-tag">MTU</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:9000</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Metric</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:1</span></span>       <span class="hljs-selector-tag"><span class="hljs-selector-tag">RX</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">packets</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:2390824140</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">errors</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dropped</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">overruns</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">frame</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:0</span></span>       <span class="hljs-selector-tag"><span class="hljs-selector-tag">TX</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">packets</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:947068357</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">errors</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dropped</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">overruns</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">carrier</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:0</span></span>       <span class="hljs-selector-tag"><span class="hljs-selector-tag">collisions</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">txqueuelen</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:0</span></span>       <span class="hljs-selector-tag"><span class="hljs-selector-tag">RX</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">bytes</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:18794424755066</span></span> (17<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">TiB</span></span>)  <span class="hljs-selector-tag"><span class="hljs-selector-tag">TX</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">bytes</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:246433289523</span></span> (229<span class="hljs-selector-class"><span class="hljs-selector-class">.5</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">GiB</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">bond0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Link</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">encap</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:Ethernet</span></span>  <span class="hljs-selector-tag"><span class="hljs-selector-tag">HWaddr</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">XXX</span></span>       <span class="hljs-selector-tag"><span class="hljs-selector-tag">inet</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">addr</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:192.168.XX</span></span>  <span class="hljs-selector-tag"><span class="hljs-selector-tag">Bcast</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:192.168.XX</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Mask</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:255.255.255.0</span></span>       <span class="hljs-selector-tag"><span class="hljs-selector-tag">UP</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">BROADCAST</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">RUNNING</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">MULTICAST</span></span>  <span class="hljs-selector-tag"><span class="hljs-selector-tag">MTU</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:9000</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Metric</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">bond0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Link</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">encap</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:Ethernet</span></span>  <span class="hljs-selector-tag"><span class="hljs-selector-tag">HWaddr</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">XXX</span></span>       <span class="hljs-selector-tag"><span class="hljs-selector-tag">inet</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">addr</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:192.168.XX</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Bcast</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:192.168.XX</span></span>  <span class="hljs-selector-tag"><span class="hljs-selector-tag">Mask</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:255.255.255.0</span></span>       <span class="hljs-selector-tag"><span class="hljs-selector-tag">UP</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">BROADCAST</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">RUNNING</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">MULTICAST</span></span>  <span class="hljs-selector-tag"><span class="hljs-selector-tag">MTU</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:9000</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Metric</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">bond0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:2</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Link</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">encap</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:Ethernet</span></span>  <span class="hljs-selector-tag"><span class="hljs-selector-tag">HWaddr</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">XXX</span></span>       <span class="hljs-selector-tag"><span class="hljs-selector-tag">inet</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">addr</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:192.168.XX</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Bcast</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:192.168.XX</span></span>  <span class="hljs-selector-tag"><span class="hljs-selector-tag">Mask</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:255.255.255.0</span></span>       <span class="hljs-selector-tag"><span class="hljs-selector-tag">UP</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">BROADCAST</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">RUNNING</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">MULTICAST</span></span>  <span class="hljs-selector-tag"><span class="hljs-selector-tag">MTU</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:9000</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Metric</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">bond0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:3</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Link</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">encap</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:Ethernet</span></span>  <span class="hljs-selector-tag"><span class="hljs-selector-tag">HWaddr</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">XXX</span></span>       <span class="hljs-selector-tag"><span class="hljs-selector-tag">inet</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">addr</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:192.168.XX</span></span>  <span class="hljs-selector-tag"><span class="hljs-selector-tag">Bcast</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:192.168.XX</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Mask</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:255.255.255.0</span></span>       <span class="hljs-selector-tag"><span class="hljs-selector-tag">UP</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">BROADCAST</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">RUNNING</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">MULTICAST</span></span>  <span class="hljs-selector-tag"><span class="hljs-selector-tag">MTU</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:9000</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Metric</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">bond0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:4</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Link</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">encap</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:Ethernet</span></span>  <span class="hljs-selector-tag"><span class="hljs-selector-tag">HWaddr</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">XXX</span></span>       <span class="hljs-selector-tag"><span class="hljs-selector-tag">inet</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">addr</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:192.168.XX</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Bcast</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:192.168.XX</span></span>  <span class="hljs-selector-tag"><span class="hljs-selector-tag">Mask</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:255.255.255.0</span></span>       <span class="hljs-selector-tag"><span class="hljs-selector-tag">UP</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">BROADCAST</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">RUNNING</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">MULTICAST</span></span>  <span class="hljs-selector-tag"><span class="hljs-selector-tag">MTU</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:9000</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Metric</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">bond0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:5</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Link</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">encap</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:Ethernet</span></span>  <span class="hljs-selector-tag"><span class="hljs-selector-tag">HWaddr</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">XXX</span></span>       <span class="hljs-selector-tag"><span class="hljs-selector-tag">inet</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">addr</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:192.168.XX</span></span>  <span class="hljs-selector-tag"><span class="hljs-selector-tag">Bcast</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:192.168.XX</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Mask</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:255.255.255.0</span></span>       <span class="hljs-selector-tag"><span class="hljs-selector-tag">UP</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">BROADCAST</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">RUNNING</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">MULTICAST</span></span>  <span class="hljs-selector-tag"><span class="hljs-selector-tag">MTU</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:9000</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Metric</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">bond0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:6</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Link</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">encap</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:Ethernet</span></span>  <span class="hljs-selector-tag"><span class="hljs-selector-tag">HWaddr</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">XXX</span></span>       <span class="hljs-selector-tag"><span class="hljs-selector-tag">inet</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">addr</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:192.168.XX</span></span>  <span class="hljs-selector-tag"><span class="hljs-selector-tag">Bcast</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:192.168.XX</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Mask</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:255.255.255.0</span></span>       <span class="hljs-selector-tag"><span class="hljs-selector-tag">UP</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">BROADCAST</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">RUNNING</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">MULTICAST</span></span>  <span class="hljs-selector-tag"><span class="hljs-selector-tag">MTU</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:9000</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Metric</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">bond0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:7</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Link</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">encap</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:Ethernet</span></span>  <span class="hljs-selector-tag"><span class="hljs-selector-tag">HWaddr</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">XXX</span></span>       <span class="hljs-selector-tag"><span class="hljs-selector-tag">inet</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">addr</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:192.168.XX</span></span>  <span class="hljs-selector-tag"><span class="hljs-selector-tag">Bcast</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:192.168.XX</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Mask</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:255.255.255.0</span></span>       <span class="hljs-selector-tag"><span class="hljs-selector-tag">UP</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">BROADCAST</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">RUNNING</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">MULTICAST</span></span>  <span class="hljs-selector-tag"><span class="hljs-selector-tag">MTU</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:9000</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Metric</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">bond0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:8</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Link</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">encap</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:Ethernet</span></span>  <span class="hljs-selector-tag"><span class="hljs-selector-tag">HWaddr</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">XXX</span></span>       <span class="hljs-selector-tag"><span class="hljs-selector-tag">inet</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">addr</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:192.168.XX</span></span>  <span class="hljs-selector-tag"><span class="hljs-selector-tag">Bcast</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:192.168.XX</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Mask</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:255.255.255.0</span></span>       <span class="hljs-selector-tag"><span class="hljs-selector-tag">UP</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">BROADCAST</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">RUNNING</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">MULTICAST</span></span>  <span class="hljs-selector-tag"><span class="hljs-selector-tag">MTU</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:9000</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Metric</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">bond0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:9</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Link</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">encap</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:Ethernet</span></span>  <span class="hljs-selector-tag"><span class="hljs-selector-tag">HWaddr</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">XXX</span></span>       <span class="hljs-selector-tag"><span class="hljs-selector-tag">inet</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">addr</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:192.168.XX</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Bcast</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:192.168.XXMask</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:255.255.255.0</span></span>       <span class="hljs-selector-tag"><span class="hljs-selector-tag">UP</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">BROADCAST</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">RUNNING</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">MULTICAST</span></span>  <span class="hljs-selector-tag"><span class="hljs-selector-tag">MTU</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:9000</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Metric</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">bond0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:10</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Link</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">encap</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:Ethernet</span></span>  <span class="hljs-selector-tag"><span class="hljs-selector-tag">HWaddr</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">XXX</span></span>       <span class="hljs-selector-tag"><span class="hljs-selector-tag">inet</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">addr</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:192.168.XX</span></span>  <span class="hljs-selector-tag"><span class="hljs-selector-tag">Bcast</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:192.168.XX</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Mask</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:255.255.255.0</span></span>       <span class="hljs-selector-tag"><span class="hljs-selector-tag">UP</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">BROADCAST</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">RUNNING</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">MULTICAST</span></span>  <span class="hljs-selector-tag"><span class="hljs-selector-tag">MTU</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:9000</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Metric</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:1</span></span></code> </pre> <br><br><br><h2>  Teste funcional </h2><br>  Depois de concluir o trabalho no reposit√≥rio, encontramos o servi√ßo flexify.io.  Eles ajudam a facilitar a migra√ß√£o entre diferentes armazenamentos de objetos.  Mas para se tornar um parceiro Flexify, voc√™ deve passar por testes s√©rios.  "Por que n√£o?"  - n√≥s pensamos.  Testes de terceiros s√£o sempre uma experi√™ncia gratificante. <br><br>  A principal tarefa dos testes √© verificar a opera√ß√£o dos m√©todos do protocolo S3 por meio de seus proxies em rela√ß√£o a v√°rias configura√ß√µes, dentre as quais pode haver qualquer conjunto de buckets compat√≠veis com S3 suportados pelo provedor de servi√ßos. <br><br>  Primeiro, os m√©todos que funcionam com objetos no balde s√£o verificados.  Nosso armazenamento foi testado usando uma ampla variedade de dados de teste, o comportamento dos m√©todos foi testado para objetos de v√°rios tamanhos e conte√∫dos, para chaves contendo todos os tipos de combina√ß√µes de caracteres Unicode. <br><br>  Em testes negativos, eles tentaram transferir dados inv√°lidos sempre que poss√≠vel.  Foi dada aten√ß√£o especial √† seguran√ßa dos dados no processo. <br><br>  Os m√©todos que trabalham com baldes tamb√©m foram testados, mas principalmente em cen√°rios positivos.  O objetivo desses testes foi verificar se o uso de m√©todos por meio de um proxy n√£o acarreta problemas s√©rios, como corrup√ß√£o de dados ou falhas. <br><br>  A abrang√™ncia da cobertura pode ser avaliada pelos testes que foram usados ‚Äã‚Äãpor meio de proxies e diretamente.  A maioria dos testes, especialmente aqueles que trabalham com objetos, s√£o parametrizados e testam um grande n√∫mero de diferentes objetos, intervalos etc. <br><br><div class="spoiler">  <b class="spoiler_title">Testes implementados para objetos</b> <div class="spoiler_text">  <i>Solicita√ß√£o de objeto GET sem par√¢metros opcionais</i> <i><br></i>  <i>Solicita√ß√£o de objeto GET multithread</i> <i><br></i>  <i>Solicita√ß√£o de objeto GET para um objeto criptografado com par√¢metros sse fornecidos</i> <i><br></i>  <i>Solicita√ß√£o de objeto GET para um objeto criptografado sem par√¢metros sse fornecidos</i> <i><br></i>  <i>Solicita√ß√£o de objeto GET com intervalo que cruza o intervalo de bytes do arquivo</i> <i><br></i>  <i>Solicita√ß√£o de objeto GET com intervalo fora do intervalo de bytes do arquivo</i> <i><br></i>  <i>Solicita√ß√£o de objeto GET com um par√¢metro de intervalo de sufixo</i> <i><br></i>  <i>Solicita√ß√£o de objeto GET com um par√¢metro de intervalo de sufixo fora do intervalo de bytes do arquivo</i> <i><br></i>  <i>Solicita√ß√£o de objeto GET com par√¢metro de intervalo inv√°lido</i> <i><br></i>  <i>Solicita√ß√£o de objeto principal para um objeto existente</i> <i><br></i>  <i>Solicita√ß√£o de objeto principal para um objeto exclu√≠do recentemente</i> <i><br></i>  <i>Solicita√ß√£o de objeto principal com uma chave que nunca existiu em um balde</i> <i><br></i>  <i>Solicita√ß√£o de objeto principal para um objeto criptografado com par√¢metros sse fornecidos</i> <i><br></i>  <i>Solicita√ß√£o de objeto principal para um objeto criptografado sem par√¢metros sse fornecidos</i> <i><br></i>  <i>Solicitar lista de objetos</i> <i><br></i>  <i>Solicita√ß√£o de Listar objetos v2</i> <i><br></i>  <i>Solicita√ß√£o de Listar objetos com o par√¢metro Marker fornecido</i> <i><br></i>  <i>Solicita√ß√£o de Listar objetos com o par√¢metro Prefixo fornecido</i> <i><br></i>  <i>Solicita√ß√£o de Listar objetos com os par√¢metros Marker e Prefix fornecidos</i> <i><br></i>  <i>Receba todos os objetos no terminal com List Objects com os par√¢metros Marker e Prefix fornecidos</i> <i><br></i>  <i>Solicita√ß√£o de Listar objetos com o par√¢metro Delimiter ignorado</i> <i><br></i>  <i>Solicita√ß√£o de Listar objetos com o par√¢metro Marker passado, mas com o par√¢metro Delimiter ignorado</i> <i><br></i>  <i>Solicita√ß√£o de Listar objetos com prefixo n√£o existente passado</i> <i><br></i>  <i>Solicita√ß√£o de lista de objetos com marcador inexistente passado</i> <i><br></i>  <i>Upload de v√°rias partes com o m√©todo upload_file () nativo</i> <i><br></i>  <i>Upload de v√°rias partes com o m√©todo upload_fileobj () nativo</i> <i><br></i>  <i>Upload de v√°rias partes com m√©todo personalizado</i> <i><br></i>  <i>Parando o upload de v√°rias partes com o m√©todo abort_multipart_upload ()</i> <i><br></i>  <i>Executando o m√©todo abort_multipart_upload () com uploadId incorreto</i> <i><br></i>  <i>Executando o m√©todo abort_multipart_upload () com Key e uploadId incorretos</i> <i><br></i>  <i>Upload de v√°rias partes de 2 arquivos com a mesma chave simultaneamente.</i>  <i>2¬∫ arquivo carregado antes do 1¬∫</i> <i><br></i>  <i>Upload de v√°rias partes de 2 arquivos com a mesma chave simultaneamente.</i>  <i>1¬∫ arquivo carregado antes do segundo</i> <i><br></i>  <i>Upload de v√°rias partes de 2 arquivos com chaves diferentes simultaneamente.</i>  <i>1¬∫ arquivo carregado antes do segundo</i> <i><br></i>  <i>Upload de v√°rias partes com um tamanho de pe√ßa de 512kb</i> <i><br></i>  <i>Upload de v√°rias partes com um tamanho de pe√ßa maior que o tamanho m√°ximo permitido</i> <i><br></i>  <i>Upload de v√°rias partes de um arquivo com partes de tamanhos diferentes</i> <i><br></i>  <i>Listar solicita√ß√£o de upload com v√°rias partes</i> <i><br></i>  <i>Solicita√ß√£o de ACL do objeto PUT para um objeto com o ID do benefici√°rio fornecido</i> <i><br></i>  <i>Solicita√ß√£o GET Object ACL para um objeto com permiss√µes de acesso adicionais concedidas</i> <i><br></i>  <i>M√©todo de marca√ß√£o de objeto PUT</i> <i><br></i>  <i>M√©todo de identifica√ß√£o de objetos GET</i> <i><br></i>  <i>M√©todo DELETE Object Tagging</i> <i><br></i>  <i>Solicita√ß√£o de objeto PUT sem par√¢metros opcionais</i> <i><br></i>  <i>Solicita√ß√µes de objeto PUT multithread</i> <i><br></i>  <i>Solicita√ß√µes de objeto PUT com par√¢metros de criptografia opcionais passados</i> <i><br></i>  <i>Solicita√ß√µes de objeto PUT com o par√¢metro Body vazio passado</i> <i><br></i>  <i>Objeto GET com o m√©todo nativo de download_file ()</i> <i><br></i>  <i>Objeto GET com o m√©todo nativo download_fileobj ()</i> <i><br></i>  <i>Objeto GET com m√©todo personalizado usando intervalos</i> <i><br></i>  <i>Objeto GET com prefixo com o m√©todo nativo de download_file ()</i> <i><br></i>  <i>Objeto GET com prefixo com o m√©todo nativo download_fileobj ()</i> <i><br></i>  <i>Objeto GET com prefixo com m√©todo personalizado usando intervalos</i> <i><br></i>  <i>DELETE Solicita√ß√£o de objeto para um objeto existente</i> <i><br></i>  <i>DELETE Solicita√ß√£o de objeto para um objeto n√£o existente</i> <i><br></i>  <i>DELETE Solicita√ß√£o de objetos para um grupo com objetos existentes</i> <br></div></div><br><br><div class="spoiler">  <b class="spoiler_title">Testes realizados para balde</b> <div class="spoiler_text">  <i>Colocar criptografia de bucket</i> <i><br></i>  <i>Criptografia de balde GET</i> <i><br></i>  <i>DELETE Criptografia de bucket</i> <i><br></i>  <i>Solicita√ß√£o de pol√≠tica de segmento PUT</i> <i><br></i>  <i>Solicita√ß√£o GET Bucket Policy para um bucket com Policy</i> <i><br></i>  <i>DELETE a solicita√ß√£o da Pol√≠tica de bucket para um bucket com Policy</i> <i><br></i>  <i>Solicita√ß√£o de pol√≠tica de bucket do GET para um bucket sem pol√≠tica</i> <i><br></i>  <i>EXCLUIR solicita√ß√£o de Pol√≠tica de Balde para um balde sem Pol√≠tica</i> <i><br></i>  <i>Colocar marca√ß√£o de balde</i> <i><br></i>  <i>Obter marca√ß√£o de bucket</i> <i><br></i>  <i>DELETE Marca√ß√£o de bucket</i> <i><br></i>  <i>Criar solicita√ß√£o de bucket com o nome do bucket existente</i> <i><br></i>  <i>Criar solicita√ß√£o de bucket com o nome exclusivo do bucket</i> <i><br></i>  <i>Excluir solicita√ß√£o de bucket com o nome do bucket existente</i> <i><br></i>  <i>Excluir solicita√ß√£o de bucket com nome exclusivo do bucket</i> <i><br></i>  <i>Solicita√ß√£o de ACL de balde PUT para um balde com o ID do benefici√°rio fornecido</i> <i><br></i>  <i>Solicita√ß√£o GET Object ACL para um objeto com permiss√µes de acesso adicionais concedidas</i> <br></div></div><br><br>  Como voc√™ pode imaginar, esse √© um teste bastante dif√≠cil, mas passamos no geral de maneira positiva.  Alguns problemas surgiram devido √† falta de suporte para SSE e escolas pequenas com suporte Unicode na √©poca: <br><br>  Falha ao carregar o aplicativo com chaves contendo: <br><br><ul><li>  U + 0000-U + 001F - os primeiros 32 caracteres de controle ileg√≠veis.  Na Amazon, por exemplo, apenas o primeiro U + 0000 n√£o √© derramado diretamente. <br></li></ul><br><ul><li>  E tamb√©m U + 18D7C, U + 18DA8, U + 18DB4, U + 18DBA, U + 18DC4, U + 18DCE.  Esses tamb√©m s√£o caracteres ileg√≠veis, mas a Amazon os aceita como chaves.  N√£o houve problemas com todos os outros personagens. <br></li></ul><br>  Ao ler o conte√∫do do balde, h√° um problema na chave 66.675, que cont√©m o s√≠mbolo U + FFFE.  N√£o √© poss√≠vel obter uma lista completa de chaves em um bucket que cont√©m um objeto com essa chave. <br><br>  Caso contr√°rio, os testes foram bem-sucedidos e, no final de setembro, aparec√≠amos na lista de fornecedores dispon√≠veis! <br><br><h2>  Um breve posf√°cio e b√¥nus para os leitores </h2><br>  Escrevi anteriormente que o Cloudian HyperStore, apesar de suas muitas vantagens, praticamente n√£o √© abordado no segmento de l√≠ngua russa da Internet. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O primeiro artigo</a> foi sobre os conceitos b√°sicos de trabalho com o Cloudian.  Desmontamos sua estrutura interna, nuances arquitet√¥nicas e lemos a tradu√ß√£o da documenta√ß√£o oficial. <br><br>  Hoje contei como constru√≠mos nosso pr√≥prio armazenamento e que nuances e armadilhas encontramos. <br><br>  Aqueles de voc√™s que querem sentir com canetas o que estamos falando de 2 artigos seguidos podem usar o formul√°rio de feedback <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">nesta p√°gina</a> e descobrir pessoalmente o que √© o sal.  Como padr√£o, damos 15Gb por 2 semanas gratuitamente, √© claro, com acesso do usu√°rio.  Se voc√™ deseja compartilhar suas impress√µes de trabalhar com o reposit√≥rio, escreva-me no PM.  :) <br><br>  E para aqueles que n√£o s√£o suficientes 15 Gb por 2 semanas, temos uma <b>pequena miss√£o!</b>  Nas fotografias do artigo, colocamos tr√™s hipop√≥tamos.  As primeiras 50 pessoas que os encontrarem receber√£o 30Gb por 4 semanas.  Para obter um teste ampliado, escreva nos coment√°rios os n√∫meros das imagens em que os hipop√≥tamos se escondiam e solicite o link acima.  N√£o se esque√ßa de incluir um link para seu coment√°rio no aplicativo. <br><br>  Por tradi√ß√£o, se voc√™ tiver alguma d√∫vida, pergunte a eles nos coment√°rios. <br>  Ficarei feliz em respond√™-las. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt425973/">https://habr.com/ru/post/pt425973/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt425963/index.html">Esta√ß√£o meteorol√≥gica no Arduino de A a Z. Parte 4</a></li>
<li><a href="../pt425965/index.html">SAP Data Management Suite como um complexo para trabalhar com Big Data em empresas</a></li>
<li><a href="../pt425967/index.html">Massacre de serra el√©trica</a></li>
<li><a href="../pt425969/index.html">Como vou me tornar um desenvolvedor web ... e vou?</a></li>
<li><a href="../pt425971/index.html">H√° evid√™ncias da presen√ßa de chips espi√µes nos servidores Supermicro</a></li>
<li><a href="../pt425975/index.html">Converta palavras e frases em anagrama</a></li>
<li><a href="../pt425977/index.html">Flexbox: qual √© o tamanho dessa caixa flex√≠vel?</a></li>
<li><a href="../pt425981/index.html">Carreira do novato na LK: trancos e barrancos para crescer lentamente para a frente</a></li>
<li><a href="../pt425983/index.html">Seguran√ßa de v√¥o</a></li>
<li><a href="../pt425985/index.html">Execu√ß√£o de c√≥digo personalizado no GO</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>