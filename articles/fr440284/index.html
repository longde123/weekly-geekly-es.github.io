<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèº‚Äç‚úàÔ∏è üçì üë®üèª‚Äçüè´ Un nouveau regard sur l'affichage des dialogues dans Android ‚ôéÔ∏è üòã üë∂üèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="L'image montre la premi√®re pens√©e du lecteur qui se demande ce qui peut √™tre √©crit sur une t√¢che aussi simple que l'affichage d'un dialogue. Le manage...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Un nouveau regard sur l'affichage des dialogues dans Android</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mobileup/blog/440284/"><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img src="https://habrastorage.org/webt/cu/u9/xl/cuu9xl-sjrrfz5v4pqqh9hocnxo.png"></a> </p><br><p>  L'image montre la premi√®re pens√©e du lecteur qui se demande ce qui peut √™tre √©crit sur une t√¢che aussi simple que l'affichage d'un dialogue.  Le manager pense de la m√™me mani√®re: "Il n'y a rien de compliqu√© ici, notre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Vasya</a> fera en 5 minutes."  Bien s√ªr, j'exag√®re, mais en r√©alit√© tout n'est pas aussi simple qu'il y para√Æt √† premi√®re vue.  Surtout si nous parlons d'Android. </p><br><p>  Donc, 2019 √©tait dans la cour et <strong>nous ne savons toujours pas comment afficher correctement les dialogues</strong> . </p><a name="habracut"></a><br><p>  Faisons-le dans l'ordre et commen√ßons par l'√©nonc√© du probl√®me: </p><br><blockquote>  Il est n√©cessaire d'afficher un dialogue simple avec le texte pour confirmer l'action et les boutons ¬´confirmer / annuler¬ª.  En cliquant sur le bouton ¬´confirmer¬ª - effectuer une action, par le bouton ¬´annuler¬ª - fermer la bo√Æte de dialogue. </blockquote><br><h1 id="reshenie-v-lob">  Solution de front </h1><br><p>  J'appellerais cette m√©thode junior, car ce n'est pas la premi√®re fois que je rencontre un malentendu pourquoi vous ne pouvez pas simplement utiliser AlertDialog, comme indiqu√© ci-dessous: </p><br><pre><code class="kotlin hljs">AlertDialog.Builder(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>) .setMessage(<span class="hljs-string"><span class="hljs-string">"Please, confirm the action"</span></span>) .setPositiveButton(<span class="hljs-string"><span class="hljs-string">"Confirm"</span></span>) { dialog, which -&gt; <span class="hljs-comment"><span class="hljs-comment">// handle click } .setNegativeButton("Cancel", null) .create() .show()</span></span></code> </pre> <br><p>  Un moyen assez courant pour un d√©veloppeur novice, il est √©vident et intuitif.  Mais, comme dans de nombreux cas lorsque vous travaillez avec Android, cette m√©thode est compl√®tement fausse.  √Ä l'improviste, nous obtenons une fuite de m√©moire, il suffit de tourner l'appareil, et vous verrez l'erreur suivante dans les journaux: </p><br><div class="spoiler">  <b class="spoiler_title">stacktrace</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">E/WindowManager: android.view.WindowLeaked: Activity com.example.testdialog.MainActivity has leaked window DecorView@71b5789[MainActivity] that was originally added here at android.view.ViewRootImpl.&lt;init&gt;(ViewRootImpl.java:511) at android.view.WindowManagerGlobal.addView(WindowManagerGlobal.java:346) at android.view.WindowManagerImpl.addView(WindowManagerImpl.java:93) at android.app.Dialog.show(Dialog.java:329) at com.example.testdialog.MainActivity.onCreate(MainActivity.kt:27) at android.app.Activity.performCreate(Activity.java:7144) at android.app.Activity.performCreate(Activity.java:7135) at android.app.Instrumentation.callActivityOnCreate(Instrumentation.java:1271) at android.app.ActivityThread.performLaunchActivity(ActivityThread.java:2931) at android.app.ActivityThread.handleLaunchActivity(ActivityThread.java:3086) at android.app.servertransaction.LaunchActivityItem.execute(LaunchActivityItem.java:78) at android.app.servertransaction.TransactionExecutor.executeCallbacks(TransactionExecutor.java:108) at android.app.servertransaction.TransactionExecutor.execute(TransactionExecutor.java:68) at android.app.ActivityThread$H.handleMessage(ActivityThread.java:1816) at android.os.Handler.dispatchMessage(Handler.java:106) at android.os.Looper.loop(Looper.java:193) at android.app.ActivityThread.main(ActivityThread.java:6718) at java.lang.reflect.Method.invoke(Native Method) at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:493) at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:858)</code> </pre></div></div><br><p>  Sur Stackoverflow, la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">question</a> √† ce sujet est l'une des plus populaires.  En bref, le probl√®me est que nous affichons la bo√Æte de dialogue ou ne fermons pas la bo√Æte de dialogue une fois l'activation termin√©e. </p><br><p>  Vous pouvez, bien s√ªr, appeler le renvoi sur la bo√Æte de dialogue dans l'activit√© onPause ou onDestroy, comme indiqu√© dans la r√©ponse par <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">r√©f√©rence</a> .  Mais ce n'est pas exactement ce dont nous avons besoin.  Nous voulons que le dialogue reprenne apr√®s avoir tourn√© l'appareil. </p><br><h1 id="ustarevshiy-sposob">  Mani√®re obsol√®te </h1><br><p>  Avant que des fragments n'apparaissent dans Android, les dialogues auraient d√ª √™tre affich√©s via un appel √† la m√©thode d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">activation showDialog</a> .  Dans ce cas, l'activit√© g√®re correctement le cycle de vie du dialogue et le restaure apr√®s un tour.  La cr√©ation du dialogue lui-m√™me devait √™tre impl√©ment√©e dans le rappel onCreateDialog: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainActivity</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Activity</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> CONFIRMATION_DIALOG_ID = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-comment"><span class="hljs-comment">// ... @Override protected Dialog onCreateDialog(int id, Bundle args) { if (id == CONFIRMATION_DIALOG_ID) { return new AlertDialog.Builder(this) .setMessage("Please, confirm the action") .setPositiveButton("Confirm", new DialogInterface.OnClickListener() { @Override public void onClick(DialogInterface dialog, int which) { // handle click } }) .create(); } else { return super.onCreateDialog(id, args); } } }</span></span></code> </pre> <br><p>  Ce n'est pas tr√®s pratique que vous ayez √† d√©marrer un identifiant de dialogue et √† passer des param√®tres via le Bundle.  Et nous pouvons toujours obtenir le probl√®me de ¬´fen√™tre perdue¬ª si nous essayons d'afficher une bo√Æte de dialogue apr√®s avoir appel√© onDestroy sur l'activit√©.  Cela est possible, par exemple, lorsque vous essayez d'afficher une erreur apr√®s une op√©ration asynchrone. </p><br><p>  En g√©n√©ral, ce probl√®me est typique pour Android, lorsque vous devez faire quelque chose apr√®s une op√©ration asynchrone et que l'activit√© ou le fragment est d√©j√† d√©truit √† ce moment.  C'est probablement pourquoi les mod√®les MV * sont plus populaires dans la communaut√© Android que parmi les d√©veloppeurs iOS. </p><br><h1 id="sposob-iz-dokumentacii">  M√©thode issue de la documentation </h1><br><p>  Des fragments sont apparus dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Android Honeycomb</a> , et la m√©thode d√©crite ci-dessus est d√©conseill√©e, et la m√©thode <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">showDialog</a> de l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">activit√© est</a> marqu√©e comme d√©conseill√©e.  Non, AlertDialog n'est pas obsol√®te, car beaucoup se trompent.  Tout √† l'heure, il y a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">DialogFragment</a> , qui enveloppe l'objet de dialogue et contr√¥le son cycle de vie. </p><br><blockquote>  Les extraits natifs sont √©galement obsol√®tes depuis l'API 28.  Maintenant, vous devez utiliser uniquement l'impl√©mentation de la biblioth√®que de support (AndroidX). </blockquote><p>  Accomplissons notre t√¢che, comme prescrit par la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation officielle</a> : </p><br><ol><li>  Vous devez d'abord h√©riter de DialogFragment et impl√©menter la cr√©ation d'une bo√Æte de dialogue dans la m√©thode onCreateDialog. </li><li>  D√©crivez l'interface des √©v√©nements de dialogue et instanciez l'√©couteur dans la m√©thode onAttach. </li><li>  Impl√©mentez une interface d'√©v√©nement de dialogue dans une activit√© ou un fragment. </li></ol><br><blockquote>  Si le lecteur ne sait pas tr√®s bien pourquoi l'auditeur ne peut pas passer par le constructeur, il peut en savoir plus <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> </blockquote><p>  Code de fragment de dialogue: </p><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConfirmationDialogFragment</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DialogFragment</span></span></span></span>() { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConfirmationListener</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">confirmButtonClicked</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cancelButtonClicked</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lateinit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> listener: ConfirmationListener <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onAttach</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(context: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Context</span></span></span></span><span class="hljs-function"><span class="hljs-params">?)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onAttach(context) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">// Instantiate the ConfirmationListener so we can send events to the host listener = activity as ConfirmationListener } catch (e: ClassCastException) { // The activity doesn't implement the interface, throw exception throw ClassCastException(activity.toString() + " must implement ConfirmationListener") } } override fun onCreateDialog(savedInstanceState: Bundle?): Dialog { return AlertDialog.Builder(context!!) .setMessage("Please, confirm the action") .setPositiveButton("Confirm") { _, _ -&gt; listener.confirmButtonClicked() } .setNegativeButton("Cancel") { _, _ -&gt; listener.cancelButtonClicked() } .create() } }</span></span></code> </pre> <br><p>  Code d'activation: </p><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainActivity</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AppCompatActivity</span></span></span></span>(), ConfirmationListener { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">showConfirmationDialog</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { ConfirmationDialogFragment() .show(supportFragmentManager, <span class="hljs-string"><span class="hljs-string">"ConfirmationDialogFragmentTag"</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">confirmButtonClicked</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-comment"><span class="hljs-comment">// handle click } override fun cancelButtonClicked() { // handle click } }</span></span></code> </pre> <br><p>  Assez de code s'est av√©r√©, non? </p><br><p>  En r√®gle g√©n√©rale, il existe une sorte de MVP dans le projet, mais j'ai d√©cid√© que les appels des pr√©sentateurs peuvent √™tre omis dans ce cas.  Dans l'exemple ci-dessus, cela vaut la peine d'ajouter la m√©thode statique de cr√©ation de la bo√Æte de dialogue newInstance et de passer des param√®tres aux arguments de fragment, le tout comme pr√©vu. </p><br><p>  Et tout cela pour que le dialogue se cache dans le temps et se r√©tablisse correctement.  Il n'est pas surprenant que de telles questions se posent sur Stackoverflow: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">un</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">deux</a> . </p><br><h1 id="poisk-idealnogo-resheniya">  Trouver la solution parfaite </h1><br><p>  La situation actuelle ne nous convenait pas et nous avons commenc√© √† chercher un moyen de rendre le travail avec les dialogues plus confortable.  Il y avait un sentiment que vous pouvez le rendre plus facile, presque comme dans la premi√®re m√©thode. </p><br><p>  Voici les consid√©rations qui nous ont guid√©s: </p><br><ul><li>  <strong>Dois-je enregistrer et restaurer la bo√Æte de dialogue apr√®s avoir tu√© le processus de candidature?</strong> <br>  Dans la plupart des cas, cela n'est pas obligatoire, comme dans notre exemple, lorsque vous devez afficher un message simple ou demander quelque chose.  Un tel dialogue est pertinent jusqu'√† ce que l'attention de l'utilisateur soit perdue.  Si vous le restaurez apr√®s une longue absence dans l'application, l'utilisateur perdra le contexte de l'action planifi√©e.  Par cons√©quent, il <strong>vous suffit de prendre en charge les tours de l'appareil</strong> et de g√©rer correctement le cycle de vie du dialogue.  Sinon, √† cause du mouvement maladroit de l'appareil, l'utilisateur peut perdre le message qui vient d'√™tre ouvert sans le lire. </li><li>  Lorsque vous utilisez DialogFragment, trop de code passe-partout appara√Æt, la simplicit√© est perdue.  Par cons√©quent, ce serait bien de se d√©barrasser du fragment comme wrapper et d' <strong>utiliser Dialog directement</strong> .  Pour ce faire, vous devrez enregistrer l'√©tat de la bo√Æte de dialogue afin de l'afficher √† nouveau apr√®s avoir recr√©√© la vue et la masquer lorsque la vue s'√©teint. </li><li>  Tout le monde a l'habitude de percevoir l'affichage du dialogue en √©quipe, surtout si vous ne travaillez qu'avec MVP.  La t√¢che de la restauration ult√©rieure de l'√©tat est assum√©e par le FragmentManager.  Mais vous pouvez regarder cette situation diff√©remment et commencer √† <strong>percevoir le dialogue comme un √©tat</strong> .  C'est beaucoup plus pratique lorsque vous travaillez avec des mod√®les PM ou MVVM. </li><li>  √âtant donn√© que la plupart des applications utilisent d√©sormais des approches r√©actives, les <strong>dialogues doivent √™tre r√©actifs</strong> .  La t√¢che principale n'est pas de briser la cha√Æne qui d√©clenche l'affichage du dialogue, et d'attacher un flux r√©actif d'√©v√©nements pour en obtenir un r√©sultat.  C'est tr√®s pratique du c√¥t√© PresentationModel / ViewModel lorsque vous manipulez plusieurs flux de donn√©es. </li></ul><br><p>  Nous avons pris en compte toutes les exigences ci-dessus et avons trouv√© un moyen d'afficher de mani√®re r√©active les dialogues, que nous avons mis en ≈ìuvre avec succ√®s dans notre biblioth√®que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">RxPM</a> (il y a un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article</a> s√©par√© √† ce sujet). </p><br><p>  La solution elle-m√™me ne n√©cessite pas de biblioth√®que et peut √™tre effectu√©e s√©par√©ment.  Guid√© par l'id√©e de ¬´dialogue en tant qu'√©tat¬ª, vous pouvez essayer de construire une solution bas√©e sur le ViewModel et LiveData √† la mode.  Mais je laisserai ce droit au lecteur, puis nous parlerons d'une solution toute faite de la biblioth√®que. </p><br><h1 id="reaktivnyy-sposob">  M√©thode r√©active </h1><br><p>  Je vais montrer comment la t√¢che initiale est r√©solue dans RxPM, mais d'abord quelques mots sur les concepts cl√©s de la biblioth√®que: </p><br><ul><li>  <strong>PresentationModel</strong> - stocke un √©tat de r√©action, contient une logique d'interface utilisateur, survit aux virages. </li><li>  <strong>L'√âtat</strong> est un <strong>√©tat</strong> r√©actif.  Vous pouvez le consid√©rer comme un wrapper sur BehaviorRelay. </li><li>  <strong>Action</strong> - un wrapper sur PublishRelay, sert √† transf√©rer des √©v√©nements de View vers PresentationModel. </li><li>  <strong>√âtat</strong> et <strong>action</strong> ont observable et consommateur. </li></ul><br><p>  La classe <a href="">DialogControl</a> est responsable de l'√©tat de la bo√Æte de dialogue.  Il a deux param√®tres: le premier pour le type de donn√©es √† afficher dans la bo√Æte de dialogue, le second pour le type de r√©sultat.  Dans notre exemple, le type de donn√©es sera Unit, mais il peut s'agir d'un message √† l'utilisateur ou de tout autre type. </p><br><p>  DialogControl a les m√©thodes suivantes: </p><br><ul><li>  <code>show(data: T)</code> - donne juste une commande √† afficher. </li><li>  <code>showForResult(data: T): Maybe&lt;R&gt;</code> - affiche une bo√Æte de dialogue et ouvre le flux pour obtenir le r√©sultat. </li><li>  <code>sendResult(result: R)</code> - envoie le r√©sultat, est appel√© du c√¥t√© Affichage. </li><li>  <code>dismiss()</code> - masque simplement la bo√Æte de dialogue. </li></ul><br><p>  DialogControl stocke l'√©tat - y a-t-il un dialogue √† l'√©cran ou non (affich√© / absent).  Voici √† quoi cela ressemble dans le code de classe: </p><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DialogControl</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">T, R</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">internal</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">constructor</span></span></span></span>(pm: PresentationModel) { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> displayed = pm.State&lt;Display&gt;(Absent) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> result = pm.Action&lt;R&gt;() <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Display</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">data</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Displayed</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">T</span></span></span><span class="hljs-class">&gt;</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">val</span></span> <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>: T) : Display() <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> Absent : Display() } <span class="hljs-comment"><span class="hljs-comment">// ... }</span></span></code> </pre> <br><p>  Cr√©ez un mod√®le de pr√©sentation simple: </p><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SamplePresentationModel</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PresentationModel</span></span></span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConfirmationDialogResult</span></span></span><span class="hljs-class"> </span></span>{ CONFIRMED, CANCELED } <span class="hljs-comment"><span class="hljs-comment">//        enum    val confirmationDialog = dialogControl&lt;Unit, ConfirmationDialogResult&gt;() val buttonClicks = Action&lt;Unit&gt;() override fun onCreate() { super.onCreate() buttonClicks.observable .switchMapMaybe { //           confirmationDialog.showForResult(Unit) .filter { it == ConfirmationDialogResult.CONFIRMED } } .subscribe { //   } .untilDestroy() } }</span></span></code> </pre> <br><p>  Veuillez noter que le traitement des clics, la confirmation de la confirmation et le traitement des actions sont impl√©ment√©s dans la m√™me cha√Æne.  Cela vous permet de concentrer le code et de ne pas disperser la logique sur plusieurs rappels. </p><br><p>  Ensuite, nous lions simplement DialogControl √† la vue √† l'aide de l'extension bindTo. <br>  Nous collectons le AlertDialog habituel et envoyons le r√©sultat via sendResult: </p><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SampleActivity</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PmSupportActivity</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SamplePresentationModel</span></span></span><span class="hljs-class">&gt;</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">providePresentationModel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> = SamplePresentationModel() <span class="hljs-comment"><span class="hljs-comment">//     View  PresentationModel override fun onBindPresentationModel(pm: SamplePresentationModel) { pm.confirmationDialog bindTo { data, dialogControl -&gt; AlertDialog.Builder(this@SampleActivity) .setMessage("Please, confirm the action") .setPositiveButton("Confirm") { _, _ -&gt; dialogControl.sendResult(CONFIRMED) } .setNegativeButton("Cancel") { _, _ -&gt; dialogControl.sendResult(CANCELED) } .create() } button.clicks() bindTo pm.buttonClicks } }</span></span></code> </pre> <br><p>  Dans un sc√©nario typique, quelque chose comme √ßa se passe sous le capot: </p><br><ol><li>  Nous cliquons sur le bouton, l'√©v√©nement √† travers l'action "buttonClicks" entre dans le PresentationModel. </li><li>  Pour cet √©v√©nement, nous lan√ßons l'affichage de la bo√Æte de dialogue via l'appel √† showForResult. </li><li>  Par cons√©quent, l'√©tat dans DialogControl passe d'Absent √† Displayed. </li><li>  Lorsque l'√©v√©nement affich√© est re√ßu, le lambda que nous avons transmis dans la liaison bindTo est appel√©.  Un objet de dialogue y est cr√©√©, qui s'affiche ensuite. </li><li>  L'utilisateur appuie sur le bouton Confirmer, l'√©couteur se d√©clenche et le r√©sultat du clic est envoy√© √† DialogControl en appelant sendResult. </li><li>  Ensuite, le r√©sultat tombe dans le ¬´r√©sultat¬ª de l'action interne et l'√©tat de Affich√© passe √† Absent. </li><li>  Lorsqu'un √©v√©nement absent est re√ßu, la bo√Æte de dialogue actuelle se ferme. </li><li>  L'√©v√©nement du ¬´r√©sultat¬ª de l'action tombe dans le flux qui a √©t√© ouvert par l'appel √† showForResult et est trait√© par la cha√Æne dans PresentationModel. </li></ol><br><p>  Il convient de noter que la bo√Æte de dialogue se ferme m√™me lorsque View est d√©tach√© de PresentationModel.  Dans ce cas, le statut reste affich√©.  Il sera re√ßu lors de la prochaine reliure et le dialogue sera r√©tabli. </p><br><p>  Comme vous pouvez le voir, le besoin de DialogFragment a disparu.  La bo√Æte de dialogue s'affiche lorsque la vue est attach√©e au mod√®le de pr√©sentation et est masqu√©e lorsque la vue est d√©li√©e.  En raison du fait que l'√©tat est stock√© dans DialogControl, qui √† son tour est stock√© dans PresentationModel, la bo√Æte de dialogue est restaur√©e apr√®s la rotation de l'appareil. </p><br><h1 id="pishite-dialogi-pravilno">  Ecrire correctement les dialogues </h1><br><p>  Nous avons examin√© plusieurs fa√ßons d'afficher les bo√Ætes de dialogue.  Si vous montrez toujours de la premi√®re mani√®re, alors je vous en prie, ne le faites plus.  Pour les amateurs de MVP, il ne reste plus qu'√† utiliser la m√©thode standard, qui est d√©crite dans la documentation officielle.  Malheureusement, la tendance √† l'imp√©rativit√© de ce sch√©ma ne permet pas de faire autrement.  Eh bien, je recommande aux fans de RxJava de regarder de plus pr√®s la m√©thode r√©active et notre biblioth√®que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">RxPM</a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr440284/">https://habr.com/ru/post/fr440284/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr440274/index.html">Cr√©ation d'un service de devise priv√© √† l'aide d'Exonum</a></li>
<li><a href="../fr440276/index.html">D√©bogage frontal et principal</a></li>
<li><a href="../fr440278/index.html">Passer Tinder √† Kubernetes</a></li>
<li><a href="../fr440280/index.html">Examen du logiciel libre Android</a></li>
<li><a href="../fr440282/index.html">Les frameworks Web Python les plus rapides en 2019</a></li>
<li><a href="../fr440286/index.html">Bruit Perlin, g√©n√©ration de contenu proc√©dural et espace int√©ressant</a></li>
<li><a href="../fr440288/index.html">S√©curit√© IoT. Num√©ro 1. Montres intelligentes, trackers de fitness et balances</a></li>
<li><a href="../fr440292/index.html">Le livre ¬´L'unit√© en action. D√©veloppement multiplateforme en C #. 2e int. √©dition ¬ª</a></li>
<li><a href="../fr440294/index.html">Routeur MIDI sur Raspberry Pi</a></li>
<li><a href="../fr440296/index.html">6 Applications pour l'IoT industriel</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>