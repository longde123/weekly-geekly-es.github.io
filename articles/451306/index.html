<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíù ü§û üñ®Ô∏è QEMU.js: ahora en serio y con WASM üåª üë®üèΩ‚Äçü§ù‚Äçüë®üèº üôçüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="√ârase una vez, en aras de la risa, decid√≠ probar la reversibilidad del proceso y aprender a generar JavaScript (o m√°s bien, Asm.js) a partir del c√≥dig...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>QEMU.js: ahora en serio y con WASM</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/451306/"><p>  √ârase una vez, en aras de la risa, decid√≠ <em>probar la reversibilidad del proceso</em> y aprender a generar JavaScript (o m√°s bien, Asm.js) a partir del c√≥digo de la m√°quina.  QEMU fue elegido para el experimento, alg√∫n tiempo despu√©s se escribi√≥ un art√≠culo sobre Habr.  En los comentarios, me aconsejaron rehacer el proyecto en WebAssembly, y yo mismo no ten√≠a ganas de abandonar el proyecto <em>casi terminado</em> ... El trabajo continu√≥, pero muy lentamente, y ahora, en ese art√≠culo, apareci√≥ un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">comentario</a> sobre el tema "Entonces, ¬øc√≥mo termin√≥?".  A mi respuesta detallada, escuch√© "Se tira de un art√≠culo".  Bueno, si tiras, habr√° un art√≠culo.  Tal vez alguien sea √∫til.  A partir de √©l, el lector aprende algunos datos sobre la generaci√≥n de c√≥digo QEMU de backends del dispositivo, as√≠ como sobre c√≥mo escribir un compilador Just-in-Time para una aplicaci√≥n web. </p><a name="habracut"></a><br><h2 id="zadachi">  Las tareas </h2><br><p>  Como ya aprend√≠ a portar QEMU a JavaScript de alguna manera, esta vez se decidi√≥ hacerlo con prudencia y no repetir viejos errores. </p><br><h3 id="oshibka-nomer-raz-otvetvitsya-ot-point-release">  Error n√∫mero de veces: ramificaci√≥n desde la liberaci√≥n </h3><br><p> Mi primer error fue bifurcar mi versi√≥n de la versi√≥n ascendente 2.4.1.  Entonces me pareci√≥ una buena idea: si existe una liberaci√≥n puntual, entonces es probable que sea m√°s estable que un simple 2.4, y m√°s a√∫n, <code>master</code> rama <code>master</code> .  Y como estaba planeando agregar una buena cantidad de mis errores, no necesitaba extra√±os en absoluto.  Entonces probablemente sucedi√≥.  Pero aqu√≠ est√° la mala suerte: QEMU no se detiene, y en alg√∫n momento incluso anunciaron la optimizaci√≥n del c√≥digo de porcentaje generado en 10. "S√≠, ahora me estoy congelando", pens√© <del>  y se interrumpi√≥ </del>  .  Aqu√≠ tenemos que hacer una digresi√≥n: debido a la naturaleza de un solo subproceso de QEMU.js y al hecho de que el QEMU original no implica la ausencia de subprocesamiento m√∫ltiple (es decir, es fundamental para que pueda operar varias rutas de c√≥digo no relacionadas al mismo tiempo, en lugar de simplemente "enlazar todos los n√∫cleos"), las funciones principales de los subprocesos tuvo que "salir" para poder llamar desde afuera.  Esto cre√≥ algunos problemas naturales de fusi√≥n.  Sin embargo, el hecho de que algunos de los cambios de la rama <code>master</code> , con la que trat√© de fusionar mi c√≥digo, tambi√©n se seleccionaron en la versi√≥n de punto (y, por lo tanto, en mi rama), probablemente tampoco agregar√≠a conveniencia. </p><br><p>  En general, decid√≠ que de todos modos el prototipo tiene sentido <del>  tirar </del>  desmonte las piezas y cree una nueva versi√≥n desde cero basada en algo m√°s nuevo y ahora desde el <code>master</code> . </p><br><h3 id="oshibka-nomer-dva-tlp-metodologiya">  Error n√∫mero dos: metodolog√≠a TLP </h3><br><p>  De hecho, esto no es un error, en general, es solo una caracter√≠stica de crear un proyecto en las condiciones de un malentendido completo de "¬ød√≥nde y c√≥mo moverse?", Y en general "¬øllegaremos all√≠?".  En estas condiciones, la <em>programaci√≥n</em> era una opci√≥n justificable, pero, por supuesto, no quer√≠a repetirla innecesariamente.  Esta vez quer√≠a hacerlo sabiamente: confirmaciones at√≥micas, cambios deliberados de c√≥digo (y no "encadenar caracteres aleatorios hasta que se compila (con advertencias)", como Linus Torvalds dijo una vez sobre alguien, si crees en Wikitatnik), etc. </p><br><h3 id="oshibka-nomer-tri-ne-znaya-brodu-lezt-v-vodu">  Error n√∫mero tres: no saber el vado para meterse en el agua </h3><br><p>  Todav√≠a no me he librado completamente de esto, pero ahora decid√≠ no seguir el camino de la menor resistencia y hacerlo "de una manera adulta", es decir, escribir mi backend TCG desde cero para que no diga m√°s tarde: "S√≠, Por supuesto, lentamente, pero no puedo controlarlo todo: TCI se escribe as√≠ ... ".  Adem√°s, inicialmente esto parec√≠a una soluci√≥n obvia, ya <em>que estaba generando c√≥digo binario</em> .  Como dice el refr√°n, "Recog√≠ Gante, pero no ese": el c√≥digo es, por supuesto, binario, pero el control no puede transferirse a √©l de esa manera: necesita ser empujado expl√≠citamente al navegador para su compilaci√≥n, lo que resulta en un cierto objeto del mundo JS, que Todav√≠a necesito guardar en alguna parte.  Sin embargo, en <del>  normal </del>  Para las arquitecturas RISC, seg√∫n tengo entendido, una situaci√≥n t√≠pica es la necesidad de vaciar expl√≠citamente la cach√© de instrucciones para el c√≥digo regenerado; si esto no es lo que necesitamos, al menos est√° cerca.  Adem√°s, desde mi √∫ltimo intento, aprend√≠ que el control no parece transferirse a la mitad del bloque de traducci√≥n, por lo tanto, realmente no necesitamos que el bytecode se interprete desde ning√∫n desplazamiento, y simplemente podemos generarlo por funci√≥n en TB. </p><br><h2 id="prishli-i-pnuli">  Vino y pate√≥ </h2><br><p>  Aunque comenc√© a reescribir el c√≥digo en julio, el Pendel m√°gico pas√≥ desapercibido: por lo general, las cartas de GitHub vienen como notificaciones de respuestas a problemas y solicitudes de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">extracci√≥n</a> , y luego, de <em>repente</em> , el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Binaryen como un backend qemu</a> en el contexto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">dice</a> : "Aqu√≠ est√°- hizo algo as√≠, tal vez dir√° algo ".  Se trataba de utilizar la biblioteca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Binaryen</a> relacionada con <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Emscripten</a> para crear un WASM JIT.  Bueno, dije que tienes una licencia de Apache 2.0 all√≠, y QEMU en su conjunto se distribuye bajo GPLv2, y no son muy compatibles.  De repente result√≥ que la licencia podr√≠a <em>corregirse de alguna manera</em> (no lo s√©: tal vez, cambiar, tal vez doble licencia, tal vez otra cosa ...).  Esto, por supuesto, me hizo feliz, porque ya hab√≠a mirado el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">formato binario</a> WebAssembly varias veces en ese momento, y de alguna manera estaba triste e incomprensible para m√≠.  Hubo una biblioteca aqu√≠ que engullir√° los bloques b√°sicos con el gr√°fico de transici√≥n, y emitir√° el c√≥digo de bytes, e incluso lo lanzar√° en el int√©rprete si es necesario. </p><br><p>  Luego tambi√©n hab√≠a una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">carta</a> en la lista de correo de QEMU, pero es m√°s probable que se pregunte: "¬øQui√©n la necesita?"  Y, de <strong>repente</strong> , fue necesario.  Como m√≠nimo, puede reunir tales casos de uso si funciona de manera m√°s o menos inteligente: </p><br><ul><li>  lanzar cualquier cosa que ense√±e sin ninguna instalaci√≥n </li><li>  virtualizaci√≥n en iOS, donde, seg√∫n los rumores, la √∫nica aplicaci√≥n que tiene derecho a generar c√≥digo sobre la marcha es el motor JS (¬øes eso cierto?) </li><li>  demostraci√≥n de mini-OS: disco √∫nico, integrado, todo tipo de firmware, etc. </li></ul><br><h2 id="osobennosti-brauzernoy-sredy-vypolneniya">  Caracter√≠sticas del tiempo de ejecuci√≥n del navegador </h2><br><p>  Como dije, QEMU est√° vinculado a subprocesos m√∫ltiples, pero no est√° en el navegador.  Bueno, es decir, como no ... Al principio no estaba all√≠ en absoluto, luego apareci√≥ WebWorkers; seg√∫n tengo entendido, esto es multihilo basado en el paso de mensajes <strong>sin variables</strong> mutuamente <strong>variables</strong> .  Naturalmente, esto crea problemas importantes al portar c√≥digo existente basado en un modelo de memoria compartida.  Luego, bajo presi√≥n del p√∫blico, se implement√≥ bajo el nombre de <code>SharedArrayBuffers</code> .  Poco a poco lo introdujeron, celebraron su lanzamiento en diferentes navegadores, luego celebraron el A√±o Nuevo y luego Meltdown ... Despu√©s de lo cual llegaron a la conclusi√≥n de que la medici√≥n del tiempo es grosera, no grosera, pero con la ayuda de la memoria compartida y un flujo que incrementa el contador, todav√≠a es <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">bastante preciso</a> .  Entonces desactivaron el subprocesamiento m√∫ltiple con memoria compartida.  Parece que luego lo volvieron a encender, pero, como qued√≥ claro desde el primer experimento, hay vida sin √©l, y si es as√≠, intentaremos hacerlo sin depender de subprocesos m√∫ltiples. </p><br><p>  La segunda caracter√≠stica es la imposibilidad de manipulaciones de bajo nivel con la pila: no puede simplemente tomar, guardar el contexto actual y cambiar a uno nuevo con una nueva pila.  La pila virtual de llamadas es administrada por la m√°quina virtual JS.  Parecer√≠a, ¬øcu√°l es el problema, ya que a√∫n decidimos administrar los flujos anteriores de forma completamente manual?  El hecho es que el bloque de entrada-salida en QEMU se implementa a trav√©s de las rutinas, y aqu√≠ las manipulaciones de la pila de bajo nivel nos ser√≠an √∫tiles.  Afortunadamente, Emscipten ya contiene un mecanismo para operaciones asincr√≥nicas, incluso dos: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Asyncify</a> y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Emterpreter</a> .  El primero funciona mediante una hinchaz√≥n significativa del c√≥digo JavaScript generado y ya no es compatible.  El segundo es el "camino correcto" actual y funciona a trav√©s de la generaci√≥n de bytecode para su propio int√©rprete.  Funciona, por supuesto, lentamente, pero no infla el c√≥digo.  Es cierto que el soporte de rutina para este mecanismo ten√≠a que atribuirse por s√≠ solo (ya hab√≠a corutinas escritas en Asyncify y hab√≠a una implementaci√≥n de aproximadamente la misma API para Emterpreter, solo ten√≠a que conectarlas). </p><br><p>  Por el momento, a√∫n no he logrado dividir el c√≥digo en compilado en WASM e interpretado usando Emterpreter, por lo que los dispositivos de bloque a√∫n no funcionan (vea la pr√≥xima serie, como dicen ...).  Es decir, al final, deber√≠as obtener algo tan divertido en capas: </p><br><ul><li>  bloque interpretado E / S.  Bueno, ¬ørealmente esperabas un NVMe emulado con rendimiento nativo?  :) </li><li>  C√≥digo QEMU principal compilado est√°ticamente (traductor, otros dispositivos emulados, etc.) </li><li>  C√≥digo de invitado compilado din√°micamente WASM </li></ul><br><h2 id="osobennosti-ishodnikov-qemu">  Caracter√≠sticas de las fuentes QEMU </h2><br><p>  Como probablemente ya haya adivinado, el c√≥digo de emulaci√≥n para arquitecturas invitadas y el c√≥digo para generar instrucciones de m√°quina host desde QEMU est√°n separados.  De hecho, hay incluso un poco m√°s complicado: </p><br><ul><li>  hay arquitecturas invitadas </li><li>  hay <em>aceleradores</em> , a saber, KVM para la virtualizaci√≥n de hardware en Linux (para sistemas invitados y host compatibles), TCG para la generaci√≥n de c√≥digo JIT en cualquier lugar.  Comenzando con QEMU 2.9, apareci√≥ soporte para el est√°ndar de virtualizaci√≥n de hardware HAXM en Windows ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">detalles</a> ) </li><li>  si se usa TCG, y no la virtualizaci√≥n de hardware, entonces tiene soporte separado para la generaci√≥n de c√≥digo para cada arquitectura de host, as√≠ como para un int√©rprete universal </li><li>  ... y todo alrededor: perif√©ricos emulados, interfaz de usuario, migraci√≥n, grabaci√≥n de repetici√≥n, etc. </li></ul><br><p>  <em>Por cierto, ¬øsab√≠as que</em> QEMU puede emular no solo toda la computadora, sino tambi√©n el procesador para un proceso de usuario separado en el n√∫cleo del host, que es utilizado, por ejemplo, por el fuzzer AFL para instrumentaci√≥n de binarios.  ¬øQuiz√°s alguien quiere portar este modo de operaci√≥n QEMU a JS?  ;) </p><br><p>  Como la mayor√≠a de los programas gratuitos de larga data, QEMU se crea a trav√©s de una llamada para <code>configure</code> y <code>make</code> .  Supongamos que decide agregar algo: un backend TCG, una implementaci√≥n de subproceso, algo m√°s.  No se apresure a alegrarse / horrorizarse (subraye seg√∫n sea necesario) la posibilidad de comunicarse con Autoconf; de hecho, la <code>configure</code> en QEMU parece ser autoescrita y no hay nada para generar. </p><br><h2 id="webassembly">  Montaje web </h2><br><p>  Entonces, ¬øqu√© es esto: WebAssembly (tambi√©n conocido como WASM)?  Este es un reemplazo para Asm.js, ahora ya no pretende ser un c√≥digo JavaScript v√°lido.  Por el contrario, es puramente binario y optimizado, e incluso escribir un n√∫mero entero en √©l no es muy simple: se almacena en formato <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">LEB128</a> para que sea <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">compacto</a> . </p><br><p>  Es posible que haya escuchado sobre el algoritmo de relooping para Asm.js: restaurar las instrucciones de control de flujo de ejecuci√≥n de "alto nivel" (es decir, if-then-else, bucles, etc.) bajo las cuales los motores JS se sintonizan desde el IR LLVM de bajo nivel, m√°s cerca del c√≥digo de m√°quina ejecutado por el procesador.  Naturalmente, la representaci√≥n intermedia de QEMU est√° m√°s cerca de la segunda.  Parece que aqu√≠ est√°, bytecode, el final del tormento ... ¬°Y luego los bloques, if-then-else y loops! .. </p><br><p>  Y esta es otra raz√≥n por la que Binaryen es √∫til: por supuesto, puede aceptar bloques de alto nivel cercanos a lo que se almacenar√° en WASM.  Pero tambi√©n puede producir c√≥digo a partir del gr√°fico de bloques base y transiciones entre ellos.  Bueno, ya dije que oculta el formato de almacenamiento WebAssembly detr√°s de la conveniente API C / C ++. </p><br><h2 id="tcg-tiny-code-generator">  TCG (Generador de c√≥digo min√∫sculo) </h2><br><p>  TCG <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">fue originalmente un</a> backend para el compilador de C. Luego, aparentemente, no pudo soportar la competencia con GCC, pero al final encontr√≥ su lugar en QEMU como un mecanismo de generaci√≥n de c√≥digo para la plataforma host.  Tambi√©n hay un backend TCG que genera un bytecode abstracto, que el int√©rprete ejecuta inmediatamente, pero decid√≠ irme esta vez.  Sin embargo, el hecho de que QEMU ya tenga la capacidad de permitir la transici√≥n a la TB generada a trav√©s de la funci√≥n <code>tcg_qemu_tb_exec</code> fue muy √∫til para m√≠. </p><br><p>  Para agregar un nuevo backend TCG a QEMU, debe crear un subdirectorio <code>tcg/&lt; &gt;</code> (en este caso, <code>tcg/binaryen</code> ), y hay dos archivos en √©l: <code>tcg-target.h</code> y <code>tcg-target.inc.c</code> y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">registrar</a> todo Esto es <code>configure</code> .  Puede colocar otros archivos all√≠, pero, como puede adivinar por los nombres de estos dos, ambos se incluir√°n en alguna parte: uno como un archivo de encabezado normal (se incluir√° en <code>tcg/tcg.h</code> , y ese ya estar√° en otros archivos en los directorios <code>tcg</code> , <code>accel</code> y no solo), el otro solo como fragmento de c√≥digo en <code>tcg/tcg.c</code> , pero tiene acceso a sus funciones est√°ticas. </p><br><p>  Habiendo decidido que pasar√≠a demasiado tiempo en los procedimientos detallados, c√≥mo funciona, simplemente copi√© los "esqueletos" de estos dos archivos de otra implementaci√≥n de back-end, honestamente indicando esto en el encabezado de la licencia. </p><br><p>  El <code>tcg-target.h</code> contiene principalmente configuraciones en forma de <code>#define</code> s: </p><br><ul><li>  cu√°ntos registros y qu√© ancho tiene la arquitectura de destino (tenemos, por mucho que queramos, hay tantos, la pregunta es m√°s que lo que generar√° el navegador en un c√≥digo m√°s eficiente en una arquitectura "completamente objetivo" ...) </li><li>  alineaci√≥n de las instrucciones del host: en x86 y en TCI, las instrucciones no se alinean en absoluto, pero voy a poner en el b√∫fer de c√≥digo no instrucciones en absoluto, sino punteros a las estructuras de la biblioteca Binaryen, as√≠ que dir√©: 4 bytes </li><li>  qu√© instrucciones opcionales puede generar el backend: active todo lo que encontremos en Binaryen, deje que el acelerador divida el resto en otros m√°s simples </li><li>  qu√© tama√±o aproximado de la cach√© TLB es solicitado por el backend.  El hecho es que en QEMU todo es serio: aunque hay funciones auxiliares que cargan / almacenan teniendo en cuenta el MMU invitado (¬øy d√≥nde ahora sin √©l?), Guardan su cach√© de traducci√≥n en forma de estructura, cuyo procesamiento es conveniente para incrustar directamente a los bloques de traducci√≥n.  La pregunta es, ¬øqu√© compensaci√≥n en esta estructura es manejada m√°s eficientemente por una secuencia peque√±a y r√°pida de comandos? </li><li>  aqu√≠ puede cambiar el prop√≥sito de uno o dos registros reservados, habilitar la llamada de TB a trav√©s de una funci√≥n y, opcionalmente, describir un par de peque√±as funciones en <code>inline</code> como <code>flush_icache_range</code> (pero este no es nuestro caso) </li></ul><br><p>  El <code>tcg-target.inc.c</code> , por supuesto, suele ser mucho m√°s grande y contiene varias funciones necesarias: </p><br><ul><li>  inicializaci√≥n, que indica, entre otras cosas, restricciones sobre qu√© instrucci√≥n con qu√© operandos pueden trabajar.  Insolentemente copiado por m√≠ de otro backend </li><li>  funci√≥n que acepta una instrucci√≥n de bytecode interno </li><li>  aqu√≠ puede poner funciones auxiliares, y tambi√©n aqu√≠ puede usar funciones est√°ticas de <code>tcg/tcg.c</code> </li></ul><br><p>  Para m√≠, eleg√≠ la siguiente estrategia: en las primeras palabras del siguiente bloque de transmisi√≥n, escrib√≠ cuatro punteros: la marca de inicio (un cierto valor en la vecindad de <code>0xFFFFFFFF</code> , que determin√≥ el estado actual de TB), el contexto, el m√≥dulo generado y el n√∫mero m√°gico para la depuraci√≥n.  Primero, la etiqueta se configur√≥ en <code>0xFFFFFFFF - n</code> , donde <code>n</code> es un n√∫mero positivo peque√±o, y cada vez a trav√©s del int√©rprete aument√≥ en 1. Cuando lleg√≥ a <code>0xFFFFFFFE</code> , se produjo la compilaci√≥n, el m√≥dulo se almacen√≥ en la tabla de funciones, importada en un peque√±o "lanzador", en el que la ejecuci√≥n dej√≥ <code>tcg_qemu_tb_exec</code> , y el m√≥dulo se elimin√≥ de la memoria QEMU. </p><br><p>  Parafraseando a los cl√°sicos, "Crutch, cu√°nto proger se ha entrelazado en este sonido para el coraz√≥n ...".  Sin embargo, el recuerdo estaba goteando en alguna parte.  ¬°Y fue un recuerdo administrado por QEMU!  Ten√≠a un c√≥digo que, al escribir la siguiente instrucci√≥n (bueno, es decir, un puntero), eliminaba el enlace al que estaba en este lugar anteriormente, pero eso no ayud√≥.  En realidad, en el caso m√°s simple, QEMU asigna memoria al inicio y escribe el c√≥digo generado all√≠.  Cuando finaliza el b√∫fer, el c√≥digo se descarta y el siguiente comienza a escribirse en su lugar. </p><br><p>  Despu√©s de estudiar el c√≥digo, me di cuenta de que la muleta con n√∫mero m√°gico nos permit√≠a no caer en la destrucci√≥n del mont√≥n, liberando algo mal en el b√∫fer no inicializado en el primer paso.  ¬øPero qui√©n sobrescribe el b√∫fer sin pasar por mi funci√≥n m√°s tarde?  Como aconsejaron los desarrolladores de Emscripten, despu√©s de haber tenido un problema, volv√≠ el c√≥digo resultante a la aplicaci√≥n nativa, configur√© Mozilla Record-Replay en √©l ... En general, como resultado, me di cuenta de una cosa simple: se asigna una <code>struct TranslationBlock</code> con su descripci√≥n para cada bloque.  Adivina d√≥nde ... As√≠ es, justo en frente del bloque justo en el b√∫fer.  Al darme cuenta de esto, decid√≠ atarlo con muletas (al menos algunas), y simplemente tir√© el n√∫mero m√°gico y transfir√≠ las palabras restantes a la <code>struct TranslationBlock</code> , creando una lista de enlaces √∫nicos que puede recorrer r√°pidamente al restablecer el cach√© de traducci√≥n y liberar memoria. </p><br><p>  Quedaron algunas muletas: por ejemplo, punteros marcados en el b√∫fer de c√≥digo; algunos de ellos son simplemente <code>BinaryenExpressionRef</code> , es decir, miran expresiones que deben colocarse linealmente en la unidad base generada, parte, la condici√≥n de transici√≥n entre los WB, parte, a d√≥nde ir.  Bueno, ya hay bloques preparados para Relooper, que deben conectarse de acuerdo con las condiciones.  Para distinguir entre ellos, se asume que todos est√°n alineados con al menos cuatro bytes, por lo que puede usar con seguridad los dos bits inferiores de la etiqueta, solo necesita recordar eliminarlo si es necesario.  Por cierto, tales etiquetas ya se usan en QEMU para indicar la raz√≥n para salir del ciclo TCG. </p><br><h2 id="ispolzovanie-binaryen">  Usando Binaryen </h2><br><p>  Los m√≥dulos en WebAssembly contienen funciones, cada una de las cuales contiene un cuerpo que representa una expresi√≥n.  Las expresiones son operaciones unarias y binarias, bloques que consisten en listas de otras expresiones, flujo de control, etc.  Como ya dije, el flujo de control aqu√≠ est√° organizado precisamente como ramas de alto nivel, bucles, llamadas a funciones, etc.  Los argumentos a las funciones se pasan no en la pila, sino expl√≠citamente, como en JS.  Hay variables globales, pero no las utilic√©, as√≠ que no hablar√© sobre ellas. </p><br><p>  Las funciones tambi√©n tienen variables locales, numeradas desde cero, del tipo: int32 / int64 / float / double.  Las primeras n variables locales son los argumentos pasados ‚Äã‚Äãa la funci√≥n.  Tenga en cuenta que aunque todo aqu√≠ no es del todo bajo en t√©rminos de flujo de control, los enteros a√∫n no llevan el signo con signo / sin signo: c√≥mo se comportar√° el n√∫mero depende del c√≥digo de operaci√≥n. </p><br><p>  En t√©rminos generales, Binaryen proporciona una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">C-API simple</a> : crea un m√≥dulo, <strong>en √©l</strong> crea expresiones: unario, binario, bloques de otras expresiones, flujo de control, etc.  Luego crea una funci√≥n, cuyo cuerpo necesita para especificar una expresi√≥n.  Si usted, como yo, tiene un gr√°fico de transici√≥n de bajo nivel, el componente relooper lo ayudar√°.  Seg√∫n tengo entendido, es posible utilizar un control de alto nivel del flujo de ejecuci√≥n en el bloque, siempre que no supere los l√≠mites del bloque, es decir, es posible hacer una rama interna de ruta r√°pida / ruta lenta dentro del c√≥digo de procesamiento de cach√© TLB incorporado, pero no hay interferencia .  Cuando liberas relooper, sus bloques se liberan, cuando liberas un m√≥dulo, las expresiones, funciones, etc., asignadas en su <em>arena</em> desaparecen. </p><br><p>  Sin embargo, si desea interpretar el c√≥digo sobre la marcha sin la creaci√≥n y eliminaci√≥n innecesarias de la instancia del int√©rprete, puede tener sentido transferir esta l√≥gica a un archivo C ++, y desde all√≠ controlar directamente toda la biblioteca API de C ++, sin pasar por los contenedores terminados. </p><br><p>  Por lo tanto, para generar el c√≥digo, necesita </p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//    (  ) BinaryenSetAPITracing(0); BinaryenSetOptimizeLevel(3); BinaryenSetShrinkLevel(2); //   BinaryenModuleRef MODULE = BinaryenModuleCreate(); //    ( ,   ) helper_type BinaryenAddFunctionType(MODULE, "helper-func", BinaryenTypeInt32(), int32_helper_args, ARRAY_SIZE(int32_helper_args)); // (int23_helper_args ^W ) //  -  // ...     -  :) //    BinaryenAddFunction(MODULE, "tb_fun", tb_func_type, func_locals, FUNC_LOCALS_COUNT, expr); BinaryenAddFunctionExport(MODULE, "tb_fun", "tb_fun"); ... BinaryenSetMemory(MODULE, (1 &lt;&lt; 15) - 1, -1, NULL, NULL, NULL, NULL, NULL, 0, 0); BinaryenAddMemoryImport(MODULE, NULL, "env", "memory", 0); BinaryenAddTableImport(MODULE, NULL, "env", "tb_funcs"); //       assert (BinaryenModuleValidate(MODULE)); BinaryenModuleOptimize(MODULE);</span></span></code> </pre> <br><p> ‚Ä¶    ‚Äî ,     ,   ‚Äî   . </p><br><p>    --,  : </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buf[<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">20</span></span>]; BinaryenModuleOptimize(MODULE); BinaryenSetMemory(MODULE, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">-1</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> sz = BinaryenModuleWrite(MODULE, buf, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(buf)); BinaryenModuleDispose(MODULE); EM_ASM({ var <span class="hljs-keyword"><span class="hljs-keyword">module</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WebAssembly.Module(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Uint8Array(wasmMemory.buffer, $<span class="hljs-number"><span class="hljs-number">0</span></span>, $<span class="hljs-number"><span class="hljs-number">1</span></span>)); var fptr = $<span class="hljs-number"><span class="hljs-number">2</span></span>; var instance = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WebAssembly.Instance(<span class="hljs-keyword"><span class="hljs-keyword">module</span></span>, { <span class="hljs-string"><span class="hljs-string">'env'</span></span>: { <span class="hljs-string"><span class="hljs-string">'memory'</span></span>: wasmMemory, <span class="hljs-comment"><span class="hljs-comment">// ... } ); //       instance! }, buf, sz);</span></span></code> </pre> <br><p>  -     QEMU  JS        ,    (     ),     .    ,         translation block,   ,           <code>struct TranslationBlock</code> . </p><br><p> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="></a> <em>(    )</em>     Firefox.  Chrome  <em>-  </em>  ,  -       WebAssembly,          ... </p><br><p>     . ,    ,   - .  ,    <em> </em>    . ,      WebAssembly  ,       JS,      ,     ,     . </p><br><p> <strong><strong> :</strong></strong>     32- ,         Binaryen, -     -   2  32-  .   ,     Binaryen       .   ? </p><br><div class="spoiler"> <b class="spoiler_title">-</b> <div class="spoiler_text"><p>      ,     ¬´ ,   32- Linux?¬ª        .    ,   : 1  2 Gb. </p></div></div><br><div class="spoiler"> <b class="spoiler_title">- (  )</b> <div class="spoiler_text"><p>       .    ,    ‚Äî   <strong></strong>   .  ¬´ :    ,     ...¬ª. </p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// 2gbubble.c // Usage: LD_PRELOAD=2gbubble.so &lt;program&gt; #include &lt;sys/mman.h&gt; #include &lt;assert.h&gt; void __attribute__((constructor)) constr(void) { assert(MAP_FAILED != mmap(1u &gt;&gt; 31, (1u &gt;&gt; 31) - (1u &gt;&gt; 20), PROT_NONE, MAP_ANONYMOUS | MAP_PRIVATE, -1, 0)); }</span></span></code> </pre> <br><p> ‚Ä¶  Valgrind-, ,  , ,  , Valgrind       :) </p><br><p> <em>, -   ,     ...</em> </p></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/451306/">https://habr.com/ru/post/451306/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../451294/index.html">A medida que agregu√© funciones al autom√≥vil a trav√©s de CAN, no pude programar</a></li>
<li><a href="../451296/index.html">Anunciado por ML.NET 1.0</a></li>
<li><a href="../451298/index.html">C√≥mo hacer una consola de juegos con una caja ordenando una placa de circuito impreso</a></li>
<li><a href="../451302/index.html">Las mejores empresas de outsourcing de TI</a></li>
<li><a href="../451304/index.html">"Punta" de Yandex: c√≥mo maximizar las ganancias en una suscripci√≥n paga</a></li>
<li><a href="../451310/index.html">¬øEchas de menos el PDA?</a></li>
<li><a href="../451314/index.html">Producci√≥n de placas de circuito impreso LUT'om de la A a la Z</a></li>
<li><a href="../451316/index.html">Sobre una facultad de f√≠sica</a></li>
<li><a href="../451318/index.html">Dart 2.3 anunciado: optimizado para el desarrollo de la interfaz de usuario</a></li>
<li><a href="../451320/index.html">Por qu√© abrir el firmware es importante para la seguridad</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>