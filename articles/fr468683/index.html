<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üöª üßóüèæ üë©üèø‚Äçüíº Th√©orie et pratique de la normalisation des services Docker üî≥ üòÅ ü¶É</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Les informations sur le th√®me de l'architecture des applications de microservices, qui ont d√©j√† r√©ussi √† combler leur retard, suffisent aujourd'hui po...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Th√©orie et pratique de la normalisation des services Docker</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/antiplagiat/blog/468683/"><p>  Les informations sur le th√®me de l'architecture des applications de microservices, qui ont d√©j√† r√©ussi √† combler leur retard, suffisent aujourd'hui pour d√©cider si elles conviennent ou non √† votre produit.  Et ce n'est pas du tout un secret que les entreprises qui ont d√©cid√© de choisir cette voie doivent faire face √† de nombreux d√©fis d'ing√©nierie et de culture.  L'une des sources de probl√®mes est les frais g√©n√©raux qui se multiplient partout, et cela s'applique √©galement √† la routine associ√©e aux processus de production. </p><br><p><img src="https://habrastorage.org/webt/6g/-f/o5/6g-fo54hrcctez4vg4-avzkijc0.jpeg"><br>  <sub><em><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Source de l'image:</a></em></sub> </p><br><p>  Comme vous pouvez le deviner, l'Anti-plagiat est exactement une telle entreprise, o√π la compr√©hension est progressivement venue que nous sommes avec des microservices en cours de route.  Mais avant de commencer √† manger le cactus, nous avons d√©cid√© de le nettoyer et de le faire cuire.  Et puisque toutes les seules solutions vraies et correctes pour chacune sont uniques, au lieu de diapositives DevOps universelles avec de belles fl√®ches, nous avons d√©cid√© de partager notre propre exp√©rience et de dire comment nous avons d√©j√† couvert une partie consid√©rable de notre chemin sp√©cial vers, je l'esp√®re, le succ√®s. </p><a name="habracut"></a><br><p>  Si vous fabriquez un produit vraiment unique, largement constitu√© de savoir-faire, il n'y a presque aucune chance d'esquiver ce chemin sp√©cial, car il est form√© de nombreux chemins priv√©s: √† partir de la culture et des donn√©es historiques qui se sont d√©velopp√©es dans l'entreprise, se terminant par sa propre sp√©cificit√© et la pile technologique utilis√©e . </p><br><p>  L'une des t√¢ches de toute entreprise et √©quipe est de trouver l'√©quilibre optimal entre les libert√©s et les r√®gles, et les microservices portent ce probl√®me √† un nouveau niveau.  Cela peut sembler contredire l'id√©e m√™me de microservices, qui implique une grande libert√© dans le choix des technologies, mais si vous ne vous concentrez pas directement sur les probl√®mes architecturaux et technologiques, mais regardez les probl√®mes de production en g√©n√©ral, alors le risque d'√™tre quelque part dans l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">intrigue du</a> ¬´Jardin des d√©lices terrestres¬ª est tout √† fait tangible. . </p><br><p> Cependant, dans l'ouvrage "Cr√©ation de microservices" Sam Newman propose une solution √† ce probl√®me, o√π litt√©ralement d√®s les premi√®res pages il √©voque la n√©cessit√© de limiter la cr√©ativit√© des √©quipes dans le cadre d'accords techniques.  Ainsi, l'une des cl√©s du succ√®s, en particulier dans le contexte d'une ressource √† main lev√©e limit√©e, est la standardisation de tout ce qui ne peut √™tre n√©goci√© et que personne ne voudrait vraiment faire tout le temps.  En √©laborant des accords, nous cr√©ons des r√®gles du jeu claires pour tous les participants √† la production et au fonctionnement des composants du syst√®me.  Et connaissant les r√®gles du jeu, vous devez √™tre d'accord, jouer devrait √™tre plus facile et plus agr√©able.  Cependant, suivre ces r√®gles elles-m√™mes peut devenir une routine et causer de l'inconfort aux participants, ce qui entra√Æne directement toutes sortes de d√©viations par rapport √† elles et, par cons√©quent, l'√©chec de l'id√©e dans son ensemble.  Et le moyen le plus √©vident est de mettre tous les accords dans le code, car aucune r√©glementation ne peut faire ce que l'automatisation et les outils pratiques peuvent utiliser, dont l'utilisation est intuitive et naturelle. </p><br><p>  En allant dans cette direction, nous avons pu automatiser de plus en plus, et plus notre processus est devenu comme un convoyeur de bout en bout pour la production de biblioth√®ques et de micro (ou pas) services. </p><br><p></p><div class="spoiler">  <b class="spoiler_title">Clause de non-responsabilit√©</b> <div class="spoiler_text">  Ce texte n'est pas une tentative d'indiquer ¬´comme il se doit¬ª, il n'y a pas de solutions universelles, seulement une description de notre position sur le chemin √©volutif et la direction choisie.  Tout ce qui pr√©c√®de peut ne pas convenir √† tout le monde, mais dans notre cas, cela a du sens principalement parce que: <br><br>  - Le d√©veloppement dans l'entreprise dans 90% des cas se fait en C #; <br>  - Il n'√©tait pas n√©cessaire de repartir de z√©ro, une partie des normes, approches et technologies accept√©es - c'est le r√©sultat d'une exp√©rience ou simplement d'un h√©ritage historique; <br>  - Des r√©f√©rentiels avec des projets .NET, contrairement aux √©quipes, des dizaines (et il y en aura plus); <br>  - Nous aimons utiliser un pipeline CI tr√®s simple, en √©vitant autant que possible le blocage des fournisseurs; <br>  - Pour un d√©veloppeur .NET ordinaire, les mots "conteneur", "docker" et "Linux" peuvent toujours provoquer des √©pisodes de l√©g√®re horreur existentielle, mais je ne veux pas briser qui que ce soit par le genou. </div></div><br><h2 id="nemnogo-predystorii">  Un peu de fond </h2><br><p>  Au printemps 2017, Microsoft a pr√©sent√© au monde un aper√ßu de .NET Core 2.0, et cette ann√©e, les astrologues C # se sont imm√©diatement pr√©cipit√©s pour d√©clarer l'ann√©e Linux, alors ... </p><br><p><img src="https://habrastorage.org/webt/ex/zm/0r/exzm0rw_jaawe48lclqgweok1rq.png"><br>  <sub><em><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Source de l'image:</a></em></sub> </p><br><p>  Pendant un certain temps, nous, ne faisant pas confiance √† la magie, avons tout collect√© et test√© sur Windows et Linux, publi√© des artefacts avec certains scripts SSH, essay√© de configurer les anciens pipelines CI / CD en mode couteau suisse.  Mais apr√®s un certain temps, ils ont r√©alis√© que nous faisions quelque chose de mal.  De plus, les r√©f√©rences aux microservices et aux conteneurs r√©sonnaient de plus en plus souvent.  Nous avons donc √©galement d√©cid√© de surfer sur la vague de battage m√©diatique et d'explorer ces directions. </p><br><p>  D√©j√† au stade de la r√©flexion sur notre futur possible de microservices, un certain nombre de questions se sont pos√©es, ignorant lesquelles, nous avons risqu√© dans ce tout futur de nouveaux probl√®mes que nous aurions nous-m√™mes cr√©√©s en √©change de leur r√©solution. </p><br><p>  Premi√®rement, lorsque nous regardons le c√¥t√© op√©rationnel du monde th√©orique des microservices sans r√®gles, nous avons √©t√© effray√©s par la perspective du chaos avec toutes les cons√©quences qui en d√©coulent, y compris non seulement la qualit√© impr√©visible du r√©sultat, mais aussi les conflits entre √©quipes ou d√©veloppeurs et ing√©nieurs.  Et essayer de faire des recommandations, ne pas √™tre en mesure de les respecter, semblait imm√©diatement une entreprise vide de sens. </p><br><p>  Deuxi√®mement, personne ne savait vraiment comment cr√©er correctement des conteneurs et √©crire des fichiers dockerfile, qui, n√©anmoins, ont d√©j√† commenc√© √† vivre dans nos r√©f√©rentiels.  De plus, beaucoup ¬´lisent quelque part¬ª que tout n'y est pas si simple.  Donc, quelqu'un a d√ª plonger plus profond√©ment et comprendre, puis revenir avec les meilleures pratiques d'assemblage de conteneurs.  Mais la perspective de jouer le r√¥le d'un docker packer √† plein temps, laiss√© seul avec des piles de fichiers docker, pour une raison quelconque, n'a inspir√© personne dans l'entreprise.  En outre, comme il s'est av√©r√©, plonger une fois n'est clairement pas suffisant, et m√™me √† premi√®re vue, il peut s'av√©rer faux ou tout simplement pas tr√®s bon. </p><br><p>  Et troisi√®mement, je voulais √™tre s√ªr que les images obtenues avec les services seraient non seulement correctes du point de vue des pratiques de conteneur, mais seraient √©galement pr√©visibles dans leur comportement et auraient toutes les propri√©t√©s et attributs n√©cessaires pour simplifier le contr√¥le des conteneurs lanc√©s.  En d'autres termes, je voulais obtenir des images avec des applications qui sont √©galement configur√©es et √©crire des journaux, fournir une interface unique pour obtenir des mesures, avoir un ensemble coh√©rent d'√©tiquettes, etc.  Il √©tait √©galement important que l'assemblage sur l'ordinateur du d√©veloppeur donne le m√™me r√©sultat que l'assemblage sur n'importe quel syst√®me CI, y compris la r√©ussite des tests et la g√©n√©ration d'artefacts. </p><br><p>  Ainsi, une compr√©hension est n√©e qu'un certain processus serait n√©cessaire pour g√©rer et centraliser de nouvelles connaissances, pratiques et normes, et le chemin depuis le premier commit vers une image docker compl√®tement pr√™te pour l'infrastructure du produit devrait √™tre unifi√© et aussi automatis√© que possible, sans aller au-del√† des termes commen√ßant avec le mot continu. </p><br><h2 id="cli-vs-gui">  CLI vs  GUI </h2><br><p>  Le point de d√©part d'un nouveau composant, qu'il s'agisse d'un service ou d'une biblioth√®que, est de cr√©er un r√©f√©rentiel.  Cette √©tape peut √™tre divis√©e en deux parties: cr√©er et configurer le r√©f√©rentiel sur l'h√©bergement du syst√®me de contr√¥le de version (nous avons Bitbucket) et l'initialiser avec la cr√©ation d'une structure de fichiers.  Heureusement, un certain nombre d'exigences existaient d√©j√† pour les deux.  Par cons√©quent, leur formalisation dans le code √©tait une t√¢che logique. </p><br><p>  Alors, quel devrait √™tre notre r√©f√©rentiel: </p><br><ul><li>  Situ√© dans l'un des projets, sur lequel le nom, les droits d'acc√®s, les politiques d'acceptation des demandes de tirage, etc.; </li><li>  Contiennent les fichiers et r√©pertoires requis, tels que: <br><ul><li> fichier avec la configuration et les informations sur le r√©f√©rentiel <code>SolutionInfo.props</code> (plus d'informations ci-dessous); </li><li>  les codes source du projet dans le r√©pertoire <code>src</code> ; </li><li>  <code>.gitignore</code> , <code>README.md</code> , etc.; </li></ul></li><li>  Contient les sous-modules Git n√©cessaires; </li><li>  Le projet doit √™tre d√©riv√© de l'un des mod√®les. </li></ul><br><p>  √âtant donn√© que l'API REST Bitbucket donne un contr√¥le total sur la configuration des r√©f√©rentiels, un utilitaire sp√©cial a √©t√© cr√©√© pour interagir avec elle - le g√©n√©rateur de r√©f√©rentiel.  En mode question-r√©ponse, elle re√ßoit de l'utilisateur toutes les donn√©es n√©cessaires et cr√©e un r√©f√©rentiel qui r√©pond pleinement √† toutes nos exigences, √† savoir: </p><br><ul><li>  D√©finit un projet dans Bitbucket √† choisir; </li><li>  Valide le nom conform√©ment √† notre accord; </li><li>  D√©finit tous les param√®tres n√©cessaires qui ne peuvent pas √™tre h√©rit√©s du projet; </li><li>  <a href="">Met √†</a> jour la liste des mod√®les personnalis√©s (nous utilisons des <a href="">mod√®les dotnet</a> ) pour le projet et sugg√®re de choisir parmi ceux-ci; </li><li>  Remplit le minimum d'informations n√©cessaires sur le r√©f√©rentiel dans le fichier de configuration et dans les documents <code>*.md</code> ; </li><li>  Il connecte les sous-modules avec la configuration du pipeline CI / CD (dans notre cas, c'est <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Bamboo Specs</a> ) et les scripts d'assemblage. </li></ul><br><p>  En d'autres termes, le d√©veloppeur, en commen√ßant un nouveau projet, lance l'utilitaire, remplit plusieurs champs, s√©lectionne le type de projet et re√ßoit, par exemple, le ¬´Hello world!¬ª Compl√®tement termin√©.  un service qui est d√©j√† connect√© au syst√®me CI, d'o√π le service peut m√™me √™tre publi√© si vous effectuez une validation qui change la version en non nul. </p><br><p>  La premi√®re √©tape a √©t√© franchie.  Pas de travail manuel et d'erreurs, recherche de documentation, inscriptions et SMS.  Passons maintenant √† ce qui y a √©t√© g√©n√©r√©. </p><br><h2 id="struktura">  La structure </h2><br><p>  La standardisation de la structure du r√©f√©rentiel a pris racine avec nous depuis longtemps et √©tait n√©cessaire pour simplifier l'assemblage, l'int√©gration avec le syst√®me CI et l'environnement de d√©veloppement.  Initialement, nous sommes partis de l'id√©e que le pipeline dans CI devrait √™tre aussi simple et, comme vous pouvez le deviner, standard, ce qui garantirait la portabilit√© et la reproductibilit√© de l'assemblage.  Autrement dit, le m√™me r√©sultat pourrait √™tre facilement obtenu √† la fois dans n'importe quel syst√®me CI et sur le lieu de travail du d√©veloppeur.  Par cons√©quent, tout ce qui ne se rapporte pas aux fonctionnalit√©s d'un environnement d'int√©gration continue sp√©cifique est soumis √† un sous-module Git sp√©cial et est un syst√®me de construction autosuffisant.  Plus pr√©cis√©ment, le syst√®me de normalisation de l'assemblage.  Le pipeline lui-m√™me, dans une approximation minimale, ne doit ex√©cuter que le script <code>build.sh</code> , r√©cup√©rer un rapport sur les tests et lancer un d√©ploiement, si n√©cessaire.  Pour plus de clart√©, voyons ce qui se passe si vous g√©n√©rez le r√©f√©rentiel <em>SampleService</em> dans un projet avec le nom parlant <em>Sandbox</em> . </p><br><pre> <code class="plaintext hljs">. ‚îú‚îÄ‚îÄ [bamboo-specs] ‚îú‚îÄ‚îÄ [devops.build] ‚îÇ ‚îú‚îÄ‚îÄ build.sh ‚îÇ ‚îî‚îÄ‚îÄ ... ‚îú‚îÄ‚îÄ [docs] ‚îú‚îÄ‚îÄ [.scripts] ‚îú‚îÄ‚îÄ [src] ‚îÇ ‚îú‚îÄ‚îÄ [CodeAnalysis] ‚îÇ ‚îú‚îÄ‚îÄ [Sandbox.SampleService] ‚îÇ ‚îú‚îÄ‚îÄ [Sandbox.SampleService.Bootstrap] ‚îÇ ‚îú‚îÄ‚îÄ [Sandbox.SampleService.Client] ‚îÇ ‚îú‚îÄ‚îÄ [Sandbox.SampleService.Tests] ‚îÇ ‚îú‚îÄ‚îÄ Directory.Build.props ‚îÇ ‚îú‚îÄ‚îÄ NLog.config ‚îÇ ‚îú‚îÄ‚îÄ NuGet.Config ‚îÇ ‚îî‚îÄ‚îÄ Sandbox.SampleService.sln ‚îú‚îÄ‚îÄ .gitattributes ‚îú‚îÄ‚îÄ .gitignore ‚îú‚îÄ‚îÄ .gitmodules ‚îú‚îÄ‚îÄ CHANGELOG.md ‚îú‚îÄ‚îÄ README.md ‚îî‚îÄ‚îÄ SolutionInfo.props</code> </pre> <br><p>  Les deux premiers r√©pertoires sont des sous-modules Git.  <code>bamboo-specs</code> est ¬´Pipeline as Code¬ª pour le syst√®me Atlassian Bamboo CI (il pourrait y avoir un fichier Jenkins √† sa place), <code>devops.build</code> est notre syst√®me de construction, dont je <code>devops.build</code> plus en d√©tail ci-dessous.  Le r√©pertoire <code>.scripts</code> √©galement.  Le projet .NET lui-m√™me est situ√© dans <code>src</code> : <code>NuGet.Config</code> contient la configuration du r√©f√©rentiel priv√© <acronym>NuGet</acronym> , <code>NLog.config</code> configuration en temps <acronym>r√©el</acronym> de <acronym>NLog</acronym> .  Comme vous pouvez le deviner, l'utilisation de NLog dans une entreprise est √©galement l'une des normes.  Le fichier <code>Directory.Build.props</code> est presque magique.  Pour une raison quelconque, peu de gens connaissent une telle possibilit√© dans les projets .NET, comme la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">personnalisation de l'assembly</a> .  En bref, les fichiers portant les noms <code>Directory.Build.props</code> et <code>Directory.Build.targets</code> automatiquement import√©s dans vos projets et vous permettent de configurer des propri√©t√©s communes pour tous les projets en un seul endroit.  Par exemple, c'est ainsi que nous connectons l'analyseur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">StyleCop.Analyzers</a> et sa configuration √† partir du r√©pertoire <code>CodeAnalysis</code> √† tous les projets de style code, d√©finissons des r√®gles de version et certains attributs communs pour les biblioth√®ques et les packages ( <em>Company</em> , <em>Copyright</em> , etc.), et nous nous connectons √©galement via le <code>&lt;Import&gt;</code> fichier <code>SolutionInfo.props</code> , qui est pr√©cis√©ment le m√™me fichier de configuration de r√©f√©rentiel, qui a √©t√© discut√© ci-dessus.  Il contient d√©j√† la version actuelle, des informations sur les auteurs, l'URL du r√©f√©rentiel et sa description, ainsi que plusieurs propri√©t√©s qui affectent le comportement du syst√®me d'assemblage et les artefacts r√©sultants. </p><br><div class="spoiler">  <b class="spoiler_title">Exemple `SolutionInfo.props`</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Project</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:xsi</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xsi:noNamespaceSchemaLocation</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"devops.build/SolutionInfo.xsd"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Product name --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Product</span></span></span><span class="hljs-tag">&gt;</span></span>Sandbox.SampleService<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Product</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Product version. Version 0.0.0 wouldn't be published! --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BaseVersion</span></span></span><span class="hljs-tag">&gt;</span></span>0.0.0<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BaseVersion</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Project name which contains Main() --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">EntryProject</span></span></span><span class="hljs-tag">&gt;</span></span>Sandbox.SampleService.Bootstrap<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">EntryProject</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Exposed port --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ExposedPort</span></span></span><span class="hljs-tag">&gt;</span></span>4000/tcp<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ExposedPort</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- DOTNET_SYSTEM_GLOBALIZATION_INVARIANT value. See https://github.com/dotnet/corefx/blob/master/Documentation/architecture/globalization-invariant-mode.md --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">GlobalizationInvariant</span></span></span><span class="hljs-tag">&gt;</span></span>false<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">GlobalizationInvariant</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Project URL --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">RepositoryUrl</span></span></span><span class="hljs-tag">&gt;</span></span>https://bitbucket.contoso.com/projects/SND/repos/sandbox.sampleservice/<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">RepositoryUrl</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Documentation URL --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DocumentationUrl</span></span></span><span class="hljs-tag">&gt;</span></span>https://bitbucket.contoso.com/projects/SND/repos/sandbox.sampleservice/browse/README.md<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DocumentationUrl</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Your name here --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Authors</span></span></span><span class="hljs-tag">&gt;</span></span>User Name &amp;lt;username@contoso.com&amp;gt;<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Authors</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Project description --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Description</span></span></span><span class="hljs-tag">&gt;</span></span>The sample service for demo purposes.<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Description</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Bamboo plan key (required for Bamboo Specs --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BambooBlanKey</span></span></span><span class="hljs-tag">&gt;</span></span>SMPL<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BambooBlanKey</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Project</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Exemple `Directory.Build.props`</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Project</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Import</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Condition</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Exists('..\SolutionInfo.props')"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Project</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"..\SolutionInfo.props"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ItemGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">None</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Include</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(MSBuildThisFileDirectory)/CodeAnalysis/stylecop.json"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Link</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"stylecop.json"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">CopyToOutputDirectory</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Never"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PackageReference</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Include</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"StyleCop.Analyzers"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Version</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1.*"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">PrivateAssets</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"all"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ItemGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CodeAnalysisRuleSet</span></span></span><span class="hljs-tag">&gt;</span></span>$(MSBuildThisFileDirectory)/CodeAnalysis/stylecop.ruleset<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CodeAnalysisRuleSet</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Enable XML docs generating--&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">GenerateDocumentationFile</span></span></span><span class="hljs-tag">&gt;</span></span>true<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">GenerateDocumentationFile</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Enable C# 7.x features --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">LangVersion</span></span></span><span class="hljs-tag">&gt;</span></span>latest<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">LangVersion</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- default base version --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BaseVersion</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Condition</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"'$(BaseVersion)' == ''"</span></span></span><span class="hljs-tag">&gt;</span></span>0.0.0<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BaseVersion</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- default build number and format --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BuildNumber</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Condition</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"'$(BuildNumber)' == ''"</span></span></span><span class="hljs-tag">&gt;</span></span>0<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BuildNumber</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BuildNumber</span></span></span><span class="hljs-tag">&gt;</span></span>$([System.String]::Format('{0:0000}',$(BuildNumber)))<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BuildNumber</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- default version suffix --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">VersionSuffix</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Condition</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"'$(VersionSuffix)' == ''"</span></span></span><span class="hljs-tag">&gt;</span></span>local<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">VersionSuffix</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- empty version suffix instead of 'prod' --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">VersionSuffix</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Condition</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"'$(VersionSuffix)' == 'prod'"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">VersionSuffix</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- format version prefix --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">VersionPrefix</span></span></span><span class="hljs-tag">&gt;</span></span>$(BaseVersion).$(BuildNumber)<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">VersionPrefix</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- disable IsPackable by default --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">IsPackable</span></span></span><span class="hljs-tag">&gt;</span></span>false<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">IsPackable</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PackageProjectUrl</span></span></span><span class="hljs-tag">&gt;</span></span>$(RepositoryUrl)<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PackageProjectUrl</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Company</span></span></span><span class="hljs-tag">&gt;</span></span>Contoso<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Company</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Copyright</span></span></span><span class="hljs-tag">&gt;</span></span>Copyright $([System.DateTime]::Now.Date.Year) Contoso Ltd<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Copyright</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Project</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> </div></div><br><h2 id="sborka">  Assemblage </h2><br><p>  Il convient de mentionner tout de suite que moi-m√™me et mes coll√®gues avions d√©j√† une exp√©rience assez r√©ussie dans l‚Äôutilisation de diff√©rents <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">syst√®mes de construction</a> .  Et au lieu de pond√©rer un outil existant avec des fonctionnalit√©s totalement inhabituelles, il a √©t√© d√©cid√© d'en cr√©er un autre, sp√©cialis√© pour notre nouveau processus, et de laisser l'ancien seul pour mener √† bien ses t√¢ches dans le cadre de projets h√©rit√©s.  L'id√©e de correction √©tait le d√©sir d'obtenir un outil qui transformera le code en une image docker qui r√©pond √† toutes nos exigences, en utilisant un processus standard unique, tout en √©liminant la n√©cessit√© pour les d√©veloppeurs de plonger dans les subtilit√©s de l'assemblage, mais en pr√©servant la possibilit√© d'une certaine personnalisation. </p><br><p>  La s√©lection d'un cadre appropri√© a commenc√©.  Sur la base des exigences de reproductibilit√© du r√©sultat √† la fois sur les machines de build avec Linux et sur les machines Windows de tout d√©veloppeur, la v√©ritable multiplateforme et un minimum de d√©pendances pr√©d√©finies sont devenues une condition cl√©.  √Ä diff√©rents moments, j'ai r√©ussi √† bien conna√Ætre certains des cadres d'assemblage pour les d√©veloppeurs .NET: de MSBuild et ses configurations XML monstrueuses, qui ont ensuite √©t√© traduites en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Psake</a> (Powershell), en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">FAKE</a> exotique (F #).  Mais cette fois, je voulais quelque chose de frais et l√©ger.  De plus, il a d√©j√† √©t√© d√©cid√© que l'assemblage et les tests devraient √™tre enti√®rement effectu√©s dans un environnement de conteneur isol√©, donc je ne pr√©voyais pas de fonctionner √† l'int√©rieur d'autre chose que les commandes Docker CLI et Git, c'est-√†-dire que la plupart du processus aurait d√ª √™tre d√©crit dans le Dockerfile. <br>  √Ä cette √©poque, FAKE 5 et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Cake</a> pour .NET Core n'√©taient toujours pas pr√™ts, donc avec une plateforme multiplateforme, ces projets √©taient comme √ßa.  Mais mon tr√®s cher <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">PowerShell 6 Core</a> a d√©j√† √©t√© publi√©, et je l'ai utilis√© au maximum.  Par cons√©quent, j'ai d√©cid√© de me tourner √† nouveau vers Psake, et pendant que je me tournais, je suis tomb√© sur un projet <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Invoke-Build</a> int√©ressant, qui est une refonte de Psake et, comme le souligne l'auteur lui-m√™me, est le m√™me, mais en mieux et plus facilement.  Il en est ainsi.  Je ne m'y attarderai pas en d√©tail dans le cadre de cet article, je noterai seulement que la compacit√© me soudoie si toutes les fonctions de base de cette classe de produits sont disponibles: </p><br><ul><li>  La s√©quence d'actions est d√©crite par un ensemble de t√¢ches interd√©pendantes (t√¢ches), qui peuvent √™tre contr√¥l√©es en utilisant leurs interd√©pendances et leurs conditions suppl√©mentaires. </li><li>  Il existe plusieurs aides pratiques, par exemple, exec {} pour g√©rer correctement les codes de sortie des applications de console. </li><li>  Toute exception ou arr√™t d'utilisation de Ctrl + C sera correctement trait√©e dans un bloc Exit-Build sp√©cial int√©gr√©.  Par exemple, vous pouvez supprimer tous les fichiers temporaires, un environnement de test ou dessiner un rapport agr√©able √† l'≈ìil. </li></ul><br><p><img src="https://habrastorage.org/webt/nw/sg/0g/nwsg0gzd3fo0a-ep6b60pfqce98.png"></p><br><h2 id="universalnyy-dockerfile">  Dockerfile g√©n√©rique </h2><br><p>  Le Dockerfile lui-m√™me et l'assemblage utilisant la <code>docker build</code> offrent des capacit√©s de param√©trage assez faibles, et la flexibilit√© de ces outils est √† peine sup√©rieure √† celle d'une poign√©e de pelle.  En outre, il existe un grand nombre de fa√ßons de rendre la ¬´mauvaise¬ª image, trop grande, trop dangereuse, trop peu intuitive ou simplement impr√©visible.  Heureusement, <a href="">la documentation de Microsoft</a> propose d√©j√† plusieurs <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">exemples de Dockerfile</a> , qui vous permettent de comprendre rapidement les concepts de base et de cr√©er votre premier Dockerfile, en l'am√©liorant progressivement plus tard.  Il utilise d√©j√† un mod√®le √† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">plusieurs √©tapes</a> et cr√©e une image sp√©ciale ¬´ <a href="">Test Runner</a> ¬ª pour ex√©cuter les tests. </p><br><h2 id="multi-stage-pattern-i-argumenty">  Mod√®le et arguments √† plusieurs √©tapes </h2><br><p>  La premi√®re √©tape consiste √† diviser les √©tapes d'assemblage en plus petites et √† en ajouter de nouvelles.  Il convient donc de souligner le lancement de la <code>dotnet build</code> tant qu'√©tape distincte, car pour les projets contenant uniquement des biblioth√®ques, il est inutile d'ex√©cuter la <code>dotnet publish</code> .  Maintenant, √† notre discr√©tion, nous ne pouvons ex√©cuter que les √©tapes d'assemblage requises en utilisant <br> <code>dotnet build --target &lt;name&gt;</code> <br>  Par exemple, nous collectons ici un projet contenant uniquement des biblioth√®ques.  Les artefacts ici ne sont que des packages NuGet, ce qui signifie que cela n'a aucun sens de collecter une image d'ex√©cution. </p><br><p><img src="https://habrastorage.org/webt/vn/_a/a3/vn_aa3w7oodzrpythwrixomkhs8.png"></p><br><p>  Ou nous construisons d√©j√† un service, mais √† partir de la branche des fonctionnalit√©s.  Nous n'avons pas du tout besoin d'artefacts d'un tel assemblage, il est seulement important de passer les tests et le bilan de sant√©. </p><br><p><img src="https://habrastorage.org/webt/fo/ua/l1/foual199bsvqf2u7mk6xgjzbw9q.png"></p><br><p>  La prochaine chose √† faire est de param√©trer l'utilisation des images de base.  Depuis un certain temps maintenant, dans le Dockerfile, la directive <code>ARG</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">peut √™tre plac√©e en</a> dehors des √©tapes de construction, et les valeurs transf√©r√©es peuvent √™tre utilis√©es dans le nom de l'image de base. </p><br><pre> <code class="plaintext hljs">ARG DOTNETCORE_VERSION=2.2 ARG ALPINE_VERSION= ARG BUILD_BASE=mcr.microsoft.com/dotnet/core/sdk:${DOTNETCORE_VERSION}-alpine${ALPINE_VERSION} ARG RUNTIME_BASE=mcr.microsoft.com/dotnet/core/runtime:${DOTNETCORE_VERSION}-alpine${ALPINE_VERSION} FROM ${BUILD_BASE} AS restore ... FROM ${RUNTIME_BASE} AS runtime ...</code> </pre> <br><p>  Nous avons donc eu de nouvelles opportunit√©s √† premi√®re vue et pas √©videntes.  Premi√®rement, si nous voulons cr√©er une image avec une application ASP.NET Core, alors l'image d'ex√©cution en aura besoin d'une autre: <code>mcr.microsoft.com/dotnet/core/aspnet</code> .  Le param√®tre avec une image de base non standard doit √™tre enregistr√© dans la configuration du r√©f√©rentiel <code>SolutionInfo.props</code> et pass√© en argument lors de l'assemblage.  Nous avons √©galement facilit√© l'utilisation par le d√©veloppeur d'autres versions des images .NET Core: des aper√ßus, par exemple, ou m√™me des personnalis√©es (on ne sait jamais!). </p><br><p>  Deuxi√®mement, la possibilit√© de "d√©velopper" le Dockerfile est encore plus int√©ressante, ayant fait partie des op√©rations dans un autre assemblage, dont le r√©sultat sera pris comme base lors de la pr√©paration de l'image d'ex√©cution.  Par exemple, certains de nos services utilisent JavaScript et Vue.js, dont nous pr√©parerons le code dans une image distincte, en ajoutant simplement un tel Dockerfile ¬´en expansion¬ª au r√©f√©rentiel: </p><br><pre> <code class="plaintext hljs">ARG DOTNETCORE_VERSION=2.2 ARG ALPINE_VERSION= ARG RUNTIME_BASE=mcr.microsoft.com/dotnet/core/aspnet:${DOTNETCORE_VERSION}-alpine${ALPINE_VERSION} FROM node:alpine AS install WORKDIR /build COPY package.json . RUN npm install FROM install AS src COPY [".babelrc", ".eslintrc.js", ".stylelintrc", "./"] COPY ClientApp ./ClientApp FROM src AS publish RUN npm run build-prod FROM ${RUNTIME_BASE} AS appbase COPY --from=publish /build/wwwroot/ /app/wwwroot/</code> </pre> <br><p>  Collectons cette image avec la balise, que nous passerons √† l'√©tape d'assemblage de l'image d'ex√©cution du service ASP.NET comme argument √† RUNTIME_BASE.  Vous pouvez donc √©tendre l'assemblage autant que vous le souhaitez, y compris, vous pouvez param√©trer ce que vous ne pouvez pas simplement faire dans la <code>docker build</code> .  Vous souhaitez param√©trer l'ajout de Volume?  Facile: </p><br><pre> <code class="plaintext hljs">ARG DOTNETCORE_VERSION=2.2 ARG ALPINE_VERSION= ARG RUNTIME_BASE=mcr.microsoft.com/dotnet/core/aspnet:${DOTNETCORE_VERSION}-alpine${ALPINE_VERSION} FROM ${RUNTIME_BASE} AS runtime ARG VOLUME VOLUME ${VOLUME}</code> </pre> <br><p>  Nous commen√ßons l'assemblage de ce Dockerfile autant de fois que nous voulons ajouter de directives VOLUME.  Nous utilisons l'image r√©sultante comme base pour le service. </p><br><h2 id="zapusk-testov">  Ex√©cution de tests </h2><br><p>  Au lieu d'ex√©cuter des tests directement dans les √©tapes d'assemblage, il est plus correct et plus pratique de le faire dans un conteneur sp√©cial ¬´Test Runner¬ª.  Pr√©sentant bri√®vement l'essence de cette approche, je note qu'elle vous permet de: </p><br><ul><li>  Effectuez tous les lancements planifi√©s, m√™me si l'un d'eux se bloque; </li><li>  Montez le r√©pertoire du syst√®me de fichiers h√¥te dans le conteneur pour recevoir un rapport de test, ce qui est essentiel lors de la construction dans le syst√®me CI; </li><li>  Ex√©cutez les tests dans un environnement temporaire en transmettant le nom de son r√©seau au <code>docker run --network &lt;test_network_name&gt;</code> . </li></ul><br><p>  Le dernier paragraphe signifie que nous pouvons d√©sormais ex√©cuter non seulement des tests unitaires, mais aussi des tests d'int√©gration.  Nous d√©crivons l'environnement, par exemple, dans <code>docker-compose.yaml</code> , et l' <code>docker-compose.yaml</code> pour la build enti√®re.  Vous pouvez maintenant v√©rifier l'interaction avec la base de donn√©es ou notre autre service, et enregistrer les journaux d'eux au cas o√π vous en auriez besoin pour l'analyse. </p><br><p>  Nous v√©rifions toujours l'image d'ex√©cution r√©sultante pour r√©ussir le contr√¥le de sant√©, qui est √©galement une sorte de test.  Un environnement de test temporaire peut √™tre utile ici si le service test√© a des d√©pendances sur son environnement. </p><br><p>  Je note √©galement que l'approche avec les conteneurs de <code>dotnet build</code> assembl√©s au stade de la <code>dotnet build</code> servira alors tr√®s bien pour lancer la <code>dotnet publish</code> <code>dotnet pack</code> <code>dotnet nuget push</code> et la <code>dotnet nuget push</code> .  Cela nous permettra d'enregistrer les artefacts d'assemblage localement. </p><br><h2 id="healthcheck-i-zavisimosti-os">  D√©pendances Healthcheck et OS </h2><br><p>  Assez rapidement, il est devenu clair que nos services standardis√©s seraient toujours uniques √† leur mani√®re.  Ils peuvent avoir des exigences diff√©rentes pour les packages pr√©install√©s du syst√®me d'exploitation √† l'int√©rieur de l'image et diff√©rentes fa√ßons de v√©rifier le contr√¥le de sant√©.  Et si curl convient pour v√©rifier l'√©tat d'une application Web, alors pour un backend gRPC ou, en outre, un service sans t√™te, il sera inutile, et ce sera √©galement un package suppl√©mentaire dans le conteneur. </p><br><p>  Pour donner aux d√©veloppeurs la possibilit√© de personnaliser l'image et d'√©tendre sa configuration, nous utilisons l'accord sur plusieurs scripts sp√©ciaux qui peuvent √™tre red√©finis dans le r√©f√©rentiel: </p><br><pre> <code class="plaintext hljs">.scripts ‚îú‚îÄ‚îÄ healthcheck.sh ‚îú‚îÄ‚îÄ run.sh ‚îî‚îÄ‚îÄ runtime-deps.sh</code> </pre> <br><p>  Le script <code>healthcheck.sh</code> contient les commandes n√©cessaires pour v√©rifier l'√©tat: </p><br><ul><li><p>  Pour le Web √† l'aide de curl: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/ash set ‚Äìe curl -sIf -o /dev/null -w "%{http_code}\n" 127.0.0.1/health || exit 1</span></span></code> </pre> <br></li><li><p>  Autres services utilisant notre propre utilitaire cli: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/ash set ‚Äìe healthcheck || exit 1</span></span></code> </pre> <br></li></ul><br><p>  √Ä l'aide de <code>runtime-deps.sh</code> , les d√©pendances sont install√©es et, si n√©cessaire, toutes les autres actions sur le syst√®me d'exploitation de base sont effectu√©es qui sont n√©cessaires au fonctionnement normal de l'application √† l'int√©rieur du conteneur.  Exemples typiques: </p><br><ul><li><p>  Pour une application Web: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/ash apk add --no-cache curl icu-libs</span></span></code> </pre> <br></li><li><p>  Pour le service gRPC: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/ash apk add --no-cache libc6-compat</span></span></code> </pre> <br></li></ul><br><p>  Ainsi, la mani√®re de g√©rer les d√©pendances et de v√©rifier l'√©tat est standardis√©e, mais il y a de la place pour une certaine flexibilit√©.  Quant √† <code>run.sh</code> , c'est plus loin. </p><br><h2 id="entrypoint-skript">  Script Entrypoint </h2><br><p>  Je suis s√ªr que tous ceux qui ont √©crit au moins une fois leur Dockerfile se sont demand√© quelle directive utiliser - <code>CMD</code> ou <code>ENTRYPOINT</code> .  De plus, ces √©quipes ont √©galement deux options de syntaxe, qui affectent de la mani√®re la plus dramatique le r√©sultat.  Je n'expliquerai pas la diff√©rence en d√©tail, en r√©p√©tant apr√®s ceux qui ont d√©j√† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">tout clarifi√©</a> .  Je recommande simplement de se rappeler que dans 99% des situations, il est correct d'utiliser ENTRYPOINT et la syntaxe exec: </p><br><p>  ENTRYPOINT ["/ chemin / vers / ex√©cutable"] </p><br><p>  Sinon, l'application lanc√©e ne pourra pas traiter correctement les commandes du syst√®me d'exploitation, telles que SIGTERM, etc., et vous pouvez √©galement avoir des probl√®mes sous la forme de processus zombies et de tout ce qui concerne <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">le probl√®me PID 1</a> .  Mais que se passe-t-il si vous souhaitez d√©marrer le conteneur sans lancer l'application?  Oui, vous pouvez remplacer le point d'entr√©e: <br> <code>docker run --rm -it --entrypoint ash &lt;image_name&gt; &lt;params&gt;</code> <br>  Il n'a pas l'air trop confortable et intuitif, non?  Mais il y a une bonne nouvelle: vous pouvez faire mieux!  √Ä savoir, utilisez un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">script de point d'entr√©e</a> .  Un tel script vous permet de rendre l'initialisation ( <a href="">exemple</a> ) arbitrairement complexe, le traitement des param√®tres et tout ce que vous voulez. </p><br><p>  Dans notre cas, par d√©faut, le sc√©nario le plus simple, mais en m√™me temps fonctionnel, est utilis√©: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh set -e if [ ! -z "$1" ] &amp;&amp; $(command -v $1 &gt;/dev/null 2&gt;&amp;1) then exec $@ else exec /usr/bin/dotnet /app/${ENTRY_PROJECT}.dll $@ fi</span></span></code> </pre> <br><p>  Il vous permet de contr√¥ler le lancement du conteneur de mani√®re tr√®s intuitive: <br>  <code>docker run &lt;image&gt; env</code> - ex√©cute simplement env dans l'image, montrant les variables d'environnement. <br>  <code>docker run &lt;image&gt; -param1 value1</code> - d√©marre le service avec les arguments sp√©cifi√©s. </p><br><p>  S√©par√©ment, vous devez faire attention √† la commande <code>exec</code> : sa pr√©sence avant d'appeler l'application ex√©cutable lui fournira le PID 1 convoit√© dans votre conteneur. </p><br><h2 id="chto-esche">  Quoi d'autre </h2><br><p>  Bien s√ªr, sur plus d'un an et demi d'utilisation, le syst√®me de build a accumul√© de nombreuses fonctionnalit√©s diff√©rentes.  En plus de g√©rer les conditions de lancement des diff√©rentes √©tapes, en travaillant avec le stockage des artefacts, la gestion des versions et d'autres fonctionnalit√©s, notre ¬´standard¬ª du conteneur s'est √©galement d√©velopp√©.  Il √©tait rempli d'attributs importants qui le rendent plus pr√©visible et plus pratique sur le plan administratif: </p><br><ul><li>  Toutes les √©tiquettes d'images n√©cessaires sont install√©es: versions, num√©ros de r√©vision, liens vers la documentation, auteur et autres. </li><li>  Dans le conteneur d'ex√©cution, la configuration NLog est red√©finie afin qu'apr√®s la publication, tous les journaux soient imm√©diatement pr√©sent√©s sous une forme structur√©e √† l'aide de json, dont la version est versionn√©e. </li><li>  Les r√®gles d'analyse statique et toutes les autres normes sont automatiquement mises √† jour. </li></ul><br><p>  Un tel outil, bien s√ªr, peut toujours √™tre am√©lior√© et d√©velopp√©.  Tout d√©pend des besoins et de l'imagination.  Par exemple, en plus de tout, il √©tait possible de regrouper des utilitaires cli suppl√©mentaires dans une image.  Le d√©veloppeur peut facilement les mettre dans l'image, en sp√©cifiant dans le fichier de configuration uniquement le nom de l'utilitaire requis et le nom du projet .NET √† partir duquel il doit √™tre assembl√© (par exemple, notre <code>healthcheck</code> ). </p><br><h2 id="zaklyuchenie">  Conclusion </h2><br><p>  D√©crit ici n'est qu'une partie d'une approche int√©gr√©e de la normalisation.  Les services eux-m√™mes, qui sont cr√©√©s √† partir de nos mod√®les, sont rest√©s en arri√®re-plan, et ils sont donc assez unifi√©s par de nombreux crit√®res, tels qu'une approche unique de la configuration, des m√©thodes courantes pour acc√©der aux m√©triques, la g√©n√©ration de code, etc.        .          ,  . </p><br><p>             ,      Linux    ,   -      .       , ,          . , ,  ,    Code Style,      ,           . </p><br><p> ,    !   ,    ¬´  ¬ª,       ,             .      ,    Docker        . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr468683/">https://habr.com/ru/post/fr468683/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr468663/index.html">Approche End2 End dans les t√¢ches de reconnaissance automatique de la parole</a></li>
<li><a href="../fr468665/index.html">Mais est-il temps d'acheter un irrigateur?</a></li>
<li><a href="../fr468673/index.html">Atelier "Garantir la s√©curit√© des donn√©es personnelles" - 3 octobre, Saint-P√©tersbourg</a></li>
<li><a href="../fr468677/index.html">L'annonce du smartphone Xiaomi Mi Mix Alpha</a></li>
<li><a href="../fr468679/index.html">L'ABC de la s√©curit√© dans Kubernetes: authentification, autorisation, audit</a></li>
<li><a href="../fr468687/index.html">Nous analysons les nouvelles initiatives de la Banque centrale pour r√©guler le march√© boursier: 3 groupes d'investisseurs, restrictions pour les d√©butants</a></li>
<li><a href="../fr468689/index.html">Enregistrer votre entreprise informatique √† Singapour: que dois-je faire?</a></li>
<li><a href="../fr468691/index.html">Pilotes tiers dangereux sur votre syst√®me ou pilotes LOLD</a></li>
<li><a href="../fr468693/index.html">Comment l'automatisation d√©truit les employ√©s de Walmart</a></li>
<li><a href="../fr468695/index.html">Mon premier hack: un site qui vous permet de d√©finir n'importe quel mot de passe utilisateur</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>