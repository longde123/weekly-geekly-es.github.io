<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ´ó §ó ¢ó ·ó ¬ó ³ó ¿ ğŸ‘‚ğŸ½ ğŸ SQL Index Manager-ç”¨äºæ•´ç†å’Œç»´æŠ¤ç´¢å¼•çš„å…è´¹å·¥å…· ğŸ¤²ğŸ½ ğŸ˜– ğŸ‘¨ğŸ¼â€ğŸš’</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="å¤šå¹´æ¥ï¼Œä½œä¸ºSQL Server DBAè¿›è¡ŒæœåŠ¡å™¨ç®¡ç†ï¼Œç„¶åè¿›è¡Œæ€§èƒ½ä¼˜åŒ–ã€‚ æ€»çš„æ¥è¯´ï¼Œæˆ‘æƒ³åœ¨ç©ºé—²æ—¶é—´ä¸ºUniverseå’Œæˆ‘ä»¬çš„åŒäº‹åšä¸€äº›æœ‰ç”¨çš„äº‹æƒ…ã€‚ å› æ­¤ï¼Œæœ€ç»ˆæˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ªç”¨äºSQL Serverå’ŒAzureçš„å°å‹å¼€æºç´¢å¼•ç»´æŠ¤å·¥å…· ã€‚ 



 ä¸»æ„ 
 æœ‰æ—¶ï¼Œå½“ä»–ä»¬æŒ‰ä¼˜å…ˆé¡ºåºè¿›è¡Œå·¥ä½œæ—¶ï¼Œäººä»¬å¯èƒ½...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>SQL Index Manager-ç”¨äºæ•´ç†å’Œç»´æŠ¤ç´¢å¼•çš„å…è´¹å·¥å…·</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/459914/"> å¤šå¹´æ¥ï¼Œä½œä¸ºSQL Server DBAè¿›è¡ŒæœåŠ¡å™¨ç®¡ç†ï¼Œç„¶åè¿›è¡Œæ€§èƒ½ä¼˜åŒ–ã€‚ æ€»çš„æ¥è¯´ï¼Œæˆ‘æƒ³åœ¨ç©ºé—²æ—¶é—´ä¸ºUniverseå’Œæˆ‘ä»¬çš„åŒäº‹åšä¸€äº›æœ‰ç”¨çš„äº‹æƒ…ã€‚ å› æ­¤ï¼Œæœ€ç»ˆæˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ªç”¨äºSQL Serverå’ŒAzureçš„å°å‹<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å¼€æº</a>ç´¢å¼•ç»´æŠ¤<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å·¥å…·</a> ã€‚ <br><br><img src="https://habrastorage.org/getpro/habr/post_images/546/8b0/98e/5468b098eea90eb287427b56021c6962.png" alt="SQLç´¢å¼•ç®¡ç†å™¨"><br><br><a name="habracut"></a><h3> ä¸»æ„ </h3><br> æœ‰æ—¶ï¼Œå½“ä»–ä»¬æŒ‰ä¼˜å…ˆé¡ºåºè¿›è¡Œå·¥ä½œæ—¶ï¼Œäººä»¬å¯èƒ½ä¼šåƒæ‰‹æŒ‡å¼ç”µæ± ä¸€æ ·-ä»…ä¸€æ¬¡é—ªå…‰ä¾¿æœ‰è¶³å¤Ÿçš„åŠ¨åŠ›ï¼Œç„¶åå°±å¯ä»¥äº†ã€‚ ç›´åˆ°æœ€è¿‘ï¼Œæˆ‘å¯¹ç”Ÿæ´»çš„è§‚å¯Ÿä¹Ÿä¸ä¾‹å¤–ã€‚ æˆ‘ç»å¸¸ä¼šè¢«åˆ›æ„æ‰€å¸å¼•ï¼Œä»¥åˆ›é€ å±äºè‡ªå·±çš„ä¸œè¥¿ï¼Œä½†æ˜¯ä¼˜å…ˆäº‹é¡¹å‘ç”Ÿäº†å˜åŒ–ï¼Œä¸€åˆ‡éƒ½æ²¡æœ‰ç»“æŸã€‚ <br><br>  Kharkovå…¬å¸Devartçš„å·¥ä½œå¯¹æˆ‘çš„åŠ¨æœºå’Œä¸“ä¸šå‘å±•äº§ç”Ÿäº†ç›¸å½“å¤§çš„å½±å“ï¼Œè¯¥å…¬å¸ä»äº‹ç”¨äºSQL Serverï¼ŒMySQLå’ŒOracleæ•°æ®åº“å¼€å‘å’Œç®¡ç†çš„è½¯ä»¶çš„åˆ›å»ºã€‚ <br><br> åœ¨æ¥è§¦ä»–ä»¬ä¹‹å‰ï¼Œæˆ‘å¯¹åˆ›å»ºè‡ªå·±çš„äº§å“çš„å…·ä½“ç»†èŠ‚ä¸€æ— æ‰€çŸ¥ï¼Œä½†æ˜¯åœ¨æ­¤è¿‡ç¨‹ä¸­ï¼Œæˆ‘å·²ç»è·å¾—äº†è®¸å¤šæœ‰å…³SQL Serverå†…éƒ¨ç»“æ„çš„çŸ¥è¯†ã€‚ ç»è¿‡ä¸€å¹´å¤šçš„ä¼˜åŒ–å…¶äº§å“ç³»åˆ—ä¸­çš„å…ƒæ•°æ®è¯·æ±‚ï¼Œæˆ‘é€æ¸å¼€å§‹äº†è§£å¸‚åœºä¸Šæœ€éœ€è¦å“ªç§åŠŸèƒ½ã€‚ <br><br> åœ¨æŸä¸ªé˜¶æ®µï¼Œè¿™ä¸ªæƒ³æ³•äº§ç”Ÿäº†ï¼Œä»¥åˆ›å»ºä¸€ç§æ–°çš„åˆ©åŸºäº§å“ï¼Œä½†æ˜¯ç”±äºç¯å¢ƒçš„åŸå› ï¼Œè¿™ä¸ªæƒ³æ³•æ²¡æœ‰æˆåŠŸã€‚ å½“æ—¶ï¼Œå¯¹äºæ–°é¡¹ç›®ï¼Œå…¬å¸å†…éƒ¨æ²¡æœ‰è¶³å¤Ÿçš„è‡ªç”±èµ„æºï¼Œè€Œåˆä¸ä¼šæŸå®³æ ¸å¿ƒä¸šåŠ¡ã€‚ <br><br> å½“ä»–åœ¨ä¸€ä¸ªæ–°åœ°æ–¹å·¥ä½œå¹¶å°è¯•ç‹¬è‡ªå®Œæˆè¯¥é¡¹ç›®æ—¶ï¼Œä»–ä¸å¾—ä¸ä¸æ–­åšå‡ºä¸€äº›å¦¥åã€‚ åˆ¶ä½œåŠŸèƒ½é½å…¨çš„å¤§å‹äº§å“çš„æœ€åˆæƒ³æ³•å¾ˆå¿«æ¶ˆå¤±äº†ï¼Œå¹¶é€æ¸è½¬å˜ä¸ºå¦ä¸€ä¸ªæ–¹å‘-å°†è®¡åˆ’çš„åŠŸèƒ½åˆ†è§£ä¸ºå•ç‹¬çš„å¾®å‹å·¥å…·ï¼Œå¹¶ä½¿å®ƒä»¬å½¼æ­¤ç‹¬ç«‹å®ç°ã€‚ <br><br> ç»“æœï¼Œ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><b>SQLç´¢å¼•ç®¡ç†å™¨</b></a>è¯ç”Ÿäº†-ç”¨äºSQL Serverå’ŒAzureçš„å…è´¹ç´¢å¼•ç»´æŠ¤å·¥å…·ã€‚ ä¸»è¦æ€æƒ³æ˜¯å°†RedGateå’ŒDevartçš„å•†ä¸šæ›¿ä»£å“ä½œä¸ºåŸºç¡€ï¼Œå¹¶å°è¯•æ”¹å–„å…¶åŠŸèƒ½ã€‚ ä¸ºåˆå­¦è€…å’Œæœ‰ç»éªŒçš„ç”¨æˆ·æä¾›æ–¹ä¾¿åœ°åˆ†æå’Œç»´æŠ¤ç´¢å¼•çš„èƒ½åŠ›ã€‚ <br><br><h3> å®ä½œ </h3><br> æ¢å¥è¯è¯´ï¼Œä¸€åˆ‡æ€»æ˜¯å¬èµ·æ¥å¾ˆç®€å•â€¦â€¦ä»–çœ‹äº†çœ‹ä¸€äº›æ¿€åŠ¨äººå¿ƒçš„ç»´å¤šè¥¿ç§‘å¤«ï¼Œç«™åœ¨æ¶å­ä¸Šï¼Œå¼€å§‹åˆ¶ä½œå¾ˆé…·çš„äº§å“ã€‚ ä½†æ˜¯å®é™…ä¸Šï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰äº‹æƒ…éƒ½é‚£ä¹ˆä¹è§‚ï¼Œå› ä¸ºä½¿ç”¨sys.dm_db_index_physical_statsç³»ç»Ÿè¡¨å‡½æ•°æ—¶ä¼šé‡åˆ°å¾ˆå¤šé™·é˜±ï¼Œå¹¶ä¸”ç»“åˆä½¿ç”¨ï¼Œè¿™æ˜¯ä»ä¸­å¯ä»¥è·å¾—æœ‰å…³ç´¢å¼•ç¢ç‰‡çš„ç›¸å…³ä¿¡æ¯çš„å”¯ä¸€åœ°æ–¹ã€‚ <br><br> ä»å¼€å‘çš„ç¬¬ä¸€å¤©å¼€å§‹ï¼Œå°±æœ‰å¾ˆå¤§çš„æœºä¼šåœ¨æ ‡å‡†æ–¹æ¡ˆä¹‹é—´èµ°å‡ºä¸€æ¡æ²‰é—·çš„é“è·¯ï¼Œå¤åˆ¶ç«äº‰åº”ç”¨ç¨‹åºå·¥ä½œä¸­å·²ç»è°ƒè¯•å¥½çš„é€»è¾‘ï¼ŒåŒæ—¶å¢åŠ ä¸€ç‚¹éº»çƒ¦ã€‚ ä½†æ˜¯åœ¨åˆ†æäº†å¯¹å…ƒæ•°æ®çš„éœ€æ±‚ä¹‹åï¼Œæˆ‘æƒ³åšä¸€äº›æ›´ä¼˜åŒ–çš„äº‹æƒ…ï¼Œç”±äºå¤§å…¬å¸çš„å®˜åƒšä½œé£ï¼Œå®ƒä»¬æ°¸è¿œä¸ä¼šå‡ºç°åœ¨ä»–ä»¬çš„äº§å“ä¸­ã€‚ <br><br> åˆ†æRedGate SQLç´¢å¼•ç®¡ç†å™¨ï¼ˆ1.1.9.1378-$ 155ï¼‰æ—¶ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°è¯¥åº”ç”¨ç¨‹åºä½¿ç”¨äº†ä¸€ç§éå¸¸ç®€å•çš„æ–¹æ³•ï¼šé€šè¿‡ä¸€ä¸ªæŸ¥è¯¢ï¼Œæˆ‘ä»¬è·å¾—äº†ç”¨æˆ·è¡¨å’Œè§†å›¾çš„åˆ—è¡¨ï¼Œåœ¨ç¬¬äºŒæ¬¡æŸ¥è¯¢åï¼Œè¿”å›äº†æ‰€é€‰æ•°æ®åº“ä¸­æ‰€æœ‰ç´¢å¼•çš„åˆ—è¡¨ã€‚ <br><br><pre><code class="1c hljs">SELECT objects.name AS tableOrViewName , objects.object_id AS tableOrViewId , schemas.name AS schemaName , CAST(ISNULL(lobs.NumLobs, <span class="hljs-number"><span class="hljs-number">0</span></span>) AS BIT) AS ContainsLobs , o.is_memory_optimized FROM sys.objects AS objects JOIN sys.schemas AS schemas ON schemas.schema_id = objects.schema_id LEFT JOIN ( SELECT object_id , COUNT(*) AS NumLobs FROM sys.columns WITH (NOLOCK) WHERE system_type_id IN (<span class="hljs-number"><span class="hljs-number">34</span></span>, <span class="hljs-number"><span class="hljs-number">35</span></span>, <span class="hljs-number"><span class="hljs-number">99</span></span>) OR max_length = -<span class="hljs-number"><span class="hljs-number">1</span></span> GROUP BY object_id ) AS lobs ON objects.object_id = lobs.object_id LEFT JOIN sys.tables AS o ON o.object_id = objects.object_id WHERE objects.type = 'U' OR objects.type = 'V' SELECT i.object_id AS tableOrViewId , i.name AS indexName , i.index_id AS indexId , i.allow_page_locks AS allowPageLocks , p.partition_number AS partitionNumber , CAST((c.numPartitions - <span class="hljs-number"><span class="hljs-number">1</span></span>) AS BIT) AS belongsToPartitionedIndex FROM sys.indexes AS i JOIN sys.partitions AS p ON p.index_id = i.index_id AND p.object_id = i.object_id JOIN ( SELECT COUNT(*) AS numPartitions , object_id , index_id FROM sys.partitions GROUP BY object_id , index_id ) AS c ON c.index_id = i.index_id AND c.object_id = i.object_id WHERE i.index_id &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> -- ignore heaps AND i.is_disabled = <span class="hljs-number"><span class="hljs-number">0</span></span> AND i.is_hypothetical = <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br> ç„¶åï¼Œåœ¨ä¸€ä¸ªå¾ªç¯ä¸­ï¼Œé’ˆå¯¹ç´¢å¼•çš„æ¯ä¸ªéƒ¨åˆ†å‘é€ä¸€ä¸ªè¯·æ±‚ï¼Œä»¥ç¡®å®šå…¶å¤§å°å’Œç¢ç‰‡çº§åˆ«ã€‚ æ‰«æç»“æŸæ—¶ï¼Œæƒé‡å°äºå…¥å£é˜ˆå€¼çš„ç´¢å¼•å°†åœ¨å®¢æˆ·ç«¯ä¸Šè¢«ä¸¢å¼ƒã€‚ <br><br><pre> <code class="1c hljs">EXEC sp_executesql N' SELECT index_id, avg_fragmentation_in_percent, page_count FROM sys.dm_db_index_physical_stats(@databaseId, @objectId, @indexId, @partitionNr, NULL)' , N'@databaseId int,@objectId int,@indexId int,@partitionNr int' , @databaseId = <span class="hljs-number"><span class="hljs-number">7</span></span>, @objectId = <span class="hljs-number"><span class="hljs-number">2133582639</span></span>, @indexId = <span class="hljs-number"><span class="hljs-number">1</span></span>, @partitionNr = <span class="hljs-number"><span class="hljs-number">1</span></span> EXEC sp_executesql N' SELECT index_id, avg_fragmentation_in_percent, page_count FROM sys.dm_db_index_physical_stats(@databaseId, @objectId, @indexId, @partitionNr, NULL)' , N'@databaseId int,@objectId int,@indexId int,@partitionNr int' , @databaseId = <span class="hljs-number"><span class="hljs-number">7</span></span>, @objectId = <span class="hljs-number"><span class="hljs-number">2133582639</span></span>, @indexId = <span class="hljs-number"><span class="hljs-number">2</span></span>, @partitionNr = <span class="hljs-number"><span class="hljs-number">1</span></span> EXEC sp_executesql N' SELECT index_id, avg_fragmentation_in_percent, page_count FROM sys.dm_db_index_physical_stats(@databaseId, @objectId, @indexId, @partitionNr, NULL)' , N'@databaseId int,@objectId int,@indexId int,@partitionNr int' , @databaseId = <span class="hljs-number"><span class="hljs-number">7</span></span>, @objectId = <span class="hljs-number"><span class="hljs-number">2133582639</span></span>, @indexId = <span class="hljs-number"><span class="hljs-number">3</span></span>, @partitionNr = <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br> åœ¨åˆ†ææ­¤åº”ç”¨ç¨‹åºçš„é€»è¾‘æ—¶ï¼Œæ‚¨ä¼šå‘ç°è®¸å¤šç¼ºç‚¹ã€‚ ä¾‹å¦‚ï¼Œå¦‚æœå‘ç°å°æ•…éšœï¼Œåˆ™åœ¨å‘é€è¯·æ±‚ä¹‹å‰ï¼Œä¸ä¼šæ£€æŸ¥å½“å‰èŠ‚æ˜¯å¦åŒ…å«å­—ç¬¦ä¸²ä»¥æ’é™¤ç©ºèŠ‚ã€‚ <br><br> ä½†æ˜¯ä»å¦ä¸€ä¸ªæ–¹é¢æ¥çœ‹ï¼Œé—®é¢˜æœ€ä¸¥é‡ï¼šæœåŠ¡å™¨è¯·æ±‚çš„æ•°é‡å°†å¤§çº¦ç­‰äºsys.partitionsä¸­çš„æ€»è¡Œæ•°ã€‚ è€ƒè™‘åˆ°å®é™…æ•°æ®åº“å¯ä»¥åŒ…å«æ•°ä»¥ä¸‡è®¡çš„éƒ¨åˆ†ï¼Œå› æ­¤è¿™ç§ç»†å¾®å·®åˆ«å¯ä»¥å¯¼è‡´å¯¹æœåŠ¡å™¨çš„å¤§é‡ç±»ä¼¼è¯·æ±‚ã€‚ åœ¨æ•°æ®åº“æ˜¯è¿œç¨‹çš„æƒ…å†µä¸‹ï¼Œç”±äºæ¯ä¸ªè¯·æ±‚ï¼ˆå³ä½¿æ˜¯æœ€ç®€å•çš„è¯·æ±‚ï¼‰çš„ç½‘ç»œå»¶è¿Ÿå¢åŠ ï¼Œæ‰«ææ—¶é—´å°†å˜å¾—æ›´é•¿ã€‚ <br><br> ä¸RedGateä¸åŒï¼Œåœ¨Devartä¸­å¼€å‘çš„ç±»ä¼¼äº§å“-ç”¨äºSQL Serverçš„dbForgeç´¢å¼•ç®¡ç†å™¨ï¼ˆ1.10.38-$ 99ï¼‰åœ¨ä¸€ä¸ªå¤§å‹æŸ¥è¯¢ä¸­æ¥æ”¶ä¿¡æ¯ï¼Œç„¶ååœ¨å®¢æˆ·ç«¯ä¸Šæ˜¾ç¤ºæ‰€æœ‰å†…å®¹ï¼š <br><br><pre> <code class="1c hljs">SELECT SCHEMA_NAME(o.[schema_id]) AS [schema_name] , o.name AS parent_name , o.[type] AS parent_type , i.name , i.type_desc , s.avg_fragmentation_in_percent , s.page_count , p.partition_number , p.[rows] , ISNULL(lob.is_lob_legacy, <span class="hljs-number"><span class="hljs-number">0</span></span>) AS is_lob_legacy , ISNULL(lob.is_lob, <span class="hljs-number"><span class="hljs-number">0</span></span>) AS is_lob , CASE WHEN ds.[type] = 'PS' THEN <span class="hljs-number"><span class="hljs-number">1</span></span> ELSE <span class="hljs-number"><span class="hljs-number">0</span></span> END AS is_partitioned FROM sys.dm_db_index_physical_stats(DB_ID(), <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) s JOIN sys.partitions p ON s.[object_id] = p.[object_id] AND s.index_id = p.index_id AND s.partition_number = p.partition_number JOIN sys.indexes i ON i.[object_id] = s.[object_id] AND i.index_id = s.index_id LEFT JOIN ( SELECT c.[object_id] , index_id = ISNULL(i.index_id, <span class="hljs-number"><span class="hljs-number">1</span></span>) , is_lob_legacy = MAX(CASE WHEN c.system_type_id IN (<span class="hljs-number"><span class="hljs-number">34</span></span>, <span class="hljs-number"><span class="hljs-number">35</span></span>, <span class="hljs-number"><span class="hljs-number">99</span></span>) THEN <span class="hljs-number"><span class="hljs-number">1</span></span> END) , is_lob = MAX(CASE WHEN c.max_length = -<span class="hljs-number"><span class="hljs-number">1</span></span> THEN <span class="hljs-number"><span class="hljs-number">1</span></span> END) FROM sys.columns c LEFT JOIN sys.index_columns i ON c.[object_id] = i.[object_id] AND c.column_id = i.column_id AND i.index_id &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> WHERE c.system_type_id IN (<span class="hljs-number"><span class="hljs-number">34</span></span>, <span class="hljs-number"><span class="hljs-number">35</span></span>, <span class="hljs-number"><span class="hljs-number">99</span></span>) OR c.max_length = -<span class="hljs-number"><span class="hljs-number">1</span></span> GROUP BY c.[object_id], i.index_id ) lob ON lob.[object_id] = i.[object_id] AND lob.index_id = i.index_id JOIN sys.objects o ON o.[object_id] = i.[object_id] JOIN sys.data_spaces ds ON i.data_space_id = ds.data_space_id WHERE i.[type] IN (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>) AND i.is_disabled = <span class="hljs-number"><span class="hljs-number">0</span></span> AND i.is_hypothetical = <span class="hljs-number"><span class="hljs-number">0</span></span> AND s.index_level = <span class="hljs-number"><span class="hljs-number">0</span></span> AND s.alloc_unit_type_desc = 'IN_ROW_DATA' AND o.[type] IN ('U', 'V')</code> </pre> <br> æˆ‘ä»¬è®¾æ³•æ‘†è„±äº†ç«äº‰äº§å“ä¸­ç›¸åŒç±»å‹æŸ¥è¯¢çš„é¢çº±çš„ä¸»è¦é—®é¢˜ï¼Œä½†æ˜¯æ­¤å®ç°çš„ç¼ºç‚¹æ˜¯æ²¡æœ‰å°†é¢å¤–çš„å‚æ•°ä¼ é€’ç»™sys.dm_db_index_physical_statså‡½æ•°ï¼Œè¯¥å‡½æ•°å¯ä»¥é™åˆ¶å¯¹æ˜¾ç„¶ä¸å¿…è¦çš„ç´¢å¼•çš„æ‰«æã€‚ å®é™…ä¸Šï¼Œè¿™å¯¼è‡´åœ¨æ‰«æé˜¶æ®µè·å¾—æœ‰å…³ç³»ç»Ÿä¸­æ‰€æœ‰ç´¢å¼•çš„ä¿¡æ¯ä»¥åŠé¢å¤–çš„ç£ç›˜è´Ÿè½½ã€‚ <br><br> é‡è¦çš„æ˜¯è¦æ³¨æ„ï¼Œä»sys.dm_db_index_physical_statsè·å¾—çš„æ•°æ®ä¸ä¼šæ°¸ä¹…åœ°ç¼“å­˜åœ¨ç¼“å†²æ± ä¸­ï¼Œå› æ­¤ï¼Œåœ¨è·å–æœ‰å…³ç´¢å¼•ç¢ç‰‡çš„ä¿¡æ¯æ—¶å°†ç‰©ç†è¯»æ•°æœ€å°åŒ–æ˜¯å¼€å‘è¿‡ç¨‹ä¸­çš„ä¼˜å…ˆä»»åŠ¡ä¹‹ä¸€ã€‚ <br><br> ç»è¿‡å‡ æ¬¡å®éªŒï¼Œç»“æœè¯æ˜å°†ä¸¤ç§æ–¹æ³•ç»“åˆèµ·æ¥ï¼Œå°†æ‰«æåˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ã€‚ é¦–å…ˆï¼Œä¸€ä¸ªå¤§å‹æŸ¥è¯¢ç¡®å®šèŠ‚çš„å¤§å°ï¼Œå¹¶é¢„å…ˆè¿‡æ»¤é‚£äº›ä¸åœ¨è¿‡æ»¤èŒƒå›´å†…çš„èŠ‚ï¼š <br><br><pre> <code class="1c hljs">INSERT INTO <span class="hljs-meta"><span class="hljs-meta">#AllocationUnits (ContainerID, ReservedPages, UsedPages) SELECT [container_id] , SUM([total_pages]) , SUM([used_pages]) FROM sys.allocation_units WITH(NOLOCK) GROUP BY [container_id] HAVING SUM([total_pages]) BETWEEN @MinIndexSize AND @MaxIndexSize</span></span></code> </pre> <br> æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä»…è·å–é‚£äº›åŒ…å«æ•°æ®çš„èŠ‚ï¼Œä»¥é¿å…ä»ç©ºç´¢å¼•è¿›è¡Œä¸å¿…è¦çš„è¯»å–æ“ä½œã€‚ <br><br><pre> <code class="1c hljs">SELECT [object_id] , [index_id] , [partition_id] , [partition_number] , [rows] , [data_compression] INTO <span class="hljs-meta"><span class="hljs-meta">#Partitions FROM sys.partitions WITH(NOLOCK) WHERE [object_id] &gt; 255 AND [rows] &gt; 0 AND [object_id] NOT IN (SELECT * FROM #ExcludeList)</span></span></code> </pre> <br> æ ¹æ®è®¾ç½®ï¼Œä»…è·å¾—ç”¨æˆ·è¦åˆ†æçš„é‚£äº›ç´¢å¼•ç±»å‹ï¼ˆæ”¯æŒä½¿ç”¨å †ï¼Œé›†ç¾¤/éé›†ç¾¤ç´¢å¼•å’Œåˆ—æŒ‡ç¤ºç¬¦ï¼‰ã€‚ <br><br><pre> <code class="1c hljs">INSERT INTO <span class="hljs-meta"><span class="hljs-meta">#Indexes SELECT ObjectID = i.[object_id] , IndexID = i.index_id , IndexName = i.[name] , PagesCount = a.ReservedPages , UnusedPagesCount = a.ReservedPages - a.UsedPages , PartitionNumber = p.[partition_number] , RowsCount = ISNULL(p.[rows], 0) , IndexType = i.[type] , IsAllowPageLocks = i.[allow_page_locks] , DataSpaceID = i.[data_space_id] , DataCompression = p.[data_compression] , IsUnique = i.[is_unique] , IsPK = i.[is_primary_key] , FillFactorValue = i.[fill_factor] , IsFiltered = i.[has_filter] FROM #AllocationUnits a JOIN #Partitions p ON a.ContainerID = p.[partition_id] JOIN sys.indexes i WITH(NOLOCK) ON i.[object_id] = p.[object_id] AND p.[index_id] = i.[index_id] WHERE i.[type] IN (0, 1, 2, 5, 6) AND i.[object_id] &gt; 255</span></span></code> </pre> <br> åœ¨é‚£ä¹‹åï¼Œä¸€ç‚¹é­”åŠ›å¼€å§‹äº†ï¼šå¯¹äºæ‰€æœ‰å°ç´¢å¼•ï¼Œæˆ‘ä»¬é€šè¿‡é‡å¤è°ƒç”¨sys.dm_db_index_physical_statså‡½æ•°å¹¶å®Œæ•´æŒ‡ç¤ºæ‰€æœ‰å‚æ•°æ¥ç¡®å®šç¢ç‰‡çº§åˆ«ã€‚ <br><br><pre> <code class="1c hljs">INSERT INTO <span class="hljs-meta"><span class="hljs-meta">#Fragmentation (ObjectID, IndexID, PartitionNumber, Fragmentation) SELECT i.ObjectID , i.IndexID , i.PartitionNumber , r.[avg_fragmentation_in_percent] FROM #Indexes i CROSS APPLY sys.dm_db_index_physical_stats(@DBID, i.ObjectID, i.IndexID, i.PartitionNumber, 'LIMITED') r WHERE i.PagesCount &lt;= @PreDescribeSize AND r.[index_level] = 0 AND r.[alloc_unit_type_desc] = 'IN_ROW_DATA' AND i.IndexType IN (0, 1, 2)</span></span></code> </pre> <br> æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†æ‰€æœ‰å¯èƒ½çš„ä¿¡æ¯è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œä»¥è¿‡æ»¤æ‰å¤šä½™çš„æ•°æ®ï¼š <br><br><pre> <code class="1c hljs">SELECT i.ObjectID , i.IndexID , i.IndexName , ObjectName = o.[name] , SchemaName = s.[name] , i.PagesCount , i.UnusedPagesCount , i.PartitionNumber , i.RowsCount , i.IndexType , i.IsAllowPageLocks , u.TotalWrites , u.TotalReads , u.TotalSeeks , u.TotalScans , u.TotalLookups , u.LastUsage , i.DataCompression , f.Fragmentation , IndexStats = STATS_DATE(i.ObjectID, i.IndexID) , IsLobLegacy = ISNULL(lob.IsLobLegacy, <span class="hljs-number"><span class="hljs-number">0</span></span>) , IsLob = ISNULL(lob.IsLob, <span class="hljs-number"><span class="hljs-number">0</span></span>) , IsSparse = CAST(CASE WHEN p.ObjectID IS <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> THEN <span class="hljs-number"><span class="hljs-number">0</span></span> ELSE <span class="hljs-number"><span class="hljs-number">1</span></span> END AS BIT) , IsPartitioned = CAST(CASE WHEN dds.[data_space_id] IS NOT <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> THEN <span class="hljs-number"><span class="hljs-number">1</span></span> ELSE <span class="hljs-number"><span class="hljs-number">0</span></span> END AS BIT) , FileGroupName = fg.[name] , i.IsUnique , i.IsPK , i.FillFactorValue , i.IsFiltered , a.IndexColumns , a.IncludedColumns FROM <span class="hljs-meta"><span class="hljs-meta">#Indexes i JOIN sys.objects o WITH(NOLOCK) ON o.[object_id] = i.ObjectID JOIN sys.schemas s WITH(NOLOCK) ON s.[schema_id] = o.[schema_id] LEFT JOIN #AggColumns a ON a.ObjectID = i.ObjectID AND a.IndexID = i.IndexID LEFT JOIN #Sparse p ON p.ObjectID = i.ObjectID LEFT JOIN #Fragmentation f ON f.ObjectID = i.ObjectID AND f.IndexID = i.IndexID AND f.PartitionNumber = i.PartitionNumber LEFT JOIN ( SELECT ObjectID = [object_id] , IndexID = [index_id] , TotalWrites = NULLIF([user_updates], 0) , TotalReads = NULLIF([user_seeks] + [user_scans] + [user_lookups], 0) , TotalSeeks = NULLIF([user_seeks], 0) , TotalScans = NULLIF([user_scans], 0) , TotalLookups = NULLIF([user_lookups], 0) , LastUsage = ( SELECT MAX(dt) FROM ( VALUES ([last_user_seek]) , ([last_user_scan]) , ([last_user_lookup]) , ([last_user_update]) ) t(dt) ) FROM sys.dm_db_index_usage_stats WITH(NOLOCK) WHERE [database_id] = @DBID ) u ON i.ObjectID = u.ObjectID AND i.IndexID = u.IndexID LEFT JOIN #Lob lob ON lob.ObjectID = i.ObjectID AND lob.IndexID = i.IndexID LEFT JOIN sys.destination_data_spaces dds WITH(NOLOCK) ON i.DataSpaceID = dds.[partition_scheme_id] AND i.PartitionNumber = dds.[destination_id] JOIN sys.filegroups fg WITH(NOLOCK) ON ISNULL(dds.[data_space_id], i.DataSpaceID) = fg.[data_space_id] WHERE o.[type] IN ('V', 'U') AND ( f.Fragmentation &gt;= @Fragmentation OR i.PagesCount &gt; @PreDescribeSize OR i.IndexType IN (5, 6) )</span></span></code> </pre> <br> æ­¤åï¼Œç‚¹æŸ¥è¯¢ç¡®å®šå¤§ç´¢å¼•çš„ç¢ç‰‡çº§åˆ«ã€‚ <br><br><pre> <code class="1c hljs">EXEC sp_executesql N' DECLARE @DBID INT = DB_ID() SELECT [avg_fragmentation_in_percent] FROM sys.dm_db_index_physical_stats(@DBID, @ObjectID, @IndexID, @PartitionNumber, ''LIMITED'') WHERE [index_level] = 0 AND [alloc_unit_type_desc] = ''IN_ROW_DATA''' , N'@ObjectID int,@IndexID int,@PartitionNumber int' , @ObjectId = <span class="hljs-number"><span class="hljs-number">1044198770</span></span>, @IndexId = <span class="hljs-number"><span class="hljs-number">1</span></span>, @PartitionNumber = <span class="hljs-number"><span class="hljs-number">1</span></span> EXEC sp_executesql N' DECLARE @DBID INT = DB_ID() SELECT [avg_fragmentation_in_percent] FROM sys.dm_db_index_physical_stats(@DBID, @ObjectID, @IndexID, @PartitionNumber, ''LIMITED'') WHERE [index_level] = 0 AND [alloc_unit_type_desc] = ''IN_ROW_DATA''' , N'@ObjectID int,@IndexID int,@PartitionNumber int' , @ObjectId = <span class="hljs-number"><span class="hljs-number">1552724584</span></span>, @IndexId = <span class="hljs-number"><span class="hljs-number">0</span></span>, @PartitionNumber = <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br> ç”±äºè¿™ç§æ–¹æ³•ï¼Œåœ¨ç”ŸæˆæŸ¥è¯¢æ—¶ï¼Œå¯ä»¥è§£å†³ç«äº‰å¯¹æ‰‹åº”ç”¨ç¨‹åºä¸­é‡åˆ°çš„æ‰«ææ€§èƒ½é—®é¢˜ã€‚ è¿™å¯ä»¥å®Œæˆï¼Œä½†æ˜¯åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œé€æ¸å‡ºç°äº†æ–°çš„æƒ³æ³•ï¼Œå¯ä»¥æ‰©å±•æ‚¨äº§å“çš„åº”ç”¨èŒƒå›´ã€‚ <br><br> æœ€åˆï¼Œå®ç°äº†å¯¹ä½¿ç”¨WAIT_AT_LOW_PRIORITYçš„æ”¯æŒï¼Œç„¶åå¯ä»¥ä½¿ç”¨DATA_COMPRESSIONå’ŒFILL_FACTORé‡å»ºç´¢å¼•ã€‚ <br><br><img src="https://habrastorage.org/webt/kd/em/xj/kdemxjo8sj0hxa4y_omvv3dph6a.png" alt="SQLç´¢å¼•ç®¡ç†å™¨è®¾ç½®"><br><br> è¯¥åº”ç”¨ç¨‹åºå› ä»¥å‰æœªè®¡åˆ’çš„åŠŸèƒ½ï¼ˆä¾‹å¦‚ä¸ºä¸“æ ä½œå®¶æä¾›æœåŠ¡ï¼‰è€Œæ˜¾å¾—è¿‡äºæ‹¥æŒ¤ï¼š <br><br><pre> <code class="1c hljs">SELECT * FROM ( SELECT IndexID = [index_id] , PartitionNumber = [partition_number] , PagesCount = SUM([size_in_bytes]) / <span class="hljs-number"><span class="hljs-number">8192</span></span> , UnusedPagesCount = ISNULL(SUM(CASE WHEN [state] = <span class="hljs-number"><span class="hljs-number">1</span></span> THEN [size_in_bytes] END), <span class="hljs-number"><span class="hljs-number">0</span></span>) / <span class="hljs-number"><span class="hljs-number">8192</span></span> , Fragmentation = CAST(ISNULL(SUM(CASE WHEN [state] = <span class="hljs-number"><span class="hljs-number">1</span></span> THEN [size_in_bytes] END), <span class="hljs-number"><span class="hljs-number">0</span></span>) * <span class="hljs-number"><span class="hljs-number">100</span></span>. / SUM([size_in_bytes]) AS FLOAT) FROM sys.fn_column_store_row_groups(@ObjectID) GROUP BY [index_id] , [partition_number] ) t WHERE Fragmentation &gt;= @Fragmentation AND PagesCount BETWEEN @MinIndexSize AND @MaxIndexSize</code> </pre> <br> æˆ–åŸºäºdm_db_missing_indexä¸­çš„ä¿¡æ¯åˆ›å»ºéèšé›†ç´¢å¼•çš„åŠŸèƒ½ï¼š <br><br><pre> <code class="1c hljs">SELECT ObjectID = d.[object_id] , UserImpact = gs.[avg_user_impact] , TotalReads = gs.[user_seeks] + gs.[user_scans] , TotalSeeks = gs.[user_seeks] , TotalScans = gs.[user_scans] , LastUsage = ISNULL(gs.[last_user_scan], gs.[last_user_seek]) , IndexColumns = CASE WHEN d.[equality_columns] IS NOT <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> AND d.[inequality_columns] IS NOT <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> THEN d.[equality_columns] + ', ' + d.[inequality_columns] WHEN d.[equality_columns] IS NOT <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> AND d.[inequality_columns] IS <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> THEN d.[equality_columns] ELSE d.[inequality_columns] END , IncludedColumns = d.[included_columns] FROM sys.dm_db_missing_index_groups g WITH(NOLOCK) JOIN sys.dm_db_missing_index_group_stats gs WITH(NOLOCK) ON gs.[group_handle] = g.[index_group_handle] JOIN sys.dm_db_missing_index_details d WITH(NOLOCK) ON g.[index_handle] = d.[index_handle] WHERE d.[database_id] = DB_ID()</code> </pre> <br><h3> æ€»ç»“ </h3><br> ç»è¿‡å…­ä¸ªæœˆçš„ç§¯æå¼€å‘é˜¶æ®µï¼Œæˆ‘å¾ˆé«˜å…´è¿™äº›è®¡åˆ’è¿˜æ²¡æœ‰ç»“æŸï¼Œå› ä¸ºæˆ‘æƒ³è¿›ä¸€æ­¥å¼€å‘è¯¥äº§å“ã€‚ ä¸‹ä¸€æ­¥æ˜¯æ·»åŠ åŠŸèƒ½ä»¥æœç´¢é‡å¤æˆ–æœªä½¿ç”¨çš„ç´¢å¼•ï¼Œå¹¶åœ¨SQL Serverä¸­å®ç°å¯¹æœåŠ¡ç»Ÿè®¡çš„å…¨é¢æ”¯æŒã€‚ <br><br> åŸºäºå¸‚åœºä¸Šæœ‰è®¸å¤šä»˜è´¹è§£å†³æ–¹æ¡ˆçš„äº‹å®ï¼Œæˆ‘æƒ³ç›¸ä¿¡ç”±äºè‡ªç”±å®šä½ï¼Œæ›´ä¼˜åŒ–çš„å…ƒæ•°æ®æè¿°ä»¥åŠå¯¹æŸäººæœ‰ç”¨çš„å„ç§å°ä¸œè¥¿çš„å­˜åœ¨ï¼Œè¯¥äº§å“è‚¯å®šä¼šåœ¨æ—¥å¸¸ä»»åŠ¡ä¸­å˜å¾—æœ‰ç”¨ã€‚ <br><br> è¯¥åº”ç”¨ç¨‹åºçš„å½“å‰ç‰ˆæœ¬å¯ä»¥åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><b>GitHubä¸Š</b></a>ä¸‹è½½ã€‚ æ¥æºåœ¨åŒä¸€ä¸ªåœ°æ–¹ã€‚ </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN459914/">https://habr.com/ru/post/zh-CN459914/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN459898/index.html">è¯¥è®¡åˆ’å·²æ¢å¤ç»æµ</a></li>
<li><a href="../zh-CN459900/index.html">ä½¿ç”¨Seabornåº“å¯è§†åŒ–DataFrameä¸­çš„åˆ—</a></li>
<li><a href="../zh-CN459902/index.html">ä¿„ç½—æ–¯åœ°åŒºçš„äº’åŠ¨åœ°å›¾ï¼Œé€‚åˆåˆå­¦è€…ã€‚ æˆ‘çŠ¯çš„é”™è¯¯ï¼Œä½ ä¸èƒ½çŠ¯çš„é”™è¯¯</a></li>
<li><a href="../zh-CN459906/index.html">äº•å­—æ¸¸æˆï¼Œç¬¬3éƒ¨åˆ†ï¼šä½¿ç”¨å‘½ä»¤å­˜å‚¨æ’¤æ¶ˆ/é‡åš</a></li>
<li><a href="../zh-CN459910/index.html">æƒ…å†µï¼šå…¬å¸ä¸æ€¥ç€ä¸ºè¯­éŸ³åŠ©æ‰‹å¼€å‘æœåŠ¡-æœ‰ä»€ä¹ˆé£é™©</a></li>
<li><a href="../zh-CN459918/index.html">ä½¿ç”¨pwnable.kr 03-BOFè§£å†³é—®é¢˜ å †æ ˆä¸Šçš„ç¼“å†²åŒºæº¢å‡º</a></li>
<li><a href="../zh-CN459922/index.html">åœ¨è½´æ‰¿æŒ¯åŠ¨è¯Šæ–­è¿‡ç¨‹ä¸­æ¶ˆé™¤æŒ¯åŠ¨ä¼ æ„Ÿå™¨ä¿¡å·ä¸­çš„é«˜é¢‘å™ªå£°</a></li>
<li><a href="../zh-CN459924/index.html">å®Œæ•´çš„Reactæµ‹è¯•å‘¨æœŸã€‚ Auto.ruæŠ¥å‘Š</a></li>
<li><a href="../zh-CN459928/index.html">å­¦ç”Ÿçš„ç§»åŠ¨åº”ç”¨å¼€å‘ä¹‹è·¯</a></li>
<li><a href="../zh-CN459930/index.html">Pythonå¯¼å…¥è‡ªåŠ¨åŒ–</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>