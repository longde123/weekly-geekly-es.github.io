<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíÖüèø üå¨Ô∏è üë©‚Äçüëß‚Äçüëß Erstellen Sie Google-Nutzer aus PowerShell √ºber die API üñêüèø üçÇ ü§¥üèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hallo! 

 In diesem Artikel wird beschrieben, wie PowerShell mit der Google-API interagiert, um G Suite-Benutzer zu bearbeiten. 

 In der Organisation...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Erstellen Sie Google-Nutzer aus PowerShell √ºber die API</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/468969/">  Hallo! <br><br>  In diesem Artikel wird beschrieben, wie PowerShell mit der Google-API interagiert, um G Suite-Benutzer zu bearbeiten. <br><br>  In der Organisation verwenden wir mehrere interne und Cloud-Dienste.  Die Autorisierung in diesen beiden F√§llen h√§ngt gr√∂√ütenteils von Google oder Active Directory ab, zwischen denen wir kein Replikat verwalten k√∂nnen. Wenn ein neuer Mitarbeiter freigegeben wird, m√ºssen Sie in diesen beiden Systemen ein Konto erstellen / aktivieren.  Um den Prozess zu automatisieren, haben wir beschlossen, ein Skript zu schreiben, das Informationen sammelt und an beide Dienste sendet. <br><a name="habracut"></a><br><h3>  <font color="#5D8DDF">Login</font> </h3><br>  Als wir die Anforderungen zusammenstellten, entschieden wir uns, echte Personen als Administratoren f√ºr die Autorisierung zu verwenden. Dies vereinfacht die Analyse von Aktionen im Falle versehentlicher oder absichtlicher massiver √Ñnderungen. <br><br>  Die Google-APIs verwenden das OAuth 2.0-Protokoll zur Authentifizierung und Autorisierung.  Anwendungsf√§lle und eine detailliertere Beschreibung finden Sie hier: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Verwenden von OAuth 2.0 f√ºr den Zugriff auf Google APIs</a> . <br><br>  Ich habe das Skript ausgew√§hlt, das f√ºr die Autorisierung in Desktop-Anwendungen verwendet wird.  Es besteht auch die M√∂glichkeit, ein Dienstkonto zu verwenden, das keine unn√∂tigen Bewegungen des Benutzers erfordert. <br><br>  Das Bild unten ist eine schematische Beschreibung des ausgew√§hlten Szenarios auf der Google-Seite. <br><br><img src="https://habrastorage.org/webt/wx/sp/rw/wxsprwm-uqyd1koa-2xx4sgjkku.png"><br><br><ol><li>  Zuerst senden wir den Benutzer auf die Authentifizierungsseite im Google-Konto und geben die GET-Parameter an: <br><ul><li>  Anwendungs-ID </li><li>  Bereiche, auf die die Anwendung Zugriff ben√∂tigt </li><li>  Adresse, an die der Benutzer nach Abschluss des Vorgangs umgeleitet wird </li><li>  die Art und Weise, wie wir das Token aktualisieren </li><li>  Best√§tigungscode </li><li>  √úbertragungsformat des Best√§tigungscodes </li></ul><br></li><li>  Nach Abschluss der Autorisierung wird der Benutzer mit einem Fehler oder Autorisierungscode, der von den GET-Parametern √ºbertragen wird, auf die in der ersten Anforderung angegebene Seite umgeleitet </li><li>  Die Anwendung (das Skript) muss diese Parameter abrufen und, wenn der Code empfangen wird, die folgende Anforderung f√ºr Token ausf√ºhren </li><li>  Wenn die Anforderung korrekt ist, gibt die Google-API Folgendes zur√ºck: <br><br><ul><li>  Zugriffstoken, mit dem wir Anfragen stellen k√∂nnen </li><li>  G√ºltigkeit dieses Tokens </li><li>  Aktualisierungstoken zum Aktualisieren des Zugriffstokens erforderlich. </li></ul></li></ol><br>  Zuerst m√ºssen Sie zur Google API-Konsole gehen: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Anmeldeinformationen - Google API Console</a> , die gew√ºnschte Anwendung ausw√§hlen und die Client-OAuth-ID im Abschnitt Anmeldeinformationen erstellen.  An derselben Stelle (oder sp√§ter in den Eigenschaften des erstellten Bezeichners) m√ºssen Sie die Adressen angeben, an die die Umleitung zul√§ssig ist.  In unserem Fall handelt es sich um mehrere localhost-Eintr√§ge mit unterschiedlichen Ports (siehe unten). <br><br>  Um das Lesen des Skriptalgorithmus zu vereinfachen, k√∂nnen Sie die ersten Schritte in einer separaten Funktion ausgeben, die Zugriffs- und Aktualisierungstoken f√ºr die Anwendung zur√ºckgibt: <br><br><pre><code class="cs hljs">$client_secret = <span class="hljs-string"><span class="hljs-string">'Our Client Secret'</span></span> $client_id = <span class="hljs-string"><span class="hljs-string">'Our Client ID'</span></span> function Get-GoogleAuthToken { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (-not [System.Net.HttpListener]::IsSupported) { <span class="hljs-string"><span class="hljs-string">"HttpListener is not supported."</span></span> exit <span class="hljs-number"><span class="hljs-number">1</span></span> } $codeverifier = -<span class="hljs-keyword"><span class="hljs-keyword">join</span></span> ((<span class="hljs-number"><span class="hljs-number">65.</span></span><span class="hljs-number"><span class="hljs-number">.90</span></span>) + (<span class="hljs-number"><span class="hljs-number">97.</span></span><span class="hljs-number"><span class="hljs-number">.122</span></span>) + (<span class="hljs-number"><span class="hljs-number">48.</span></span><span class="hljs-number"><span class="hljs-number">.57</span></span>) + <span class="hljs-number"><span class="hljs-number">45</span></span> + <span class="hljs-number"><span class="hljs-number">46</span></span> + <span class="hljs-number"><span class="hljs-number">95</span></span> + <span class="hljs-number"><span class="hljs-number">126</span></span> |Get-Random -Count <span class="hljs-number"><span class="hljs-number">60</span></span>| % {[<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>]$_}) $hasher = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> System.Security.Cryptography.SHA256Managed $hashByteArray = $hasher.ComputeHash([System.Text.Encoding]::UTF8.GetBytes($codeverifier)) $base64 = ((([System.Convert]::ToBase64String($hashByteArray)).replace(<span class="hljs-string"><span class="hljs-string">'='</span></span>,<span class="hljs-string"><span class="hljs-string">''</span></span>)).replace(<span class="hljs-string"><span class="hljs-string">'+'</span></span>,<span class="hljs-string"><span class="hljs-string">'-'</span></span>)).replace(<span class="hljs-string"><span class="hljs-string">'/'</span></span>,<span class="hljs-string"><span class="hljs-string">'_'</span></span>) $ports = @(<span class="hljs-number"><span class="hljs-number">10600</span></span>,<span class="hljs-number"><span class="hljs-number">15084</span></span>,<span class="hljs-number"><span class="hljs-number">39700</span></span>,<span class="hljs-number"><span class="hljs-number">42847</span></span>,<span class="hljs-number"><span class="hljs-number">65387</span></span>,<span class="hljs-number"><span class="hljs-number">32079</span></span>) $port = $ports[(<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>-random -Minimum <span class="hljs-number"><span class="hljs-number">0</span></span> -maximum <span class="hljs-number"><span class="hljs-number">5</span></span>)] Write-Host <span class="hljs-string"><span class="hljs-string">"Start browser..."</span></span> Start-Process <span class="hljs-string"><span class="hljs-string">"https://accounts.google.com/o/oauth2/v2/auth?code_challenge_method=S256&amp;code_challenge=$base64&amp;access_type=offline&amp;client_id=$client_id&amp;redirect_uri=http://localhost:$port&amp;response_type=code&amp;scope=https://www.googleapis.com/auth/admin.directory.user https://www.googleapis.com/auth/admin.directory.group"</span></span> $listener = New-Object System.Net.HttpListener $listener.Prefixes.Add(<span class="hljs-string"><span class="hljs-string">"http://localhost:"</span></span>+$port+<span class="hljs-string"><span class="hljs-string">'/'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> {$listener.Start()} <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> { <span class="hljs-string"><span class="hljs-string">"Unable to start listener."</span></span> exit <span class="hljs-number"><span class="hljs-number">1</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (($code -eq $<span class="hljs-literal"><span class="hljs-literal">null</span></span>)) { $context = $listener.GetContext() Write-Host <span class="hljs-string"><span class="hljs-string">"Connection accepted"</span></span> -f <span class="hljs-string"><span class="hljs-string">'mag'</span></span> $url = $context.Request.RawUrl $code = $url.split(<span class="hljs-string"><span class="hljs-string">'?'</span></span>)[<span class="hljs-number"><span class="hljs-number">1</span></span>].split(<span class="hljs-string"><span class="hljs-string">'='</span></span>)[<span class="hljs-number"><span class="hljs-number">1</span></span>].split(<span class="hljs-string"><span class="hljs-string">'&amp;'</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($url.split(<span class="hljs-string"><span class="hljs-string">'?'</span></span>)[<span class="hljs-number"><span class="hljs-number">1</span></span>].split(<span class="hljs-string"><span class="hljs-string">'='</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>] -eq <span class="hljs-string"><span class="hljs-string">'error'</span></span>) { Write-Host <span class="hljs-string"><span class="hljs-string">"Error!"</span></span>$code -f <span class="hljs-string"><span class="hljs-string">'red'</span></span> $buffer = [System.Text.Encoding]::UTF8.GetBytes(<span class="hljs-string"><span class="hljs-string">"Error!"</span></span>+$code) $context.Response.ContentLength64 = $buffer.Length $context.Response.OutputStream.Write($buffer, <span class="hljs-number"><span class="hljs-number">0</span></span>, $buffer.Length) $context.Response.OutputStream.Close() $listener.Stop() exit <span class="hljs-number"><span class="hljs-number">1</span></span> } $buffer = [System.Text.Encoding]::UTF8.GetBytes(<span class="hljs-string"><span class="hljs-string">"Now you can close this browser tab."</span></span>) $context.Response.ContentLength64 = $buffer.Length $context.Response.OutputStream.Write($buffer, <span class="hljs-number"><span class="hljs-number">0</span></span>, $buffer.Length) $context.Response.OutputStream.Close() $listener.Stop() } Return Invoke-RestMethod -Method Post -Uri <span class="hljs-string"><span class="hljs-string">"https://www.googleapis.com/oauth2/v4/token"</span></span> -Body @{ code = $code client_id = $client_id client_secret = $client_secret redirect_uri = <span class="hljs-string"><span class="hljs-string">'http://localhost:'</span></span>+$port grant_type = <span class="hljs-string"><span class="hljs-string">'authorization_code'</span></span> code_verifier = $codeverifier } $code = $<span class="hljs-literal"><span class="hljs-literal">null</span></span></code> </pre> <br>  Wir legen die Client-ID und das Client-Geheimnis fest, die in den Eigenschaften der OAuth-Client-ID erhalten wurden, und der Code-Verifizierer ist eine Zeichenfolge mit einer L√§nge von 43 bis 128 Zeichen, die zuf√§llig aus nicht reservierten Zeichen generiert werden sollte: [AZ] / [az] / [0-9 ] / "-" / "."  / "_" / "~". <br><br>  Weiterhin wird dieser Code erneut √ºbertragen.  Dadurch wird die Sicherheitsanf√§lligkeit beseitigt, bei der ein Angreifer die Antwort abfangen kann, die nach der Benutzerautorisierung als Weiterleitung zur√ºckgegeben wurde. <br>  Sie k√∂nnen den Code-Verifizierer in der aktuellen Anforderung in klarer Form senden (was es sinnlos macht - dies ist nur f√ºr Systeme geeignet, die SHA256 nicht unterst√ºtzen) oder indem Sie einen SHA256-Hash erstellen, der in BASE64Url codiert werden muss (unterscheidet sich von Base64 durch zwei Zeichen der Tabelle) und das Zeichen l√∂schen Zeilenende: =. <br><br>  Als N√§chstes m√ºssen wir http auf dem lokalen Computer abh√∂ren, um nach der Autorisierung eine Antwort zu erhalten, die als Umleitung zur√ºckgegeben wird. <br><br>  Verwaltungsaufgaben werden auf einem speziellen Server ausgef√ºhrt. Wir k√∂nnen nicht ausschlie√üen, dass mehrere Administratoren das Skript gleichzeitig ausf√ºhren. Daher w√§hlt er zuf√§llig einen Port f√ºr den aktuellen Benutzer aus. Ich habe jedoch vordefinierte Ports angegeben, da  Sie m√ºssen auch in der API-Konsole als vertrauensw√ºrdig hinzugef√ºgt werden. <br><br>  <i>access_type = offline</i> bedeutet, dass die Anwendung das abgelaufene Token unabh√§ngig aktualisieren kann, ohne dass der Benutzer mit dem Browser interagieren muss. <br>  <i>response_type = code</i> legt das Format f√ºr die R√ºckgabe des Codes fest (unter Bezugnahme auf die alte Autorisierungsmethode, als der Benutzer den Code vom Browser in das Skript kopierte). <br>  <i>Umfang</i> gibt den <i>Umfang</i> und die Art des Zugriffs an.  Sie m√ºssen durch Leerzeichen oder% 20 getrennt werden (gem√§√ü URL-Codierung).  Eine Liste der Zugriffsbereiche mit Typen finden Sie hier: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">OAuth 2.0-</a> Bereiche <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">f√ºr Google-APIs</a> . <br><br>  Nach Erhalt des Autorisierungscodes gibt die Anwendung eine Abschlussnachricht an den Browser zur√ºck, h√∂rt auf, den Port abzuh√∂ren, und sendet eine POST-Anforderung zum Empfangen des Tokens.  Wir geben darin die zuvor festgelegte ID und das Geheimnis der Konsolen-API an, die Adresse, an die der Benutzer umgeleitet wird, und grant_type gem√§√ü der Protokollspezifikation. <br><br>  Als Antwort erhalten wir ein Zugriffstoken, dessen Dauer in Sekunden und ein Aktualisierungstoken, mit dem wir das Zugriffstoken aktualisieren k√∂nnen. <br><br>  Die Anwendung sollte die Token an einem sicheren Ort mit langer Haltbarkeit aufbewahren. Bis wir den empfangenen Zugriff widerrufen, wird das Aktualisierungstoken nicht an die Anwendung zur√ºckgegeben.  Am Ende habe ich eine Aufforderung zum Widerruf des Tokens hinzugef√ºgt. Wenn die Anwendung nicht erfolgreich abgeschlossen wurde und das Aktualisierungstoken nicht zur√ºckgegeben wurde, wird der Vorgang erneut gestartet (wir hielten es f√ºr unsicher, Token lokal auf dem Terminal zu speichern, m√∂chten jedoch die Kryptografie nicht komplizieren oder den Browser h√§ufig √∂ffnen). <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { $token_result = Get-GoogleAuthToken $token = $token_result.<span class="hljs-function"><span class="hljs-function">access_token </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$token_result.refresh_token -eq $</span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">null</span></span></span></span></span><span class="hljs-function">)</span></span> { Write-Host (<span class="hljs-string"><span class="hljs-string">"Session is not destroyed. Revoking token..."</span></span>) Invoke-WebRequest -Uri (<span class="hljs-string"><span class="hljs-string">"https://accounts.google.com/o/oauth2/revoke?token="</span></span>+$token) } } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ($token_result.refresh_token -eq $<span class="hljs-literal"><span class="hljs-literal">null</span></span>) $refresh_token = $token_result.refresh_token $minute = ([<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>](<span class="hljs-string"><span class="hljs-string">"{0:mm}"</span></span> -f ([timespan]::fromseconds($token_result.expires_in))))+((Get-date).Minute)<span class="hljs-number"><span class="hljs-number">-2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($minute -lt <span class="hljs-number"><span class="hljs-number">0</span></span>) {$minute += <span class="hljs-number"><span class="hljs-number">60</span></span>} elseif ($minute -gt <span class="hljs-number"><span class="hljs-number">59</span></span>) {$minute -=<span class="hljs-number"><span class="hljs-number">60</span></span>} $token_expire = @{ hour = ([<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>](<span class="hljs-string"><span class="hljs-string">"{0:hh}"</span></span> -f ([timespan]::fromseconds($token_result.expires_in))))+((Get-date).Hour) minute = $minute }</code> </pre><br>  Wie Sie vielleicht bemerkt haben, wird beim Aufrufen eines Tokens Invoke-WebRequest verwendet.  Im Gegensatz zu Invoke-RestMethod werden die empfangenen Daten nicht in einem geeigneten Format zur Verwendung zur√ºckgegeben und der Status der Anforderung angezeigt. <br><br>  Als N√§chstes werden Sie vom Skript aufgefordert, den Vor- und Nachnamen des Benutzers einzugeben und einen Benutzernamen + eine E-Mail zu generieren. <br><br><h3>  <font color="#5D8DDF">Anfragen</font> </h3><br>  Im Folgenden sind die Anforderungen aufgef√ºhrt. Zun√§chst m√ºssen Sie √ºberpr√ºfen, ob der Benutzer bereits mit einem solchen Login vorhanden ist, um eine Entscheidung √ºber das Erstellen eines neuen oder das Aktivieren des aktuellen Logins zu treffen. <br><br>  Ich habe beschlossen, alle Anforderungen im Format einer einzelnen Funktion mit einer Auswahl √ºber switch zu implementieren: <br><br><pre> <code class="cs hljs">function GoogleQuery { param ( $type, $query ) <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> ($type) { <span class="hljs-string"><span class="hljs-string">"SearchAccount"</span></span> { Return Invoke-RestMethod -Method Get -Uri <span class="hljs-string"><span class="hljs-string">"https://www.googleapis.com/admin/directory/v1/users"</span></span> -Headers @{Authorization = <span class="hljs-string"><span class="hljs-string">"Bearer "</span></span>+(Get-GoogleToken)} -Body @{ domain = <span class="hljs-string"><span class="hljs-string">'rocketguys.com'</span></span> query = <span class="hljs-string"><span class="hljs-string">"email:$query"</span></span> } } <span class="hljs-string"><span class="hljs-string">"UpdateAccount"</span></span> { $body = @{ name = @{ givenName = $query[<span class="hljs-string"><span class="hljs-string">'givenName'</span></span>] familyName = $query[<span class="hljs-string"><span class="hljs-string">'familyName'</span></span>] } suspended = <span class="hljs-string"><span class="hljs-string">'false'</span></span> password = $query[<span class="hljs-string"><span class="hljs-string">'password'</span></span>] changePasswordAtNextLogin = <span class="hljs-string"><span class="hljs-string">'true'</span></span> phones = @(@{ primary = <span class="hljs-string"><span class="hljs-string">'true'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = $query[<span class="hljs-string"><span class="hljs-string">'phone'</span></span>] type = <span class="hljs-string"><span class="hljs-string">"mobile"</span></span> }) orgUnitPath = $query[<span class="hljs-string"><span class="hljs-string">'orgunit'</span></span>] } Return Invoke-RestMethod -Method Put -Uri (<span class="hljs-string"><span class="hljs-string">"https://www.googleapis.com/admin/directory/v1/users/"</span></span>+$query[<span class="hljs-string"><span class="hljs-string">'email'</span></span>]) -Headers @{Authorization = <span class="hljs-string"><span class="hljs-string">"Bearer "</span></span>+(Get-GoogleToken)} -Body (ConvertTo-Json $body) -ContentType <span class="hljs-string"><span class="hljs-string">'application/json; charset=utf-8'</span></span> } <span class="hljs-string"><span class="hljs-string">"CreateAccount"</span></span> { $body = @{ primaryEmail = $query[<span class="hljs-string"><span class="hljs-string">'email'</span></span>] name = @{ givenName = $query[<span class="hljs-string"><span class="hljs-string">'givenName'</span></span>] familyName = $query[<span class="hljs-string"><span class="hljs-string">'familyName'</span></span>] } suspended = <span class="hljs-string"><span class="hljs-string">'false'</span></span> password = $query[<span class="hljs-string"><span class="hljs-string">'password'</span></span>] changePasswordAtNextLogin = <span class="hljs-string"><span class="hljs-string">'true'</span></span> phones = @(@{ primary = <span class="hljs-string"><span class="hljs-string">'true'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = $query[<span class="hljs-string"><span class="hljs-string">'phone'</span></span>] type = <span class="hljs-string"><span class="hljs-string">"mobile"</span></span> }) orgUnitPath = $query[<span class="hljs-string"><span class="hljs-string">'orgunit'</span></span>] } Return Invoke-RestMethod -Method Post -Uri <span class="hljs-string"><span class="hljs-string">"https://www.googleapis.com/admin/directory/v1/users"</span></span> -Headers @{Authorization = <span class="hljs-string"><span class="hljs-string">"Bearer "</span></span>+(Get-GoogleToken)} -Body (ConvertTo-Json $body) -ContentType <span class="hljs-string"><span class="hljs-string">'application/json; charset=utf-8'</span></span> } <span class="hljs-string"><span class="hljs-string">"AddMember"</span></span> { $body = @{ userKey = $query[<span class="hljs-string"><span class="hljs-string">'email'</span></span>] } $ifrequest = Invoke-RestMethod -Method Get -Uri <span class="hljs-string"><span class="hljs-string">"https://www.googleapis.com/admin/directory/v1/groups"</span></span> -Headers @{Authorization = <span class="hljs-string"><span class="hljs-string">"Bearer "</span></span>+(Get-GoogleToken)} -Body $body $array = @() <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($<span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> $ifrequest.groups) {$array += $<span class="hljs-keyword"><span class="hljs-keyword">group</span></span>.email} <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($array -notcontains $query[<span class="hljs-string"><span class="hljs-string">'groupkey'</span></span>]) { $body = @{ email = $query[<span class="hljs-string"><span class="hljs-string">'email'</span></span>] role = <span class="hljs-string"><span class="hljs-string">"MEMBER"</span></span> } Return Invoke-RestMethod -Method Post -Uri (<span class="hljs-string"><span class="hljs-string">"https://www.googleapis.com/admin/directory/v1/groups/"</span></span>+$query[<span class="hljs-string"><span class="hljs-string">'groupkey'</span></span>]+<span class="hljs-string"><span class="hljs-string">"/members"</span></span>) -Headers @{Authorization = <span class="hljs-string"><span class="hljs-string">"Bearer "</span></span>+(Get-GoogleToken)} -Body (ConvertTo-Json $body) -ContentType <span class="hljs-string"><span class="hljs-string">'application/json; charset=utf-8'</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Return ($query[<span class="hljs-string"><span class="hljs-string">'email'</span></span>]+<span class="hljs-string"><span class="hljs-string">" now is a member of "</span></span>+$query[<span class="hljs-string"><span class="hljs-string">'groupkey'</span></span>]) } } } }</code> </pre> <br>  In jeder Anforderung m√ºssen Sie einen Autorisierungsheader senden, der den Tokentyp und das Zugriffstoken selbst enth√§lt.  Im Moment ist die Art des Tokens immer Tr√§ger.  Weil  Wir m√ºssen √ºberpr√ºfen, ob das Token nicht abgelaufen ist, und es nach einer Stunde ab dem Zeitpunkt seiner Ausgabe aktualisieren. Ich habe eine Anforderung f√ºr eine andere Funktion angegeben, die ein Zugriffstoken zur√ºckgibt.  Der gleiche Code befindet sich am Anfang des Skripts, wenn das erste Zugriffstoken empfangen wird: <br><br><pre> <code class="cs hljs">function Get-GoogleToken { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (((Get-date).Hour -gt $token_expire.hour) -or (((Get-date).Hour -ge $token_expire.hour) -and ((Get-date).Minute -gt $token_expire.minute))) { Write-Host <span class="hljs-string"><span class="hljs-string">"Token Expired. Refreshing..."</span></span> $request = (Invoke-RestMethod -Method Post -Uri <span class="hljs-string"><span class="hljs-string">"https://www.googleapis.com/oauth2/v4/token"</span></span> -ContentType <span class="hljs-string"><span class="hljs-string">'application/x-www-form-urlencoded'</span></span> -Body @{ client_id = $client_id client_secret = $client_secret refresh_token = $refresh_token grant_type = <span class="hljs-string"><span class="hljs-string">'refresh_token'</span></span> }) $token = $request.access_token $minute = ([<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>](<span class="hljs-string"><span class="hljs-string">"{0:mm}"</span></span> -f ([timespan]::fromseconds($request.expires_in))))+((Get-date).Minute)<span class="hljs-number"><span class="hljs-number">-2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($minute -lt <span class="hljs-number"><span class="hljs-number">0</span></span>) {$minute += <span class="hljs-number"><span class="hljs-number">60</span></span>} elseif ($minute -gt <span class="hljs-number"><span class="hljs-number">59</span></span>) {$minute -=<span class="hljs-number"><span class="hljs-number">60</span></span>} $script:token_expire = @{ hour = ([<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>](<span class="hljs-string"><span class="hljs-string">"{0:hh}"</span></span> -f ([timespan]::fromseconds($request.expires_in))))+((Get-date).Hour) minute = $minute } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $token }</code> </pre> <br>  √úberpr√ºfen des Logins auf Existenz: <br><br><pre> <code class="cs hljs">function Check_Google { $query = (GoogleQuery <span class="hljs-string"><span class="hljs-string">'SearchAccount'</span></span> $username) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($query.users -ne $<span class="hljs-literal"><span class="hljs-literal">null</span></span>) { $user = $query.users[<span class="hljs-number"><span class="hljs-number">0</span></span>] Write-Host $user.name.fullName<span class="hljs-string"><span class="hljs-string">' - '</span></span>$user.PrimaryEmail<span class="hljs-string"><span class="hljs-string">' - suspended: '</span></span>$user.Suspended $GAresult = $user } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($GAresult) { $<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> = $GAresult } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {$<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> = <span class="hljs-string"><span class="hljs-string">'gg'</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> }</code> </pre> <br>  E-Mail-Anfrage: $ query fordert die API auf, nach einem Benutzer mit genau dieser E-Mail zu suchen, einschlie√ülich Aliasnamen.  Sie k√∂nnen auch Platzhalter verwenden: <i>=,:,: {PREFIX} *</i> . <br><br>  Um Daten zu erhalten, wird die GET-Anforderungsmethode verwendet, um Daten einzuf√ºgen (ein Konto zu erstellen oder ein Mitglied zu einer Gruppe hinzuzuf√ºgen) - POST, um vorhandene Daten zu aktualisieren - PUT, um einen Eintrag zu l√∂schen (z. B. einen Teilnehmer aus einer Gruppe) - DELETE. <br><br>  Das Skript fordert au√üerdem eine Telefonnummer (eine ung√ºltige Zeichenfolge) an und nimmt sie in eine regionale Verteilergruppe auf.  Sie entscheidet anhand der ausgew√§hlten Active Directory-Organisationseinheit, welche Organisationseinheit der Benutzer haben soll, und gibt ein Kennwort aus: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { $phone = Read-Host <span class="hljs-string"><span class="hljs-string">"   +7"</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (-not $phone) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { $moscow = Read-Host <span class="hljs-string"><span class="hljs-string">"  ? (y/n) "</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (-not (($moscow -eq <span class="hljs-string"><span class="hljs-string">'y'</span></span>) -or ($moscow -eq <span class="hljs-string"><span class="hljs-string">'n'</span></span>))) $orgunit = <span class="hljs-string"><span class="hljs-string">'/'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($OU -like <span class="hljs-string"><span class="hljs-string">"*OU=Delivery,OU=Users,OU=ROOT,DC=rocket,DC=local"</span></span>) { Write-host <span class="hljs-string"><span class="hljs-string">"   /Team delivery"</span></span> $orgunit = <span class="hljs-string"><span class="hljs-string">"/Team delivery"</span></span> } $Password = -<span class="hljs-keyword"><span class="hljs-keyword">join</span></span> ( <span class="hljs-number"><span class="hljs-number">48.</span></span><span class="hljs-number"><span class="hljs-number">.57</span></span> + <span class="hljs-number"><span class="hljs-number">65.</span></span><span class="hljs-number"><span class="hljs-number">.90</span></span> + <span class="hljs-number"><span class="hljs-number">97.</span></span><span class="hljs-number"><span class="hljs-number">.122</span></span> | Get-Random -Count <span class="hljs-number"><span class="hljs-number">12</span></span> | % {[<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>]$_})+<span class="hljs-string"><span class="hljs-string">"*Ba"</span></span></code> </pre><br>  Und dann beginnt das Konto zu manipulieren: <br><br><pre> <code class="cs hljs">$query = @{ email = $email givenName = $firstname familyName = $lastname password = $password phone = $phone orgunit = $orgunit } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($GMailExist) { Write-Host <span class="hljs-string"><span class="hljs-string">"  "</span></span> -<span class="hljs-function"><span class="hljs-function">f </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mag</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">GoogleQuery </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'UpdateAccount'</span></span></span></span><span class="hljs-function"><span class="hljs-params"> $query</span></span></span><span class="hljs-function">) | fl write-host "      $Username  Google." } else</span></span> { Write-Host <span class="hljs-string"><span class="hljs-string">"  "</span></span> -<span class="hljs-function"><span class="hljs-function">f </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mag</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">GoogleQuery </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'CreateAccount'</span></span></span></span><span class="hljs-function"><span class="hljs-params"> $query</span></span></span><span class="hljs-function">) | fl } </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$moscow -eq </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"y"</span></span></span></span></span><span class="hljs-function">)</span></span>{ write-host <span class="hljs-string"><span class="hljs-string">"   moscowoffice"</span></span> $query = @{ groupkey = <span class="hljs-string"><span class="hljs-string">'moscowoffice@rocketguys.com'</span></span> email = $email } (GoogleQuery <span class="hljs-string"><span class="hljs-string">'AddMember'</span></span> $query) | fl }</code> </pre><br>  Die Funktionen zum Aktualisieren und Erstellen eines Kontos haben dieselbe Syntax. Es sind nicht alle zus√§tzlichen Felder erforderlich. In dem Abschnitt mit Telefonnummern m√ºssen Sie ein Array angeben, das aus einem Datensatz eine Nummer und einen Typ enthalten kann. <br><br>  Um beim Hinzuf√ºgen eines Benutzers zu einer Gruppe keinen Fehler zu erhalten, k√∂nnen wir zun√§chst √ºberpr√ºfen, ob er bereits in dieser Gruppe ist, indem wir vom Benutzer selbst eine Liste der Gruppenmitglieder oder die Zusammensetzung erhalten. <br><br>  <b>Eine Anfrage f√ºr die Zusammensetzung von Gruppen eines bestimmten Benutzers ist nicht rekursiv und zeigt nur eine direkte Mitgliedschaft.</b>  Die Aufnahme des Benutzers in die √ºbergeordnete Gruppe, in der die untergeordnete Gruppe, zu der der Benutzer geh√∂rt, bereits erfolgreich ist. <br><br><h3>  <font color="#5D8DDF">Fazit</font> </h3><br>  Es bleibt dem Benutzer das Passwort f√ºr das neue Konto zu senden.  Wir tun dies per SMS und senden allgemeine Informationen mit Anweisungen und Login an die pers√∂nliche Post, die zusammen mit der Telefonnummer von der Personalauswahlabteilung bereitgestellt wurde.  Alternativ k√∂nnen Sie Geld sparen und ein Passwort an einen geheimen Telegramm-Chat senden, was auch als zweiter Faktor angesehen werden kann (Macbooks sind eine Ausnahme). <br><br>  Vielen Dank f√ºr das Lesen bis zum Ende.  Ich freue mich √ºber Vorschl√§ge zur Verbesserung des Schreibstils von Artikeln und m√∂chte, dass Sie beim Schreiben von Skripten weniger Fehler feststellen =) <br><br>  Liste der Links, die thematisch n√ºtzlich sein k√∂nnen oder nur Ihre Fragen beantworten: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">OAuth 2.0 f√ºr Mobile &amp; Desktop Apps</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Verwenden von OAuth 2.0 f√ºr Webserveranwendungen</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Proof-Schl√ºssel f√ºr den Code-Austausch durch √∂ffentliche OAuth-Clients</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Generieren Sie zuf√§llige Buchstaben mit PowerShell</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">ASCII-Tabelle und Beschreibung</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">PowerShell: Abrufen des Hashwerts f√ºr eine Zeichenfolge</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Base64Url codieren / decodieren</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Base64-Codierung vs. Base64url-Codierung</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Invoke-RestMethod in PowerShell 5.1</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Kein Aktualisierungstoken erhalten, obwohl access_type in Schritt 1 offline ist</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">√úber Vergleichsoperatoren</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Verzeichnis-API: Benutzerkonten</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Suche nach Benutzern</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Verzeichnis-API: Gruppen</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Fehlerbehandlung f√ºr Invoke-RestMethod - Powershell</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de468969/">https://habr.com/ru/post/de468969/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de468957/index.html">Zyklische Dungeon-Generierung am Beispiel von Unexplored</a></li>
<li><a href="../de468959/index.html">Abh√§ngigkeitsmanagement in einem Multi-Modul-Projekt auf Hagel</a></li>
<li><a href="../de468961/index.html">Wie kann man die Routine im Leben f√ºr 560 Dollar loswerden? Oder wie man lebt, nicht lebt</a></li>
<li><a href="../de468963/index.html">Backup, Teil auf Wunsch der Leser: UrBackup-√úbersicht, BackupPC, AMANDA</a></li>
<li><a href="../de468967/index.html">"Technologie" zum Erhalten von Gleichungen der Dynamik von TAU. Und warum ist Systemidentifikation schei√üe und "ehrliche Physik" Regeln</a></li>
<li><a href="../de468971/index.html">Schreiben in Java f√ºr Nintendo DS</a></li>
<li><a href="../de468973/index.html">Neuronales Netzwerk zur Klassifizierung von Satellitenbildern mit Tensorflow in Python</a></li>
<li><a href="../de468989/index.html">UEBA-Markt stirbt - Es lebe die UEBA</a></li>
<li><a href="../de468991/index.html">Modulare Sprite-Charaktere und ihre Animation</a></li>
<li><a href="../de468993/index.html">Oculus Quest stellt eine Verbindung zu einem PC her und sieht H√§nde</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>