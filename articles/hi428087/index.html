<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ЁЯФТ тЩРя╕П ЁЯзСЁЯП┐тАНЁЯдЭтАНЁЯзСЁЯП╗ "рд▓реЙрдХ-рдлрд╝реНрд░реА, рдпрд╛ рд▓реЙрдХ-рдлрд╝реНрд░реА рдирд╣реАрдВ, рдпрд╣ рд╕рд╡рд╛рд▓ рд╣реИ" рдпрд╛ "рд╕реНрд╡рд╕реНрде рдиреАрдВрдж рдХрдбрд╝рд╡реА рдореВрд▓реА рд╕реЗ рднреА рдмрджрддрд░ рд╣реИ" ЁЯШ░ ЁЯд╜ЁЯП╝ ЁЯУТ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="" рдХреИрд╕реЗ рд╕рд╣реА рдврдВрдЧ рд╕реЗ рдФрд░ рдЧрд▓рдд рддрд░реАрдХреЗ рд╕реЗ рд╕реЛрдирд╛ рд╣реИ " рд▓реЗрдЦ рдкрд░ рдЯрд┐рдкреНрдкрдгрд┐рдпреЛрдВ рдиреЗ рдореБрдЭреЗ рдЗрд╕ рд▓реЗрдЦ рдХреЛ рд▓рд┐рдЦрдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░реЗрд░рд┐рдд рдХрд┐рдпрд╛ред 


 рдпрд╣ рдЖрд▓реЗрдЦ рдмрд╣реБ-рдереНрд░реЗрдбреЗрдб рдЕрдиреБрдкреНрд░рдпреЛрдЧреЛрдВ рдХреЗ рд╡рд┐рдХрд╛...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>"рд▓реЙрдХ-рдлрд╝реНрд░реА, рдпрд╛ рд▓реЙрдХ-рдлрд╝реНрд░реА рдирд╣реАрдВ, рдпрд╣ рд╕рд╡рд╛рд▓ рд╣реИ" рдпрд╛ "рд╕реНрд╡рд╕реНрде рдиреАрдВрдж рдХрдбрд╝рд╡реА рдореВрд▓реА рд╕реЗ рднреА рдмрджрддрд░ рд╣реИ"</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/428087/"><p>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдХреИрд╕реЗ рд╕рд╣реА рдврдВрдЧ рд╕реЗ рдФрд░ рдЧрд▓рдд рддрд░реАрдХреЗ рд╕реЗ рд╕реЛрдирд╛ рд╣реИ</a> " рд▓реЗрдЦ рдкрд░ рдЯрд┐рдкреНрдкрдгрд┐рдпреЛрдВ рдиреЗ рдореБрдЭреЗ рдЗрд╕ рд▓реЗрдЦ рдХреЛ рд▓рд┐рдЦрдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░реЗрд░рд┐рдд рдХрд┐рдпрд╛ред </p><br><p>  рдпрд╣ рдЖрд▓реЗрдЦ рдмрд╣реБ-рдереНрд░реЗрдбреЗрдб рдЕрдиреБрдкреНрд░рдпреЛрдЧреЛрдВ рдХреЗ рд╡рд┐рдХрд╛рд╕ рдкрд░ рдзреНрдпрд╛рди рдХреЗрдВрджреНрд░рд┐рдд рдХрд░реЗрдЧрд╛, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">LAppS</a> рдкрд░ рдХрд╛рдо рдХрд░рдиреЗ рдХреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдореЗрдВ рдЙрддреНрдкрдиреНрди рд╣реЛрдиреЗ рд╡рд╛рд▓реЗ рдХреБрдЫ рдорд╛рдорд▓реЛрдВ рдХреЗ рд▓реЙрдХ-рдлрд╝реНрд░реА рдХреА <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдкреНрд░рдпреЛрдЬреНрдпрддрд╛</a> , рдХрд╛рд░реНрдп рд╢реЗрдбреНрдпреВрд▓рд░ рдХреЗ рдЦрд┐рд▓рд╛рдл <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдиреИрдиреЛрд╕реЗрд▓реЗрдк</a> рдлрд╝рдВрдХреНрд╢рди рдФрд░ рд╣рд┐рдВрд╕рд╛ред </p><br><pre><code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">NB</span></span>:      <span class="hljs-selector-tag"><span class="hljs-selector-tag">C</span></span>++  <span class="hljs-selector-tag"><span class="hljs-selector-tag">Linux</span></span>,       <span class="hljs-selector-tag"><span class="hljs-selector-tag">POSIX</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1-2008</span></span>  <span class="hljs-selector-tag"><span class="hljs-selector-tag">a</span></span> (    ).</code> </pre> <br><p>  рд╕рд╛рдорд╛рдиреНрдп рддреМрд░ рдкрд░, рд╕рдм рдХреБрдЫ рдмрд╣реБрдд рдЧрдбрд╝рдмрдбрд╝ рд╣реИ, рдореБрдЭреЗ рдЙрдореНрдореАрдж рд╣реИ рдХрд┐ рдкреНрд░рд╕реНрддреБрддрд┐ рдореЗрдВ рд╡рд┐рдЪрд╛рд░ рдХреА рдЯреНрд░реЗрди рд╕реНрдкрд╖реНрдЯ рд╣реЛрдЧреАред  рдЕрдЧрд░ рджрд┐рд▓рдЪрд╕реНрдкреА рд╣реИ, рддреЛ рдореИрдВ рдПрдХ рдмрд┐рд▓реНрд▓реА рдХреЗ рд▓рд┐рдП рдкреВрдЫрддрд╛ рд╣реВрдВред </p><a name="habracut"></a><br><p>  рдЗрд╡реЗрдВрдЯ-рдУрд░рд┐рдПрдВрдЯреЗрдб рд╕реЙрдлрд╝реНрдЯрд╡реЗрдпрд░ рд╣рдореЗрд╢рд╛ рдХрд┐рд╕реА рдЪреАрдЬрд╝ рдХрд╛ рдЗрдВрддрдЬрд╝рд╛рд░ рдХрд░ рд░рд╣рд╛ рд╣реИред  рдЪрд╛рд╣реЗ рд╡рд╣ GUI рдпрд╛ рдиреЗрдЯрд╡рд░реНрдХ рд╕рд░реНрд╡рд░ рд╣реЛ, рд╡реЗ рдХрд┐рд╕реА рднреА рдИрд╡реЗрдВрдЯ рдХреА рдкреНрд░рддреАрдХреНрд╖рд╛ рдХрд░ рд░рд╣реЗ рд╣реИрдВ: рдХреАрдмреЛрд░реНрдб рдЗрдирдкреБрдЯ, рдорд╛рдЙрд╕ рдИрд╡реЗрдВрдЯ, рдиреЗрдЯрд╡рд░реНрдХ рдкрд░ рдкрд╣реБрдВрдЪрдиреЗ рд╡рд╛рд▓реЗ рдбреЗрдЯрд╛ рдкреИрдХреЗрдЯред  рд▓реЗрдХрд┐рди рд╕рднреА рд╕реЙрдлреНрдЯрд╡реЗрдпрд░ рдЕрд▓рдЧ рддрд░рд╣ рд╕реЗ рдЗрдВрддрдЬрд╛рд░ рдХрд░рддреЗ рд╣реИрдВред  рд▓реЙрдХ-рдлреНрд░реА рд╕рд┐рд╕реНрдЯрдо рдХреЗ рд▓рд┐рдП рдмрд┐рд▓реНрдХреБрд▓ рднреА рдЗрдВрддрдЬрд╛рд░ рдирд╣реАрдВ рдХрд░рдирд╛ рдкрдбрд╝рддрд╛ рд╣реИред  рдХрдо рд╕реЗ рдХрдо рд▓реЙрдХ-рдлреНрд░реА рдПрд▓реНрдЧреЛрд░рд┐рджрдо рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдП рдЬрд╣рд╛рдВ рдЖрдкрдХреЛ рдкреНрд░рддреАрдХреНрд╖рд╛ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИ, рдФрд░ рдпрд╣рд╛рдВ рддрдХ тАЛтАЛрдХрд┐ рд╣рд╛рдирд┐рдХрд╛рд░рдХ рднреАред  рд▓реЗрдХрд┐рди рд╣рдо рдкреНрд░рддрд┐рд╕реНрдкрд░реНрдзреА (рдмрд╣реБ-рдереНрд░реЗрдбреЗрдб) рд╕рд┐рд╕реНрдЯрдо рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдмрд╛рдд рдХрд░ рд░рд╣реЗ рд╣реИрдВ, рдФрд░ рдЕрдЬреАрдм рддрд░рд╣ рд╕реЗ рдкрд░реНрдпрд╛рдкреНрдд, рд▓реЙрдХ-рдлреНрд░реА рдПрд▓реНрдЧреЛрд░рд┐рджрдо рднреА рдЗрдВрддрдЬрд╛рд░ рдХрд░ рд░рд╣реЗ рд╣реИрдВред  рд╣рд╛рдВ, рд╡реЗ рд╕рдорд╛рдирд╛рдВрддрд░ рдзрд╛рдЧреЗ рдХреЗ рдирд┐рд╖реНрдкрд╛рджрди рдХреЛ рдЕрд╡рд░реБрджреНрдз рдирд╣реАрдВ рдХрд░рддреЗ рд╣реИрдВ, рд▓реЗрдХрд┐рди рд╡реЗ рдЦреБрдж рдХреЛ рдЕрд╡рд░реБрджреНрдз рдХрд┐рдП рдмрд┐рдирд╛ рдХреБрдЫ рдХрд░рдиреЗ рдХреЗ рдЕрд╡рд╕рд░ рдХреА рдкреНрд░рддреАрдХреНрд╖рд╛ рдХрд░ рд░рд╣реЗ рд╣реИрдВред </p><br><p>  LAppS рдореНрдпреВрдЯреЗрдХреНрд╕ рдФрд░ рд╕реЗрдорд╛рдлреЛрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдмрд╣реБрдд рд╕рдХреНрд░рд┐рдп рд░реВрдк рд╕реЗ рдХрд░рддрд╛ рд╣реИред  рдЗрд╕реА рд╕рдордп, рд╕реА ++ рдорд╛рдирдХ рдореЗрдВ рдХреЛрдИ рд╕реАрдореИрдлрд╝реЛрд░реНрд╕ рдирд╣реАрдВ рд╣реИрдВред  рддрдВрддреНрд░ рдмрд╣реБрдд рдорд╣рддреНрд╡рдкреВрд░реНрдг рдФрд░ рд╕реБрд╡рд┐рдзрд╛рдЬрдирдХ рд╣реИ, рд▓реЗрдХрд┐рди рд╕реА ++ рдХреЛ рдЙрди рдкреНрд░рдгрд╛рд▓рд┐рдпреЛрдВ рдкрд░ рдХрд╛рдо рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдП рдЬреЛ рд╕реЗрдореАрдлрд╝реЛрд░реНрд╕ рдХрд╛ рд╕рдорд░реНрдерди рдирд╣реАрдВ рдХрд░рддреЗ рд╣реИрдВ, рдФрд░ рдЗрд╕рд▓рд┐рдП рд╕реЗрдореАрдлрд╝реЛрд░реНрд╕ рдорд╛рдирдХ рдореЗрдВ рд╢рд╛рдорд┐рд▓ рдирд╣реАрдВ рд╣реИрдВред  рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдЕрдЧрд░ рдореИрдВ рд╕реЗрдорд╛рдлреЛрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реВрдВ рдХреНрдпреЛрдВрдХрд┐ рд╡реЗ рд╕реБрд╡рд┐рдзрд╛рдЬрдирдХ рд╣реИрдВ, рддреЛ рдореНрдпреВрдЯреЗрдХреНрд╕ рдХреНрдпреЛрдВрдХрд┐ рдореБрдЭреЗ рдХрд░рдирд╛ рд╣реИред </p><br><p>  рд▓рд┐рдирдХреНрд╕ рдореЗрдВ рдкреНрд░рддрд┐рд╕реНрдкрд░реНрдзрд╛рддреНрдордХ рд▓реЙрдХ (), рдЬреИрд╕реЗ sem_wait () рдХреЗ рдорд╛рдорд▓реЗ рдореЗрдВ рдореНрдпреВрдЯреЗрдХреНрд╕ рдХрд╛ рд╡реНрдпрд╡рд╣рд╛рд░, рдХрд╛рд░реНрдп рд╢реЗрдбреНрдпреВрд▓рд░ рдХрддрд╛рд░ рдХреЗ рдЕрдВрдд рдореЗрдВ рдкреНрд░рддреАрдХреНрд╖рд╛ рдереНрд░реЗрдб рдбрд╛рд▓рддрд╛ рд╣реИ, рдФрд░ рдЬрдм рдпрд╣ рд╢реАрд░реНрд╖ рдкрд░ рд╣реЛрддрд╛ рд╣реИ, рддреЛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рд▓реИрдВрдб рдкрд░ рд╡рд╛рдкрд╕ рдЖрдП рдмрд┐рдирд╛ рджреЛрд╣рд░рд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдереНрд░реЗрдб рд╡рд╛рдкрд╕ рдХрддрд╛рд░ рдореЗрдВ рд░рдЦрд╛ рдЬрд╛рддрд╛ рд╣реИ рдпрджрд┐ рдЕрдкреЗрдХреНрд╖рд┐рдд рдШрдЯрдирд╛ рдЕрднреА рддрдХ рдирд╣реАрдВ рд╣реБрдИ рд╣реИред  рдпрд╣ рдмрд╣реБрдд рдорд╣рддреНрд╡рдкреВрд░реНрдг рдмрд┐рдВрджреБ рд╣реИред </p><br><p>  рдФрд░ рдореИрдВрдиреЗ рдпрд╣ рдЬрд╛рдВрдЪрдиреЗ рдХрд╛ рдлреИрд╕рд▓рд╛ рдХрд┐рдпрд╛ рдХрд┐ рдХреНрдпрд╛ рдореИрдВ std :: mutex рдФрд░ POSIX рд╕реЗрдорд╛рдлреЛрд░реЗрд╕ рдХреЛ рдордирд╛ рдХрд░ рд╕рдХрддрд╛ рд╣реВрдВ, рдЙрдиреНрд╣реЗрдВ std :: atomic рдХреЗ рд╕рд╛рде рдЕрдиреБрдХрд░рдг рдХрд░рддреЗ рд╣реБрдП, рд▓реЛрдб рдХреЛ рдЬреНрдпрд╛рджрд╛рддрд░ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рднреВрдорд┐ рдореЗрдВ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд░ рд░рд╣рд╛ рд╣реВрдВред  рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдЕрд╕рдлрд▓ рд░рд╣рд╛, рд▓реЗрдХрд┐рди рдкрд╣рд▓реА рдЪреАрдЬреЗрдВ рдкрд╣рд▓реЗред </p><br><p>  рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ, рдореЗрд░реЗ рдкрд╛рд╕ рдХрдИ рдЦрдВрдб рд╣реИрдВ рдЬрд┐рдирдореЗрдВ рдпреЗ рдкреНрд░рдпреЛрдЧ рдЙрдкрдпреЛрдЧреА рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВ: </p><br><ul><li>  рд▓рд┐рдмреНрд░реЗрдПрд╕рдПрд╕рдПрд▓ (рдХреЗрд╕ 1) рдореЗрдВ рддрд╛рд▓реЗ; </li><li>  рдЕрд╡рд░реБрджреНрдз рдЬрдм рдкреЗрд▓реЛрдб рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП Lua рдЕрдиреБрдкреНрд░рдпреЛрдЧреЛрдВ (рдорд╛рдорд▓рд╛ 2) рдХреЗ рдкреИрдХреЗрдЯ рдкреНрд░рд╛рдкреНрдд; </li><li>  рд▓реВрдЖ рдЕрдиреБрдкреНрд░рдпреЛрдЧреЛрдВ (рдХреЗрд╕ 3) рджреНрд╡рд╛рд░рд╛ рд╕рдВрд╕рд╛рдзрд┐рдд рд╣реЛрдиреЗ рдХреЗ рд▓рд┐рдП рддреИрдпрд╛рд░ рдкреЗрд▓реЛрдб рдШрдЯрдирд╛рдУрдВ рдХреА рдкреНрд░рддреАрдХреНрд╖рд╛ рдХреА рдЬрд╛ рд░рд╣реА рд╣реИред </li></ul><br><p>  рдЪрд▓реЛ рдЧреИрд░-рдЕрд╡рд░реБрджреНрдз-рддрд╛рд▓реЗ рд╕реЗ рд╢реБрд░реВ рдХрд░рддреЗ рд╣реИрдВред  рдЖрдЗрдП рдПрдЯрдорд┐рдХреНрд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╣рдорд╛рд░реЗ рдореНрдпреВрдЯреЗрдХреНрд╕ рдХреЛ рд▓рд┐рдЦреЗрдВ, рдЬреИрд╕рд╛ рдХрд┐ рдПрдЪред рд╕рдЯрд░ рджреНрд╡рд╛рд░рд╛ рдХреБрдЫ рднрд╛рд╖рдгреЛрдВ рдореЗрдВ рджрд┐рдЦрд╛рдпрд╛ рдЧрдпрд╛ рд╣реИ (рдЗрд╕рд▓рд┐рдП рдХреЛрдИ рдореВрд▓ рдХреЛрдб рдирд╣реАрдВ рд╣реИ, рдЗрд╕рд▓рд┐рдП, рд╕реНрдореГрддрд┐ рд╕реЗ рдФрд░ рдЗрд╕рд▓рд┐рдП рдХреЛрдб рдореВрд▓ 100% рдХреЗ рд╕рд╛рде рдореЗрд▓ рдирд╣реАрдВ рдЦрд╛рддрд╛ рд╣реИ, рдФрд░ Satter рдореЗрдВ рдпрд╣ рдХреЛрдб C ++ 20 рдкреНрд░рдЧрддрд┐ рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд рдерд╛, рдЗрд╕рд▓рд┐рдП рдорддрднреЗрдж рд╣реИрдВ)ред  рдФрд░ рдЗрд╕ рдХреЛрдб рдХреА рд╕рд╛рджрдЧреА рдХреЗ рдмрд╛рд╡рдЬреВрдж, рдЗрд╕рдореЗрдВ рдиреБрдХрд╕рд╛рди рд╣реИрдВред </p><br><pre> <code class="hljs kotlin">#include &lt;atomic&gt; #include &lt;pthread.h&gt; namespace test { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mutex</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: std::atomic&lt;pthread_t&gt; mLock; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: explicit mutex():mLock{<span class="hljs-number"><span class="hljs-number">0</span></span>} { } mutex(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> mutex&amp;)=delete; mutex(mutex&amp;)=delete; void lock() { pthread_t locked_by=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">//  C++20     , .. compare_exchange_strong          while(!mLock.compare_exchange_strong(locked_by,pthread_self())) { locked_by=0; //      } } void unlock() { pthread_t current=pthread_self(); if(!mLock.compare_exchange_strong(current,0)) { throw std::system_error(EACCES, std::system_category(), "An attempt to unlock the mutex owned by other thread"); } } const bool try_lock() { pthread_t unused=0; return mLock.compare_exchange_strong(unused,pthread_self()); } }; }</span></span></code> </pre> <br><p>  рдПрд╕рдЯреАрдбреА рдХреЗ рд╡рд┐рдкрд░реАрдд :: рдореНрдпреВрдЯреЗрдХреНрд╕ :: рдЕрдирд▓реЙрдХ (), рдкрд░реАрдХреНрд╖рдг рдХрд╛ рд╡реНрдпрд╡рд╣рд╛рд░ :: рдореНрдпреВрдЯреЗрдХреНрд╕: рдЕрдирд▓реЙрдХ () рдЬрдм рджреВрд╕рд░реЗ рдзрд╛рдЧреЗ рд╕реЗ рдЕрдирд▓реЙрдХ рдХрд░рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдпрд╣ рдирд┐рд░реНрдзрд╛рд░рдХ рд╣реЛрддрд╛ рд╣реИред  рдПрдХ рдЕрдкрд╡рд╛рдж рдлреЗрдВрдХ рджрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред  рдпрд╣ рдЕрдЪреНрдЫрд╛ рд╣реИ, рд╣рд╛рд▓рд╛рдВрдХрд┐ рдорд╛рдирдХ рд╡реНрдпрд╡рд╣рд╛рд░ рдХреЗ рдЕрдиреБрд░реВрдк рдирд╣реАрдВ рд╣реИред  рдФрд░ рдЗрд╕ рд╡рд░реНрдЧ рдореЗрдВ рдмреБрд░рд╛ рдХреНрдпрд╛ рд╣реИ?  рдмреБрд░реА рдЦрдмрд░ рдпрд╣ рд╣реИ рдХрд┐ рдкрд░реАрдХреНрд╖рдг :: рдореНрдпреВрдЯреЗрдХреНрд╕: рд▓реЙрдХ () рд╡рд┐рдзрд┐ рдмреЗрд╢рд░реНрдореА рд╕реЗ рд╕реАрдкреАрдпреВ рд╕рдВрд╕рд╛рдзрдиреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рд╕рдордп рдХреЛрдЯрд╛ рдХреЛ рдереНрд░реЗрдб рдХреЗ рд▓рд┐рдП рдЖрд╡рдВрдЯрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛, рдореНрдпреВрдЯреЗрдХреНрд╕ рдкрд░ рд▓реЗрдиреЗ рдХреЗ рдкреНрд░рдпрд╛рд╕ рдореЗрдВ рдХрд┐ рдПрдХ рдФрд░ рдзрд╛рдЧрд╛ рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдорд╛рд▓рд┐рдХ рд╣реИред  рдпрд╛рдиреА  рдкрд░реАрдХреНрд╖рдг рдореЗрдВ рдПрдХ рд▓реВрдк :: рдореНрдпреВрдЯреЗрдХреНрд╕: рд▓реЙрдХ () рд╕реАрдкреАрдпреВ рд╕рдВрд╕рд╛рдзрдиреЛрдВ рдХреА рдмрд░реНрдмрд╛рджреА рд╣реЛрдЧреАред  рдЗрд╕ рд╕реНрдерд┐рддрд┐ рдкрд░ рдХрд╛рдмреВ рдкрд╛рдиреЗ рдХреЗ рд▓рд┐рдП рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рдХреНрдпрд╛ рд╡рд┐рдХрд▓реНрдк рд╣реИрдВ? </p><br><p>  рд╣рдо рд╢реЗрдбреНрдпреВрд▓_рдпрд┐рд▓реНрдб () рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ (рдЬреИрд╕рд╛ рдХрд┐ рдКрдкрд░ рджрд┐рдП рдЧрдП рд▓реЗрдЦреЛрдВ рдореЗрдВ рд╕реЗ рдПрдХ рдореЗрдВ рд╕реБрдЭрд╛рд╡ рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ)ред  рдХреНрдпрд╛ рдпрд╣ рдЗрддрдирд╛ рдЖрд╕рд╛рди рд╣реИ?  рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ, рд╕рдордп-рд╕рд╛рд░рдгреА () рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдпрд╣ рдЖрд╡рд╢реНрдпрдХ рд╣реИ рдХрд┐ рдирд┐рд╖реНрдкрд╛рджрди рдХреЗ рд╕реВрддреНрд░ рдХрд╛рд░реНрдп рдЕрдиреБрд╕реВрдЪреА рдореЗрдВ рдЙрдирдХреА рдкреНрд░рд╛рдердорд┐рдХрддрд╛ рдХреЗ рд▓рд┐рдП SCHED_RR, SCHED_FIFO рдиреАрддрд┐рдпреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВред  рдЕрдиреНрдпрдерд╛, рдХреЙрд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╢реЗрдбреНрдпреВрд▓_рдбрд┐рд▓реНрдб () рд╕реАрдкреАрдпреВ рд╕рдВрд╕рд╛рдзрдиреЛрдВ рдХреА рдмрд░реНрдмрд╛рджреА рд╣реЛрдЧреАред  рджреВрд╕рд░реЗ, рд╢реЗрдбреНрдпреВрд▓_рдЗрд▓реНрдб () рдХреЗ рд▓рд┐рдП рдПрдХ рдмрд╣реБрдд рд╣реА рд▓рдЧрд╛рддрд╛рд░ рдХреЙрд▓ рдЕрднреА рднреА рд╕реАрдкреАрдпреВ рдХреА рдЦрдкрдд рдореЗрдВ рд╡реГрджреНрдзрд┐ рдХрд░реЗрдЧрд╛ред  рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдЖрдкрдХреЗ рдЖрд╡реЗрджрди рдореЗрдВ рд╡рд╛рд╕реНрддрд╡рд┐рдХ рд╕рдордп рдХреА рдиреАрддрд┐рдпреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ, рдФрд░ рдмрд╢рд░реНрддреЗ рдХрд┐ рд╕рд┐рд╕реНрдЯрдо рдореЗрдВ рдХреЛрдИ рдЕрдиреНрдп рд╡рд╛рд╕реНрддрд╡рд┐рдХ рд╕рдордп рдЕрдиреБрдкреНрд░рдпреЛрдЧ рдирд╣реАрдВ рд╣реИрдВ, рдХреЗрд╡рд▓ рдЖрдкрдХреЗ рдереНрд░реЗрдбреНрд╕ рдХреЗ рд▓рд┐рдП рдЪрдпрдирд┐рдд рдиреАрддрд┐ рдХреЗ рд╕рд╛рде рдЕрдиреБрд╕реВрдЪрдХ рдХрддрд╛рд░ рдХреЛ рд╕реАрдорд┐рдд рдХрд░реЗрдЧрд╛ред  рдРрд╕рд╛ рд▓рдЧреЗрдЧрд╛ рдХрд┐ рдпрд╣ рдЕрдЪреНрдЫрд╛ рд╣реИ!  рдирд╣реАрдВ, рдЕрдЪреНрдЫрд╛ рдирд╣реАрдВред  рдкреВрд░рд╛ рд╕рд┐рд╕реНрдЯрдо рдХрдо рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рд╣реЛ рдЬрд╛рдПрдЧрд╛, рдХреНрдпреЛрдВрдХрд┐  рдкреНрд░рд╛рдердорд┐рдХрддрд╛ рдХрд╛рд░реНрдп рдХреЗ рд╕рд╛рде рд╡реНрдпрд╕реНрддред  рдкреЗрди рдореЗрдВ рд╕реАрдПрдлрдХреНрдпреВ рд╣реЛрдЧрд╛ред  рд▓реЗрдХрд┐рди рдЖрд╡реЗрджрди рдореЗрдВ рдЕрдиреНрдп рдзрд╛рдЧреЗ рд╣реИрдВ, рдФрд░ рдмрд╣реБрдд рдмрд╛рд░ рдПрдХ рд╕реНрдерд┐рддрд┐ рдЙрддреНрдкрдиреНрди рд╣реЛрддреА рд╣реИ рдЬрдм рдореНрдпреВрдЯреЗрдХреНрд╕ рдкрд░ рдХрдмреНрдЬрд╛ рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рдзрд╛рдЧреЗ рдХреЛ рдХрддрд╛рд░ рдХреЗ рдЕрдВрдд рдореЗрдВ рдбрд╛рд▓ рджрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ (рдХреЛрдЯрд╛ рд╕рдорд╛рдкреНрдд рд╣реЛ рдЧрдпрд╛ рд╣реИ), рдФрд░ рдЬреЛ рдзрд╛рдЧрд╛ рдореНрдпреВрдЯреЗрдХреНрд╕ рдХреЗ рдЗрдВрддрдЬрд╛рд░ рдореЗрдВ рд╣реИ рдЙрд╕рдХреЗ рдареАрдХ рд╕рд╛рдордиреЗ рдЬрд╛рд░реА рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред  рдореЗрд░реЗ рдкреНрд░рдпреЛрдЧреЛрдВ (рдХреЗрд╕ 2) рдореЗрдВ, рдЗрд╕ рдкрджреНрдзрддрд┐ рдиреЗ std :: mutex рдХреА рддреБрд▓рдирд╛ рдореЗрдВ рд╕рдорд╛рди рдкрд░рд┐рдгрд╛рдореЛрдВ (3.8% рдЦрд░рд╛рдм) рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЬрд╛рдирдХрд╛рд░реА рджреА, рд▓реЗрдХрд┐рди рдпрд╣ рдкреНрд░рдгрд╛рд▓реА рдХрдо рдЙрддреНрддрд░рджрд╛рдпреА рд╣реИ рдФрд░ CPU рдЦрдкрдд рдореЗрдВ 5% -7% рдХреА рд╡реГрджреНрдзрд┐ рд╣реБрдИ рд╣реИред </p><br><p>  рдЖрдк рдкрд░реАрдХреНрд╖рдг рдмрджрд▓рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ :: рдореНрдпреВрдЯреЗрдХреНрд╕ :: рд▓реЙрдХ () рдЗрд╕ рддрд░рд╣ (рднреА рдЦрд░рд╛рдм): </p><br><pre> <code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">lock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">pthread_t</span></span> locked_by=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(!mLock.compare_exchange_strong(locked_by,pthread_self())) { <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">thread_local</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">timespec</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pause</span></span></span><span class="hljs-class">{</span></span><span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>}; <span class="hljs-comment"><span class="hljs-comment">// -      nanosleep(&amp;pause,nullptr); locked_by=0; } }</span></span></code> </pre> <br><p>  рдпрд╣рд╛рдВ рдЖрдк рдиреИрдиреЛрд╕реЗрдХрдВрдб рдореЗрдВ рдиреАрдВрдж рдХреА рдЕрд╡рдзрд┐ рдХреЗ рд╕рд╛рде рдкреНрд░рдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, 4ns рджреЗрд░реА рдореЗрд░реЗ рд╕реАрдкреАрдпреВ рдХреЗ рд▓рд┐рдП рдЗрд╖реНрдЯрддрдо рдереЗ рдФрд░ рдПрд╕рдЯреА рдХреЗ рд▓рд┐рдП рдкреНрд░рджрд░реНрд╢рди рдбреНрд░реЙрдк рдХреЗ рд╕рд╛рдкреЗрдХреНрд╖ рдкреНрд░рджрд░реНрд╢рди :: mutex рдПрдХ рд╣реА рдорд╛рдорд▓реЗ рдореЗрдВ 2 1.2% рдерд╛ред  рддрдереНрдп рдпрд╣ рдирд╣реАрдВ рд╣реИ рдХрд┐ рдиреИрдиреЛрд╕реЗрд▓реЗрдк 4ns рд╕реЛрдП рдереЗред  рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ, рдпрд╛ рдЕрдзрд┐рдХ (рд╕рд╛рдорд╛рдиреНрдп рдорд╛рдорд▓реЗ рдореЗрдВ) рдпрд╛ рдЙрд╕рд╕реЗ рдХрдо (рдпрджрд┐ рдмрд╛рдзрд┐рдд рд╣реЛ)ред  рд╕реАрдкреАрдпреВ рдХреА рдЦрдкрдд рдореЗрдВ рдЧрд┐рд░рд╛рд╡рдЯ (!) 12% -20% рдереАред  рдпрд╛рдиреА  рдпрд╣ рдПрдХ рд╕реНрд╡рд╕реНрде рд╕рдкрдирд╛ рдерд╛ред </p><br><p>  рдУрдкрдирдПрд╕рдПрд╕рдПрд▓ рдФрд░ рд▓рд┐рдмреНрд░реЗрдПрд╕рдПрд╕рдПрд▓ рдХреЗ рджреЛ рдХрд╛рд░реНрдп рд╣реИрдВ рдЬреЛ рдЗрди рдкреБрд╕реНрддрдХрд╛рд▓рдпреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдмрд╣реБ-рдереНрд░реЗрдбреЗрдб рд╡рд╛рддрд╛рд╡рд░рдг рдореЗрдВ рдХрд░рддреЗ рд╕рдордп рдмреНрд▓реЙрдХ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреЙрд▓рдмреИрдХ рдХреА рд╕реНрдерд╛рдкрдирд╛ рдХрд░рддреЗ рд╣реИрдВред  рдпрд╣ рдЗрд╕ рддрд░рд╣ рджрд┐рдЦрддрд╛ рд╣реИ: </p><br><pre> <code class="hljs pgsql">//  callback <span class="hljs-type"><span class="hljs-type">void</span></span> openssl_crypt_locking_function_callback(<span class="hljs-type"><span class="hljs-type">int</span></span> mode, <span class="hljs-type"><span class="hljs-type">int</span></span> n, const <span class="hljs-type"><span class="hljs-type">char</span></span>* file, const <span class="hljs-type"><span class="hljs-type">int</span></span> <span class="hljs-type"><span class="hljs-type">line</span></span>) { static std::vector&lt;std::mutex&gt; locks(CRYPTO_num_locks()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(n&gt;=static_cast&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt;(locks.size())) { <span class="hljs-keyword"><span class="hljs-keyword">abort</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(mode &amp; CRYPTO_LOCK) locks[n].<span class="hljs-keyword"><span class="hljs-keyword">lock</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> locks[n].unlock(); } //  callback-a CRYPTO_set_locking_callback(openssl_crypt_locking_function_callback); //  id CRYPTO_set_id_callback(pthread_self);</code> </pre> <br><p>  рдФрд░ рдЕрдм рд╕рдмрд╕реЗ рдмреБрд░реА рдмрд╛рдд рдпрд╣ рд╣реИ рдХрд┐ рдЙрдкрд░реЛрдХреНрдд рдкрд░реАрдХреНрд╖рдг :: рд▓рд┐рдмреНрд░реЗрдПрд╕рдПрд╕рдПрд▓ рдореЗрдВ рдореНрдпреВрдЯреЗрдХреНрд╕ рдореНрдпреВрдЯреЗрдХреНрд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рдПрд▓рдПрдкреАрдкреАрдПрд╕ рдХреЗ рдкреНрд░рджрд░реНрд╢рди рдХреЛ рд▓рдЧрднрдЧ 2 рдЧреБрдирд╛ рдХрдо рдХрд░ рджреЗрддрд╛ рд╣реИред  рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рд╡рд┐рдХрд▓реНрдк рдХреА рдкрд░рд╡рд╛рд╣ рдХрд┐рдП рдмрд┐рдирд╛ (рдЦрд╛рд▓реА рдкреНрд░рддреАрдХреНрд╖рд╛ рд▓реВрдк, рд╢реЗрдбреНрдпреВрд▓_рдпрд┐рд▓реНрдб (), рдиреИрдиреЛрд╕реНрд▓реАрдк ())ред </p><br><p>  рд╕рд╛рдорд╛рдиреНрдп рддреМрд░ рдкрд░, рд╣рдо рдХреЗрд╕ 2 рдФрд░ рдХреЗрд╕ 1 рдХреЛ рд╣рдЯрд╛рддреЗ рд╣реИрдВ, рдФрд░ std :: mutex рдХреЗ рд╕рд╛рде рдмрдиреЗ рд░рд╣рддреЗ рд╣реИрдВред </p><br><p>  рдЖрдЗрдП рдЕрд░реНрдзрд╡реГрддреНрдд рдкрд░ рдЬрд╛рдПрдВред  Std :: condition_variable рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╕реЗрдорд╛рдлреЛрд░ рдХреЛ рдХреИрд╕реЗ рд▓рд╛рдЧреВ рдХрд┐рдпрд╛ рдЬрд╛рдП, рдЗрд╕рдХреЗ рдХрдИ рдЙрджрд╛рд╣рд░рдг рд╣реИрдВред  рд╡реЗ рд╕рднреА std :: mutex рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВред  рдФрд░ рдЗрд╕ рддрд░рд╣ рдХреЗ рд╕реЗрдорд╛рдлреЛрд░ рд╕рд┐рдореБрд▓реЗрдЯрд░ рдкреЙрд╕рд┐рдХреНрд╕ рд╕рд┐рд╕реНрдЯрдо рд╕реЗрдорд╛рдлреЛрд░реНрд╕ рдХреА рддреБрд▓рдирд╛ рдореЗрдВ рдзреАрдореЗ (рдореЗрд░реЗ рдкрд░реАрдХреНрд╖рдгреЛрдВ рдХреЗ рдЕрдиреБрд╕рд╛рд░) рд╣реИрдВред </p><br><p>  рдЗрд╕рд▓рд┐рдП, рд╣рдо рдкрд░рдорд╛рдгреБрдУрдВ рдкрд░ рдПрдХ рдЕрд░реНрдзрд╡реГрддреНрдд рдмрдирд╛рдПрдВрдЧреЗ: </p><br><pre> <code class="hljs java"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">semaphore</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: std::atomic&lt;bool&gt; mayRun; mutable std::atomic&lt;int64_t&gt; counter; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-function"><span class="hljs-function">explicit </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">semaphore</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : mayRun</span></span>{<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>},counter{<span class="hljs-number"><span class="hljs-number">0</span></span>} { } semaphore(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> semaphore&amp;)=delete; semaphore(semaphore&amp;)=delete; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> bool </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">post</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>{ ++counter; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mayRun.load(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> bool </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">try_wait</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(mayRun.load()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(counter.fetch_sub(<span class="hljs-number"><span class="hljs-number">1</span></span>)&gt;<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { ++counter; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> std::system_error(ENOENT,std::system_category(),<span class="hljs-string"><span class="hljs-string">"Semaphore is destroyed"</span></span>); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">wait</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(!try_wait()) { <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> thread_local <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> struct timespec pause{<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>}; nanosleep(&amp;pause,nullptr); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">destroy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ mayRun.store(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> int64_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">decrimentOn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> size_t value)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(mayRun.load()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> counter.fetch_sub(value); }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> std::system_error(ENOENT,std::system_category(),<span class="hljs-string"><span class="hljs-string">"Semaphore is destroyed"</span></span>); } } ~semaphore() { destroy(); } };</code> </pre> <br><p>  рдУрд╣, рдпрд╣ рд╕реЗрдорд╛рдлреЛрд░ рд╕рд┐рд╕реНрдЯрдо рд╕реЗрдорд╛рдлреЛрд░ рд╕реЗ рдХрдИ рдЧреБрдирд╛ рддреЗрдЬ рд╣реИред  рдПрдХ рдкреНрд░рджрд╛рддрд╛ рдФрд░ 20 рдХрдВрд╕реНрдпреВрдорд░реНрд╕ рдХреЗ рд╕рд╛рде рдЗрд╕ рд╕реЗрдорд╛рдлреЛрд░ рдХреЗ рдПрдХ рдЕрд▓рдЧ рдкрд░реАрдХреНрд╖рдг рдХрд╛ рдкрд░рд┐рдгрд╛рдо: </p><br><pre> <code class="hljs bash">OS semaphores <span class="hljs-built_in"><span class="hljs-built_in">test</span></span>. Started 20 threads waiting on a semaphore Thread(OS): wakes: 500321 Thread(OS): wakes: 500473 Thread(OS): wakes: 501504 Thread(OS): wakes: 502337 Thread(OS): wakes: 498324 Thread(OS): wakes: 502755 Thread(OS): wakes: 500212 Thread(OS): wakes: 498579 Thread(OS): wakes: 499504 Thread(OS): wakes: 500228 Thread(OS): wakes: 499696 Thread(OS): wakes: 501978 Thread(OS): wakes: 498617 Thread(OS): wakes: 502238 Thread(OS): wakes: 497797 Thread(OS): wakes: 498089 Thread(OS): wakes: 499292 Thread(OS): wakes: 498011 Thread(OS): wakes: 498749 Thread(OS): wakes: 501296 OS semaphores <span class="hljs-built_in"><span class="hljs-built_in">test</span></span>. 10000000 of posts <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> 20 waiting threads have taken 9924 milliseconds OS semaphores <span class="hljs-built_in"><span class="hljs-built_in">test</span></span>. Post latency: 0.9924ns ======================================= AtomicEmu semaphores <span class="hljs-built_in"><span class="hljs-built_in">test</span></span>. Started 20 threads waiting on a semaphore Thread(EmuAtomic) wakes: 492748 Thread(EmuAtomic) wakes: 546860 Thread(EmuAtomic) wakes: 479375 Thread(EmuAtomic) wakes: 534676 Thread(EmuAtomic) wakes: 501014 Thread(EmuAtomic) wakes: 528220 Thread(EmuAtomic) wakes: 496783 Thread(EmuAtomic) wakes: 467563 Thread(EmuAtomic) wakes: 608086 Thread(EmuAtomic) wakes: 489825 Thread(EmuAtomic) wakes: 479799 Thread(EmuAtomic) wakes: 539634 Thread(EmuAtomic) wakes: 479559 Thread(EmuAtomic) wakes: 495377 Thread(EmuAtomic) wakes: 454759 Thread(EmuAtomic) wakes: 482375 Thread(EmuAtomic) wakes: 512442 Thread(EmuAtomic) wakes: 453303 Thread(EmuAtomic) wakes: 480227 Thread(EmuAtomic) wakes: 477375 AtomicEmu semaphores <span class="hljs-built_in"><span class="hljs-built_in">test</span></span>. 10000000 of posts <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> 20 waiting threads have taken 341 milliseconds AtomicEmu semaphores <span class="hljs-built_in"><span class="hljs-built_in">test</span></span>. Post latency: 0.0341ns</code> </pre><br><p>  рддреЗ рдЗрд╕ рд╕реЗрдорд╛рдлреЛрд░ рдХреЛ рд▓рдЧрднрдЧ рдирд┐: рд╢реБрд▓реНрдХ рдкреЛрд╕реНрдЯ () рдХреЗ рд╕рд╛рде, рдЬреЛ рд╕рд┐рд╕реНрдЯрдо рдПрдХ рдХреА рддреБрд▓рдирд╛ рдореЗрдВ 29 рдЧреБрдирд╛ рддреЗрдЬ рд╣реИ, рдЗрд╕рдХреЗ рд▓рд┐рдП рдЗрдВрддрдЬрд╛рд░ рдХрд░ рд░рд╣реЗ рдереНрд░реЗрдбреНрд╕ рдХреЛ рдЬрд╛рдЧрдиреЗ рдореЗрдВ рднреА рдмрд╣реБрдд рддреЗрдЬ рд╣реИ: рд╕рд┐рд╕реНрдЯрдо рд╕реЗ 1007 рд╡реЗрдХ-рдЕрдк рдХреЗ рдореБрдХрд╛рдмрд▓реЗ 29325 рдкреНрд░рддрд┐ рдорд┐рд▓рд┐рд╕реЗрдХреЗрдВрдб рдкреНрд░рддрд┐ рдорд┐рдирдЯред  рдЗрд╕рдХрд╛ рд╡рд┐рдзреНрд╡рдВрд╕рдХ рд╡реНрдпрд╡рд╣рд╛рд░ рдПрдХ рдирд╖реНрдЯ рдХрд┐рдП рдЧрдП рд╕реЗрдорд╛рдлреЛрд░ рдпрд╛ рдПрдХ рд╡рд┐рдирд╛рд╢рдХрд╛рд░реА рд╕реЗрдорд╛рдлреЛрд░ рдХреЗ рд╕рд╛рде рд╣реЛрддрд╛ рд╣реИред  рдФрд░ рд╕реНрд╡рд╛рднрд╛рд╡рд┐рдХ рд░реВрдк рд╕реЗ, рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдирд╖реНрдЯ рд╣реЛ рдЪреБрдХреЗ рдПрдХ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░рддреЗ рд╕рдордп рд╕реЗрдЧрдлреЙрд▓реНрдЯред </p><br><p>  (,) рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ, рдПрдХ рдорд┐рд▓реАрд╕реЗрдХрдВрдб рдореЗрдВ рдЗрддрдиреА рдмрд╛рд░ рдХрд┐рд╕реА рдзрд╛рд░рд╛ рдХреЛ рд╡рд┐рд▓рдВрдмрд┐рдд рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдЕрдиреБрд╕реВрдЪрдХ рджреНрд╡рд╛рд░рд╛ рдЬрд╛рдЧреГрдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред  рдХреНрдпреЛрдВрдХрд┐  рдкреЛрд╕реНрдЯ () рдЕрд╡рд░реБрджреНрдз рдирд╣реАрдВ рд╣реИ, рдЗрд╕ рд╕рд┐рдВрдереЗрдЯрд┐рдХ рдкрд░реАрдХреНрд╖рдг рдореЗрдВ, рдкреНрд░рддреАрдХреНрд╖рд╛ () рдмрд╣реБрдд рдмрд╛рд░ рдЦреБрдж рдХреЛ рдРрд╕реА рд╕реНрдерд┐рддрд┐ рдореЗрдВ рдкрд╛рддрд╛ рд╣реИ рдЬрд╣рд╛рдВ рдЖрдкрдХреЛ рд╕реЛрдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реЛрддреА рд╣реИред  рдПрдХ рд╣реА рд╕рдордп рдореЗрдВ, рд╕рдорд╛рдирд╛рдВрддрд░ рдореЗрдВ рдХрдо рд╕реЗ рдХрдо 7 рдзрд╛рдЧреЗ рд╕реЗрдорд╛рдлреЛрд░ рдХреЗ рдореВрд▓реНрдп рдХреЛ рдкрдврд╝рддреЗ рд╣реИрдВред </p><br><p>  рд▓реЗрдХрд┐рди LAppS рдореЗрдВ 3 рдХреЗ рдорд╛рдорд▓реЗ рдореЗрдВ рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рд╕реЗ рдиреАрдВрдж рдХреЗ рд╕рдордп рдХреА рдкрд░рд╡рд╛рд╣ рдХрд┐рдП рдмрд┐рдирд╛ рдкреНрд░рджрд░реНрд╢рди рд╣рд╛рдирд┐ рд╣реЛрддреА рд╣реИред  рд╡рд╣ рдЕрдХреНрд╕рд░ рдЬрд╛рдБрдЪ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдарддрд╛ рд╣реИ, рдФрд░ LAppS рдореЗрдВ рд╣реЛрдиреЗ рд╡рд╛рд▓реА рдШрдЯрдирд╛рдПрдБ рдмрд╣реБрдд рдзреАрдореА (рдиреЗрдЯрд╡рд░реНрдХ рд╡рд┐рд▓рдВрдмрддрд╛, рд╡рд┐рд▓рдВрдмрддрд╛ рдЙрддреНрдкрдиреНрди рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рдЧреНрд░рд╛рд╣рдХ рдкрдХреНрд╖ рдХреА рд╡рд┐рд▓рдВрдмрддрд╛, рдЖрджрд┐) рддрдХ рдкрд╣реБрдБрдЪрддреА рд╣реИрдВред  рдФрд░ рдХрдо рдмрд╛рд░ рдЪреЗрдХ рдХрд░рдиреЗ рдХрд╛ рдорддрд▓рдм рд╣реИ рдкреНрд░рджрд░реНрд╢рди рдХрд╛ рдХрдо рд╣реЛрдирд╛ред </p><br><p>  рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдРрд╕реЗ рдорд╛рдорд▓реЛрдВ рдореЗрдВ рдФрд░ рдЗрд╕реА рддрд░рд╣ рд╕реЗ рдиреАрдВрдж рдХрд╛ рдЙрдкрдпреЛрдЧ рдкреВрд░реА рддрд░рд╣ рд╕реЗ рд╣рд╛рдирд┐рдХрд╛рд░рдХ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐  рдХрд┐рд╕реА рдЕрдиреНрдп рд╣рд╛рд░реНрдбрд╡реЗрдпрд░ рдкрд░, рдкрд░рд┐рдгрд╛рдо рдкреВрд░реА рддрд░рд╣ рд╕реЗ рдЕрд▓рдЧ рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВ (рдЬреИрд╕рд╛ рдХрд┐ рдЕрд╕реЗрдВрдмрд▓рд░ рдЗрдВрд╕реНрдЯреНрд░рдХреНрд╢рди рдкреЙрдЬрд╝ рдХреЗ рдорд╛рдорд▓реЗ рдореЗрдВ), рдФрд░ рдкреНрд░рддреНрдпреЗрдХ рд╕реАрдкреАрдпреВ рдореЙрдбрд▓ рдХреЗ рд▓рд┐рдП, рдЖрдкрдХреЛ рджреЗрд░реА рд╕рдордп рдХрд╛ рдЪрдпрди рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред </p><br><p>  рдПрдХ рд╕рд┐рд╕реНрдЯрдо рдореНрдпреВрдЯреЗрдХреНрд╕ рдФрд░ рд╕реЗрдорд╛рдлреЛрд░ рдХрд╛ рд▓рд╛рдн рдпрд╣ рд╣реИ рдХрд┐ рдирд┐рд╖реНрдкрд╛рджрди рдереНрд░реЗрдб рддрдм рддрдХ рдирд╣реАрдВ рдЙрдарддрд╛ рд╣реИ рдЬрдм рддрдХ рдХрд┐ рдХреЛрдИ рдШрдЯрдирд╛ (рдореНрдпреВрдЯреЗрдХреНрд╕ рдХреЛ рдЕрдирд▓реЙрдХ рдХрд░рдиреЗ рдпрд╛ рд╕реЗрдорд╛рдлреЛрд░ рдХреЛ рдмрдврд╝рд╛рдиреЗ) рдирд╣реАрдВ рд╣реЛрддреА рд╣реИред  рдЕрддрд┐рд░рд┐рдХреНрдд рд╕реАрдкреАрдпреВ рдЪрдХреНрд░ рдмрд░реНрдмрд╛рдж рдирд╣реАрдВ рд╣реЛрддреЗ рд╣реИрдВ - рд▓рд╛рднред </p><br><p>  рд╕рд╛рдорд╛рдиреНрдп рддреМрд░ рдкрд░, рдЗрд╕ рдмреБрд░рд╛рдИ рд╕реЗ рд╕рдм рдХреБрдЫ, рдореЗрд░реЗ рд╕рд┐рд╕реНрдЯрдо рдкрд░ iptables рдХреЛ рдЕрдХреНрд╖рдо рдХрд░рдиреЗ рд╕реЗ 12% (TLS рдХреЗ рд╕рд╛рде) рд╕реЗ 30% (TLS рдХреЗ рдмрд┐рдирд╛) рдПрдХ рдкреНрд░рджрд░реНрд╢рди рд▓рд╛рдн рд╣реЛрддрд╛ рд╣реИ ... </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/hi428087/">https://habr.com/ru/post/hi428087/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../hi428075/index.html">рд╕рднреА рд╕рдорд╛рди, рдЖрдк рдРрд╕рд╛ рдирд╣реАрдВ рдХрд░ рд╕рдХрддреЗ! - рд▓рдВрдмреА рдЕрд╡рдзрд┐ рдХреЗ рдбрд┐рдЬрд╛рдЗрди рдХреЗ рд▓рд┐рдП рдЗрдВрдЯрд░рдлреЗрд╕ рдФрд░ рдирд┐рд░реНрднрд░рддрд╛ рдЗрдВрдЬреЗрдХреНрд╢рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛</a></li>
<li><a href="../hi428077/index.html">React.js: рдПрдХ рд╢реБрд░реБрдЖрддреА рдЧрд╛рдЗрдб</a></li>
<li><a href="../hi428079/index.html">рдЕрдиреБрдкреНрд░рдпреЛрдЧ рд╡рд┐рдХрд╛рд╕ рдХреЗ рд▓рд┐рдП рдареЛрд╕ рд╕рд┐рджреНрдзрд╛рдВрддреЛрдВ рдХреЛ рд▓рд╛рдЧреВ рдХрд░рдирд╛</a></li>
<li><a href="../hi428083/index.html">рд╡реЗрдм рд╡рд┐рд╢реНрд▓реЗрд╖рд┐рдХреА рдореИрдЯреНрд░рд┐рдХреНрд╕ рдХреЛ рдкреНрд░рднрд╛рд╡рд┐рдд рдХрд░рддреА рд╣реИ - рдЕрд╡рд┐рдирд╛рд╢ рдХреЛрд╢рд┐рдХ рдХреА рд░рдгрдиреАрддрд┐рдХ рдкреНрд░рдгрд╛рд▓реА</a></li>
<li><a href="../hi428085/index.html">рдлреНрд░рдВрдЯреЗрдВрдб рдкреАрдЫреЗ рд╣рдЯрддрд╛ рд╣реИ: рд╢реАрд░реНрд╖ 10 (?) рдкрд╡рд┐рддреНрд░рдЬреЗрдПрд╕ 2018 рдкреИрдЯрд░ рдХреА рд░рд┐рдкреЛрд░реНрдЯ</a></li>
<li><a href="../hi428089/index.html">рдЕрдХреНрдЯреВрдмрд░ рдХреЗ рд▓рд┐рдП "рдкрд░реАрдХреНрд╖рдХ рдХреИрд▓реЗрдВрдбрд░"ред рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛: рдпрд╣ рдХреИрд╕реЗ рд╣реЛрддрд╛ рд╣реИ</a></li>
<li><a href="../hi428091/index.html">рдПрдХ рдЗрдВрдЯрд░реНрди рдЫрд╛рддреНрд░ рдиреЗ рджреБрдирд┐рдпрд╛ рдХрд╛ рд╕рдмрд╕реЗ рд▓реЛрдХрдкреНрд░рд┐рдп рд╡реАрдбрд┐рдпреЛ рдЧреЗрдо рдпрд╛ рд╡рд┐рдВрдбреЛрдЬ рдЧреЗрдо рдЗрддрд┐рд╣рд╛рд╕ рдХреИрд╕реЗ рдмрдирд╛рдпрд╛</a></li>
<li><a href="../hi428095/index.html">рд╡реЗрдм рд╕реНрдЯреВрдбрд┐рдпреЛ рдФрд░ рдбрд┐рдЬрд┐рдЯрд▓ рдПрдЬреЗрдВрд╕рд┐рдпреЛрдВ рдХреЗ рд▓рд┐рдП рдмрд╛рдЬрд╛рд░ рдЕрдиреБрд╕рдВрдзрд╛рди</a></li>
<li><a href="../hi428097/index.html">рдбреАрдПрдЪрд╕реАрдкреА рджреНрд╡рд╛рд░рд╛ рд╕реМрдВрдкреЗ рдЧрдП рдЧреЗрдЯрд╡реЗ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдорд┐рдХреНрд░реЛрдЯрд┐рдХ рдореЗрдВ рдкреБрдирд░рд╛рд╡рд░реНрддреА рдорд╛рд░реНрдЧ</a></li>
<li><a href="../hi428099/index.html">рд╕рд╛рдзрд╛рд░рдг рдХрдкрдбрд╝реЗ рдФрд░ рдЖрдиреЗ рд╡рд╛рд▓реЗ 5 рдЬреА рдпреБрдЧ рдореЗрдВ рдХреНрдпрд╛ рд╣реИ?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>