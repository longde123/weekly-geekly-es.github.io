<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>â™Ÿï¸ ğŸ‘©ğŸ½â€ğŸ¤â€ğŸ‘¨ğŸ¾ ğŸ‘ğŸ¿ æˆ‘ä»¬ä½¿ç”¨RabbitMQå’ŒTypeScriptå¤„ç†æ¥è‡ªåœ¨çº¿å•†åº—çš„è®¢å• ğŸ’‡ ğŸ‘¨â€ğŸ’» ğŸ»</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="å¤§å®¶å¥½ï¼ äº’è”ç½‘å•†åŠ¡çš„æ™®åŠä¸ä¸è´¸æ˜“æœ‰å…³çš„æ‰€æœ‰æ´»åŠ¨çš„ä¿¡æ¯åŒ–æ‰€å çš„ä»½é¢éƒ½åœ¨ä¸æ–­å¢é•¿ã€‚ ä¸æ­¤åŒæ—¶ï¼Œä¿¡æ¯å¤„ç†çš„å¤æ‚æ€§ä¹Ÿåœ¨å¢é•¿ã€‚ åœ¨çº¿å•†åº—çš„å®¢æˆ·åšå‡ºçš„æ¯ç¬”è®¢å•éƒ½ä¼šç”Ÿæˆå¤§é‡ä¸å„ç§æœåŠ¡çš„é›†æˆã€‚ æ­¤ç±»æœåŠ¡å¯èƒ½åŒ…æ‹¬ä»˜æ¬¾å¤„ç†ï¼Œäº¤ä»˜ï¼Œä¼šè®¡å’Œä¼šå‘˜æœåŠ¡ã€‚ æ¯ä¸ªè®¢å•å¿…é¡»ä»˜æ¬¾ï¼Œè®°å½•ï¼Œç»„è£…å’Œäº¤ä»˜ï¼Œè¿˜å¯ä»¥è¿›è¡Œè¿›ä¸€æ­¥åˆ†æã€‚ ç”±äºä¸æ˜¯åœ¨...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>æˆ‘ä»¬ä½¿ç”¨RabbitMQå’ŒTypeScriptå¤„ç†æ¥è‡ªåœ¨çº¿å•†åº—çš„è®¢å•</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/469991/"><p><img src="https://habrastorage.org/webt/wh/2y/cv/wh2ycv5atat_nuru35jo5pwfo08.jpeg"></p><br><p> å¤§å®¶å¥½ï¼ äº’è”ç½‘å•†åŠ¡çš„æ™®åŠä¸ä¸è´¸æ˜“æœ‰å…³çš„æ‰€æœ‰æ´»åŠ¨çš„ä¿¡æ¯åŒ–æ‰€å çš„ä»½é¢éƒ½åœ¨ä¸æ–­å¢é•¿ã€‚ ä¸æ­¤åŒæ—¶ï¼Œä¿¡æ¯å¤„ç†çš„å¤æ‚æ€§ä¹Ÿåœ¨å¢é•¿ã€‚ åœ¨çº¿å•†åº—çš„å®¢æˆ·åšå‡ºçš„æ¯ç¬”è®¢å•éƒ½ä¼šç”Ÿæˆå¤§é‡ä¸å„ç§æœåŠ¡çš„é›†æˆã€‚ æ­¤ç±»æœåŠ¡å¯èƒ½åŒ…æ‹¬ä»˜æ¬¾å¤„ç†ï¼Œäº¤ä»˜ï¼Œä¼šè®¡å’Œä¼šå‘˜æœåŠ¡ã€‚ æ¯ä¸ªè®¢å•å¿…é¡»ä»˜æ¬¾ï¼Œè®°å½•ï¼Œç»„è£…å’Œäº¤ä»˜ï¼Œè¿˜å¯ä»¥è¿›è¡Œè¿›ä¸€æ­¥åˆ†æã€‚ ç”±äºä¸æ˜¯åœ¨çº¿å•†åº—çš„ç”¨æˆ·åœ¨ä¸‹è®¢å•æ—¶å°±ä¸æƒ³é•¿æ—¶é—´ç—›è‹¦åœ°ç­‰å¾…æŸäº‹ï¼Œå› æ­¤è¿™ç§æƒ…å†µï¼ˆè€Œä¸æ˜¯ç®€å•çš„æƒ…å†µï¼‰å˜å¾—å¤æ‚ã€‚ åœ¨çº¿å•†åº—çš„å“åº”åº”è¯¥å¾ˆå¿«ï¼Œå› ä¸ºæ¯æ¯«ç§’çš„å»¶è¿Ÿéƒ½ä¼šå¢åŠ å¤±å»å®¢æˆ·å¹¶éšåè·åˆ©çš„æœºä¼šã€‚ åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘æƒ³è®¨è®ºRabbitMQæ¶ˆæ¯ä»£ç†ï¼Œä»¥åŠå¦‚ä½•ä½¿ç”¨å®ƒæ¥ä½¿ç”¨Node.jså’ŒTypeScriptç»„ç»‡è®¢å•å¤„ç†ã€‚ æ¬¢è¿æ¥åˆ°çŒ«ã€‚ </p><a name="habracut"></a><br><h2 id="neobhodimaya-teoriya"> å¿…è¦çš„ç†è®º </h2><br><p> æˆ‘æƒ³è®¸å¤šäººå¬è¯´è¿‡RabbitMQï¼Œå› ä¸ºåŸºäºAMQPåè®®çš„æ­¤æ¶ˆæ¯ä»£ç†çš„ç¬¬ä¸€ä¸ªå¼€æºç‰ˆæœ¬å·²äº2007å¹´å‘å¸ƒã€‚ éœ€è¦æ¶ˆæ¯ä»£ç†å°†ç³»ç»Ÿçš„ä¸åŒç»„ä»¶è¿æ¥ä¸ºä¸€ä¸ªæ•´ä½“ï¼Œå› ä¸ºéœ€è¦ä½¿ç”¨èƒ¶æ°´æ¥æ¢å¤ç ´æŸçš„èŠ±ç“¶ã€‚ ä½¿ç”¨æ¶ˆæ¯ä»£ç†ï¼Œå¯ä»¥å®ç°å¯¹ç³»ç»Ÿä¸­æ¥æ”¶åˆ°çš„äº‹ä»¶çš„å¼‚æ­¥å¤„ç†ã€‚ åœ¨çº¿å•†åº—éœ€è¦çš„åªæ˜¯å¼‚æ­¥è®¢å•å¤„ç†ã€‚ ä½†æ˜¯é¦–å…ˆï¼Œæ‚¨éœ€è¦äº†è§£RabbitMQçš„åŸºæœ¬ç»„ä»¶ã€‚ è¯¥ä»£ç†å…·æœ‰ä¸‰ä¸ªä¸»è¦ç»„ä»¶ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨å®ƒä»¬æ¥æ„å»ºå¤„ç†è¿‡ç¨‹ï¼š </p><br><ul><li>  <strong>ç•™è¨€å†…å®¹</strong> è¿™æ˜¯æ¶ˆæ¯ä»£ç†å’Œæˆ‘ä»¬çš„å¤„ç†æœåŠ¡ä¸­å¯ä»¥å¤„ç†çš„æœ€å°ä¿¡æ¯å•å…ƒã€‚  RabbitMQæœ¬èº«ä»¥äºŒè¿›åˆ¶å½¢å¼å­˜å‚¨æ¶ˆæ¯ï¼Œä½†æ˜¯å¯¹äºæˆ‘ä»¬çš„ç³»ç»Ÿå’Œæœ¬æ–‡è€Œè¨€ï¼Œè¿™å¹¶ä¸é‡è¦ã€‚ æˆ‘ä»¬å°†ä»¥JSONå½¢å¼æ¥æ”¶å’Œå¤„ç†æ¶ˆæ¯ã€‚ è¿˜å€¼å¾—ä¸€æçš„æ˜¯RabbitMQä¸­çš„æ¶ˆæ¯å…·æœ‰æ ‡å¤´ã€‚ å®ƒä»¬ç±»ä¼¼äºhttpè¯·æ±‚çš„æ ‡å¤´ã€‚ è¿™æ˜¯ä¸€ä¸ªå…³è”æ•°ç»„ï¼Œæ‚¨å¯ä»¥åœ¨å…¶ä¸­ç¼–å†™å¿…è¦çš„ä¿¡æ¯ã€‚ </li><li>  <strong>æ¶ˆæ¯é˜Ÿåˆ—</strong> ã€‚ è¿™æ˜¯RabbitMQå­˜å‚¨æ¶ˆæ¯çš„é˜Ÿåˆ—ã€‚ æ¶ˆæ¯é˜Ÿåˆ—å¯ä»¥ç”±ä¸€ä¸ªæˆ–å¤šä¸ªä½¿ç”¨è€…é¢„è®¢ã€‚ ä½¿ç”¨å¾ªç¯ç®—æ³•å°†å…”å­é˜Ÿåˆ—ä¸­çš„æ¯ä¸ªæ¶ˆæ¯åˆ†å‘ç»™æ¶ˆè´¹è€…ã€‚ </li><li>  <strong>äº¤æ¢</strong> é¡¾åæ€ä¹‰ï¼Œè¿™æ˜¯ä¸€ä¸ªäº¤æ¢ç‚¹ã€‚ é˜Ÿåˆ—æˆ–å…¶ä»–äº¤æ¢å™¨å¯ä»¥é™„åŠ åˆ°è¿™ä¸€ç‚¹ã€‚ äº¤æ¢ç‚¹ä¸å­˜å‚¨æ¶ˆæ¯ï¼›å®ƒçš„ä¸»è¦åŠŸèƒ½æ˜¯å°†æ¶ˆæ¯è·¯ç”±åˆ°ä¸€ä¸ªæˆ–å‡ ä¸ªé˜Ÿåˆ—æˆ–ç›¸åŒçš„äº¤æ¢ç‚¹ã€‚ æ¯ä¸ªé˜Ÿåˆ—æˆ–äº¤æ¢å™¨éƒ½ç”±è·¯ç”±é”®ç»‘å®šã€‚  RabbitMQä¸­æœ‰å‡ ç§ä¸åŒç±»å‹çš„äº¤æ¢å™¨ï¼Œå®ƒä»¬ä¼šå½±å“äº¤æ¢å¦‚ä½•æ­£ç¡®è·¯ç”±æ¥æ”¶åˆ°çš„æ¶ˆæ¯çš„æ–¹å¼ã€‚ </li></ul><br><p> ä¸ºäº†æè¿°ä¸åŒç±»å‹çš„äº¤æ¢å™¨æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œæœ‰å¿…è¦äº†è§£ä»€ä¹ˆæ˜¯è·¯ç”±é”®ã€‚ è·¯ç”±å¯†é’¥æ—¢åœ¨é˜Ÿåˆ—åˆ°äº¤æ¢å™¨çš„ç»‘å®šä¸­ï¼Œåˆåœ¨æ¶ˆæ¯æœ¬èº«ä¸­ã€‚  <strong>è·¯ç”±å¯†é’¥</strong>åªæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œåˆ†ä¸ºå¤šä¸ªå—ã€‚ æ¯ä¸ªå—ç”±ä¸€ä¸ªç‚¹åˆ†éš”ã€‚ ä¾‹å¦‚ï¼Œâ€œ notify.sendEmail.sendSmsâ€ã€‚ åŒæ—¶ï¼Œå¯ä»¥ä½¿ç”¨ç‰¹æ®Šå­—ç¬¦ï¼ƒå’Œ*ä¸ºæ¶ˆæ¯è·¯ç”±é”®è®¾ç½®æ¨¡å¼ã€‚  *-è¡¨ç¤ºåœ¨ä¸€ä¸ªç‚¹ä¹‹åä»»ä½•ä¸€ä¸ªç¨‹åºæ®µéƒ½å¯ä»¥æ‰§è¡Œï¼Œä½†æ˜¯åœ¨ï¼ƒä¹‹åå¯ä»¥æ‰§è¡Œä»»æ„æ•°é‡çš„ç¨‹åºæ®µã€‚ ä¾‹å¦‚ï¼Œâ€œ notify.sendSmsã€‚*â€æˆ–â€œ notifyã€‚ï¼ƒâ€ã€‚ ç°åœ¨ï¼Œæ‚¨å¯ä»¥ç»§ç»­è¿›è¡Œäº¤æ¢ç‚¹çš„ç±»å‹ã€‚ </p><br><p> äº¤æ¢å™¨æœ‰å››ç§ç±»å‹ï¼š </p><br><ul><li>  <strong>æ‰‡å‡º</strong> è¿™ç§äº¤æ¢çš„è·¯ç”±é€»è¾‘å¾ˆç®€å•ï¼›å®ƒå°†è¿›å…¥çš„æ¶ˆæ¯é‡å®šå‘åˆ°ä¸ä¹‹ç›¸è¿çš„æ‰€æœ‰é˜Ÿåˆ—æˆ–äº¤æ¢å™¨ã€‚ </li></ul><br><p><img src="https://habrastorage.org/webt/iw/f5/ib/iwf5ibz1b-6-qqhby_z_kqope9e.png"></p><br><ul><li>  <strong>ç›´è¾¾</strong> æ­¤äº¤æ¢æ ¹æ®æ¶ˆæ¯çš„è·¯ç”±å¯†é’¥æ˜¯å¦ä¸ç»‘å®šçš„è·¯ç”±å¯†é’¥åŒ¹é…æ¥é‡å®šå‘æ¶ˆæ¯ã€‚ </li></ul><br><p><img src="https://habrastorage.org/webt/vu/pm/ia/vupmiavbtemxaxoecqcuklmpvqe.png"></p><br><ul><li>  <strong>è¯é¢˜</strong> è¿™ç§ç±»å‹çš„äº¤æ¢ä»¥åŠç›´æ¥è·¯ç”±éƒ½å–å†³äºè·¯ç”±å¯†é’¥ã€‚ ä½†æ˜¯æ¨¡å¼å¯ä»¥å……å½“è·¯ç”±é”®ã€‚ </li></ul><br><p><img src="https://habrastorage.org/webt/yz/h4/ug/yzh4ug3abx7ywf9ex-bei3k20oe.png"></p><br><ul><li>  <strong>æ ‡å¤´</strong> ã€‚ ä¸å…¶ä»–äº¤æ¢ä¸åŒï¼Œæ­¤äº¤æ¢ä½¿ç”¨æ¶ˆæ¯å¤´è¿›è¡Œè·¯ç”±ã€‚ åŒæ—¶ï¼Œäº¤æ¢å™¨çš„é˜Ÿåˆ—ä¹Ÿä½¿ç”¨å…³è”æ•°ç»„è¿›è¡Œç»‘å®šã€‚ å¯ä»¥ä½¿ç”¨ç‰¹æ®Šçš„â€œ x-matchâ€é”®æ›´æ”¹äº¤æ¢å™¨è·¯ç”±æ¶ˆæ¯çš„é€»è¾‘ï¼Œè¯¥é”®åœ¨å…³è”ç»‘å®šæ•°ç»„ä¸­è®¾ç½®ã€‚ é”®å¯ä»¥è®¾ç½®ä¸ºå…¨éƒ¨æˆ–ä»»æ„ä¸¤ä¸ªå€¼ã€‚ å¦‚æœå€¼ä¸ºallï¼Œåˆ™æ¶ˆæ¯å¤´å¿…é¡»ä¸åŒ¹é…ç»‘å®šæ•°ç»„å®Œå…¨åŒ¹é…ï¼›å¦‚æœå€¼ä¸ºanyï¼Œåˆ™è¯¥å€¼å¿…é¡»è‡³å°‘ä¸ä¸€ä¸ªé”®åŒ¹é…ã€‚ </li></ul><br><p><img src="https://habrastorage.org/webt/gq/pd/gm/gqpdgmxxipjwviioorrzouqdj0o.png"></p><br><p> è¿™äº›æ˜¯RabbitMQçš„æ ¸å¿ƒç»„ä»¶ã€‚ æ‚¨å¯ä»¥åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">AMQPåè®®è§„èŒƒä¸­</a>é˜…è¯»æœ‰å…³è¿™äº›ç»„ä»¶çš„æ›´å¤šä¿¡æ¯ã€‚ æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†ä»¥TypeScriptä¸ºä¾‹ï¼Œè®¾è®¡å¹¶å®ç°ä¸€ä¸ªè®¢å•å¤„ç†ç³»ç»Ÿï¼ŒåŒæ—¶äº†è§£æ¯ä¸ªç»„ä»¶çš„è®¾ç½®ã€‚ </p><br><h2 id="proektirovanie"> è®¾è®¡æ–¹æ¡ˆ </h2><br><p> ä¸ºäº†ç®€åŒ–ç¤ºä¾‹ï¼Œæˆ‘ä»¬å‡è®¾è¦æˆåŠŸå¤„ç†åœ¨çº¿è®¢å•ï¼Œæˆ‘ä»¬å¿…é¡»å…·æœ‰ä»¥ä¸‹åŠŸèƒ½ï¼š </p><br><ul><li> ä¿å­˜æ”¶åˆ°çš„è®¢å• </li><li> é€šè¿‡è®¢å•å·ä»¥åŠè®¢å•çŠ¶æ€å‘å®¢æˆ·å‘é€çŸ­ä¿¡ </li><li> å¦‚æœå®¢æˆ·é€‰æ‹©äº†è¿™ç§é€è´§æ–¹å¼ï¼Œè¯·å‘å¿«é€’é€è´§æœåŠ¡å‘é€æœ‰å…³æˆ‘ä»¬ç½‘ä¸Šå•†åº—çš„æ–°è®¢å•çš„æ¶ˆæ¯ </li></ul><br><p> ä½†æ˜¯ï¼Œä»…ä»…å®ç°è¯¥åŠŸèƒ½è¿˜ä¸å¤Ÿï¼Œå› ä¸ºæˆ‘ä»¬çš„åœ¨çº¿å•†åº—è®¡åˆ’æ‰©å±•è¯¥åŠŸèƒ½ï¼Œå¹¶åœ¨å°†æ¥ä¸ºå®¢æˆ·æä¾›æ›´å¤šä¸åŒçš„æœºä¼šï¼ˆè€Œä¸”è¿™ç§æƒ…å†µç»å¸¸å‘ç”Ÿï¼‰ã€‚ ä¾‹å¦‚ï¼Œé€šè¿‡ç”µå­é‚®ä»¶é€šçŸ¥å®¢æˆ·æˆ–ä¸ºè®¢å•æä¾›å‡ ç§äº¤ä»˜æ–¹å¼çš„é€‰æ‹©ã€‚ å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦ä»¥ä¸€ç§ç®€å•çš„æ–¹å¼æ¥æ·»åŠ åŠŸèƒ½æ¥è®¾è®¡ç³»ç»Ÿã€‚ </p><br><p> è¿˜å€¼å¾—ä¸€æçš„æ˜¯ï¼Œæˆ‘å°†ä½¿ç”¨æ¨¡æ¿å¤„ç†å»¶è¿Ÿçš„æ¶ˆæ¯ï¼Œä»¥ä¾¿åœ¨å¤–éƒ¨æœåŠ¡ä¸å¯ç”¨æ—¶èƒ½å¤Ÿå¤šæ¬¡é‡å¤é€»è¾‘ã€‚ æ‚¨å¯ä»¥<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">åœ¨æ­¤å¤„</a>é˜…è¯»æœ‰å…³æ­¤æ¨¡æ¿çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä¿¡æ¯ã€‚</a> </p><br><p> ä¸ºäº†æ›´æ¸…æ¥šåœ°ä»£è¡¨æœ€ç»ˆç›®æ ‡ï¼Œæˆ‘å°†ç»˜åˆ¶ä¸€ä¸ªå›¾è¡¨ã€‚ </p><br><p><img src="https://habrastorage.org/webt/mu/bz/ji/mubzjikeu0b35eac4e_qj0rxdt4.png"></p><br><p> è®©æˆ‘ä»¬ä¾æ¬¡æŸ¥çœ‹è®¢å•å¤„ç†æµç¨‹åœ¨æ­¤å›¾ä¸­çš„å·¥ä½œæ–¹å¼ã€‚ è¯¥æ–¹æ¡ˆåˆ†ä¸ºå—å’Œä¸åŒçš„é¢œè‰²ã€‚ ç™½æ¡†è¡¨ç¤ºæˆ‘ä»¬ä¸ä¼šè€ƒè™‘çš„å¤–éƒ¨æœåŠ¡ã€‚ ç°è‰²å—è¡¨ç¤ºRabbitMQå…ƒç´ ã€‚ é˜Ÿåˆ—å’Œäº¤æ¢å™¨ã€‚ ç»¿è‰²åæ˜ äº†éœ€è¦å®ç°çš„ä¸šåŠ¡é€»è¾‘å—ã€‚ åŒæ ·ï¼Œä¸æˆ‘ä»¬çš„é€»è¾‘ç›¸å…³çš„æ¯ä¸ªå—éƒ½è¢«ç¼–å·ã€‚ æ•°å­—æŒ‰é¡ºåºæŒ‡ç¤ºæµç¨‹å’Œå­æµç¨‹ã€‚ </p><br><p> é¦–å…ˆï¼ŒHTTP APIæ¶ˆæ¯è¿›å…¥æˆ‘ä»¬çš„æœåŠ¡ã€‚ ä¹‹åï¼Œæˆ‘ä»¬å¿…é¡»ä¸ºè®¢å•åˆ†é…ä¸€ä¸ªç¼–å·ï¼Œå°†è®¢å•çŠ¶æ€ä¿å­˜ä¸ºæ•°æ®åº“ä¸­çš„â€œæ–°â€ï¼Œå¹¶å‘é€æœ‰å…³æˆåŠŸåˆ›å»ºè®¢å•çš„å“åº”åŠå…¶ç¼–å·ã€‚ å®¢æˆ·å·²ç»æ”¶åˆ°æœ‰å…³æˆåŠŸåˆ›å»ºè®¢å•çš„æ¶ˆæ¯ï¼Œç„¶åç»§ç»­è‡ªå·±çš„ç”Ÿæ„ã€‚ é€šè¿‡å‘é€è‚¯å®šå“åº”ï¼Œæˆ‘ä»¬å°†è®¢å•å¯¹è±¡å‘é€åˆ°åå¤„ç†äº¤æ¢ï¼Œäº¤æ¢å¯¹è±¡ä»è¯¥å¯¹è±¡è½å…¥è·¯ç”±é”®å½¢æˆçš„å·¥ä½œç¨‹åºä¸­ã€‚ è¯¥å·¥ä½œäººå‘˜ä»é˜Ÿåˆ—ä¸­æ¥æ”¶åˆ°è®¢å•å¯¹è±¡åï¼Œå¿…é¡»ä»¥æ­¤ä¸ºåŸºç¡€ï¼ˆæ— è®ºè®¢å•ä¸­æ˜¯å¦æœ‰ç”µå­é‚®ä»¶æˆ–å®¢æˆ·çš„ç”µè¯ï¼Œä»¥åŠé€‰æ‹©äº†å“ªç§å‘é€æ–¹å¼ï¼‰ï¼Œéƒ½å¿…é¡»æ„æˆè®¢å•è·¯ç”±å¯†é’¥ã€‚ å½¢æˆè·¯ç”±é”®åï¼Œå·¥ä½œäººå‘˜å°†æ¶ˆæ¯å‘é€å›åå¤„ç†äº¤æ¢ï¼Œä½†æ˜¯ç°åœ¨è®¢å•çš„è·¯ç”±é”®å·²æ›´æ”¹ï¼Œäº¤æ¢å™¨å¯ä»¥åœ¨æ‰€éœ€çš„è·¯ç”±ä¸Šå‘é€å®ƒã€‚ æ ¹æ®å¯†é’¥ï¼Œå¯ä»¥å°†è®¢å•å‘é€åˆ°äº¤æ˜“æ‰€ï¼Œåè€…è´Ÿè´£é€šçŸ¥ï¼Œäº¤æ˜“æ‰€é›†æˆæˆ–åŒæ—¶æ‰§è¡Œè¿™ä¸¤è€…ã€‚ å¹¶è¿›ä¸€æ­¥æŒ‰ç…§ç›¸åŒçš„é€»è¾‘æ’é˜Ÿå’Œå·¥ä½œã€‚ </p><br><p>  SMSå‘é€å·¥ä½œè€…å’Œä¼ é€’æœåŠ¡å°†å°è¯•å¤šæ¬¡å¤„ç†è¯¥æ¶ˆæ¯ã€‚ å¯ä»¥åœ¨ç¯å¢ƒå˜é‡ä¸­ä¼ é€’æ­¤ç±»å°è¯•çš„æ¬¡æ•°ã€‚ ä½†æ˜¯æ‚¨ä¸åº”è¯¥æ— ä¼‘æ­¢åœ°å¤„ç†æ¶ˆæ¯ï¼Œå› ä¸ºé”™è¯¯å¯èƒ½åœ¨äºæ¶ˆæ¯æœ¬èº«æˆ–å·¥ä½œäººå‘˜çš„é€»è¾‘ã€‚ å› æ­¤ï¼Œåœ¨è¶…è¿‡å…è®¸çš„å°è¯•æ¬¡æ•°ä¹‹åï¼Œè¯¥æ¶ˆæ¯å°†ä»é˜Ÿåˆ—ä¸­åˆ é™¤ï¼Œå¹¶å‘é€åˆ°é”™è¯¯å­˜å‚¨ï¼Œä»ä¸­å¯ä»¥å°†å…¶é‡æ–°å‘é€å›æ‰€éœ€çš„å¤„ç†çº§åˆ«ã€‚ </p><br><h2 id="realizaciya"> å®ä½œ </h2><br><p> ä¸ºäº†éªŒè¯å®ç°ï¼Œæ‚¨éœ€è¦Rabbitæœ¬èº«ã€‚ æˆ‘å»ºè®®ä¸ºæ­¤ä½¿ç”¨dockerå’Œå®˜æ–¹ä»£ç†æ˜ åƒã€‚ ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å®‰è£…å¹¶è¿è¡Œå®¹å™¨ã€‚ </p><br><pre><code class="bash hljs">docker run -d --name rabbit -p 5672:5672 -e rabbitmq:3.7.15-management-alpine</code> </pre> <br><p> è¿™æ˜¯åœ¨ç«¯å£15672ä¸Šå…·æœ‰Webç•Œé¢çš„å›¾åƒï¼Œç”¨äºæ–¹ä¾¿è°ƒè¯•ã€‚ </p><br><p> æˆ‘ä»¬å°†ä½¿ç”¨TypeScriptå’Œ<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">amqplib</a>åº“ï¼ˆNode.jsçš„RabbitMQå®¢æˆ·ç«¯å®ç°ï¼‰å®æ–½æˆ‘ä»¬çš„è®¡åˆ’ï¼Œå› æ­¤ä¸€å¼€å§‹æ‚¨éœ€è¦æè¿°å‡ ä¸ªæ¥å£ã€‚ æˆ‘ä»¬æè¿°äº†è®¢å•çš„ç•Œé¢ä»¥åŠå°†å‘é€ç»™Rabbitçš„æ¶ˆæ¯ã€‚ </p><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//    export interface Product { id: string; name: string; price: number; } //    export interface Order { clientName: string; city: string; email?: string; phone?: string; products: Product[]; totalSum: number; deliveryAddress?: string; } //         export interface OrderWithPhone extends Order { phone: string; } //        export interface OrderWithDeliveryAddress extends Order { deliveryAddress: string; } // Types Guard'        export const isOrderWithPhone = (order: Order): order is OrderWithPhone =&gt; Boolean(order.phone); export const isOrderWithDeliveryAddress = (order: Order): order is OrderWithDeliveryAddress =&gt; Boolean(order.deliveryAddress); //    . export interface Message&lt;O extends Order&gt; { errors: string[]; retry: number; order: O; //         export interface FailOrder extends Message&lt;Order&gt; { exchange: string; routingKey: string; }</span></span></code> </pre> <br><p> ç°åœ¨æˆ‘ä»¬éœ€è¦æè¿°é˜Ÿåˆ—å’Œäº¤æ¢å™¨çš„é…ç½®æ¥å£ï¼Œåœ¨æ­¤åŸºç¡€ä¸Šæˆ‘ä»¬å°†æ„å»ºRabbitçš„å¤„ç†ç»“æ„ã€‚ </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Types, ExchangeTypes } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../constants'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Options } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'amqplib'</span></span>; <span class="hljs-comment"><span class="hljs-comment">//   RabbitMQ       export enum Types { QUEUE = 'queue', EXCHANGE = 'exchange', } //      export enum ExchangeTypes { TOPIC = 'topic', } //    export interface Queue { name: string; options: Options.AssertQueue; } //    export interface Exchange { name: string; type: ExchangeTypes; } //    export interface Binding { type: Types; destination: string; source: string; routingKey: string; } //   RabbitMQ export interface PipelineConfig { queues: Queue[]; exchanges: Exchange[]; bindings: Binding[]; }</span></span></code> </pre> <br><p> æè¿°äº†ç³»ç»Ÿçš„ä¸»è¦ç»„ä»¶ä¹‹åï¼Œæˆ‘ä»¬æè¿°äº†ä½¿ç”¨å¯¹è±¡åœ¨å›¾ä¸Šç»˜åˆ¶çš„é…ç½®ã€‚ </p><br><p>  Queueåˆ— </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> [ <span class="hljs-comment"><span class="hljs-comment">//        routingKey { name: 'generateRoutingKey', options: { durable: true, }, }, //   sms { name: 'sendSms', options: { durable: true, }, }, //      { name: 'delivery', options: { durable: true, }, }, //         sms { name: 'sendSmsHold', options: { durable: true, deadLetterExchange: 'notify', deadLetterRoutingKey: 'sendSms', messageTtl: 60000, }, }, //            { name: 'deliveryHold', options: { durable: true, deadLetterExchange: 'integrates', deadLetterRoutingKey: 'delivery', messageTtl: 60000, }, }, ];</span></span></code> </pre> <br><p> æè¿°é˜Ÿåˆ—æ—¶ï¼Œä»¥ä¸‹é€‰é¡¹ç”¨äºé˜Ÿåˆ—ã€‚ </p><br><ul><li>  <strong>è€ç”¨çš„</strong> ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰é˜Ÿåˆ—æ¶ˆæ¯éƒ½å­˜å‚¨åœ¨å†…å­˜ä¸­ã€‚ å› æ­¤ï¼Œå½“ä»£ç†é‡æ–°å¯åŠ¨æ—¶ï¼Œæ¶ˆæ¯å°†æ¶ˆå¤±ã€‚ ä¸ºé¿å…è¿™ç§æƒ…å†µï¼Œå¯ä»¥ä½¿ç”¨æ­¤é€‰é¡¹ã€‚ ä½¿ç”¨æ­¤è®¾ç½®ï¼Œrabbitä¼šå°†æ¶ˆæ¯åˆ·æ–°åˆ°ç£ç›˜ã€‚ ä½†æ˜¯æœ‰ä¸€ä¸ªè­¦å‘Šã€‚ ä¸ºäº†åœ¨ä»£ç†é‡æ–°å¯åŠ¨åä¿å­˜æ¶ˆæ¯ï¼Œæ­¤è®¾ç½®è¿˜ä¸å¤Ÿï¼›å¿…é¡»ä½¿ç”¨æŒä¹…æ€§é€‰é¡¹å°†æ¶ˆæ¯å‘é€åˆ°é˜Ÿåˆ—ã€‚ </li><li>  <strong>messageTtl</strong> ã€‚ æ¶ˆæ¯ç”Ÿå­˜æœŸã€‚ ä»¥æ¯«ç§’ä¸ºå•ä½ </li><li>  <strong>deadLetterExchange</strong> ã€‚ è¿‡æœŸæ—¶å°†ä»é˜Ÿåˆ—ä¸­å‘é€æ¶ˆæ¯çš„äº¤æ¢å™¨çš„åç§° </li><li>  <strong>deadLetterRoutingKey</strong> ã€‚ ä»ä¸Šä¸€ä¸ªé€‰é¡¹å°†æ¶ˆæ¯å‘é€åˆ°äº¤æ¢å™¨çš„RoutingKey </li></ul><br><p> äº¤æµäº¤æµ </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { ExchangeTypes } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../constants'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> [ { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'postprocessing'</span></span>, <span class="hljs-attr"><span class="hljs-attr">type</span></span>: ExchangeTypes.TOPIC, }, { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'notify'</span></span>, <span class="hljs-attr"><span class="hljs-attr">type</span></span>: ExchangeTypes.TOPIC, }, { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'integrates'</span></span>, <span class="hljs-attr"><span class="hljs-attr">type</span></span>: ExchangeTypes.TOPIC, }, ];</code> </pre> <br><p> ç»‘å®š </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Types } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../constants'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> [ { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: Types.EXCHANGE, <span class="hljs-attr"><span class="hljs-attr">destination</span></span>: <span class="hljs-string"><span class="hljs-string">'notify'</span></span>, <span class="hljs-attr"><span class="hljs-attr">source</span></span>: <span class="hljs-string"><span class="hljs-string">'postprocessing'</span></span>, <span class="hljs-attr"><span class="hljs-attr">routingKey</span></span>: <span class="hljs-string"><span class="hljs-string">'#.notify.#'</span></span>, }, { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: Types.EXCHANGE, <span class="hljs-attr"><span class="hljs-attr">destination</span></span>: <span class="hljs-string"><span class="hljs-string">'integrates'</span></span>, <span class="hljs-attr"><span class="hljs-attr">source</span></span>: <span class="hljs-string"><span class="hljs-string">'postprocessing'</span></span>, <span class="hljs-attr"><span class="hljs-attr">routingKey</span></span>: <span class="hljs-string"><span class="hljs-string">'#.integrates.#'</span></span>, }, { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: Types.QUEUE, <span class="hljs-attr"><span class="hljs-attr">destination</span></span>: <span class="hljs-string"><span class="hljs-string">'generateRoutingKey'</span></span>, <span class="hljs-attr"><span class="hljs-attr">source</span></span>: <span class="hljs-string"><span class="hljs-string">'postprocessing'</span></span>, <span class="hljs-attr"><span class="hljs-attr">routingKey</span></span>: <span class="hljs-string"><span class="hljs-string">'generateRoutingKey'</span></span>, }, { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: Types.QUEUE, <span class="hljs-attr"><span class="hljs-attr">destination</span></span>: <span class="hljs-string"><span class="hljs-string">'sendSms'</span></span>, <span class="hljs-attr"><span class="hljs-attr">source</span></span>: <span class="hljs-string"><span class="hljs-string">'notify'</span></span>, <span class="hljs-attr"><span class="hljs-attr">routingKey</span></span>: <span class="hljs-string"><span class="hljs-string">'#.sendSms.#'</span></span>, }, { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: Types.QUEUE, <span class="hljs-attr"><span class="hljs-attr">destination</span></span>: <span class="hljs-string"><span class="hljs-string">'delivery'</span></span>, <span class="hljs-attr"><span class="hljs-attr">source</span></span>: <span class="hljs-string"><span class="hljs-string">'integrates'</span></span>, <span class="hljs-attr"><span class="hljs-attr">routingKey</span></span>: <span class="hljs-string"><span class="hljs-string">'#.delivery.#'</span></span>, }, { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: Types.QUEUE, <span class="hljs-attr"><span class="hljs-attr">destination</span></span>: <span class="hljs-string"><span class="hljs-string">'sendSmsHold'</span></span>, <span class="hljs-attr"><span class="hljs-attr">source</span></span>: <span class="hljs-string"><span class="hljs-string">'notify'</span></span>, <span class="hljs-attr"><span class="hljs-attr">routingKey</span></span>: <span class="hljs-string"><span class="hljs-string">'sendSmsHold'</span></span>, }, { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: Types.QUEUE, <span class="hljs-attr"><span class="hljs-attr">destination</span></span>: <span class="hljs-string"><span class="hljs-string">'deliveryHold'</span></span>, <span class="hljs-attr"><span class="hljs-attr">source</span></span>: <span class="hljs-string"><span class="hljs-string">'integrates'</span></span>, <span class="hljs-attr"><span class="hljs-attr">routingKey</span></span>: <span class="hljs-string"><span class="hljs-string">'deliveryHold'</span></span>, }, ];</code> </pre> <br><p> å®Œæ•´é…ç½® </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { PipelineConfig } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../interfaces'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> exchanges <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./exchanges'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> queues <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./queues'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> bindings <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./bindigs'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> pipelineConfig: PipelineConfig = { exchanges, queues, bindings, };</code> </pre> <br><p> è¦è¿æ¥åˆ°Rabbitï¼Œè¯·ç¼–å†™ä¸€ä¸ªç±»ã€‚ </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { connect, Connection, Channel } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'amqplib'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RabbitConnect</span></span></span><span class="hljs-class"> </span></span>{ private _uri: string; private _connection: Connection; private _chanel: Channel; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>() { <span class="hljs-comment"><span class="hljs-comment">//    rabbit     this._uri = process.env.RABBIT_URI || 'amqp://localhost'; } protected async connect() { this._connection = await connect(this._uri); this._chanel = await this._connection.createChannel(); } protected async disconnect() { await this._chanel.close(); return this._connection.close(); } protected get chanel() { return this._chanel; } }</span></span></code> </pre> <br><p> è®©æˆ‘ä»¬ç¼–å†™Pipelineç±»ï¼Œè¯¥ç±»åœ¨å¯åŠ¨æ—¶å°†æ ¹æ®å‰é¢æ‰€è¿°çš„é…ç½®åœ¨Rabbitä¸­åˆ›å»ºæ‰€æœ‰å¿…è¦çš„åŸºç¡€ç»“æ„ã€‚ </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { RabbitConnect } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./RabbitConnect'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { PipelineConfig } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./interfaces'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Types } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./constants'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Pipeline</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RabbitConnect</span></span></span><span class="hljs-class"> </span></span>{ private _pipeline: PipelineConfig; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(pipelineConfig: PipelineConfig) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._pipeline = pipelineConfig; } public <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> create() { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.connect(); <span class="hljs-comment"><span class="hljs-comment">//   const createQueues = this._pipeline.queues.map(queue =&gt; this.chanel.assertQueue(queue.name, queue.options), ) as PromiseLike&lt;any&gt;[]; //   const createExchanges = this._pipeline.exchanges.map(exchange =&gt; this.chanel.assertExchange(exchange.name, exchange.type), ) as PromiseLike&lt;any&gt;[]; await Promise.all([...createQueues, ...createExchanges]); //       const createBindings = this._pipeline.bindings.map(binding =&gt; { if (binding.type === Types.QUEUE) { return this.chanel.bindQueue(binding.destination, binding.source, binding.routingKey); } return this.chanel.bindExchange(binding.destination, binding.source, binding.routingKey); }); await Promise.all(createBindings); return this.disconnect(); } catch (error) { console.error(error); throw new Error(error); } } }</span></span></code> </pre> <br><p> ç°åœ¨ï¼Œæˆ‘ä»¬å°†ç¼–å†™ä¸€ä¸ªæŠ½è±¡çš„å·¥ä½œç¨‹åºç±»ï¼Œè¯¥ç±»ä¸ºæ‰€æœ‰å¯ä»¥ä»å…¶ç»§æ‰¿çš„å·¥ä½œç¨‹åºæä¾›é€šç”¨åŠŸèƒ½ã€‚ </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { RabbitConnect } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./RabbitConnect'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Message, Order, FailOrder } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./interfaces'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { ConsumeMessage } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'amqplib'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> interface WorkerParams { maxRetry?: number; <span class="hljs-comment"><span class="hljs-comment">//     active: string; //    exchange: string; //       holdKey?: string; //      } export abstract class Worker&lt;M extends Order&gt; extends RabbitConnect { private _maxRetry: number; private _active: string; private _holdKey: string | undefined; protected exchange: string; private _currentMessage: Message&lt;M&gt;; private _currentConsumeMessage: ConsumeMessage; constructor({ active, holdKey, exchange, maxRetry }: WorkerParams) { super(); this._maxRetry = maxRetry || 0; this._active = active; this._holdKey = holdKey; this.exchange = exchange; } public async subscribe() { await this.connect(); this.chanel.consume(this._active, this.checkMessage.bind(this)); } //          private async checkMessage(message: ConsumeMessage) { this._currentConsumeMessage = message; const orderMessage: Message&lt;M&gt; = JSON.parse(message.content.toString()); if (orderMessage.retry &gt;= this._maxRetry) { await this.sendToErrorStorage('  '); } this._currentMessage = orderMessage; //           await this.handler(orderMessage.order || orderMessage); } //       protected async sendToErrorStorage(error: string) { const message: FailOrder = { order: this._currentMessage.order, errors: [...this._currentMessage.errors, error], retry: this._currentMessage.retry + 1, exchange: this.exchange, routingKey: this._active }; console.log('   ', message); this.ack(); } //       protected async hold(error: string) { if (!this._holdKey) { return; } const orderMessage = { order: this._currentMessage.order, errors: [...this._currentMessage.errors, error], retry: this._currentMessage.retry + 1, }; const orderData = Buffer.from(JSON.stringify(orderMessage)); return this.chanel.publish(this.exchange, this._holdKey, orderData); } //      protected async ack() { return this.chanel.ack(this._currentConsumeMessage); } protected abstract handler(message: M): void; }</span></span></code> </pre> <br><p> é»˜è®¤æƒ…å†µä¸‹ï¼Œrabbitè¦æ±‚å·¥ä½œäººå‘˜ç¡®è®¤æ¶ˆæ¯å¤„ç†æˆåŠŸã€‚ ä¸ºæ­¤ï¼Œè¿æ¥é€šé“å…·æœ‰ackæ–¹æ³•ã€‚ å¦‚æœå·¥ä½œäººå‘˜æ— æ³•å¤„ç†è¯¥æ¶ˆæ¯ï¼Œåˆ™æœ‰ä¸€ä¸ªnackæ–¹æ³•å‘Šè¯‰å…”å­å°†æ¶ˆæ¯å‘é€ç»™å¦ä¸€ä¸ªå·¥ä½œäººå‘˜ã€‚ </p><br><p> ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥ä»å›¾ä¸­ç¼–å†™ä¸€äº›ç®€å•çš„å·¥ä½œç¨‹åºã€‚ </p><br><p> ç”Ÿæˆè·¯ç”±å¯†é’¥çš„å·¥ä½œäººå‘˜ã€‚ </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Worker } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../Worker'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { isOrderWithPhone, isOrderWithDeliveryAddress, Order, Message, } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../interfaces'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Keys } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../constants'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GenerateRoutingKey</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Worker</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Order</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>({ <span class="hljs-attr"><span class="hljs-attr">active</span></span>: <span class="hljs-string"><span class="hljs-string">'generateRoutingKey'</span></span>, <span class="hljs-attr"><span class="hljs-attr">exchange</span></span>: <span class="hljs-string"><span class="hljs-string">'postprocessing'</span></span>, }); } protected <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> handler(order: Order) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> routingKey: string[] = []; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isOrderWithPhone(order)) { routingKey.push(Keys.SEND_SMS); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isOrderWithDeliveryAddress(order)) { routingKey.push(Keys.SEND_TO_DELIVERY); } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> message: Message&lt;Order&gt; = { <span class="hljs-attr"><span class="hljs-attr">retry</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">errors</span></span>: [], order, }; <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.chanel.publish( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.exchange, routingKey.join(<span class="hljs-string"><span class="hljs-string">'.'</span></span>), Buffer.from(<span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify(message)), ); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ack(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (error) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.error(error); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.sendToErrorStorage(error); } } }</code> </pre> <br><p> å·¥äººå‘é€çŸ­ä¿¡ã€‚ </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Worker } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../Worker'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { OrderWithPhone } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../interfaces'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SendSms</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Worker</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OrderWithPhone</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>({ <span class="hljs-attr"><span class="hljs-attr">active</span></span>: <span class="hljs-string"><span class="hljs-string">'sendSms'</span></span>, <span class="hljs-attr"><span class="hljs-attr">exchange</span></span>: <span class="hljs-string"><span class="hljs-string">'notify'</span></span>, <span class="hljs-attr"><span class="hljs-attr">holdKey</span></span>: <span class="hljs-string"><span class="hljs-string">'sendSmsHold'</span></span>, <span class="hljs-attr"><span class="hljs-attr">maxRetry</span></span>: process.env.MAX_RETRY ? <span class="hljs-built_in"><span class="hljs-built_in">parseInt</span></span>(process.env.MAX_RETRY) : <span class="hljs-number"><span class="hljs-number">5</span></span>, }); } protected <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> handler(message: OrderWithPhone) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">' sms  : '</span></span>, message.phone); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ack(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (error) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.error(error); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.hold(error); } } }</code> </pre> <br><p> å·¥äººä¸é€è´§æœåŠ¡çš„æ•´åˆã€‚ </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Worker } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../Worker'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { OrderWithDeliveryAddress } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../interfaces'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Delivery</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Worker</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OrderWithDeliveryAddress</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>({ <span class="hljs-attr"><span class="hljs-attr">active</span></span>: <span class="hljs-string"><span class="hljs-string">'delivery'</span></span>, <span class="hljs-attr"><span class="hljs-attr">exchange</span></span>: <span class="hljs-string"><span class="hljs-string">'interates'</span></span>, <span class="hljs-attr"><span class="hljs-attr">holdKey</span></span>: <span class="hljs-string"><span class="hljs-string">'deliveryHold'</span></span>, <span class="hljs-attr"><span class="hljs-attr">maxRetry</span></span>: process.env.MAX_RETRY ? <span class="hljs-built_in"><span class="hljs-built_in">parseInt</span></span>(process.env.MAX_RETRY) : <span class="hljs-number"><span class="hljs-number">5</span></span>, }); } protected <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> handler(message: OrderWithDeliveryAddress) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'      : '</span></span>, message.deliveryAddress); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ack(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (error) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.error(error); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.hold(error); } } }</code> </pre> <br><p> åº”ç”¨ç¨‹åºçš„å…¥å£ç‚¹ã€‚ </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Pipeline } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./Pipeline'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { pipelineConfig } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./pipeline'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { GenerateRoutingKey } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./workers/GenerateRoutingKey'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { SendSms } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./workers/SendSms'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Delivery } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./workers/Delivery'</span></span>; <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">async</span></span></span></span><span class="hljs-function"><span class="hljs-params"> (</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> pipeline = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Pipeline(pipelineConfig); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> generateRoutingKey = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GenerateRoutingKey(); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> sendSms = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SendSms(); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> delivery = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Delivery(); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> pipeline.create(); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>.all([generateRoutingKey.subscribe(), sendSms.subscribe(), delivery.subscribe()]); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (error) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.error(error); process.exit(<span class="hljs-number"><span class="hljs-number">1</span></span>); } })();</code> </pre> <br><p> æˆ‘ä¸ä¼šæä¾›ç”¨äºå°†è®¢å•å†™å…¥æ•°æ®åº“å¹¶ç”ŸæˆInternetè®¢å•å·çš„ä»£ç ç±»ç¤ºä¾‹ã€‚ è¿™è¶…å‡ºäº†æœ¬æ–‡çš„èŒƒå›´ã€‚ è¦æ£€æŸ¥ä»£ç ï¼Œå¯ä»¥é€šè¿‡å°†è®¢å•jsonå‘é€åˆ°äº¤æ¢å™¨posrprocessingæ¥ä½¿ç”¨Rabbit Webç•Œé¢ã€‚ </p><br><h2 id="zaklyuchenie"> ç»“è®º </h2><br><p> ç”¨äºå¤„ç†åœ¨çº¿è®¢å•çš„è¿™ç§æ„é€ æ–¹æ¡ˆä½¿å¾—æ‰©å±•ç³»ç»Ÿå˜å¾—å®¹æ˜“ã€‚ å¯¹äºæˆ‘ä»¬æ¥è¯´ï¼Œä¸ºè¯¥æ–¹æ¡ˆæ·»åŠ å‡ ä¸ªé˜Ÿåˆ—å’Œå·¥ä½œå™¨ä»¥æ·»åŠ å¿…è¦çš„åŠŸèƒ½å¹¶ä¸å›°éš¾ã€‚ ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥æ·»åŠ é€šè¿‡ç”µå­é‚®ä»¶å‘é€å‘é€é€šçŸ¥æˆ–å‘é€1Cä¸­çš„è®°å¸è®¢å•ã€‚ è½¬æ¢åçš„ç”µè·¯å¦‚ä¸‹æ‰€ç¤ºï¼š </p><br><p><img src="https://habrastorage.org/webt/id/rt/7j/idrt7j5jx9zmzcma6axa3st7-nq.png"></p><br><p> å¸Œæœ›æ‚¨å–œæ¬¢è¿™ç¯‡æ–‡ç« ã€‚ æˆ‘å°†å¯¹ä»»ä½•è¯„è®ºå’Œæ‰¹è¯„æ„Ÿåˆ°é«˜å…´ã€‚ æ‰€æœ‰æäº¤çš„ä»£ç éƒ½å¯ä»¥<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">åœ¨github</a>ä¸Š<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ‰¾åˆ°</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN469991/">https://habr.com/ru/post/zh-CN469991/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN469979/index.html">æ¥è‡ªç¬¬äºŒä¸ªiOS mitap Redmadrobotçš„æŠ¥å‘Šè®°å½•</a></li>
<li><a href="../zh-CN469981/index.html">èŠå¤©æœºå™¨äººé‡Œé¢æœ‰ä»€ä¹ˆï¼Ÿ</a></li>
<li><a href="../zh-CN469985/index.html">æ— éœ€ä¼˜åŒ–å³å¯åŠ é€ŸReddåˆæˆå¤„ç†å™¨çš„ç¨‹åºï¼šæ›´æ¢æ—¶é’Ÿ</a></li>
<li><a href="../zh-CN469987/index.html">å…¨çƒæ’åå‰20ä½çš„å¸‚åœºå¼€å‘å…¬å¸</a></li>
<li><a href="../zh-CN469989/index.html">Cï¼ƒæ­£åˆ™è¡¨è¾¾å¼ç¤ºä¾‹</a></li>
<li><a href="../zh-CN469995/index.html">Python SAXè§£æå™¨ä¸python DOMè§£æå™¨ã€‚ Parsim FIASæˆ¿å±‹</a></li>
<li><a href="../zh-CN469997/index.html">å“ªäº›æ ‡é¢˜æœ€æœ‰å¯èƒ½å¼•èµ·æ³¨æ„æˆ–è¿›è¡ŒHabraHabråˆ†æ</a></li>
<li><a href="../zh-CN469999/index.html">æœåŠ¡å™¨ä¹‹é—´å¦‚ä½•åå•†ï¼šRaftåˆ†å¸ƒå¼å…±è¯†ç®—æ³•</a></li>
<li><a href="../zh-CN470001/index.html">LinuxæŠ€å·§å’Œçªé—¨ï¼šæœåŠ¡å™¨ï¼Œå¼€æ”¾</a></li>
<li><a href="../zh-CN470005/index.html">é€šè¿‡æµè§ˆå™¨è¿›è¡Œè¿œç¨‹è®¡ç®—æœºæ§åˆ¶</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>