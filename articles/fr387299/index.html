<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üì¥ üë®üèª‚Äçüè´ ‚öΩÔ∏è MBED, ou sur les abstractions qui fuient ü§∏üèæ üò¨ ü§æ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Il jeta un coup d'≈ìil vers mbed. √Ä premi√®re vue, cela semblait tr√®s int√©ressant - un cadre ind√©pendant de fer, en C ++, avec un support pour un tas de...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>MBED, ou sur les abstractions qui fuient</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/387299/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il jeta un coup d'≈ìil vers mbed. √Ä premi√®re vue, cela semblait tr√®s int√©ressant - un cadre ind√©pendant de fer, en C ++, avec un support pour un tas de microcontr√¥leurs et de cartes de d√©monstration, un compilateur en ligne avec int√©gration dans le syst√®me de contr√¥le de version. Un tas d'exemples qui convainquent davantage l'√©l√©gance du cadre. Presque toutes les interfaces du microcontr√¥leur sont accessibles directement hors de la bo√Æte en utilisant les classes correspondantes d√©j√† impl√©ment√©es. Prenez-le directement de la bo√Æte et programmez en C ++ sans regarder la fiche technique du microcontr√¥leur - n'est-ce pas un r√™ve? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La plate-forme de test est le STM Nucleo F030 de longue date, pris en charge par cette plate-forme. Il y a beaucoup de bons tutoriels sur la fa√ßon de s'inscrire et de d√©marrer le premier projet, nous n'en parlerons pas. Allons directement √† l'int√©ressant.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette carte ne contient pas trop de p√©riph√©riques "embarqu√©s". </font><font style="vertical-align: inherit;">LED et bouton - c'est toute la richesse. </font><font style="vertical-align: inherit;">Eh bien, le premier projet - le "Hello world" classique du monde des microcontr√¥leurs - clignote avec une LED. </font><font style="vertical-align: inherit;">Voici le code:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"mbed.h"</span></span></span></span>
<span class="hljs-function"><span class="hljs-function">DigitalOut </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">myled</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(LED1)</span></span></span></span>;
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{
    <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>)<font></font>
    {<font></font>
        wait_ms(<span class="hljs-number"><span class="hljs-number">500</span></span>);<font></font>
        myled = myled ^ <span class="hljs-number"><span class="hljs-number">1</span></span>;<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sympa apr√®s tout, non? </font><font style="vertical-align: inherit;">Vous n'avez vraiment m√™me pas besoin de consulter la fiche technique du contr√¥leur! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Soit dit en passant, le classique ¬´Hello world¬ª est √©galement disponible d√®s la sortie de la bo√Æte:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"mbed.h"</span></span></span></span>
<span class="hljs-function"><span class="hljs-function">Serial </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pc</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(USBTX, USBRX)</span></span></span></span>;
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{<font></font>
    pc.<span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"Hello world\n\r"</span></span>);
    <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>)<font></font>
    {<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N'est-ce pas vraiment g√©nial? ¬´Out of the box¬ª avons-nous une console dans laquelle une impression syst√®me standard fonctionne? Soit dit en passant, le port appara√Æt √©galement imm√©diatement lorsque la carte est connect√©e √† l'ordinateur, avec un disque virtuel, sur lequel il vous suffit de copier le binaire assembl√© - et la carte se red√©marrera. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais revenons √† la LED clignotante. Compilation, t√©l√©chargement sur la carte - clignotant! Mais en quelque sorte trop vite, √©videmment plus d'une fois par seconde, mais au moins 5 fois ... Oups ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je suis un peu distrait par les "abstractions trou√©es" mentionn√©es dans le titre. J'ai lu ce terme avec Joel Spolsky. Voici sa citation: "</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si j'enseigne aux programmeurs C ++, ce serait bien si je n'avais pas besoin de leur parler de l'arithm√©tique char * et pointeur, mais je pourrais aller directement aux lignes de la biblioth√®que de mod√®les standard. Mais un jour ils √©criront "foo" + "bar" et d'√©tranges probl√®mes surgiront, mais je dois encore leur expliquer ce qu'est char *. Ou ils essaieront d'appeler une fonction Windows avec un param√®tre de type LPTSTR et √©choueront jusqu'√† ce qu'ils apprennent char * et les pointeurs et les fichiers d'en-t√™te Unicode et wchar_t et TCHAR - tout ce qui brille √† travers les trous dans les abstractions.</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> "</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aussi paradoxal que cela puisse √™tre, la loi des abstractions trou√©es ne permet pas de prendre et de commencer √† programmer un microcontr√¥leur comme celui-ci (m√™me s'il s'agit du ¬´bonjour¬ª le plus simple de trois lignes), sans regarder sa fiche technique et sans avoir une id√©e que le microcontr√¥leur a le m√™me int√©rieur, ainsi que ce qui se cache derri√®re toutes ces classes en abstraction. Contrairement aux promesses des marketeurs ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alors, apr√®s avoir fortement soupir√©, nous commen√ßons √† chercher. Si sous mes yeux ce n'√©tait pas une abstraction, mais un environnement de d√©veloppement complet pour le contr√¥leur, il serait clair o√π creuser. Mais o√π creuser en cas de code ci-dessus? Si m√™me le contenu du fichier mbed.h ne permet pas de voir l'abstraction?</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Heureusement, la biblioth√®que mbed elle-m√™me est open source, et vous pouvez la t√©l√©charger et voir ce qu'elle contient. </font><font style="vertical-align: inherit;">Il s'est av√©r√©, encore une fois, heureusement, que gr√¢ce √† l'abstraction pour le programmeur, tous les registres du microcontr√¥leur sont assez accessibles, bien qu'ils ne soient pas explicitement d√©clar√©s. </font><font style="vertical-align: inherit;">D√©j√† mieux. </font><font style="vertical-align: inherit;">Par exemple, vous pouvez v√©rifier que nous avons une vitesse d'horloge en ex√©cutant ceci (pour lequel j'ai d√ª regarder les fiches techniques et creuser assez bien mbed):</font></font><br>
<br>
<pre><code class="cpp hljs">  RCC_OscInitTypeDef str;<font></font>
  RCC_ClkInitTypeDef clk;<font></font>
    pc.<span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"SystemCoreClock = %d Hz\n\r"</span></span>, HAL_RCC_GetSysClockFreq());<font></font>
    <font></font>
    HAL_RCC_GetOscConfig(&amp;str);<font></font>
    pc.<span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"-&gt;HSIState %d\n\r"</span></span>, str.HSIState);<font></font>
    pc.<span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"-&gt;PLL.PLLState %d\n\r"</span></span>, str.PLL.PLLState);<font></font>
    pc.<span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"-&gt;PLL.PLLSource %d\n\r"</span></span>, str.PLL.PLLSource);<font></font>
    pc.<span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"-&gt;PLL.PLLMUL %d\n\r"</span></span>, str.PLL.PLLMUL);<font></font>
    pc.<span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"-&gt;PLL.PREDIV %d\n\r"</span></span>, str.PLL.PREDIV);<font></font>
    pc.<span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"\n\r"</span></span>);<font></font>
    <font></font>
    HAL_RCC_GetClockConfig(&amp;clk, &amp;flat);<font></font>
    pc.<span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"ClockType %d\n\r"</span></span>, clk.ClockType);<font></font>
    pc.<span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"SYSCLKSource %d\n\r"</span></span>, clk.SYSCLKSource );<font></font>
    pc.<span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"AHBCLKDivider  %d\n\r"</span></span>, clk.AHBCLKDivider );<font></font>
    pc.<span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"APB1CLKDivider %d\n\r"</span></span>, clk.APB1CLKDivider );<font></font>
<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout s'est bien pass√© avec la fr√©quence, elle √©tait de 48 MHz, comme pr√©vu. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eh bien, creusez plus loin. </font><font style="vertical-align: inherit;">Nous essayons de connecter un timer au lieu de wait_ms ():</font></font><br>
<br>
<pre><code class="cpp hljs">   Timer timer;<font></font>
    timer.start();<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>) {<font></font>
        myled ^= <span class="hljs-number"><span class="hljs-number">1</span></span>;<font></font>
        t1 = timer.read_ms();<font></font>
        t2 = timer.read_ms();<font></font>
        <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (t2 - t1 &lt; <span class="hljs-number"><span class="hljs-number">500</span></span>)<font></font>
        {<font></font>
            t2 = timer.read_ms();<font></font>
        }<font></font>
    }<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est beau, non? Mais la LED clignote toujours 5 fois plus vite que souhait√© ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D'accord, nous creusons encore plus profond√©ment et voyons ce que nous avons derri√®re le minuteur magique, qui, comme la documentation le promet, peut √™tre cr√©√© en toute quantit√©, quel que soit le nombre de minuteurs mat√©riels. microcontr√¥leur. Cool, ouais ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et dans le cas du STM F030, la minuterie mat√©rielle du contr√¥leur TIM1 est cach√©e derri√®re, programm√©e pour compter les ticks en microsecondes. Et sur cette base, tout le reste a d√©j√† √©t√© construit. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Donc, il fait d√©j√† chaud. Rappelez-vous, j'ai dit que tous les registres sont disponibles? Nous examinons les √©l√©ments suivants:</font></font><br>
<br>
<pre><code class="cpp hljs">pc.<span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"PSC: %d\n\r"</span></span>, TIM1-&gt;PSC);
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voila! Cela met fin √† l'enqu√™te sur qui est √† bl√¢mer: le num√©ro 7 est envoy√© √† la console. Dans le registre PSC (scribe? Est-ce vraiment juste une co√Øncidence?) Il y a une valeur, lorsque le minuteur va g√©n√©rer une interruption et recommencer √† compter. Et sur cette interruption et le compteur de microsecondes est raccroch√©. Et pour qu‚Äô√† une fr√©quence de 48 MHz, l‚Äôinterruption se produise une fois par microseconde, il ne devrait pas y en avoir du tout 7, mais 47. Et 7 sont arriv√©s, tr√®s probablement, au tout premier stade du chargement du microcontr√¥leur, car il commence √† 8 MHz, puis r√©accorde la PLL pour que la fr√©quence soit multipli√©e par 6, donnant les 48 MHz souhait√©s. Et il semble que la minuterie s'initialise trop t√¥t ... </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Qui est √† bl√¢mer, bien s√ªr. Mais que faire? Les fouilles du cadre ont conduit aux cha√Ænes d'appels suivantes:</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Premi√®rement: SetSysClock_PLL_HSI () -&gt; HAL_RCC_OscConfig (), HAL_RCC_ClockConfig () -&gt; HAL_InitTick () - lors du changement de fr√©quence, appelez la fonction qui d√©finit le tick de microseconde. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Deuxi√®mement: HAL_Init () -&gt; HAL_InitTick () -&gt; HAL_TIM_Base_Init () -&gt; TIM_Base_SetConfig () -&gt; TIMx-&gt; PSC - appel√© depuis l'une des fonctions les plus globales, HAL_InitTick √©crit la valeur requise dans le registre PSC, en fonction de l'horloge actuelle fr√©quences ... </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce qui reste un myst√®re pour moi, c'est que c'est pour la famille STM F0 que la deuxi√®me cha√Æne n'est pas appel√©e. Je n'ai trouv√© aucun appel √† la fonction HAL_Init ()! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, si vous regardez l'impl√©mentation de HAL_InitTick (), alors au tout d√©but il y aura les lignes suivantes:</font></font><br>
<br>
<pre><code class="cpp hljs">    <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> ticker_inited=<span class="hljs-number"><span class="hljs-number">0</span></span>;  
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(ticker_inited)<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> HAL_OK;<font></font>
    ticker_inited=<span class="hljs-number"><span class="hljs-number">1</span></span>;
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Appelez cette fonction une seule fois. Autrement dit, vous pouvez l'appeler autant de fois que vous le souhaitez, mais elle ne fera rien pour tous les appels ult√©rieurs. Et le fait que le framework l'appelle au cas o√π les changements de fr√©quence d'horloge sont inutiles ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'√©tais trop paresseux pour reconstruire la biblioth√®que, donc la correction a pris cette forme: la premi√®re ligne de la fonction principale √©tait la suivante:</font></font><br>
<br>
<pre><code class="cpp hljs">TIM1-&gt;PSC = (SystemCoreClock / <span class="hljs-number"><span class="hljs-number">1000000</span></span>) - <span class="hljs-number"><span class="hljs-number">1</span></span>;
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s cela, la LED a finalement commenc√© √† clignoter avec la fr√©quence correcte de 1 Hz ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je me demande √† quelle √©tape une personne hypoth√©tique arr√™terait que les sp√©cialistes du marketing mbed ont convaincu d'essayer de rendre la programmation des microcontr√¥leurs si facile √† partir de z√©ro? S'il n'a jamais rencontr√© de microcontr√¥leurs auparavant? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D'accord, si je ne suis pas tr√®s fatigu√©, nous allons de l'avant. Faire clignoter une LED est bon, mais pas int√©ressant. Je veux quelque chose de plus. Le capteur de temp√©rature DS1820 a √©t√© trouv√© √† partir d'un plus grand, et la biblioth√®que termin√©e pour lui a √©t√© googl√©. Facile √† utiliser, cachant la complexit√© de travailler avec ce capteur √† l'int√©rieur. Il suffit d'√©crire quelque chose comme</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"DS1820.h"</span></span></span></span>
DS1820 probe[<span class="hljs-number"><span class="hljs-number">1</span></span>] = {D4}; <span class="hljs-comment"><span class="hljs-comment">// D4 ‚Äì  ,    </span></span>
probe[<span class="hljs-number"><span class="hljs-number">0</span></span>].convert_temperature(DS1820::all_devices);
<span class="hljs-keyword"><span class="hljs-keyword">float</span></span> temperature = probe[<span class="hljs-number"><span class="hljs-number">0</span></span>].temperature(<span class="hljs-string"><span class="hljs-string">'c'</span></span>);
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Que pensez-vous qu'il s'est pass√© apr√®s la compilation et le lancement? Correctement. √áa n'a pas march√© :) Des </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
abstractions qui fuient, oui. Eh bien, une autre √©tude passionnante des internes mbed nous attend, semble-t-il. Et les d√©tails du capteur lui-m√™me. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le capteur est tr√®s int√©ressant. Avec son interface num√©rique. En une ligne, c'est-√†-dire fonctionne en mode semi-duplex. Le contr√¥leur initie l'√©change de donn√©es, le capteur envoie une s√©quence de bits en r√©ponse. Surtout pour de tels cas, le framework mbed a la classe DigitalInOut, avec laquelle vous pouvez changer la direction de son travail sur la broche GPIO √† la vol√©e. Quelque chose comme √ßa:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> DS1820::onewire_bit_in(DigitalInOut *pin) {
    <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> answer;<font></font>
    pin-&gt;output();<font></font>
    pin-&gt;write(<span class="hljs-number"><span class="hljs-number">0</span></span>);<font></font>
    wait_us(<span class="hljs-number"><span class="hljs-number">3</span></span>);                 <font></font>
    pin-&gt;input();<font></font>
    wait_us(<span class="hljs-number"><span class="hljs-number">10</span></span>); <font></font>
    answer = pin-&gt;read();<font></font>
    wait_us(<span class="hljs-number"><span class="hljs-number">45</span></span>); 
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> answer;<font></font>
}<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le contr√¥leur envoie une impulsion ¬´1 -&gt; 0 -&gt; 1¬ª au capteur, qui est un signal pour qu'il envoie un bit en r√©ponse. Qu'est-ce qui pourrait ne pas fonctionner ici? Voici une partie de la fiche technique du capteur: </font></font><br>
<br>
<img src="https://habrastorage.org/files/135/495/6dc/1354956dcab04ddab94c48a2e49a3586.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme vous pouvez le voir, apr√®s avoir envoy√© une impulsion au capteur, afin de lire le bit, nous avons jusqu'√† 15 microsecondes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous connectons l'oscilloscope et voyons que le capteur s'envoie des bits, comme indiqu√© dans la fiche technique. Mais ici, le contr√¥leur lit les ordures. Quelle pourrait √™tre la raison? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je n‚Äô√©crirai pas grand-chose sur la fa√ßon dont j‚Äôen suis venu √† ex√©cuter ce code:</font></font><br>
<br>
<pre><code class="cpp hljs">    pin-&gt;output();<font></font>
    t1 = timer.read_us();<font></font>
    pin-&gt;input();<font></font>
    t4 = timer.read_us();<font></font>
    pc.<span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"Time: %d us\n\r"</span></span>, t4-t1);
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eh bien, qui devine, sans autre lecture, combien de temps sur un microcontr√¥leur avec une fr√©quence d'horloge de 48 MHz il faut pour changer la direction d'une broche GPIO (en fait, c'est UNE √©criture dans le registre, si cela), si cela se fait en utilisant le cadre mbed √©crit en C ++ en utilisant une couche ind√©pendante du fer? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
13 microsecondes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et pour lire la r√©ponse du capteur, nous en avons jusqu'√† 15. Et m√™me si nous supprimons compl√®tement wait_us (10) du code ci-dessus, la commande answer = pin-&gt; read (); prend √©galement un certain temps plus de 2 microsecondes. De quoi ne pas avoir le temps de lire la r√©ponse.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Heureusement, il a √©t√© possible d'envoyer une impulsion √† la STM sans changer la direction du GPIO. En mode d'entr√©e, lorsque vous connectez la r√©sistance PullDown int√©gr√©e, l'effet est le m√™me. Et encore une fois, heureusement, appeler pin-&gt; mode (PullUp) au lieu de pin-&gt; input () ne n√©cessite que 6 microsecondes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De quoi avoir le temps de lire la r√©ponse. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et enfin, un autre trou dans l'abstraction. Apr√®s que le DS1820 a fonctionn√©, le capteur suivant qui est venu √† la main √©tait le DHT21, un capteur qui mesure √† la fois la temp√©rature et l'humidit√©. √âgalement avec une interface √† 1 fil, mais cette fois une r√©ponse de codage avec une dur√©e d'impulsion. Il semblerait que la solution √©vidente serait de suspendre cette ligne √† l'interruption d'entr√©e GPIO, ce qui facilite la mesure de la dur√©e d'impulsion. Et il y a m√™me une classe en mbed pour √ßa. Et cela fonctionne m√™me comme document√©.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais le probl√®me est que le capteur fonctionne √©galement en semi-duplex. Et pour qu'il commence √† transmettre des donn√©es, il doit envoyer une impulsion "1 -&gt; 0 -&gt; 1" comme dans l'exemple ci-dessus. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et ici, mbed ne le permet pas. Ou vous d√©clarez le port comme DigitalInOut, mais vous ne pouvez alors pas utiliser d'interruptions. Ou vous d√©clarez le port comme InterruptIn, mais vous ne pouvez rien lui envoyer. Malheureusement, l'astuce PullDown n'a pas fonctionn√© ici. le capteur a un PullUp int√©gr√©, et le microcontr√¥leur PullDown int√©gr√© n'est pas suffisant pour tirer une broche √† 0. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai donc d√ª faire un cycle d'interrogation de ligne beaucoup moins beau. Bien s√ªr, tout a fonctionn√© comme √ßa, mais cela n'a pas fonctionn√© √† merveille. Ce qui ne serait pas un probl√®me d'acc√®s direct aux registres ...</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est ici. </font><font style="vertical-align: inherit;">Une tentative de faire une abstraction pour que n'importe qui puisse imm√©diatement commencer √† programmer des microcontr√¥leurs dignes. </font><font style="vertical-align: inherit;">Beaucoup de choses sont vraiment tr√®s simplifi√©es et fonctionnent m√™me. </font><font style="vertical-align: inherit;">Mais, comme toute abstraction de haut niveau, cette abstraction est √©galement pleine de trous. </font><font style="vertical-align: inherit;">Et en cas de collision avec l'un des nombreux trous, il faut descendre du ciel √† la terre.</font></font></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr387299/">https://habr.com/ru/post/fr387299/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr387289/index.html">Adobe a pr√©sent√© son premier √©diteur vid√©o pour Android</a></li>
<li><a href="../fr387291/index.html">Mat√©riau superabsorbant comme outil de r√©ponse aux d√©versements d'hydrocarbures</a></li>
<li><a href="../fr387293/index.html">Le seuil du commerce √©lectronique en franchise de droits peut √™tre relev√©. Ou pas?</a></li>
<li><a href="../fr387295/index.html">–õ–∞—Ä—Å –õ–∞—Ä—Å—Å–æ–Ω –∏ –Ω–æ—É—Ç–±—É–∫ Dell –ø—É—Ç–µ—à–µ—Å—Ç–≤—É—é—Ç –ø–æ –°—Ä–µ–¥–Ω–µ–π –ê–∑–∏–∏</a></li>
<li><a href="../fr387297/index.html">–ó–Ω–∞–∫–æ–º—å—Ç–µ—Å—å, —ç—Ç–æ —Ç–æ—Ä–≥–æ–≤—ã–π —Ä–∞–±–æ—Ç–Ω–∏–∫ —Ä–æ–±–æ—Ç Tally</a></li>
<li><a href="../fr387305/index.html">Ouverture de la salle de conf√©rence scientifique populaire Mise en place le 5 d√©cembre</a></li>
<li><a href="../fr387307/index.html">Que se passera-t-il si nous combinons l'informatique et la m√©decine du sport?</a></li>
<li><a href="../fr387309/index.html">Comment l'impression 3D modifie les proth√®ses des membres</a></li>
<li><a href="../fr387311/index.html">Comment cuisiner une dinde festive sur l'ISS?</a></li>
<li><a href="../fr387313/index.html">Le plus ancien mus√©e technique d'Europe</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>