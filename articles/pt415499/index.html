<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üí∞ üéç üìò Como parar de ter medo de Proguard e come√ßar a viver ‚ò∫Ô∏è üè¶ üç¥</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√°, sou desenvolvedor Android e n√£o tenho mais medo do ProGuard ... 


 Geralmente, esse utilit√°rio √© lembrado quando se depara com um problema do da...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como parar de ter medo de Proguard e come√ßar a viver</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/415499/"><p><img src="https://habrastorage.org/webt/ws/uk/rs/wsukrsowhkx1zzbqyocrumhhsmi.png"></p><br><p>  Ol√°, sou desenvolvedor Android e n√£o tenho mais medo do ProGuard ... </p><br><p> Geralmente, esse utilit√°rio √© lembrado quando se depara com um problema do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">dalvik dex-limit</a> ou com um requisito para melhorar a seguran√ßa do aplicativo.  Infelizmente, est√° longe da primeira vez para configurar corretamente o Proguard.  Frequentemente, observei quantas, ao interromper o projeto, desligam o Proguard e ativam o suporte ao Mulditex, e toda vez que fico triste com isso, porque o Proguard ajuda a reduzir o tamanho do aplicativo e aumentar seu desempenho. </p><br><p>  No final, decidi escrever um artigo no qual eu pudesse colocar todas as informa√ß√µes √∫teis que aprendi ao longo de v√°rios anos trabalhando com a Proguard e que poderiam ajudar tanto novatos quanto aqueles que j√° sabem alguma coisa. </p><a name="habracut"></a><br><h2 id="o-chem-eto">  Sobre o que √© isso </h2><br><p>  Proguard √© um utilit√°rio de c√≥digo aberto para otimizar e ofuscar o c√≥digo Java.  Essa ferramenta processa o c√≥digo Java j√° compilado, portanto, deve funcionar com qualquer linguagem da JVM.  Mais precisamente, a pr√≥pria linguagem para Proguard √© indiferente, apenas o bytecode √© importante.  Todas as manipula√ß√µes de bytecode programadas podem ser divididas em 3 categorias principais: <strong>redu√ß√£o de c√≥digo</strong> , <strong>otimiza√ß√£o</strong> e <strong>ofusca√ß√£o</strong> . </p><br><h3 id="code-shrinking">  C√≥digo encolhendo </h3><br><p>  Sim, √© uma tarefa bastante estranha escrever c√≥digo e exclu√≠-lo, mas essa √© a realidade do desenvolvimento do Android.  Obviamente, n√£o se trata do c√≥digo escrito √† m√£o (embora isso aconte√ßa), mas de toneladas de carga morta trazidas por bibliotecas de todos os tipos.  <strong>Goiaba</strong> , <strong>Apache Commons</strong> , <strong>Google Play Services</strong> e outros caras podem aumentar o tamanho do arquivo apk de 500kb para algumas dezenas de megabytes.  √Äs vezes, √© t√£o longe que um programa n√£o pode ser compilado devido a exceder o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">limite dos m√©todos Dalvik</a> .  O Proguard ajudar√° a remover todo o c√≥digo n√£o utilizado e reduzir√° o tamanho do aplicativo para alguns megabytes. </p><br><h3 id="optimisation">  Otimiza√ß√£o </h3><br><p>  Al√©m de remover o c√≥digo desnecess√°rio, o Proguard pode otimizar o c√≥digo restante.  Seu arsenal inclui an√°lise de fluxo de controle, an√°lise de fluxo de dados, avalia√ß√£o parcial, atribui√ß√£o √∫nica est√°tica, numera√ß√£o de valor global, an√°lise de vivacidade.  Proguard pode executar otimiza√ß√µes de olho m√°gico, reduzir o n√∫mero de aloca√ß√µes de vari√°veis, simplificar recurs√µes de cauda e muito mais ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">wiki</a> ).  Al√©m dessas opera√ß√µes gerais, o Proguard possui otimiza√ß√µes √∫teis especificamente para a plataforma Android, por exemplo, substituindo classes enum por ints, excluindo instru√ß√µes de registro. </p><br><h3 id="obfuscation">  Ofusca√ß√£o </h3><br><p>  Finalmente, o Proguard pode transformar todo o seu c√≥digo em uma confus√£o ileg√≠vel renomeando todas as classes, m√©todos e campos em conjuntos de letras aleat√≥rias (na verdade n√£o muito aleat√≥rias).  Essa √© uma op√ß√£o muito √∫til, pois qualquer pessoa pode descompilar seu arquivo apk e nem todos t√™m paci√™ncia para entender o c√≥digo ofuscado. </p><br><h2 id="princip-raboty">  Princ√≠pio de funcionamento </h2><br><p>  O programa funciona em 3 etapas na sequ√™ncia descrita acima: <strong>encolhimento do c√≥digo</strong> ‚Üí <strong>otimiza√ß√£o</strong> ‚Üí <strong>ofusca√ß√£o</strong> .  Cada uma das etapas √© opcional. </p><br><p>  <em>A etapa de otimiza√ß√£o no caso do Android SDK est√° desativada por padr√£o.</em> </p><br><p>  Para o Proguard funcionar, voc√™ precisa fornecer 3 componentes: </p><br><ul><li> Seu c√≥digo compilado √© um arquivo com os arquivos de <code>class</code> do seu programa e todas as bibliotecas que voc√™ usa (jar, aar, apk, war, zip, etc.).  Proguard apenas modifica o c√≥digo j√° compilado e n√£o tem nada a ver com a fonte. </li><li>  Arquivo (s) de configura√ß√£o - arquivo (s) que cont√©m todas as regras, op√ß√µes e configura√ß√µes com as quais voc√™ deseja iniciar o processamento. </li><li>  Jarros da biblioteca (aar, apks, ...) - classes da plataforma na qual o programa √© executado.  No caso do Android, este √© <code>android.jar</code> .  Esses arquivos s√£o necess√°rios apenas para a an√°lise correta do seu c√≥digo, eles n√£o ser√£o modificados (isso n√£o faz sentido, pois o <code>android.jar</code> est√° "no telefone", n√£o temos acesso a ele). </li></ul><br><p><img src="https://habrastorage.org/webt/sf/vb/b8/sfvbb8uuvqdacgnjvzmeka3zpa4.png" alt="Imagem da apresenta√ß√£o de Jeb Ware, link no final do artigo"><br>  (Imagem da apresenta√ß√£o de Jeb Ware, link no final do artigo) </p><br><p>  Usando classes de biblioteca e seus arquivos de configura√ß√£o, o Proguard define todos os pontos de entrada para o seu programa ( <strong>sementes</strong> ).  Em outras palavras, define as classes e m√©todos que podem ser chamados de fora e que n√£o podem ser tocados.  Ent√£o, come√ßando com as <strong>sementes</strong> descobertas, o Proguard percorre recursivamente todo o seu c√≥digo, sinalizando "usado" tudo o que poderia alcan√ßar.  Todos os outros c√≥digos ser√£o exclu√≠dos.  Voc√™ deve especificar pelo menos um ponto de entrada na configura√ß√£o.  Para um programa java padr√£o, esta √© a fun√ß√£o <code>main</code> .  No Android, n√£o h√° um ponto de entrada √∫nico no programa; em vez disso, temos componentes padr√£o (Atividade, Servi√ßo etc.) criados e chamados pelo sistema.  Felizmente, n√£o precisamos especificar nada aqui por conta pr√≥pria, o SDK do Android criar√° a configura√ß√£o necess√°ria para n√≥s. </p><br><h3 id="soputstvuyuschie-fayly">  Arquivos complementares </h3><br><p>  Ap√≥s detectar todos os pontos de entrada, o Proguard os <code>seeds.txt</code> arquivo <code>seeds.txt</code> . </p><br><p>  Todo o c√≥digo que a Proguard considerou desnecess√°rio √© gravado no arquivo <code>usage.txt</code> .  Este √© um nome bastante estranho para um arquivo que cont√©m c√≥digo remoto; seria mais correto cham√°-lo de unusage.txt, mas temos o que temos, lembre-se disso. </p><br><p>  Na etapa de ofusca√ß√£o, ser√° criado um arquivo <code>mapping.txt</code> contendo os pares &lt;nome da classe original | m√©todo | campo&gt; -&gt; &lt;nome da classe ofuscada | m√©todo | campo&gt;.  Esse arquivo √© √∫til quando voc√™ precisa desobstruir um programa, por exemplo, ler o stacktrace.  O mapeamento manual de arquivos de volta n√£o √© necess√°rio; o SDK do Android tem utilit√°rios de <code>proguardui</code> e <code>proguardui</code> para ajudar.  Al√©m disso, se voc√™ usa o Fabric Crashlytics, o plug-in gradle pode localizar e carregar esse arquivo independentemente no console, para que voc√™ n√£o precise se preocupar com isso. </p><br><p>  No caso do Android, esses arquivos geralmente est√£o localizados em <code>app/build/output/mapping/&lt;product-flavor-name&gt;/</code> . </p><br><p>  O Proguard tamb√©m cria um arquivo <code>dump.txt</code> que cont√©m tudo o que o Proguard colocou no arquivo final.  Ele nunca veio a calhar para mim, mas talvez seja √∫til para algu√©m. </p><br><h3 id="kak-dela-obstoyat-v-android">  Como est√£o as coisas no Android </h3><br><p>  O Android Gradle Plugin pode executar o Proguard por conta pr√≥pria.  Tudo que voc√™ precisa fazer √© ativar esta op√ß√£o e especificar os arquivos de configura√ß√£o. </p><br><pre> <code class="hljs cs">buildTypes { &lt;...&gt; release { minifyEnabled <span class="hljs-literal"><span class="hljs-literal">true</span></span> proguardFiles <span class="hljs-string"><span class="hljs-string">'proguard-rules.pro'</span></span>, getDefaultProguardFile(<span class="hljs-string"><span class="hljs-string">'proguard-android.txt'</span></span>) } }</code> </pre> <br><p>  <code>minifyEnabled true</code> - ativa o Proguard no tempo de constru√ß√£o </p><br><p>  <code>proguardFiles</code> - uma lista de arquivos de configura√ß√£o.  As regras de todos os arquivos de configura√ß√£o ser√£o adicionadas √† lista geral na ordem em que aparecerem. </p><br><p>  <code>proguard-rules.pro</code> √© o nosso arquivo de configura√ß√£o com regras espec√≠ficas do projeto </p><br><p>  <code>getDefaultProguardFile('proguard-android.txt')</code> - uma fun√ß√£o que retorna o arquivo de configura√ß√£o padr√£o para aplicativos Android.  Encontra-se em <code>AndroidSDK/tools/proguard</code> </p><br><p>  De fato, o SDK do Android tem dois <code>proguard-android.txt</code> : <code>proguard-android.txt</code> e <code>proguard-android-optimize.txt</code> .  O primeiro tem a op√ß√£o <code>-dontoptimize</code> , que desativa todas as otimiza√ß√µes.  Se voc√™ deseja ativar a otimiza√ß√£o, use a segunda configura√ß√£o. </p><br><p>  Al√©m dessas configura√ß√µes padr√£o, o SDK do Android (aapt) gera automaticamente um conjunto de regras para recursos: o aapt verifica todos os arquivos xml (incluindo o manifesto) para encontrar todas as atividades, servi√ßos, visualiza√ß√µes etc.  e gere as regras necess√°rias para eles.  As regras geradas podem ser encontradas em <code>app/build/intermediates/proguard-rules/&lt;flavor&gt;/aapt_rules.txt</code> .  Voc√™ n√£o precisa especific√°-lo, o Android Gradle Plugin adicionar√° essas regras automaticamente. </p><br><p><img src="https://habrastorage.org/webt/1r/w4/t6/1rw4t6egtvymigl79hnxc3n8t9a.png" alt="Imagem da apresenta√ß√£o de Jeb Ware, link no final do artigo"><br>  (Imagem da apresenta√ß√£o de Jeb Ware, link no final do artigo) </p><br><h2 id="konfigi">  Configs </h2><br><p>  A configura√ß√£o do Proguard √© a parte mais b√°sica do trabalho e, ao mesmo tempo, a mais dif√≠cil.  Uma configura√ß√£o incorreta pode facilmente interromper a compila√ß√£o do aplicativo e do pr√≥prio aplicativo em tempo de execu√ß√£o.  Todas as op√ß√µes de configura√ß√£o dispon√≠veis s√£o documentadas em detalhes, desativadas.  site. </p><br><p>  Entre todas as op√ß√µes, eu destacaria os tr√™s grupos mais importantes: </p><br><ul><li>  manter regras - Todos os pontos de entrada poss√≠veis para o programa.  Regras que informam a Proguard quais classes ou partes de classes manter inalteradas ou quais modifica√ß√µes s√£o v√°lidas para classes espec√≠ficas. </li><li>  ajuste de otimiza√ß√£o - indique quais otimiza√ß√µes s√£o aceit√°veis, quantos ciclos de otimiza√ß√£o precisam ser realizados. </li><li>  trabalhar com avisos, erros e depura√ß√£o </li></ul><br><h3 id="keep-rules">  Manter regras </h3><br><p>  Este √© um conjunto de op√ß√µes projetadas para proteger seu c√≥digo do implac√°vel Proguard.  Na sua forma mais geral, esta regra se parece com isso: </p><br><pre> <code class="hljs powershell"><span class="hljs-literal"><span class="hljs-literal">-keep</span></span> [,<span class="hljs-type"><span class="hljs-type">modifier</span></span>,<span class="hljs-type"><span class="hljs-type">...</span></span>] class_specification</code> </pre> <br><p>  <code>keep</code> √© a mais comum dessas op√ß√µes (existem outras), dizendo ao Proguard para salvar a pr√≥pria classe e todos os seus membros: campos e m√©todos. </p><br><p>  <code>class_specification</code> - um modelo apontando para a (s) classe (s) ou suas partes (membros da classe).  A vis√£o geral do modelo √© muito grande, pode ser visualizada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documenta√ß√£o</a> .  Voc√™ pode entrar em contato com ele, mas, em geral, voc√™ pode se lembrar de que temos a oportunidade de compor um modelo desses componentes: </p><br><ul><li>  selecione todas as classes com um nome espec√≠fico, pacote </li><li>  selecione todas as classes que herdam / implementam determinadas classes / interfaces </li><li>  selecione todas as classes com modificadores espec√≠ficos e / ou anota√ß√µes espec√≠ficas </li><li>  selecione todos os m√©todos com um nome espec√≠fico, modificadores, argumentos e valor de retorno </li><li>  selecione todos os campos com um nome espec√≠fico, modificadores, de um tipo espec√≠fico. </li><li><p>  √© poss√≠vel usar curingas </p><br><p>  Mais uma vez, essa n√£o √© uma descri√ß√£o estrita do modelo; √© uma lista dos recursos que temos.  Aqui est√£o alguns exemplos: </p><br></li></ul><br><p> <code>-keep public class com.example.MyActivity</code> <br>  salvar classe <code>com.example.MyActivity</code> </p><br><p> <code>-keep public class * extends android.app.Activity</code> <br>  salve todas as classes p√∫blicas que herdam <code>android.app.Activity</code> </p><br><pre> <code class="hljs scala">-keep public <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">*</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">android</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">view</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">View</span></span></span><span class="hljs-class"> </span></span>{ public &lt;init&gt;(android.content.<span class="hljs-type"><span class="hljs-type">Context</span></span>); public &lt;init&gt;(android.content.<span class="hljs-type"><span class="hljs-type">Context</span></span>, android.util.<span class="hljs-type"><span class="hljs-type">AttributeSet</span></span>); public &lt;init&gt;(android.content.<span class="hljs-type"><span class="hljs-type">Context</span></span>, android.util.<span class="hljs-type"><span class="hljs-type">AttributeSet</span></span>, int); public void set*(...); }</code> </pre> <br><p>  encontre todas as classes p√∫blicas que herdam <code>android.view.View</code> e salve 3 construtores com determinados par√¢metros neles + todos os m√©todos p√∫blicos, com o modificador de <code>void</code> , quaisquer argumentos e um nome come√ßando com <code>set</code> .  Todas as outras partes da classe podem ser modificadas. </p><br><p> <code>-keep class com.habr.** { *; }</code> <br>  salve todas as classes e todo o seu conte√∫do no pacote <code>com.habr</code> </p><br><p>  <code>modifiers</code> - adi√ß√£o √† regra de manuten√ß√£o: </p><br><ul><li>  <code>includedescriptorclasses</code> - al√©m da classe / m√©todo / campo especificado, voc√™ precisa salvar todas as classes que ocorrem em seus descritores. </li><li>  <code>includecode</code> - o conte√∫do do m√©todo apontado por esta regra espec√≠fica tamb√©m n√£o pode ser tocado. </li><li>  <code>allowshrinking</code> - as classes apontadas por esta regra n√£o s√£o sementes e podem ser exclu√≠das, mas apenas se n√£o forem usadas no pr√≥prio programa.  No entanto, se ap√≥s a troca de c√≥digo este c√≥digo permanecer (devido ao fato de algu√©m o usar), √© imposs√≠vel otimizar / ofuscar esse c√≥digo. </li><li>  <code>allowoptimization</code> - as classes referidas por esta regra s√≥ podem ser otimizadas, mas n√£o podem ser removidas ou ofuscadas. </li><li>  <code>allowobfuscation</code> - as classes apontadas por esta regra s√≥ podem ser ofuscadas, mas n√£o podem ser removidas ou otimizadas. </li></ul><br><p>  Al√©m do <code>keep</code> , existem mais algumas op√ß√µes: </p><br><p>  <code>-keepclassmembers</code> - indica que os membros da classe devem ser salvos se a pr√≥pria classe for preservada ap√≥s a redu√ß√£o do c√≥digo. </p><br><p>  <code>-keepclasseswithmembers</code> - indica que voc√™ deseja salvar classes cujo conte√∫do se enquadra no modelo especificado.  Por exemplo, <code>-keepclasseswithmembers class * { public &lt;init&gt;(android.content.Context); }</code>  <code>-keepclasseswithmembers class * { public &lt;init&gt;(android.content.Context); }</code> - salva todas as classes que t√™m um construtor p√∫blico com um argumento do tipo <code>Context</code> . </p><br><p>  <code>-keepnames</code> - abrevia√ß√£o de <code>-keep,allowshrinking</code> . </p><br><p>  <code>-keepclassmembernames</code> - abrevia√ß√£o de <code>-keepclassmembers,allowshrinking</code> . </p><br><p>  <code>keepclasseswithmembernames</code> - abrevia√ß√£o de <code>-keepclasseswithmembers,allowshrinking</code> . </p><br><h3 id="optimisation-tuning">  Ajuste de otimiza√ß√£o </h3><br><p>  A op√ß√£o mais importante aqui √© o sinalizador <code>-dontoptimize</code> .  Se estiver presente, nenhuma otimiza√ß√£o ser√° executada e todas as outras op√ß√µes de otimiza√ß√£o ser√£o ignoradas. </p><br><p>  Existem muitas op√ß√µes de otimiza√ß√£o, mas as seguintes s√£o mais √∫teis para mim: </p><br><p>  <code>-optimizations optimization_filter</code> - listando todas as maneiras que voc√™ deseja usar.  √â melhor usar o conjunto especificado em <code>proguard-android-optimize.txt</code> ou um subconjunto dele.  Uma lista de todas as otimiza√ß√µes pode ser encontrada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . </p><br><p>  <code>-optimizationpasses n</code> - n√∫mero de ciclos de otimiza√ß√£o.  V√°rios ciclos podem melhorar o resultado.  Ao mesmo tempo, o Proguard √© inteligente o suficiente para interromper os ciclos se perceber que o resultado n√£o melhorou desde a √∫ltima vez. </p><br><p>  <code>-assumenosideeffects class_specification</code> - indica que esse m√©todo n√£o tem efeitos colaterais e retorna apenas algum valor.  O programa ir√° excluir as chamadas para esse m√©todo se detectar que o resultado retornado n√£o √© usado.  Talvez o uso mais comum dessa op√ß√£o seja excluir todos os logs de depura√ß√£o: <code>-assumenosideeffects class android.util.Log { public static int d(...); }</code> <code>-assumenosideeffects class android.util.Log { public static int d(...); }</code> </p><br><p>  <code>-allowaccessmodification</code> - mostra tudo o que est√° oculto :) Uma √≥tima op√ß√£o que permite que voc√™ se livre de <code>-allowaccessmodification</code> m√©todos acessadores artificiais para classes aninhadas.  Funciona apenas em conjunto com <code>-repackageclasses</code> </p><br><p>  <code>-repackageclasses</code> - <code>-repackageclasses</code> mover todas as classes para um pacote especificado.  Isso se aplica mais √† ofusca√ß√£o, mas, ao mesmo tempo, fornece bons resultados na otimiza√ß√£o. </p><br><h3 id="prochie-poleznye-opcii">  Outras op√ß√µes √∫teis </h3><br><p>  <code>-dontwarn</code> e <code>-dontnote</code> </p><br><p>  O programa √© muito inteligente e sempre relata lugares suspeitos durante a an√°lise de c√≥digo; √†s vezes, essas s√£o notas, √†s vezes avisos.  Se sua compila√ß√£o n√£o estiver funcionando com o Proguard ativado, leia todos os logs que produz, ele escrever√° o que deu errado e, provavelmente, at√© lhe dir√° como corrigi-lo.  Depois de ler todas as mensagens, voc√™ corrige o problema ou ignora a mensagem de uma dessas op√ß√µes se tiver certeza de que n√£o h√° nenhum problema. </p><br><p>  Por exemplo, acontece que algumas bibliotecas java usam classes de plataforma que n√£o est√£o no android.jar e o Proguard avisa sobre isso.  Se voc√™ tem certeza de que esta biblioteca funciona bem em um ambiente Android, pode desativar este aviso <code>-dontwarn java.lang.management.**</code> </p><br><p>  <code>-whyareyoukeeping class_specification</code> √© uma op√ß√£o √∫til que imprimir√° o motivo pelo qual a Proguard decidiu n√£o tocar nessa classe / m√©todo. </p><br><p>  <code>-verbose</code> - imprime logs e exce√ß√µes mais detalhados </p><br><p>  <code>-printconfiguration</code> - imprime uma lista completa de op√ß√µes de todos os arquivos de configura√ß√£o que foram usados, incluindo regras das bibliotecas e gerados atrav√©s do aapt. </p><br><p>  <code>-keepattributes SourceFile, LineNumberTable</code> - salva <code>-keepattributes SourceFile, LineNumberTable</code> (nomes de arquivos, numera√ß√£o de linhas) para poder depurar c√≥digos no IDE e obter um rastreamento de pilha significativo.  Certifique-se de adicionar esta op√ß√£o. </p><br><h3 id="praktika">  Pr√°tica </h3><br><p>  Isso geralmente acontece: ative o Proguard e ele interrompe o projeto inteiro, causando muitos erros.  Muitos nesta etapa desligam o Proguard e tentam n√£o retornar a ele.  Vou tentar dar algumas dicas para facilitar esse processo de transi√ß√£o. </p><br><h4 id="opredelitsya-s-nachalnymi-vhodnymi-tochkami">  Decida sobre os pontos de entrada iniciais </h4><br><p>  Se voc√™ √© um desenvolvedor do Android, tudo √© extremamente elementar - basta selecionar uma das duas configura√ß√µes padr√£o do SDK do Android: <code>proguard-android.txt</code> ou <code>proguard-android-optimize.txt</code> , eles cuidar√£o de tudo que deve permanecer intocado. </p><br><h4 id="proverit-vse-biblioteki">  Verifique todas as bibliotecas </h4><br><p>  Recentemente, mais e mais bibliotecas s√£o distribu√≠das com proguard-configs prontas.  O Proguard pode procurar dentro do arquivo, encontrar a configura√ß√£o da biblioteca e adicion√°-la a outras op√ß√µes.  Verifique cada biblioteca que voc√™ usa para essa configura√ß√£o. </p><br><p><img src="https://habrastorage.org/webt/rf/dq/vn/rfdqvnztj-zagmqtzwctc73x3-k.png" alt="(conte√∫do do arquivo aar de uma das bibliotecas)"><br>  (conte√∫do do arquivo aar de uma das bibliotecas) </p><br><p>  Se voc√™ usa o Google Play Services, o plug <code>com.google.gms.google-services</code> in <code>com.google.gms.google-services</code> seleciona a configura√ß√£o necess√°ria por conta pr√≥pria. </p><br><p>  Se os autores da biblioteca n√£o empacotarem a configura√ß√£o no arquivo morto, talvez tenham cuidado e tenham escrito as regras em seu site, na p√°gina do reposit√≥rio ou no arquivo README.  Tente encontrar a configura√ß√£o para a vers√£o da biblioteca que voc√™ est√° usando. </p><br><p>  Se voc√™ n√£o encontrar nenhuma regra pronta em nenhum lugar, precisar√° ler os logs e resolver o problema individualmente.  Provavelmente, voc√™ precisar√° adicionar regras de manuten√ß√£o para o c√≥digo da biblioteca que est√° quebrado.  Ou ignore os erros se eles n√£o interferirem no programa. </p><br><h4 id="provesti-inspekciyu-svoego-koda">  Inspecione seu c√≥digo </h4><br><p>  Voc√™ sabe melhor qual c√≥digo pode enviar embaixo da faca, mas observe cuidadosamente todos os locais onde a reflex√£o √© usada: </p><br><ul><li>  Class.forName (...) (a documenta√ß√£o promete que Proguard √© capaz de definir esse c√≥digo, no entanto, houve casos, vale a pena conferir) </li><li>  Modelos / classes de entidade que s√£o usados ‚Äã‚Äãna serializa√ß√£o, mapeamento.  Todas as classes cujos nomes de campo (√†s vezes as pr√≥prias classes) s√£o importantes para manter (Gson, RealmIO etc.) </li><li>  chamadas de biblioteca nativa atrav√©s de JNI </li></ul><br><h4 id="testy">  Testes </h4><br><p>  Se uma classe / m√©todo for usada apenas em testes e em nenhum outro lugar, o Proguard excluir√° esse c√≥digo.  Essa √© uma situa√ß√£o comum se voc√™ tiver TDD :) Nesse caso, tenho uma configura√ß√£o separada, onde adiciono classes que ainda n√£o est√£o integradas ao projeto, n√£o s√£o usadas em nenhum lugar, mas precisam ser testadas. </p><br><p>  No plug-in Android Gradle, al√©m das instru√ß√µes <code>proguardFiles</code> , ainda existem <code>testProguardFiles</code> .  Esta instru√ß√£o √© necess√°ria para especificar as configura√ß√µes que ser√£o aplicadas ao aplicativo de teste gerado para testar seu aplicativo quando voc√™ executar testes de instrumenta√ß√£o.  Geralmente, isso √© usado para obter a mesma otimiza√ß√£o / ofusca√ß√£o nos dois arquivos apk, para que n√£o haja dessincroniza√ß√£o entre eles.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Link</a> </p><br><h4 id="apk-analyzer">  Analisador de APK </h4><br><p>  O Android Studio tem uma √≥tima ferramenta.  Voc√™ pode abri-lo atrav√©s do Find Action -&gt; Analyze APK, ou abrindo o pr√≥prio arquivo apk no Android Studio.  O Analyzer mostra muitas informa√ß√µes √∫teis, mas agora estamos interessados ‚Äã‚Äãno c√≥digo.  Para ver o que foi empacotado em um arquivo APK, voc√™ precisa selecionar o arquivo <code>classes.dex</code> </p><br><p><img src="https://habrastorage.org/webt/go/zz/o_/gozzo_o83s3e1mknkxhqldrzr3g.png"></p><br><p>  Por padr√£o, voc√™ ver√° exatamente o c√≥digo resultante que passou nas etapas de redu√ß√£o e otimiza√ß√£o.  No entanto, voc√™ pode clicar no bot√£o <strong>Carregar mapeamentos do programa ...</strong> , adicionar <code>seeds.txt</code> e <code>usage.txt</code> para ver o c√≥digo que foi exclu√≠do. </p><br><p><img src="https://habrastorage.org/webt/gy/4a/gk/gy4agkxifirpyy95-exhk1xmguc.png"></p><br><p>  Se, por algum motivo, o Proguard modificou o c√≥digo necess√°rio, localize-o no Analyzer e selecione <strong>Gerar regra de manuten√ß√£o de programa</strong> atrav√©s do RMB.  O Analyzer gerar√° uma escolha de v√°rias op√ß√µes para as regras, da mais geral √† mais espec√≠fica, selecione <strong>UMA</strong> delas. </p><br><p><img src="https://habrastorage.org/webt/ny/zc/ob/nyzcobecp45cnrrjgq3unu3_zba.png"></p><br><p><img src="https://habrastorage.org/webt/yq/wg/0m/yqwg0mwllbw9wauhemkvffgk_h8.png"></p><br><h4 id="dlya-avtorov-bibliotek">  Para autores da biblioteca </h4><br><p>  Se voc√™ estiver criando uma biblioteca Android, poder√° adicionar uma configura√ß√£o de programa para seus clientes da seguinte maneira: </p><br><pre> <code class="hljs nginx"><span class="hljs-section"><span class="hljs-section">buildTypes</span></span> { <span class="hljs-section"><span class="hljs-section">release</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">consumerProguardFiles</span></span> <span class="hljs-string"><span class="hljs-string">'proguard-rules.pro'</span></span> } }</code> </pre> <br><p>  Na minha opini√£o, √© melhor n√£o otimizar e ofuscar sua biblioteca com zelo, mas proporcionar essa oportunidade aos seus clientes.  Um bom tom √© adicionar √† configura√ß√£o o que os clientes ainda ter√£o que adicionar se inclu√≠rem o Proguard.  No entanto, se voc√™ ainda deseja adicionar seguran√ßa, √© √≥bvio que precisa proteger toda a API pulic da sua biblioteca do Proguard, incluindo descritores e assinaturas. </p><br><h3 id="r8-dexguard-i-redex">  R8, DexGuard e Redex </h3><br><p>  R8 √© a nova ferramenta do Google para substituir o atual Proguard.  Espere, n√£o tente esquecer tudo o que acabou de ler no artigo, trate-o como o novo Proguard.  O Google promete manter toda a API p√∫blica, para que todas as configura√ß√µes funcionem como antes.  O projeto ainda est√° na vers√£o beta, mas voc√™ pode tentar voc√™ mesmo. </p><br><p>  DexGuard √© um utilit√°rio pago pelos desenvolvedores do Proguard.  Pode ser usado em conjunto ou em vez de Proguard.  Argumenta-se que o DexGuard pode fazer tudo o que Proguard pode fazer, mas melhor.  Infelizmente, n√£o tive chance de experiment√°-lo; se algu√©m tiver experi√™ncia, compartilhe. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Redex</a> √© outro otimizador de dex do Facebook.  √â relatado que com ele voc√™ pode obter um aumento de produtividade de at√© 25% e reduzir o tamanho do aplicativo aplicando a ferramenta ao c√≥digo j√° processado pela Proguard. </p><br><h2 id="vmesto-zaklyucheniya">  Em vez de uma conclus√£o </h2><br><p>  N√£o tenha medo de usar Proguard, n√£o seja pregui√ßoso e gaste algum tempo configurando.  Isso reduzir√° seu tamanho, aumentar√° a velocidade do trabalho e aumentar√° a lealdade de seus usu√°rios.  Ao mesmo tempo, tente criar configura√ß√µes eficazes do Proguard, n√£o escreva regras de "carpete"; caso contr√°rio, Jake Wharton bravo chegar√° at√© voc√™ e o repreender√°. </p><br><p><img src="https://habrastorage.org/webt/ma/tf/kz/matfkzxceoougdvn7pfyx4klnho.png"></p><br><h2 id="resursy">  Recursos </h2><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Site da Proguard</a> .  H√° tamb√©m informa√ß√µes sobre o DexGuard. <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">V√°rias regras de exemplo</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">R8</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Gravando uma apresenta√ß√£o de Como o Proguard funciona com o DroidCon</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ProGuard eficaz mant√©m regras para grava√ß√£o de apresenta√ß√£o de aplicativos menores (Google I / O '18)</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Instru√ß√µes para ativar e configurar o Proguard para Android</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">P√°gina Wiki</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Redex</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt415499/">https://habr.com/ru/post/pt415499/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt415483/index.html">7 erros comuns ao comparar seus servidores com a nuvem</a></li>
<li><a href="../pt415485/index.html">Dirija Kingston A1000 - uma ambul√¢ncia para o laptop?</a></li>
<li><a href="../pt415487/index.html">P√°ginas da hist√≥ria da Intel. Primeiro chip, Intel 3101</a></li>
<li><a href="../pt415489/index.html">Facebook fecha projeto de distribui√ß√£o da Internet por meio de drones em energia solar</a></li>
<li><a href="../pt415493/index.html">Um novo c√°lculo da f√≥rmula de Drake mostrou: a humanidade est√° sozinha em sua gal√°xia, com uma probabilidade de 53 a 99,6%</a></li>
<li><a href="../pt415501/index.html">Sal√£o virtual do Hermitage - O primeiro passo para o futuro de Pelevin</a></li>
<li><a href="../pt415503/index.html">Interface do usu√°rio NetScaler SD-WAN</a></li>
<li><a href="../pt415509/index.html">Aprendizado profundo em programa√ß√£o: o qu√™, por que e como</a></li>
<li><a href="../pt415527/index.html">Confer√™ncia DUMP 2018: v√≠deo de todos os relat√≥rios e apresenta√ß√µes</a></li>
<li><a href="../pt415529/index.html">Resumo dos eventos de TI de julho</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>