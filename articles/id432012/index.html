<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🌄 🛌🏾 🗳️ Cara menguji kontrak yang cerdas 🏏 👨‍👦‍👦 🥚</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ketentuan kontrak pintar tidak dapat diubah. Karena itu, setiap kali Anda membuat kontrak pintar, Anda perlu memastikan bahwa itu bekerja dengan benar...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Cara menguji kontrak yang cerdas</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mobileup/blog/432012/"><img src="https://habrastorage.org/webt/p5/xq/sj/p5xqsjbx3ydredj41fcohyg6jga.png" alt="gambar"><br><br>  Ketentuan kontrak pintar tidak dapat diubah.  Karena itu, setiap kali Anda membuat kontrak pintar, Anda perlu memastikan bahwa itu bekerja dengan benar.  Pengujian adalah cara yang aman untuk menguji kontrak dalam situasi yang berbeda.  Dalam tutorial ini, Anda akan mempelajari langkah-langkah apa yang harus diambil. <br><a name="habracut"></a><br>  Saya akan memberi tahu: <br><br><ol><li>  Cara menyiapkan lingkungan pengujian. </li><li>  Cara menulis tes <b>JavaScript</b> dan menjalankannya dalam <b>Truffle</b> . </li></ol><br>  Tutorial ini ditujukan untuk pemula yang baru saja mulai mempelajari pengembangan dan pengujian kontrak pintar di Ethereum.  Untuk memahami tutorial ini, Anda harus memiliki setidaknya pengetahuan dasar tentang <b>JavaScript</b> dan <b>Soliditas</b> . <br><br><h2>  1. Cara menyiapkan lingkungan pengujian </h2><br>  Ada banyak cara untuk menguji kontrak yang cerdas, tetapi <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Truffle</a></b> adalah alat penulisan tes yang paling populer menggunakan <b>JavaScript</b> .  Pada <b>Truffle,</b> Anda dapat menulis pengujian unit atau melakukan pengujian integrasi penuh dengan parameter nyata dari lingkungan produksi. <br><br>  Pertama, Anda perlu menginstal Node.js versi terbaru dari <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">situs resmi</a> . <br>  Kemudian buka terminal dan instal <b>Truffle</b> menggunakan perintah berikut: <br><br><pre><code class="plaintext hljs">npm install -g truffle</code> </pre> <br>  Setelah menginstal <b>Truffle</b> , tanpa menutup terminal, buat direktori <b>Pendanaan</b> : <br><br><pre> <code class="plaintext hljs">mkdir Funding</code> </pre> <br>  Selanjutnya, buka direktori dengan perintah: <br><br><pre> <code class="plaintext hljs">cd Funding</code> </pre> <br>  Untuk menginisialisasi direktori, jalankan perintah: <br><br><pre> <code class="plaintext hljs">truffle init</code> </pre> <br>  Setelah menjalankan perintah, folder dan file berikut ini akan dibuat di direktori <b>Pendanaan</b> : <br><br><img src="https://habrastorage.org/webt/lb/io/8k/lbio8kevpzbkkk45st2cj1xzmvw.png" alt="gambar"><br><br>  Selanjutnya kami akan bekerja dengan setiap direktori.  Sementara itu, kami terus mempersiapkan lingkungan pengujian. <br><br>  Untuk menjalankan tes, Anda perlu perpustakaan Javascript. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Mocha</a> adalah perpustakaan yang berisi fungsi umum untuk pengujian, termasuk <b>menjelaskan</b> dan <b>itu</b> . <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Chai</a> adalah perpustakaan yang mendukung berbagai fungsi untuk pemeriksaan.  Ada "gaya" yang berbeda untuk memeriksa hasil, dan Chai memberi kita kesempatan ini.  Dalam tutorial kita akan menggunakan <b>Harus</b> . <br><br>  Secara default, Mocha adalah bagian dari Truffle, kita dapat dengan mudah menggunakan fungsi perpustakaan.  Chai harus diinstal secara manual.  Untuk melakukan ini, gunakan terminal dan di direktori root proyek, jalankan perintah: <br><br><pre> <code class="plaintext hljs">npm install chai</code> </pre> <br>  Saya juga menginstal <b>perpustakaan chai-bignumber</b> untuk membandingkan angka dengan presisi sewenang-wenang: <br><br><pre> <code class="plaintext hljs">npm install --save-dev chai-bignumber</code> </pre> <br>  Lingkungan pengujian siap untuk ini.  Sekarang Anda dapat mulai mengembangkan kontrak yang cerdas dan mengujinya. <br><br><h2>  2. Cara menulis tes JavaScript dan menjalankannya dalam Truffle </h2><br>  Untuk mengembangkan tes, Anda memerlukan kontrak yang cerdas.  Kami akan mengembangkan kontrak yang memungkinkan Anda untuk mengumpulkan sumbangan, menetapkan jumlah tertentu untuk mencapai pengumpulan dan menarik dana.  Jika seseorang menyumbang lebih banyak, perbedaan antara jumlah yang telah diakumulasikan dan jumlah yang perlu dikumpulkan akan dikembalikan kepadanya. <br><br>  Pergi ke direktori <b>Pendanaan -&gt; kontrak</b> .  Dalam <b>Pendanaan / kontrak,</b> buat file <b>Funding.sol</b> dengan ekstensi <b>.sol</b> - ini akan menjadi kontrak cerdas untuk pengujian. <br><br>  Di <b>Funding.sol,</b> tambahkan kode berikut: <br><br><pre> <code class="javascript hljs">pragma solidity <span class="hljs-number"><span class="hljs-number">0.4</span></span><span class="hljs-number"><span class="hljs-number">.24</span></span>; contract Funding { uint public raised; uint public goal; address public owner; event Donated(uint donation); event Withdrew(uint amount); modifier onlyOwner() { <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(owner == msg.sender); _; } modifier isFinished() { <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(isFunded()); _; } modifier notFinished() { <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(!isFunded()); _; } <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span> (uint _goal) public { owner = msg.sender; goal = _goal; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isFunded</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">view</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returns</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">bool</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> raised &gt;= goal; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">donate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">payable</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">notFinished</span></span></span><span class="hljs-function"> </span></span>{ uint refund; raised += msg.value; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (raised &gt; goal) { refund = raised - goal; raised -= refund; msg.sender.transfer(refund); } emit Donated(msg.value); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">withdraw</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onlyOwner</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isFinished</span></span></span><span class="hljs-function"> </span></span>{ uint amount = address(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>).balance; owner.transfer(amount); emit Withdrew(amount); } }</code> </pre><br>  Kontrak sudah siap.  Kami akan menggunakan kontrak pintar melalui migrasi. <br><br>  Migrasi adalah file <b>JavaScript</b> yang membantu Anda menggunakan kontrak di jaringan Ethereum.  Ini adalah cara utama untuk menyebarkan kontrak. <br><br>  Buka direktori <b>Pendanaan -&gt; migrasi</b> dan buat file <b>2_funding.js</b> , tambahkan kode berikut ke dalamnya: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Funding = artifacts.require(<span class="hljs-string"><span class="hljs-string">"./Funding.sol"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ETHERS = <span class="hljs-number"><span class="hljs-number">10</span></span>**<span class="hljs-number"><span class="hljs-number">18</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> GOAL = <span class="hljs-number"><span class="hljs-number">20</span></span> * ETHERS; <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">deployer</span></span></span><span class="hljs-function">) </span></span>{ deployer.deploy(Funding, GOAL); };</code> </pre> <br>  Untuk menjalankan tes, Anda harus menggunakan perintah <b>tes truffle</b> .  Di terminal, buka akar direktori <b>Pendanaan</b> , yang dibuat selama persiapan lingkungan pengujian dan masukkan: <br><br><pre> <code class="plaintext hljs">truffle test</code> </pre> <br>  Jika output berikut muncul di terminal, maka semuanya dilakukan dengan benar: <br><br><img src="https://habrastorage.org/webt/yi/gn/wp/yignwpfhoay4uojgfxixff6twew.png" alt="gambar"><br><br>  Sekarang mari kita mulai menulis tes. <br><br><h3>  Verifikasi Pemilik </h3><br><br>  Pergi ke direktori <b>tes Pendanaan -&gt;</b> dan buat file <b>test_funding.js</b> dengan ekstensi <b>.js</b> .  Ini adalah file di mana tes akan ditulis. <br><br>  Tambahkan kode berikut ke file <b>test_funding.js</b> : <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Funding = artifacts.require(<span class="hljs-string"><span class="hljs-string">"Funding"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"chai"</span></span>).use(<span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"chai-bignumber"</span></span>)(web3.BigNumber)).should(); contract(<span class="hljs-string"><span class="hljs-string">"Funding"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[account, firstDonator, secondDonator]</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ETHERS = <span class="hljs-number"><span class="hljs-number">10</span></span>**<span class="hljs-number"><span class="hljs-number">18</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> GAS_PRICE = <span class="hljs-number"><span class="hljs-number">10</span></span>**<span class="hljs-number"><span class="hljs-number">6</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> fundingContract = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; it(<span class="hljs-string"><span class="hljs-string">"should check the owner is valid"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { fundingContract = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> Funding.deployed(); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> owner = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fundingContract.owner.call() owner.should.be.bignumber.equal(account); });</code> </pre><br>  Dalam pengujian, kami memverifikasi bahwa kontrak <b>Pendanaan</b> menyimpan alamat pemilik yang menyebarkan kontrak.  Dalam kasus kami, <b>akun</b> adalah elemen pertama dari array.  <b>Truffle</b> memungkinkan Anda untuk menggunakan hingga sepuluh alamat, dalam pengujian kami hanya membutuhkan tiga alamat. <br><br><h3>  Penerimaan sumbangan dan verifikasi akhir penggalangan dana </h3><br>  Di bagian ini kami akan memeriksa: <br><br><ol><li>  Penerimaan dan jumlah donasi. </li><li>  Apakah sejumlah donasi telah tercapai. </li><li>  Apa yang terjadi jika Anda menyumbang lebih dari yang perlu Anda kumpulkan. </li><li>  Jumlah total donasi. </li><li>  Dapatkah saya terus mengumpulkan dana jika jumlah yang diminta telah dikumpulkan. </li></ol><br>  Kami akan menulis dan menganalisis tes: <br><br><pre> <code class="javascript hljs">. . . . . . . . . . . . . . . . . . . . . . const ETHERS = <span class="hljs-number"><span class="hljs-number">10</span></span>**<span class="hljs-number"><span class="hljs-number">18</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> GAS_PRICE = <span class="hljs-number"><span class="hljs-number">10</span></span>**<span class="hljs-number"><span class="hljs-number">6</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> fundingContract = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> txEvent; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findEvent</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">logs, eventName</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> log <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> logs) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (log.event === eventName) { result = log; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }; it(<span class="hljs-string"><span class="hljs-string">"should accept donations from the donator #1"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> bFirstDonator= web3.eth.getBalance(firstDonator); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> donate = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fundingContract.donate({ <span class="hljs-attr"><span class="hljs-attr">from</span></span>: firstDonator, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-number"><span class="hljs-number">5</span></span> * ETHERS, <span class="hljs-attr"><span class="hljs-attr">gasPrice</span></span>: GAS_PRICE }); txEvent = findEvent(donate.logs, <span class="hljs-string"><span class="hljs-string">"Donated"</span></span>); txEvent.args.donation.should.be.bignumber.equal(<span class="hljs-number"><span class="hljs-number">5</span></span> * ETHERS); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> difference = bFirstDonator.sub(web3.eth.getBalance(firstDonator)).sub(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> web3.BigNumber(donate.receipt.gasUsed * GAS_PRICE)); difference.should.be.bignumber.equal(<span class="hljs-number"><span class="hljs-number">5</span></span> * ETHERS); });</code> </pre><br>  Sebelum menguraikan tes, saya ingin mencatat 2 poin: <br><br><ol><li>  Untuk mencari peristiwa (events) dan memeriksa argumennya, fungsi <b>findEvent</b> kecil ditulis. </li><li>  Untuk kenyamanan pengujian dan perhitungan, nilai intrinsik untuk gas ditetapkan (GAS_PRICE konstan). </li></ol><br>  Sekarang mari kita menganalisis tesnya.  Dalam tes, kami memeriksa: <br><br><ul><li>  bahwa kami dapat menerima donasi dengan memanggil metode <b>donate ()</b> ; </li><li>  bahwa jumlah yang disumbangkan kepada kami ditunjukkan dengan benar; </li><li>  bahwa orang yang menyumbangkan dana, saldo menurun dengan jumlah yang disumbangkan. </li></ul><br><pre> <code class="javascript hljs">it(<span class="hljs-string"><span class="hljs-string">"should check if donation is not completed"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> isFunded = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fundingContract.isFunded(); isFunded.should.be.equal(<span class="hljs-literal"><span class="hljs-literal">false</span></span>); });</code> </pre><br>  Dalam tes ini, kami memeriksa bahwa penggalangan dana belum selesai. <br><br><pre> <code class="javascript hljs">it(<span class="hljs-string"><span class="hljs-string">"should not allow to withdraw the fund until the required amount has been collected"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> isCaught = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fundingContract.withdraw({ <span class="hljs-attr"><span class="hljs-attr">gasPrice</span></span>: GAS_PRICE }); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (err) { isCaught = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } isCaught.should.be.equal(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); });</code> </pre> <br>  Dalam tes kami memeriksa bahwa kami tidak dapat menarik dana sampai jumlah yang kami butuhkan dikumpulkan. <br><br><pre> <code class="javascript hljs">it(<span class="hljs-string"><span class="hljs-string">"should accept donations from the donator #2"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> bSecondDonator= web3.eth.getBalance(secondDonator); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> donate = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fundingContract.donate({ <span class="hljs-attr"><span class="hljs-attr">from</span></span>: secondDonator, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-number"><span class="hljs-number">20</span></span> * ETHERS, <span class="hljs-attr"><span class="hljs-attr">gasPrice</span></span>: GAS_PRICE }); txEvent = findEvent(donate.logs, <span class="hljs-string"><span class="hljs-string">"Donated"</span></span>); txEvent.args.donation.should.be.bignumber.equal(<span class="hljs-number"><span class="hljs-number">20</span></span> * ETHERS); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> difference = bSecondDonator.sub(web3.eth.getBalance(secondDonator)).sub(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> web3.BigNumber(donate.receipt.gasUsed * GAS_PRICE)); difference.should.be.bignumber.equal(<span class="hljs-number"><span class="hljs-number">15</span></span> * ETHERS); });</code> </pre><br>  Dalam tes kami memeriksa bahwa jika Anda menyumbangkan jumlah besar, metode <b>donate ()</b> menghitung dan mengembalikan dana kepada orang yang menyumbang lebih dari yang diperlukan.  Jumlah ini adalah perbedaan antara jumlah yang diakumulasikan dan jumlah yang ingin Anda kumpulkan. <br><br><pre> <code class="javascript hljs">it(<span class="hljs-string"><span class="hljs-string">"should check if the donation is completed"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> notFunded = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fundingContract.isFunded(); notFunded.should.be.equal(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); }); it(<span class="hljs-string"><span class="hljs-string">"should check if donated amount of money is correct"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> raised = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fundingContract.raised.call(); raised.should.be.bignumber.equal(<span class="hljs-number"><span class="hljs-number">20</span></span> * ETHERS); }); it(<span class="hljs-string"><span class="hljs-string">"should not accept donations if the fundraising is completed"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> isCaught = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fundingContract.donate({ <span class="hljs-attr"><span class="hljs-attr">from</span></span>: firstDonator, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span> * ETHERS }); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (err) { isCaught = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } isCaught.should.be.equal(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); });</code> </pre><br>  Dalam tiga tes ini, kami memeriksa: <br><br><ul><li>  bahwa penggalangan dana selesai; </li><li>  bahwa jumlah donasi sudah benar; </li><li>  bahwa tidak ada orang lain yang dapat menyumbang, karena penggalangan dana telah selesai. </li></ul><br><h3>  Tarik dana </h3><br>  Di bagian tutorial sebelumnya, kami mengumpulkan jumlah yang kami butuhkan, sekarang dapat ditampilkan: <br><br><pre> <code class="javascript hljs"> . . . . . . . . . . . . . . . . . . . . . . it(<span class="hljs-string"><span class="hljs-string">"should allow the owner to withdraw the fund"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> bAccount = web3.eth.getBalance(account); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> withdraw = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fundingContract.withdraw({ <span class="hljs-attr"><span class="hljs-attr">gasPrice</span></span>: GAS_PRICE }); txEvent = findEvent(withdraw.logs, <span class="hljs-string"><span class="hljs-string">"Withdrew"</span></span>); txEvent.args.amount.should.be.bignumber.equal(<span class="hljs-number"><span class="hljs-number">20</span></span> * ETHERS); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> difference = web3.eth.getBalance(account).sub(bAccount); difference.should.be.bignumber.equal(<span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fundingContract.raised.call() - withdraw.receipt.gasUsed * GAS_PRICE); });</code> </pre><br>  Dengan memanggil fungsi <b>withdraw ()</b> , kami menarik dana pemilik kontrak pintar, dalam <b>akun</b> kasing kami.  Kemudian kami memeriksa bahwa kami benar-benar menarik jumlah yang kami butuhkan.  Untuk melakukan ini, <b>tulis</b> perbedaan dalam saldo sebelum dan sesudah penarikan dana ke dalam <b>perbedaan</b> konstan.  Hasilnya dibandingkan dengan jumlah donasi dikurangi biaya transaksi.  Seperti disebutkan di atas, untuk kenyamanan pengujian dan perhitungan, saya menetapkan harga <b>gas</b> saya sendiri. <br><br>  Jalankan tes tertulis dengan perintah <b>tes truffle</b> .  Jika semuanya dilakukan dengan benar, hasilnya harus sebagai berikut: <br><br><img src="https://habrastorage.org/webt/3n/jp/jr/3njpjroqs-jqwzfuejzkqu4neuk.png" alt="gambar"><br><br><h3>  Hasil </h3><br>  Saya mencoba menggambarkan langkah-langkah pengujian kontrak cerdas dalam bahasa yang sederhana dan mudah dipahami: mulai dari mempersiapkan lingkungan pengujian hingga menulis tes itu sendiri. <br><br>  Sekarang Anda dapat menguji kontrak pintar apa pun dan memastikannya berfungsi dengan benar. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id432012/">https://habr.com/ru/post/id432012/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id431998/index.html">Temui Yandex.Phone - sekarang resmi</a></li>
<li><a href="../id432002/index.html">Microsoft sedang mengembangkan browser berbasis Chromium, yang akan dikirimkan secara default, bukan Edge</a></li>
<li><a href="../id432004/index.html">Pengantar pemrograman reaktif</a></li>
<li><a href="../id432006/index.html">Kisah bagaimana saya masuk ke topik kesehatan wanita</a></li>
<li><a href="../id432008/index.html">Mengejar Standar Web</a></li>
<li><a href="../id432014/index.html">Kali Linux untuk pemula</a></li>
<li><a href="../id432016/index.html">Bagaimana musik dan menggambar mengajari saya cara memprogram</a></li>
<li><a href="../id432020/index.html">Replikasi berantai: membangun repositori KV yang efisien (bagian 2/2)</a></li>
<li><a href="../id432022/index.html">Forkney it: 8 Go projects yang menarik untuk digali ke dalam kode sumber</a></li>
<li><a href="../id432024/index.html">Gradle 5.0 - apa yang baru</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>