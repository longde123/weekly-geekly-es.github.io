<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèø‚Äçüîß üíü üÜô Bus PCIe: ¬ølas limitaciones f√≠sicas afectan la velocidad de transferencia? üè° üõ´ üê∑</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Comenzar√© desde lejos. El invierno pasado hice un dispositivo USB con un n√∫cleo alojado en la FPGA. Por supuesto, realmente quer√≠a comprobar el ancho ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Bus PCIe: ¬ølas limitaciones f√≠sicas afectan la velocidad de transferencia?</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/414753/">  Comenzar√© desde lejos.  El invierno pasado hice un dispositivo USB con un n√∫cleo alojado en la FPGA.  Por supuesto, realmente quer√≠a comprobar el ancho de banda real de este bus.  Despu√©s de todo, en el controlador, hay mucho que hacer.  Siempre se puede decir que hay un retraso, o por all√°.  En el caso de los FPGA, veo un bloque que bombea datos, por lo que me dijo que hay datos en √©l.  Pero configur√© que todo se proces√≥ y estoy listo para aceptar una nueva porci√≥n (al mismo tiempo, ya recibe datos en el segundo b√∫fer del mismo punto final).  Genial, configure la preparaci√≥n desde la primera medida y vea qu√© sucede cuando el USB puede "martillar" sin detenerse. <br><br><img src="https://habrastorage.org/webt/ab/ft/n3/abftn3olrakrhdj3zztrcksut5k.jpeg"><br><a name="habracut"></a><br>  Pero resulta una cosa asombrosa.  Si el dispositivo USB 2.0 est√° atascado en el conector "azul" (que es USB 3.0), entonces la velocidad es una.  Si en "negro" - otro.  Aqu√≠ est√° mi gr√°fico de velocidad de grabaci√≥n USB versus longitud de datos.  USB3 y USB2 son el tipo de conector; el dispositivo siempre es USB 2.0 HS. <br><br><img src="https://habrastorage.org/webt/ea/sg/ja/easgjasaj1jbzovcsgbiymhploa.png"><br><br>  Lo intent√© en diferentes m√°quinas.  El resultado est√° cerca.  Nadie podr√≠a explicarme este fen√≥meno.  M√°s tarde, encontr√© la raz√≥n m√°s probable.  Y la raz√≥n es muy simple.  Estas son las propiedades del controlador USB 2.0: <br><br><img src="https://habrastorage.org/webt/2y/ek/xl/2yekxlpcnthq8p06z8wpxxasjgo.png"><br><br>  Los controladores que controlan el conector "azul" no lo hacen.  Y la diferencia es solo un 20 por ciento. <br><br>  De esto concluimos que las limitaciones de ancho de banda no siempre est√°n determinadas por las propiedades f√≠sicas del bus.  A veces se superponen algunas otras cosas.  Pasamos con este conocimiento en estos d√≠as. <br><br><h2>  Experimento primario </h2><br>  Entonces  Todo comenz√≥ bastante mundano.  Hubo un chequeo de un programa.  Se verific√≥ el proceso de escribir datos en varios discos simult√°neamente.  El hardware es simple: hay una placa base con cuatro ranuras PCIe.  Se insertan tarjetas absolutamente id√©nticas con controladores AHCI en todas las ranuras, cada una de las cuales admite exclusivamente PCIe x1. <br><br><img src="https://habrastorage.org/webt/4k/il/lz/4killzfbtb9r6evuybrs68e6xl0.jpeg"><br><br>  Cada tarjeta sirve 4 unidades. <br>  Y luego se revela el siguiente efecto.  Tomamos un disco y comenzamos a escribirle datos.  Obtenemos una velocidad de 180 a 220 megabytes por segundo (en adelante, los megabytes son 1024 * 1024 bytes): <br><br><img src="https://habrastorage.org/webt/we/cu/uy/wecuuyqewi743lh6kcxiqgpkk5i.png"><br><br>  Tomamos el segundo disco.  La velocidad de escritura es de 170 a 190 MB / s: <br><br><img src="https://habrastorage.org/webt/cs/0o/g7/cs0og7k2kztps5h2vgvw7yfsrno.png"><br><br>  Escribimos inmediatamente a ambos: obtenemos una reducci√≥n de velocidad: <br><br><img src="https://habrastorage.org/webt/xz/at/nk/xzatnk1bt2sog8qsvkjaryf34j0.png"><br><br>  La velocidad total es de alrededor de 290 MB / s.  Pero lo sorprendente es que depuramos (por lo que result√≥) este programa en las mismas unidades, pero en otros canales.  Y todo estuvo bien all√≠.  Nos transferimos r√°pidamente a esos canales (pasar√°n por otra tarjeta), obtenemos un excelente trabajo: <br><br><img src="https://habrastorage.org/webt/xd/jj/qo/xdjjqomypz-hhmaq6yt73wtoai4.png"><br><br><h2>  Comprar√© una ranura en una buena zona </h2><br>  Debo decir de inmediato que no vale la pena culpar de todo a los componentes de otra persona.  Todo aqu√≠ lo escribimos nosotros, comenzando desde el programa en s√≠, terminando con los controladores.  Por lo tanto, se puede monitorear toda la ruta de datos.  Lo desconocido se produce solo cuando la solicitud se envi√≥ al hardware. <br><br>  Despu√©s del an√°lisis inicial, result√≥ que la velocidad no est√° limitada en las ranuras PCIe "largas" y est√° limitada en las "cortas".  Las largas son donde puedes insertar tarjetas x16 (aunque una de ellas funciona en modo no superior a x4), y las cortas son solo para tarjetas x1. <br><br><img src="https://habrastorage.org/webt/38/kt/jt/38ktjtqf38knqdotsc3gxacmqos.jpeg"><br><br>  Todo estar√≠a bien, pero los controladores en las tarjetas actuales, en principio, no pueden funcionar en un modo que no sea PCIex1.  Es decir, todos los controladores deben estar en condiciones absolutamente id√©nticas, independientemente de la longitud de la ranura.  Pero no  Quien vive en el "largo" - trabaja r√°pido, quien en el "corto" - lentamente.  Bueno  Y r√°pido, ¬øqu√© tan r√°pido?  Agregue un tercer disco, escriba en los tres. <br><br>  En las ranuras "cortas", el l√≠mite sigue siendo de alrededor de 290 MB / s: <br><br><img src="https://habrastorage.org/webt/i-/ti/jr/i-tijrldg-h9izkdypn5iyzir8k.png"><br><br>  En el "largo" - en la regi√≥n de 400 MB / s: <br><br><img src="https://habrastorage.org/webt/qh/gn/w_/qhgnw_p59bewkzpoj8o0i8jexns.png"><br><br><img src="https://habrastorage.org/webt/oh/yz/gt/ohyzgt_cbix1f8uufh8-s5dnazk.png"><br><br>  Busqu√© en todo Internet.  En primer lugar, despu√©s de un tiempo, ya me re√≠ de los art√≠culos en los que dice que el rendimiento de PCIe gen 1 y gen 2 para x1 es de 250 y 500 MB / s.  Estos son megabytes sin procesar.  Debido a la sobrecarga (uso esta palabra no rusa para denotar un intercambio de servicios que va en la misma l√≠nea que los datos principales) para la generaci√≥n 2 obtenemos exactamente 400 megabytes por segundo de flujo √∫til.  En segundo lugar, tercamente no pude encontrar nada sobre el n√∫mero m√°gico 290 (mirando hacia el futuro, todav√≠a no lo he encontrado). <br><br>  Genial  Tratando de ver la topolog√≠a de la inclusi√≥n de nuestros controladores.  Aqu√≠ est√° (013-015: estos son los sufijos de los nombres de dispositivos con los que los combin√© para distinguirlos de alguna manera).  El verde es r√°pido, el rojo es lento. <br><br><img src="https://habrastorage.org/webt/ae/xo/3o/aexo3oqtd-c7caogtc-bthelriq.png"><br><br>  El controlador "015" ni siquiera lo consideramos.  Vive en una ranura privilegiada dise√±ada para una tarjeta de video.  Pero el 013 est√° conectado al mismo interruptor que el 012 del 014.  ¬øC√≥mo es √©l diferente? <br><br>  Algunos art√≠culos dicen que las diferentes tarjetas pueden diferir en la configuraci√≥n de Max Payload.  Estudi√© el espacio de configuraci√≥n de todas las tarjetas: este par√°metro es para todos en el mismo valor m√≠nimo posible.  Adem√°s, la documentaci√≥n para el conjunto de chips de esta placa base dice que no puede haber otro significado. <br><br><img src="https://habrastorage.org/webt/ch/tg/iv/chtgivqtyksowq7blomsrtpmija.png"><br><br>  En general, rebusqu√© en todo el espacio de configuraci√≥n: todo est√° configurado de manera id√©ntica.  ¬°Y la velocidad es diferente!  Vuelva a leer repetidamente la documentaci√≥n del conjunto de chips, sin configuraciones de ancho de banda.  Prioridades: s√≠, se ha escrito algo sobre ellos, ¬°pero las pruebas se realizan en ausencia total de carga en otros canales!  Es decir, no est√° en ellos. <br><br>  Por si acaso, incluso apagu√© el programa de interrupci√≥n.  La carga del procesador ha aumentado a cantidades incre√≠bles, porque ahora lee constantemente el bit de preparaci√≥n, pero las lecturas de velocidad no han cambiado.  Por lo tanto, es imposible culpar a este subsistema por los problemas. <br><br><h2>  ¬øY qu√© hay de otras tablas? </h2><br>  Intentamos cambiar la placa base exactamente a la misma.  No hay cambio  Intentaron reemplazar el procesador (hab√≠a razones para creer que era basura).  Adem√°s, no hay cambios en la velocidad (pero el antiguo procesador realmente basura).  Instalamos una placa base de nueva generaci√≥n: todo vuela en todas las ranuras.  Adem√°s, la velocidad m√°xima ya no es 400, sino 418 megabytes por segundo, incluso en ranuras "largas", incluso en ranuras "cortas": <br><br><img src="https://habrastorage.org/webt/kk/ct/yp/kkctypau1u3bn-klc-4bxzrgptk.png"><br><br>  Pero aqu√≠, no hay milagros.  Con el movimiento habitual de la mano (ya acostumbrado a estos d√≠as), leemos el espacio de configuraci√≥n y vemos que el par√°metro Max Payload no est√° configurado en 128, sino en 256 bytes. <br><br>  Tama√±o de paquete m√°s grande: menos paquetes.  Menos gastos generales para enviarlos: m√°s datos √∫tiles logran ejecutarse al mismo tiempo.  Eso es correcto <br><br><h2>  Entonces, ¬øqui√©n tiene la culpa? </h2><br>  No dar√© una respuesta exacta a la pregunta del t√≠tulo, con referencia a los documentos.  Pero mi pensamiento sigui√≥ el siguiente camino: digamos que la restricci√≥n de flujo se establece dentro del conjunto de chips.  No se puede programar, est√° ajustado firmemente, pero lo est√°.  Por ejemplo, es igual a 290 megabytes por segundo para cada diferencia.  una pareja  M√°s: ya est√° cortado en alg√∫n lugar dentro del chipset en sus mecanismos internos.  Por lo tanto, en la ranura "larga" (donde puede pegar tarjetas de hasta x4), no se corta nada para nuestra tarjeta dentro del chipset, y descansamos contra el l√≠mite f√≠sico del bus x1.  En el conector "corto", nos encontramos con esta limitaci√≥n. <br><br>  De hecho, verificar esto no es f√°cil, pero s√≠ muy simple.  Nos quedamos en la ranura 013, no AHCI, sino en el controlador SAS, que sirve 8 unidades a la vez y puede funcionar en modos PCIe hasta x4.  Le conectamos 4 unidades SSD inteligentes.  Observamos la velocidad de grabaci√≥n, tanto como el alma se regocija: <br><br><img src="https://habrastorage.org/webt/zo/hr/tv/zohrtvdgopxxvrgoavusiehb4mq.png"><br><br>  Ahora agregamos esos 4 discos que aparecieron en las primeras pruebas.  Rendimiento SSD previsiblemente bajado: <br><br><img src="https://habrastorage.org/webt/28/wp/hg/28wphgyghw6aaea9y3ddilidzc0.png"><br><br>  Calculamos la velocidad total que pasa a trav√©s del controlador SAS, obtenemos 1175 megabytes por segundo.  Dividir por 4 (tantas l√≠neas van a la ranura "larga"), obtenemos ... Rollo de bater√≠a ... 293 megabytes por segundo.  ¬°En alg√∫n lugar ya vi este n√∫mero! <br><br>  Por lo tanto, en el marco de este proyecto, se demostr√≥ que el problema no est√° en nuestro programa o controlador, sino en las extra√±as limitaciones del conjunto de chips, que probablemente est√©n "cableados".  Se desarroll√≥ la metodolog√≠a para seleccionar placas base que se pueden utilizar en el proyecto.  Pero en general, sacamos las siguientes conclusiones. <br><br><h2>  Conclusi√≥n </h2><br><ul><li>  A menudo, en la vida real, el equipo tiene menos rendimiento de lo te√≥ricamente posible.  Los controladores pueden incluso imponer restricciones, como se muestra en el caso de USB.  A veces es posible recoger equipos que (o cuyos conductores) no tienen tales restricciones. </li><li>  Las limitaciones pueden incluso ser indocumentadas, pero claramente expresadas. </li><li>  Una gran cantidad de art√≠culos que dicen que un par diferencial de gen PCIe.  1 y gen 2 da aproximadamente 250 y 500 megabytes por segundo, son err√≥neos.  Copian el mismo error entre s√≠: un megabyte de datos sin procesar por segundo.  La sobrecarga se acumula en varios niveles de la interfaz.  Con una carga √∫til m√°xima de 128 bytes, PCIe gen2 en realidad obtiene alrededor de 400 megabytes por segundo.  En las nuevas generaciones de PCIe, todo deber√≠a ser un poco mejor, ya que la codificaci√≥n f√≠sica no es 8b / 10b, sino m√°s econ√≥mica, pero hasta ahora no se ha encontrado un controlador de unidad para verificar esto en la pr√°ctica. </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es414753/">https://habr.com/ru/post/es414753/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es414743/index.html">Localizaci√≥n: caso flojo</a></li>
<li><a href="../es414745/index.html">#BigGun. El cron√≥grafo "frame" m√°s simple en Arduino (medici√≥n de velocidad de bala)</a></li>
<li><a href="../es414747/index.html">SNC, drogas y rock and roll: una historia sobre un dispositivo que nos hizo beber, no dormir y no parpadear</a></li>
<li><a href="../es414749/index.html">Set de caballero sysadmin</a></li>
<li><a href="../es414751/index.html">Domando WSUS con Ansible y m√°s</a></li>
<li><a href="../es414755/index.html">Hackathon es la soluci√≥n al problema.</a></li>
<li><a href="../es414757/index.html">Formato de presentaci√≥n moderno</a></li>
<li><a href="../es414759/index.html">Competencia de servlet</a></li>
<li><a href="../es414761/index.html">5 sitios de noticias creativas en ingl√©s</a></li>
<li><a href="../es414763/index.html">Cuatro tipos de errores del gerente de producto que pueden (y deben) evitarse</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>