<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§öüèΩ üòÇ üêé Bibliotecas PHP para com√©rcio eletr√¥nico: trabalhando com ATOL e Payture, analisando c√≥digos GS1 e outras tarefas üë®‚Äçüè≠ üë©‚Äçüë©‚Äçüëß‚Äçüëß üå≤</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√°, meu nome √© Pavel Savelyev, sou o chefe do departamento de automa√ß√£o de processos de neg√≥cios da Lamoda. Trabalhamos com tarefas muito diferentes ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Bibliotecas PHP para com√©rcio eletr√¥nico: trabalhando com ATOL e Payture, analisando c√≥digos GS1 e outras tarefas</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/lamoda/blog/466039/">  Ol√°, meu nome √© Pavel Savelyev, sou o chefe do departamento de automa√ß√£o de processos de neg√≥cios da Lamoda.  Trabalhamos com tarefas muito diferentes e tentamos escolher as ferramentas mais convenientes para cada uma.  Conseq√ºentemente, usamos linguagens diferentes - em nossos sistemas, voc√™ pode encontrar Java, Go e um pouco de Kotlin para Android.  Ao mesmo tempo, uma parte significativa do desenvolvimento √© conduzida em PHP; nele s√£o escritas mais de duas d√∫zias de servi√ßos que automatizam n√£o apenas o trabalho com pedidos, mas tamb√©m os processos operacionais de uma ampla rede de entrega, call centers em tr√™s pa√≠ses e nosso pr√≥prio est√∫dio de fotografia, al√©m de fornecer tudo isso na forma servi√ßos aos nossos parceiros B2B.  Esses servi√ßos s√£o suportados e desenvolvidos por 5 equipes de desenvolvimento de nosso departamento. <br><br><img src="https://habrastorage.org/webt/vv/vz/ia/vvvziajvf5uazdok_tjzpzs-5ae.png" alt="imagem"><br><br>  √Ä medida que os pr√≥prios servi√ßos e a infraestrutura ao redor deles se desenvolvem, tarefas semelhantes ocorrem com mais frequ√™ncia nesses sistemas, como efetuar login no CLS (Sistema de Log Centralizado) comum, testar o armazenamento de arquivos, coletar m√©tricas para o Prometheus e outros.  Tentamos padronizar maneiras de resolver esses problemas e usar componentes comuns para diferentes sistemas. <br><a name="habracut"></a><br><blockquote>  Quando uma das equipes se depara com a adapta√ß√£o ou integra√ß√£o de um novo servi√ßo / ferramenta que pode se tornar comum a todos, iniciamos o desenvolvimento da biblioteca nessa equipe.  E o componente final √© preparado para reutiliza√ß√£o futura e apresentado em dom√≠nio p√∫blico. <br></blockquote><br>  Portanto, como esse processo ocorre regularmente conosco, criamos uma diretriz que nos permite conduzi-lo com menos esfor√ßo - tentarei relatar isso em uma das pr√≥ximas confer√™ncias. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Mais de duas d√∫zias de nossas bibliotecas PHP</a> foram disponibilizadas publicamente no GitHub.  E planejamos nos espalhar ainda mais.  Porque  Bem, investimos muitos recursos e (quero acreditar) se sa√≠ram bem.  Esperamos astutamente que outros desenvolvedores usem nossas bibliotecas, os ajudem a finalizar e a desenvolver mais, em vez de gastar tempo escrevendo seus an√°logos do zero.  Neste artigo, quero falar brevemente sobre sete bibliotecas projetadas para resolver problemas comuns para tarefas de com√©rcio eletr√¥nico - ficarei feliz se elas forem √∫teis para voc√™ e ficarei ainda mais feliz em desenvolv√™-las juntas :) <br><br><h2>  1. Fiscaliza√ß√£o online: um cliente para o ATOL Online </h2><br>  Como outras empresas russas, somos obrigados a cumprir totalmente os requisitos do FZ-54, um dos quais √© a fiscaliza√ß√£o online.  Todos os pedidos pr√©-pagos no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">lamoda.ru</a> s√£o sempre fiscalizados: eles geram cheques on-line que s√£o enviados aos clientes.  Nosso servi√ßo de fiscaliza√ß√£o funciona pela API com o sistema <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ATOL Online,</a> e a primeira <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">biblioteca</a> da nossa lista √© um cliente completo para esse servi√ßo.  Al√©m da pr√≥pria biblioteca, tamb√©m publicamos um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">pacote</a> , com o qual voc√™ pode conect√°-lo facilmente a qualquer projeto baseado na estrutura do Symfony.  A pr√≥pria biblioteca pode ser incorporada em qualquer outra estrutura PHP: Laravel, Yii, etc. - basta escrever um "wrapper" para a biblioteca. <br><br><h2>  2. Pagamentos pr√©-pagos: intera√ß√£o com o Payture </h2><br>  Para processar pagamentos pr√©-pagos, interagimos ativamente com o servi√ßo Payture.  Este servi√ßo possui v√°rias interfaces de software.  Usamos a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">op√ß√£o Payture InPay</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">criamos</a> nosso pr√≥prio <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">cliente de API</a> para isso.  A biblioteca permite manipular v√°rios terminais, suporta o registro PSR-3 padr√£o.  Tamb√©m √© poss√≠vel usar o cliente Guzzle pr√©-configurado - isso facilita a organiza√ß√£o de testes usando o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Guzzle Mock Handler</a> . <br><br>  Nosso pacote de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">bibliotecas</a> fornece uma configura√ß√£o sem√¢ntica de terminais e permite que voc√™ defina convenientemente as configura√ß√µes do cliente (at√© o momento, apenas o tempo limite) para v√°rias opera√ß√µes da API. <br><br><h2>  3. Rotulagem do produto: Analisador de c√≥digo GS1 Datamatrix </h2><br>  Um dos projetos mais importantes de 2019 em nossa empresa √© o suporte √† rotulagem estadual de mercadorias.  Como parte deste projeto, c√≥digos exclusivos especiais ser√£o aplicados a todos os produtos de determinadas categorias - no formato GS1 Datamatrix.  Esses c√≥digos permitir√£o a qualquer comprador verificar a autenticidade dos produtos, sua origem e hist√≥rico.  Para que os sistemas internos da Lamoda funcionem com esses c√≥digos de barras, desenvolvemos uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">biblioteca</a> para a an√°lise correta dos c√≥digos GS1. <br>  Em um futuro pr√≥ximo, tamb√©m planejamos definir os c√≥digos-fonte de nossos clientes desenvolvidos para intera√ß√£o com o Sistema de Informa√ß√µes de Marca√ß√£o e Rastreabilidade (IP MP). <br><br><h2>  4. Gerenciamento de microsservi√ßos: middleware para o √¥nibus da equipe Tactician </h2><br>  Temos mais de cem microsservi√ßos que realizam muitas opera√ß√µes separadas: eles verificam o status dos pagamentos ou novos arquivos nos armazenamentos, enviam comandos de controle aos caixas, fazem o download e processam fotos de servi√ßos externos.  Quase todas essas opera√ß√µes s√£o executadas em segundo plano, e o padr√£o do barramento de comando √© excelente para gerenci√°-las.  Para implementar o barramento em sistemas PHP, escolhemos uma solu√ß√£o pronta - a biblioteca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Tactician</a> aberta. <br><br>  No entanto, surgiu um problema: nossas equipes de segundo plano costumam interagir com servi√ßos externos, que t√™m um limite no n√∫mero de opera√ß√µes em n segundos.  E o Tactician n√£o tem a capacidade de controlar o n√∫mero de comandos execut√°veis ‚Äã‚Äãem uma janela de tempo espec√≠fica.  Portanto, desenvolvemos um middleware adicional - biblioteca de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">limites de taxas Tactician</a> .  Com sua ajuda, voc√™ pode adicionar uma nova camada de processamento que rastreia o n√∫mero de comandos executados no barramento de acordo com a estrat√©gia de limita√ß√£o de taxa selecionada.  As estrat√©gias s√£o conect√°veis, as estrat√©gias da biblioteca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">stiphle</a> est√£o dispon√≠veis na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">caixa</a> . <br><br>  Tamb√©m no dom√≠nio p√∫blico est√° o nosso <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">pacote Symfony</a> para a biblioteca. <br><br><h2>  5. Coletando e Renderizando M√©tricas para o Prometheus </h2><br>  Nossos microsservi√ßos geram m√©tricas t√©cnicas e de neg√≥cios, que s√£o coletadas pelo Prometheus Operator de todo o cluster k8s.  Para gerenciar tudo isso, escrevemos uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">biblioteca</a> que processa m√©tricas personalizadas de acordo com o cen√°rio "coletar, salvar e mostrar".  Ao mesmo tempo, a biblioteca suporta modos operacionais nos quais um dos itens de script pode ser omitido para aumentar a efici√™ncia.  Por exemplo, para m√©tricas comput√°veis ‚Äã‚Äãr√°pidas, um cen√°rio simplificado de "exibi√ß√£o em coleta" pode ser executado.  E o trabalho com m√©tricas de neg√≥cios lentas pode se traduzir parcialmente em segundo plano, dividindo-se em dois est√°gios: ‚Äúcoleta-salvamento‚Äù + ‚Äúcoleta (do armazenamento) - exibi√ß√£o‚Äù. <br><br>  A biblioteca possui os n√≠veis de abstra√ß√£o necess√°rios, tanto para escrever seus geradores de m√©tricas quanto para escrever reposit√≥rios.  Fora da caixa, h√° um adaptador abstrato para o Doctrine, que pode ser configurado na entidade para salvar dados no banco de dados. <br><br>  Como formatos de renderiza√ß√£o m√©trica, o prometheus e o telegraf httpjson atualmente s√£o suportados. <br><br>  A biblioteca vem com um pacote Symfony, que fornece uma configura√ß√£o sem√¢ntica de fontes de m√©tricas, reposit√≥rios e m√©tricas de roteamento.  Ele tamb√©m possui comandos auxiliares para depura√ß√£o e salvamento de m√©tricas de fontes (por exemplo, para calcular m√©tricas cron). <br><br><h2>  6. Testando o armazenamento de arquivos: trabalhando com diferentes sistemas de arquivos </h2><br>  Para automatizar o teste, usamos a estrutura de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Codeception</a> , que nos permite escrever testes de v√°rios n√≠veis e possui uma biblioteca bastante extensa de m√≥dulos padr√£o.  Escrevemos mais sobre nossas abordagens para testar o desenvolvimento recentemente em um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">artigo</a> separado e conversamos em uma confer√™ncia do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">PHP R√∫ssia</a> .  A codecep√ß√£o possui m√≥dulos prontos para interagir com o FTP e o sistema de arquivos local, mas em nossos testes √© necess√°rio trabalhar com mais sistemas de arquivos.  No m√≠nimo, tamb√©m usamos o AWS S3 e o Webdav.  Al√©m disso, eu gostaria de interagir com todos os sistemas de arquivos usando a mesma API (todos os sistemas de arquivos :)). <br><br>  Felizmente, existe uma biblioteca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">FlySystem</a> aberta que fornece uma √∫nica interface de software para trabalhar com diferentes sistemas de arquivos.  Portanto, precisamos apenas combinar as duas ferramentas - o que fizemos escrevendo um inv√≥lucro no FlySystem como um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">m√≥dulo de sistema de codecp√ß√£o-flysystem</a> .  Agora ele suporta SFTP, S3 e Webdav.  Basta definir as configura√ß√µes uma vez para conectar-se ao sistema de arquivos desejado na configura√ß√£o de teste yml e, depois disso, voc√™ pode trabalhar com todos os sistemas de arquivos usando o mesmo conjunto de m√©todos: escreva, copie, limpe o diret√≥rio, etc.  O m√≥dulo j√° est√° inclu√≠do na p√°gina de adi√ß√µes e recomenda√ß√µes de Codeception: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">codeception.com/addons</a> . <br><br><h2>  7. Trabalhando com vari√°veis ‚Äã‚Äãde ambiente no modo multilocat√°rio </h2><br>  No departamento de automa√ß√£o de processos de neg√≥cios, existem sistemas que operam no modo multilocat√°rio.  Para garantir seu trabalho, √© necess√°rio poder trabalhar com vari√°veis ‚Äã‚Äãde ambiente - para determinar qual vari√°vel usar no momento atual. <br><br>  Nossa <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">biblioteca</a> fornece v√°rias estrat√©gias para trabalhar com vari√°veis ‚Äã‚Äãde ambiente no modo multilocat√°rio.  Com base nos par√¢metros passados ‚Äã‚Äãno est√°gio de inicializa√ß√£o, a biblioteca determina qual vari√°vel de ambiente deve ser acessada na solicita√ß√£o atual. <br><br><h2>  Para ser continuado </h2><br>  Esta √© apenas a primeira parte das bibliotecas.  Temos mais uma d√∫zia l√° dentro - eles est√£o esperando na fila quando os ‚Äúpenteamos‚Äù um pouco e os colocamos em dom√≠nio p√∫blico.  Isso me motiva a entender que essas bibliotecas podem ser √∫teis para outra pessoa.  Eu me alegro com os coment√°rios e as estrelas no github e espero continuar desenvolvendo bibliotecas com outros desenvolvedores.  De fato, muitos projetos russos de com√©rcio eletr√¥nico trabalham com ATOL e Payture.  Para o Datamatrix, al√©m do analisador de c√≥digo descrito no artigo, tamb√©m temos alguns clientes que j√° usamos internamente - essas bibliotecas s√£o as primeiras da fila no GitHub. <br><br>  Tentamos n√£o esquecer os outros idiomas - j√° publicamos a primeira biblioteca no Go ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">escrevemos</a> mais sobre isso <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui no Habr√©</a> ) e estamos preparando outros.  Fique atento! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt466039/">https://habr.com/ru/post/pt466039/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt466021/index.html">Como eu ensinei Yandex.Alice a falar sobre brinquedos sexuais</a></li>
<li><a href="../pt466027/index.html">O livro "O Caminho do Python. Faixa preta para desenvolvimento, dimensionamento, teste e implanta√ß√£o ‚Äù</a></li>
<li><a href="../pt466029/index.html">Como transformar um computador qu√¢ntico em um gerador de n√∫meros aleat√≥rios perfeito</a></li>
<li><a href="../pt466031/index.html">A miss√£o √©pica do DeepMind para resolver o problema cient√≠fico mais complexo</a></li>
<li><a href="../pt466033/index.html">Como envolver uma equipe na busca de id√©ias e obter muito mais do que id√©ias</a></li>
<li><a href="../pt466041/index.html">O primeiro evento offline da comunidade Circle Developer Circle: Moscow - Launch Event</a></li>
<li><a href="../pt466045/index.html">Como revitalizar uma marca: contar hist√≥rias que funcionaram</a></li>
<li><a href="../pt466047/index.html">Projetando lojas online. Parte 3. P√°gina Inicial e Cat√°logo</a></li>
<li><a href="../pt466049/index.html">De copiar e colar para componentes: reutilizando c√≥digo em diferentes aplicativos</a></li>
<li><a href="../pt466051/index.html">Automatize a cria√ß√£o de perfil em Java 10/09</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>