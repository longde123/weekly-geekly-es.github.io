<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🔽 🤞🏿 🚹 LLVM的Go语言 🍶 😰 👩🏿‍🚒</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="编译器开发是一项非常艰巨的任务。 但是，幸运的是，随着LLVM之类的项目的开发，此问题的解决方案得到了极大简化，甚至允许单个程序员创建性能接近C的新语言。由于该系统由大量代码表示并配有小型文档，因此使用LLVM变得很复杂。 为了纠正这一缺陷，我们今天出版的材料的作者将演示用Go编写的代码示例，并展示...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>LLVM的Go语言</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/451476/"> 编译器开发是一项非常艰巨的任务。 但是，幸运的是，随着LLVM之类的项目的开发，此问题的解决方案得到了极大简化，甚至允许单个程序员创建性能接近C的新语言。由于该系统由大量代码表示并配有小型文档，因此使用LLVM变得很复杂。 为了纠正这一缺陷，我们今天出版的材料的作者将演示用Go编写的代码示例，并展示如何先使用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">TinyGO</a>编译器将其传输到<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Go SSA</a> ，然后再传输到LLVM IR。 对Go SSA和LLVM IR代码进行了稍微的编辑，为了使这些说明更容易理解，已删除了不属于此处给出的说明的内容。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/f4a/50e/d6d/f4a50ed6d13e445eaf3d9c55293e7999.jpg" alt="图片"></div><a name="habracut"></a><br><h2>  <font color="#3AC1EF">第一个例子</font> </h2><br> 我要在这里解析的第一个函数是一个简单的加数机制： <br><br><pre><code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">myAdd</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(a, b </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span></span>{    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a + b }</code> </pre> <br> 此功能非常简单，也许没有一件事情不容易提出。 它将转换为以下Go SSA代码： <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">myAdd</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(a </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">, b </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">entry</span></span></span><span class="hljs-function">:   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t0</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">a</span></span></span><span class="hljs-function"> + </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">b</span></span></span><span class="hljs-function">                                                    </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function">   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">return</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t0</span></span></span></span></code> </pre> <br> 通过此函数表示，有关数据类型的提示位于右侧，在大多数情况下，您可以忽略它们。 <br><br> 这个小例子已经使您了解SSA的一个方面的要点。 即，在将代码转换为SSA形式时，每个表达式都被划分为其组成的最基本的部分。 实际上，在我们的例子中， <code>return a + b</code>命令表示两个操作：加两个数字并返回结果。 <br><br> 另外，在这里您可以看到程序的基本块，在此代码中只有一个块-输入（入口块）。 我们将在下面详细讨论。 <br><br>  Go SSA代码可以轻松转换为LLVM IR： <br><br><pre> <code class="go hljs">define i64 @myAdd(i64 %a, i64 %b) { entry: %<span class="hljs-number"><span class="hljs-number">0</span></span> = add i64 %a, %b ret i64 %<span class="hljs-number"><span class="hljs-number">0</span></span> }</code> </pre> <br> 您可能会注意到，尽管此处使用了其他语法构造，但该函数的结构基本上没有改变。  LLVM IR代码比Go SSA代码略强，类似于C。这里，在函数声明中，首先是对返回给它的数据类型的描述，参数的类型在参数名称之前指示。 此外，为简化IR解析，全局实体的名称前面带有<code>@</code>符号，而本地实体的名称之前则带有<code>%</code>字符（该函数也被视为全局实体）。 <br><br> 您需要注意的此代码的功能之一是，在创建LLVM时，将决定表示类型Go <code>int</code>的类型，该类型可以由32位或64位值表示，具体取决于编译器和编译的目的。红外线代码。 这是LLVM IR代码与平台无关的众多原因之一。 为一个平台创建的此类代码不能简单地为另一个平台采用和编译（除非您<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">非常谨慎地执行</a>此任务）。 <br><br> 另一个值得注意的有趣点是<code>i64</code>类型不是有符号整数：就表示数字的符号而言，它是中性的。 根据指令的不同，它可以表示带符号的数字和带符号的数字。 在表示加法运算的情况下，它不起作用，因此使用带或不带符号的数字没有区别。 在这里，我想指出，在C中，有符号整数变量的溢出导致未定义的行为，因此，Clang前端在操作中添加了<code>nsw</code> （无符号包装）标志，这向LLVM表示可以从假设加法永远不会发生溢出。 <br><br> 这对于某些优化可能很重要。 例如，在32位平台（具有32位寄存器）上将两个<code>i16</code>值相加后，要求在相加完成后将符号扩展操作保持在<code>i16</code>范围内。 因此，考虑到寄存器的机器大小，执行整数运算通常会更高效。 <br><br> 现在，对于我们来说，使用此IR代码将来会发生什么并不特别有趣。 代码经过优化（但在像我们这样的简单示例中，尚未进行任何优化），然后将其转换为机器代码。 <br><br><h2>  <font color="#3AC1EF">第二个例子</font> </h2><br> 我们将研究的以下示例将更加复杂。 也就是说，我们正在谈论一个将整数切片求和的函数： <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sum</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(numbers []</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span></span> {   n := <span class="hljs-number"><span class="hljs-number">0</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-built_in"><span class="hljs-built_in">len</span></span>(numbers); i++ {       n += numbers[i]   }   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> n }</code> </pre> <br> 此代码将转换为以下Go SSA代码： <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sum</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(numbers []</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">entry</span></span></span><span class="hljs-function">:   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jump</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">for</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loop</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">for</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loop</span></span></span><span class="hljs-function">:   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t0</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">phi</span></span></span><span class="hljs-function"> [</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">entry</span></span></span><span class="hljs-function">: 0:</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">for</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">body</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t6</span></span></span><span class="hljs-function">] #</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">n</span></span></span><span class="hljs-function">                       </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function">   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t1</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">phi</span></span></span><span class="hljs-function"> [</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">entry</span></span></span><span class="hljs-function">: 0:</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">for</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">body</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t7</span></span></span><span class="hljs-function">] #</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">i</span></span></span><span class="hljs-function">                       </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function">   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t2</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">len</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(numbers)</span></span></span><span class="hljs-function">                                              </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function">   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t3</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t1</span></span></span><span class="hljs-function"> &lt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t2</span></span></span><span class="hljs-function">                                                  </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bool</span></span></span><span class="hljs-function">   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t3</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">goto</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">for</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">body</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">else</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">for</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">done</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">for</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">body</span></span></span><span class="hljs-function">:   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t4</span></span></span><span class="hljs-function"> = &amp;</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">numbers</span></span></span><span class="hljs-function">[</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t1</span></span></span><span class="hljs-function">]                                             *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function">   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t5</span></span></span><span class="hljs-function"> = *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t4</span></span></span><span class="hljs-function">                                                       </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function">   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t6</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t0</span></span></span><span class="hljs-function"> + </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t5</span></span></span><span class="hljs-function">                                                   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function">   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t7</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t1</span></span></span><span class="hljs-function"> + 1:</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function">                                                </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function">   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jump</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">for</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loop</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">for</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">done</span></span></span><span class="hljs-function">:   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">return</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t0</span></span></span></span></code> </pre> <br> 在这里，您已经可以看到更多针对SSA形式的代码表示的构造。 该代码最明显的特征可能是没有结构化的流控制命令。 为了控制计算流程，只有条件跳转和无条件跳转，如果我们将此命令视为控制流的命令，则返回命令。 <br><br> 实际上，您可以在这里注意以下事实：该程序没有使用花括号将其划分为块（如C系列语言）。 它由类似于汇编语言的标签划分，并以基本块的形式显示。 在SSA中，基本块是连续的代码序列，从标签开始，并以完成基本块的指令（例如<code>return</code>和<code>jump</code> 。 <br><br> 该代码的另一个有趣的细节是<code>phi</code>指令。 该说明很不寻常，可能需要一些时间才能弄清。 请记住， <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">SSA</a>是静态单一分配的缩写。 这是编译器使用的代码的中间表示，其中每个变量仅分配一次。 这对于表示简单的函数（如上面显示的<code>myAdd</code>函数）非常<code>myAdd</code> ，但对于更复杂的函数（如本节中讨论的<code>sum</code>函数）则不是。 特别地，在循环执行期间，变量<code>i</code>和<code>n</code>改变。 <br><br>  SSA使用所谓的<code>phi</code>指令（其名称取自希腊字母）绕过了对单个变量值分配的限制。 事实是，为了使代码的SSA表示形式能够像C这样的语言形成，您必须采取一些技巧。 调用该指令的结果是变量（ <code>i</code>或<code>n</code> ）的当前值，并且基块列表用作其参数。 例如，考虑以下说明： <br><br><pre> <code class="go hljs">t0 = phi [entry: <span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>.body: t6] #n</code> </pre> <br> 其含义如下：如果前一个基本块是一个<code>entry</code> （输入）块，则<code>t0</code>为常数<code>0</code> ；如果前一个基本块是<code>for.body</code> ，则需要从该块中获取值<code>t6</code> 。 所有这些可能看起来都很神秘，但是由于有了这种机制，所以可以确保SSA。 从人的角度来看，所有这些都使对代码的理解变得复杂，但是每个值只分配一次的事实大大简化了许多优化。 <br><br> 请注意，如果您正在编写自己的编译器，则通常不必处理此类事情。 即使Clang不会生成所有这些<code>phi</code>指令，它也会使用<code>alloca</code>机制（类似于使用普通的局部变量）。 然后，当执行称为<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">mem2reg</a>的LLVM优化传递时， <code>alloca</code>指令将转换为SSA形式。 但是，TinyGo从Go SSA接收输入，该输入已经很方便地已经转换为SSA形式。 <br><br> 这段中间代码的另一项创新是，以计算地址的操作和获得的指针的解引用操作的形式，介绍了通过索引访问切片元素的方法。 在这里，您可以看到将常数直接添加到IR代码中（例如<code>1:int</code> ）。 在具有<code>myAdd</code>函数的示例中，未使用它。 现在我们已经弄清楚了这些功能，下面我们来看一下将其转换为LLVM IR形式时该代码将变成什么： <br><br><pre> <code class="go hljs">define i64 @sum(i64* %ptr, i64 %<span class="hljs-built_in"><span class="hljs-built_in">len</span></span>, i64 %<span class="hljs-built_in"><span class="hljs-built_in">cap</span></span>) { entry: br label %<span class="hljs-keyword"><span class="hljs-keyword">for</span></span>.loop <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>.loop:                                         ; preds = %<span class="hljs-keyword"><span class="hljs-keyword">for</span></span>.body, %entry %<span class="hljs-number"><span class="hljs-number">0</span></span> = phi i64 [ <span class="hljs-number"><span class="hljs-number">0</span></span>, %entry ], [ %<span class="hljs-number"><span class="hljs-number">5</span></span>, %deref.next ] %<span class="hljs-number"><span class="hljs-number">1</span></span> = phi i64 [ <span class="hljs-number"><span class="hljs-number">0</span></span>, %entry ], [ %<span class="hljs-number"><span class="hljs-number">6</span></span>, %deref.next ] %<span class="hljs-number"><span class="hljs-number">2</span></span> = icmp slt i64 %<span class="hljs-number"><span class="hljs-number">1</span></span>, %<span class="hljs-built_in"><span class="hljs-built_in">len</span></span> br i1 %<span class="hljs-number"><span class="hljs-number">2</span></span>, label %<span class="hljs-keyword"><span class="hljs-keyword">for</span></span>.body, label %<span class="hljs-keyword"><span class="hljs-keyword">for</span></span>.done <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>.body:                                         ; preds = %<span class="hljs-keyword"><span class="hljs-keyword">for</span></span>.loop %<span class="hljs-number"><span class="hljs-number">3</span></span> = getelementptr i64, i64* %ptr, i64 %<span class="hljs-number"><span class="hljs-number">1</span></span> %<span class="hljs-number"><span class="hljs-number">4</span></span> = load i64, i64* %<span class="hljs-number"><span class="hljs-number">3</span></span> %<span class="hljs-number"><span class="hljs-number">5</span></span> = add i64 %<span class="hljs-number"><span class="hljs-number">0</span></span>, %<span class="hljs-number"><span class="hljs-number">4</span></span> %<span class="hljs-number"><span class="hljs-number">6</span></span> = add i64 %<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span> br label %<span class="hljs-keyword"><span class="hljs-keyword">for</span></span>.loop <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>.done:                                         ; preds = %<span class="hljs-keyword"><span class="hljs-keyword">for</span></span>.loop ret i64 %<span class="hljs-number"><span class="hljs-number">0</span></span> }</code> </pre> <br> 在这里，和以前一样，我们可以看到相同的结构，其中包括其他语法结构。 例如，在<code>phi</code>调用中，值和标签被交换。 但是，还有一些值得特别注意的地方。 <br><br> 对于初学者，在这里您可以看到功能的完全不同的签名。  LLVM不支持切片，因此，以优化的形式生成了此中间代码的TinyGo编译器将该数据结构的描述分为若干部分。 他可以将三个切片元素（ <code>ptr</code> ， <code>len</code>和<code>cap</code> ）表示为结构（结构），但将它们表示为三个单独的实体可以进行一些优化。 其他编译器可能以其他方式显示切片，这取决于调用目标平台功能的约定。 <br><br> 该代码的另一个有趣功能是使用<code>getelementptr</code> （通常简称为GEP）。 <br><br> 该指令与指针一起使用，用于获取指向slice元素的指针。 例如，让我们将其与以下用C编写的代码进行比较： <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span>* sliceptr(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> *ptr, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> index) {   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> &amp;ptr[index]; }</code> </pre> <br> 或具有以下等效项： <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span>* sliceptr(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> *ptr, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> index) {   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ptr + index; }</code> </pre> <br> 这里最重要的是<code>getelementptr</code>语句<code>getelementptr</code>执行取消引用操作。 它仅基于现有指针来计算一个新指针。 它可以解释为<code>mul</code>并在硬件级别<code>add</code> 。 可在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">此处</a>找到有关GEP指令的详细信息。 <br><br> 此中间代码的另一个有趣的功能是<code>icmp</code>指令的使用。 这是用于实现整数比较的通用指令。 该指令的结果始终是类型为<code>i1</code>的值-逻辑值。 在这种情况下，使用关键字<code>slt</code> （带符号小于）进行比较，因为我们正在比较先前由<code>int</code>类型表示的两个数字。 如果要比较两个无符号整数，则将使用<code>icmp</code>作为指令，并且比较中使用的关键字将为<code>ult</code> 。 为了比较浮点数，使用了另一条指令<code>fcmp</code> ，其工作方式类似。 <br><br><h2>  <font color="#3AC1EF">总结</font> </h2><br> 我相信，在本文中，我研究了LLVM IR的最重要功能。 当然，还有很多事情。 特别地，代码的中间表示可能包含很多注释，从而允许考虑优化过程中编译器已知的某些优化功能，这些功能不能以任何其他方式在IR中表示。 例如，这些是<code>inbounds</code>指令的入<code>nuw</code>或<code>nsw</code>和<code>nuw</code> ，可以将其添加到<code>add</code>语句中。 这对于<code>private</code>关键字同样适用，它向优化器指示不会从当前编译单元外部引用由他标记的功能。 这使您可以执行许多有趣的过程间优化，例如消除未使用的参数。 <br><br> 您可以在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">文档中</a>阅读有关LLVM的更多信息，在开发自己的基于LLVM的编译器时经常会参考该<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">文档</a> 。 这是一份<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">指南</a> ，讨论了使用非常简单的语言进行的编译器开发。 在创建自己的编译器时，这两种信息源都将派上用场。 <br><br>  <b>亲爱的读者们！</b> 您是否使用LLVM？ <br><br><div style="text-align:center;"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><img src="https://habrastorage.org/files/1ba/550/d25/1ba550d25e8846ce8805de564da6aa63.png"></a> </div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN451476/">https://habr.com/ru/post/zh-CN451476/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN451460/index.html">朱莉娅在迷宫中</a></li>
<li><a href="../zh-CN451462/index.html">在Laravel中使用活页夹编写更少重复的代码</a></li>
<li><a href="../zh-CN451464/index.html">前端每周摘要（2019年5月6日至12日）</a></li>
<li><a href="../zh-CN451466/index.html">graphql-陷阱</a></li>
<li><a href="../zh-CN451468/index.html">上周第364期（2019年5月6日至12日）的前端世界摘要</a></li>
<li><a href="../zh-CN451478/index.html">使用pandas分析库加速数据探索</a></li>
<li><a href="../zh-CN451480/index.html">工业和贸易部为何禁止存储外国设备的数据</a></li>
<li><a href="../zh-CN451482/index.html">现代程序员的能力从不同的角度</a></li>
<li><a href="../zh-CN451488/index.html">基于经典A / B测试和自举方法的相食性计算</a></li>
<li><a href="../zh-CN451492/index.html">七个意外的Bash变量</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>