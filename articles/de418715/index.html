<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üé© üëÉüèª üëáüèø Wie effizient ist das virtuelle procfs-Dateisystem und kann es optimiert werden? üë©‚Äçüë©‚Äçüëß üïπÔ∏è ‚ö±Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Das proc-Dateisystem (im Folgenden einfach procfs) ist ein virtuelles Dateisystem, das Informationen √ºber Prozesse bereitstellt. Sie ist ein ‚Äûgutes‚Äú B...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Wie effizient ist das virtuelle procfs-Dateisystem und kann es optimiert werden?</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/virtuozzo/blog/418715/"><p>  Das proc-Dateisystem (im Folgenden einfach procfs) ist ein virtuelles Dateisystem, das Informationen √ºber Prozesse bereitstellt.  Sie ist ein ‚Äûgutes‚Äú Beispiel f√ºr Schnittstellen, die dem Paradigma ‚ÄûAlles ist eine Datei‚Äú folgen.  Procfs wurde vor sehr langer Zeit entwickelt: Zu einer Zeit, als Server durchschnittlich Dutzende von Prozessen bedienten, war das √ñffnen einer Datei und das Lesen von Prozessinformationen kein Problem.  Die Zeit steht jedoch nicht still und jetzt bedienen Server Hunderttausende oder sogar mehr Prozesse gleichzeitig.  In diesem Zusammenhang sieht die Idee, ‚Äûf√ºr jeden Prozess eine Datei zu √∂ffnen, um die interessierenden Daten zu subtrahieren‚Äú, nicht mehr so ‚Äã‚Äãattraktiv aus. Um das Lesen zu beschleunigen, m√ºssen Sie zun√§chst Informationen √ºber eine Gruppe von Prozessen in einer Iteration abrufen.  In diesem Artikel werden wir versuchen, procfs-Elemente zu finden, die optimiert werden k√∂nnen. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/7c7/55c/f6b/7c755cf6b80f5b20ab194e548c3c99be.jpg" alt="Bild"></p><a name="habracut"></a><br><p>  Die Idee, procfs zu verbessern, entstand, als wir entdeckten, dass CRIU viel Zeit damit verbringt, nur procfs-Dateien zu lesen.  Wir haben gesehen, wie ein √§hnliches Problem f√ºr Sockets gel√∂st wurde, und beschlossen, etwas √Ñhnliches wie die Sockendiag-Schnittstelle zu tun, jedoch nur f√ºr procfs.  Nat√ºrlich gingen wir davon aus, wie schwierig es sein w√ºrde, die langj√§hrige und gut etablierte Benutzeroberfl√§che im Kernel zu √§ndern, um die Community davon zu √ºberzeugen, dass das Spiel die Kerze wert ist ... und wir waren angenehm √ºberrascht von der Anzahl der Personen, die die Erstellung der neuen Benutzeroberfl√§che unterst√ºtzten.  Genau genommen wusste niemand, wie die neue Benutzeroberfl√§che aussehen sollte, aber es besteht kein Zweifel, dass procfs die aktuellen Leistungsanforderungen nicht erf√ºllt.  Beispiel: Dieses Szenario: Der Server antwortet zu lange auf Anforderungen, vmstat zeigt an, dass der Speicher ausgelagert wurde, und "ps ax" wird ab 10 Sekunden oder l√§nger gestartet. Top zeigt √ºberhaupt nichts an.  In diesem Artikel werden wir keine spezifische neue Schnittstelle betrachten, sondern versuchen, die Probleme und ihre L√∂sungen zu beschreiben. </p><br><p> Jeder ausf√ºhrende procfs-Prozess wird durch das Verzeichnis / proc / <code>&lt;pid&gt;</code> . <br>  In jedem dieser Verzeichnisse befinden sich viele Dateien und Unterverzeichnisse, die Zugriff auf bestimmte Informationen √ºber den Prozess bieten.  Unterverzeichnisse gruppieren Daten nach Funktionen.  Zum Beispiel ( <code>$$</code> ist eine spezielle Shell-Variable, die in pid erweitert wird - der Kennung des aktuellen Prozesses): </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> ls <span class="hljs-operator"><span class="hljs-operator">-F</span></span> /proc/<span class="hljs-variable"><span class="hljs-variable">$</span></span><span class="hljs-variable"><span class="hljs-variable">$</span></span> attr/ exe<span class="hljs-selector-tag"><span class="hljs-selector-tag">@</span></span> mounts projid_map status autogroup fd/ mountstats root<span class="hljs-selector-tag"><span class="hljs-selector-tag">@</span></span> syscall auxv fdinfo/ net/ sched task/ cgroup gid_map ns/ schedstat timers clear_refs io numa_maps sessionid timerslack_ns cmdline limits oom_adj setgroups uid_map comm loginuid oom_score smaps wchan coredump_filter map_files/ oom_score_adj smaps_rollup cpuset maps pagemap stack cwd<span class="hljs-selector-tag"><span class="hljs-selector-tag">@</span></span> mem patch_state stat environ mountinfo personality statm</code> </pre> <br><p>  Alle diese Dateien geben Daten in verschiedenen Formaten aus.  Die meisten sind im ASCII-Format und werden vom Menschen leicht wahrgenommen.  Na ja, fast einfach: </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> cat /proc/<span class="hljs-variable"><span class="hljs-variable">$</span></span><span class="hljs-variable"><span class="hljs-variable">$</span></span>/stat <span class="hljs-number"><span class="hljs-number">24293</span></span> (bash) S <span class="hljs-number"><span class="hljs-number">21811</span></span> <span class="hljs-number"><span class="hljs-number">24293</span></span> <span class="hljs-number"><span class="hljs-number">24293</span></span> <span class="hljs-number"><span class="hljs-number">34854</span></span> <span class="hljs-number"><span class="hljs-number">24876</span></span> <span class="hljs-number"><span class="hljs-number">4210688</span></span> <span class="hljs-number"><span class="hljs-number">6325</span></span> <span class="hljs-number"><span class="hljs-number">19702</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">33</span></span> <span class="hljs-number"><span class="hljs-number">35</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">47892016</span></span> <span class="hljs-number"><span class="hljs-number">135487488</span></span> <span class="hljs-number"><span class="hljs-number">3388</span></span> <span class="hljs-number"><span class="hljs-number">18446744073709551615</span></span> <span class="hljs-number"><span class="hljs-number">94447405350912</span></span> <span class="hljs-number"><span class="hljs-number">94447406416132</span></span> <span class="hljs-number"><span class="hljs-number">140729719486816</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">65536</span></span> <span class="hljs-number"><span class="hljs-number">3670020</span></span> <span class="hljs-number"><span class="hljs-number">1266777851</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">94447408516528</span></span> <span class="hljs-number"><span class="hljs-number">94447408563556</span></span> <span class="hljs-number"><span class="hljs-number">94447429677056</span></span> <span class="hljs-number"><span class="hljs-number">140729719494655</span></span> <span class="hljs-number"><span class="hljs-number">140729719494660</span></span> <span class="hljs-number"><span class="hljs-number">140729719494660</span></span> <span class="hljs-number"><span class="hljs-number">140729719496686</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br><p>  Um zu verstehen, was jedes Element dieses Satzes bedeutet, muss der Leser man proc (5) oder die Kerneldokumentation √∂ffnen.  Das zweite Element ist beispielsweise der Name der ausf√ºhrbaren Datei in Klammern, und das neunzehnte Element ist der aktuelle Wert der Ausf√ºhrungspriorit√§t (nett). </p><br><p>  Einige Dateien sind f√ºr sich gut lesbar: </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> cat /proc/<span class="hljs-variable"><span class="hljs-variable">$</span></span><span class="hljs-variable"><span class="hljs-variable">$</span></span>/status | head <span class="hljs-literal"><span class="hljs-literal">-n</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> Name: bash Umask: <span class="hljs-number"><span class="hljs-number">0002</span></span> State: S (sleeping) Tgid: <span class="hljs-number"><span class="hljs-number">24293</span></span> Ngid: <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br><p>  Aber wie oft lesen Benutzer Informationen direkt aus procfs-Dateien?  Wie lange braucht der Kernel, um Bin√§rdaten in das Textformat zu konvertieren?  Was ist der Overhead von procfs?  Wie bequem ist diese Schnittstelle f√ºr Status√ºberwachungsprogramme und wie viel Zeit verbringen sie mit der Verarbeitung dieser Textdaten?  Wie kritisch ist eine so langsame Implementierung in Notsituationen? </p><br><p>  H√∂chstwahrscheinlich ist es kein Fehler zu sagen, dass Benutzer Programme wie top oder ps bevorzugen, anstatt Daten aus procfs direkt zu lesen. </p><br><p>  Um die verbleibenden Fragen zu beantworten, werden wir mehrere Experimente durchf√ºhren.  Stellen Sie zun√§chst fest, wo der Kernel Zeit zum Generieren von procfs-Dateien verbringt. </p><br><p>  Um bestimmte Informationen von allen Prozessen im System zu erhalten, m√ºssen wir das Verzeichnis / proc / durchsuchen und alle Unterverzeichnisse ausw√§hlen, deren Name durch Dezimalstellen dargestellt wird.  Dann m√ºssen wir in jedem von ihnen die Datei √∂ffnen, lesen und schlie√üen. </p><br><p>  Insgesamt werden drei Systemaufrufe durchgef√ºhrt, von denen einer einen Dateideskriptor erstellt (im Kernel ist ein Dateideskriptor einer Reihe interner Objekte zugeordnet, f√ºr die zus√§tzlicher Speicher zugewiesen ist).  Die Systemaufrufe open () und close () selbst geben uns keine Informationen, sodass sie dem Overhead der procfs-Schnittstelle zugeordnet werden k√∂nnen. </p><br><p>  Versuchen wir einfach, f√ºr jeden Prozess im System zu √∂ffnen () und zu schlie√üen (), aber wir werden den Inhalt der Dateien nicht lesen: </p><br><pre> <code class="hljs go">$ time ./task_proc_all --noread stat tasks: <span class="hljs-number"><span class="hljs-number">50290</span></span> <span class="hljs-built_in"><span class="hljs-built_in">real</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.177s</span></span> user <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.012s</span></span> sys <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.162s</span></span></code> </pre> <br><pre> <code class="hljs go">$ time ./task_proc_all --noread loginuid tasks: <span class="hljs-number"><span class="hljs-number">50289</span></span> <span class="hljs-built_in"><span class="hljs-built_in">real</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.176s</span></span> user <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.026s</span></span> sys <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.145</span></span></code> </pre> <br><p>  <em>task-proc-all - ein kleines Dienstprogramm, dessen Code unter dem folgenden Link zu finden ist</em> </p><br><p>  Es spielt keine Rolle, welche Datei ge√∂ffnet werden soll, da echte Daten nur zum Zeitpunkt von read () generiert werden. </p><br><p>  Schauen Sie sich nun die Ausgabe des Perf Core Profilers an: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 92<span class="hljs-selector-class"><span class="hljs-selector-class">.18</span></span>% 0<span class="hljs-selector-class"><span class="hljs-selector-class">.00</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">task_proc_all</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[unknown]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x8000</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 64<span class="hljs-selector-class"><span class="hljs-selector-class">.01</span></span>% __<span class="hljs-selector-tag"><span class="hljs-selector-tag">GI___libc_open</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 50<span class="hljs-selector-class"><span class="hljs-selector-class">.71</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">entry_SYSCALL_64_fastpath</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">do_sys_open</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 48<span class="hljs-selector-class"><span class="hljs-selector-class">.63</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">do_filp_open</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">path_openat</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 19<span class="hljs-selector-class"><span class="hljs-selector-class">.60</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">link_path_walk</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 14<span class="hljs-selector-class"><span class="hljs-selector-class">.23</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">walk_component</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 13<span class="hljs-selector-class"><span class="hljs-selector-class">.87</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">lookup_fast</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 7<span class="hljs-selector-class"><span class="hljs-selector-class">.55</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">pid_revalidate</span></span> 4<span class="hljs-selector-class"><span class="hljs-selector-class">.13</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">get_pid_task</span></span> + 1<span class="hljs-selector-class"><span class="hljs-selector-class">.58</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">security_task_to_inode</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">task_dump_owner</span></span> 3<span class="hljs-selector-class"><span class="hljs-selector-class">.63</span></span>% __<span class="hljs-selector-tag"><span class="hljs-selector-tag">d_lookup_rcu</span></span> + 3<span class="hljs-selector-class"><span class="hljs-selector-class">.42</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">security_inode_permission</span></span> + 14<span class="hljs-selector-class"><span class="hljs-selector-class">.76</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">proc_pident_lookup</span></span> + 4<span class="hljs-selector-class"><span class="hljs-selector-class">.39</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">d_alloc_parallel</span></span> + 2<span class="hljs-selector-class"><span class="hljs-selector-class">.93</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">get_empty_filp</span></span> + 2<span class="hljs-selector-class"><span class="hljs-selector-class">.43</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">lookup_fast</span></span> + 0<span class="hljs-selector-class"><span class="hljs-selector-class">.98</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">do_dentry_open</span></span> 2<span class="hljs-selector-class"><span class="hljs-selector-class">.07</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">syscall_return_via_sysret</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.60</span></span>% 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">xfffffe000008a01b</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.97</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">kmem_cache_alloc</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.61</span></span>% 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">xfffffe000008a01e</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 16<span class="hljs-selector-class"><span class="hljs-selector-class">.45</span></span>% __<span class="hljs-selector-tag"><span class="hljs-selector-tag">getdents64</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 15<span class="hljs-selector-class"><span class="hljs-selector-class">.11</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">entry_SYSCALL_64_fastpath</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sys_getdents</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">iterate_dir</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">proc_pid_readdir</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 7<span class="hljs-selector-class"><span class="hljs-selector-class">.18</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">proc_fill_cache</span></span> + 3<span class="hljs-selector-class"><span class="hljs-selector-class">.53</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">d_lookup</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.59</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">filldir</span></span> + 6<span class="hljs-selector-class"><span class="hljs-selector-class">.82</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">next_tgid</span></span> + 0<span class="hljs-selector-class"><span class="hljs-selector-class">.61</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">snprintf</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 9<span class="hljs-selector-class"><span class="hljs-selector-class">.89</span></span>% __<span class="hljs-selector-tag"><span class="hljs-selector-tag">close</span></span> + 4<span class="hljs-selector-class"><span class="hljs-selector-class">.03</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">entry_SYSCALL_64_fastpath</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.98</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">syscall_return_via_sysret</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.85</span></span>% 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">xfffffe000008a01b</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.61</span></span>% 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">xfffffe000008a01e</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">syscall_return_via_sysret</span></span></code> </pre> <br><p>  Der Kernel verbringt fast 75% der Zeit damit, den Dateideskriptor zu erstellen und zu l√∂schen, und etwa 16% damit, die Prozesse aufzulisten. </p><br><p>  Obwohl wir wissen, wie lange es dauert, bis open () und close () f√ºr jeden Prozess aufgerufen werden, k√∂nnen wir immer noch nicht absch√§tzen, wie wichtig er ist.  Wir m√ºssen die erhaltenen Werte mit etwas vergleichen.  Versuchen wir, dasselbe mit den bekanntesten Dateien zu tun.  Wenn Sie die Prozesse auflisten m√ºssen, wird normalerweise ps oder top verwendet.  Beide lesen / proc / <code>&lt;pid&gt;</code> / stat und / proc / <code>&lt;pid&gt;</code> / status f√ºr jeden Prozess auf dem System. </p><br><p>  Beginnen wir mit / proc / <code>&lt;pid&gt;</code> / status - dies ist eine massive Datei mit einer festen Anzahl von Feldern: </p><br><pre> <code class="hljs go">$ time ./task_proc_all status tasks: <span class="hljs-number"><span class="hljs-number">50283</span></span> <span class="hljs-built_in"><span class="hljs-built_in">real</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.455s</span></span> user <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.033s</span></span> sys <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.417s</span></span></code> </pre> <br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 93<span class="hljs-selector-class"><span class="hljs-selector-class">.84</span></span>% 0<span class="hljs-selector-class"><span class="hljs-selector-class">.00</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">task_proc_all</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[unknown]</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[k]</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x0000000000008000</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x8000</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 61<span class="hljs-selector-class"><span class="hljs-selector-class">.20</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">read</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 53<span class="hljs-selector-class"><span class="hljs-selector-class">.06</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">entry_SYSCALL_64_fastpath</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sys_read</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 52<span class="hljs-selector-class"><span class="hljs-selector-class">.80</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">vfs_read</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 52<span class="hljs-selector-class"><span class="hljs-selector-class">.22</span></span>% __<span class="hljs-selector-tag"><span class="hljs-selector-tag">vfs_read</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">seq_read</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 50<span class="hljs-selector-class"><span class="hljs-selector-class">.43</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">proc_single_show</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 50<span class="hljs-selector-class"><span class="hljs-selector-class">.38</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">proc_pid_status</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 11<span class="hljs-selector-class"><span class="hljs-selector-class">.34</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">task_mem</span></span> + <span class="hljs-selector-tag"><span class="hljs-selector-tag">seq_printf</span></span> + 6<span class="hljs-selector-class"><span class="hljs-selector-class">.99</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">seq_printf</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 5<span class="hljs-selector-class"><span class="hljs-selector-class">.77</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">seq_put_decimal_ull</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.94</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">strlen</span></span> + 1<span class="hljs-selector-class"><span class="hljs-selector-class">.42</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">num_to_str</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 5<span class="hljs-selector-class"><span class="hljs-selector-class">.73</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">cpuset_task_status_allowed</span></span> + <span class="hljs-selector-tag"><span class="hljs-selector-tag">seq_printf</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 5<span class="hljs-selector-class"><span class="hljs-selector-class">.37</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">render_cap_t</span></span> + 5<span class="hljs-selector-class"><span class="hljs-selector-class">.31</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">seq_printf</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 5<span class="hljs-selector-class"><span class="hljs-selector-class">.25</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">render_sigset_t</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.84</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">seq_putc</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.73</span></span>% __<span class="hljs-selector-tag"><span class="hljs-selector-tag">task_pid_nr_ns</span></span> + 0<span class="hljs-selector-class"><span class="hljs-selector-class">.63</span></span>% __<span class="hljs-selector-tag"><span class="hljs-selector-tag">lock_task_sighand</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.53</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">hugetlb_report_usage</span></span> + 0<span class="hljs-selector-class"><span class="hljs-selector-class">.68</span></span>% _<span class="hljs-selector-tag"><span class="hljs-selector-tag">copy_to_user</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">number</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.05</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">seq_put_decimal_ull</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.84</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">vsnprintf</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.79</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">format_decode</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.73</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">syscall_return_via_sysret</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.52</span></span>% 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">xfffffe000003201b</span></span> + 20<span class="hljs-selector-class"><span class="hljs-selector-class">.95</span></span>% __<span class="hljs-selector-tag"><span class="hljs-selector-tag">GI___libc_open</span></span> + 6<span class="hljs-selector-class"><span class="hljs-selector-class">.44</span></span>% __<span class="hljs-selector-tag"><span class="hljs-selector-tag">getdents64</span></span> + 4<span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span>% __<span class="hljs-selector-tag"><span class="hljs-selector-tag">close</span></span></code> </pre> <br><p>  Es ist ersichtlich, dass nur etwa 60% der Zeit im Systemaufruf read () verbracht wurden.  Wenn Sie sich das Profil genauer ansehen, stellt sich heraus, dass 45% der Zeit in den Kernelfunktionen seq_printf, seq_put_decimal_ull verwendet wird.  Das Konvertieren vom Bin√§r- in das Textformat ist daher eine ziemlich kostspielige Operation.  Was die begr√ºndete Frage aufwirft: Brauchen wir wirklich eine Textschnittstelle, um Daten aus dem Kernel zu ziehen?  Wie oft m√∂chten Benutzer mit Rohdaten arbeiten?  Und warum m√ºssen die Dienstprogramme top und ps diese Textdaten wieder in Bin√§rdaten konvertieren? </p><br><p>  Es w√§re wahrscheinlich interessant zu wissen, wie viel schneller die Ausgabe w√§re, wenn Bin√§rdaten direkt verwendet w√ºrden und drei Systemaufrufe nicht erforderlich w√§ren. </p><br><p>  Es wurden bereits Versuche unternommen, eine solche Schnittstelle zu erstellen.  Im Jahr 2004 haben wir versucht, die Netlink-Engine zu verwenden. </p><br><pre> <code class="hljs markdown">[<span class="hljs-string"><span class="hljs-string">0/2</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">ANNOUNCE</span></span>] nproc: netlink access to /proc information (https://lwn.net/Articles/99600/) nproc is an attempt to address the current problems with /proc. In short, it exposes the same information via netlink (implemented for a small subset).</code> </pre> <br><p>  Leider hat die Community kein gro√ües Interesse an dieser Arbeit gezeigt.  Einer der letzten Versuche, die Situation zu korrigieren, fand vor zwei Jahren statt. </p><br><pre> <code class="hljs cs">[<span class="hljs-meta"><span class="hljs-meta">PATCH 0/15</span></span>] task_diag: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">add</span></span></span><span class="hljs-function"> a new </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">interface</span></span></span><span class="hljs-function"> to </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">get</span></span></span><span class="hljs-function"> information about </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processes</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">https://lwn.net/Articles/</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">683371</span></span></span></span><span class="hljs-function"><span class="hljs-params">/</span></span></span><span class="hljs-function">)</span></span></code> </pre> <br><p>  Die Task-Diag-Schnittstelle basiert auf folgenden Prinzipien: </p><br><ul><li>  Transaktion: Anfrage gesendet, Antwort erhalten; </li><li>  Das Format der Nachrichten hat die Form eines Netlinks (dasselbe wie die Schnittstelle sock_diag: bin√§r und erweiterbar). </li><li>  Die M√∂glichkeit, Informationen zu vielen Prozessen in einem Aufruf anzufordern. </li><li>  Optimierte Gruppierung von Attributen (jedes Attribut in der Gruppe sollte die Antwortzeit nicht verl√§ngern). </li></ul><br><p>  Diese Schnittstelle wurde auf mehreren Konferenzen vorgestellt.  Es wurde in pstools, CRIU-Dienstprogramme und David Ahern integriert, um task_diag als Experiment in perf zu integrieren. </p><br><p>  Die Kernel-Entwicklergemeinde hat sich f√ºr die Schnittstelle task_diag interessiert.  Das Hauptthema der Diskussion war die Wahl des Transports zwischen dem Kernel und dem Benutzerraum.  Die urspr√ºngliche Idee, Netlink-Sockets zu verwenden, wurde abgelehnt.  Teilweise aufgrund ungel√∂ster Probleme im Code der Netlink-Engine selbst und teilweise, weil viele Leute denken, dass die Netlink-Schnittstelle ausschlie√ülich f√ºr das Netzwerk-Subsystem entwickelt wurde.  Dann wurde vorgeschlagen, Transaktionsdateien in procfs zu verwenden, dh der Benutzer √∂ffnet die Datei, schreibt die Anforderung hinein und liest dann einfach die Antwort.  Wie √ºblich gab es Gegner dieses Ansatzes.  Eine L√∂sung, die jeder gerne h√§tte, bis sie gefunden ist. </p><br><p>  Vergleichen wir die Leistung von task_diag mit procfs. </p><br><p>  Die task_diag-Engine verf√ºgt √ºber ein Testdienstprogramm, das f√ºr unsere Experimente gut geeignet ist.  Angenommen, wir m√∂chten Prozesskennungen und ihre Rechte anfordern.  Unten ist die Ausgabe f√ºr einen Prozess: </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> ./task_diag_all one <span class="hljs-literal"><span class="hljs-literal">-c</span></span> <span class="hljs-literal"><span class="hljs-literal">-p</span></span> <span class="hljs-variable"><span class="hljs-variable">$</span></span><span class="hljs-variable"><span class="hljs-variable">$</span></span> pid <span class="hljs-number"><span class="hljs-number">2305</span></span> tgid <span class="hljs-number"><span class="hljs-number">2305</span></span> ppid <span class="hljs-number"><span class="hljs-number">2299</span></span> sid <span class="hljs-number"><span class="hljs-number">2305</span></span> pgid <span class="hljs-number"><span class="hljs-number">2305</span></span> comm bash uid: <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> gid: <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> CapInh: <span class="hljs-number"><span class="hljs-number">0000000000000000</span></span> CapPrm: <span class="hljs-number"><span class="hljs-number">0000000000000000</span></span> CapEff: <span class="hljs-number"><span class="hljs-number">0000000000000000</span></span> CapBnd: <span class="hljs-number"><span class="hljs-number">0000003</span></span>fffffffff</code> </pre> <br><p>  Und jetzt f√ºr alle Prozesse im System, das hei√üt, dasselbe, was wir f√ºr das procfs-Experiment getan haben, als wir die Datei / proc / pid / status gelesen haben: </p><br><pre> <code class="hljs pgsql">$ <span class="hljs-type"><span class="hljs-type">time</span></span> ./task_diag_all <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> -c <span class="hljs-type"><span class="hljs-type">real</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.048</span></span>s <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.001</span></span>s sys <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.046</span></span>s</code> </pre> <br><p>  Es dauerte nur 0,05 Sekunden, bis die Daten zum Erstellen des Prozessbaums abgerufen wurden.  Und mit procfs dauerte es nur 0,177 Sekunden, um eine Datei f√ºr jeden Prozess zu √∂ffnen, ohne Daten zu lesen. </p><br><p>  Perf-Ausgabe f√ºr die Schnittstelle task_diag: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 82<span class="hljs-selector-class"><span class="hljs-selector-class">.24</span></span>% 0<span class="hljs-selector-class"><span class="hljs-selector-class">.00</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">task_diag_all</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[kernel.vmlinux]</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[k]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">entry_SYSCALL_64_fastpath</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">entry_SYSCALL_64_fastpath</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 81<span class="hljs-selector-class"><span class="hljs-selector-class">.84</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">sys_read</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">vfs_read</span></span> __<span class="hljs-selector-tag"><span class="hljs-selector-tag">vfs_read</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">proc_reg_read</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">task_diag_read</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">taskdiag_dumpit</span></span> + 33<span class="hljs-selector-class"><span class="hljs-selector-class">.84</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">next_tgid</span></span> 13<span class="hljs-selector-class"><span class="hljs-selector-class">.06</span></span>% __<span class="hljs-selector-tag"><span class="hljs-selector-tag">task_pid_nr_ns</span></span> + 6<span class="hljs-selector-class"><span class="hljs-selector-class">.63</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">ptrace_may_access</span></span> + 5<span class="hljs-selector-class"><span class="hljs-selector-class">.68</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">from_kuid_munged</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 4<span class="hljs-selector-class"><span class="hljs-selector-class">.19</span></span>% __<span class="hljs-selector-tag"><span class="hljs-selector-tag">get_task_comm</span></span> 2<span class="hljs-selector-class"><span class="hljs-selector-class">.90</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">strncpy</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.29</span></span>% _<span class="hljs-selector-tag"><span class="hljs-selector-tag">raw_spin_lock</span></span> 3<span class="hljs-selector-class"><span class="hljs-selector-class">.03</span></span>% __<span class="hljs-selector-tag"><span class="hljs-selector-tag">nla_reserve</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.73</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">nla_reserve</span></span> + 1<span class="hljs-selector-class"><span class="hljs-selector-class">.30</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">skb_copy_datagram_iter</span></span> + 1<span class="hljs-selector-class"><span class="hljs-selector-class">.21</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">from_kgid_munged</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.12</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">strncpy</span></span></code> </pre> <br><p>  Die Auflistung selbst enth√§lt nichts Interessantes au√üer der Tatsache, dass es keine offensichtlichen Funktionen gibt, die f√ºr die Optimierung geeignet sind. </p><br><p>  Schauen wir uns die Perf-Ausgabe an, wenn wir Informationen zu allen Prozessen im System lesen: </p><br><pre> <code class="hljs pgsql"> $ perf trace -s ./task_diag_all <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> -c -q <span class="hljs-keyword"><span class="hljs-keyword">Summary</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> events: task_diag_all (<span class="hljs-number"><span class="hljs-number">54326</span></span>), <span class="hljs-number"><span class="hljs-number">185</span></span> events, <span class="hljs-number"><span class="hljs-number">95.4</span></span>% syscall calls total min avg max stddev (msec) (msec) (msec) (msec) (%) <span class="hljs-comment"><span class="hljs-comment">--------------- -------- --------- --------- --------- --------- ------ read 49 40.209 0.002 0.821 4.126 9.50% mmap 11 0.051 0.003 0.005 0.007 9.94% mprotect 8 0.047 0.003 0.006 0.009 10.42% openat 5 0.042 0.005 0.008 0.020 34.86% munmap 1 0.014 0.014 0.014 0.014 0.00% fstat 4 0.006 0.001 0.002 0.002 10.47% access 1 0.006 0.006 0.006 0.006 0.00% close 4 0.004 0.001 0.001 0.001 2.11% write 1 0.003 0.003 0.003 0.003 0.00% rt_sigaction 2 0.003 0.001 0.001 0.002 15.43% brk 1 0.002 0.002 0.002 0.002 0.00% prlimit64 1 0.001 0.001 0.001 0.001 0.00% arch_prctl 1 0.001 0.001 0.001 0.001 0.00% rt_sigprocmask 1 0.001 0.001 0.001 0.001 0.00% set_robust_list 1 0.001 0.001 0.001 0.001 0.00% set_tid_address 1 0.001 0.001 0.001 0.001 0.00%</span></span></code> </pre> <br><p>  F√ºr procfs m√ºssen wir mehr als 150.000 Systemaufrufe durchf√ºhren, um Informationen √ºber alle Prozesse zu erhalten, und f√ºr task_diag - etwas mehr als 50. </p><br><p>  Schauen wir uns reale Situationen an.  Zum Beispiel m√∂chten wir einen Prozessbaum zusammen mit Befehlszeilenargumenten f√ºr jedes anzeigen.  Dazu m√ºssen wir die PID des Prozesses, die PID des √ºbergeordneten Prozesses und die Befehlszeilenargumente selbst herausziehen. </p><br><p>  F√ºr die Schnittstelle task_diag sendet das Programm eine Anforderung, um alle Parameter gleichzeitig abzurufen: </p><br><pre> <code class="hljs go">$ time ./task_diag_all all --cmdline -q <span class="hljs-built_in"><span class="hljs-built_in">real</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.096s</span></span> user <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.006s</span></span> sys <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.090s</span></span></code> </pre> <br><p>  F√ºr die urspr√ºnglichen Prozesse m√ºssen wir f√ºr jeden Prozess / proc // status und / proc // cmdline lesen: <br></p><pre> <code class="hljs go">$ time ./task_proc_all status tasks: <span class="hljs-number"><span class="hljs-number">50278</span></span> <span class="hljs-built_in"><span class="hljs-built_in">real</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.463s</span></span> user <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.030s</span></span> sys <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.427s</span></span></code> </pre> <br><pre> <code class="hljs go">$ time ./task_proc_all cmdline tasks: <span class="hljs-number"><span class="hljs-number">50281</span></span> <span class="hljs-built_in"><span class="hljs-built_in">real</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.270s</span></span> user <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.028s</span></span> sys <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.237s</span></span></code> </pre> <br><p>  Es ist leicht zu bemerken, dass task_diag siebenmal schneller ist als procfs (0,096 gegen√ºber 0,27 + 0,46).  Normalerweise ist eine Leistungsverbesserung von mehreren Prozent bereits ein gutes Ergebnis, aber hier hat sich die Geschwindigkeit um fast eine Gr√∂√üenordnung erh√∂ht. </p><br><p>  Erw√§hnenswert ist auch, dass die Erstellung interner Kernelobjekte die Leistung stark beeinflusst.  Insbesondere wenn das Speichersubsystem stark ausgelastet ist.  Vergleichen Sie die Anzahl der f√ºr procfs und task_diag erstellten Objekte: </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> perf trace -<span class="hljs-literal"><span class="hljs-literal">-event</span></span> <span class="hljs-string"><span class="hljs-string">'kmem:*alloc*'</span></span> ./task_proc_all status <span class="hljs-number"><span class="hljs-number">2</span></span>&gt;&amp;<span class="hljs-number"><span class="hljs-number">1</span></span> | grep kmem | wc <span class="hljs-literal"><span class="hljs-literal">-l</span></span> <span class="hljs-number"><span class="hljs-number">58184</span></span> <span class="hljs-variable"><span class="hljs-variable">$</span></span> perf trace -<span class="hljs-literal"><span class="hljs-literal">-event</span></span> <span class="hljs-string"><span class="hljs-string">'kmem:*alloc*'</span></span> ./task_diag_all all <span class="hljs-literal"><span class="hljs-literal">-q</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>&gt;&amp;<span class="hljs-number"><span class="hljs-number">1</span></span> | grep kmem | wc <span class="hljs-literal"><span class="hljs-literal">-l</span></span> <span class="hljs-number"><span class="hljs-number">188</span></span></code> </pre> <br><p>  Au√üerdem m√ºssen Sie herausfinden, wie viele Objekte beim Starten eines einfachen Prozesses erstellt werden, z. B. das wahre Dienstprogramm: </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> perf trace -<span class="hljs-literal"><span class="hljs-literal">-event</span></span> <span class="hljs-string"><span class="hljs-string">'kmem:*alloc*'</span></span> true <span class="hljs-number"><span class="hljs-number">2</span></span>&gt;&amp;<span class="hljs-number"><span class="hljs-number">1</span></span> | wc <span class="hljs-literal"><span class="hljs-literal">-l</span></span> <span class="hljs-number"><span class="hljs-number">94</span></span></code> </pre> <br><p>  Procfs erstellt 600-mal mehr Objekte als task_diag.  Dies ist einer der Gr√ºnde, warum procfs bei hoher Speicherauslastung so schlecht funktioniert.  Zumindest lohnt es sich deshalb, es zu optimieren. </p><br><p>  Wir hoffen, dass der Artikel mehr Entwickler anzieht, um den procfs-Status des Kernel-Subsystems zu optimieren. </p><br><p>  Vielen Dank an David Ahern, Andy Lutomirski, Stephen Hemming, Oleg Nesterov, W. Trevor King, Arnd Bergmann, Eric W. Biederman und viele andere, die zur Entwicklung und Verbesserung der Schnittstelle task_diag beigetragen haben. </p><br><p>  Vielen Dank an <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link">cromer</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link">k001</a> und Stanislav Kinsbursky f√ºr die Hilfe beim Schreiben dieses Artikels. </p><br><h1 id="ssylki">  Referenzen </h1><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">https://github.com/avagin/linux-task-diag/tree/v4.16-task-diag-20180427/tools/testing/selftests/task_diag</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">https://lwn.net/Articles/685791/</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">https://www.slideshare.net/KirKolyshkin/time-to-rethink-proc</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">https://www.slideshare.net/kolyshkin/speeding-up-ps-and-top</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">https://blog.linuxplumbersconf.org/2016/ocw/system/presentations/4599/original/Netlink-issues.pdf</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de418715/">https://habr.com/ru/post/de418715/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de418701/index.html">Wir studieren syntaktische Parser f√ºr die russische Sprache</a></li>
<li><a href="../de418705/index.html">Futex-Grundlagen</a></li>
<li><a href="../de418709/index.html">M√ºssen Sie sich zwingen: Treiber und Schnittstellenbarrieren</a></li>
<li><a href="../de418711/index.html">Token Managed Registers 1.0</a></li>
<li><a href="../de418713/index.html">Spiel zur Verbesserung der Qualit√§t von Wikipedia</a></li>
<li><a href="../de418717/index.html">Unicode-Geister</a></li>
<li><a href="../de418721/index.html">Legenden der Virentechnik: Beginn des Krieges</a></li>
<li><a href="../de418723/index.html">Patch AndroidX</a></li>
<li><a href="../de418725/index.html">Magische Konstante</a></li>
<li><a href="../de418727/index.html">Wo und wie man in Graph-Einbettungen kommt</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>