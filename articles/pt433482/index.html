<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üñäÔ∏è ü§¥ üë©üèæ‚Äç‚úàÔ∏è Django sob microsc√≥pio ü§∞üèΩ üåî üë®‚Äçüöí</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Se, de acordo com o relat√≥rio de Artyom Malyshev ( proofit404 ), eles fizerem um filme, o diretor ser√° Quentin Tarantino - ele j√° fez um filme sobre D...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Django sob microsc√≥pio</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/433482/">  Se, de acordo com o relat√≥rio de Artyom Malyshev ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">proofit404</a> ), eles fizerem um filme, o diretor ser√° Quentin Tarantino - ele j√° fez um filme sobre Django, e tamb√©m o segundo.  Todos os detalhes da vida √∫til dos mecanismos internos do Django, desde o primeiro byte da solicita√ß√£o HTTP at√© o √∫ltimo byte da resposta.  A extravag√¢ncia de formas de analisador, compila√ß√£o de SQL cheia de a√ß√£o, efeitos especiais da implementa√ß√£o do mecanismo de modelo para HTML.  Quem est√° gerenciando o pool de conex√µes e como?  Tudo isso em ordem cronol√≥gica de processamento de objetos WSGI.  Em todas as telas do pa√≠s - a decodifica√ß√£o "Django sob microsc√≥pio". <br><br><img src="https://habrastorage.org/webt/np/fq/rq/npfqrqbbgfwn2lktbgdq9h4xhgg.jpeg"><br><br>  <strong>Sobre o palestrante: Artyom Malyshev</strong> √© o fundador do projeto Dry Python e o desenvolvedor principal do Django Channels vers√£o 1.0.  Ele escreve Python h√° 5 anos e ajudou a organizar reuni√µes do Python Rannts em Nizhny Novgorod.  Artyom pode ser familiar para voc√™ sob o apelido <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">PROOFIT404</a> .  A apresenta√ß√£o do relat√≥rio √© armazenada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . <br><a name="habracut"></a><br><iframe width="560" height="315" src="https://www.youtube.com/embed/AvGl7Vi2yT4" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Era uma vez, lan√ßamos a vers√£o antiga do Django.  Ent√£o ela parecia assustadora e triste. <br><br><img src="https://habrastorage.org/webt/yv/i5/a9/yvi5a9ueicvuhwgsyf8npzvojne.jpeg"><br><br>  Eles viram que o <code>self_check</code> passou, instalamos tudo corretamente, tudo funcionou e agora voc√™ pode escrever c√≥digo.  Para conseguir tudo isso, tivemos que executar o <code>django-admin runserver</code> . <br><br><pre> <code class="plaintext hljs">$ django-admin runserver Performing system checks‚Ä¶ System check identified no issues (0 silenced). You have unapplied migrations; your app may not work properly until they are applied. Run 'python manage.py migrate1 to apply them. August 21, 2018 - 15:50:53 Django version 2.1, using settings 'mysite.settings' Starting development server at http://127.0.0.1:8000/Quit the server with CONTROL-C.</code> </pre><br>  O processo inicia, processa solicita√ß√µes HTTP e toda a m√°gica acontece dentro e todo o c√≥digo que queremos mostrar aos usu√°rios como um site √© executado. <br><br><h2>  Instala√ß√£o <br></h2><br>  <code>django-admin</code> aparece no sistema quando instalamos o Django usando, por exemplo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">pip, o gerenciador de pacotes</a> . <br><br><pre> <code class="python hljs">$ pip install Django <span class="hljs-comment"><span class="hljs-comment"># setup.py from setuptools import find_packages, setup setup( name='Django', entry_points={ 'console_scripts': [ 'django-admin = django.core.management:execute_from_command_line' ] }, )</span></span></code> </pre><br>  <code>entry_points setuptools</code> , que aponta para a fun√ß√£o <code>execute_from_command_line</code> .  Esta fun√ß√£o √© um ponto de entrada para qualquer opera√ß√£o com o Django, para qualquer processo atual. <br><br><h3>  Bootstrap <br></h3><br>  O que acontece dentro de uma fun√ß√£o?  <strong>Bootstrap</strong> , que √© dividido em duas itera√ß√µes. <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.core.management django.setup().</span></span></code> </pre><br><h4>  Definir configura√ß√µes <br></h4><br>  O primeiro √© <strong>ler configura√ß√µes</strong> : <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> django.conf.global_settings import_module(os.environ[<span class="hljs-string"><span class="hljs-string">"DJANGO_SETTINGS_MODULE"</span></span>])</code> </pre><br>  As configura√ß√µes padr√£o <code>global_settings</code> , a partir da vari√°vel de ambiente, tentamos encontrar o m√≥dulo com <code>DJANGO_SETTINGS_MODULE</code> , que o usu√°rio escreveu.  Essas configura√ß√µes s√£o combinadas em um espa√ßo para nome. <br><br>  Qualquer um que escreve no Django pelo menos ‚ÄúOl√°, mundo‚Äù sabe que existe <code>INSTALLED_APPS</code> - onde escrevemos o c√≥digo do usu√°rio. <br><br><h4>  Preencher aplicativos <br></h4><br>  Na segunda parte, todos esses aplicativos, essencialmente pacotes, s√£o iterados um por um.  Criamos para cada configura√ß√£o, importamos modelos para trabalhar com um banco de dados e verificamos a integridade dos modelos.  Al√©m disso, a estrutura executa <code>Check</code> , ou seja, verifica se cada modelo possui uma chave prim√°ria, todas as chaves estrangeiras apontam para os campos existentes e se o campo Null n√£o est√° gravado no BooleanField, mas o NullBooleanField √© usado. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> entry <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> settings.INSTALLED_APPS: cfg = AppConfig.create(entry) cfg.import_models()</code> </pre><br>  Esta √© a verifica√ß√£o m√≠nima de sanidade para modelos, para o painel de administra√ß√£o, para qualquer coisa - sem conectar ao banco de dados, sem algo super complicado e espec√≠fico.  Nesta fase, o Django ainda n√£o sabe qual comando voc√™ pediu para executar, ou seja, n√£o distingue <code>migrate</code> do <code>runserver</code> ou <code>shell</code> . <br><br>  Ent√£o nos encontramos em um m√≥dulo que tenta adivinhar, por argumentos da linha de comando, qual comando queremos executar e em qual aplicativo ele se encontra. <br><br><h2>  Comando de gerenciamento <br></h2><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.core.management subcommand = sys.argv[1] app_name = find(pkgutils.iter_modules(settings.INSTALLED_APPS)) module = import_module( '%s.management.commands.%s' % (app_name, subcommand) ) cmd = module.Command() cmd.run_from_argv(self.argv)</span></span></code> </pre><br>  Nesse caso, o m√≥dulo runserver ter√° um m√≥dulo <code>django.core.management.commands.runserver</code> interno.  Depois de importar o m√≥dulo, por conven√ß√£o, a classe global <code>Command</code> √© chamada dentro, √© instanciada e dizemos: " <em>Encontrei voc√™, aqui voc√™ tem os argumentos da linha de comando que o usu√°rio passou, fa√ßa algo com eles</em> ". <br><br>  Em seguida, vamos ao m√≥dulo runserver e vemos que o <b>Django √© feito de "regexp and sticks"</b> , sobre o qual falarei em detalhes hoje: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.core.management.commands.runserver naiveip_re = re.compile(r"""^(?: (?P&lt;addr&gt; (?P&lt;ipv4&gt;\d{1,3}(?:\.\d{1,3}){3}) | # IPv4 address (?P&lt;ipv6&gt;\[[a-fA-F0-9:]+\]) | # IPv6 address (?P&lt;fqdn&gt;[a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*) # FQDN ):)?(?P&lt;port&gt;\d+)$""", re.X)</span></span></code> </pre><br><h3>  Comandos <br></h3><br>  Role uma tela e meia - finalmente chegamos √† defini√ß√£o de nossa equipe que inicia o servidor. <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.core.management.commands.runserver class Command(BaseCommand): def handle(self, *args, **options): httpd = WSGIServer(*args, **options) handler = WSGIHandler() httpd.set_app(handler) httpd.serve_forever()</span></span></code> </pre><br>  <code>BaseCommand</code> executa um conjunto m√≠nimo de opera√ß√µes para que os argumentos da linha de comando resultem em argumentos para chamar as fun√ß√µes de <code>**options</code> <code>*args</code> e <code>**options</code> .  Vemos que a inst√¢ncia do servidor WSGI est√° sendo criada aqui, o WSGIHandler global est√° instalado neste servidor WSGI - este √© exatamente o <strong>God Object Django</strong> .  Podemos dizer que esta √© a √∫nica inst√¢ncia do framework.  A inst√¢ncia √© instalada no servidor globalmente - atrav√©s do <code>set application</code> e diz: "Gire no loop de eventos, execute solicita√ß√µes". <br><br><blockquote>  Sempre h√° um loop de eventos em algum lugar e um programador que lhe d√° tarefas. <br></blockquote><br><h2>  Servidor WSGI <br></h2><br>  O que √© o <strong>WSGIHandler</strong> ?  O WSGI √© uma interface que permite processar solicita√ß√µes HTTP com um n√≠vel m√≠nimo de abstra√ß√£o e se parece com algo na forma de uma fun√ß√£o. <br><br><h3>  Manipulador WSGI <br></h3><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.core.handlers.wsgi class WSGIHandler: def __call__(self, environ, start_response): signals.request_started.send() request = WSGIRequest(environ) response = self.get_response(request) start_response(response.status, response.headers) return response</span></span></code> </pre><br>  Por exemplo, aqui est√° uma inst√¢ncia de uma classe que possui uma <code>call</code> definida.  Ele espera pela entrada do dicion√°rio, na qual os cabe√ßalhos ser√£o apresentados como bytes e como manipulador de arquivos.  O manipulador √© necess√°rio para ler o <code>&lt;body&gt;</code> solicita√ß√£o.  O pr√≥prio servidor tamb√©m fornece retorno de chamada <code>start_response</code> para que possamos enviar <code>response.headers</code> e seu cabe√ßalho, por exemplo, status, em um pacote. <br><br>  Al√©m disso, podemos passar o corpo da resposta para o servidor atrav√©s do objeto de resposta.  <strong>A resposta</strong> √© um gerador sobre o qual voc√™ pode iterar. <br><br>  Todos os servidores escritos para WSGI - Gunicorn, uWSGI, Waitress, trabalham nessa interface e s√£o intercambi√°veis.  Agora estamos considerando um servidor para desenvolvimento, mas qualquer servidor chega ao ponto em que no Django ele atravessa o ambiente e o retorno de chamada. <br><br><h2>  O que h√° dentro de Deus Object? <br></h2><br>  O que acontece dentro dessa fun√ß√£o global de Objeto Deus dentro do Django? <br><br><ul><li>  PEDIDO. </li><li>  MIDDLEWARES. </li><li>  ROUTING para visualizar. </li><li>  VIEW - processamento de c√≥digo do usu√°rio dentro da view. </li><li>  FORMUL√ÅRIO - trabalhe com formul√°rios. </li><li>  ORM. </li><li>  MODELO </li><li>  RESPOSTA. </li></ul><br>  Todo o maquin√°rio que queremos do Django ocorre em uma √∫nica fun√ß√£o, que est√° espalhada por toda a estrutura. <br><br><h3>  Pedido <br></h3><br>  N√≥s agrupamos o ambiente WSGI, que √© um dicion√°rio simples, em algum objeto especial, para a conveni√™ncia de trabalhar com o ambiente.  Por exemplo, √© mais conveniente descobrir a dura√ß√£o de uma solicita√ß√£o do usu√°rio trabalhando com algo semelhante a um dicion√°rio do que com uma sequ√™ncia de bytes que precisa ser analisada e procurar por entradas de valor-chave.  Ao trabalhar com cookies, tamb√©m n√£o quero calcular manualmente se o per√≠odo de armazenamento expirou ou n√£o e de alguma forma interpret√°-lo. <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.core.handlers.wsgi class WSGIRequest(HttpRequest): @cached_property def GET(self): return QueryDict(self.environ['QUERY_STRING']) @property def POST(self): self._load_post_and_files() return self._post @cached_property def COOKIES(self): return parse_cookie(self.environ['HTTP_COOKIE'])</span></span></code> </pre><br>  A solicita√ß√£o cont√©m analisadores, bem como um conjunto de manipuladores para controlar o processamento do corpo da solicita√ß√£o POST: se √© um arquivo na mem√≥ria ou tempor√°rio no armazenamento em disco.  Tudo √© decidido dentro da solicita√ß√£o.  A requisi√ß√£o no Django tamb√©m √© um objeto agregador no qual todos os middlewares podem colocar as informa√ß√µes necess√°rias sobre a sess√£o, autentica√ß√£o e autoriza√ß√£o do usu√°rio.  Podemos dizer que este tamb√©m √© um Objeto Divino, mas menor. <br><br>  Solicita√ß√£o adicional chega ao middleware. <br><br><h3>  Middlewares <br></h3><br>  <strong>Middleware</strong> √© um inv√≥lucro que envolve outras fun√ß√µes como um decorador.  Antes de abrir m√£o do controle do middleware, no m√©todo de chamada, respondemos ou chamamos um middleware j√° empacotado. <br><br>  √â assim que o middleware se parece do ponto de vista de um programador. <br><br><h4>  Configura√ß√µes <br></h4><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># settings.py MIDDLEWARE = [ 'django.middleware.security.SecurityMiddleware', 'django.middleware.csrf.CsrfViewMiddleware', 'django.contrib.sessions.middleware.SessionMiddleware', 'django.contrib.auth.middleware.AuthenticationMiddleware', ]</span></span></code> </pre><br><h4>  Definir <br></h4><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Middleware</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, get_response=None)</span></span></span><span class="hljs-function">:</span></span> self.get_response = get_response <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__call__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, request)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.get_response(request)</code> </pre><br>  Do ponto de vista do Django, os middlewares parecem uma esp√©cie de pilha: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.core.handlers.base def load_middleware(self): handler = convert_exception_to_response(self._get_response) for middleware_path in reversed(settings.MIDDLEWARE): middleware = import_string(middleware_path) instance = middleware(handler) handler = convert_exception_to_response(instance) self._middleware_chain = handler</span></span></code> </pre><br><h4>  Aplicar <br></h4><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_response</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, request)</span></span></span><span class="hljs-function">:</span></span> set_urlconf(settings.ROOT_URLCONF) response = self._middleware_chain(request) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> response</code> </pre><br>  Pegamos a fun√ß√£o <code>get_response</code> inicial, envolvemos-a em um manipulador, que traduzir√°, por exemplo, <code>permission error</code> e <code>permission error</code> <code>not found error</code> no c√≥digo HTTP correto.  Envolvemos tudo no middleware em si da lista.  A pilha de middlewares cresce e cada pr√≥xima envolve a anterior.  Isso √© muito semelhante √† aplica√ß√£o da mesma pilha de decoradores em todas as visualiza√ß√µes de um projeto, apenas centralmente.  N√£o h√° necessidade de sair e organizar os inv√≥lucros com as m√£os de acordo com o projeto, tudo √© conveniente e l√≥gico. <br><br>  Passamos por 7 c√≠rculos de middlewares, nossa solicita√ß√£o sobreviveu e decidimos process√°-la √† vista.  Al√©m disso, chegamos ao m√≥dulo de roteamento. <br><br><h3>  Encaminhamento <br></h3><br>  √â aqui que decidimos qual manipulador solicitar uma solicita√ß√£o espec√≠fica.  E isso est√° resolvido: <br><br><ul><li>  com base no URL; </li><li>  na especifica√ß√£o WSGI, em que request.path_info √© chamado. </li></ul><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.core.handlers.base def _get_response(self, request): resolver = get_resolver() view, args, kwargs = resolver.resolve(request.path_info) response = view(request, *args, **kwargs) return response</span></span></code> </pre><br><h4>  URLs <br></h4><br>  Pegamos o resolvedor, alimentamos o URL de solicita√ß√£o atual e esperamos que ele retorne a fun√ß√£o view, e a partir do mesmo URL obteremos os argumentos com os quais chamar o view.  Ent√£o, <code>get_response</code> chama a visualiza√ß√£o, lida com exce√ß√µes e faz algo com ela. <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># urls.py urlpatterns = [ path('articles/2003/', views.special_case_2003), path('articles/&lt;int:year&gt;/', views.year_archive), path('articles/&lt;int:year&gt;/&lt;int:month&gt;/', views.month_archive) ]</span></span></code> </pre><br><h4>  Resolver <br></h4><br>  √â assim que o resolvedor se parece: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.urls.resolvers _PATH_RE = re.compile( r'&lt;(?:(?P&lt;converter&gt;[^&gt;:]+):)?(?P&lt;parameter&gt;\w+)&gt;' ) def resolve(self, path): for pattern in self.url_patterns: match = pattern.search(path) if match: return ResolverMatch( self.resolve(match[0]) ) raise Resolver404({'path': path})</span></span></code> </pre><br>  Isso tamb√©m √© regexp, mas recursivo.  Ele entra em partes do URL, procura o que o usu√°rio deseja: outros usu√°rios, postagens, blogs ou √© algum tipo de conversor, por exemplo, um ano espec√≠fico que precisa ser resolvido, colocado em argumentos, convertido em int. <br><br>  √â caracter√≠stico que a profundidade da recurs√£o do m√©todo de resolu√ß√£o seja sempre igual ao n√∫mero de argumentos com os quais a exibi√ß√£o √© chamada.  Se algo deu errado e n√£o encontramos um URL espec√≠fico, ocorre um erro n√£o encontrado. <br><br>  Ent√£o finalmente chegamos √† vista - o c√≥digo que o programador escreveu. <br><br><h3>  Ver <br></h3><br>  Em sua representa√ß√£o mais simples, √© uma fun√ß√£o que retorna solicita√ß√£o de resposta, mas dentro dela realizamos tarefas l√≥gicas: ‚Äúpara, se algum dia‚Äù - muitas tarefas repetitivas.  O Django nos fornece uma vis√£o baseada em classe, onde voc√™ pode especificar detalhes espec√≠ficos, e todo o comportamento ser√° interpretado no formato correto pela pr√≥pria classe. <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.views.generic.edit class ContactView(FormView): template_name = 'contact.html' form_class = ContactForm success_url = '/thanks/'</span></span></code> </pre><br><h4>  Fluxograma do m√©todo <br></h4><br><pre> <code class="python hljs">self.dispatch() self.post() self.get_form() self.form_valid() self.render_to_response()</code> </pre><br>  O m√©todo de <code>dispatch</code> desta inst√¢ncia j√° est√° no mapeamento de URL em vez de em uma fun√ß√£o.  A expedi√ß√£o baseada no verbo HTTP entende qual m√©todo chamar: O POST chegou at√© n√≥s e provavelmente queremos instanciar o objeto do formul√°rio, se o formul√°rio for v√°lido, salve-o no banco de dados e mostre o modelo.  Tudo isso √© feito atrav√©s do grande n√∫mero de mixins que comp√µem essa classe. <br><br><h3>  Formul√°rio <br></h3><br>  O formul√°rio deve ser lido no soquete antes de entrar na visualiza√ß√£o do Django - atrav√©s do mesmo manipulador de arquivos que se encontra no ambiente WSGI.  form-data √© um fluxo de bytes, no qual os separadores s√£o descritos - podemos ler esses blocos e fazer algo deles.  Pode ser uma correspond√™ncia de valor-chave, se for um campo, parte de um arquivo e, novamente, algum campo - tudo est√° misturado. <br><br><pre> <code class="python hljs">Content-Type: multipart/form-data;boundary=<span class="hljs-string"><span class="hljs-string">"boundary"</span></span> --boundary name=<span class="hljs-string"><span class="hljs-string">"field1"</span></span> value1 --boundary name=<span class="hljs-string"><span class="hljs-string">"field2"</span></span>; value2</code> </pre><br><h4>  Analisador <br></h4><br>  O analisador consiste em 3 partes. <br><br>  O iterador de partes que cria as leituras esperadas do fluxo de bytes se transforma em um iterador que pode produzir <code>boundaries</code> .  Garante que, se algo retornar, ser√° um limite.  Isso √© necess√°rio para que, dentro do analisador, n√£o seja necess√°rio armazenar o estado da conex√£o, ler do soquete ou n√£o ler para minimizar a l√≥gica do processamento de dados. <br><br>  Em seguida, o gerador envolve o <strong>LazyStream</strong> , que novamente cria um arquivo de objeto, mas com a leitura esperada.  Portanto, o analisador j√° pode percorrer peda√ßos de bytes e criar um valor-chave a partir deles. <br><br>  <strong>campo e dados aqui sempre ser√£o strings</strong> .  Se recebermos um hor√°rio de dados no formato ISO, o formul√°rio do Django (que foi escrito pelo programador) receber√°, usando certos campos, por exemplo, carimbo de data / hora. <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.http.multipartparser self._post = QueryDict(mutable=True) stream = LazyStream(ChunkIter(self._input_data)) for field, data in Parser(stream): self._post.append(field, force_text(data))</span></span></code> </pre><br>  Al√©m disso, o formul√°rio, provavelmente, quer se salvar em um banco de dados, e aqui o Django ORM come√ßa. <br><br><h3>  ORM <br></h3><br>  Aproximadamente atrav√©s desses pedidos DSL para ORM s√£o executados: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># models.py Entry.objects.exclude( pub_date__gt=date(2005, 1, 3), headline='Hello', )</span></span></code> </pre><br>  Usando chaves, voc√™ pode coletar express√µes SQL semelhantes: <br><br><pre> <code class="python hljs">SELECT * WHERE NOT (pub_date &gt; <span class="hljs-string"><span class="hljs-string">'2005-1-3'</span></span> AND headline = <span class="hljs-string"><span class="hljs-string">'Hello'</span></span>)</code> </pre><br>  Como est√° indo isso? <br><br><h4>  Queryset <br></h4><br>  O m√©todo de <code>exclude</code> tem um objeto de <code>Query</code> sob o cap√¥.  O objeto passa argumentos para a fun√ß√£o e cria uma hierarquia de objetos, cada um dos quais pode se transformar em uma parte separada da consulta SQL como uma sequ√™ncia. <br><br>  Ao percorrer a √°rvore, cada uma das se√ß√µes pesquisa seus n√≥s filhos, recebe consultas SQL aninhadas e, como resultado, podemos construir o SQL como uma string.  Por exemplo, o valor-chave n√£o ser√° um campo SQL separado, mas ser√° comparado com o valor-valor.  A concatena√ß√£o e a nega√ß√£o de consultas funcionam da mesma maneira que uma passagem de √°rvore recursiva, para cada n√≥ do qual uma convers√£o ao SQL √© chamada. <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.db.models.query sql.Query(Entry).where.add( ~Q( Q(F('pub_date') &gt; date(2005, 1, 3)) &amp; Q(headline='Hello') ) )</span></span></code> </pre><br><h4>  Compilador <br></h4><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.db.models.expressions class Q(tree.Node): AND = 'AND' OR = 'OR' def as_sql(self, compiler, connection): return self.template % self.field.get_lookup('gt')</span></span></code> </pre><br><h3>  Sa√≠da <br></h3><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>Q(headline=<span class="hljs-string"><span class="hljs-string">'Hello'</span></span>) <span class="hljs-comment"><span class="hljs-comment"># headline = 'Hello' &gt;&gt;&gt; F('pub_date') # pub_date &gt;&gt;&gt; F('pub_date') &gt; date(2005, 1, 3) # pub_date &gt; '2005-1-3' &gt;&gt;&gt; Q(...) &amp; Q(...) # ... AND ... &gt;&gt;&gt; ~Q(...) # NOT ‚Ä¶</span></span></code> </pre><br>  Um pequeno compilador auxiliar √© passado para esse m√©todo, que pode distinguir o dialeto do MySQL do PostgreSQL e organizar corretamente o a√ß√∫car sint√°tico usado no dialeto de um banco de dados espec√≠fico. <br><br><h3>  Roteamento de banco de dados <br></h3><br>  Quando recebemos a consulta SQL, o modelo bate no roteamento de banco de dados e pergunta em qual banco de dados ele est√°.  Em 99% dos casos, ser√° o banco de dados padr√£o, nos 1% restantes - algum tipo pr√≥prio. <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.db.utils class ConnectionRouter: def db_for_read(self, model, **hints): if model._meta.app_label == 'auth': return 'auth_db'</span></span></code> </pre><br>  O agrupamento de um driver de banco de dados de uma interface espec√≠fica da biblioteca, como Python MySQL ou Psycopg2, cria um objeto universal com o qual o Django pode trabalhar.  H√° um inv√≥lucro para cursores, um inv√≥lucro para transa√ß√µes. <br><br><h4>  Piscina de conex√£o <br></h4><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.db.backends.base.base class BaseDatabaseWrapper: def commit(self): self.validate_thread_sharing() self.validate_no_atomic_block() with self.wrap_database_errors: return self.connection.commit()</span></span></code> </pre><br>  Nesta conex√£o em particular, enviamos solicita√ß√µes para o soquete que est√° batendo no banco de dados e aguardamos a execu√ß√£o.  O wrapper da biblioteca ler√° a resposta humana do banco de dados na forma de um registro, e o Django coleta a inst√¢ncia do modelo desses dados nos tipos Python.  Esta n√£o √© uma itera√ß√£o complicada. <br><br>  Escrevemos algo no banco de dados, lemos algo e decidimos contar ao usu√°rio sobre ele usando a p√°gina HTML.  Para fazer isso, o Django tem uma linguagem de modelo n√£o-apreciada pela comunidade que se parece com uma linguagem de programa√ß√£o, apenas em um arquivo HTML. <br><br><h3>  Template <br></h3><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django.template.loader <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> render_to_string render_to_string(<span class="hljs-string"><span class="hljs-string">'my_template.html'</span></span>, {<span class="hljs-string"><span class="hljs-string">'entries'</span></span>: ...})</code> </pre><br><h4>  C√≥digo <br></h4><br><pre> <code class="python hljs">&lt;ul&gt; {% <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> entry <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> entries %} &lt;li&gt;{{ entry.name }}&lt;/li&gt; {% endfor %} &lt;/ul&gt;</code> </pre><br><h4>  Analisador <br></h4><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.template.base BLOCK_TAG_START = '{%' BLOCK_TAG_END = '%}' VARIABLE_TAG_START = '{{' VARIABLE_TAG_END = '}}' COMMENT_TAG_START = '{#' COMMENT_TAG_END = '#}' tag_re = (re.compile('(%s.*?%s|%s.*?%s|%s.*?%s)' % (re.escape(BLOCK_TAG_START), re.escape(BLOCK_TAG_END), re.escape(VARIABLE_TAG_START), re.escape(VARIABLE_TAG_END), re.escape(COMMENT_TAG_START), re.escape(COMMENT_TAG_END))))</span></span></code> </pre><br>  Surpresa - regexp novamente.  Somente no final deve haver uma v√≠rgula, e a lista ser√° muito abaixo.  Este √© provavelmente o regexp mais dif√≠cil que eu j√° vi neste projeto. <br><br><h3>  Lexer <br></h3><br>  O manipulador e o int√©rprete de modelos s√£o bastante simples.  Existe um lexer que usa o regexp para traduzir o texto em uma lista de pequenos tokens. <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.template.base def tokenize(self): for bit in tag_re.split(template_string): lineno += bit.count('\n') yield bit</span></span></code> </pre><br>  Repetimos a lista de fichas, veja: ‚ÄúQuem √© voc√™?  Envolva voc√™ em um n√≥ de tag. ‚Äù  Por exemplo, se este √© o in√≠cio de alguns <code>if</code> ou <code>for</code> ou <code>for</code> , o manipulador de tags usar√° o manipulador apropriado.  O manipulador <code>for</code> novamente diz ao analisador: "Leia-me uma lista de tokens at√© a tag de fechamento". <br><br>  A opera√ß√£o vai para o analisador novamente. <br><br><blockquote>  Um n√≥, tag e analisador s√£o coisas mutuamente recursivas, e a profundidade da recurs√£o geralmente √© igual ao aninhamento do pr√≥prio modelo por tags. <br></blockquote><br><h4>  Analisador <br></h4><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> tokens: token = tokens.pop() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> token.startswith(BLOCK_TAG_START): <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> TagNode(token) <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> token.startswith(VARIABLE_TAG_START): ...</code> </pre><br>  O manipulador de tags nos fornece um n√≥ espec√≠fico, por exemplo, com um loop for, para o qual o m√©todo <code>render</code> aparece. <br><br><h4>  For loop <br></h4><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.template.defaulttags @register.tag('for') def do_for(parser, token): args = token.split_contents() body = parser.parse(until=['endfor']) return ForNode(args, body)</span></span></code> </pre><br><h4>  Para o n√≥ <br></h4><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ForNode</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(Node)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">render</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, context)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> context.push(): <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> self.args: <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> self.body.render(context)</code> </pre><br>  O m√©todo de <code>render</code> √© uma √°rvore de renderiza√ß√£o.  Cada n√≥ superior pode ir para um n√≥ filha, pedir para ela renderizar.  Os programadores est√£o acostumados a mostrar algumas vari√°veis ‚Äã‚Äãneste modelo.  Isso √© feito atrav√©s do <code>context</code> - √© apresentado na forma de um dicion√°rio regular.  Esta √© uma pilha de dicion√°rios para emular um escopo quando inserimos uma tag.  Por exemplo, se o pr√≥prio <code>context</code> alterar alguma outra tag dentro do loop <code>for</code> , quando sairmos do loop, as altera√ß√µes ser√£o revertidas.  Isso √© conveniente porque, quando tudo √© global, √© dif√≠cil trabalhar. <br><br><h3>  Resposta <br></h3><br>  Finalmente conseguimos nossa linha com a resposta HTTP: <br><br><blockquote>  Ol√° Mundo! <br></blockquote><br>  Podemos dar a linha ao usu√°rio. <br><br><ul><li>  Retorne esta resposta da vista. </li><li>  Exibir listas de middlewares. </li><li>  Middlewares essa resposta modifica, complementa e aprimora. </li><li>  A resposta come√ßa a iterar dentro do WSGIHandler, √© parcialmente gravada no soquete e o navegador recebe uma resposta do nosso servidor. </li></ul><br>  Todas as startups famosas que foram escritas no Django, como Bitbucket ou Instagram, come√ßaram com um ciclo t√£o pequeno que todo programador passou. <br><br>  Tudo isso, e uma apresenta√ß√£o no Moscow Python Conf ++, √© necess√°rio para voc√™ entender melhor o que est√° em suas m√£os e como us√°-lo.  Em qualquer m√°gica, h√° uma grande parte do regexp que voc√™ deve poder cozinhar. <br><br><blockquote>  Artyom Malyshev e outros 23 grandes palestrantes <strong>em 5 de abril</strong> nos dar√£o novamente muita reflex√£o e discuss√£o sobre o t√≥pico Python na confer√™ncia <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Moscow Python Conf ++</a> .  Estude o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">cronograma</a> e participe da troca de experi√™ncias na solu√ß√£o de v√°rios problemas usando o Python. <br></blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt433482/">https://habr.com/ru/post/pt433482/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt433472/index.html">Lan√ßamento do Unity 2018.3</a></li>
<li><a href="../pt433474/index.html">Pil√£o de dentro para fora. Como ele faz isso</a></li>
<li><a href="../pt433476/index.html">50 tons de aipo</a></li>
<li><a href="../pt433478/index.html">Por que o Django √© escolhido na Revista Tinkoff</a></li>
<li><a href="../pt433480/index.html">Hist√≥ria de Holivarny sobre linter</a></li>
<li><a href="../pt433486/index.html">O que de novo? A recupera√ß√£o de cart√µes de d√©bito n√£o banc√°rios</a></li>
<li><a href="../pt433488/index.html">Christmas Scrum Meetup Transmiss√£o UPD mitap</a></li>
<li><a href="../pt433490/index.html">Revis√£o da impressora 3D Creality CR-X</a></li>
<li><a href="../pt433494/index.html">10 idiomas ingleses que voc√™ nunca conhecer√°</a></li>
<li><a href="../pt433496/index.html">Empresas estatais obrigadas a mudar para software dom√©stico at√© 2022</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>