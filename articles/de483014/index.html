<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë¶üèª üßúüèæ üëµüèº PostgreSQL-Nachrichtenwarteschlangen mit PgQ ü§üüèø ‚ô†Ô∏è üì∂</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nachrichtenwarteschlangen werden f√ºr folgende Aufgaben verwendet: ausstehende Vorg√§nge, Interaktion zwischen Diensten, Stapelverarbeitung usw. Es gibt...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>PostgreSQL-Nachrichtenwarteschlangen mit PgQ</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/483014/"><img src="https://habrastorage.org/webt/g4/5g/b1/g45gb1ef-etyywuggdsyiyr-lyk.jpeg"><br><br>  Nachrichtenwarteschlangen werden f√ºr folgende Aufgaben verwendet: ausstehende Vorg√§nge, Interaktion zwischen Diensten, Stapelverarbeitung usw.  Es gibt spezielle L√∂sungen f√ºr das Organisieren solcher Warteschlangen, wie z. B. RabbitMQ, ActiveMQ, ZeroMQ usw., aber es kommt h√§ufig vor, dass sie keinen gro√üen Bedarf haben und ihre Installation und Unterst√ºtzung mehr Schmerzen und Leiden verursachen als Vorteile bringen.  Angenommen, Sie haben bei der Registrierung einen Dienst, bei dem eine E-Mail zur Best√§tigung an den Benutzer gesendet wird, und wenn Sie Postgres verwenden, haben Sie Gl√ºck - in Postgres gibt es fast sofort eine PgQ-Erweiterung, die die ganze Drecksarbeit f√ºr Sie erledigt. <br><br>  In diesem Artikel werde ich √ºber Message Queuing (Aufgaben) in PostgreSQL unter Verwendung der PgQ-Erweiterung sprechen.  Dieser Artikel ist n√ºtzlich, wenn Sie PgQ nicht verwendet haben oder selbst geschriebene Warteschlangen √ºber Postgres verwenden. <br><br>  Warum brauchen Sie √ºberhaupt PgQ, wenn Sie nur ein Tablet erstellen und dort Aufgaben schreiben k√∂nnen?  Es scheint m√∂glich, aber Sie m√ºssen den parallelen Zugriff auf Aufgaben, m√∂gliche Fehler (was passiert, wenn der Prozess, der die Aufgabe bearbeitet, abst√ºrzt?) Sowie die Leistung ber√ºcksichtigen (PgQ ist sehr schnell und selbstgeschriebene L√∂sungen normalerweise nicht, insbesondere wenn die Transaktion ausgef√ºhrt wird) Die Datenbank wird nicht w√§hrend der gesamten Ausf√ºhrung der Aufgabe geschlossen. Der wichtigste Grund f√ºr die meiner Meinung nach notwendige Verwendung von PgQ ist jedoch, dass PgQ bereits geschrieben ist und funktioniert und die selbstgeschriebene L√∂sung noch geschrieben werden muss (UPD: Warum lohnt es sich nicht, selbstgeschriebene Warteschlangen zu verwenden? k√∂nnen Sie hier lesen). <br>  (UPD: Da PgQ auf Postgres l√§uft, k√∂nnen auch alle Vorz√ºge von Transaktionen darin verwendet werden.) <br><br>  Aber PgQ hat ein gro√ües Minus - die fehlende Dokumentation versuche ich mit diesem Artikel zu kompensieren. <br><a name="habracut"></a><br><h4>  Ger√§t </h4><br>  PgQ besteht aus Teilen (mindestens 2): 1 - die pgq-Erweiterung f√ºr postgres, 2 - der pgqd-Daemon (etwa, um sie etwas sp√§ter zu installieren). <br><br>  Alle Interaktionen mit der Warteschlange werden mithilfe von Funktionen in Postgres ausgef√ºhrt. <br><br>  Um beispielsweise eine Warteschlange zu erstellen, m√ºssen Sie ausf√ºhren <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pgq.create_queue({ } <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>);</code> </pre> <br>  Nachdem die Warteschlange erstellt wurde, k√∂nnen Sie ihr Nachrichten hinzuf√ºgen. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pgq.insert_event({ } <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, { } <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, {  } <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>);</code> </pre> <br>  Jetzt m√ºssen wir lernen, wie man aufgezeichnete Nachrichten empf√§ngt.  Hierf√ºr gibt es eine Entit√§t wie "Consumer" (ich werde einen Consumer schreiben), die keine Nachrichten (Ereignisse), sondern "Batch" (Batch) empf√§ngt.  Ein Cache ist eine Gruppe aufeinanderfolgender Nachrichten. Cache-Speicher werden mit pgqd erstellt.  In regelm√§√üigen Abst√§nden (der Parameter ‚Äûticker_period‚Äú in der Konfigurationsdatei) nimmt pgqd alle angesammelten Nachrichten entgegen und schreibt sie in einen neuen Cache.  <b>Es ist wichtig, dass,</b> wenn pgqd nicht funktioniert, keine neuen Bachs erstellt werden, was bedeutet, dass die Verbraucher nichts zu lesen haben. Wenn pgqd lange nicht funktioniert und dann eingeschaltet wird, wird aus den in dieser Zeit gesammelten Nachrichten ein gro√üer Bach erstellt. Daher sollte pgqd nicht erstellt werden schalte es einfach aus. <br><br>  Registrierung eines Verbrauchers ( <b>Wichtig! Ein</b> Verbraucher erh√§lt Ereignisse, die erst <b>nach</b> seiner Registrierung aufgezeichnet wurden. Daher sollten Sie zuerst einen Verbraucher erstellen und erst dann Ereignisse schreiben): <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pgq.register_consumer({ } <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, { } <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>);</code> </pre> <br>  <i>(√§hnlich wie pgq.unregister_consumer)</i> <br>  Jeder Verbraucher erh√§lt <b>absolut alle Ereignisse</b> , die nach seiner Erstellung aufgetreten sind (auch von einem anderen Verbraucher verarbeitet), was bedeutet, dass Sie h√∂chstwahrscheinlich nur einen Verbraucher f√ºr eine Runde ben√∂tigen.  Als n√§chstes erkl√§re ich Ihnen, wie Sie die Last auf mehrere Server aufteilen. <br><br>  Um einen Bach zu bekommen, m√ºssen Sie zuerst seine ID herausfinden: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pgq.next_batch({ } <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, { } <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>);</code> </pre> <br>  Die Funktion kann NULL zur√ºckgeben, wenn der Consumer alle Bachs verarbeitet hat.  In diesem Fall m√ºssen Sie nur warten, bis pgqd einen neuen Bach erstellt. <br><br>  In diesem Fall gibt diese Funktion denselben Wert zur√ºck, solange der Cache nicht verarbeitet wird. <br>  Sie k√∂nnen alle Ereignisse im Stapel abrufen, indem Sie Folgendes verwenden: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pgq.get_batch_events({<span class="hljs-keyword"><span class="hljs-keyword">id</span></span> } <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>);</code> </pre> <br>  (Der Bach ist m√∂glicherweise leer.) <br><br>  Wenn bei der Verarbeitung eines dieser Ereignisse ein Fehler aufgetreten ist, k√∂nnen Sie versuchen, dieses Ereignis sp√§ter zu verarbeiten: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pgq.event_retry({<span class="hljs-keyword"><span class="hljs-keyword">id</span></span> } <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>, {<span class="hljs-keyword"><span class="hljs-keyword">id</span></span> } <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>, {   } <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>);</code> </pre> <br>  Um √ºber das Ende des Bachs zu informieren und die M√∂glichkeit zu bekommen, einen neuen zu starten, wird dieser genutzt <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pgq.finish_batch({<span class="hljs-keyword"><span class="hljs-keyword">id</span></span> } <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>);</code> </pre> <br>  Nat√ºrlich sind dies nicht alle Funktionen in der Erweiterung. Ich empfehle <a href="https://pgq.github.io/extension/pgq/files/external-sql.html" rel="nofollow">pgq.github.io/extension/pgq/files/external-sql.html</a> und <a href="https://github.com/pgq/pgq/tree/master/functions" rel="nofollow">github.com/pgq/pgq/tree/master/functions</a> (jede Datei enth√§lt eine Definition und eine Beschreibung) entsprechende Funktion). <br><br><h4>  Lastverteilung </h4><br>  Damit Ereignisse von mehreren Handlern gleichzeitig verarbeitet werden k√∂nnen, gibt es die Erweiterung pgq_coop, die wie pgq funktioniert und eine neue Entit√§t namens "sub consumer" hinzuf√ºgt, die nat√ºrlich alle Ereignisse ab dem Zeitpunkt der Registrierung des √ºbergeordneten Verbrauchers empf√§ngt, mit Ausnahme derjenigen, die bereits verarbeitet wurden. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pgq_coop.register_subconsumer({ } <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, { } <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, { } <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>);</code> </pre> <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pgq_coop.next_batch({ } <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, { } <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, { } <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>);</code> </pre> <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pgq_coop.next_batch({ } <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, { } <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, { } <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, {        ,      } <span class="hljs-built_in"><span class="hljs-built_in">interval</span></span>);</code> </pre> <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pgq_coop.finish_batch({<span class="hljs-keyword"><span class="hljs-keyword">id</span></span> } <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>);</code> </pre> <br>  Lesen Sie hier alles √ºber die Funktionen. <br><br><h4>  Installation </h4><br>  Die pgq-Erweiterung und der pgqd-Daemon sind in den PGDG-Repositorys enthalten und werden in den meisten Distributionen sehr einfach installiert, zum Beispiel in Debian: <br><br>  <code>sudo apt install postgresql-XX-pgq3 pgqd</code> (XX ist die Versionsnummer). <br><br>  pgqd ist ein kleines Programm, das √ºber die Verwendung von <code>pgqd --help</code> Sie nicht, es zu <code>sudo systemctl enable pgqd.service</code> hinzuzuf√ºgen ( <code>sudo systemctl enable pgqd.service</code> und die Standardkonfiguration ist <code>/etc/pgqd.ini</code> ). <br><br>  Um PgQ zu verwenden, m√ºssen Sie in der Datenbank nur die Erweiterung verbinden: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> extension <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exists</span></span> pgq;</code> </pre> <br><br>  Mit pgq_coop ist alles etwas komplizierter, es befindet sich nicht im Repository, aber es ist nicht schwierig, es aus den Quellen zu kompilieren (Beispiel f√ºr Debian): <br><br><pre> <code class="plaintext hljs">sudo apt install postgresql-server-dev-XX git clone https://github.com/pgq/pgq-coop.git cd pgq-coop sudo make install</code> </pre><br>  und verbinden Sie die Nebenstelle mit <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> extension <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exists</span></span> pgq_coop;</code> </pre> <br><h4>  N√ºtzliche Links </h4><br>  <a href="https://pgq.github.io/extension/pgq/files/external-sql.html" rel="nofollow">Pgq-Dokumentation</a> <br>  <a href="https://github.com/pgq/pgq/tree/master/functions" rel="nofollow">Pgq-Funktionen</a> <br>  <a href="https://github.com/pgq/pgq-coop/tree/master/functions" rel="nofollow">Pgq_coop funktioniert</a> <br>  <a href="https://github.com/pgq/pgqd" rel="nofollow">Pgqd-Quellcode</a> <br>  <a href="https://github.com/pgq" rel="nofollow">github account mit allen verwandten projekten</a> <br>  <a href="https://wiki.postgresql.org/wiki/PGQ_Tutorial" rel="nofollow">Wiki Postgres</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de483014/">https://habr.com/ru/post/de483014/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de482998/index.html">Neuigkeiten aus der Welt von OpenStreetMap Nr. 492 (17.12.19 - 23.12.19)</a></li>
<li><a href="../de483000/index.html">Die offizielle Position von Telegram bez√ºglich der TON-Blockchain</a></li>
<li><a href="../de483004/index.html">Kuleshov-Effekt in Disco Elysium: Wie Kontext Sinn schafft</a></li>
<li><a href="../de483008/index.html">Eine andere Zukunft - eine Spaltung der Menschheit</a></li>
<li><a href="../de483012/index.html">Antiquit√§ten: Roland MT-32, ein alternativer Sound f√ºr DOS-Spiele</a></li>
<li><a href="../de483016/index.html">Eine kurze Geschichte der Weltraummikroprozessoren, Teil Zwei</a></li>
<li><a href="../de483018/index.html">Maske-R CNN vom Anf√§nger bis zum Profi</a></li>
<li><a href="../de483024/index.html">‚ÄûWas haben Unternehmen mit Ihrer Privatsph√§re gemacht?‚Äú, Arthur Khachuyan</a></li>
<li><a href="../de483026/index.html">Java / Spring: So generieren Sie mit Speedment eine CRUD REST-API vollst√§ndig</a></li>
<li><a href="../de483030/index.html">API, die Sie zum Weinen bringt</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>