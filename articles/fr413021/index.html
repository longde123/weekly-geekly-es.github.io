<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚§¥Ô∏è üèáüèΩ üçÑ Dispositif de vision nocturne bas√© sur le module d'imagerie thermique Flir Lepton 3 üö∫ üñïüèæ üî±</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Plus t√¥t, j'ai √©crit un article sur la connexion d'un d√©codeur d'imagerie thermique √† un smartphone Flir One Gen 2. Il est temps de retirer le module ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Dispositif de vision nocturne bas√© sur le module d'imagerie thermique Flir Lepton 3</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/413021/"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Plus t√¥t,</a> j'ai √©crit un article sur la connexion d'un d√©codeur d'imagerie thermique √† un smartphone Flir One Gen 2. Il est temps de retirer le module lepton de ce d√©codeur et de le connecter directement au microcontr√¥leur en assemblant un dispositif de vision nocturne avec une r√©solution de 160x120 pixels. <br><a name="habracut"></a><br>  Pour construire votre propre appareil d'imagerie thermique de vision nocturne, vous aurez besoin de: <br><br>  1) Carte avec microcontr√¥leur.  J'ai pris une planche d'un ami chinois avec le microcontr√¥leur STM32F407VGT6.  Un si bon contr√¥leur: fr√©quence 168 MHz et 192 Ko de RAM. <br><br><img src="https://habrastorage.org/webt/8c/dc/ku/8cdckuwklqzb6uau4hu303w7ly0.jpeg"><br><br>  2) Affichage.  J'ai pris un √©cran avec une r√©solution de 320x240.  Ces √©crans sont livr√©s avec diff√©rents contr√¥leurs.  Je l'ai eu avec le contr√¥leur hx8347d. <br><br><img src="https://habrastorage.org/webt/6a/6m/un/6a6mundpajyfht-oxvu96zucw_g.jpeg"><br><br>  3) Carte pour connecter le lepton 3 sur SPI et I2C. <br><br><img src="https://habrastorage.org/webt/9w/l_/ba/9wl_baf3ewy_pcavn7pxgjwlfxo.jpeg"><br><br>  4) Le lepton lui-m√™me 3. L'√©l√©ment le plus difficile et le plus cher.  Pour l'obtenir, j'ai achet√© un imageur thermique Flir One Gen 2 d√©fectueux sur ebay et j'en ai retir√© un lepton.  Il ressemble √† un grossissement comme ceci: <br><br><img src="https://habrastorage.org/webt/vk/z0/no/vkz0nogorpl_g0n9in9e3wacyw4.jpeg"><br><br>  Vous pouvez exclure l'√©l√©ment 3 de cette liste, sauf si, bien s√ªr, vous parvenez √† prendre un berceau pour un lepton d'un imageur thermique d√©fectueux et vous pouvez le dessouder (et ses contacts, soit dit en passant, seront par le bas).  Malheureusement, la distance entre les jambes du lepton est assez petite, donc cette option ne m'a pas √©t√© soumise. <br><br>  Pour collecter tout cela, il vous suffit de tout souder comme suit: <br><br><img src="https://habrastorage.org/webt/7u/ev/sl/7uevslpasq6o-qw5hazjqqe79_4.jpeg"><br><br>  Vous devez √©galement connecter l'alimentation.  Pour alimenter la carte lepton, j'utilise 5 V, pour la carte STM32 3,3 V.Pour obtenir 5 V de la batterie, j'utilise le convertisseur TEL3-0511 (tension d'entr√©e de 4,5 √† 9 V), et abaisse d√©j√† ces 5 V sur un LP2950CZ-3.3 normal (d'ailleurs) , chauffe jusqu'√† 70 degr√©s. Ici aussi, vous devez utiliser un convertisseur DC / DC, mais je ne l'ai pas encore achet√©).  Au fait, Lepton 3 mange bien.  Lorsqu'il est aliment√© √† partir de 6 V, la consommation de courant de l'ensemble de l'appareil est d'environ 250 mA.  Lorsque le lepton veut cliquer sur l'obturateur pour l'√©talonnage, le courant monte √† 500 mA. <br><br>  Tout ensemble ressemble √† ceci: <br><br><img src="https://habrastorage.org/webt/l_/5u/6u/l_5u6uvczvxtcllw78yr8ggdgxg.jpeg"><br><br><img src="https://habrastorage.org/webt/sd/b4/ao/sdb4aok26v1_ty26lq52t5eaazq.jpeg"><br><br>  Pour travailler avec un lepton, vous avez besoin d'un programme.  J'ai utilis√© CubeMX et Keil 5. Dans ce cas, toutes les liaisons logicielles sont simplifi√©es √† l'impossibilit√©. <br><br>  La communication avec un lepton s'effectue sur SPI.  Je n'ai pas utilis√© I2C, car il n'√©tait pas particuli√®rement n√©cessaire.  Selon I2C, vous pouvez contr√¥ler l'√©tat du lepton, ses modes de fonctionnement, activer / d√©sactiver le mode d'√©talonnage automatique, etc.  Mais pour un appareil de vision nocturne, ce n'est pas particuli√®rement n√©cessaire. <br><br>  Pour d√©crypter les donn√©es, j'ai √©crit un module: <br><br><div class="spoiler">  <b class="spoiler_title">Module</b> <div class="spoiler_text">  <b>leptoncontrol.h</b> <br><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifndef</span></span></span><span class="hljs-meta"> LEPTON_CONTROL_H #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LEPTON_CONTROL_H #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdbool.h&gt; #include &lt;stdio.h&gt; //   ( ) #define LEPTON_ORIGINAL_IMAGE_WIDTH 160 #define LEPTON_ORIGINAL_IMAGE_HEIGHT 120 //  VoSPI #define VOSPI_FRAME_HEIGHT 60 //  VoSPI #define VOSPI_FRAME_WIDTH 80 //  VoSPI   (164  RAW14  244  RGB) #define VOSPI_PACKAGE_SIZE 164 //   VoSPI   #define VOSPI_PACKAGE_LINE_SIZE 160 //  VOSPI   #define VOSPI_SEGMENT_LINE_AMOUNT 60 void LEPTONCONTROL_Init(void);// void LEPTONCONTROL_CalculateCRC(unsigned short *crc,unsigned char byte);// crc bool LEPTONCONTROL_PushVoSPI(unsigned char data[VOSPI_PACKAGE_SIZE],bool *first_line);//    VoSPI    unsigned short *LEPTONCONTROL_GetRAW14Ptr(void);//      #endif</span></span></span></span></code> </pre> <br>  <b>leptoncontrol.c</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"leptoncontrol.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"stm32f4xx_hal.h"</span></span></span><span class="hljs-meta"> static unsigned short RAW14Image[LEPTON_ORIGINAL_IMAGE_HEIGHT*LEPTON_ORIGINAL_IMAGE_WIDTH];</span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//  static unsigned short CRCTable[256];//   CRC16 //     #define RESYNC_TIMEOUT_MS 19 //:   #define NO_SEGMENT -1 //:   #define ERROR_PACKAGE -2 //---------------------------------------------------------------------------------------------------- // //---------------------------------------------------------------------------------------------------- void LEPTONCONTROL_Init(void) { //    CRC unsigned short code; for(long n=0;n&lt;256;n++) { code=((unsigned short)n)&lt;&lt;8; for(unsigned char m=0;m&lt;8;m++) { if(code&amp;(1&lt;&lt;15)) code=(code&lt;&lt;1)^0x1021; else code=code&lt;&lt;1; } CRCTable[n]=code; } } //---------------------------------------------------------------------------------------------------- // crc //---------------------------------------------------------------------------------------------------- void LEPTONCONTROL_CalculateCRC(unsigned short *crc,unsigned char byte) { *crc=CRCTable[(((*crc)&gt;&gt;8)^byte++)&amp;0xFF]^((*crc)&lt;&lt;8); } //---------------------------------------------------------------------------------------------------- //---------------------------------------------------------------------------------------------------- long LEPTONCONTROL_ReadSegment(unsigned short *raw14_ptr,unsigned char data[VOSPI_PACKAGE_SIZE],bool *first_line) { static long current_package=-1; static long segment=-1; long n; *first_line=false; if ((data[0]&amp;0x0F)==0x0F) return(NO_SEGMENT);//  unsigned short crc=data[2]; crc&lt;&lt;=8; crc|=data[3]; // CRC unsigned short crc16=0; LEPTONCONTROL_CalculateCRC(&amp;crc16,data[0]&amp;0x0F); LEPTONCONTROL_CalculateCRC(&amp;crc16,data[1]); LEPTONCONTROL_CalculateCRC(&amp;crc16,0); LEPTONCONTROL_CalculateCRC(&amp;crc16,0); for(n=4;n&lt;VOSPI_PACKAGE_SIZE;n++) LEPTONCONTROL_CalculateCRC(&amp;crc16,data[n]); if (crc16!=crc) return(ERROR_PACKAGE);// CRC //   unsigned short package=data[0]&amp;0x0F; package&lt;&lt;=8; package|=data[1]; if (package==0) { *first_line=true; current_package=0; } if (package==20) { unsigned char ttt=(data[0]&amp;0x70)&gt;&gt;4;//     20  segment=ttt; } if (current_package&lt;0) return(NO_SEGMENT); if (current_package!=package) { current_package=-1; return(ERROR_PACKAGE); } unsigned short *raw_ptr=raw14_ptr+current_package*VOSPI_PACKAGE_LINE_SIZE/2; for(n=0;n&lt;VOSPI_PACKAGE_LINE_SIZE/2;n++,raw_ptr++) { //    big-endian: ,  unsigned short value=data[n*sizeof(short)+4]; value&lt;&lt;=8; value|=data[n*sizeof(short)+5]; *raw_ptr=value; } current_package++; if (current_package!=VOSPI_FRAME_HEIGHT) return(NO_SEGMENT); current_package=-1; return(segment); } //---------------------------------------------------------------------------------------------------- //    VoSPI    //---------------------------------------------------------------------------------------------------- bool LEPTONCONTROL_PushVoSPI(unsigned char data[VOSPI_PACKAGE_SIZE],bool *first_line) { *first_line=false; static long waitable_segment=1; long segment=LEPTONCONTROL_ReadSegment(RAW14Image+(waitable_segment-1)*VOSPI_FRAME_WIDTH*VOSPI_SEGMENT_LINE_AMOUNT,data,first_line); if (segment==ERROR_PACKAGE) HAL_Delay(RESYNC_TIMEOUT_MS); if (segment==ERROR_PACKAGE || segment==0) waitable_segment=1; if (segment==ERROR_PACKAGE || segment==NO_SEGMENT || segment==0) return(false); if (segment!=waitable_segment) { waitable_segment=1; if (segment!=1) return(false); } waitable_segment++; if (waitable_segment!=5) return(false); waitable_segment=1; return(true); } //---------------------------------------------------------------------------------------------------- //      //---------------------------------------------------------------------------------------------------- unsigned short *LEPTONCONTROL_GetRAW14Ptr(void) { return(RAW14Image); }</span></span></span></span></code> </pre><br></div></div><br>  Tout travail avec ce module consiste en une simple soumission de donn√©es obtenues par SPI. <br><br><div class="spoiler">  <b class="spoiler_title">Travailler avec le module</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-comment"><span class="hljs-comment">//   while(1) { HAL_SPI_Receive(&amp;hspi1,buffer,VOSPI_PACKAGE_SIZE,0x1000); bool first_line=false; unsigned char *buffer_ptr=buffer; LEPTONCONTROL_PushVoSPI(buffer_ptr,&amp;first_line); if (first_line==true) break; } //    lepton3 unsigned char *buffer_ptr=buffer; HAL_SPI_Receive(&amp;hspi1,buffer_ptr,VOSPI_PACKAGE_SIZE*SPI_READ_VOSPI_AMOUNT,0x1000); buffer_ptr=buffer; for(long n=0;n&lt;SPI_READ_VOSPI_AMOUNT;n++,buffer_ptr+=VOSPI_PACKAGE_SIZE) { bool first_line=false; bool res=LEPTONCONTROL_PushVoSPI(buffer_ptr,&amp;first_line); if (res==true) CreateImage();//     } }</span></span></code> </pre><br></div></div><br>  Apr√®s assemblage du cadre, les lectures du capteur sont simplement normalis√©es, r√©duites √† la plage [0..255] et affich√©es √† l'√©cran sous la forme de nuances de gris.  Cependant, rien n'emp√™che d'utiliser une palette pour colorier l'image. <br><br>  Pour afficher l'image sur l'√©cran, j'utilise le module FSMC int√©gr√© √† ce contr√¥leur en mode bus de donn√©es 8 bits. <br><br>  Le programme complet peut √™tre t√©l√©charg√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . <br><br>  Vid√©o de travail (malheureusement, j'ai tourn√© sur un vieil appareil photo avec la qualit√© appropri√©e - je n'ai pas de cam√©ra vid√©o avec moi maintenant). <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/BMG0rLr8tC8" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  PS Soit dit en passant, vous pouvez connecter l'imageur thermique Flir One Gen 2 √† la carte de d√©bogage STM32F407Discovery directement via USB.  Cependant, la connexion est instable - l'imageur thermique est souvent perdu. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/-elBzHRjZxo" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Le programme d'une telle connexion est <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> .  Peut-√™tre que quelqu'un comprendra ce que c'est et comment rendre la connexion stable. <br><br>  De plus, ce module lepton 3 se connecte facilement et simplement au Raspberry Pi. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/IWScr3B4RJ0" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Dans ce cas, j'ai d√ª modifier le programme √† partir du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">r√©f√©rentiel</a> , ce qui rend ma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">version</a> fonctionnant avec lepton 3. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr413021/">https://habr.com/ru/post/fr413021/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr413011/index.html">Sous-sol de la mort</a></li>
<li><a href="../fr413013/index.html">Le d√©sir de transparence</a></li>
<li><a href="../fr413015/index.html">Comment nous sommes analys√©s dans les cin√©mas ... et pas seulement</a></li>
<li><a href="../fr413017/index.html">Une petite note sur les certificats g√©n√©riques Let's Encrypt</a></li>
<li><a href="../fr413019/index.html">La vie un an apr√®s l'introduction des robots: alors que l'√©galit√© n'est pas demand√©e</a></li>
<li><a href="../fr413023/index.html">¬´Well Forgotten Old¬ª: les v√©los √©lectriques - des premiers mod√®les aux possibilit√©s d'aujourd'hui</a></li>
<li><a href="../fr413025/index.html">Sur les √©pines et les √©toiles sur la voie de l'optimisation des processus de d√©veloppement</a></li>
<li><a href="../fr413027/index.html">Le HI-FI sovi√©tique et ses cr√©ateurs: les vid√©odisques laser en URSS</a></li>
<li><a href="../fr413029/index.html">La premi√®re solution Managed OpenShift dans le cloud</a></li>
<li><a href="../fr413033/index.html">Aubrey de Gray, pionni√®re du rajeunissement: ¬´Les personnes d'√¢ge moyen ont de bonnes chances¬ª</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>