<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🌇 🔌 🧔 ClickHouse für Integrationstests in gitlab-ci konfigurieren 🧚🏼 🐫 👨🏾‍✈️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Wir hatten einen Service für Golang, ein separates Thema, Kafka, Clickhouse, Gitlab-CI und eine fallende Gewinnlinie, einen faulen SSH-Schlüssel und d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ClickHouse für Integrationstests in gitlab-ci konfigurieren</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/459860/"> Wir hatten einen Service für Golang, ein separates Thema, Kafka, Clickhouse, Gitlab-CI und eine fallende Gewinnlinie, einen faulen SSH-Schlüssel und das alles, zusammen mit einer Ferienzeit, schrecklichen Regenfällen in der Stadt, einem kaputten Laptop, nächtlichen Warnungen und einem heißen Verkauf .  Nicht, dass dies alles für diesen Artikel notwendig gewesen wäre, aber wenn Sie den typischen Alltag des Testers zeigen, gehen Sie in Ihrer Absicht bis zum Ende.  Das einzige, was mich störte, war p0.  Auf der Welt gibt es nichts Verzweifelteres, Düstereres und Deprimierteres als den Tester, der es auf dem Stoß verpasst hat.  Aber ich wusste, dass ich mich ziemlich bald darauf einlassen würde. <br><a name="habracut"></a><br><h3>  Warum das alles? </h3><br>  Es gibt ein gemeinsames Bündel von Diensten - den Dienst selbst, der etwas tut - und eine Datenbank, in die diese Ergebnisse geschrieben werden.  manchmal geschieht dies direkt, dh "Service - Basis".  In meinem Fall erfolgt die Aufzeichnung über einen Vermittler, dh "Service - Warteschlange - Basis". <br><br>  Insgesamt gibt es mehrere Elemente, und die Grenze dieser Elemente - die Ausgabe des einen und die Eingabe des anderen - ist der Ort, an dem Probleme auftreten.  Sie können dort einfach nicht erscheinen. <br><br>  Ein anschauliches Beispiel: Im Service wird das Preisfeld als float32 verarbeitet, in der Datenbank als Dezimalzahl (18, 5) konfiguriert, geben wir den Maximalwert von float32 als Testfall aus der Ausgabe des Service an die Datenbank weiter - oh, die Datenbank antwortet nicht.  Oder ein traurigeres Beispiel: Die Datenbank stürzt nicht ab, aber es gibt keinen Fehler in den Datenprotokollen in der Datenbank.  Es ist nur so, dass die Datenbank nicht mehr fließt.  Oder die Aufzeichnung wird durchgeführt, jedoch mit Datenverlust oder mit Verzerrung: Das Feld verlässt den Dienst als float64 und wird als float32 aufgezeichnet. <br><br>  Oder sie haben im Verlauf des Lebenszyklus entschieden, dass der Typ dieses oder jenes Feldes geändert werden muss.  Das Feld ist seit langem auf dem Produkt implementiert, aber hier muss es bearbeitet werden.  Und natürlich haben wir es nur an einer Stelle geändert.  Hoba, wieder ist etwas schief gelaufen. <br><br><h3>  Herausforderung </h3><br>  Ich möchte nicht alle diese Änderungen verfolgen.  Ich möchte, dass es nicht fällt.  Ich möchte, dass die Aufnahme richtig läuft. <br><br>  Beenden: Integrationstests! <br><br><h3>  Umsetzung und Schwierigkeiten </h3><br><h4>  Wo soll man brechen? </h4><br>  Es gibt eine Entwicklungsumgebung: schrecklich instabil und wird normalerweise von Entwicklern als Sandbox verwendet.  Es gibt Chaos und Anarchie, die für ein hartes Backend charakteristisch sind. <br><br>  Es gibt eine Testumgebung oder einen Qa-Stand: Es ist besser abgestimmt, sogar Entwickler sehen es sich an, aber bis Sie sie treten, wird nichts passieren.  und diese Umgebung wird oft aktualisiert.  und noch öfter ist dort etwas kaputt. <br><br>  Und es gibt einen Stoß - das Allerheiligste: Es ist besser, so etwas nicht darauf zu fahren.  Integrationstests deuten auf die Möglichkeit eines Fehlers hin, den sie finden müssen, bevor er zum Produkt gelangt. <br><br>  Was tun mit der Umgebung, wenn sie entweder instabil ist oder kämpft?  Das ist richtig, erstellen Sie Ihre eigenen! <br><br><h4>  Was tun mit der Basis? </h4><br>  Die Datenbank kann auf verschiedene Arten gestartet werden. <br><br>  Wie wir oben besprochen haben, werden wir uns nicht mit der realen Basis dieser oder jener Umgebung verbinden. <br><br>  Zunächst können Sie den <s>Cruttle-</s> Clickhouse-Server mit den erforderlichen Einstellungen anheben, die erforderliche SQL darauf ausrollen und über den Clickhouse-Client mit ihm kommunizieren.  Beim ersten erfolgreichen Versuch, eine ähnliche Basis zu schaffen, war ci traurig.  Die Tests blitzten, der Server ging nicht aus und arbeitete weiter.  Sagen wir einfach, es bleibt mir immer noch ein Rätsel, warum es überhaupt angefangen hat.  (es selbst, ich habe nichts damit zu tun).  Ich empfehle diese Option nicht. <br><br>  Eine praktische Option ist die Verwendung eines <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Docker-Images</a> . <br>  Laden Sie die gewünschte Version in Ihr Auto herunter.  Clickhouse benötigt config.xml mit Einstellungen zum Starten.  Weitere Details <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> <br>  Für das wiederverwendete Klickbild müssen Sie die richtige Docker-Datei erstellen.  Wir geben darin an, dass wir config.xl in den Ordner kopieren möchten, wir docken die anderen erforderlichen Konfigurationen an.  Stellen Sie sicher, dass Sie die Skripte kopieren, um Ihre Basis bereitzustellen. <br><br>  Da wir von außen auf das Bild zugreifen, müssen wir die Ports öffnen, über die wir mit dem Clickhouse kommunizieren.  Klicken Sie auf 8123 auf http und auf 9000 auf tcp. <br><br>  Wir erhalten die folgende Docker-Datei: <br><br><pre><code class="plaintext hljs">From yandex/clickhouse-server Expose 8123 Expose 9000 Add config.xml /etc/clickhouse-server/config.xml Add my_init_script.sql /docker-entrypoint-initdb.d/</code> </pre> <br><h4>  Wie wirft man ein Bild in ci? </h4><br>  Um irgendwie mit dem Docker-Image in ci zu arbeiten, müssen Sie es dort irgendwie aufrufen. <br><br>  Sie können das Image in Ihrem Repository festschreiben und ausführen und Docker Run mit den erforderlichen Parametern ausführen, um die Tests auszuführen.  Nur hier wiegt das Docker-Image des Klicks weniger als 350mb.  Es ist unanständig, solche Dateien in Git zu halten. <br><br>  Wenn für verschiedene Projekte dasselbe Docker-Image benötigt wird (z. B. werden unterschiedliche Dienste in dieselbe Datenbank geschrieben), sollten Sie dies umso mehr nicht tun.  Sie können den <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Dock-Registrierungs-</a> Image-Speicher verwenden <br>  Wir glauben, dass es in unserem Projekt bereits existiert und verwendet wird.  Melden Sie sich daher an, sammeln Sie das Docker-Image und verschieben Sie es dorthin. <br><br><pre> <code class="plaintext hljs">docker build -t my_clickhouse_image . docker login my_registry_path.domain.com docker push my_clickhouse_image</code> </pre><br>  Aussteigen und unser Bild flog in die Registrierung.  Stellen Sie sicher, dass Sie das Tag während der Montage angeben! <br><br>  Die Basis ist fertig. <br><br>  Lesen Sie hier mehr über die Registrierung <br><br><h4>  Was tun mit ci? </h4><br>  Wie können Sie sowohl Ihren Dienst als auch Ihre Datenbank in einem Schritt starten? <br><br>  Es hängt alles davon ab, wie wir den Service starten und nutzen.  Wenn Sie mit dem Dienst wie mit einem Docker-Image arbeiten und tatsächlich die gesamte .gitlab-ci.yml nur mit ihnen funktioniert, ist alles einfach. <br>  Es gibt einen Dind Streuner - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Docker-in-Docker</a> .  Es wird angezeigt, mit dem der Hauptdienst ci zusammenarbeitet, und ermöglicht es Ihnen, den Docker vollständig zu nutzen und überhaupt nicht zu belasten. <br><br>  Wir pumpen das neueste Bild aus, fügen den Phasen den erforderlichen Testschritt hinzu und beschreiben unsere Abfolge von Aktionen. <br><br><pre> <code class="plaintext hljs">image: docker:stable services: - docker:dind stages: - build … - test-click ... - test - release … test-click: variables: VERY_IMPORTANT_VARIABLE: “its value” before_script: - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY script: - docker pull My_Service_Image - docker pull My_ClickHouse_Image - docker run -FLAGS My_ClickHouse_Image - docker run My_Service_Image /path/to/tests</code> </pre><br>  Der offizielle Docker Docker gibt an, dass es nicht empfohlen wird, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">dind</a> zu verwenden, aber wenn Sie wirklich ... <br><br>  In meinem Projekt muss der Dienst durch den Start der Binärdatei getestet werden.  Hier beginnt die Magie. <br>  Verwenden Sie dazu die Datenbank als Dienst.  In der offiziellen gitlab-ci-Dokumentation wird die Verwendung eines Containers mit Basis als <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Beispiel für den</a> häufigsten Anwendungsfall für einen Docker-Container in ci genannt.  Sogar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Beispiele für</a> MySQL-, Postress- und Redis-Einstellungen werden bereitgestellt.  Aber wir suchen nicht nach einfachen Wegen, wir brauchen ein Clickhouse. <br><br>  Verbinden Sie die Basis!  Stellen Sie sicher, dass Sie einen Alias ​​angeben.  Wenn es nicht angegeben ist, wird der Basis ein zufälliger Name und eine zufällige IP zugewiesen.  Das heißt, es wird nicht genau klar sein, wie darauf zugegriffen werden soll.  Es wird kein solches Problem mit Alias ​​geben - im <code>http://my_alias_name:8123</code> der Aufruf beispielsweise wie <code>http://my_alias_name:8123</code> . <br><br>  Für Tests wird weiterhin ein Image der Datenbank benötigt, das wir sorgfältig in die Registrierung einfügen.  Um das Image herunterzuladen, müssen Sie sich anmelden und Docker ziehen. Nur ci weiß nicht, was Docker ist - Sie müssen es installieren. <br><br>  Der resultierende Code für den Schritt in gitlab-ci.yml: <br><br><pre> <code class="plaintext hljs">Integration tests: Services: - name: my_clickhouse:latest alias: clicktest Stage: tests Variables: Variables_for_my_service: “value” Before_script: - curl -ssl https://get.docker.com/ | sh - docker login -u gitlab-ci-token -p $ci_build_token my_registry_path.domain.com Script: - ./bin/my_service &amp; - go test -v ./tests -tags=integration Dependencies: - build</code> </pre><br><h3>  Gewinn </h3><br><ul><li>  Ich habe eine funktionierende Servicebasis. </li><li>  Im Rahmen des Autotests ist der Zugriff auf die Datenbank einfach - einfach per Alias. </li><li>  Ich setze die Datensätze und Einstellungen der Datenbank im Rahmen des Setup-Tests zurück, rufe den Dienst an, schreibe in die Datenbank, wende mich an die Datenbank, sehe, dass die Datenbank nicht heruntergefallen ist, sehe, was angekommen ist, validiere ich.  wirf mehr Tests. </li><li>  Sie können nicht mit Stiften testen! </li></ul><br><h3>  Ergebnisse </h3><br>  Es scheint, dass ein paar Zeilen Setup in Gitlab-CI.  Das Erstellen eines Docker-Images ist einfach.  Das lokale Ausführen ist einfach.  Ich habe mich in die ersten Tests integriert, bei denen an einem Tag Probleme festgestellt wurden.  Aber Versuche, es bei ci zu starten, wurden zu einer Woche voller Schmerz und Hoffnungslosigkeit.  Und jetzt, in den Wochen des Schmerzes und der Hoffnungslosigkeit von Entwicklern, die alles reparieren müssen, was sie dort programmiert haben. <br><br><h3>  Was haben wir geschafft? </h3><br><ul><li>  Wir haben einen Container mit Clickhouse aufgestellt. </li><li>  Wir haben den Container im lokalen Lager gestartet. </li><li>  Wir haben gelernt, dieses Bild in Schritt ci zu ziehen. </li><li>  Startete es im Läufer. </li></ul><br>  Senden Sie einfach Daten an die Datenbank und greifen Sie vom Test darauf zu. <br><br>  Die Automatisierung ist ein ziemlich einfacher Weg, um die Routine der manuellen Piercing-Integration loszuwerden. <br><br>  Was ist wichtig zu beachten: Stellen Sie sicher, dass die Eingabetypen der Basis den Ausgabetypen des vorherigen Links entsprechen.  (und <s>ggf.</s> Dokumentation). </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de459860/">https://habr.com/ru/post/de459860/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de459842/index.html">Luxor</a></li>
<li><a href="../de459844/index.html">Pinguin im Fenster: über das Potenzial und die Perspektiven von WSL2</a></li>
<li><a href="../de459850/index.html">Amateurfunktechnologie: Wie ich die Installation einer Leiterplatte in einer chinesischen Fabrik bestellt habe</a></li>
<li><a href="../de459852/index.html">Die Praxis der Verwendung der Lottie-Bibliothek in der mobilen Anwendung der Bank</a></li>
<li><a href="../de459858/index.html">Erkundung der modernen Malware Cerberus für Android</a></li>
<li><a href="../de459862/index.html">Berkeley DB STL-Schnittstelle</a></li>
<li><a href="../de459866/index.html">Problemlösung mit pwnable.kr 02 - Kollision. Hash-Kollision</a></li>
<li><a href="../de459870/index.html">Beispiel für eine Model-View-Update-Architektur in F #</a></li>
<li><a href="../de459872/index.html">Patton Jeff. Benutzerdefinierte Geschichten. Die Kunst der agilen Softwareentwicklung</a></li>
<li><a href="../de459874/index.html">Du hast etwas zu verbergen</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>