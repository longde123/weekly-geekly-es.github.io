<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🦒 🏹 🙇🏻 Wie wir angefangen haben, Registrierkassen für unsere Kunden zu registrieren ✊🏿 👍🏼 🍞</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nach den Änderungen zu 54- sind seit Juli dieses Jahres fast alle Handelsunternehmen verpflichtet, Online-Kassen zu nutzen, die Daten über das Interne...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Wie wir angefangen haben, Registrierkassen für unsere Kunden zu registrieren</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tinkoff/blog/420033/">  Nach den Änderungen zu 54- sind seit Juli dieses Jahres fast alle Handelsunternehmen verpflichtet, Online-Kassen zu nutzen, die Daten über das Internet an den Steuerdienst übermitteln.  Um einen solchen Apparat zu erwerben, müssen Sie eine Kasse und eine Steuerbehörde kaufen, eine Vereinbarung unterzeichnen und die Dienste eines Steuerdatenbetreibers bezahlen, sich in zwei persönlichen Büros des Bundessteuerdienstes und des OFD registrieren, die Daten an die Kasse senden und einen Papierregistrierungsbericht erhalten.  Nun, Sie benötigen auch eine elektronische digitale Signatur, andernfalls müssen Sie zum Bundessteuerdienst kommen und persönlich in der Schlange stehen. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3a9/fb3/9b6/3a9fb39b680344c3f892804eb41b1a11.png"><br><br>  Wir haben uns entschlossen, unsere Kunden vor all diesem Horror zu bewahren, indem wir einen Service entwickelt haben, der fast automatisch alles mit einem Klick registriert.  Wir werden jetzt darüber sprechen. <br><a name="habracut"></a><br><h2>  Warum brauchen wir es? </h2><br>  Sie haben bereits erkannt, dass die Registrierung eines Ticketschalters eine mühsame mehrstufige Aufgabe ist, aber dies ist nicht das einzige Problem.  In jeder Phase wartet der Zoo auf Schnittstellen, deren Formulare manuell mit Registrierungsdaten für jedes Ticketbüro ausgefüllt werden müssen, sowie auf einen vollständigen Satz relevanter Fehler (separate Begrüßung der Steueranforderungen für die Verwendung von IE-, Yandex.Browser- oder Sputnik-Browsern).  Hunderte von Möglichkeiten, einen Fehler zu machen, das Verfahren zu ruinieren und von vorne zu beginnen.  Und wenn Sie 5-10 Registrierkassen einstellen, steigt die Wahrscheinlichkeit eines Fehlers bei der Eingabe derselben Details mitunter.  Ganz zu schweigen von der unproduktiven Zeitverschwendung und der Frage, warum das persönliche Finanzamt die Annahme des Tokens ablehnt, der erst gestern perfekt „verschluckt“ wurde. <br><br><img src="https://habrastorage.org/webt/cz/bk/qn/czbkqnhvog24qqgwodhckwfyhew.png"><br><br>  Und als wir die Hauptlast der oben genannten Tragödie spürten, beschlossen wir, die Entwicklung aufzunehmen. <br><br><h2>  Registrierungsschritte </h2><br>  An der Registrierung einer Registrierkasse sind mehrere Parteien gleichzeitig beteiligt.  Dies ist der Steuerdienst (FTS), OFD - der Betreiber von Steuerdaten, über die Registrierkassen mit der Steuerbehörde interagieren, ein Zertifizierungszentrum, das elektronische Signaturen ausstellt, und in der Regel ein wenig verwirrter Geschäftsmann, der sich in bürokratischen Umwälzungen verirrt hat.  Wir wollten in ihre Beziehung eingreifen, um alle Schwierigkeiten auf uns zu nehmen. <br><br>  Bedingt ist das Verfahren in zwei Phasen unterteilt: <br><br>  Kassenregistrierung - Die Daten eines bestimmten Geräts werden an den Bundessteuerdienst gesendet, und die Registrierungsnummer wird beantwortet. <br><br>  Fiskalisierung - Aktivierung des Kassierers unter Verwendung der vom Bundessteuerdienst vergebenen Fahrzeugregistrierungsnummer. <br><br>  Zunächst gingen wir zu unseren Partnern, um mit ihnen die erste Phase zu erarbeiten. <br><br><h2>  API für den Federal Tax Service </h2><br>  Wir waren nicht die ersten, die über die Automatisierung der Registrierung nachdachten.  Viele sagten, dass sie etwas in diesem Bereich tun, dass die Entwicklung im Gange ist, aber niemand hatte eine vorgefertigte externe Schnittstelle.  Einer der Steuerdatenbetreiber wurde von der API bereitgestellt - fast bereit, mit der Steuer zu interagieren. <br><br>  Zu diesem Zeitpunkt wurden nur etwa 80 Testanwendungen mit dem Protokoll gesendet.  Wir glaubten, dass die Schnittstelle bald voll ausgelastet sein würde, und begannen mit der Implementierung und dem Testen der „Stubs“. <br><br>  Als wir zum Produkt gingen, stellten wir fest, dass unsere Tests und die tatsächliche Anwendung unterschiedlich sind, wie Tag und Nacht.  Die „Stubs“, die wir vom OFD erhalten haben, enthielten nur Erfolgsmock und reproduzierten ein erfolgreiches Skript.  Tatsächlich war es nicht einfach, diesen „Erfolg“ zu erzielen. <br><br>  Zu den Treffern gehörten: Anträge von Seiten von Partnern, die mehrere Tage lang nicht bearbeitet wurden, mangelndes Feedback von Federal Tax Service und OFD, Signaturfehler und unser bevorzugter „unbekannter Fehler“.  Das FTS-Protokoll erwies sich als schlecht dokumentiert und reagierte häufig mit nicht spezifizierten Fehlern, für die nicht klar ist, was sie verursacht hat.  Eine eindeutige Spezifikation existiert noch nicht.  Als wir das Protokoll zum ersten Mal testeten, trafen wir zusammen mit dem OFD Entscheidungen darüber, wie auf bestimmte Antworten des Bundessteuerdienstes in bestimmten Fällen reagiert werden soll. <br><br><h2>  Kassierer-API </h2><br>  Während ein Teil des Teams das Verhalten der Bundessteuerdienstsysteme in der Praxis untersuchte, blieb die Arbeit nicht stehen.  Parallel dazu haben wir Verhandlungen mit Registrierkassenherstellern geführt, sie aufgefordert, Daten von uns auf ihre Plattform, von Plattform zu Registrierkasse und in umgekehrter Reihenfolge für die Einrichtung der automatischen Fiskalisierung von Registrierkassen auszutauschen. <br><br>  Wir haben ein Paar universeller einteiliger Lösungen ausgewählt.  Kassen Evotor mit Touchscreen und DreamCas sind für Kunden gedacht, die an die guten alten Tasten gewöhnt sind und die zusätzliche Funktionalität für überflüssig halten.  Die Modelle sind unterschiedlich: mit und ohne Scanner. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ro/r7/dc/ror7dcretvhsilz3yiw12judrxi.png"></div><br>  Wenn das OFD eine eigene API bereit hatte, musste diese für die Registrierkassen von Grund auf neu entwickelt werden.  Andernfalls ist es unmöglich, alle Registrierungsdaten ohne manuelle Eingabe automatisch in die Registrierkasse zu bringen. <br><br>  Kollegen konnten die Interaktion über ihre Plattform einrichten und waren bald bereit: eine API zum Eröffnen des persönlichen Kontos eines Kunden und ein proprietäres Protokoll zum Verwalten einer Registrierkasse. <br><br><img src="https://habrastorage.org/webt/wy/5h/hr/wy5hhrv-agl7qmya0x9pnpbppde.png"><br><br>  Unsere Lieferanten haben als erste die automatische Übermittlung von Registrierungsinformationen an die Kasse eingerichtet.  Und bald wird es die API genauso einfach machen, Registrierkassen abzumelden und neu zu registrieren. <br><br>  Wenn wir jetzt mit anderen Geldanbietern verhandeln, wird genau die Unterstützung dieser Schnittstelle zu einer der wichtigsten Anforderungen. <br><br><h2>  Anatomie der automatischen Registrierung </h2><br>  Nachdem wir gelernt hatten, wie man mit dem Federal Tax Service zusammenarbeitet und APIs mit Anbietern für die Übertragung von Registrierungsdaten an die Kasse implementiert, war es an der Zeit, all dies in einem einzigen System zu verbinden und ein Registrierungsverfahren einzurichten. <br><br>  Dies ist die Aufgabe der Auswahl der richtigen Architektur, die es uns ermöglichen würde, die asynchrone Registrierung von Registrierkassen im OFD sowohl beim Federal Tax Service als auch beim Verkäufer zu steuern.  Da sie verzögert auf Anfragen reagieren, ist der Prozess zeitaufwändig und weist eine große Anzahl von Integrationen in externe Systeme auf.  Aus diesem Grund mussten wir zwei Anwendungen in Java schreiben. <br><br>  Der Jobdienst kommuniziert direkt mit CRF und Systemen von Registrierkassenherstellern.  Zum Beispiel senden wir Kundendaten an das OFD und erwarten als Antwort eine Registrierungsnummer. <br><br>  Der Jobdienst fragt den Jobstatus in bestimmten Intervallen ab.  Er fragt erneut und fragt erneut, bis das Ergebnis zurückkommt.  Die Registrierungsnummer wird gespeichert, Job überträgt die Bewerbung auf die nächste Stufe und die Fiskalisierung beginnt. <br><br>  Wenn wir zunächst den Durchgang von Anwendungen sorgfältig überwacht und jeden vom System verursachten Fehler manuell untersucht haben, ist der Prozess jetzt automatisiert. <br><br>  Wir ermitteln sofort die Fehlerursache.  Und im Falle massiver Probleme wurden Überwachungssysteme eingerichtet, die Anomalien aufzeichnen, die auf schwerwiegende Fehler beim Federal Tax Service (OFD) hinweisen.  Der Kunde erfährt jedoch im einzigen Fall von den Problemen: Wenn wir als Antwort auf eine Anfrage ein bestimmtes Redject erhalten, eine begründete Ablehnung der Registrierung. <br><br>  Die zweite Anwendung, CashReg, ist ein Verarbeitungssystem, in dem ein Statusmodell verwaltet wird, das in einer relationalen Form dargestellt wird. <br><br>  Es wurde basierend auf den von den Anbietern und dem CRF bereitgestellten APIs entwickelt und enthielt alle möglichen Übergänge für jede am Registrierungsprozess teilnehmende Klasse.  Das Statusmodell vermeidet interne Fehler und eliminiert Abweichungen vom Standardalgorithmus für die Anwendungsverarbeitung. <br><br>  Wenn sich die Anwendung beispielsweise zu lange im selben Status befindet, erhält sie mehrere Stunden lang keine Registrierungsnummer oder das CRF antwortet mit einer falschen Phase oder einem falschen Status der Anwendung. CashReg meldet einen Fehler. <br><br>  Natürlich wurde ein Administrator benötigt, um das Verfahren zu verwalten.  Eine Unterstützungsgruppe für Handelsentscheidungen arbeitet mit ihr zusammen und bedient und begleitet Registrierkassen bei der Registrierung.  Jetzt sind nur noch zwei Mitarbeiter damit beschäftigt, aber ihre Arbeitsoberfläche ist nicht kompliziert, und der Vorbereitungsprozess für die Kasse ist dank der Ablehnung der manuellen Dateneingabe einfach.  So können wir die Abteilung schnell und einfach skalieren. <br><br>  Alle drei Komponenten des Registrierungssystems bedeuten keine hohen Lasten, da sie in virtuellen Umgebungen bereitgestellt werden. <br><br><h2>  Wie ist die Antragsbearbeitung </h2><br>  All dies war erforderlich, damit der Kunde einige Tage später, nachdem er eine Anfrage auf seinem persönlichen Konto hinterlassen hatte, die aktivierte Kasse für die Arbeit hinter der Theke bereitstellte. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f14/777/abe/f14777abe2e59529a31a321dcfbe01ca.png"></div><br>  Aus Sicht der Haushaltsküche wirkt die Magie der automatischen Registrierung etwas komplizierter.  Wenn der Kunde den Antrag in Ihrem persönlichen Konto belässt, erteilt er uns die rechtliche Zustimmung, eine elektronische Signatur auszustellen und das gesamte Verfahren in seinem Namen durchzuführen. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/36e/5ef/ccb/36e5efccba0427be9fef8324a50323c3.png"></div><br>  Informationen über das Unternehmen, Registrierungsdaten für ein bestimmtes Geschäft und den Unterzeichner (z. B. an den Generaldirektor) werden aus Bankdatenbanken extrahiert.  Sie werden in SPARK aktualisiert, durchlaufen die Wertung und betreten das Mastersystem an der Abendkasse. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ae4/749/b78/ae4749b7824fe74ebc8ddefb2d952955.png"></div><br>  Dann wird eine Anwendung in CASHREG gebildet.  Es wird als neue Aufgabe im Admin-Bereich eines Mitarbeiters der Support-Gruppe für Handelslösungen angezeigt.  Er sieht, welche Kasse und welchen Steuerantrieb der Kunde benötigt.  Der Mitarbeiter findet das erforderliche Gerät im Lager, wählt das Steuerlaufwerk aus, codiert seine Seriennummern und bestätigt die Anwendung.  Es sind also bestimmte Geräte angeschlossen, die an den Client geliefert werden.  Zu diesem Zeitpunkt erhält der OFD eine Anfrage: "Bilden Sie einen Antrag auf Registrierung einer solchen und einer solchen Kasse für eine solche und eine solche Firma." <br><br>  Die vom OFD als Antwort gesendete Datei wird durch elektronische Signatur authentifiziert und unter Verwendung der OFD-API an die Steuerbehörden gesendet.  Dort wird der Kasse eine Registrierungsnummer zugewiesen. <br><br>  Jetzt geht das vollständige Paket der Dokumente an der Kasse beim Hersteller der Registrierkasse ein (ja, sie sind auch hier beteiligt).  Gleichzeitig wird im Admin-Bereich eine Aufgabe angezeigt, denselben Kassierer zu fiskalisieren.  Dies bedeutet, dass der Mitarbeiter lediglich den Kassierer einbezieht.  Das System des Anbieters „erkennt“, dass das Gerät in Kontakt ist, und lädt alle erforderlichen Registrierungsdaten automatisch in seinen Speicher.  Fehler bei der manuellen Eingabe sind ausgeschlossen, die gleichen Angaben gehen an den Bundessteuerdienst und die Kasse. <br><br>  Die Kassiererin druckt einen Registrierungsbericht - etwas, für das alles gestartet wurde.  Steuerdaten aus dem Bericht: Druckdatum, Unterschrift, Steuerzeichen dienen als Bestätigung, dass die Kasse betriebsbereit ist.  Diese Daten werden erneut an das OFD gesendet. <br><br>  Unmittelbar nachdem das OFD einen Registrierungsbericht erstellt hat, unterschreiben wir ihn für den Kunden und die Abendkasse geht mit dem Kurier. <br><br><img src="https://habrastorage.org/webt/dc/cs/et/dccsetgp8qnjvcijl84ra3n6vu0.png"><br><br>  OFD hat noch keine Registrierungskarte vorbereitet, aber Sie können es kaum erwarten.  Es wird in zwei bis drei Tagen in elektronischer Form auf dem persönlichen Konto des Kunden verfügbar sein. <br><br><h2>  Fazit </h2><br>  Um dieses Projekt umzusetzen, wurden etwa zwanzig Mitarbeiter aus der ganzen Bank und viele weitere Spezialisten unserer Partner, OFD und Geldverkäufer von ihren üblichen Aufgaben abgelenkt, aber ihre Bemühungen waren nicht umsonst. <br><br>  Die durchschnittliche Zeit, um eine Registrierungsnummer zu erhalten, beträgt mit Ausnahme der negativsten Fälle drei Stunden.  Im Allgemeinen dauert der gesamte Vorgang 5 bis 6 Stunden.  90% der Registrierungen sind erfolgreich.  Derzeit wurden bereits rund 1000 Anträge bearbeitet. <br><br>  Wie Sie verstehen, lieben wir in unserem Unternehmen im Allgemeinen solche Fälle, die das Leben einer großen Anzahl von Menschen erheblich vereinfachen können.  Wenn Sie solche Probleme lösen, haben Sie das Gefühl, etwas wirklich Nützliches zu tun. <br><br>  PS Wenn Sie interessiert sind, können Sie lesen, wie wir selbst <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">unseren Geldautomaten heruntergespült haben</a> .  Darüber hinaus zusammen mit Datenaustauschprotokollen. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de420033/">https://habr.com/ru/post/de420033/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de420021/index.html">Warum brauchst du Splunk? Internet der Dinge und Industriedaten</a></li>
<li><a href="../de420023/index.html">Speichern von Status in Android-Anwendungen</a></li>
<li><a href="../de420025/index.html">Intelligente Farm. Wie wird sie sein?</a></li>
<li><a href="../de420029/index.html">Wie wir bei 1C: Enterprise Systeme algebraischer Gleichungen lösen</a></li>
<li><a href="../de420031/index.html">Zeichnen mit Renderzielen in Unreal Engine</a></li>
<li><a href="../de420035/index.html">Golang GUI: GTK + 3</a></li>
<li><a href="../de420037/index.html">Streamen Sie mit mehreren Kameras aus improvisierten Materialien</a></li>
<li><a href="../de420039/index.html">Funktionales Denken. Teil 2</a></li>
<li><a href="../de420041/index.html">TypeScript War oder Enum Conquest</a></li>
<li><a href="../de420045/index.html">Bunker für das Datum: Wie ich im RUVDS-Rechenzentrum auf dem Territorium der Raumfahrtanlage herumlaufen durfte</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>