<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©‚Äçüè≠ üßî üíÇüèº E, novamente, CAPTCHA ou nginx tamb√©m sabe bordar üåà üë©üèΩ‚Äçüíº ‚úÖ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="1. Introdu√ß√£o 


 Fui aqui para Habr e encontrei nos rascunhos um artigo n√£o publicado sobre captcha, queria formaliz√°-lo e public√°-lo, mas decidi esc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>E, novamente, CAPTCHA ou nginx tamb√©m sabe bordar</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/485804/"><h2>  1. Introdu√ß√£o </h2><br><p>  Fui aqui para Habr e encontrei nos rascunhos um <a href="https://postgres.men/web/nginx/nginx-fast-captcha/">artigo</a> n√£o <a href="https://postgres.men/web/nginx/nginx-fast-captcha/">publicado</a> sobre captcha, queria formaliz√°-lo e public√°-lo, mas decidi escrever um novo artigo alterando levemente o mecanismo e as ferramentas usadas.  Na minha opini√£o, ser√° √∫til ler um artigo antigo, n√£o ser√° pior. </p><br><p>  O principal objetivo de escrever um novo artigo n√£o √© nem mostrar outro mecanismo de trabalho, quanto mostrar os recursos do nginx que √†s vezes s√£o completamente esquecidos, considerando-o um servidor proxy banal. </p><a name="habracut"></a><br><h2>  Condi√ß√µes </h2><br><p>  Para impedir que os bots baixem arquivos, √© usado um "captcha" de teste. </p><br><p>  Ao formar um formul√°rio para um salto de arquivo, uma imagem com um c√≥digo e certas distor√ß√µes √© criada para complicar seu reconhecimento autom√°tico.  Tamb√©m h√° armazenamento para corrigir um par de chave + c√≥digo para verifica√ß√£o. </p><br><p>  Ap√≥s a confirma√ß√£o do formul√°rio para baixar o arquivo e verificar o captcha quanto √† correspond√™ncia do c√≥digo, o arquivo √© fornecido ao usu√°rio ou um link √∫nico √∫nico para o arquivo √© gerado.  A exclusividade do link tamb√©m √© controlada pelo back-end.  O par de chave + c√≥digo tamb√©m √© removido para impedir sua reutiliza√ß√£o. </p><br><p>  H√° um proxy que redireciona todas as solicita√ß√µes para o back-end. </p><br><h2>  Os problemas </h2><br><p> A gera√ß√£o complexa de imagens √© uma opera√ß√£o que consome muitos recursos e, dado que nem todos os c√≥digos mostrados s√£o usados.  √â necess√°rio criar um certo mecanismo para armazenar em cache imagens n√£o utilizadas, a fim de poder exibi-las para outros usu√°rios. </p><br><p>  O c√≥digo e a chave s√£o verificados pelo back-end, mas h√° dificuldades em transferir arquivos grandes por meio do back-end, os links √∫nicos tamb√©m exigem verifica√ß√£o no n√≠vel do back-end. Quero me livrar da carga extra neles. </p><br><h2>  Solu√ß√£o </h2><br><h3>  Selecionar funcionalidade </h3><br><p>  Na verdade, o captcha em si consiste em uma imagem e em uma determinada chave que corresponde ao c√≥digo na imagem armazenada no back-end.  A imagem n√£o √© muito grande e a traduzimos para Base64 e fornecemos um formul√°rio: </p><br><pre><code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">img</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"data:image/png;base64,{{ IMAGE CODE BASE64 }}"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hidden"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"key"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{{ KEY }}"</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  Ou JSON: </p><br><pre> <code class="json hljs">{ ... <span class="hljs-attr"><span class="hljs-attr">"data"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"image"</span></span>: <span class="hljs-string"><span class="hljs-string">"data:image/png;base64,{{ IMAGE CODE BASE64 }}"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"key"</span></span>: <span class="hljs-string"><span class="hljs-string">"{{ KEY }}"</span></span> } }</code> </pre> <br><p>  Se temos uma parte do formul√°rio sendo formada, podemos usar o <a href="http_ssi_module.html">SSI</a> para inseri-la no corpo da p√°gina, para isso habilitamos o modo correspondente na configura√ß√£o nginx no proxy: </p><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">ssi</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>;</code> </pre> <br><p>  E no c√≥digo da p√°gina do formul√°rio, inserimos: </p><br><pre> <code class="xml hljs">... <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">action</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"download"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">method</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"get"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">...</span></span></span><span class="hljs-tag">&gt;</span></span> ... <span class="hljs-comment"><span class="hljs-comment">&lt;!--#include virtual="/x/captcha/generate"--&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag">&gt;</span></span> ...</code> </pre><br><p>  Assim, alocamos a funcionalidade do mapeamento de captcha em <i>locais</i> ou m√©todos separados.  Agora voc√™ pode fazer o cache. </p><br><blockquote>  Sim, o mecanismo <i>SSI (Server Side Include)</i> est√° quase esquecido, mas o m√≥dulo nginx √© mais ativo que todos os vivos e funciona muito rapidamente.  E, a prop√≥sito, se proxy_pass_cache <i>armazena em cache a</i> p√°gina inteira, o resultado da <i>inclus√£o virtual</i> n√£o ser√° armazenado em cache, mas ser√° executado toda vez que for solicitado.  Isso permite que voc√™ fa√ßa a inser√ß√£o din√¢mica. </blockquote><br><h3>  CAPTCHA CAPTCHA </h3><br><p>  Para implementar o cache, precisamos de algo bastante aleat√≥rio e controlado pelo n√∫mero de op√ß√µes, a vari√°vel <i>$ request_id</i> √© adequada para essa fun√ß√£o - √© bastante aleat√≥ria e hexadecimal, ou seja, ao escolher uma determinada parte dessa vari√°vel, voc√™ pode limitar o n√∫mero de elementos do cache para 16 ^ n, em que n - o n√∫mero de caracteres que precisamos extrair da vari√°vel.  Ent√£o: </p><br><p>  Determine a zona de cache: </p><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">proxy_cache_path</span></span> /cache/nginx/captcha levels=<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span> keys_zone=captcha:<span class="hljs-number"><span class="hljs-number">10m</span></span> max_size=<span class="hljs-number"><span class="hljs-number">128m</span></span>;</code> </pre> <br><p>  √â importante determinar qual valor de n escolhemos, respectivamente, os par√¢metros dependem disso: </p><br><ul><li>  n√≠veis = 1: 2 </li><li>  max_size = 128m </li><li>  keys_zone = captcha: 10m </li></ul><br><p>  Ent√£o isso foi suficiente para tudo, mas n√£o havia nada sup√©rfluo.  Em seguida, determinamos a chave de cache: </p><br><pre> <code class="nginx hljs"><span class="hljs-section"><span class="hljs-section">server</span></span> { ... <span class="hljs-attribute"><span class="hljs-attribute">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$captcha_salt</span></span> <span class="hljs-string"><span class="hljs-string">'salt'</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">if</span></span> ( <span class="hljs-variable"><span class="hljs-variable">$request_id</span></span> <span class="hljs-regexp"><span class="hljs-regexp">~* "(\w</span></span>{4})$" ) { <span class="hljs-attribute"><span class="hljs-attribute">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$cache_key</span></span> <span class="hljs-variable"><span class="hljs-variable">$1</span></span>; } ...</code> </pre> <br><p>  A <i>vari√°vel $ captcha_salt</i> ainda √© √∫til para n√≥s, mas agora protege contra poss√≠veis interse√ß√µes de teclas.  Eu escolhi n como 4, o que significa 16 ^ 4 slots de cache, com <i>2kb</i> em m√©dia alocados a cada slot a partir do tamanho total do cache ( <i>max_size = 128m</i> ), o que deve ser suficiente, caso contr√°rio voc√™ precisar√° aumentar o tamanho m√°ximo. </p><br><p>  Fazendo o <i>local</i> apropriado </p><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">location</span></span> /x/captcha/generate { <span class="hljs-attribute"><span class="hljs-attribute">proxy_cache</span></span> captcha; <span class="hljs-attribute"><span class="hljs-attribute">proxy_cache_key</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$captcha_salt</span></span></span><span class="hljs-string">:</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$cache_key</span></span></span><span class="hljs-string">"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_cache_valid</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> <span class="hljs-number"><span class="hljs-number">365d</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_cache_valid</span></span> any <span class="hljs-number"><span class="hljs-number">0s</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> Host <span class="hljs-string"><span class="hljs-string">"captcha.service.domain.my"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> http://captcha_upstream/?cache_key=<span class="hljs-variable"><span class="hljs-variable">$cache_key</span></span>; }</code> </pre> <br><p>  As respostas "boas" de back-end ser√£o armazenadas em cache quase para sempre, o restante n√£o ser√° armazenado em cache.  E sim, voc√™ pode destacar imediatamente a funcionalidade de trabalhar com o captcha em um servi√ßo separado. </p><br><blockquote>  A prop√≥sito, um mecanismo semelhante pode ser usado para gerar pseudo-din√¢mica quando o usu√°rio pressiona F5 e cada vez que uma nova ‚Äúimagem‚Äù aleat√≥ria √© mostrada a ele.  Nesse caso, o back-end praticamente n√£o est√° carregado. </blockquote><br><p>  Tamb√©m precisamos redefinir o cache correspondente ao verificar o formul√°rio, para que o back-end, entre outras coisas, precise fornecer o valor <i>cache_key</i> para transmiti-lo de volta ao formul√°rio como um campo <i>oculto</i> .  Infelizmente, a diretiva <i>proxy_cache_purge</i> est√° dispon√≠vel apenas na vers√£o comercial.  N√£o importa, existe um m√≥dulo <a href="https://github.com/FRiCKLE/ngx_cache_purge">cache_purge de</a> terceiros, que pode ser um pouco mais simples, mas o suficiente para n√≥s.  Portanto, <i>local</i> para liberar o cache: </p><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">location</span></span> /x/captcha/cache/purge { internal; <span class="hljs-attribute"><span class="hljs-attribute">proxy_cache_purge</span></span> captcha <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$captcha_salt</span></span></span><span class="hljs-string">:</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$arg_cache_key</span></span></span><span class="hljs-string">"</span></span>; }</code> </pre> <br><p>  Possui a diretiva <i>interna</i> , j√° que n√£o vamos us√°-la publicamente.  E para chamar esse <i>local,</i> usaremos a diretiva <i>mirror</i> do m√≥dulo <a href="http_mirror_module.html">http_mirror_module</a> : </p><br><p>  Ou seja, fazemos uma solicita√ß√£o paralela para redefinir o cache pela chave da vari√°vel <i>$ arg_cache_key</i> , que √© transmitida no formul√°rio.  Em seguida, apenas copiei a solicita√ß√£o ao nosso back-end, onde o restante do processamento √© realizado. </p><br><h3>  A maneira espinhosa de otimiza√ß√£o </h3><br><p>  Aqui, de fato, eu queria desenvolver um t√≥pico: como separar a verifica√ß√£o do c√≥digo captcha e o retorno do arquivo.  Como impedir que o cache seja lavado com solicita√ß√µes incorretas.  Ent√£o, para otimizar cada vez mais, mas tudo se resume ao fato de que, em geral, n√£o precisamos mais do back-end ... afinal ... porque j√° temos tudo. </p><br><p>  A tarefa que permaneceu com o servidor em termos de verifica√ß√£o de captcha est√° na verdade verificando o c√≥digo da chave + e removendo esse par do reposit√≥rio.  A verifica√ß√£o do c√≥digo da tecla + pode ser uma compara√ß√£o simples do valor md5 da chave.  Para isso, basta um m√≥dulo para n√≥s: <a href="http_secure_link_module.html">http_secure_link_module</a> .  Ou seja, a chave pode ser representada como uma f√≥rmula: </p><br> <code>key = md5_baseurl( salt + code )</code> <br> <p>  Ao mesmo tempo, a liga√ß√£o ao slot do cache (chave do cache) n√£o nos prejudicar√°, n√≥s o adicionamos: </p><br> <code>key = md5_baseurl( salt + code + cache_key )</code> <br> <p>  Temos o Salt - esta √© a vari√°vel <i>$ captcha_salt</i> (por isso foi √∫til), mas manter o sal em dois lugares no backend e proxy √© ruim, ent√£o vamos fazer o seguinte: </p><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">location</span></span> /x/captcha/salt { <span class="hljs-section"><span class="hljs-section">allow</span></span> {{ <span class="hljs-attribute"><span class="hljs-attribute">captcha</span></span> backend IPs }}; <span class="hljs-attribute"><span class="hljs-attribute">deny</span></span> all; <span class="hljs-attribute"><span class="hljs-attribute">return</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$captcha_salt</span></span></span><span class="hljs-string">"</span></span>; }</code> </pre> <br><p>  E deixe o back-end ir ao proxy para o sal. </p><br><p>  A quest√£o permanece no reposit√≥rio, onde armazenamos um par de chave + c√≥digo que precisa ser limpo.  Para fazer isso, o mecanismo de cache que j√° implementamos √© adequado para n√≥s.  A √∫nica coisa √© que n√£o processamos o resultado <i>cache_purge de forma alguma</i> , mas simplesmente espelhamos a solicita√ß√£o, mas isso √© corrig√≠vel.  E sim, isso justifica o uso de uma chave de cache ao criar uma chave captcha. </p><br><h3>  Verifica√ß√£o de c√≥digo </h3><br><p>  Reescreva os downloads de arquivos de <i>localiza√ß√£o</i> : </p><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">location</span></span> /download { <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> Host <span class="hljs-variable"><span class="hljs-variable">$host</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-Context download; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-File-Name <span class="hljs-variable"><span class="hljs-variable">$arg_filename</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-Key <span class="hljs-variable"><span class="hljs-variable">$arg_key</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-Code <span class="hljs-variable"><span class="hljs-variable">$arg_code</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-Cache-Key <span class="hljs-variable"><span class="hljs-variable">$arg_cache_key</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> http://127.0.0.1/x/captcha/check; <span class="hljs-attribute"><span class="hljs-attribute">proxy_intercept_errors</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">error_page</span></span> <span class="hljs-number"><span class="hljs-number">403</span></span> <span class="hljs-number"><span class="hljs-number">404</span></span> = /download/fail; }</code> </pre> <br><p>  Eu passo os par√¢metros necess√°rios com os cabe√ßalhos.  Isso √© opcional, mas √© mais conveniente para mim.  Proxy o processamento para o local local da verifica√ß√£o captcha.  Al√©m disso, <i>context = download</i> √© passado, para que no manipulador possamos produzir um ou outro resultado, dependendo dele.  Nesse caso, o manipulador pode retornar para n√≥s: </p><br><ul><li>  403 - erro de verifica√ß√£o de c√≥digo.  Na verdade, portanto, <i>proxy_intercept_errors √©</i> inclu√≠do e um local √© declarado para redirecionamento em caso de erro; </li><li>  404 - erro de limpeza do cache.  O m√≥dulo <i>cache_purge</i> , se n√£o houver nada no cache com essa chave, retorna 404; </li><li>  200 + <i>Accel-Redirect</i> - no <i>local do</i> upload <i>do</i> arquivo, caso a verifica√ß√£o captcha tenha corrido bem.  No nosso caso, ser√° o <i>X-Accel-Redirect: / store / file</i> </li></ul><br><blockquote>  Se <i>error_page</i> pudesse lidar <i>com</i> c√≥digos <i>2XX</i> , ent√£o seria poss√≠vel faz√™-lo sozinho.  Caso contr√°rio, voc√™ precisar√° usar o mecanismo <i>Accel-Redirect</i> .  Se voc√™ realmente deseja, pode separar os manipuladores de erro 403 e 404; </blockquote><br><p>  Cometer um erro de <i>localiza√ß√£o</i> simples: </p><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">location</span></span> /download/fail { internal; <span class="hljs-attribute"><span class="hljs-attribute">return</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> <span class="hljs-string"><span class="hljs-string">"FAIL DOWNLOAD"</span></span>; }</code> </pre> <br><p>  Voc√™ pode devolver qualquer coisa neste local, dependendo de suas necessidades. </p><br><p>  Estabelecemos o local do upload do arquivo: </p><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">location</span></span> /store/file { internal; <span class="hljs-attribute"><span class="hljs-attribute">add_header</span></span> Content-Disposition <span class="hljs-string"><span class="hljs-string">"attachment; filename=\"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$arg_filename</span></span></span><span class="hljs-string">\""</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">alias</span></span> /spool/tmp/; <span class="hljs-attribute"><span class="hljs-attribute">try_files</span></span> <span class="hljs-variable"><span class="hljs-variable">$arg_filename</span></span> =<span class="hljs-number"><span class="hljs-number">404</span></span>; }</code> </pre> <br><p>  Primeiro, √© importante que seja <i>interno</i> - isso significa que voc√™ n√£o poder√° fazer o download do arquivo diretamente atrav√©s dele, apenas atrav√©s do redirecionamento.  Ele tamb√©m pode ser modificado dependendo das necessidades e n√£o distribuir o arquivo local, mas para proxy da solicita√ß√£o do servi√ßo de armazenamento de arquivos. </p><br><p>  O seguinte <i>local</i> que temos para verifica√ß√£o de captcha: </p><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">location</span></span> /x/captcha/check { <span class="hljs-attribute"><span class="hljs-attribute">allow</span></span> <span class="hljs-number"><span class="hljs-number">127.0.0.1</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">deny</span></span> all; <span class="hljs-attribute"><span class="hljs-attribute">secure_link_md5</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$captcha_salt</span></span></span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$http_x_code</span></span></span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$http_x_cache_key</span></span></span><span class="hljs-string">"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">secure_link</span></span> <span class="hljs-variable"><span class="hljs-variable">$http_x_key</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$secure_link</span></span> = <span class="hljs-string"><span class="hljs-string">""</span></span>) { <span class="hljs-attribute"><span class="hljs-attribute">return</span></span> <span class="hljs-number"><span class="hljs-number">403</span></span> <span class="hljs-string"><span class="hljs-string">"FAIL CHECK CODE"</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> Host <span class="hljs-variable"><span class="hljs-variable">$host</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> http://127.0.0.1/x/captcha/purge; }</code> </pre> <br><p>  Possui 2 blocos: verifica√ß√£o de c√≥digo e proxy adicional para limpar o cache.  Ao mesmo tempo, se a verifica√ß√£o do c√≥digo n√£o for aprovada, retorne imediatamente 403 (o texto n√£o √© importante, pois n√£o √© mais usado). </p><br><p>  A procura em <i>/ x / captcha / purge</i> retornar√° 2 op√ß√µes de resposta: </p><br><ul><li>  200 + <i>Accel-Redirect</i> - ap√≥s a limpeza bem-sucedida do cache.  O redirecionamento ser√° para o <i>X-Accel-Redirect: / x / captcha / check / ok</i> ; </li><li>  404 - se n√£o havia nada para limpar.  Este resultado ser√° passado acima para <i>/ download</i> e ser√° processado nele <i>error_page</i> ; </li></ul><br><p>  Um manipulador separado para a resposta positiva de <i>/ x / captcha / purge</i> √© criado devido ao fato de que primeiro precisamos alcan√ßar um n√≠vel mais alto de proxy, e n√£o entre <i>/ download</i> e <i>/ x / captcha / check</i> .  Em segundo lugar, seria bom dar uma resposta positiva em rela√ß√£o ao contexto. </p><br><p>  Vamos come√ßar com um manipulador de respostas positivas: </p><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">location</span></span> /x/captcha/check/ok { internal; <span class="hljs-attribute"><span class="hljs-attribute">if</span></span> ( <span class="hljs-variable"><span class="hljs-variable">$http_x_context</span></span> = <span class="hljs-string"><span class="hljs-string">'download'</span></span> ) { <span class="hljs-attribute"><span class="hljs-attribute">add_header</span></span> X-Accel-Redirect <span class="hljs-string"><span class="hljs-string">"/store/file?filename=</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$http_x_file_name</span></span></span><span class="hljs-string">"</span></span>; } ... <span class="hljs-attribute"><span class="hljs-attribute">return</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> <span class="hljs-string"><span class="hljs-string">"OK"</span></span>; }</code> </pre> <br><p>  Na verdade, dependendo do valor da vari√°vel <i>$ http_x_context</i> (cabe√ßalho <i>X-Context</i> ), podemos determinar qual <i>Accel-Redirect</i> responder√° com <i>/ x / captcha / check</i> .  Isso significa que voc√™ pode usar esse mecanismo em outros lugares, al√©m de baixar o arquivo. </p><br><p>  Limpar o cache √© bastante simples: </p><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">location</span></span> /x/captcha/purge { <span class="hljs-attribute"><span class="hljs-attribute">allow</span></span> <span class="hljs-number"><span class="hljs-number">127.0.0.1</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">deny</span></span> all; <span class="hljs-attribute"><span class="hljs-attribute">proxy_cache_purge</span></span> captcha <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$http_x_cache_key</span></span></span><span class="hljs-string">"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">add_header</span></span> X-Accel-Redirect <span class="hljs-string"><span class="hljs-string">"/x/captcha/check/ok"</span></span>; }</code> </pre> <br><p>  Em geral, √© tudo, no final, temos a seguinte configura√ß√£o nginx: </p><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">proxy_cache_path</span></span> /cache/nginx/captcha levels=<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span> keys_zone=captcha:<span class="hljs-number"><span class="hljs-number">10m</span></span> max_size=<span class="hljs-number"><span class="hljs-number">128m</span></span>; <span class="hljs-section"><span class="hljs-section">server</span></span> { ... <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> /download { <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> Host <span class="hljs-variable"><span class="hljs-variable">$host</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-Context download; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-File-Name <span class="hljs-variable"><span class="hljs-variable">$arg_filename</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-Key <span class="hljs-variable"><span class="hljs-variable">$arg_key</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-Code <span class="hljs-variable"><span class="hljs-variable">$arg_code</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-Cache-Key <span class="hljs-variable"><span class="hljs-variable">$arg_cache_key</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> http://127.0.0.1/x/captcha/check; <span class="hljs-attribute"><span class="hljs-attribute">proxy_intercept_errors</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">error_page</span></span> <span class="hljs-number"><span class="hljs-number">403</span></span> <span class="hljs-number"><span class="hljs-number">404</span></span> = /download/fail; } <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> /download/fail { internal; <span class="hljs-attribute"><span class="hljs-attribute">return</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> <span class="hljs-string"><span class="hljs-string">"FAIL DOWNLOAD"</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> /store/file { internal; <span class="hljs-attribute"><span class="hljs-attribute">add_header</span></span> Content-Disposition <span class="hljs-string"><span class="hljs-string">"attachment; filename=\"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$arg_filename</span></span></span><span class="hljs-string">\""</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">alias</span></span> /spool/tmp/; <span class="hljs-attribute"><span class="hljs-attribute">try_files</span></span> <span class="hljs-variable"><span class="hljs-variable">$arg_filename</span></span> =<span class="hljs-number"><span class="hljs-number">404</span></span>; } ... <span class="hljs-attribute"><span class="hljs-attribute">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$captcha_salt</span></span> <span class="hljs-string"><span class="hljs-string">'salt'</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">if</span></span> ( <span class="hljs-variable"><span class="hljs-variable">$request_id</span></span> <span class="hljs-regexp"><span class="hljs-regexp">~* "(\w</span></span>{4})$" ) { <span class="hljs-attribute"><span class="hljs-attribute">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$cache_key</span></span> <span class="hljs-variable"><span class="hljs-variable">$1</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> /x/captcha/generate { <span class="hljs-attribute"><span class="hljs-attribute">proxy_cache</span></span> captcha; <span class="hljs-attribute"><span class="hljs-attribute">proxy_cache_key</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$captcha_salt</span></span></span><span class="hljs-string">:</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$cache_key</span></span></span><span class="hljs-string">"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_cache_valid</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> <span class="hljs-number"><span class="hljs-number">365d</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_cache_valid</span></span> any <span class="hljs-number"><span class="hljs-number">0s</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> Host <span class="hljs-string"><span class="hljs-string">"captcha.service.domain.my"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> http://captcha_upstream/?cache_key=<span class="hljs-variable"><span class="hljs-variable">$cache_key</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> /x/captcha/salt { <span class="hljs-section"><span class="hljs-section">allow</span></span> {{ <span class="hljs-attribute"><span class="hljs-attribute">captcha</span></span> backend IPs }}; <span class="hljs-attribute"><span class="hljs-attribute">deny</span></span> all; <span class="hljs-attribute"><span class="hljs-attribute">return</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$captcha_salt</span></span></span><span class="hljs-string">"</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> /x/captcha/check { <span class="hljs-attribute"><span class="hljs-attribute">allow</span></span> <span class="hljs-number"><span class="hljs-number">127.0.0.1</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">deny</span></span> all; <span class="hljs-attribute"><span class="hljs-attribute">secure_link_md5</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$captcha_salt</span></span></span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$http_x_code</span></span></span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$http_x_cache_key</span></span></span><span class="hljs-string">"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">secure_link</span></span> <span class="hljs-variable"><span class="hljs-variable">$http_x_key</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$secure_link</span></span> = <span class="hljs-string"><span class="hljs-string">""</span></span>) { <span class="hljs-attribute"><span class="hljs-attribute">return</span></span> <span class="hljs-number"><span class="hljs-number">403</span></span> <span class="hljs-string"><span class="hljs-string">"FAIL CHECK CODE"</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> Host <span class="hljs-variable"><span class="hljs-variable">$host</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> http://127.0.0.1/x/captcha/purge; } <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> /x/captcha/check/ok { internal; <span class="hljs-attribute"><span class="hljs-attribute">if</span></span> ( <span class="hljs-variable"><span class="hljs-variable">$http_x_context</span></span> = <span class="hljs-string"><span class="hljs-string">'download'</span></span> ) { <span class="hljs-attribute"><span class="hljs-attribute">add_header</span></span> X-Accel-Redirect <span class="hljs-string"><span class="hljs-string">"/store/file?filename=</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$http_x_file_name</span></span></span><span class="hljs-string">"</span></span>; } ... <span class="hljs-attribute"><span class="hljs-attribute">return</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> <span class="hljs-string"><span class="hljs-string">"OK"</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> /x/captcha/purge { <span class="hljs-attribute"><span class="hljs-attribute">allow</span></span> <span class="hljs-number"><span class="hljs-number">127.0.0.1</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">deny</span></span> all; <span class="hljs-attribute"><span class="hljs-attribute">proxy_cache_purge</span></span> captcha <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$http_x_cache_key</span></span></span><span class="hljs-string">"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">add_header</span></span> X-Accel-Redirect <span class="hljs-string"><span class="hljs-string">"/x/captcha/check/ok"</span></span>; } }</code> </pre> <br><p>  O que voc√™ deve prestar aten√ß√£o: <br></p><ul><li>  O Accel-Redirect funciona apenas quando o status da resposta √© 2XX.  √â verdade que, infelizmente, nada foi escrito sobre isso em nenhum lugar, e os adeptos do nginx discordam; </li><li>  <i>Locais</i> privados pr√≥ximos <i>permitem 127.0.0.1;</i>  <i>negar tudo;</i>  seja <i>interno;</i>  , dependendo de chegarmos a esse <i>local</i> por <i>proxy_pass</i> ou por <i>Accel-Redirect</i> ; </li><li>  Todos os <i>locais</i> associados ao captcha s√£o destacados em <i>/ x / capcha / ...</i> para que seja poss√≠vel formar um microsservi√ßo; </li></ul><br><p>  Para maior clareza, tamb√©m desenhei um diagrama do trabalho: </p><br><img src="https://habrastorage.org/getpro/habr/post_images/245/8bc/6c8/2458bc6c8defdbbf6f6f0bcfccb0f05a.png" alt="imagem"><br><h2>  Sum√°rio </h2><br><p>  Como resultado, a partir do back-end, precisamos apenas gerar diretamente a imagem e o c√≥digo para ela.  O Nginx pode lidar facilmente com o resto.  Obviamente, essas s√£o opera√ß√µes l√≥gicas relativamente simples, mas, no entanto, isso acelerar√° significativamente o trabalho e reduzir√° a carga no back-end.  De fato, n√£o usamos mecanismos incomuns, mas apenas: </p><br><ul><li>  proxy_cache; </li><li>  Acelerar-Redirecionar </li><li>  error_page; </li><li>  secure_link </li><li>  cache_purge; </li></ul><br><p>  O resto √© a constru√ß√£o correta de cadeias l√≥gicas. </p><br><p>  Tamb√©m removemos o reposit√≥rio de back-end tempor√°rio para c√≥digos e links √∫nicos.  No entanto, eles criaram um elemento obrigat√≥rio do sistema nginx, aumentando seu peso funcional. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt485804/">https://habr.com/ru/post/pt485804/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt485788/index.html">Como fazer com que qualquer processo funcione com o NTFS transacional: minha primeira etapa para escrever uma sandbox para Windows</a></li>
<li><a href="../pt485790/index.html">Entrevistas: expectativas versus realidade</a></li>
<li><a href="../pt485792/index.html">Ivan Lilekvist e Kim Dotkom, uma grande entrevista: a hist√≥ria do Megaupload, extradi√ß√£o para os Estados Unidos, liberdade, bitcoin. Parte 2</a></li>
<li><a href="../pt485794/index.html">Voc√™ est√° desenvolvendo no .NET Core? Vamos para o Ubuntu, eu preparei tudo</a></li>
<li><a href="../pt485796/index.html">Resolver o insol√∫vel</a></li>
<li><a href="../pt485806/index.html">Coronav√≠rus: da SARS a 2019-nCoV</a></li>
<li><a href="../pt485810/index.html">Ganchos de tempo de compila√ß√£o Elixir</a></li>
<li><a href="../pt485812/index.html">7 etapas de teste da evolu√ß√£o em uma empresa</a></li>
<li><a href="../pt485820/index.html">Pessoa muito atacada: descubra quem √© o principal alvo dos cibercriminosos na sua empresa.</a></li>
<li><a href="../pt485824/index.html">Como fazer um bot que transforma uma foto em quadrinhos. Parte tr√™s. Modelo de hospedagem sem servidor + GPU gratuito</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>