<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë∞üèΩ ‚òùüèø üöπ Como implementamos a entrega cont√≠nua de atualiza√ß√µes na plataforma do cliente üë®‚Äçüç≥ üõ∑ ‚ñ™Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Na True Engineering, configuramos o processo de entrega cont√≠nua de atualiza√ß√µes para os servidores do cliente e queremos compartilhar essa experi√™nci...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como implementamos a entrega cont√≠nua de atualiza√ß√µes na plataforma do cliente</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/true_engineering/blog/447812/">  Na True Engineering, configuramos o processo de entrega cont√≠nua de atualiza√ß√µes para os servidores do cliente e queremos compartilhar essa experi√™ncia. <br><br>  Primeiro, desenvolvemos um sistema online para o cliente e o implantamos em nosso pr√≥prio cluster Kubernetes.  Agora, nossa solu√ß√£o altamente carregada mudou para a plataforma do cliente, para a qual configuramos o processo de implanta√ß√£o cont√≠nua totalmente autom√°tico.  Gra√ßas a isso, aceleramos o tempo de coloca√ß√£o no mercado - entrega de altera√ß√µes no ambiente do produto. <br><br>  Neste artigo, falaremos sobre todos os est√°gios do processo de implanta√ß√£o cont√≠nua (CD) ou entrega de atualiza√ß√µes para a plataforma do cliente: <br><br><ol><li>  como esse processo come√ßa </li><li>  sincroniza√ß√£o com o reposit√≥rio Git do cliente, </li><li>  montagem de back-end e front-end </li><li>  implanta√ß√£o autom√°tica do aplicativo em um ambiente de teste, </li><li>  implanta√ß√£o autom√°tica no Prod. </li></ol><br>  No processo, compartilharemos os detalhes das configura√ß√µes. <br><br><img src="https://habrastorage.org/webt/ii/pa/gh/iipaghverrphnx-_scgemoqhgy0.jpeg"><br><a name="habracut"></a><br><h3>  1. Inicie o CD </h3><br>  A Implanta√ß√£o Cont√≠nua come√ßa com o fato de o desenvolvedor postar as altera√ß√µes na ramifica√ß√£o de lan√ßamento do nosso reposit√≥rio Git. <br><br>  Nosso aplicativo funciona com base na arquitetura de microsservi√ßo e todos os seus componentes s√£o armazenados em um reposit√≥rio.  Gra√ßas a isso, todos os microsservi√ßos s√£o montados e instalados, mesmo que um deles tenha sido alterado. <br><br>  Organizamos o trabalho atrav√©s de um reposit√≥rio por v√°rios motivos: <br><br><ul><li>  Facilidade de desenvolvimento - o aplicativo est√° desenvolvendo ativamente, para que voc√™ possa trabalhar imediatamente com todo o c√≥digo. </li><li>  Um √∫nico pipeline de CI / CD que garante que o aplicativo como um sistema √∫nico passe em todos os testes e seja entregue ao ambiente de produtos do cliente. </li><li>  Exclu√≠mos confus√£o nas vers√µes - n√£o precisamos armazenar um mapa de vers√µes de microsservi√ßo e descrever nossa configura√ß√£o para cada microsservi√ßo nos scripts Helm. </li></ul><br><h3>  2. Sincroniza√ß√£o com o reposit√≥rio Git do c√≥digo-fonte do cliente </h3><br>  As altera√ß√µes feitas s√£o sincronizadas automaticamente com o reposit√≥rio Git do cliente.  L√°, o conjunto do aplicativo √© configurado, que √© iniciado ap√≥s a atualiza√ß√£o da ramifica√ß√£o e a implanta√ß√£o no prod.  Ambos os processos ocorrem em seu ambiente a partir do reposit√≥rio Git. <br><br>  N√£o podemos trabalhar diretamente com o reposit√≥rio do cliente, porque precisamos de nossos pr√≥prios ambientes de desenvolvimento e teste.  Usamos nosso reposit√≥rio Git para esses fins - ele √© sincronizado com o reposit√≥rio Git.  Assim que o desenvolvedor postar as altera√ß√µes na ramifica√ß√£o apropriada do nosso reposit√≥rio, o GitLab envia imediatamente essas altera√ß√µes ao cliente. <br><br><img src="https://habrastorage.org/webt/x4/de/zu/x4dezunuwwydsx3xq2uaxj1wbzo.png"><br><br>  Depois disso, voc√™ precisa fazer uma montagem.  Consiste em v√°rias etapas: montagem do back-end e front-end, teste e entrega ao produto. <br><br><h3>  3. Crie o back-end e o front-end </h3><br>  Montagem de back-end e front-end s√£o duas tarefas paralelas que s√£o executadas no sistema GitLab Runner.  Sua configura√ß√£o da montagem original est√° no mesmo reposit√≥rio. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Tutorial para escrever um script YAML para compilar no GitLab</a> . <br><br>  O GitLab Runner pega o c√≥digo do reposit√≥rio desejado, coleta o comando de constru√ß√£o do aplicativo Java e o envia ao registro do Docker.  Aqui, coletamos o back-end e o front-end, obtemos imagens do Docker, que colocamos no reposit√≥rio no lado do cliente.  Para gerenciar imagens do Doker, use o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">plug-in Gradle</a> . <br><br>  Sincronizamos as vers√µes de nossas imagens com a vers√£o do lan√ßamento, que ser√° publicada no Docker.  Para um bom funcionamento, fizemos v√°rias configura√ß√µes: <br><br>  1. Entre o ambiente de teste e os cont√™ineres de supermercado, n√£o s√£o remontados.  Fizemos a parametriza√ß√£o para que o mesmo cont√™iner pudesse funcionar sem reconstruir com todas as configura√ß√µes, vari√°veis ‚Äã‚Äãde ambiente e servi√ßos, tanto no ambiente de teste quanto no produto. <br><br>  2. Para atualizar o aplicativo atrav√©s do Helm, voc√™ deve especificar sua vers√£o.  Temos o conjunto de back-end, o front-end e a atualiza√ß√£o do aplicativo - essas s√£o tr√™s tarefas diferentes, por isso √© importante usar a mesma vers√£o do aplicativo em qualquer lugar.  Para esta tarefa, usamos dados do hist√≥rico do Git, pois temos uma configura√ß√£o de cluster K8S e os aplicativos est√£o no mesmo reposit√≥rio Git. <br><br>  Obtemos a vers√£o do aplicativo a partir dos resultados do comando <br>  <code>git describe --tags --abbrev=7</code> . <br><br><h3>  4. Implanta√ß√£o autom√°tica de todas as altera√ß√µes em um ambiente de teste (UAT) </h3><br>  A pr√≥xima etapa deste script de constru√ß√£o √© atualizar automaticamente o cluster K8S.  Isso acontece desde que todo o aplicativo seja montado e todos os artefatos sejam publicados no Docker Registry.  Depois disso, a atualiza√ß√£o do ambiente de teste √© iniciada. <br><br>  A atualiza√ß√£o de cluster √© iniciada usando o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Helm Update</a> .  Se, como resultado, algo der errado, o Helm reverter√° automaticamente e independentemente todas as altera√ß√µes.  Seu trabalho n√£o precisa ser controlado. <br><br>  Juntamente com a montagem, entregamos a configura√ß√£o do cluster K8S.  Portanto, a pr√≥xima etapa √© atualiz√°-lo: configMaps, implanta√ß√µes, servi√ßos, segredos e quaisquer outras configura√ß√µes do K8S que alteramos. <br><br>  Depois disso, o Helm inicia o RollOut e atualiza o aplicativo em um ambiente de teste.  Antes de o aplicativo ser implantado no prod.  Isso √© feito para que os usu√°rios verifiquem manualmente os recursos comerciais que publicamos no ambiente de teste. <br><br><h3>  5. Implante automaticamente todas as altera√ß√µes no Prod </h3><br>  Para implantar a atualiza√ß√£o no ambiente do produto, basta clicar em um bot√£o no GitLab - e os cont√™ineres s√£o entregues imediatamente no ambiente do produto. <br><br>  Um mesmo aplicativo pode funcionar sem reconstruir em ambientes diferentes - teste e produ√ß√£o.  Usamos os mesmos artefatos sem alterar nada no aplicativo e configuramos os par√¢metros de fora. <br><br>  A parametriza√ß√£o flex√≠vel das configura√ß√µes do aplicativo depende do ambiente em que esse aplicativo ser√° executado.  Tiramos todas as configura√ß√µes do ambiente: tudo √© parametrizado atrav√©s da configura√ß√£o do K8S e dos par√¢metros Helm.  Quando o Helm implanta uma montagem em um ambiente de teste, os par√¢metros de teste se aplicam a ele e os par√¢metros do produto se aplicam ao ambiente do produto. <br><br>  O mais dif√≠cil foi parametrizar todos os servi√ßos e vari√°veis ‚Äã‚Äãusadas, que dependem do ambiente, e convert√™-los em vari√°veis ‚Äã‚Äãde ambiente e uma descri√ß√£o-configura√ß√£o dos par√¢metros de ambiente do Helm. <br><br>  Os par√¢metros do aplicativo usam vari√°veis ‚Äã‚Äãde ambiente.  Seus valores s√£o definidos em cont√™ineres usando o configmap K8S, que √© modelado usando modelos Go.  Por exemplo, a configura√ß√£o de uma vari√°vel de ambiente como um nome de dom√≠nio pode ser feita assim: <br><br><pre> <code class="plaintext hljs">APP_EXTERNAL_DOMAIN: {{ (pluck .Values.global.env .Values.app.properties.app_external_domain | first) }}</code> </pre> <br>  <b>.Values.global.env</b> - o nome do ambiente (prod, stage, UAT) √© armazenado nessa vari√°vel. <br>  <b>.Values.app.properties.app_external_domain</b> - nessa vari√°vel, no arquivo .Values.yaml, definimos o dom√≠nio desejado <br><br>  Ao atualizar o aplicativo, o Helm cria o arquivo configmap.yaml a partir dos modelos e preenche o valor APP_EXTERNAL_DOMAIN com o valor necess√°rio, dependendo do ambiente em que a atualiza√ß√£o do aplicativo √© iniciada.  Essa vari√°vel j√° est√° definida no cont√™iner.  O acesso a ele √© do aplicativo, respectivamente, em cada ambiente do aplicativo, haver√° um valor diferente dessa vari√°vel. <br><br>  Relativamente recente, o Spring Cloud introduziu o suporte ao K8S, incluindo o trabalho com o configMaps: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Spring Cloud Kubernetes</a> .  Enquanto o projeto estiver ativamente desenvolvendo e mudando drasticamente, n√£o podemos us√°-lo na produ√ß√£o.  Mas monitoramos ativamente sua condi√ß√£o e a usamos nas configura√ß√µes de DEV.  Assim que estabilizar, passaremos de usar vari√°veis ‚Äã‚Äãde ambiente para ele. <br><br><h3>  Total </h3><br>  Portanto, a implanta√ß√£o cont√≠nua est√° em funcionamento.  Todas as atualiza√ß√µes ocorrem com o clique de um bot√£o.  A entrega de altera√ß√µes no ambiente alimentar √© autom√°tica.  E, o mais importante, as atualiza√ß√µes n√£o param o sistema. <br><br><img src="https://habrastorage.org/webt/3j/aq/bs/3jaqbs3llw95qie5ienc8efaymw.jpeg"><br><br><h3>  Planos futuros: migra√ß√£o autom√°tica de base </h3><br>  Pensamos em atualizar o banco de dados e na capacidade de reverter essas altera√ß√µes.  Afinal, duas vers√µes diferentes do aplicativo funcionam simultaneamente: a antiga funciona e a nova aumenta.  E desligaremos a antiga somente quando estivermos convencidos de que a nova vers√£o est√° funcionando.  A migra√ß√£o do banco de dados deve permitir trabalhar com ambas as vers√µes do aplicativo. <br><br>  Portanto, n√£o podemos apenas mudar o nome da coluna ou outros dados.  Mas podemos criar uma nova coluna, copiar os dados da coluna antiga para ela e escrever gatilhos que, quando os dados forem atualizados, os copiar√£o e atualizar√£o simultaneamente em outra coluna.  E ap√≥s a implanta√ß√£o bem-sucedida da nova vers√£o do aplicativo, ap√≥s o per√≠odo de suporte p√≥s-lan√ßamento, podemos excluir a coluna antiga e o gatilho que se tornou desnecess√°rio. <br><br>  Se a nova vers√£o do aplicativo n√£o funcionar corretamente, podemos reverter para a vers√£o anterior, incluindo a vers√£o anterior do banco de dados.  Em uma palavra, nossas altera√ß√µes permitir√£o trabalhar simultaneamente com v√°rias vers√µes do aplicativo. <br><br>  Planejamos automatizar a migra√ß√£o do banco de dados atrav√©s do trabalho K8S, incorporando-o ao processo do CD.  E certamente compartilharemos essa experi√™ncia em Habr√©. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt447812/">https://habr.com/ru/post/pt447812/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt447802/index.html">Isabella 2</a></li>
<li><a href="../pt447804/index.html">Dwarf Fortress abandona gr√°ficos de texto, mas n√£o sua ess√™ncia</a></li>
<li><a href="../pt447806/index.html">Acelerando o desempenho de redes neurais usando hash</a></li>
<li><a href="../pt447808/index.html">Aprendendo a escrever contratos inteligentes do Waves no RIDE e RIDE4DAPPS. Parte 2 (DAO - Organiza√ß√£o Aut√¥noma Descentralizada)</a></li>
<li><a href="../pt447810/index.html">O Analytics for Azure DevOps Services agora est√° dispon√≠vel ao p√∫blico</a></li>
<li><a href="../pt447814/index.html">Onde e como abrir um centro de desenvolvimento?</a></li>
<li><a href="../pt447816/index.html">Um pouco de magia de modelo C ++ e CRTP para controlar a corre√ß√£o das a√ß√µes do programador em tempo de compila√ß√£o</a></li>
<li><a href="../pt447818/index.html">AgileDays 2019</a></li>
<li><a href="../pt447820/index.html">Importe modelos 3D para o Unity e armadilhas</a></li>
<li><a href="../pt447822/index.html">Quase demitido. Como criei o departamento de an√°lise Yandex</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>