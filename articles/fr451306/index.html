<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßëüèæ‚Äçü§ù‚Äçüßëüèº üë®üèº‚Äçüíª üê° QEMU.js: maintenant s√©rieusement et avec WASM üë©üèæ‚Äçüåæ üçÇ üéûÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Il √©tait une fois, pour rire, j'ai d√©cid√© de prouver la r√©versibilit√© du processus et d'apprendre √† g√©n√©rer JavaScript (ou plut√¥t Asm.js) √† partir du ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>QEMU.js: maintenant s√©rieusement et avec WASM</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/451306/"><p>  Il √©tait une fois, pour rire, j'ai d√©cid√© de <em>prouver la r√©versibilit√© du processus</em> et d'apprendre √† g√©n√©rer JavaScript (ou plut√¥t Asm.js) √† partir du code machine.  QEMU a √©t√© choisi pour l'exp√©rience, quelque temps plus tard, un article a √©t√© √©crit sur Habr.  Dans les commentaires, on m'a conseill√© de refaire le projet sur WebAssembly, et moi-m√™me je n'avais pas envie de quitter le projet <em>presque termin√©</em> moi-m√™me ... Le travail a continu√©, mais tr√®s lentement, et maintenant, dans cet article, un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">commentaire</a> est apparu sur le sujet "Alors, comment √ßa s'est <em>termin√©</em> ?".  Pour ma r√©ponse d√©taill√©e, j'ai entendu "Cela tire sur un article."  Eh bien, si √ßa tire, il y aura un article.  Peut-√™tre que quelqu'un vous sera utile.  √Ä partir de l√†, le lecteur apprend quelques faits sur la g√©n√©ration de code QEMU de backends de l'appareil, ainsi que sur la fa√ßon d'√©crire un compilateur Just-in-Time pour une application Web. </p><a name="habracut"></a><br><h2 id="zadachi">  Les t√¢ches </h2><br><p>  Comme j'ai d√©j√† appris √† "porter" QEMU sur JavaScript, cette fois, il a √©t√© d√©cid√© de le faire judicieusement et de ne pas r√©p√©ter les anciennes erreurs. </p><br><h3 id="oshibka-nomer-raz-otvetvitsya-ot-point-release">  Nombre de fois d'erreur: branche √† partir de la lib√©ration de points </h3><br><p> Ma premi√®re erreur a √©t√© de d√©river ma version de la version amont 2.4.1.  Ensuite, cela m'a sembl√© une bonne id√©e: s'il existe une version ponctuelle, elle est probablement plus stable qu'une simple 2.4, et plus encore <code>master</code> branche <code>master</code> .  Et comme je pr√©voyais d'ajouter une bonne quantit√© de mes bugs, je n'avais pas du tout besoin d'√©trangers.  Alors c'est probablement arriv√©.  Mais voici la malchance: QEMU ne reste pas immobile, et √† un moment donn√©, ils ont m√™me annonc√© l'optimisation du code de pourcentage g√©n√©r√© par 10. "Ouais, maintenant je g√®le", je pensais <del>  et rompit </del>  .  Ici, nous devons faire une digression: en raison de la nature √† un seul thread de QEMU.js et du fait que le QEMU d'origine n'implique pas l'absence de multithreading (c'est-√†-dire, il est essentiel qu'il puisse exploiter plusieurs chemins de code non li√©s en m√™me temps, et pas seulement ¬´brancher tous les noyaux¬ª), les principales fonctions des threads a d√ª "tourner" pour la possibilit√© d'un appel de l'ext√©rieur.  Cela a cr√©√© des probl√®mes de fusion naturels.  Cependant, le fait que certaines des modifications de la branche principale, avec lesquelles j'ai essay√© de fusionner mon code, ont √©galement √©t√© choisies dans la version ponctuelle (et, par cons√©quent, dans ma branche), n'ajouterait probablement pas la commodit√©. </p><br><p>  En g√©n√©ral, j'ai d√©cid√© que de toute fa√ßon le prototype avait du sens <del>  jeter </del>  d√©monter pour les pi√®ces et construire une nouvelle version √† partir de z√©ro bas√©e sur quelque chose de plus frais et maintenant de <code>master</code> . </p><br><h3 id="oshibka-nomer-dva-tlp-metodologiya">  Erreur num√©ro deux: m√©thodologie TLP </h3><br><p>  En fait, ce n'est pas une erreur, en g√©n√©ral - c'est juste une caract√©ristique de cr√©er un projet dans des conditions de m√©connaissance totale de "o√π et comment se d√©placer?", Et en g√©n√©ral "allons-nous y arriver?".  Dans ces conditions, la <em>programmation</em> √©tait une option justifiable, mais, bien s√ªr, je ne voulais absolument pas la r√©p√©ter inutilement.  Cette fois, je voulais le faire avec sagesse: commits atomiques, changements d√©lib√©r√©s de code (et non ¬´encha√Æner des caract√®res al√©atoires jusqu'√† ce qu'il compile (avec des avertissements)¬ª, comme Linus Torvalds l'a dit un jour √† propos de quelqu'un, si vous croyez Wikitatnik), etc. </p><br><h3 id="oshibka-nomer-tri-ne-znaya-brodu-lezt-v-vodu">  Erreur num√©ro trois: ne pas savoir que le gu√© monte dans l'eau </h3><br><p>  Je ne me suis pas encore compl√®tement d√©barrass√© de cela, mais maintenant j'ai d√©cid√© de ne pas suivre le chemin de la moindre r√©sistance, et de le faire "√† la mani√®re d'un adulte", √† savoir, √©crire mon backend TCG √† partir de z√©ro afin de ne pas dire plus tard, "Oui, il Bien s√ªr, lentement, mais je ne peux pas tout contr√¥ler - TCI est √©crit comme √ßa ... ".  De plus, au d√©but, cela semblait √™tre une solution √©vidente, car <em>je g√©n√©rais du code binaire</em> .  Comme le dit le proverbe, "J'ai r√©cup√©r√© Gand, mais pas celui-l√†": le code est, bien s√ªr, binaire, mais le contr√¥le ne peut pas √™tre transf√©r√© comme √ßa - il doit √™tre explicitement pouss√© dans le navigateur pour la compilation, r√©sultant en un certain objet du monde JS, qui encore besoin d'enregistrer quelque part.  Cependant, le <del>  normal </del>  Pour les architectures RISC, si je comprends bien, une situation typique est la n√©cessit√© de vider explicitement le cache d'instructions pour le code r√©g√©n√©r√© - si ce n'est pas ce dont nous avons besoin, alors au moins c'est proche.  De plus, lors de ma derni√®re tentative, j'ai appris que le contr√¥le ne semble pas √™tre transf√©r√© au milieu du bloc de traduction, par cons√©quent, nous n'avons pas vraiment besoin que le bytecode soit interpr√©t√© √† partir de n'importe quel d√©calage, et nous pouvons simplement g√©n√©rer par fonction sur TB. </p><br><h2 id="prishli-i-pnuli">  Entr√© et coups de pied </h2><br><p>  Bien que j'ai commenc√© √† r√©√©crire le code en juillet, le Pendel magique s'est gliss√© inaper√ßu: g√©n√©ralement des lettres de GitHub viennent comme des notifications de r√©ponses aux probl√®mes et aux demandes Pull, puis, <em>tout √† coup</em> , le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Binaryen en tant que backend qemu</a> dans le contexte <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">dit</a> : ¬´Le voici - il a fait quelque chose comme √ßa, peut-√™tre qu'il dira quelque chose. ¬ª  Il s'agissait d'utiliser la biblioth√®que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Binaryen</a> li√©e √† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Emscripten</a> pour cr√©er un WASM JIT.  Eh bien, j'ai dit que vous disposez d'une licence Apache 2.0 et que QEMU dans son ensemble est distribu√© sous GPLv2, et ils ne sont pas tr√®s compatibles.  Il s'est av√©r√© que la licence pouvait √™tre <em>corrig√©e d'une mani√®re ou d'</em> une <em>autre</em> (je ne sais pas: peut-√™tre, changer, peut-√™tre doubler la licence, peut-√™tre autre chose ...).  Bien s√ªr, cela m'a fait plaisir, car j'avais d√©j√† regard√© le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">format binaire</a> WebAssembly plusieurs fois √† ce moment-l√†, et j'√©tais en quelque sorte triste et incompr√©hensible pour moi.  Il y avait une biblioth√®que ici qui engloutirait les blocs de base avec le graphe de transition, et √©mettrait le bytecode, et m√™me le lancerait dans l'interpr√©teur si n√©cessaire. </p><br><p>  Ensuite, il y avait aussi une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">lettre</a> sur la liste de diffusion QEMU, mais celle-ci est plus susceptible de se poser la question: "Qui en a besoin?"  Et cela, <strong>soudain</strong> , √©tait n√©cessaire.  Au minimum, vous pouvez regrouper de tels cas d'utilisation si cela fonctionne plus ou moins intelligemment: </p><br><ul><li>  lancer quoi que ce soit d'enseignement sans aucune installation du tout </li><li>  virtualisation sur iOS, o√π selon les rumeurs la seule application qui a le droit de g√©n√©rer du code √† la vol√©e est le moteur JS (est-ce vrai?) </li><li>  d√©monstration mini-OS - un seul disque, int√©gr√©, toutes sortes de firmware, etc ... </li></ul><br><h2 id="osobennosti-brauzernoy-sredy-vypolneniya">  Caract√©ristiques du runtime du navigateur </h2><br><p>  Comme je l'ai dit, QEMU est li√© au multithreading, mais il n'est pas dans le navigateur.  Eh bien, c'est comme si non ... Au d√©but, ce n'√©tait pas l√† du tout, puis les WebWorkers sont apparus - si je comprends bien, c'est du multithreading bas√© sur le passage de messages <strong>sans variables</strong> mutuellement <strong>variables</strong> .  Naturellement, cela cr√©e des probl√®mes importants lors du portage de code existant bas√© sur un mod√®le de m√©moire partag√©e.  Puis, sous la pression du public, il a √©t√© impl√©ment√© sous le nom <code>SharedArrayBuffers</code> .  Ils l'ont progressivement introduit, ont c√©l√©br√© son lancement dans diff√©rents navigateurs, puis ont c√©l√©br√© la nouvelle ann√©e, puis Meltdown ... Apr√®s quoi ils sont arriv√©s √† la conclusion que grossier, ne pas grossier la mesure du temps, mais avec l'aide de la m√©moire partag√©e et d'un flux incr√©mentant le compteur, c'est toujours <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">assez pr√©cis</a> .  Ils ont donc d√©sactiv√© le multithreading avec la m√©moire partag√©e.  Il semble qu'ils l'ont r√©activ√© plus tard, mais, comme il est devenu clair √† partir de la premi√®re exp√©rience, il y a de la vie sans elle, et si c'est le cas, nous essaierons de le faire sans compter sur le multithreading. </p><br><p>  La deuxi√®me caract√©ristique est l'impossibilit√© de manipulations de bas niveau avec la pile: vous ne pouvez pas simplement prendre, enregistrer le contexte actuel et passer √† un nouveau avec une nouvelle pile.  La pile d'appels est g√©r√©e par la machine virtuelle JS.  Il semblerait, quel est le probl√®me, puisque nous avons quand m√™me d√©cid√© de g√©rer les anciens flux compl√®tement manuellement?  Le fait est que le bloc entr√©e-sortie dans QEMU est impl√©ment√© via des coroutines, et ici des manipulations de pile de bas niveau nous seraient utiles.  Heureusement, Emscipten contient d√©j√† un m√©canisme pour les op√©rations asynchrones, m√™me deux: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Asyncify</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Emterpreter</a> .  Le premier fonctionne gr√¢ce √† un ballonnement important du code JavaScript g√©n√©r√© et n'est plus pris en charge.  La seconde est la "voie correcte" actuelle et fonctionne gr√¢ce √† la g√©n√©ration de bytecode pour son propre interpr√®te.  Cela fonctionne, bien s√ªr, lentement, mais cela ne gonfle pas le code.  Certes, la prise en charge de la coroutine pour ce m√©canisme devait √™tre attribu√©e seule (il y avait d√©j√† des coroutines √©crites sous Asyncify et il y avait une impl√©mentation d'environ la m√™me API pour Emterpreter, vous deviez simplement les connecter). </p><br><p>  Pour le moment, je n'ai pas encore r√©ussi √† diviser le code en compil√© dans WASM et interpr√©t√© en utilisant Emterpreter, donc les p√©riph√©riques de blocs ne fonctionnent pas encore (voir la prochaine s√©rie, comme on dit ...).  Autrement dit, √† la fin, vous devriez obtenir quelque chose de super dr√¥le: </p><br><ul><li>  E / S de bloc interpr√©t√©es.  Eh bien, qu'attendiez-vous vraiment d'un NVMe √©mul√© avec des performances natives?  :) </li><li>  code QEMU principal compil√© statiquement (traducteur, autres p√©riph√©riques √©mul√©s, etc.) </li><li>  Code invit√© WASM compil√© dynamiquement </li></ul><br><h2 id="osobennosti-ishodnikov-qemu">  Caract√©ristiques des sources QEMU </h2><br><p>  Comme vous l'avez probablement d√©j√† devin√©, le code d'√©mulation pour les architectures invit√©es et le code pour g√©n√©rer des instructions de machine h√¥te √† partir de QEMU sont s√©par√©s.  En fait, il y a m√™me un peu plus d√©licat: </p><br><ul><li>  il y a des architectures invit√©es </li><li>  il existe des <em>acc√©l√©rateurs</em> , √† savoir KVM pour la virtualisation mat√©rielle sous Linux (pour les syst√®mes h√¥tes et h√¥tes compatibles), TCG pour la g√©n√©ration de code JIT n'importe o√π.  √Ä partir de QEMU 2.9, la prise en charge de la norme de virtualisation mat√©rielle HAXM sous Windows est apparue ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">d√©tails</a> ) </li><li>  si TCG est utilis√©, et non la virtualisation mat√©rielle, il prend en charge s√©par√©ment la g√©n√©ration de code pour chaque architecture h√¥te, ainsi que pour un interpr√©teur universel </li><li>  ... et tout autour - p√©riph√©riques √©mul√©s, interface utilisateur, migration, relecture d'enregistrement, etc. </li></ul><br><p>  <em>Au fait, le saviez-vous:</em> QEMU peut √©muler non seulement l'ordinateur entier, mais aussi le processeur pour un processus utilisateur s√©par√© dans le noyau h√¥te, qui est utilis√©, par exemple, par le flou AFL pour l'instrumentation des binaires.  Peut-√™tre que quelqu'un veut porter ce mode de fonctionnement QEMU sur JS?  ;) </p><br><p>  Comme la plupart des programmes gratuits de longue date, QEMU est construit via un appel √† <code>configure</code> et √† <code>make</code> .  Supposons que vous d√©cidiez d'ajouter quelque chose: un backend TCG, une impl√©mentation de thread, autre chose.  Ne vous pr√©cipitez pas pour vous r√©jouir / √™tre horrifi√© (souligner si n√©cessaire) la perspective de communiquer avec Autoconf - en fait, la <code>configure</code> √† QEMU semble √™tre auto-√©crite et il n'y a rien √† g√©n√©rer. </p><br><h2 id="webassembly">  Webassembly </h2><br><p>  Alors, quelle est cette chose - WebAssembly (aka WASM)?  Il s'agit d'un remplacement pour Asm.js, qui ne pr√©tend plus √™tre un code JavaScript valide.  Au contraire, il est purement binaire et optimis√©, et m√™me simplement y √©crire un entier n'est pas tr√®s simple: il est stock√© au format <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">LEB128</a> pour plus de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">compacit√©</a> . </p><br><p>  Vous avez peut-√™tre entendu parler de l'algorithme de relooping pour Asm.js - restauration des instructions de contr√¥le de flux d'ex√©cution ¬´de haut niveau¬ª (c'est-√†-dire, si-alors-sinon, boucles, etc.) sous lesquelles les moteurs JS sont r√©gl√©s √† partir du LLVM IR de bas niveau, plus proche du code machine ex√©cut√© par le processeur.  Naturellement, la repr√©sentation interm√©diaire de QEMU est plus proche de la seconde.  Il semblerait que le voici, bytecode, la fin du tourment ... Et puis les blocs, if-then-else et les boucles! .. </p><br><p>  Et c'est une autre raison pour laquelle Binaryen est utile: il peut, bien s√ªr, accepter des blocs de haut niveau proches de ce qui sera stock√© dans WASM.  Mais il peut √©galement produire du code √† partir du graphe des blocs de base et des transitions entre eux.  Eh bien, j'ai d√©j√† dit qu'il cache le format de stockage WebAssembly derri√®re l'API C / C ++ pratique. </p><br><h2 id="tcg-tiny-code-generator">  TCG (G√©n√©rateur de code minuscule) </h2><br><p>  TCG <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">√©tait √† l'origine un</a> backend pour le compilateur C. Puis, apparemment, il ne pouvait pas supporter la concurrence de GCC, mais √† la fin il a trouv√© sa place dans QEMU en tant que m√©canisme de g√©n√©ration de code pour la plate-forme h√¥te.  Il y a aussi un backend TCG qui g√©n√®re du bytecode abstrait, qui est imm√©diatement ex√©cut√© par l'interpr√©teur, mais j'ai d√©cid√© de quitter cette fois cette fois.  Cependant, le fait que QEMU ait d√©j√† la possibilit√© d'activer la transition vers la TB g√©n√©r√©e via la fonction <code>tcg_qemu_tb_exec</code> √©t√© tr√®s utile. </p><br><p>  Pour ajouter un nouveau backend TCG √† QEMU, vous devez cr√©er un sous-r√©pertoire <code>tcg/&lt; &gt;</code> (dans ce cas, <code>tcg/binaryen</code> ), et il <code>tcg/binaryen</code> deux fichiers: <code>tcg-target.h</code> et <code>tcg-target.inc.c</code> et tout <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">enregistrer</a> c'est <code>configure</code> .  Vous pouvez y placer d'autres fichiers, mais, comme vous pouvez le deviner d'apr√®s les noms de ces deux, ils seront tous les deux inclus quelque part: l'un en tant que fichier d'en-t√™te normal (il sera inclus dans <code>tcg/tcg.h</code> , et celui-ci sera d√©j√† dans d'autres fichiers dans les r√©pertoires <code>tcg</code> , <code>accel</code> et pas seulement), l'autre uniquement comme extrait de code dans <code>tcg/tcg.c</code> , mais il a acc√®s √† ses fonctions statiques. </p><br><p>  Ayant d√©cid√© que je passerais trop de temps sur les proc√©dures d√©taill√©es, comment cela fonctionne, j'ai simplement copi√© les ¬´squelettes¬ª de ces deux fichiers √† partir d'une autre impl√©mentation backend, en l'indiquant honn√™tement dans l'en-t√™te de la licence. </p><br><p>  Le <code>tcg-target.h</code> contient principalement des param√®tres sous la forme de <code>#define</code> s: </p><br><ul><li>  combien de registres et quelle largeur sont sur l'architecture cible (nous en avons - autant que nous voulons, il y en a tellement - la question est plus que ce que le navigateur va g√©n√©rer dans un code plus efficace sur une architecture "compl√®tement cible" ...) </li><li>  alignement des instructions de l'h√¥te: sur x86, et dans TCI, les instructions ne s'alignent pas du tout, je vais mettre dans le tampon de code pas des instructions du tout, mais des pointeurs sur les structures de la biblioth√®que Binaryen, donc je dirai: 4 octets </li><li>  quelles instructions facultatives le backend peut g√©n√©rer - allumez tout ce que nous trouvons dans Binaryen, laissez l'acc√©l√©rateur diviser le reste en plus simples </li><li>  quelle taille approximative du cache TLB est demand√©e par le backend.  Le fait est que dans QEMU, tout est s√©rieux: bien qu'il existe des fonctions d'assistance qui se chargent / stockent en tenant compte de la MMU invit√©e (et o√π maintenant sans elle?), Ils enregistrent leur cache de traduction sous la forme d'une structure, dont le traitement est pratique √† int√©grer directement aux blocs de traduction.  La question est de savoir quel d√©calage dans cette structure est g√©r√© le plus efficacement par une petite s√©quence de commandes rapide </li><li>  ici, vous pouvez tordre le but d'un ou deux registres r√©serv√©s, activer l'appel de TB via une fonction et √©ventuellement d√©crire quelques petites fonctions en <code>inline</code> comme <code>flush_icache_range</code> (mais ce n'est pas notre cas) </li></ul><br><p>  Le <code>tcg-target.inc.c</code> , bien s√ªr, est g√©n√©ralement beaucoup plus volumineux et contient plusieurs fonctions requises: </p><br><ul><li>  initialisation, indiquant, entre autres, les restrictions quant √† l'instruction avec laquelle les op√©randes peuvent fonctionner.  Insolemment copi√© par moi depuis un autre backend </li><li>  fonction acceptant une instruction de bytecode interne </li><li>  ici vous pouvez mettre des fonctions auxiliaires, et aussi ici vous pouvez utiliser des fonctions statiques de <code>tcg/tcg.c</code> </li></ul><br><p>  Pour ma part, j'ai choisi la strat√©gie suivante: dans les premiers mots du bloc de traduction suivant, j'ai not√© quatre pointeurs: la marque de d√©part (une certaine valeur au voisinage de <code>0xFFFFFFFF</code> , qui a d√©termin√© l'√©tat actuel de TB), le contexte, le module g√©n√©r√© et le nombre magique pour le d√©bogage.  Tout d'abord, le libell√© a √©t√© d√©fini sur <code>0xFFFFFFFF - n</code> , o√π <code>n</code> est un petit nombre positif, et chaque fois via l'interpr√©teur, il a augment√© de 1. Lorsqu'il a atteint <code>0xFFFFFFFE</code> , la compilation s'est produite, le module a √©t√© stock√© dans la table de fonction, import√© dans un petit "lanceur", dans lequel l'ex√©cution a quitt√© <code>tcg_qemu_tb_exec</code> et le module a √©t√© supprim√© de la m√©moire QEMU. </p><br><p>  Pour paraphraser les classiques, "Crutch, combien proger s'est entrelac√© dans ce son pour le coeur ...".  Cependant, la m√©moire fuyait quelque part.  Et c'√©tait une m√©moire g√©r√©e par QEMU!  J'avais un code qui, lors de l'√©criture de l'instruction suivante (enfin, c'est-√†-dire un pointeur), a supprim√© celui dont le lien √©tait √† cet endroit plus t√¥t, mais cela n'a pas aid√©.  En fait, dans le cas le plus simple, QEMU alloue de la m√©moire au d√©marrage et y √©crit le code g√©n√©r√©.  Lorsque le tampon se termine, le code est jet√© et le suivant commence √† √™tre √©crit √† sa place. </p><br><p>  Apr√®s avoir √©tudi√© le code, j'ai r√©alis√© que la b√©quille avec nombre magique nous permettait de ne pas tomber sur la destruction du tas, lib√©rant quelque chose de mal sur le tampon non initialis√© lors du premier passage.  Mais qui √©crase le tampon en contournant ma fonction plus tard?  Comme les d√©veloppeurs d'Emscripten l'ont conseill√©, apr√®s avoir rencontr√© un probl√®me, j'ai port√© le code r√©sultant vers l'application native, d√©fini Mozilla Record-Replay dessus ... En g√©n√©ral, en cons√©quence, j'ai r√©alis√© une chose simple: une <code>struct TranslationBlock</code> avec sa description est allou√©e √† chaque bloc.  Devinez o√π ... C'est vrai, juste en face du bloc juste dans le tampon.  Apr√®s avoir r√©alis√© cela, j'ai d√©cid√© de le lier avec des b√©quilles (au moins certaines), et j'ai simplement jet√© le num√©ro magique et transf√©r√© les mots restants dans la <code>struct TranslationBlock</code> , cr√©ant une liste √† lien unique que vous pouvez parcourir rapidement lors de la r√©initialisation du cache de traduction et lib√©rer de la m√©moire. </p><br><p>  Certaines b√©quilles sont rest√©es: par exemple, des pointeurs marqu√©s dans le tampon de code - certains d'entre eux sont simplement <code>BinaryenExpressionRef</code> , c'est-√†-dire qu'ils examinent les expressions qui doivent √™tre lin√©airement plac√©es dans l'unit√© de base g√©n√©r√©e, partie - la condition de transition entre les WB, partie - o√π aller.  Eh bien, il existe d√©j√† des blocs pr√©par√©s pour Relooper, qui doivent √™tre connect√©s en fonction des conditions.  Pour les distinguer, l'hypoth√®se est utilis√©e qu'ils sont tous align√©s sur au moins quatre octets, de sorte que vous pouvez utiliser en toute s√©curit√© les deux bits inf√©rieurs de l'√©tiquette, il vous suffit de vous rappeler de le supprimer si n√©cessaire.  Soit dit en passant, ces √©tiquettes sont d√©j√† utilis√©es dans QEMU pour indiquer la raison de la sortie du cycle TCG. </p><br><h2 id="ispolzovanie-binaryen">  Utilisation de Binaryen </h2><br><p>  Les modules de WebAssembly contiennent des fonctions, chacune contenant un corps repr√©sentant une expression.  Les expressions sont des op√©rations unaires et binaires, des blocs constitu√©s de listes d'autres expressions, un flux de contr√¥le, etc.  Comme je l'ai d√©j√† dit, le flux de contr√¥le est organis√© pr√©cis√©ment comme des branches de haut niveau, des boucles, des appels de fonction, etc.  Les arguments des fonctions ne sont pas transmis sur la pile, mais explicitement, comme dans JS.  Il y a des variables globales, mais je ne les ai pas utilis√©es, donc je n'en parlerai pas. </p><br><p>  Les fonctions ont √©galement des variables locales, num√©rot√©es √† partir de z√©ro, du type: int32 / int64 / float / double.  Les n premi√®res variables locales sont les arguments pass√©s √† la fonction.  Veuillez noter que bien que tout ici ne soit pas enti√®rement de bas niveau en termes de flux de contr√¥le, les entiers ne portent toujours pas le signe / signe sans signe: le comportement du nombre d√©pend du code d'op√©ration. </p><br><p>  De mani√®re g√©n√©rale, Binaryen fournit une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">API C simple</a> : vous cr√©ez un module, <strong>vous y</strong> cr√©ez des expressions - unaires, binaires, blocs √† partir d'autres expressions, flux de contr√¥le, etc.  Ensuite, vous cr√©ez une fonction, dont le corps dont vous avez besoin pour sp√©cifier une expression.  Si vous, comme moi, avez un graphe de transition de bas niveau, le composant relooper vous aidera.  Pour autant que je comprends, il est possible d'utiliser un contr√¥le de haut niveau du flux d'ex√©cution dans le bloc, tant qu'il ne d√©passe pas les limites du bloc - c'est-√†-dire qu'il est possible de cr√©er une branche de chemin rapide / chemin lent interne √† l'int√©rieur du code de traitement du cache TLB int√©gr√©, mais il n'y a aucun moyen d'interf√©rer avec le flux de contr√¥le ¬´externe¬ª .  Lorsque vous rel√¢chez relooper, ses blocs sont lib√©r√©s, lorsque vous lib√©rez un module, les expressions, fonctions, etc., allou√©es dans son <em>ar√®ne</em> disparaissent. </p><br><p>  Cependant, si vous souhaitez interpr√©ter le code √† la vol√©e sans cr√©ation et suppression inutiles de l'instance d'interpr√©teur, il peut √™tre judicieux de transf√©rer cette logique dans un fichier C ++, et de l√† contr√¥ler directement la biblioth√®que API C ++ enti√®re, en contournant les wrappers finis. </p><br><p>  Ainsi, pour g√©n√©rer le code, vous avez besoin </p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//    (  ) BinaryenSetAPITracing(0); BinaryenSetOptimizeLevel(3); BinaryenSetShrinkLevel(2); //   BinaryenModuleRef MODULE = BinaryenModuleCreate(); //    ( ,   ) helper_type BinaryenAddFunctionType(MODULE, "helper-func", BinaryenTypeInt32(), int32_helper_args, ARRAY_SIZE(int32_helper_args)); // (int23_helper_args ^W ) //  -  // ...     -  :) //    BinaryenAddFunction(MODULE, "tb_fun", tb_func_type, func_locals, FUNC_LOCALS_COUNT, expr); BinaryenAddFunctionExport(MODULE, "tb_fun", "tb_fun"); ... BinaryenSetMemory(MODULE, (1 &lt;&lt; 15) - 1, -1, NULL, NULL, NULL, NULL, NULL, 0, 0); BinaryenAddMemoryImport(MODULE, NULL, "env", "memory", 0); BinaryenAddTableImport(MODULE, NULL, "env", "tb_funcs"); //       assert (BinaryenModuleValidate(MODULE)); BinaryenModuleOptimize(MODULE);</span></span></code> </pre> <br><p> ‚Ä¶    ‚Äî ,     ,   ‚Äî   . </p><br><p>    --,  : </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buf[<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">20</span></span>]; BinaryenModuleOptimize(MODULE); BinaryenSetMemory(MODULE, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">-1</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> sz = BinaryenModuleWrite(MODULE, buf, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(buf)); BinaryenModuleDispose(MODULE); EM_ASM({ var <span class="hljs-keyword"><span class="hljs-keyword">module</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WebAssembly.Module(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Uint8Array(wasmMemory.buffer, $<span class="hljs-number"><span class="hljs-number">0</span></span>, $<span class="hljs-number"><span class="hljs-number">1</span></span>)); var fptr = $<span class="hljs-number"><span class="hljs-number">2</span></span>; var instance = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WebAssembly.Instance(<span class="hljs-keyword"><span class="hljs-keyword">module</span></span>, { <span class="hljs-string"><span class="hljs-string">'env'</span></span>: { <span class="hljs-string"><span class="hljs-string">'memory'</span></span>: wasmMemory, <span class="hljs-comment"><span class="hljs-comment">// ... } ); //       instance! }, buf, sz);</span></span></code> </pre> <br><p>  -     QEMU  JS        ,    (     ),     .    ,         translation block,   ,           <code>struct TranslationBlock</code> . </p><br><p> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a> <em>(    )</em>     Firefox.  Chrome  <em>-  </em>  ,  -       WebAssembly,          ... </p><br><p>     . ,    ,   - .  ,    <em> </em>    . ,      WebAssembly  ,       JS,      ,     ,     . </p><br><p> <strong><strong> :</strong></strong>     32- ,         Binaryen, -     -   2  32-  .   ,     Binaryen       .   ? </p><br><div class="spoiler"> <b class="spoiler_title">-</b> <div class="spoiler_text"><p>      ,     ¬´ ,   32- Linux?¬ª        .    ,   : 1  2 Gb. </p></div></div><br><div class="spoiler"> <b class="spoiler_title">- (  )</b> <div class="spoiler_text"><p>       .    ,    ‚Äî   <strong></strong>   .  ¬´ :    ,     ...¬ª. </p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// 2gbubble.c // Usage: LD_PRELOAD=2gbubble.so &lt;program&gt; #include &lt;sys/mman.h&gt; #include &lt;assert.h&gt; void __attribute__((constructor)) constr(void) { assert(MAP_FAILED != mmap(1u &gt;&gt; 31, (1u &gt;&gt; 31) - (1u &gt;&gt; 20), PROT_NONE, MAP_ANONYMOUS | MAP_PRIVATE, -1, 0)); }</span></span></code> </pre> <br><p> ‚Ä¶  Valgrind-, ,  , ,  , Valgrind       :) </p><br><p> <em>, -   ,     ...</em> </p></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr451306/">https://habr.com/ru/post/fr451306/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr451294/index.html">Comme j'ai ajout√© des fonctions √† la voiture via CAN, je ne pouvais pas programmer</a></li>
<li><a href="../fr451296/index.html">Annonc√© par ML.NET 1.0</a></li>
<li><a href="../fr451298/index.html">Comment faire une console de jeu avec un √©tui en commandant une carte de circuit imprim√©</a></li>
<li><a href="../fr451302/index.html">Les meilleures soci√©t√©s d'externalisation informatique</a></li>
<li><a href="../fr451304/index.html">¬´Astuce¬ª Yandex: comment maximiser les profits sur un abonnement payant</a></li>
<li><a href="../fr451310/index.html">Vous manquez le PDA?</a></li>
<li><a href="../fr451314/index.html">Production de circuits imprim√©s LUT'om de A √† Z</a></li>
<li><a href="../fr451316/index.html">√Ä propos d'une facult√© de physique</a></li>
<li><a href="../fr451318/index.html">Dart 2.3 annonc√©: optimis√© pour le d√©veloppement de l'interface utilisateur</a></li>
<li><a href="../fr451320/index.html">Pourquoi le firmware ouvert est important pour la s√©curit√©</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>