<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👎 💪🏿 🕘 C / C ++ de Python (boost) 🖲️ 📣 🗃️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Le dernier article de la série sur la façon d'invoquer C / C ++ à partir de Python3 est passé par toutes les façons connues de le faire. Cette fois, j...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>C / C ++ de Python (boost)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/471618/"><div style="text-align:center;"><img alt="principal" width="500" src="https://habrastorage.org/webt/nf/o7/xa/nfo7xaba24kf94ay5hsqahnow2y.jpeg"></div><br><p> Le dernier article de la série sur la façon d'invoquer <strong>C / C ++ à</strong> partir de <strong>Python3</strong> est passé par toutes les façons connues de le faire.  Cette fois, j'ai pu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><strong>booster</strong></a> .  Qu'est-ce qui en est ressorti ci-dessous. </p><a name="habracut"></a><br><h2 id="c">  C </h2><br><p>  Je prends le même exemple de bibliothèque de test comme base et en fais une variation pour une méthode spécifique.  Une bibliothèque de tests pour montrer comment travailler avec des variables globales, des structures et des fonctions avec des arguments de différents types. </p><br><p>  test.c: </p><br><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"test.hpp"</span></span></span><span class="hljs-meta"> int a = 5; double b = 5.12345; char c = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'X'</span></span></span><span class="hljs-meta">; int func_ret_int(int val) { printf(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"C get func_ret_int: %d\n"</span></span></span><span class="hljs-meta">, val); return val; } double func_ret_double(double val) { printf(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"C get func_ret_double: %f\n"</span></span></span><span class="hljs-meta">, val); return val; } object func_ret_str(char *val) { printf(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"C get func_ret_str: %s\n"</span></span></span><span class="hljs-meta">, val); return object(string(val)); } char func_many_args(int val1, double val2, char val3, short val4) { printf(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"C get func_many_args: int - %d, double - %f, char - %c, short - %d\n"</span></span></span><span class="hljs-meta">, val1, val2, val3, val4); return val3; } test_st_t * func_ret_struct(test_st_t *test_st) { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (test_st) { printf(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"C get test_st: val1 - %d, val2 - %f, val3 - %c\n"</span></span></span><span class="hljs-meta">, test_st-&gt;val1, test_st-&gt;val2, test_st-&gt;val3); } return test_st; } </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// _test    BOOST_PYTHON_MODULE(_test) { /* *   */ def("func_ret_int", func_ret_int); def("func_ret_double", func_ret_double); def("func_ret_str", &amp;func_ret_str); def("func_many_args", func_many_args); //   // manage_new_object C     // reference_existing_object C     def("func_ret_struct", &amp;func_ret_struct, return_value_policy&lt;reference_existing_object&gt;()); /* *    */ scope().attr("a") = a; scope().attr("b") = b; scope().attr("c") = c; /* *  */ class_&lt;test_st_t&gt;("test_st_t") .def_readwrite("val1", &amp;test_st_t::val1) .def_readwrite("val2", &amp;test_st_t::val2) .def_readwrite("val3", &amp;test_st_t::val3) ; }</span></span></span></span></code> </pre> <br><p>  test.h: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> boost::python; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>; <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> __cplusplus extern </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"C"</span></span></span><span class="hljs-meta"> { #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> typedef struct test_st_s test_st_t; typedef char * char_p; extern int a; extern double b; extern char c; int func_ret_int(int val); double func_ret_double(double val); object func_ret_str(char *val); char func_many_args(int val1, double val2, char val3, short val4); test_st_t *func_ret_struct(test_st_t *test_st); struct test_st_s { int val1; double val2; char val3; }; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> __cplusplus } #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span></span></code> </pre> <br><p>  Comment compiler: </p><br><pre> <code class="plaintext hljs">g++ -g -fPIC -I/usr/include/python3.6 -I./src/c -o ./objs/test.o -c ./src/c/test.cpp g++ -fPIC -g -shared -o ./lib/_test.so ./objs/test.o -lboost_python3</code> </pre> <br><p>  La source se compile dans une bibliothèque dynamique. <br>  <strong>python boost</strong> est similaire à <strong>pybind11</strong> , vous devez également décrire les fonctions que python verra.  Mais à mon avis, le boost est plus volumineux et complexe.  Par exemple: </p><br><pre> <code class="cpp hljs">def(<span class="hljs-string"><span class="hljs-string">"func_ret_struct"</span></span>, &amp;func_ret_struct, return_value_policy&lt;reference_existing_object&gt;());</code> </pre> <br><p>  La fonction <strong>func_ret_struct</strong> prend un pointeur sur une structure comme argument et retourne le même pointeur.  Pour cela, vous devez spécifier les règles de l'objet retourné <strong>return_value_policy &lt;reference_existing_object&gt; ()</strong> .  reference_existing_objec indique que l'objet renvoyé existait déjà.  Si vous spécifiez manage_new_object, cela signifie que nous renvoyons un nouvel objet.  Dans ce cas, un tel script tombera dans une <strong>erreur de segmentation</strong> sur le garbage collector: </p><br><pre> <code class="python hljs">test_st = _test.test_st_t() ret = _test.func_ret_struct(test_st)</code> </pre> <br><p>  Parce que le garbage collector effacera d'abord les données que contient test_st, puis souhaite effacer les données que contient l'objet ret.  Qui contient les mêmes données que contenait test_st, mais elles ont déjà été effacées. </p><br><p>  Il est intéressant de savoir comment dans ce cas décrire une telle fonction (n'est pas allé en profondeur)?: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">test_st_t</span></span> * func_ret_struct(<span class="hljs-keyword"><span class="hljs-keyword">test_st_t</span></span> *test_st) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (test_st) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> test_st; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">test_st_t</span></span> *) <span class="hljs-built_in"><span class="hljs-built_in">malloc</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">test_st_t</span></span>)); } }</code> </pre> <br><p>  Une telle fonction peut renvoyer un objet existant aussi bien qu'un objet existant. </p><br><p>  J'ai également eu un problème avec une telle fonction: </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">char</span></span></span><span class="hljs-function"> * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">func_ret_str</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *val)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> val; }</code> </pre> <br><p>  Si je comprends bien, vous ne pouvez pas obtenir un pointeur vers un type de données standard à partir de python dans boost.  Il n'est possible que sur la <strong>structure</strong> , la <strong>classe</strong> et l' <strong>union</strong> .  Si quelqu'un connaît un moyen d'éclairer. </p><br><h2 id="python">  Python </h2><br><p>  Pour python, le module devient natif. <br>  main.py: </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/python3 #-*- coding: utf-8 -*- import sys import time #    test #sys.path.append('.') sys.path.append('lib/') #   import _test ### ## C ### print("boost\n") print("C\n") start_time = time.time() ## #    ## print('  :') print('ret func_ret_int: ', _test.func_ret_int(101)) print('ret func_ret_double: ', _test.func_ret_double(12.123456789)) print('ret func_ret_str: ', _test.func_ret_str('Hello!')) print('ret func_many_args: ', _test.func_many_args(15, 18.1617, 'X', 32000)) ## #    ## print('\n  :') print('ret a: ', _test.a) #   . _test.a = 22 print('new a: ', _test.a) print('ret b: ', _test.b) print('ret c: ', _test.c) ## #    ## print('\n  :') #      test_st = _test.test_st_t() test_st.val1 = 5 test_st.val2 = 5.1234567 test_st.val3 = 'Z' print('val1 = {}\nval2 = {}\nval3 = {}'.format(test_st.val1, test_st.val2, test_st.val3)) ret = _test.func_ret_struct(test_st) #    C print('ret val1 = {}\nret val2 = {}\nret val3 = {}'.format(ret.val1, ret.val2, ret.val3)) #   print("--- {} seconds ---".format(time.time() - start_time))</span></span></code> </pre><br><h3 id="plyusy-i-minusy-boost">  Avantages et inconvénients du boost </h3><br><p>  <strong>Avantages</strong> : </p><br><ul><li>  syntaxe simple lorsqu'elle est utilisée en Python </li></ul><br><p>  <strong>Inconvénients</strong> : </p><br><ul><li>  vous devez modifier les sources C ++ ou écrire une liaison pour elles </li><li>  booster seul n'est pas facile </li></ul><br><p>  Le code, comme d'habitude, j'essaie de commenter clairement. </p><br><h2 id="srednee-vremya-vypolneniya-testa-na-kazhdom-sposobe-pri-1000-zapuskah">  Le temps d'exécution moyen des tests sur chaque méthode avec 1000 démarrages: </h2><br><ul><li>  ctypes: - 0,0004987692832946777 secondes --- </li><li>  CFFI: - 0,00038521790504455566 secondes --- </li><li>  pybind: - 0,0004547207355499268 secondes --- </li><li>  API C: - 0,0003561973571777344 secondes --- </li><li>  boost: - 0,00037789344787597656 secondes --- </li></ul><br><h2 id="ssylki">  Les références </h2><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Codes source pour des exemples</a> </li><li>  Chemin à travers les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><strong>types</strong></a> </li><li>  Méthode via <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><strong>CFFI, pybind11</strong></a> </li><li>  Méthode via l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><strong>API C</strong></a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Python de C</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr471618/">https://habr.com/ru/post/fr471618/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr471600/index.html">Le nombre sous-jacent à la musique moderne</a></li>
<li><a href="../fr471604/index.html">N'oubliez pas Open Graph</a></li>
<li><a href="../fr471608/index.html">Système d'évitement des collisions: Partie 1. Législation en tant que savoirs traditionnels pour le développeur</a></li>
<li><a href="../fr471610/index.html">Serveur REST sur Prolog, à quoi ça ressemble?</a></li>
<li><a href="../fr471614/index.html">Version Rustup 1.20.0: prise en charge des profils, améliorations des commandes de mise à jour et de documentation</a></li>
<li><a href="../fr471620/index.html">Stratégies de déploiement dans Kubernetes: roulement, recréation, bleu / vert, canari, sombre (test A / B)</a></li>
<li><a href="../fr471622/index.html">Xamarin.Forms - Un exemple simple d'émulation de carte basée sur l'hôte</a></li>
<li><a href="../fr471624/index.html">Donner une présentation avec une conception UI / UX parfaite</a></li>
<li><a href="../fr471626/index.html">L'IA pour les gens: des mots simples sur la technologie</a></li>
<li><a href="../fr471628/index.html">J'ai remanié à lui seul 15 000 lignes héritées. Ce fut les deux pires semaines de ma vie</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>