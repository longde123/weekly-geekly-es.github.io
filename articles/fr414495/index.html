<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§úüèª ü•å üë∞üèº toString: grand et terrible ü§± üíó üîÄ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="La fonction toString en JavaScript est probablement la plus "implicite" discut√©e √† la fois parmi les d√©veloppeurs js eux-m√™mes et parmi les observateu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>toString: grand et terrible</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/414495/"><p><img src="https://habrastorage.org/webt/on/px/4c/onpx4cu-vxqkdask5tvj3so9va4.jpeg" alt="image"></p><br><p>  La fonction <em>toString</em> en <strong>JavaScript est</strong> probablement la plus "implicite" discut√©e √† la fois parmi les d√©veloppeurs js eux-m√™mes et parmi les observateurs externes.  Elle est √† l'origine de nombreuses blagues et m√®mes sur de nombreuses op√©rations arithm√©tiques suspectes, transformations qui entrent dans une stupeur <em>[objet Object]</em> .  Il n'est conc√©d√©, peut-√™tre, que pour surprendre en travaillant avec float64. </p><br><p>  Des cas int√©ressants que j'ai d√ª observer, utiliser ou surmonter, m'ont motiv√© √† √©crire un vrai d√©briefing.  Nous galoperons sur la sp√©cification du langage et utiliserons les exemples pour analyser les fonctionnalit√©s non √©videntes de <em>toString</em> . </p><br><p> Si vous attendez des conseils utiles et suffisants, alors <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ceci</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ceci</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ce</a> mat√©riel vous conviennent mieux.  Si votre curiosit√© l'emporte toujours sur le pragmatisme, alors s'il vous pla√Æt, sous cat. </p><a name="habracut"></a><br><h3 id="vse-chto-nuzhno-znat">  Tout ce que vous devez savoir </h3><br><p>  La fonction <em>toString</em> est une propri√©t√© de l'objet prototype Object, en termes simples sa m√©thode.  Il est utilis√© pour la conversion de cha√Æne d'un objet et doit renvoyer une valeur primitive dans le bon sens.  Les objets prototypes ont √©galement leurs impl√©mentations: <em>Function, Array, String, Boolean, Number, Symbol, Date, RegExp, Error</em> .  Si vous impl√©mentez votre objet prototype (classe), <em>toString</em> sera une bonne forme pour lui. </p><br><p>  <em>JavaScript</em> est un langage avec un syst√®me de type faible: ce qui signifie qu'il nous permet de m√©langer diff√©rents types, d'effectuer implicitement de nombreuses op√©rations.  Dans les conversions, <em>toString</em> est associ√© √† <em>valueOf</em> pour r√©duire l'objet √† la primitive n√©cessaire √† l'op√©ration.  Par exemple, l'op√©rateur d'addition se transforme en concat√©nation s'il y a au moins une ligne parmi les op√©rateurs.  Certaines fonctions standard du langage avant leur travail conduisent √† un argument √† la cha√Æne: <em>parseInt, decodeURI, JSON.parse, btoa</em> et ainsi de suite. </p><br><p>  Beaucoup a √©t√© dit et ridiculis√© sur le casting implicite.  Nous consid√©rerons les impl√©mentations de <em>toString des</em> objets prototypes de langage cl√©. </p><br><h3 id="objectprototypetostring">  Object.prototype.toString </h3><br><p>  Si nous passons √† la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">section</a> correspondante <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">de la</a> sp√©cification, nous constatons que la t√¢che principale de <em>toString</em> par d√©faut est d'obtenir la soi-disant <strong>balise</strong> √† concat√©ner √† la cha√Æne r√©sultante: </p><br><pre><code class="javascript hljs"><span class="hljs-string"><span class="hljs-string">"[object "</span></span> + tag + <span class="hljs-string"><span class="hljs-string">"]"</span></span></code> </pre> <br><p>  Pour ce faire: </p><br><ol><li>  Un appel au symbole <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><em>toStringTag</em></a> interne (ou √† la pseudo-propri√©t√© <em>[[Class]]</em> dans l'ancienne √©dition) se produit: il poss√®de de nombreux objets prototypes int√©gr√©s ( <em>Map, Math, JSON</em> et autres). </li><li>  S'il manque ou non une cha√Æne, il √©num√®re un certain nombre d'autres pseudo-propri√©t√©s et m√©thodes internes qui signalent le type de l'objet: <em>[[Call]]</em> pour <em>Function</em> , <em>[[DateValue]]</em> pour <em>Date,</em> et ainsi de suite. </li><li>  Eh bien, si rien du tout, la <em>balise</em> est <em>"Object"</em> . </li></ol><br><p>  Ceux qui sont concern√©s par la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">r√©flexion</a> noteront imm√©diatement la possibilit√© d'obtenir le type d'un objet avec une op√©ration simple (non recommand√©e par la sp√©cification, mais possible): </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> getObjT = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">obj</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.prototype.toString.call(obj).match(<span class="hljs-regexp"><span class="hljs-regexp">/\[object\s(\w+)]/</span></span>)[<span class="hljs-number"><span class="hljs-number">1</span></span>];</code> </pre> <br><p>  La particularit√© de <em>toString</em> par d√©faut est qu'il fonctionne avec n'importe quelle valeur.  S'il s'agit d'une primitive, elle sera convertie en objet ( <em>nul</em> et <em>non d√©fini</em> sont v√©rifi√©s s√©par√©ment).  Aucune <em>erreur de type</em> : </p><br><pre> <code class="javascript hljs">[<span class="hljs-literal"><span class="hljs-literal">Infinity</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, x =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">*(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{}].map(getObjT); &gt; [<span class="hljs-string"><span class="hljs-string">"Number"</span></span>, <span class="hljs-string"><span class="hljs-string">"Null"</span></span>, <span class="hljs-string"><span class="hljs-string">"Function"</span></span>, <span class="hljs-string"><span class="hljs-string">"Date"</span></span>, <span class="hljs-string"><span class="hljs-string">"GeneratorFunction"</span></span>]</code> </pre> <br><p>  Comment cela peut-il √™tre utile?  Par exemple, lors du d√©veloppement d'outils pour l'analyse de code dynamique.  Gr√¢ce √† un pool impromptu de variables utilis√©es pendant le travail de l'application, vous pouvez collecter des statistiques homog√®nes utiles au moment de l'ex√©cution. </p><br><p>  Cette approche pr√©sente un inconv√©nient majeur: les types d'utilisateurs.  Il n'est pas difficile de deviner que pour leurs instances, nous obtenons simplement <em>"Object"</em> . </p><br><h3 id="kastomnyy-symboltostringtag-i-functionname">  Symbol.toStringTag et Function.name personnalis√©s </h3><br><p>  La POO en JavaScript est bas√©e sur des prototypes, et non sur des classes (comme en Java), et nous n'avons pas de m√©thode <em>getClass ()</em> pr√™te √† l' <em>emploi</em> .  Une d√©finition explicite du caract√®re <em>toStringTag</em> pour un type d'utilisateur aidera √† r√©soudre le probl√®me: </p><br><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Cat</span></span></span><span class="hljs-class"> </span></span>{ get [<span class="hljs-built_in"><span class="hljs-built_in">Symbol</span></span>.toStringTag]() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'Cat'</span></span>; } }</code> </pre> <br><p>  ou en style prototype: </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Dog</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{} Dog.prototype[<span class="hljs-built_in"><span class="hljs-built_in">Symbol</span></span>.toStringTag] = <span class="hljs-string"><span class="hljs-string">'Dog'</span></span>;</code> </pre> <br><p>  Il existe une solution alternative via la propri√©t√© en lecture seule <em>Function.name</em> , qui ne fait pas encore partie de la sp√©cification, mais qui est prise en charge par la plupart des navigateurs.  Chaque instance de l'objet / classe prototype a un lien vers la fonction constructeur avec laquelle il a √©t√© cr√©√©.  On peut donc trouver le nom du type: </p><br><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Cat</span></span></span><span class="hljs-class"> </span></span>{} (<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Cat).constructor.name &lt; <span class="hljs-string"><span class="hljs-string">'Cat'</span></span></code> </pre> <br><p>  ou en style prototype: </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Dog</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{} (<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dog).constructor.name &lt; <span class="hljs-string"><span class="hljs-string">'Dog'</span></span></code> </pre> <br><p>  Bien s√ªr, cette solution ne fonctionne pas pour les objets cr√©√©s √† l'aide d'une fonction anonyme ( <em>"anonyme"</em> ) ou <em>Object.create (null)</em> , ou pour les primitives sans objet wrapper ( <em>null, non d√©fini</em> ). </p><br><p>  Ainsi, pour une manipulation fiable des types de variables, il convient de combiner des techniques bien connues, bas√©es principalement sur la t√¢che √† accomplir.  Dans la grande majorit√© des cas, <em>typeof</em> et <em>instanceof</em> suffisent. </p><br><h3 id="functionprototypetostring">  Function.prototype.toString </h3><br><p>  Nous √©tions un peu distraits, mais en cons√©quence, nous sommes arriv√©s √† des fonctions qui ont leur propre <em>cha√Æne</em> int√©ressante.  Tout d'abord, jetez un ≈ìil au code suivant: </p><br><pre> <code class="javascript hljs">(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'('</span></span> + <span class="hljs-built_in"><span class="hljs-built_in">arguments</span></span>.callee.toString() + <span class="hljs-string"><span class="hljs-string">')()'</span></span>); })()</code> </pre> <br><p>  Beaucoup ont probablement devin√© qu'il s'agissait d'un exemple de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Quine</a> .  Si vous chargez un script avec un tel contenu dans le corps de la page, une copie exacte du code source sera affich√©e dans la console.  Cela est d√ª √† l'appel √† <em>Strings</em> depuis la fonction <em>arguments.callee</em> . </p><br><p>  L' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">impl√©mentation</a> utilis√©e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">de l'</a> objet prototype <em>toString de la</em> <em>fonction</em> renvoie une repr√©sentation sous forme de cha√Æne du code source de la fonction, en conservant la syntaxe utilis√©e dans sa d√©finition: <em>FunctionDeclaration, FunctionExpression, ClassDeclaration, ArrowFunction</em> , etc. </p><br><p>  Par exemple, nous avons une fonction de fl√®che: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> bind = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">f, ctx</span></span></span><span class="hljs-function">) =&gt;</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> f.apply(ctx, <span class="hljs-built_in"><span class="hljs-built_in">arguments</span></span>); }</code> </pre> <br><p>  L'appel de <em>bind.toString ()</em> nous renverra une repr√©sentation sous forme de cha√Æne de <em>ArrowFunction</em> : </p><br><pre> <code class="javascript hljs"><span class="hljs-string"><span class="hljs-string">"(f, ctx) =&gt; function() { return f.apply(ctx, arguments); }"</span></span></code> </pre> <br><p>  Et appeler <em>toString √†</em> partir d'une fonction encapsul√©e est d√©j√† une repr√©sentation sous forme de cha√Æne de <em>FunctionExpression</em> : </p><br><pre> <code class="javascript hljs"><span class="hljs-string"><span class="hljs-string">"function() { return f.apply(ctx, arguments); }"</span></span></code> </pre> <br><p>  Cet exemple de <em>liaison</em> n'est pas accidentel, car nous avons une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">solution pr√™te √† l'emploi</a> avec la liaison de contexte <em>Function.prototype.bind</em> , et en ce qui concerne les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">fonctions li√©es</a> natives <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">,</a> il existe une fonctionnalit√© de <em>Function.prototype.toString qui</em> fonctionne avec elles.  Selon l'impl√©mentation, une repr√©sentation de la fonction encapsul√©e elle-m√™me et de la fonction <em>cible</em> peut √™tre obtenue.  V8 et SpiderMonkey derni√®res versions de chrome et ff: </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getx</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.x; } getx.bind({ <span class="hljs-attr"><span class="hljs-attr">x</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span> }).toString() &lt; <span class="hljs-string"><span class="hljs-string">"function () { [native code] }"</span></span></code> </pre> <br><p>  Par cons√©quent, la prudence doit √™tre exerc√©e avec les √©l√©ments d√©cor√©s de mani√®re native. </p><br><h3 id="praktika-ispolzovaniya-ftostring">  Entra√Ænez-vous √† utiliser f.toString </h3><br><p>  Il existe de nombreuses options pour utiliser la <em>cha√Æne toString en</em> question, mais elle n'est urgente qu'en tant qu'outil de m√©taprogrammation ou de d√©bogage.  Avoir une application typique similaire dans la logique m√©tier conduira t√¥t ou tard √† un creux cass√© non pris en charge. </p><br><p>  La chose la plus simple qui me vient √† l'esprit est de <strong>d√©terminer la dur√©e de la fonction</strong> : </p><br><pre> <code class="javascript hljs">f.toString().replace(<span class="hljs-regexp"><span class="hljs-regexp">/\s+/g</span></span>, <span class="hljs-string"><span class="hljs-string">' '</span></span>).length</code> </pre> <br><p>  L'emplacement et le nombre de caract√®res d' <em>espacement du</em> r√©sultat <em>toString</em> sont donn√©s par la sp√©cification √† l'achat d'une impl√©mentation sp√©cifique, par cons√©quent, pour la propret√©, nous supprimons d'abord l'exc√©dent, ce qui conduit √† une vue g√©n√©rale.  Soit dit en passant, dans les anciennes versions du moteur Gecko, la fonction avait un param√®tre d' <em>indentation</em> sp√©cial qui aide au formatage des retraits. </p><br><p>  La <strong>d√©finition des noms de param√®tres de fonction</strong> vient imm√©diatement √† l'esprit, ce qui peut √™tre utile pour la r√©flexion: </p><br><pre> <code class="javascript hljs">f.toString().match(<span class="hljs-regexp"><span class="hljs-regexp">/^function(?:\s+\w+)?\s*\(([^\)]+)/m</span></span>)[<span class="hljs-number"><span class="hljs-number">1</span></span>].split(<span class="hljs-regexp"><span class="hljs-regexp">/\s*,\s*/</span></span>)</code> </pre> <br><p>  Cette solution de genou convient √† la syntaxe <em>FunctionDeclaration</em> et <em>FunctionExpression</em> .  Si vous en avez besoin d'un plus d√©taill√© et pr√©cis, je vous recommande de rechercher des exemples du code source de votre framework pr√©f√©r√©, qui a probablement une sorte d'injection de d√©pendance sous le capot, bas√© sur les noms des param√®tres d√©clar√©s. </p><br><p>  Une option dangereuse et int√©ressante pour <strong>remplacer une fonction</strong> via <em>eval</em> : </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> sum = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">a, b</span></span></span><span class="hljs-function">) =&gt;</span></span> a + b; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> prod = <span class="hljs-built_in"><span class="hljs-built_in">eval</span></span>(sum.toString().replace(<span class="hljs-regexp"><span class="hljs-regexp">/\+(?=\s*(?:a|b))/gm</span></span>, <span class="hljs-string"><span class="hljs-string">'*'</span></span>)); sum(<span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>) &lt; <span class="hljs-number"><span class="hljs-number">15</span></span> prod(<span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>) &lt; <span class="hljs-number"><span class="hljs-number">50</span></span></code> </pre> <br><p>  Connaissant la structure de la fonction d'origine, nous en avons cr√©√© une nouvelle en rempla√ßant l'op√©rateur d'addition utilis√© dans son corps par des arguments avec multiplication.  Dans le cas du code g√©n√©r√© par logiciel ou de l'absence d'une interface d'extension de fonction, cela peut √™tre magiquement utile.  Par exemple, si vous recherchez un mod√®le math√©matique, s√©lectionnez une fonction appropri√©e, jouez avec les op√©rateurs et les coefficients. </p><br><p>  Une utilisation plus pratique est la <strong>compilation et la distribution de mod√®les</strong> .  De nombreuses impl√©mentations de moteur de mod√®le compilent le code source d'un mod√®le et fournissent une fonction de donn√©es qui forme d√©j√† le code HTML final (ou autre).  Voici un exemple de la fonction <a href="">_.template</a> : </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> helloJst = <span class="hljs-string"><span class="hljs-string">"Hello, &lt;%= user %&gt;"</span></span> _.template(helloJst)({ <span class="hljs-attr"><span class="hljs-attr">user</span></span>: <span class="hljs-string"><span class="hljs-string">'admin'</span></span> }) &lt; <span class="hljs-string"><span class="hljs-string">"Hello, admin"</span></span></code> </pre> <br><p>  Mais que se passe-t-il si la compilation du mod√®le n√©cessite des ressources mat√©rielles ou si le client est tr√®s l√©ger?  Dans ce cas, nous pouvons compiler le mod√®le c√¥t√© serveur et donner aux clients non pas le texte du mod√®le, mais une repr√©sentation sous forme de cha√Æne de la fonction termin√©e.  De plus, vous n'avez pas besoin de charger la biblioth√®que de mod√®les sur le client. </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> helloStr = _.template(helloJst).toString() helloStr &lt; <span class="hljs-string"><span class="hljs-string">"function(obj) { obj || (obj = {}); var __t, __p = ''; with (obj) { __p += 'Hello, ' + ((__t = ( user )) == null ? '' : __t); } return __p }"</span></span></code> </pre> <br><p>  Maintenant, nous devons ex√©cuter ce code sur le client avant utilisation.  Qu'√† la compilation, il n'y avait pas de <em>SyntaxError √†</em> cause de la syntaxe <em>FunctionExpression</em> : </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> helloFn = <span class="hljs-built_in"><span class="hljs-built_in">eval</span></span>(helloStr.replace(<span class="hljs-regexp"><span class="hljs-regexp">/^function\(obj\)/</span></span>, <span class="hljs-string"><span class="hljs-string">'obj=&gt;'</span></span>));</code> </pre> <br><p>  ou alors: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> helloFn = <span class="hljs-built_in"><span class="hljs-built_in">eval</span></span>(<span class="hljs-string"><span class="hljs-string">`const f = </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${helloStr}</span></span></span><span class="hljs-string">;f`</span></span>);</code> </pre> <br><p>  Ou comme vous le souhaitez.  En tout cas: </p><br><pre> <code class="javascript hljs">helloFn({ <span class="hljs-attr"><span class="hljs-attr">user</span></span>: <span class="hljs-string"><span class="hljs-string">'admin'</span></span> }) &lt; <span class="hljs-string"><span class="hljs-string">"Hello, admin"</span></span></code> </pre> <br><p>  Ce n'est peut-√™tre pas la meilleure pratique pour compiler des mod√®les c√¥t√© serveur et les distribuer davantage aux clients.  Juste un exemple utilisant un tas de <em>Function.prototype.toString</em> et <em>eval</em> . </p><br><p>  Enfin, l'ancienne t√¢che de <strong>d√©finition d'un nom de fonction</strong> (avant l'apparition de la propri√©t√© <em>Function.name</em> ) via <em>toString</em> : </p><br><pre> <code class="javascript hljs">f.toString().match(<span class="hljs-regexp"><span class="hljs-regexp">/function\s+(\w+)(?=\s*\()/m</span></span>)[<span class="hljs-number"><span class="hljs-number">1</span></span>]</code> </pre> <br><p>  Bien s√ªr, cela fonctionne bien avec la syntaxe <em>FunctionDeclaration</em> .  Une solution plus intelligente n√©cessitera une expression r√©guli√®re ou une correspondance de mod√®le astucieuse. </p><br><p>  Internet regorge de solutions int√©ressantes bas√©es sur <em>Function.prototype.toString</em> , il suffit de demander.  Partagez votre exp√©rience dans les commentaires: tr√®s int√©ressant. </p><br><h3 id="arrayprototypetostring">  Array.prototype.toString </h3><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">L'impl√©mentation de la</a> <em>toString d'</em> un objet prototype <em>Array</em> est g√©n√©rique et peut √™tre appel√©e pour n'importe quel objet.  Si l'objet a une m√©thode de <em>jointure</em> , le r√©sultat de <em>toString</em> sera son appel, sinon <em>Object.prototype.toString</em> . </p><br><p>  <em>Array</em> , logiquement, a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">une m√©thode de jointure</a> qui concat√®ne la repr√©sentation sous forme de cha√Æne de tous ses √©l√©ments via le <em>s√©parateur</em> pass√© en param√®tre (la valeur par d√©faut est une virgule). </p><br><p>  Supposons que nous ayons besoin d'√©crire une fonction qui s√©rialise une liste de ses arguments.  Si tous les param√®tres sont des primitives, dans de nombreux cas, nous pouvons nous passer de <em>JSON.stringify</em> : </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">seria</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Array</span></span>.from(<span class="hljs-built_in"><span class="hljs-built_in">arguments</span></span>).toString(); }</code> </pre> <br><p>  ou alors: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> seria = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">...a</span></span></span><span class="hljs-function">) =&gt;</span></span> a.toString();</code> </pre> <br><p>  N'oubliez pas que la cha√Æne ¬´10¬ª et le num√©ro 10 seront s√©rialis√©s de la m√™me mani√®re.  Dans le probl√®me du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">m√©moizer</a> le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">plus court</a> √† un moment donn√©, cette solution a √©t√© utilis√©e. </p><br><p>  La jointure native des √©l√©ments du tableau fonctionne √† travers un cycle arithm√©tique de 0 √† la <em>longueur</em> et ne filtre pas les √©l√©ments manquants ( <em>null</em> et <em>ind√©fini</em> ).  Au lieu de cela, la concat√©nation se produit avec le <em>s√©parateur</em> .  Cela conduit √† ce qui suit: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ar = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Array</span></span>(<span class="hljs-number"><span class="hljs-number">1000</span></span>); ar.toString() &lt; <span class="hljs-string"><span class="hljs-string">",,,...,,,"</span></span> <span class="hljs-comment"><span class="hljs-comment">// 1000 times</span></span></code> </pre> <br><p>  Par cons√©quent, si pour une raison ou une autre vous ajoutez un √©l√©ment avec un grand index au tableau (par exemple, c'est un identifiant naturel g√©n√©r√©), en aucun cas ne vous joignez et, par cons√©quent, ne conduisez pas √† une cha√Æne sans pr√©paration pr√©alable.  Sinon, il peut y avoir des cons√©quences: <em>longueur de cha√Æne non valide, m√©moire</em> insuffisante ou simplement un script pendant.  Utilisez les fonctions des <em>valeurs</em> et des <em>cl√©s</em> de l'objet pour parcourir uniquement ses propres propri√©t√©s √©num√©r√©es de l'objet: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> k = []; k[<span class="hljs-number"><span class="hljs-number">2</span></span>**<span class="hljs-number"><span class="hljs-number">10</span></span>] = <span class="hljs-number"><span class="hljs-number">1</span></span>; k[<span class="hljs-number"><span class="hljs-number">2</span></span>**<span class="hljs-number"><span class="hljs-number">20</span></span>] = <span class="hljs-number"><span class="hljs-number">2</span></span>; k[<span class="hljs-number"><span class="hljs-number">2</span></span>**<span class="hljs-number"><span class="hljs-number">30</span></span>] = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.values(k).toString() &lt; <span class="hljs-string"><span class="hljs-string">"1,2,3"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.keys(k).toString() &lt; <span class="hljs-string"><span class="hljs-string">"1024,1048576,1073741824"</span></span></code> </pre> <br><p>  Mais il vaut mieux √©viter une telle manipulation du tableau: tr√®s probablement un simple objet cl√©-valeur vous conviendrait comme stockage. </p><br><p>  Soit dit en passant, le m√™me danger existe lors de la s√©rialisation via <em>JSON.stringify</em> .  Plus grave encore, car les √©l√©ments vides et non pris en charge sont d√©j√† repr√©sent√©s comme <em>"null"</em> : </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ar = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Array</span></span>(<span class="hljs-number"><span class="hljs-number">1000</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify(ar); <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt; "[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">null</span></span></span></span><span class="xml"><span class="hljs-tag">,</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">null</span></span></span></span><span class="xml"><span class="hljs-tag">,</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">null</span></span></span></span><span class="xml"><span class="hljs-tag">,</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">...</span></span></span></span><span class="xml"><span class="hljs-tag">,</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">null</span></span></span></span><span class="xml"><span class="hljs-tag">,</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">null</span></span></span></span><span class="xml"><span class="hljs-tag">,</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">null</span></span></span></span><span class="xml"><span class="hljs-tag">]" // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1000</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">times</span></span></span></span></span></span></code> </pre> <br><p>  Pour conclure la section, je voudrais vous rappeler que vous pouvez d√©finir votre m√©thode de <em>jointure</em> pour le type d'utilisateur et appeler <em>Array.prototype.toString.call en</em> tant que distribution alternative √† la cha√Æne, mais je doute qu'elle ait une utilit√© pratique. </p><br><h3 id="numberprototypetostring-i-parseint">  Number.prototype.toString et parseInt </h3><br><p>  L'une de mes t√¢ches pr√©f√©r√©es pour les questionnaires js est Qu'est-ce qui retournera le prochain appel <em>parseInt</em> ? </p><br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">parseInt</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>**<span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>)</code> </pre> <br><p>  La premi√®re chose <em>que</em> fait <em>parseInt</em> est de lancer implicitement un argument dans une cha√Æne en appelant la fonction abstraite <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><em>ToString</em></a> , qui, selon le type d'argument, ex√©cute la branche de distribution souhait√©e.  Pour le <em>num√©ro de</em> type, les op√©rations suivantes sont effectu√©es: </p><br><ol><li>  Si la valeur est <em>NaN, 0</em> ou <em>Infinity</em> , renvoyez la cha√Æne correspondante. </li><li>  Sinon, l'algorithme renvoie l'enregistrement du nombre le plus pratique pour l'homme: sous forme d√©cimale ou exponentielle. </li></ol><br><p>  Je ne dupliquerai pas l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">algorithme pour</a> d√©terminer la forme pr√©f√©r√©e ici, je noterai seulement ce qui suit: si le nombre de chiffres dans une notation d√©cimale d√©passe <strong>21</strong> , alors une forme exponentielle sera s√©lectionn√©e.  Et cela signifie que dans notre cas, <em>parseInt</em> ne fonctionne pas avec "100 ... 000" mais avec "1e30".  Par cons√©quent, la r√©ponse n'est pas du tout attendue 2 ^ 30.  Qui conna√Æt la nature de ce num√©ro magique 21 - √©crivez! </p><br><p>  Ensuite, <em>parseInt</em> examine la base du syst√®me de nombre de <em>radix</em> utilis√© (par d√©faut 10, nous en avons 2) et v√©rifie la compatibilit√© des caract√®res de la cha√Æne re√ßue.  Apr√®s avoir rencontr√© 'e', ‚Äã‚Äãil coupe toute la queue, ne laissant que "1".  Le r√©sultat sera un entier obtenu en convertissant du syst√®me avec la base radix en d√©cimal - dans notre cas, c'est 1. </p><br><p>  Proc√©dure inverse: </p><br><pre> <code class="javascript hljs">(<span class="hljs-number"><span class="hljs-number">2</span></span>**<span class="hljs-number"><span class="hljs-number">30</span></span>).toString(<span class="hljs-number"><span class="hljs-number">2</span></span>)</code> </pre> <br><p>  C'est l√† que la fonction <em>toString</em> est appel√©e √† partir de l'objet prototype <em>Number</em> , qui utilise le m√™me algorithme pour transtyper <em>nombre</em> en cha√Æne.  Il a √©galement le param√®tre optionnel <em>radix</em> .  Seulement, elle renvoie une <em>RangeError</em> pour une valeur non valide (ce doit √™tre un entier de 2 √† 36 inclus), tandis que <em>parseInt</em> renvoie <em>NaN</em> . </p><br><p>  Il convient de se rappeler la limite sup√©rieure du syst√®me num√©rique si vous pr√©voyez d'impl√©menter une fonction de hachage exotique: cette <em>cha√Æne toString</em> peut ne pas fonctionner pour vous. </p><br><p>  La t√¢che de distraire un instant: </p><br><pre> <code class="javascript hljs"><span class="hljs-string"><span class="hljs-string">'3113'</span></span>.split(<span class="hljs-string"><span class="hljs-string">''</span></span>).map(<span class="hljs-built_in"><span class="hljs-built_in">parseInt</span></span>)</code> </pre> <br><p>  Qu'est-ce qui reviendra et comment y rem√©dier? </p><br><h3 id="obdelennoe-vnimaniem">  Priv√© d'attention </h3><br><p>  Nous n'avons examin√© <em>toString</em> en aucun cas m√™me tous les objets prototypes natifs.  En partie, parce que personnellement je n'ai pas eu de probl√®me avec eux, et ils n'ont pas grand chose d'int√©ressant.  De plus, nous n'avons pas touch√© la fonction <em>toLocaleString</em> , car ce serait bien d'en parler s√©par√©ment.  Si j'ai fait quelque chose en vain priv√© d'attention, perdu de vue ou mal compris - assurez-vous d'√©crire! </p><br><h3 id="prizyv-k-bezdeystviyu">  Appel √† l'inaction </h3><br><p>  Les exemples que j'ai cit√©s ne sont en aucun cas des recettes toutes faites - seulement de la mati√®re √† r√©flexion.  De plus, je trouve inutile et un peu stupide de discuter de cela lors des entretiens techniques: pour cela, il y a des sujets √©ternels sur les fermetures, la jointure, une boucle d'√©v√©nement, les mod√®les de module / fa√ßade / m√©diateur et des questions ¬´bien s√ªr¬ª sur [le cadre utilis√©]. </p><br><p>  Cet article s'est av√©r√© √™tre un m√©li-m√©lo, et j'esp√®re que vous avez trouv√© quelque chose d'int√©ressant pour vous-m√™me.  PS Le langage JavaScript - incroyable! </p><br><h3 id="bonus">  Bonus </h3><br><p>  Pour pr√©parer ce document en vue de sa publication, j'ai utilis√© Google Translate.  Et tout √† fait par accident, j'ai d√©couvert un effet divertissant.  Si vous s√©lectionnez une traduction du russe vers l'anglais, entrez "toString" et commencez √† l'effacer √† l'aide de la touche Retour arri√®re, nous observerons alors: </p><br><p><img src="https://habrastorage.org/webt/op/yl/g3/opylg3burl5dlqv5ojibfeis0c4.gif" alt="bonus"></p><br><p>  Quelle ironie!  Je pense que je suis loin du premier, mais juste au cas o√π je leur enverrais une capture d'√©cran avec un script de lecture.  Il ressemble √† un auto-XSS inoffensif, c'est pourquoi je le partage. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr414495/">https://habr.com/ru/post/fr414495/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr414483/index.html">Tapez Safe SQL sur Kotlin</a></li>
<li><a href="../fr414485/index.html">GNMT, √©chec √©pique ou subtilit√©s de la traduction automatique</a></li>
<li><a href="../fr414487/index.html">Un rare repr√©sentant du type force brute: l'histoire d'une attaque</a></li>
<li><a href="../fr414489/index.html">Les √âtats-Unis envisagent de s'attaquer s√©rieusement √† la question des d√©bris spatiaux</a></li>
<li><a href="../fr414493/index.html">Comment r√©diger un contrat intelligent pour ICO en 5 minutes</a></li>
<li><a href="../fr414497/index.html">API Consulo UI de l'id√©e au prototype</a></li>
<li><a href="../fr414499/index.html">Rapport du Club de Rome 2018, chapitre 1.1.3: ¬´Un monde vide contre une paix totale¬ª</a></li>
<li><a href="../fr414501/index.html">Rapport 2018 du Club de Rome, chapitre 3.11: ¬´R√©formes du secteur financier¬ª</a></li>
<li><a href="../fr414503/index.html">Intel NUC Hades Canyon avec AMD Vega Graphics - VR ou pas VR?</a></li>
<li><a href="../fr414505/index.html">Cours MIT "S√©curit√© des syst√®mes informatiques". Conf√©rence 2: ¬´Contr√¥le des attaques de pirates¬ª, partie 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>