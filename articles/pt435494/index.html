<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßìüèº üë¥üèΩ üòª Servidor de cliente sem costura üëª ü§öüèª üë®üèª‚Äçüç≥</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Qualquer projeto cliente-servidor implica uma separa√ß√£o clara da base de c√≥digo em 2 partes (√†s vezes mais) - cliente e servidor. Freq√ºentemente, cada...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Servidor de cliente sem costura</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/435494/"><img src="https://habrastorage.org/webt/rq/-9/mh/rq-9mhais2g6p5dd5tsfv8rllak.jpeg" align="left">  Qualquer projeto cliente-servidor implica uma separa√ß√£o clara da base de c√≥digo em 2 partes (√†s vezes mais) - cliente e servidor.  Freq√ºentemente, cada uma dessas partes √© executada na forma de um projeto independente separado, suportado por sua pr√≥pria equipe de desenvolvedores. <br><br>  Neste artigo, proponho uma vis√£o cr√≠tica da divis√£o r√≠gida padr√£o do c√≥digo em um back-end e um front-end.  E considere uma alternativa em que o c√≥digo n√£o tenha uma linha clara entre o cliente e o servidor. <br><br><a name="habracut"></a><br><br><h3>  Contras da abordagem padr√£o </h3><br>  A principal desvantagem da separa√ß√£o padr√£o do projeto em duas partes √© a eros√£o da l√≥gica de neg√≥cios entre o cliente e o servidor.  Editamos os dados no formul√°rio no navegador, verificamos no c√≥digo do cliente e enviamos para a vila do av√¥ (para o servidor).  O servidor j√° √© outro projeto.  L√°, voc√™ tamb√©m precisa verificar a corre√ß√£o dos dados recebidos (ou seja, duplicar a funcionalidade do cliente), fazer algumas manipula√ß√µes adicionais (salvar no banco de dados, enviar e-mail etc.). <br><br>  Assim, para rastrear todo o caminho das informa√ß√µes, desde o formul√°rio no navegador at√© o banco de dados no servidor, precisamos nos aprofundar em dois sistemas diversos.  Se as fun√ß√µes s√£o divididas em uma equipe e diferentes especialistas s√£o respons√°veis ‚Äã‚Äãpelo back-end e front-end, surgem problemas organizacionais adicionais relacionados √† sua sincroniza√ß√£o. <br><br><h3>  Vamos sonhar </h3><br>  Suponha que possamos descrever todo o caminho de dados do formul√°rio no cliente para o banco de dados no servidor em um modelo.  No c√≥digo, pode ser algo como isto (o c√≥digo n√£o est√° funcionando): <br><br><pre><code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyDataModel</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//         verifyData(data) { //   .... return true; } //       client saveData(data) { if(this.verifyData(data)) this.writeDataToDb(data) else consol.log('error') } //  .     server writeDataToDb(data) { if(this.verifyData(data)) this.db.insert(data) else consol.log('error') } }</span></span></code> </pre> <br>  Assim, toda a l√≥gica de neg√≥cios do modelo est√° diante de nossos olhos.  Manter esse c√≥digo √© mais f√°cil.  Aqui est√£o as vantagens que a combina√ß√£o de m√©todos cliente-servidor em um modelo pode trazer: <br><br><ol><li>  A l√≥gica de neg√≥cios est√° concentrada em um √∫nico local, n√£o h√° necessidade de compartilh√°-la entre o cliente e o servidor. </li><li>  Voc√™ pode transferir facilmente a funcionalidade de servidor para cliente ou de cliente para servidor durante o desenvolvimento do projeto. </li><li>  N√£o h√° necessidade de duplicar os mesmos m√©todos para o back-end e o front-end. </li><li>  Um √∫nico conjunto de testes para toda a l√≥gica comercial do projeto. </li><li>  Substitui√ß√£o de linhas horizontais de delimita√ß√£o de responsabilidade no projeto por linhas verticais. </li></ol><br>  Vou revelar o √∫ltimo ponto em mais detalhes.  Imagine um aplicativo cliente-servidor comum na forma de um esquema desse tipo: <br><br><img src="https://habrastorage.org/webt/8x/c9/de/8xc9degimzw-w-ln5w2ihiybi6w.jpeg" width="400"><br><br>  Vasya √© respons√°vel pelo frontend, Fedya - pelo backend.  A linha de delineamento de responsabilidade √© executada horizontalmente.  Esse esquema tem as desvantagens de qualquer estrutura vertical - √© dif√≠cil de dimensionar e tem baixa toler√¢ncia a falhas.  Se o projeto estiver em expans√£o, voc√™ ter√° que fazer uma escolha bastante dif√≠cil: quem fortalecer Vasya ou Fedya?  Ou, se Fedya ficar doente ou desistir, Vasya n√£o poder√° substitu√≠-lo. <br><br>  A abordagem proposta aqui permite expandir a linha de divis√£o de responsabilidade em 90 graus e transformar a arquitetura vertical em horizontal. <br><br><img src="https://habrastorage.org/webt/v6/4m/9f/v64m9fuv5sonujosvh4yc4v8vbw.jpeg" width="400"><br><br>  Essa arquitetura √© muito mais f√°cil de dimensionar e mais tolerante a falhas.  Vasya e Fedya tornam-se intercambi√°veis. <br><br>  Em teoria, parece bom, vamos tentar implementar tudo isso na pr√°tica, sem perder tudo o que nos d√° a exist√™ncia separada do cliente e do servidor ao longo do caminho. <br><br><h3>  Declara√ß√£o do problema </h3><br>  N√£o precisamos absolutamente de um servidor cliente integrado no produto.  Pelo contr√°rio, essa decis√£o seria extremamente prejudicial de todos os pontos de vista.  A tarefa √© que, no processo de desenvolvimento, ter√≠amos uma √∫nica base de c√≥digo para modelos de dados para o back-end e o front-end, mas a sa√≠da seria um cliente e servidor independentes.  Nesse caso, obteremos todas as vantagens da abordagem padr√£o e obteremos as comodidades listadas acima para o desenvolvimento e suporte do projeto. <br><br><h3>  Solu√ß√£o </h3><br>  Estou experimentando a integra√ß√£o de cliente e servidor em um arquivo h√° algum tempo.  At√© recentemente, o principal problema era que, no JS padr√£o, a conex√£o de m√≥dulos de terceiros no cliente e no servidor era muito diferente: exigem (...) no node.js, toda a m√°gica do AJAX no cliente.  Tudo mudou com o advento dos m√≥dulos ES.  Nos navegadores modernos, a "importa√ß√£o" √© suportada h√° muito tempo.  O Node.js est√° um pouco atrasado nesse aspecto e os m√≥dulos ES s√£o suportados apenas com o sinalizador "--experimental-modules" ativado.  Espera-se que, no futuro previs√≠vel, os m√≥dulos funcionem imediatamente no node.js.  Al√©m disso, √© improv√°vel que algo mude muito, porque  nos navegadores, essa funcionalidade funciona por padr√£o h√° muito tempo.  Eu acho que agora voc√™ pode usar os m√≥dulos ES, n√£o apenas no cliente, mas tamb√©m no lado do servidor (se voc√™ tiver contra-argumentos sobre esse assunto, escreva nos coment√°rios). <br><br>  O esquema da solu√ß√£o √© assim: <br><br><img src="https://habrastorage.org/webt/xo/_a/vi/xo_avikvz1udp9-dwhxfe6ypt-q.png" width="600"><br><br>  O projeto cont√©m tr√™s cat√°logos principais: <br><br>  <b>protegido</b> - back-end; <br>  <b>p√∫blico</b> - frontend; <br>  <b>shared</b> - modelos cliente-servidor compartilhados. <br><br>  Um processo de observador separado monitora arquivos no diret√≥rio compartilhado e, com quaisquer altera√ß√µes, cria vers√µes do arquivo alterado separadamente para o cliente e separadamente para o servidor (nos diret√≥rios protegidos / compartilhados e p√∫blicos / compartilhados). <br><br><h3>  Implementa√ß√£o </h3><br>  Considere o exemplo de um simples messenger em tempo real.  Vamos precisar do node.js fresco (eu tenho a vers√£o 11.0.0) e do Redis (instal√°-los n√£o √© coberto aqui). <br><br>  Clone um exemplo: <br><br><pre> <code class="bash hljs">git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/Kolbaskin/both-example <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ./both-example npm i</code> </pre><br>  Instale e execute o processo do observador (observador no diagrama): <br><br><pre> <code class="bash hljs">npm i both-js -g both ./index.mjs</code> </pre><br>  Se tudo estiver em ordem, o observador iniciar√° o servidor da web e come√ßar√° a monitorar as altera√ß√µes nos arquivos nos diret√≥rios compartilhados e protegidos.  Quando s√£o feitas altera√ß√µes no compartilhamento, s√£o criadas as vers√µes correspondentes dos modelos de dados para o cliente e o servidor.  Ap√≥s altera√ß√µes em protegido, o inspetor reiniciar√° automaticamente o servidor da web. <br><br>  Voc√™ pode ver o desempenho do messenger no navegador clicando no link <br><br> <code>http://localhost:3000/index.html?token=123&amp;user=Vasya</code> <br> <br>  (token e usu√°rio s√£o arbitr√°rios).  Para emular v√°rios usu√°rios, abra a mesma p√°gina em outro navegador, especificando token e usu√°rio diferentes. <br><br>  Agora um pequeno c√≥digo. <br><br><h4>  Servidor Web </h4><br>  protected / server.mjs <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> express <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'express'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> bodyParser <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'body-parser'</span></span>; <span class="hljs-comment"><span class="hljs-comment">// -     //  -  import wsServer from './lib/wsServer.mjs'; const app = express(); //   - wsServer(app); //  mime  mjs express.static.mime.define({'application/javascript': ['js','mjs']}); app.use( bodyParser.json() ); app.use(bodyParser.urlencoded({ extended: true })); //      public app.use(express.static('public')); const server = app.listen(3000, () =&gt; { console.log('server is running at %s', server.address().port); });</span></span></code> </pre><br>  Este √© um servidor expresso regular, n√£o h√° nada de interessante aqui.  A extens√£o mjs √© necess√°ria para os m√≥dulos ES no node.js.  Para maior consist√™ncia, usaremos essa extens√£o para o cliente. <br><br><h4>  Cliente </h4><br>  public / index.html <br><br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;!DOCTYPE html&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">lang</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"en"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://cdn.jsdelivr.net/npm/vue/dist/vue.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/main.mjs"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"module"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"users"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">v-for</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"user in users"</span></span></span><span class="hljs-tag">&gt;</span></span> {{ user.name }} ({{user.id}}) <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"messages"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">v-model</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"msg"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">v-on:click</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"sendMessage()"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">v-for</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"message in messages"</span></span></span><span class="hljs-tag">&gt;</span></span>[{{ message.date }}] <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">strong</span></span></span><span class="hljs-tag">&gt;</span></span>{{ message.text }}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">strong</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Por exemplo, eu uso o Vue no cliente, mas isso n√£o muda a ess√™ncia.  Em vez do Vue, pode haver qualquer coisa em que voc√™ possa separar o modelo de dados em uma classe separada (nocaute, angular). <br><br>  public / main.mjs <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//      - import ws from "/lib/Ws.mjs"; //       import Messages from "./shared/messages/model/dataModel.mjs"; //    import Users from "./shared/users/model/dataModel.mjs"; //  - (     ) window.WS = new ws({ token: new URLSearchParams(document.location.search).get("token"), user: new URLSearchParams(document.location.search).get("user") }); //       new Messages({ el: '#messages' }) //       new Users({ el: '#users' })</span></span></code> </pre><br>  main.mjs √© um script que associa modelos de dados √†s visualiza√ß√µes correspondentes.  Para simplificar o c√≥digo, exemplos de representa√ß√µes da lista de usu√°rios ativos e feeds de mensagens s√£o criados diretamente no index.html <br><br><h4>  Modelo de dados </h4><br>  shared / messages / model / dataModel.mjs <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//    //          , //    import Base from '@root/lib/Base.mjs'; export default class dataModel extends Base { //!#client constructor(attr) { attr.data = { msg: '', messages: [] } super(attr); //     this.on('newmessage', (data) =&gt; { this.messages.push(data) }) } //!#client async sendMessage(e) { //    await this.$sendMessage(this.msg); this.msg = ''; } //!#server async $sendMessage(text) { //   newmessage     this.fireEvent('newmessage', 'all', { date: new Date(), text }) return true; } }</span></span></code> </pre><br>  Esses v√°rios m√©todos implementam toda a funcionalidade de envio e recebimento de mensagens em tempo real.  As diretivas! #Client e! #Server informam ao processo do observador qual m√©todo para qual parte (cliente ou servidor) se destina.  Se n√£o houver essas diretivas antes de definir um m√©todo, esse m√©todo estar√° dispon√≠vel no cliente e no servidor.  As barras de coment√°rios antes da diretiva s√£o opcionais e existem apenas para impedir que o IDE padr√£o xingue os erros de sintaxe. <br><br>  A primeira linha do caminho usa a pesquisa &amp; root.  Ao gerar as vers√µes do cliente e do servidor, o &amp; root ser√° substitu√≠do pelo caminho relativo para os diret√≥rios p√∫blico e protegido, respectivamente. <br><br>  Outro ponto importante: no m√©todo cliente, voc√™ pode chamar apenas o m√©todo servidor, cujo nome come√ßa com "$": <br><br><pre> <code class="javascript hljs">... <span class="hljs-comment"><span class="hljs-comment">//    async sendMessage(e) { await this.$sendMessage(this.msg); &lt;-    this.msg = ''; } ...</span></span></code> </pre><br>  Isso √© feito por raz√µes de seguran√ßa: do lado de fora, voc√™ s√≥ pode recorrer a m√©todos especialmente projetados para isso. <br><br>  Vejamos as vers√µes dos modelos de dados que o observador gerou para o cliente e o servidor. <br><br>  <b>Cliente</b> (p√∫blico / compartilhado / mensagens / modelo / dataModel.mjs) <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Base <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'/lib/Base.mjs'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataModel</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Base</span></span></span><span class="hljs-class"> </span></span>{ __getFilePath__() {<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"messages/model/dataModel.mjs"</span></span>} <span class="hljs-comment"><span class="hljs-comment">// constructor(attr) { attr.data = { msg: '', messages: [] } super(attr); //     this.on('newmessage', (data) =&gt; { this.messages.push(data) }) } // async sendMessage(e) { //    await this.$sendMessage(this.msg); this.msg = ''; } // ... async $sendMessage() {return await this.__runSharedFunction("$sendMessage",arguments)} }</span></span></code> </pre><br>  No lado do cliente, o modelo √© um descendente da classe Vue (via Base.mjs).  Assim, voc√™ pode trabalhar com ele como em um modelo de dados Vue comum.  O observador adicionou o m√©todo __getFilePath__ √† vers√£o do cliente do modelo, que retorna o caminho para o arquivo de classe e substitui o c√≥digo do m√©todo do servidor $ sendMessage por uma constru√ß√£o que, em ess√™ncia, chamar√° o m√©todo necess√°rio no servidor por meio do mecanismo rpc (__runSharedFunction √© definido na classe pai). <br><br>  <b>Servidor</b> (protegido / compartilhado / mensagens / modelo / dataModel.mjs) <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Base <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../../lib/Base.mjs'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataModel</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Base</span></span></span><span class="hljs-class"> </span></span>{ __getFilePath__() {<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"messages/model/dataModel.mjs"</span></span>} ...       ... <span class="hljs-comment"><span class="hljs-comment">// async $sendMessage(text) { //   newmessage     this.fireEvent('newmessage', 'all', { date: new Date(), text }) return true; } }</span></span></code> </pre><br>  Na vers√£o do servidor, o m√©todo __getFilePath__ tamb√©m foi adicionado e os m√©todos do cliente marcados com a diretiva foram removidos! <br><br>  Nas duas vers√µes geradas do modelo, todas as linhas exclu√≠das s√£o substitu√≠das por vazias.  Isso √© feito para que a mensagem de erro no depurador possa encontrar facilmente a linha problem√°tica no c√≥digo-fonte do modelo. <br><br><h4>  Intera√ß√£o cliente-servidor </h4><br>  Quando precisamos chamar algum m√©todo de servidor no cliente, basta faz√™-lo. <br>  Se a chamada estiver dentro do mesmo modelo, tudo ser√° simples: <br><br><pre> <code class="javascript hljs">... !#client <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> sendMessage(e) { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$sendMessage(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.msg); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.msg = <span class="hljs-string"><span class="hljs-string">''</span></span>; } !#server <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> $sendMessage(msg) { <span class="hljs-comment"><span class="hljs-comment">// -    } ...</span></span></code> </pre><br>  Voc√™ pode "puxar" outro modelo: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> dataModel <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"/shared/messages/model/dataModel.mjs"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> msg = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> dataModel(); msg.$sendMessage(<span class="hljs-string"><span class="hljs-string">'blah-blah-blah'</span></span>);</code> </pre><br>  Na dire√ß√£o oposta, ou seja,  Chamar algum m√©todo cliente no servidor n√£o funciona.  Tecnicamente, isso √© vi√°vel, mas do ponto de vista pr√°tico n√£o faz sentido, porque  o servidor √© um, mas h√° muitos clientes.  Se precisarmos iniciar algumas a√ß√µes no servidor no cliente, usamos o mecanismo de eventos: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//    ... //!#client constructor(attr) { .... //       "newmessage" this.on('newmessage', (data) =&gt; { this.messages.push(data) }) } //!#server async $sendMessage(text) { //     newmessage     this.fireEvent('newmessage', 'all', { date: new Date(), text }) return true; } ...</span></span></code> </pre><br>  O m√©todo fireEvent usa tr√™s par√¢metros: o nome do evento, a quem ele √© endere√ßado e os dados.  Voc√™ pode definir o destinat√°rio de v√°rias maneiras: palavra-chave ‚Äútodos‚Äù - o evento ser√° enviado a todos os usu√°rios ou na matriz para listar os tokens de sess√£o dos clientes aos quais o evento √© endere√ßado. <br><br>  O evento n√£o est√° vinculado a uma inst√¢ncia espec√≠fica da classe do modelo de dados e os manipuladores ser√£o acionados em todas as inst√¢ncias da classe na qual o fireEvent foi chamado. <br><br><h4>  Dimensionamento de back-end horizontal </h4><br>  A monoliticidade dos modelos cliente-servidor na implementa√ß√£o proposta, √† primeira vista, deve impor restri√ß√µes significativas √† possibilidade de dimensionamento horizontal da parte do servidor.  Mas n√£o √© assim: tecnicamente, o servidor √© independente do cliente.  Voc√™ pode copiar o diret√≥rio "public" em qualquer lugar e fornecer seu conte√∫do atrav√©s de qualquer outro servidor web (nginx, apache, etc.). <br><br>  O lado do servidor pode ser facilmente expandido iniciando novas inst√¢ncias de back-end.  Redis e o sistema de filas Kue s√£o usados ‚Äã‚Äãpara interagir com inst√¢ncias individuais. <br><br><h4>  API e clientes diferentes para um back-end </h4><br>  Em projetos reais, diversos clientes de servidor podem usar uma API de servidor - sites, aplicativos m√≥veis, servi√ßos de terceiros.  Na solu√ß√£o proposta, tudo isso est√° dispon√≠vel sem dan√ßas adicionais.  Sob o cap√¥ de chamar m√©todos de servidor est√° o bom e velho rpc.  O pr√≥prio servidor da web √© um aplicativo expresso cl√°ssico.  √â suficiente adicionar um wrapper para rotas com a chamada dos m√©todos necess√°rios dos mesmos modelos de dados. <br><br><h4>  Post scriptum </h4><br>  A abordagem proposta no artigo n√£o pretende mudan√ßas revolucion√°rias nos aplicativos cliente-servidor.  Ele apenas adiciona um pouco de conforto ao processo de desenvolvimento, permitindo que voc√™ se concentre na l√≥gica de neg√≥cios montada em um √∫nico local. <br><br>  Este projeto √© experimental, escreva nos coment√°rios se, na sua opini√£o, vale a pena continuar esse experimento. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt435494/">https://habr.com/ru/post/pt435494/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt435480/index.html">Microsoft e Kroger v√£o dar √† Amazon uma briga no campo ... com√©rcio de alimentos</a></li>
<li><a href="../pt435482/index.html">Destaque em zirc√£o: vDSO (objeto din√¢mico compartilhado virtual)</a></li>
<li><a href="../pt435484/index.html">Estilo fuzzing 1989</a></li>
<li><a href="../pt435488/index.html">Zombarias, stubs e espi√µes no Spock Framework</a></li>
<li><a href="../pt435490/index.html">Altera√ß√µes fiscais do Google em 2019</a></li>
<li><a href="../pt435496/index.html">Tesla processada por um acidente em que o motorista e o passageiro do modelo S morreram</a></li>
<li><a href="../pt435498/index.html">vCloud Director Extender: Migra√ß√£o</a></li>
<li><a href="../pt435500/index.html">Luvas biom√©tricas no automobilismo</a></li>
<li><a href="../pt435502/index.html">O estudo revelou os pr√≥s e contras do perfeccionismo</a></li>
<li><a href="../pt435504/index.html">Monstros de m√£o na luta pela limpeza: sele√ß√£o manual do aspirador Xiaomi</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>