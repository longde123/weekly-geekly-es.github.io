<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§¥üèø üçÅ üë§ Comment nous avons mis la gestion des infrastructures sur Terraform - et commenc√© √† vivre üõ£Ô∏è ü•† üïö</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nous avions 4 comptes Amazon, 9 VPC et 30 environnements de d√©veloppement, √©tapes et r√©gressions les plus puissants - au total plus de 1000 instances ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment nous avons mis la gestion des infrastructures sur Terraform - et commenc√© √† vivre</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dins/blog/470543/"><img src="https://habrastorage.org/webt/os/gu/yk/osguyk_s9ckyitafq3rayiqhxw0.png" alt="image"><br>  Nous avions 4 comptes Amazon, 9 VPC et 30 environnements de d√©veloppement, √©tapes et r√©gressions les plus puissants - au total plus de 1000 instances EC2 de toutes les couleurs et nuances.  Depuis que j'ai commenc√© √† collecter des solutions cloud pour les entreprises, je dois aller jusqu'au bout de mon hobby et r√©fl√©chir √† la fa√ßon d'automatiser tout cela. <br><br>  Salut  Je m'appelle Kirill Kazarin, je travaille comme ing√©nieur chez DINS.  Nous d√©veloppons des solutions de communication d'entreprise bas√©es sur le cloud.  Dans notre travail, nous utilisons activement Terraform, avec lequel nous g√©rons de mani√®re flexible notre infrastructure.  Je partagerai mon exp√©rience avec cette solution. <br><br>  L'article est long, alors faites le plein de th√© au <s>pop-corn</s> et c'est parti! <br><br>  Et encore une nuance - l'article a √©t√© √©crit sur la base de la version 0.11, dans la version 0.12 beaucoup a chang√© mais les principales pratiques et astuces sont toujours d'actualit√©.  La question de la migration de 0,11 √† 0,12 m√©rite un article s√©par√©! <br><a name="habracut"></a><br><h3>  Qu'est-ce que Terraform </h3><br>  <b>Terraform</b> est un outil populaire d'Hashicorp qui est apparu en 2014. <br><br>  Cet utilitaire vous permet de g√©rer votre infrastructure cloud dans l' <i>infrastructure en tant que</i> paradigme de <i>code</i> dans un langage d√©claratif tr√®s convivial et facile √† lire.  Son application vous fournit un type unifi√© de ressources et d'application des pratiques de code pour la gestion de l'infrastructure, qui ont longtemps √©t√© d√©velopp√©es par la communaut√© des d√©veloppeurs.  Terraform prend en charge toutes les plates-formes cloud modernes, vous permet de modifier l'infrastructure de mani√®re s√ªre et pr√©visible. <br><br>  Une fois lanc√©, Terraform lit le code et, √† l'aide des plug-ins fournis par les fournisseurs de services cloud, am√®ne votre infrastructure √† l'√©tat d√©crit en effectuant les appels d'API n√©cessaires. <br><br>  Notre projet est enti√®rement sur Amazon, d√©ploy√© sur la base des services AWS, et j'√©cris donc sur l'utilisation de Terraform dans cette veine.  S√©par√©ment, je note qu'il peut √™tre utilis√© non seulement pour Amazon.  Il vous permet de g√©rer tout ce qui a une API. <br><br>  De plus, nous g√©rons les param√®tres VPC, les strat√©gies IAM et les r√¥les.  Nous g√©rons les tables de routage, les certificats, les ACL r√©seau.  Nous g√©rons les param√®tres de notre pare-feu d'application Web, S3-bucket, SQS-queues - tout ce que notre service peut utiliser dans Amazon.  Je n'ai pas encore vu de fonctionnalit√©s avec Amazon que Terraform ne pouvait pas d√©crire en termes d'infrastructure. <br><br>  Il s‚Äôagit d‚Äôune infrastructure assez grande, avec vos mains, elle est facile √† prendre en charge.  Mais avec Terraform, c'est pratique et simple. <br><br><h3>  De quoi Terraform est fait </h3><br>  <b>Les fournisseurs</b> sont des plugins pour travailler avec l'API d'un service.  Je les ai compt√©s <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">plus de 100</a> .  Parmi eux se trouvent des fournisseurs pour Amazon, Google, DigitalOcean, VMware Vsphere, Docker.  J'ai m√™me trouv√© un fournisseur sur cette liste officielle qui vous permet <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">de g√©rer les r√®gles de Cisco ASA</a> ! <br><br>  Entre autres choses, vous pouvez contr√¥ler: <br><br><ul><li>  Tableaux de bord, source de donn√©es et alertes √† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Grafana</a> . </li><li>  Projets sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">GitHub</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">GitLab</a> . </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">RabbitMQ</a> . </li><li>  Bases de donn√©es, utilisateurs et droits dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">MySQL</a> . </li></ul><br>  Et ce ne sont que des fournisseurs officiels, il y a encore plus de fournisseurs non officiels.  Pendant les exp√©riences, je suis tomb√© sur GitHub un tiers, non inclus dans le fournisseur de liste officiel, qui a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">permis de travailler avec DNS de GoDaddy</a> , ainsi qu'avec les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ressources Proxmox</a> . <br><br>  Dans un projet Terraform, vous pouvez utiliser diff√©rents fournisseurs et, par cons√©quent, les ressources de diff√©rents fournisseurs de services ou technologies.  Par exemple, vous pouvez g√©rer votre infrastructure dans AWS, avec un DNS externe de GoDaddy.  Et demain, votre entreprise a achet√© une startup h√©berg√©e dans DO ou Azure.  Et pendant que vous d√©cidez de migrer ou non vers AWS, vous pouvez √©galement le prendre en charge avec le m√™me outil! <br><br>  <b>Ressources.</b>  Ce sont des entit√©s cloud que vous pouvez cr√©er √† l'aide de Terraform.  Leur liste, leur syntaxe et leurs propri√©t√©s d√©pendent du fournisseur utilis√©, en fait - du cloud utilis√©.  Ou pas seulement des nuages. <br><br>  <b>Modules</b>  Ce sont les entit√©s avec lesquelles Terraform vous permet de mod√©liser votre configuration.  Ainsi, les mod√®les vous permettent de rendre votre code plus petit, vous permettent de le r√©utiliser.  Eh bien, ils aident √† travailler confortablement avec lui. <br><br><h3>  Pourquoi nous avons choisi Terraform </h3><br>  Pour nous, nous avons identifi√© 5 raisons principales.  Peut-√™tre de votre point de vue, tous ne sembleront pas significatifs: <br><br><ul><li>  <b>Terraform est un utilitaire de prise en charge de plusieurs Cloud <s>Cloud Agnostic</s> (merci pour le pr√©cieux commentaire dans les commentaires)</b> .  Lorsque nous avons s√©lectionn√© cet outil, nous avons pens√©: - Que se passera-t-il si la direction vient chez nous demain ou dans une semaine et dit: "Les <i>gars, et nous avons pens√© - ne nous contentons pas de d√©ployer sur Amazon. Nous avons une sorte de projet, o√π nous devrons obtenir l'infrastructure dans Google Cloud. Ou dans Azure - eh bien, on ne sait jamais</i> . "  Nous avons d√©cid√© que nous aimerions avoir un outil qui ne sera pas li√© de mani√®re rigide √† un service cloud. </li><li>  <b>Open source</b> .  Terraform est une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">solution open source</a> .  Le r√©f√©rentiel du projet a une note de plus de 16 mille √©toiles, c'est une bonne confirmation de la r√©putation du projet. <br><br>  Nous avons rencontr√© plus d'une ou deux fois le fait que dans certaines versions il y a des bugs ou un comportement pas tout √† fait compr√©hensible.  Avoir un r√©f√©rentiel ouvert vous permet de vous assurer qu'il s'agit bien d'un bug, et nous pouvons r√©soudre le probl√®me en mettant simplement √† jour le moteur ou la version du plugin.  Ou qu'il s'agit d'un bug, mais "Les gars, attendez, litt√©ralement deux jours plus tard, une nouvelle version sera publi√©e et nous le corrigerons."  Ou: "Oui, c'est quelque chose d'incompr√©hensible, d'√©trange, ils le trient, mais il y a du contournement."  C'est tr√®s pratique. </li><li>  <b>Contr√¥le</b> .  Terraform en tant qu'utilitaire est enti√®rement sous votre contr√¥le.  Il peut √™tre install√© sur un ordinateur portable, sur un serveur, il peut √™tre facilement int√©gr√© dans votre pipeline, ce qui peut √™tre fait sur la base de n'importe quel outil.  Par exemple, nous l'utilisons dans GitLab CI. </li><li>  <b>V√©rification de l'√©tat de l'infrastructure</b> .  Terraform peut v√©rifier et v√©rifie l'√©tat de votre infrastructure. <br><br>  Supposons que vous ayez commenc√© √† utiliser Terraform dans votre √©quipe.  Vous cr√©ez une description d'une ressource dans Amazon, par exemple, Security Group, appliquez-la - elle est cr√©√©e pour vous, tout va bien.  Et ici - bam!  Votre coll√®gue qui est rentr√© de vacances hier et ne sait pas encore que vous avez tout si bien arrang√© ici, ou m√™me un coll√®gue d'un autre service entre et modifie les param√®tres de ce groupe de s√©curit√© par des poign√©es. <br><br>  Et sans le rencontrer, sans parler ou sans avoir rencontr√© un certain probl√®me, vous ne le saurez jamais dans une situation normale.  Mais, si vous utilisez Terraform, m√™me l'ex√©cution d'un plan inactif sur cette ressource vous montrera qu'il y a des changements dans l'environnement de travail. <br><br>  Lorsque Terraform examine votre code, il appelle simultan√©ment l'API du fournisseur de cloud, re√ßoit l'√©tat des objets de celui-ci et compare: ¬´Et maintenant, il y a la m√™me chose que je faisais avant, de quoi me souviens-je?¬ª  Puis il le compare avec le code, regarde ce qui doit √™tre chang√©.  Et, par exemple, si tout est le m√™me dans son histoire, dans sa m√©moire et dans votre code, mais qu'il y a des changements l√†-bas, il vous le montrera et vous proposera de le faire reculer.  √Ä mon avis, √©galement une tr√®s bonne propri√©t√©.  C'est donc une autre √©tape, personnellement pour nous, pour nous assurer d'avoir une infrastructure immuable. </li><li>  Une autre caract√©ristique tr√®s importante est <b>les modules que</b> j'ai mentionn√©s et qui comptent.  J'en parlerai un peu plus tard.  Quand je comparerai avec les outils. </li></ul><br>  Et aussi une cerise sur le g√¢teau: Terraform a une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">liste assez large de fonctions int√©gr√©es</a> .  Ces fonctions, malgr√© le langage d√©claratif, nous permettent d'en impl√©menter certaines, pour ne pas dire programmatiques, mais logiques. <br><br>  Par exemple, certains calculs automatiques, lignes fractionn√©es, transtypage en minuscules et majuscules, suppression de caract√®res de cette ligne.  Nous l'utilisons assez activement.  Ils facilitent la vie, surtout lorsque vous √©crivez un module qui sera ensuite r√©utilis√© dans diff√©rents environnements. <br><br><h3>  Terraform vs CloudFormation </h3><br>  Le r√©seau compare souvent Terraform √† CloudFormation.  Nous avons √©galement pos√© cette question lors de son choix.  Et voici le r√©sultat de notre comparaison. <br><br><div class="scrollable-table"><table><tbody><tr><th>  Comparaison </th><th>  Terraform </th><th>  Cloudformation </th></tr><tr><td>  Prise en charge de plusieurs clouds </td><td>  Gr√¢ce √† l'utilisation de divers fournisseurs, les plug-ins peuvent fonctionner avec n'importe quel grand fournisseur de cloud. <br></td><td>  Fermement attach√© √† Amazon. </td></tr><tr><td>  Suivi des modifications </td><td>  Si vous avez un changement <br>  pas dans le code TF, mais sur la ressource qu'il a cr√©√©e, TF pourra le d√©tecter et vous permettre de corriger la situation <br></td><td>  Une fonction similaire est apparue <br>  uniquement en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">novembre 2018</a> . <br></td></tr><tr><td>  Les conditions </td><td>  Pas de prise en charge des conditions (uniquement <br>  sous forme d'op√©rateurs ternaires). </td><td>  Les conditions sont prises en charge. </td></tr><tr><td>  Stockage <br>  √©tats </td><td>  Vous permet de s√©lectionner plusieurs types de backend, par exemple localement <br>  sur votre machine (c'est le comportement par d√©faut), sur un partage de fichiers, <br>  en S3 et ailleurs. <br><br>  Ceci est parfois utile car tfstate Terraform est pr√©sent√© comme un gros fichier texte avec une structure de type JSON.  Et parfois, il est parfois utile d‚Äôy entrer, de le lire - et au moins de pouvoir en faire une sauvegarde, car on ne sait jamais quoi.  Personnellement, par exemple, je suis plus calme du fait que c'est quelque part sous mon contr√¥le. <br></td><td>  Stockage de l'√©tat uniquement quelque part dans AWS </td></tr><tr><td>  Importation de ressources </td><td>  Terraform facilite l'importation de ressources.  Vous pouvez prendre toutes les ressources sous votre contr√¥le.  Vous √©crivez simplement le code qui caract√©risera cet objet ou utilisez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Terraforming</a> . <br>  Elle se rend sur le m√™me Amazon, prend des informations sur l'environnement √† partir de l√†, puis les vide sous forme de code. <br>  Il est g√©n√©r√© par la machine, pas optimis√©, mais c'est une bonne premi√®re √©tape pour d√©marrer la migration.  Et puis vous venez de donner la commande d'importation.  Terraform compare, met cet environnement dans son √©tat - et maintenant il le contr√¥le. <br></td><td>  CloudFormation ne sait pas comment.  Si <br>  vous avez fait quelque chose avant cela avec vos mains, soit vous le frappez et le recr√©ez en utilisant CloudFormation, soit vous continuez.  Malheureusement, aucune option. </td></tr></tbody></table></div><br><h3>  Comment d√©marrer avec Terraform </h3><br>  De mani√®re g√©n√©rale, le d√©marrage est assez simple.  Voici bri√®vement les premi√®res √©tapes: <br><br><ol><li>  Tout d'abord, cr√©ez un r√©f√©rentiel Git et commencez imm√©diatement √† stocker toutes vos modifications, exp√©riences et tout. </li><li>  Lisez le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">guide de d√©marrage</a> .  Il est petit, simple, assez d√©taill√© et d√©crit bien comment d√©marrer avec cet utilitaire. </li><li>  √âcrivez une d√©mo, du code de travail.  Vous pouvez m√™me copier une sorte d'exemple pour jouer avec plus tard. </li></ol><br><h3>  Notre pratique avec Terraform </h3><br><h4>  Code source </h4><br>  Vous avez commenc√© votre premier projet et enregistrez tout dans un grand fichier main.tf.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Voici un exemple typique</a> (j'ai honn√™tement pris le premier que j'ai re√ßu de GitHub). <br><br>  Rien de mal, mais la taille de la base de code a tendance √† augmenter avec le temps.  Les d√©pendances entre les ressources augmentent √©galement.  Apr√®s un certain temps, le fichier devient √©norme, complexe, illisible, mal entretenu - et un changement imprudent au m√™me endroit peut causer des probl√®mes. <br><br>  La premi√®re chose que je recommande est de mettre en √©vidence le soi-disant r√©f√©rentiel de base, ou l'√©tat de base de votre projet, votre environnement.  D√®s que vous commencez √† cr√©er une infrastructure √† l'aide de Terraform ou √† l'importer, vous constaterez imm√©diatement que vous avez des entit√©s qui, une fois d√©ploy√©es, configur√©es, changent rarement.  Par exemple, ce sont des param√®tres VPC ou VPC lui-m√™me.  Ce sont des r√©seaux, des groupes de s√©curit√© g√©n√©raux et de base tels que l'acc√®s SSH - vous pouvez compiler une liste assez longue. <br><br>  Cela n'a aucun sens de le conserver dans le m√™me r√©f√©rentiel que les services que vous modifiez fr√©quemment.  S√©lectionnez-les dans un r√©f√©rentiel s√©par√© et ancrez-les via une fonction Terraform telle que l'√©tat distant. <br><br><ul><li>  Vous r√©duisez la base de code de cette partie du projet avec laquelle vous travaillez souvent directement. </li><li>  Au lieu d'un grand fichier tfstate qui contient une description de l'√©tat de votre infrastructure, deux fichiers plus petits et √† un moment donn√©, vous travaillez avec l'un d'eux. </li></ul><br>  Quel est le truc?  Lorsque Terraform cr√©e un plan, c'est-√†-dire calcule, calcule ce qu'il doit changer, applique - il raconte compl√®tement cet √©tat, v√©rifie le code, v√©rifie le statut dans AWS.  Plus votre √©tat est grand, plus le plan prendra du temps. <br><br>  Nous sommes arriv√©s √† cette pratique quand il nous a fallu 20 minutes pour construire un plan pour l'ensemble de l'environnement en production.  En raison du fait que nous avons retir√© dans un noyau s√©par√© tout ce que nous ne sommes pas soumis √† des changements fr√©quents, nous avons r√©duit de moiti√© le temps de construire un plan.  Nous avons une id√©e de la fa√ßon dont il peut √™tre r√©duit davantage, se d√©composant non seulement en c≈ìur et en non-c≈ìur, mais aussi en sous-syst√®mes, car nous les avons connect√©s et changeons g√©n√©ralement ensemble.  Ainsi, nous disons, nous allons transformer 10 minutes en 3. Mais nous sommes toujours en train de mettre en ≈ìuvre une telle solution. <br><br><h4>  Moins de code - plus facile √† lire </h4><br>  Le petit code est plus facile √† comprendre et plus pratique √† utiliser.  Si vous avez une grande √©quipe et qu'elle a des gens avec diff√©rents niveaux d'exp√©rience - sortez ce que vous changez rarement, mais globalement, dans un navet s√©par√©, et fournissez-lui un acc√®s plus √©troit. <br><br>  Disons que vous avez des juniors dans votre √©quipe et que vous ne leur donnez pas acc√®s au r√©f√©rentiel global qui d√©crit les param√®tres du VPC - de cette fa√ßon, vous vous assurez contre les erreurs.  Si un ing√©nieur fait une erreur en √©crivant l'instance et que quelque chose se cr√©e mal - ce n'est pas effrayant.  Et s'il fait une erreur dans les options install√©es sur toutes les machines, s'arr√™te ou fait quelque chose avec les param√®tres des sous-r√©seaux, avec le routage - c'est beaucoup plus douloureux. <br><br>  La s√©lection du r√©f√©rentiel central se d√©roule en plusieurs √©tapes. <br><br>  <b>√âtape 1</b> .  Cr√©ez un r√©f√©rentiel s√©par√©.  Stockez tout le code dedans, s√©par√©ment - et d√©crivez les entit√©s qui devraient √™tre r√©utilis√©es dans un r√©f√©rentiel tiers √† l'aide de cette sortie.  Imaginons que nous cr√©ons une ressource de sous-r√©seau AWS dans laquelle nous d√©crivons o√π elle se trouve, quelle zone de disponibilit√©, espace d'adressage. <br><br><pre><code class="go hljs">resource <span class="hljs-string"><span class="hljs-string">"aws_subnet"</span></span> <span class="hljs-string"><span class="hljs-string">"lab_pub1a"</span></span> { vpc_id = <span class="hljs-string"><span class="hljs-string">"${aws_vpc.lab.id}"</span></span> cidr_block = <span class="hljs-string"><span class="hljs-string">"10.10.10.0/24"</span></span> Availability_zone = <span class="hljs-string"><span class="hljs-string">"us-east-1a"</span></span> ... } output <span class="hljs-string"><span class="hljs-string">"sn_lab_pub1a-id"</span></span> { value = <span class="hljs-string"><span class="hljs-string">"${aws_subnet.lab_pub1a.id}"</span></span> }</code> </pre> <br>  Et puis nous disons que nous envoyons l'id de cet objet √† la sortie.  Vous pouvez effectuer une sortie pour chaque param√®tre dont vous avez besoin. <br><br>  Quelle est l'astuce ici?  Lorsque vous d√©crivez une valeur, Terraform l'enregistre s√©par√©ment dans tfstate core.  Et quand vous vous tournerez vers lui, il n'aura pas besoin de se synchroniser, de raconter - il pourra vous donner imm√©diatement cette affaire depuis cet √©tat.  De plus, dans le r√©f√©rentiel, qui n'est pas central, vous d√©crivez une telle connexion avec l'√©tat distant: vous avez un √©tat distant tel ou tel, il se trouve dans le seau S3 tel ou tel, telle ou telle cl√© et une r√©gion. <br><br>  <b>√âtape 2</b> .  Dans un projet non principal, nous cr√©ons un lien vers l'√©tat du projet principal, afin de pouvoir faire r√©f√©rence aux param√®tres export√©s via la sortie. <br><br><pre> <code class="go hljs">data <span class="hljs-string"><span class="hljs-string">"terraform_remote_state"</span></span> <span class="hljs-string"><span class="hljs-string">"lab_core"</span></span> { backend = <span class="hljs-string"><span class="hljs-string">"s3"</span></span> config { bucket = <span class="hljs-string"><span class="hljs-string">"lab-core-terraform-state"</span></span> key = <span class="hljs-string"><span class="hljs-string">"terraform.tfstate"</span></span> region = <span class="hljs-string"><span class="hljs-string">"us-east-1"</span></span> } }</code> </pre><br>  <b>√âtape 3</b> .  Pour commencer!  Lorsque j'ai besoin de d√©ployer une nouvelle interface r√©seau pour une instance dans un sous-r√©seau sp√©cifique, je dis: voici l'√©tat distant des donn√©es, recherchez le nom de cet √©tat dedans, trouvez ce param√®tre dedans, qui, en fait, co√Øncide avec ce nom. <br><br><pre> <code class="go hljs">resource <span class="hljs-string"><span class="hljs-string">"aws_network_interface"</span></span> <span class="hljs-string"><span class="hljs-string">"fwl01"</span></span> { ... subnet_id = <span class="hljs-string"><span class="hljs-string">"${data.terraform_remote_state.lab_core.sn_lab_pub1a-id}"</span></span> }</code> </pre><br>  Et lorsque je construis un plan de changements dans mon r√©f√©rentiel non central, cette valeur pour Terraform deviendra une constante pour lui.  Si vous voulez le changer, vous devez le faire dans le r√©f√©rentiel de ce noyau, bien s√ªr.  Mais comme cela change rarement, cela ne vous d√©range pas beaucoup. <br><br><h4>  Modules </h4><br>  Permettez-moi de vous rappeler qu'un module est une configuration autonome constitu√©e d'une ou plusieurs ressources associ√©es.  Il est g√©r√© en groupe: <br><br>  Un module est une chose extr√™mement pratique car vous cr√©ez rarement une ressource comme √ßa, dans le vide, g√©n√©ralement elle est logiquement connect√©e √† quelque chose. <br><br><pre> <code class="go hljs">module <span class="hljs-string"><span class="hljs-string">"AAA"</span></span> { source = <span class="hljs-string"><span class="hljs-string">"..."</span></span> count = <span class="hljs-string"><span class="hljs-string">"3"</span></span> count_offset = <span class="hljs-string"><span class="hljs-string">"0"</span></span> host_name_prefix = <span class="hljs-string"><span class="hljs-string">"XXX-YYY-AAA"</span></span> ami_id = <span class="hljs-string"><span class="hljs-string">"${data.terraform_remote_state.lab_core.ami-base-ami_XXXX-id}"</span></span> subnet_ids = [<span class="hljs-string"><span class="hljs-string">"${data.terraform_remote_state.lab_core.sn_lab_pub1a-id}"</span></span>, <span class="hljs-string"><span class="hljs-string">"${data.terraform_remote_state.lab_core.sn_lab_pub1b-id}"</span></span>] instance_type = <span class="hljs-string"><span class="hljs-string">"t2.large"</span></span> sgs_ids = [ <span class="hljs-string"><span class="hljs-string">"${data.terraform_remote_state.lab_core.sg_ssh_lab-id}"</span></span>, <span class="hljs-string"><span class="hljs-string">"${aws_security_group.XXX_lab.id}"</span></span> ] boot_device = {volume_size = <span class="hljs-string"><span class="hljs-string">"50"</span></span> volume_type = <span class="hljs-string"><span class="hljs-string">"gp2"</span></span>} root_device = {device_name = <span class="hljs-string"><span class="hljs-string">"/dev/sdb"</span></span> volume_size = <span class="hljs-string"><span class="hljs-string">"50"</span></span> volume_type = <span class="hljs-string"><span class="hljs-string">"gp2"</span></span> encrypted = <span class="hljs-string"><span class="hljs-string">"true"</span></span>} tags = <span class="hljs-string"><span class="hljs-string">"${var.gas_tags}"</span></span> }</code> </pre><br>  Par exemple: lorsque nous d√©ployons une nouvelle instance EC2, nous cr√©ons une interface r√©seau et une pi√®ce jointe pour celle-ci, nous lui faisons souvent une adresse IP √©lastique, nous faisons un enregistrement route-53 et autre chose.  Autrement dit, nous obtenons au moins 4 entit√©s. <br><br>  Chaque fois, les d√©crire en quatre morceaux de code n'est pas pratique.  De plus, ils sont assez typiques.  Cela demande - cr√©ez un mod√®le, puis faites simplement r√©f√©rence √† ce mod√®le, en lui passant des param√®tres: un nom, dans quelle grille pousser, quel groupe de s√©curit√© y accrocher.  C'est tr√®s pratique. <br><br>  Terraform dispose d'une fonction de comptage, qui vous permet de r√©duire davantage votre √©tat.  Vous pouvez d√©crire un grand ensemble d'instances avec un seul morceau de code.  Disons que je dois d√©ployer 20 machines du m√™me type.  Je n'√©crirai pas 20 morceaux de code m√™me √† partir d'un mod√®le, j'√©crirai 1 morceau de code, j'indiquerai le nombre et le nombre - combien je dois faire. <br><br>  Par exemple, certains modules font r√©f√©rence √† un mod√®le.  Je ne passe que des param√®tres sp√©cifiques: sous-r√©seau ID;  AMI pour d√©ployer avec;  type d'instance;  param√®tres de groupe de s√©curit√©;  toute autre chose, et indiquez combien de ces choses me faire.  Super, les a pris et les ont retourn√©s! <br><br>  Demain, les d√©veloppeurs viennent me voir et me disent: ¬´√âcoutez, nous voulons exp√©rimenter la charge, veuillez nous en donner deux autres.¬ª  Ce que je dois faire: je change un chiffre en 5. La quantit√© de code reste exactement la m√™me. <br><br>  Classiquement, les modules peuvent √™tre divis√©s en deux types - ressources et infrastructures.  Du point de vue du code, il n'y a pas de diff√©rence, mais plut√¥t les concepts de niveau sup√©rieur que l'op√©rateur lui-m√™me introduit. <br>  Les modules de ressources fournissent une collection de ressources normalis√©es et param√©tr√©es, li√©es de mani√®re logique.  L'exemple ci-dessus est un module de ressources typique.  Comment travailler avec eux: <br><br><ul><li>  Nous indiquons le chemin vers le module - la source de sa configuration, via la directive Source. </li><li>  Nous indiquons la version - oui, et le fonctionnement sur le principe des ¬´derni√®res et meilleures¬ª n'est pas la meilleure option ici.  Vous n'incluez pas la derni√®re version de la biblioth√®que √† chaque fois dans votre projet?  Mais plus √† ce sujet plus tard. </li><li>  Nous lui transmettons des arguments. </li></ul><br>  Nous sommes attach√©s √† la version du module, et nous prenons juste le dernier - l'infrastructure doit √™tre versionn√©e (les ressources ne peuvent pas √™tre versionn√©es, mais le code peut).  Une ressource peut √™tre cr√©√©e supprim√©e ou recr√©√©e.  C‚Äôest tout!  Nous devons √©galement savoir clairement quelle version nous avons cr√©√© chaque √©l√©ment de l'infrastructure. <br><br>  Les modules d'infrastructure sont assez simples.  Ils sont constitu√©s de ressources et incluent des normes d'entreprise (par exemple, des balises, des listes de valeurs standard, des valeurs par d√©faut accept√©es, etc.). <br><br>  En ce qui concerne notre projet et notre exp√©rience, nous avons depuis longtemps et fermement bascul√© vers l'utilisation de modules de ressources pour tout ce qui est possible avec un processus de versioning et de r√©vision tr√®s strict.  Et maintenant, nous introduisons activement la pratique des modules d'infrastructure au niveau du laboratoire et de la mise en sc√®ne. <br><br>  Recommandations pour l'utilisation des modules <br><br><ol><li>  Si vous ne pouvez pas √©crire, mais utilisez des cl√©s en main, n'√©crivez pas.  Surtout si vous √™tes nouveau dans ce domaine.  Faites confiance aux modules pr√™ts √† l'emploi, ou au moins voyez comment ils vous l'ont fait.  Cependant, si vous devez encore √©crire le v√¥tre, n'utilisez pas l'appel aux fournisseurs en interne et soyez prudent avec les fournisseurs de services. </li><li>  V√©rifiez que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Terraform Registry</a> ne contient pas de module de ressources pr√™t √† l'emploi. </li><li>  Si vous √©crivez votre module, cachez les d√©tails sous le capot.  L'utilisateur final n'a pas √† se soucier de quoi et comment vous impl√©mentez en interne. </li><li>  Faites les param√®tres d'entr√©e et les valeurs de sortie de votre module.  Et c'est mieux s'il s'agit de fichiers s√©par√©s.  Tellement pratique. </li><li>  Si vous √©crivez vos modules, stockez-les dans le r√©f√©rentiel et la version.  Mieux vaut un r√©f√©rentiel s√©par√© pour le module. </li><li>  N'utilisez pas de modules locaux - ils ne sont ni versionn√©s ni r√©utilis√©s. </li><li>  √âvitez d'utiliser les descriptions des fournisseurs dans le module, car les informations d'identification de connexion peuvent √™tre configur√©es et appliqu√©es diff√©remment pour diff√©rentes personnes.  Quelqu'un utilise des variables d'environnement pour cela, et quelqu'un implique de stocker leurs cl√©s et secrets dans des fichiers avec des chemins de prescription pour eux.  Cela doit √™tre indiqu√© √† un niveau sup√©rieur. </li><li>  Utilisez le provisionneur local avec pr√©caution.  Il est ex√©cut√© localement, sur la machine sur laquelle Terraform s'ex√©cute, mais l'environnement d'ex√©cution pour diff√©rents utilisateurs peut √™tre diff√©rent.  Jusqu'√† ce que vous l'int√©griez dans CI, vous pouvez rencontrer divers artefacts: par exemple, un ex√©cutable local et un ansible en cours d'ex√©cution.  Et quelqu'un a une distribution diff√©rente, un autre shell, une version diff√©rente de ansible, ou m√™me Windows. </li></ol><br>  Signes d'un bon module (voici un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">peu plus en d√©tail</a> ): <br><br><ul><li>  Les bons modules ont une documentation et des exemples.  Si chacun est con√ßu comme un r√©f√©rentiel s√©par√©, cela est plus facile √† faire. </li><li>  Ils n'ont pas de param√®tres cod√©s en dur (par exemple, r√©gion AWS). </li><li>  Utilisez des valeurs par d√©faut raisonnables, con√ßues comme valeurs par d√©faut.  Par exemple, le module pour l'instance EC2 par d√©faut ne cr√©era pas de machine virtuelle de type m5d.24xlarge pour vous, il utilise pour cela l'un des types minimum t2 ou t3. </li><li>  Le code est ¬´propre¬ª - structur√©, fourni avec des commentaires, pas inutilement confus, con√ßu dans le m√™me style. </li><li>  Il est hautement souhaitable qu'il soit √©quip√© de tests, bien que ce soit difficile.  Malheureusement, nous n'y sommes pas encore parvenus. </li></ul><br><h4>  Marquage </h4><br>  Les balises sont importantes. <br><br>  Le balisage, c'est la facturation.  AWS dispose d'outils qui vous permettent de voir combien d'argent vous d√©pensez sur votre infrastructure.  Et notre direction voulait vraiment avoir un outil dans lequel ils pourraient le voir de fa√ßon d√©terministe.  Par exemple, combien d'argent tel ou tel composant consomme, ou tel ou tel sous-syst√®me, telle ou telle √©quipe, tel ou tel environnement <br><br><img src="https://habrastorage.org/webt/3q/mn/9e/3qmn9ej1ao0cmn8irggvgl8ztj4.png" alt="image"><br><br>  Le balisage est la documentation de votre syst√®me.  Avec lui, vous simplifiez votre recherche.  M√™me juste dans la console AWS, o√π ces balises sont parfaitement affich√©es sur votre √©cran, il devient plus facile pour vous de comprendre √† quoi se r√©f√®re tel ou tel type d'instance.  Si de nouveaux coll√®gues viennent, il est plus facile pour vous d'expliquer cela en montrant: "Regardez, c'est √ßa - ici."  Nous avons commenc√© √† cr√©er des balises comme suit - nous avons cr√©√© un tableau de balises pour chaque type de ressource. <br><br>  Un exemple: <br><br><pre> <code class="go hljs">variable <span class="hljs-string"><span class="hljs-string">"XXX_tags"</span></span> { description = <span class="hljs-string"><span class="hljs-string">"The set of XXX tags."</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> = <span class="hljs-string"><span class="hljs-string">"map"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> = { <span class="hljs-string"><span class="hljs-string">"TerminationDate"</span></span> = <span class="hljs-string"><span class="hljs-string">"03.23.2018"</span></span>, <span class="hljs-string"><span class="hljs-string">"Environment"</span></span> = <span class="hljs-string"><span class="hljs-string">"env_name_here"</span></span>, <span class="hljs-string"><span class="hljs-string">"Department"</span></span> = <span class="hljs-string"><span class="hljs-string">"dev"</span></span>, <span class="hljs-string"><span class="hljs-string">"Subsystem"</span></span> = <span class="hljs-string"><span class="hljs-string">"subsystem_name"</span></span>, <span class="hljs-string"><span class="hljs-string">"Component"</span></span> = <span class="hljs-string"><span class="hljs-string">"XXX"</span></span>, <span class="hljs-string"><span class="hljs-string">"Type"</span></span> = <span class="hljs-string"><span class="hljs-string">"application"</span></span>, <span class="hljs-string"><span class="hljs-string">"Team"</span></span> = <span class="hljs-string"><span class="hljs-string">"team_name"</span></span> } }</code> </pre><br>  Il se trouve que dans notre entreprise, plus d'une de nos √©quipes utilise AWS, et il existe une liste de balises requises. <br><br><ol><li>  √âquipe - quelle √©quipe utilise le nombre de ressources. </li><li>  D√©partement - similaire √† un d√©partement. </li><li>  Environnement - les ressources battent dans les "environnements", mais vous, par exemple, pouvez le remplacer par un projet ou quelque chose comme √ßa. </li><li>  Sous-syst√®me - le sous-syst√®me auquel appartient le composant.  Les composants peuvent appartenir √† un sous-syst√®me.  Par exemple, nous voulons voir combien nous avons ce sous-syst√®me et ses entit√©s ont commenc√© √† consommer.  Du coup, par exemple, pour le mois pr√©c√©dent, il a consid√©rablement augment√©.  Nous devons aller voir les d√©veloppeurs et dire: ¬´Les gars, c'est cher.  Le budget est d√©j√† proche les uns des autres, optimisons en quelque sorte la logique. ¬ª </li><li>  Type - type de composant: √©quilibreur, stockage, application ou base de donn√©es. </li><li>  Composant - le composant lui-m√™me, son nom en notation interne. </li><li>  Date de r√©siliation - heure √† laquelle elle doit √™tre supprim√©e, au format date.  Si son retrait n'est pas pr√©vu, d√©finissez-le sur ¬´Permanent¬ª.  Nous l'avons introduit parce que dans les environnements de d√©veloppement, et m√™me dans certains environnements de stade, nous avons une phase de test de stress qui monte pendant les sessions de stress, c'est-√†-dire que nous ne gardons pas ces machines r√©guli√®rement.  Nous indiquons la date √† laquelle la ressource doit √™tre d√©truite.  De plus, vous pouvez s√©curiser l'automatisation bas√©e sur lambda, certains scripts externes qui fonctionnent via l'interface de ligne de commande AWS, qui d√©truiront automatiquement ces ressources. </li></ol><br>  Maintenant - comment marquer. <br><br>  Nous avons d√©cid√© que nous ferions notre propre tag-map pour chaque composant, dans lequel nous listerions toutes les balises sp√©cifi√©es: quand le terminer, √† quoi il se r√©f√®re.  Ils ont rapidement r√©alis√© que c'√©tait g√™nant.  Parce que la base de code se d√©veloppe, parce que nous avons plus de 30 composants, et 30 de ces morceaux de code ne sont pas pratiques.  Si vous devez changer quelque chose, vous ex√©cutez et changez. <br><br>  Pour bien marquer, nous utilisons l'entit√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Locals</a> . <br><br><pre> <code class="go hljs">locals { common_tags = {<span class="hljs-string"><span class="hljs-string">"TerminationDate"</span></span> = <span class="hljs-string"><span class="hljs-string">"XX.XX.XXXX"</span></span>, <span class="hljs-string"><span class="hljs-string">"Environment"</span></span> = <span class="hljs-string"><span class="hljs-string">"env_name"</span></span>, <span class="hljs-string"><span class="hljs-string">"Department"</span></span> = <span class="hljs-string"><span class="hljs-string">"dev"</span></span>, <span class="hljs-string"><span class="hljs-string">"Team"</span></span> = <span class="hljs-string"><span class="hljs-string">"team_name"</span></span>} subsystem_1_tags = <span class="hljs-string"><span class="hljs-string">"${merge(local.common_tags, map("</span></span>Subsystem<span class="hljs-string"><span class="hljs-string">", "</span></span>subsystem_1_name<span class="hljs-string"><span class="hljs-string">"))}"</span></span> subsystem_2_tags = <span class="hljs-string"><span class="hljs-string">"${merge(local.common_tags, map("</span></span>Subsystem<span class="hljs-string"><span class="hljs-string">", "</span></span>subsystem_2_name<span class="hljs-string"><span class="hljs-string">"))}"</span></span> }</code> </pre><br>  Vous pouvez y r√©pertorier un sous-ensemble, puis les utiliser les uns avec les autres. <br><br>  Par exemple, nous avons supprim√© certaines balises courantes dans une telle structure, puis des balises sp√©cifiques par sous-syst√®mes.  Nous disons: "Prenez ce bloc et ajoutez, par exemple, le sous-syst√®me 1. Et pour le sous-syst√®me 2, ajoutez le sous-syst√®me 2".  Nous disons: "Tags, s'il vous pla√Æt, prenez les g√©n√©ralit√©s et ajoutez le type, l'application, le nom, le composant et qui c'est."  Il s'av√®re un changement tr√®s bref, clair et centralis√©, si tout √† coup il est n√©cessaire. <br><br><pre> <code class="go hljs">module <span class="hljs-string"><span class="hljs-string">"ZZZ02"</span></span> { count = <span class="hljs-number"><span class="hljs-number">1</span></span> count_offset = <span class="hljs-number"><span class="hljs-number">1</span></span> name = <span class="hljs-string"><span class="hljs-string">"XXX-YYY-ZZZ"</span></span> ... tags = <span class="hljs-string"><span class="hljs-string">"${merge(local.core_tags, map("</span></span>Type<span class="hljs-string"><span class="hljs-string">", "</span></span>application<span class="hljs-string"><span class="hljs-string">", "</span></span>Component<span class="hljs-string"><span class="hljs-string">", "</span></span>XXX<span class="hljs-string"><span class="hljs-string">"))}"</span></span> }</code> </pre><br><img src="https://habrastorage.org/webt/ka/sq/4o/kasq4ocxxl3hht59z9p6o5bzjfs.png" alt="image"><br><br><h4>  Contr√¥le de version </h4><br>  Vos modules de mod√®le, si vous les utilisez, doivent √™tre stock√©s quelque part.  Le moyen le plus simple que tout le monde d√©marre est le stockage local.  Juste dans le m√™me r√©pertoire, juste un sous-r√©pertoire dans lequel vous d√©crivez, par exemple, un mod√®le pour une sorte de service.  Ce n'est pas un bon moyen.  C'est pratique, il peut √™tre rapidement r√©par√© et test√© rapidement, mais il est difficile de le r√©utiliser plus tard et difficile √† contr√¥ler <br><br><pre> <code class="go hljs">module <span class="hljs-string"><span class="hljs-string">"ZZZ02"</span></span> { source = <span class="hljs-string"><span class="hljs-string">"./modules/srvroles/ZZZ"</span></span> name = <span class="hljs-string"><span class="hljs-string">"XXX-YYY-ZZZ"</span></span> }</code> </pre><br>  Supposons que les d√©veloppeurs viennent vers vous et vous disent: "Donc, nous avons besoin de telle ou telle entit√© dans telle ou telle configuration, dans notre infrastructure."  Vous l'avez √©crit, r√©alis√© sous la forme d'un module local dans le r√©f√©rentiel de leur projet.  D√©ploy√© - excellent.  Ils ont test√©, dit: ¬´√áa va!  En production. "  Nous arrivons √† la sc√®ne, aux tests de r√©sistance, √† la production.  Chaque fois Ctrl-C, Ctrl-V;  Ctrl-C, Ctrl-V.  Pendant que nous arrivions √† la vente, notre coll√®gue l'a pris, a copi√© le code de l'environnement du laboratoire, l'a transf√©r√© √† un autre endroit et l'a chang√© l√†.  Et nous obtenons un √©tat d√©j√† incoh√©rent.  Avec la mise √† l'√©chelle horizontale, lorsque vous avez autant d'environnements de laboratoire que nous, ce n'est qu'un adish. <br><br>  Par cons√©quent, un bon moyen consiste √† cr√©er un r√©f√©rentiel Git distinct pour chacun de vos modules, puis √† vous y r√©f√©rer.  Nous changeons tout en un seul endroit - bon, pratique, contr√¥l√©. <br><br><pre> <code class="go hljs">module <span class="hljs-string"><span class="hljs-string">"ZZZ"</span></span> { source = <span class="hljs-string"><span class="hljs-string">"git::ssh://git@GIT_SERVER_FQDN/terraform/modules/general-vm/2-disks.git"</span></span> host_name_prefix = <span class="hljs-string"><span class="hljs-string">"XXX-YYY-ZZZ"</span></span></code> </pre><br>  Anticipant la question, comment votre code atteint-il la production.  Pour cela, un projet distinct est cr√©√© qui r√©utilise les modules pr√©par√©s et test√©s. <br><br>  Tr√®s bien, nous avons une source de code qui change de mani√®re centrale.  J'ai pris, √©crit, pr√©par√© et mis en place que demain matin je vais me d√©ployer en production.  Construit un plan, test√© - super, allons-y.  En ce moment, mon coll√®gue, guid√© exclusivement par de bonnes intentions, est all√© et a optimis√© quelque chose, ajout√© √† ce module.  Et il se trouve que ces changements rompent la compatibilit√© descendante. <br><br>  Par exemple, il a ajout√© les param√®tres n√©cessaires, qu'il doit transmettre, sinon le module ne s'assemblera pas.  Ou il a chang√© le nom de ces param√®tres.  J'arrive le matin, j'ai un temps strictement limit√© pour les changements, je commence √† construire un plan, et Terraform r√©cup√®re les modules d'√©tat de Git, commence √† construire un plan et dit: ¬´Oups, je ne peux pas.  Pas assez pour vous, vous avez renomm√©. "  Je suis surpris: "Mais je ne l'ai pas fait, comment y faire face?"  Et s'il s'agit d'une ressource qui a √©t√© cr√©√©e il y a longtemps, alors apr√®s de tels changements, vous devrez parcourir tous les environnements, en quelque sorte changer et conduire √† un seul regard.  C'est g√™nant. <br><br>  Cela peut √™tre corrig√© √† l'aide des balises Git.  Nous avons d√©cid√© par nous-m√™mes d'utiliser la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">notation SemVer</a> et √©labor√© une r√®gle simple: d√®s que la configuration de notre module atteint un certain √©tat stable, c'est-√†-dire que nous pouvons l'utiliser, nous mettons une balise sur ce commit.  Si nous apportons des modifications et qu'elles ne cassent pas la compatibilit√© descendante, nous changeons le num√©ro mineur au niveau de la balise, si elles cassent, nous changeons le num√©ro majeur. <br><br>  Donc, dans l'adresse source, attachez-vous √† une balise sp√©cifique et si au moins fournissez quelque chose que vous aviez auparavant, il sera toujours collect√©.  Laissez la version du module aller de l'avant, mais au bon moment, nous viendrons, et lorsque nous en aurons vraiment besoin, nous la changerons.  Et ce qui fonctionnait avant √ßa, au moins √ßa ne cassera pas.  C'est pratique.  Voici √† quoi cela ressemble dans notre GitLab. <br><br><img src="https://habrastorage.org/webt/qb/vc/yh/qbvcyhrhgdblv8ewvwlr1gkxsmc.png" alt="image"><br><br><h4>  Ramification </h4><br>  L'utilisation de la ramification est une autre pratique importante.  Nous avons d√©velopp√© une r√®gle pour nous-m√™mes que vous ne devez apporter des modifications qu'au ma√Ætre.  Mais pour tout changement que vous souhaitez apporter et tester, veuillez cr√©er une branche distincte, jouer avec, exp√©rimenter, faire des plans et voir comment cela se passe.  Et puis faites une demande de fusion et laissez un coll√®gue regarder le code et l'aide. <br><br><img src="https://habrastorage.org/webt/ty/vf/je/tyvfjel4g_uhzcrf7ifnkdxd230.png" alt="image"><br><br><h4>  O√π conserver tfstate </h4><br>  Vous ne devez pas stocker votre √©tat localement.  Vous ne devez pas stocker votre √©tat dans Git. <br><br>  Nous nous sommes br√ªl√©s l√†-dessus lorsque quelqu'un, lors du d√©ploiement des branches d'un non-ma√Ætre, obtient son √©tat tf, dans lequel l'√©tat est enregistr√© - puis il l'allume via la fusion, quelqu'un ajoute le sien, il s'av√®re que les conflits de fusion.  Ou cela se passe sans eux, mais un √©tat incoh√©rent, car "il l'a d√©j√†, je ne l'ai pas encore", et puis tout r√©parer est une pratique d√©sagr√©able.  Par cons√©quent, nous avons d√©cid√© de le stocker dans un endroit s√ªr, versionn√©, mais ce serait en dehors de Git. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">S3</a> s'inscrit parfaitement sous cela: il est disponible, il a HA, pour autant que je me souvienne <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">exactement de quatre neuf, peut-√™tre cinq</a> .  Il donne des versions hors de la bo√Æte, m√™me si vous cassez votre tfstate, vous pouvez toujours revenir en arri√®re.  Et il donne √©galement une chose tr√®s importante en combinaison avec DynamoDB, qui, √† mon avis, a appris ce Terraform depuis la version 0.8.  Dans DynamoDB, vous disposez d'une plaque signal√©tique dans laquelle Terraform enregistre qu'il bloque l'√©tat. <br><br>  Autrement dit, supposons que je souhaite apporter des modifications.  Je commence √† construire un plan ou √† commencer √† l'appliquer, Terraform va √† DynamoDB et dit qu'il indique dans cette plaque que cet √©tat est bloqu√©;  utilisateur, ordinateur, temps.  En ce moment, mon coll√®gue, qui travaille √† distance ou peut-√™tre √† quelques tables de moi, mais concentr√© sur le travail et ne voit pas ce que je fais, a √©galement d√©cid√© que quelque chose devait √™tre chang√©.  Il fait un plan, mais le lance un peu plus tard. <br><br>  Terraform entre dans la dynamique, voit - Lock, s'interrompt, dit √† l'utilisateur: "D√©sol√©, tfstate est bloqu√© par quelque chose."  Un coll√®gue voit que je travaille maintenant, il peut venir vers moi et me dire: "√âcoute, mon changeur est plus important, c√®de-moi, s'il te pla√Æt."  Je dis: "Bien", j'annule le plan, je supprime le bloc, m√™me s'il est automatiquement supprim√© si vous le faites correctement, sans interrompre Ctrl-C.  Un coll√®gue va et vient.  Ainsi, nous nous assurons contre une situation o√π vous changez quelque chose. <br><br><h4>  Fusion-demande </h4><br>  Nous utilisons la ramification dans Git.  Nous attribuons nos demandes de fusion √† des coll√®gues.  De plus, dans Gitlab, nous utilisons presque tous les outils disponibles pour travailler ensemble, pour des demandes de fusion ou m√™me juste quelques pools: discussion de votre code, sa r√©vision, mise en cours ou probl√®me, quelque chose comme √ßa.  C'est tr√®s utile, √ßa aide dans le travail. <br><br>  De plus, dans ce cas, la restauration est √©galement plus facile, vous pouvez revenir √† la validation pr√©c√©dente ou, si vous dites, par exemple, que vous appliqueriez non seulement les modifications de l'assistant, vous pouvez simplement basculer vers une branche stable.  Par exemple, vous avez cr√©√© une branche de fonctionnalit√© et d√©cid√© que vous apporteriez d'abord des modifications √† partir de la branche de fonctionnalit√©.  Et puis les changements, apr√®s que tout a bien fonctionn√©, apportent au ma√Ætre.  Vous avez appliqu√© les changements dans votre branche, vous avez r√©alis√© que quelque chose n'allait pas, vous √™tes pass√© au ma√Ætre - aucun changement, a d√©clar√© appliquer - il est revenu. <br><br><h4>  Pipelines </h4><br><img src="https://habrastorage.org/webt/qx/g1/ex/qxg1exw6vesornrgdhc7ynmjg80.png" alt="image"><br><br>  Nous avons d√©cid√© que nous devions utiliser le processus CI pour appliquer nos modifications.  Pour ce faire, sur la base de Gitlab CI, nous √©crivons un pipeline qui automatise l'application des modifications.  Jusqu'√† pr√©sent, nous en avons deux types: <br><br><ul><li>  Pipeline pour la branche principale (pipeline principal) </li><li>  Pipeline pour toutes les autres branches (pipeline de branche) </li></ul><br>  Que fait le pipeline de brunch?      (   , ).     .  ,     merge-request,           ‚Äî   ,   .         .    . <br><br><img src="https://habrastorage.org/webt/vt/0_/hq/vt0_hqcdpurvppbglcxwgwtqiyi.png" alt="image"><br><br>       .   ,       ,       .      Terraform-  ,       ,    . ,   merge-request   .        .       .   ,       ,        ,      . <br><br><img src="https://habrastorage.org/webt/67/9z/ub/679zubdsyvuldaiwzcpimtbvjmu.png" alt="image"><br><br>          ,   .         . <br><br><h3>  Terraform </h3><br> <b>.</b>      Terraform     ,      ,     . <br><br>     ,  ¬´¬ª ‚Äî              ,   . <br><br> ,   ,    count ‚Äî   ,  , ,  ,   availability-. , ,  ,  .          .    ,    AZ  .      ,  count      . <br><br> ,    4 AZ    5 ,       AZ ‚Äî   4,     , .    : ¬´    ¬ª.    !  ,      .        Terraform  . <br><br> <b> .</b>  ‚Äî  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> </a> .     .   - -   If  Else. ,    ‚Äî , . <br><br> <b>  </b> .     ,   ,    ,     , Terraform-    ,    CI. <br><br>  CI           .       ,      , ,    ‚Äî    merge,   .  . <br><br> ,         .        .     ,   , Terraform  , ,   tfstate   Terraform   : ¬´,  ,  ¬ª.        ,   ,      . <br><br>     CI,    ,    pipeline  ‚Äî   ,         . <br><br>   ,        .         ,      .    ,       target    ,   . ,      : ¬´Terraform apply target instance¬ª,  -.        -  (,  - ),        . <br><br>          ,      .     .   CI ‚Äî      ,  Terraform    ,   .      ,     - .  ,  ,       ,     .  . <br><br><h3> Terraform ‚Äî    </h3><br>      : <br><br><ul><li> Terraform       ,      .  , ,  .    ,        ,   ,   .       ,    ,  ,         . <br><br>  ,      ‚Äî       Tfstate,       ,        .         .   ¬´   ,    ¬ª ‚Äî  . <br><br>                 , -,  ,  - ‚Äî   .      ,          .     ,               ‚Äî    . </li><li> Terraform    ,      .  Terraform    .  Pourquoi?           ,    .     . ,   ,    AZ    - -. ,   North Virginia,     6  .          .    ,   ,  : ¬´,   ¬ª.       ‚Äî .   ‚Äî      ,  , Terraform     . </li><li> Terraform        . ,    ‚Äî 200 ,    198 ,    5.    .       ,         API .  H√©las. </li><li>     ,      . ,    S3 bucket.     ,              ‚Äî  ,     - .         Terraform ‚Äì    ,   ,   : ¬´,  -   ¬ª.     .      -  ,      . </li></ul><br>   , Terraform ‚Äî ,   .     ,     . <br></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr470543/">https://habr.com/ru/post/fr470543/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr470525/index.html">Windows dans un navigateur sans inscription et SMS - vue d'ensemble des clients HTML5 RDP</a></li>
<li><a href="../fr470531/index.html">Le neurophysiologue discute du projet Neuralink et parle du travail du cerveau ¬´sur les doigts¬ª</a></li>
<li><a href="../fr470535/index.html">Fa√ßons de cr√©er des graphiques √† barres √† l'aide de Python</a></li>
<li><a href="../fr470537/index.html">Nouveau package de validation pour React sur Mobx @ quantumart / mobx-form-validation-kit</a></li>
<li><a href="../fr470541/index.html">Principes de base de l'utilisation de Neo4j dans un navigateur</a></li>
<li><a href="../fr470547/index.html">Celery taskcls: nouveau d√©corateur, nouvelles fonctionnalit√©s</a></li>
<li><a href="../fr470549/index.html">TSMC esp√®re suivre la loi de Moore pour les d√©cennies √† venir</a></li>
<li><a href="../fr470553/index.html">Int√©grale d'Euler-Poisson. D√©tails sur les m√©thodes de calcul</a></li>
<li><a href="../fr470555/index.html">Revue Joker 2019: Planet Parade, ou ce qui nous attend</a></li>
<li><a href="../fr470557/index.html">Contr√¥le de la lumi√®re: un nouveau type d'√©l√©ments optiques √† base de m√©tamat√©riaux</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>