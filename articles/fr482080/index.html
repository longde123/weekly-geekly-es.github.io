<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üöµüèø üë™ ü¶ó Passerelle pour UDP entre Wi-Fi et LoRa üßëüèº‚Äçü§ù‚Äçüßëüèº üõë üôÜüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nous faisons la passerelle entre le Wi-Fi et LoRa pour UDP 





 J'ai eu un r√™ve d'enfance: donner √† chaque appareil domestique ¬´sans Wi-Fi¬ª un ticke...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Passerelle pour UDP entre Wi-Fi et LoRa</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/482080/"><h1 id="delaem-shlyuz-mezhdu-wi-fi-i-lora-dlya-udp">  Nous faisons la passerelle entre le Wi-Fi et LoRa pour UDP </h1><br><p><img src="https://habrastorage.org/webt/7r/6w/qs/7r6wqsteous5ebxb2pjrlplmqbm.png"></p><br><p>  J'ai eu un r√™ve d'enfance: donner √† chaque appareil domestique ¬´sans Wi-Fi¬ª un ticket r√©seau, c'est-√†-dire une adresse IP et un port.  Apr√®s un certain temps, j'ai r√©alis√© que je ne devais pas le remettre.  Nous devons prendre et faire. </p><br><h2 id="tehnicheskoe-zadanie">  Mandat </h2><br><p>  Faites-en une passerelle M5Stack avec le module LoRa install√© (Figure 1).  La passerelle sera connect√©e √† un r√©seau Wi-Fi dans lequel obtenir une adresse IP locale via DHCP.  La passerelle diffusera son nom en LoRa-√©ther avec une certaine fr√©quence (analogique du SSID pour le Wi-Fi) et la gamme de ports acceptables afin que les autres appareils sachent qu'il existe un tel r√©seau auquel vous pouvez vous connecter et dans quelle plage vous pouvez s√©lectionner un port libre.  Puisque ce sera un prototype, l'authentification n'est pas cette fois.  Les nouveaux appareils clients trouveront un r√©seau LoRa disponible et lui transmettront le port s√©lectionn√©.  Une fois que la passerelle a re√ßu un port d'un nouveau client, elle v√©rifie s'il est libre, si c'est le cas, elle enregistre un nouveau client et commence √† √©couter ce port sur son propre serveur UDP asynchrone.  Apr√®s l'enregistrement, le client recevra le consentement ou le refus d'utiliser le port d√©clar√©.  La proc√©dure de fonctionnement est indiqu√©e dans le tableau 1. </p><br><p><img src="https://habrastorage.org/webt/cz/am/ab/czamabsepozwcixjn0rdwe7hmw8.png"><br>  Figure 1 </p><br><p>  Tableau 1 </p><br><div class="scrollable-table"><table><thead><tr><th>  c√¥t√© </th><th>  direction et donn√©es </th><th>  c√¥t√© </th><th>  la session </th></tr></thead><tbody><tr><td>  [client] </td><td>  &lt;- signal de balise - </td><td>  [passerelle] </td><td>  0xA1 </td></tr><tr><td>  [client] </td><td>  - port s√©lectionn√© -&gt; </td><td>  [passerelle] </td><td>  0xB1 </td></tr><tr><td>  [client] </td><td>  &lt;- consentement ou refus - </td><td>  [passerelle] </td><td>  0xA2 </td></tr><tr><td>  [client] </td><td>  - Pack UPD -&gt; </td><td>  [passerelle] </td><td>  0xB2 </td></tr><tr><td>  [client] </td><td>  &lt;- Package UPD - </td><td>  [passerelle] </td><td>  0xA3 </td></tr><tr><td>  [r√©seau] </td><td>  &lt;- Package UPD - </td><td>  [passerelle] </td><td>  0xC1 </td></tr></tbody></table></div><br><p>  Devant moi sur la table sont toutes sortes de modules pour le M5Stack et s'ennuient.  Prenons LoR <del>  et amusez-vous avec elle </del>  .  Le concept du module lui-m√™me est magnifique!  Que puis-je dire?  Mais, les modules de ma premi√®re r√©vision, dans lesquels une terrible antenne int√©gr√©e, faite sur une carte de circuit imprim√© flexible et coll√©e sur la paroi lat√©rale du bo√Ætier.  J'ai d√©j√† effectu√© des tests sur le terrain de ces modules (vous pouvez le regarder sur la cha√Æne en russe sur YouTube): </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/2mWAu6X_v-U" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  Naturellement, j'ai d√ª retirer ces rudiments et souder les antennes h√©lico√Ødales standard fournies avec le Ra-01.  Apr√®s une telle personnalisation, la port√©e de communication s'est sensiblement am√©lior√©e, mais un point lat√©ral est apparu - l'antenne a un diam√®tre sup√©rieur √† la distance autoris√©e entre les modules.  J'ai d√ª abandonner le module Final pour la dur√©e du projet. </p><a name="habracut"></a><br><h2 id="pervye-trudnosti-ot-sihronnoy-tugosti">  Premi√®res difficult√©s <del>  de l'√©tanch√©it√© synchronique </del></h2><br><p>  Il semblerait que prendre la biblioth√®que <strong>WiFiUdp.h</strong> , o√π tout est pour l'existence confortable d'un serveur UDP, non.  La biblioth√®que est con√ßue pour soulever un serveur synchrone qui, malheureusement, ne peut pas servir plusieurs connexions en m√™me temps.  Une telle biblioth√®que n'est pas adapt√©e √† la t√¢che en cours.  J'ai d√ª boire beaucoup de tasses de th√© et chercher une biblioth√®que qui nous permettrait d'√©lever un serveur UDP asynchrone capable de prendre en charge de nombreuses connexions en m√™me temps.  Une telle biblioth√®que a √©t√© trouv√©e - <strong>AsyncUDP.h</strong> .  Quelle est la diff√©rence entre un serveur synchrone et un serveur asynchrone?  Jetons un coup d'≈ìil √† six √©pisodes de la figure 2, dans lesquels les options de fonctionnement du socket sont affich√©es de mani√®re triviale. </p><br><p><img src="https://habrastorage.org/webt/fa/ay/fv/faayfvfxtqvi8nu5s_ks4ssbava.jpeg"></p><br><p>  Figure 2 </p><br><p>  Avec: </p><br><p>  <strong>Un homme</strong> dans le r√¥le d'une <strong>prise</strong> ; </p><br><p>  <strong>Dove</strong> dans le r√¥le de <strong>Compound</strong> ; </p><br><p>  <strong>Pismo</strong> comme <strong>donn√©es</strong> . </p><br><h3 id="epizod-a-sinhronnyy-soket-bez-taymauta">  √âpisode A. Prise synchrone sans timeout </h3><br><p>  Une personne restera debout jusqu'√† ce que la colombe lui apporte une lettre. </p><br><h3 id="epizod-b-sinhronnyy-soket-s-taymautom">  √âpisode B. Prise synchrone avec timeout </h3><br><p>  Un homme attend l'heure convenue avec la Colombe, et s'il n'arrive pas √† l'heure, l'homme partira. </p><br><h3 id="epizod-c-sinhronnyy-soket-s-mnogopotochnostyu">  √âpisode C. Prise multithreading synchrone </h3><br><p>  Un homme lounges et regarde comme les pigeons livrent des lettres de leur propre chef. </p><br><h3 id="epizod-d-asinhronnyy-soket-kogda-nechego-eschyo-poluchat">  √âpisode D. Prise asynchrone (quand il n'y a rien d'autre √† recevoir) </h3><br><p>  Un homme fait ses choses pr√©f√©r√©es, mais n'oublie pas les pigeons. </p><br><h3 id="epizod-e-asinhronnyy-soket-kogda-est-chto-poluchit">  √âpisode E. Prise asynchrone (quand il y a quelque chose √† recevoir) </h3><br><p>  L'homme s'est bri√®vement distrait de ses affaires pour recevoir une lettre de la colombe. </p><br><h3 id="epizod-f-asinhronnyy-soket-s-mnogopotochnostyu">  √âpisode F. Prise multithreading asynchrone </h3><br><p>  Un homme vaquer √† ses occupations et regarde les Pigeons livrer des lettres par eux-m√™mes. </p><br><p>  Si vous avez fait attention, vous auriez probablement d√ª remarquer que les colliers des Pigeons dans chaque √©pisode ont une certaine couleur.  Et ce n'est pas un hasard.  Dans les √©pisodes A et B, un seul socket fonctionne sur le serveur et c'est tout.  L'√©pisode C a d√©j√† deux prises.  Les √©pisodes D, E et F ont d√©j√† trois prises.  "Pourquoi y en a-t-il deux, mais en voici trois?"  - demandez-vous.  Ceci est conditionnellement 2 et 3, en fait, au lieu de 2, il peut √™tre de 20 et au lieu de trois 200. La t√¢che consiste √† montrer que les sockets asynchrones ne br√ªlent pas autant le fer que les synchrones. </p><br><h2 id="kuda-skolko-chego-vmeschaetsya">  O√π va quoi? </h2><br><p>  Regardons le tableau 1, qui montre la structure du paquet UDP et r√©fl√©chissons √† ce que vous pouvez faire √† ce sujet. </p><br><p>  Tableau 1. Structure des paquets UDP </p><br><div class="scrollable-table"><table><thead><tr><th>  Bits </th><th>  0 - 15 </th><th>  16 - 31 </th></tr></thead><tbody><tr><td>  0-31 </td><td>  Port source </td><td>  Port de destination </td></tr><tr><td>  32-63 </td><td>  Longueur du datagramme </td><td>  Somme de contr√¥le </td></tr><tr><td>  64 -... </td><td>  Les donn√©es </td><td></td></tr></tbody></table></div><br><p>  Ajoutez un autre champ <strong>Session</strong> (1 octet) au tout d√©but de ce tableau.  C'est suffisant pour ce projet.  En fonction de la session, l'appareil saura quoi faire avec le package suivant.  Nous allons maintenant trouver des codes pour les sessions et les √©crire dans le tableau 2. </p><br><p>  Tableau 2. Description de la session </p><br><div class="scrollable-table"><table><thead><tr><th>  Code </th><th>  Le titre </th><th>  Explication </th></tr></thead><tbody><tr><td>  0xA1 </td><td>  Phare </td><td>  La passerelle diffuse le nom du r√©seau LoRa et la gamme de ports autoris√©s avec une certaine fr√©quence.  Cela est n√©cessaire pour que les nouveaux clients voient le r√©seau disponible et que les clients actuels, lorsqu'il n'y a pas de transmission, puissent d√©terminer le niveau du signal. </td></tr><tr><td>  0xB1 </td><td>  Candidature </td><td>  Lorsque le client trouve le r√©seau, il envoie le port pr√©f√©r√©. </td></tr><tr><td>  0xA2 </td><td>  Consentement ou refus </td><td>  Si le port demand√© par le client est libre, le serveur r√©pond par consentement et sinon par refus. </td></tr><tr><td>  0xB2 </td><td>  Lien vers le haut </td><td>  Lorsque le client envoie le paquet UDP √† la passerelle. </td></tr><tr><td>  0xA3 </td><td>  Lien vers le bas </td><td>  Lorsque la passerelle envoie le paquet UDP au client. </td></tr><tr><td>  0xC1 </td><td>  Continu Up-Link </td><td>  Lorsque la passerelle envoie un paquet UDP au r√©seau local. </td></tr></tbody></table></div><br><p>  Bon.  Voyons maintenant la composition des sessions dans le tableau 3. </p><br><p>  Tableau 3. Sessions </p><br><div class="scrollable-table"><table><thead><tr><th>  Nom de la session </th><th>  La composition </th></tr></thead><tbody><tr><td>  Phare </td><td>  Code de session (1 octet) + nom du r√©seau LoRa (4 octets) + port de d√©but (2 octets) + port de fin (2 octets) </td></tr><tr><td>  Candidature </td><td>  Code de transfert (1 octet) + nom du r√©seau LoRa (4 octets) + port pr√©f√©r√© (2 octets) </td></tr><tr><td>  Consentement ou refus </td><td>  Code de transmission (1 octet) + nom du r√©seau LoRa (4 octets) + port pr√©f√©r√© (2 octets) + r√©sultat (1 octet) </td></tr><tr><td>  Lien vers le haut </td><td>  Code de transmission (1 octet) + nom du r√©seau LoRa (4 octets) + adresse IP distante (4 octets) + port distant (2 octets) + adresse IP locale (4 octets) + port local (2 octets) + taille des donn√©es (2 octets) + donn√©es </td></tr><tr><td>  Lien vers le bas </td><td>  Code de transmission (1 octet) + nom du r√©seau LoRa (4 octets) + adresse IP distante (4 octets) + port distant (2 octets) + adresse IP locale (4 octets) + port local (2 octets) + taille des donn√©es (2 octets) + donn√©es </td></tr><tr><td>  Continu Up-Link </td><td>  Adresse IP distante (4 octets) + port distant (2 octets) + taille des donn√©es (2 octets) + donn√©es </td></tr></tbody></table></div><br><p>  A √©crit deux clients pour Arduino et pour M5Stack.  Vous pouvez voir comment cela fonctionne dans la <a href="https://youtu.be/g4aHpgWcJnY" rel="nofollow">vid√©o</a> .  Il n'y a aucun probl√®me dans l'appartement, je n'ai pas encore fait de tests sur le terrain. </p><br><p>  Le code source est disponible sur GitHub √† l'adresse </p><br><p>  En savoir plus sur l'unit√© de base M5Stack et acheter <a href="http://ru.m5stack.com/%3Fsearch%3D%25D0%25BA%25D0%25BB%25D0%25B0%25D1%2581%25D1%2581%25D0%25B8%25D1%2587%25D0%25B5%25D1%2581%25D0%25BA%25D0%25B8%25D0%25B9" rel="nofollow">ici.</a> </p><br><p>  Vous pouvez s√©lectionner les modules sans fil LoRa pour l'unit√© de base <a href="http://ru.m5stack.com/%3Fsearch%3Dlora" rel="nofollow">ici</a> </p><br><p>  <strong>Je serai heureux si ce projet vous est utile.</strong>  <strong>Merci beaucoup pour votre temps!</strong> </p><br><p>  R√©f√©rences et (ou) sources: </p><br><ul><li>  <a href="https://qna.habr.com/q/388343" rel="nofollow">Habr Q&amp;A "Qu'est-ce qu'un socket asynchrone?"</a> </li><li>  <a href="https://ru.wikipedia.org/wiki/UDP" rel="nofollow">Wikip√©dia "UDP"</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr482080/">https://habr.com/ru/post/fr482080/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr482066/index.html">Remplacer la User Story par la Job Story</a></li>
<li><a href="../fr482068/index.html">Dois-je cr√©er une matrice RAID √† partir d'un SSD et quels contr√¥leurs sont n√©cessaires pour cela</a></li>
<li><a href="../fr482070/index.html">Cinq habitudes qui aident √† maintenir les performances c√©r√©brales</a></li>
<li><a href="../fr482076/index.html">Clients, faites confiance √† asoshnikov</a></li>
<li><a href="../fr482078/index.html">Risques des projets informatiques et des √©quipes informatiques</a></li>
<li><a href="../fr482084/index.html">Que lire en vacances</a></li>
<li><a href="../fr482086/index.html">Analyse de Bootkit</a></li>
<li><a href="../fr482088/index.html">Hugge pour les d√©veloppeurs, ou comment je suis all√© √† KotlinConf</a></li>
<li><a href="../fr482092/index.html">De quoi les aveugles ont-ils besoin? Revue de l'expert sourd-aveugle Sergei Fleitin</a></li>
<li><a href="../fr482094/index.html">Architecte logiciel: pourquoi est-il n√©cessaire et quelle est sa mal√©diction</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>