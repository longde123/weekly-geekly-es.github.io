<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üéÜ üë®üèø‚Äçüç≥ üë©üèæ‚Äç‚öïÔ∏è C√≥mo se admite Java 8 en Android üå´Ô∏è üòè üèÇ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hola Habr! Les traigo a su atenci√≥n una traducci√≥n de un maravilloso art√≠culo de una serie de art√≠culos del famoso Jake Worton sobre c√≥mo Android 8 es...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>C√≥mo se admite Java 8 en Android</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tinkoff/blog/478692/">  Hola Habr!  Les traigo a su atenci√≥n una traducci√≥n de un maravilloso art√≠culo de una serie de art√≠culos del <a href="https://twitter.com/JakeWharton%3Flang%3Den">famoso Jake Worton</a> sobre c√≥mo Android 8 es compatible con Java. <br><br><img src="https://habrastorage.org/webt/ho/ap/qe/hoapqe-nhkwts3ekeettjbuiao8.png"><br><br>  <font color="#0000ff"><a href="https://jakewharton.com/androids-java-8-support/">El art√≠culo original est√° aqu√≠.</a></font> <br><a name="habracut"></a><br>  Trabaj√© desde casa durante varios a√±os, y a menudo escuch√© a mis colegas quejarse de que Android admite diferentes versiones de Java. <br><br>  Este es un tema bastante complicado.  Primero debe decidir a qu√© nos referimos con "soporte Java en Android", porque en una versi√≥n del lenguaje puede haber muchas cosas: caracter√≠sticas (lambdas, por ejemplo), c√≥digo de bytes, herramientas, API, JVM, etc. <br><br>  Cuando las personas hablan sobre la compatibilidad con Java 8 en Android, generalmente se refieren a la compatibilidad con las caracter√≠sticas del lenguaje.  Entonces, comencemos con ellos. <br><br><h2>  Lambdas </h2><br>  Una de las principales innovaciones de Java 8 fue lambdas. <br>  El c√≥digo se ha vuelto m√°s conciso y simple, las lambdas nos han salvado de la necesidad de escribir clases an√≥nimas voluminosas utilizando una interfaz con un √∫nico m√©todo en su interior. <br><br><pre><code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Java8</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Logger</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">log</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String s)</span></span></span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String... args)</span></span></span><span class="hljs-function"> </span></span>{ sayHi(s -&gt; System.out.println(s)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sayHi</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Logger logger)</span></span></span><span class="hljs-function"> </span></span>{ logger.log(<span class="hljs-string"><span class="hljs-string">"Hello!"</span></span>); } }</code> </pre> <br>  Despu√©s de compilar esto usando javac y la <code>dx tool</code> heredada, obtenemos el siguiente error: <br><br><pre> <code class="plaintext hljs">$ javac *.java $ ls Java8.java Java8.class Java8$Logger.class $ $ANDROID_HOME/build-tools/28.0.2/dx --dex --output . *.class Uncaught translation error: com.android.dx.cf.code.SimException: ERROR in Java8.main:([Ljava/lang/String;)V: invalid opcode ba - invokedynamic requires --min-sdk-version &gt;= 26 (currently 13) 1 error; aborting</code> </pre> <br>  Este error se produce debido al hecho de que las lambdas usan una nueva instrucci√≥n en el <code>invokedynamic</code> : <code>invokedynamic</code> , que se agreg√≥ en Java 7. Del texto de error puede ver que Android solo lo admite a partir de la API 26 (Android 8). <br><br>  No suena muy bien, porque casi nadie lanzar√° una aplicaci√≥n con 26 minApi.  Para evitar esto, se <i>utiliza el</i> llamado proceso de <i>desugaring</i> , que hace posible el soporte lambda en todas las versiones de la API. <br><br><h2>  Historia de la desacarizaci√≥n </h2><br>  Ella es muy colorida en el mundo de Android.  El objetivo de la desaccharizaci√≥n es siempre el mismo: permitir que las nuevas funciones de lenguaje funcionen en todos los dispositivos. <br><br>  Inicialmente, por ejemplo, para admitir lambdas en Android, los desarrolladores conectaron el complemento <a href="https://github.com/evant/gradle-retrolambda">Retrolambda</a> .  Utiliz√≥ el mismo mecanismo incorporado que la JVM, convirtiendo lambdas a clases, pero lo hizo en tiempo de ejecuci√≥n y no en tiempo de compilaci√≥n.  Las clases generadas eran muy caras en t√©rminos de la cantidad de m√©todos, pero con el tiempo, despu√©s de mejoras y mejoras, este indicador disminuy√≥ a algo m√°s o menos razonable. <br><br>  Luego, el equipo de Android <a href="https://android-developers.googleblog.com/2014/12/hello-world-meet-our-new-experimental.html">anunci√≥ un nuevo compilador</a> que admit√≠a todas las caracter√≠sticas de Java 8 y era m√°s productivo.  Fue construido sobre el compilador Eclipse Java, pero en lugar de generar un c√≥digo de bytes Java, gener√≥ un c√≥digo de bytes Dalvik.  Sin embargo, su rendimiento a√∫n dejaba mucho que desear. <br><br>  Cuando se abandon√≥ el nuevo compilador (afortunadamente), el transformador de bytecode de Java en el bytecode de Java, que hizo el malabarismo, <a href="https://android-developers.googleblog.com/2017/04/java-8-language-features-support-update.html">se integr√≥ en el complemento Android Gradle</a> de <a href="https://docs.bazel.build/versions/master/bazel-and-android.html">Bazel</a> , el sistema de compilaci√≥n de Google.  Y su rendimiento a√∫n era bajo, por lo que la b√∫squeda de una mejor soluci√≥n continu√≥ en paralelo. <br><br>  Y ahora nos <a href="https://android-developers.googleblog.com/2017/08/next-generation-dex-compiler-now-in.html"><code>  dexer</code></a> : <i>D8</i> , que supuestamente reemplazar√≠a la <code>dx tool</code> .  La desaccharizaci√≥n ahora se realiz√≥ durante la conversi√≥n de archivos JAR compilados a <code>.dex</code> (dexing).  D8 es mucho mejor en rendimiento en comparaci√≥n con <code>dx</code> , y desde Android Gradle Plugin 3.1 se ha convertido en el dexer predeterminado. <br><br><h2>  D8 </h2><br>  Ahora, usando D8, podemos compilar el c√≥digo anterior. <br><br><pre> <code class="plaintext hljs">$ java -jar d8.jar \ --lib $ANDROID_HOME/platforms/android-28/android.jar \ --release \ --output . \ *.class $ ls Java8.java Java8.class Java8$Logger.class classes.dex</code> </pre> <br>  Para ver c√≥mo el D8 convirti√≥ lambda, puede usar la <code>dexdump tool</code> , que se incluye en el SDK de Android.  Mostrar√° bastante de todo, pero nos centraremos solo en esto: <br><br><pre> <code class="plaintext hljs">$ $ANDROID_HOME/build-tools/28.0.2/dexdump -d classes.dex [0002d8] Java8.main:([Ljava/lang/String;)V 0000: sget-object v0, LJava8$1;.INSTANCE:LJava8$1; 0002: invoke-static {v0}, LJava8;.sayHi:(LJava8$Logger;)V 0005: return-void [0002a8] Java8.sayHi:(LJava8$Logger;)V 0000: const-string v0, "Hello" 0002: invoke-interface {v1, v0}, LJava8$Logger;.log:(Ljava/lang/String;)V 0005: return-void ‚Ä¶</code> </pre> <br>  Si a√∫n no ha le√≠do el c√≥digo de bytes, no se preocupe: gran parte de lo que est√° escrito aqu√≠ puede entenderse intuitivamente. <br><br>  En el primer bloque, nuestro m√©todo <code>main</code> con el √≠ndice <code>0000</code> obtiene una referencia del campo <code>INSTANCE</code> a la clase <code>INSTANCE</code> <code>Java8$1</code> .  Esta clase se gener√≥ durante la <code></code> .  El <code>Java8$1</code> m√©todo principal tampoco contiene ninguna menci√≥n del cuerpo de nuestro lambda, por lo tanto, lo m√°s probable es que est√© asociado con la clase <code>Java8$1</code> .  El √≠ndice <code>0002</code> llama al m√©todo est√°tico <code>sayHi</code> usando el enlace a <code>INSTANCE</code> .  El <code>sayHi</code> requiere <code>Java8$Logger</code> , por lo que parece que <code>Java8$1</code> implementa esta interfaz.  Podemos verificar esto aqu√≠: <br><br><pre> <code class="plaintext hljs">Class #2 - Class descriptor : 'LJava8$1;' Access flags : 0x1011 (PUBLIC FINAL SYNTHETIC) Superclass : 'Ljava/lang/Object;' Interfaces - #0 : 'LJava8$Logger;'</code> </pre> <br>  El indicador <code>SYNTHETIC</code> significa que <code>Java8$1</code> ha generado la clase <code>Java8$1</code> y la lista de interfaces que incluye contiene el <code>Java8$Logger</code> . <br>  Esta clase representa nuestra lambda.  Si observa la implementaci√≥n del m√©todo de <code>log</code> , no ver√° el cuerpo de la lambda. <br><br><pre> <code class="plaintext hljs">‚Ä¶ [00026c] Java8$1.log:(Ljava/lang/String;)V 0000: invoke-static {v1}, LJava8;.lambda$main$0:(Ljava/lang/String;)V 0003: return-void ‚Ä¶</code> </pre> <br>  En cambio, el m√©todo <code>static</code> de la clase <code>Java8</code> se <code>Java8</code> - <code>lambda$main$0</code> .  Repito, este m√©todo se presenta solo en bytecode. <br><br><pre> <code class="plaintext hljs">‚Ä¶ #1 : (in LJava8;) name : 'lambda$main$0' type : '(Ljava/lang/String;)V' access : 0x1008 (STATIC SYNTHETIC) [0002a0] Java8.lambda$main$0:(Ljava/lang/String;)V 0000: sget-object v0, Ljava/lang/System;.out:Ljava/io/PrintStream; 0002: invoke-virtual {v0, v1}, Ljava/io/PrintStream;.println:(Ljava/lang/String;)V 0005: return-void</code> </pre> <br>  El indicador <code>SYNTHETIC</code> nuevamente nos dice que este m√©todo fue generado, y su bytecode solo contiene el cuerpo lambda: una llamada a <code>System.out.println</code> .  La raz√≥n por la que el cuerpo lambda est√° dentro de <i>Java8.class</i> es simple: puede necesitar acceso a miembros <code>private</code> de la clase, a los que la clase generada no tendr√° acceso. <br><br>  Todo lo que necesita para comprender c√≥mo funciona la <i>desaccharizaci√≥n</i> se describe anteriormente.  Sin embargo, al mirarlo en el c√≥digo de bytes de Dalvik, puede ver que todo es mucho m√°s complicado y aterrador all√≠. <br><br><h2>  Transformaci√≥n de fuente </h2><br>  Para comprender mejor c√≥mo se produce la <i>desacrasificaci√≥n</i> , intentemos paso a paso convertir nuestra clase en algo que funcione en todas las versiones de la API. <br><br>  Tomemos la misma clase con lambda como base: <br><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Java8</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Logger</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">log</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String s)</span></span></span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String... args)</span></span></span><span class="hljs-function"> </span></span>{ sayHi(s -&gt; System.out.println(s)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sayHi</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Logger logger)</span></span></span><span class="hljs-function"> </span></span>{ logger.log(<span class="hljs-string"><span class="hljs-string">"Hello!"</span></span>); } }</code> </pre> <br>  Primero, el cuerpo lambda se mueve al m√©todo <code>package private</code> del <code>package private</code> . <br><br><pre> <code class="diff hljs"> public static void main(String... args) { - sayHi(s -&gt; System.out.println(s)); + sayHi(s -&gt; lambda$main$0(s)); } + + static void lambda$main$0(String s) { + System.out.println(s); + }</code> </pre> <br>  Luego se implementa una clase que implementa la interfaz <code>Logger</code> , dentro de la cual se ejecuta un bloque de c√≥digo del cuerpo lambda. <br><br><pre> <code class="diff hljs"> public static void main(String... args) { - sayHi(s -&gt; lambda$main$0(s)); + sayHi(new Java8$1()); } @@ } + +class Java8$1 implements Java8.Logger { + @Override public void log(String s) { + Java8.lambda$main$0(s); + } +}</code> </pre> <br>  A continuaci√≥n, <code>Java8$1</code> una instancia singleton de <code>Java8$1</code> , que se almacena en la variable <code>static</code> <code>INSTANCE</code> . <br><br><pre> <code class="diff hljs"> public static void main(String... args) { - sayHi(new Java8$1()); + sayHi(Java8$1.INSTANCE); } @@ class Java8$1 implements Java8.Logger { + static final Java8$1 INSTANCE = new Java8$1(); + @Override public void log(String s) {</code> </pre> <br>  Aqu√≠ est√° la clase <i>doblada</i> final que se puede usar en todas las versiones de la API: <br><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Java8</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Logger</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">log</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String s)</span></span></span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String... args)</span></span></span><span class="hljs-function"> </span></span>{ sayHi(Java8$<span class="hljs-number"><span class="hljs-number">1</span></span>.INSTANCE); } <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> lambda$main$<span class="hljs-number"><span class="hljs-number">0</span></span>(String s) { System.out.println(s); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sayHi</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Logger logger)</span></span></span><span class="hljs-function"> </span></span>{ logger.log(<span class="hljs-string"><span class="hljs-string">"Hello!"</span></span>); } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Java8</span></span></span><span class="hljs-class">$1 </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Java8</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Logger</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Java8$<span class="hljs-number"><span class="hljs-number">1</span></span> INSTANCE = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Java8$<span class="hljs-number"><span class="hljs-number">1</span></span>(); <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">log</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String s)</span></span></span><span class="hljs-function"> </span></span>{ Java8.lambda$main$<span class="hljs-number"><span class="hljs-number">0</span></span>(s); } }</code> </pre> <br>  Si observa la clase generada en el c√≥digo de bytes de Dalvik, no encontrar√° nombres como Java8 $ 1; habr√° algo como <code>-$$Lambda$Java8$QkyWJ8jlAksLjYziID4cZLvHwoY</code> .  La raz√≥n por la cual se genera ese nombre para la clase, y cu√°les son sus ventajas, se basa en un art√≠culo separado. <br><br><h2>  Soporte lambda nativo </h2><br>  Cuando utilizamos la <code>dx tool</code> para compilar una clase que contiene lambdas, un mensaje de error dec√≠a que esto solo funcionar√≠a con 26 API. <br><br><pre> <code class="plaintext hljs">$ $ANDROID_HOME/build-tools/28.0.2/dx --dex --output . *.class Uncaught translation error: com.android.dx.cf.code.SimException: ERROR in Java8.main:([Ljava/lang/String;)V: invalid opcode ba - invokedynamic requires --min-sdk-version &gt;= 26 (currently 13) 1 error; aborting</code> </pre> <br>  Por lo tanto, parece l√≥gico que si tratamos de compilar esto con el <code>‚Äîmin-api 26</code> , no se produzca la desacarizaci√≥n. <br><br><pre> <code class="bash hljs">$ java -jar d8.jar \ --lib <span class="hljs-variable"><span class="hljs-variable">$ANDROID_HOME</span></span>/platforms/android-28/android.jar \ --release \ --min-api 26 \ --output . \ *.class</code> </pre> <br>  Sin embargo, si <code>.dex</code> archivo <code>.dex</code> , a√∫n se puede encontrar en √©l <code>-$$Lambda$Java8$QkyWJ8jlAksLjYziID4cZLvHwoY</code> .  Por qu√©  ¬øEs esto un error D8? <br><br>  Para responder a esta pregunta, y tambi√©n por qu√© <i>siempre se produce la</i> desaccharizaci√≥n, debemos mirar dentro del <code>Java8</code> de <code>Java8</code> Java de la clase <code>Java8</code> . <br><br><pre> <code class="bash hljs">$ javap -v Java8.class class Java8 { public static void main(java.lang.String...); Code: 0: invokedynamic <span class="hljs-comment"><span class="hljs-comment">#2, 0 // InvokeDynamic #0:log:()LJava8$Logger; 5: invokestatic #3 // Method sayHi:(LJava8$Logger;)V 8: return } ‚Ä¶</span></span></code> </pre> <br>  Dentro del m√©todo <code>main</code> , nuevamente vemos <i>invocados din√°micamente</i> en el √≠ndice <code>0</code> .  El segundo argumento en la llamada es <code>0</code> : el √≠ndice del m√©todo de <a href="https://stackoverflow.com/questions/30733557/what-is-a-bootstrap-method">arranque</a> asociado con √©l. <br><br>  Aqu√≠ hay una lista de m√©todos de <i>arranque</i> : <br><br><pre> <code class="plaintext hljs">‚Ä¶ BootstrapMethods: 0: #27 invokestatic java/lang/invoke/LambdaMetafactory.metafactory:( Ljava/lang/invoke/MethodHandles$Lookup;Ljava/lang/String; Ljava/lang/invoke/MethodType;Ljava/lang/invoke/MethodType; Ljava/lang/invoke/MethodHandle;Ljava/lang/invoke/MethodType;) Ljava/lang/invoke/CallSite; Method arguments: #28 (Ljava/lang/String;)V #29 invokestatic Java8.lambda$main$0:(Ljava/lang/String;)V #28 (Ljava/lang/String;)V</code> </pre> <br>  Aqu√≠ el m√©todo <i>bootstrap</i> se llama <code>metafactory</code> en la clase <code>java.lang.invoke.LambdaMetafactory</code> .  <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/invoke/LambdaMetafactory.html">Vive en el JDK</a> y crea clases an√≥nimas sobre la marcha en tiempo de ejecuci√≥n para lambdas, al igual que D8 las genera en el tiempo de c√°lculo. <br><br>  Si nos fijamos en la <a href="https://developer.android.com/reference/java/lang/invoke/package-summary"><code> Android  java.lang.invoke</code></a> <br>  o a las <a href="https://android.googlesource.com/platform/libcore/%2B/master/ojluni/src/main/java/java/lang/invoke/"><code> AOSP  java.lang.invoke</code></a> , vemos que esta clase no est√° en tiempo de ejecuci√≥n.  Es por eso que el malabarismo siempre ocurre en el momento de la compilaci√≥n, sin importar el minApi que tenga.  La VM admite instrucciones de <code>invokedynamic</code> de <code>invokedynamic</code> similares a las <code>invokedynamic</code> , pero el <code>invokedynamic</code> integrado en el JDK no <code>LambdaMetafactory</code> disponible para su uso. <br><br><h2>  Referencias del m√©todo </h2><br>  Junto con lambdas, Java 8 agreg√≥ referencias de m√©todo: esta es una forma efectiva de crear una lambda cuyo cuerpo hace referencia a un m√©todo existente. <br><br>  Nuestra interfaz <code>Logger</code> es solo un ejemplo.  El cuerpo lambda se refer√≠a a <code>System.out.println</code> .  Convirtamos la lambda en un m√©todo de referencia: <br><br><pre> <code class="diff hljs"> public static void main(String... args) { - sayHi(s -&gt; System.out.println(s)); + sayHi(System.out::println); }</code> </pre> <br>  Cuando lo compilamos y echamos un vistazo al c√≥digo de bytes, veremos una diferencia con la versi√≥n anterior: <br><br><pre> <code class="plaintext hljs">[000268] -$$Lambda$1Osqr2Z9OSwjseX_0FMQJcCG_uM.log:(Ljava/lang/String;)V 0000: iget-object v0, v1, L-$$Lambda$1Osqr2Z9OSwjseX_0FMQJcCG_uM;.f$0:Ljava/io/PrintStream; 0002: invoke-virtual {v0, v2}, Ljava/io/PrintStream;.println:(Ljava/lang/String;)V 0005: return-void</code> </pre> <br>  En lugar de llamar al <code>Java8.lambda$main$0</code> generado, que contiene una llamada a <code>System.out.println</code> , ahora se llama directamente a <code>System.out.println</code> . <br><br>  Una clase con un lambda ya no es un singleton <code>static</code> , pero por el √≠ndice <code>0000</code> en el bytecode, vemos que obtenemos un enlace a <code>PrintStream</code> - <code>System.out</code> , que luego se usa para llamar a <code>println</code> en √©l. <br><br>  Como resultado, nuestra clase se convirti√≥ en esto: <br><br><pre> <code class="diff hljs"> public static void main(String... args) { - sayHi(System.out::println); + sayHi(new -$$Lambda$1Osqr2Z9OSwjseX_0FMQJcCG_uM(System.out)); } @@ } + +class -$$Lambda$1Osqr2Z9OSwjseX_0FMQJcCG_uM implements Java8.Logger { + private final PrintStream ps; + + -$$Lambda$1Osqr2Z9OSwjseX_0FMQJcCG_uM(PrintStream ps) { + this.ps = ps; + } + + @Override public void log(String s) { + ps.println(s); + } +}</code> </pre> <br><h2>  M√©todos <code>Default</code> y <code>static</code> en interfaces </h2><br>  Otro cambio importante y importante que trajo Java 8 fue la capacidad de declarar m√©todos <code>default</code> y <code>static</code> en las interfaces. <br><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Logger</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">log</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String s)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">default</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">log</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String tag, String s)</span></span></span><span class="hljs-function"> </span></span>{ log(tag + <span class="hljs-string"><span class="hljs-string">": "</span></span> + s); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Logger </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">systemOut</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> System.out::println; } }</code> </pre> <br>  Todo esto tambi√©n es compatible con D8.  Usando las mismas herramientas que antes, es f√°cil ver una versi√≥n registrada de Logger con m√©todos <code>default</code> y <code>static</code> .  Una de las diferencias con lambdas y <code>method references</code> es que los m√©todos predeterminados y est√°ticos se implementan en la VM de Android y, a partir de las 24 API, D8 no los <i>desacoplar√°</i> . <br><br><h2>  ¬øQuiz√°s solo use Kotlin? </h2><br>  Mientras le√≠an el art√≠culo, la mayor√≠a de ustedes probablemente pens√≥ en Kotlin.  S√≠, admite todas las funciones de Java 8, pero <code>kotlinc</code> implementa de la misma manera que D8, con la excepci√≥n de algunos detalles. <br><br>  Por lo tanto, el soporte de Android para nuevas versiones de Java sigue siendo muy importante, incluso si su proyecto est√° escrito al 100% en Kotlin. <br><br>  Es posible que en el futuro Kotlin ya no admita c√≥digo de bytes Java 6 y Java 7. <a href="https://blog.jetbrains.com/idea/2015/12/intellij-idea-16-eap-144-2608-is-out/">IntelliJ IDEA</a> , Gradle 5.0 cambi√≥ a Java 8. El n√∫mero de plataformas que se ejecutan en JVM m√°s antiguas est√° disminuyendo. <br><br><h2>  Desugaring APIs </h2><br>  Todo este tiempo habl√© sobre las caracter√≠sticas de Java 8, pero no dije nada sobre las nuevas API: transmisiones, <code>CompletableFuture</code> , fecha / hora, etc. <br><br>  Volviendo al ejemplo de Logger, podemos usar la nueva API de fecha / hora para saber cu√°ndo se enviaron los mensajes. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.time.*; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Java8</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Logger</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">log</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(LocalDateTime time, String s)</span></span></span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String... args)</span></span></span><span class="hljs-function"> </span></span>{ sayHi((time, s) -&gt; System.out.println(time + <span class="hljs-string"><span class="hljs-string">" "</span></span> + s)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sayHi</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Logger logger)</span></span></span><span class="hljs-function"> </span></span>{ logger.log(LocalDateTime.now(), <span class="hljs-string"><span class="hljs-string">"Hello!"</span></span>); } }</code> </pre> <br>  <i>Comp√≠lelo</i> nuevamente con <code>javac</code> y convi√©rtalo al bytecode de Dalvik con D8, que lo <i>desacopla</i> para brindar soporte en todas las versiones de la API. <br><br><pre> <code class="plaintext hljs">$ javac *.java $ java -jar d8.jar \ --lib $ANDROID_HOME/platforms/android-28/android.jar \ --release \ --output . \ *.class</code> </pre> <br>  Incluso puede ejecutar esto en su dispositivo para asegurarse de que funciona. <br><br><pre> <code class="plaintext hljs">$ adb push classes.dex /sdcard classes.dex: 1 file pushed. 0.5 MB/s (1620 bytes in 0.003s) $ adb shell dalvikvm -cp /sdcard/classes.dex Java8 2018-11-19T21:38:23.761 Hello</code> </pre> <br>  Si API 26 y superior est√° en este dispositivo, aparecer√° el mensaje Hola.  Si no, veremos lo siguiente: <br><br><pre> <code class="plaintext hljs">java.lang.NoClassDefFoundError: Failed resolution of: Ljava/time/LocalDateTime; at Java8.sayHi(Java8.java:13) at Java8.main(Java8.java:9)</code> </pre> <br>  D8 trat√≥ con lambdas, un m√©todo de referencia, pero no hizo nada para trabajar con <code>LocalDateTime</code> , y esto es muy triste. <br><br>  Los desarrolladores tienen que usar sus propias implementaciones o envoltorios en la API de fecha / hora, o usar bibliotecas como <code>ThreeTenBP</code> para trabajar con el tiempo, pero ¬øpor qu√© no puedes hacer D8 con tus propias manos? <br><br><h2>  Ep√≠logo </h2><br>  La falta de soporte para todas las nuevas API de Java 8 sigue siendo un gran problema en el ecosistema de Android.  Despu√©s de todo, es poco probable que cada uno de nosotros nos permita especificar la API de 26 minutos en nuestro proyecto.  ¬°Las bibliotecas que admiten Android y JVM no pueden permitirse el lujo de utilizar la API que se nos present√≥ hace 5 a√±os! <br><br>  Y a pesar de que el soporte de Java 8 ahora es parte de D8, cada desarrollador debe especificar expl√≠citamente la compatibilidad de origen y destino en Java 8. Si escribe sus propias bibliotecas, puede reforzar esta tendencia al dise√±ar bibliotecas que usen c√≥digo de bytes Java 8 (incluso si no est√° utilizando nuevas funciones de idioma). <br><br>  Se est√° trabajando mucho en D8, por lo que parece que todo estar√° bien en el futuro con soporte para funciones de lenguaje.  Incluso si escribe solo en Kotlin, es muy importante obligar al equipo de desarrollo de Android a admitir todas las nuevas versiones de Java, mejorar el c√≥digo de bytes y las nuevas API. <br><br>  Esta publicaci√≥n es una versi√≥n escrita de mi charla <a href="https://jakewharton.com/digging-into-d8-and-r8/">Excavando en D8 y R8</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/478692/">https://habr.com/ru/post/478692/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../478666/index.html">Tarjeta de sonido USB en YM3812</a></li>
<li><a href="../478670/index.html">C√≥mo los atacantes pueden leer su correspondencia en Telegram. ¬øY c√≥mo pueden prevenirlo?</a></li>
<li><a href="../478672/index.html">Pruebas de IA y puesta en marcha: entrevista con Adam Carmi (Applitools)</a></li>
<li><a href="../478680/index.html">¬øPor qu√©, y lo m√°s importante, a d√≥nde va la gente de TI?</a></li>
<li><a href="../478688/index.html">C√≥mo fue estudiar Data Science en 2019</a></li>
<li><a href="../478696/index.html">C√≥mo visit√© Urban Tech 2019. Informe del evento</a></li>
<li><a href="../478698/index.html">Hacemos un plan de terreno interactivo en 15 minutos.</a></li>
<li><a href="../478702/index.html">Trucos de procesamiento m√©trico en Kapacitor</a></li>
<li><a href="../478704/index.html">Qu√© hacer si los correos ya han llegado a Spam: 5 pasos pr√°cticos</a></li>
<li><a href="../478706/index.html">Arquitecto de alta carga. Nuevo curso de OTUS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>