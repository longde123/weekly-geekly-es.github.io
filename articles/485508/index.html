<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ÜóÔ∏è üìΩÔ∏è üçÑ En el camino hacia un DBMS funcional y NoSQL ERP: almacenamiento de saldos y costos üïú üñ§ üê∂</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hola Habr! 

 Continuamos estudiando la aplicabilidad de los principios de programaci√≥n funcional en el dise√±o de ERP. En el art√≠culo anterior, hablam...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>En el camino hacia un DBMS funcional y NoSQL ERP: almacenamiento de saldos y costos</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/485508/"> Hola Habr! <br><br>  Continuamos estudiando la aplicabilidad de los principios de programaci√≥n funcional en el dise√±o de ERP.  En el <a href="https://habr.com/ru/post/482938/">art√≠culo anterior,</a> hablamos sobre por qu√© esto es necesario, sentamos las bases de la arquitectura y demostramos la construcci√≥n de convoluciones simples usando el ejemplo de una declaraci√≥n inversa.  De hecho, se propone el enfoque de <a href="https://habr.com/ru/post/178259/">abastecimiento de eventos</a> , pero debido a la separaci√≥n de la base de datos en las partes inmutables y mutables, obtenemos en un sistema una combinaci√≥n de las ventajas de un mapa / reducir el almacenamiento y un DBMS en memoria, que resuelve tanto el problema de rendimiento como el problema de escalabilidad.  En este art√≠culo explicar√© (y mostrar√© un prototipo en <a href="https://deno.land/" rel="nofollow">tiempo de ejecuci√≥n de</a> TypeScript y <a href="https://deno.land/" rel="nofollow">Deno</a> ) c√≥mo almacenar registros de saldos instant√°neos en dicho sistema y calcular el costo.  Para aquellos que no han le√≠do el primer art√≠culo, un breve resumen: <br><br>  <b>1. Diario de documentos</b> .  Un ERP construido sobre la base de un RDBMS es un gran estado mutable con acceso competitivo, por lo tanto, no es escalable, d√©bilmente audible y poco confiable en operaci√≥n (permite inconsistencia de datos).  En el ERP funcional, todos los datos se organizan en forma de un diario ordenado cronol√≥gicamente de documentos primarios inmutables, y no hay nada m√°s que estos documentos.  Los enlaces se resuelven de documentos nuevos a documentos antiguos por ID completa (y nunca al rev√©s), y todos los dem√°s datos (saldos, registros, comparaciones) son convoluciones calculadas, es decir, resultados en cach√© de funciones puras en el flujo de documentos.  La falta de estado + audibilidad de las funciones nos brinda una mayor confiabilidad (la cadena de bloques se adapta perfectamente a este esquema), y como beneficio adicional obtenemos una simplificaci√≥n del esquema de almacenamiento + cach√© adaptativo en lugar de duro (organizado en base a tablas). <br><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">As√≠ es como se ve el fragmento de datos en nuestro ERP</b> <div class="spoiler_text"><pre><code class="json hljs">//   { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"person"</span></span>, //  ,      <span class="hljs-attr"><span class="hljs-attr">"key"</span></span>: <span class="hljs-string"><span class="hljs-string">"person.0"</span></span>, //    <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-string"><span class="hljs-string">"person.0^1580006048190"</span></span>, //  +    ID <span class="hljs-attr"><span class="hljs-attr">"erp_type"</span></span>: <span class="hljs-string"><span class="hljs-string">"person.retail"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"   "</span></span> } //  <span class="hljs-string"><span class="hljs-string">""</span></span> { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"purch"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"key"</span></span>: <span class="hljs-string"><span class="hljs-string">"purch.XXX"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-string"><span class="hljs-string">"purch.XXX^1580006158787"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"date"</span></span>: <span class="hljs-string"><span class="hljs-string">"2020-01-21"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"person"</span></span>: <span class="hljs-string"><span class="hljs-string">"person.0^1580006048190"</span></span>, //    <span class="hljs-attr"><span class="hljs-attr">"stock"</span></span>: <span class="hljs-string"><span class="hljs-string">"stock.0^1580006048190"</span></span>, //    <span class="hljs-attr"><span class="hljs-attr">"lines"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"nomen"</span></span>: <span class="hljs-string"><span class="hljs-string">"nomen.0^1580006048190"</span></span>, //    <span class="hljs-attr"><span class="hljs-attr">"qty"</span></span>: <span class="hljs-number"><span class="hljs-number">10000</span></span>, <span class="hljs-attr"><span class="hljs-attr">"price"</span></span>: <span class="hljs-number"><span class="hljs-number">116.62545127448834</span></span> } ] }</code> </pre> </div></div><br>  <b>2. Inmunidad y mutabilidad</b> .  El diario de documentos se divide en 2 partes desiguales: <br><br><ul><li>  La parte grande e <b>inmutable se</b> encuentra en los archivos JSON, est√° disponible para lectura secuencial y se puede copiar a los nodos del servidor, lo que garantiza la concurrencia de la lectura.  Las circunvoluciones calculadas en la parte inmutable se almacenan en cach√©, y hasta el cambio, los puntos de inmunidad tambi√©n permanecen sin cambios (es decir, replicados). </li><li>  La parte <b>mutable</b> m√°s peque√±a son los datos actuales (en t√©rminos de contabilidad, el per√≠odo actual), donde puede editar y cancelar documentos (pero no eliminarlos), insertar y reorganizar relaciones retroactivamente (por ejemplo, hacer coincidir los recibos con los gastos, recalcular los costos, etc. .).  Los datos mutables se cargan en la memoria como un todo, lo que proporciona un c√°lculo de convoluci√≥n r√°pido y un mecanismo transaccional relativamente simple. </li></ul><br>  <b>3. Convoluci√≥n</b> .  Debido a la falta de sem√°ntica JOIN, el lenguaje SQL no es adecuado, y todos los algoritmos est√°n escritos en el estilo funcional de filtro / reducci√≥n, tambi√©n hay activadores (controladores de eventos) para ciertos tipos de documentos.  El c√°lculo de filtro / reducci√≥n se llama convoluci√≥n.  El algoritmo de convoluci√≥n para el desarrollador de la aplicaci√≥n parece un paso completo a trav√©s del diario de documentos, sin embargo, el n√∫cleo realiza la optimizaci√≥n durante la ejecuci√≥n: el resultado intermedio calculado a partir de la parte inmutable se toma del cach√© y luego se "cuenta" desde la parte mutable.  Por lo tanto, a partir del segundo lanzamiento, la convoluci√≥n se calcula completamente en RAM, que toma fracciones de segundo en un mill√≥n de documentos (lo mostraremos con ejemplos).  La convoluci√≥n se cuenta en cada llamada, ya que es muy dif√≠cil rastrear todos los cambios en documentos mutables (enfoque imperativo-reactivo), y los c√°lculos en la RAM son baratos, y el c√≥digo de usuario con este enfoque se simplifica enormemente.  Una convoluci√≥n puede usar los resultados de otras convoluciones, extraer documentos por ID y buscar documentos en la cach√© superior por clave. <br><br>  <b>4. Versiones de documentos y almacenamiento en cach√©</b> .  Cada documento tiene una clave √∫nica y una ID √∫nica (clave + marca de tiempo).  Los documentos con la misma clave se organizan en un grupo, cuyo √∫ltimo registro es actual (actual) y el resto son hist√≥ricos. <br><br>  Un cach√© es todo lo que se puede eliminar y se restaura nuevamente del diario de documentos cuando se inicia la base de datos.  Nuestro sistema tiene 3 cach√©s: <br><br><ul><li>  <b>Cach√© de documentos</b> con acceso de identificaci√≥n.  Por lo general, se trata de directorios y documentos semipermanentes, como los diarios de tasa de gastos.  El atributo de almacenamiento en cach√© (s√≠ / no) est√° vinculado al tipo de documento, el cach√© se inicializa en el primer inicio de la base de datos y luego es compatible con el n√∫cleo. </li><li>  <b>Cach√© superior de documentos</b> con acceso clave.  Almacena las √∫ltimas versiones de entradas de directorio y registros instant√°neos (por ejemplo, saldos y saldos).  El signo de la necesidad de almacenamiento en cach√© superior est√° vinculado al tipo de documento, el n√∫cleo actualiza el cach√© superior al crear / modificar cualquier documento. </li><li>  <b>El cach√© de convoluci√≥n</b> calculado a partir de la parte inmutable de la base de datos es una colecci√≥n de pares clave / valor.  La clave de convoluci√≥n es una representaci√≥n de cadena del c√≥digo del algoritmo + valor inicial serializado del acumulador (en el que se transmiten los par√°metros de c√°lculo de entrada), y el resultado de la convoluci√≥n es el valor final serializado del acumulador (puede ser un objeto o colecci√≥n compleja). </li></ul><br><h4>  Almacenamiento de saldos </h4><br>  Pasamos al tema real del art√≠culo: el almacenamiento de residuos.  Lo primero que viene a la mente es implementar el resto como una convoluci√≥n, cuyo par√°metro de entrada ser√° una combinaci√≥n de analistas (por ejemplo, nomenclatura + almac√©n + lote).  Sin embargo, en ERP debemos considerar el precio de costo, para lo cual es necesario comparar los costos con los saldos (algoritmos FIFO, FIFO por lotes, promedio de almac√©n; en teor√≠a, podemos promediar el costo para cualquier combinaci√≥n de analistas).  En otras palabras, necesitamos el resto como una entidad independiente, y dado que todo es un documento en nuestro sistema, el resto tambi√©n es un documento. <br><br>  El activador genera un documento con el tipo "saldo" en el momento de la publicaci√≥n de l√≠neas de documentos de compra / venta / movimiento, etc.  Balance Key es una combinaci√≥n de analistas, los balances con la misma clave forman un grupo hist√≥rico, cuyo √∫ltimo elemento se almacena en la cach√© superior y est√° disponible al instante.  Los saldos no son contabilizaciones y, por lo tanto, no se resumen: el √∫ltimo registro es relevante y los primeros registros mantienen un historial. <br><br>  El saldo almacena la cantidad en unidades de almacenamiento y la cantidad en la moneda principal, y dividiendo la segunda en la primera, obtenemos el costo instant√°neo en la intersecci√≥n del analista.  Por lo tanto, el sistema almacena no solo el historial completo de los residuos, sino tambi√©n el historial completo de los costos, lo cual es una ventaja para la auditor√≠a de los resultados.  El saldo es liviano, el n√∫mero m√°ximo de saldos es igual al n√∫mero de l√≠neas de documentos (en realidad menor si las l√≠neas se agrupan por combinaci√≥n de analistas), el n√∫mero de registros de saldo superior no depende del volumen de la base de datos y est√° determinado por el n√∫mero de combinaciones de analistas involucrados en el control de saldos y el c√°lculo de costos, por lo que el tama√±o Nuestro cach√© superior siempre es predecible. <br><br><h4>  Publicar consumibles </h4><br>  Inicialmente, los saldos se forman mediante documentos de recibo del tipo de "compra" y se ajustan por cualquier documento de gastos.  Por ejemplo, un activador para un documento de ventas hace lo siguiente: <br><br><ul><li>  extrae el saldo actual del cach√© superior </li><li>  comprueba disponibilidad de cantidad </li><li>  guarda un enlace al saldo actual en la l√≠nea del documento y el costo instant√°neo </li><li>  genera un nuevo balance con una cantidad y cantidad reducidas </li></ul><br>  Un ejemplo de cambio de saldo al vender <br><br><pre> <code class="json hljs">//    { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"bal"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"key"</span></span>: <span class="hljs-string"><span class="hljs-string">"bal|nomen.0|stock.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-string"><span class="hljs-string">"bal|nomen.0|stock.0^1580006158787"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"qty"</span></span>: <span class="hljs-number"><span class="hljs-number">11209</span></span>, //  <span class="hljs-attr"><span class="hljs-attr">"val"</span></span>: <span class="hljs-number"><span class="hljs-number">1392411.5073958784</span></span> //  } //  <span class="hljs-string"><span class="hljs-string">""</span></span> { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"sale"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"key"</span></span>: <span class="hljs-string"><span class="hljs-string">"sale.XXX"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-string"><span class="hljs-string">"sale.XXX^1580006184280"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"date"</span></span>: <span class="hljs-string"><span class="hljs-string">"2020-01-21"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"person"</span></span>: <span class="hljs-string"><span class="hljs-string">"person.0^1580006048190"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"stock"</span></span>: <span class="hljs-string"><span class="hljs-string">"stock.0^1580006048190"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"lines"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"nomen"</span></span>: <span class="hljs-string"><span class="hljs-string">"nomen.0^1580006048190"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"qty"</span></span>: <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-attr"><span class="hljs-attr">"price"</span></span>: <span class="hljs-number"><span class="hljs-number">295.5228788368553</span></span>, //   <span class="hljs-attr"><span class="hljs-attr">"cost"</span></span>: <span class="hljs-number"><span class="hljs-number">124.22263425781769</span></span>, //  <span class="hljs-attr"><span class="hljs-attr">"from"</span></span>: <span class="hljs-string"><span class="hljs-string">"bal|nomen.0|stock.0^1580006158787"</span></span> // - } ] } //    { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"bal"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"key"</span></span>: <span class="hljs-string"><span class="hljs-string">"bal|nomen.0|stock.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-string"><span class="hljs-string">"bal|nomen.0|stock.0^1580006184281"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"qty"</span></span>: <span class="hljs-number"><span class="hljs-number">11189</span></span>, <span class="hljs-attr"><span class="hljs-attr">"val"</span></span>: <span class="hljs-number"><span class="hljs-number">1389927.054710722</span></span> }</code> </pre><br>  C√≥digo de clase de controlador de documentos TypeScript <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Document, DocClass, IDBCore } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../core/DBMeta.ts'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Sale</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DocClass</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> before_add(doc: Document, <span class="hljs-attr"><span class="hljs-attr">db</span></span>: IDBCore): [boolean, string?] { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> err = <span class="hljs-string"><span class="hljs-string">''</span></span> doc.lines.forEach(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">line</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> key = <span class="hljs-string"><span class="hljs-string">'bal'</span></span> + <span class="hljs-string"><span class="hljs-string">'|'</span></span> + db.key_from_id(line.nomen) + <span class="hljs-string"><span class="hljs-string">'|'</span></span> + db.key_from_id(doc.stock) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> bal = db.get_top(key, <span class="hljs-literal"><span class="hljs-literal">true</span></span>) <span class="hljs-comment"><span class="hljs-comment">// true -  ,    - const bal_qty = bal?.qty ?? 0 //   const bal_val = bal?.val ?? 0 //   if (bal_qty &lt; line.qty) { err += '\n"' + key + '": requested ' + line.qty + ' but balance is only ' + bal_qty } else { line.cost = bal_val / bal_qty //     line.from = bal.id } }) return err !== '' ? [false, err] : [true,] } static after_add(doc: Document, db: IDBCore): void { doc.lines.forEach(line =&gt; { const key = 'bal' + '|' + db.key_from_id(line.nomen) + '|' + db.key_from_id(doc.stock) const bal = db.get_top(key, true) const bal_qty = bal?.qty ?? 0 const bal_val = bal?.val ?? 0 db.add_mut( { type: 'bal', key: key, qty: bal_qty - line.qty, val: bal_val - line.cost * line.qty // cost   before_add() } ) }) } }</span></span></code> </pre><br>  Por supuesto, ser√≠a posible no almacenar el costo directamente en las l√≠neas de gastos, sino tomarlo como referencia del balance general, pero el hecho es que los saldos son documentos, hay muchos, es imposible almacenar todo en cach√©, y obtener un documento por ID al leerlo desde el disco es costoso ( c√≥mo indexar archivos secuenciales para un acceso r√°pido: te lo dir√© la pr√≥xima vez). <br><br>  El principal problema que los comentaristas se√±alaron es el rendimiento del sistema, y ‚Äã‚Äãtenemos todo para medirlo en cantidades de datos relativamente relevantes. <br><br><h4>  Generaci√≥n de datos fuente </h4><br>  Nuestro sistema constar√° de <b>5,000</b> contrapartes (proveedores y clientes), <b>3,000</b> art√≠culos, <b>50</b> almacenes y <b>100k</b> documentos de cada tipo: compra, transferencia, venta.  Los documentos se generan aleatoriamente, un promedio de 8.5 l√≠neas por documento.  Las l√≠neas de compra y venta generan una transacci√≥n (y un saldo), y dos l√≠neas de movimiento, lo que da como resultado <b>300k</b> documentos primarios generan aproximadamente <b>3,4 millones de</b> transacciones, lo que es consistente con el volumen mensual de ERP provincial.  Generamos la parte mutable de la misma manera, solo con un volumen de 10 veces menos. <br><br>  Generamos los documentos con un <a href="" rel="nofollow">script</a> .  Comencemos con las compras, durante el resto de los documentos, el activador verificar√° el saldo en la intersecci√≥n del art√≠culo y el almac√©n, y si al menos una l√≠nea no pasa, el script intentar√° generar un nuevo documento.  Los saldos se crean autom√°ticamente por disparadores, el n√∫mero m√°ximo de combinaciones de analistas es igual al n√∫mero de nomenclaturas * n√∫mero de almacenes, es decir  <b>150k.</b> <br><br><h4>  DB y tama√±o de cach√© </h4><br>  Una vez que finalice el script, veremos las siguientes m√©tricas de la base de datos: <br><br><ul><li>  parte inmutable: <b>3.7kk</b> documentos (300k primaria, el resto saldos) - archivo <b>770 Mb</b> </li><li>  parte mutable: <b>370k</b> documentos (30k primaria, saldos restantes) - archivo <b>76 Mb</b> </li><li>  cach√© superior de documentos: <b>158k</b> documentos (referencias + segmento actual de saldos) - archivo <b>20 MB</b> </li><li>  cach√© de documentos: <b>8.8k</b> documentos (solo directorios) - archivo <b>&lt;1 Mb</b> </li></ul><br><h4>  Benchmarking </h4><br>  Inicializaci√≥n de la base.  En ausencia de archivos de cach√©, la base de datos en el primer inicio implementa una exploraci√≥n completa: <br><br><ul><li>  archivo de datos inmutable (cach√©s de relleno para tipos de documentos en cach√©): <b>55 segundos</b> </li><li>  archivo de datos mutables (cargando datos completos en la memoria y actualizando la cach√© superior) - <b>6 segundos</b> </li></ul><br>  Cuando existen cach√©s, elevar la base es m√°s r√°pido: <br><br><ul><li>  archivo de datos mutables - <b>6 segundos</b> </li><li>  archivo de cach√© superior: <b>1,8 segundos</b> </li><li>  otros cach√©s: menos de 1 segundo </li></ul><br>  Cualquier convoluci√≥n del usuario (por ejemplo, tome el <a href="" rel="nofollow">script para</a> construir la hoja de facturaci√≥n) en la primera llamada inicia un escaneo del archivo inmutable, y los datos mutables ya se escanean en la RAM: <br><br><ul><li>  archivo de datos inmutable - <b>55 segundos</b> </li><li>  matriz mutable en memoria - <b>0.2 segundos</b> </li></ul><br>  En llamadas posteriores, cuando los par√°metros de entrada coinciden, <i>reduce ()</i> devolver√° el resultado en <b>0.2 segundos</b> , mientras hace lo siguiente cada vez: <br><br><ul><li>  extraer el resultado del cach√© reducido por clave (teniendo en cuenta los par√°metros) </li><li>  Escaneo de matriz mutable en memoria ( <b>370k</b> documentos) </li><li>  "Contando" el resultado aplicando el algoritmo de convoluci√≥n a documentos filtrados ( <b>20k</b> ) </li></ul><br>  Los resultados son bastante atractivos para tales vol√∫menes de datos, mi computadora port√°til de un solo n√∫cleo, la ausencia total de cualquier DBMS (no olvidemos que esto es solo un prototipo) y un algoritmo de un solo paso en el lenguaje TypeScript (que todav√≠a se considera una opci√≥n fr√≠vola para la empresa) aplicaciones de fondo). <br><br><h4>  Optimizaci√≥n t√©cnica </h4><br>  Despu√©s de examinar el rendimiento del c√≥digo, descubr√≠ que m√°s del 80% del tiempo se pasa leyendo el archivo y analizando Unicode, es decir, <i>File.read ()</i> y <i>TextDecoder (). Decode ()</i> .  Adem√°s, la <a href="" rel="nofollow">interfaz de</a> archivo de alto nivel en Deno es solo as√≠ncrona y, como descubr√≠ <a href="https://habr.com/ru/post/483734/">recientemente</a> , el precio de <i>async / wait es</i> demasiado alto para mi tarea.  Por lo tanto, tuve que escribir mi propio <a href="" rel="nofollow">lector</a> s√≠ncrono, y sin realmente molestarme con las optimizaciones, para aumentar la velocidad de la lectura pura en 3 veces o, si cuenta con el an√°lisis JSON, en 2 veces, al mismo tiempo, de forma global, elimin√© la asincronizaci√≥n.  Quiz√°s esta pieza necesita ser reescrita a bajo nivel (o tal vez todo el proyecto).  Escribir datos en el disco tambi√©n es inaceptablemente lento, aunque esto es menos cr√≠tico para el prototipo. <br><br><h4>  Pasos adicionales </h4><br>  1. Demuestre la implementaci√≥n de los siguientes algoritmos ERP en un estilo funcional: <br><br><ul><li>  gesti√≥n de reservas y necesidades abiertas </li><li>  planificaci√≥n de la cadena de suministro </li><li>  c√°lculo de los costos de producci√≥n teniendo en cuenta los costos generales </li></ul><br>  2. Cambie al formato de almacenamiento binario, quiz√°s esto acelerar√° la lectura del archivo.  O incluso poner todo en Mongo. <br><br>  3. Transfiera FuncDB en modo multiusuario.  De acuerdo con el principio <a href="https://ru.wikipedia.org/wiki/CQRS" rel="nofollow">CQRS</a> , la lectura se realiza directamente por los nodos del servidor en los que se copian archivos de bases de datos inmutables (o se revuelven en la red), y la grabaci√≥n se realiza a trav√©s de un √∫nico punto REST que gestiona datos mutables, cach√©s y transacciones. <br><br>  4. Aceleraci√≥n de la obtenci√≥n de cualquier documento no almacenado en cach√© por ID debido a la indexaci√≥n de archivos secuenciales (que, por supuesto, viola nuestro concepto de algoritmos de paso √∫nico, pero la presencia de cualquier posibilidad siempre es mejor que su ausencia). <br><br><h4>  Resumen </h4><br>  Hasta ahora, no he encontrado una sola raz√≥n para abandonar la idea de un DBMS / ERP funcional, porque a pesar de la no universalidad de tal DBMS para una tarea espec√≠fica (contabilidad y planificaci√≥n), tenemos la oportunidad de obtener un aumento m√∫ltiple en la escalabilidad, audibilidad y confiabilidad del sistema objetivo, todo gracias a la observancia de lo b√°sico principios de FP. <br><br>  <a href="" rel="nofollow"><b>C√≥digo completo del proyecto</b></a> <br><br>  Si alguien quiere jugar solo: <br><br><ul><li>  instalar <a href="https://deno.land/" rel="nofollow">deno</a> </li><li>  clonar el repositorio </li><li>  ejecutar el script de generaci√≥n de base de datos con control de residuos (generate_sample_database_with_balanses.ts) </li><li>  ejecutar scripts de ejemplos 1..4 en la carpeta ra√≠z </li><li>  inventa tu propio ejemplo, codifica, prueba y dame tu opini√≥n </li></ul><br>  PS <br>  La salida de la consola est√° dise√±ada para Linux, tal vez en Windows las secuencias esc no funcionen correctamente, pero no tengo nada que verificar :) <br><br>  Gracias por su atencion </div></div><p>Source: <a href="https://habr.com/ru/post/485508/">https://habr.com/ru/post/485508/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../485494/index.html">Selecciones de fin de semana: lectura ligera para mayores de STEM</a></li>
<li><a href="../485496/index.html">LyX: Observaciones generales. Parte 1</a></li>
<li><a href="../485498/index.html">Ejemplo de aplicaci√≥n reactiva Spring (versi√≥n del 14/01/2020)</a></li>
<li><a href="../485502/index.html">Noticias del mundo de OpenStreetMap No. 495 (01/01/2020 - 13/01/2020)</a></li>
<li><a href="../485504/index.html">Al prohibir el reconocimiento facial, perdemos el punto</a></li>
<li><a href="../485510/index.html">C√≥mo lanzar un producto solo si es desarrollador: Consejos del creador de Laravel, Taylor Otvel. Parte 3: no te rindas</a></li>
<li><a href="../485514/index.html">EBlink - Servidor GDB para microcontroladores ARM Cortex-M</a></li>
<li><a href="../485518/index.html">Intentando componer lo no composable: elevar todo</a></li>
<li><a href="../485520/index.html">QueryFilter: el concepto de filtrado de modelos</a></li>
<li><a href="../485522/index.html">Hack The Box - Tutorial AI. SQLi en API Text To Sreach, SSH Forwarding y RCE en JDWP</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>