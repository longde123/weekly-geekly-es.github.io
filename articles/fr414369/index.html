<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèº üõéÔ∏è üë©üèø‚Äçü§ù‚Äçüë®üèæ Serveur d'impression √† tol√©rance de pannes Windows üöº üõèÔ∏è üî∑</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Un vrai administrateur ne peut dormir paisiblement que lorsque tout est sauvegard√©, surveill√© et dupliqu√©. Ou quand il travaille dans une bonne √©quipe...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Serveur d'impression √† tol√©rance de pannes Windows</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/414369/"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img src="https://habrastorage.org/webt/7x/lk/zl/7xlkzlpjw2oft9qotypwjalwdmy.png"></a> <br>  Un vrai administrateur ne peut dormir paisiblement que lorsque tout est sauvegard√©, surveill√© et dupliqu√©.  <s>Ou quand il travaille dans une bonne √©quipe, o√π vous pouvez toujours bl√¢mer les autres.</s> <br>  Il se trouve que j'utilise principalement des produits Microsoft dans mon travail et je peux dire que la soci√©t√© souhaite s√©rieusement sauvegarder ses services: Active Directory, Exchange DAG, SQL Always On, DFSR, etc.  Comme ailleurs, il existe √† la fois des impl√©mentations tr√®s √©l√©gantes et r√©ussies, ainsi que des impl√©mentations √©videmment g√™nantes et difficiles.  Il existe √©galement une solution pour le service d'impression, mais elle n√©cessite un clustering bas√© sur Hyper-V.  Et je voulais une solution simple ¬´pr√™te √† l'emploi¬ª, qui ne n√©cessite pas de financement suppl√©mentaire.  Windows 2012 R2 a √©t√© pris comme base, mais le m√™me sch√©ma fonctionnera probablement sans probl√®me sur toutes les versions de serveur √† partir de Windows 2008, et m√™me sur les syst√®mes d'exploitation clients de Vista et sup√©rieurs (bonjour aux fans qui √©conomisent le budget!).  Peu importe - je demande un chat. <br><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">Clause de non-responsabilit√©</b> <div class="spoiler_text">  <s>Afin de respecter le travail des Indiens,</s> le public Habr √©tant majoritairement russophone et pour faciliter la t√¢che aux administrateurs d√©butants, les exemples utilisent la version russe de l'interface Windows.  Dans la mesure du possible, les liens m√®nent √©galement √† des ressources en russe. <br></div></div><br><br><h2>  Un peu de th√©orie </h2><br>  Quiconque n'aime pas la th√©orie et souhaite cliquer plus rapidement avec une souris et un clavier peut passer directement √† la partie suivante. <br>  Comme mentionn√© ci-dessus, la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">recommandation officielle</a> aujourd'hui est une solution utilisant le clustering et la virtualisation Hyper-V.  De plus, rien n'emp√™che d'assurer la tol√©rance aux pannes du service d'impression au niveau du syst√®me de virtualisation, et pas forc√©ment Hyper-V, mais de telles solutions co√ªtent cher. <br>  Je voulais vraiment quelque chose de similaire au <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">basculement DHCP</a> , mais pour le r√¥le d'un serveur d'impression. <br>  Rien de convenable n'a √©t√© trouv√© sur Internet en g√©n√©ral et sur le Habr <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">en particulier</a> - et j'ai d√ª l'inventer moi-m√™me. <br><br>  <b>L'essence de l'id√©e dans un paragraphe</b> <br>  La solution d√©crite ci-dessous est bas√©e sur l'utilitaire BrintBrm, qui fait partie de la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">distribution</a> Windows standard <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">et est venu remplacer printmig</a> . <br>  Le serveur de secours fonctionne en mode veille et synchronise les param√®tres avec le serveur principal avec la fr√©quence sp√©cifi√©e √† l'aide de cet utilitaire.  Pour les clients, un CNAME avec un petit TTL a √©t√© cr√©√© dans DNS, r√©f√©ren√ßant le serveur principal.  En cas de d√©faillance du serveur principal, l'administrateur corrige CNAME en basculant les clients vers le serveur de sauvegarde.  En fait, c'est tout. <br>  Si le sujet est int√©ressant et que je veux me familiariser avec les bosses d√©j√† farcies avec moi et les moyens de contourner le r√¢teau, veuillez suivre ensuite. <br><br><h2>  Avant de commencer ou ce que vous devez savoir sur PrintBrm </h2><br>  Alors, quel est-il, cet utilitaire PrintBrm, dont le but principal est de servir le serveur d'impression? <br><ul><li>  Bien entretenu.  Il a une impl√©mentation GUI appel√©e <i>Print Migration</i> et peut √™tre lanc√© √† partir <i>du</i> composant <i>logiciel</i> enfichable <i>Gestion</i> de <i>l'impression</i> .  La version GUI est moins fonctionnelle et a des probl√®mes avec le portage de port. </li><li>  Attentif.  Par d√©faut, il g√®re les listes de contr√¥le d'acc√®s d'imprimante du serveur d'impression.  En d'autres termes, si vous avez autoris√© l'impression sur l'imprimante \\ serveur d'impression \ imprimante1 uniquement aux employ√©s membres du groupe <i>Comptabilit√©</i> AD, cette restriction sera prise en compte pour l'importation / exportation.  Ou pas, si vous mettez la cl√© <i>-NOACL</i> .  Cependant, l'ACL du serveur d'impression lui-m√™me n'est pas trait√© quelle que soit la cl√©. </li><li>  Maugrey.  Au moment d'importer des param√®tres √† partir d'un fichier, le serveur cible doit avoir au moins une imprimante partag√©e, sinon vous obtiendrez une erreur. </li><li>  Doux.  Espaces perdus dans le chemin du fichier.  A la vue des guillemets encadrant un tel chemin, il est <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">contrari√©</a> et donne une erreur 0x8007007b. </li><li>  Modeste.  Si le fichier sp√©cifi√© existe d√©j√† en essayant d'exporter les param√®tres, il ne peut pas le remplacer, il est timide de le demander et se termine √©galement par une erreur. </li><li>  Myst√©rieux.  Renvoie toujours <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">un code de sortie de 0</a> .  Il s'av√®re que le programme parfait. <br></li><li>  Apte √† r√©fl√©chir.  Il peut geler au stade de 100% minutes pendant 5, et parfois plus.  Mais alors il r√©fl√©chit et termine le travail (√† moins, bien s√ªr, que vous n'ayez la patience de ne pas appuyer sur Ctrl + C). </li><li>  Soudain et contradictoire.  Peut organiser de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">telles surprises</a> . </li><li>  Intelligent.  Peut r√©affecter des pilotes source √† d'autres.  Par exemple, en utilisant un fichier XML, vous pouvez sp√©cifier que tous les pilotes HP Universal Printing PCL 5 dans un fichier enregistr√© sur le serveur de destination doivent √™tre r√©affect√©s √† HP Universal Printing PCL 6. Je ne l'ai pas utilis√© dans la pratique, mais il peut √™tre utile pour quelqu'un. </li><li>  Capricieux.  Je ne pouvais pas l'utiliser pour transf√©rer des param√®tres entre des domaines sans confiance, m√™me avec le commutateur -NOACL.  Soit il ne peut pas le faire en principe, soit ma magie n'est pas assez forte. </li><li>  Vous pouvez mieux vous conna√Ætre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> , mais pour ceux qui ont du courage et qui n'h√©sitent pas √† demander directement, il y a une cl√© /? <br></li></ul><br><br>  J'avoue que certaines fonctionnalit√©s que j'ai n√©glig√©es √† juste titre.  Peut-√™tre que dans Windows 10/2016, elle a commenc√© √† se comporter diff√©remment.  S'il y a des informations, veuillez les partager. <br><br><h2>  Pr√©paration de l'environnement </h2><br>  Il est suppos√© que vous avez d√©j√† d√©ploy√© Active Directory et que vous connaissez au moins 3 fa√ßons de le d√©sactiver et qu'au moins 2 d'entre elles ont √©t√© test√©es dans la pratique. <br><br><div class="spoiler">  <b class="spoiler_title">Quelques paroles</b> <div class="spoiler_text">  En partant du sujet de l'article, je note que j'aime la commande, et je suis pour le fait que chaque imprimante r√©seau et MFP poss√®de un autocollant correspondant √† son nom de r√©seau.  Cela simplifie le travail des employ√©s de l'informatique lorsqu'ils essaient de d√©couvrir aupr√®s de l'utilisateur sur quelle imprimante <s>photo de</s> chat des rapports analytiques importants sont imprim√©s dans des tons acides toxiques au lieu de d√©licats pistaches.  <s>Il est pr√©f√©rable de coller de tels autocollants sur le dessous de l'imprimante, afin que tout le monde soit plus int√©ress√© et plus amusant.</s> <br>  J'aime aussi quand chaque imprimante r√©seau est enregistr√©e dans la zone DNS interne.  Un serveur DHCP bas√© sur Windows <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">peut facilement le faire</a> . <br>  Par exemple, le nom de l'imprimante peut √™tre au format msk-prn001 ou sale-printer023, et les noms de port pour ces imprimantes sur le serveur d'impression sont nomm√©s exactement de la m√™me mani√®re.  Mais c'est ma pr√©f√©rence personnelle, je suis pr√™t √† entendre des objections dans les commentaires. <br></div></div><br>  Nous supposerons que toutes les imprimantes sont en r√©seau et disponibles pour l'impression √† partir des serveurs d'impression principal et de secours.  Que ces serveurs s'appellent respectivement <i>prn-srv01</i> et <i>prn-srv02</i> . <br>  Les serveurs de domaine sur Windows Server pas inf√©rieurs √† 2008 conviennent comme serveurs d'impression. En principe, les OS clients commen√ßant par Vista conviennent √©galement, si vous voulez vraiment √©conomiser de l'argent.  L'exemple utilise Windows 2012 R2.  Il est fortement conseill√© d'installer toutes les mises √† jour n√©cessaires du syst√®me d'exploitation avant de configurer les serveurs et les machines clientes. <br><br>  Vous-m√™me, bien s√ªr, comprenez, mais le plafond n√©cessite toujours de l'attention: si les serveurs d'impression sont virtuels, ils doivent √™tre distribu√©s sur diff√©rents serveurs physiques, sinon notre basculement se transformera simplement en √©chec. <br><br>  Sur <i>prn-srv01</i> et <i>prn</i> <i>-srv02</i> , le r√¥le de serveur d'impression doit √™tre ajout√©.  Il est plus pratique pour moi d'utiliser l'applet de commande PowerShell: <br> <code>Install-WindowsFeature Print-Services</code> <br> <br>  En outre, un ajustement du Registre doit √™tre appliqu√© sur les serveurs d'impression, ce qui corrige l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">erreur 0 √ó 00000709</a> lorsque les ordinateurs clients acc√®dent au serveur d'impression via CNAME.  Vous pouvez le faire avec la commande de l'article sur le lien ci-dessus: <br> <code>reg add HKLM\SYSTEM\CurrentControlSet\Control\Print /v DnsOnWire /t REG_DWORD /d 1</code> <br>  Apr√®s avoir appliqu√© la commande, vous devez red√©marrer le service <i>Gestionnaire d'impression</i> . <br>  Je vous recommande d'allouer une unit√© d'organisation distincte pour les serveurs d'impression et de distribuer ce param√®tre √† l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">aide de GPP</a> . <br><br>  Nous d√©marrons le composant logiciel enfichable DNS sur le contr√¥leur de domaine et activons l'affichage √©tendu: <br><div class="spoiler">  <b class="spoiler_title">cliquer</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/t_/sg/w1/t_sgw1pf6fazbhihj-4yjxzivfc.png"><br></div></div><br>  Un mappage avanc√© est n√©cessaire pour pouvoir d√©finir TTL pour les enregistrements cr√©√©s. <br>  Dans DNS, cr√©ez un enregistrement d' <i>impression</i> CNAME qui r√©f√©rence <i>prn-srv01</i> avec une valeur TTL de 5 minutes: <br><div class="spoiler">  <b class="spoiler_title">cliquer</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/bx/oe/0y/bxoe0yjyj5pmar4utycfqjfnnba.png"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">cliquer</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/w_/tz/dj/w_tzdj66enutsmeuw5wwajzmrww.png"><br></div></div><br>  Ce nom doit √™tre utilis√© par les ordinateurs clients pour se connecter au serveur d'impression.  C'est-√†-dire  le client se connectera aux adresses \\ print \ printer01, \\ print \ printer02, etc. <br>  Plus la valeur TTL est faible, plus les clients mettront √† jour l'enregistrement et ¬´comprendront¬ª plus t√¥t qu'ils doivent passer √† un autre serveur d'impression.  5 minutes me suffisent. <br>  En d√©finissant une valeur trop basse, vous g√©n√©rez du trafic DNS sur votre r√©seau <s>et en sp√©cifiant une heure ou deux, vous accentuez votre tol√©rance au stress et vos nerfs forts</s> . <br>  Une autre fa√ßon d'ajouter un enregistrement CNAME √† l'aide de PowerShell: <br> <code>Import-Module DnsServer <br> Add-DnsServerResourceRecordCName -Name "print" -HostNameAlias "prn-srv01.lab.net" -ZoneName "lab.net" -TimeToLive 00:05:00 <br></code> <br>  (Bien s√ªr, nous changeons lab.net en votre contoso.local ou quoi que ce soit) <br><br>  Gardez √† l'esprit que si vous avez plusieurs sites AD, la mise √† jour des enregistrements DNS dans tous les emplacements prendra plus de temps en raison de la r√©plication intersite.  Vous pouvez forcer le processus avec la <i>commande repadmin / syncall</i> . <br><br>  En utilisant la strat√©gie de groupe, nous permettons aux utilisateurs ordinaires d'installer des pilotes √† partir du serveur d'impression.  La proc√©dure √† suivre est d√©crite en d√©tail <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . <br><br>  Cr√©ez un compte de service dans AD (je l'ai nomm√© svc-printsync) avec une expiration de mot de passe illimit√©e: <br><div class="spoiler">  <b class="spoiler_title">cliquer</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/aw/b8/-i/awb8-irvpqwtgz7_hqh5zziclxu.png"><br></div></div><br>  Selon les exigences de PrintBrm, ce compte doit avoir tous les droits sur le serveur d'impression, nous l'ajoutons donc au <s>domaine admins pour que tout fonctionne √† coup s√ªr et nous √©crivons le mot de passe dans le champ de description afin de ne pas oublier le</s> groupe <i>Administrateurs</i> local sur <i>prn-srv01</i> et <i>prn-srv02</i> ( par exemple, √† <i>l'</i> aide <i>du</i> composant <i>logiciel</i> enfichable <i>Gestion de l'ordinateur</i> ). <br><br><h2>  Configurer le premier serveur </h2><br>  Si toutes les imprimantes n√©cessaires sur l'imprimante principale ont d√©j√† √©t√© ajout√©es, vous pouvez imm√©diatement passer √† la section sur la configuration du deuxi√®me serveur. <br><br>  √Ä <i>l'</i> aide <i>du</i> composant <i>logiciel</i> enfichable <i>Gestion de l'impression</i> , nous ajoutons des pilotes pour les imprimantes n√©cessaires au serveur: <br><div class="spoiler">  <b class="spoiler_title">cliquer</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/c0/_b/fl/c0_bflidme6egcqqpjsu8fmhkay.png"><br></div></div><br>  L'assistant d'installation du pilote se lance.  C'est intuitif, vous pouvez le d√©couvrir vous-m√™me.  Je ne ferai attention qu'au moment avec une profondeur de bits. <br>  Parce que  √âtant donn√© que Windows 2012R2 n'est disponible que dans la version x64, les pilotes doivent √©galement √™tre x64.  Si les clients avec des versions x86 de Windows se connectent au serveur d'impression, n'oubliez pas de cocher la case correspondante: <br><div class="spoiler">  <b class="spoiler_title">cliquer</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/kk/1r/be/kk1rbe46et1lxpumhlwjt4dgqvu.png"><br></div></div><br>  Certains kits de pilotes contiennent un fichier inf commun pour les syst√®mes x86 et x64, tandis que d'autres ont une s√©paration. <br><br><div class="spoiler">  <b class="spoiler_title">Quelques paroles de plus</b> <div class="spoiler_text">  De nombreux pilotes se pr√©sentent sous la forme d'un installateur, mais √©tant donn√© que ces installateurs mettent beaucoup de d√©chets avec les pilotes, j'essaie de suivre le principe ¬´n√©cessaire et suffisant¬ª et d'ajouter des pilotes manuellement, comme d√©crit ci-dessus. <br>  Aussi, par souci de coh√©rence, je m'efforce d'utiliser au maximum la version universelle des pilotes (presque tous les fournisseurs normaux l'ont).  Mais parfois, cela peut √™tre un probl√®me.  Ainsi, une fois que j'ai rencontr√© un bogue dans l'une des versions de HP Universal Printing PCL 6, dans lequel un document PDF via EasyPrint dans une session RDP a √©t√© imprim√© en miroir de gauche √† droite. <br>  Vous pouvez √©galement regarder vers les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pilotes v4</a> . <br></div></div><br><br>  Lorsque tous les pilotes n√©cessaires seront ajout√©s, nous traiterons des ports et des imprimantes.  Vous pouvez les ajouter manuellement √† partir du m√™me composant logiciel enfichable, mais je recommande de cr√©er un fichier CSV dans Excel et de le charger dans un script PowerShell.  Bien s√ªr, rien n'emp√™che Excel d'utiliser tout autre √©diteur de feuille de calcul ou bloc-notes en g√©n√©ral.  L'essentiel est que le s√©parateur et l'encodage sp√©cifi√©s dans le script correspondent au s√©parateur et √† l'encodage dans le fichier CSV. <br>  Notez √©galement que le nom du pilote dans le fichier CSV doit √™tre exactement le m√™me que celui sp√©cifi√© dans le composant <i>logiciel</i> enfichable <i>Gestion de</i> l'impression. <br><div class="spoiler">  <b class="spoiler_title">Copiez-collez √† la rescousse</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/lt/-u/k3/lt-uk31frw4ashg6sqfxptrx6us.png"><br></div></div><br><br><div class="spoiler">  <b class="spoiler_title">Exemple de fichier CSV</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/f9/wp/cj/f9wpcjsmlydppavwxh9ed4bn51m.png"><br></div></div><br><br>  Bien que j'aie √©crit ci-dessus que j'aime quand toutes les imprimantes ont des noms de r√©seau unifi√©s, l'exemple (champ d' <i>adresse de l'imprimante</i> ) utilise une vinaigrette d'adresses IP et de noms au cas o√π vous n'auriez <s>pas de</s> commande dans votre r√©seau un peu plus tard. <br><br>  Enregistrez ce tableau au format CSV: <br><div class="spoiler">  <b class="spoiler_title">cliquer</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/1e/qq/4i/1eqq4iw3hfbsjfge8mcetyerlfg.png"><br>  <i><b>Remarque</b></i>  <i>Malgr√© le fait que les virgules sont indiqu√©es comme s√©parateurs dans le champ ¬´Type de fichier¬ª, Excel a cr√©√© un point-virgule comme s√©parateur.</i>  <i>Probablement pour √™tre plus int√©ressant et plus amusant.</i> <br></div></div><br>  Et voici le script lui-m√™me: <br><div class="spoiler">  <b class="spoiler_title">CreatePrintersFromCsv.ps1</b> <div class="spoiler_text"><pre> <code class="hljs mel">#    $InputFile = <span class="hljs-string"><span class="hljs-string">'C:\Scripts\Printers.csv'</span></span> #      CSV- $Printers = (Import-Csv $InputFile -Delimiter <span class="hljs-string"><span class="hljs-string">";"</span></span> -Encoding Default) #          ForEach ($Printer <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> $Printers) { #       $PrinterName = $Printer.<span class="hljs-string"><span class="hljs-string">' '</span></span> $ShareName = $Printer.<span class="hljs-string"><span class="hljs-string">'  '</span></span> $DriverName = $Printer.<span class="hljs-string"><span class="hljs-string">' '</span></span> $PrinterAddr = $Printer.<span class="hljs-string"><span class="hljs-string">' '</span></span> $Comment = $Printer.<span class="hljs-string"><span class="hljs-string">''</span></span> $Location = $Printer.<span class="hljs-string"><span class="hljs-string">''</span></span> #  Add-PrinterPort -Name $PrinterAddr -PrinterHostAddress $PrinterAddr -SNMP <span class="hljs-number"><span class="hljs-number">1</span></span> -SNMPCommunity <span class="hljs-string"><span class="hljs-string">'public'</span></span> #  Add-Printer -Name $PrinterName -DriverName $DriverName -PortName $PrinterAddr -Comment $Comment -Location $Location #   Set-Printer -Name $PrinterName -Shared $True -Published $False -ShareName $ShareName }</code> </pre><br></div></div><br>  Si le caract√®re de tabulation est utilis√© comme d√©limiteur dans votre CSV, alors dans le script, vous devez d√©finir <i>-Delimiter "` t "</i> <br><br>  Veuillez noter que si une imprimante n'est pas disponible sur le serveur pendant l'ex√©cution du script, l'ajout au serveur d'impression prendra plus de temps (2-3 minutes au lieu de quelques secondes) <br><br>  Le r√©sultat du script: <br><div class="spoiler">  <b class="spoiler_title">cliquer</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/fj/jd/-t/fjjd-tcfaowketxq9u7av7yzfzk.png"><br></div></div><br><br>  Pour vous assurer que tout fonctionne √† ce stade, ajoutez une imprimante partag√©e √† l'une des machines clientes du serveur d'impression principal √† l'aide du CNAME pr√©c√©demment cr√©√© (par exemple, \\ print \ printer01) et essayez d'imprimer quelque chose dessus.  <s>A cet effet, la phrase ¬´Pr√©venu, je suis un morceau de papier¬ª, tap√©e en gras Arial au 200e, convient le mieux √† cet effet.</s> <br><br><h2>  Configurer un deuxi√®me serveur </h2><br><blockquote>  Un artista copia, un gran artista roba (Pablo Picasso) </blockquote><br>  Notre <i>prn-srv02</i> n'a pas encore atteint le niveau de gran artista, nous nous limiterons donc √† la copie.  <s>Bien que ... c'est possible avec un coup de poignet ...</s> <br><br>  Nous cr√©ons et partageons au moins une imprimante, sinon PrintBrm donnera une erreur.  Vous pouvez cr√©er un faux, mais il est important de ne pas choisir le mauvais pilote ou le mauvais port.  Par exemple, une imprimante avec un pilote Microsoft XPS Document Writer ou un port FILE ne peut pas √™tre partag√©e. <br><br>  Nous cr√©ons un script de synchronisation simple.  Je pr√©f√®re PowerShell, mais personne n'interdit de cr√©er un fichier batch de tube chaud. <br><br><div class="spoiler">  <b class="spoiler_title">PrintSync.ps1</b> <div class="spoiler_text"><pre> <code class="hljs mel">#   PrintBrm $ProgramPath = <span class="hljs-string"><span class="hljs-string">'C:\Windows\System32\Spool\Tools\PrintBrm.exe'</span></span> #    $SourceServer = <span class="hljs-string"><span class="hljs-string">'prn-srv01'</span></span> $DestServer = <span class="hljs-string"><span class="hljs-string">'prn-srv02'</span></span> #,   .     , ..  PrintBrm       $ConfigFilePath = <span class="hljs-string"><span class="hljs-string">'C:\Scripts\prn-config.printerExport'</span></span> #    $Arguments = <span class="hljs-string"><span class="hljs-string">"-s $SourceServer -f $ConfigFilePath -b"</span></span> Start-process $ProgramPath -ArgumentList $Arguments -Wait -PassThru #    $Arguments = <span class="hljs-string"><span class="hljs-string">"-s $DestServer -f $ConfigFilePath -r -o force"</span></span> Start-process $ProgramPath -ArgumentList $Arguments -Wait -PassThru #   Del $ConfigFilePath</code> </pre><br></div></div><br><br>  Nous mettons le script dans un endroit isol√© (dans l'exemple c'est <i>C: \ Scripts</i> ) et cr√©ons une t√¢che dans le Planificateur. <br>  Nous allons ex√©cuter √† partir du compte svc-printsync pr√©c√©demment cr√©√© avec les autorisations les plus √©lev√©es: <br><div class="spoiler">  <b class="spoiler_title">cliquer</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/sp/ax/9w/spax9w_u6llu5ekhxh6ezfq8zdi.png"><br></div></div><br>  D√©terminez vous-m√™me la fr√©quence d'ex√©cution.  Assez pour moi une fois par jour: <br><div class="spoiler">  <b class="spoiler_title">cliquer</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/m8/a5/hm/m8a5hm3qm5dosyvvd8uivsrdeaq.png"><br></div></div><br>  Dans l'onglet Actions, cr√©ez une nouvelle action de lancement PowerShell: <br> <code>C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe</code> <br>  Comme arguments, nous d√©finissons le chemin d'acc√®s au script avec les param√®tres suivants: <br> <code>C:\Scripts\PrintSync.ps1 -NonInteractive -WindowStyle Hidden -ExecutionPolicy Bypass</code> <br> <div class="spoiler">  <b class="spoiler_title">cliquer</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/c2/dw/zi/c2dwzipe2ifr6vstp2qgpvr-cc4.png"><br></div></div><br>  Nous laissons le reste des param√®tres de t√¢che dans les onglets <i>Conditions</i> et <i>Param√®tres</i> par d√©faut. <br>  Lors de l'enregistrement de la t√¢che, un mot de passe sera demand√© pour le compte <i>svc-printsync</i> .  Tu ne l‚Äôas pas oubli√©?  Si vous avez d√©j√† oubli√© (l'article est long), alors <s>tout a √©t√© fait en vain et la vie a √©chou√©,</s> r√©initialisez-le √† l'aide du composant logiciel enfichable ADUC ou d'une autre mani√®re pratique <s>et sp√©cifiez-le d√©j√† dans le champ de description pour le rendre plus calme</s> . <br><br><div class="spoiler">  <b class="spoiler_title">Remarque</b> <div class="spoiler_text">  Il n'est pas n√©cessaire d'ex√©cuter le travail sur le serveur d'impression de sauvegarde.  Si vous avez un serveur distinct pour ex√©cuter des routines, vous pouvez cr√©er une t√¢che dessus.  Dans ce cas, le compte <i>svc-printsync</i> doit avoir le droit de se connecter en tant que t√¢che par lots sur ce serveur.  Par d√©faut, le groupe local <i>Op√©rateurs de sauvegarde</i> a ce droit, et si cela ne change pas dans votre environnement, alors incluez simplement le compte de service dans le groupe d'op√©rateurs d'archives du serveur sur lequel la t√¢che s'ex√©cutera. <br></div></div><br><br>  Pour la premi√®re fois, nous d√©marrons la t√¢che manuellement et attendons son ach√®vement. <br>  Pour mon zoo, o√π il y a environ 50 imprimantes de types diff√©rents, √† la fois en voie de disparition et r√©cemment d√©velopp√©es, la proc√©dure de synchronisation prend environ 10 minutes.  Le fichier p√®se en m√™me temps pr√®s de 1 Go. <br>  Pour acc√©l√©rer le processus d'importation / exportation, vous pouvez utiliser le <i>commutateur -NOBIN</i> , qui est responsable de la copie des pilotes.  Cela a du sens lorsque le parc d'imprimantes est compos√© des m√™mes mod√®les et que les pilotes n√©cessaires sont install√©s sur tous les serveurs. <br><br>  Une fois l'op√©ration termin√©e, ex√©cutez le composant logiciel enfichable <i>Observateur d'√©v√©nements</i> , acc√©dez √† la section <i>Journaux des applications et des services</i> , ouvrez le <i>journal Microsoft \ Microsoft \ PrintBRM \ Administrator</i> et analysez-le √† la recherche d'erreurs et d'avertissements.  <s>Et s'il y en a trop, alors nous sommes plus susceptibles de nettoyer le magazine afin que nos yeux ne callosent pas.</s> <br><br>  Je suis tomb√© sur les codes 20, 22, 80 et 81. Par exemple, <br><div class="spoiler">  <b class="spoiler_title">tel</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/be/sx/7u/besx7uy6lxapuzrxj3_mrsg9agc.png"><br></div></div><br>  Comme il ressort clairement du texte, un probl√®me est survenu lors du transfert d'un pilote sp√©cifique.  En parcourant le journal, nous dressons une liste des pilotes probl√©matiques et les mettons sur le serveur de sauvegarde avec nos mains, ou les rempla√ßons par d'autres qui ne sont pas oppos√©s aux voyages.  Je n'ai eu que des probl√®mes avec HP, Kyocera et Konica Minolta, aucune erreur n'a √©t√© d√©tect√©e pour les pilotes d'autres fabricants (peut-√™tre parce qu'ils sont meilleurs ou peut-√™tre parce que nous ne les avons tout simplement pas). <br>  Par cons√©quent, vous devez obtenir la m√™me liste d'imprimantes sur les serveurs principal et de sauvegarde et l'absence d'erreurs et d'avertissements dans les journaux. <br><br><h2>  Passer √† r√©server </h2><br>  <s>Sous le coup des haches et le grincement des fourchettes, nous barricadons la porte de notre bureau et √©teignons le t√©l√©phone.</s>  Ex√©cutez le composant logiciel enfichable DNS et modifiez l'enregistrement CNAME afin qu'il pointe vers le serveur de sauvegarde: <br><div class="spoiler">  <b class="spoiler_title">cliquer</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/3n/kh/p5/3nkhp5g6apvxj1ejoheth9hlcfu.png"><br></div></div><br>  Apr√®s un certain temps (qu'avez-vous mis dans TTL l√†-bas?), Les <s>cris mena√ßants se calmeront, les</s> machines clientes passeront √† prn-srv02 <s>et la porte avec le t√©l√©phone peut √™tre d√©verrouill√©e</s> . <br><br><h2>  Reviens </h2><br>  Si, lors de la r√©cup√©ration du serveur principal sur la sauvegarde, des modifications de configuration doivent √™tre enregistr√©es, nous d√©marrons la synchronisation dans le sens oppos√©.  Pour ce faire, dans le script <i>PrintSync.ps1</i> ci-dessus <i>,</i> nous <i>√©changeons</i> les valeurs des variables <i>$ SourceServer</i> et <i>$ DestServer</i> .  Apr√®s avoir transf√©r√© les modifications, n'oubliez pas de renvoyer ces valeurs, sinon tous les changements dans la configuration de l'imprimante sur <i>prn-srv01</i> seront impitoyablement <i>balay√©s</i> chaque nuit par la mauvaise volont√© du destin. <br>  Dans le composant logiciel enfichable DNS, d√©finissez l' <i>impression</i> pour l'enregistrement CNAME sur la valeur du n≈ìud de destination prn-srv01 - et tout revient √† la case d√©part. <br><br><h2>  Quel est le r√©sultat? </h2><br>  Applaudissements orageux de la direction, jetant l'administrateur dans ses bras, augmentant le salaire (√† l'auteur de l'article - honn√™te 10% de l'augmentation) ... <br>  Eh bien, quelques r√©flexions dans le sens d'une orientation de plus belle beaut√©. <br><br>  Malheureusement, il n'y a pas assez de miracles pour tout le monde et cette solution n'est pas un basculement √† part enti√®re.  Si au moment de l'effondrement du serveur d'impression principal, il y a des files d'attente d'impression non vides, alors leur contenu dispara√Ætra tr√®s probablement dans l'air et quelqu'un devra r√©p√©ter l'envoi de l'impression. <br><br>  Mais il sera tr√®s pratique pour les utilisateurs d'effectuer de mani√®re transparente la maintenance de routine des serveurs d'impression. <br><div class="spoiler">  <b class="spoiler_title">Vous suivez les recommandations de Microsoft?</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/s9/dr/bm/s9drbmkdazxkxaswuw4flitnsoi.jpeg"><br></div></div><br><br>  Les fans d'automatisation peuvent aller plus loin et cr√©er un script qui re√ßoit les noms de serveur avec un intervalle de synchronisation √† l'entr√©e et fait le reste des param√®tres lui-m√™me: cr√©e un compte de service si n√©cessaire, une t√¢che dans le planificateur, etc. <br><br>  Les gourous de surveillance ajouteront la surveillance de la t√¢che de synchronisation et des erreurs dans les journaux. <br><br>  Les amateurs de creuser plus profond√©ment peuvent penser √† la synchronisation bidirectionnelle dans l'esprit de la r√©plication AD avec des changements de suivi du temps pour chaque imprimante.  PrintBrm n'aidera pas ici, mais personne n'a annul√© PowerShell! <br><br>  La cerise sur le g√¢teau sera l'installation automatique d'imprimantes sur les machines clientes utilisant GPP, ciblant le groupe AD.  Ajoutez l'utilisateur au groupe - et l'imprimante souhait√©e vole vers lui.  Certes, c'est une autre histoire qui d√©passe le cadre de l'article. <br><br>  J'esp√®re pour quelqu'un que ma publication sera utile.  Je souhaite √† tout le monde moins de probl√®mes et j'attends avec impatience les questions et suggestions dans les commentaires. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr414369/">https://habr.com/ru/post/fr414369/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr414357/index.html">Nous utilisons l'API Web Bluetooth pour connecter le moniteur de fr√©quence cardiaque et d√©velopper l'application √† l'aide de Vue.js</a></li>
<li><a href="../fr414359/index.html">Interaction avec le serveur via l'API dans iOS sur Swift 3. Partie 1</a></li>
<li><a href="../fr414361/index.html">Unity3D: architecture de jeu, objets scriptables, singletones</a></li>
<li><a href="../fr414363/index.html">Le condens√© de mati√®res fra√Æches du monde du front-end de la derni√®re semaine n ¬∞ 319 (11-17 juin 2018)</a></li>
<li><a href="../fr414367/index.html">Galop en trois ans: ce qui peut √™tre int√©ressant √† relire sur le blog HashFlare</a></li>
<li><a href="../fr414371/index.html">Classe d'√©cole et un petit croquis de l'ing√©nierie sociale</a></li>
<li><a href="../fr414373/index.html">Conception asynchrone / attente JavaScript: forces, pi√®ges et mod√®les d'utilisation</a></li>
<li><a href="../fr414375/index.html">Commandes pour travailler avec la console JavaScript dans les navigateurs et augmenter la productivit√© du programmeur</a></li>
<li><a href="../fr414377/index.html">Innovations des litt√©raux d'objets dans JavaScript ES6</a></li>
<li><a href="../fr414379/index.html">¬´Ceux qui sont pr√™ts √† √©changer la libert√© contre la s√©curit√© ne sont dignes ni de libert√© ni de s√©curit√©¬ª (source originale)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>