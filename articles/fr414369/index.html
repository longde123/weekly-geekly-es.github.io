<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏼 🛎️ 👩🏿‍🤝‍👨🏾 Serveur d'impression à tolérance de pannes Windows 🚼 🛏️ 🔷</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Un vrai administrateur ne peut dormir paisiblement que lorsque tout est sauvegardé, surveillé et dupliqué. Ou quand il travaille dans une bonne équipe...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Serveur d'impression à tolérance de pannes Windows</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/414369/"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img src="https://habrastorage.org/webt/7x/lk/zl/7xlkzlpjw2oft9qotypwjalwdmy.png"></a> <br>  Un vrai administrateur ne peut dormir paisiblement que lorsque tout est sauvegardé, surveillé et dupliqué.  <s>Ou quand il travaille dans une bonne équipe, où vous pouvez toujours blâmer les autres.</s> <br>  Il se trouve que j'utilise principalement des produits Microsoft dans mon travail et je peux dire que la société souhaite sérieusement sauvegarder ses services: Active Directory, Exchange DAG, SQL Always On, DFSR, etc.  Comme ailleurs, il existe à la fois des implémentations très élégantes et réussies, ainsi que des implémentations évidemment gênantes et difficiles.  Il existe également une solution pour le service d'impression, mais elle nécessite un clustering basé sur Hyper-V.  Et je voulais une solution simple «prête à l'emploi», qui ne nécessite pas de financement supplémentaire.  Windows 2012 R2 a été pris comme base, mais le même schéma fonctionnera probablement sans problème sur toutes les versions de serveur à partir de Windows 2008, et même sur les systèmes d'exploitation clients de Vista et supérieurs (bonjour aux fans qui économisent le budget!).  Peu importe - je demande un chat. <br><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">Clause de non-responsabilité</b> <div class="spoiler_text">  <s>Afin de respecter le travail des Indiens,</s> le public Habr étant majoritairement russophone et pour faciliter la tâche aux administrateurs débutants, les exemples utilisent la version russe de l'interface Windows.  Dans la mesure du possible, les liens mènent également à des ressources en russe. <br></div></div><br><br><h2>  Un peu de théorie </h2><br>  Quiconque n'aime pas la théorie et souhaite cliquer plus rapidement avec une souris et un clavier peut passer directement à la partie suivante. <br>  Comme mentionné ci-dessus, la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">recommandation officielle</a> aujourd'hui est une solution utilisant le clustering et la virtualisation Hyper-V.  De plus, rien n'empêche d'assurer la tolérance aux pannes du service d'impression au niveau du système de virtualisation, et pas forcément Hyper-V, mais de telles solutions coûtent cher. <br>  Je voulais vraiment quelque chose de similaire au <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">basculement DHCP</a> , mais pour le rôle d'un serveur d'impression. <br>  Rien de convenable n'a été trouvé sur Internet en général et sur le Habr <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">en particulier</a> - et j'ai dû l'inventer moi-même. <br><br>  <b>L'essence de l'idée dans un paragraphe</b> <br>  La solution décrite ci-dessous est basée sur l'utilitaire BrintBrm, qui fait partie de la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">distribution</a> Windows standard <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">et est venu remplacer printmig</a> . <br>  Le serveur de secours fonctionne en mode veille et synchronise les paramètres avec le serveur principal avec la fréquence spécifiée à l'aide de cet utilitaire.  Pour les clients, un CNAME avec un petit TTL a été créé dans DNS, référençant le serveur principal.  En cas de défaillance du serveur principal, l'administrateur corrige CNAME en basculant les clients vers le serveur de sauvegarde.  En fait, c'est tout. <br>  Si le sujet est intéressant et que je veux me familiariser avec les bosses déjà farcies avec moi et les moyens de contourner le râteau, veuillez suivre ensuite. <br><br><h2>  Avant de commencer ou ce que vous devez savoir sur PrintBrm </h2><br>  Alors, quel est-il, cet utilitaire PrintBrm, dont le but principal est de servir le serveur d'impression? <br><ul><li>  Bien entretenu.  Il a une implémentation GUI appelée <i>Print Migration</i> et peut être lancé à partir <i>du</i> composant <i>logiciel</i> enfichable <i>Gestion</i> de <i>l'impression</i> .  La version GUI est moins fonctionnelle et a des problèmes avec le portage de port. </li><li>  Attentif.  Par défaut, il gère les listes de contrôle d'accès d'imprimante du serveur d'impression.  En d'autres termes, si vous avez autorisé l'impression sur l'imprimante \\ serveur d'impression \ imprimante1 uniquement aux employés membres du groupe <i>Comptabilité</i> AD, cette restriction sera prise en compte pour l'importation / exportation.  Ou pas, si vous mettez la clé <i>-NOACL</i> .  Cependant, l'ACL du serveur d'impression lui-même n'est pas traité quelle que soit la clé. </li><li>  Maugrey.  Au moment d'importer des paramètres à partir d'un fichier, le serveur cible doit avoir au moins une imprimante partagée, sinon vous obtiendrez une erreur. </li><li>  Doux.  Espaces perdus dans le chemin du fichier.  A la vue des guillemets encadrant un tel chemin, il est <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">contrarié</a> et donne une erreur 0x8007007b. </li><li>  Modeste.  Si le fichier spécifié existe déjà en essayant d'exporter les paramètres, il ne peut pas le remplacer, il est timide de le demander et se termine également par une erreur. </li><li>  Mystérieux.  Renvoie toujours <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">un code de sortie de 0</a> .  Il s'avère que le programme parfait. <br></li><li>  Apte à réfléchir.  Il peut geler au stade de 100% minutes pendant 5, et parfois plus.  Mais alors il réfléchit et termine le travail (à moins, bien sûr, que vous n'ayez la patience de ne pas appuyer sur Ctrl + C). </li><li>  Soudain et contradictoire.  Peut organiser de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">telles surprises</a> . </li><li>  Intelligent.  Peut réaffecter des pilotes source à d'autres.  Par exemple, en utilisant un fichier XML, vous pouvez spécifier que tous les pilotes HP Universal Printing PCL 5 dans un fichier enregistré sur le serveur de destination doivent être réaffectés à HP Universal Printing PCL 6. Je ne l'ai pas utilisé dans la pratique, mais il peut être utile pour quelqu'un. </li><li>  Capricieux.  Je ne pouvais pas l'utiliser pour transférer des paramètres entre des domaines sans confiance, même avec le commutateur -NOACL.  Soit il ne peut pas le faire en principe, soit ma magie n'est pas assez forte. </li><li>  Vous pouvez mieux vous connaître <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> , mais pour ceux qui ont du courage et qui n'hésitent pas à demander directement, il y a une clé /? <br></li></ul><br><br>  J'avoue que certaines fonctionnalités que j'ai négligées à juste titre.  Peut-être que dans Windows 10/2016, elle a commencé à se comporter différemment.  S'il y a des informations, veuillez les partager. <br><br><h2>  Préparation de l'environnement </h2><br>  Il est supposé que vous avez déjà déployé Active Directory et que vous connaissez au moins 3 façons de le désactiver et qu'au moins 2 d'entre elles ont été testées dans la pratique. <br><br><div class="spoiler">  <b class="spoiler_title">Quelques paroles</b> <div class="spoiler_text">  En partant du sujet de l'article, je note que j'aime la commande, et je suis pour le fait que chaque imprimante réseau et MFP possède un autocollant correspondant à son nom de réseau.  Cela simplifie le travail des employés de l'informatique lorsqu'ils essaient de découvrir auprès de l'utilisateur sur quelle imprimante <s>photo de</s> chat des rapports analytiques importants sont imprimés dans des tons acides toxiques au lieu de délicats pistaches.  <s>Il est préférable de coller de tels autocollants sur le dessous de l'imprimante, afin que tout le monde soit plus intéressé et plus amusant.</s> <br>  J'aime aussi quand chaque imprimante réseau est enregistrée dans la zone DNS interne.  Un serveur DHCP basé sur Windows <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">peut facilement le faire</a> . <br>  Par exemple, le nom de l'imprimante peut être au format msk-prn001 ou sale-printer023, et les noms de port pour ces imprimantes sur le serveur d'impression sont nommés exactement de la même manière.  Mais c'est ma préférence personnelle, je suis prêt à entendre des objections dans les commentaires. <br></div></div><br>  Nous supposerons que toutes les imprimantes sont en réseau et disponibles pour l'impression à partir des serveurs d'impression principal et de secours.  Que ces serveurs s'appellent respectivement <i>prn-srv01</i> et <i>prn-srv02</i> . <br>  Les serveurs de domaine sur Windows Server pas inférieurs à 2008 conviennent comme serveurs d'impression. En principe, les OS clients commençant par Vista conviennent également, si vous voulez vraiment économiser de l'argent.  L'exemple utilise Windows 2012 R2.  Il est fortement conseillé d'installer toutes les mises à jour nécessaires du système d'exploitation avant de configurer les serveurs et les machines clientes. <br><br>  Vous-même, bien sûr, comprenez, mais le plafond nécessite toujours de l'attention: si les serveurs d'impression sont virtuels, ils doivent être distribués sur différents serveurs physiques, sinon notre basculement se transformera simplement en échec. <br><br>  Sur <i>prn-srv01</i> et <i>prn</i> <i>-srv02</i> , le rôle de serveur d'impression doit être ajouté.  Il est plus pratique pour moi d'utiliser l'applet de commande PowerShell: <br> <code>Install-WindowsFeature Print-Services</code> <br> <br>  En outre, un ajustement du Registre doit être appliqué sur les serveurs d'impression, ce qui corrige l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">erreur 0 × 00000709</a> lorsque les ordinateurs clients accèdent au serveur d'impression via CNAME.  Vous pouvez le faire avec la commande de l'article sur le lien ci-dessus: <br> <code>reg add HKLM\SYSTEM\CurrentControlSet\Control\Print /v DnsOnWire /t REG_DWORD /d 1</code> <br>  Après avoir appliqué la commande, vous devez redémarrer le service <i>Gestionnaire d'impression</i> . <br>  Je vous recommande d'allouer une unité d'organisation distincte pour les serveurs d'impression et de distribuer ce paramètre à l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">aide de GPP</a> . <br><br>  Nous démarrons le composant logiciel enfichable DNS sur le contrôleur de domaine et activons l'affichage étendu: <br><div class="spoiler">  <b class="spoiler_title">cliquer</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/t_/sg/w1/t_sgw1pf6fazbhihj-4yjxzivfc.png"><br></div></div><br>  Un mappage avancé est nécessaire pour pouvoir définir TTL pour les enregistrements créés. <br>  Dans DNS, créez un enregistrement d' <i>impression</i> CNAME qui référence <i>prn-srv01</i> avec une valeur TTL de 5 minutes: <br><div class="spoiler">  <b class="spoiler_title">cliquer</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/bx/oe/0y/bxoe0yjyj5pmar4utycfqjfnnba.png"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">cliquer</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/w_/tz/dj/w_tzdj66enutsmeuw5wwajzmrww.png"><br></div></div><br>  Ce nom doit être utilisé par les ordinateurs clients pour se connecter au serveur d'impression.  C'est-à-dire  le client se connectera aux adresses \\ print \ printer01, \\ print \ printer02, etc. <br>  Plus la valeur TTL est faible, plus les clients mettront à jour l'enregistrement et «comprendront» plus tôt qu'ils doivent passer à un autre serveur d'impression.  5 minutes me suffisent. <br>  En définissant une valeur trop basse, vous générez du trafic DNS sur votre réseau <s>et en spécifiant une heure ou deux, vous accentuez votre tolérance au stress et vos nerfs forts</s> . <br>  Une autre façon d'ajouter un enregistrement CNAME à l'aide de PowerShell: <br> <code>Import-Module DnsServer <br> Add-DnsServerResourceRecordCName -Name "print" -HostNameAlias "prn-srv01.lab.net" -ZoneName "lab.net" -TimeToLive 00:05:00 <br></code> <br>  (Bien sûr, nous changeons lab.net en votre contoso.local ou quoi que ce soit) <br><br>  Gardez à l'esprit que si vous avez plusieurs sites AD, la mise à jour des enregistrements DNS dans tous les emplacements prendra plus de temps en raison de la réplication intersite.  Vous pouvez forcer le processus avec la <i>commande repadmin / syncall</i> . <br><br>  En utilisant la stratégie de groupe, nous permettons aux utilisateurs ordinaires d'installer des pilotes à partir du serveur d'impression.  La procédure à suivre est décrite en détail <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . <br><br>  Créez un compte de service dans AD (je l'ai nommé svc-printsync) avec une expiration de mot de passe illimitée: <br><div class="spoiler">  <b class="spoiler_title">cliquer</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/aw/b8/-i/awb8-irvpqwtgz7_hqh5zziclxu.png"><br></div></div><br>  Selon les exigences de PrintBrm, ce compte doit avoir tous les droits sur le serveur d'impression, nous l'ajoutons donc au <s>domaine admins pour que tout fonctionne à coup sûr et nous écrivons le mot de passe dans le champ de description afin de ne pas oublier le</s> groupe <i>Administrateurs</i> local sur <i>prn-srv01</i> et <i>prn-srv02</i> ( par exemple, à <i>l'</i> aide <i>du</i> composant <i>logiciel</i> enfichable <i>Gestion de l'ordinateur</i> ). <br><br><h2>  Configurer le premier serveur </h2><br>  Si toutes les imprimantes nécessaires sur l'imprimante principale ont déjà été ajoutées, vous pouvez immédiatement passer à la section sur la configuration du deuxième serveur. <br><br>  À <i>l'</i> aide <i>du</i> composant <i>logiciel</i> enfichable <i>Gestion de l'impression</i> , nous ajoutons des pilotes pour les imprimantes nécessaires au serveur: <br><div class="spoiler">  <b class="spoiler_title">cliquer</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/c0/_b/fl/c0_bflidme6egcqqpjsu8fmhkay.png"><br></div></div><br>  L'assistant d'installation du pilote se lance.  C'est intuitif, vous pouvez le découvrir vous-même.  Je ne ferai attention qu'au moment avec une profondeur de bits. <br>  Parce que  Étant donné que Windows 2012R2 n'est disponible que dans la version x64, les pilotes doivent également être x64.  Si les clients avec des versions x86 de Windows se connectent au serveur d'impression, n'oubliez pas de cocher la case correspondante: <br><div class="spoiler">  <b class="spoiler_title">cliquer</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/kk/1r/be/kk1rbe46et1lxpumhlwjt4dgqvu.png"><br></div></div><br>  Certains kits de pilotes contiennent un fichier inf commun pour les systèmes x86 et x64, tandis que d'autres ont une séparation. <br><br><div class="spoiler">  <b class="spoiler_title">Quelques paroles de plus</b> <div class="spoiler_text">  De nombreux pilotes se présentent sous la forme d'un installateur, mais étant donné que ces installateurs mettent beaucoup de déchets avec les pilotes, j'essaie de suivre le principe «nécessaire et suffisant» et d'ajouter des pilotes manuellement, comme décrit ci-dessus. <br>  Aussi, par souci de cohérence, je m'efforce d'utiliser au maximum la version universelle des pilotes (presque tous les fournisseurs normaux l'ont).  Mais parfois, cela peut être un problème.  Ainsi, une fois que j'ai rencontré un bogue dans l'une des versions de HP Universal Printing PCL 6, dans lequel un document PDF via EasyPrint dans une session RDP a été imprimé en miroir de gauche à droite. <br>  Vous pouvez également regarder vers les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pilotes v4</a> . <br></div></div><br><br>  Lorsque tous les pilotes nécessaires seront ajoutés, nous traiterons des ports et des imprimantes.  Vous pouvez les ajouter manuellement à partir du même composant logiciel enfichable, mais je recommande de créer un fichier CSV dans Excel et de le charger dans un script PowerShell.  Bien sûr, rien n'empêche Excel d'utiliser tout autre éditeur de feuille de calcul ou bloc-notes en général.  L'essentiel est que le séparateur et l'encodage spécifiés dans le script correspondent au séparateur et à l'encodage dans le fichier CSV. <br>  Notez également que le nom du pilote dans le fichier CSV doit être exactement le même que celui spécifié dans le composant <i>logiciel</i> enfichable <i>Gestion de</i> l'impression. <br><div class="spoiler">  <b class="spoiler_title">Copiez-collez à la rescousse</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/lt/-u/k3/lt-uk31frw4ashg6sqfxptrx6us.png"><br></div></div><br><br><div class="spoiler">  <b class="spoiler_title">Exemple de fichier CSV</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/f9/wp/cj/f9wpcjsmlydppavwxh9ed4bn51m.png"><br></div></div><br><br>  Bien que j'aie écrit ci-dessus que j'aime quand toutes les imprimantes ont des noms de réseau unifiés, l'exemple (champ d' <i>adresse de l'imprimante</i> ) utilise une vinaigrette d'adresses IP et de noms au cas où vous n'auriez <s>pas de</s> commande dans votre réseau un peu plus tard. <br><br>  Enregistrez ce tableau au format CSV: <br><div class="spoiler">  <b class="spoiler_title">cliquer</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/1e/qq/4i/1eqq4iw3hfbsjfge8mcetyerlfg.png"><br>  <i><b>Remarque</b></i>  <i>Malgré le fait que les virgules sont indiquées comme séparateurs dans le champ «Type de fichier», Excel a créé un point-virgule comme séparateur.</i>  <i>Probablement pour être plus intéressant et plus amusant.</i> <br></div></div><br>  Et voici le script lui-même: <br><div class="spoiler">  <b class="spoiler_title">CreatePrintersFromCsv.ps1</b> <div class="spoiler_text"><pre> <code class="hljs mel">#    $InputFile = <span class="hljs-string"><span class="hljs-string">'C:\Scripts\Printers.csv'</span></span> #      CSV- $Printers = (Import-Csv $InputFile -Delimiter <span class="hljs-string"><span class="hljs-string">";"</span></span> -Encoding Default) #          ForEach ($Printer <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> $Printers) { #       $PrinterName = $Printer.<span class="hljs-string"><span class="hljs-string">' '</span></span> $ShareName = $Printer.<span class="hljs-string"><span class="hljs-string">'  '</span></span> $DriverName = $Printer.<span class="hljs-string"><span class="hljs-string">' '</span></span> $PrinterAddr = $Printer.<span class="hljs-string"><span class="hljs-string">' '</span></span> $Comment = $Printer.<span class="hljs-string"><span class="hljs-string">''</span></span> $Location = $Printer.<span class="hljs-string"><span class="hljs-string">''</span></span> #  Add-PrinterPort -Name $PrinterAddr -PrinterHostAddress $PrinterAddr -SNMP <span class="hljs-number"><span class="hljs-number">1</span></span> -SNMPCommunity <span class="hljs-string"><span class="hljs-string">'public'</span></span> #  Add-Printer -Name $PrinterName -DriverName $DriverName -PortName $PrinterAddr -Comment $Comment -Location $Location #   Set-Printer -Name $PrinterName -Shared $True -Published $False -ShareName $ShareName }</code> </pre><br></div></div><br>  Si le caractère de tabulation est utilisé comme délimiteur dans votre CSV, alors dans le script, vous devez définir <i>-Delimiter "` t "</i> <br><br>  Veuillez noter que si une imprimante n'est pas disponible sur le serveur pendant l'exécution du script, l'ajout au serveur d'impression prendra plus de temps (2-3 minutes au lieu de quelques secondes) <br><br>  Le résultat du script: <br><div class="spoiler">  <b class="spoiler_title">cliquer</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/fj/jd/-t/fjjd-tcfaowketxq9u7av7yzfzk.png"><br></div></div><br><br>  Pour vous assurer que tout fonctionne à ce stade, ajoutez une imprimante partagée à l'une des machines clientes du serveur d'impression principal à l'aide du CNAME précédemment créé (par exemple, \\ print \ printer01) et essayez d'imprimer quelque chose dessus.  <s>A cet effet, la phrase «Prévenu, je suis un morceau de papier», tapée en gras Arial au 200e, convient le mieux à cet effet.</s> <br><br><h2>  Configurer un deuxième serveur </h2><br><blockquote>  Un artista copia, un gran artista roba (Pablo Picasso) </blockquote><br>  Notre <i>prn-srv02</i> n'a pas encore atteint le niveau de gran artista, nous nous limiterons donc à la copie.  <s>Bien que ... c'est possible avec un coup de poignet ...</s> <br><br>  Nous créons et partageons au moins une imprimante, sinon PrintBrm donnera une erreur.  Vous pouvez créer un faux, mais il est important de ne pas choisir le mauvais pilote ou le mauvais port.  Par exemple, une imprimante avec un pilote Microsoft XPS Document Writer ou un port FILE ne peut pas être partagée. <br><br>  Nous créons un script de synchronisation simple.  Je préfère PowerShell, mais personne n'interdit de créer un fichier batch de tube chaud. <br><br><div class="spoiler">  <b class="spoiler_title">PrintSync.ps1</b> <div class="spoiler_text"><pre> <code class="hljs mel">#   PrintBrm $ProgramPath = <span class="hljs-string"><span class="hljs-string">'C:\Windows\System32\Spool\Tools\PrintBrm.exe'</span></span> #    $SourceServer = <span class="hljs-string"><span class="hljs-string">'prn-srv01'</span></span> $DestServer = <span class="hljs-string"><span class="hljs-string">'prn-srv02'</span></span> #,   .     , ..  PrintBrm       $ConfigFilePath = <span class="hljs-string"><span class="hljs-string">'C:\Scripts\prn-config.printerExport'</span></span> #    $Arguments = <span class="hljs-string"><span class="hljs-string">"-s $SourceServer -f $ConfigFilePath -b"</span></span> Start-process $ProgramPath -ArgumentList $Arguments -Wait -PassThru #    $Arguments = <span class="hljs-string"><span class="hljs-string">"-s $DestServer -f $ConfigFilePath -r -o force"</span></span> Start-process $ProgramPath -ArgumentList $Arguments -Wait -PassThru #   Del $ConfigFilePath</code> </pre><br></div></div><br><br>  Nous mettons le script dans un endroit isolé (dans l'exemple c'est <i>C: \ Scripts</i> ) et créons une tâche dans le Planificateur. <br>  Nous allons exécuter à partir du compte svc-printsync précédemment créé avec les autorisations les plus élevées: <br><div class="spoiler">  <b class="spoiler_title">cliquer</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/sp/ax/9w/spax9w_u6llu5ekhxh6ezfq8zdi.png"><br></div></div><br>  Déterminez vous-même la fréquence d'exécution.  Assez pour moi une fois par jour: <br><div class="spoiler">  <b class="spoiler_title">cliquer</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/m8/a5/hm/m8a5hm3qm5dosyvvd8uivsrdeaq.png"><br></div></div><br>  Dans l'onglet Actions, créez une nouvelle action de lancement PowerShell: <br> <code>C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe</code> <br>  Comme arguments, nous définissons le chemin d'accès au script avec les paramètres suivants: <br> <code>C:\Scripts\PrintSync.ps1 -NonInteractive -WindowStyle Hidden -ExecutionPolicy Bypass</code> <br> <div class="spoiler">  <b class="spoiler_title">cliquer</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/c2/dw/zi/c2dwzipe2ifr6vstp2qgpvr-cc4.png"><br></div></div><br>  Nous laissons le reste des paramètres de tâche dans les onglets <i>Conditions</i> et <i>Paramètres</i> par défaut. <br>  Lors de l'enregistrement de la tâche, un mot de passe sera demandé pour le compte <i>svc-printsync</i> .  Tu ne l’as pas oublié?  Si vous avez déjà oublié (l'article est long), alors <s>tout a été fait en vain et la vie a échoué,</s> réinitialisez-le à l'aide du composant logiciel enfichable ADUC ou d'une autre manière pratique <s>et spécifiez-le déjà dans le champ de description pour le rendre plus calme</s> . <br><br><div class="spoiler">  <b class="spoiler_title">Remarque</b> <div class="spoiler_text">  Il n'est pas nécessaire d'exécuter le travail sur le serveur d'impression de sauvegarde.  Si vous avez un serveur distinct pour exécuter des routines, vous pouvez créer une tâche dessus.  Dans ce cas, le compte <i>svc-printsync</i> doit avoir le droit de se connecter en tant que tâche par lots sur ce serveur.  Par défaut, le groupe local <i>Opérateurs de sauvegarde</i> a ce droit, et si cela ne change pas dans votre environnement, alors incluez simplement le compte de service dans le groupe d'opérateurs d'archives du serveur sur lequel la tâche s'exécutera. <br></div></div><br><br>  Pour la première fois, nous démarrons la tâche manuellement et attendons son achèvement. <br>  Pour mon zoo, où il y a environ 50 imprimantes de types différents, à la fois en voie de disparition et récemment développées, la procédure de synchronisation prend environ 10 minutes.  Le fichier pèse en même temps près de 1 Go. <br>  Pour accélérer le processus d'importation / exportation, vous pouvez utiliser le <i>commutateur -NOBIN</i> , qui est responsable de la copie des pilotes.  Cela a du sens lorsque le parc d'imprimantes est composé des mêmes modèles et que les pilotes nécessaires sont installés sur tous les serveurs. <br><br>  Une fois l'opération terminée, exécutez le composant logiciel enfichable <i>Observateur d'événements</i> , accédez à la section <i>Journaux des applications et des services</i> , ouvrez le <i>journal Microsoft \ Microsoft \ PrintBRM \ Administrator</i> et analysez-le à la recherche d'erreurs et d'avertissements.  <s>Et s'il y en a trop, alors nous sommes plus susceptibles de nettoyer le magazine afin que nos yeux ne callosent pas.</s> <br><br>  Je suis tombé sur les codes 20, 22, 80 et 81. Par exemple, <br><div class="spoiler">  <b class="spoiler_title">tel</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/be/sx/7u/besx7uy6lxapuzrxj3_mrsg9agc.png"><br></div></div><br>  Comme il ressort clairement du texte, un problème est survenu lors du transfert d'un pilote spécifique.  En parcourant le journal, nous dressons une liste des pilotes problématiques et les mettons sur le serveur de sauvegarde avec nos mains, ou les remplaçons par d'autres qui ne sont pas opposés aux voyages.  Je n'ai eu que des problèmes avec HP, Kyocera et Konica Minolta, aucune erreur n'a été détectée pour les pilotes d'autres fabricants (peut-être parce qu'ils sont meilleurs ou peut-être parce que nous ne les avons tout simplement pas). <br>  Par conséquent, vous devez obtenir la même liste d'imprimantes sur les serveurs principal et de sauvegarde et l'absence d'erreurs et d'avertissements dans les journaux. <br><br><h2>  Passer à réserver </h2><br>  <s>Sous le coup des haches et le grincement des fourchettes, nous barricadons la porte de notre bureau et éteignons le téléphone.</s>  Exécutez le composant logiciel enfichable DNS et modifiez l'enregistrement CNAME afin qu'il pointe vers le serveur de sauvegarde: <br><div class="spoiler">  <b class="spoiler_title">cliquer</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/3n/kh/p5/3nkhp5g6apvxj1ejoheth9hlcfu.png"><br></div></div><br>  Après un certain temps (qu'avez-vous mis dans TTL là-bas?), Les <s>cris menaçants se calmeront, les</s> machines clientes passeront à prn-srv02 <s>et la porte avec le téléphone peut être déverrouillée</s> . <br><br><h2>  Reviens </h2><br>  Si, lors de la récupération du serveur principal sur la sauvegarde, des modifications de configuration doivent être enregistrées, nous démarrons la synchronisation dans le sens opposé.  Pour ce faire, dans le script <i>PrintSync.ps1</i> ci-dessus <i>,</i> nous <i>échangeons</i> les valeurs des variables <i>$ SourceServer</i> et <i>$ DestServer</i> .  Après avoir transféré les modifications, n'oubliez pas de renvoyer ces valeurs, sinon tous les changements dans la configuration de l'imprimante sur <i>prn-srv01</i> seront impitoyablement <i>balayés</i> chaque nuit par la mauvaise volonté du destin. <br>  Dans le composant logiciel enfichable DNS, définissez l' <i>impression</i> pour l'enregistrement CNAME sur la valeur du nœud de destination prn-srv01 - et tout revient à la case départ. <br><br><h2>  Quel est le résultat? </h2><br>  Applaudissements orageux de la direction, jetant l'administrateur dans ses bras, augmentant le salaire (à l'auteur de l'article - honnête 10% de l'augmentation) ... <br>  Eh bien, quelques réflexions dans le sens d'une orientation de plus belle beauté. <br><br>  Malheureusement, il n'y a pas assez de miracles pour tout le monde et cette solution n'est pas un basculement à part entière.  Si au moment de l'effondrement du serveur d'impression principal, il y a des files d'attente d'impression non vides, alors leur contenu disparaîtra très probablement dans l'air et quelqu'un devra répéter l'envoi de l'impression. <br><br>  Mais il sera très pratique pour les utilisateurs d'effectuer de manière transparente la maintenance de routine des serveurs d'impression. <br><div class="spoiler">  <b class="spoiler_title">Vous suivez les recommandations de Microsoft?</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/s9/dr/bm/s9drbmkdazxkxaswuw4flitnsoi.jpeg"><br></div></div><br><br>  Les fans d'automatisation peuvent aller plus loin et créer un script qui reçoit les noms de serveur avec un intervalle de synchronisation à l'entrée et fait le reste des paramètres lui-même: crée un compte de service si nécessaire, une tâche dans le planificateur, etc. <br><br>  Les gourous de surveillance ajouteront la surveillance de la tâche de synchronisation et des erreurs dans les journaux. <br><br>  Les amateurs de creuser plus profondément peuvent penser à la synchronisation bidirectionnelle dans l'esprit de la réplication AD avec des changements de suivi du temps pour chaque imprimante.  PrintBrm n'aidera pas ici, mais personne n'a annulé PowerShell! <br><br>  La cerise sur le gâteau sera l'installation automatique d'imprimantes sur les machines clientes utilisant GPP, ciblant le groupe AD.  Ajoutez l'utilisateur au groupe - et l'imprimante souhaitée vole vers lui.  Certes, c'est une autre histoire qui dépasse le cadre de l'article. <br><br>  J'espère pour quelqu'un que ma publication sera utile.  Je souhaite à tout le monde moins de problèmes et j'attends avec impatience les questions et suggestions dans les commentaires. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr414369/">https://habr.com/ru/post/fr414369/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr414357/index.html">Nous utilisons l'API Web Bluetooth pour connecter le moniteur de fréquence cardiaque et développer l'application à l'aide de Vue.js</a></li>
<li><a href="../fr414359/index.html">Interaction avec le serveur via l'API dans iOS sur Swift 3. Partie 1</a></li>
<li><a href="../fr414361/index.html">Unity3D: architecture de jeu, objets scriptables, singletones</a></li>
<li><a href="../fr414363/index.html">Le condensé de matières fraîches du monde du front-end de la dernière semaine n ° 319 (11-17 juin 2018)</a></li>
<li><a href="../fr414367/index.html">Galop en trois ans: ce qui peut être intéressant à relire sur le blog HashFlare</a></li>
<li><a href="../fr414371/index.html">Classe d'école et un petit croquis de l'ingénierie sociale</a></li>
<li><a href="../fr414373/index.html">Conception asynchrone / attente JavaScript: forces, pièges et modèles d'utilisation</a></li>
<li><a href="../fr414375/index.html">Commandes pour travailler avec la console JavaScript dans les navigateurs et augmenter la productivité du programmeur</a></li>
<li><a href="../fr414377/index.html">Innovations des littéraux d'objets dans JavaScript ES6</a></li>
<li><a href="../fr414379/index.html">«Ceux qui sont prêts à échanger la liberté contre la sécurité ne sont dignes ni de liberté ni de sécurité» (source originale)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>