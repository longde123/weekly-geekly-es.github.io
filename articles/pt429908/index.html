<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üîå üë®üèæ‚Äçüíª üë©üèæ‚Äçü§ù‚Äçüë©üèº Como usar corotinas na comida e dormir tranquilamente √† noite üéê üëµ üë©üèø‚Äçüé®</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As corotinas s√£o uma ferramenta poderosa para execu√ß√£o de c√≥digo ass√≠ncrono. Eles trabalham em paralelo, se comunicam e consomem poucos recursos. Pare...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como usar corotinas na comida e dormir tranquilamente √† noite</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/429908/">  As corotinas s√£o uma ferramenta poderosa para execu√ß√£o de c√≥digo ass√≠ncrono.  Eles trabalham em paralelo, se comunicam e consomem poucos recursos.  Parece que, sem medo, as corotinas podem ser introduzidas na produ√ß√£o.  Mas h√° medos e eles interferem. <br><br>  O <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">relat√≥rio de</a> <strong>Vladimir Ivanov</strong> no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">AppsConf</a> √© sobre o fato de que o diabo n√£o √© t√£o terr√≠vel e que voc√™ pode usar corotinas agora: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">por que coroutines, n√£o RxJava</a> ; </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">o que teme atrapalha desenvolvedores</a> ; </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">como fazer um cache usando corotinas</a> ; </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">como lidar com erros corretamente</a> . </li></ul><br><iframe width="560" height="315" src="https://www.youtube.com/embed/1lEG1CPkRaw" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  <strong>Sobre o palestrante</strong> : Vladimir Ivanov ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">dzigoro</a> ) √© um desenvolvedor l√≠der de Android na <strong>EPAM,</strong> com 7 anos de experi√™ncia, gosta de Arquitetura de Solu√ß√µes, React Native e desenvolvimento iOS e tamb√©m possui um certificado do <strong>Google Cloud Architect</strong> . <br><a name="habracut"></a><br><blockquote>  Tudo o que voc√™ l√™ √© um produto da produ√ß√£o de experi√™ncia e de v√°rios estudos; portanto, tome como est√°, sem qualquer garantia. <br></blockquote><h2><a name="coroutine"></a>  Corotinas, Kotlin e RxJava </h2><br>  Para informa√ß√µes: o status atual de corutin est√° no release, deixado Beta.  <strong>O Kotlin 1.3</strong> foi lan√ßado, as corotinas s√£o declaradas est√°veis ‚Äã‚Äãe h√° paz no mundo. <br><br><img src="https://habrastorage.org/webt/it/jm/db/itjmdbtgjewt6v1kihv_5urqxie.png"><br><br>  Recentemente, conduzi uma pesquisa no Twitter de que as pessoas que usam corotina: <br><br><ul><li>  13% das corotinas nos alimentos.  Tudo est√° bem; </li><li>  25% experiment√°-los no projeto pet; </li><li>  24% - O que √© Kotlin? </li><li>  A maior parte do 38% RxJava est√° em toda parte. </li></ul><br>  As estat√≠sticas n√£o s√£o felizes.  Acredito que o <strong>RxJava √© uma ferramenta muito complexa</strong> para tarefas nas quais √© comumente usada por desenvolvedores.  As corotinas s√£o mais adequadas para controlar a opera√ß√£o ass√≠ncrona. <br><br>  Nos meus relat√≥rios anteriores, falei sobre como refatorar o RxJava para as corotinas em Kotlin, por isso n√£o vou me debru√ßar sobre isso em detalhes, mas apenas relembrar os pontos principais. <br><br><h3>  Por que usamos corotinas? </h3><br>  Como se usarmos o RxJava, os exemplos de implementa√ß√£o comuns ser√£o assim: <br><br><pre><code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApiClientRx</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">login</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(auth: Authorization)</span></span></span><span class="hljs-function"> : Single&lt;GithubUser&gt; fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRepositories</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(reposUrl: String, auth: Authorization)</span></span></span><span class="hljs-function"> : Single&lt;List&lt;GithubRepository&gt;&gt; } </span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-comment">//RxJava 2 implementation</span></span></span></span></code> </pre> <br>  Temos uma interface, por exemplo, escrevemos um cliente GitHub e queremos executar algumas opera√ß√µes para ele: <br><br><ol><li>  Usu√°rio de logon. <br></li><li>  Obtenha uma lista dos reposit√≥rios do GitHub. <br></li></ol><br>  Nos dois casos, as fun√ß√µes retornar√£o Objetos de neg√≥cios √∫nicos: GitHubUser ou uma lista de GitHubRepository. <br><br>  O c√≥digo de implementa√ß√£o para esta interface √© o seguinte: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">attemptLoginRx</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ showProgress(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) compositeDisposable.add(apiClient.login(auth) .flatMap { user -&gt; apiClient.getRepositories(user.repos_url, auth) } .map { list -&gt; list.map { it.full_name } } .subscribeOn(Schedulers.io()) .observeOn(AndroidSchedulers.mainThread()) .doFinally { showProgress(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) } .subscribe( { list -&gt; showRepositories(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, list) }, { error -&gt; Log.e(<span class="hljs-string"><span class="hljs-string">"TAG"</span></span>, <span class="hljs-string"><span class="hljs-string">"Failed to show repos"</span></span>, error) } )) }</code> </pre><br>  - Tomamos <strong>CompositeDisposable</strong> para que n√£o haja vazamento de mem√≥ria. <br>  - Adicione uma chamada ao primeiro m√©todo. <br>  - Utilizamos operadores convenientes para obter o usu√°rio, por exemplo <strong>flatMap</strong> . <br>  - N√≥s temos uma lista de seus reposit√≥rios. <br>  - N√≥s escrevemos um <strong>Boilerplate</strong> para que ele <strong>funcione</strong> nos threads certos. <br>  - Quando tudo estiver pronto, mostramos a lista de reposit√≥rios para o usu√°rio conectado. <br><br>  <strong>Dificuldades com o c√≥digo RxJava:</strong> <br><br><ul><li>  <strong>Complexidade</strong>  Na minha opini√£o, o c√≥digo √© muito complicado para a tarefa simples de duas chamadas de rede e exibir algo na <strong>interface</strong> do <strong>usu√°rio</strong> . </li><li>  <strong>Rastreios de pilha n√£o acoplados.</strong>  Rastreios de pilha quase n√£o est√£o relacionados ao c√≥digo que voc√™ escreve. </li><li>  <strong>Recursos em excesso</strong> <strong>.</strong>  O RxJava gera muitos objetos sob o cap√¥ e o desempenho pode diminuir. </li></ul><br>  <strong>Qual ser√° o mesmo c√≥digo com corotinas at√© a vers√£o 0.26?</strong> <br><br>  Em 0,26, a API mudou e estamos falando sobre produ√ß√£o.  Ningu√©m conseguiu aplicar 0,26 no produto, mas estamos trabalhando nisso. <br><br>  <strong>Com as corotinas, nossa interface mudar√° bastante</strong> .  As fun√ß√µes interromper√£o o retorno de Singles e outros objetos auxiliares.  Eles retornar√£o imediatamente objetos de neg√≥cios: GitHubUser e uma lista de GitHubRepository.  As fun√ß√µes GitHubUser e GitHubRepository ter√£o modificadores de <strong>suspens√£o</strong> .  Isso √© bom, porque suspender quase n√£o nos obriga a nada: <br><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApiClient</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">suspend fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">login</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(auth: Authorization)</span></span></span><span class="hljs-function"> : GithubUser suspend fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRepositories</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(reposUrl: String, auth: Authorization)</span></span></span><span class="hljs-function"> : List&lt;GithubRepository&gt; } </span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-comment">//Base interface</span></span></span></span></code> </pre><br>  Se voc√™ observar o c√≥digo que j√° usa a implementa√ß√£o dessa interface, ele ser√° alterado significativamente em compara√ß√£o com o RxJava: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">attemptLogin</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ launch(UI) { val auth = BasicAuthorization(login, pass) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { showProgress(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) val userlnfo = async { apiClient.login(auth) }.await() val repoUrl = userlnfo.repos_url val list = async { apiClient.getRepositories(repoUrl, auth) }.await() showRepositories( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, list.map { it -&gt; it.full_name } ) } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (e: RuntimeException) { showToast(<span class="hljs-string"><span class="hljs-string">"Oops!"</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { showProgress(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) } } }</code> </pre><br>  - A a√ß√£o principal ocorre quando chamamos de <strong>coroutine builder async</strong> , aguardamos uma resposta e obtemos <strong>userlnfo</strong> . <br>  - Usamos dados deste objeto. <br>  - Fa√ßa outra chamada <strong>ass√≠ncrona</strong> e <strong>aguarde</strong> . <br><br>  Tudo parece que nenhum trabalho ass√≠ncrono est√° acontecendo, e apenas escrevemos os comandos na coluna e eles s√£o executados.  No final, fazemos o que precisa ser feito na interface do usu√°rio. <br><br>  <strong>Por que as corotinas s√£o melhores?</strong> <br><br><ul><li>  Este c√≥digo √© mais f√°cil de ler.  Est√° escrito como se fosse consistente. </li><li>  Provavelmente, o desempenho desse c√≥digo √© melhor do que no RxJava. </li><li>  √â muito simples escrever testes, mas vamos encontr√°-los um pouco mais tarde. </li></ul><br><h2>  2 passos para o lado <br></h2><br>  Vamos discordar um pouco, h√° algumas coisas que ainda precisam ser discutidas. <br><br><h3>  Etapa 1. withContext vs launch / async <br></h3><br>  Al√©m do <strong>ass√≠ncrono do construtor de corotina,</strong> h√° o <strong>construtor de corotina com o Contexto</strong> . <br><br>  <strong>Iniciar</strong> ou <strong>ass√≠ncrono</strong> cria um novo <strong>contexto de Coroutine</strong> , que nem sempre √© necess√°rio.  Se voc√™ tiver um contexto de Coroutine que deseja usar em todo o aplicativo, n√£o precisar√° recri√°-lo.  Voc√™ pode simplesmente reutilizar um existente.  Para fazer isso, voc√™ precisar√° de um construtor de corotina com Contexto.  Ele simplesmente reutiliza o contexto existente da Coroutine.  Ser√° 2-3 vezes mais r√°pido, mas agora √© uma pergunta sem princ√≠pios.  Se os n√∫meros exatos forem interessantes, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui est√° a pergunta</a> sobre o <strong>stackoverflow</strong> com benchmarks e detalhes. <br><br><blockquote>  <strong>Regra geral:</strong> use withContext sem d√∫vida onde ele se encaixa semanticamente.  Mas se voc√™ precisar de carregamento paralelo, por exemplo, v√°rias fotos ou dados, ent√£o async / waitit √© a sua escolha. <br></blockquote><br><h3>  Etapa 2. Refatora√ß√£o <br></h3><br>  E se voc√™ refatorar uma cadeia RxJava realmente complexa?  Me deparei com isso na produ√ß√£o: <br><br><pre> <code class="java hljs">observable1.getSubject().zipWith(observable2.getSubject(), (t1, t2) -&gt; { <span class="hljs-comment"><span class="hljs-comment">// side effects return true; }).doOnError { // handle errors } .zipWith(observable3.getSubject(), (t3, t4) -&gt; { // side effects return true; }).doOnComplete { // gather data } .subscribe()</span></span></code> </pre><br>  Eu tinha uma corrente complicada com um <strong>assunto p√∫blico</strong> , com <strong>z√≠per</strong> e <strong>efeitos</strong> <strong>colaterais</strong> em cada <strong>z√≠per</strong> que enviavam outra coisa para o √¥nibus do evento.  A tarefa pelo menos era livrar-se do barramento de eventos.  Fiquei um dia sentado, mas n√£o pude refatorar o c√≥digo para resolver o problema.  <strong>A decis√£o certa acabou descartando tudo e reescrevendo o c√≥digo na corotina em 4 horas</strong> . <br><br>  O c√≥digo abaixo √© muito semelhante ao que recebi: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { val firstChunkJob = async { call1 } val secondChunkJob = async { call2 } val thirdChunkJob = async { call3 } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Result( firstChunkJob.await(), secondChunkJob.await(), thirdChunkJob.await()) } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (e: Exception) { <span class="hljs-comment"><span class="hljs-comment">// handle errors }</span></span></code> </pre><br>  - Ass√≠ncrono para uma tarefa, para a segunda e terceira. <br>  - Estamos aguardando o resultado e colocamos tudo em um objeto. <br>  - Feito! <br><br>  Se voc√™ tem cadeias complexas e existem corotinas, basta refatorar.  √â realmente r√°pido. <br><br><h2><a name="fear"></a>  O que impede os desenvolvedores de usar corotinas no prod? <br></h2><br>  Na minha opini√£o, atualmente, como desenvolvedores, somos impedidos de usar corotinas apenas pelo medo de algo novo: <br><br><ul><li>  N√£o sabemos o que fazer com o <strong>ciclo de vida</strong> , <strong>atividade</strong> e ciclo de vida do fragmento.  Como trabalhar com corotinas nesses casos? </li><li>  N√£o h√° experi√™ncia na solu√ß√£o de tarefas complexas di√°rias na produ√ß√£o usando corutin. </li><li>  Ferramentas insuficientes.  Um monte de bibliotecas e fun√ß√µes foram escritas para o RxJava.  Por exemplo <strong>RxFCM</strong> .  O pr√≥prio RxJava possui muitos operadores, o que √© bom, mas e a rotina? </li><li>  N√≥s realmente n√£o entendemos como testar corotinas. </li></ul><br><blockquote>  Se nos livrarmos desses quatro medos, podemos dormir em paz √† noite e usar corotinas na produ√ß√£o. <br></blockquote><br>  Vamos ponto por ponto. <br><br><h3>  1. Gerenciamento do ciclo de vida <br></h3><br><ul><li>  As corotinas podem vazar como <strong>descart√°veis</strong> ou <strong>AsyncTask</strong> .  Este problema deve ser resolvido manualmente. </li><li>  Para evitar uma <strong>exce√ß√£o</strong> aleat√≥ria de <strong>ponteiro nulo, as</strong> rotinas devem ser interrompidas. </li></ul><br><h4>  Parar <br></h4><br>  Voc√™ est√° familiarizado com o <strong>Thread.stop ()</strong> ?  Se voc√™ o usou, n√£o por muito tempo.  No <strong>JDK 1.1, o</strong> m√©todo foi imediatamente declarado obsoleto, pois √© imposs√≠vel pegar e parar um determinado trecho de c√≥digo e n√£o h√° garantias de que ele ser√° conclu√≠do corretamente.  Provavelmente voc√™ ter√° apenas <strong>corrup√ß√£o de mem√≥ria</strong> . <br><br>  Portanto, <strong>Thread.stop () n√£o funciona</strong> .  Voc√™ precisa que o cancelamento seja cooperativo, ou seja, o c√≥digo do outro lado para saber que voc√™ est√° cancelando. <br><br>  Como aplicamos paradas com o RxJava: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> val compositeDisposable = CompositeDisposable() <span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">requestSmth</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ compositeDisposable.add( apiClientRx.requestSomething() .subscribeOn(Schedulers.io()) .observeOn(AndroidSchedulers.mainThread()) .subscribe(result -&gt; {}) } <span class="hljs-function"><span class="hljs-function">override fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onDestroy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ compositeDisposable.dispose() }</code> </pre><br><br>  No RxJava, <strong>usamos CompositeDisposable</strong> . <br><br>  - Adicione a vari√°vel <strong>compositeDisposable</strong> √† atividade no fragmento ou no apresentador, onde usamos o RxJava. <br>  - Em <strong>onDestro,</strong> adicione <strong>Dispose</strong> e todas as exce√ß√µes desaparecem sozinhas. <br><br>  Aproximadamente o mesmo princ√≠pio com corotinas: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> val job: Job? = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">null</span></span></span><span class="hljs-function"> fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">requestSmth</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ job = launch(UI) { val user = apiClient.requestSomething() ‚Ä¶ } } <span class="hljs-function"><span class="hljs-function">override fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onDestroy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ job?.cancel() }</code> </pre><br>  Considere um exemplo de uma <strong>tarefa simples</strong> . <br><br>  Normalmente, os <strong>construtores de corotina</strong> retornam um <strong>trabalho</strong> e, em alguns casos, <strong>Adiados</strong> . <br><br>  - Podemos memorizar este trabalho. <br>  - D√™ o comando <strong>"launch"</strong> <strong>coroutine builder</strong> .  O processo inicia, algo acontece, o resultado da execu√ß√£o √© lembrado. <br>  - Se n√£o passarmos mais nada, o comando "launch" inicia a fun√ß√£o e retorna um link para o trabalho. <br>  - J√≥ √© lembrado e, no onDestroy, dizemos <strong>"cancelar"</strong> e tudo funciona bem. <br><br>  <strong>Qual √© o problema da abordagem?</strong>  Cada trabalho precisa de um campo.  Voc√™ precisa manter uma lista de trabalhos para cancel√°-los todos juntos.  A abordagem leva √† duplica√ß√£o de c√≥digo, n√£o fa√ßa isso. <br><br>  A boa not√≠cia √© que temos <strong>alternativas</strong> : <strong>CompositeJob</strong> e <strong>trabalho que reconhece o ciclo de vida</strong> . <br><br>  CompositeJob √© um an√°logo de compositeDisposable.  Parece algo como isto <strong>:</strong> <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> val job: CompositeJob = CompositeJob() <span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">requestSmth</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ job.add(launch(UI) { val user = apiClient.requestSomething() ... }) } <span class="hljs-function"><span class="hljs-function">override fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onDestroy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ job.cancel() }</code> </pre><br>  - Para um fragmento, come√ßamos um trabalho. <br>  - Colocamos todos os <strong>trabalhos</strong> no CompositeJob e damos o comando: <strong>"job.cancel () para todos!"</strong>  . <br><br>  A abordagem √© facilmente implementada em 4 linhas, sem contar a declara√ß√£o de classe: <br><br><pre> <code class="java hljs">Class CompositeJob { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> val map = hashMapOf&lt;String, Job&gt;() <span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(job: Job, key: String = job.hashCode()</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">) </span></span>= map.put(key, job)?.cancel() <span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cancel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(key: String)</span></span></span><span class="hljs-function"> </span></span>= map[key]?.cancel() <span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cancel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>= map.forEach { _ ,u -&gt; u.cancel() } }</code> </pre><br><br>  Voc√™ precisar√° de: <br><br>  - <strong>mapa</strong> com uma chave de cadeia, <br>  - m√©todo <strong>add</strong> , no qual voc√™ adicionar√° trabalho, <br>  - par√¢metro <strong>chave</strong> opcional. <br><br>  Se voc√™ deseja usar a mesma chave para o mesmo trabalho - por favor.  Caso contr√°rio, o <strong>hashCode</strong> resolver√° o nosso problema.  Adicione o trabalho ao mapa pelo qual passamos e cancele o anterior com a mesma chave.  Se cumprirmos demais a tarefa, o resultado anterior n√£o nos interessa.  N√≥s a cancelamos e dirigimos novamente. <br><br>  Cancelar √© simples: conseguimos o trabalho com a tecla e cancelamos.  O segundo cancelamento de todo o mapa cancela tudo.  Todo o c√≥digo √© escrito em meia hora em quatro linhas e funciona.  Se voc√™ n√£o quiser escrever, siga o exemplo acima. <br><br><h4>  Trabalho com reconhecimento do ciclo de vida </h4><br>  Voc√™ j√° usou o <strong>Android Lifecycle</strong> , <strong>propriet√°rio</strong> ou <strong>observador do</strong> <strong>Lifecycle</strong> ? <br><img src="https://habrastorage.org/webt/ud/pi/eq/udpieqn_xba30yasl2buwbs2bay.png"><br><br>  Nossa <strong>atividade</strong> e <strong>fragmentos</strong> t√™m certos estados.  Destaques: <strong>criados,</strong> <strong>iniciados</strong> e <strong>retomados</strong> .  Existem diferentes transi√ß√µes entre estados.  <strong>O LifecycleObserver</strong> permite que voc√™ assine essas transi√ß√µes e fa√ßa alguma coisa quando uma delas ocorrer. <br><br>  Parece bem simples: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyObserver</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LifecycleObserver</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@OnLifecycleEvent</span></span>(Lifecycle.Event.ON_RESUME) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">connectListener</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ ... } <span class="hljs-meta"><span class="hljs-meta">@OnLifecycleEvent</span></span>(Lifecycle.Event.ON_PAUSE) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">disconnectListener</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ ‚Ä¶ } }</code> </pre><br>  Voc√™ desliga a anota√ß√£o com algum par√¢metro no m√©todo, e ela √© chamada com a transi√ß√£o correspondente.  Basta usar esta abordagem para a rotina: <br><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AndroidJob</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lifecycle</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Lifecycle</span></span></span><span class="hljs-class">) : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Job</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">by</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Job</span></span></span><span class="hljs-class">(), </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LifecycleObserver</span></span></span><span class="hljs-class"> </span></span>{ init { lifecycle.addObserver(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>) } <span class="hljs-meta"><span class="hljs-meta">@OnLifecycleEvent</span></span>(Lifecycle.Event.ON_DESTROY) <span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">destroy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Log.d(<span class="hljs-string"><span class="hljs-string">"AndroidJob"</span></span>, <span class="hljs-string"><span class="hljs-string">"Cancelling a coroutine"</span></span>) cancel() } }</code> </pre><br>  - Voc√™ pode escrever a classe base <strong>AndroidJob</strong> . <br>  - Transferiremos o <strong>Ciclo de vida da</strong> turma. <br>  - A interface <strong>LifecycleObserver</strong> implementar√° o trabalho. <br><br>  Tudo o que precisamos: <br><br>  - No construtor, adicione ao Lifecycle como um Observer. <br>  - Assine <strong>ON_DESTROY</strong> ou qualquer outra coisa que nos interesse. <br>  - Fa√ßa o cancelamento em ON_DESTROY. <br>  - <strong>Obtenha</strong> um <strong>job pai</strong> no seu fragmento. <br>  - Chame o construtor <strong>Joy jobs</strong> ou o <strong>ciclo de vida do</strong> seu fragmento de atividade.  N√£o faz diferen√ßa. <br>  - Passe este <strong>parentJob</strong> como <strong>pai</strong> . <br><br>  O c√≥digo final √© assim: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> parentJob = AndroidJob(lifecycle) <span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">do</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ job = launch(UI, parent = parentJob) { <span class="hljs-comment"><span class="hljs-comment">// code } }</span></span></code> </pre><br>  Quando voc√™ cancela o pai, todas as rotinas filho s√£o canceladas e voc√™ n√£o precisa mais escrever nada no fragmento.  Tudo acontece automaticamente, n√£o √© mais ON_DESTROY.  O principal n√£o se esque√ßa de passar <strong>parent = parentJob</strong> . <br><br><blockquote>  Se voc√™ usar, poder√° escrever uma regra simples de fiapos que destacar√° voc√™: "Ah, voc√™ esqueceu seus pais!" <br></blockquote><br>  Com <strong>&nbsp;</strong>  Gerenciamento do ciclo de vida resolvido.  Temos algumas ferramentas que permitem que voc√™ fa√ßa isso de maneira f√°cil e confort√°vel. <br><br>  E os cen√°rios complexos e as tarefas n√£o triviais na produ√ß√£o? <br><br><h3>  2. Casos de uso complexos <br></h3><br>  Cen√°rios complexos e tarefas n√£o triviais s√£o: <br><br>  - <strong>Operadores</strong> - operadores complexos no RxJava: flatMap, debounce, etc. <br>  - <strong>Tratamento de erros - tratamento</strong> complexo de erros.  N√£o apenas <strong>tente ... capturar</strong> , mas aninhado por exemplo. <br>  - O <strong>armazenamento em cache</strong> <strong>√© uma</strong> tarefa n√£o trivial.  Na produ√ß√£o, encontramos um cache e quer√≠amos obter uma ferramenta para resolver facilmente o problema de cache com corotinas. <br><br><h4>  Repetir </h4><br>  Quando pensamos nos operadores da corotina, a primeira op√ß√£o foi <strong>repeatWhen ()</strong> . <br><br>  Se algo deu errado e Corutin n√£o conseguiu acessar o servidor interno, queremos tentar v√°rias vezes com algum tipo de fallback exponencial.  Talvez o motivo seja uma conex√£o ruim e obteremos o resultado desejado repetindo a opera√ß√£o v√°rias vezes. <br><br>  Com corotinas, esta tarefa √© facilmente implementada: <br><br><pre> <code class="java hljs">suspend fun &lt;T&gt; retryDeferredWithDelay( deferred: () -&gt; Deferred&lt;T&gt;, tries: Int = <span class="hljs-number"><span class="hljs-number">3</span></span>, timeDelay: Long = <span class="hljs-number"><span class="hljs-number">1000L</span></span> ): T { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i in <span class="hljs-number"><span class="hljs-number">1</span></span>..tries) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> deferred().await() } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (e: Exception) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (i &lt; tries) delay(timeDelay) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> e } } <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> UnsupportedOperationException() }</code> </pre><br><br>  Implementa√ß√£o do operador: <br><br>  - Ele adia <strong>adiado</strong> . <br>  - Voc√™ precisar√° chamar <strong>async</strong> para obter esse objeto. <br>  - Em vez de <strong>adiado,</strong> voc√™ pode passar um bloco de suspens√£o e geralmente qualquer <strong>fun√ß√£o de suspens√£o.</strong> <br>  - O loop <strong>for</strong> - voc√™ est√° aguardando o resultado da sua rotina.  Se algo acontecer e o contador de repeti√ß√µes n√£o estiver esgotado, tente novamente com <strong>Atraso</strong> .  Se n√£o, ent√£o n√£o. <br><br>  A fun√ß√£o pode ser facilmente personalizada: coloque um atraso exponencial ou passe uma fun√ß√£o lambda que calcular√° o atraso dependendo das circunst√¢ncias. <br><br>  Use-o, ele funciona! <br><br><h4>  Fechos </h4><br>  N√≥s tamb√©m frequentemente os encontramos.  Aqui, novamente, tudo √© simples: <br><br><pre> <code class="java hljs">suspend fun &lt;T1, T2, R&gt; zip( source1: Deferred&lt;T1&gt;, source2: Deferred&lt;T2&gt;, zipper: BiFunction&lt;T1, T2, R&gt;): R { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> zipper.apply(sourcel.await(), source2.await()) } suspend fun &lt;T1, T2, R&gt; Deferred&lt;T1&gt;.zipWith( other: Deferred&lt;T2&gt;, zipper: BiFunction&lt;T1, T2, R&gt;): R { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> zip(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, other, zipper) }</code> </pre><br>  - Use o <strong>z√≠per</strong> e ligue em espera no seu adiado. <br>  - Em vez de adiado, voc√™ pode usar a fun√ß√£o de suspens√£o e o construtor de corotina com withContext.  Voc√™ transmitir√° o contexto necess√°rio. <br><br>  Isso funciona novamente e espero ter removido esse medo. <br><br><a name="cache"></a><h3>  Cache </h3><br><br>  Voc√™ tem uma implementa√ß√£o de cache em produ√ß√£o com o RxJava?  N√≥s usamos o RxCache. <br><img src="https://habrastorage.org/webt/tz/ym/tn/tzymtn1tykponnxcmz0qqi_qjmi.png"><br><br>  No diagrama √† esquerda: <strong>View</strong> e <strong>ViewModel</strong> .  √Ä direita est√£o as fontes de dados: chamadas de rede e banco de dados. <br><br>  Se queremos que algo seja armazenado em cache, o cache ser√° outra fonte de dados. <br><br>  Tipos de cache: <br><br><ul><li>  <strong>Fonte</strong> de rede para chamadas de rede. </li><li>  <strong>Cache na mem√≥ria</strong> . </li><li>  <strong>Cache persistente</strong> com expira√ß√£o para ser armazenado no disco para que o cache sobreviva √† reinicializa√ß√£o do aplicativo. </li></ul><br>  Vamos escrever um <strong>cache</strong> simples e primitivo para o terceiro caso.  O construtor Coroutine withContext vem em socorro novamente. <br><br><pre> <code class="java hljs">launch(UI) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> data = withContext(dispatcher) { persistence.getData() } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (data == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { data = withContext(dispatcher) { memory.getData() } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (data == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { data = withContext(dispatcher) { network.getData() } memory.cache(url, data) persistence.cache(url, data) } } }</code> </pre><br>  - Voc√™ executa cada opera√ß√£o com withContext e verifica se algum dado est√° chegando. <br>  - Se os dados da <strong>persist√™ncia</strong> n√£o vierem, voc√™ est√° tentando obt√™-los do <strong>memory.cache</strong> . <br>  - Se tamb√©m n√£o houver memory.cache, entre em contato com a <strong>fonte</strong> da <strong>rede</strong> e obtenha seus dados.  N√£o se esque√ßa, √© claro, de colocar todos os caches. <br><br>  Essa √© uma implementa√ß√£o bastante primitiva e h√° muitas perguntas, mas o m√©todo funciona se voc√™ precisar de um cache em um √∫nico local.  Para tarefas de produ√ß√£o, esse cache n√£o √© suficiente.  Algo mais complicado √© necess√°rio. <br><br><h4>  Rx tem RxCache </h4><br>  Para aqueles que ainda usam o RxJava, voc√™ pode usar o RxCache.  N√≥s ainda o usamos tamb√©m.  <strong>RxCache</strong> √© uma biblioteca especial.  Permite armazenar em cache dados e gerenciar seu ciclo de vida. <br><br>  Por exemplo, voc√™ quer dizer que esses dados expirar√£o ap√≥s 15 minutos: "Por favor, ap√≥s esse per√≠odo de tempo, n√£o envie dados do cache, mas envie-me novos dados". <br><br>  A biblioteca √© maravilhosa por apoiar declarativamente a equipe.  A declara√ß√£o √© muito semelhante ao que voc√™ faz com o <strong>Retrofit</strong> : <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FeatureConfigCacheProvider</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@ProviderKey</span></span>(<span class="hljs-string"><span class="hljs-string">"features"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@LifeCache</span></span>(duration = <span class="hljs-number"><span class="hljs-number">15</span></span>, timeUnit = TimeUnit.MINUTES) <span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getFeatures</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( result: Observable&lt;Features&gt;, cacheName: DynamicKey )</span></span></span><span class="hljs-function">: Observable&lt;Reply&lt;Features&gt;&gt; }</span></span></code> </pre><br>  - Voc√™ diz que possui um <strong>CacheProvider</strong> . <br>  - Inicie um m√©todo e diga que a vida √∫til do <strong>LifeCache √© de</strong> 15 minutos.  A chave pela qual estar√° dispon√≠vel √© <strong>Recursos</strong> . <br>  - Retorna <strong>Observ√°vel &lt;Responder</strong> , em que <strong>Responder</strong> √© um objeto de biblioteca auxiliar para trabalhar com cache. <br><br>  O uso √© bastante simples: <br><br><pre> <code class="java hljs">val restObservable = configServiceRestApi.getFeatures() val features = featureConfigCacheProvider.getFeatures( restObservable, DynamicKey(CACHE_KEY) )</code> </pre><br>  - No cache Rx, acesse <strong>RestApi</strong> . <br>  - <strong>V√°</strong> para <strong>CacheProvider</strong> . <br>  - Alimente-o com um observ√°vel. <br>  - A pr√≥pria biblioteca descobrir√° o que fazer: v√° para o cache ou n√£o, se o tempo acabar, v√° para <strong>Observable</strong> e execute outra opera√ß√£o. <br><br>  Usar a biblioteca √© muito conveniente e eu gostaria de obter uma similar para a corotina. <br><br><h4>  Cache de Coroutine em desenvolvimento </h4><br>  No EPAM, estamos escrevendo a biblioteca <strong>Coroutine Cache</strong> , que executar√° todas as fun√ß√µes do RxCache.  N√≥s escrevemos a primeira vers√£o e executamos dentro da empresa.  Assim que o primeiro lan√ßamento for lan√ßado, terei prazer em public√°-lo no meu Twitter.  Ficar√° assim: <br><br><pre> <code class="java hljs">val restFunction = configServiceRestApi.getFeatures() val features = withCache(CACHE_KEY) { restFunction() }</code> </pre><br>  Teremos uma fun√ß√£o de suspens√£o, <strong>getFeatures</strong> .  Passaremos a fun√ß√£o como um bloco para uma fun√ß√£o especial de ordem superior com o <strong>Cache</strong> , que <strong>descobrir√°</strong> o que precisa ser feito. <br><br>  Talvez fa√ßamos a mesma interface para suportar fun√ß√µes declarativas. <br><br><a name="err"></a><h3>  Tratamento de erros <br></h3><br><img src="https://habrastorage.org/webt/sd/qq/uc/sdqqucxxckqchfozdoknxa3vi-k.png"><br><br>  O tratamento simples de erros √© frequentemente encontrado pelos desenvolvedores e geralmente √© resolvido de maneira simples.  Se voc√™ n√£o tem coisas complicadas, pegue uma <strong>exce√ß√£o</strong> e veja o que aconteceu l√°, escreva no log ou mostre o erro ao usu√°rio.  Na interface do usu√°rio, voc√™ pode fazer isso facilmente. <br><br>  Em casos simples, tudo √© esperado de maneira simples - o tratamento de erros com corotinas √© feito atrav√©s do <strong>try-catch-finalmente</strong> . <br><br>  Na produ√ß√£o, al√©m de casos simples, existem: <br><br>  - <strong>try-catch</strong> aninhado, <br>  - Muitos tipos diferentes de <strong>exce√ß√µes</strong> , <br>  - erros na rede ou na l√≥gica de neg√≥cios, <br>  - erros de usu√°rio.  Ele novamente fez algo errado e foi o culpado por tudo. <br><br>  N√≥s devemos estar preparados para isso. <br><br>  Existem 2 solu√ß√µes: <strong>CoroutineExceptionHandler</strong> e a abordagem com as <strong>classes Result</strong> . <br><br><h3>  Manipulador de Exce√ß√£o de Coroutine <br></h3><br>  Esta √© uma classe especial para lidar com casos complexos de erros.  <strong>ExceptionHandler</strong> permite que voc√™ tome sua <strong>exce√ß√£o</strong> como argumento como um erro e lide com isso. <br><br>  Como geralmente lidamos com erros complexos? <br><br>  O usu√°rio pressionou alguma coisa, o bot√£o n√£o funcionou.  Ele precisa dizer o que deu errado e direcion√°-lo para uma a√ß√£o espec√≠fica: verifique a Internet, o Wi-Fi, tente mais tarde ou exclua o aplicativo e nunca mais o use.  Dizer isso ao usu√°rio pode ser bastante simples: <br><br><pre> <code class="java hljs">val handler = CoroutineExceptionHandler(handler = { , error -&gt; hideProgressDialog() val defaultErrorMsg = <span class="hljs-string"><span class="hljs-string">"Something went wrong"</span></span> val errorMsg = when (error) { is ConnectionException -&gt; userFriendlyErrorMessage(error, defaultErrorMsg) is HttpResponseException -&gt; userFriendlyErrorMessage(Endpoint.EndpointType.ENDPOINT_SYNCPLICITY, error) is EncodingException -&gt; <span class="hljs-string"><span class="hljs-string">"Failed to decode data, please try again"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> -&gt; defaultErrorMsg } Toast.makeText(context, errorMsg, Toast.LENGTH_SHORT).show() })</code> </pre><br>  - Vamos receber a mensagem padr√£o: "Algo deu errado!"  e analise a exce√ß√£o. <br>  - Se for uma <strong>ConnectionException,</strong> receberemos uma mensagem localizada dos recursos: ‚ÄúCara, ligue o Wi-Fi e seus problemas desaparecer√£o.  Eu garanto. <br>  - Se o <strong>servidor disser algo errado</strong> , voc√™ precisar√° informar ao cliente: ‚ÄúDesconecte-se e efetue login novamente‚Äù ou ‚ÄúN√£o fa√ßa isso em Moscou, fa√ßa isso em outro pa√≠s‚Äù ou ‚ÄúDesculpe, camarada.  Tudo o que posso fazer √© dizer que algo deu errado. <br>  - Se este √© um <strong>erro</strong> completamente <strong>diferente</strong> , por exemplo, <strong>falta de mem√≥ria</strong> , dizemos: "Algo deu errado, desculpe". <br>  - Todas as mensagens s√£o exibidas. <br><br>  O que voc√™ escreve no <strong>CoroutineExceptionHandler</strong> ser√° executado no mesmo <strong>Dispatcher em</strong> que voc√™ executa a corotina.  Portanto, se voc√™ der o comando da interface do usu√°rio "launch", tudo acontecer√° na interface do usu√°rio.  Voc√™ n√£o precisa de <strong>expedi√ß√£o</strong> separada <strong>, o</strong> que √© muito conveniente. <br><br>  O uso √© simples: <br><br><pre> <code class="java hljs">launch(uiDispatcher + handler) { ... }</code> </pre><br>  Existe um operador <strong>positivo</strong> .  No contexto da Coroutine, adicione um <strong>manipulador</strong> e tudo funcionar√°, o que √© muito conveniente.  N√≥s usamos isso por um tempo. <br><br><h3>  Classes de resultado <br></h3><br>  Mais tarde, percebemos que o CoroutineExceptionHandler pode estar ausente.  O resultado, formado pelo trabalho da corotina, pode consistir em v√°rios dados, de diferentes partes ou processar v√°rias situa√ß√µes. <br><br>  A abordagem de <strong>classes Result</strong> ajuda a lidar com esse problema: <br><br><pre> <code class="java hljs">sealed <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Result</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">data class </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Success</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(val payload: String)</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Result</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> data class </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Error</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(val exception: Exception)</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Result</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> }</span></span></code> </pre><br>  - Na sua l√≥gica de neg√≥cios, voc√™ inicia uma <strong>classe Result</strong> . <br>  - Marcar como <strong>selado</strong> . <br>  - Voc√™ herda da classe duas outras classes de dados: <strong>Sucesso</strong> e <strong>Erro</strong> . <br> ‚Äî  <strong>Success</strong>   ,     . <br> ‚Äî  <strong>Error</strong>  exception. <br><br>     -  : <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-function">override suspend fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doTask</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">: Result </span></span>= withContext(CommonPool) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !isSessionValidForTask() ) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span><span class="hljs-meta"><span class="hljs-meta">@withContext</span></span> Result.Error(Exception()) } ‚Ä¶ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { Result.Success(restApi.call()) } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (e: Exception) { Result.Error(e) } }</code> </pre><br>  Coroutine context ‚Äî Coroutine builder withContex     . <br><br> ,  : <br><br> ‚Äî   ,   error.     . <br> ‚Äî   RestApi   -. <br> ‚Äî   ,   <strong>Result.Success</strong> . <br> ‚Äî   ,  <strong>Result.Error</strong> . <br><br>      - ,  ExceptionHandler   . <br><br> Result classes ,   .   Result classes,      ExceptionHandler  try-catch. <br><br><h3> 3.  <br></h3><br> ,       .    <strong>unit-</strong> ,   ,    .       unit-. <br><br> ,   .   ,   unit-,    2 : <br><br><ol><li> <strong>Replacing context</strong> .   ,    ; </li><li> <strong>Mocking coroutines</strong> .   . </li></ol><br><h4> Replacing context <br></h4><br>   presenter: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-function">val </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">login</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ launch(UI) { ‚Ä¶ } }</code> </pre><br> ,    <strong>login</strong>    ,     UI-.      ,        ,  <strong>         </strong> .    ,    ,   unit-. <br><br>   : <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-function">val </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">login</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(val coroutineContext = UI)</span></span></span><span class="hljs-function"> </span></span>{ launch(coroutineContext) { ... } }</code> </pre><br> ‚Äî   login   coroutineContext. ,            .  Kotlin   ,     UI  . <br> ‚Äî   Coroutine builder   Coroutine Contex,    . <br><br>  unit-   : <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testLogin</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ val presenter = LoginPresenter () presenter.login(Unconfined) }</code> </pre><br><br> ‚Äî    <strong>LoginPresenter</strong>   login   - , ,  Unconfined. <br> ‚Äî <strong>Unconfined</strong> ,      ,    .         . <br><br><h4> Mocking coroutines <br></h4><br>   ‚Äî  .    <strong>Mockk</strong>  unit-.     unit-    Kotlin,      .  suspend-        <strong>coEvery</strong>        -. <br><br>   login     <strong>githubUser</strong> : <br><br><pre> <code class="java hljs">coEvery { apiClient.login(any()) } returns githubUser</code> </pre><br>    <strong>Mockito-kotlin</strong> ,     ‚Äî    . ,    ,     : <br><br><pre> <code class="java hljs">given { runBlocking { apiClient.login(any()) } }.willReturn (githubUser)</code> </pre><br>    <strong>runBlocking</strong> .  <strong>given-</strong>    ,    . <br><br>        <strong>Presenter</strong> : <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testLogin</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ val githubUser = GithubUser(<span class="hljs-string"><span class="hljs-string">'login'</span></span>) val presenter = LoginPresenter(mockApi) presenter.login (Unconfined) assertEquals(githubUser, presenter.user()) }</code> </pre><br> ‚Äî   -, , <strong>GitHubUser</strong> . <br> ‚Äî  LoginPresenter      API,     .      . <br> ‚Äî   <strong>presenter.login</strong>  Unconfined   ,   Presenter    ,   . <br><br>  E isso √© tudo!    . <br><br><h2>   <br></h2><br><br><ul><li> <strong> Rx-   .</strong>      .      ,  RxJava  RxJava.     -  ‚Äî   ,   . </li><li> <strong>   .</strong>   ,       . Unit- ‚Äî       ,  ,     ,    .  ‚Äî welcome! </li><li> <strong>   .</strong>   ,  ,   ,   ,      .       . </li></ul><br><br><h3>  Links √∫teis <br></h3><br><ul><li>      ,      Android GDE   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Android Coroutine Recipes</a> .     ,      : lifeCircle, coroutineContexts,   Coroutine builders   . </li><li> <a href="">  </a>  GitHub. </li><li>     Android  Kotlin,      ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> <strong>Codelab</strong></a> . </li><li>           .  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Twitter</a>       . <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><strong> Medium</strong></a>     ¬´¬ª      Android,   async-   . </li></ul><br><blockquote>  <strong>Not√≠cias</strong> <br><br> 30    Mail.ru   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> </a>      .  ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a> . <br><br>       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">AppsConf</a>   ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> </a>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> </a>   . <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">  </a> ,   ,       ,       . <br><br>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">youtube-</a>       AppsConf 2018 ‚Äî    :) <br></blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt429908/">https://habr.com/ru/post/pt429908/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt429892/index.html">xonsh - python como uma substitui√ß√£o de shell</a></li>
<li><a href="../pt429894/index.html">Usando um olho de peixe em um Raspberry Pi 3 com ROS - Parte 2</a></li>
<li><a href="../pt429898/index.html">DMS (Dealership Management System) - Implementa√ß√£o de EcoSystems de informa√ß√£o para gerenciar redes de revendedores</a></li>
<li><a href="../pt429902/index.html">Page Rank na Era da Web 2.0 - Parte 1</a></li>
<li><a href="../pt429904/index.html">Hist√≥rias engra√ßadas e tristes sobre o desenvolvimento de jogos de computador</a></li>
<li><a href="../pt429910/index.html">AppsConf Rises</a></li>
<li><a href="../pt429912/index.html">Desenvolvimento da biblioteca: da API ao lan√ßamento p√∫blico</a></li>
<li><a href="../pt429914/index.html">OpenSceneGraph: Gr√°fico de cena e ponteiros inteligentes</a></li>
<li><a href="../pt429916/index.html">Como construir e construir</a></li>
<li><a href="../pt429918/index.html">Mundo virtual Intel. Parte 2: SMP</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>