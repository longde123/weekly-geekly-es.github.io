<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèúÔ∏è üßìüèª üíÖüèº Corrigez-moi si vous le pouvez: comment nous d√©boguons sur la production. Partie 1 üî™ ‚úçüèΩ üßõüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="UPD: la deuxi√®me partie de l'article est pr√™te . 

 Bonjour, Habr! Je m'appelle Alexander Izmailov. Chez Badoo, je dirige une √©quipe d'ing√©nieurs de v...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Corrigez-moi si vous le pouvez: comment nous d√©boguons sur la production. Partie 1</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/badoo/blog/413503/">  <b>UPD: la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">deuxi√®me partie de l'article</a> est pr√™te <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">.</a></b> <br><br>  Bonjour, Habr!  Je m'appelle Alexander Izmailov.  Chez Badoo, je dirige une √©quipe d'ing√©nieurs de version.  Je sais que dans de nombreuses entreprises, vous pouvez envoyer des modifications de code √† une personne sp√©cialement form√©e, il les regarde et les ajoute l√† o√π elles devraient (par exemple, c'est exactement ce qui se passe avec le code Git).  Et je veux parler de la fa√ßon dont nous avons automatis√© ce processus avec nous. <br><br>  Mon histoire se composera de deux parties.  Dans cette partie, je vais parler de ce que nous voulions r√©aliser du nouveau syst√®me, √† quoi il ressemblait dans sa premi√®re version, et pourquoi finalement nous avons d√ª le refaire.  Dans la deuxi√®me partie, nous parlerons du processus de refonte du syst√®me et des bonus inattendus qu'il nous a apport√©. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/kz/rx/oo/kzrxooelulor2_oeeddmmd-o7xg.png" height="500"></div><br>  Image: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">source</a> <br><a name="habracut"></a><br>  Il √©tait une fois dans notre entreprise tout le monde pouvait apporter ses modifications directement √† la branche principale et les disposer de ses propres mains.  Pour ce faire, nous avons √©crit un utilitaire MSCP sp√©cial qui fonctionnait assez primitivement: il copiait les modifications d'une machine √† l'autre et d√©finissait les droits n√©cessaires. <br><br>  Au fil du temps, l'entreprise a grandi - et nous avons d√ª penser √† l'automatisation des processus, y compris le processus de mise en place de petits changements.  Nous avons donc eu l'id√©e de cr√©er un syst√®me de patchs.  Tout d'abord, nous voulions qu'il permette √† tout d√©veloppeur d'envoyer ses modifications √† Git et de les disposer sur des serveurs.  Pour notre part, nous avons exig√© qu'un autre d√©veloppeur examine les changements et qu'ils soient li√©s √† la t√¢che de notre syst√®me de suivi des bogues (nous utilisons Jira). <br><br><div class="spoiler">  <b class="spoiler_title">Collecteur de patch 6000</b> <div class="spoiler_text">  Je dois dire que ces exigences n'ont pas s√©duit tous les d√©veloppeurs.  Il nous a sembl√© que consacrer quelques minutes √† la cr√©ation d'une t√¢che n'est pas une chose, mais pour nous, cela signifierait une utilisation plus d√©lib√©r√©e du syst√®me.  Mais les d√©veloppeurs ont commenc√© √† r√©sister, arguant que la pr√©sentation des modifications prenait plusieurs fois moins de temps que la cr√©ation d'un nouveau ticket.  En cons√©quence, nous avons encore des t√¢ches "universelles", auxquelles des centaines de correctifs sont attach√©s. <br><br>  De plus, le syst√®me a √©t√© con√ßu dans le but de r√©soudre les probl√®mes urgents et il peut √™tre difficile de trouver un examinateur pour un patch √† trois heures du matin. <br></div></div><br><h2>  De quoi avons-nous besoin? </h2><br>  <s>Oui, juste une lumi√®re dans la fen√™tre ...</s> Notre probl√®me pourrait √™tre conditionnellement divis√© en deux parties: nous avions besoin d'un moyen d'accepter les modifications du r√©f√©rentiel et d'une mani√®re de les pr√©senter. <br><br>  Nous avons d√©cid√© la premi√®re question assez rapidement: nous avons fait un formulaire auquel nous devions joindre nos modifications et indiquer les d√©tails (r√©viseur et t√¢che). <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/kl/yk/gt/klykgtwk7gjwahm7bittw-jrf58.png" height="500"></div><br><br>  Sur la deuxi√®me page, vous pouvez voir les modifications, les rejeter ou les accepter. <br><br><img src="https://habrastorage.org/webt/dd/2k/s8/dd2ks86twqszir9vu7jsaiu6cym.png"><br><br>  Apr√®s confirmation, les changements sont pass√©s au ma√Ætre. <br><br>  Deuxi√®me question: comment ces modifications peuvent-elles √™tre apport√©es rapidement aux serveurs?  Aujourd'hui, beaucoup utilisent l'int√©gration continue, et cela pourrait bien faire le travail si nos constructions et mises en page ¬´honn√™tes¬ª ne prenaient pas autant de temps. <br><br><h3>  Assemblage √©quitable </h3><br>  Notre montage a toujours √©t√© assez compliqu√©.  Le principe g√©n√©ral √©tait le suivant: dans un r√©pertoire s√©par√©, nous avons dispos√© les fichiers tels qu'ils seraient sur les serveurs de destination;  puis nous avons enregistr√© cet √©tat dans un instantan√© (instantan√© du syst√®me de fichiers) et l'avons pr√©sent√©. <br><br>  Nous avons mis le code PHP dans le r√©pertoire, que nous avons pris du r√©f√©rentiel tel quel, y avons ajout√© les fichiers g√©n√©r√©s (par exemple, les mod√®les et les traductions).  Nous avons pr√©sent√© la statique s√©par√©ment.  C'est un processus assez compliqu√©, et vous pouvez y consacrer un article entier, mais en cons√©quence, nous avons eu une carte de version pour g√©n√©rer des liens de fichiers pour les utilisateurs qui sont partis avec le code principal. <br><br>  Ensuite, l'√©tat du r√©pertoire devait √™tre enregistr√© quelque part.  Pour ce faire, nous avons utilis√© un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">p√©riph√©rique bloc</a> , que nous avons appel√© une boucle.  L'ensemble du r√©pertoire a √©t√© copi√© sur un appareil vide, qui a ensuite √©t√© archiv√© et livr√© sur des serveurs ¬´principaux¬ª distincts.  De ces serveurs, nous avons pris des archives en cours de mise en page.  Chaque archive avait une taille de 200 Mo et, une fois d√©ball√©es, les boucles pesaient 1 Go.  Il nous a fallu environ cinq minutes pour construire sans statique. <br><br><h3>  Disposition juste </h3><br>  Nous devions d'abord livrer l'archive aux serveurs de destination.  Nous en avons des milliers, donc la question de livraison pour nous a toujours √©t√© un gros probl√®me: nous avons plusieurs plates-formes (centres de donn√©es), et sur les mille serveurs les plus "√©pais" avec un code.  Dans le but d'obtenir de meilleures performances (temps et ressources minimum), nous avons essay√© diff√©rentes m√©thodes: du simple SCP aux torrents.  Au final, nous avons opt√© pour l'utilisation de l'UFTP.  La m√©thode a √©t√© rapide (par beau temps - une minute), mais malheureusement pas sans probl√®me.  P√©riodiquement, quelque chose se brisait et nous devions courir vers les administrateurs et les networkers. <br><br>  Apr√®s que l'archive (en quelque sorte) se soit retrouv√©e sur les serveurs, elle doit √™tre d√©compress√©e, ce qui n'est pas non plus gratuit.  Cette proc√©dure semble particuli√®rement co√ªteuse si vous vous souvenez qu'elle est effectu√©e des milliers de fois, mais en parall√®le sur diff√©rentes machines. <br><br><h3>  Pas de montage </h3><br>  Donc, honn√™tement, publier des modifications prenait beaucoup de temps et la vitesse de livraison √©tait tr√®s importante pour le syst√®me de correctifs, car on supposait qu'ils l'utilisaient lorsque quelque chose ne fonctionnait plus.  Par cons√©quent, nous sommes revenus √† l'id√©e d'utiliser MSCP: rapide et facile √† mettre en ≈ìuvre.  Ainsi, apr√®s que les modifications soient apparues dans l'assistant, sur une page s√©par√©e, il a √©t√© possible de d√©composer les fichiers modifi√©s tour √† tour. <br><br><img src="https://habrastorage.org/webt/6v/xr/zh/6vxrzhjqovb_itqx7g8caopp5zq.png"><br><br><h2>  C'est vivant </h2><br>  Le syst√®me fonctionne.  Malgr√© une certaine insatisfaction √† l'√©gard des petites choses, les d√©veloppeurs pouvaient faire leur travail, et pour cela, ils n'avaient pas besoin d'acc√©der au ma√Ætre ni aux serveurs. <br><br>  Mais, bien s√ªr, avec cette m√©thode de mise en page, nous avons eu des probl√®mes.  Certains √©taient pr√©visibles, certains nous avons m√™me d√©cid√© d'une mani√®re ou d'une autre.  La plupart d'entre eux √©taient li√©s √† l'√©dition de fichiers en parall√®le. <br><br><h3>  Un patch pour plusieurs fichiers </h3><br>  Un exemple d'un probl√®me pr√©visible.  De nouveaux dossiers ont √©t√© dispos√©s tour √† tour.  Que faire si vous devez modifier plusieurs fichiers et que les modifications y sont li√©es?  Par exemple, je veux ajouter une nouvelle m√©thode dans un fichier et l'utiliser imm√©diatement dans d'autres.  Tant qu'il n'y a pas de bouclage utilisant des m√©thodes (voir <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">r√©currence mutuelle</a> ), il suffit de se souvenir de l'ordre de mise en page des fichiers correct. <br><br><div class="spoiler">  <b class="spoiler_title">D√©cision honn√™te</b> <div class="spoiler_text">  Pour r√©soudre le probl√®me, nous devions remplacer plusieurs fichiers atomiquement.  Dans le cas d'un seul fichier, la solution est connue: vous devez utiliser l'op√©ration de fichier renommer.  Supposons que nous ayons un fichier F et que nous devions remplacer son contenu.  Pour ce faire, cr√©ez un fichier TMP, √©crivez-y les informations n√©cessaires, puis faites renommer TMP F. <br><br>  Compliquons la t√¢che.  Supposons que nous ayons un r√©pertoire D et que nous ayons besoin de remplacer son contenu.  L'op√©ration de renommage ne nous aidera pas, car elle ne peut pas remplacer un r√©pertoire non vide.  Cependant, il existe une solution de contournement: vous pouvez pr√©-remplacer le r√©pertoire D par un lien dit symbolique (lien symbolique).  Ensuite, le contenu lui-m√™me se trouvera ailleurs, par exemple dans le r√©pertoire D_1, et D sera un lien vers D_1.  Au moment o√π le remplacement est requis, le nouveau contenu est √©crit dans le r√©pertoire D_2, vers lequel un nouveau lien TMP est cr√©√©.  Maintenant, renommer TMP D fonctionnera car cette op√©ration peut √™tre appliqu√©e aux liens. <br><br>  Cette solution semble appropri√©e: vous pouvez modifier le r√©pertoire entier avec le code, en copiant les anciens fichiers et en √©crivant de nouveaux sur le dessus.  Le probl√®me est que la copie de tout le code est longue et co√ªteuse.  Vous pouvez uniquement remplacer le sous-r√©pertoire o√π les fichiers ont chang√©, mais tous les sous-r√©pertoires avec le code doivent √™tre des liens, car nous ne pouvons pas remplacer le r√©pertoire rempli par quoi que ce soit pendant le processus de mise en page.  Non seulement cette solution semble tr√®s compliqu√©e - vous devez vous rappeler d'ajouter quelques restrictions afin que les deux processus ne puissent pas simultan√©ment changer le m√™me r√©pertoire ou r√©pertoire et ses sous-r√©pertoires. <br></div></div><br>  En cons√©quence, nous n'avons pas pu trouver de solution technique, mais nous avons compris comment simplifier un peu la vie: nous avons fait la mise en page de plusieurs fichiers en une seule action dans l'interface.  Le d√©veloppeur a sp√©cifi√© la disposition des fichiers et le syst√®me les a fournis. <br><br><h3>  Plusieurs correctifs par fichier </h3><br>  C‚Äôest plus difficile s‚Äôil n‚Äôya qu‚Äôun seul fichier et plusieurs d√©veloppeurs souhaitent le changer.  Nous avons appliqu√© le premier patch, mais ne l'avons pas d√©compos√©.  √Ä ce stade, le deuxi√®me patch arrive et est invit√© √† se d√©composer.  Que faire  Encore plus int√©ressant, si le deuxi√®me patch est appliqu√©, et √† ce moment on nous demande de d√©composer le premier. <br><br>  Probablement, nous devons pr√©ciser que nous n'avons toujours pr√©sent√© que la derni√®re version de l'assistant.  Sinon, d'autres probl√®mes pourraient survenir.  Par exemple, disposer l'ancienne version par-dessus la nouvelle. <br><br>  Nous n'avons pas trouv√© une tr√®s bonne solution √† ce probl√®me.  Nous avons montr√© aux d√©veloppeurs la diff√©rence entre ce qu'ils pr√©sentent et ce qui se trouve sur les machines √† un moment donn√©, mais cela n'a pas toujours fonctionn√©.  Par exemple, il pourrait y avoir beaucoup de changements, et le d√©veloppeur pourrait √™tre press√© ou simplement √™tre paresseux (tout peut arriver). <br><br><h3>  Beaucoup de correctifs et tout le monde change les m√™mes fichiers </h3><br>  C'est la pire option sur laquelle vous ne voulez m√™me pas vous attarder.  Si les changements de plusieurs d√©veloppeurs affectaient plusieurs des m√™mes fichiers, notre syst√®me de correctifs ne pouvait pas particuli√®rement aider - il restait √† compter sur l'attention des d√©veloppeurs et leur capacit√© √† communiquer entre eux.  Mais en th√©orie, il est tout √† fait possible d‚Äôobtenir du ¬´poisson¬ª lorsque, dans n‚Äôimporte quel ordre de disposition, √† un moment donn√© du serveur, le code sera partiellement rompu. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/n-/qn/fs/n-qnfsbv6myxc8d7oav-yhyitu4.png"></div><br>  Image: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">source</a> <br><br><h3>  Probl√®mes de fer </h3><br>  Un autre probl√®me est survenu lorsque, pour une raison quelconque, l'un des serveurs est devenu indisponible.  Nous avions un m√©canisme pour exclure ces serveurs de la mise en page, ce qui fonctionnait assez bien;  des difficult√©s sont apparues apr√®s leur retour au travail.  Le fait est que les versions des configs et du code sur les serveurs qui fonctionnent sont v√©rifi√©es avec nous (il y a tout un d√©partement de surveillance!), Et nous nous assurons que toutes les versions sont √† jour lorsque le serveur est de nouveau op√©rationnel.  Mais nous n'avions pas de version pour les correctifs - nous venons de copier de nouveaux fichiers dans le code actuel. <br><br>  Nous n'avons pas trouv√© de moyen pr√©cis de versionner les correctifs d√©compos√©s, mais nous avons essay√© de r√©soudre le probl√®me par des solutions de contournement.  Par exemple, rsync √† partir d'une machine voisine √† la fin du processus de mise en page.  Mais d'une mani√®re ou d'une autre, nous ne pouvions pas v√©rifier d'une mani√®re ou d'une autre. <br><br>  Nous avons examin√© plusieurs solutions √† ce probl√®me, par exemple, nous voulions √©galement appliquer des correctifs sur les serveurs ¬´principaux¬ª (il est important de se rappeler que nous d√©ployons la version packag√©e, c'est-√†-dire que nous devons appliquer le correctif et reconditionner la version), mais c'√©tait assez difficile √† mettre en ≈ìuvre. <br><br><h2>  Une cuill√®re de miel </h2><br>  Mais, en plus des probl√®mes, il y avait des aspects positifs. <br><br>  Premi√®rement, les d√©veloppeurs ont rapidement compris qu'en plus de r√©parer les choses, avec l'aide du syst√®me de correctifs, vous pouvez parfois t√©l√©charger de nouvelles fonctionnalit√©s, par exemple lorsque vous en avez besoin de toute urgence.  Comme dans toute entreprise, nous avons un cas de force majeure.  Mais si auparavant nous devions cr√©er une version extraordinaire, sur laquelle les testeurs et les ing√©nieurs de publication √©taient distraits, le d√©veloppeur pouvait d√©sormais d√©composer certains changements par lui-m√™me. <br><br>  Deuxi√®mement, une personne sp√©ciale avec des droits n'√©tait plus n√©cessaire pour r√©parer quelque chose.  Tout d√©veloppeur lui-m√™me pouvait publier ses modifications.  Mais ce n'est pas tout: les builds en g√©n√©ral sont devenus plus faciles, maintenant les probl√®mes √©taient divis√©s en critiques et ceux qui peuvent √™tre corrig√©s √† l'aide de correctifs.  Cela a permis de revenir en arri√®re moins souvent et de d√©cider plus rapidement si nous avons r√©ussi. <br><br>  Autrement dit, nous avons aim√© le syst√®me et gagn√© en popularit√©.  Nous avons continu√© √† essayer de l'am√©liorer, mais avec les probl√®mes d√©crits, nous avons d√ª vivre encore quelques ann√©es.  Et comment nous les avons d√©cid√©s, comment le syst√®me fonctionne maintenant et comment nous avons presque tu√© les vacances du Nouvel An pendant le processus de mise √† jour, je le dirai dans la deuxi√®me partie de l'article. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr413503/">https://habr.com/ru/post/fr413503/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr413491/index.html">Food Design Digest, mai 2018</a></li>
<li><a href="../fr413493/index.html">Infrastructure √† cl√© publique (suite): Autorit√© de certification bas√©e sur OpenSSL et SQLite3</a></li>
<li><a href="../fr413495/index.html">D√©ploiement rapide ou comment d√©ployer le front-end en 15 minutes</a></li>
<li><a href="../fr413499/index.html">Ouverture d'un programme de master conjoint chez JetBrains et ITMO</a></li>
<li><a href="../fr413501/index.html">L'ann√©e pass√©e avec React: conclusions et recommandations</a></li>
<li><a href="../fr413505/index.html">2 billets gratuits pour In-Memory Computing Summit Europe</a></li>
<li><a href="../fr413511/index.html">Choisir un scanner 3D pour l'industrie. Maxim Zhuravlev. Reportage √† Top 3D Expo 2018</a></li>
<li><a href="../fr413513/index.html">Normes de communication ¬´oubli√©es¬ª: WiMAX, CDMA, ALOHAnet et autres</a></li>
<li><a href="../fr413515/index.html">Doh en images</a></li>
<li><a href="../fr413517/index.html">Qu'est-ce que le paradoxe de la productivit√© informatique et comment le cloud peut-il le r√©soudre?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>