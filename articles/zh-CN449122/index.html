<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘·ğŸ¼ ğŸ—ƒï¸ ğŸ˜ é—æ†¾çš„æ˜¯ï¼Œåœ¨C ++ä¸­ç¼ºå°‘ä¸€ä¸ªæˆç†Ÿçš„static ifæˆ–... ğŸ‘¨ğŸ½â€ğŸ¤ ğŸ‘ƒğŸ¼ ğŸ’‡ğŸ¾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="...å¦‚ä½•æ ¹æ®æ¨¡æ¿å‚æ•°çš„å€¼ç”¨ä¸åŒçš„å†…å®¹å¡«å……æ¨¡æ¿ç±»ï¼Ÿ 


å¾ˆä¹…ä»¥æ¥ï¼Œè€ƒè™‘åˆ°C ++çš„ç»éªŒï¼ŒDè¯­è¨€å°±å¼€å§‹è¢«åˆ¶é€ ä¸ºâ€œæ­£ç¡®çš„C ++â€ã€‚ éšç€æ—¶é—´çš„æµé€ï¼ŒDå·²å˜å¾—æ¯”C ++å¤æ‚ï¼Œè¡¨è¾¾èƒ½åŠ›æ›´å¼ºçš„è¯­è¨€ã€‚ å¹¶ä¸”C ++å·²ç»å¼€å§‹ç›‘è§†Dã€‚ä¾‹å¦‚ï¼Œåœ¨æˆ‘çœ‹æ¥ï¼Œ if constexpræ˜¯ç›´æ¥ä»Då€Ÿæ¥çš„ï¼Œåˆ™C ++ 17ä¸­...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>é—æ†¾çš„æ˜¯ï¼Œåœ¨C ++ä¸­ç¼ºå°‘ä¸€ä¸ªæˆç†Ÿçš„static ifæˆ–...</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/449122/"><p> <strong>...å¦‚ä½•æ ¹æ®æ¨¡æ¿å‚æ•°çš„å€¼ç”¨ä¸åŒçš„å†…å®¹å¡«å……æ¨¡æ¿ç±»ï¼Ÿ</strong> </p><br><p>å¾ˆä¹…ä»¥æ¥ï¼Œè€ƒè™‘åˆ°C ++çš„ç»éªŒï¼ŒDè¯­è¨€å°±å¼€å§‹è¢«åˆ¶é€ ä¸ºâ€œæ­£ç¡®çš„C ++â€ã€‚ éšç€æ—¶é—´çš„æµé€ï¼ŒDå·²å˜å¾—æ¯”C ++å¤æ‚ï¼Œè¡¨è¾¾èƒ½åŠ›æ›´å¼ºçš„è¯­è¨€ã€‚ å¹¶ä¸”C ++å·²ç»å¼€å§‹ç›‘è§†Dã€‚ä¾‹å¦‚ï¼Œåœ¨æˆ‘çœ‹æ¥ï¼Œ <code>if constexpr</code>æ˜¯ç›´æ¥ä»Då€Ÿæ¥çš„ï¼Œåˆ™C ++ 17ä¸­<code>if constexpr</code>å‡ºç°äº†ï¼ŒDçš„åŸå‹æ˜¯<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">D-shny static if</a> ã€‚ </p><br><p> ä¸å¹¸çš„æ˜¯ï¼Œ <code>if constexpr</code> C ++ä¸­çš„<code>if constexpr</code>ä¸Dä¸­çš„<code>static if</code>å‡½æ•°ä¸å…·æœ‰ç›¸åŒçš„åŠŸèƒ½ã€‚è¿™æ˜¯æœ‰<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">åŸå› çš„</a> ï¼Œä½†æ˜¯åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ‚¨åªèƒ½åæ‚”<code>if constexpr</code> C ++ä¸­çš„<code>if constexpr</code>ä¸å…è®¸æ‚¨æ§åˆ¶C +çš„å†…å®¹+ç±»ã€‚ æˆ‘æƒ³è°ˆè°ˆå…¶ä¸­ä¸€ç§æƒ…å†µã€‚ </p><br><p> æˆ‘ä»¬å°†è®¨è®ºå¦‚ä½•åˆ¶ä½œä¸€ä¸ªæ¨¡æ¿ç±»ï¼Œå…¶å†…å®¹ï¼ˆå³æ–¹æ³•çš„ç»„æˆå’ŒæŸäº›æ–¹æ³•çš„é€»è¾‘ï¼‰å°†æ ¹æ®ä¼ é€’ç»™è¯¥æ¨¡æ¿ç±»çš„å‚æ•°è€Œæ”¹å˜ã€‚ ä»ç°å®ç”Ÿæ´»ä¸­ä»¥å¼€å‘<a href="">SObjectizeræ–°ç‰ˆæœ¬</a>çš„ç»éªŒ<a href="">ä¸ºä¾‹</a> ã€‚ </p><br><h1 id="zadacha-kotoruyu-trebuetsya-reshit"> è¦è§£å†³çš„ä»»åŠ¡ </h1><br><p> éœ€è¦åˆ›å»ºç”¨äºå­˜å‚¨æ¶ˆæ¯å¯¹è±¡çš„â€œæ™ºèƒ½æŒ‡é’ˆâ€çš„ç²¾å·§ç‰ˆæœ¬ã€‚ è¿™æ ·æ‚¨å°±å¯ä»¥ç¼–å†™å¦‚ä¸‹å†…å®¹ï¼š </p><a name="habracut"></a><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">message_holder_t</span></span>&lt;my_message&gt; msg{ <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> my_message{...} }; send(target, msg); send(another_target, msg);</code> </pre> <br><p> è¿™ä¸ª<code>message_holder_t</code>ç±»çš„æŠ€å·§æ˜¯è¦è€ƒè™‘ä¸‰ä¸ªé‡è¦å› ç´ ã€‚ </p><br><h2 id="ot-chego-otnasledovan-tip-soobscheniya"> æ¶ˆæ¯çš„ç±»å‹æ˜¯ä»€ä¹ˆï¼Ÿ </h2><br><p> å‚æ•°åŒ–<code>message_holder_t</code>çš„æ¶ˆæ¯ç±»å‹åˆ†ä¸ºä¸¤ç»„ã€‚ ç¬¬ä¸€ç»„æ˜¯ä»ç‰¹æ®ŠåŸºæœ¬ç±»å‹<code>message_t</code>ç»§æ‰¿çš„æ¶ˆæ¯ã€‚ ä¾‹å¦‚ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">so5_message</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">final</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> so_5::<span class="hljs-keyword"><span class="hljs-keyword">message_t</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a_; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> b_; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::chrono::milliseconds c_; so5_message(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> b, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::chrono::milliseconds c) : a_{a}, b_{<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move(b)}, c_{c} {} };</code> </pre> <br><p> åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè‡ªèº«å†…éƒ¨çš„message_holder_tåº”è¯¥åªåŒ…å«ä¸€ä¸ªæŒ‡å‘æ­¤ç±»å‹å¯¹è±¡çš„æŒ‡é’ˆã€‚ ç›¸åŒçš„æŒ‡é’ˆåº”åœ¨getteræ–¹æ³•ä¸­è¿”å›ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹äºæ¥è‡ª<code>message_t</code>çš„ç»§æ‰¿äºº<code>message_t</code>åº”è¯¥æœ‰ç±»ä¼¼ä»¥ä¸‹å†…å®¹ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> M&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">message_holder_t</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">intrusive_ptr_t</span></span>&lt;M&gt; m_msg; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> M * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">noexcept</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> m_msg.get(); } };</code> </pre> <br><p> ç¬¬äºŒç»„æ˜¯ä¸ä»<code>message_t</code>ç»§æ‰¿çš„ä»»æ„ç”¨æˆ·ç±»å‹çš„æ¶ˆæ¯ã€‚ ä¾‹å¦‚ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user_message</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">final</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a_; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> b_; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::chrono::milliseconds c_; user_message(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> b, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::chrono::milliseconds c) : a_{a}, b_{<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move(b)}, c_{c} {} };</code> </pre> <br><p>  SObjectizerä¸­è¿™äº›ç±»å‹çš„å®ä¾‹ä¸æ˜¯è‡ªå·±å‘é€çš„ï¼Œè€Œæ˜¯å°è£…åœ¨ç‰¹æ®Šçš„åŒ…è£…ä¸­ï¼Œå³<code>user_type_message_t&lt;M&gt;</code> ï¼Œè¯¥åŒ…è£…å·²ä»<code>message_t</code>ç»§æ‰¿ã€‚ å› æ­¤ï¼Œå¯¹äºæ­¤ç±»ç±»å‹ï¼Œ <code>message_holder_t</code>å¿…é¡»åœ¨å…¶ä¸­åŒ…å«æŒ‡å‘<code>user_type_message_t&lt;M&gt;</code>çš„æŒ‡é’ˆï¼Œè€Œgetteræ–¹æ³•å¿…é¡»è¿”å›æŒ‡å‘Mçš„æŒ‡é’ˆï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> M&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">message_holder_t</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">intrusive_ptr_t</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">user_type_message_t</span></span>&lt;M&gt;&gt; m_msg; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> M * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">noexcept</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::addressof(m_msg-&gt;m_payload); } };</code> </pre> <br><h2 id="immutabelnost-ili-mutabelnost-soobscheniy"> æ¶ˆæ¯çš„æŠ—æ‰°æ€§æˆ–å¯å˜æ€§ </h2><br><p> ç¬¬äºŒä¸ªå› ç´ æ˜¯å°†æ¶ˆæ¯åˆ†ä¸ºä¸å¯å˜å’Œå¯å˜çš„ã€‚ å¦‚æœæ¶ˆæ¯æ˜¯ä¸å¯å˜çš„ï¼ˆé»˜è®¤æƒ…å†µä¸‹æ˜¯ä¸å¯å˜çš„ï¼‰ï¼Œåˆ™getteræ–¹æ³•å¿…é¡»è¿”å›æŒ‡å‘æ¶ˆæ¯çš„å¸¸é‡æŒ‡é’ˆã€‚ å¦‚æœæ˜¯å¯å˜çš„ï¼Œåˆ™è·å–å™¨å¿…é¡»è¿”å›ä¸€ä¸ªéæ’å®šæŒ‡é’ˆã€‚ å³ åº”è¯¥æ˜¯è¿™æ ·çš„ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">message_holder_t</span></span>&lt;so5_message&gt; msg1{...}; <span class="hljs-comment"><span class="hljs-comment">//  . const int a = msg1-&gt;a_; // OK. msg1-&gt;a_ = 0; //     ! message_holder_t&lt;mutable_msg&lt;user_message&gt;&gt; msg2{...}; //  . const int a = msg2-&gt;a_; // OK. msg2-&gt;a_ = 0; // OK.</span></span></code> </pre> <br><h2 id="shared_ptr-vs-unique_ptr">  shared_ptrå’Œunique_ptr </h2><br><p> ç¬¬ä¸‰ä¸ªå› ç´ æ˜¯<code>message_holder_t</code>ä½œä¸ºæ™ºèƒ½æŒ‡é’ˆçš„è¡Œä¸ºçš„é€»è¾‘ã€‚ ä¸€æ—¦å®ƒåº”è¯¥è¡¨ç°å¾—åƒ<code>std::shared_ptr</code> ï¼Œå³ æ‚¨å¯ä»¥æœ‰å¤šä¸ªmessage_holderså¼•ç”¨åŒä¸€ä¸ªæ¶ˆæ¯å®ä¾‹ã€‚ å¹¶ä¸”ä¸€æ—¦å®ƒçš„è¡Œä¸ºå°±åƒ<code>std::unique_ptr</code> ï¼Œå³ åªæœ‰ä¸€ä¸ªmessage_holderå®ä¾‹å¯ä»¥å¼•ç”¨ä¸€ä¸ªæ¶ˆæ¯å®ä¾‹ã€‚ </p><br><p> é»˜è®¤æƒ…å†µä¸‹ï¼Œ <code>message_holder_t</code>çš„è¡Œä¸ºåº”å–å†³äºæ¶ˆæ¯çš„å¯å˜æ€§/ä¸å¯å˜æ€§ã€‚ å³ å¯¹äºä¸å¯å˜æ¶ˆæ¯ï¼Œ <code>message_holder_t</code>è¡Œä¸ºåº”ç±»ä¼¼äº<code>std::shared_ptr</code> ï¼Œå¯¹äºå¯å˜<code>std::unique_ptr</code>å¦‚<code>std::unique_ptr</code> ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">message_holder_t</span></span>&lt;so5_message&gt; msg1{...}; <span class="hljs-keyword"><span class="hljs-keyword">message_holder_t</span></span>&lt;so5_message&gt; msg2 = msg; <span class="hljs-comment"><span class="hljs-comment">// OK. message_holder_t&lt;mutable_msg&lt;user_message&gt;&gt; msg3{...}; message_holder_t&lt;mutable_msg&lt;user_message&gt;&gt; msg4 = msg3; // !  ! message_holder_t&lt;mutable_msg&lt;user_message&gt;&gt; msg5 = std::move(msg3); // OK.</span></span></code> </pre> <br><p> ä½†æ˜¯ç”Ÿæ´»æ˜¯ä¸€ä»¶å¤æ‚çš„äº‹æƒ…ï¼Œå› æ­¤æ‚¨è¿˜éœ€è¦èƒ½å¤Ÿæ‰‹åŠ¨è®¾ç½®<code>message_holder_t</code>è¡Œä¸ºã€‚ è¿™æ ·å°±å¯ä»¥ä½¿message_holderæˆä¸ºè¡Œä¸ºä¸å˜çš„æ¶ˆæ¯ï¼Œå…¶è¡Œä¸ºç±»ä¼¼äºunique_ptrã€‚ è¿™æ ·æ‚¨å°±å¯ä»¥ä½¿message_holderç”¨äºè¡Œä¸ºç±»ä¼¼äºshared_ptrçš„å¯å˜æ¶ˆæ¯ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> unique_so5_message = so_5::<span class="hljs-keyword"><span class="hljs-keyword">message_holder_t</span></span>&lt; so5_message, so_5::<span class="hljs-keyword"><span class="hljs-keyword">message_ownership_t</span></span>::unique&gt;; unique_so5_message msg1{...}; unique_so5_message msg2 = msg1; <span class="hljs-comment"><span class="hljs-comment">// !  ! unique_so5_message msg3 = std::move(msg); // OK,   msg3. using shared_user_messsage = so_5::message_holder_t&lt; so_5::mutable_msg&lt;user_message&gt;, so_5::message_ownership_t::shared&gt;; shared_user_message msg4{...}; shared_user_message msg5 = msg4; // OK.</span></span></code> </pre> <br><p> å› æ­¤ï¼Œå½“<code>message_holder_t</code>åƒshared_pträ¸€æ ·å·¥ä½œæ—¶ï¼Œå®ƒåº”è¯¥å…·æœ‰é€šå¸¸çš„æ„é€ å‡½æ•°å’Œèµ‹å€¼è¿ç®—ç¬¦é›†ï¼šå¤åˆ¶å’Œç§»åŠ¨ã€‚ æ­¤å¤–ï¼Œå¿…é¡»æœ‰ä¸€ä¸ªå¸¸é‡æ–¹æ³•<code>make_reference</code> ï¼Œè¯¥æ–¹æ³•è¿”å›å­˜å‚¨åœ¨<code>message_holder_t</code>å†…éƒ¨çš„æŒ‡é’ˆçš„å‰¯æœ¬ã€‚ </p><br><p> ä½†æ˜¯ï¼Œå½“<code>message_holder_t</code>åƒunique_pträ¸€æ ·å·¥ä½œæ—¶ï¼Œåˆ™åº”ç¦æ­¢ä½¿ç”¨æ„é€ å‡½æ•°å’Œå¤åˆ¶è¿ç®—ç¬¦ã€‚ å¹¶ä¸”<code>make_reference</code>æ–¹æ³•åº”è¯¥ä»<code>message_holder_t</code>å¯¹è±¡<em>è·å–</em>æŒ‡é’ˆï¼šè°ƒç”¨<code>make_reference</code>åŸå§‹<code>message_holder_t</code>åº”è¯¥ä¿æŒä¸ºç©ºã€‚ </p><br><h2 id="chut-bolee-formalno"> æ­£å¼ä¸€ç‚¹ </h2><br><p> å› æ­¤ï¼Œæ‚¨éœ€è¦åˆ›å»ºä¸€ä¸ªæ¨¡æ¿ç±»ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt; <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> M, <span class="hljs-keyword"><span class="hljs-keyword">message_ownership_t</span></span> Ownership = <span class="hljs-keyword"><span class="hljs-keyword">message_ownership_t</span></span>::autodetected&gt; class <span class="hljs-keyword"><span class="hljs-keyword">message_holder_t</span></span> {...};</code> </pre> <br><p> å…¶ä¸­ï¼š </p><br><ul><li> åº”è¯¥å°†<code>intrusive_ptr_t&lt;M&gt;</code>æˆ–<code>intrusive_ptr&lt;user_type_message_t&lt;M&gt;&gt;</code>å­˜å‚¨åœ¨å†…éƒ¨ï¼Œå…·ä½“å–å†³äºMæ˜¯å¦ä»<code>message_t</code>ç»§æ‰¿è€Œæ¥ï¼› </li><li>  getteræ–¹æ³•å¿…é¡»æ ¹æ®æ¶ˆæ¯çš„å¯å˜æ€§/ä¸å¯å˜æ€§è¿”å›<code>const M*</code>æˆ–<code>M*</code> ã€‚ </li><li> åº”è¯¥æœ‰ä¸€ç»„å®Œæ•´çš„æ„é€ å‡½æ•°å’Œå¤åˆ¶/ç§»åŠ¨è¿ç®—ç¬¦ï¼Œæˆ–è€…åªæœ‰ä¸€ä¸ªæ„é€ å‡½æ•°å’Œç§»åŠ¨è¿ç®—ç¬¦ </li><li>  <code>make_reference()</code>æ–¹æ³•åº”è¿”å›å­˜å‚¨çš„intrusive_ptrçš„å‰¯æœ¬ï¼Œæˆ–è€…åº”é‡‡ç”¨intrusive_ptrçš„å€¼å¹¶å°†åŸå§‹<code>message_holder_t</code>ä¿ç•™ä¸ºç©ºã€‚ åœ¨ç¬¬ä¸€ç§æƒ…å†µä¸‹ï¼Œ <code>make_reference()</code>å¿…é¡»ä¸ºå¸¸é‡ï¼Œåœ¨ç¬¬äºŒç§æ–¹æ³•-éå¸¸é‡æ–¹æ³•ä¸­ã€‚ </li></ul><br><p> åˆ—è¡¨ä¸­çš„æœ€åä¸¤é¡¹æ˜¯ç”±Ownershipå‚æ•°ç¡®å®šçš„ï¼ˆå¦‚æœæ‰€æœ‰æƒ<code>autodetected</code>ä½¿ç”¨<code>autodetected</code>çš„è¯ï¼Œè¿˜æœ‰æ¶ˆæ¯çš„å¯å˜æ€§ï¼‰ã€‚ </p><br><h1 id="kak-eto-bylo-resheno"> å¦‚ä½•å†³å®š </h1><br><p> åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†è€ƒè™‘æ„æˆæœ€ç»ˆè§£å†³æ–¹æ¡ˆçš„æ‰€æœ‰ç»„ä»¶ã€‚ å¥½å§ï¼Œæœ€ç»ˆçš„è§£å†³æ–¹æ¡ˆæœ¬èº«ã€‚ å°†æ˜¾ç¤ºæ¸…é™¤äº†æ‰€æœ‰ä»¤äººåˆ†å¿ƒç»†èŠ‚çš„ä»£ç ç‰‡æ®µã€‚ å¦‚æœæœ‰äººå¯¹çœŸå®ä»£ç æ„Ÿå…´è¶£ï¼Œé‚£ä¹ˆå¯ä»¥<a href="">åœ¨æ­¤å¤„æŸ¥çœ‹</a> ã€‚ </p><br><h2 id="disclaimer"> å…è´£å£°æ˜ </h2><br><p> ä¸‹é¢æ˜¾ç¤ºçš„è§£å†³æ–¹æ¡ˆå¹¶ä¸è£…ä½œç²¾ç¾ï¼Œç†æƒ³æˆ–æ¦œæ ·ã€‚ åœ¨æˆªæ­¢æ—¥æœŸçš„å‹åŠ›ä¸‹ï¼Œå¯ä»¥åœ¨çŸ­æ—¶é—´å†…æ‰¾åˆ°ï¼Œå®æ–½ï¼Œæµ‹è¯•å’Œè®°å½•è¯¥æ–‡æ¡£ã€‚ ä¹Ÿè®¸å¦‚æœæœ‰æ›´å¤šçš„æ—¶é—´ï¼Œå¹¶ä¸”æœ‰æ›´å¤šçš„äººåœ¨å¯»æ‰¾è§£å†³æ–¹æ¡ˆï¼Œ <del> å¹´è½»çš„ </del> åœ¨ç°ä»£C ++å¼€å‘äººå‘˜ä¸­æ˜æ™ºä¸”åšå­¦ï¼Œå®ƒå°†å˜å¾—æ›´åŠ ç´§å‡‘ï¼Œæ›´ç®€å•å’Œæ›´æ˜“äºç†è§£ã€‚ ä½†æ˜¯ï¼Œäº‹å®è¯æ˜ï¼Œå®ƒå‘ç”Ÿäº†â€¦â€¦ä¸€èˆ¬æ¥è¯´ï¼Œâ€œä¸è¦å°„å‡»é’¢ç´å®¶â€ã€‚ </p><br><h2 id="posledovatelnost-shagov-i-uzhe-gotovaya-shablonnaya-magiya"> æ­¥éª¤é¡ºåºå’Œç°æˆçš„æ¨¡æ¿é­”æœ¯ </h2><br><p> å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå¸¦æœ‰å‡ ç»„æ–¹æ³•çš„ç±»ã€‚ è¿™äº›å·¥å…·åŒ…ä¸­çš„ç‰©å“å¿…é¡»æ¥è‡ªæŸä¸ªåœ°æ–¹ã€‚ ä»å“ªé‡Œæ¥ï¼Ÿ </p><br><p> åœ¨Dä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>static if</code>å¹¶æ ¹æ®ä¸åŒæ¡ä»¶å®šä¹‰ç±»çš„ä¸åŒéƒ¨åˆ†ã€‚ åœ¨æŸäº›Rubyä¸­ï¼Œæˆ‘ä»¬å¯ä»¥<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä½¿ç”¨includeæ–¹æ³•å°†æ–¹æ³•æ··åˆåˆ°ç±»ä¸­</a> ã€‚ ä½†æ˜¯æˆ‘ä»¬åœ¨C ++ä¸­ï¼Œåˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬çš„å¯èƒ½æ€§éå¸¸æœ‰é™ï¼šæˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨ç±»å†…éƒ¨å®šä¹‰æ–¹æ³•/å±æ€§ï¼Œä¹Ÿå¯ä»¥ä»æŸäº›åŸºç±»ç»§æ‰¿è¯¥æ–¹æ³•/å±æ€§ã€‚ </p><br><p> æˆ‘ä»¬ä¸èƒ½æ ¹æ®æŸäº›æ¡ä»¶åœ¨ç±»å†…å®šä¹‰ä¸åŒçš„æ–¹æ³•/å±æ€§ï¼Œå› ä¸º  <code>if constexpr</code>ä¸æ˜¯D <code>static if</code> C ++ <code>static if</code> ã€‚ å› æ­¤ï¼Œä»…ä¿ç•™ç»§æ‰¿ã€‚ </p><br><blockquote>  <strong>æ›´æ–°ã€‚</strong> æ­£å¦‚è¯„è®ºä¸­å»ºè®®çš„é‚£æ ·ï¼Œæˆ‘åœ¨è¿™é‡Œåº”è¯¥æ›´ä»”ç»†åœ°è®²ã€‚ ç”±äºC ++å…·æœ‰SFINAEï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡SFINAEå¯ç”¨/ç¦ç”¨ç±»ä¸­å„ä¸ªæ–¹æ³•çš„å¯è§æ€§ï¼ˆå³è¾¾åˆ°ç±»ä¼¼äº<code>static if</code>çš„æ•ˆæœï¼‰ã€‚ ä½†æ˜¯æˆ‘è®¤ä¸ºè¿™ç§æ–¹æ³•æœ‰ä¸¤ä¸ªä¸¥é‡çš„ç¼ºç‚¹ã€‚ é¦–å…ˆï¼Œå¦‚æœè¿™äº›æ–¹æ³•ä¸æ˜¯1-2-3ï¼Œè€Œæ˜¯4-5æˆ–æ›´å¤šï¼Œé‚£ä¹ˆä½¿ç”¨SFINAEæ ¼å¼åŒ–æ¯ä¸ªæ–¹æ³•å°±å¾ˆéº»çƒ¦ï¼Œè¿™ä¼šå½±å“ä»£ç çš„å¯è¯»æ€§ã€‚ å…¶æ¬¡ï¼ŒSFINAEæ— æ³•å¸®åŠ©æˆ‘ä»¬æ·»åŠ /åˆ é™¤ç±»å±æ€§ï¼ˆå­—æ®µï¼‰ã€‚ </blockquote><p> åœ¨C ++ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰å‡ ä¸ªåŸºç±»ï¼Œç„¶åä»è¿™äº›åŸºç±»ç»§æ‰¿<code>message_holder_t</code> ã€‚ å¹¶ä¸”å·²ç»ä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">std :: conditional</a>æ ¹æ®æ¨¡æ¿å‚æ•°çš„å€¼æ¥é€‰æ‹©ä¸€ä¸ªæˆ–å¦ä¸€ä¸ªåŸºç±»ã€‚ </p><br><p> ä½†æ˜¯è¯€çªåœ¨äºï¼Œæˆ‘ä»¬ä¸ä»…éœ€è¦ä¸€ç»„åŸºç±»ï¼Œè¿˜éœ€è¦ä¸€å°éƒ¨åˆ†ç»§æ‰¿é“¾ã€‚ åœ¨å¼€å§‹æ—¶ï¼Œå°†æœ‰ä¸€ä¸ªç±»æ¥ç¡®å®šåœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½å°†éœ€è¦çš„å¸¸è§„åŠŸèƒ½ã€‚ æ¥ä¸‹æ¥æ˜¯å°†ç¡®å®šâ€œæ™ºèƒ½æŒ‡é’ˆâ€è¡Œä¸ºé€»è¾‘çš„åŸºç±»ã€‚ ç„¶åå°†æœ‰ä¸€ä¸ªç¡®å®šå¿…è¦çš„è·å–æ–¹æ³•çš„ç±»ã€‚ æŒ‰æ­¤é¡ºåºï¼Œæˆ‘ä»¬å°†è€ƒè™‘å®ç°çš„ç±»ã€‚ </p><br><p>  SObjectizerå·²ç»å…·æœ‰ç°æˆçš„æ¨¡æ¿é­”æœ¯<a href="">æ¥</a>ç®€åŒ–æˆ‘ä»¬çš„ä»»åŠ¡ï¼Œè¯¥é­”æœ¯<a href="">å¯ä»¥ç¡®å®šæ˜¯å¦ä»message_tç»§æ‰¿æ¶ˆæ¯</a> ï¼Œä»¥åŠ<a href="">æ£€æŸ¥æ¶ˆæ¯å¯å˜æ€§çš„æ–¹æ³•</a> ã€‚ å› æ­¤ï¼Œåœ¨å®ç°ä¸­ï¼Œæˆ‘ä»¬å°†ä»…ä½¿ç”¨æ­¤ç°æˆçš„é­”æœ¯ï¼Œè€Œä¸ä¼šæ·±å…¥ç ”ç©¶å…¶å·¥ä½œç»†èŠ‚ã€‚ </p><br><h2 id="obschaya-baza-dlya-hraneniya-ukazatelya"> é€šç”¨æŒ‡é’ˆå­˜å‚¨åº“ </h2><br><p> è®©æˆ‘ä»¬ä»å­˜å‚¨ç›¸åº”çš„intrusive_ptrçš„é€šç”¨åŸºæœ¬ç±»å‹å¼€å§‹ï¼Œè¿˜æä¾›ä»»ä½•<code>message_holder_t</code>å®ç°æ‰€éœ€çš„é€šç”¨æ–¹æ³•é›†ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt; <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Payload, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Envelope &gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">basic_message_holder_impl_t</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> : <span class="hljs-keyword"><span class="hljs-keyword">intrusive_ptr_t</span></span>&lt; Envelope &gt; m_msg; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> : <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> payload_type = Payload; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> envelope_type = Envelope; <span class="hljs-keyword"><span class="hljs-keyword">basic_message_holder_impl_t</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">noexcept</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">basic_message_holder_impl_t</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">intrusive_ptr_t</span></span>&lt; Envelope &gt; msg ) <span class="hljs-keyword"><span class="hljs-keyword">noexcept</span></span> : m_msg{ <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move(msg) } {} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reset</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">noexcept</span></span></span><span class="hljs-function"> </span></span>{ m_msg.reset(); } [[nodiscard]] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">empty</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">noexcept</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>&gt;( m_msg ); } [[nodiscard]] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">operator</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bool</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">noexcept</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> !<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;empty(); } [[nodiscard]] <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>!() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">noexcept</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;empty(); } };</code> </pre> <br><p> è¯¥æ¨¡æ¿ç±»å…·æœ‰ä¸¤ä¸ªå‚æ•°ã€‚ ç¬¬ä¸€ä¸ªï¼Œæœ‰æ•ˆè½½è·ï¼Œè®¾ç½®å¸æ°”æ–¹æ³•åº”ä½¿ç”¨çš„ç±»å‹ã€‚ è€Œç¬¬äºŒä¸ªEnvelopeè®¾ç½®intrusive_ptrçš„ç±»å‹ã€‚ å¦‚æœæ¶ˆæ¯ç±»å‹æ˜¯ä»<code>message_t</code>ç»§æ‰¿çš„<code>message_t</code>è¿™ä¸¤ä¸ªå‚æ•°å°†å…·æœ‰ç›¸åŒçš„å€¼ã€‚ ä½†æ˜¯ï¼Œå¦‚æœæ¶ˆæ¯ä¸æ˜¯ä»<code>message_t</code>ç»§æ‰¿çš„ï¼Œåˆ™æ¶ˆæ¯ç±»å‹å°†ç”¨ä½œæœ‰æ•ˆè´Ÿè½½ï¼Œè€Œ<code>user_type_message_t&lt;Payload&gt;</code>å°†<code>user_type_message_t&lt;Payload&gt;</code>ä¿¡å°ã€‚ </p><br><p> æˆ‘è®¤ä¸ºåŸºæœ¬ä¸Šè¯¥è¯¾ç¨‹çš„å†…å®¹ä¸ä¼šå¼•èµ·ä»»ä½•ç–‘é—®ã€‚ ä½†æ˜¯ï¼Œåº”åˆ†åˆ«æ³¨æ„ä¸¤ä»¶äº‹ã€‚ </p><br><p> é¦–å…ˆï¼ŒæŒ‡é’ˆæœ¬èº«ï¼Œå³  m_msgå±æ€§åœ¨protectedéƒ¨åˆ†ä¸­å®šä¹‰ï¼Œä»¥ä¾¿ç±»ç»§æ‰¿è€…å¯ä»¥è®¿é—®å®ƒã€‚ </p><br><p> å…¶æ¬¡ï¼Œå¯¹äºæ­¤ç±»ï¼Œç¼–è¯‘å™¨æœ¬èº«ä¼šç”Ÿæˆæ‰€æœ‰å¿…éœ€çš„æ„é€ å‡½æ•°å’Œå¤åˆ¶/ç§»åŠ¨è¿ç®—ç¬¦ã€‚ åœ¨è¿™ä¸ªçº§åˆ«çš„æ°´å¹³ä¸Šï¼Œæˆ‘ä»¬å°šæœªç¦æ­¢ä»»ä½•æ“ä½œã€‚ </p><br><h2 id="otdelnye-bazy-dlya-shared_ptr--i-unique_ptr-povedeniya">  shared_ptrå’Œunique_ptrè¡Œä¸ºçš„å•ç‹¬åŸºç¡€ </h2><br><p> å› æ­¤ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªå­˜å‚¨æŒ‡å‘æ¶ˆæ¯çš„æŒ‡é’ˆçš„ç±»ã€‚ ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰å…¶ç»§æ‰¿äººï¼Œå…¶ç»§æ‰¿äººå°†è¡¨ç°ä¸ºshared_ptræˆ–unique_ptrã€‚ </p><br><p> è®©æˆ‘ä»¬ä»shared_ptrè¡Œä¸ºçš„æƒ…å†µå¼€å§‹ï¼Œå› ä¸º è¿™æ˜¯æœ€å°‘çš„ä»£ç ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt; <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Payload, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Envelope &gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">shared_message_holder_impl_t</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">basic_message_holder_impl_t</span></span>&lt;Payload, Envelope&gt; { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> direct_base_type = <span class="hljs-keyword"><span class="hljs-keyword">basic_message_holder_impl_t</span></span>&lt;Payload, Envelope&gt;; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> : <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> direct_base_type::direct_base_type; [[nodiscard]] <span class="hljs-keyword"><span class="hljs-keyword">intrusive_ptr_t</span></span>&lt; Envelope &gt; make_reference() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">noexcept</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;m_msg; } };</code> </pre> <br><p> æ²¡ä»€ä¹ˆå¤æ‚çš„ï¼šä»<code>basic_message_holder_impl_t</code>ç»§æ‰¿ï¼Œç»§æ‰¿å…¶æ‰€æœ‰æ„é€ å‡½æ•°ï¼Œå¹¶å®šä¹‰<code>make_reference()</code>çš„ç®€å•ï¼Œæ— æŸå®ç°ã€‚ </p><br><p> å¯¹äºunique_ptrè¡Œä¸ºï¼Œä»£ç è™½ç„¶æ²¡æœ‰ä»€ä¹ˆå¤æ‚ä¹‹å¤„ï¼Œä½†æ˜¯ä»£ç æ›´å¤§ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt; <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Payload, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Envelope &gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unique_message_holder_impl_t</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">basic_message_holder_impl_t</span></span>&lt;Payload, Envelope&gt; { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> direct_base_type = <span class="hljs-keyword"><span class="hljs-keyword">basic_message_holder_impl_t</span></span>&lt;Payload, Envelope&gt;; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> : <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> direct_base_type::direct_base_type; <span class="hljs-keyword"><span class="hljs-keyword">unique_message_holder_impl_t</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unique_message_holder_impl_t</span></span> &amp; ) = <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">unique_message_holder_impl_t</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">unique_message_holder_impl_t</span></span> &amp;&amp; ) = <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">unique_message_holder_impl_t</span></span> &amp; <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>=( <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unique_message_holder_impl_t</span></span> &amp; ) = <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">unique_message_holder_impl_t</span></span> &amp; <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>=( <span class="hljs-keyword"><span class="hljs-keyword">unique_message_holder_impl_t</span></span> &amp;&amp; ) = <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>; [[nodiscard]] <span class="hljs-keyword"><span class="hljs-keyword">intrusive_ptr_t</span></span>&lt; Envelope &gt; make_reference() <span class="hljs-keyword"><span class="hljs-keyword">noexcept</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;m_msg) }; } };</code> </pre> <br><p> åŒæ ·ï¼Œæˆ‘ä»¬ä»<code>basic_message_holder_impl_t</code>ç»§æ‰¿å¹¶<code>basic_message_holder_impl_t</code>ç»§æ‰¿æ‰€éœ€çš„æ„é€ å‡½æ•°ï¼ˆè¿™æ˜¯é»˜è®¤æ„é€ å‡½æ•°å’Œåˆå§‹åŒ–æ„é€ å‡½æ•°ï¼‰ã€‚ ä½†åŒæ—¶ï¼Œæˆ‘ä»¬æ ¹æ®unique_ptré€»è¾‘å®šä¹‰æ„é€ å‡½æ•°å’Œå¤åˆ¶/ç§»åŠ¨è¿ç®—ç¬¦ï¼šæˆ‘ä»¬ç¦æ­¢å¤åˆ¶ï¼Œè€Œæ˜¯å®ç°ç§»åŠ¨ã€‚ </p><br><p> æˆ‘ä»¬<code>make_reference()</code>è¿˜æœ‰ä¸€ä¸ªç ´åæ€§çš„<code>make_reference()</code>æ–¹æ³•ã€‚ </p><br><p> å®é™…ä¸Šï¼Œä»…æ­¤è€Œå·²ã€‚ ä»ç„¶åªæœ‰å®ç°è¿™ä¸¤ä¸ªåŸºç±»ä¹‹é—´çš„é€‰æ‹©... </p><br><h3 id="vybor-mezhdu-shared_ptr--i-unique_ptr-povedeniem"> åœ¨shared_ptrå’Œunique_ptrè¡Œä¸ºä¹‹é—´è¿›è¡Œé€‰æ‹© </h3><br><p> è¦åœ¨shared_ptrå’Œunique_ptrè¡Œä¸ºä¹‹é—´è¿›è¡Œé€‰æ‹©ï¼Œæ‚¨éœ€è¦ä»¥ä¸‹å…ƒå‡½æ•°ï¼ˆå…ƒå‡½æ•°ï¼Œå› ä¸ºå®ƒâ€œåœ¨ç¼–è¯‘æ—¶â€ä¸ç±»å‹é…åˆä½¿ç”¨ï¼‰ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt; <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Msg, <span class="hljs-keyword"><span class="hljs-keyword">message_ownership_t</span></span> Ownership &gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">impl_selector</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static_assert</span></span>( !is_signal&lt;Msg&gt;::value, <span class="hljs-string"><span class="hljs-string">"Signals can't be used with message_holder"</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> P = <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> message_payload_type&lt; Msg &gt;::payload_type; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> E = <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> message_payload_type&lt; Msg &gt;::envelope_type; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> type = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">conditional_t</span></span>&lt; <span class="hljs-keyword"><span class="hljs-keyword">message_ownership_t</span></span>::autodetected == Ownership, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">conditional_t</span></span>&lt; <span class="hljs-keyword"><span class="hljs-keyword">message_mutability_t</span></span>::immutable_message == message_mutability_traits&lt;Msg&gt;::mutability, <span class="hljs-keyword"><span class="hljs-keyword">shared_message_holder_impl_t</span></span>&lt;P, E&gt;, <span class="hljs-keyword"><span class="hljs-keyword">unique_message_holder_impl_t</span></span>&lt;P, E&gt; &gt;, <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">conditional_t</span></span>&lt; <span class="hljs-keyword"><span class="hljs-keyword">message_ownership_t</span></span>::shared == Ownership, <span class="hljs-keyword"><span class="hljs-keyword">shared_message_holder_impl_t</span></span>&lt;P, E&gt;, <span class="hljs-keyword"><span class="hljs-keyword">unique_message_holder_impl_t</span></span>&lt;P, E&gt; &gt; &gt;; };</code> </pre> <br><p> æ­¤å…ƒå‡½æ•°æ¥å—<code>message_holder_t</code>å‚æ•°åˆ—è¡¨ä¸­çš„ä¸¤ä¸ªå‚æ•°ï¼Œç»“æœï¼ˆå³ï¼ŒåµŒå¥—<code>type</code>çš„å®šä¹‰ï¼‰â€œè¿”å›â€åº”ä»å…¶ç»§æ‰¿çš„ç±»å‹ã€‚ å³  <code>shared_message_holder_impl_t</code>æˆ–<code>unique_message_holder_impl_t</code> ã€‚ </p><br><p> åœ¨<code>impl_selector</code>çš„å®šä¹‰å†…<code>impl_selector</code>æ‚¨å¯ä»¥çœ‹åˆ°ä¸Šé¢æåˆ°çš„é­”æœ¯ç—•è¿¹ï¼Œè€Œæˆ‘ä»¬æ²¡æœ‰æ¶‰åŠåˆ°å®ƒï¼š <code>message_payload_type&lt;Msg&gt;::payload_type</code> ï¼Œ <code>message_payload_type&lt;Msg&gt;::envelope_type</code> <code>message_mutability_traits&lt;Msg&gt;::mutability</code>å’Œ<code>message_mutability_traits&lt;Msg&gt;::mutability</code> ã€‚ </p><br><p> ä¸ºäº†æ›´è½»æ¾åœ°ä½¿ç”¨<code>impl_selector</code> ï¼Œæˆ‘ä»¬å°†ä¸ºå…¶å®šä¹‰ä¸€ä¸ªè¾ƒçŸ­çš„åç§°ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt; <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Msg, <span class="hljs-keyword"><span class="hljs-keyword">message_ownership_t</span></span> Ownership &gt; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">impl_selector_t</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> impl_selector&lt;Msg, Ownership&gt;::type;</code> </pre> <br><h2 id="baza-dlya-getter-ov"> å¸æ°”å‰‚çš„åŸºç¡€ </h2><br><p> å› æ­¤ï¼Œæˆ‘ä»¬å·²ç»æœ‰æœºä¼šé€‰æ‹©ä¸€ä¸ªåŒ…å«æŒ‡é’ˆå¹¶å®šä¹‰â€œæ™ºèƒ½æŒ‡é’ˆâ€è¡Œä¸ºçš„åŸºç¡€ã€‚ ç°åœ¨ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºè¯¥åŸºç¡€æä¾›getteræ–¹æ³•ã€‚ ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦ä¸€ä¸ªç®€å•çš„ç±»ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt; <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Base, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Return_Type &gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">msg_accessors_t</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Base { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> : <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Base::Base; [[nodiscard]] <span class="hljs-function"><span class="hljs-function">Return_Type * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">noexcept</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> get_ptr( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;m_msg ); } [[nodiscard]] Return_Type &amp; <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> * () <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">noexcept</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> *get(); } [[nodiscard]] Return_Type * <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>-&gt;() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">noexcept</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> get(); } };</code> </pre> <br><p> è¿™æ˜¯ä¸€ä¸ªä¾èµ–ä¸¤ä¸ªå‚æ•°çš„æ¨¡æ¿ç±»ï¼Œä½†æ˜¯å®ƒä»¬çš„å«ä¹‰å®Œå…¨ä¸åŒã€‚ åŸºæœ¬å‚æ•°å°†æ˜¯ä¸Šé¢æ˜¾ç¤ºçš„<code>impl_selector</code>å…ƒå‡½æ•°çš„ç»“æœã€‚ å³ ä½œä¸ºBaseå‚æ•°ï¼Œè®¾ç½®è¦ç»§æ‰¿çš„åŸºç±»ã€‚ </p><br><p> é‡è¦çš„æ˜¯è¦æ³¨æ„ï¼Œå¦‚æœç»§æ‰¿æ¥è‡ª<code>unique_message_holder_impl_t</code> ï¼Œç¦æ­¢ä½¿ç”¨è¯¥æ„é€ å‡½æ•°å’Œå¤åˆ¶è¿ç®—ç¬¦ï¼Œåˆ™ç¼–è¯‘å™¨å°†æ— æ³•ç”Ÿæˆ<code>msg_accessors_t</code>çš„æ„é€ å‡½æ•°å’Œå¤åˆ¶è¿ç®—ç¬¦ã€‚ è¿™å°±æ˜¯æˆ‘ä»¬æ‰€éœ€è¦çš„ã€‚ </p><br><p>  return_Typeå‚æ•°å°†æ˜¯æ¶ˆæ¯çš„ç±»å‹ï¼Œgetterå°†è¿”å›æ¶ˆæ¯çš„æŒ‡é’ˆ/é“¾æ¥ã€‚ è¯€çªæ˜¯ï¼Œå¯¹äºç±»å‹ä¸º<code>Msg</code>çš„ä¸å¯å˜æ¶ˆæ¯<code>Msg</code> Return_Typeå‚æ•°å°†è®¾ç½®ä¸º<code>const Msg</code> ã€‚ å¯¹äºç±»å‹ä¸º<code>Msg</code>çš„å¯å˜æ¶ˆæ¯<code>Msg</code>å‚æ•°Return_Typeå°†å…·æœ‰å€¼<code>Msg</code> ã€‚ å› æ­¤ï¼Œ <code>get()</code>æ–¹æ³•å°†ä¸ºä¸å˜æ¶ˆæ¯è¿”å›<code>const Msg*</code> ï¼Œè€Œå¯¹äºå¯å˜æ¶ˆæ¯ä»…è¿”å›<code>Msg*</code> ã€‚ </p><br><p> ä½¿ç”¨å…è´¹å‡½æ•°<code>get_ptr()</code>è§£å†³äº†ä½¿ç”¨æœªä»<code>message_t</code>ç»§æ‰¿çš„æ¶ˆæ¯çš„é—®é¢˜ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt; <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> M &gt; <span class="hljs-function"><span class="hljs-function">M * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_ptr</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">intrusive_ptr_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;M&gt; &amp; msg )</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">noexcept</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> msg.get(); } <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt; <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> M &gt; <span class="hljs-function"><span class="hljs-function">M * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_ptr</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">intrusive_ptr_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt; </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">user_type_message_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;M&gt; &gt; &amp; msg )</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">noexcept</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::addressof(msg-&gt;m_payload); }</code> </pre> <br><p> å³ å¦‚æœæ¶ˆæ¯ä¸æ˜¯ä»<code>message_t</code>ç»§æ‰¿å¹¶å­˜å‚¨ä¸º<code>user_type_message_t&lt;Msg&gt;</code> ï¼Œåˆ™è°ƒç”¨ç¬¬äºŒä¸ªé‡è½½ã€‚ è€Œä¸”å¦‚æœå®ƒæ˜¯ç»§æ‰¿çš„ï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªé‡è½½ã€‚ </p><br><h3 id="vybor-konkretnoy-bazy-dlya-getter-ov"> ä¸ºå¸æ°”å‰‚é€‰æ‹©ç‰¹å®šçš„åŸºç¡€ </h3><br><p> å› æ­¤ï¼Œ <code>msg_accessors_t</code>æ¨¡æ¿éœ€è¦ä¸¤ä¸ªå‚æ•°ã€‚ ç¬¬ä¸€ä¸ªç”±<code>impl_selector</code>å…ƒå‡½æ•°è®¡ç®—ã€‚ ä½†æ˜¯ä¸ºäº†ä»<code>msg_accessors_t</code>å½¢æˆç‰¹å®šçš„åŸºæœ¬ç±»å‹ï¼Œæˆ‘ä»¬éœ€è¦ç¡®å®šç¬¬äºŒä¸ªå‚æ•°çš„å€¼ã€‚ ä¸ºæ­¤ï¼Œè¿˜éœ€è¦ä¸€ä¸ªå…ƒåŠŸèƒ½ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt; <span class="hljs-keyword"><span class="hljs-keyword">message_mutability_t</span></span> Mutability, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Base &gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">accessor_selector</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> type = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">conditional_t</span></span>&lt; <span class="hljs-keyword"><span class="hljs-keyword">message_mutability_t</span></span>::immutable_message == Mutability, <span class="hljs-keyword"><span class="hljs-keyword">msg_accessors_t</span></span>&lt;Base, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Base::payload_type <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>&gt;, <span class="hljs-keyword"><span class="hljs-keyword">msg_accessors_t</span></span>&lt;Base, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Base::payload_type&gt; &gt;; };</code> </pre> <br><p> æ‚¨åªèƒ½æ³¨æ„Return_Typeå‚æ•°çš„è®¡ç®—ã€‚  East constæœ‰ç”¨çš„å°‘æ•°æƒ…å†µä¹‹ä¸€ï¼›ï¼‰ </p><br><p> å¥½å§ï¼Œä¸ºäº†æé«˜ä»¥ä¸‹ä»£ç çš„å¯è¯»æ€§ï¼Œå¯ä»¥ä½¿ç”¨ä¸€ä¸ªæ›´ç´§å‡‘çš„é€‰é¡¹ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt; <span class="hljs-keyword"><span class="hljs-keyword">message_mutability_t</span></span> Mutability, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Base &gt; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">accessor_selector_t</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> accessor_selector&lt;Mutability, Base&gt;::type;</code> </pre> <br><h2 id="itogovyy-naslednik-message_holder_t"> æœ€åçš„åç»§message_holder_t </h2><br><p> ç°åœ¨ï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹<code>message_holder_t</code>ä»€ä¹ˆï¼Œå¯¹äºå®ç°æ‰€æœ‰è¿™äº›åŸºæœ¬ç±»å’Œå…ƒåŠŸèƒ½éƒ½æ˜¯å¿…éœ€çš„ï¼ˆä»å®ç°ä¸­åˆ é™¤äº†æ„é€ å­˜å‚¨åœ¨message_holderä¸­çš„æ¶ˆæ¯å®ä¾‹çš„æ–¹æ³•çš„ä¸€éƒ¨åˆ†ï¼‰ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt; <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Msg, <span class="hljs-keyword"><span class="hljs-keyword">message_ownership_t</span></span> Ownership = <span class="hljs-keyword"><span class="hljs-keyword">message_ownership_t</span></span>::autodetected &gt; class <span class="hljs-keyword"><span class="hljs-keyword">message_holder_t</span></span> : <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> details::message_holder_details::<span class="hljs-keyword"><span class="hljs-keyword">accessor_selector_t</span></span>&lt; details::message_mutability_traits&lt;Msg&gt;::mutability, details::message_holder_details::<span class="hljs-keyword"><span class="hljs-keyword">impl_selector_t</span></span>&lt;Msg, Ownership&gt; &gt; { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> base_type = details::message_holder_details::<span class="hljs-keyword"><span class="hljs-keyword">accessor_selector_t</span></span>&lt; details::message_mutability_traits&lt;Msg&gt;::mutability, details::message_holder_details::<span class="hljs-keyword"><span class="hljs-keyword">impl_selector_t</span></span>&lt;Msg, Ownership&gt; &gt;; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> : <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> payload_type = <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> base_type::payload_type; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> envelope_type = <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> base_type::envelope_type; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> base_type::base_type; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">friend</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">swap</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">message_holder_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> &amp; a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">message_holder_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> &amp; b )</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">noexcept</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::swap; swap( a.message_reference(), b.message_reference() ); } };</code> </pre> <br><p> å®é™…ä¸Šï¼Œæˆ‘ä»¬ä¸Šé¢åˆ†æçš„æ‰€æœ‰å†…å®¹éƒ½æ˜¯å¿…éœ€çš„ï¼Œä»¥ä¾¿è®°å½•ä»¥ä¸‹ä¸¤ä¸ªå…ƒå‡½æ•°çš„â€œè°ƒç”¨â€ï¼š </p><br><pre> <code class="cpp hljs">details::message_holder_details::<span class="hljs-keyword"><span class="hljs-keyword">accessor_selector_t</span></span>&lt; details::message_mutability_traits&lt;Msg&gt;::mutability, details::message_holder_details::<span class="hljs-keyword"><span class="hljs-keyword">impl_selector_t</span></span>&lt;Msg, Ownership&gt; &gt;</code> </pre> <br><p> å› ä¸º è¿™ä¸æ˜¯ç¬¬ä¸€ç§é€‰æ‹©ï¼Œè€Œæ˜¯ç®€åŒ–å’Œå‡å°‘ä»£ç çš„ç»“æœï¼Œæˆ‘å¯ä»¥è¯´ç´§å‡‘çš„å…ƒå‡½æ•°å½¢å¼å¯ä»¥å¤§å¤§å‡å°‘ä»£ç é‡å¹¶æé«˜å…¶å¯ç†è§£æ€§ï¼ˆå¦‚æœé€šå¸¸åœ¨è¿™é‡Œè°ˆè®ºå¯ç†è§£æ€§ï¼‰ã€‚ </p><br><h1 id="a-chto-bylo-by-esli-by"> å¦‚æœ... </h1><br><p> ä½†æ˜¯ï¼Œå¦‚æœåœ¨C ++ä¸­<code>if constexpr</code>å’Œåœ¨Dä¸­ä¸€æ ·å¼ºå¤§ï¼Œé‚£ä¹ˆæ‚¨å¯ä»¥ç¼–å†™å¦‚ä¸‹ä»£ç ï¼š </p><br><div class="spoiler">  <b class="spoiler_title">å‡è®¾ç‰ˆæœ¬ï¼Œå¦‚æœä½¿ç”¨constexprï¼Œåˆ™å…·æœ‰æ›´é«˜çº§çš„åŠŸèƒ½</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt; <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Msg, <span class="hljs-keyword"><span class="hljs-keyword">message_ownership_t</span></span> Ownership = <span class="hljs-keyword"><span class="hljs-keyword">message_ownership_t</span></span>::autodetected &gt; class <span class="hljs-keyword"><span class="hljs-keyword">message_holder_t</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">message_mutability_t</span></span> Mutability = details::message_mutability_traits&lt;Msg&gt;::mutability; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">message_ownership_t</span></span> Actual_Ownership = (<span class="hljs-keyword"><span class="hljs-keyword">message_ownership_t</span></span>::unique == Ownership || (<span class="hljs-keyword"><span class="hljs-keyword">message_mutability_t</span></span>::mutable_msg == Mutability &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">message_ownership_t</span></span>::autodetected == Ownership)) ? <span class="hljs-keyword"><span class="hljs-keyword">message_ownership_t</span></span>::unique : <span class="hljs-keyword"><span class="hljs-keyword">message_ownership_t</span></span>::shared; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> : <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> payload_type = <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> message_payload_type&lt; Msg &gt;::payload_type; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> envelope_type = <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> message_payload_type&lt; Msg &gt;::envelope_type; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> : <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> getter_return_type = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">conditional_t</span></span>&lt; <span class="hljs-keyword"><span class="hljs-keyword">message_mutability_t</span></span>::immutable_msg == Mutability, payload_type <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>, payload_type &gt;; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> : <span class="hljs-keyword"><span class="hljs-keyword">message_holder_t</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">noexcept</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">message_holder_t</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">intrusive_ptr_t</span></span>&lt; envelope_type &gt; mf ) <span class="hljs-keyword"><span class="hljs-keyword">noexcept</span></span> : m_msg{ <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move(mf) } {} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">if</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">constexpr</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">message_ownership_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">::unique == Actual_Ownership )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">message_holder_t</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">message_holder_t</span></span> &amp; ) = <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">message_holder_t</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">message_holder_t</span></span> &amp;&amp; ) <span class="hljs-keyword"><span class="hljs-keyword">noexcept</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">message_holder_t</span></span> &amp; <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>=( <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">message_holder_t</span></span> &amp; ) = <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">message_holder_t</span></span> &amp; <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>=( <span class="hljs-keyword"><span class="hljs-keyword">message_holder_t</span></span> &amp;&amp; ) <span class="hljs-keyword"><span class="hljs-keyword">noexcept</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">friend</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">swap</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">message_holder_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> &amp; a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">message_holder_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> &amp; b )</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">noexcept</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::swap; swap( a.m_msg, b.m_msg ); } [[nodiscard]] <span class="hljs-function"><span class="hljs-function">getter_return_type * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">noexcept</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> get_const_ptr( m_msg ); } [[nodiscard]] getter_return_type &amp; <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> * () <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">noexcept</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> *get(); } [[nodiscard]] getter_return_type * <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>-&gt;() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">noexcept</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> get(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">if</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">constexpr</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">message_ownership_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">::shared == Actual_Ownership)</span></span></span><span class="hljs-function"> </span></span>{ [[nodiscard]] <span class="hljs-keyword"><span class="hljs-keyword">intrusive_ptr_t</span></span>&lt; envelope_type &gt; make_reference() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">noexcept</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> m_msg; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { [[nodiscard]] <span class="hljs-keyword"><span class="hljs-keyword">intrusive_ptr_t</span></span>&lt; envelope_type &gt; make_reference() <span class="hljs-keyword"><span class="hljs-keyword">noexcept</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move(m_msg) }; } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> : <span class="hljs-keyword"><span class="hljs-keyword">intrusive_ptr_t</span></span>&lt; envelope_type &gt; m_msg; };</code> </pre> </div></div><br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¯¹æˆ‘æ¥è¯´ï¼Œå·®å¼‚å¤ªæƒŠäººäº†ã€‚</font><font style="vertical-align: inherit;">è€Œä¸”å®ƒä»¬ä¹Ÿä¸èµæˆå½“å‰çš„C ++ï¼šï¼ˆ</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆä¸Šé¢ä»¥ä¸€ä¸ªè¿ç»­çš„â€œ footfootâ€å½¢å¼åˆ†è§£çš„C ++ä»£ç å¯ä»¥åœ¨</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ­¤å¤„</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">çœ‹åˆ°</font><font style="vertical-align: inherit;">ï¼‰ã€‚</font></font></p><br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">é¡ºä¾¿è¯´ä¸€å¥ï¼Œæˆ‘å¹¶æ²¡æœ‰çœŸæ­£äº†è§£C ++æœªæ¥ç‰ˆæœ¬çš„å…ƒç¼–ç¨‹å’Œåå°„å»ºè®®é¢†åŸŸä¸­æ­£åœ¨å‘ç”Ÿçš„äº‹æƒ…ã€‚</font><font style="vertical-align: inherit;">ä½†æ˜¯ä»æˆ‘çš„è®°å¿†ä¸­ï¼Œæˆ‘ä¼šæ„Ÿè§‰åˆ°Sutteræå‡ºçš„å…ƒç±»ä¸ä¼šå¤§å¤§ç®€åŒ–è¿™ä¸€ç‰¹å®šä»»åŠ¡ã€‚</font><font style="vertical-align: inherit;">æ®æˆ‘äº†è§£ï¼Œå€ŸåŠ©å…ƒç±»ï¼Œå¯ä»¥ç¼–å†™ä¸€ä¸ªç±»ç”Ÿæˆå™¨</font></font><code>message_holder_t</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">è¿™æ ·çš„ç”Ÿæˆå™¨å¯èƒ½å†™èµ·æ¥å¾ˆç®€å•ï¼Œä½†æ˜¯åœ¨è¿™ç§ç‰¹å®šæƒ…å†µä¸‹ï¼Œè¿™ç§æ–¹æ³•ä¸å¤ªå¯èƒ½æ¯”çœŸæ­£é«˜çº§çš„æ–¹æ³•æ›´å…·è¡¨è¾¾æ€§å’Œå¯ç†è§£æ€§</font></font><code>if constexpr</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font></p><br><h1 id="zaklyuchenie"> ç»“è®º </h1><br><p>   ,         C++. ,     .  ,    ,          . </p><br><p>                ,           . </p><br><p>   ,   ,   ++   ,   .      ,    . , ,            .  ,    .   C++98/03        ,     C++11       . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN449122/">https://habr.com/ru/post/zh-CN449122/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN449110/index.html">ä¿®å¤äº†ä¸æ— æ³•åœ¨IMAPæ–‡ä»¶å¤¹åç§°ä¸­ä½¿ç”¨è¥¿é‡Œå°”å­—æ¯æœ‰å…³çš„é”™è¯¯</a></li>
<li><a href="../zh-CN449112/index.html">æˆ‘ä»¬å·²é€€ä¼‘-æˆ‘ä»¬è®¨è®ºçš„æ˜¯æ›¾ç»â€œè¿‡æ—¶â€çš„æµè¡ŒéŸ³é¢‘å°å·¥å…·</a></li>
<li><a href="../zh-CN449114/index.html">å¯¹Î»ambdaååº”</a></li>
<li><a href="../zh-CN449118/index.html">å…‹é‡Œå§†æ—å®«æ¶é­”ä¸¸</a></li>
<li><a href="../zh-CN449120/index.html">ç•™ç€èƒ¡å­ï¼Œæˆ´ç€å¢¨é•œå’Œå¤–å½¢ï¼šè®¡ç®—æœºè§†è§‰çš„å›°éš¾æƒ…å†µ</a></li>
<li><a href="../zh-CN449124/index.html">å¦‚æ­¤éš¾ä»¥æ‰¾åˆ°ï¼Œå®¹æ˜“é”™è¿‡ä¸”ä¸å¯èƒ½å‘è¡Œ</a></li>
<li><a href="../zh-CN449128/index.html">ä¸–ç•Œé¡¶çº§æ¸¸æˆå¼€å‘å…¬å¸</a></li>
<li><a href="../zh-CN449132/index.html">é€‚ç”¨äºAndroid Studioçš„17ä¸ªé¡¶çº§æ’ä»¶</a></li>
<li><a href="../zh-CN449134/index.html">åŠ¨ç‰©å›­afl</a></li>
<li><a href="../zh-CN449138/index.html">åŠ å¯†å¸½çš„5ä¸ªç†ç”± ä¸ºä»€ä¹ˆITäººå‘˜ä¸å–œæ¬¢æ¯”ç‰¹å¸</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>