<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚õ∞Ô∏è üòò üåÇ Sistema de Gerenciamento de Configura√ß√£o de Rede Qrator Filter üö¥üèΩ üï∂Ô∏è üêú</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="TL; DR : Descri√ß√£o da arquitetura cliente-servidor do nosso sistema interno de gerenciamento de configura√ß√£o de rede, QControl. Ele √© baseado em um pr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Sistema de Gerenciamento de Configura√ß√£o de Rede Qrator Filter</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/qrator/blog/463739/"><img src="https://habrastorage.org/webt/m2/ak/w7/m2akw7igwdnpnlkl-wtyczkznlc.jpeg"><br><br>  <b>TL; DR</b> : Descri√ß√£o da arquitetura cliente-servidor do nosso sistema interno de gerenciamento de configura√ß√£o de rede, QControl.  Ele √© baseado em um protocolo de transporte de dois n√≠veis que funciona com mensagens compactadas em gzip sem descompacta√ß√£o entre os pontos de extremidade.  Roteadores distribu√≠dos e pontos de extremidade recebem atualiza√ß√µes de configura√ß√£o, e o pr√≥prio protocolo permite a instala√ß√£o de rel√©s intermedi√°rios localizados.  O sistema √© constru√≠do com base no princ√≠pio do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">backup diferencial</a> (‚Äúrecente-est√°vel‚Äù, explicado abaixo) e usa a linguagem de consulta JMESpath junto com o mecanismo de modelo Jinja para renderizar arquivos de configura√ß√£o. <br><br>  O Qrator Labs gerencia uma rede de mitiga√ß√£o de ataques distribu√≠da globalmente.  Nossa rede trabalha com o princ√≠pio de anycast, e as sub-redes s√£o anunciadas via BGP.  Sendo uma rede anycast BGP localizada fisicamente em v√°rias regi√µes da Terra, podemos processar e filtrar o tr√°fego ileg√≠timo mais pr√≥ximo do n√∫cleo da Internet - operadores de n√≠vel 1. <br><br>  Por outro lado, ser uma rede distribu√≠da geograficamente n√£o √© f√°cil.  A comunica√ß√£o entre os pontos de presen√ßa da rede √© fundamental para um provedor de servi√ßos de seguran√ßa, a fim de ter uma configura√ß√£o consistente de todos os n√≥s da rede, atualizando-os em tempo h√°bil.  Portanto, para fornecer o n√≠vel mais alto poss√≠vel de servi√ßos b√°sicos para os consumidores, precis√°vamos encontrar uma maneira de sincronizar de forma confi√°vel os dados de configura√ß√£o entre os continentes. <br><blockquote>  No come√ßo era a Palavra.  Ele rapidamente se tornou um protocolo de comunica√ß√£o que precisava de uma atualiza√ß√£o. </blockquote><a name="habracut"></a><br>  A pedra angular da exist√™ncia do QControl e, ao mesmo tempo, o principal motivo para gastar uma quantidade significativa de tempo e recursos para construir esse protocolo √© a necessidade de obter uma √∫nica fonte autorizada de configura√ß√£o e, finalmente, sincronizar nossos pontos de presen√ßa com ele.  O pr√≥prio reposit√≥rio foi apenas um dos v√°rios requisitos durante o desenvolvimento do QControl.  Al√©m disso, tamb√©m precis√°vamos de integra√ß√£o com os servi√ßos existentes e planejados nos pontos de presen√ßa (TP), m√©todos inteligentes (e personaliz√°veis) de valida√ß√£o de dados e controle de acesso.  Al√©m disso, tamb√©m quer√≠amos gerenciar esse sistema usando comandos, em vez de fazer modifica√ß√µes nos arquivos.  Antes do QControl, os dados eram enviados para pontos de presen√ßa no modo quase manual.  Se um dos pontos de presen√ßa n√£o estivesse dispon√≠vel e esquecemos de atualiz√°-lo mais tarde, a configura√ß√£o estava fora de sincronia - voc√™ precisou gastar algum tempo retornando-o ao servi√ßo. <br><br>  Como resultado, criamos o seguinte esquema: <br><img src="https://habrastorage.org/webt/_5/iy/zf/_5iyzfealoms5eprrxrmg-hhwui.png"><br>  O servidor de configura√ß√£o √© respons√°vel pela valida√ß√£o e armazenamento de dados, o roteador possui v√°rios pontos de extremidade que recebem e transmitem atualiza√ß√µes de configura√ß√£o de clientes e equipes de suporte ao servidor e do servidor para pontos de presen√ßa. <br><br>  A qualidade da conex√£o √† Internet ainda √© significativamente diferente em diferentes partes do mundo - para ilustrar esta tese, vejamos um MTR simples de Praga, Rep√∫blica Tcheca, Cingapura e Hong Kong. <br><br> <a href=""><img src="https://habrastorage.org/webt/ob/pl/vc/obplvcdpqlc8as-nra_jnpv4hbc.png" alt="imagem"></a> <br>  MTR de Praga para Singapura <br><br> <a href=""><img src="https://habrastorage.org/webt/4z/xo/7s/4zxo7sr_qqrg6cdlipwwvujohto.png" alt="imagem"></a> <br>  A mesma coisa para Hong Kong <br><br>  Atrasos altos significam menos velocidade.  Al√©m disso, h√° perda de pacotes.  A largura dos canais n√£o compensa esse problema, que sempre deve ser levado em considera√ß√£o ao criar sistemas descentralizados. <br><br>  Uma configura√ß√£o completa do ponto de presen√ßa √© uma quantidade significativa de dados que precisa ser enviada a muitos destinat√°rios por meio de conex√µes n√£o confi√°veis.  Felizmente, embora a configura√ß√£o esteja constantemente mudando, isso acontece em pequenas por√ß√µes. <br><br><h3>  Projeto est√°vel recente </h3><br>  Podemos dizer que construir uma rede distribu√≠da com base no princ√≠pio de atualiza√ß√µes incrementais √© uma solu√ß√£o bastante √≥bvia.  Mas h√° muitos problemas com diffs.  Precisamos manter todas as diferen√ßas entre os pontos de controle e poder envi√°-las caso algu√©m perca alguns dados.  Cada destino deve aplic√°-los em uma sequ√™ncia estritamente definida.  Normalmente, no caso de v√°rios destinos, essa opera√ß√£o pode levar muito tempo.  O destinat√°rio tamb√©m deve poder solicitar as partes ausentes e, √© claro, a parte central deve responder a essa solicita√ß√£o corretamente, enviando apenas os dados ausentes. <br><br>  Como resultado, chegamos a uma solu√ß√£o bastante interessante - temos apenas uma camada de suporte, fixa, vamos cham√°-la est√°vel, e apenas uma diferen√ßa por ser recente.  Cada recente √© baseado no √∫ltimo est√°bulo formado e √© suficiente para reconstruir os dados de configura√ß√£o.  Assim que um novo recente chega ao seu destino, o antigo n√£o √© mais necess√°rio. <br><br>  Ocasionalmente, envia periodicamente uma nova configura√ß√£o est√°vel, por exemplo, devido ao fato de as recentes terem se tornado muito grandes.  Tamb√©m √© importante aqui enviarmos todas essas atualiza√ß√µes no modo de difus√£o / difus√£o seletiva, sem nos preocuparmos com os destinat√°rios individuais e sua capacidade de coletar dados juntos.  Assim que estamos convencidos de que todos t√™m o est√°bulo correto, enviamos apenas os novos mais recentes.  Vale a pena esclarecer que isso funciona?  Isso funciona.  Est√°vel √© armazenado em cache no servidor de configura√ß√£o e nos destinat√°rios; recente √© criado conforme necess√°rio. <br><br><h3>  Arquitetura de transporte em dois n√≠veis </h3><br>  Por que constru√≠mos nosso transporte em dois n√≠veis?  A resposta √© bastante simples - quer√≠amos separar o roteamento da l√≥gica de alto n√≠vel, inspirando-se no modelo OSI com sua camada de transporte e camada de aplica√ß√£o.  Tom√°mos o Thrift como protocolo de transporte e o formato de serializa√ß√£o msgpack para o formato de mensagem de controle de alto n√≠vel.  √â por isso que o roteador (executando multicast / broadcast / retransmiss√£o) n√£o olha dentro do msgpack, n√£o descompacta e n√£o empacota o conte√∫do de volta, e apenas realiza a transfer√™ncia de dados. <br><br>  <i>O Thrift (do ingl√™s - ‚Äúthrift‚Äù, pronunciado [Œ∏rift]) √© uma linguagem de descri√ß√£o de interface usada para definir e criar servi√ßos para diferentes linguagens de programa√ß√£o.</i>  <i>√â uma estrutura para chamada de procedimento remoto (RPC).</i>  <i>Ele combina um pipeline de software com um mecanismo de gera√ß√£o de c√≥digo para o desenvolvimento de servi√ßos que, em um grau ou outro, funcionam de maneira eficiente e f√°cil entre idiomas.</i> <br><br>  Adotamos a estrutura Thrift por causa do RPC e suporte para v√°rios idiomas.  Como sempre, o cliente e o servidor s√£o as partes f√°ceis.  No entanto, o roteador acabou por ser um osso duro de roer, em parte devido √† falta de uma solu√ß√£o pronta durante o nosso desenvolvimento. <br><br><img src="https://habrastorage.org/webt/l8/so/6v/l8so6vrzh0u_feb60p6ehjbubs0.png" alt="imagem" align="left">  Existem outras op√ß√µes, como protobuf / gRPC, no entanto, quando iniciamos nosso projeto, o gRPC era bastante jovem e n√£o ousamos aceit√°-lo. <br><br>  √â claro que poder√≠amos (e de fato valeu a pena) criar nossa pr√≥pria bicicleta.  Seria mais f√°cil criar um protocolo para o que precisamos, porque a arquitetura cliente-servidor √© relativamente direta na implementa√ß√£o em compara√ß√£o com a constru√ß√£o de um roteador no Thrift.  De uma forma ou de outra, existe uma atitude preconceituosa tradicional em rela√ß√£o aos protocolos e implementa√ß√µes auto-escritas de bibliotecas populares (n√£o em v√£o); al√©m disso, a discuss√£o sempre levanta a quest√£o: "Como vamos port√°-la para outros idiomas?"  Portanto, imediatamente lan√ßamos id√©ias sobre a bicicleta. <br><br>  <i>Msgpack √© um an√°logo do JSON, mas mais r√°pido e menos.</i>  <i>Este √© um formato de serializa√ß√£o de dados bin√°rios que permite a troca de dados entre v√°rios idiomas.</i> <br><br>  No primeiro n√≠vel, temos o Thrift com as informa√ß√µes m√≠nimas necess√°rias para o roteador encaminhar a mensagem.  No segundo n√≠vel, est√£o estruturas empacotadas do msgpack. <br><br>  Escolhemos o msgpack porque √© mais r√°pido e mais compacto em compara√ß√£o com o JSON.  Mais importante, por√©m, ele suporta tipos de dados personalizados, permitindo o uso de recursos interessantes, como a transfer√™ncia de bin√°rios brutos ou objetos especiais, indicando a falta de dados, o que foi importante para o nosso recente esquema est√°vel. <br><br>  <b>Jmespath</b> <br>  <i>JMESPath √© uma linguagem de solicita√ß√£o JSON.</i> <br>  √â exatamente assim que a descri√ß√£o se parece, que obtemos da documenta√ß√£o oficial do JMESPath, mas, na verdade, fornece muito mais.  O JMESPath permite pesquisar e filtrar sub√°rvores em uma estrutura de √°rvore arbitr√°ria, bem como aplicar altera√ß√µes nos dados em tempo real.  Tamb√©m permite adicionar filtros especiais e procedimentos de convers√£o de dados.  Embora, √© claro, exija tens√£o cerebral para entender. <br><br>  <b>Jinja</b> <br>  Para alguns consumidores, precisamos transformar a configura√ß√£o em um arquivo - portanto, usamos o mecanismo de modelo e o Jinja √© a escolha √≥bvia.  Com sua ajuda, geramos um arquivo de configura√ß√£o a partir do modelo e dos dados recebidos no destino. <br><br>  Para gerar o arquivo de configura√ß√£o, precisamos de uma solicita√ß√£o JMESPath, um modelo para o local do arquivo no FS, um modelo para a pr√≥pria configura√ß√£o.  Tamb√©m nesta fase, √© bom esclarecer as permiss√µes de arquivo.  Tudo isso foi combinado com sucesso em um arquivo - antes do in√≠cio do modelo de configura√ß√£o, colocamos o cabe√ßalho no formato YAML, que descreve o restante. <br><br>  Por exemplo: <br><br> <code>--- <br> selector: "[@][?@.fft._meta.version == `42`] | items([0].fft_config || `{}`)" <br> destination_filename: "fft/{{ match[0] }}.json" <br> file_mode: 0644 <br> reload_daemons: [fft] <br> ... <br> {{ dict(match[1]) | json(indent=2, sort_keys=True) }} <br></code> <br><br>  Para criar um arquivo de configura√ß√£o para um novo servi√ßo, adicionamos apenas um novo arquivo de modelo.  N√£o s√£o necess√°rias altera√ß√µes no c√≥digo-fonte ou no software nos pontos de presen√ßa. <br><br>  O que mudou desde que o QControl foi introduzido nas opera√ß√µes?  A primeira e mais importante √© a entrega consistente e confi√°vel de atualiza√ß√µes de configura√ß√£o em todos os n√≥s da rede.  O segundo √© obter uma poderosa ferramenta de verifica√ß√£o de configura√ß√£o e fazer altera√ß√µes na nossa equipe de suporte, bem como nos consumidores do servi√ßo. <br><br>  Conseguimos fazer tudo isso usando o esquema de atualiza√ß√£o est√°vel recente para simplificar a comunica√ß√£o entre o servidor de configura√ß√£o e os destinat√°rios da configura√ß√£o.  Usando um protocolo de duas camadas para oferecer suporte a um m√©todo de roteamento de dados independente de conte√∫do.  Tendo integrado com √™xito o mecanismo de gera√ß√£o de configura√ß√£o baseado em Jinja em uma rede de filtragem distribu√≠da.  Este sistema suporta uma ampla variedade de m√©todos de configura√ß√£o para nossos perif√©ricos distribu√≠dos e variados. <br><br>  Obrigado por escrever material, gra√ßas a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">VolanDamrod</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">serenheit</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">NoN</a> . <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Vers√£o em ingl√™s do</a> post. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt463739/">https://habr.com/ru/post/pt463739/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt463727/index.html">Como entrar no topo do Google na UE / EUA no nicho de desenvolvimento e encontrar clientes com grandes or√ßamentos</a></li>
<li><a href="../pt463729/index.html">Encontro com o fundador do NSTR Viktor Chernikov</a></li>
<li><a href="../pt463733/index.html">Mesh VS WiFi: o que escolher para wireless?</a></li>
<li><a href="../pt463735/index.html">Sistema de entrega de configura√ß√£o de rede de filtragem Qrator</a></li>
<li><a href="../pt463737/index.html">Resolu√ß√£o de problemas com pwnable.kr 21 - horcuxes. Programa√ß√£o orientada a retorno e cadeias ROP</a></li>
<li><a href="../pt463741/index.html">Firefox (j√° corrigido) e Chrome permitem usar o cabe√ßalho Alt-Svc para verificar portas da intranet</a></li>
<li><a href="../pt463745/index.html">Complicar C ++ √© inevit√°vel. E n√£o apenas C ++</a></li>
<li><a href="../pt463747/index.html">Acessar propriedades dentro do campo Jsonb para Npgsql</a></li>
<li><a href="../pt463749/index.html">Scrum vs Kanban: mantenha a calma e escolha o que melhor combina com voc√™</a></li>
<li><a href="../pt463751/index.html">iOS 13: o que voc√™ precisa e o que absolutamente n√£o precisa fazer ao desenvolver um novo sistema operacional</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>