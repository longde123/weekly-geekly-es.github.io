<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèª‚Äçü§ù‚Äçüë®üèº üôÜüèΩ üèáüèª Usando asyncio para criar drivers de dispositivo ass√≠ncronos no MicroPython v.1.12 üêà üë®üèø‚Äç‚öïÔ∏è üßî</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Estudando as possibilidades do MicroPython para seus prop√≥sitos, deparei-me com uma das implementa√ß√µes da biblioteca ass√≠ncrona e, ap√≥s uma breve corr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Usando asyncio para criar drivers de dispositivo ass√≠ncronos no MicroPython v.1.12</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/484472/"> <i>Estudando as possibilidades do <b>MicroPython</b> para seus prop√≥sitos, deparei-me com uma das implementa√ß√µes da biblioteca <b>ass√≠ncrona</b> e, ap√≥s uma breve correspond√™ncia com <b>Piter Hinch</b> , o autor da biblioteca, percebi que precisava entender mais profundamente os princ√≠pios, conceitos b√°sicos e erros t√≠picos do uso de m√©todos de programa√ß√£o ass√≠ncronos.</i>  <i>Al√©m disso, a se√ß√£o para iniciantes √© apenas para mim.</i> <br><br>  Este guia √© destinado a usu√°rios com diferentes n√≠veis de experi√™ncia com <i><b>ass√≠ncio</b></i> , incluindo uma se√ß√£o especial para iniciantes. <br><a name="habracut"></a><br>  <b>Conte√∫do</b> <br>  <b>0. Introdu√ß√£o</b> <br>  0.1 .___ Instalando o <i><b>uasyncio</b></i> em um dispositivo vazio (hardware) <br>  <b>1. Planejando a execu√ß√£o conjunta do programa</b> <br>  1.1 .___ Modules <br>  <b>2. biblioteca <i>uasyncio</i></b> <br>  2.1 .___ Estrutura do programa: ciclo de processamento de eventos <br>  2.2 .___ Corotinas <br>  2.2.1 <i>.______</i> Filas <i>rotativas para participar do planejamento</i> <br>  2.2.2 .______ <i>Iniciando um <i>retorno de chamada de</i> fun√ß√£o ( <i>retorno de chamada</i> )</i> <br>  2.2.3 .______ <i>Notas: corotinas como m√©todos relacionados.</i>  <i>Os valores retornados.</i> <br>  2.3 .___ Atrasos <br>  <b>3. Sincroniza√ß√£o e suas classes</b> <br>  3.1 .___ Bloquear <i><b>Bloquear</b></i> <br>  3.1.1 .______ <i>Bloqueios e tempos limite</i> <br>  3.2 .___ <i><b>Evento</b></i> <br>  3.2.1 .______ <i>Valor do</i> evento <br>  3.3 .___ Barreira <i><b>Barreira</b></i> <br>  3.4 .___ <i><b>Sem√°foro</b></i> <br>  3.4.1 .______ <i>Sem√°foro limitado</i> <br>  3.5 .___ Queue <i><b>Queue</b></i> <br>  3.6 .___ Outras classes de sincroniza√ß√£o <br>  <b>4. Desenvolvimento de classe para <i>ass√≠ncio</i></b> <br>  4.1 .___ Classes usando <i>aguardar</i> <br>  4.1.1 .______ <i>Uso em gerenciadores de contexto</i> <br>  4.1.2 <i>.______ Aguardar na corotina</i> <br>  4.2 .___ Iteradores ass√≠ncronos <br>  4.3 .___ Gerenciadores de contexto ass√≠ncrono <br>  <b>5. Exce√ß√µes a tempos limite e devido a cancelamentos de tarefas</b> <br>  5.1 .___ Exce√ß√µes <br>  5.2 .___ Exce√ß√µes devido a tempos limite e devido ao cancelamento de tarefas <br>  5.2.1 .______ <i>Cancelar tarefas</i> <br>  5.2.2 .______ <i>Corotinas com tempo limite</i> <br>  <b>6. Intera√ß√£o com dispositivos de hardware</b> <br>  6.1 .___ Problemas de sincroniza√ß√£o <br>  6.2 .___ Dispositivos de vota√ß√£o com corotinas <br>  6.3 .___ Usando o mecanismo de streaming <br>  6.3.1 .______ <i>Exemplo de driver UART</i> <br>  6.4 .___ Desenvolvimento de driver para um dispositivo de streaming <br>  6.5 .___ Exemplo completo: <i>aremote.py</i> Driver para receptor de controle remoto IR. <br>  6.6 .___ Driver para sensor de temperatura e umidade HTU21D. <br>  <b>7. Dicas e truques</b> <br>  7.1 .___ O programa congela <br>  7.2 .___ <b><i>uasyncio</i></b> salva estado <br>  7.3 .___ Coleta de lixo <br>  7.4 .___ Testing <br>  7.5 .___ Erro comum.  Pode ser dif√≠cil de encontrar. <br>  7.6 .___ Programa√ß√£o usando soquetes ( <i>soquetes</i> ) <br>  7.6.1 .______ <i>Problemas de WiFi</i> <br>  7.7 .___ Argumentos do construtor de loop de eventos <br>  <b>8. Notas para iniciantes</b> <br>  8.1 .___ Problema 1: loops de eventos <br>  8.2 .___ Problema 2: m√©todos de bloqueio <br>  8.3 .___ A abordagem <b><i>uasyncio</i></b> <br>  8.4 .___ Planejamento no <b><i>uasyncio</i></b> <br>  8.5 .___ Por que agendamento colaborativo, n√£o baseado em <i>encadeamento</i> ( <i>_thread</i> )? <br>  8.6 .___ Intera√ß√£o <br>  8.7 .___ <i>Pesquisa</i> <br><br>  <b>0. Introdu√ß√£o</b> <br><br>  A maior parte deste documento assume alguma familiaridade com a programa√ß√£o ass√≠ncrona.  Para iniciantes, uma introdu√ß√£o pode ser encontrada na se√ß√£o 7. <br><br>  A biblioteca <i><b>uasyncio</b></i> para <b>MicroPython</b> inclui um subconjunto da biblioteca <b>Python</b> <b><i>ass√≠ncrona</i></b> e deve ser usada em microcontroladores.  Como tal, ele ocupa uma pequena quantidade de RAM e est√° configurado para alternar rapidamente contextos com zero de aloca√ß√£o de RAM. <br><br>  Este documento descreve o uso do <i><b>uasyncio</b></i> com √™nfase na cria√ß√£o de drivers para dispositivos de hardware. <br><br>  O objetivo √© projetar os drivers para que o aplicativo continue funcionando enquanto o driver aguarda uma resposta do dispositivo.  Ao mesmo tempo, o aplicativo permanece sens√≠vel a outros eventos e intera√ß√£o do usu√°rio. <br><br>  Outra √°rea importante de aplica√ß√£o do <b><i>ass√≠ncio</i></b> √© a programa√ß√£o em rede: na Internet, voc√™ encontra informa√ß√µes suficientes sobre esse t√≥pico. <br><br>  Observe que o <b>MicroPython √©</b> baseado no <b>Python 3.4</b> com os complementos m√≠nimos do <b>Python 3.5</b> .  Exceto conforme detalhado abaixo, n√£o h√° suporte para fun√ß√µes de vers√µes <b><i>ass√≠ncronas</i></b> anteriores a 3,4.  Este documento define os recursos suportados neste subconjunto. <br><br>  O objetivo deste guia √© apresentar um estilo de programa√ß√£o compat√≠vel com o <b>CPython V3.5</b> e superior. <br><br>  <b>0.1 Instalar o <b><i>uasyncio</i></b> em um dispositivo vazio (hardware)</b> <br><br>  √â recomend√°vel usar o firmware <b>MicroPython V1.11</b> ou posterior.  Em muitas plataformas, a instala√ß√£o n√£o √© necess√°ria, pois o <b><i>uasyncio¬Æ</i></b> j√° <b><i>est√°</i></b> compilado na montagem.  Para verificar, basta digitar REPL <br><br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> uasyncio</code> </pre> <br>  As instru√ß√µes a seguir abrangem casos em que os m√≥dulos n√£o est√£o pr√©-instalados.  As <b><i>filas</i></b> e os m√≥dulos <b><i>sincronizados</i></b> s√£o opcionais, mas s√£o necess√°rios para executar os exemplos fornecidos aqui. <br><br>  <b>Dispositivo conectado √† Internet</b> <br><br>  Em um dispositivo conectado √† Internet e executando o firmware V1.11 ou posterior, √© poss√≠vel instalar usando a vers√£o <i>upip integrada</i> .  Verifique se o dispositivo est√° conectado √† sua rede: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> upip upip.install ( <span class="hljs-string"><span class="hljs-string">'micropython-uasyncio'</span></span> ) upip.install ( <span class="hljs-string"><span class="hljs-string">'micropython-uasyncio.synchro'</span></span> ) upip.install ( <span class="hljs-string"><span class="hljs-string">'micropython-uasyncio.queues'</span></span> )</code> </pre><br>  As mensagens de erro do <i>upip</i> n√£o <i>s√£o</i> muito √∫teis.  Se voc√™ receber um erro incompreens√≠vel, verifique a conex√£o com a Internet novamente. <br><br>  <b>Hardware sem conex√£o √† Internet ( <i>micropip</i> )</b> <br><br>  Se o dispositivo n√£o tiver uma conex√£o com a Internet (por exemplo, <b>Pyboard V1.x</b> ), a maneira mais f√°cil √© iniciar a instala√ß√£o do <i>micropip.py</i> no computador para o diret√≥rio de sua escolha e copiar a estrutura de diret√≥rios resultante para o dispositivo de destino.  O utilit√°rio <i>micropip.py</i> √© executado no <b>Python 3.2</b> ou posterior e no Linux, Windows e OSX.  Mais informa√ß√µes podem ser encontradas <a href="https://github.com/peterhinch/micropython-samples/tree/master/micropip" rel="nofollow">aqui</a> . <br><br>  Chamada t√≠pica: <br><br><pre> <code class="python hljs">$ micropip.py install -p ~/rats micropython-uasyncio $ micropip.py install -p ~/rats micropython-uasyncio.synchro $ micropip.py install -p ~/rats micropython-uasyncio.queues</code> </pre><br>  <b>Um dispositivo sem conex√£o √† Internet (fonte de c√≥pia)</b> <br><br>  Se voc√™ n√£o usar o <i>micropip.py</i> , os arquivos dever√£o ser copiados da fonte.  As instru√ß√µes a seguir descrevem como copiar o n√∫mero m√≠nimo de arquivos no dispositivo de destino, bem como o caso em que o <b><i>uasyncio</i></b> precisa ser compactado em um assembly compilado na forma de bytecode para reduzir o espa√ßo ocupado.  Para a vers√£o mais recente compat√≠vel com o firmware oficial, os arquivos devem ser copiados do site oficial do <a href="http://github.com/micropython/micropython-lib" rel="nofollow">micropython-lib</a> . <br><br>  Clone a biblioteca no computador com o comando <br><br><pre> <code class="python hljs">$ git clone https://github.com/micropython/micropython-lib.git</code> </pre><br>  No dispositivo de destino, crie o diret√≥rio <b><i>uasyncio</i></b> (opcional no diret√≥rio lib) e copie os seguintes arquivos nele: <br><br>  <b>‚Ä¢ uasyncio / uasyncio / __ init__.py</b> <b><br></b>  <b>‚Ä¢ uasyncio.core / uasyncio / core.py</b> <b><br></b>  <b>‚Ä¢ uasyncio.synchro / uasyncio / synchro.py</b> <b><br></b>  <b>‚Ä¢ uasyncio.queues / uasyncio / queues.py</b> <b><br></b> <br><br>  Esses m√≥dulos <b><i>uasyncio</i></b> podem ser compactados no bytecode colocando o diret√≥rio <b><i>uasyncio</i></b> e seu conte√∫do na porta do diret√≥rio <i>modules</i> e recompilando o conte√∫do. <br><br>  <b>1. Planejamento conjunto</b> <br><br>  A t√©cnica de execu√ß√£o conjunta de v√°rias tarefas √© amplamente usada em sistemas embarcados, que oferece menos sobrecarga do que o agendamento de threading ( <b>_thread</b> ), evitando muitas armadilhas associadas a encadeamentos verdadeiramente ass√≠ncronos. <br><br>  <b>1.1 M√≥dulos</b> <br><br>  A seguir, √© apresentada uma lista de m√≥dulos que podem ser executados no dispositivo de destino. <br><br>  <b><u>Bibliotecas</u></b> <br><br>  1. <b><i>asyn.py</i></b> Fornece <i><b>Bloqueio, Evento, Barreira, Sem√°foro, BoundedSemaphore, Condi√ß√£o, coletar</b></i> primitivas de sincroniza√ß√£o.  Fornece suporte para o cancelamento de tarefas por meio das classes <i><b>NamedTask</b></i> e <i><b>Cancellable</b></i> . <br><br>  2. <b><i>aswitch.py</i></b> Representa classes para emparelhar interruptores e bot√µes, bem como um objeto de programa com a possibilidade de atraso repetido.  Os bot√µes s√£o uma generaliza√ß√£o de switches que fornecem um estado l√≥gico e n√£o f√≠sico, al√©m de eventos acionados por um toque duplo e longo. <br><br>  <b>Programas de demonstra√ß√£o</b> <br><br>  Os dois primeiros s√£o mais √∫teis, pois fornecem resultados vis√≠veis ao acessar o <b>hardware</b> do <b>Pyboard</b> . <br><br><ol><li>  <b><i>aledflash.py</i></b> Pisca quatro indicadores do <b>Pyboard de</b> forma ass√≠ncrona por 10 segundos.  A demonstra√ß√£o mais simples de <b>uasyncio</b> .  Importe-o para executar. </li><li>  <b><i>apoll.py</i></b> Driver de <b><i>dispositivo</i></b> para o aceler√¥metro <b>Pyboard</b> .  Demonstra o uso de corotinas para consultar um dispositivo.  Trabalha por 20 s.  Importe-o para executar.  Requer <b>Pyboard V1.x.</b> </li><li>  <b><i>astests.py Programas de</i></b> teste / demonstra√ß√£o para o m√≥dulo <b><i>aswitch</i></b> . </li><li>  <b><i>asyn_demos.py</i></b> Demonstra√ß√µes simples de cancelamento de tarefas. </li><li>  <b><i>roundrobin.py</i></b> Demonstra√ß√£o de planejamento circular.  Tamb√©m a refer√™ncia para o planejamento de desempenho. </li><li>  <b><i>waititable.py</i></b> Demonstra√ß√£o de uma classe com uma espera.  Uma maneira de implementar um driver de dispositivo que pesquisa uma interface. </li><li>  <b><i>chain.py</i></b> Copiado da documenta√ß√£o do <b>Python</b> .  Demonstra√ß√£o da cadeia de corotina. </li><li>  <b><i>aqtest.py</i></b> Demonstra√ß√£o da classe <b><i>Queue</i></b> da biblioteca <i><b>uasyncio</b></i> . </li><li>  <b><i>aremote.py</i></b> Exemplo de driver de dispositivo para o protocolo NEC IR. </li><li>  <b><i>auart.py</i></b> Demonstra√ß√£o do fluxo de entrada e sa√≠da atrav√©s do <b>Pyboard UART</b> . </li><li>  <b><i>auart_hd.py</i></b> Usando o <b>Pyboard UART</b> para se comunicar com um dispositivo usando o protocolo half-duplex.  Adequado para dispositivos, por exemplo, usando o conjunto de comandos do modem AT. </li><li>  <b><i>iorw.py</i></b> Demonstra√ß√£o de um dispositivo leitor / gravador usando E / S de streaming. </li></ol><br>  <b>Programas de teste</b> <br><br><ol><li>  <b><i>asyntest.py</i></b> Testa classes de sincroniza√ß√£o em <b><i>asyn.py.</i></b> </li><li>  testes de cancelamento de trabalho. </li></ol><br>  <b>Utilit√°rio</b> <br><br>  1. <b><i>check_async_code.py</i></b> O utilit√°rio foi escrito em <b>Python3</b> para detectar erros de codifica√ß√£o espec√≠ficos que podem ser dif√≠ceis de encontrar.  Veja a se√ß√£o 7.5. <br><br>  <b>Controlar</b> <br><br>  O diret√≥rio <a href="" rel="nofollow"><i>benchmarks</i></a> cont√©m scripts para verificar e caracterizar o <i><b>planejador uasyncio</b></i> . <br><br><cut></cut><br>  <b>2. biblioteca <i>uasyncio</i></b> <br><br>  O conceito de <i>ass√≠ncio</i> baseia-se na organiza√ß√£o do planejamento para a execu√ß√£o conjunta de v√°rias tarefas, que neste documento s√£o denominadas <b>corotinas</b> . <br><br>  <b>2.1 Estrutura do programa: loop de eventos</b> <br><br>  Considere o seguinte exemplo: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> uasyncio <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> asyncio <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bar</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> count = <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> : count + = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> ( count ) <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep ( <span class="hljs-number"><span class="hljs-number">1</span></span> ) <span class="hljs-comment"><span class="hljs-comment">#  1 loop = asyncio.get_event_loop () loop.create_task ( bar ()) #     loop.run_forever ()</span></span></code> </pre><br>  A execu√ß√£o do programa continua at√© que <i>loop.run_forever seja chamado</i> .  Neste ponto, a execu√ß√£o √© controlada pelo planejador.  A linha ap√≥s <i>loop.run_forever</i> nunca ser√° executada.  O planejador executa o c√≥digo de <i>barras</i> porque foi colocado na fila no <i>planejador loop.create_task</i> .  Neste exemplo trivial, h√° apenas uma <i>barra de</i> rotina.  Se houvesse outros, o agendador os executaria durante os per√≠odos em que a <i>barra</i> estivesse em pausa. <br><br>  A maioria dos aplicativos incorporados possui um loop de eventos cont√≠nuo.  Um loop de eventos tamb√©m pode ser iniciado de uma maneira que permita a conclus√£o usando o m√©todo do loop de eventos <i>run_until_complete</i> ;  √â usado principalmente em testes.  Exemplos podem ser encontrados no m√≥dulo <a href="https://github.com/peterhinch/micropython-async/blob/master/astests.py" rel="nofollow"><b><i>astests.py</i></b></a> . <br><br>  Uma inst√¢ncia de loop de eventos √© um √∫nico objeto criado pela primeira chamada para <i>asyncio.get_event_loop ()</i> com dois argumentos inteiros opcionais que indicam o n√∫mero de corotinas nas duas filas - o in√≠cio e a espera.  Normalmente, os dois argumentos ter√£o o mesmo valor, igual a pelo menos o n√∫mero de corotinas executadas simultaneamente no aplicativo.  Geralmente, o valor padr√£o de 16 √© suficiente.Se valores n√£o padr√£o forem usados, consulte Argumentos do construtor de loop de eventos (se√ß√£o 7.7.) <br><br>  Se a corotina precisar chamar o m√©todo do loop de eventos (geralmente <i>create_task</i> ), chamar <i>asyncio.get_event_loop ()</i> (sem argumentos) retornar√° efetivamente. <br><br>  <b>2.2 Corotinas</b> <br><br>  Uma rotina √© criada da seguinte maneira: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( delay_secs )</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep ( delay_secs ) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> ( <span class="hljs-string"><span class="hljs-string">'Hello'</span></span> )</code> </pre><br>  Uma corotina pode permitir que outras corotinas sejam lan√ßadas usando a instru√ß√£o de <i>espera</i> .  Uma corotina deve conter pelo menos uma instru√ß√£o de <i>espera</i> .  Isso faz com que a corotina seja executada antes da conclus√£o, antes da execu√ß√£o prosseguir para a pr√≥xima instru√ß√£o.  Considere um exemplo: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep ( delay_secs ) <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep ( <span class="hljs-number"><span class="hljs-number">0</span></span> )</code> </pre><br>  A primeira linha faz com que o c√≥digo seja pausado por um tempo de atraso, enquanto outras corotinas usam esse tempo para sua execu√ß√£o.  Um atraso de 0 faz com que todas as rotinas em execu√ß√£o sejam executadas em uma ordem c√≠clica at√© a pr√≥xima linha ser executada.  Veja o exemplo de <i><b>roundrobin.py</b></i> . <br><br>  <b>2.2.1</b>  <b>Fila para planejar uma rotina</b> <br><br><ul><li>  <i>EventLoop.create_task</i> Argumento: Coroutine para executar.  O planejador enfileira a corotina para iniciar o mais r√°pido poss√≠vel.  A chamada <i>create_task</i> retorna imediatamente.  A corotina no argumento √© especificada usando a sintaxe da chamada de fun√ß√£o com os argumentos necess√°rios. </li><li>  <i>EventLoop.run_until_complete</i> Argumento: Coroutine para executar.  O planejador enfileira a corotina para iniciar o mais r√°pido poss√≠vel.  A corotina no argumento √© especificada usando a sintaxe da chamada de fun√ß√£o com os argumentos necess√°rios.  A chamada <i>un_until_complete</i> retorna quando a corotina √© conclu√≠da: esse m√©todo fornece uma maneira de sair do planejador. </li><li>  <i>aguardar</i> Argumento: Uma rotina a ser executada, especificada usando a sintaxe da chamada de fun√ß√£o.  Inicia uma corrotina o mais r√°pido poss√≠vel.  A corotina pendente √© bloqueada at√© que uma das corotinas esperadas seja conclu√≠da. </li></ul><br>  O acima √© compat√≠vel com <b>CPython</b> .  M√©todos adicionais de <b><i>uasyncio s√£o</i></b> discutidos nas Notas (Se√ß√£o 2.2.3.). <br><br>  <b>2.2.2 Iniciando a fun√ß√£o de retorno de chamada</b> <br><br>  Os retornos de chamada devem ser fun√ß√µes <b>Python</b> projetadas para serem executadas em um curto per√≠odo de tempo.  Isso se deve ao fato de as corotinas n√£o conseguirem trabalhar durante toda a dura√ß√£o da execu√ß√£o dessa fun√ß√£o. <br><br>  Os seguintes <b><i>m√©todos da</i></b> classe <b><i>EventLoop</i></b> usam retornos de chamada: <br><br><ol><li>  <i>call_soon</i> - ligue o mais r√°pido poss√≠vel.  Args: <i>retorno de</i> chamada <i>retorno de</i> chamada a executar, <i>* args</i> quaisquer argumentos posicionais podem ser seguidos por v√≠rgula. </li><li>  <i>call_later</i> - chama ap√≥s um atraso em segundos.  Args: <i>atraso, retorno de chamada, * args</i> </li><li>  <i>call_later_ms</i> - liga ap√≥s um atraso em ms.  Args: <i>atraso, retorno de chamada, * args</i> . </li></ol><br><pre> <code class="python hljs">loop = asyncio.get_event_loop () loop.call_soon ( foo , <span class="hljs-number"><span class="hljs-number">5</span></span> ) <span class="hljs-comment"><span class="hljs-comment">#    'foo'      5. loop.call_later ( 2 , foo , 5 ) #   2 . loop.call_later_ms ( 50 , foo , 5 ) #   50 . loop.run_forever ()</span></span></code> </pre><br>  <b>2.2.3 Notas</b> <br><br>  Uma corotina pode conter uma declara√ß√£o de <i>retorno</i> com valores de retorno arbitr√°rios.  Para obter esse valor: <br><br><pre> <code class="python hljs">result = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> my_coro ()</code> </pre><br>  Uma corotina pode ser limitada por m√©todos e deve conter pelo menos uma instru√ß√£o de <i>espera</i> . <br><br>  <b>2.3 Atrasos</b> <br><br>  Existem duas op√ß√µes para organizar atrasos nas corotinas.  Para atrasos mais longos e nos casos em que a dura√ß√£o n√£o precisa ser precisa, voc√™ pode usar: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( delay_secs , delay_ms )</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep ( delay_secs ) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> ( <span class="hljs-string"><span class="hljs-string">'Hello'</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep_ms ( delay_ms )</code> </pre><br>  Durante esses atrasos, o planejador executar√° outras corotinas.  Isso pode introduzir incerteza de tempo, uma vez que a rotina de chamada somente ser√° iniciada quando a que estiver em execu√ß√£o no momento for executada.  A quantidade de atraso depende do desenvolvedor do aplicativo, mas provavelmente ser√° da ordem de dezenas ou centenas de ms;  isso √© discutido mais adiante na intera√ß√£o com dispositivos de hardware (se√ß√£o 6). <br><br>  Atrasos muito precisos podem ser executados usando as fun√ß√µes <i>utime</i> - <i>sleep_ms</i> e <i>sleep_us</i> .  Eles s√£o mais adequados para pequenos atrasos, pois o agendador n√£o poder√° executar outras corotinas enquanto o atraso estiver em andamento. <br><br>  <b>3.Sync</b> <br><br>  Freq√ºentemente, √© necess√°rio garantir a sincroniza√ß√£o entre corotinas.  Um exemplo comum √© evitar as chamadas "condi√ß√µes de corrida" quando v√°rias corotinas requerem simultaneamente acesso ao mesmo recurso.  Um exemplo √© fornecido em <b><i>astests.py</i></b> e √© discutido na <a href="" rel="nofollow">documenta√ß√£o</a> .  Outro perigo √© o "abra√ßo da morte", quando cada corotina aguarda a conclus√£o da outra. <br><br>  Em aplicativos simples, a sincroniza√ß√£o pode ser alcan√ßada usando sinalizadores globais ou vari√°veis ‚Äã‚Äãrelacionadas.  Uma abordagem mais elegante √© usar classes de sincroniza√ß√£o.  O m√≥dulo <b><i>asyn.py</i></b> oferece implementa√ß√µes ‚Äúmicro‚Äù das classes <i><b>Event, Barrier, Semaphore</b></i> e <i><b>Conditios</b></i> , destinadas a serem usadas apenas com <b><i>asyncio</i></b> .  Eles n√£o s√£o orientados a encadeamentos e n√£o devem ser usados ‚Äã‚Äãcom o m√≥dulo <b><i>_thread</i></b> ou com o manipulador de interrup√ß√µes, a menos que especificado de outra forma.  A classe <i><b>Lock</b></i> tamb√©m √© implementada, o que √© uma alternativa √† implementa√ß√£o oficial. <br><br>  Outro problema de sincroniza√ß√£o surge com os produtores e consumidores de corotina.  Um produtor de corotina gera dados que um consumidor de corotina usa.  Para fazer isso, o <b><i>asyncio</i></b> fornece a classe <i><b>Queue</b></i> .  O produtor de corotina coloca os dados na fila, enquanto o consumidor de corotina est√° aguardando sua conclus√£o (com outras opera√ß√µes agendadas no prazo).  A classe <i><b>Queue</b></i> fornece garantias para remover itens na ordem em que foram recebidos.  Como alternativa, voc√™ pode usar a classe <i><b>Barrier</b></i> se a corotina produtora precisar esperar at√© que a corotina consumidora esteja pronta para acessar os dados. <br><br>  Uma breve vis√£o geral das aulas √© dada abaixo.  Mais detalhes na <a href="" rel="nofollow">documenta√ß√£o completa</a> . <br><br>  <b>3.1 <a href="" rel="nofollow"><i>Bloqueio</i></a></b> <br><br>  <i><b>O bloqueio</b></i> garante acesso exclusivo a um recurso compartilhado.  O exemplo de c√≥digo a seguir cria uma inst√¢ncia da classe <b><i>Lock</i></b> que √© passada a todos os clientes que desejam acessar o recurso compartilhado.  Cada corotina tenta capturar o bloqueio, interrompendo a execu√ß√£o at√© que seja bem-sucedido: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> uasyncio <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> asyncio <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> uasyncio.synchro <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Lock <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">task</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(i, lock)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> lock.acquire() print(<span class="hljs-string"><span class="hljs-string">"Acquired lock in task"</span></span>, i) <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep(<span class="hljs-number"><span class="hljs-number">0.5</span></span>) lock.release() <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">killer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep(<span class="hljs-number"><span class="hljs-number">10</span></span>) loop = asyncio.get_event_loop() lock = Lock() <span class="hljs-comment"><span class="hljs-comment"># The global Lock instance loop.create_task(task(1, lock)) loop.create_task(task(2, lock)) loop.create_task(task(3, lock)) loop.run_until_complete(killer()) #  10s</span></span></code> </pre><br>  <b>3.1.1. Bloqueio e tempos limite</b> <br><br>  No momento da reda√ß√£o deste artigo (5 de janeiro de 2018), o desenvolvimento da classe <i><b>uasycio</b></i> <i>Lock</i> ainda n√£o estava oficialmente conclu√≠do.  Se a corotina tiver um <u>tempo limite (se√ß√£o 5.2.2.)</u> , Ao aguardar um bloqueio quando acionado, o tempo limite ser√° ineficaz.  Ele n√£o receber√° um <i>TimeoutError</i> at√© receber um bloqueio.  O mesmo se aplica ao cancelamento de uma tarefa. <br><br>  O m√≥dulo <b><i>asyn.py</i></b> oferece a classe <a href="" rel="nofollow"><b><i>Lock</i></b></a> , que funciona nessas situa√ß√µes.  Essa implementa√ß√£o da classe √© menos eficiente que a classe oficial, mas suporta interfaces adicionais de acordo com a vers√£o do <b>CPython</b> , incluindo o uso do gerenciador de contexto. <br><br>  <b>3.2 Evento</b> <br><br>  <b><i>O evento</i></b> cria uma oportunidade para uma ou v√°rias corotinas pausarem, enquanto outra d√° um sinal sobre sua continua√ß√£o.  Uma inst√¢ncia de <b>Event</b> fica dispon√≠vel para todas as corotinas que o utilizam: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> asyn event = asyn.Event ()</code> </pre><br>  Uma corotina aguarda um evento declarando um <i>evento de espera</i> , ap√≥s o qual a execu√ß√£o pausa at√© que outras corotinas declarem <i>event.set ()</i> .  <a href="" rel="nofollow">Informa√ß√£o completa</a> . <br><br>  Um problema pode surgir se <i>event.set ()</i> for emitido em uma constru√ß√£o em loop;  o c√≥digo deve aguardar at√© que todos os objetos pendentes tenham acesso ao evento antes de configur√°-lo novamente.  No caso em que um <b>coro</b> espera um evento, isso pode ser alcan√ßado ao receber um evento <b>coro</b> limpando o evento: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">eventwait</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( event )</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> event event.clear()</code> </pre><br>  A corrotina que aciona o evento verifica se ele foi atendido: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( event )</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> : <span class="hljs-comment"><span class="hljs-comment">#   - while event.is_set (): await asyncio.sleep ( 1 ) # ,  coro   event.set ()</span></span></code> </pre><br>  No caso de v√°rios <b>coros</b> aguardarem a sincroniza√ß√£o de um evento, o problema pode ser resolvido usando o evento de confirma√ß√£o.  Cada <b>coro</b> precisa de um evento separado. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">eventwait</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(  , ack_event )</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> event ack_event.set ()</code> </pre><br>  Um exemplo disso √© fornecido na fun√ß√£o <i><b>event_test</b></i> em <i><b>asyntest.py</b></i> .  Isso √© complicado Na maioria dos casos - mesmo com um <b>coro em</b> espera - a classe <b>Barreira</b> , apresentada abaixo, oferece uma abordagem mais simples. <br>  Um evento tamb√©m pode fornecer um meio de comunica√ß√£o entre o manipulador de interrup√ß√µes e o <b>coro</b> .  O manipulador mant√©m o hardware e define o evento, que √© verificado pelo <b>coro</b> j√° no modo normal. <br><br>  <b>3.2.1 Valores do evento</b> <br><br>  O m√©todo <i>event.set ()</i> pode <i>usar</i> um valor de dados opcional de qualquer tipo.  <b>Coro</b> , aguardando um evento, pode obt√™-lo com <i>event.value ()</i> .  Observe que <i>event.clear ()</i> ser√° definido como <i>None</i> .  Um uso t√≠pico disso para a configura√ß√£o de <i>coro</i> do evento √© emitir <i>event.set (utime.ticks_ms ())</i> .  Qualquer <b>coro que</b> aguarde um evento pode determinar o atraso que ocorreu, por exemplo, para compensar isso. <br><br>  <b>3.3 <a href="" rel="nofollow"><i>Barreira</i></a></b> <br><br>  Existem dois usos para a classe <b><i>Barreira</i></b> . <br><br>  Primeiro, ele pode suspender uma corotina at√© que uma ou v√°rias outras corotinas sejam conclu√≠das. <br><br>  Em segundo lugar, permite que v√°rias corotinas se encontrem em um determinado ponto.  Por exemplo, um produtor e um consumidor podem sincronizar no ponto em que o produtor possui dados e o consumidor est√° pronto para us√°-los.  No momento da execu√ß√£o, a <b>Barreira</b> pode emitir um retorno de chamada adicional antes que a barreira seja removida e todos os eventos pendentes possam continuar. <br><br>  O retorno de chamada pode ser uma fun√ß√£o ou uma rotina.  Na maioria das aplica√ß√µes, a fun√ß√£o provavelmente ser√° usada: pode ser garantida a execu√ß√£o antes da conclus√£o, antes da remo√ß√£o da barreira. <br><br>  Um exemplo √© a fun√ß√£o <i><b>barreira_teste</b></i> em <i><b>asyntest.py</b></i> .  No trecho de c√≥digo deste programa: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> asyn <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">callback</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(text)</span></span></span><span class="hljs-function">:</span></span> print(text) barrier = asyn.Barrier(<span class="hljs-number"><span class="hljs-number">3</span></span>, callback, (<span class="hljs-string"><span class="hljs-string">'Synch'</span></span>,)) <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">report</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">5</span></span>): print(<span class="hljs-string"><span class="hljs-string">'{} '</span></span>.format(i), end=<span class="hljs-string"><span class="hljs-string">''</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> barrier</code> </pre> <br>  v√°rias inst√¢ncias da rotina do <i>relat√≥rio</i> imprimem seus resultados e pausam at√© que outras inst√¢ncias tamb√©m estejam conclu√≠das e aguardam a <b>barreira</b> continuar.  Neste ponto, um retorno de chamada est√° sendo feito.  Ap√≥s a conclus√£o, a rotina original √© retomada. <br><br>  <b>3.4 Sem√°foro</b> <br><br>  O sem√°foro limita o n√∫mero de corotinas que podem acessar o recurso.  Pode ser usado para limitar o n√∫mero de inst√¢ncias de uma determinada rotina que pode ser executada simultaneamente.  Isso √© feito usando um contador de acesso, que √© inicializado pelo construtor e reduzido a cada vez que a corotina recebe um sem√°foro. <br><br>  A maneira mais f√°cil de us√°-lo em um gerenciador de contexto: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> asyn sema = asyn.Semaphore(<span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(sema)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> sema: <span class="hljs-comment"><span class="hljs-comment">#   </span></span></code> </pre><br>  Um exemplo √© a fun√ß√£o <i>semaphore_test</i> em <i><b>asyntest.py</b></i> . <br><br>  <b>3.4.1 Sem√°foro ( <a href="" rel="nofollow"><i>limitado</i></a> )</b> <br><br>  Funciona de maneira semelhante √† classe <i><b>Semaphore,</b></i> exceto que, se o m√©todo de <i>libera√ß√£o</i> fizer com que o contador de acesso exceda seu valor inicial, um <i>ValueError ser√°</i> definido. <br><br>  <b>3.5 Fila</b> <br><br>  A classe <i><b>Queue</b></i> √© mantida pelo <i><b>uasycio</b></i> oficial e o programa de amostra <i><b>aqtest.py</b></i> demonstra seu uso.  A fila √© criada da seguinte maneira: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> uasyncio.queues <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Queue q = Queue ()</code> </pre><br>  Uma corotina t√≠pica do fabricante pode funcionar da seguinte maneira: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">producer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(q)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: result = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> slow_process() <span class="hljs-comment"><span class="hljs-comment">#       await q.put(result) #  ,       </span></span></code> </pre><br>  e a rotina do consumidor pode funcionar da seguinte maneira: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">consumer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(q)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: result = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span>(q.get()) <span class="hljs-comment"><span class="hljs-comment"># ,  q  print('Result was {}'.format(result))</span></span></code> </pre><br>  A classe <i><b>Queue</b></i> fornece funcionalidade adicional significativa quando o tamanho das filas pode ser limitado e o status pode ser pesquisado.  O comportamento com uma fila vazia (se o tamanho for limitado) e o comportamento com uma fila cheia podem ser controlados.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A documenta√ß√£o sobre isso est√° no c√≥digo. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.6 Outras classes de sincroniza√ß√£o</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> A biblioteca </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">asyn.py</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> fornece uma micro implementa√ß√£o de alguns dos outros recursos do </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CPython</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A classe </font></font><a href="" rel="nofollow"><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Condi√ß√£o</font></font></i></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> permite que uma corotina notifique outras corotinas que aguardam um recurso bloqueado. Ap√≥s receber a notifica√ß√£o, eles ter√£o acesso ao recurso e ser√£o desbloqueados por vez. Uma corotina de notifica√ß√£o pode limitar o n√∫mero de corotinas a serem notificadas. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A classe </font></font><a href="" rel="nofollow"><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gather</font></font></i></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> permite executar uma lista de corotinas. Ap√≥s a conclus√£o deste √∫ltimo, uma lista de resultados ser√° retornada. Essa implementa√ß√£o "micro" usa uma sintaxe diferente. Os tempos limites podem ser aplicados a qualquer uma das corotinas.</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4 Desenvolvendo classes para </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ass√≠ncio</font></font></i></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> No contexto do desenvolvimento de drivers de dispositivo, o objetivo √© garantir que eles funcionem sem bloqueio. Um driver de corotina deve garantir que outras corotinas sejam executadas enquanto o driver aguarda o dispositivo executar opera√ß√µes de hardware. Por exemplo, uma tarefa aguardando a chegada de dados no UART ou um usu√°rio pressionando um bot√£o deve permitir que outros eventos sejam agendados at√© que o evento ocorra. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4.1 Classes usando </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aguardar</font></font></i></b> <font style="vertical-align: inherit;"><b><font style="vertical-align: inherit;"> espera Uma </font></b><b><i><font style="vertical-align: inherit;">corotina</font></i></b></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pode pausar a execu√ß√£o enquanto aguarda um objeto </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aguard√°vel</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . No </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CPython, uma</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> classe </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aguard√°vel</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> personalizada </font><font style="vertical-align: inherit;">√© criada implementando o m√©todo </font><i><font style="vertical-align: inherit;">__await__</font></i><font style="vertical-align: inherit;"> especial</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qual o gerador retorna. </font><font style="vertical-align: inherit;">A classe </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aguard√°vel √©</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> usada da seguinte maneira:</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> uasyncio <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> asyncio <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Foo</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">()</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__await__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> n <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">5</span></span>): print(<span class="hljs-string"><span class="hljs-string">'__await__ called'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> asyncio.sleep(<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-comment"><span class="hljs-comment">#     return 42 __iter__ = __await__ # .   async def bar(): foo = Foo() # Foo - awaitable  print('waiting for foo') res = await foo #   print('done', res) loop = asyncio.get_event_loop() loop.run_until_complete(bar())</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Atualmente </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MicroPython</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> n√£o suporta </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__await__</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font></font><a href="http://github.com/micropython/micropython/issues/2678" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">edi√ß√£o # 2678</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) e para a solu√ß√£o a ser utilizada </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__iter__</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">A cadeia </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__iter__ = __await__</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> fornece portabilidade entre </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CPython</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MicroPython</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">exemplos de c√≥digo, consulte as classes </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">de evento, barreira, cancel√°veis, a condi√ß√£o</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> em </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">asyn.py</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4.1.1 Uso em gerenciadores de contexto</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Objetos esperados podem ser usados ‚Äã‚Äãem gerenciadores de contexto s√≠ncronos ou ass√≠ncronos, fornecendo os m√©todos especiais necess√°rios. </font><font style="vertical-align: inherit;">Sintaxe:</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> awaitable <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> a: <span class="hljs-comment"><span class="hljs-comment">#  'as'   #    async with awaitable as a: #    (.) #  -</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para conseguir isso, o </font><font style="vertical-align: inherit;">gerador </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__await__</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> deve retornar </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">self</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . √â transmitida em qualquer vari√°vel </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">como</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> a senten√ßa e permite t√©cnicas especiais. Consulte </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">asyn.Condition</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">asyntest.condition_test</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> onde a classe </font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Condition</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> usa </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aguardam</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e podem ser usados ‚Äã‚Äãem um gerenciador de contexto s√≠ncrono. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4.1.2 coroutine Await em</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> linguagem </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Python</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> requer </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__await__</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> era a fun√ß√£o do gerador. No </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MicroPython, os</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> geradores e as rotinas s√£o id√™nticos; portanto, a solu√ß√£o √© usar o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rendimento do coro (args)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O objetivo deste guia √© oferecer c√≥digo port√°vel para o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CPython 3.5</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou posterior. No </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CPython,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> geradores e corotinas s√£o diferentes em significado. No </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CPython, uma</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> corotina possui um </font><font style="vertical-align: inherit;">m√©todo especial </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__await__</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que o gerador recupera. Isso √© port√°til:</font></font><br><br><pre> <code class="python hljs">up = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-comment"><span class="hljs-comment">#   MicroPython? try: import uasyncio as asyncio up = True #    sys.implementation.name except ImportError: import asyncio async def times_two(n): # Coro   await asyncio.sleep(1) return 2 * n class Foo(): def __await__(self): res = 1 for n in range(5): print('__await__ called') if up: # MicroPython res = yield from times_two(res) else: # CPython res = yield from times_two(res).__await__() return res __iter__ = __await__ async def bar(): foo = Foo() # foo is awaitable print('waiting for foo') res = await foo #   print('done', res) loop = asyncio.get_event_loop() loop.run_until_complete(bar())</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Observe que </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__await__, yield de asyncio.sleep (1) √©</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> permitido pelo </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CPython</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Ainda n√£o entendo como isso √© alcan√ßado. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4.2 Iteradores</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ass√≠ncronos </font><b><font style="vertical-align: inherit;">Os iteradores</font></b><font style="vertical-align: inherit;"> ass√≠ncronos fornecem um meio de retornar uma sequ√™ncia finita ou infinita de valores e podem ser usados ‚Äã‚Äãcomo um meio de recuperar elementos de dados sequenciais quando eles v√™m de um dispositivo somente leitura. </font><font style="vertical-align: inherit;">Um iterador ass√≠ncrono chama c√≥digo ass√≠ncrono em seu </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pr√≥ximo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> m√©todo </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">A classe deve atender aos seguintes requisitos:</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Possui um m√©todo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__aiter__</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> definido em </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">def ass√≠ncrono</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e retornando um iterador ass√≠ncrono.</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Possui um m√©todo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__anext__</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que por si s√≥ √© uma corrotina - isto √©, definido via </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">async def</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e contendo pelo menos uma instru√ß√£o de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">espera</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Para parar a itera√ß√£o, ele deve gerar uma </font><font style="vertical-align: inherit;">exce√ß√£o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">StopAsyncIteration</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Os valores de s√©rie s√£o recuperados usando </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ass√≠ncrono,</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> conforme mostrado abaixo:</font></font><br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AsyncIterable</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self.data = (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>) self.index = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__aiter__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__anext__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> data = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> self.fetch_data() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> data: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> data <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> StopAsyncIteration <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fetch_data</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep(<span class="hljs-number"><span class="hljs-number">0.1</span></span>) <span class="hljs-comment"><span class="hljs-comment">#     if self.index &gt;= len(self.data): return None x = self.data[self.index] self.index += 1 return x async def run(): ai = AsyncIterable() async for x in ai: print(x)</span></span></code> </pre><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4.3 Gerenciadores de contexto ass√≠ncronos</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> As classes podem ser projetadas para oferecer suporte a gerenciadores de contexto ass√≠ncronos que possuem procedimentos de entrada e sa√≠da que s√£o co-programas. Um exemplo √© a classe de </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bloqueio</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> descrita acima. Possui a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rotina</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> __aenter__ </font><font style="vertical-align: inherit;">, necess√°ria logicamente para a opera√ß√£o ass√≠ncrona. Para oferecer suporte ao protocolo ass√≠ncrono do gerenciador de contexto, seu </font><font style="vertical-align: inherit;">m√©todo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__aexit__</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tamb√©m deve ser uma corotina, o que √© alcan√ßado ao incluir </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">waitit asyncio.sleep (0)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Essas classes s√£o acess√≠veis a partir de uma rotina com a seguinte sintaxe:</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bar</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( lock )</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> lock: <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> ( ¬´ bar ¬ª )</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como √© o caso dos gerenciadores de contexto regulares, √© garantido que o m√©todo de sa√≠da seja chamado quando o gerenciador de contexto concluir seu trabalho, como de costume, e por meio de uma exce√ß√£o. Para atingir esse objetivo, os m√©todos especiais </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__aenter__</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__aexit__</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> s√£o </font><i><font style="vertical-align: inherit;">usados ‚Äã‚Äãe</font></i><font style="vertical-align: inherit;"> devem ser definidos como corotinas que aguardam outra corotina ou </font><font style="vertical-align: inherit;">objeto </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aguard√°vel</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Este exemplo √© retirado da classe </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lock</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br><br><pre> <code class="python hljs"> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__aenter__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> self.acquire() <span class="hljs-comment"><span class="hljs-comment"># a coro    async def return self async def __aexit__(self, *args): self.release() #   await asyncio.sleep_ms(0)</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ass√≠ncrona com</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cont√©m a proposta </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">como com a vari√°vel</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , a vari√°vel √© atribu√≠do o valor retornado pelo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__aenter__</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para garantir o comportamento correto, o firmware deve ser V1.9.10 ou posterior. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5. Exce√ß√µes a tempos limite e devido ao cancelamento de tarefas</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Estes t√≥picos est√£o relacionados: o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> inclui cancelar tarefas e aplicar um tempo limite a uma tarefa, lan√ßando uma exce√ß√£o para a tarefa de uma maneira especial. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5.1 Exce√ß√µes</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se ocorrer uma exce√ß√£o em uma corotina, ela deve ser processada nessa corotina ou em uma corotina aguardando sua conclus√£o. Isso garante que a exce√ß√£o n√£o se aplique ao planejador. Se ocorrer uma exce√ß√£o, o planejador interromper√° o trabalho passando a exce√ß√£o para o c√≥digo iniciado pelo planejador. Portanto, para evitar que o planejador pare, a corotina iniciada com </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">loop.create_task ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> deve capturar quaisquer exce√ß√µes dentro. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Usar </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">throw</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">close</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para </font><i><font style="vertical-align: inherit;">lan√ßar uma</font></i><font style="vertical-align: inherit;"> exce√ß√£o em uma rotina √© irracional. Isso destr√≥i o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , fazendo com que a corotina inicie e possivelmente </font><b><font style="vertical-align: inherit;">saia</font></b><font style="vertical-align: inherit;"> quando ainda est√° na fila de execu√ß√£o.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O exemplo acima ilustra essa situa√ß√£o. Se permitido trabalhar at√© o fim, funcionar√° conforme o esperado.</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> uasyncio <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> asyncio <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep(<span class="hljs-number"><span class="hljs-number">3</span></span>) print(<span class="hljs-string"><span class="hljs-string">'About to throw exception.'</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bar</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> foo() <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> ZeroDivisionError: print(<span class="hljs-string"><span class="hljs-string">'foo  -   0'</span></span>) <span class="hljs-comment"><span class="hljs-comment"># ! raise #     . except KeyboardInterrupt: print('foo was interrupted by ctrl-c') #   ! raise async def shutdown(): print('Shutdown is running.') #     await asyncio.sleep(1) print('done') loop = asyncio.get_event_loop() try: loop.run_until_complete(bar()) except ZeroDivisionError: loop.run_until_complete(shutdown()) except KeyboardInterrupt: print('Keyboard interrupt at loop level.') loop.run_until_complete(shutdown())</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No entanto, emitir uma interrup√ß√£o do teclado faz com que a exce√ß√£o entre no loop de eventos. Isso ocorre porque a execu√ß√£o do </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio.sleep</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© passada para o loop de eventos. Portanto, os aplicativos que exigem um c√≥digo claro em resposta a uma interrup√ß√£o do teclado devem capturar uma exce√ß√£o no n√≠vel do loop de eventos. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5.2 Cancelamento e tempos limite</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Como mencionado acima, essas fun√ß√µes funcionam </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lan√ßando uma</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> exce√ß√£o para a tarefa de uma maneira especial usando o m√©todo especial </font><b><font style="vertical-align: inherit;">MicroPython</font></b><font style="vertical-align: inherit;"> coroutine </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pend_throw</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Como funciona depende da vers√£o. No </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> oficial </font><b><font style="vertical-align: inherit;">v.2.0, uma</font></b><font style="vertical-align: inherit;"> exce√ß√£o n√£o √© processada at√© a pr√≥xima tarefa agendada. Isso imp√µe um atraso se a tarefa espera </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dormir</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">entrada-sa√≠da </font><font style="vertical-align: inherit;">Os tempos limite podem ir al√©m do per√≠odo nominal. </font><font style="vertical-align: inherit;">A tarefa de desfazer de outras tarefas n√£o pode determinar quando o desfazer √© conclu√≠do. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Atualmente, h√° uma solu√ß√£o alternativa e duas solu√ß√µes.</font></font><br><br><ul><li><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Solu√ß√£o alternativa</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : a biblioteca </font><b><font style="vertical-align: inherit;">ass√≠ncrona</font></b><font style="vertical-align: inherit;"> fornece um meio de aguardar o cancelamento de tarefas ou grupos de tarefas. </font><font style="vertical-align: inherit;">Consulte Cancelar um trabalho (se√ß√£o 5.2.1.).</font></font></li><li> <a href="http://github.com/pfalcon/pycopy-lib" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A biblioteca Paul Sokolovsky</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> fornece o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio v2.4</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , mas isso requer seu firmware </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pycopy</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li><li> <a href="" rel="nofollow"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fast_io</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> biblioteca</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> resolve este problema</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> no Python</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (menos forma elegante) e rodando firmware oficial.</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A hierarquia de exce√ß√µes usada aqui √© </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exception-CanceledError-TimeoutError</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5.2.1 Cancelando um trabalho O </font></font></b> <br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> fornece uma fun√ß√£o de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cancelamento (coro)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Isso funciona lan√ßando uma exce√ß√£o para usar a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">corotina</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pend_throw </font><font style="vertical-align: inherit;">. Tamb√©m funciona com corotinas aninhadas. O uso √© o seguinte:</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: <span class="hljs-comment"><span class="hljs-comment">#  -  10 secs await asyncio.sleep(10) async def bar(loop): foo_instance = foo() #   coro loop.create_task(foo_instance) # code omitted asyncio.cancel(foo_instance)</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se este exemplo √© executado sob </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio v2.0</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , quando o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bar</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> vai emitir </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cancelar</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> isso n√£o ter√° efeito at√© a pr√≥xima agendada </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">foo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e casos </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">foo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pode haver um atraso de at√© 10 segundos. Outra fonte de atraso ocorrer√° se </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">foo estiver</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> aguardando E / S. Onde quer que o atraso ocorra, a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">barra</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> n√£o poder√° determinar se o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">foo foi</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cancelado. √â importante em alguns casos de uso. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ao usar as </font><b><font style="vertical-align: inherit;">bibliotecas </font></b></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Paul Sokolovsky</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fast_io, √©</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> suficiente usar sleep (0):</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: <span class="hljs-comment"><span class="hljs-comment">#  -  10 secs await asyncio.sleep(10) async def bar(loop): foo_instance = foo() #   coro loop.create_task(foo_instance) #    asyncio.cancel(foo_instance) await asyncio.sleep(0) #   </span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Isso tamb√©m funcionar√° no </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio v2.0</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> se </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">foo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (e qualquer coroutine pendente </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">foo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) nunca </font><font style="vertical-align: inherit;">retornasse o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sono</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e n√£o esperasse E / S. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comportamento que pode surpreender o descuidado ocorre quando √© esperado que uma corotina executada por </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">create_task</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e no modo de </font><font style="vertical-align: inherit;">espera cancele </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Considere este trecho:</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: <span class="hljs-comment"><span class="hljs-comment">#  -  10 secs await asyncio.sleep(10) async def foo_runner(foo_instance): await foo_instance print('   ') async def bar(loop): foo_instance = foo() loop.create_task(foo_runner(foo_instance)) #    asyncio.cancel(foo_instance)</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quando </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">foo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© cancelado, ele √© removido da fila do planejador; </font><font style="vertical-align: inherit;">porque falta uma </font><font style="vertical-align: inherit;">declara√ß√£o de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">retorno</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , o procedimento de chamada </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">foo_runner</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nunca √© retomado. </font><font style="vertical-align: inherit;">√â recomend√°vel que voc√™ sempre capture a exce√ß√£o no escopo mais externo da fun√ß√£o a ser desfeita:</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep(<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> my_coro <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> asyncio.CancelledError: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nesse caso, o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">my_coro</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> n√£o precisa capturar a exce√ß√£o, pois ela ser√° propagada para o canal de chamada e capturada l√°.</font></font><br><br>  Nota<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√â proibido usar </font><font style="vertical-align: inherit;">m√©todos </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">close</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">throw</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de corotinas quando elas s√£o usadas fora do planejador. Isso prejudica o agendador, for√ßando a corotina a executar o c√≥digo, mesmo que n√£o esteja agendado. Isso pode ter consequ√™ncias indesej√°veis. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5.2.2 coroutines com tempos limite</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Timeouts implementado usando </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> m√©todos </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.wait_for ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.wait_for_ms ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Eles tomam a rotina e a lat√™ncia em segundos ou ms, respectivamente, como argumentos. Se o tempo limite expirar, um </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TimeoutError</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ser√° </font><i><font style="vertical-align: inherit;">lan√ßado</font></i><font style="vertical-align: inherit;"> na corotina usando </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pend_throw</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Essa exce√ß√£o deve ser detectada pelo usu√°rio ou pelo chamador. </font><font style="vertical-align: inherit;">Isso √© necess√°rio pelo motivo descrito acima: se o tempo limite expirar, ele ser√° cancelado. </font><font style="vertical-align: inherit;">A menos que o erro seja capturado e retornado, a √∫nica maneira de o chamador continuar √© capturar a pr√≥pria exce√ß√£o. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Onde a exce√ß√£o foi capturada pela corotina, tive falhas pouco claras se a exce√ß√£o n√£o foi capturada no escopo externo, conforme mostrado abaixo:</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> uasyncio <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> asyncio <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">forever</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: print(<span class="hljs-string"><span class="hljs-string">'Starting'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep_ms(<span class="hljs-number"><span class="hljs-number">300</span></span>) print(<span class="hljs-string"><span class="hljs-string">'Got here'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> asyncio.TimeoutError: print(<span class="hljs-string"><span class="hljs-string">'Got timeout'</span></span>) <span class="hljs-comment"><span class="hljs-comment"># And return async def foo(): await asyncio.wait_for(forever(), 5) await asyncio.sleep(2) loop = asyncio.get_event_loop() loop.run_until_complete(foo())</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Como alternativa, voc√™ pode interceptar a fun√ß√£o de chamada: </font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> uasyncio <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> asyncio <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">forever</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> print(<span class="hljs-string"><span class="hljs-string">'Starting'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep_ms(<span class="hljs-number"><span class="hljs-number">300</span></span>) print(<span class="hljs-string"><span class="hljs-string">'Got here'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.wait_for(forever(), <span class="hljs-number"><span class="hljs-number">5</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> asyncio.TimeoutError: <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> print(<span class="hljs-string"><span class="hljs-string">'Timeout elapsed.'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep(<span class="hljs-number"><span class="hljs-number">2</span></span>) loop = asyncio.get_event_loop() loop.run_until_complete(foo())</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nota para o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uasyncio v2.0</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Isso n√£o se aplica √†s </font><b><font style="vertical-align: inherit;">bibliotecas </font></b></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Paul Sokolovsky</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fast_io</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se a corotina iniciar, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aguarde asyncio.sleep (t)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , com um longo atraso t, a corotina n√£o ser√° reiniciada at√© </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">t</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> expirar </font><font style="vertical-align: inherit;">. Se o tempo limite expirar antes que o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sono</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> termine </font><font style="vertical-align: inherit;">, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ocorrer√°</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> um erro de </font><font style="vertical-align: inherit;">tempo limite </font><font style="vertical-align: inherit;">quando a corotina for recarregada - ou seja, quando </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">t</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> expirar </font><font style="vertical-align: inherit;">. Em tempo real e da perspectiva do chamador, sua resposta </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TimeoutError</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ser√° atrasada. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se isso for importante para o aplicativo, crie um longo atraso enquanto aguarda um curto no loop. Coroutine</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o asyn.sleep</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> suporta isso. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6 Intera√ß√£o com o equipamento</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> A base da intera√ß√£o entre </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e eventos ass√≠ncronos externos √© a pesquisa de </font><b><font style="vertical-align: inherit;">opini√£o</font></b><font style="vertical-align: inherit;"> . O hardware que requer uma resposta r√°pida pode usar uma interrup√ß√£o. Mas a intera√ß√£o entre a rotina de interrup√ß√£o (ISR) e a rotina do usu√°rio ser√° baseada em pesquisas. Por exemplo, um ISR pode chamar </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Event</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou definir um sinalizador global, enquanto uma corrotina que aguarda um resultado pesquisa um objeto cada vez que uma solicita√ß√£o √© agendada. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A interroga√ß√£o pode ser realizada de duas maneiras, expl√≠cita ou impl√≠cita. O √∫ltimo √© feito usando </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">E / S de fluxo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">um mecanismo, que √© um sistema projetado para dispositivos de streaming como </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UART</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">soquetes</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Na pesquisa expl√≠cita mais simples, o seguinte c√≥digo pode consistir:</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">poll_my_device</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> my_flag <span class="hljs-comment"><span class="hljs-comment">#   ISR while True: if my_flag: my_flag = False # service the device await asyncio.sleep(0)</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em vez de um sinalizador global, voc√™ pode usar uma vari√°vel de inst√¢ncia da classe </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Event</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou uma inst√¢ncia de uma classe que use </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wait</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Uma pesquisa expl√≠cita √© discutida abaixo. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A pesquisa impl√≠cita consiste em desenvolver um driver que funcionar√° como um dispositivo de E / S de streaming, como um </font><i><font style="vertical-align: inherit;">soquete </font></i></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UART</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou </font><i><font style="vertical-align: inherit;">E / S de streaming</font></i><font style="vertical-align: inherit;"> , que pesquisa os dispositivos usando o sistema </font><b><font style="vertical-align: inherit;">Python </font></b><i><font style="vertical-align: inherit;">select.poll</font></i><font style="vertical-align: inherit;"> : como a pesquisa √© realizada em C, √© mais r√°pida e eficiente do que pesquisa expl√≠cita. O uso de E / S de fluxo √© discutido na se√ß√£o 6.3.</font></font><i><font style="vertical-align: inherit;"></font></i> <i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i> <b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Devido √† sua efic√°cia, a pesquisa impl√≠cita oferece uma vantagem aos drivers de dispositivo de E / S mais r√°pidos: os drivers de streaming podem ser criados para muitos dispositivos que geralmente n√£o s√£o considerados dispositivos de streaming. Isso √© discutido em mais detalhes na se√ß√£o 6.4. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6.1 Problemas de sincroniza√ß√£o</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Atualmente, pesquisas expl√≠citas e impl√≠citas s√£o baseadas em planejamento c√≠clico. Suponha que a E / S funcione simultaneamente com N rotinas personalizadas, cada uma das quais √© executada com atraso zero. Quando a E / S √© servida, ela ser√° pesquisada assim que todas as opera√ß√µes do usu√°rio forem agendadas. O atraso estimado deve ser considerado ao projetar. Os canais de E / S podem exigir buffer, com o equipamento de manuten√ß√£o ISR em tempo real a partir de buffers e corotinas, preenchendo ou liberando buffers em um tempo mais lento. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tamb√©m √© necess√°rio considerar a possibilidade de ir al√©m: esse √© o caso quando algo interrogado pela corotina acontece mais de uma vez antes de ser realmente planejado pela corotina.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Outra quest√£o de tempo √© a precis√£o da lat√™ncia. Se a corotina emitir</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep_ms ( t ) <span class="hljs-comment"><span class="hljs-comment">#  </span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o planejador garante que a execu√ß√£o seja suspensa por pelo menos t ms. O atraso real pode ser maior que t, dependendo da carga atual do sistema. Se, nesse momento, outras corotinas aguardarem a conclus√£o de atrasos diferentes de zero, a pr√≥xima linha ser√° imediatamente agendada para execu√ß√£o. Por√©m, se outras corotinas tamb√©m estiverem aguardando execu√ß√£o (porque emitiram um atraso zero ou porque o tempo tamb√©m expirou), elas podem ser agendadas para serem executadas mais cedo. Isso introduz incerteza de sincroniza√ß√£o nas </font><font style="vertical-align: inherit;">fun√ß√µes </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sleep ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sleep_ms ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . O valor do pior caso para esse estouro pode ser calculado somando os valores de tempo de execu√ß√£o de todas essas rotinas para determinar o tempo de transmiss√£o do pior caso para o planejador.</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> vers√£o </font><b><font style="vertical-align: inherit;">fast_io</font></b><font style="vertical-align: inherit;"> do </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , neste contexto, fornece uma maneira de garantir que a E / S de streaming seja pesquisada a cada itera√ß√£o do planejador. Espera-se que o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> oficial </font><font style="vertical-align: inherit;">aceite as emendas relevantes em devido tempo. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6.2 Interrogando dispositivos usando corotinas</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Esta √© uma abordagem simples, mais adequada para dispositivos que podem ser interrogados a uma velocidade relativamente baixa. Isso ocorre principalmente porque a pesquisa com um intervalo de pesquisa curto (ou zero) pode levar ao fato de que a corotina consome mais tempo do processador do que o desej√°vel para cair no intervalo. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O exemplo </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">apoll.py</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> demonstra essa abordagem consultando o aceler√¥metro </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pyboard</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">com um intervalo de 100 ms. Ele executa uma filtragem simples para ignorar o ru√≠do e imprime uma mensagem a cada dois segundos, se nenhum movimento ocorrer. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O exemplo </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aswitch.py</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> fornece drivers para comutadores e dispositivos de bot√£o. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um exemplo de driver para um dispositivo capaz de ler e escrever √© mostrado abaixo. Para facilitar o teste, o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pyboard</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> UART 4 ‚Äã‚Äãemula um dispositivo condicional. Driver implementa a classe </font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RecordOrientedUart</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, em que os dados s√£o fornecidos em registros de tamanho vari√°vel que consistem em inst√¢ncias de bytes. O objeto adiciona um delimitador antes de enviar e armazena em buffer os dados recebidos at√© que um delimitador adicionado seja recebido. Esta √© apenas uma demonstra√ß√£o e uma maneira ineficiente de usar o UART em compara√ß√£o com a entrada / sa√≠da de streaming. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para demonstrar a transfer√™ncia ass√≠ncrona, assumimos que o dispositivo emulado tem um meio de verificar se a transfer√™ncia est√° conclu√≠da e que o aplicativo exige que esperemos. Nenhuma das suposi√ß√µes √© verdadeira neste exemplo, mas o c√≥digo o falsifica </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aguardando asyncio.sleep (0.1)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para come√ßar, n√£o esque√ßa de conectar as sa√≠das do </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pyboard</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> X1 e X2 (UART Txd e Rxd)</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> uasyncio <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> asyncio <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pyb <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> UART <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RecordOrientedUart</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">()</span></span></span><span class="hljs-class">:</span></span> DELIMITER = <span class="hljs-string"><span class="hljs-string">b'\0'</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self.uart = UART(<span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">9600</span></span>) self.data = <span class="hljs-string"><span class="hljs-string">b''</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__iter__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># Not __await__ issue #2678 data = b'' while not data.endswith(self.DELIMITER): yield from asyncio.sleep(0) # ,  : while not self.uart.any(): yield from asyncio.sleep(0) # timing may mean this is never called data = b''.join((data, self.uart.read(self.uart.any()))) self.data = data async def send_record(self, data): data = b''.join((data, self.DELIMITER)) self.uart.write(data) await self._send_complete() #          #        await asyncio.sleep(0) async def _send_complete(self): await asyncio.sleep(0.1) def read_record(self): # Synchronous: await the object before calling return self.data[0:-1] # Discard delimiter async def run(): foo = RecordOrientedUart() rx_data = b'' await foo.send_record(b'A line of text.') for _ in range(20): await foo #  coros       foo rx_data = foo.read_record() print('Got: {}'.format(rx_data)) await foo.send_record(rx_data) rx_data = b'' loop = asyncio.get_event_loop() loop.run_until_complete(run())</span></span></code> </pre><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6.3 Usando o mecanismo de streaming ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stream</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> )</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> O exemplo demonstra a entrada e sa√≠da simult√¢nea em um UART do microprocessador </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pyboard</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para come√ßar, conecte as sa√≠das do </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pyboard</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> X1 e X2 (UART Txd e Rxd)</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> uasyncio <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> asyncio <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pyb <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> UART uart = UART(<span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">9600</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sender</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> swriter = asyncio.StreamWriter(uart, {}) <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> swriter.awrite(<span class="hljs-string"><span class="hljs-string">'Hello uart\n'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep(<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">receiver</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> sreader = asyncio.StreamReader(uart) <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: res = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> sreader.readline() print(<span class="hljs-string"><span class="hljs-string">'Received'</span></span>, res) loop = asyncio.get_event_loop() loop.create_task(sender()) loop.create_task(receiver()) loop.run_forever()</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O c√≥digo de suporte pode ser encontrado em </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__init__.py</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> na </font><font style="vertical-align: inherit;">biblioteca </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">O mecanismo funciona porque o driver de dispositivo (escrito em </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) implementa os seguintes m√©todos: </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ioctl, read, readline</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">write</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Se√ß√£o 6.4: A cria√ß√£o de um driver de dispositivo de streaming revela detalhes de como esses drivers podem ser escritos em </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Python</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O UART pode receber dados a qualquer momento. O mecanismo de E / S de streaming verifica se h√° caracteres pendentes sempre que o agendador obt√©m controle. Quando a corotina est√° em execu√ß√£o, a rotina de interrup√ß√£o armazena em buffer os caracteres recebidos; eles ser√£o exclu√≠dos quando a corotina der lugar ao agendador. Portanto, os aplicativos UART devem ser projetados para que as corotinas minimizem o tempo entre as transfer√™ncias para o planejador, a fim de evitar estouros de buffer e perda de dados. Isso pode ser aprimorado usando um buffer de leitura UART maior ou uma taxa de dados mais baixa. Como alternativa, o controle de fluxo de hardware fornecer√° uma solu√ß√£o se a fonte de dados o suportar. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6.3.1 Exemplo de UART controlador</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> programa </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">auart_hd.py</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ilustra um m√©todo de comunica√ß√£o com um dispositivo half-duplex, como um dispositivo que responde ao conjunto de comandos do modem AT. Half duplex significa que o dispositivo nunca envia dados n√£o solicitados: suas transfer√™ncias s√£o sempre realizadas em resposta a um comando recebido do mestre. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O dispositivo √© emulado executando um teste em um </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pyboard</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> com duas conex√µes com fio. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O dispositivo emulado (muito simplificado) responde a qualquer comando enviando quatro linhas de dados com uma pausa entre cada uma para simular o processamento lento.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O assistente envia um comando, mas n√£o sabe antecipadamente quantas linhas de dados ser√£o retornadas. Ele inicia um timer de reinicializa√ß√£o que √© reiniciado toda vez que uma linha √© recebida. Quando o cron√¥metro expirar, presume-se que o dispositivo tenha conclu√≠do a transmiss√£o e uma lista de linhas recebidas seja retornada. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tamb√©m √© demonstrado um caso de falha do dispositivo, o que √© alcan√ßado pulando uma transmiss√£o antes de esperar por uma resposta. Ap√≥s o tempo limite, uma lista vazia √© retornada. Veja os coment√°rios do c√≥digo para mais detalhes. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6.4 Desenvolvimento de fluxo cont√≠nuo (drivers de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fluxo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) da unidade</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de entrada de fluxo / mecanismo de sa√≠da ( </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fluxo de I / O</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) para controlar o funcionamento da transmiss√£o de dispositivos I / O, tais como UART e soquetes ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">soquete</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) O mecanismo pode ser usado pelos drivers de qualquer dispositivo consultado regularmente, delegando ao agendador que usa </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">select</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , consultando a disponibilidade de qualquer dispositivo na fila. Isso √© mais eficiente do que executar v√°rias opera√ß√µes de corotina, cada uma pesquisando o dispositivo, em parte porque </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">select</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© gravada em </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e tamb√©m porque a corotina que realiza a pesquisa √© atrasada at√© que o objeto pesquisado retorne um estado pronto. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um driver de dispositivo capaz de atender ao mecanismo de entrada / sa√≠da de streaming deve preferencialmente suportar os m√©todos </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">StreamReader, StreamWriter</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Um dispositivo leg√≠vel deve fornecer pelo menos um dos seguintes m√©todos. Observe que esses s√£o m√©todos s√≠ncronos. O m√©todo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ioctl</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (veja abaixo) garante que eles sejam chamados apenas quando os dados estiverem dispon√≠veis. Os m√©todos devem ser retornados o mais r√°pido poss√≠vel, usando o m√°ximo de dados dispon√≠veis. </font></font><br><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">readline ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Retorna o m√°ximo de caracteres poss√≠vel, at√© qualquer caractere de nova linha. Necess√°rio se voc√™ estiver usando </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">StreamReader.readline () </font></font></i> <br><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">read (n)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Retorne o m√°ximo de caracteres poss√≠vel, mas n√£o mais que </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Necess√°rio se estiver usando </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">StreamReader.read ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">StreamReader.readexactly ()</font></font></i> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O driver criado deve fornecer o seguinte m√©todo s√≠ncrono com retorno imediato: </font></font><br><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">escreva</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> com argumentos </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">buf, off, sz</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Onde: </font></font><br><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">buf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© o buffer para grava√ß√£o. </font></font><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">off</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - offset para o buffer do primeiro caractere a ser gravado. </font></font><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sz</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - o n√∫mero solicitado de caracteres para escrever. </font></font><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O valor de retorno</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© o n√∫mero de caracteres realmente gravados (talvez 1 se o dispositivo estiver lento). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O m√©todo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ioctl</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> garante que ele ser√° chamado apenas quando o dispositivo estiver pronto para receber dados.</font></font><br><cut></cut><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Todos os dispositivos devem fornecer um m√©todo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ioctl</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que controla o equipamento para determinar seu status de disponibilidade. </font><font style="vertical-align: inherit;">Um exemplo t√≠pico para um driver de leitura / grava√ß√£o:</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io MP_STREAM_POLL_RD = const(<span class="hljs-number"><span class="hljs-number">1</span></span>) MP_STREAM_POLL_WR = const(<span class="hljs-number"><span class="hljs-number">4</span></span>) MP_STREAM_POLL = const(<span class="hljs-number"><span class="hljs-number">3</span></span>) MP_STREAM_ERROR = const(<span class="hljs-number"><span class="hljs-number">-1</span></span>) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyIO</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(io.IOBase)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-comment"><span class="hljs-comment">#    def ioctl(self, req, arg): # see ports/stm32/uart.c ret = MP_STREAM_ERROR if req == MP_STREAM_POLL: ret = 0 if arg &amp; MP_STREAM_POLL_RD: if hardware_has_at_least_one_char_to_read: ret |= MP_STREAM_POLL_RD if arg &amp; MP_STREAM_POLL_WR: if hardware_can_accept_at_least_one_write_character: ret |= MP_STREAM_POLL_WR return ret</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A seguir, √© apresentada uma descri√ß√£o do </font><font style="vertical-align: inherit;">atraso de espera da </font><font style="vertical-align: inherit;">classe </font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MillisecTimer</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> uasyncio <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> asyncio <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> utime <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io MP_STREAM_POLL_RD = const(<span class="hljs-number"><span class="hljs-number">1</span></span>) MP_STREAM_POLL = const(<span class="hljs-number"><span class="hljs-number">3</span></span>) MP_STREAM_ERROR = const(<span class="hljs-number"><span class="hljs-number">-1</span></span>) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MillisecTimer</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(io.IOBase)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self.end = <span class="hljs-number"><span class="hljs-number">0</span></span> self.sreader = asyncio.StreamReader(self) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__iter__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> self.sreader.readline() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__call__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, ms)</span></span></span><span class="hljs-function">:</span></span> self.end = utime.ticks_add(utime.ticks_ms(), ms) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readline</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">b'\n'</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ioctl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, req, arg)</span></span></span><span class="hljs-function">:</span></span> ret = MP_STREAM_ERROR <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> req == MP_STREAM_POLL: ret = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> arg &amp; MP_STREAM_POLL_RD: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> utime.ticks_diff(utime.ticks_ms(), self.end) &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>: ret |= MP_STREAM_POLL_RD <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ret</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que pode ser usado da seguinte maneira: </font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">timer_test</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( n )</span></span></span><span class="hljs-function">:</span></span> timer = ms_timer.MillisecTimer () <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> timer ( <span class="hljs-number"><span class="hljs-number">30</span></span> ) <span class="hljs-comment"><span class="hljs-comment">#  30 </span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comparado ao </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> oficial </font><b><font style="vertical-align: inherit;">,</font></b><font style="vertical-align: inherit;"> essa implementa√ß√£o n√£o oferece nenhuma vantagem em compara√ß√£o com o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">asyncio.sleep_ms ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . O uso de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fast_io</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> fornece atrasos significativamente mais precisos no padr√£o de uso normal, quando as corotinas esperam um atraso zero. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Voc√™ pode usar o agendamento de E / S para associar um evento a um retorno de chamada. Isso √© mais eficiente que o ciclo de pesquisa, porque a pesquisa n√£o √© agendada at√© que o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ioctl</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> retorne pronto. Em seguida, um retorno de chamada √© executado quando o retorno de chamada muda de estado.</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> uasyncio <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> asyncio <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io MP_STREAM_POLL_RD = const(<span class="hljs-number"><span class="hljs-number">1</span></span>) MP_STREAM_POLL = const(<span class="hljs-number"><span class="hljs-number">3</span></span>) MP_STREAM_ERROR = const(<span class="hljs-number"><span class="hljs-number">-1</span></span>) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PinCall</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(io.IOBase)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, pin, *, cb_rise=None, cbr_args=</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">()</span></span></span></span><span class="hljs-function"><span class="hljs-params">, cb_fall=None, cbf_args=</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">()</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> self.pin = pin self.cb_rise = cb_rise self.cbr_args = cbr_args self.cb_fall = cb_fall self.cbf_args = cbf_args self.pinval = pin.value() self.sreader = asyncio.StreamReader(self) loop = asyncio.get_event_loop() loop.create_task(self.run()) <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> self.sreader.read(<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, _)</span></span></span><span class="hljs-function">:</span></span> v = self.pinval <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> v <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> self.cb_rise <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: self.cb_rise(*self.cbr_args) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">b'\n'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> v <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> self.cb_fall <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: self.cb_fall(*self.cbf_args) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">b'\n'</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ioctl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, req, arg)</span></span></span><span class="hljs-function">:</span></span> ret = MP_STREAM_ERROR <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> req == MP_STREAM_POLL: ret = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> arg &amp; MP_STREAM_POLL_RD: v = self.pin.value() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> v != self.pinval: self.pinval = v ret = MP_STREAM_POLL_RD <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ret</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">E novamente - no </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> oficial </font><b><font style="vertical-align: inherit;">, o</font></b><font style="vertical-align: inherit;"> atraso pode ser alto. Dependendo do design do aplicativo, a vers√£o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fast_io</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pode ser mais eficiente. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">demonstra√ß√£o do iorw.py</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ilustra um exemplo completo. Observe que, no momento da reda√ß√£o do artigo no </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> oficial, </font><font style="vertical-align: inherit;">h√° um erro devido ao qual isso </font></font><a href="http://github.com/micropython/pull/3836" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n√£o funciona</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Existem duas solu√ß√µes. A solu√ß√£o alternativa √© gravar dois drivers separados, um para somente leitura e outro para somente grava√ß√£o. O segundo √© usar o </font></font><a href="" rel="nofollow"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fast_io</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que resolve esse problema. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> oficial </font><b><font style="vertical-align: inherit;">, a</font></b><font style="vertical-align: inherit;"> entrada / sa√≠da √© planejada muito </font></font><a href="http://github.com/micropython/micropython/issues/2664" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">raramente</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6.5 Exemplo completo: aremote.py</font></font></b> <br><br> <a href="" rel="nofollow"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O driver foi</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> projetado para receber / decodificar sinais de um controle remoto infravermelho. O</font></font><a href="http://github.com/peterhinch/micropython-async/blob/master/nec_ir/aremote.py" rel="nofollow"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pr√≥prio</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> driver</font><a href="http://github.com/peterhinch/micropython-async/blob/master/nec_ir/aremote.py" rel="nofollow"><b><font style="vertical-align: inherit;"> aremote.py</font></b></a><font style="vertical-align: inherit;"> . As notas a seguir s√£o significativas em rela√ß√£o ao uso de</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ass√≠ncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A interrup√ß√£o no contato registra a hora da altera√ß√£o de estado (em microssegundos) e define o evento, ignorando a hora em que a primeira altera√ß√£o de estado ocorreu. A corotina aguarda um evento, relata a dura√ß√£o do pacote de dados e decodifica os dados armazenados antes de chamar o retorno de chamada especificado pelo usu√°rio.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A passagem do tempo para uma inst√¢ncia de</font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Evento</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> permite que a corotina compense qualquer</font><font style="vertical-align: inherit;">atraso</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ass√≠ncrono</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ao definir o per√≠odo de atraso.</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 6.6 sensor ambiental HTU21D</font></font></b> <br><br> <a href="http://github.com/peterhinch/micropython-async/blob/master/nec_ir/aremote.py" rel="nofollow"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> driver de chip HTU21D fornece medi√ß√µes precisas de temperatura e umidade.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O chip precisa de cerca de 120 ms para receber os dois elementos de dados. O driver trabalha de forma ass√≠ncrona, iniciando o recebimento e o uso de</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> wait asyncio.sleep (t)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> antes de ler os dados, atualiza as vari√°veis ‚Äã‚Äãde temperatura e umidade, que podem ser acessadas a qualquer momento, o que permite que outras corotinas sejam ativadas enquanto o driver do chip estiver em execu√ß√£o.</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 7.Dicas e truques </font></font></b> <br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.1 O programa congela O congelamento</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> geralmente ocorre porque a tarefa √© bloqueada sem concess√£o: isso levar√° ao congelamento de todo o sistema. Ao desenvolver, √© √∫til ter uma rotina rotativa que acenda periodicamente o LED embutido. Isso fornece confirma√ß√£o de que o planejador ainda est√° em execu√ß√£o.</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.2 uasyncio salva estado</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ao iniciar programas usando o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> no REPL, execute uma reinicializa√ß√£o suave (ctrl-D) entre as partidas. Devido ao fato de o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> manter o estado entre as partidas, um comportamento imprevis√≠vel pode ocorrer na pr√≥xima partida. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.3 Coleta de lixo</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Voc√™ pode executar uma corotina especificando </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">import gc primeiro</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br><br><pre> <code class="python hljs">gc.collect () gc.treshold ( gc.mem_free () // <span class="hljs-number"><span class="hljs-number">4</span></span> + gc.mem_alloc ())</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O objetivo disso √© discutido </font></font><a href="http://docs.micropython.org/en/latest/reference/constrained.html" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> na se√ß√£o heap. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.4 Teste</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √â recomend√°vel garantir que o driver do dispositivo mantenha o controle quando necess√°rio, o que pode ser feito executando uma ou mais c√≥pias de corotinas fict√≠cias que iniciam o ciclo de impress√£o de mensagens e verificando se ele √© executado durante per√≠odos em que o driver est√° no modo de espera:</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rr</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: print(<span class="hljs-string"><span class="hljs-string">'Roundrobin '</span></span>, n) <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep(<span class="hljs-number"><span class="hljs-number">0</span></span>)</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como um exemplo do tipo de perigo que pode surgir, no exemplo acima, o </font><font style="vertical-align: inherit;">m√©todo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RecordOrientedUart </font></font></i> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__await__</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> foi originalmente escrito como:</font></font><br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__await__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> data = <span class="hljs-string"><span class="hljs-string">b''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> data.endswith(self.DELIMITER): <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> self.uart.any(): <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> asyncio.sleep(<span class="hljs-number"><span class="hljs-number">0</span></span>) data = <span class="hljs-string"><span class="hljs-string">b''</span></span>.join((data, self.uart.read(self.uart.any()))) self.data = data</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como resultado, a execu√ß√£o √© esticada at√© que todo o registro seja recebido, bem como o fato de que </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uart.any ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sempre retorna um n√∫mero diferente de zero de caracteres recebidos. No momento da chamada, todos os caracteres j√° podem ter sido recebidos. Esta situa√ß√£o pode ser resolvida usando um loop externo:</font></font><br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__await__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> data = <span class="hljs-string"><span class="hljs-string">b''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> data.endswith(self.DELIMITER): <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> asyncio.sleep(<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-comment"><span class="hljs-comment"># ,  : while not self.uart.any(): yield from asyncio.sleep(0) #        data = b''.join((data, self.uart.read(self.uart.any()))) self.data = data</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vale a pena notar que esse erro n√£o seria √≥bvio se os dados tivessem sido enviados para o UART em uma velocidade mais baixa, em vez de usar um teste de feedback. Bem-vindo √†s alegrias da programa√ß√£o em tempo real. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.5 Erro comum</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Se uma fun√ß√£o ou m√©todo √© definido por </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">def ass√≠ncrono</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e subsequentemente chamado como se fosse uma chamada regular (s√≠ncrona), o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MicroPython</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> n√£o </font><b><font style="vertical-align: inherit;">exibe</font></b><font style="vertical-align: inherit;"> uma mensagem de erro. Isso √© por design. Geralmente, isso leva ao fato de que o programa silenciosamente n√£o funciona corretamente:</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># code loop.create_task(foo) #  1 1: foo     foo() #  2: .</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eu tenho uma </font></font><a href="http://github.com/micropython-lib/pull/292" rel="nofollow"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sugest√£o</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que sugere corrigir a situa√ß√£o na op√ß√£o 1 usando </font></font><a href="" rel="nofollow"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fast_io</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O m√≥dulo </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">check_async_code.py</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tenta detectar casos de uso duvidoso de corotinas. Est√° escrito em </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Python3</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e foi projetado para funcionar em um PC. Utilizado em scripts escritos de acordo com as diretrizes descritas neste guia com corotinas declaradas usando </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">async def</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . O m√≥dulo usa um argumento, o caminho para o arquivo </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MicroPython de</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> origem </font><font style="vertical-align: inherit;">(ou --help).</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Observe que √© um tanto rude e se destina a ser usado em um arquivo sintaticamente correto, que n√£o inicia por padr√£o. </font><font style="vertical-align: inherit;">Use uma ferramenta, como o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pylint,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para verificar a sintaxe geral (o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pylint</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> atualmente n√£o possui esse erro). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O script produz falsos positivos. </font><font style="vertical-align: inherit;">De acordo com o plano, as corotinas s√£o objetos de primeiro n√≠vel, podem ser transferidas para fun√ß√µes e armazenadas em estruturas de dados. </font><font style="vertical-align: inherit;">Dependendo da l√≥gica do programa, voc√™ pode salvar a fun√ß√£o ou o resultado de sua execu√ß√£o. </font><font style="vertical-align: inherit;">O script n√£o pode determinar a inten√ß√£o. </font><font style="vertical-align: inherit;">O objetivo √© ignorar os casos que parecem corretos ao identificar outros casos a serem considerados. </font><font style="vertical-align: inherit;">Suponha </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">foo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> onde a corotina √© declarada como </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">def ass√≠ncrona</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><br><br><pre> <code class="python hljs">loop.run_until_complete(foo()) <span class="hljs-comment"><span class="hljs-comment">#   bar(foo) #     ,      bar(foo()) z = (foo,) z = (foo(),) foo() #  :   .</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Acho √∫til, mas as melhorias s√£o sempre bem-vindas. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.6 Programa√ß√£o com sockets ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">soquetes</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> )</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Existem duas abordagens b√°sicas para a programa√ß√£o soquetes </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Por padr√£o, os soquetes s√£o bloqueados at√© que a opera√ß√£o de leitura ou grava√ß√£o especificada seja conclu√≠da. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O Uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> suporta o bloqueio de soquete usando o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">select.poll</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para impedir que o planejador os bloqueie. Na maioria dos casos, esse mecanismo √© mais f√°cil de usar. Um exemplo de c√≥digo do cliente e do servidor pode ser encontrado no diret√≥rio </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">client_server</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Userver</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> usa o aplicativo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">select.poll</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pesquisando explicitamente o soquete do servidor.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Os soquetes do cliente o usam implicitamente no sentido em que o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mecanismo de</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> streaming </font><b><font style="vertical-align: inherit;">uasyncio</font></b><font style="vertical-align: inherit;"> o </font><font style="vertical-align: inherit;">usa diretamente. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Observe que o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">socket.getaddrinfo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est√° atualmente bloqueado. O tempo no c√≥digo de exemplo ser√° m√≠nimo, mas se for necess√°ria uma pesquisa de DNS, o per√≠odo de bloqueio poder√° ser significativo. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uma segunda abordagem para a programa√ß√£o de soquetes √© usar soquetes sem bloqueio. Isso aumenta a complexidade, mas √© necess√°rio em alguns aplicativos, especialmente se a conex√£o for via Wi-Fi (veja abaixo). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No momento da reda√ß√£o deste artigo (mar√ßo de 2019), o suporte ao TLS para soquetes sem bloqueio estava em desenvolvimento. Seu status exato √© desconhecido (para mim).</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O uso de soquetes sem bloqueio exige alguma aten√ß√£o aos detalhes. Se leituras sem bloqueio ocorrerem devido √† lat√™ncia do servidor, n√£o h√° garantia de que todos (ou alguns) dos dados solicitados ser√£o retornados. Da mesma forma, as entradas podem n√£o ser conclu√≠das. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Portanto, os m√©todos ass√≠ncronos de leitura e grava√ß√£o devem executar iterativamente uma opera√ß√£o sem bloqueio at√© que os dados necess√°rios sejam lidos ou gravados. Na pr√°tica, pode ser necess√°rio um tempo limite para lidar com interrup√ß√µes no servidor. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Outra complica√ß√£o √© que a porta ESP32 teve problemas que exigiam invas√µes bastante desagrad√°veis ‚Äã‚Äãpara uma opera√ß√£o sem erros. N√£o testei se esse ainda √© o caso. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">M√≥dulo </font></font><a href="" rel="nofollow"><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sock_nonblock.py</font></font></b></i></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ilustra os m√©todos necess√°rios. Esta n√£o √© uma demonstra√ß√£o funcional e √© prov√°vel que as decis√µes sejam dependentes do aplicativo. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.6.1 Problemas com o WiFi</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> O mecanismo de streaming </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> n√£o </font><b><font style="vertical-align: inherit;">√©</font></b><font style="vertical-align: inherit;"> a melhor op√ß√£o ao detectar falhas no WiFi. Achei necess√°rio usar soquetes sem bloqueio para fornecer opera√ß√£o √† prova de falhas e reconectar o cliente em caso de falhas. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Este </font></font><a href="" rel="nofollow"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">documento</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> descreve os problemas encontrados em aplicativos WiFi que mant√™m os soquetes abertos por longos per√≠odos e descrevem a solu√ß√£o. </font></font><br><br> <a href="http://guthub.com/peterhinch/micropython-mqtt" rel="nofollow"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pltcm</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oferece um cliente MQTT ass√≠ncrono robusto que fornece integridade de mensagem durante falhas de WiFi. √â descrito um link serial full-duplex ass√≠ncrono simples entre um cliente sem fio e um servidor com fio com entrega garantida de mensagens. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.7 Argumentos do construtor de loop de eventos</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pode ocorrer um pequeno erro se voc√™ precisar criar um loop de eventos com valores diferentes dos valores padr√£o. Esse loop deve ser declarado antes de executar qualquer outro c√≥digo usando </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ass√≠ncrono,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pois esses valores podem ser necess√°rios nesse c√≥digo. Caso contr√°rio, o c√≥digo ser√° inicializado com os valores padr√£o:</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> uasyncio <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> asyncio <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> some_module bar = some_module.Bar() <span class="hljs-comment"><span class="hljs-comment">#   get_event_loop() #     loop = asyncio.get_event_loop(runq_len=40, waitq_len=40)</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como a importa√ß√£o de um m√≥dulo pode executar c√≥digo, a maneira mais segura √© instanciar um loop de eventos imediatamente ap√≥s a importa√ß√£o do </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> uasyncio <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> asyncio loop = asyncio.get_event_loop(runq_len=<span class="hljs-number"><span class="hljs-number">40</span></span>, waitq_len=<span class="hljs-number"><span class="hljs-number">40</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> some_module bar = some_module.Bar() <span class="hljs-comment"><span class="hljs-comment"># get_event_loop()   </span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ao escrever m√≥dulos para uso por outros programas, prefiro evitar a execu√ß√£o de c√≥digo </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> na importa√ß√£o. </font><font style="vertical-align: inherit;">Escreva fun√ß√µes e m√©todos para aguardar um loop de eventos como argumento. </font><font style="vertical-align: inherit;">Em seguida, verifique se apenas os aplicativos de n√≠vel superior chamam </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">get_event_loop</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> uasyncio <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> asyncio <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> my_module <span class="hljs-comment"><span class="hljs-comment">#      loop = asyncio.get_event_loop(runq_len=40, waitq_len=40) bar = my_module.Bar(loop)</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esta quest√£o √© discutida </font></font><a href="http://github.com/micropython/micropython-lib/issues/295" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8 notas para iniciantes</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Essas notas destinam-se a iniciantes em c√≥digo ass√≠ncrono e come√ßam com uma descri√ß√£o dos problemas que os planejadores tentam resolver, al√©m de fornecer uma vis√£o geral da abordagem </font><font style="vertical-align: inherit;">de solu√ß√µes </font><font style="vertical-align: inherit;">do </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A Se√ß√£o 8.5 discute os m√©ritos relativos dos m√≥dulos </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e _ </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">thread</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , bem como por que voc√™ pode preferir usar as </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">corotinas</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> uasyncio </font><b><font style="vertical-align: inherit;">com</font></b><font style="vertical-align: inherit;"> agendamento proativo (_thread). </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8.1 Problema 1: loops de eventos</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um aplicativo t√≠pico de firmware funciona continuamente e, ao mesmo tempo, deve responder a eventos externos, que podem incluir uma altera√ß√£o de voltagem no ADC, a apar√™ncia de uma interrup√ß√£o de hardware ou um s√≠mbolo recebido no UART ou dados dispon√≠veis no soquete. Esses eventos ocorrem de forma ass√≠ncrona e o c√≥digo deve poder responder independentemente da ordem em que ocorrem. Al√©m disso, podem ser necess√°rias tarefas dependentes do tempo, como LEDs piscando. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A maneira √≥bvia de fazer isso √© com o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">loop de</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> eventos </font><b><font style="vertical-align: inherit;">uasycio</font></b><font style="vertical-align: inherit;"> . Este exemplo n√£o √© um c√≥digo pr√°tico, mas serve para ilustrar a forma geral do loop de eventos.</font></font><br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">event_loop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> led_1_time = <span class="hljs-number"><span class="hljs-number">0</span></span> led_1_period = <span class="hljs-number"><span class="hljs-number">20</span></span> led_2_time = <span class="hljs-number"><span class="hljs-number">0</span></span> led_2_period = <span class="hljs-number"><span class="hljs-number">30</span></span> switch_state = switch.state() <span class="hljs-comment"><span class="hljs-comment">#    while True: time_now = utime.time() if time_now &gt;= led_1_time: #  LED #1 led1.toggle() led_1_time = time_now + led_1_period if time_now &gt;= led_2_time: #  LED #2 led2.toggle() led_2_time = time_now + led_2_period #    LEDs if switch.value() != switch_state: switch_state = switch.value() #  - if uart.any(): #    UART</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esse loop funciona para exemplos simples, mas √† medida que o n√∫mero de eventos aumenta, o c√≥digo rapidamente se torna complicado. Eles tamb√©m violam os princ√≠pios da programa√ß√£o orientada a objetos combinando a maior parte da l√≥gica do programa em um s√≥ lugar, em vez de vincular o c√≥digo a um objeto controlado. Queremos desenvolver uma classe para um LED intermitente que possa ser inserido em um m√≥dulo e importado. A abordagem OOP do LED piscando pode ser assim:</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pyb <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LED_flashable</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">()</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, led_no)</span></span></span><span class="hljs-function">:</span></span> self.led = pyb.LED(led_no) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">flash</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, period)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: self.led.toggle() <span class="hljs-comment"><span class="hljs-comment"># -     period, #         </span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O planejador no </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> permite criar essas classes. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8.2 Problema 2: m√©todos de bloqueio</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Suponha que voc√™ precise ler um determinado n√∫mero de bytes de um soquete. Se voc√™ chamar </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">socket.read (n)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> com um soquete de bloqueio por padr√£o, ele "bloquear√°" (ou seja, n√£o poder√° terminar) at√© que </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> bytes </font><font style="vertical-align: inherit;">sejam recebidos </font><font style="vertical-align: inherit;">. Durante esse per√≠odo, o aplicativo n√£o responder√° a outros eventos. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Usando o soquete </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sem bloqueio </font><b><font style="vertical-align: inherit;">,</font></b><font style="vertical-align: inherit;"> voc√™ pode escrever um m√©todo de leitura ass√≠ncrono. Uma tarefa que requer dados ser√° (necessariamente) bloqueada at√© que seja recebida, mas outras tarefas ser√£o executadas durante esse per√≠odo, o que permitir√° que o aplicativo permane√ßa responsivo.</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8.3 Abordagens de Uasyncio</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> A pr√≥xima aula tem um LED que pode ser ligado e desligado, e voc√™ tamb√©m pode piscar a qualquer velocidade. A inst√¢ncia </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LED_async</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> usa o m√©todo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">run</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que pode ser usado para opera√ß√£o cont√≠nua. O comportamento dos LEDs pode ser controlado usando os m√©todos </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ligado (), desligado ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">flash (segundos)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pyb <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> uasyncio <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> asyncio <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LED_async</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">()</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, led_no)</span></span></span><span class="hljs-function">:</span></span> self.led = pyb.LED(led_no) self.rate = <span class="hljs-number"><span class="hljs-number">0</span></span> loop = asyncio.get_event_loop() loop.create_task(self.run()) <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self.rate &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep_ms(<span class="hljs-number"><span class="hljs-number">200</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: self.led.toggle() <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep_ms(int(<span class="hljs-number"><span class="hljs-number">500</span></span> / self.rate)) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">flash</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, rate)</span></span></span><span class="hljs-function">:</span></span> self.rate = rate <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self.led.on() self.rate = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">off</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self.led.off() self.rate = <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note-se que </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on (), off ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">flash ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> s√£o m√©todos s√≠ncronos comuns. Eles mudam o comportamento do LED, mas retornam imediatamente. Piscando ocorre "em segundo plano". Isso √© explicado em detalhes na pr√≥xima se√ß√£o. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A classe est√° em conformidade com o princ√≠pio OOP, que consiste em armazenar a l√≥gica associada ao dispositivo na classe. Ao mesmo tempo, o uso do </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> garante que o aplicativo possa responder a outros eventos enquanto o LED estiver piscando. O programa abaixo pisca com quatro LEDs do </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pyboard</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> em diferentes frequ√™ncias e tamb√©m responde ao bot√£o USR, que o completa.</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pyb <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> uasyncio <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> asyncio <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> led_async <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> LED_async <span class="hljs-comment"><span class="hljs-comment"># ,   async def killer(): # ,      sw = pyb.Switch() while not sw.value(): await asyncio.sleep_ms(100) leds = [LED_async(n) for n in range(1, 4)] for n, led in enumerate(leds): led.flash(0.7 + n/4) loop = asyncio.get_event_loop() loop.run_until_complete(killer())</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ao contr√°rio do primeiro exemplo de um loop de eventos, a l√≥gica associada ao comutador est√° em uma fun√ß√£o separada da funcionalidade do LED. </font><font style="vertical-align: inherit;">Preste aten√ß√£o ao c√≥digo usado para iniciar o planejador:</font></font><br><br><pre> <code class="python hljs">loop = asyncio.get_event_loop() loop.run_until_complete(killer()) <span class="hljs-comment"><span class="hljs-comment">#    #       killer (), #   .</span></span></code> </pre><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8.4 Planejamento no uasyncio </font></font></b> <br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Python 3.5</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MicroPython</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> suportam o conceito de uma fun√ß√£o ass√≠ncrona, tamb√©m conhecida como uma rotina ou tarefa. </font><font style="vertical-align: inherit;">Uma corrotina deve incluir pelo menos uma declara√ß√£o de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">espera</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hello</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> _ <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">10</span></span>): print(<span class="hljs-string"><span class="hljs-string">'Hello world.'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep(<span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esta fun√ß√£o imprime uma mensagem dez vezes em intervalos de um segundo. Enquanto a fun√ß√£o √© pausada em antecipa√ß√£o a um atraso, o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">agendador ass√≠ncrono</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> executar√° outras tarefas, criando a ilus√£o de execut√°-las simultaneamente. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quando um problema de rotineira </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aguarda asyncio.sleep_ms ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">asyncio.sleep (), a</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tarefa atual √© pausada e colocada em uma fila que √© ordenada por hor√°rio e a execu√ß√£o prossegue para a tarefa na parte superior da fila. A fila √© projetada de maneira que, mesmo que o modo de suspens√£o especificado seja zero, outras tarefas relevantes ser√£o executadas at√© que a corrente seja retomada. Esse √© um planejamento "circular honesto". √â pr√°tica comum executar </font><i><font style="vertical-align: inherit;">loops aguardando asyncio.sleep (0)</font></i><font style="vertical-align: inherit;"> .</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para que a tarefa n√£o atrase a execu√ß√£o. </font><font style="vertical-align: inherit;">A seguir, um loop de espera ocupada aguardando outra tarefa para definir a vari√°vel de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">flag</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> global </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Infelizmente, monopoliza o processador, impedindo o lan√ßamento de outras corotinas:</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bad_code</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> flag <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> flag: <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> <span class="hljs-comment"><span class="hljs-comment">#  flag = False #    </span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O problema aqui √© que, at√© que o loop </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">flag flag False passe o</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> controle para o planejador, nenhuma outra tarefa ser√° iniciada. </font><font style="vertical-align: inherit;">A abordagem correta:</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">good_code</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> flag <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> flag: <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep(<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-comment"><span class="hljs-comment">#  flag = False #    </span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pelo mesmo motivo, √© uma m√° pr√°tica definir atrasos, por exemplo, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">utime.sleep (1)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> porque bloqueia outras tarefas por 1 s; √© mais correto usar o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wait asyncio.sleep (1)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Observe que os atrasos gerados pelos m√©todos </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uasyncio </font></font></b> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sleep</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sleep_ms</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> podem realmente exceder o tempo especificado. Isso se deve ao fato de que outras tarefas ser√£o executadas durante o atraso. Ap√≥s o per√≠odo de atraso, a execu√ß√£o n√£o ser√° retomada at√© que os problemas da tarefa em execu√ß√£o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aguardem</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou sejam finalizados. Uma rotina bem comportada sempre declara </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aguardar</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">em intervalos regulares. Nos casos em que √© necess√°rio um atraso exato, especialmente se houver menos de alguns ms, pode ser necess√°rio usar </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">utime.sleep_us (us)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8.5 Por que agendamento colaborativo, n√£o baseado em </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">encadeamento</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font><i><font style="vertical-align: inherit;">_thread</font></i><font style="vertical-align: inherit;"> )?</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> A rea√ß√£o inicial dos iniciantes √† ideia de co-planejar corotinas √© muitas vezes decepcionante. Certamente o planejamento de streaming √© melhor? Por que eu deveria ceder explicitamente o controle se a m√°quina virtual Python pode fazer isso por mim? </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quando se trata de sistemas embarcados, o modelo de colabora√ß√£o tem duas vantagens.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O primeiro √© leve. √â poss√≠vel ter um grande n√∫mero de corotinas, porque, diferentemente dos encadeamentos agendados, as corotinas suspensas ocupam menos espa√ßo. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em segundo lugar, isso evita alguns dos problemas sutis associados ao agendamento de streaming. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Na pr√°tica, a multitarefa colaborativa √© amplamente usada, especialmente em aplicativos de interface com o usu√°rio. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em defesa do modelo de planejamento de streaming, mostrarei uma vantagem: se algu√©m escrever</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> x <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range ( <span class="hljs-number"><span class="hljs-number">1000000</span></span> ): <span class="hljs-comment"><span class="hljs-comment">#  - </span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n√£o ir√° bloquear outras tarefas. O modelo de colabora√ß√£o pressup√µe que o loop conceda explicitamente ao controle de cada tarefa um certo n√∫mero de itera√ß√µes, por exemplo, colocando c√≥digo em uma rotina e emitindo periodicamente </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aguardando asyncio.sleep (0)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Infelizmente, essa vantagem empalidece em compara√ß√£o com as desvantagens. Alguns deles s√£o descritos na documenta√ß√£o para escrever </font></font><a href="http://docs.micropython.org/en/latest/reference/isr_rules.html" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">manipuladores de interrup√ß√£o.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Em um modelo de agendamento de streaming, cada thread pode interromper qualquer outro thread, alterando os dados que podem ser usados ‚Äã‚Äãem outros threads. Como regra, √© muito mais f√°cil encontrar e corrigir um bloqueio que ocorre devido a um erro que n√£o gera resultado do que a detec√ß√£o de erros √†s vezes muito sutis e raramente encontrados, que podem ocorrer no c√≥digo escrito na estrutura de um modelo com planejamento de streaming. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Simplificando, se voc√™ escrever uma </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">corotina</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MicroPython </font><font style="vertical-align: inherit;">, pode ter certeza de que as vari√°veis ‚Äã‚Äãn√£o ser√£o alteradas repentinamente por outra corotina: sua corotina tem controle total at√© </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">retornar enquanto aguarda asyncio.sleep (0)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lembre-se de que os manipuladores de interrup√ß√£o s√£o preventivos. Isso se aplica √†s interrup√ß√µes de hardware e software que podem ocorrer em qualquer lugar do seu c√≥digo. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uma discuss√£o eloquente sobre problemas de planejamento de streaming pode ser encontrada </font></font><a href="http://glyph.twistedmatrix.com/" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8.6 Intera√ß√£o</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Em aplica√ß√µes n√£o triviais, as corotinas devem interagir. M√©todos convencionais de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Python</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> podem ser usados </font><font style="vertical-align: inherit;">. Isso inclui o uso de vari√°veis ‚Äã‚Äãglobais ou a declara√ß√£o de corotinas como m√©todos de objeto: eles podem compartilhar vari√°veis ‚Äã‚Äãde inst√¢ncia. Como alternativa, um objeto mut√°vel pode ser passado como argumento para uma corotina.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O modelo de planejamento de streaming requer especialistas para garantir que as classes forne√ßam uma conex√£o segura; </font><font style="vertical-align: inherit;">em um modelo de colabora√ß√£o, isso raramente √© necess√°rio. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8.7 </font><font style="vertical-align: inherit;">Poll ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">polling</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> )</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Alguns dispositivo de hardware, tais como um aceler√≥metro </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pyboard</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , n√£o suportam as interrup√ß√µes e, portanto, devem ser consultadas (i periodicamente verificado). </font><font style="vertical-align: inherit;">A pesquisa tamb√©m pode ser usada em conjunto com manipuladores de interrup√ß√£o: o manipulador de interrup√ß√£o mant√©m o equipamento e define um sinalizador. </font><font style="vertical-align: inherit;">A corotina consulta o sinalizador - se estiver definido, os dados s√£o processados ‚Äã‚Äãe o sinalizador √© redefinido. </font><font style="vertical-align: inherit;">A melhor abordagem √© usar a classe </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Event</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt484472/">https://habr.com/ru/post/pt484472/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt484462/index.html">Scraping Github: Procurando por "segredos" para desenvolver</a></li>
<li><a href="../pt484464/index.html">Leil√µes japoneses de motocicletas, como tudo acontece</a></li>
<li><a href="../pt484466/index.html">JavaScript comum promete mat√©ria que todos deveriam saber</a></li>
<li><a href="../pt484468/index.html">A cultura corporativa vermelha √© o principal problema dos neg√≥cios russos (parte 2)</a></li>
<li><a href="../pt484470/index.html">Extens√µes Extens√≠veis em JavaScript</a></li>
<li><a href="../pt484480/index.html">A capitaliza√ß√£o das 5 maiores empresas de tecnologia dos EUA ultrapassou US $ 5 trilh√µes</a></li>
<li><a href="../pt484482/index.html">Um pequeno programa educacional sobre tratamento de √°gua</a></li>
<li><a href="../pt484484/index.html">Ubuntu n√£o √© o melhor desktop Linux</a></li>
<li><a href="../pt484486/index.html">Um computador que se recusa a morrer</a></li>
<li><a href="../pt484488/index.html">Qu√£o confuso √© um sistema qu√¢ntico? A resposta pode n√£o ser comput√°vel.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>