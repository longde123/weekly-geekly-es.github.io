<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🈯️ 🙋 🍐 Docker storage (docker root) histori masalah migrasi 😀 👨‍👧‍👧 🎩</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Tidak lebih dari beberapa hari yang lalu diputuskan pada salah satu server untuk memindahkan penyimpanan buruh pelabuhan (direktori tempat buruh pelab...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Docker storage (docker root) histori masalah migrasi</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/462013/"> Tidak lebih dari beberapa hari yang lalu diputuskan pada salah satu server untuk memindahkan penyimpanan buruh pelabuhan (direktori tempat buruh pelabuhan menyimpan semua file wadah, gambar) ke partisi terpisah, yang <br>  memiliki kapasitas lebih.  Tugas itu, tampaknya, sepele dan tidak menandakan masalah ... <br><a name="habracut"></a><br>  Mulai: <br><br>  1. Hentikan dan bunuh semua wadah aplikasi kita: <br><br><pre><code class="bash hljs">docker-compose down</code> </pre> <br>  jika ada banyak wadah, dan mereka berada dalam komposisi yang berbeda, Anda dapat melakukan ini: <br><br><pre> <code class="bash hljs">docker rm -f $(docker ps -q)</code> </pre> <br>  2. Hentikan daemon buruh pelabuhan: <br><br><pre> <code class="bash hljs">systemctl stop docker</code> </pre> <br>  3. Pindahkan direktori ke lokasi yang diinginkan: <br><br><pre> <code class="bash hljs">cp -r /var/lib/docker /docker/data/storage</code> </pre> <br>  4. Kami memberi tahu iblis dari buruh pelabuhan untuk mencari di direktori baru.  Ada beberapa opsi: gunakan flag -g untuk mengarahkan daemon ke path baru, atau konfigurasi systemd, yang kami gunakan.  Nah, atau symlink.  Saya tidak akan mengecatnya, Internet <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">penuh dengan</a> manual tentang porting root docker ke lokasi baru. <br><br>  5. Kami memulai demon docker, dan melihat bahwa itu terlihat di mana seharusnya: <br><br><pre> <code class="bash hljs">systemctl status docker</code> </pre> <br>  Di salah satu jalur output, kita akan melihat: <br><pre> <code class="bash hljs">├─19493 /usr/bin/dockerd --data-root=/docker/data/storage</code> </pre> <br>  Kami memastikan bahwa opsi tersebut diteruskan ke daemon, sekarang kami <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" class="user_link">akan</a> memeriksa apakah telah menerapkannya (terima kasih <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" class="user_link">inkvizitor68sl</a> )! <br><pre> <code class="bash hljs">docker info | awk <span class="hljs-string"><span class="hljs-string">'/Root Dir/ {print $NF}'</span></span></code> </pre> <br>  6. Kami memulai aplikasi kami: <br><pre> <code class="bash hljs">docker-compose up -d</code> </pre> <br>  7. Periksa <br><br>  Dan di sini kesenangan dimulai, DBMS, MQ, semuanya baik-baik saja!  Basisnya utuh, semuanya berfungsi ... kecuali untuk nginx.  Kami memiliki perakitan nginx kami sendiri dengan kerberos <s>dan pelacur</s> .  Dan melihat log kontainer menunjukkan bahwa ia tidak dapat menulis ke / var / tmp - Izin ditolak.  Aku meregangkan jari-jariku dengan wiski dan mencoba menganalisis situasinya ... Bagaimana itu?  Gambar buruh pelabuhan tidak berubah.  Kami baru saja memindahkan direktori.  Selalu berhasil, dan ini untuk Anda ... Demi percobaan, saya pergi ke wadah dengan pena dan mengubah hak untuk direktori ini, ada <u>root, root 755</u> , beri <u>root, root 777</u> .  Dan semuanya dimulai ... Suatu pemikiran muncul di benak saya - semacam omong kosong ... Saya pikir, yah, mungkin saya tidak memperhitungkan sesuatu ... <br><br>  Saya memutuskan bahwa kami menyukai hak akses ke file selama transfer.  Mereka menghentikan aplikasi, daemon buruh pelabuhan, menghapus direktori baru dan membuat salinan direktori / var / lib / buruh pelabuhan menggunakan <code>rsync -a</code> sudah. <br><br>  Saya pikir sekarang semuanya baik-baik saja, kami sedang menaikkan buruh pelabuhan, aplikasinya. <br><br>  III ... masalahnya tetap ... Mataku berkedut.  Saya bergegas ke konsol mesin virtual saya, di mana saya menjalankan berbagai tes, saya punya gambar nginx ini, dan saya naik ke dalam wadah, dan di sini root, root 777 hak ada di direktori / var / tmp. .  Tapi gambarnya identik! <br><br>  <u>Di mana-mana digunakan FS xfs.</u> <br><br>  Saya membandingkan melalui perintah <br><br><pre> <code class="bash hljs">docker inspect my-nginx:12345</code> </pre> <br>  Semua hash adalah identik, semua 1-1.  Baik di server dan di virtualka saya.  Saya menghapus gambar nginx lokal dan menggulung lagi dengan registri, yang karena beberapa alasan ada di mesin yang sama.  Dan masalahnya sama ... Sekarang mata kedua saya bergerak-gerak. <br><br>  Saya tidak ingat apa yang ada di pikiran saya, selain jeritan "AAAAAAA" dan hal-hal lain.  Di jalan pada jam 4 pagi, sumber buruh pelabuhan digunakan untuk memahami prinsip hashing layer gambar.  Dia membuka kaleng energi ketiga.  Dan pada akhirnya, saya sadar bahwa hashing hanya memperhitungkan file, isinya, tapi <b>BUKAN HAK AKSES</b> !  Artinya, dalam beberapa cara misterius, hak dipukuli, dan selinux dinonaktifkan, acl tidak digunakan, sedikit lengket tidak ada. <br><br>  Saya menghapus gambar lokal, juga menghapus gambar dari register buruh pelabuhan dan mulai lagi.  Dan itu berhasil.  Ternyata selama transfer hak-hak dipukuli, baik di dalam gambar lokal dan di dalam gambar yang terletak di registri.  Seperti yang saya katakan, karena beberapa alasan, ia berada di mobil yang sama.  Dan sebagai hasilnya dalam satu direktori / var / lib / docker. <br><br>  Dan mengantisipasi pertanyaan apakah mereka mencoba mengembalikan pandangan buruh pelabuhan ke katalog lama - tidak, mereka tidak, sayangnya, keadaan tidak memungkinkan.  Ya, dan benar-benar ingin mengetahuinya. <br><br>  Setelah menulis artikel ini, solusi untuk masalah tersebut tampak jelas bagi saya, tetapi pada saat analisis sepertinya tidak begitu.  Saya jujur ​​googled, dan tidak menemukan situasi yang sama. <br><br>  Intinya: Saya memecahkan masalah, saya tidak mengerti alasannya = ( <br><br>  Jika seseorang tahu / menebak / memiliki visi tentang kemungkinan penyebab masalah ini - saya akan sangat senang melihat Anda di komentar! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id462013/">https://habr.com/ru/post/id462013/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id462003/index.html">Bagaimana saya memposting PWA di Svelte di Google Play</a></li>
<li><a href="../id462005/index.html">Fitur Google PageSpeed: peningkatan peringkat situs dan peringkat pencarian</a></li>
<li><a href="../id462007/index.html">Mengembangkan skrip Python yang kuat</a></li>
<li><a href="../id462009/index.html">Tren pemrograman: apa yang bisa diharapkan pada tahun 2020?</a></li>
<li><a href="../id462011/index.html">Layanan geoser web. Ikhtisar solusi modern</a></li>
<li><a href="../id462015/index.html">Alam semesta pelaporan SAP</a></li>
<li><a href="../id462021/index.html">Bagaimana cara berhenti melakukan hal yang sama</a></li>
<li><a href="../id462023/index.html">Cascadeur: Masa Depan Animasi Game</a></li>
<li><a href="../id462025/index.html">Model data jaringan relasional</a></li>
<li><a href="../id462027/index.html">Bagaimana Dark Menyebarkan Kode 50ms</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>