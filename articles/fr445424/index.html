<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üåà üôåüèª üßìüèø Exp√©rience dans le d√©veloppement du service Refund Tool avec une API asynchrone sur Kafka üë®üèª‚Äçüíª ü§¥üèª üëåüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Qu'est-ce qui peut faire qu'une grande entreprise comme Lamoda avec un processus rationalis√© et des dizaines de services interconnect√©s change consid√©...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Exp√©rience dans le d√©veloppement du service Refund Tool avec une API asynchrone sur Kafka</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/445424/"> Qu'est-ce qui peut faire qu'une grande entreprise comme Lamoda avec un processus rationalis√© et des dizaines de services interconnect√©s change consid√©rablement l'approche?  La motivation peut √™tre compl√®tement diff√©rente: du l√©gislatif au d√©sir inh√©rent √† tous les programmeurs d'exp√©rimenter. <br><br>  Mais cela ne signifie pas du tout que l'on ne peut pas compter sur des avantages suppl√©mentaires.  Que peut-on gagner exactement si vous impl√©mentez l'API √©v√©nementielle sur Kafka, dira Sergey Zaika ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">fewald</a> ).  Il y aura certainement aussi des bosses farcies et des d√©couvertes int√©ressantes - une exp√©rience ne peut pas s'en passer. <br><br><img src="https://habrastorage.org/webt/kq/o2/ye/kqo2yemmmu-wiqi9vtpcrbolroq.png"><br><br>  <em>Avertissement: Cet article est bas√© sur les mat√©riaux du mitap que Sergey a organis√© en novembre 2018 sur HighLoad ++.</em>  <em>L'exp√©rience en direct de Lamoda avec Kafka a attir√© des auditeurs pas moins que d'autres reportages d'horaires.</em>  <em>Il nous semble que c'est un excellent exemple du fait qu'il est toujours possible et n√©cessaire de trouver des personnes partageant les m√™mes id√©es, et les organisateurs de HighLoad ++ continueront √† essayer de cr√©er une atmosph√®re propice √† cela.</em> <br><a name="habracut"></a><br><h2>  √Ä propos du processus </h2><br>  Lamoda est une grande plateforme de commerce √©lectronique qui a son propre centre de contact, un service de livraison (et de nombreux affili√©s), un studio photo, un immense entrep√¥t et tout fonctionne sur son logiciel.  Il existe des dizaines de modes de paiement, des partenaires B2B qui peuvent utiliser tout ou partie de ces services et souhaitent conna√Ætre les derni√®res informations sur leurs produits.  De plus, Lamoda op√®re dans trois pays en plus de la F√©d√©ration de Russie et tout y est un peu diff√©rent.  Au total, il existe probablement plus d'une centaine de fa√ßons de configurer une nouvelle commande, qui doit √™tre trait√©e √† sa mani√®re.  Tout cela fonctionne avec l'aide de dizaines de services qui communiquent parfois de mani√®re non √©vidente.  Il existe √©galement un syst√®me central dont la principale responsabilit√© est le statut des commandes.  Nous l'appelons BOB, je travaille avec elle. <br><br><h2>  Outil de remboursement avec API pilot√©e par les √©v√©nements </h2><br>  Le mot √©v√©nementiel est assez galvaud√©, un peu plus loin nous d√©finirons plus en d√©tail ce que l'on entend par l√†.  Je vais commencer par le contexte dans lequel nous avons d√©cid√© d'essayer l'approche API √©v√©nementielle de Kafka. <br><br><img src="https://habrastorage.org/webt/8y/0i/kp/8y0ikp8ebxzglwhw1s-dhrubivw.png"><br><br>  Dans n'importe quel magasin, en plus des commandes pour lesquelles les clients paient, il y a des moments o√π le magasin est tenu de retourner de l'argent, car le produit ne convenait pas au client.  Ce processus relativement court: nous clarifions les informations, s'il y a un tel besoin, et transf√©rons l'argent. <br><br>  Mais le retour a √©t√© compliqu√© en raison de modifications de la l√©gislation, et nous avons d√ª mettre en place un microservice distinct pour cela. <br><br><img src="https://habrastorage.org/webt/nn/_x/xr/nn_xxr2xlqfpn-kmgc5y4rzj9a8.png"><br><br>  Notre motivation: <br><br><ol><li>  <strong>Loi FZ-54</strong> - bri√®vement, la loi vous oblige √† faire rapport au bureau des imp√¥ts sur chaque transaction mon√©taire, que ce soit un remboursement ou un re√ßu, dans un SLA assez court en quelques minutes.  Nous, en tant que e-commerce, effectuons pas mal d'op√©rations.  Techniquement, cela signifie une nouvelle responsabilit√© (et donc un nouveau service) et des am√©liorations dans tous les syst√®mes impliqu√©s. </li><li>  <strong>Division BOB</strong> - projet interne de l'entreprise visant √† d√©barrasser BOB d'un grand nombre de responsabilit√©s non essentielles et √† r√©duire sa complexit√© globale. </li></ol><br><img src="https://habrastorage.org/webt/u7/k8/7x/u7k87xo4jzxcjmoeanxdzhy_yag.png"><br><br>  Ce diagramme illustre les principaux syst√®mes Lamoda.  Maintenant, la plupart d'entre eux ressemblent davantage √† une <strong>constellation de 5 √† 10 microservices autour d'un monolithe d√©croissant</strong> .  Ils grandissent lentement, mais nous essayons de les r√©duire, car il est effrayant de d√©ployer le fragment mis en √©vidence au milieu - on ne peut pas le laisser tomber.  Tous les √©changes (fl√®ches) que nous sommes oblig√©s de r√©server et reposent sur le fait que l'un d'eux peut √™tre indisponible. <br><br>  Il y a aussi pas mal d'√©changes en BOB: paiement, livraison, syst√®mes de notification, etc. <br><br>  Techniquement, BOB c'est: <br><br><ul><li>  ~ 150k lignes de code + ~ 100k lignes de tests; </li><li>  php7.2 + Zend 1 &amp; Symfony Components 3; </li><li>  &gt; 100 API et ~ 50 int√©grations sortantes; </li><li>  4 pays avec leur propre logique m√©tier. </li></ul><br>  Le d√©ploiement de BOB est co√ªteux et douloureux, la quantit√© de code et les t√¢ches qu'il r√©sout sont telles que personne ne peut le mettre dans leur t√™te.  En g√©n√©ral, il existe de nombreuses raisons de le simplifier. <br><br><h2>  Processus de retour </h2><br>  Initialement, deux syst√®mes sont impliqu√©s dans le processus: BOB et Paiement.  Maintenant, deux autres apparaissent: <br><br><ul><li>  Service de fiscalisation, qui s'occupera des probl√®mes de fiscalisation et de communication avec les services externes. </li><li>  Outil de remboursement, dans lequel de nouveaux √©changes sont simplement retir√©s afin de ne pas gonfler le BOB. </li></ul><br>  Maintenant, le processus ressemble √† ceci: <br><br><img src="https://habrastorage.org/webt/pe/e6/0q/pee60qj1tdefewqgdaw22bww-ag.png"><br><br><ol><li>  BOB re√ßoit une demande de remboursement. </li><li>  BOB parle de cet outil de remboursement. </li><li>  L'outil de remboursement indique Paiement: "R√©cup√©rez l'argent". </li><li>  Le paiement renvoie l'argent. </li><li>  L'outil de remboursement et BOB synchronisent les statuts l'un avec l'autre, car pour le moment, ils en ont tous les deux besoin.  Nous ne sommes pas encore pr√™ts √† passer enti√®rement √† l'outil de remboursement, car BOB a une interface utilisateur, des rapports pour la comptabilit√© et g√©n√©ralement beaucoup de donn√©es que vous ne pouvez pas facilement transf√©rer.  Nous devons nous asseoir sur deux chaises. </li><li>  La demande de fiscalisation part. </li></ol><br>  En cons√©quence, nous avons fait une sorte de bus d'√©v√©nement sur Kafka - un bus d'√©v√©nement, sur lequel tout a commenc√©.  Hourra, nous avons maintenant un seul point d'√©chec (sarcasme). <br><br><img src="https://habrastorage.org/webt/8k/zg/qc/8kzgqcfju7ybv8imzajjjykpz10.png"><br><br>  Les avantages et les inconv√©nients sont assez √©vidents.  Nous avons fait un bus, alors maintenant tous les services en d√©pendent.  Cela simplifie la conception, mais introduit un point de d√©faillance unique dans le syst√®me.  Kafka tombera, le processus augmentera. <br><br><h2>  Qu'est-ce qu'une API √©v√©nementielle </h2><br>  Une bonne r√©ponse √† cette question se trouve dans le rapport de Martin Fowler (GOTO 2017) <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">"Les nombreuses significations de l'architecture √©v√©nementielle"</a> . <br><br>  En bref, ce que nous avons fait: <br><br><ol><li>  Envelopp√© tous les √©changes asynchrones via le <strong>stockage des √©v√©nements</strong> .  Au lieu d'informer chaque consommateur int√©ress√© du changement d'√©tat via le r√©seau, nous √©crivons un √©v√©nement de changement d'√©tat dans le r√©f√©rentiel centralis√©, et les consommateurs int√©ress√©s par le sujet lisent tout ce qui appara√Æt √† partir de l√†. </li><li>  Un √©v√©nement dans ce cas est une notification ( <strong>notifications</strong> ) que quelque chose a chang√© quelque part.  Par exemple, le statut de la commande a chang√©.  Un consommateur qui est int√©ress√© par une sorte de donn√©es accompagnant le changement de statut et qui ne figure pas dans la notification peut d√©couvrir lui-m√™me son statut. </li><li>  L'option maximale est un sourcing d'√©v√©nements √† part enti√®re, <strong>un transfert d'√©tat</strong> , dans lequel l'√©v√©nement contient toutes les informations n√©cessaires au traitement: d'o√π et vers quel statut avez-vous chang√©, comment les donn√©es ont-elles chang√©, etc. La seule question est de savoir si cela vaut la peine et combien d'informations vous pouvez vous permettre de stocker. </li></ol><br>  Dans le cadre du lancement de l'outil de remboursement, nous avons utilis√© la troisi√®me option.  Cela a simplifi√© le traitement des √©v√©nements, car il n'√©tait pas n√©cessaire d'obtenir des informations d√©taill√©es, et il a √©galement exclu le sc√©nario lorsque chaque nouvel √©v√©nement g√©n√®re une vague de clarification des demandes d'obtention des consommateurs. <br><br>  Le service Refund Tool n'est <strong>pas charg√©</strong> , donc Kafka ressemble plus √† un test au stylo qu'√† une n√©cessit√©.  Je ne pense pas que si le service de remboursement devenait un projet √† forte charge, l'entreprise serait heureuse. <br><br><h4>  √âchange asynchrone TEL QUEL </h4><br>  Pour les √©changes asynchrones, le d√©partement PHP utilise g√©n√©ralement RabbitMQ.  Nous avons collect√© les donn√©es de la demande, les avons plac√©es dans la file d'attente et le consommateur du m√™me service les a lues et envoy√©es (ou ne les a pas envoy√©es).  Pour l'API elle-m√™me, Lamoda utilise activement Swagger.  Nous concevons l'API, la d√©crivons dans Swagger, g√©n√©rons du code client et serveur.  Nous utilisons √©galement un JSON RPC 2.0 l√©g√®rement avanc√©. <br><br>  Ici et l√†, des bus esb sont utilis√©s, quelqu'un vit sur activeMQ, mais, en g√©n√©ral, <strong>RabbitMQ est la norme</strong> . <br><br><h4>  √âchange asynchrone √Ä √äTRE </h4><br>  Lors de la conception d'un √©change via un bus d'√©v√©nements, une analogie est trac√©e.  Nous d√©crivons √©galement l'√©change futur de donn√©es √† travers des descriptions de structure d'√©v√©nements.  Le format yaml, la g√©n√©ration de code devait √™tre faite par nous-m√™mes, le g√©n√©rateur cr√©e le DTO selon les sp√©cifications et enseigne aux clients et aux serveurs comment travailler avec eux.  La g√©n√©ration se fait en deux langues - <strong>golang et php</strong> .  Cela maintient les biblioth√®ques coh√©rentes.  Le g√©n√©rateur est √©crit en golang, pour lequel il a re√ßu le nom de gogi. <br><br>  Le sourcing d'√©v√©nements chez Kafka est une chose typique.  Il existe une solution √† partir de la version d'entreprise principale de Kafka Confluent, il y a le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">nakadi</a> , une solution de nos "fr√®res" dans la zone du domaine Zalando.  Notre <strong>motivation pour commencer avec vanilla Kafka</strong> est de laisser la solution gratuite jusqu'√† ce que nous d√©cidions finalement de l'utiliser ou non partout, et de laisser √©galement une marge de man≈ìuvre et d'am√©liorations: nous voulons la prise en charge de notre <strong>JSON RPC 2.0</strong> , g√©n√©rateurs pour deux langues, et voir quoi d'autre. <br><br>  Il est ironique que m√™me dans un cas aussi heureux, quand il y a une entreprise similaire √† Zalando, qui a pris une d√©cision similaire, nous ne pouvons pas l'utiliser efficacement. <br><br>  Sur le plan architectural, au d√©marrage, le mod√®le est le suivant: lire directement depuis Kafka, mais √©crire uniquement via le bus d'√©v√©nements.  Il y a beaucoup de pr√™t √† lire dans Kafka: courtiers, √©quilibreurs et il est plus ou moins pr√™t pour la mise √† l'√©chelle horizontale, je voulais le garder.  L'enregistrement, nous voulions passer par une passerelle, alias Events-bus, et c'est pourquoi. <br><br><h3>  Ev√©nements-bus </h3><br>  Ou un bus √©v√©nementiel.  Il s'agit simplement d'une passerelle http sans √©tat qui joue plusieurs r√¥les importants: <br><br><ul><li>  <strong>Validation de la production</strong> - nous v√©rifions que les √©v√©nements r√©pondent √† nos sp√©cifications. </li><li>  <strong>Un syst√®me ma√Ætre d'√©v√©nements</strong> , c'est-√†-dire qu'il est le seul et principal syst√®me de l'entreprise √† r√©pondre √† la question de savoir quels √©v√©nements avec quelles structures sont consid√©r√©s comme valides.  La validation inclut simplement les types de donn√©es et les √©num√©rations pour une sp√©cification stricte du contenu. </li><li>  <strong>La fonction de</strong> hachage pour le partitionnement - la structure du message de Kafka est une valeur-cl√©, et ici elle est calcul√©e par le hachage de la cl√© o√π le mettre. </li></ul><br><h3>  Pourquoi </h3><br>  Nous travaillons dans une grande entreprise avec un processus rationalis√©.  Pourquoi changer quelque chose?  <strong>Il s'agit d'une exp√©rience</strong> et nous nous attendons √† obtenir plusieurs avantages. <br><br><h4>  1: n + 1 √©changes (un √† plusieurs) </h4><br>  Avec Kafka, il est tr√®s facile de connecter de nouveaux consommateurs √† l'API. <br><br>  Supposons que vous ayez un r√©pertoire qui doit √™tre tenu √† jour dans plusieurs syst√®mes √† la fois (et dans certains nouveaux).  Auparavant, nous avions invent√© un bundle qui impl√©mentait un set-API, et les adresses des consommateurs √©taient signal√©es au syst√®me ma√Ætre.  Maintenant, le syst√®me ma√Ætre envoie des mises √† jour sur le sujet et √† tous ceux qui souhaitent lire.  Un nouveau syst√®me est apparu - ils l'ont sign√© sur le sujet.  Oui, √©galement en bundle, mais plus simple. <br><br>  Dans le cas de l'outil de remboursement, qui est un morceau de BOB, il est pratique pour nous de les garder synchronis√©s via Kafka.  Le paiement dit qu'ils ont rendu l'argent: BOB, RT l'a d√©couvert, a chang√© de statut, le service de fiscalisation l'a d√©couvert et a fait un ch√®que. <br><br><img src="https://habrastorage.org/webt/x1/rs/gx/x1rsgx9mbceqzstdmcsg_hapnbs.png"><br><br>  Nous avons l'intention de cr√©er un service de notifications unique, qui informerait le client des nouvelles de sa commande / retours.  Cette responsabilit√© est d√©sormais r√©partie entre les syst√®mes.  Il nous suffira d'enseigner au service de notifications comment intercepter et r√©pondre aux informations pertinentes de Kafka (et d√©sactiver ces notifications dans d'autres syst√®mes).  Aucun nouvel √©change direct ne sera n√©cessaire. <br><br><h4>  Ax√© sur les donn√©es </h4><br>  Les informations entre les syst√®mes deviennent transparentes - quelle que soit l'entreprise sanglante que vous avez et √† quel point votre carnet de commandes est gonfl√©.  Lamoda dispose d'un d√©partement Data Analytics qui collecte des donn√©es sur les syst√®mes et les met sous une forme r√©utilisable, √† la fois pour les entreprises et pour les syst√®mes intelligents.  Kafka vous permet de leur fournir rapidement un grand nombre de donn√©es et de maintenir ce flux d'informations √† jour. <br><br><h4>  Journal de r√©plication </h4><br>  Les messages ne disparaissent pas apr√®s la lecture, comme dans RabbitMQ.  Lorsque l'√©v√©nement contient suffisamment d'informations pour le traitement, nous avons un historique des modifications r√©centes apport√©es √† l'objet et, si vous le souhaitez, la possibilit√© d'appliquer ces modifications. <br><br>  La p√©riode de stockage du journal de r√©plication d√©pend de l'intensit√© de l'√©criture sur ce sujet. Kafka vous permet de d√©finir de mani√®re flexible des limites de temps de stockage et de volume de donn√©es.  Pour les sujets intensifs, il est important que tous les consommateurs aient le temps de lire les informations avant qu'elles ne disparaissent, m√™me en cas d'inop√©rabilit√© √† court terme.  Il s'av√®re g√©n√©ralement stocker des donn√©es pour des <strong>unit√©s de jours</strong> , ce qui est assez suffisant pour le support. <br><br><img src="https://habrastorage.org/webt/xz/6-/59/xz6-59a1z7vrszrmoowvswxauqc.png"><br><br>  Puis un peu de r√©cit de la documentation, pour ceux qui ne connaissent pas Kafka (la photo est aussi de la documentation) <br><br>  Il y a des files d'attente dans AMQP: nous √©crivons des messages dans la file d'attente pour le consommateur.  En r√®gle g√©n√©rale, une file d'attente est trait√©e par un syst√®me avec la m√™me logique m√©tier.  Si vous devez notifier plusieurs syst√®mes, vous pouvez apprendre √† l'application √† √©crire dans plusieurs files d'attente ou √† configurer l'√©change avec le m√©canisme de fanout, qui les clone lui-m√™me. <br><br>  Kafka a une abstraction de <em>sujet</em> similaire dans laquelle vous √©crivez des messages, mais ils ne disparaissent pas apr√®s la lecture.  Par d√©faut, lorsque vous vous connectez √† Kafka, vous recevez tous les messages et en m√™me temps, vous avez la possibilit√© de sauvegarder l'endroit o√π vous vous √©tiez arr√™t√©.  Autrement dit, vous lisez de mani√®re s√©quentielle, vous ne pouvez pas marquer le message comme lu, mais enregistrer l'identifiant, √† partir duquel ensuite continuer la lecture.  L'ID auquel vous vous arr√™tez s'appelle offset, et le m√©canisme est commit offset. <br><br>  En cons√©quence, une logique diff√©rente peut √™tre mise en ≈ìuvre.  Par exemple, nous avons BOB dans 4 cas pour diff√©rents pays - Lamoda est en Russie, au Kazakhstan, en Ukraine, en Bi√©lorussie.  Puisqu'ils sont d√©ploy√©s s√©par√©ment, ils ont un peu leurs propres configurations et leur propre logique m√©tier.  Dans le message, nous indiquons de quel pays il s'agit.  Chaque consommateur BOB dans chaque pays lit avec diff√©rents groupId, et si le message ne s'applique pas √† lui, sautez-le, c'est-√†-dire  validez imm√©diatement l'offset +1.  Si le m√™me sujet est lu par notre service de paiement, il le fait avec un groupe distinct et, par cons√©quent, le d√©calage ne se chevauche pas. <br><br>  <b>Exigences de l'√©v√©nement:</b> <br><br><ul><li>  <strong>Exhaustivit√© des donn√©es.</strong>  Je souhaite qu'il y ait suffisamment de donn√©es dans l'√©v√©nement pour qu'elles puissent √™tre trait√©es. </li></ul><br><ul><li>  <strong>Int√©grit√©</strong>  Nous d√©l√©guons le bus d'√©v√©nements pour v√©rifier que l'√©v√©nement est coh√©rent et qu'il peut le g√©rer. </li><li>  <strong>L'ordre est important.</strong>  En cas de retour, nous sommes oblig√©s de travailler avec l'histoire.  Avec les notifications, la commande n'est pas importante, s'il s'agit de notifications homog√®nes, l'e-mail sera le m√™me quelle que soit la commande arriv√©e en premier.  Dans le cas d'un retour, il existe un processus clair, si vous modifiez la commande, il y aura des exceptions, le remboursement ne sera pas cr√©√© ou trait√© - nous nous retrouverons dans un statut diff√©rent. </li><li>  <strong>Coh√©rence.</strong>  Nous avons un r√©f√©rentiel, et maintenant au lieu de l'API, nous cr√©ons des √©v√©nements.  Nous avons besoin d'un moyen de transf√©rer rapidement et √† moindre co√ªt des informations sur de nouveaux √©v√©nements et des changements sur des √©v√©nements existants √† nos services.  Ceci est r√©alis√© en utilisant une sp√©cification commune dans un r√©f√©rentiel git s√©par√© et des g√©n√©rateurs de code.  Par cons√©quent, les clients et les serveurs de diff√©rents services sont coordonn√©s avec nous. </li></ul><br><h2>  Kafka in Lamoda </h2><br>  Nous avons trois installations Kafka: <br><br><ol><li>  Journaux </li><li>  R&amp;D; </li><li>  Ev√©nements-bus. </li></ol><br>  Aujourd'hui, nous ne parlons que du dernier point.  Dans les √©v√©nements-bus, nous n'avons pas de tr√®s grandes installations - 3 courtiers (serveurs) et un total de 27 sujets.  En r√®gle g√©n√©rale, un sujet est un processus.  Mais c'est un moment d√©licat, et nous allons maintenant y revenir. <br><br><img src="https://habrastorage.org/webt/1v/5s/nj/1v5snjoqmrg2sb1grok5snkzowu.png"><br><br>  Ci-dessus est le graphique rps.  Le processus de remboursement est marqu√© d'une ligne turquoise (oui, celle situ√©e sur l'axe X), et le rose est le processus de mise √† jour du contenu. <br><br>  Le catalogue de Lamoda contient des millions de produits et les donn√©es sont constamment mises √† jour.  Certaines collections se d√©modent, de nouvelles sortent √† leur place, de nouveaux mod√®les apparaissent constamment dans le catalogue.  Nous essayons de pr√©dire ce qui sera int√©ressant pour nos clients demain, alors nous achetons constamment de nouvelles choses, les photographions et mettons √† jour la fen√™tre. <br><br>  Les pics roses sont une mise √† jour du produit, c'est-√†-dire des changements de produits.  On peut voir que les gars ont pris des photos, pris des photos, et puis encore!  - t√©l√©charg√© un paquet d'√©v√©nements. <br><br><h2>  Cas d'utilisation de Lamoda Events </h2><br>  Nous utilisons l'architecture construite pour de telles op√©rations: <br><br><ul><li>  <strong>Suivi des statuts de retour</strong> : appel √† l'action et suivi des statuts de tous les syst√®mes impliqu√©s.  Paiement, statuts, fiscalisation, notifications.  Ici, nous avons test√© l'approche, cr√©√© les outils, collect√© tous les bogues, r√©dig√© la documentation et expliqu√© √† nos coll√®gues comment l'utiliser. </li><li>  <strong>Mise √† jour des fiches produits:</strong> configuration, m√©tadonn√©es, caract√©ristiques.  Un syst√®me lit (qui s'affiche) et plusieurs √©crivent. </li><li>  <strong>Email, push et sms</strong> : la commande est collect√©e, la commande est arriv√©e, le retour a √©t√© accept√©, etc., beaucoup d'entre eux. </li><li>  <strong>Stock, mise √† jour de l'entrep√¥t</strong> - une mise √† jour quantitative des articles, juste des chiffres: r√©ception √† l'entrep√¥t, retour.  Il est n√©cessaire que tous les syst√®mes li√©s √† la r√©servation de marchandises fonctionnent avec les donn√©es les plus pertinentes.  Maintenant que le syst√®me de mise √† niveau du drain est assez compliqu√©, Kafka le simplifiera. </li><li>  <strong>Analyse des donn√©es</strong> (d√©partement R&amp;D), outils ML, analyse, statistiques.  Nous voulons que les informations soient transparentes - car ce Kafka est bien adapt√©. </li></ul><br>  Maintenant, la partie la plus int√©ressante concerne les c√¥nes farcis et les d√©couvertes int√©ressantes qui ont eu lieu pendant six mois. <br><br><h2>  Probl√®mes de conception </h2><br>  Supposons que nous voulions faire quelque chose de nouveau - par exemple, transf√©rer l'ensemble du processus de livraison √† Kafka.  Une partie du processus est maintenant impl√©ment√©e dans le traitement des commandes dans BOB.  Derri√®re le transfert de la commande au service de livraison, le transfert vers un entrep√¥t interm√©diaire, etc., il y a un mod√®le de statut.  Il y a tout un monolithe, m√™me deux, plus un tas d'API de livraison.  Ils en savent beaucoup plus sur la livraison. <br><br>  Il semble que ce soient des domaines similaires, mais pour le traitement des commandes dans le BOB et pour le syst√®me de livraison, les statuts sont diff√©rents.  Par exemple, certains services de messagerie n'envoient pas de statuts interm√©diaires, mais uniquement des statuts d√©finitifs: ¬´livr√©s¬ª ou ¬´perdus¬ª.  D'autres, au contraire, rendent compte en d√©tail de la circulation des marchandises.  Chacun a ses propres r√®gles de validation: pour quelqu'un, l'e-mail est valide, il sera donc trait√©;  pour d'autres, ce n'est pas valable, mais la commande sera toujours trait√©e, car il y a un t√©l√©phone pour la communication, et quelqu'un dira qu'une telle commande ne sera pas trait√©e du tout. <br><br><h3>  Flux de donn√©es </h3><br>  Dans le cas de Kafka, se pose la question de l'organisation du flux de donn√©es.  Cette t√¢che est li√©e au choix de la strat√©gie pour plusieurs points, nous les passerons tous en revue. <br><br><h4>  Dans un sujet ou dans un autre? </h4><br>  Nous avons une sp√©cification d'√©v√©nement.  Dans BOB, nous √©crivons qu'une telle commande doit √™tre livr√©e et indiquons: le num√©ro de commande, sa composition, certains SKU et codes √† barres, etc.  Lorsque les marchandises arrivent √† l'entrep√¥t, la livraison pourra recevoir les statuts, les horodatages et tout ce qui est n√©cessaire.  Mais nous souhaitons en outre recevoir des mises √† jour sur ces donn√©es dans BOB.  Nous sommes confront√©s au processus inverse d'obtention des donn√©es √† la livraison.  S'agit-il du m√™me √©v√©nement?  Ou s'agit-il d'un √©change s√©par√© qui m√©rite un sujet distinct? <br><br>  Tr√®s probablement, ils seront tr√®s similaires, et la tentation de faire un sujet n'est pas d√©raisonnable, car un sujet s√©par√© est des consommateurs distincts, des configurations distinctes, une g√©n√©ration distincte de tout cela.  Mais pas un fait. <br><br><h4>  Nouveau domaine ou nouvel √©v√©nement? </h4><br>  Mais si vous utilisez les m√™mes √©v√©nements, un autre probl√®me se pose.  Par exemple, tous les syst√®mes de livraison ne peuvent pas g√©n√©rer un DTO capable de g√©n√©rer des BOB.  Nous leur envoyons un identifiant, mais ils ne les enregistrent pas, car ils n'en ont pas besoin, et du point de vue du d√©marrage du processus de bus d'√©v√©nements, ce champ est obligatoire. <br><br>  Si nous introduisons une r√®gle pour le bus d'√©v√©nements selon laquelle ce champ est obligatoire, nous sommes oblig√©s de d√©finir des r√®gles de validation suppl√©mentaires dans le BOB ou dans le gestionnaire d'√©v√©nements de d√©marrage.  La validation commence √† se glisser sur le service - ce n'est pas tr√®s pratique. <br><br>    ‚Äî    .  ,   -   , ,  ,   ,      .       ‚Äî   .   ‚Äî    ,    .        JSON      . <br><br>   refunds        .     -,   refund update,     type, ,     update .      ¬´¬ª   ,  ,        type. <br><br><h4>   </h4><br>     Kafka   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Avro</a> ,          Confluent.        .        replication log,    ¬´¬ª.  ,    ,     : ,    .    ,     ,   ,    . <br><br><h4>    partitions </h4><br>   Kafka   partitions.          ,  ,  ,     . <br><br>       Kafka  .     partition,        .       . , ,    ,      .  , ,  ,    Kafka   partition,  Kafka       ‚Äî  ,  . <br><br>  Kafka  ?      (    JSON)   key.      -,   ,   partition  . <br><br>     refunds  ,     partition,   ,           . - ,            partition. <br><br><h4> Events vs commands </h4><br>    ,    . Event ‚Äî   :  ,  - -  (something_happened), , item    refund.    - ,   ¬´item ¬ª  refund  ,  ¬´ refund¬ª  -  . <br><br>  ,    ,        ‚Äî    ,   -  .     something_happened (item_canceled, refund_refunded),  something_should_be_done. , item   . <br><br>   ,  ,    .   ,        .   ,      do_something.     ,    - ;   ,   ;    ,   -,   -  .   ,    do_something,    ,   . <br><br><img src="https://habrastorage.org/webt/gy/xo/vm/gyxovmgvxv3wbwkv_k7mzluobls.png"><br><br>     RabbitMQ,    ,   http,    response ‚Äî  ,    .     Kafka,  ,     Kafka,   ,   ,    . <br><br>             ,    - ,  -       .    ,  , -   . ,     ¬´item_ready_to_refund¬ª,  ,  refund ,   ,    ¬´money_refunded¬ª.    ,   . <br><br><h3>  Nuances </h3><br>    :      ,    -  ,  ,     .   <strong>  </strong> ,  offset ,   . <br><br>    ,   ,     .    ,        events-bus,        ,         PostgreSQL,        MySQL  UNSIGNED INT,      PostgreSQL   INT.     ,  Id  . Symfony   . , ,  ,     ,     offset,       ,     .        ,  Symfony     ,          offset. <br><br> -    ‚Äî  ,  Kafka    ,    .       .  . <br><br>  Kafka    tooling   offset.    ,     ‚Äî      ,     , redeployments.   Kafka  tooling   offset,   . <br><br>   ‚Äî <strong>replication log vs rdkafka.so</strong> ‚Äî     .   PHP,   PHP,  ,  ,   Kafka   rdkafka.so,    - .  ,    ,  ,        - .  ,   . <br><br>      partitions,     <strong>consumers &gt;= topic partitions</strong> .       ,   .        ,      partitions.  ,      partition,    20  ,    ,     . ,     ,    partitions. <br><br><h2>  Suivi </h2><br> ,  ,   ,   ,      . <br><br> , ,       , , ,       ,        .   Kafka    ,       . ,         . <br><br><img src="https://habrastorage.org/webt/il/on/va/ilonvaqqf3tkfcv9reuyezxpgoq.png"><br><br>  ,  ,    ,   events-bus ,     . ,     Refund Tool  ,   BOB  -  ( ). <br><br><img src="https://habrastorage.org/webt/i4/9b/jf/i49bjfsr_lrypwz0_1qfkhhmcjq.png"><br><br>    consumer-group lag.  ,    .       ,     0,      . Kafka    ,     . <br><br>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Burrow</a> ,       Kafka.    API  consumer-group  ,     .    Failed   warning,    ,         ‚Äî    ,  .   ,   . <br><br><img src="https://habrastorage.org/webt/4j/ht/go/4jhtgoqjn_0kdgvagxkg3flceng.png"><br><br>     API.   bob-live-fifa, partition refund.update.v1,  , lag 0 ‚Äî   offset -. <br><br><img src="https://habrastorage.org/webt/mh/gn/aq/mhgnaq2qcxamaejf1fkdkkkqnwu.png"><br><br>  <strong>updated_at SLA (stuck)</strong>   . ,    ,     .   Cron,  ,    5       refund (       ),  -    ,      .    Cron,    ,     0,   . <br><br> <b> ,   , </b> : <br><br><ul><li>    ; </li><li>    ; </li><li>     . </li></ul><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il semblerait que l'article ait un sujet tr√®s sp√©cifique - l'API asynchrone sur Kafka, mais √† ce sujet, je veux recommander imm√©diatement beaucoup de choses. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Premi√®rement, le prochain </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HighLoad ++</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ne devrait pas √™tre attendu avant novembre, √† Saint-P√©tersbourg il y aura sa version, et en juin nous parlerons de charges √©lev√©es √† Novossibirsk. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deuxi√®mement, l'auteur du rapport, Sergey Zaika, est membre du comit√© de programme de notre nouvelle conf√©rence KnowledgeConf sur </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> gestion des </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">connaissances</font></a><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">La conf√©rence est d'une journ√©e, elle se tiendra le 26 avril, mais son programme est tr√®s mouvement√©. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Et en mai, il y aura </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP Russie</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RIT ++</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (avec DevOpsConf inclus) - vous pouvez toujours sugg√©rer votre propre sujet, parler de votre exp√©rience et vous plaindre de vos bosses farcies.</font></font></blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr445424/">https://habr.com/ru/post/fr445424/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr445414/index.html">Comment les livres de science sovi√©tiques sont devenus un artefact parmi les physiciens et les ing√©nieurs en Inde</a></li>
<li><a href="../fr445416/index.html">Pourquoi les disques vinyle survivent √† l'√®re num√©rique</a></li>
<li><a href="../fr445418/index.html">Homo sapiens? Plus</a></li>
<li><a href="../fr445420/index.html">Il y a 17 milliards d'ordinateurs dans le cortex de votre cerveau</a></li>
<li><a href="../fr445422/index.html">Quels langages de programmation sont les moins s√©curis√©s?</a></li>
<li><a href="../fr445426/index.html">Optimisation pour l'application PostgreSQL servant des Rails</a></li>
<li><a href="../fr445428/index.html">Wi-Fi de haute qualit√© - la base de l'hospitalit√© moderne et le moteur des affaires</a></li>
<li><a href="../fr445432/index.html">Gestionnaire de packages Unity</a></li>
<li><a href="../fr445434/index.html">Meilleur pire travail au monde: √† la recherche d'un Habraautor</a></li>
<li><a href="../fr445436/index.html">Recyclage dans DevOps - √† quoi vous pr√©parer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>