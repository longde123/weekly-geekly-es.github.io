<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üå¨Ô∏è üë®üèæ‚Äçüè´ üíÇ GLSL: ¬øCentro o centroide? O cuando los sombreadores atacan üë®üèΩ‚Äç‚úàÔ∏è üë©üèº‚Äçüé§ üë®üèΩ‚ÄçüöÄ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Al modificar el sombreador para el pr√≥ximo juego, me encontr√© con un artefacto desagradable que solo se manifiesta cuando el hardware MSAA est√° encend...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>GLSL: ¬øCentro o centroide? O cuando los sombreadores atacan</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/434046/">  Al modificar el sombreador para el pr√≥ximo juego, me encontr√© con un artefacto desagradable que solo se manifiesta cuando el hardware MSAA est√° encendido.  En la captura de pantalla del paisaje puede ver algunos p√≠xeles demasiado brillantes.  Los valores de color en varios de ellos fueron tan grandes que despu√©s de florecer, se convirtieron en "fantasmas" multicolores. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ta/gx/zy/tagxzyrj4t5z9godohkp1fgteya.png" alt="imagen"></div><br>  Les traigo a su atenci√≥n una traducci√≥n de un art√≠culo que explica en detalle la raz√≥n de este fen√≥meno y la forma de tratarlo. <br><a name="habracut"></a><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/526/948/f51/526948f51e45bbb855518c2cdf292d0e.jpg" alt="imagen"></div><br>  <i>Figura 1 - Im√°genes correctas (izquierda) e incorrectas (derecha).</i>  <i>Presta atenci√≥n a la barra amarilla en el borde izquierdo de la imagen "incorrecta".</i>  <i>Aunque la variable myMixer var√≠a de 0 a 1, de alguna manera va m√°s all√° de este rango en la imagen "incorrecta".</i> <br><br>  Considere un sombreador de fragmentos simple con una transformaci√≥n no lineal simple: <br><br><pre><code class="plaintext hljs">smooth in float myMixer; //      . //  sqrt    . void main( void ) { const vec3 blue = vec3( 0.0, 0.0, 1.0 ); const vec3 yellow = vec3( 1.0, 1.0, 0.0 ); float a = sqrt( myMixer ); //    myMixer &lt; 0.0 vec3 color = mix( blue, yellow, a ); //   gl_FragColor = vec4( color, 1.0 ); }</code> </pre> <br>  ¬øDe d√≥nde vino la franja amarilla a la izquierda en la imagen incorrecta?  Para comprender mejor lo que sali√≥ mal, primero veamos un caso en el que todo funciona correctamente (casi) siempre. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/83d/1fe/6fd/83d1fe6fdaaffaf185291655c0808542.png" alt="imagen"></div><br>  <i>Esta es una rasterizaci√≥n cl√°sica con una muestra.</i>  <i>Los cuadrados grises son p√≠xeles y los puntos amarillos son los centros de los p√≠xeles ubicados en las coordenadas de la ventana de medio entero (por defecto, las coordenadas del p√≠xel inferior izquierdo en gl_FragCoord son (0.5, 0.5) - <i>trans.</i> ).</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3e5/854/0c1/3e58540c1bf747df60150e88d564d4a0.png" alt="imagen"></div><br>  <i>En la imagen de arriba, la l√≠nea secante separa el medio espacio de la primitiva.</i>  <i>Arriba y a la izquierda de esta l√≠nea, la variable myMixer es positiva, y abajo y a la derecha es negativa.</i> <br><br>  La rasterizaci√≥n cl√°sica de una muestra clasifica los p√≠xeles seg√∫n la pertenencia primitiva y crea fragmentos solo para los p√≠xeles cuyos centros se encuentran dentro de la primitiva.  En este ejemplo, se producir√°n seis fragmentos, que se muestran en la esquina superior izquierda.  Los p√≠xeles marcados en color apagado no caen en la primitiva.  No se generar√°n fragmentos para ellos. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/83f/b9b/37f/83fb9b37f2e978f18643f111af0e2eb8.png" alt="imagen"></div><br>  <i>El verde indica los puntos en los que se calcular√° el sombreador de fragmentos.</i>  <i>El valor de myMixer se calcular√° para el centro de cada p√≠xel.</i>  <i>Tenga en cuenta que los puntos verdes est√°n arriba ya la izquierda de la l√≠nea, por lo que los valores de myMixer en ellos ser√°n positivos.</i>  <i>Todos los datos de entrada asociados con v√©rtices (variables variables o variables de entrada / salida) tambi√©n se interpolar√°n en estos puntos.</i> <br><br>  Nuestro sombreador simple no utiliza derivadas (expl√≠citas o impl√≠citas, por ejemplo, al muestrear desde una textura con niveles de mip), pero las derivadas dFdx (horizontal) y dFdy (vertical) est√°n marcadas con flechas.  Dentro de lo primitivo, est√°n bastante bien definidos y son regulares. <br><br>  Para resumir: en una sola selecci√≥n, los fragmentos se generan <i>solo</i> si el centro del p√≠xel cae "dentro" de la primitiva, los datos del fragmento se calculan para el centro del p√≠xel, la interpolaci√≥n de datos de v√©rtice y el c√°lculo del sombreador se realizan solo dentro de la primitiva.  Todo es bueno y "correcto".  (Casi siempre. Por ahora, omita las inexactitudes de algunas derivadas en p√≠xeles a lo largo del borde de la primitiva). <br><br>  Entonces, todo es (casi) excelente en rasterizaci√≥n con una sola selecci√≥n.  Pero, ¬øqu√© puede salir mal cuando se activa el muestreo m√∫ltiple? <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/acc/eee/dc2/acceeedc234b34993f3e284dd6a2dd81.png" alt="imagen"></div><br>  <i>Esta es una cl√°sica rasterizaci√≥n de muestreo m√∫ltiple.</i>  <i>Los cuadrados grises indican p√≠xeles.</i>  <i>Los puntos amarillos son centros de p√≠xeles en coordenadas de medio entero.</i>  <i>En los puntos azules, se produce el muestreo.</i>  <i>Este ejemplo muestra un diagrama simple de dos muestras rotadas.</i>  <i>Todos los argumentos pueden generalizarse para un n√∫mero arbitrario de muestras.</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f10/7f0/1bb/f107f01bb4df32a980543cb70e6b8e5c.png" alt="imagen"></div><br>  <i>La l√≠nea todav√≠a separa el medio espacio de lo primitivo.</i>  <i>Arriba ya la izquierda, el valor de myMixer es positivo.</i>  <i>M√°s abajo y a la derecha - negativo.</i> <br><br>  Al rasterizar con muestreo m√∫ltiple, el clasificador de p√≠xeles generar√° un fragmento si <i>al menos una</i> muestra de p√≠xeles cae dentro de la primitiva. <br><br>  En este ejemplo, se generar√°n 10 fragmentos, que se muestran en el semiplano superior izquierdo.  Observe los cuatro fragmentos agregados a lo largo de la cara, en los que una muestra cae dentro del primitivo, aunque el centro est√° afuera.  Los p√≠xeles fuera del primitivo todav√≠a est√°n marcados como tenues. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f3e/842/b67/f3e842b67809ec9efe1c8e0ff837ee7c.png" alt="imagen"></div><br>  <i>¬øQu√© suceder√° al calcular en el centro del p√≠xel?</i> <br><br>  El sombreador se calcular√° en puntos verdes <i>y</i> rojos para cada uno de los fragmentos.  Los datos asociados a myMixer se calculan en el centro de cada p√≠xel.  En los puntos verdes, estos valores ser√°n positivos, ya que est√°n arriba ya la izquierda del borde.  Los puntos rojos est√°n fuera de la primitiva, porque los valores de myMixer en ellos son negativos.  En los puntos rojos, los datos asociados se extrapolan en lugar de la interpolaci√≥n. <br><br>  En nuestro sombreador, los valores de sqrt (myMixer) no est√°n definidos con un myMixer negativo.  Incluso cuando los valores de myMixer registrados por el sombreador de v√©rtices se encuentran en el intervalo de cero a uno, en el sombreador de fragmentos, myMixer puede ir m√°s all√° de este intervalo debido a la extrapolaci√≥n.  Por lo tanto, con un myMixer negativo, el resultado del sombreador de fragmentos no est√° definido. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8f4/31d/854/8f431d8540787d70ae2fb27aede04f9f.png" alt="imagen"></div><br>  <i>Todav√≠a estamos considerando calcular el sombreador en el centro de los p√≠xeles, las flechas en la figura muestran dFdx y dFdy.</i>  <i>En los fragmentos internos del pol√≠gono, est√°n bastante bien definidos porque todos los c√°lculos se realizan en los centros de p√≠xeles ubicados a intervalos iguales.</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e02/f36/8fa/e02f368fae459f51896de647a98f23ab.png" alt="imagen"></div><br>  <i>¬øQu√© suceder√° al calcular en puntos distintos de los centros de los p√≠xeles?</i> <br><br>  Los puntos verdes son los puntos en los que se calcular√° el sombreador.  El valor asociado de myMixer se calcula en el <u>centroide de</u> cada p√≠xel. <br><br>  El centroide de un p√≠xel es el centro de gravedad de la intersecci√≥n del cuadrado del p√≠xel y el interior de la primitiva.  Para un p√≠xel totalmente cubierto, el centroide es el centro.  Para un p√≠xel parcialmente cubierto, el centroide suele ser diferente del centro. <br><br>  El est√°ndar OpenGL permite que una implementaci√≥n seleccione un punto arbitrario en la intersecci√≥n de un primitivo y un p√≠xel en lugar de un centroide ideal.  Por ejemplo, podr√≠a ser un punto de muestreo. <br><br>  En este ejemplo, si el centro se encuentra dentro de la primitiva, los datos de v√©rtice se calculan para el centro.  De lo contrario, se calculan en cualquiera de los puntos de muestra que se encuentran dentro de la primitiva.  Esto sucede para cuatro p√≠xeles a lo largo del borde.  Todos los puntos verdes se encuentran arriba ya la izquierda del borde, por lo que los valores en ellos siempre se interpolan y nunca se extrapolan. <br><br>  ¬øPor qu√© no siempre calcular el sombreador centroide?  En general, es m√°s costoso que la inform√°tica en el centro.  Sin embargo, este no es el factor principal. <br><br>  Se trata de calcular derivados.  Presta atenci√≥n a las flechas entre los puntos verdes.  La distancia entre ellos no es la misma para diferentes pares de puntos.  Adem√°s, y no es constante para dFdx, y x no es constante para dFdy.  <i>Los derivados son menos precisos cuando se calculan en centroides</i> . <br><br>  Esto es un compromiso y, por lo tanto, OpenGL, comenzando con GLSL 1.20, ofrece al desarrollador del sombreador una opci√≥n entre centro y centroide utilizando el calificador centroide: <br><br><pre> <code class="plaintext hljs">centroid in float myMixer; //  centroid  smooth //      . //  sqrt    . void main( void ) { const vec3 blue = vec3( 0.0, 0.0, 1.0 ); const vec3 yellow = vec3( 1.0, 1.0, 0.0 ); float a = sqrt( myMixer ); //    myMixer &lt; 0.0 vec3 color = mix( blue, yellow, a ); //   gl_FragColor = vec4( color, 1.0 ); }</code> </pre><br>  ¬øCu√°ndo deber√≠as usar el centroide? <br><br><ol><li>  Cuando un valor extrapolado puede conducir a resultados vagos.  Preste especial atenci√≥n a las funciones integradas, cuya descripci√≥n dice "el resultado no se define si ..." </li><li>  Cuando se usa un valor extrapolado con una funci√≥n muy no lineal o discontinua.  Estos incluyen la funci√≥n de paso o el c√°lculo de destellos, especialmente cuando el exponente es lo suficientemente grande. </li></ol><br>  ¬øCu√°ndo no deber√≠as usar un centroide? <br><br><ol><li>  Si necesita derivados exactos.  Los derivados pueden ser expl√≠citos (llamada dFdx) o impl√≠citos, por ejemplo, muestras de texturas con niveles mip o con filtrado anisotr√≥pico.  En la especificaci√≥n GLSL, los derivados en centroides se consideran tan inutilizables que se declaran indefinidos.  En tales casos, intente escribir: <br><br><pre> <code class="plaintext hljs">centroid in float myMixer; //  ! smooth in float myCenterMixer; //     .</code> </pre><br></li><li>  Si se representa una cuadr√≠cula en la que la mayor√≠a de los l√≠mites de las primitivas son internos y siempre est√°n bien definidos.  El ejemplo m√°s simple es una tira de 100 tri√°ngulos (TRIANGLE_STRIP), en la que solo el primer y el √∫ltimo tri√°ngulo est√°n sujetos a extrapolaci√≥n.  El calificador centroide dar√° como resultado la interpolaci√≥n en estos dos tri√°ngulos a costa de la p√©rdida de precisi√≥n y continuidad en los 98 tri√°ngulos restantes. </li><li>  Si sabe que los artefactos pueden aparecer por una funci√≥n indefinida, no lineal o discontinua, pero en la pr√°ctica estos artefactos resultan ser casi invisibles.  Si el sombreador <i>no</i> ataca, ¬°no lo arregles! </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es434046/">https://habr.com/ru/post/es434046/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es434034/index.html">Buenos tutoriales en YouTube</a></li>
<li><a href="../es434036/index.html">Feliz y final: los buzones en los dominios del portal Qip.ru se han trasladado a Yandex</a></li>
<li><a href="../es434038/index.html">Ventas de veh√≠culos el√©ctricos enchufables en China para noviembre de 2018</a></li>
<li><a href="../es434040/index.html">Resumen de la Universidad ITMO: habla sobre proyectos universitarios, √©xitos y logros de nuestros graduados</a></li>
<li><a href="../es434044/index.html">Autenticaci√≥n de dos factores (2FA) resistente al phishing</a></li>
<li><a href="../es434048/index.html">Facebook desarrolla criptomonedas para WhatsApp</a></li>
<li><a href="../es434050/index.html">Java Enterprise vs Android en 2019: ¬øqu√© elegir para un novato?</a></li>
<li><a href="../es434052/index.html">Conferencia NEGRO SOMBRERO. C√≥mo hacer un tel√©fono esp√≠a. Parte 1</a></li>
<li><a href="../es434054/index.html">Conferencia NEGRO SOMBRERO. C√≥mo hacer un tel√©fono esp√≠a. Parte 2</a></li>
<li><a href="../es434056/index.html">Necesitas saber d√≥nde poner el cero</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>