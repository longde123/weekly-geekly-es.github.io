<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üòé üéº ü§∞üèª Menyebarkan kode langsung ke wadah buruh pelabuhan. Atau bagaimana tidak menunda-nunda setelah setiap komit ü•† üë©üèΩ‚Äçüé§ üç≥</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Tugas datang WEB-12982 
 Buat cabang web-12982 di repositori 
 Sementara ranting sedang berjalan, baca tz dan minum kopi 
 Lanjutkan langsung ke penge...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Menyebarkan kode langsung ke wadah buruh pelabuhan. Atau bagaimana tidak menunda-nunda setelah setiap komit</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/439262/"><blockquote>  <em>Tugas datang WEB-12982</em> <br>  Buat cabang web-12982 di repositori <br>  <em>Sementara ranting sedang berjalan, baca tz dan minum kopi</em> <br>  <em>Lanjutkan langsung ke pengembangan</em> <br><br>  <em>git commit, git push</em> <br>  Sementara cabang disusun kembali <br>  <em>git commit, git push</em> <br>  Sementara cabang dibangun kembali, membalik twitter <br>  <em>git commit, git push</em> <br>  ... <br>  <em>Anda menyerahkan cabang ulasan dengan 50 komitmen</em> <br><br>  Anda memahami bahwa 50 commit adalah tepat 50 menit dari waktu murni, yang dikumpulkan dalam kesesuaian dan permulaan, karena interval 1 menit terlalu kecil untuk melakukan apa pun selain penundaan dan kebutuhan dasar. </blockquote><p><img src="https://habrastorage.org/webt/wk/fr/gn/wkfrgnyb8_mtcoblzg_hm2fi_9c.png"></p><br><p>  Apakah situasinya akrab?  Di perusahaan saya, infrastruktur pengembangan diatur sebagai berikut: </p><br><ul><li>  Hitlab memiliki banyak repositori proyek </li><li>  Untuk memastikan kemudahan pengembangan saat membuat cabang baru, buruh pelabuhan secara otomatis membuat kotak pasir mereka sendiri di alamat unik, salinan lengkap cabang induk dengan semua lingkungan yang diperlukan. </li><li>  Semua yang Anda butuhkan sudah siap - cukup tulis kode dan uji-lihat-evaluasi hasilnya setelah setiap komit, <strong>sangat nyaman!</strong> </li></ul><br><p>  <strong>Tapi, perlahan ...</strong> Jika situasi ini dekat denganmu, selamat datang di bawah kucing. </p><a name="habracut"></a><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Inti dari masalah</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Opsi solusi</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Implementasi solusi</a> </li></ul><br><h2 id="sut-problemy--a-nameproblema">  Inti dari masalah </h2><br><blockquote>  <strong>tldr:</strong> Perubahan yang dilakukan pada kode memerlukan pemasangan kembali wadah dan menghabiskan waktu (lebih dari satu menit, itu tergantung pada proyek, terutama jika CI \ CD dikonfigurasi), yang sebenarnya tidak dapat dihabiskan dengan berguna, tetapi yang benar-benar membutuhkan potongan yang baik dari waktu kerja programmer. </blockquote><br><div class="spoiler">  <b class="spoiler_title">Masalah serupa muncul secara berkala di semua</b> <div class="spoiler_text"><p>  Sebagai contoh, liveReload yang sama untuk frontend jelas diciptakan karena suatu alasan </p></div></div><br><p>  Saya sebelumnya menerbitkan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">artikel tentang topik terkait</a> , tetapi terkait dengan proses debugging (Omong-omong, terima kasih atas komentar informatif dan umpan balik positif).  Namun, masalah pada pemotongan pada dasarnya tidak hilang, kami juga terus menunggu sampai cabang dipasang kembali. </p><br><p>  Bahkan jika Anda melewati tahapan tambahan dan hanya menyisakan build-dev dan deploy-dev, waktu tunggu tidak signifikan untuk tindakan apa pun yang bermanfaat, tetapi secara signifikan dalam total waktu yang dihabiskan, terutama ketika menyangkut CI \ CD, misalnya, dari Gitlab. </p><br><p>  Tentu saja, Anda dapat mempercepat proses dengan merakit proyek secara lokal, asalkan programmer memiliki komputer yang relatif kuat, gitlab-runner dikonfigurasi, lingkungan yang sama dikonfigurasi seperti pada server jarak jauh, dan tag yang sesuai ditambahkan ke gitlab-ci.yml, tapi saya ragu bahwa kecepatan build akan sama dengan penyebaran kode FTP otomatis setelah tombol ctrl + s. </p><br><p>  Terutama <del>  membakar amarah </del>  itu melelahkan ketika selama proses pengembangan Anda membuat kesalahan ketik / kesalahan yang umumnya tidak mempengaruhi operasi aplikasi, tetapi yang tidak dapat dibiarkan begitu saja dan Anda perhatikan hanya ketika Anda melihat hasil setelah perakitan. </p><br><h2 id="chto-trebuetsya-i-varianty-resheniya-a-namevariantsa">  Apa yang diperlukan dan opsi solusi </h2><br><blockquote>  <strong>tldr:</strong> Temukan cara untuk melihat hasil edit Anda sesederhana dan secepat mungkin.  Agar tidak berkomitmen setiap waktu dan tidak menunggu untuk membangun kembali cabang.  Saya memilih rsync dari komputer lokal ke folder server jauh yang dipasang dengan folder kontainer. </blockquote><p>  Saya tidak menemukan solusi lengkap di Internet, tetapi sebenarnya ada beberapa opsi: </p><br><ul><li>  Konfigurasikan ftp \ ssh langsung dalam wadah dengan basis kode, sertakan dalam gambar, sambungkan melalui FTP langsung ke wadah itu sendiri <br><ul><li>  Secara pribadi, opsi ini bagi saya agak rumit, dan juga "kruk", meskipun di sini semua opsi adalah kruk </li></ul></li><li>  (untuk penggunaan lokal) gunakan <strong><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">buruh pelabuhan cp</a></strong> untuk memuat kode langsung ke wadah <br><ul><li>  Opsi ini tidak cocok untuk bekerja dengan server jarak jauh. </li><li>  docker cp memiliki fungsionalitas yang sangat terbatas, mengingat folder vendor yang tidak boleh disalin setiap waktu, dan algoritma penyalinan itu sendiri, ini akan agak lambat. </li></ul></li><li>  (untuk penggunaan jarak jauh \ lokal) Pasang folder kontainer yang diinginkan ke folder host eksternal.  Unduh file lokal langsung ke folder host yang dipasang.  Sudah ada banyak opsi implementasi: <br><ul><li>  Gunakan mesin <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">docker</a> dan khususnya <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">mesin docker scp</a> <br><ul><li>  Sekali lagi, Anda perlu mengkonfigurasi lingkungan, mengkonfigurasi mesin docker, mungkin ini masuk akal ketika Anda terus-menerus bekerja dengan server yang berbeda </li></ul></li><li>  Dalam IDE, konfigurasikan koneksi FTP dengan folder host yang diinginkan <br><ul><li>  Setiap cabang baru perlu membuat koneksi baru atau mengubah pemetaan </li></ul></li><li>  Gunakan scp atau rsync untuk mengunggah file ke folder host yang diinginkan, untuk ini gunakan skrip bash kecil dan gantung di hot keys <br><ul><li>  Pada awalnya, tampaknya tidak perlu rumit, tetapi sebenarnya tidak.  Script itu sendiri sesederhana mungkin dan diperlukan untuk mengotomatiskan proses sehingga Anda tidak perlu mengkonfigurasi ulang pemetaan setiap kali </li></ul></li></ul></li></ul><br><h2 id="samo-reshenie-rsync--volumes-a-namedecisiona">  Solusi itu sendiri: rsync + volume </h2><br><blockquote>  <strong>tldr:</strong> <br><ul><li>  Perlu akses ssh ke server jarak jauh dan rsync pada mesin lokal </li><li>  Server jarak jauh harus memiliki folder yang dapat ditulis </li><li>  Pasang folder proyek dalam wadah ke folder host eksternal </li><li>  Tambahkan skrip bash kecil ke root proyek untuk menyinkronkan file dengan server jauh </li><li>  Konfigurasikan hotkey untuk eksekusi skrip sinkronisasi </li></ul><br></blockquote><p>  <strong>Perlu dicatat bahwa solusi yang diberikan dikecualikan untuk pengembangan dan lingkungan pengujian</strong> </p><br><p>  Dalam hal ini, saya akan melihat lingkungan docker-compose dan gitlab-ci, dengan docker-compose menggunakan variabel lingkungan dari gitlab-ci. </p><br><p>  Kami membentuk path ke folder tujuan di gitlab-ci dan mengekspor path ini ke docker-compose.yml: </p><br><pre><code class="plaintext hljs">before_script: - export SHARED_DIR_BASE='/var/www/builds' #    ,      - export SHARED_BRANCH_DIR=${SHARED_DIR_BASE}/${PROJECT_GROUP}/${PROJECT_NAME}/${CI_COMMIT_REF_NAME} #     web-123   my_group/my_project,      /var/shared/my_group/my_project/web-123 Deploy dev: stage: deploy_dev script: #   ,         - mkdir -p ${SHARED_BRANCH_DIR} - rsync -r --exclude-from=.gitignore --exclude-from=.dockerignore . ${SHARED_BRANCH_DIR} - find ${SHARED_BRANCH_DIR} -type d -exec setfacl -d -mo:rwx {} \; - find ${SHARED_BRANCH_DIR} -type d -exec setfacl -mo:rwx {} \; - find ${SHARED_BRANCH_DIR} -type f -exec setfacl -mo:rwx {} \; - envsubst &lt; docker-compose.tmpl &gt; docker-compose.yml #     gitlab-ci.yml  docker-compose.yml,   docker-compose.tmpl - docker-compose up -d</code> </pre> <br><p>  Selanjutnya, kita perlu me-mount folder proyek ke folder host eksternal di docker-compose, karena kita menggunakan variabel-variabel dalam docker-compose, kita perlu templat docker-compose.tmpl di mana kita akan menggunakan variabel-variabel ini. </p><br><pre> <code class="plaintext hljs">version: '2.3' services: web: ... volumes: - ${SHARED_BRANCH_DIR}:/app/:rw #             #        .    ,      ,           .              ,     ,        - /app/protected/vendor/</code> </pre> <br><p>  Konfigurasi saat ini sudah cukup, sekarang ketika Anda membangun cabang di server host, folder <strong>/ var / www / builds / GROUP_NAME / PROJECT_NAME / BRANCH_NAME</strong> akan dibuat dan proyek akan ditransfer ke sana kecuali file dan folder yang ditentukan dalam .gitignore dan .dockerignore, lalu Anda cukup mengkonfigurasi pemetaan FTP, tetapi kami akan melangkah lebih jauh dan membuat prosesnya sedikit lebih otomatis. </p><br><p>  Bahkan, untuk menyinkronkan file, kita perlu menjalankan sesuatu seperti ini: </p><br><pre> <code class="bash hljs">rsync -r -u \ --delete-after \ --exclude-from=.gitignore \ --exclude-from=.dockerignore \ . <span class="hljs-variable"><span class="hljs-variable">$sshUserName</span></span>@<span class="hljs-variable"><span class="hljs-variable">$sshHost</span></span>:<span class="hljs-variable"><span class="hljs-variable">$sharedBaseDir</span></span></code> </pre> <br><p>  Bahkan, pada proyek-proyek berukuran kecil-menengah, perintah ini akan mengeksekusi lebih cepat daripada waktu Anda untuk melakukan dan mendorong pengeditan ke repositori.  Tetap membawa skrip ini ke tampilan yang lebih lengkap dan mengikat eksekusi ke hot key. </p><br><div class="spoiler">  <b class="spoiler_title">Kode skrip lengkap: deploy.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env bash #    while [ -n "$1" ] do case "$1" in --sshUserName=*) sshUserName=${1#*=} ;; --sshHost=*) sshHost=${1#*=} ;; esac shift done #  shared    gitBranch=$(git branch | grep \* | cut -d ' ' -f2) gitProject=$(git config --local remote.origin.url|sed -n 's#.*/\([^.]*\)\.git#\1#p') gitGroup=$(git config --local remote.origin.url|sed -n 's#.*/\([^.]*\)/.*\.git#\1#p') sharedBaseDir=/var/www/builds/$gitGroup/$gitProject/$gitBranch #         rsync -r -u \ --delete-after \ --exclude-from=.gitignore \ --exclude-from=.dockerignore \ . $sshUserName@$sshHost:$sharedBaseDir echo "done"</span></span></code> </pre> </div></div><br><p>  Perlu dicatat bahwa skrip harus terletak di root folder proyek repositori atau menunjukkan di direktori mana ia seharusnya bekerja. </p><br><p>  Tetap hanya untuk mempercepat eksekusi skrip ini ke hotkey spesifik dan mengatur parameter sshUserName dan sshHost (dipahami bahwa sudah ada akses ke server jauh melalui ssh).  Cara melakukan ini, saya akan memberikan contoh PHPstorm. </p><br><ul><li>  Buka <strong>File -&gt; Pengaturan</strong> </li><li>  Di jendela pengaturan di menu sebelah kiri, luaskan <strong>Alat</strong> , pilih <strong>Alat Eksternal</strong> </li><li>  Kami menulis path ke skrip dan menentukan sshUserName dan sshHost nyata dalam argumen <br><br><img src="https://habrastorage.org/webt/wv/j6/zq/wvj6zq86jwgy2s4gh01ouqrq7d8.png"></li><li>  Selanjutnya, buka <strong>Keymap</strong> dan cari nama Alat Eksternal kami, atur kombinasi yang diperlukan <br><br><img src="https://habrastorage.org/webt/ao/9y/iy/ao9yiyq5zahfsqkeh4lsfgb3wi4.png"></li></ul><br><p>  Itu saja.  Sekarang, ketika Anda mengklik kombinasi yang diinginkan, semua file proyek disinkronkan dengan folder jarak jauh, yang dipasang dengan folder proyek di dalam wadah.  Artinya, setiap perubahan akan segera terlihat. </p><br><p>  Saya tidak berpura-pura menjadi "ideal" dari solusi ini, mungkin ada opsi yang lebih baik, saya akan senang jika saya mengetahui mereka di komentar.  Terima kasih </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id439262/">https://habr.com/ru/post/id439262/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id439248/index.html">Alan Kay: "Bisakah bangsa Romawi kuno membangun komputer?"</a></li>
<li><a href="../id439252/index.html">6 alasan untuk mengembangkan karir TI di Armenia</a></li>
<li><a href="../id439254/index.html">Segalanya untuk kita</a></li>
<li><a href="../id439258/index.html">Metode Generik dalam Karat: Bagaimana Exonum Bergeser dari Besi ke Actix-web</a></li>
<li><a href="../id439260/index.html">Penulis The Witcher masih akan menerima kompensasi dari CD Projekt Red</a></li>
<li><a href="../id439264/index.html">Cara mengelola proyek teknis yang rumit tanpa mempekerjakan PM: Pengalaman DataLine</a></li>
<li><a href="../id439266/index.html">Pengalaman membuat game untuk Android sendiri dari awal dan bagaimana itu dikreditkan ke Google Play</a></li>
<li><a href="../id439268/index.html">Bagaimana VR, AR, dan pencetakan 3D bekerja bersama: Pengalaman Konsep VR</a></li>
<li><a href="../id439270/index.html">Contoh parsing kode C ++ menggunakan libclang dengan Python</a></li>
<li><a href="../id439272/index.html">Notebook Jupyter di Netflix</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>