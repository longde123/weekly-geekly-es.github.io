<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏡 🍘 ✋🏿 Guia de notificações de assinaturas da Apple para iOS. Eles são realmente bons? 👨🏻‍🎓 👩🏽‍🤝‍👩🏼 😰</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Portanto, você tem um aplicativo com assinaturas renováveis ​​automáticas. Funciona muito bem, os usuários emitem incontrolavelmente assinaturas premi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Guia de notificações de assinaturas da Apple para iOS. Eles são realmente bons?</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/apphud/blog/453770/"><p><img src="https://habrastorage.org/getpro/habr/post_images/fa5/f52/a07/fa5f52a07612fe9b040dad35421024ec.jpg"></p><br><p>  Portanto, você tem um aplicativo com assinaturas renováveis ​​automáticas.  Funciona muito bem, os usuários emitem incontrolavelmente assinaturas premium e escrevem críticas elogiosas.  Beleza! </p><br><p>  Olá pessoal, meu nome é Denis, sou gerente de projetos do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Apphud</a> , um serviço de análise de assinaturas renováveis ​​automaticamente para aplicativos iOS. </p><br><p>  Como gerente de projeto, é vital que você fique a par das principais métricas do produto.  Um dos mais importantes é o valor do tempo de vida útil (LTV) - a renda média de cada usuário durante todo o tempo usando o aplicativo.  Mas como calculá-lo no caso de assinaturas renováveis ​​automaticamente no iOS?  Como rastrear o tempo de renovação, cancelamento, renovação de uma assinatura por um usuário? <a name="habracut"></a></p><br><p>  Até recentemente (ou seja, até 2017), a única maneira de fazer isso era a chamada Pesquisa de status de assinaturas.  A qualquer momento, você pode obter informações sobre o status da assinatura enviando o recibo necessário para o URL: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://buy.itunes.apple.com/verifyReceipt</a> .  Depois de recebê-lo, você pode visualizar informações básicas sobre a assinatura, incluindo a data de término.  É verdade que você ainda não terá seu custo. </p><br><p>  Para implementar a pesquisa de status, você deve: </p><br><ol><li>  transferir e armazenar no servidor todas as verificações de todas as assinaturas de cada usuário, </li><li>  implementar lógica complexa do servidor, que verificará <strong>regularmente</strong> essas verificações. </li></ol><br><p>  Isso é complicado.  Mas em 2017, a Apple parece resolver esse problema.  Na WWDC, aplaudindo de pé, eles apresentam notificações de atualização de status das assinaturas da Apple. </p><br><h2 id="chto-takoe-subscriptions-notifications">  O que são notificações de inscrições? </h2><br><p>  As Notificações de atualização de status das assinaturas Apple são um mecanismo para enviar webhooks ao servidor Apple quando ocorrem eventos de assinatura renováveis ​​automaticamente.  Para habilitá-los, você deve primeiro configurar seu servidor para aceitá-los: o servidor deve suportar o protocolo App Transport Security (geralmente tudo funciona por padrão).  Depois disso, acesse a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">App Store Connect</a> e, na seção "App Store" das configurações do seu aplicativo, insira um link para o qual a Apple enviará uma solicitação POST sempre que ocorrer um evento: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/011/e97/844/011e97844357cc016a2a8258bacfd354.png" alt="Configurar notificações de atualização de status das assinaturas Apple"></p><br><blockquote>  Observe que a Apple recomenda o uso de Notificações de assinaturas em conjunto com a Pesquisa de status.  Mau sinal ... </blockquote><p>  Feito!  Agora você deve receber notificações sempre que, por exemplo, uma assinatura for emitida, renovada ou cancelada. </p><br><h2 id="raznovidnosti-uvedomleniy">  Variedades de notificações </h2><br><p>  A Apple envia 6 tipos de notificações que ocorrem em vários eventos.  Vamos analisar cada um deles. </p><br><h3 id="initial_buy">  INITIAL_BUY </h3><br><p>  A Apple envia esta notificação quando um usuário se inscreve pela primeira vez em um <strong>grupo de</strong> assinaturas. </p><br><blockquote>  Você pode ler mais sobre grupos de assinaturas em nosso <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">artigo</a> . </blockquote><p><img src="https://habrastorage.org/getpro/habr/post_images/bce/b16/6de/bceb166ded34b6e3efe67b0fbd22ae01.png" alt="Evento INITIAL_BUY"></p><br><h3 id="cancel">  CANCELAR </h3><br><p>  Este evento é despachado quando o usuário cancela a assinatura através do suporte Apple Care e reembolsa a compra.  Enfatizamos que <strong>não se</strong> trata do cancelamento usual da assinatura por meio das configurações do iOS. </p><br><blockquote> <code>CANCEL</code> evento <code>CANCEL</code> não é despachado durante o cancelamento normal através das configurações do iOS. </blockquote><p><img src="https://habrastorage.org/getpro/habr/post_images/52c/692/9ce/52c6929ced9ea6d4d887581722f5612a.png" alt="CANCELAR Evento"></p><br><h3 id="did_change_renewal_status">  DID_CHANGE_RENEWAL_STATUS </h3><br><p>  Este evento foi adicionado recentemente.  É enviado quando o usuário desconecta ou (novamente) ativa a renovação da assinatura por meio das configurações do iOS, do aplicativo App Store ou do suporte da Apple: </p><br><blockquote>  Não confunda este evento com o evento <code>CANCEL</code> que é acionado quando você cancela sua assinatura e reembolsa através do suporte Apple Care. </blockquote><p><img src="https://habrastorage.org/getpro/habr/post_images/987/be2/829/987be28296f3367163ff3af07a4fb29a.png" alt="Evento DID_CHANGE_RENEWAL_STATUS"></p><br><h3 id="renewal">  RENOVAÇÃO </h3><br><p>  A primeira coisa que vem à mente quando você vê o nome deste evento: a Apple envia quando a renovação é renovada automaticamente.  Não importa como! </p><br><p>  O evento <code>RENEWAL</code> despachado quando: </p><br><ol><li><p>  a assinatura do usuário foi cancelada automaticamente <strong>devido a problemas com o cartão bancário do usuário ...</strong> </p><br></li><li><p>  e depois disso, o usuário renovou a assinatura novamente.  É nesse ponto que o evento <code>RENEWAL</code> é <code>RENEWAL</code> . </p><br></li></ol><br><p><img src="https://habrastorage.org/getpro/habr/post_images/e56/ed6/4e9/e56ed64e9a4f804a69c32b15df6e614f.jpg"></p><br><blockquote>  Um <code>RENEWAL</code> RENOVAÇÃO <strong>não</strong> <code>RENEWAL</code> <strong>enviado</strong> no caso de uma renovação regular de uma assinatura.  Em vez disso, a Apple sugere verificar a verificação da assinatura através de <code>/VerifyReceipt</code> antes e após a renovação esperada e analisar a <code>expiration_date</code> resultante </blockquote><p><img src="https://habrastorage.org/getpro/habr/post_images/2d9/e2d/544/2d9e2d5440a690903f0182b5c08cc9a4.png" alt="Evento RENOVAÇÃO"></p><br><h3 id="interactive_renewal">  INTERACTIVE_RENEWAL </h3><br><p>  Este evento é despachado se: </p><br><ol><li><p>  O usuário cancelou a assinatura e <strong>algum tempo depois disso ...</strong> </p><br></li><li><p>  assinatura renovada pelo usuário.  É neste momento que <code>INTERACTIVE_RENEWAL</code> enviado. </p><br><blockquote>  A nova assinatura (indicada na cláusula 2) pode ser diferente da assinatura da cláusula 1, mas ambas devem pertencer ao mesmo grupo de compras.  Por exemplo, um usuário pode cancelar a inscrição no plano tarifário Bronze e, após algum tempo, renovar sua assinatura escolhendo o plano Gold.  Nesse caso, a Apple enviará o evento <code>INTERACTIVE_RENEWAL</code> ao seu servidor (desde que as assinaturas Bronze e Gold pertençam ao mesmo grupo de compras).  Você pode ler mais sobre grupos de assinaturas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . </blockquote><br></li></ol><br><p><img src="https://habrastorage.org/getpro/habr/post_images/7b0/d77/fe3/7b0d77fe3921cf4bf9c4d9b4a04bec03.png" alt="Evento INTERACTIVE_RENEWAL"></p><br><h3 id="did_change_renewal_pref">  DID_CHANGE_RENEWAL_PREF </h3><br><p>  <code>DID_CHANGE_RENEWAL_PREF</code> enviado quando um usuário alterna de uma assinatura para outra dentro do mesmo grupo de compras: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/ab1/8d5/359/ab18d53594ec3b04615f38598aa0c787.png" alt="Evento DID_CHANGE_RENEWAL_PREF"></p><br><h3 id="chto-v-itoge">  Qual é o resultado? </h3><br><p>  A Apple oferece até 6 eventos, mas nenhum deles é enviado ao renovar automaticamente uma assinatura no modo normal.  Por que eles fizeram isso?  Claro.  Além disso, os nomes desses eventos são enganosos. </p><br><p>  A tabela abaixo resume os eventos. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/3ba/c0f/fc1/3bac0ffc178eaad092d199d6dd0e8d19.png"></p><br><h2 id="kak-ispolzovat-apple-subscriptions-notifications">  Como usar as notificações de assinaturas da Apple? </h2><br><p>  Devido ao fato de que o evento mais importante que você precisa calcular para LTV - renovação da assinatura no modo normal - não foi enviado, você ainda precisa usar a Status Polling.  Existe a possibilidade de a Apple adicionar este evento em um futuro próximo, mas mesmo que isso aconteça, você ainda não pode ficar sem o seu próprio servidor.  Este servidor atuará como uma "camada" entre a Apple e outro sistema de análise (por exemplo, Amplitude, Flurry ou Mixpanel).  Ao receber eventos e verificar cheques, você enviará informações sobre renovações, cancelamentos e reembolsos. </p><br><blockquote><h1 id="odnazhdy-my-stolknulis-s-etoy-problemoy-i-reshili-razrabotat-servis-kotoryy-by-reshil-eti-problemy-tak-rodilas-ideya-servisa-nad-kotorym-my-seychas-rabotaem--servisa-analitiki-podpisok-dlya-ios-kotoryy-zapolnyaet-bresh-v-otpravke-sobytiy-so-storony-apple">  Uma vez que encontramos esse problema e decidimos desenvolver um serviço que resolveria esses problemas.  Portanto, nasceu a idéia do serviço em que estamos trabalhando agora - o serviço de análise de assinaturas para iOS, que preenche a lacuna no envio de eventos da Apple. </h1><br></blockquote><br><h2 id="zaklyuchenie">  Conclusão </h2><br><p>  As notificações de assinaturas da Apple não são tão boas quanto parecem, porque somente com elas você não consegue resolver o problema principal: descobrir quanto dinheiro um usuário traz para você.  A Apple pode facilitar a vida dos desenvolvedores no futuro, mas uma coisa é certa: a implementação atual das Notificações de assinaturas é extremamente óbvia e parece muletas. </p><br><blockquote>  Deseja implementar assinaturas no seu aplicativo iOS em 10 minutos?  Integre o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Apphud</a> e: <br><ul><li>  Faça compras usando apenas um método; </li><li>  rastreia automaticamente o status da assinatura de cada usuário; </li><li>  Integre facilmente as ofertas de assinatura </li><li>  enviar eventos de assinatura para Amplitude, Mixpanel, Slack e Telegram, levando em consideração a moeda local do usuário; </li><li>  diminua a taxa de rotatividade de aplicativos e retorne usuários não inscritos. </li></ul><br></blockquote><br><h2 id="chto-pochitat">  O que ler? </h2><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">7 coisas a saber sobre assinaturas renováveis ​​automaticamente</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Guia de ofertas introdutórias no iOS</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Guia de notificações da atualização de status da Apple</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt453770/">https://habr.com/ru/post/pt453770/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt453756/index.html">Problemas da metodologia atual para determinar ameaças atuais do FSTEC</a></li>
<li><a href="../pt453760/index.html">Campo de treinamento em circuito para tanques e processadores</a></li>
<li><a href="../pt453764/index.html">Amnésia voluntária: manipulações do hipocampo para remover memórias dolorosas</a></li>
<li><a href="../pt453766/index.html">Rádio definido por software - como funciona? Parte 6</a></li>
<li><a href="../pt453768/index.html">Visão geral dos serviços SMS: Serviços populares</a></li>
<li><a href="../pt453772/index.html">Projeto Athena - Reinventando o Notebook</a></li>
<li><a href="../pt453776/index.html">Bombeamos designers da empresa: do júnior ao diretor de arte</a></li>
<li><a href="../pt453778/index.html">Como criamos um banco on-line para empresas. Parte Um: Rebranding</a></li>
<li><a href="../pt453780/index.html">Como escolher um telefone SIP Grandstream - em geral e em particular?</a></li>
<li><a href="../pt453782/index.html">Infinito UIScrollView</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>