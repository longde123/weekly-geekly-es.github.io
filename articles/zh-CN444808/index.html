<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸï¸ âšªï¸ ğŸ‘¨â€ğŸ‘¦â€ğŸ‘¦ Flaggerå’ŒIstioçš„è‡ªåŠ¨é‡‘ä¸é›€éƒ¨ç½² ğŸ¤´ğŸ¼ ğŸ¤´ ğŸ™ŒğŸ½</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="CDè¢«è®¤ä¸ºæ˜¯ä¸€ç§ä¼ä¸šè½¯ä»¶å¼€å‘å®è·µï¼›å®ƒæ˜¯å·²å»ºç«‹çš„CIåŸåˆ™è‡ªç„¶æ¼”å˜çš„ç»“æœã€‚ ä½†æ˜¯ï¼ŒCDä»ç„¶å¾ˆå°‘å‡ºç°ï¼Œè¿™å¯èƒ½æ˜¯ç”±äºç®¡ç†çš„å¤æ‚æ€§ä»¥åŠæ‹…å¿ƒéƒ¨ç½²ä¸æˆåŠŸä¼šå½±å“ç³»ç»Ÿå¯ç”¨æ€§çš„ç¼˜æ•…ã€‚ 


 Flaggeræ˜¯å¼€æºçš„Kubernetesè¿è¥å•†ï¼Œæ—¨åœ¨æ¶ˆé™¤æ··ä¹±çš„å…³ç³»ã€‚ å®ƒä½¿ç”¨Istioæµé‡è¡¥å¿å’ŒPrometheusæŒ‡æ ‡è‡ªåŠ¨åˆ†...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Flaggerå’ŒIstioçš„è‡ªåŠ¨é‡‘ä¸é›€éƒ¨ç½²</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/southbridge/blog/444808/"><p><img src="https://habrastorage.org/webt/ol/eo/lt/oleoltogrvhcuhjuil5zmvmbpxi.png"></p><br><p>  CDè¢«è®¤ä¸ºæ˜¯ä¸€ç§ä¼ä¸šè½¯ä»¶å¼€å‘å®è·µï¼›å®ƒæ˜¯å·²å»ºç«‹çš„CIåŸåˆ™è‡ªç„¶æ¼”å˜çš„ç»“æœã€‚ ä½†æ˜¯ï¼ŒCDä»ç„¶å¾ˆå°‘å‡ºç°ï¼Œè¿™å¯èƒ½æ˜¯ç”±äºç®¡ç†çš„å¤æ‚æ€§ä»¥åŠæ‹…å¿ƒéƒ¨ç½²ä¸æˆåŠŸä¼šå½±å“ç³»ç»Ÿå¯ç”¨æ€§çš„ç¼˜æ•…ã€‚ </p><br><p>  Flaggeræ˜¯å¼€æºçš„Kubernetesè¿è¥å•†ï¼Œæ—¨åœ¨æ¶ˆé™¤æ··ä¹±çš„å…³ç³»ã€‚ å®ƒä½¿ç”¨Istioæµé‡è¡¥å¿å’ŒPrometheusæŒ‡æ ‡è‡ªåŠ¨åˆ†æé‡‘ä¸é›€éƒ¨ç½²ï¼Œä»¥åˆ†ææ‰˜ç®¡éƒ¨ç½²æœŸé—´çš„åº”ç”¨ç¨‹åºè¡Œä¸ºã€‚ </p><br><p> ä»¥ä¸‹æ˜¯æœ‰å…³å¦‚ä½•åœ¨Google Kubernetes Engineï¼ˆGKEï¼‰ä¸­é…ç½®å’Œä½¿ç”¨Flaggerçš„åˆ†æ­¥æŒ‡å—ã€‚ </p><a name="habracut"></a><br><h3 id="nastroyka-klastera-kubernetes"> é…ç½®Kubernetesé›†ç¾¤ </h3><br><p> é¦–å…ˆï¼Œä½¿ç”¨IstioåŠ è½½é¡¹åˆ›å»ºGKEç¾¤é›†ï¼ˆå¦‚æœæ‚¨æ²¡æœ‰GCPå¸æˆ·ï¼Œåˆ™å¯ä»¥<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">åœ¨æ­¤å¤„</a>æ³¨å†Œä»¥è·å–å…è´¹ç§¯åˆ†ï¼‰ã€‚ </p><br><p>ç™»å½•åˆ°Google Cloudï¼Œåˆ›å»ºä¸€ä¸ªé¡¹ç›®å¹¶ä¸ºå…¶è®¡è´¹ã€‚ å®‰è£…<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">gcloud</a>å‘½ä»¤è¡Œ<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å®ç”¨ç¨‹åºï¼Œ</a>å¹¶ä½¿ç”¨<code>gcloud init</code>å®šåˆ¶é¡¹ç›®ã€‚ </p><br><p> è®¾ç½®é»˜è®¤é¡¹ç›®ï¼Œè®¡ç®—åŒºåŸŸå’ŒåŒºåŸŸï¼ˆç”¨é¡¹ç›®æ›¿æ¢<code>PROJECT_ID</code> ï¼‰ï¼š </p><br><pre> <code class="plaintext hljs">gcloud config set project PROJECT_ID gcloud config set compute/region us-central1 gcloud config set compute/zone us-central1-a</code> </pre> <br><p> å¯ç”¨GKEæœåŠ¡å¹¶ä½¿ç”¨HPAå’ŒIstioé™„åŠ ç»„ä»¶åˆ›å»ºé›†ç¾¤ï¼š </p><br><pre> <code class="plaintext hljs">gcloud services enable container.googleapis.com K8S_VERSION=$(gcloud beta container get-server-config --format=json | jq -r '.validMasterVersions[0]') gcloud beta container clusters create istio \ --cluster-version=${K8S_VERSION} \ --zone=us-central1-a \ --num-nodes=2 \ --machine-type=n1-standard-2 \ --disk-size=30 \ --enable-autorepair \ --no-enable-cloud-logging \ --no-enable-cloud-monitoring \ --addons=HorizontalPodAutoscaling,Istio \ --istio-config=auth=MTLS_PERMISSIVE</code> </pre> <br><p> ä¸Šé¢çš„å‘½ä»¤å°†åˆ›å»ºä¸€ä¸ªé»˜è®¤èŠ‚ç‚¹æ± ï¼Œå…¶ä¸­åŒ…æ‹¬ä¸¤ä¸ª<code>n1-standard-2</code>è™šæ‹Ÿæœºï¼ˆvCPUï¼š2ï¼ŒRAM 7.5 GBï¼Œç£ç›˜ï¼š30 GBï¼‰ã€‚ ç†æƒ³æƒ…å†µä¸‹ï¼Œå€¼å¾—å°†Istioç»„ä»¶ä¸å…¶å·¥ä½œè´Ÿè½½éš”ç¦»å¼€æ¥ï¼Œä½†æ˜¯æ²¡æœ‰ç®€å•çš„æ–¹æ³•å¯ä»¥åœ¨ä¸“ç”¨èŠ‚ç‚¹æ± ä¸­è¿è¡ŒIstioåŠèˆ±ã€‚  Istioæ¸…å•è¢«è§†ä¸ºåªè¯»æ¸…å•ï¼ŒGKEå°†æ’¤æ¶ˆä»»ä½•æ›´æ”¹ï¼Œä¾‹å¦‚ç»‘å®šåˆ°èŠ‚ç‚¹æˆ–ä¸ç‚‰è†›æ–­å¼€è¿æ¥ã€‚ </p><br><p> é…ç½®<code>kubectl</code>å‡­æ®ï¼š </p><br><pre> <code class="plaintext hljs">gcloud container clusters get-credentials istio</code> </pre> <br><p> åˆ›å»ºé›†ç¾¤ç®¡ç†å‘˜è§’è‰²ç»‘å®šï¼š </p><br><pre> <code class="plaintext hljs">kubectl create clusterrolebinding "cluster-admin-$(whoami)" \ --clusterrole=cluster-admin \ --user="$(gcloud config get-value core/account)"</code> </pre> <br><p> å®‰è£…<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Helm</a>å‘½ä»¤è¡Œå·¥å…·ï¼š </p><br><pre> <code class="plaintext hljs">brew install kubernetes-helm</code> </pre> <br><p>  Homebrew 2.0ç°åœ¨ä¹Ÿå¯ç”¨äº<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Linux</a> ã€‚ </p><br><p> ä¸ºTilleråˆ›å»ºæœåŠ¡å¸æˆ·å’Œé›†ç¾¤è§’è‰²ç»‘å®šï¼š </p><br><pre> <code class="plaintext hljs">kubectl -n kube-system create sa tiller &amp;&amp; \ kubectl create clusterrolebinding tiller-cluster-rule \ --clusterrole=cluster-admin \ --serviceaccount=kube-system:tiller</code> </pre> <br><p> åœ¨<code>kube-system</code>å±•å¼€Tillerï¼š </p><br><pre> <code class="plaintext hljs">helm init --service-account tiller</code> </pre> <br><p> æ‚¨åº”è¯¥è€ƒè™‘åœ¨Helmå’ŒTillerä¹‹é—´ä½¿ç”¨SSLã€‚ æœ‰å…³ä¿æŠ¤Helmå®‰è£…çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">docs.helm.sh</a> </p><br><p> ç¡®è®¤è®¾ç½®ï¼š </p><br><pre> <code class="plaintext hljs">kubectl -n istio-system get svc</code> </pre> <br><p> å‡ ç§’é’Ÿåï¼ŒGCPåº”è¯¥ä¸º<code>istio-ingressgateway</code>åˆ†é…ä¸€ä¸ªå¤–éƒ¨IPåœ°å€ã€‚ </p><br><h3 id="nastroyka-vhodnogo-shlyuza-istio">  Istioè¾“å…¥ç½‘å…³è®¾ç½® </h3><br><p> ä½¿ç”¨<code>istio-gateway</code>çš„IPåœ°å€åˆ›å»ºä¸€ä¸ªç§°ä¸º<code>istio-gateway</code>çš„é™æ€IPåœ°å€ï¼š </p><br><pre> <code class="plaintext hljs">export GATEWAY_IP=$(kubectl -n istio-system get svc/istio-ingressgateway -ojson | jq -r .status.loadBalancer.ingress[0].ip) gcloud compute addresses create istio-gateway --addresses ${GATEWAY_IP} --region us-central1</code> </pre> <br><p> ç°åœ¨ï¼Œæ‚¨éœ€è¦ä¸€ä¸ªInternetåŸŸå¹¶å¯ä»¥è®¿é—®æ‚¨çš„DNSæ³¨å†Œå™¨ã€‚ æ·»åŠ ä¸¤ä¸ªAæ¡ç›®ï¼ˆç”¨æ‚¨çš„åŸŸæ›¿æ¢<code>example.com</code> ï¼‰ï¼š </p><br><pre> <code class="plaintext hljs">istio.example.com A ${GATEWAY_IP} *.istio.example.com A ${GATEWAY_IP}</code> </pre> <br><p> éªŒè¯DNSé€šé…ç¬¦æ˜¯å¦æ­£å¸¸å·¥ä½œï¼š </p><br><pre> <code class="plaintext hljs">watch host test.istio.example.com</code> </pre> <br><p> åˆ›å»ºä¸€ä¸ªIstioé€šç”¨ç½‘å…³ï¼Œä»¥é€šè¿‡HTTPåœ¨æœåŠ¡ç½‘æ ¼ä¹‹å¤–æä¾›æœåŠ¡ï¼š </p><br><pre> <code class="plaintext hljs">apiVersion: networking.istio.io/v1alpha3 kind: Gateway metadata: name: public-gateway namespace: istio-system spec: selector: istio: ingressgateway servers: - port: number: 80 name: http protocol: HTTP hosts: - "*"</code> </pre> <br><p> å°†ä»¥ä¸Šèµ„æºå¦å­˜ä¸ºpublic-gateway.yamlï¼Œç„¶ååº”ç”¨å®ƒï¼š </p><br><pre> <code class="plaintext hljs">kubectl apply -f ./public-gateway.yaml</code> </pre> <br><p> æ²¡æœ‰SSLï¼Œä»»ä½•ç”Ÿäº§ç³»ç»Ÿéƒ½ä¸èƒ½åœ¨Internetä¸Šæä¾›æœåŠ¡ã€‚ è¦ä½¿ç”¨cert-managerï¼ŒCloudDNSå’ŒLet's Encryptä¿æŠ¤Istioç½‘å…³ï¼Œè¯·é˜…è¯»Flagger GKE <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ–‡æ¡£</a> ã€‚ </p><br><h3 id="ustanovka-flagger"> æ——æ†å®‰è£… </h3><br><p>  GKE IstioåŠ è½½é¡¹ä¸åŒ…æ‹¬Prometheuså®ä¾‹ï¼Œè¯¥å®ä¾‹æ¸…é™¤äº†Istioé¥æµ‹æœåŠ¡ã€‚ ç”±äºFlaggerä½¿ç”¨Istio HTTPæŒ‡æ ‡æ‰§è¡Œé‡‘ä¸é›€åˆ†æï¼Œå› æ­¤æ‚¨éœ€è¦éƒ¨ç½²ä»¥ä¸‹Prometheusé…ç½®ï¼Œç±»ä¼¼äºå®˜æ–¹Istio Helmæ–¹æ¡ˆéšé™„çš„é…ç½®ã€‚ </p><br><pre> <code class="plaintext hljs">REPO=https://raw.githubusercontent.com/stefanprodan/flagger/master kubectl apply -f ${REPO}/artifacts/gke/istio-prometheus.yaml</code> </pre> <br><p> æ·»åŠ Flagger Helmå­˜å‚¨åº“ï¼š </p><br><pre> <code class="plaintext hljs">helm repo add flagger https://flagger.app</code> </pre> <br><p>  <code>istio-system</code>å¯ç”¨Sâ€‹â€‹lacké€šçŸ¥ï¼Œåœ¨istio -system <code>istio-system</code>å±•å¼€Flaggerï¼š </p><br><pre> <code class="plaintext hljs">helm upgrade -i flagger flagger/flagger \ --namespace=istio-system \ --set metricsServer=http://prometheus.istio-system:9090 \ --set slack.url=https://hooks.slack.com/services/YOUR-WEBHOOK-ID \ --set slack.channel=general \ --set slack.user=flagger</code> </pre> <br><p> å¦‚æœFlaggerå¯ä»¥é€šè¿‡ç«¯å£9090ä¸Istio PrometheusæœåŠ¡è¿›è¡Œé€šä¿¡ï¼Œåˆ™å¯ä»¥åœ¨ä»»ä½•åç§°ç©ºé—´ä¸­å®‰è£…Flaggerã€‚ </p><br><p>  Flaggerå…·æœ‰ç”¨äºé‡‘ä¸é›€åˆ†æçš„Grafanaä»ªè¡¨æ¿ã€‚ åœ¨<code>istio-system</code>å®‰è£…Grafanaï¼š </p><br><pre> <code class="plaintext hljs">helm upgrade -i flagger-grafana flagger/grafana \ --namespace=istio-system \ --set url=http://prometheus.istio-system:9090 \ --set user=admin \ --set password=change-me</code> </pre> <br><p> é€šè¿‡åˆ›å»ºè™šæ‹ŸæœåŠ¡ï¼Œé€šè¿‡å¼€æ”¾çš„ç½‘å…³æ‰©å±•Grafanaï¼ˆå°†<code>example.com</code>æ›¿æ¢ä¸ºæ‚¨çš„åŸŸï¼‰ï¼š </p><br><pre> <code class="plaintext hljs">apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: grafana namespace: istio-system spec: hosts: - "grafana.istio.example.com" gateways: - public-gateway.istio-system.svc.cluster.local http: - route: - destination: host: flagger-grafana</code> </pre> <br><p> å°†ä»¥ä¸Šèµ„æºå¦å­˜ä¸ºgrafana-virtual-service.yamlï¼Œç„¶ååº”ç”¨å®ƒï¼š </p><br><pre> <code class="plaintext hljs">kubectl apply -f ./grafana-virtual-service.yaml</code> </pre> <br><p> åœ¨æµè§ˆå™¨ä¸­è½¬åˆ°<code>http://grafana.istio.example.com</code>æ—¶ï¼Œåº”å°†æ‚¨å®šå‘åˆ°Grafanaç™»å½•é¡µé¢ã€‚ </p><br><h3 id="deploy-veb-prilozheniy-s-flagger"> ä½¿ç”¨Flaggerè¿›è¡ŒWebåº”ç”¨ç¨‹åºéƒ¨ç½² </h3><br><p>  Flaggeréƒ¨ç½²Kubernetesï¼Œå¹¶åœ¨å¿…è¦æ—¶éƒ¨ç½²æ°´å¹³è‡ªåŠ¨ç¼©æ”¾ï¼ˆHPAï¼‰ï¼Œç„¶ååˆ›å»ºä¸€ç³»åˆ—å¯¹è±¡ï¼ˆKuberneteséƒ¨ç½²ï¼ŒClusterIPæœåŠ¡å’ŒIstioè™šæ‹ŸæœåŠ¡ï¼‰ã€‚ è¿™äº›å¯¹è±¡åœ¨æœåŠ¡ç½‘æ ¼ä¸­æ‰“å¼€åº”ç”¨ç¨‹åºï¼Œå¹¶ç®¡ç†é‡‘ä¸é›€åˆ†æå’Œå‡çº§ã€‚ </p><br><p> <a href=""><img src="https://habrastorage.org/webt/la/cg/h5/lacgh59saaxevwtpgoiby77xe7u.png"></a> </p><br><p> åˆ›å»ºå¯ç”¨Istio Sidecarå®ç°çš„æµ‹è¯•åç§°ç©ºé—´ï¼š </p><br><pre> <code class="plaintext hljs">REPO=https://raw.githubusercontent.com/stefanprodan/flagger/master kubectl apply -f ${REPO}/artifacts/namespaces/test.yaml</code> </pre> <br><p> åˆ›å»ºä¸€ä¸ªéƒ¨ç½²å’Œç‚‰è†›è‡ªåŠ¨æ°´å¹³ç¼©æ”¾å·¥å…·ï¼š </p><br><pre> <code class="plaintext hljs">kubectl apply -f ${REPO}/artifacts/canaries/deployment.yaml kubectl apply -f ${REPO}/artifacts/canaries/hpa.yaml</code> </pre> <br><p> éƒ¨ç½²æµ‹è¯•è´Ÿè½½æœåŠ¡ä»¥åœ¨é‡‘ä¸é›€åˆ†ææœŸé—´ç”Ÿæˆæµé‡ï¼š </p><br><pre> <code class="plaintext hljs">helm upgrade -i flagger-loadtester flagger/loadtester \ --namepace=test</code> </pre> <br><p> åˆ›å»ºè‡ªå®šä¹‰é‡‘ä¸é›€èµ„æºï¼ˆç”¨æ‚¨çš„åŸŸæ›¿æ¢<code>example.com</code> ï¼‰ï¼š </p><br><pre> <code class="plaintext hljs">apiVersion: flagger.app/v1alpha3 kind: Canary metadata: name: podinfo namespace: test spec: targetRef: apiVersion: apps/v1 kind: Deployment name: podinfo progressDeadlineSeconds: 60 autoscalerRef: apiVersion: autoscaling/v2beta1 kind: HorizontalPodAutoscaler name: podinfo service: port: 9898 gateways: - public-gateway.istio-system.svc.cluster.local hosts: - app.istio.example.com canaryAnalysis: interval: 30s threshold: 10 maxWeight: 50 stepWeight: 5 metrics: - name: istio_requests_total threshold: 99 interval: 30s - name: istio_request_duration_seconds_bucket threshold: 500 interval: 30s webhooks: - name: load-test url: http://flagger-loadtester.test/ timeout: 5s metadata: cmd: "hey -z 1m -q 10 -c 2 http://podinfo.test:9898/"</code> </pre> <br><p> å°†ä»¥ä¸Šèµ„æºå¦å­˜ä¸ºpodinfo-canary.yamlï¼Œç„¶ååº”ç”¨å®ƒï¼š </p><br><pre> <code class="plaintext hljs">kubectl apply -f ./podinfo-canary.yaml</code> </pre> <br><p> å¦‚æœæˆåŠŸï¼Œä»¥ä¸Šåˆ†æå°†åœ¨äº”åˆ†é’Ÿå†…æ‰§è¡Œï¼Œæ¯åŠåˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡HTTPæŒ‡æ ‡ã€‚ æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å…¬å¼ç¡®å®šéªŒè¯å’Œå‡çº§Canaryéƒ¨ç½²æ‰€éœ€çš„æœ€çŸ­æ—¶é—´ï¼š <code>interval * (maxWeight / stepWeight)</code> ã€‚ é‡‘ä¸é›€CRDå­—æ®µè®°å½•<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">åœ¨è¿™é‡Œ</a> ã€‚ </p><br><p> åœ¨å‡ ç§’é’Ÿå†…ï¼ŒFlaggerå°†åˆ›å»ºé‡‘ä¸é›€å¯¹è±¡ï¼š </p><br><pre> <code class="plaintext hljs"># applied deployment.apps/podinfo horizontalpodautoscaler.autoscaling/podinfo canary.flagger.app/podinfo # generated deployment.apps/podinfo-primary horizontalpodautoscaler.autoscaling/podinfo-primary service/podinfo service/podinfo-canary service/podinfo-primary virtualservice.networking.istio.io/podinfo</code> </pre> <br><p> æ‰“å¼€æµè§ˆå™¨å¹¶è½¬åˆ°<code>app.istio.example.com</code> ï¼Œæ‚¨åº”è¯¥çœ‹åˆ°<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ¼”ç¤ºåº”ç”¨ç¨‹åº</a>çš„ç‰ˆæœ¬å·ã€‚ </p><br><h3 id="avtomaticheskiy-canary-analiz-i-prodvizhenie"> è‡ªåŠ¨é‡‘ä¸é›€åˆ†æå’Œæ¨å¹¿ </h3><br><p>  Flaggerå®ç°äº†ä¸€ä¸ªæ§åˆ¶ç¯è·¯ï¼Œè¯¥ç¯è·¯å°†æµé‡é€æ¸ç§»è‡³Canaryï¼ŒåŒæ—¶æµ‹é‡å…³é”®æ€§èƒ½æŒ‡æ ‡ï¼Œä¾‹å¦‚HTTPè¯·æ±‚çš„æˆåŠŸç‡ï¼Œå¹³å‡è¯·æ±‚æŒç»­æ—¶é—´å’Œå¿ƒè·³æ€§èƒ½ã€‚ æ ¹æ®åˆ†æï¼ŒKPIé‡‘ä¸é›€å‰è¿›æˆ–è¢«ä¸­æ–­ï¼Œåˆ†æç»“æœå‘å¸ƒåœ¨Slackä¸­ã€‚ </p><br><p> <a href=""><img src="https://habrastorage.org/webt/bw/85/ua/bw85uavib13od3yhfyv7yaqbdmo.png"></a> </p><br><p> å½“ä¸‹åˆ—å¯¹è±¡ä¹‹ä¸€æ›´æ”¹æ—¶ï¼Œé‡‘ä¸é›€éƒ¨ç½²å¼€å§‹ï¼š </p><br><ul><li> éƒ¨ç½²PodSpecï¼ˆå®¹å™¨æ˜ åƒï¼Œå‘½ä»¤ï¼Œç«¯å£ï¼Œç¯å¢ƒç­‰ï¼‰ </li><li>  ConfigMapä½œä¸ºå·å®‰è£…æˆ–è½¬æ¢ä¸ºç¯å¢ƒå˜é‡ </li><li> æœºå¯†ä½œä¸ºå·å®‰è£…æˆ–è½¬æ¢ä¸ºç¯å¢ƒå˜é‡ </li></ul><br><p> æ›´æ–°å®¹å™¨æ˜ åƒæ—¶å¯åŠ¨é‡‘ä¸é›€éƒ¨ç½²ï¼š </p><br><pre> <code class="plaintext hljs">kubectl -n test set image deployment/podinfo \ podinfod=quay.io/stefanprodan/podinfo:1.4.1</code> </pre> <br><p>  Flaggerå‘ç°éƒ¨ç½²ç‰ˆæœ¬å·²æ›´æ”¹ï¼Œå¹¶å¼€å§‹å¯¹å…¶è¿›è¡Œåˆ†æï¼š </p><br><pre> <code class="plaintext hljs">kubectl -n test describe canary/podinfo Events: New revision detected podinfo.test Scaling up podinfo.test Waiting for podinfo.test rollout to finish: 0 of 1 updated replicas are available Advance podinfo.test canary weight 5 Advance podinfo.test canary weight 10 Advance podinfo.test canary weight 15 Advance podinfo.test canary weight 20 Advance podinfo.test canary weight 25 Advance podinfo.test canary weight 30 Advance podinfo.test canary weight 35 Advance podinfo.test canary weight 40 Advance podinfo.test canary weight 45 Advance podinfo.test canary weight 50 Copying podinfo.test template spec to podinfo-primary.test Waiting for podinfo-primary.test rollout to finish: 1 of 2 updated replicas are available Promotion completed! Scaling down podinfo.test</code> </pre> <br><p> åœ¨åˆ†æè¿‡ç¨‹ä¸­ï¼Œå¯ä»¥ä½¿ç”¨Grafanaè·Ÿè¸ªé‡‘ä¸é›€çš„ç»“æœï¼š </p><br><p> <a href=""><img src="https://habrastorage.org/webt/so/xr/cr/soxrcrt3wvsgtnbwpukfwbzityy.png"></a> </p><br><p> è¯·æ³¨æ„ï¼šå¦‚æœåœ¨é‡‘ä¸é›€åˆ†ææœŸé—´å°†æ–°æ›´æ”¹åº”ç”¨äºéƒ¨ç½²ï¼ŒFlaggerå°†é‡æ–°å¯åŠ¨åˆ†æé˜¶æ®µã€‚ </p><br><p> åˆ—å‡ºé›†ç¾¤ä¸­æ‰€æœ‰â€œé‡‘ä¸é›€â€ï¼š </p><br><pre> <code class="plaintext hljs">watch kubectl get canaries --all-namespaces NAMESPACE NAME STATUS WEIGHT LASTTRANSITIONTIME test podinfo Progressing 15 2019-01-16T14:05:07Z prod frontend Succeeded 0 2019-01-15T16:15:07Z prod backend Failed 0 2019-01-14T17:05:07Z</code> </pre> <br><p> å¦‚æœå¯ç”¨äº†Slacké€šçŸ¥ï¼Œæ‚¨å°†æ”¶åˆ°ä»¥ä¸‹æ¶ˆæ¯ï¼š </p><br><p> <a href=""><img src="https://habrastorage.org/webt/xx/0v/cn/xx0vcnpcarb8nb3xivkmfz_6pfw.png"></a> </p><br><h3 id="avtomaticheskiy-otkat"> è‡ªåŠ¨å›æ»š </h3><br><p> åœ¨é‡‘ä¸é›€åˆ†ææœŸé—´ï¼Œæ‚¨å¯èƒ½ä¼šç”Ÿæˆç»¼åˆHTTP 500é”™è¯¯å’Œè¾ƒé«˜çš„å“åº”å»¶è¿Ÿï¼Œä»¥æ£€æŸ¥Flaggeræ˜¯å¦å°†åœæ­¢éƒ¨ç½²ã€‚ </p><br><p> åˆ›å»ºä¸€ä¸ªæµ‹è¯•å­å¹¶åœ¨å…¶ä¸­æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š </p><br><pre> <code class="plaintext hljs">kubectl -n test run tester \ --image=quay.io/stefanprodan/podinfo:1.2.1 \ -- ./podinfo --port=9898 kubectl -n test exec -it tester-xx-xx sh</code> </pre> <br><p>  HTTP 500é”™è¯¯ç”Ÿæˆï¼š </p><br><pre> <code class="plaintext hljs">watch curl http://podinfo-canary:9898/status/500</code> </pre> <br><p> å»¶è¿Ÿäº§ç”Ÿï¼š </p><br><pre> <code class="plaintext hljs">watch curl http://podinfo-canary:9898/delay/1</code> </pre> <br><p> å½“æ£€æŸ¥å¤±è´¥æ¬¡æ•°è¾¾åˆ°é˜ˆå€¼æ—¶ï¼Œæµé‡å°†è·¯ç”±å›åˆ°ä¸»é€šé“ï¼Œcanaryè¢«ç¼©æ”¾ä¸ºé›¶ï¼Œå¹¶ä¸”éƒ¨ç½²è¢«æ ‡è®°ä¸ºä¸æˆåŠŸã€‚ </p><br><p>  Canaryé”™è¯¯å’Œå»¶è¿Ÿå³°å€¼å°†ä½œä¸ºKubernetesäº‹ä»¶è®°å½•ä¸‹æ¥ï¼Œå¹¶ç”±Flaggerä»¥JSONæ ¼å¼è®°å½•ï¼š </p><br><pre> <code class="plaintext hljs">kubectl -n istio-system logs deployment/flagger -f | jq .msg Starting canary deployment for podinfo.test Advance podinfo.test canary weight 5 Advance podinfo.test canary weight 10 Advance podinfo.test canary weight 15 Halt podinfo.test advancement success rate 69.17% &lt; 99% Halt podinfo.test advancement success rate 61.39% &lt; 99% Halt podinfo.test advancement success rate 55.06% &lt; 99% Halt podinfo.test advancement success rate 47.00% &lt; 99% Halt podinfo.test advancement success rate 37.00% &lt; 99% Halt podinfo.test advancement request duration 1.515s &gt; 500ms Halt podinfo.test advancement request duration 1.600s &gt; 500ms Halt podinfo.test advancement request duration 1.915s &gt; 500ms Halt podinfo.test advancement request duration 2.050s &gt; 500ms Halt podinfo.test advancement request duration 2.515s &gt; 500ms Rolling back podinfo.test failed checks threshold reached 10 Canary failed! Scaling down podinfo.test</code> </pre> <br><p> å¦‚æœå¯ç”¨äº†Slacké€šçŸ¥ï¼Œåˆ™åœ¨è¾¾åˆ°æœŸé™æˆ–è¾¾åˆ°åˆ†æè¿‡ç¨‹ä¸­å¤±è´¥æ£€æŸ¥çš„æœ€å¤§æ•°é‡æ—¶ï¼Œæ‚¨å°†æ”¶åˆ°ä¸€æ¡æ¶ˆæ¯ï¼š </p><br><p> <a href=""><img src="https://habrastorage.org/webt/wo/te/dq/wotedqdhoxxyhjug_lcuy57wno0.png"></a> </p><br><h3 id="v-zaklyuchenie"> æ€»ç»“ </h3><br><p> é™¤äº†å¯åŠ¨Kuberneteså¤–ï¼Œå¯åŠ¨Istioç­‰æœåŠ¡ç½‘æ ¼å°†æä¾›è‡ªåŠ¨æŒ‡æ ‡ï¼Œæ—¥å¿—å’Œåè®®ï¼Œä½†æ˜¯å·¥ä½œè´Ÿè½½çš„éƒ¨ç½²ä»ç„¶å–å†³äºå¤–éƒ¨å·¥å…·ã€‚  Flaggerè¯•å›¾é€šè¿‡æ·»åŠ Istioçš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ¸è¿›å¼äº¤ä»˜</a>åŠŸèƒ½æ¥æ”¹å˜è¿™ä¸€çŠ¶å†µã€‚ </p><br><p>  Flaggerä¸ä»»ä½•Kubernetes CI / CDè§£å†³æ–¹æ¡ˆå…¼å®¹ï¼Œå¹¶ä¸”å¯ä»¥ä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">webhooks</a>è½»æ¾æ‰©å±•canaryåˆ†æï¼Œä»¥æ‰§è¡Œç³»ç»Ÿé›†æˆ/éªŒæ”¶æµ‹è¯•ï¼Œå‹åŠ›æµ‹è¯•æˆ–ä»»ä½•å…¶ä»–ç”¨æˆ·æµ‹è¯•ã€‚ å› ä¸ºFlaggeræ˜¯å£°æ˜æ€§çš„ï¼Œå¹¶ä¸”å¯¹Kubernetesäº‹ä»¶ä½œå‡ºå“åº”ï¼Œæ‰€ä»¥å¯ä»¥å°†å…¶ä¸<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Weave Flux</a>æˆ–<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">JenkinsX</a>ä¸€èµ·ç”¨äºGitOpsç®¡é“ã€‚ å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯JenkinsXï¼Œåˆ™å¯ä»¥å®‰è£…å¸¦æœ‰jxé™„åŠ ç»„ä»¶çš„Flaggerã€‚ </p><br><p>  Flaggerå—<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Weaveworks</a>æ”¯æŒï¼Œå¹¶ä¸º<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Weave Cloud</a>æä¾›é‡‘ä¸é›€éƒ¨ç½²ã€‚ è¯¥é¡¹ç›®åœ¨GKEï¼ŒEXå’Œå¸¦æœ‰kubeadmçš„è£¸æœºä¸Šè¿›è¡Œäº†æµ‹è¯•ã€‚ </p><br><p> å¦‚æœæ‚¨æœ‰ä»»ä½•æ”¹è¿›Flaggerçš„å»ºè®®ï¼Œè¯·é€šè¿‡<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">stefanprodan / flagger</a>å‘GitHubå‘é€é—®é¢˜æˆ–PRã€‚ æ¬¢è¿ææ¬¾ï¼ </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ›¾è«æƒ</a> ã€‚ </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN444808/">https://habr.com/ru/post/zh-CN444808/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN444796/index.html">æ‹–æ‹‰æœºé€†å‘å·¥ç¨‹ï¼šå¦‚ä½•å°†æµ‹é‡è¿‡ç¨‹åŠ å¿«ä¸€åŠ</a></li>
<li><a href="../zh-CN444798/index.html">DUMPä¼šè®®çš„â€œå‰ç«¯â€éƒ¨åˆ†æ¦‚è¿°ï¼šæ•´ä¸ªå‰ç«¯å¼€å‘</a></li>
<li><a href="../zh-CN444800/index.html">å¼€æºå¹¶ä¸èƒ½èµšé’±ï¼Œå› ä¸ºå®ƒä¸æ˜¯ä¸ºæ­¤è€Œåˆ›å»ºçš„</a></li>
<li><a href="../zh-CN444804/index.html">BTC-eäº¤æ˜“æ‰€è¿è¥å•†è¦æ±‚å°†å…¶å¼•æ¸¡åˆ°ä¿„ç½—æ–¯</a></li>
<li><a href="../zh-CN444806/index.html">Moiraå‚åŠ äº†Google Summer of Code 2019</a></li>
<li><a href="../zh-CN444810/index.html">è®¡ç®—æœºæŠ€æœ¯ä¸­çš„å¤„ç†å™¨å’Œè¥é”€</a></li>
<li><a href="../zh-CN444814/index.html">Javaä¸­çš„å¯†ç å­¦ã€‚ ç±»å¯†ç </a></li>
<li><a href="../zh-CN444816/index.html">DIYæœ¨å·¥ï¼šæœŸæœ›ä¸ç°å®</a></li>
<li><a href="../zh-CN444818/index.html">Citymobil-åˆ›ä¸šå…¬å¸åœ¨å¢é•¿ä¸­æé«˜ç¨³å®šæ€§çš„æŒ‡å—ã€‚ ç¬¬ä¸€éƒ¨åˆ†</a></li>
<li><a href="../zh-CN444820/index.html">Mockdownï¼šåˆ›å»ºçº¿æ¡†çš„æœ€å¿«æ–¹æ³•</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>