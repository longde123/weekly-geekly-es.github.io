<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚úñÔ∏è üë®üèø‚Äçü§ù‚Äçüë®üèæ üî† Em todo o mundo em 4 segundos no Columnstore (parte 1) üßôüèº üçî ‚úãüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Neste artigo, vou considerar aumentar a velocidade dos relat√≥rios. Por um relat√≥rio, quero dizer qualquer consulta a um banco de dados que use fun√ß√µes...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Em todo o mundo em 4 segundos no Columnstore (parte 1)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/472396/">  Neste artigo, vou considerar aumentar a velocidade dos relat√≥rios.  Por um relat√≥rio, quero dizer qualquer consulta a um banco de dados que use fun√ß√µes agregadas.  Al√©m disso, abordarei quest√µes relacionadas aos recursos gastos na produ√ß√£o e suporte de relat√≥rios, humanos e m√°quinas. <br><br>  Nos exemplos, usarei um conjunto de dados contendo 52.608.000 registros. <br><br>  Usando o exemplo de reservas anal√≠ticas n√£o dif√≠ceis, demonstrarei que mesmo um computador fraco pode ser transformado em uma boa ferramenta para analisar uma quantidade "decente" de dados sem muito esfor√ßo. <br><br>  Depois de configurar experimentos n√£o complicados, veremos que uma tabela regular n√£o √© uma fonte adequada para consultas anal√≠ticas. <br><br>  Se o leitor puder decifrar facilmente as abrevia√ß√µes OLTP e OLAP, pode fazer sentido ir diretamente para a se√ß√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Columnstore</a> <br><br><h4>  Duas abordagens para trabalhar com dados </h4> <br>  Aqui vou ser breve, porque  H√° informa√ß√µes mais do que suficientes sobre esse t√≥pico na Internet. <br><br>  Portanto, no n√≠vel mais alto, existem apenas duas abordagens para trabalhar com dados: OLTP e OLAP. <br><br>  OLTP - pode ser traduzido como processamento instant√¢neo de transa√ß√£o.  De fato, estamos falando sobre o processamento on-line de transa√ß√µes curtas que funcionam com uma pequena quantidade de dados.  Por exemplo, gravando, atualizando ou excluindo um pedido.  Na grande maioria dos casos, um pedido √© uma quantidade extremamente pequena de dados, durante o processamento dos quais voc√™ n√£o pode ter medo dos longos bloqueios impostos pelo RDBMS moderno. <br><br>  OLAP - pode ser traduzido como processamento anal√≠tico de um grande n√∫mero de transa√ß√µes por vez.  Qualquer relat√≥rio usa essa abordagem espec√≠fica, porque, na grande maioria dos casos, produz relat√≥rios resumidos e agregados para determinadas se√ß√µes. <br><a name="habracut"></a><br>  Cada abordagem tem sua pr√≥pria tecnologia.  Por exemplo, para OLTP, √© PostgreSQL e, para OLAP, √© Microsoft SQL Server Analysis Services.  Enquanto o PostgresSQL usa um formato conhecido para armazenar dados em tabelas, v√°rios formatos diferentes foram inventados para o OLAP.  Estas s√£o tabelas multidimensionais, balde cheio de pares de valores-chave e meu columnstore favorito.  Sobre o √∫ltimo em mais detalhes abaixo. <br><br><h4>  Por que s√£o necess√°rias duas abordagens? </h4><br>  Observou-se que qualquer data warehouse, mais cedo ou mais tarde, enfrenta dois tipos de carga: leitura frequente (grava√ß√£o e atualiza√ß√£o, √© claro, tamb√©m) de quantidades extremamente pequenas de dados e leitura rara, mas quantidades muito grandes.  De fato, essa √© uma atividade, por exemplo, da bilheteria e da cabe√ßa.  O balc√£o de caixa, trabalhando o dia todo, preenche o armazenamento com pequenos peda√ßos de dados, enquanto no final do dia o volume acumulado, se o neg√≥cio est√° indo bem, atinge tamanho impressionante.  Por sua vez, o gerente no final do dia quer saber quanto dinheiro a bilheteria ganha por dia. <br><br>  Portanto, no OLTP, temos tabelas e √≠ndices.  Essas duas ferramentas s√£o √≥timas para registrar as atividades de bilheteria com todos os detalhes.  Os √≠ndices fornecem uma pesquisa r√°pida para um pedido gravado anteriormente, portanto, √© f√°cil alterar um pedido.  Mas, para satisfazer as necessidades do l√≠der, precisamos considerar toda a quantidade de dados acumulados por dia.  Al√©m disso, como regra, o gerente n√£o precisa de todos os detalhes de todos os pedidos.  O que ele realmente precisa saber √© quanto dinheiro a bilheteria ganhou em geral.  N√£o importa onde fica a bilheteria, quando houve uma pausa para o almo√ßo, quem trabalhou para ela etc.  O OLAP existe ent√£o, para que, em um curto per√≠odo de tempo, o sistema possa responder √† pergunta - quanto a empresa ganhou como um todo sem leitura sequencial de cada pedido e todos os seus detalhes.  O OLAP pode usar as mesmas tabelas e √≠ndices que o OLTP?  A resposta √© n√£o, pelo menos n√£o deveria.  Em primeiro lugar, porque o OLAP simplesmente n√£o precisa de todos os detalhes registrados nas tabelas.  Esse problema √© resolvido armazenando dados em outros formatos que n√£o sejam tabelas bidimensionais.  Em segundo lugar, as informa√ß√µes analisadas geralmente est√£o espalhadas por diferentes tabelas, o que implica v√°rias associa√ß√µes, incluindo associa√ß√µes do tipo de auto-jun√ß√£o.  Para resolver esse problema, eles geralmente desenvolvem um esquema especial de banco de dados.  Esse esquema √© otimizado para carga OLAP, bem como o esquema normalizado normal para carga OLTP. <br><br><h4>  O que acontece quando o OLAP usa um esquema OLTP </h4><br>  De fato, apresentei esta se√ß√£o para que este artigo atenda claramente aos meus pr√≥prios requisitos para o formato desse material, ou seja,  problema, solu√ß√£o, conclus√£o. <br><br>  Listamos v√°rias desvantagens do uso de esquemas OLTP para an√°lise de dados. <br><br><ul><li>  Muitos √≠ndices. <br><br>  <i>Muitas vezes, voc√™ precisa criar √≠ndices especiais para dar suporte a relat√≥rios.</i>  <i>Esses √≠ndices implementam um esquema de armazenamento de dados OLAP.</i>  <i>Eles n√£o s√£o usados ‚Äã‚Äãpela parte OLTP do aplicativo, enquanto exercem uma carga nele, exigindo suporte constante e ocupando espa√ßo em disco.</i> </li><li>  A quantidade de dados lidos excede o necess√°rio. </li><li>  Falta de um esquema de dados claro. <br><br>  <i>O fato √© que muitas vezes as informa√ß√µes enviadas pelos relat√≥rios em um √∫nico formul√°rio est√£o espalhadas em tabelas diferentes.</i>  <i>Essa informa√ß√£o requer constante transforma√ß√£o em tempo real.</i>  <i>O exemplo mais simples √© o valor da receita, que consiste em dinheiro e n√£o dinheiro.</i>  <i>Outro exemplo impressionante s√£o as hierarquias de dados.</i>  <i>Porque</i>  <i>Como o desenvolvimento de aplicativos √© progressivo e nem sempre se sabe o que ser√° necess√°rio no futuro, a mesma hierarquia de significado pode ser armazenada em tabelas diferentes.</i>  <i>E enquanto a aquisi√ß√£o on-the-fly √© usada ativamente no OLAP, essas s√£o coisas ligeiramente diferentes.</i> </li><li>  Complexidade excessiva de consultas. <br><br>  <i>Porque</i>  <i>Um esquema OLTP difere de um OLAP √â necess√°ria uma camada de software fortemente relacionada que traga o esquema de dados OLTP para a forma correta.</i> </li><li>  Complexidade de suporte, depura√ß√£o e desenvolvimento. <br><br>  <i>Em geral, podemos dizer que quanto mais complexa a base de c√≥digo, mais dif√≠cil √© mant√™-la em um estado √≠ntegro.</i>  <i>Este √© um axioma.</i> </li><li>  A complexidade da cobertura do teste. <br><br>  <i>Muitas c√≥pias foram quebradas devido a discuss√µes sobre como obter um banco de dados cheio de todos os scripts de teste, mas √© melhor dizer que, com um esquema de dados mais simples, a tarefa de cobrir os testes √© simplificada muitas vezes.</i> </li><li>  Depura√ß√£o de desempenho sem fim. <br><br>  <i>H√° uma alta probabilidade de o usu√°rio solicitar um relat√≥rio "pesado" para o servidor de banco de dados.</i>  <i>Essa probabilidade aumenta com o tempo.</i>  <i>Deve-se observar que o OLAP tamb√©m √© propenso a esse problema, mas, diferentemente do OLTP, o recurso OLAP nesse assunto √© muito maior.</i> </li></ul><br> <b><a name="cs"></a></b>  <b>Columnstore</b> <br><br>  Este artigo focar√° no formato de armazenamento columnstore, mas sem detalhes de baixo n√≠vel.  Outros formatos mencionados acima tamb√©m merecem aten√ß√£o, mas este √© um t√≥pico para outro artigo. <br><br>  Na verdade, o formato columnstore √© conhecido h√° 30 anos, mas n√£o foi implementado no RDBMS at√© recentemente.  A ess√™ncia do columnstore √© que os dados s√£o armazenados n√£o em linhas, mas em colunas.  I.e.  em uma p√°gina (todos conhecidos 8 Kb), o servidor registra dados de apenas um campo.  E assim, com cada campo da tabela, por sua vez.  Isso √© necess√°rio para que voc√™ n√£o precise ler informa√ß√µes extras.  Vamos imaginar uma tabela com 10 campos e uma consulta que tenha apenas um campo especificado na instru√ß√£o SELECT.  Se fosse uma tabela regular salva em um formato baseado em linhas, o servidor seria for√ßado a ler todos os 10 campos, mas ao mesmo tempo retornaria apenas um.  Acontece que o servidor leu 9 vezes mais informa√ß√µes do que o necess√°rio.  O columnstore resolve completamente esse problema, porque  O formato de armazenamento permite que voc√™ leia apenas um campo solicitado.  Tudo isso acontece porque a unidade de armazenamento em um RDBMS √© uma p√°gina.  I.e.  o servidor sempre grava e l√™ pelo menos uma p√°gina.  A √∫nica quest√£o √© quantos campos est√£o presentes nele. <br><br><h4>  Como o Columnstore pode realmente ajudar </h4><br>  Para responder, √© preciso ter n√∫meros exatos.  Vamos peg√°-los.  Mas que n√∫meros podem dar uma imagem precisa? <br><br><ol><li>  A quantidade de espa√ßo em disco. </li><li>  Desempenho da consulta. </li><li>  Toler√¢ncia a falhas. </li><li>  Facilidade de implementa√ß√£o. </li><li>  Quais novas habilidades um desenvolvedor deve ter para trabalhar com novas estruturas. </li></ol><br><h4>  Espa√ßo em disco </h4><br>  Vamos criar uma tabela simples, preench√™-la com dados e verificar quanto espa√ßo √© necess√°rio. <br><br><pre><code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">foreign</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> cstore_table ( trd <span class="hljs-type"><span class="hljs-type">date</span></span>, org <span class="hljs-type"><span class="hljs-type">int</span></span>, op <span class="hljs-type"><span class="hljs-type">int</span></span>, it <span class="hljs-type"><span class="hljs-type">int</span></span>, wh <span class="hljs-type"><span class="hljs-type">int</span></span>, m1 <span class="hljs-type"><span class="hljs-type">numeric</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>), m2 <span class="hljs-type"><span class="hljs-type">numeric</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>), m3 <span class="hljs-type"><span class="hljs-type">numeric</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>), m4 <span class="hljs-type"><span class="hljs-type">numeric</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>), m5 <span class="hljs-type"><span class="hljs-type">numeric</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> cstore_server <span class="hljs-keyword"><span class="hljs-keyword">options</span></span>(compression <span class="hljs-string"><span class="hljs-string">'pglz'</span></span>);</code> </pre> <br>  Como voc√™ notou, eu criei uma tabela externa.  O fato √© que o PostgreSQL n√£o possui suporte a columnstore embutido.  Mas o PostgreSQL possui um sistema poderoso para extens√µes.  Um deles torna poss√≠vel criar tabelas columnstore.  Links no final do artigo. <br><br><ul><li>  pglz - informa a extens√£o que os dados devem ser compactados usando o algoritmo embutido no PostgreSQL; </li><li>  trd - tempo de transa√ß√£o; </li><li>  op, it, wh - se√ß√µes ou medi√ß√µes anal√≠ticas; </li><li>  m1, m2, m3, m4, m5 - indicadores ou medidas num√©ricos; </li></ul><br>  Vamos inserir uma quantidade "decente" de dados e ver quanto espa√ßo √© necess√°rio no disco.  Ao mesmo tempo, verificamos o desempenho da inser√ß√£o.  Porque  Coloquei minhas experi√™ncias em um laptop dom√©stico, sou um pouco org√¢nico na quantidade de dados.  Al√©m disso, o que √© ainda bom, usarei o HDD executando o sistema operacional convidado Fedora 30. Host do sistema operacional - Windows 10 Home Edition.  Processador Intel Core 7. O SO convidado recebeu 4 GB de RAM.  Vers√£o do PostgreSQL - PostgreSQL 10.10 no x86_64-pc-linux-gnu, compilado pelo gcc (GCC) 9.1.1 20190503 (Red Hat 9.1.1-1), 64 bits.  Vou experimentar um conjunto de dados com o n√∫mero de registros 52 608 000. <br><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">explain</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">analyze</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> cstore_table <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'2010-01-01'</span></span>::<span class="hljs-type"><span class="hljs-type">date</span></span> + make_interval(days =&gt; d) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> trd , op , org , wh , it , <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> m1 , <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> m2 , <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> m3 , <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> m4 , <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> m5 <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> generate_series(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> op <span class="hljs-keyword"><span class="hljs-keyword">cross</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> generate_series(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> org <span class="hljs-keyword"><span class="hljs-keyword">cross</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> generate_series(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> wh <span class="hljs-keyword"><span class="hljs-keyword">cross</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> generate_series(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">4000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> it <span class="hljs-keyword"><span class="hljs-keyword">cross</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> generate_series(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1095</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> d;</code> </pre> <br>  O plano de implementa√ß√£o ser√° o seguinte <br><blockquote>  Inserir na tabela cstore_table (custo = 0,01..24902714242540.01 linhas = 1000000000000000 largura = 150) (tempo real = 119560.456..119560.456 linhas = 0 loops = 1) <br>  ----&gt; Loop aninhado (custo = 0,01..24902714242540.01 linhas = 1000000000000000 largura = 150) (tempo real = 1,823..22339,976 linhas = 52608000 loops = 1) <br>  ----------&gt; Varredura de fun√ß√µes em generate_series d (custo = 0.00..10.00 linhas = 1000 largura = 4) (tempo real = 0.151..2.198 linhas = 1096 loops = 1) <br>  ----------&gt; Materializar (custo = 0,01..27284555030,01 linhas = 1000000000000 largura = 16) (tempo real = 0,002..3,196 linhas = 48000 loops = 1096) <br>  ----------------&gt; Loop aninhado (custo = 0.01..17401742530.01 linhas = 1000000000000 largura = 16) (tempo real = 1.461..15.072 linhas = 48000 loops = 1) <br>  ----------------------&gt; Varredura de fun√ß√µes em generate_series (custo = 0.00..10.00 linhas = 1000 largura = 4) (tempo real = 1.159..2,007 linhas = 4000 loops = 1) <br>  ----------------------&gt; Materializar (custo = 0,01..26312333,01 linhas = 1.000.000.000 de largura = 12) (tempo real = 0,000..0,001 linhas = 12 loops = 4000) <br>  ----------------------------&gt; Loop aninhado (custo = 0,01..16429520,01 linhas = 1.000.000.000 de largura = 12) (tempo real = 0,257 ..0.485 linhas = 12 loops = 1) <br>  ----------------------------------&gt; Varredura de fun√ß√µes em generate_series wh (custo = 0.00..10.00 linhas = 1000 width = 4) (tempo real = 0,046..0,049 linhas = 3 loops = 1) <br>  ----------------------------------&gt; Materializar (custo = 0,01..28917,01 linhas = 1.000.000 de largura = 8) (tempo real = 0,070..0,139 linhas = 4 loops = 3) <br>  ---------------------------------------&gt; Loop aninhado (custo = 0,01..20010,01 linhas = 1000000 de largura = 8) (tempo real = 0,173..0,366 linhas = 4 loops = 1) <br>  -------------------------------------------&gt; Fun√ß√£o Scan on generate_series op ( custo = 0,00..10,00 linhas = 1000 largura = 4) (tempo real = 0,076..0,079 linhas = 2 loops = 1) <br>  ---------------------------------------------&gt; Fun√ß√£o Digitalizar em generate_series org (custo = 0,00..10,00 linhas = 1000 largura = 4) (tempo real = 0,043..0,047 linhas = 2 loops = 2) <br>  Tempo de planejamento: 0,439 ms <br>  Tempo de execu√ß√£o: 119692,051 ms </blockquote>  Tempo total de entrega - 1.994867517 minutos <br><br>  Hora de cria√ß√£o do conjunto de dados - 22.339976 segundos <br><br>  Tempo de inser√ß√£o - 1.620341333 minutos <br><br>  N√£o consegui avaliar o espa√ßo em disco ocupado usando as fun√ß√µes do PostgreSQL.  N√£o sei por que, mas mostra 0. Talvez esse seja o comportamento padr√£o para tabelas externas.  Usado para este gerenciador de arquivos.  Portanto, o volume de espa√ßo em disco ocupado √© 226,2 Mb.  Para avaliar muito ou pouco, vamos compar√°-lo com uma tabela regular. <br><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">explain</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">analyze</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> rbstore_table <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'2010-01-01'</span></span>::<span class="hljs-type"><span class="hljs-type">date</span></span> + make_interval(days =&gt; d) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> trd , op , org , wh , it , <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> m1 , <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> m2 , <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> m3 , <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> m4 , <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> m5 <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> generate_series(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> op <span class="hljs-keyword"><span class="hljs-keyword">cross</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> generate_series(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> org <span class="hljs-keyword"><span class="hljs-keyword">cross</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> generate_series(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> wh <span class="hljs-keyword"><span class="hljs-keyword">cross</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> generate_series(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">4000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> it <span class="hljs-keyword"><span class="hljs-keyword">cross</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> generate_series(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1095</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> d;</code> </pre> <br>  O plano de implementa√ß√£o ser√° o seguinte <br><blockquote>  Loop aninhado (custo = 0,01..22402714242540,01 linhas = 1000000000000000 largura = 44) (tempo real = 0,585..23781,942 linhas = 52608000 loops = 1) <br>  ---&gt; Fun√ß√£o Varredura em generate_series d (custo = 0,00..10,00 linhas = 1000 largura = 4) (tempo real = 0,091..2,130 linhas = 1096 loops = 1) <br>  ---&gt; Materializar (custo = 0,01..27284555030,01 linhas = 1000000000000 largura = 16) (tempo real = 0,001..3,574 linhas = 48000 loops = 1096) <br>  ----------&gt; Loop aninhado (custo = 0,01..17401742530,01 linhas = 1000000000000 largura = 16) (tempo real = 0,489..14,044 linhas = 48000 loops = 1) <br>  ----------------&gt; Varredura de fun√ß√µes em generate_series it (custo = 0.00..10.00 linhas = 1000 largura = 4) (tempo real = 0.477..1.352 linhas = 4000 loops = 1 ) <br>  ----------------&gt; Materializar (custo = 0,01..26312333,01 linhas = 1000000000 largura = 12) (tempo real = 0,000..0,001 linhas = 12 loops = 4000) <br>  ----------------------&gt; Loop aninhado (custo = 0,01..16429520,01 linhas = 1.000.000.000 de largura = 12) (tempo real = 0,010..0,019 linhas = 12 loops = 1) <br>  ----------------------------&gt; Fun√ß√£o Digitalizar em generate_series wh (custo = 0.00..10.00 linhas = 1000 largura = 4) (real time = 0.003..0.003 linhas = 3 loops = 1) <br>  ----------------------------&gt; Materializar (custo = 0,01..28917,01 linhas = 1.000.000 de largura = 8) (tempo real = 0,002. .0.004 linhas = 4 loops = 3) <br>  ----------------------------------&gt; Loop aninhado (custo = 0,01..20010,01 linhas = 1.000.000 de largura = 8 ) (tempo real = 0,006..0,009 linhas = 4 loops = 1) <br>  ----------------------------------------&gt; Varredura de fun√ß√µes em generate_series op (cost = 0.00 ..10,00 linhas = 1000 largura = 4) (tempo real = 0,002..0,002 linhas = 2 loops = 1) <br>  ----------------------------------------&gt; Verifica√ß√£o de fun√ß√µes na organiza√ß√£o generate_series (custo = 0,00 ..10,00 linhas = 1000 largura = 4) (tempo real = 0,001..0,001 linhas = 2 loops = 2) <br>  Tempo de planejamento: 0,569 ms <br>  Tempo de execu√ß√£o: 378883.989 ms </blockquote>  O tempo gasto na implementa√ß√£o deste plano n√£o nos interessa, porque  na vida real, essas inser√ß√µes n√£o s√£o supostas.  Estamos interessados ‚Äã‚Äãem quanto espa√ßo em disco esta tabela ocupa.  Tendo cumprido o pedido de fun√ß√µes do sistema, recebi 3,75 GB. <br><br>  Portanto, cstore_table - 226 MB, rbstore_table - 3,75 GB.  A diferen√ßa de 16,99 vezes √© impressionante, mas √© improv√°vel que a mesma diferen√ßa possa ser obtida na produ√ß√£o, principalmente devido √† distribui√ß√£o de dados.  Como regra, essa diferen√ßa ser√° menor e ser√° cerca de 5 vezes. <br><br>  Mas espere, ningu√©m usa dados brutos em um formato baseado em linha para fins de an√°lise.  Por exemplo, eles tentam usar dados indexados para gerar relat√≥rios.  E porque  Os dados "brutos" sempre ser√£o, voc√™ precisar√° comparar os tamanhos com os tamanhos dos √≠ndices.  Vamos criar pelo menos um √≠ndice.  Seja um √≠ndice no campo de data e tipo de opera√ß√£o - trd + op. <br><br>  Portanto, indexei apenas dois campos e o √≠ndice ocupou 1583 MB, o que √© muito mais que a tabela cstore_.  Mas, como regra, √© necess√°rio mais de um √≠ndice para carregar OLAP.  √â apropriado observar aqui que a tabela cstore_table n√£o precisa de indexa√ß√£o adicional.  Esta tabela atua como um √≠ndice que cobre todas as consultas. <br><br>  De todas as op√ß√µes acima, uma conclus√£o simples pode ser feita - usando as tabelas columnstore, voc√™ pode reduzir a quantidade de espa√ßo em disco usado. <br><br><h4>  Desempenho da consulta </h4><br>  Para avaliar o desempenho, vamos executar uma consulta que retorne dados resumidos de um m√™s espec√≠fico para um tipo espec√≠fico de opera√ß√£o. <br><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">explain</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">analyze</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">costs</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">buffers</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> sum(m1) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> cstore_table <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> trd = <span class="hljs-string"><span class="hljs-string">'2011-01-01'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> op = <span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre> <br>  O plano de implementa√ß√£o ser√° o seguinte <br><blockquote>  Agregado (custo = 793602.69..793602.70 linhas = 1 largura = 32) (tempo real = 79.708..79.708 linhas = 1 loops = 1) <br>  --Buffers: ocorr√™ncia compartilhada = 44226 <br>  ---&gt; Verifica√ß√£o estrangeira na tabela cstore (custo = 0.00..793544.70 linhas = 23197 largura = 5) (tempo real = 23.209..76.628 linhas = 24000 loops = 1) <br>  -------- Filtro: ((trd = '2011-01-01' :: data) AND (op = 1)) <br>  -------- Linhas removidas pelo filtro: 26000 <br>  -------- Arquivo CStore: / var / lib / pgsql / 10 / data / cstore_fdw / 14028/16417 <br>  Tamanho do arquivo CStore: 120818897 <br>  -------- Buffers: ocorr√™ncia compartilhada = 44226 <br>  Tempo de planejamento: 0,165 ms <br>  Tempo de execu√ß√£o: 79,887 ms </blockquote>  E <br><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">explain</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">analyze</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">costs</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">buffers</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> sum(m1) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> rbstore_table <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> trd = <span class="hljs-string"><span class="hljs-string">'2011-01-01'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> op = <span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre><br>  O plano de implementa√ß√£o ser√° o seguinte <br><blockquote>  Agregado (custo = 40053.80..40053.81 linhas = 1 largura = 8) (tempo real = 389.183..389.183 linhas = 1 loops = 1) <br>  --Buffers: leitura compartilhada = 545 <br>  ---&gt; Varredura de √≠ndice usando trd_op_ix em rbstore_table (custo = 0,56..39996.70 linhas = 22841 largura = 4) (tempo real = 55.955..385.283 linhas = 24000 loops = 1) <br>  -------- √çndice Cond: ((trd = '2011-01-01 00:00:00' :: carimbo de data / hora sem fuso hor√°rio) AND (op = 1)) <br>  -------- Buffers: leitura compartilhada = 545 <br>  Tempo de planejamento: 112,175 ms <br>  Tempo de execu√ß√£o: 389,219 ms </blockquote>  389,219 ms vs 79,887 ms.  Aqui vemos que, mesmo em uma quantidade relativamente pequena de dados do columnstore, uma tabela √© significativamente mais r√°pida que um √≠ndice em uma tabela baseada em linhas. <br><br>  Vamos alterar a solicita√ß√£o e tentar obter a unidade para todo o ano de 2011. <br><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">explain</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">analyze</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">costs</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">buffers</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> sum(m1) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> cstore_table <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> trd <span class="hljs-keyword"><span class="hljs-keyword">between</span></span> <span class="hljs-string"><span class="hljs-string">'2011-01-01'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-string"><span class="hljs-string">'2011-12-31'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> op = <span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre> <br>  O plano de implementa√ß√£o ser√° o seguinte <br><blockquote>  Agregado (custo = 946625.58..946625.59 linhas = 1 largura = 32) (tempo real = 3123.604..3123.604 linhas = 1 loops = 1) <br>  --Buffers: ocorr√™ncia compartilhada = 44226 <br>  ---&gt; Verifica√ß√£o estrangeira na tabela cstore_table (custo = 0.00..925064.70 linhas = 8624349 largura = 5) (tempo real = 21.728..2100.665 linhas = 8760000 loops = 1) <br>  -------- Filtro: ((trd&gt; = '2011-01-01' :: data) AND (trd &lt;= '2011-12-31' :: date) AND (op = 1)) <br>  -------- Linhas removidas pelo filtro: 8760000 <br>  -------- Arquivo CStore: / var / lib / pgsql / 10 / data / cstore_fdw / 14028/16411 <br>  Tamanho do arquivo CStore: 120818897 <br>  -------- Buffers: ocorr√™ncia compartilhada = 44226 <br>  Tempo de planejamento: 0,212 ms <br>  Tempo de execu√ß√£o: 3123.960 ms </blockquote>  E <br><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">explain</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">analyze</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">costs</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">buffers</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> sum(m1) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> rbstore_table <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> trd <span class="hljs-keyword"><span class="hljs-keyword">between</span></span> <span class="hljs-string"><span class="hljs-string">'2011-01-01'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-string"><span class="hljs-string">'2011-12-31'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> op = <span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre><br>  O plano de implementa√ß√£o ser√° o seguinte <br><blockquote>  Finalizar agregado (custo = 885214.33..885214.34 linhas = 1 largura = 8) (tempo real = 98512.560..98512.560 linhas = 1 loops = 1) <br>  --Buffers: hit compartilhado = 2565 lido = 489099 <br>  ---&gt; Reunir (custo = 885214.12..885214.33 linhas = 2 largura = 8) (tempo real = 98427.034..98523.194 linhas = 3 loops = 1) <br>  -------- Trabalhadores planejados: 2 <br>  -------- Trabalhadores Lan√ßados: 2 <br>  -------- Buffers: hit compartilhado = 2565 read = 489099 <br>  ---------&gt; Agregado parcial (custo = 884214.12..884214.13 linhas = 1 largura = 8) (tempo real = 97907.608..97907.608 linhas = 1 loops = 3) <br>  -------------- Buffers: hit compartilhado = 2565 read = 489099 <br>  ---------------&gt; Varredura Seq paralela em rbstore_table (custo = 0,00..875264,00 linhas = 3580047 largura = 4) (tempo real = 40820,004..97405,250 linhas = 2920000 loops = 3) <br>  --------------------- Filtro: ((trd&gt; = '2011-01-01 00:00:00' :: carimbo de data / hora sem fuso hor√°rio) AND (trd &lt;= '2011-12-31 00:00:00' :: carimbo de data / hora sem fuso hor√°rio) AND (op = 1)) <br>  -------------------- Linhas removidas pelo filtro: 14616000 <br>  -------------------- Buffers: hit compartilhado = 2565 read = 489099 <br>  Tempo de planejamento: 7.899 ms <br>  Tempo de execu√ß√£o: 98523.278 ms </blockquote>  98523.278 ms vs 3123.960 ms.  Talvez um √≠ndice parcial nos ajude, mas √© melhor n√£o arriscar e criar uma estrutura baseada em linha adequada na qual os valores prontos ser√£o armazenados. <br><br><h4>  Agregados manuais </h4><br>  Uma estrutura adequada para agrega√ß√µes manuais pode ser uma tabela regular baseada em row_ contendo valores pr√©-computados.  Por exemplo, ele pode conter um registro relacionado a 2011 com o tipo de opera√ß√£o igual a 1, enquanto nos campos m1, m2, m3, m4 e m5 o valor agregado ser√° armazenado precisamente para essas se√ß√µes anal√≠ticas.  Assim, tendo um conjunto suficiente de agregados e √≠ndices, as consultas anal√≠ticas adquirem um desempenho sem precedentes.  Curiosamente, o Microsoft SQL Server Analysis Services possui um assistente especial que permite configurar o n√∫mero e a profundidade dos valores pr√©-calculados. <br><br>  Esta solu√ß√£o tem as seguintes vantagens: <br><br><ul><li>  An√°lise em tempo real. <br><br>  <i>Por favor, n√£o confunda o termo "an√°lise em tempo real".</i>  <i>Aqui estamos falando sobre o fato de que o incremento da unidade ocorre durante um per√≠odo de tempo aceit√°vel na grande maioria dos casos.</i> <i><br><br></i>  <i>De fato, esse plus √© controverso, mas n√£o vamos falar sobre isso.</i>  <i>O fato permanece.</i>  <i>A arquitetura da solu√ß√£o √© tal que as unidades permanecem ‚Äúnovas‚Äù quase sempre.</i> </li><li>  Independ√™ncia completa do volume de dados. <br><br>  <i>Esta √© uma vantagem muito s√©ria.</i>  <i>N√£o importa quantos dados sejam processados, mais cedo ou mais tarde ser√£o processados ‚Äã‚Äãe agregados recebidos.</i> </li><li>  Complexidade relativa. <br><br>  <i>Para obter an√°lises em tempo real e independ√™ncia do volume de dados, a solu√ß√£o deve usar tecnologias avan√ßadas, como multithreading e gerenciamento de bloqueio manual no n√≠vel do DBMS.</i> </li><li>  Teste de dificuldade. <br><br>  <i>Aqui estamos falando sobre testes de unidade e testes manuais.</i>  <i>Acho que o leitor n√£o deve explicar que identificar erros de multithreading n√£o √© uma tarefa f√°cil.</i> </li><li>  Aumento dos requisitos de espa√ßo em disco. <br><br></li></ul><br><h4>  O uso real do columnstore </h4><br>  Aqui devemos novamente mergulhar na teoria e analisar a quest√£o do que s√£o dados anal√≠ticos com mais detalhes. <br><br>  Assuma o chefe m√©dio da empresa.  Como regra, ele / ela est√° preocupado com duas quest√µes globais: "Como est√£o as coisas no momento?"  e "O que mudou ultimamente?". <br><br>  Para responder √† pergunta "Como est√£o as coisas no momento", absolutamente n√£o precisamos de dados hist√≥ricos.  I.e.  n√£o importa como foram as coisas h√° um m√™s. <br><br>  Para acompanhar o pulso, a pergunta √© frequentemente feita.  Esse tipo de an√°lise de dados √© chamado operacional. <br><br>  Para responder √† pergunta "O que mudou ultimamente", precisamos de dados precisamente hist√≥ricos.  Al√©m disso, como regra, a an√°lise √© realizada nos mesmos intervalos de tempo.  Por exemplo, um m√™s √© comparado a um m√™s, ano a ano etc.  Obviamente, o sistema n√£o deve limitar o usu√°rio da capacidade de comparar per√≠odos arbitr√°rios, mas esse caso deve ser reconhecido como raro, porque  comparar um ano fechado com o meio n√£o fechado faz pouco sentido.  Uma caracter√≠stica distintiva da an√°lise comparativa √© que ela n√£o √© necess√°ria com a mesma frequ√™ncia operacional.  Vamos chamar esse tipo de an√°lise de hist√≥rico. <br><br>  Obviamente, a an√°lise operacional deve ocorrer rapidamente.  Consequentemente, exige muito desempenho.  Embora para an√°lise hist√≥rica, esses requisitos n√£o possam ser apresentados.  Embora o desempenho da an√°lise hist√≥rica deva permanecer em um n√≠vel muito alto.  Pelo menos para que o pr√≥prio sistema de an√°lise permane√ßa competitivo. <br><br>  Portanto, de acordo com dois tipos de an√°lise, podemos distinguir dois tipos de dados anal√≠ticos: dados operacionais e hist√≥ricos.  Do lado do usu√°rio, n√£o deve ser notado com quais dados espec√≠ficos ele est√° trabalhando no momento. <br><br>  √â a partir dessas considera√ß√µes que em servidores de banco de dados surgiu a possibilidade de dividir tabelas em se√ß√µes separadas. <br><br>  No que diz respeito ao columnstore, √© poss√≠vel misturar se√ß√µes nos formatos baseado em linha e columnstore.  Sabe-se que os dados da an√°lise operacional est√£o sujeitos a altera√ß√µes frequentes, o que impede seu armazenamento no formato columnstore.  E, como os dados operacionais n√£o acontecem muito, eles podem ser armazenados no formato baseado em linhas. <br><br>  Os dados hist√≥ricos n√£o s√£o alterados.  Existem muitos desses dados e, portanto, o formato columnstore se adapta melhor a eles.  Lembre-se de que o desempenho de consultas em negrito em uma fonte columnstore √© maior que em uma fonte baseada em linha. <br><br>  Vejamos um exemplo de todos os itens acima. <br><br>  Abaixo, crio a tabela principal do armaz√©m e anexo as se√ß√µes de an√°lise operacional e hist√≥rica a ela. <br><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> warehouse ( trd <span class="hljs-type"><span class="hljs-type">date</span></span>, org <span class="hljs-type"><span class="hljs-type">int</span></span>, op <span class="hljs-type"><span class="hljs-type">int</span></span>, it <span class="hljs-type"><span class="hljs-type">int</span></span>, wh <span class="hljs-type"><span class="hljs-type">int</span></span>, m1 <span class="hljs-type"><span class="hljs-type">numeric</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>), m2 <span class="hljs-type"><span class="hljs-type">numeric</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>), m3 <span class="hljs-type"><span class="hljs-type">numeric</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>), m4 <span class="hljs-type"><span class="hljs-type">numeric</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>), m5 <span class="hljs-type"><span class="hljs-type">numeric</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">partition by range</span></span>(trd); <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">foreign</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> historycal_data ( trd <span class="hljs-type"><span class="hljs-type">date</span></span>, org <span class="hljs-type"><span class="hljs-type">int</span></span>, op <span class="hljs-type"><span class="hljs-type">int</span></span>, it <span class="hljs-type"><span class="hljs-type">int</span></span>, wh <span class="hljs-type"><span class="hljs-type">int</span></span>, m1 <span class="hljs-type"><span class="hljs-type">numeric</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>), m2 <span class="hljs-type"><span class="hljs-type">numeric</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>), m3 <span class="hljs-type"><span class="hljs-type">numeric</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>), m4 <span class="hljs-type"><span class="hljs-type">numeric</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>), m5 <span class="hljs-type"><span class="hljs-type">numeric</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> cstore_server <span class="hljs-keyword"><span class="hljs-keyword">options</span></span>(compression <span class="hljs-string"><span class="hljs-string">'pglz'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> historycal_data <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'2010-01-01'</span></span>::<span class="hljs-type"><span class="hljs-type">date</span></span> + make_interval(days =&gt; d) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> trd , op , org , wh , it , <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> m1 , <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> m2 , <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> m3 , <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> m4 , <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> m5 <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> generate_series(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> op <span class="hljs-keyword"><span class="hljs-keyword">cross</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> generate_series(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> org <span class="hljs-keyword"><span class="hljs-keyword">cross</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> generate_series(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> wh <span class="hljs-keyword"><span class="hljs-keyword">cross</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> generate_series(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">4000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> it <span class="hljs-keyword"><span class="hljs-keyword">cross</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> generate_series(<span class="hljs-number"><span class="hljs-number">0</span></span>, (<span class="hljs-number"><span class="hljs-number">1095</span></span> - <span class="hljs-number"><span class="hljs-number">31</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> d; <span class="hljs-keyword"><span class="hljs-keyword">analyze</span></span> historycal_data; <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> operational_data <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> (<span class="hljs-string"><span class="hljs-string">'2012-12-01'</span></span>::<span class="hljs-type"><span class="hljs-type">date</span></span> + make_interval(days =&gt; d))::<span class="hljs-type"><span class="hljs-type">date</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> trd , op , org , wh , it , <span class="hljs-number"><span class="hljs-number">100</span></span>::<span class="hljs-type"><span class="hljs-type">numeric</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> m1 , <span class="hljs-number"><span class="hljs-number">100</span></span>::<span class="hljs-type"><span class="hljs-type">numeric</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> m2 , <span class="hljs-number"><span class="hljs-number">100</span></span>::<span class="hljs-type"><span class="hljs-type">numeric</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> m3 , <span class="hljs-number"><span class="hljs-number">100</span></span>::<span class="hljs-type"><span class="hljs-type">numeric</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> m4 , <span class="hljs-number"><span class="hljs-number">100</span></span>::<span class="hljs-type"><span class="hljs-type">numeric</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> m5 <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> generate_series(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> op <span class="hljs-keyword"><span class="hljs-keyword">cross</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> generate_series(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> org <span class="hljs-keyword"><span class="hljs-keyword">cross</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> generate_series(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> wh <span class="hljs-keyword"><span class="hljs-keyword">cross</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> generate_series(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">4000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> it <span class="hljs-keyword"><span class="hljs-keyword">cross</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> generate_series(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> d; <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> trd_op_ix <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> operational_data (trd, op); <span class="hljs-keyword"><span class="hljs-keyword">analyze</span></span> operational_data; <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> warehouse <span class="hljs-keyword"><span class="hljs-keyword">attach partition</span></span> operational_data <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> (<span class="hljs-string"><span class="hljs-string">'2012-12-01'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> (<span class="hljs-string"><span class="hljs-string">'2112-01-01'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> warehouse <span class="hljs-keyword"><span class="hljs-keyword">attach partition</span></span> historycal_data <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> (<span class="hljs-string"><span class="hljs-string">'2010-01-01'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> (<span class="hljs-string"><span class="hljs-string">'2012-12-01'</span></span>);</code> </pre> <br>  Est√° tudo pronto.  Vamos tentar solicitar alguns relat√≥rios.  Vamos come√ßar solicitando dados para um dia do m√™s atual. <br><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">explain</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">analyze</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">costs</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">buffers</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> sum(m1) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> warehouse <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> trd = <span class="hljs-string"><span class="hljs-string">'2012-12-01'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> op = <span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre><br><blockquote>  Agregado (custo = 15203,37..15203,38 linhas = 1 largura = 32) (tempo real = 17,320..17,320 linhas = 1 loops = 1) <br>  --Buffers: ocorr√™ncia compartilhada = 3 lidos = 515 <br>  ---&gt; Anexar (custo = 532,59..15140,89 linhas = 24991 largura = 5) (tempo real = 1,924..13,838 linhas = 24000 loops = 1) <br>  ------- Buffers: hit compartilhado = 3 lido = 515 <br>  ---------&gt; Varredura de Heap de Bitmap em dados_operacionais (custo = 532.59..15140.89 linhas = 24991 largura = 5) (tempo real = 1.924..11.992 linhas = 24000 loops = 1) <br>  --------------- Verifique novamente Cond: ((trd = '2012-12-01' :: data) AND (op = 1)) <br>  --------------- Blocos de heap: exato = 449 <br>  --------------- Buffers: hit compartilhado = 3 lido = 515 <br>  ----------------&gt; An√°lise de √çndice de Bitmap em trd_op_ix (custo = 0.00..526.34 linhas = 24991 largura = 0) (tempo real = 1.877..1.877 linhas = 24000 loops = 1 ) <br>  --------------------- √çndice Cond: ((trd = '2012-12-01' :: data) AND (op = 1)) <br>  --------------------- Buffers: hit compartilhado = 2 lido = 67 <br>  Tempo de planejamento: 0,388 ms <br>  Tempo de execu√ß√£o: 100,941 ms </blockquote>  Agora, solicitaremos dados para todo o ano de 2012, nos quais o n√∫mero de transa√ß√µes √© de 8.784.000. <br><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">explain</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">analyze</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">costs</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">buffers</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> sum(m1) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> warehouse <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> trd <span class="hljs-keyword"><span class="hljs-keyword">between</span></span> <span class="hljs-string"><span class="hljs-string">'2012-01-01'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-string"><span class="hljs-string">'2012-12-31'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> op = <span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre><blockquote>  Agregado (custo = 960685.82..960685.83 linhas = 1 largura = 32) (tempo real = 4124.681..4124.681 linhas = 1 loops = 1) <br>  --Buffers: hit compartilhado = 45591 read = 11282 <br>  ---&gt; Anexar (custo = 0,00..938846,60 linhas = 8735687 largura = 5) (tempo real = 66,581..3036,394 linhas = 8784000 loops = 1) <br>  --------- Buffers: hit compartilhado = 45591 read = 11282 <br>  ----------&gt; Varredura estrangeira no hist√≥ricocal_data (custo = 0.00..898899.60 linhas = 7994117 largura = 5) (tempo real = 66.579..2193.801 linhas = 8040000 loops = 1) <br>  --------------- Filtro: ((trd&gt; = '2012-01-01' :: data) AND (trd &lt;= '2012-12-31' :: data) AND (op = 1)) <br>  --------------- Linhas removidas pelo filtro: 8040000 <br>  --------------- Arquivo do CStore: / var / lib / pgsql / 10 / data / cstore_fdw / 14028/16448 <br>  --------------- Tamanho do arquivo CStore: 117401470 <br>  --------------- Buffers: ocorr√™ncia compartilhada = 42966 <br>  ----------&gt; Varredura Seq em operating_data (cost = 0.00..39947.00 linhas = 741570 width = 5) (tempo real = 0.019..284.824 linhas = 744000 loops = 1) <br>  --------------- Filtro: ((trd&gt; = '2012-01-01' :: data) AND (trd &lt;= '2012-12-31' :: data) AND (op = 1)) <br>  --------------- Linhas removidas pelo filtro: 744000 <br>  --------------- Buffers: hit compartilhado = 2625 read = 11282 <br>  Tempo de planejamento: 0,256 ms <br>  Tempo de execu√ß√£o: 4125,239 ms </blockquote>  No final, vamos ver o que acontece se o usu√°rio quiser, por exemplo, sem inten√ß√£o maliciosa, solicitar um relat√≥rio sobre todas as transa√ß√µes no sistema, das quais existem 52 608 000. <br><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">explain</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">analyze</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">costs</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">buffers</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> sum(m1) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> warehouse</code> </pre> <br><blockquote>  Agregado (custo = 672940.20..672940,21 linhas = 1 largura = 32) (tempo real = 15907,886..15907,886 linhas = 1 loops = 1) <br>  --Buffers: hit compartilhado = 17075 read = 11154 <br>  ---&gt; Anexar (custo = 0,00..541420,20 linhas = 52608000 largura = 5) (tempo real = 0,192..9115,144 linhas = 52608000 loops = 1) <br>  --------- Buffers: hit compartilhado = 17075 read = 11154 <br>  ----------&gt; Varredura estrangeira no hist√≥ricocal_data (custo = 0.00..512633.20 linhas = 51120000 largura = 5) (tempo real = 0.191..5376.449 linhas = 51120000 loops = 1) <br>  --------------- Arquivo do CStore: / var / lib / pgsql / 10 / data / cstore_fdw / 14028/16448 <br>  --------------- Tamanho do arquivo CStore: 117401470 <br>  --------------- Buffers: ocorr√™ncia compartilhada = 14322 <br>  ----------&gt; Varredura Seq em dados_operacionais (custo = 0,00..28787,00 linhas = 1488000 largura = 5) (tempo real = 0,032..246,978 linhas = 1488000 loops = 1) <br>  --------------- Buffers: hit compartilhado = 2753 read = 11154 <br>  Tempo de planejamento: 0,157 ms <br>  Tempo de execu√ß√£o: 15908.096 ms </blockquote>  Observe que ainda estou escrevendo meu artigo, como se nada tivesse acontecido.  Nem precisei reiniciar meu laptop n√£o t√£o poderoso com HDD e 4 GB de RAM.  Embora a quest√£o do consumo de recursos exija um estudo mais cuidadoso. <br><br><h4>  Toler√¢ncia a falhas </h4><br>  Em parte, a toler√¢ncia a falhas foi testada no momento da reda√ß√£o deste documento.  Meu laptop est√° ativo e, em geral, n√£o notei lentid√£o no trabalho, al√©m dos habituais. <br><br>  Permita que o leitor me perdoe pelo fato de n√£o ter tido tempo de resolver a quest√£o da toler√¢ncia a falhas em detalhes, mas posso dizer que a extens√£o em quest√£o tem toler√¢ncia a falhas - o backup √© poss√≠vel. <br><br><h4>  Facilidade de implementa√ß√£o </h4><br>  Como se viu, ao criar uma tabela que armazena dados em um formato columnstore, n√£o h√° outras op√ß√µes al√©m de um algoritmo de compacta√ß√£o.  A compress√£o em si √© absolutamente necess√°ria. <br><br>  O formato em si tem uma certa estrutura.  Ao definir os par√¢metros apropriados, voc√™ pode obter uma certa acelera√ß√£o de consultas anal√≠ticas ou ajustar o grau de compacta√ß√£o das informa√ß√µes. <br><br>  Como demonstrado acima, a cria√ß√£o de uma tabela columnstore n√£o √© um aborrecimento.  A extens√£o pode funcionar com 40 tipos de dados PostgreSQL.  Os semin√°rios on-line falaram sobre todos os tipos suportados pelo PostgreSQL. <br><br><h4>  Quais novas habilidades um desenvolvedor deve ter para trabalhar com novas estruturas </h4><br>  O desenvolvedor do SQL n√£o precisa de habilidades especiais para gravar consultas em tabelas columnstore.  Essa tabela √© vis√≠vel em todas as consultas, como uma tabela regular baseada em linhas.  Embora isso n√£o exclua a necessidade de otimiza√ß√£o de consulta. <br><br><h4>  Conclus√£o </h4><br>  Neste artigo, mostrei como uma tabela com um formato de armazenamento columnstore pode ser √∫til.  Isso economiza espa√ßo em disco e consultas anal√≠ticas de alto desempenho.  A facilidade de trabalhar com a tabela reduz automaticamente o custo de cria√ß√£o de um data warehouse anal√≠tico completo, porque  seu uso n√£o requer o desenvolvimento de algoritmos complexos e dif√≠ceis de depurar.  O teste √© simplificado. <br><br>  Apesar do fato de que os experimentos expostos acima inspiram otimismo, muitas quest√µes n√£o foram resolvidas.  Por exemplo, qual plano de consulta ser√° gerado quando a tabela columnstore ingressar em outras tabelas.  Espero continuar esse trabalho na pr√≥xima parte.  Quantas partes depender√£o de como o cstore_fdw se comporta em dados mais ou menos reais. <br><br><h4>  Links para materiais adicionais </h4><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Revis√£o curta cstore_fdw</a> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">cstore_fdw no github</a> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Roteiro cstore_fdw</a> <br></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt472396/">https://habr.com/ru/post/pt472396/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt472384/index.html">Um olhar sobre as atualiza√ß√µes do Android da perspectiva de um desenvolvedor</a></li>
<li><a href="../pt472386/index.html">ZIO & Cats Effect: uma alian√ßa de sucesso</a></li>
<li><a href="../pt472388/index.html">Walmart declara guerra de pre√ßos na Amazon</a></li>
<li><a href="../pt472392/index.html">A ascens√£o, queda e poss√≠vel retorno de fitas de √°udio - lidamos com mitos e fornecemos uma vis√£o geral da situa√ß√£o</a></li>
<li><a href="../pt472394/index.html">Avaliando o impacto da intelig√™ncia artificial em petr√≥leo e g√°s offshore</a></li>
<li><a href="../pt472402/index.html">Streaming de chamadas de v√≠deo RTMP</a></li>
<li><a href="../pt472404/index.html">C√°lculo 2D de colis√£o: Algoritmo de Gilbert-Johnson-Kirti</a></li>
<li><a href="../pt472406/index.html">Expandir o centro de dados durante a entrega da pizza</a></li>
<li><a href="../pt472410/index.html">Projetando sistemas de cores dispon√≠veis</a></li>
<li><a href="../pt472412/index.html">Analista de sistemas e m√©tricas de produto - tremer, mas n√£o misturar?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>