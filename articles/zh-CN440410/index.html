<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>â›½ï¸ ğŸŒ¸ ğŸ¥” åœ¨åœ°å›¾ä¸Šé€‰æ‹©ï¼Œç¼“å­˜å’Œæ˜¾ç¤ºç…§ç‰‡ ğŸ© ğŸ‘©â€â¤ï¸â€ğŸ‘¨ ğŸ™†ğŸ¼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å†³å®šæè¿°å¦‚ä½•åœ¨æˆ‘ä»¬çš„ç…§ç‰‡æœåŠ¡gfranq.comä¸­å®ç°åœ¨åœ°å›¾ä¸Šç‰¹å®šä½ç½®é€‰æ‹©å’Œæ˜¾ç¤ºç…§ç‰‡çš„åŠŸèƒ½ã€‚ ç…§ç‰‡æœåŠ¡ç°åœ¨æ— æ³•ä½¿ç”¨ã€‚ 







 ç”±äºæˆ‘ä»¬çš„æœåŠ¡ä¸­æœ‰å¾ˆå¤šç…§ç‰‡ï¼Œå¹¶ä¸”æ¯æ¬¡è§†å£æ›´æ”¹è¿‡äºå ç”¨èµ„æºæ—¶éƒ½ä¼šå‘æ•°æ®åº“å‘é€è¯·æ±‚ï¼Œå› æ­¤å°†åœ°å›¾åˆ’åˆ†ä¸ºå‡ ä¸ªåŒ…å«æœ‰å…³å·²æ£€ç´¢æ•°æ®çš„ä¿¡æ¯çš„åŒºåŸŸæ˜¯åˆä¹é€»è¾‘çš„ã€‚ å‡ºäºæ˜...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>åœ¨åœ°å›¾ä¸Šé€‰æ‹©ï¼Œç¼“å­˜å’Œæ˜¾ç¤ºç…§ç‰‡</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/440410/"><p> åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å†³å®šæè¿°å¦‚ä½•åœ¨æˆ‘ä»¬çš„ç…§ç‰‡æœåŠ¡<em>gfranq.comä¸­</em>å®ç°åœ¨åœ°å›¾ä¸Šç‰¹å®šä½ç½®é€‰æ‹©å’Œæ˜¾ç¤ºç…§ç‰‡çš„åŠŸèƒ½ã€‚ ç…§ç‰‡æœåŠ¡ç°åœ¨æ— æ³•ä½¿ç”¨ã€‚ </p><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/storage2/709/48a/e52/70948ae52bacb687d1b882fa7405bed5.jpg"></div><p></p><br><p> ç”±äºæˆ‘ä»¬çš„æœåŠ¡ä¸­æœ‰å¾ˆå¤šç…§ç‰‡ï¼Œå¹¶ä¸”æ¯æ¬¡è§†å£æ›´æ”¹è¿‡äºå ç”¨èµ„æºæ—¶éƒ½ä¼šå‘æ•°æ®åº“å‘é€è¯·æ±‚ï¼Œå› æ­¤å°†åœ°å›¾åˆ’åˆ†ä¸ºå‡ ä¸ªåŒ…å«æœ‰å…³å·²æ£€ç´¢æ•°æ®çš„ä¿¡æ¯çš„åŒºåŸŸæ˜¯åˆä¹é€»è¾‘çš„ã€‚ å‡ºäºæ˜æ˜¾çš„åŸå› ï¼Œè¿™äº›åŒºåŸŸä¸ºçŸ©å½¢ï¼ˆå°½ç®¡ä¹Ÿè€ƒè™‘äº†å…­è¾¹å½¢ç½‘æ ¼ï¼‰ã€‚ éšç€åŒºåŸŸåœ¨æ›´å¤§èŒƒå›´å†…å˜å¾—è¶Šæ¥è¶Šçƒå½¢ï¼Œè¿˜è€ƒè™‘äº†çƒå½¢å‡ ä½•å…ƒç´ å’Œç”¨äºå®ƒçš„å·¥å…·ã€‚ </p><br><p> æœ¬æ–‡ä¸­æå‡ºäº†ä»¥ä¸‹é—®é¢˜ï¼š </p><br><ul><li> ä»æ•°æ®åº“å­˜å‚¨å’Œæ£€ç´¢ç…§ç‰‡ï¼Œå¹¶å°†å®ƒä»¬ç¼“å­˜åœ¨æœåŠ¡å™¨ï¼ˆSQLï¼ŒCï¼ƒï¼ŒASP.NETï¼‰ä¸Šã€‚ </li><li> åœ¨å®¢æˆ·ç«¯ä¸‹è½½å¿…è¦çš„ç…§ç‰‡å¹¶å°†å…¶ä¿å­˜åˆ°å®¢æˆ·ç«¯ç¼“å­˜ï¼ˆJavaScriptï¼‰ã€‚ </li><li> é‡æ–°è®¡ç®—è§†å£æ›´æ”¹æ—¶å¿…é¡»éšè—æˆ–æ˜¾ç¤ºçš„ç…§ç‰‡ã€‚ </li><li> çƒå½¢å‡ ä½•å…ƒç´ ã€‚ </li></ul><a name="habracut"></a><br><h2 id="contents"> ç›®å½•å†…å®¹ </h2><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æœåŠ¡å™¨éƒ¨åˆ†</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å†…ç½®çš„åœ°ç†ç±»å‹</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ­£å¸¸é€‰æ‹©</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä½¿ç”¨å…¶ä»–å“ˆå¸Œè¡¨</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ç¼“å­˜ç…§ç‰‡ä»¥è¿›è¡Œå¤šçº¿ç¨‹è®¿é—®</a> </li></ul></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å®¢æˆ·ç«¯</a> <br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">åˆå§‹åŒ–åœ°å›¾</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä½¿ç”¨HTML5ç¡®å®šåœ°ç†ä½ç½®</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä½¿ç”¨æœåŠ¡å™¨ä¸­çš„ä¿¡æ¯ç¡®å®šåœ°ç†ä½ç½®</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è®¡ç®—éƒ¨åˆ†å¯è§çš„çŸ©å½¢åŒºåŸŸ</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è®¡ç®—ç¼“å­˜åŒºåŸŸçš„å¤§å°</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">é‡ç»˜æ—¶ä½¿ç”¨å»¶è¿Ÿ</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è®¡ç®—éƒ¨åˆ†å¯è§åŒºåŸŸçš„åæ ‡å’Œå“ˆå¸Œ</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">é‡æ–°ç»˜åˆ¶æ˜¾ç¤ºçš„ç…§ç‰‡</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">åœ°å›¾ä¸Šçš„è·ç¦»</a> </li></ul></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ç»“è®º</a> </li></ul><br><h2 id="server-part"> æœåŠ¡å™¨éƒ¨åˆ† </h2><br><p> è®¾è®¡äº†ä»¥ä¸‹é€‰æ‹©åœ°ç†ä¿¡æ¯å¹¶å°†å…¶å­˜å‚¨åœ¨æ•°æ®åº“ä¸­çš„æ–¹æ³•ï¼š </p><br><ul><li>  SQL Serverå†…ç½®çš„åœ°ç†æ•°æ®ç±»å‹ã€‚ </li><li> æ­£å¸¸é€‰æ‹©æœ‰é™åˆ¶ã€‚ </li><li> ä½¿ç”¨å…¶ä»–è¡¨ã€‚ </li></ul><br><p> æ­¤å¤–ï¼Œå°†è¯¦ç»†æè¿°è¿™äº›æ–¹æ³•ã€‚ </p><br><h3 id="built-in-geotypes"> å†…ç½®çš„åœ°ç†ç±»å‹ </h3><br><p>ä¼—æ‰€å‘¨çŸ¥ï¼ŒSQL Server 2008æ”¯æŒåœ°ç†å’Œå‡ ä½•æ•°æ®ç±»å‹ï¼Œè¿™å…è®¸æŒ‡å®šåœ°ç†ï¼ˆåœ¨çƒä¸Šï¼‰å’Œå‡ ä½•ï¼ˆåœ¨å¹³é¢ä¸Šï¼‰ä¿¡æ¯ï¼Œä¾‹å¦‚ç‚¹ï¼Œçº¿ï¼Œå¤šè¾¹å½¢<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ç­‰ã€‚</a>  ã€‚ ä¸ºäº†æ£€ç´¢ç”±åæ ‡ä¸ºï¼ˆ <code>lngMin</code> <code>latMin</code> ï¼‰å’Œï¼ˆ <code>latMax</code> <code>lngMax</code> ï¼‰çš„çŸ©å½¢åŒ…å›´çš„æ‰€æœ‰ç…§ç‰‡ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æŸ¥è¯¢ï¼š </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @h geography; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @p geography; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @rect = geography::STGeomFromText(<span class="hljs-string"><span class="hljs-string">'POLYGON((lngMin latMin, lngMax latMin, lngMax latMax, lngMin latMax, lngMin latMin))'</span></span>, <span class="hljs-number"><span class="hljs-number">4326</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP @cound <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, image75Path, geoTag.Lat <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Lat, geoTag.Long <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Lng, popularity, width, height <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Photo <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span>(IX_Photo_geoTag)) <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> @rect.STContains(geoTag) = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> popularity <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span></code> </pre> <br><p> æ³¨æ„ï¼Œå¤šè¾¹å½¢çš„æ–¹å‘æ˜¯é€†æ—¶é’ˆæ–¹å‘ï¼Œå¹¶ä¸”ä½¿ç”¨äº†ç”±åæ ‡å®šä¹‰çš„ç©ºé—´ç´¢å¼•<code>IX_Photo_geoTag</code> ï¼ˆæ­¤å¤–ï¼Œç©ºé—´ç´¢å¼•æ˜¯ä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Bæ ‘</a>æ¥æ„å»ºçš„ï¼‰ã€‚ </p><br><p> ä½†æ˜¯ï¼Œäº‹å®è¯æ˜ï¼Œåœ¨Microsoft SQL Server 2008ä¸­ï¼Œå¦‚æœå…·æœ‰åœ°ç†ç±»å‹çš„åˆ—å¯ä»¥æ¥å—<code>NULL</code>å€¼ï¼Œå¹¶ä¸”ç©ºé—´ç´¢å¼•ä¸èƒ½åŒ…å«å…·æœ‰åœ°ç†æ•°æ®ç±»å‹çš„åˆ—ï¼Œé‚£ä¹ˆç©ºé—´ç´¢å¼•å°†ä¸èµ·ä½œç”¨ï¼Œå¹¶ä¸”<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">åœ¨Stackoverflowä¸Šè®¨è®ºäº†</a>æ­¤é—®é¢˜ã€‚ è¿™å°±æ˜¯ä¸ºä»€ä¹ˆè¿™ç§æŸ¥è¯¢ï¼ˆæ²¡æœ‰ç´¢å¼•ï¼‰çš„æ€§èƒ½å˜å¾—å¾ˆä½çš„åŸå› ã€‚ </p><br><p> ä»¥ä¸‹æ–¹æ³•å¯ä»¥è§£å†³æ­¤é—®é¢˜ï¼š </p><br><ul><li> ç”±äºæ— æ³•ä½¿ç”¨<code>NULL</code>å€¼ï¼Œå› æ­¤æ­¤åˆ—çš„é»˜è®¤å€¼ä¸ºåæ ‡ï¼ˆ0ï¼Œ0ï¼‰ï¼Œè¯¥åæ ‡æŒ‡å‘éæ´²é™„è¿‘å¤§è¥¿æ´‹ä¸­çš„æŸä¸ªä½ç½®ï¼ˆç”¨äºæµ‹é‡çº¬åº¦å’Œç»åº¦çš„èµ·ç‚¹ï¼‰ã€‚ ä½†æ˜¯ï¼Œå¯ä»¥åœ¨æ­¤ä½ç½®ä»¥åŠé™„è¿‘æ‰¾åˆ°çœŸå®ç‚¹ï¼Œå¹¶ä¸”åº”è¯¥å¿½ç•¥éåœ°å›¾ä¸Šçš„ç…§ç‰‡ã€‚ å¦‚æœå°†é›¶ç‚¹ï¼ˆ0ï¼Œ0ï¼‰æ›´æ”¹ä¸ºæœ€åŒ—ç‚¹ï¼ˆ0ï¼Œ90ï¼‰ï¼Œé‚£ä¹ˆä¸€åˆ‡éƒ½ä¼šå¥½å¾—å¤šï¼Œå› ä¸ºçº¬åº¦90æŒ‡å‘åœ°å›¾çš„è¾¹ç¼˜ï¼Œå› æ­¤åœ¨æ„å»ºç½‘æ ¼æ—¶ï¼ˆä¾‹å¦‚ï¼Œè¾¾åˆ°çº¬åº¦89ï¼‰ã€‚ </li><li> ä½¿ç”¨SQL Server 2012æˆ–æ›´é«˜ç‰ˆæœ¬ï¼Œå¹¶é€šè¿‡æ‰§è¡Œ<code>ALTER DATABASE database_name SET COMPATIBILITY_LEVEL = 110</code>å°†æ•°æ®åº“çš„å…¼å®¹æ€§çº§åˆ«æ›´æ”¹ä¸º110æˆ–æ›´é«˜ã€‚ åœ¨æ­¤ç‰ˆæœ¬çš„SQL Serverä¸­ï¼Œå›ºå®šäº†å…·æœ‰åœ°ç†ç±»å‹<code>NULL</code>å€¼çš„é”™è¯¯ï¼Œå¹¶æ·»åŠ äº†å¯¹ä¸åŒæ–¹å‘ï¼ˆé€†æ—¶é’ˆå’Œé¡ºæ—¶é’ˆï¼‰çš„å¤šè¾¹å½¢çš„æ”¯æŒã€‚ </li></ul><br><p> å°½ç®¡åœ°ç†ç±»å‹å…·æœ‰å¹¿æ³›çš„å¯èƒ½æ€§ï¼ˆå®ƒä»¬ä¸ä»…ä½¿æ‚¨å¯ä»¥å¦‚ä¸Šæ‰€ç¤ºè¿›è¡Œç®€å•é€‰æ‹©ï¼Œè€Œä¸”è¿˜å¯ä»¥ä½¿ç”¨è·ç¦»å’Œä¸åŒçš„å¤šè¾¹å½¢ï¼‰ï¼Œä½†æˆ‘ä»¬åœ¨é¡¹ç›®ä¸­å¹¶æœªä½¿ç”¨å®ƒä»¬ã€‚ </p><br><h3 id="normal-selection"> æ­£å¸¸é€‰æ‹© </h3><br><p> è¦ä»åæ ‡ï¼ˆ <code>lngMin</code> <code>latMin</code> ï¼‰å’Œï¼ˆ <code>latMax</code> <code>lngMax</code> ï¼‰é™åˆ¶çš„åŒºåŸŸä¸­é€‰æ‹©ç…§ç‰‡ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹æŸ¥è¯¢ï¼š </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP @<span class="hljs-keyword"><span class="hljs-keyword">Count</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">url</span></span>, ... <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Photo <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> latitude &gt; @latMin <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> longitude &gt; @lngMin <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> latitude &lt; @latMax <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> longitude &lt; @lngMax <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> popularity <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span></code> </pre> <br><p> è¯·æ³¨æ„ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥ä¸º<code>latitude</code>å’Œ<code>longitude</code>å­—æ®µåˆ›å»ºä»»ä½•ç´¢å¼•ï¼ˆä¸ç¬¬ä¸€ç§æ–¹æ³•ç›¸åï¼‰ï¼Œå› ä¸ºä½¿ç”¨äº†æ™®é€šçš„floatæ•°æ®ç±»å‹ã€‚ ä½†æ˜¯ï¼Œæ­¤é€‰æ‹©ä¸­æœ‰4ä¸ªæ¯”è¾ƒæ“ä½œã€‚ </p><br><h3 id="using-additional-hash-table"> ä½¿ç”¨å…¶ä»–å“ˆå¸Œè¡¨ </h3><br><p> å¯¹äºä»æŸäº›åŒºåŸŸé€‰æ‹©ç…§ç‰‡çš„é—®é¢˜ï¼Œæœ€ç†æƒ³çš„è§£å†³æ–¹æ¡ˆæ˜¯åˆ›å»ºé¢å¤–çš„è¡¨Zoomï¼Œè¯¥è¡¨å­˜å‚¨äº†åŒ…å«æ¯æ¬¡ç¼©æ”¾çš„åŒºåŸŸå“ˆå¸Œå€¼çš„å­—ç¬¦ä¸²ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ </p><br><div style="text-align:center;"><img src="https://habrastorage.org/storage2/dd2/696/223/dd269622322fa5b688101ba38ef68f10.png"></div><br><p> å¯ä»¥ä½¿ç”¨ä»¥ä¸‹SQLæŸ¥è¯¢ï¼ˆ <code>zn</code>å½“å‰ç¼©æ”¾çº§åˆ«ï¼‰ï¼š </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">hash</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">hash</span></span> = (@latMin + <span class="hljs-number"><span class="hljs-number">90</span></span>) + (@lngMin + <span class="hljs-number"><span class="hljs-number">180</span></span>) * <span class="hljs-number"><span class="hljs-number">180</span></span> + (@latMax + <span class="hljs-number"><span class="hljs-number">90</span></span>) * <span class="hljs-number"><span class="hljs-number">64800</span></span> + (@lngMax + <span class="hljs-number"><span class="hljs-number">180</span></span>) * <span class="hljs-number"><span class="hljs-number">11664000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP @<span class="hljs-keyword"><span class="hljs-keyword">Count</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">url</span></span>, ... <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Photo <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Zooms <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> zn = @<span class="hljs-keyword"><span class="hljs-keyword">hash</span></span>)</code> </pre> <br><p> è¿™ç§æ–¹æ³•çš„ç¼ºç‚¹æ˜¯é¢å¤–çš„è¡¨å ç”¨äº†é¢å¤–çš„å†…å­˜ç©ºé—´ã€‚ </p><br><p> å°½ç®¡åä¸€ç§æ–¹æ³•æœ‰å¾ˆå¤šä¼˜ç‚¹ï¼Œä½†æˆ‘ä»¬åœ¨æœåŠ¡å™¨ä¸Šä»ä½¿ç”¨äº†ç¬¬äºŒç§æ–¹æ³•ï¼ˆâ€œ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ­£å¸¸é€‰æ‹©â€</a> ï¼‰ï¼Œå› ä¸ºå®ƒè¡¨ç°å‡ºè‰¯å¥½çš„æ€§èƒ½ã€‚ </p><br><h3 id="caching-photos-for-multi-threaded-access"> ç¼“å­˜ç…§ç‰‡ä»¥è¿›è¡Œå¤šçº¿ç¨‹è®¿é—® </h3><br><p> åœ¨ä»¥ä¸€ç§æˆ–å¤šç§æ–¹å¼ä»æ•°æ®åº“ä¸­æå–ä¿¡æ¯ä¹‹åï¼Œä½¿ç”¨åŒæ­¥å¯¹è±¡å°†ç…§ç‰‡æ”¾ç½®åœ¨æœåŠ¡å™¨ç¼“å­˜ä¸­ï¼Œä»¥æ”¯æŒå¤šçº¿ç¨‹ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> SyncObject = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>(); ... List&lt;Photo&gt; photos = (List&lt;Photo&gt;)CachedAreas[hash]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (photos == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// Use lock to avoid extracting from and adding to the cache more than once. lock (SyncObject) { photos = (List&lt;Photo&gt;)CachedAreas[hash]; if (photos == null) { photos = PhotoList.GetAllFromRect(latMin, lngMin, latMax, lngMax, count); // Adding information about photos to the cache with a storage time of 2 minutes with a high storage priority. CachedAreas.Add(hash, photos, null, DateTime.Now.AddSeconds(120), Cache.NoSlidingExpiration, CacheItemPriority.High, null); } } } // Further usage of CachedAreas[hash]</span></span></code> </pre> <br><p> æœ¬èŠ‚ä»‹ç»äº†ç”¨äºä»æ•°æ®åº“æ£€ç´¢ç…§ç‰‡å¹¶å°†å…¶ä¿å­˜åˆ°ç¼“å­˜çš„æœåŠ¡å™¨åŠŸèƒ½ã€‚ ä¸‹ä¸€éƒ¨åˆ†å°†æè¿°æµè§ˆå™¨åœ¨å®¢æˆ·ç«¯å‘ç”Ÿçš„æƒ…å†µã€‚ </p><br><h2 id="client-side"> å®¢æˆ·ç«¯ </h2><br><p> ä¸ºäº†å¯è§†åŒ–åœ°å›¾å’Œä¸Šé¢çš„ç…§ç‰‡ï¼Œä½¿ç”¨äº†Google Maps APIã€‚ é¦–å…ˆï¼Œå¿…é¡»å°†ç”¨æˆ·åœ°å›¾ç§»åŠ¨åˆ°ä¸ç…§ç‰‡çš„åœ°ç†ä½ç½®ç›¸å¯¹åº”çš„ç‰¹å®šä½ç½®ã€‚ </p><br><h3 id="initializing-the-map"> åˆå§‹åŒ–åœ°å›¾ </h3><br><p> åˆå§‹åŒ–åœ°å›¾æ—¶ï¼Œæœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥ç¡®å®šåœ°ç†ä½ç½®ï¼šä½¿ç”¨HTML5çš„åŠŸèƒ½æˆ–å¯¹åŒºåŸŸä½¿ç”¨é¢„å…ˆè®¡ç®—çš„åæ ‡ã€‚ </p><br><h4 id="determining-the-geolocation-using-html5"> ä½¿ç”¨HTML5ç¡®å®šåœ°ç†ä½ç½® </h4><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">detectRegion</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (navigator.geolocation) { navigator.geolocation.getCurrentPosition(success); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { map.setZoom(defaultZoom); map.setCenter(defaultPoint); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">success</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">position</span></span></span><span class="hljs-function">) </span></span>{ ... map.setZoom(defaultZoom); map.setCenter(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> google.maps.LatLng(position.coords.latitude, position.coords.longitude)); }</code> </pre> <br><p> è¿™ç§æ–¹æ³•çš„ç¼ºç‚¹æ˜¯ï¼Œå¹¶éæ‰€æœ‰æµè§ˆå™¨éƒ½æ”¯æŒHTML5çš„æ­¤åŠŸèƒ½ï¼Œå¹¶ä¸”ç”¨æˆ·å¯èƒ½ä¸å…è®¸è®¿é—®å…¶è®¾å¤‡ä¸Šçš„åœ°ç†ä¿¡æ¯ã€‚ </p><br><h4 id="determining-the-geolocation-using-information-from-the-server"> ä½¿ç”¨æœåŠ¡å™¨ä¸­çš„ä¿¡æ¯ç¡®å®šåœ°ç†ä½ç½® </h4><br><p> è¯¥åœ°å›¾åœ¨ä¸‹é¢çš„æºä»£ç éƒ¨åˆ†ä¸­è¿›è¡Œäº†åˆå§‹åŒ–ï¼Œå…¶ä¸­çš„<code>bounds</code>æ˜¯æœåŠ¡å™¨è¿”å›çš„åŒºåŸŸï¼ˆå¡«å……åŒºåŸŸï¼ŒåŒºåŸŸæˆ–å›½å®¶/åœ°åŒºï¼‰çš„åæ ‡ã€‚ è¿‘ä¼¼ç¼©æ”¾çº§åˆ«åœ¨å‡½æ•°<code>getZoomFromBounds</code>è®¡ç®—ï¼ˆä»<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">stackoverflowä¸­è·å–</a> ï¼‰ã€‚ </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> northEast = bounds.getNorthEast(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> southWest = bounds.getSouthWest(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> myOptions = { <span class="hljs-attr"><span class="hljs-attr">zoom</span></span>: getZoomFromBounds(northEast, southWest), <span class="hljs-attr"><span class="hljs-attr">center</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> google.maps.LatLng((northEast.lat() + southWest.lat()) / <span class="hljs-number"><span class="hljs-number">2</span></span>, (northEast.lng() + southWest.lng()) / <span class="hljs-number"><span class="hljs-number">2</span></span>), <span class="hljs-attr"><span class="hljs-attr">mapTypeId</span></span>: google.maps.MapTypeId.ROADMAP, <span class="hljs-attr"><span class="hljs-attr">minZoom</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-attr"><span class="hljs-attr">maxZoom</span></span>: <span class="hljs-number"><span class="hljs-number">19</span></span> } map = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> google.maps.Map(<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">"map_canvas"</span></span>), myOptions);</code> </pre> <br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getZoomFromBounds</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ne, sw</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> GLOBE_WIDTH = <span class="hljs-number"><span class="hljs-number">256</span></span>; <span class="hljs-comment"><span class="hljs-comment">// a constant in Google's map projection var west = sw.lng(); var east = ne.lng(); var angle = east - west; if (angle &lt; 0) { angle += 360; } return Math.round(Math.log($('#map_canvas').width() * 360 / angle / GLOBE_WIDTH) / Math.LN2); }</span></span></code> </pre> <br><p> åœ¨æœåŠ¡å™¨ä¸Šï¼Œå°†æ ¹æ®ç”¨æˆ·çš„IPåœ°å€æ¥è®¡ç®—åŒºåŸŸã€‚ ä¸ºäº†æ±‡æ€»æ¯ä¸ªåŒºåŸŸçš„æ‰€æœ‰è¾¹ç•Œåæ ‡ï¼Œä½¿ç”¨äº†<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Googleåœ°ç†ç¼–ç api</a> ï¼Œå°½ç®¡ç¦»çº¿ä½¿ç”¨æ­¤ç±»ä¿¡æ¯æ˜¯ä¸åˆæ³•çš„ï¼› æ­¤å¤–ï¼Œæ¯å¤©æœ€å¤šæœ‰2500ä¸ªè¯·æ±‚ã€‚ å¯¹äºæˆ‘ä»¬æ•°æ®åº“ä¸­çš„æ¯ä¸ªåŸå¸‚ï¼Œåœ°åŒºå’Œå›½å®¶/åœ°åŒºï¼Œéƒ½ä¼šç”Ÿæˆä¸€ä¸ªæŸ¥è¯¢ï¼Œè¯¥æŸ¥è¯¢è¿”å›æ‰€éœ€çš„<code>viewport</code> <code>bounds</code>å’Œ<code>bounds</code> ã€‚ å®ƒä»¬ä»…é’ˆå¯¹æ— æ³•å®Œå…¨æ”¾å…¥è§†å£çš„å¤§åŒºåŸŸè€Œæœ‰æ‰€ä¸åŒã€‚ å¦‚æœæœåŠ¡å™¨è¿”å›é”™è¯¯ï¼Œåˆ™ä½¿ç”¨å…¶ä»–æŸ¥è¯¢ï¼Œå…¶ä¸­ä½¿ç”¨è¯¥åœ°åŒºçš„æœ¬åœ°è¯­è¨€æˆ–è‹±è¯­ï¼Œåˆ é™¤{Populated area}éƒ¨åˆ†ï¼Œä¾æ­¤ç±»æ¨ã€‚ <code>http://maps.googleapis.com/maps/api/geocode/xml?address={Country},{Region},{Populated area}&amp;sensor=false</code> </p><br><p> ä¾‹å¦‚ï¼Œå¯¹äºä»¥ä¸‹æŸ¥è¯¢ï¼š <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">http://maps.googleapis.com/maps/api/geocode/xml?address=Russiaï¼ŒIvanovo% 20åŒºåŸŸï¼ŒIvanovoï¼†sensor = false</a> </p><br><div class="spoiler">  <b class="spoiler_title">ä»¥ä¸‹åæ ‡å°†è¢«è¿”å›ï¼ˆç‰‡æ®µï¼‰</b> <div class="spoiler_text"><pre> <code class="html hljs xml">... <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">location</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">lat</span></span></span><span class="hljs-tag">&gt;</span></span>56.9951313<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">lat</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">lng</span></span></span><span class="hljs-tag">&gt;</span></span>40.9796047<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">lng</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">location</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">location_type</span></span></span><span class="hljs-tag">&gt;</span></span>APPROXIMATE<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">location_type</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">viewport</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">southwest</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">lat</span></span></span><span class="hljs-tag">&gt;</span></span>56.9420231<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">lat</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">lng</span></span></span><span class="hljs-tag">&gt;</span></span>40.8765941<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">lng</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">southwest</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">northeast</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">lat</span></span></span><span class="hljs-tag">&gt;</span></span>57.0703221<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">lat</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">lng</span></span></span><span class="hljs-tag">&gt;</span></span>41.0876169<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">lng</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">northeast</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">viewport</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bounds</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">southwest</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">lat</span></span></span><span class="hljs-tag">&gt;</span></span>56.9420231<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">lat</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">lng</span></span></span><span class="hljs-tag">&gt;</span></span>40.8765941<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">lng</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">southwest</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">northeast</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">lat</span></span></span><span class="hljs-tag">&gt;</span></span>57.0703221<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">lat</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">lng</span></span></span><span class="hljs-tag">&gt;</span></span>41.0876169<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">lng</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">northeast</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bounds</span></span></span><span class="hljs-tag">&gt;</span></span> ...</code> </pre> </div></div><br><h3 id="calculating-partially-visible-rectangular-areas"> è®¡ç®—éƒ¨åˆ†å¯è§çš„çŸ©å½¢åŒºåŸŸ </h3><br><h4 id="calculating-the-size-of-caching-areas"> è®¡ç®—ç¼“å­˜åŒºåŸŸçš„å¤§å° </h4><br><p> å› æ­¤ï¼Œå¦‚å‰æ‰€è¿°ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯çš„æ‰€æœ‰ç…§ç‰‡å‡è¢«çŸ©å½¢åŒºåŸŸç¼“å­˜ï¼ŒçŸ©å½¢åŒºåŸŸçš„èµ·ç‚¹æ˜¯ä»»æ„ç‚¹ï¼ˆåœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­æ˜¯åæ ‡ä¸ºï¼ˆ0ï¼Œ0ï¼‰çš„ç‚¹ï¼‰ï¼Œå…¶å¤§å°å–å†³äºåœ¨å½“å‰ç¼©æ”¾çº§åˆ«ä¸Šå¦‚ä¸‹ï¼š </p><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// The initial window at which initMapSizeLat and initMapSizeLng were calculated var initDefaultDimX = 1000, var initDefaultDimY = 800; // The current default viewport which depends on the size of the areas. var currentDefaultDimX = 1080, var currentDefaultDimY = 500; var initMapSizeLat = 0.0003019; var initMapSizeLng = 0.00067055; // The coefficient of size reduction (increase). var initRatio = 0.75; // To calculate the size of the smallest caching area, the map was zoomed in to the maximum zoom level // Ie initMapSizeLat and initMapSizeLng were calculated empirically. var initZoomSize = new google.maps.Size( initMapSizeLat / initDefaultDimX * currentDefaultDimX * initRatio, initMapSizeLng / initDefaultDimY * currentDefaultDimY * initRatio); // All subsequent sizes of areas can be calculated based only on the smallest area (by multiplying each size by 2, because with increasing the zoom level by 1, the linear dimensions increase by 2 times, and the quadratic dimensions increase by 4 times). function initZoomSizes() { zoomSizes = []; var coef = 1; for (var i = 21; i &gt;= 0; i--) { zoomSizes[i] = new google.maps.Size(initZoomSize.width * coef, initZoomSize.height * coef); coef *= 2; } }</span></span></code> </pre> <br><p> å› æ­¤ï¼Œåœ¨æ¯ä¸ªç¼©æ”¾çº§åˆ«ï¼Œå¦‚æœçŸ©å½¢åŒºåŸŸçš„å®½åº¦ä¸º1080pxï¼Œé«˜åº¦ä¸º500pxï¼Œåˆ™çŸ©å½¢åŒºåŸŸçš„å¤§å°ä¸ºå½“å‰è§†å£å¤§å°çš„<code>0.75^2=0.5625</code> ã€‚ </p><br><h4 id="using-delay-when-redrawing"> é‡ç»˜æ—¶ä½¿ç”¨å»¶è¿Ÿ </h4><br><p> ç”±äºåœ¨åœ°å›¾ä¸Šé‡æ–°ç»˜åˆ¶æ‰€æœ‰ç…§ç‰‡å¹¶ä¸æ˜¯ä¸€é¡¹å¿«é€Ÿçš„æ“ä½œï¼ˆç¨åå°†æ˜¾ç¤ºï¼‰ï¼Œå› æ­¤æˆ‘ä»¬å†³å®šåœ¨ç”¨æˆ·â€‹â€‹è¾“å…¥åè¿›è¡Œä¸€äº›å»¶è¿Ÿï¼š </p><br><pre> <code class="javascript hljs">google.maps.event.addListener(map, <span class="hljs-string"><span class="hljs-string">'bounds_changed'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (boundsChangedInverval != <span class="hljs-literal"><span class="hljs-literal">undefined</span></span>) clearInterval(boundsChangedInverval); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> zoom = map.getZoom(); boundsChangedInverval = setTimeout(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ boundsChanged(); }, prevZoom === zoom ? moveUpdateDelay : zoomUpdateDelay); prevZoom = zoom; });</code> </pre> <br><h4 id="calculating-coordinates-and-hashes-of-partially-visible-areas"> è®¡ç®—éƒ¨åˆ†å¯è§åŒºåŸŸçš„åæ ‡å’Œå“ˆå¸Œ </h4><br><p> ä½¿ç”¨å¯è§çš„åæ ‡ï¼ˆ <code>latMin</code> ï¼Œ <code>lngMin</code> ï¼‰å’Œå°ºå¯¸ï¼ˆä½¿ç”¨å‰é¢æè¿°çš„ç®—æ³•è®¡ç®—ï¼‰ä¸å¯è§çª—å£é‡å çš„æ‰€æœ‰çŸ©å½¢çš„åæ ‡å’Œå“ˆå¸Œçš„è®¡ç®—å¦‚ä¸‹ï¼š </p><br><div style="text-align:center;"><img src="https://habrastorage.org/storage2/d8f/63a/bd7/d8f63abd76978f82b66bd0cc5a06311e.png"></div><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> s = zoomSizes[zoom]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> beginLat = <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.floor((latMin - initPoint.x) / s.width) * s.width + initPoint.x; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> beginLng = <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.floor((lngMin - initPoint.y) / s.height) * s.height + initPoint.y; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lat = beginLat; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lng = beginLng; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lngMax &lt;= beginLng) beginLng = beginLng - <span class="hljs-number"><span class="hljs-number">360</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (lat &lt;= maxlat) { lng = beginLng; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (lng &lt;= maxLng) { <span class="hljs-comment"><span class="hljs-comment">// lat and normalizeLng(lng) coordinates are the coordinates of the overlapping rectangles. // Longitude normalization is used because the right boundary can be greater than 180 or the left boundary can be less than -180. loadIfNeeded(lat, normalizeLng(lng)); lng += s.height; } lat += s.width; } function normalizeLng(lng) { var rtn = lng % 360; if (rtn &lt;= 0) rtn += 360; if (rtn &gt; 180) rtn -= 360; return rtn; }</span></span></code> </pre> <br><p> ä¹‹åï¼Œå¯¹äºæ¯ä¸ªåŒºåŸŸï¼Œè°ƒç”¨ä»¥ä¸‹å‡½æ•°ï¼Œå¦‚æœ‰å¿…è¦ï¼Œè¯¥å‡½æ•°ä¼šå°†è¯·æ±‚å‘é€åˆ°æœåŠ¡å™¨ã€‚ å“ˆå¸Œè®¡ç®—å…¬å¼ä¸ºæ¯ä¸ªåŒºåŸŸè¿”å›å”¯ä¸€å€¼ï¼Œå› ä¸ºèµ·ç‚¹å’Œå°ºå¯¸æ˜¯å›ºå®šçš„ã€‚ </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loadIfNeeded</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">lat, lng</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> hash = calculateHash(lat, lng, zoom); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(hash <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> items)) { <span class="hljs-comment"><span class="hljs-comment">// Send a query to the database and put this cell in the client cache. } else { // Do nothing. } } function calculateHash(lat, lng, zoom) { // lat: [-90..90] // lng: [-180..180] return (lat + 90) + ((lng + 180) * 180) + (zoom * 64800); }</span></span></code> </pre> <br><h3 id="redrawing-the-displayed-photos"> é‡æ–°ç»˜åˆ¶æ˜¾ç¤ºçš„ç…§ç‰‡ </h3><br><p> ä»é«˜é€Ÿç¼“å­˜ä¸‹è½½æˆ–æå–æ‰€æœ‰ç…§ç‰‡åï¼Œå…¶ä¸­ä¸€äº›ç…§ç‰‡éœ€è¦é‡ç”»ã€‚ åœ¨ä¸€ä¸ªåœ°æ–¹æ”¾æœ‰å¤§é‡ç…§ç‰‡æˆ–æ ‡è®°æ—¶ï¼Œå…¶ä¸­ä¸€äº›åº”è¯¥è¢«éšè—ï¼Œä½†æ˜¯ç°åœ¨ä¸æ¸…æ¥šåœ¨è¿™ä¸ªåœ°æ–¹æ”¾ç½®äº†å¤šå°‘å¼ ç…§ç‰‡ã€‚ ä¸ºäº†è§£å†³æ­¤é—®é¢˜ï¼Œæˆ‘ä»¬å†³å®šæ”¯æŒä¸¤ç§ç±»å‹çš„æ ‡è®°ï¼šæ˜¾ç¤ºç…§ç‰‡çš„æ ‡è®°å’Œæ˜¾ç¤ºè¯¥ä½ç½®æœ‰ç…§ç‰‡çš„æ ‡è®°ã€‚ å¦å¤–ï¼Œå¦‚æœåœ¨æ›´æ”¹è¾¹ç•Œæ—¶æ‰€æœ‰æ ‡è®°éƒ½è¢«éšè—ï¼Œç„¶åé‡æ–°æ˜¾ç¤ºå®ƒä»¬ï¼Œåˆ™ç”¨æˆ·å¯èƒ½ä¼šæ³¨æ„åˆ°é—ªçƒã€‚ ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œå¼€å‘äº†ä»¥ä¸‹ç®—æ³•ï¼š </p><br><ol><li> å°†æ‰€æœ‰å¯è§çš„ç…§ç‰‡ä»å®¢æˆ·ç«¯ç¼“å­˜æå–åˆ°<code>visMarks</code>æ•°ç»„ã€‚ ä¸Šé¢æè¿°äº†ç”¨ç…§ç‰‡è®¡ç®—è¿™äº›åŒºåŸŸçš„æ–¹æ³•ã€‚ </li><li> æŒ‰å—æ¬¢è¿ç¨‹åº¦å¯¹æ”¶åˆ°çš„æ ‡è®°è¿›è¡Œæ’åºã€‚ </li><li> ä½¿ç”¨<code>markerSize</code> ï¼Œ <code>SmallMarkerSize</code> ï¼Œ <code>minPhotoDistRatio</code>å’Œ<code>pixelDistance</code>æŸ¥æ‰¾é‡å çš„æ ‡è®°ã€‚ </li><li> ä½¿ç”¨<code>maxBigVisPhotosCount</code>åˆ›å»ºå¤§æ ‡è®°æ•°ç»„ï¼Œå¹¶ä½¿ç”¨<code>maxBigVisPhotosCount</code>åˆ›å»ºå°æ ‡è®°<code>maxSmlVisPhotosCount</code> ã€‚ </li><li> å®šä¹‰åº”éšè—çš„æ—§æ ‡è®°ï¼Œå¹¶ä½¿ç”¨<code>refreshMarkerArrays</code>å°†å®ƒä»¬æ·»åŠ åˆ°<code>smlMarksToHide</code>å’Œ<code>bigMarksToHide</code>ä¸­ã€‚ </li><li> ä¸ºåº”ä½¿ç”¨<code>updateMarkersVis</code>æ˜¾ç¤ºçš„æ–°æ ‡è®°æ›´æ–°å¯è§æ€§å’Œç¼©æ”¾ç´¢å¼•<code>zIndex</code> ã€‚ </li><li> ä½¿ç”¨<code>addPhotoToRibbon</code>å°†å½“å‰å¯è§çš„ç…§ç‰‡æ·»åŠ åˆ°feedä¸­ã€‚ </li></ol><br><div class="spoiler">  <b class="spoiler_title">é‡æ–°è®¡ç®—å¯è§æ ‡è®°çš„ç®—æ³•</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">redraw</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ isRedrawing = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> visMarker; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> visMarks = []; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> visBigMarks2; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> visSmlMarks2; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bigMarksToHide = []; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> smlMarksToHide = []; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> photo; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i, j; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bounds = map.getBounds(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> northEast = bounds.getNorthEast(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> southWest = bounds.getSouthWest(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> latMin = southWest.lat(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lngMin = southWest.lng(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> latMax = northEast.lat(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lngMax = northEast.lng(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ratio = (latMax - latMin) / $(<span class="hljs-string"><span class="hljs-string">"#map_canvas"</span></span>).height(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> zoom = map.getZoom(); visMarks = []; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> k = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> s = zoomSizes[zoom]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> beginLat = <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.floor((latMin - initPoint.x) / s.width) * s.width + initPoint.x; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> beginLng = <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.floor((lngMin - initPoint.y) / s.height) * s.height + initPoint.y; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lat = beginLat; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lng = beginLng; i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lngMax &lt;= beginLng) beginLng = beginLng - <span class="hljs-number"><span class="hljs-number">360</span></span>; <span class="hljs-comment"><span class="hljs-comment">// Extracting all visible markers. while (lat &lt;= latMax) { lng = beginLng; while (lng &lt;= lngMax) { var hash = calcHash(lat, normLng(lng), zoom); if (!(hash in curItems)) { } else { var item = curItems[hash]; for (photo in item.photos) { if (bounds.contains(item.photos[photo].latLng)) { visMarks[i] = item.photos[photo]; visMarks[i].overlapCount = 0; i++; } } } k++; lng += s.height; } lat += s.width; } // Sorting markers by popularity. visMarks.sort(function (a, b) { if (b.priority !== a.priority) { return b.priority - a.priority; } else if (b.popularity !== a.popularity) { return b.popularity - a.popularity; } else { return b.id - a.id; } }); // Finding overlapping markers and markers that exceed a certain specified number. var curInd; var contains; var contains2; var dist; visBigMarks2 = []; visSmlMarks2 = []; for (i = 0; i &lt; visMarks.length; i++) { contains = false; contains2 = false; visMarker = visMarks[i]; for (j = 0; j &lt; visBigMarks2.length; j++) { dist = pixelDistance(visMarker.latLng, visBigMarks2[j].latLng, zoom); if (dist &lt;= markerSize * minPhotoDistRatio) { contains = true; if (contains &amp;&amp; contains2) break; } if (dist &lt;= (markerSize + smallMarkerSize) / 2) { contains2 = true; if (contains &amp;&amp; contains2) break; } } if (!contains) { if (visBigMarks2.length &lt; maxBigVisPhotosCount) { smlMarksToHide[smlMarksToHide.length] = visMarker; visBigMarks2[visBigMarks2.length] = visMarker; } } else { bigMarksToHide[bigMarksToHide.length] = visMarker; if (!contains2 &amp;&amp; visSmlMarks2.length &lt; maxSmlVisPhotosCount) { visSmlMarks2[visSmlMarks2.length] = visMarker; } else { visBigMarks2[j].overlapCount++; } } } // Adding markers that should be hidden to smlMarksToHide and bigMarksToHide. refreshMarkerArrays(visibleSmallMarkers, visSmlMarks2, smlMarksToHide); refreshMarkerArrays(visibleBigMarkers, visBigMarks2, bigMarksToHide); // Hiding invisible markers and displaying visible markers when zIndex changes. var curZInd = maxBigVisPhotosCount + 1; curZInd = updateMarkersVis(visBigMarks2, bigMarksToHide, true, curZInd); curZInd = 0; curZInd = updateMarkersVis(visSmlMarks2, smlMarksToHide, false, curZInd); visibleBigMarkers = visBigMarks2; visibleSmallMarkers = visSmlMarks2; // Adding visible photos to the feed. trPhotosOnMap.innerHTML = ''; for (var marker in visBigMarks2) { addPhotoToRibbon(visBigMarks2[marker]); } isRedrawing = false; } function refreshMarkerArrays(oldArr, newArr, toHide) { for (var j = 0; j &lt; oldArr.length; j++) { contains = false; var visMarker = oldArr[j]; for (i = 0; i &lt; newArr.length; i++) { if (newArr[i].id === visMarker.id) { contains = true; break; } } if (!contains) { toHide[toHide.length] = visMarker; } } } function updateMarkersVis(showArr, hideArr, big, curZInd) { var marker; var bounds = map.getBounds(); for (var i = 0; i &lt; showArr.length; i++) { var photo = showArr[i]; if (big) { marker = photo.bigMarker; $('#divOvlpCount' + photo.id).html(photo.overlapCount); } else { marker = photo.smlMarker; } marker.setZIndex(++curZInd); if (marker.getMap() === null) { marker.setMap(map); } } for (i = 0; i &lt; hideArr.length; i++) { marker = big ? hideArr[i].bigMarker : hideArr[i].smlMarker; if (marker.getMap() !== null) { marker.setMap(null); marker.setZIndex(0); if (!bounds.contains(hideArr[i].latLng)) hideArr[i].priority = 0; } } return curZInd; } function addPhotoToRibbon(marker) { var td = createColumn(marker); if (isLatLngValid(marker.latLng)) { trPhotosOnMap.appendChild(td); } else { trPhotosNotOnMap.appendChild(td); if (photoViewMode == 'user') { var img = $("#photo" + marker.id).children()[0]; $('#photo' + marker.id).draggable({ helper: 'clone', appendTo: $('#map_canvas'), stop: function (e) { var mapBoundingRect = document.getElementById("map_canvas").getBoundingClientRect(); var point = new google.maps.Point(e.pageX - mapBoundingRect.left, e.pageY - mapBoundingRect.top); var latLng = overlay.getProjection().fromContainerPixelToLatLng(point); marker.latLng = latLng; marker.priority = ++curPriority; placeMarker(marker); }, containment: 'parent', distance: 5 }); } } }</span></span></code> </pre> </div></div><br><h4 id="distance-on-the-map"> åœ°å›¾ä¸Šçš„è·ç¦» </h4><br><p> è¦è®¡ç®—åœ°å›¾ä¸Šä¸¤ç‚¹ä¹‹é—´çš„è·ç¦»ï¼ˆä»¥<em>åƒç´ </em>ä¸º<em>å•ä½ï¼‰</em> ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹å‡½æ•°ï¼š </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Offset = <span class="hljs-number"><span class="hljs-number">268435456</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Radius = <span class="hljs-number"><span class="hljs-number">85445659.4471</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pixelDistance</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">latLng1, latLng2, zoom</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> x1 = lonToX(latLng1.lng()); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> y1 = latToY(latLng1.lat()); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> x2 = lonToX(latLng2.lng()); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> y2 = latToY(latLng2.lat()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.sqrt((x1 - x2) * (x1 - x2) + (y1 - y2) * (y1 - y2)) &gt;&gt; (<span class="hljs-number"><span class="hljs-number">21</span></span> - zoom); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">lonToX</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">lng</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.round(Offset + Radius * lng * <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.PI / <span class="hljs-number"><span class="hljs-number">180</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">latToY</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">lat</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.round(Offset - Radius * <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.log((<span class="hljs-number"><span class="hljs-number">1</span></span> + <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.sin(lat * <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.PI / <span class="hljs-number"><span class="hljs-number">180</span></span>)) / (<span class="hljs-number"><span class="hljs-number">1</span></span> - <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.sin(lat * <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.PI / <span class="hljs-number"><span class="hljs-number">180</span></span>))) / <span class="hljs-number"><span class="hljs-number">2</span></span>); }</code> </pre> <br><p> åœ¨stackoverflowä¸Šä¹Ÿå‘ç°äº†æ­¤åŠŸèƒ½ã€‚ </p><br><p> ä¸ºäº†ä½¿æ ‡è®°çœ‹èµ·æ¥åƒå¸¦æœ‰ç…§ç‰‡çš„åœ†åœˆï¼ˆä¾‹å¦‚vkontakteï¼‰ï¼Œä½¿ç”¨äº†<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">RichMarker</a>æ’ä»¶ï¼Œå¹¶ä¸ºdivå…ƒç´ æ·»åŠ äº†ä»»æ„æ ·å¼ã€‚ </p><br><h2 id="conclusion"> ç»“è®º </h2><br><p> äº‹å®è¯æ˜ï¼Œä¸ºäº†åœ¨åœ°å›¾ä¸Šå¿«é€Ÿæ­£ç¡®åœ°æ˜¾ç¤ºç…§ç‰‡ï¼Œæˆ‘ä»¬éœ€è¦è§£å†³ä¸ç¼“å­˜å’Œçƒå½¢å‡ ä½•ä½“ç›¸å…³çš„éå¸¸æœ‰è¶£ä¸”ä¸å¹³å‡¡çš„é—®é¢˜ã€‚ å°½ç®¡å¹¶éæ‰€æœ‰æè¿°çš„æ–¹æ³•å®é™…ä¸Šéƒ½åœ¨æˆ‘ä»¬çš„é¡¹ç›®ä¸­ä½¿ç”¨è¿‡ï¼Œä½†å¹¶æ²¡æœ‰æµªè´¹æ—¶é—´ï¼Œå› ä¸ºæˆ‘ä»¬è·å¾—çš„ç»éªŒå¯èƒ½å¯¹å…¶ä»–é¡¹ç›®æœ‰ç”¨ï¼Œå¹¶ä¸”å¯¹é˜…è¯»å’Œç†è§£æœ¬æ–‡çš„äººä¹Ÿå¯èƒ½æœ‰ç”¨ã€‚ </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN440410/">https://habr.com/ru/post/zh-CN440410/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN440394/index.html">PostgreSQLæƒé™æå‡-CVE-2018-10915è§£æ</a></li>
<li><a href="../zh-CN440398/index.html">å‚åŠ 2018å¹´ä¿„ç½—æ–¯AIæ¯çš„å†å²ï¼ˆå’Œèƒœåˆ©ï¼‰-CodeBall</a></li>
<li><a href="../zh-CN440400/index.html">Apache Kafka + Spring Bootï¼šæ‚¨å¥½ï¼Œå¾®æœåŠ¡</a></li>
<li><a href="../zh-CN440402/index.html">SearchFaceå¼€å‘äººå‘˜æœ‰å…³ç®—æ³•åŠŸèƒ½çš„ä¿¡æ¯</a></li>
<li><a href="../zh-CN440404/index.html">â€œä¿¡æ¯æ¶æ„â€ï¼šOZONä¸­çš„mitap</a></li>
<li><a href="../zh-CN440412/index.html">Zimbraåä½œå¥—ä»¶å’ŒMS Exchangeåœ¨åŒä¸€åŸŸä¸Š</a></li>
<li><a href="../zh-CN440414/index.html">å…³äºçŸ­ç»’æ£‰ï¼Œä»£ç è´¨é‡ï¼Œä¸€èˆ¬è´¨é‡å’Œè´¨é‡ç®¡ç†</a></li>
<li><a href="../zh-CN440416/index.html">æ®–æ°‘åœ° ç¬¬25ç« </a></li>
<li><a href="../zh-CN440420/index.html">æ¬¢è¿å‚åŠ 2æœˆ21æ—¥çš„Devleadsèšä¼š</a></li>
<li><a href="../zh-CN440422/index.html">å½“æ‚¨å¯¹ç¤¼ç‰©çš„è´¨é‡è´Ÿè´£æ—¶ã€‚ ä¸€ä¸ªåŒºå—é“¾å®éªŒçš„å†å²</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>