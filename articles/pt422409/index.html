<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👹 🏂🏾 🎩 Python: metaprogramação em produção. Parte um 🕜 🎿 👴🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Muitas pessoas pensam que a metaprogramação no Python complica desnecessariamente o código, mas se você o usar corretamente, poderá implementar rápida...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Python: metaprogramação em produção. Parte um</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/binarydistrict/blog/422409/"><p> Muitas pessoas pensam que a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">metaprogramação</a> no Python complica desnecessariamente o código, mas se você o usar corretamente, poderá implementar rápida e elegantemente padrões de design complexos.  Além disso, estruturas conhecidas do Python, como Django, DRF e SQLAlchemy, usam metaclasses para fornecer extensibilidade fácil e reutilização fácil de código. </p><br><p><img src="https://habrastorage.org/webt/ls/ty/gh/lstyghddpotgif7f6jg8cl6kcbi.jpeg"></p><br><p>  Neste artigo, explicarei por que você não deve ter medo de usar a metaprogramação em seus projetos e mostrar para quais tarefas ela é mais adequada.  Você pode aprender mais sobre as opções de metaprogramação no curso <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Advanced Python</a> . </p><a name="habracut"></a><br><p>  Para começar, vamos relembrar o básico da metaprogramação no Python.  Não será supérfluo acrescentar que tudo o que está escrito abaixo se refere à versão 3.5 e superior do Python. </p><br><h2 id="kratkiy-ekskurs-v-model-dannyh-python">  Um rápido tour pelo modelo de dados Python </h2><br><p>  Portanto, todos sabemos que tudo em Python é um objeto, e não é segredo que para cada objeto existe uma certa classe pela qual foi gerada, por exemplo: </p><br><pre><code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">f</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> &gt;&gt;&gt; type(f) &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class">'&gt;</span></span></code> </pre> <br><p>  O tipo do objeto ou a classe pela qual o objeto foi gerado pode ser determinado usando a função de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tipo</a> interna, que possui uma assinatura de chamada bastante interessante (falaremos sobre isso mais adiante).  O mesmo efeito pode ser obtido derivando o atributo <code>__class__</code> em qualquer objeto. </p><br><p>  Portanto, para criar funções, uma certa <code>function</code> classe <code>function</code> .  Vamos ver o que podemos fazer com isso.  Para fazer isso, retire o espaço em branco do módulo de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tipos</a> interno: </p><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> types <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> FunctionType &gt;&gt;&gt; FunctionType &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class">'&gt; &gt;&gt;&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">help</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(FunctionType)</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class"> | </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(code, globals[, name[, argdefs[, closure]]])</span></span></span><span class="hljs-class"> | | </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Create</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">from</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">code</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">and</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dictionary</span></span></span><span class="hljs-class">. | </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">The</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">optional</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">overrides</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">the</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">from</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">the</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">code</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class">. | </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">The</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">optional</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">argdefs</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tuple</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">specifies</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">the</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">default</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">argument</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">values</span></span></span><span class="hljs-class">. | </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">The</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">optional</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">closure</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tuple</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">supplies</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">the</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bindings</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">free</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">variables</span></span></span><span class="hljs-class">.</span></span></code> </pre> <br><p>  Como podemos ver, qualquer função no Python é uma instância da classe descrita acima.  Vamos agora tentar criar uma nova função sem recorrer à sua declaração através de <code>def</code> .  Para fazer isso, precisamos aprender como criar objetos de código usando a função de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">compilação</a> incorporada ao intérprete: </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#   ,    "Hello, world!" &gt;&gt;&gt; code = compile('print("Hello, world!")', '&lt;repl&gt;', 'eval') &gt;&gt;&gt; code &lt;code object &lt;module&gt; at 0xdeadbeef, file "&lt;repl&gt;", line 1&gt; #  ,     , #      &gt;&gt;&gt; func = FunctionType(code, globals(), 'greetings') &gt;&gt;&gt; func &lt;function &lt;module&gt; at 0xcafefeed&gt; &gt;&gt;&gt; func.__name__ 'greetings' &gt;&gt;&gt; func() Hello, world!</span></span></code> </pre> <br><p>  Ótimo!  Com a ajuda de meta-ferramentas, aprendemos a criar funções dinamicamente, mas na prática esse conhecimento raramente é usado.  Agora, vamos dar uma olhada em como os objetos de classe e os objetos de instância dessas classes são criados: </p><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> &gt;&gt;&gt; user = User() &gt;&gt;&gt; type(user) &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">__main__</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class">'&gt; &gt;&gt;&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(User)</span></span></span><span class="hljs-class"> &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class">'&gt;</span></span></code> </pre> <br><p>  É bastante óbvio que a classe <code>User</code> é usada para criar uma instância do <code>user</code> , é muito mais interessante olhar para a classe <code>type</code> , que é usada para criar a própria classe <code>User</code> .  Aqui, voltaremos à segunda opção de chamar a função de <code>type</code> interno, que em combinação é uma metaclasse para qualquer classe no Python.  Uma metaclasse é, por definição, uma classe cuja instância é outra classe.  As metaclasses nos permitem personalizar o processo de criação de uma classe e controlar parcialmente o processo de criação de uma instância de uma classe. </p><br><p>  De acordo com a documentação, a segunda variante do <code>type(name, bases, attrs)</code> assinatura <code>type(name, bases, attrs)</code> - retorna um novo tipo de dados ou, se de maneira simples - uma nova classe, e o atributo <code>name</code> se torna o atributo <code>__name__</code> da classe retornada, <code>bases</code> - a lista de classes pai estará disponível como <code>__bases__</code> , Bem, <code>attrs</code> - um objeto semelhante a dict contendo todos os atributos e métodos da classe, entrará em <code>__dict__</code> .  O princípio da função pode ser descrito como um pseudo-código simples em Python: </p><br><pre> <code class="python hljs">type(name, bases, attrs) ~ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(bases)</span></span></span><span class="hljs-class">:</span></span> attrs</code> </pre> <br><p>  Vamos ver como você pode, usando apenas a chamada de <code>type</code> , construir uma classe completamente nova: </p><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>User = type(<span class="hljs-string"><span class="hljs-string">'User'</span></span>, (), {}) &gt;&gt;&gt; User &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">__main__</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class">'&gt;</span></span></code> </pre> <br><p>  Como você pode ver, não precisamos usar a palavra-chave <code>class</code> para criar uma nova classe, a função <code>type</code> fica sem ela, agora vamos ver um exemplo mais complicado: </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, name)</span></span></span><span class="hljs-function">:</span></span> self.name = name <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SuperUser</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(User)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-string"><span class="hljs-string">"""Encapsulate domain logic to work with super users"""</span></span> group_name = <span class="hljs-string"><span class="hljs-string">'admin'</span></span> @property <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">login</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">f'</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{self.group_name}</span></span></span><span class="hljs-string">/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{self.name}</span></span></span><span class="hljs-string">'</span></span>.lower() <span class="hljs-comment"><span class="hljs-comment">#     SuperUser "" CustomSuperUser = type( #   'SuperUser', #  ,      (User, ), #         { '__doc__': 'Encapsulate domain logic to work with super users', 'group_name': 'admin', 'login': property(lambda self: f'{self.group_name}/{self.name}'.lower()), } ) assert SuperUser.__doc__ == CustomSuperUser.__doc__ assert SuperUser('Vladimir').login == CustomSuperUser('Vladimir').login</span></span></code> </pre> <br><p>  Como você pode ver nos exemplos acima, a descrição de classes e funções usando as palavras-chave <code>class</code> e <code>def</code> é apenas um açúcar sintático e qualquer tipo de objeto pode ser criado por chamadas comuns a funções internas.  E agora, finalmente, vamos falar sobre como você pode usar a criação dinâmica de classes em projetos reais. </p><br><h2 id="dinamicheskoe-sozdanie-form-i-validatorov">  Crie dinamicamente formulários e validadores </h2><br><p>  Às vezes, precisamos validar as informações do usuário ou de outras fontes externas de acordo com um esquema de dados conhecido anteriormente.  Por exemplo, queremos alterar o formulário de login do usuário no painel de administração - excluir e adicionar campos, alterar a estratégia de validação etc. </p><br><p>  Para ilustrar, vamos tentar criar dinamicamente um formulário <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Django</a> , cuja descrição do esquema é armazenada no seguinte formato <code>json</code> : </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"fist_name"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"str"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_length"</span></span>: <span class="hljs-number"><span class="hljs-number">25</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"last_name"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"str"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_length"</span></span>: <span class="hljs-number"><span class="hljs-number">30</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"age"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"int"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"min_value"</span></span>: <span class="hljs-number"><span class="hljs-number">18</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_value"</span></span>: <span class="hljs-number"><span class="hljs-number">99</span></span> } }</code> </pre> <br><p>  Agora, com base na descrição acima, crie um conjunto de campos e um novo formulário usando a função de <code>type</code> que já conhecemos: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> forms fields_type_map = { <span class="hljs-string"><span class="hljs-string">'str'</span></span>: forms.CharField, <span class="hljs-string"><span class="hljs-string">'int'</span></span>: forms.IntegerField, } <span class="hljs-comment"><span class="hljs-comment"># form_description –  json    deserialized_form_description: dict = json.loads(form_description) form_attrs = {} #            for field_name, field_description in deserialized_form_description.items(): field_class = fields_type_map[field_description.pop('type')] form_attrs[field_name] = field_class(**field_description) user_form_class = type('DynamicForm', (forms.Form, ), form_attrs) &gt;&gt;&gt; form = user_form_class({'age': 101}) &gt;&gt;&gt; form &lt;DynamicForm bound=True, valid=Unknown, fields=(fist_name;last_name;age)&gt; &gt;&gt;&gt; form.is_valid() False &gt;&gt;&gt; form.errors {'fist_name': ['This field is required.'], 'last_name': ['This field is required.'], 'age': ['Ensure this value is less than or equal to 99.']}</span></span></code> </pre> <br><p>  Ótimo!  Agora você pode transferir o formulário criado para o modelo e renderizá-lo para o usuário.  A mesma abordagem pode ser usada com outras estruturas para validação e apresentação de dados ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">serializadores DRF</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">marshmallow</a> e outros). </p><br><h2 id="konfiguriruem-sozdanie-novogo-klassa-cherez-metaklass">  Configurando a criação de uma nova classe através da metaclasse </h2><br><p>  Acima, vimos a metaclasse do <code>type</code> "terminado", mas na maioria das vezes no código você criará suas próprias metaclasses e as usará para configurar a criação de novas classes e suas instâncias.  No caso geral, o "espaço em branco" de uma metaclasse é assim: </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MetaClass</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(type)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-string"><span class="hljs-string">"""   : mcs –  ,  &lt;__main__.MetaClass&gt; name – ,  ,     ,  "User" bases –   -,  (SomeMixin, AbstractUser) attrs – dict-like ,         cls –  ,  &lt;__main__.User&gt; extra_kwargs –  keyword-     args  kwargs –          """</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__new__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(mcs, name, bases, attrs, **extra_kwargs)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> super().__new__(mcs, name, bases, attrs) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cls, name, bases, attrs, **extra_kwargs)</span></span></span><span class="hljs-function">:</span></span> super().__init__(cls) @classmethod <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__prepare__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(mcs, cls, bases, **extra_kwargs)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> super().__prepare__(mcs, cls, bases, **kwargs) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__call__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cls, *args, **kwargs)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> super().__call__(*args, **kwargs)</code> </pre> <br><p>  Para usar essa metaclasse para configurar a classe <code>User</code> , a seguinte sintaxe é usada: </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(metaclass=MetaClass)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__new__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cls, name)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> super().__new__(cls) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, name)</span></span></span><span class="hljs-function">:</span></span> self.name = name</code> </pre> <br><p>  O mais interessante é a ordem na qual o interpretador Python chama o metamétodo da metaclasse no momento em que a própria classe é criada: </p><br><ol><li>  O intérprete determina e localiza as classes pai da classe atual (se houver). </li><li>  O intérprete define uma metaclasse ( <code>MetaClass</code> no nosso caso). </li><li>  O método <code>MetaClass.__prepare__</code> é <code>MetaClass.__prepare__</code> - ele deve retornar um objeto semelhante ao <code>MetaClass.__prepare__</code> no qual os atributos e métodos da classe serão gravados.  Depois disso, o objeto será passado para o <code>MetaClass.__new__</code> através do argumento <code>attrs</code> .  Falaremos sobre o uso prático desse método um pouco mais adiante nos exemplos. </li><li>  O intérprete lê o corpo da classe <code>User</code> e gera parâmetros para transmiti-los à metaclasse <code>MetaClass</code> . </li><li>  O método <code>MetaClass.__new__</code> é <code>MetaClass.__new__</code> - o método <code>MetaClass.__new__</code> , retorna o objeto de classe criado.  Já conhecemos os argumentos <code>name</code> , <code>bases</code> e <code>attrs</code> quando os passamos para a função <code>type</code> , e falaremos sobre o parâmetro <code>**extra_kwargs</code> um pouco mais tarde.  Se o tipo do argumento <code>attrs</code> foi alterado usando <code>__prepare__</code> , ele deve ser convertido em um <code>dict</code> antes de passá-lo para a chamada do método <code>super()</code> . </li><li>  O método <code>MetaClass.__init__</code> é <code>MetaClass.__init__</code> - o método inicializador com o qual você pode adicionar atributos e métodos adicionais ao objeto de classe na classe.  Na prática, é usado nos casos em que as metaclasses são herdadas de outras metaclasses, caso contrário, tudo o que pode ser feito em <code>__init__</code> é melhor feito em <code>__new__</code> .  Por exemplo, o parâmetro <code>__slots__</code> <strong>só</strong> pode ser definido no método <code>__new__</code> gravando-o no objeto <code>attrs</code> . </li><li>  Nesta etapa, a classe é considerada criada. </li></ol><br><p>  Agora crie uma instância da nossa classe <code>User</code> e observe a cadeia de chamadas: </p><br><pre> <code class="python hljs">user = User(name=<span class="hljs-string"><span class="hljs-string">'Alyosha'</span></span>)</code> </pre> <br><ol><li>  No momento da chamada do <code>User(...)</code> intérprete chama o <code>MetaClass.__call__(name='Alyosha')</code> , onde passa o objeto de classe e os argumentos passados. </li><li>  <code>MetaClass.__call__</code> chama <code>User.__new__(name='Alyosha')</code> - um método construtor que cria e retorna uma instância da classe <code>User</code> </li><li>  Em seguida, <code>MetaClass.__call__</code> chama <code>User.__init__(name='Alyosha')</code> - um método inicializador que adiciona novos atributos à instância criada. </li><li>  <code>MetaClass.__call__</code> retorna a instância criada e inicializada da classe <code>User</code> . </li><li>  Neste ponto, uma instância da classe é considerada criada. </li></ol><br><p>  Essa descrição, é claro, não cobre todas as nuances do uso de metaclasses, mas é suficiente começar a usar a metaprogramação para implementar alguns padrões arquiteturais.  Encaminhar para os exemplos! </p><br><h2 id="abstraktnye-klassy">  Classes abstratas </h2><br><p>  E o primeiro exemplo pode ser encontrado na biblioteca padrão: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ABCMeta</a> - uma metaclasse permite que você declare qualquer resumo de nossa classe e force todos os seus descendentes a implementar métodos, propriedades e atributos predefinidos; </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> abc <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ABCMeta, abstractmethod <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BasePlugin</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(metaclass=ABCMeta)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-string"><span class="hljs-string">"""   supported_formats   run        """</span></span> @property @abstractmethod <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">supported_formats</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function"> -&gt; list:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> @abstractmethod <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, input_data: dict)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span></code> </pre> <br><p>  Se todos os métodos e atributos abstratos não forem implementados no herdeiro, quando tentarmos criar uma instância da classe herdeiro, obteremos um <code>TypeError</code> : </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">VideoPlugin</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(BasePlugin)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> print(<span class="hljs-string"><span class="hljs-string">'Processing video...'</span></span>) plugin = VideoPlugin() <span class="hljs-comment"><span class="hljs-comment"># TypeError: Can't instantiate abstract class VideoPlugin # with abstract methods supported_formats</span></span></code> </pre> <br><p>  O uso de classes abstratas ajuda a corrigir imediatamente a interface da classe base e a evitar futuros erros de herança, por exemplo erros de digitação no nome de um método substituído. </p><br><h2 id="sistema-plaginov-s-avtomaticheskoy-registraciey">  Sistema de plug-in de registro automático </h2><br><p>  Muitas vezes, a metaprogramação é usada para implementar vários padrões de design.  Quase qualquer estrutura conhecida usa metaclasses para criar objetos de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">registro</a> .  Tais objetos armazenam links para outros objetos e permitem que sejam recebidos rapidamente em qualquer lugar do programa.  Considere um exemplo simples de registro automático de plug-ins para reproduzir arquivos de mídia de vários formatos. </p><br><p>  Implementação de metaclasse: </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RegistryMeta</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(ABCMeta)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-string"><span class="hljs-string">""" ,      .     " " -&gt; " " """</span></span> _registry_formats = {} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__new__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(mcs, name, bases, attrs)</span></span></span><span class="hljs-function">:</span></span> cls: <span class="hljs-string"><span class="hljs-string">'BasePlugin'</span></span> = super().__new__(mcs, name, bases, attrs) <span class="hljs-comment"><span class="hljs-comment">#     (BasePlugin) if inspect.isabstract(cls): return cls for media_format in cls.supported_formats: if media_format in mcs._registry_formats: raise ValueError(f'Format {media_format} is already registered') #       mcs._registry_formats[media_format] = cls return cls @classmethod def get_plugin(mcs, media_format: str): try: return mcs._registry_formats[media_format] except KeyError: raise RuntimeError(f'Plugin is not defined for {media_format}') @classmethod def show_registry(mcs): from pprint import pprint pprint(mcs._registry_formats)</span></span></code> </pre> <br><p>  E aqui estão os próprios plug-ins, pegaremos a implementação <code>BasePlugin</code> do exemplo anterior: </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BasePlugin</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(metaclass=RegistryMeta)</span></span></span><span class="hljs-class">:</span></span> ... <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">VideoPlugin</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(BasePlugin)</span></span></span><span class="hljs-class">:</span></span> supported_formats = [<span class="hljs-string"><span class="hljs-string">'mpg'</span></span>, <span class="hljs-string"><span class="hljs-string">'mov'</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> ... <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AudioPlugin</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(BasePlugin)</span></span></span><span class="hljs-class">:</span></span> supported_formats = [<span class="hljs-string"><span class="hljs-string">'mp3'</span></span>, <span class="hljs-string"><span class="hljs-string">'flac'</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> ...</code> </pre> <br><p>  Após executar este código, o intérprete registrará 4 formatos e 2 plugins em nosso registro que podem processar estes formatos: </p><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>RegistryMeta.show_registry() {<span class="hljs-string"><span class="hljs-string">'flac'</span></span>: &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">__main__</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AudioPlugin</span></span></span><span class="hljs-class">'&gt;, '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mov</span></span></span><span class="hljs-class">':</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">__main__</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">VideoPlugin</span></span></span><span class="hljs-class">'&gt;, '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mp3</span></span></span><span class="hljs-class">':</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">__main__</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AudioPlugin</span></span></span><span class="hljs-class">'&gt;, '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mpg</span></span></span><span class="hljs-class">':</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">__main__</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">VideoPlugin</span></span></span><span class="hljs-class">'&gt;} &gt;&gt;&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plugin_class</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RegistryMeta</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">get_plugin</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-class"><span class="hljs-params"><span class="hljs-string">'mov'</span></span></span></span><span class="hljs-class"><span class="hljs-params">)</span></span></span><span class="hljs-class"> &gt;&gt;&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plugin_class</span></span></span><span class="hljs-class"> &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">__main__</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">VideoPlugin</span></span></span><span class="hljs-class">'&gt; &gt;&gt;&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plugin_class</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">()</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">()</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Processing</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">video</span></span></span><span class="hljs-class">...</span></span></code> </pre> <br><p>  Vale a pena notar mais uma nuance interessante de trabalhar com metaclasses, graças à ordem de resolução do método não óbvio, podemos chamar o método <code>show_registry</code> não apenas na classe <code>RegistyMeta</code> , mas em qualquer outra classe da qual seja uma metaclasse: </p><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>AudioPlugin.get_plugin(<span class="hljs-string"><span class="hljs-string">'avi'</span></span>) <span class="hljs-comment"><span class="hljs-comment"># RuntimeError: Plugin is not found for avi</span></span></code> </pre> <br><h2 id="ispolzovanie-imen-atributov-v-kachestve-metadannyh">  Usando nomes de atributo como metadados </h2><br><p>  Usando metaclasses, você pode usar nomes de atributos de classe como metadados para outros objetos.  Nada está claro?  Mas tenho certeza que você já viu essa abordagem muitas vezes, por exemplo, declaração declarativa dos campos de modelo no Django: </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Book</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(models.Model)</span></span></span><span class="hljs-class">:</span></span> title = models.Charfield(max_length=<span class="hljs-number"><span class="hljs-number">250</span></span>)</code> </pre> <br><p>  No exemplo acima, <code>title</code> é o nome do identificador Python, também é usado para nomear a coluna na tabela de <code>book</code> , embora não tenhamos indicado isso explicitamente em nenhum lugar.  Sim, essa "mágica" pode ser realizada com a ajuda da metaprogramação.  Vamos, por exemplo, implementar um sistema para transmitir erros de aplicativos ao front-end, para que cada mensagem tenha um código legível que possa ser usado para traduzir a mensagem em outro idioma.  Portanto, temos um objeto de mensagem que pode ser convertido em <code>json</code> : </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Message</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, text, code=None)</span></span></span><span class="hljs-function">:</span></span> self.text = text self.code = code <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">to_json</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> json.dumps({<span class="hljs-string"><span class="hljs-string">'text'</span></span>: self.text, <span class="hljs-string"><span class="hljs-string">'code'</span></span>: self.code})</code> </pre> <br><p>  Todas as nossas mensagens de erro serão armazenadas em um "espaço para nome" separado: </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Messages</span></span></span><span class="hljs-class">:</span></span> not_found = Message(<span class="hljs-string"><span class="hljs-string">'Resource not found'</span></span>) bad_request = Message(<span class="hljs-string"><span class="hljs-string">'Request body is invalid'</span></span>) ... &gt;&gt;&gt; Messages.not_found.to_json() {<span class="hljs-string"><span class="hljs-string">"text"</span></span>: <span class="hljs-string"><span class="hljs-string">"Resource not found"</span></span>, <span class="hljs-string"><span class="hljs-string">"code"</span></span>: null}</code> </pre> <br><p>  Agora queremos que o <code>code</code> torne não <code>null</code> , mas não <code>not_found</code> , para isso, escrevemos a seguinte metaclasse: </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MetaMessage</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(type)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__new__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(mcs, name, bases, attrs)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> attr, value <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> attrs.items(): <span class="hljs-comment"><span class="hljs-comment">#          Message #    code    # ( code   ) if isinstance(value, Message) and value.code is None: value.code = attr return super().__new__(mcs, name, bases, attrs) class Messages(metaclass=MetaMessage): ...</span></span></code> </pre> <br><p>  Vamos ver como ficam as nossas postagens: </p><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>Messages.not_found.to_json() {<span class="hljs-string"><span class="hljs-string">"text"</span></span>: <span class="hljs-string"><span class="hljs-string">"Resource not found"</span></span>, <span class="hljs-string"><span class="hljs-string">"code"</span></span>: <span class="hljs-string"><span class="hljs-string">"not_found"</span></span>} &gt;&gt;&gt; Messages.bad_request.to_json() {<span class="hljs-string"><span class="hljs-string">"text"</span></span>: <span class="hljs-string"><span class="hljs-string">"Request body is invalid"</span></span>, <span class="hljs-string"><span class="hljs-string">"code"</span></span>: <span class="hljs-string"><span class="hljs-string">"bad_request"</span></span>}</code> </pre> <br><p>  O que você precisa!  Agora você sabe o que fazer para que, pelo formato dos dados, encontre facilmente o código que os processa. </p><br><h2 id="keshirovanie-metadannyh-o-klasse-i-ego-naslednikah">  Armazenando em cache metadados sobre uma classe e seus descendentes </h2><br><p>  Outro caso comum é armazenar em cache qualquer dado estático no estágio de criação da classe, para não perder tempo calculando-o enquanto o aplicativo está em execução.  Além disso, alguns dados podem ser atualizados ao criar novas instâncias de classes, por exemplo, um contador do número de objetos criados. </p><br><p>  Como isso pode ser usado?  Suponha que você esteja desenvolvendo uma estrutura para criar relatórios e tabelas e tenha um objeto como esse: </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Row</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(metaclass=MetaRow)</span></span></span><span class="hljs-class">:</span></span> name: str age: int ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, **kwargs)</span></span></span><span class="hljs-function">:</span></span> self.counter = <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> attr, value <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> kwargs.items(): setattr(self, attr, value) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__str__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> out = [self.counter] <span class="hljs-comment"><span class="hljs-comment">#  __header__      for name in self.__header__[1:]: out.append(getattr(self, name, 'N/A')) return ' | '.join(map(str, out))</span></span></code> </pre> <br><p>  Queremos salvar e aumentar o contador ao criar uma nova linha e também queremos gerar o cabeçalho da tabela resultante com antecedência.  Metaclasse para o resgate! </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MetaRow</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(type)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-comment"><span class="hljs-comment">#      row_count = 0 def __new__(mcs, name, bases, attrs): cls = super().__new__(mcs, name, bases, attrs) #          cls.__header__ = ['№'] + sorted(attrs['__annotations__'].keys()) return cls def __call__(cls, *args, **kwargs): #      row: 'Row' = super().__call__(*args, **kwargs) #    cls.row_count += 1 #     row.counter = cls.row_count return row</span></span></code> </pre> <br><p>  Duas coisas precisam ser esclarecidas aqui: </p><br><ul><li>  A classe <code>Row</code> não possui atributos de classe com os nomes <code>name</code> e <code>age</code> - são <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">anotações de tipo</a> , portanto não estão nas chaves do dicionário <code>attrs</code> e, para obter uma lista de campos, usamos o <code>__annotations__</code> classe <code>__annotations__</code> . </li><li>  A operação <code>cls.row_count += 1</code> deveria enganar você: como assim?  Afinal, <code>cls</code> é uma classe <code>Row</code> ; não possui o atributo <code>row_count</code> .  Tudo é verdade, mas, como expliquei acima - se a classe criada não possui um atributo ou método que eles estão tentando chamar, o intérprete vai além na cadeia de classes base - se não houver nenhuma, uma pesquisa é feita na metaclasse.  Nesses casos, para não confundir ninguém, é melhor usar outro registro: <code>MetaRow.row_count += 1</code> . </li></ul><br><p>  Veja com que elegância agora você pode exibir a tabela inteira: </p><br><pre> <code class="python hljs">rows = [ Row(name=<span class="hljs-string"><span class="hljs-string">'Valentin'</span></span>, age=<span class="hljs-number"><span class="hljs-number">25</span></span>), Row(name=<span class="hljs-string"><span class="hljs-string">'Sergey'</span></span>, age=<span class="hljs-number"><span class="hljs-number">33</span></span>), Row(name=<span class="hljs-string"><span class="hljs-string">'Gosha'</span></span>), ] print(<span class="hljs-string"><span class="hljs-string">' | '</span></span>.join(Row.__header__)) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> row <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> rows: print(row)</code> </pre> <br><pre> <code class="hljs ruby">№ <span class="hljs-params"><span class="hljs-params">| age |</span></span> name <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-params"><span class="hljs-params">| 25 |</span></span> Valentin <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-params"><span class="hljs-params">| 33 |</span></span> Sergey <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-params"><span class="hljs-params">| N/A |</span></span> Gosha</code> </pre> <br><p>  A propósito, exibir e trabalhar com uma tabela pode ser encapsulado em qualquer <code>Sheet</code> classe separada. </p><br><h2 id="prodolzhenie-sleduet">  Para continuar ... </h2><br><p>  Na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">próxima parte</a> deste artigo, descreverei como usar metaclasses para depurar o código do aplicativo, como parametrizar a criação de uma metaclasse e mostrarei exemplos básicos do uso do método <code>__prepare__</code> .  Fique atento! </p><br><p>  Mais detalhadamente sobre metaclasses e descritores em Python, contarei na estrutura do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Advanced Python</a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt422409/">https://habr.com/ru/post/pt422409/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt422397/index.html">“O principal é que eu passei”: o que e como os futuros especialistas em TI são ensinados em Berlim</a></li>
<li><a href="../pt422399/index.html">O processo de revisão de código em hh.ru</a></li>
<li><a href="../pt422401/index.html">Outra estrutura de plug-in C ++</a></li>
<li><a href="../pt422403/index.html">20 de setembro de Moscou - uma reunião para analistas</a></li>
<li><a href="../pt422407/index.html">Localizar e classificar textos relacionados</a></li>
<li><a href="../pt422411/index.html">Novos papéis nas empresas na era da servitização</a></li>
<li><a href="../pt422413/index.html">Aplicação do Arm Mbed OS. Ajuste fino</a></li>
<li><a href="../pt422415/index.html">Python: metaprogramação em produção. Parte dois</a></li>
<li><a href="../pt422417/index.html">Slavik e GMT + 3 ou benefício para pessoas</a></li>
<li><a href="../pt422419/index.html">Não sem pânico no Go</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>