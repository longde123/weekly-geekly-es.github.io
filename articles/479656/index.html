<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üåô üìÅ üèáüèæ PostgreSQL Antipatterns: estad√≠sticas alrededor de la cabeza üëæ üë®üèª‚Äçüåæ üëßüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="PostgreSQL utiliza estad√≠sticas acumuladas sobre la distribuci√≥n de valores de datos en las tablas de destino para seleccionar el plan de ejecuci√≥n de...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>PostgreSQL Antipatterns: estad√≠sticas alrededor de la cabeza</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tensor/blog/479656/">  <a href="https://postgrespro.ru/docs/postgresql/12/planner-stats">PostgreSQL utiliza estad√≠sticas acumuladas</a> sobre la distribuci√≥n de valores de datos en las tablas de destino para seleccionar el plan de ejecuci√≥n de consultas m√°s eficiente. <br><br>  Se actualiza ejecutando expl√≠citamente los comandos <b>ANALYZE</b> y <b>VACUUM ANALYZE</b> o en segundo plano mediante el <i>proceso autovacuum / autoanalyze</i> .  Pero si las estad√≠sticas no tienen tiempo para actualizarse, pueden ocurrir problemas. <br><br>  ¬øC√≥mo detectar y solucionar tal problema? <br><a name="habracut"></a><br>  La opci√≥n principal cuando tal situaci√≥n puede ocurrir es si el conjunto de datos ha cambiado dram√°ticamente en la tabla.  Es decir, <i>gener√≥ una gran cantidad de INSERT / UPDATE / DELETE o simplemente "verti√≥" los datos</i> en una tabla vac√≠a, por ejemplo, <b>al restaurar desde una copia de seguridad</b> . <br><br>  La ayuda para la <a href="https://postgrespro.ru/docs/postgresql/12/app-pgrestore">utilidad de recuperaci√≥n</a> est√°ndar <a href="https://postgrespro.ru/docs/postgresql/12/app-pgrestore">pg_restore</a> incluso dice expl√≠citamente: <br><blockquote>  Despu√©s de la recuperaci√≥n, tiene sentido ejecutar ANALYZE para cada tabla restaurada para que el optimizador reciba estad√≠sticas actualizadas. <br></blockquote>  Por lo tanto, si est√° haciendo algo similar con la base de datos, no sea perezoso, ejecute <a href="https://postgrespro.ru/docs/postgresql/12/sql-analyze">ANALYZE</a> inmediatamente para las tablas m√°s "en negrita" o para toda la base de datos. <br><br><h3>  Determinamos la presencia de un problema. </h3><br>  ¬øPor qu√© se ve exactamente la situaci√≥n de "todo malo"?  Por lo general, algo como esto: <br><img src="https://habrastorage.org/webt/88/oq/j_/88oqj_7rh-kkdso8uxjkezopfga.png"><br><br>  La columna de <b>proporci√≥n</b> solo muestra la relaci√≥n "a veces" entre el n√∫mero de registros planeados sobre la base de estad√≠sticas y el n√∫mero realmente le√≠do: <br><br><pre><code class="plaintext hljs">Bitmap Heap Scan on ... (... rows=14831 ...) (actual ... rows=9 ...)</code> </pre> <br>  <b>Cuanto mayor es este valor, peor son las</b> estad√≠sticas que reflejan la situaci√≥n real en su tabla.  Normalmente, generalmente <i>no supera los cientos</i> , en este ejemplo, <i>medio millar de veces</i> . <br><br>  Esto lleva a la elecci√≥n de un plan ineficaz y, como resultado, la <u>carga m√°s salvaje en la base</u> .  Para eliminarlo r√°pidamente, solo necesita escuchar las recomendaciones del manual y pasar por <b>ANALIZAR</b> en las tablas principales. <br><br>  Aqu√≠ est√° la carga de la CPU en el servidor de la base de datos antes y despu√©s de esta operaci√≥n para el ejemplo anterior: <br><br><img src="https://habrastorage.org/webt/1d/z1/_t/1dz1_tjab_zmcwy-ir0ei2_tjte.png"><br><br><h3>  Tabla actualizada con frecuencia </h3><br>  Pero, ¬øqu√© pasa si la tabla realmente cambia una gran cantidad de registros?  Por ejemplo, este es alg√∫n tipo de b√∫fer o cola de procesamiento donde se agregan constantemente nuevas entradas y se eliminan las antiguas. <br><br>  En este caso, los siguientes <a href="https://postgrespro.ru/docs/postgresql/12/runtime-config-autovacuum">par√°metros de configuraci√≥n</a> nos ayudar√°n: <br><blockquote>  <b>autovacuum_naptime</b> (entero) <br>  Establece el retraso m√≠nimo entre dos ejecuciones de limpieza autom√°tica para una sola base de datos.  El demonio de limpieza autom√°tica escanea la base de datos en el intervalo de tiempo especificado y emite los comandos VACUUM y ANALYZE cuando sea necesario para las tablas en esta base de datos.  Si este valor se especifica sin unidades, se considera establecido en segundos.  Por defecto, el retraso es de un minuto (1 min).  Este par√°metro solo se puede establecer en postgresql.conf o en la l√≠nea de comando cuando se inicia el servidor. <br><br>  <b>autovacuum_analyze_threshold</b> (entero) <br>  Establece el n√∫mero m√≠nimo de tuplas agregadas, modificadas o eliminadas en las que ANALYZE se ejecutar√° para una sola tabla.  El valor predeterminado es 50 tuplas.  Este par√°metro solo se puede establecer en postgresql.conf o en la l√≠nea de comando cuando se inicia el servidor.  Sin embargo, este valor <u>se puede anular para las tablas seleccionadas</u> cambiando su configuraci√≥n de almacenamiento. <br><br>  <b>autovacuum_analyze_scale_factor</b> (coma flotante) <br>  Especifica el porcentaje del tama√±o de la tabla que se agregar√° a autovacuum_analyze_threshold cuando se seleccione el umbral del comando ANALYZE.  El valor predeterminado es 0.1 (10% del tama√±o de la tabla).  Puede establecer este par√°metro solo en postgresql.conf o en la l√≠nea de comando cuando se inicia el servidor.  Sin embargo, este valor <u>se puede anular para las tablas seleccionadas</u> cambiando su configuraci√≥n de almacenamiento. </blockquote><br><h3>  SWSS </h3><br>  A veces, al configurar un servidor, <i>autovacuum_naptime se</i> " <i>aplasta</i> " a "una vez al d√≠a" (1d) para <b>que los autoVACUUM recorran menos la base de datos</b> y <b>consuman</b> menos recursos. <br><br>  A veces, aunque muy raramente, incluso puede justificarse, por ejemplo, si tiene <i>miles de tablas / secciones</i> en una base de datos (incluso si se presentan en diferentes patrones). <br><br>  Debido a que la definici√≥n misma de qu√© tablas espec√≠ficas de la lista completa deben procesarse, durante la inicializaci√≥n del proceso de vac√≠o autom√°tico, <b>puede ocupar una parte considerable de los recursos y ralentizar el servidor</b> . <br><br>  Solo en este caso, tendr√° problemas con una tabla modificada con frecuencia. <br><br>  Aqu√≠: establezca un intervalo de inicio m√°s adecuado o persiga ANALIZAR de acuerdo con dicha tabla en modo "manual" por algunos motivos aplicados (por ejemplo, un temporizador externo o despu√©s del final de la siguiente etapa del procesamiento de la cola). <br><br>  <i>¬°Camarada, mantenga las estad√≠sticas actualizadas!</i> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/479656/">https://habr.com/ru/post/479656/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../479636/index.html">Propia pila de navegaci√≥n. ¬øMejor que ROS?</a></li>
<li><a href="../479642/index.html">C√≥mo las est√∫pidas decisiones al dise√±ar un avi√≥n de la Segunda Guerra Mundial llevaron a la creaci√≥n del Macintosh</a></li>
<li><a href="../479646/index.html">Malos consejos o razones para seguir aprendiendo ingl√©s despu√©s de intermedio</a></li>
<li><a href="../479650/index.html">Las 12 infograf√≠as din√°micas din√°micas de TI m√°s interesantes</a></li>
<li><a href="../479654/index.html">Django vue generador</a></li>
<li><a href="../479660/index.html">3. An√°lisis de malware mediante el an√°lisis forense de Check Point. Chorro de arena m√≥vil</a></li>
<li><a href="../479662/index.html">C√≥mo Yandex ense√±√≥ inteligencia artificial para encontrar errores en las noticias</a></li>
<li><a href="../479664/index.html">C√≥mo funcionan los kubernetes gestionados y OpenShift gestionados en IBM Cloud. Parte 1 - Arquitectura y seguridad</a></li>
<li><a href="../479666/index.html">Golang: ¬øEn qu√© conf√≠a un especialista en Go en un mar de especialidades de TI?</a></li>
<li><a href="../479668/index.html">QA para principiantes: ¬øc√≥mo probar un cohete o avi√≥n?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>