<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üé¢ üç≥ ‚¨úÔ∏è Mainkan "osu!", But Watch Out for Bugs ü§∂üèø üë¶üèæ üßöüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hai, kalian semua pengoleksi serangga eksotis dan polos! Kami punya spesimen langka di bangku tes PVS-Studio kami hari ini - permainan yang disebut "o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Mainkan "osu!", But Watch Out for Bugs</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pvs-studio/blog/483436/"><p><img src="https://habrastorage.org/getpro/habr/post_images/3ac/9da/a12/3ac9daa12b519fc14e45f7f65abdd204.png" alt="Gambar 1" align="left"></p><br>  Hai, kalian semua pengoleksi serangga eksotis dan polos!  Kami punya spesimen langka di bangku tes PVS-Studio kami hari ini - permainan yang disebut "osu!", Ditulis dalam C #.  Seperti biasa, kami akan mencari bug, menganalisisnya, dan bermain. <br><a name="habracut"></a><br><h2>  Permainan </h2><br>  Osu!  adalah game rhythm open-source.  Menurut <a href="https://osu.ppy.sh/home">situs web</a> gim, ini cukup populer, dengan lebih dari 15 juta akun pemain.  Proyek ini menampilkan permainan gratis, desain penuh warna, kustomisasi peta, sistem peringkat pemain online tingkat lanjut, mode multi-pemain, dan sekumpulan karya musik yang kaya.  Tidak ada gunanya menjabarkan lebih lanjut tentang game;  Anda dapat membaca semua tentang itu di Internet.  Mulai dengan <a href="https://en.wikipedia.org/wiki/Osu!">halaman ini</a> . <br><br>  Saya lebih tertarik pada kode sumber proyek, yang tersedia di <a href="https://github.com/ppy/osu">GitHub</a> .  Satu hal yang segera menarik perhatian Anda adalah banyaknya jumlah tempat penyimpanan (lebih dari 24 ribu), yang merupakan pertanda perkembangan yang intens dan berkelanjutan (permainan ini pertama kali dirilis pada 2007, tetapi pekerjaan itu harus sudah dimulai lebih awal).  Proyek ini tidak besar: hanya 1813 file .cs dengan total 135 ribu LOC tidak kosong.  Jumlah ini juga termasuk tes, yang biasanya tidak saya perhitungkan saat menjalankan cek.  Tes terdiri dari 306 file .cs dengan 25 ribu LOC.  Proyek ini memang kecil: misalnya, inti C # dari PVS-Studio adalah sekitar 300 ribu LOC. <br><br>  Menyisakan file uji, saya memeriksa 1507 file, 110 ribu LOC.  Cek itu mengungkapkan beberapa bug menarik, yang saya ingin tunjukkan kepada Anda. <br><br><h2>  Bug </h2><br>  <a href="https://www.viva64.com/en/w/v3001/">V3001</a> Ada hasil sub-ekspresi yang identik '== HitResult.Perfect' ke kiri dan ke kanan '||'  operator.  DrawableHoldNote.cs 266 <br><br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CheckForResult</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">....</span></span></span><span class="hljs-function">)</span></span> { .... ApplyResult(r =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (holdNote.hasBroken &amp;&amp; (result == HitResult.Perfect || result == HitResult.Perfect)) result = HitResult.Good; .... }); }</code> </pre> <br>  Ini adalah contoh yang bagus dari pemrograman berorientasi copy-paste, yang merupakan istilah lucu yang baru-baru ini digunakan oleh rekan kerja saya Valeriy Komarov dalam artikelnya " <a href="https://www.viva64.com/en/b/0699/">Top 10 Bug yang Ditemukan di Proyek Java pada 2019</a> ". <br><br>  Bagaimanapun, dua pemeriksaan identik dieksekusi berturut-turut.  Salah satunya mungkin dimaksudkan untuk memeriksa beberapa konstanta lain dari penghitungan <i>HitResult</i> : <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> HitResult { None, Miss, Meh, Ok, Good, Great, Perfect, }</code> </pre> <br>  Konstanta mana yang dimaksudkan untuk diperiksa?  Atau mungkin cek kedua tidak seharusnya ada di sana?  Ini adalah pertanyaan yang hanya bisa dijawab oleh penulis.  Bagaimanapun, ini adalah kesalahan yang mengubah logika eksekusi program. <br><br>  <a href="https://www.viva64.com/en/w/v3001/">V3001</a> Ada sub-ekspresi identik 'family! = GetFamilyString (TournamentTypeface.Aquatico)' di sebelah kiri dan di sebelah kanan operator '&amp;&amp;'.  TournamentFont.cs 64 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetWeightString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> family, FontWeight weight</span></span></span><span class="hljs-function">)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (weight == FontWeight.Regular &amp;&amp; family != GetFamilyString(TournamentTypeface.Aquatico) &amp;&amp; family != GetFamilyString(TournamentTypeface.Aquatico)) weightString = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty; .... }</code> </pre> <br>  Copy-paste lagi.  Saya refactored kodenya sehingga kesalahan mudah dilihat sekarang tetapi awalnya telah ditulis dalam satu baris.  Sama seperti pada contoh sebelumnya, saya tidak bisa mengatakan dengan pasti bagaimana tepatnya yang ini harus diperbaiki.  <i>Enumerasi TournamentTypeface</i> hanya berisi satu konstanta: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> TournamentTypeface { Aquatico }</code> </pre> <br>  Mungkin kesalahannya adalah tentang memeriksa variabel <i>keluarga</i> dua kali, tetapi saya mungkin salah. <br><br>  <a href="https://www.viva64.com/en/w/v3009/">V3009</a> [CWE-393] Aneh bahwa metode ini selalu mengembalikan satu dan nilai 'false' yang sama.  KeyCounterAction.cs 19 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnPressed</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T action, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> forwards</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!EqualityComparer&lt;T&gt;.Default.Equals(action, Action)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; IsLit = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (forwards) Increment(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; }</code> </pre> <br>  Metode ini mengembalikan <i>false</i> setiap kali.  Dalam kasus seperti ini, saya biasanya akan memeriksa pemanggilan fungsi, karena Anda mungkin sering menemukan bahwa pemanggil tidak menggunakan nilai balik, yang berarti tidak ada masalah (selain gaya buruk).  Seperti inilah panggilan dalam kasus ini: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnPressed</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T action</span></span></span><span class="hljs-function">)</span></span> =&gt; Target.Children .OfType&lt;KeyCounterAction&lt;T&gt;&gt;() .Any(c =&gt; c.OnPressed(action, Clock.Rate &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>));</code> </pre> <br>  Seperti yang Anda lihat, pemanggil tidak menggunakan nilai yang dikembalikan oleh metode <i>OnPressed</i> .  Karena nilai itu selalu <i>salah</i> , penelepon itu sendiri selalu mengembalikan <i>false</i> juga.  Kode ini sangat mungkin mengandung kesalahan dan harus direvisi. <br><br>  Bug serupa lainnya: <br><br><ul><li>  V3009 [CWE-393] Aneh bahwa metode ini selalu mengembalikan satu dan nilai 'false' yang sama.  KeyCounterAction.cs 30 </li></ul><br>  <a href="https://www.viva64.com/en/w/v3042/">V3042</a> [CWE-476] Kemungkinan NullReferenceException.  '?.'  dan '.'  operator digunakan untuk mengakses anggota objek 'val.NewValue' TournamentTeam.cs 41 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TournamentTeam</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Acronym.ValueChanged += val =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (....) FlagName.Value = val.NewValue.Length &gt;= <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-comment"><span class="hljs-comment">// &lt;= ? val.NewValue?.Substring(0, 2).ToUpper() : string.Empty; }; .... }</span></span></code> </pre> <br>  Variabel <i>val.NewValue</i> ditangani dengan cara yang berbahaya dalam kondisi <i>?:</i> Operator.  Apa yang membuat penganalisa berpikir demikian adalah kenyataan bahwa kemudian di cabang <i>kemudian</i> , variabel yang sama ditangani dengan cara yang aman menggunakan operator akses bersyarat: <i>val.NewValue? .Substring (....)</i> . <br><br>  Bug serupa lainnya: <br><br><ul><li>  V3042 [CWE-476] Kemungkinan NullReferenceException.  '?.'  dan '.'  operator digunakan untuk mengakses anggota objek 'val.NewValue' TournamentTeam.cs 48 </li></ul><br>  <a href="https://www.viva64.com/en/w/v3042/">V3042</a> [CWE-476] Kemungkinan NullReferenceException.  '?.'  dan '.'  operator digunakan untuk mengakses anggota objek 'api' SetupScreen.cs 77 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reload</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ActionableInfo { Label = <span class="hljs-string"><span class="hljs-string">"Current User"</span></span>, ButtonText = <span class="hljs-string"><span class="hljs-string">"Change Login"</span></span>, Action = () =&gt; { api.Logout(); <span class="hljs-comment"><span class="hljs-comment">// &lt;= .... }, Value = api?.LocalUser.Value.Username, .... }, .... } private class ActionableInfo : LabelledDrawable&lt;Drawable&gt; { .... public Action Action; .... }</span></span></code> </pre> <br>  Yang ini lebih ambigu, tapi saya percaya itu bug juga.  Programmer menciptakan objek bertipe <i>ActionableInfo</i> .  Bidang <i>Tindakan</i> diinisialisasi dengan menggunakan fungsi lambda, yang menangani <i>api</i> referensi yang berpotensi nol dengan cara yang berbahaya.  Penganalisa menganggap pola ini sebagai kesalahan karena variabel <i>api</i> ditangani dengan cara yang aman nanti, ketika menginisialisasi parameter <i>Nilai</i> .  Saya menyebut kasus ini ambigu karena kode pada fungsi lambda menyiratkan eksekusi yang tertunda, pada saat itu pengembang mungkin dapat menjamin bahwa referensi <i>api</i> tidak akan nol.  Tapi saya tidak yakin tentang itu karena tubuh fungsi lambda tampaknya tidak menggunakan penanganan referensi yang aman seperti cek sebelumnya. <br><br>  <a href="https://www.viva64.com/en/w/v3066/">V3066</a> [CWE-683] Kemungkinan urutan argumen yang salah diteruskan ke metode 'Atan2': 'diff.X' dan 'diff.Y'.  SliderBall.cs 182 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdateProgress</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> completionProgress</span></span></span><span class="hljs-function">)</span></span> { .... Rotation = <span class="hljs-number"><span class="hljs-number">-90</span></span> + (<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>)(-Math.Atan2(diff.X, diff.Y) * <span class="hljs-number"><span class="hljs-number">180</span></span> / Math.PI); .... }</code> </pre> <br>  Penganalisa menduga bahwa argumen metode <i>Atan2</i> dilewatkan dalam urutan yang salah.  Ini adalah deklarasi metode: <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// Parameters: // y: // The y coordinate of a point. // // x: // The x coordinate of a point. public static double Atan2(double y, double x);</span></span></code> </pre> <br>  Nilai diteruskan dalam urutan terbalik.  Saya tidak yakin apakah ini bug karena metode <i>UpdateProgress</i> mengandung cukup banyak perhitungan nontrivial;  Saya hanya menyebut itu sebagai bug yang mungkin. <br><br>  <a href="https://www.viva64.com/en/w/v3080/">V3080</a> [CWE-476] Kemungkinan null dereference.  Pertimbangkan untuk memeriksa 'Beatmap'.  WorkingBeatmap.cs 57 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> Track </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetVirtualTrack</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lastObject = Beatmap.HitObjects.LastOrDefault(); .... }</code> </pre> <br>  Penganalisa menunjukkan kemungkinan null dereference dari <i>Beatmap</i> : <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IBeatmap Beatmap { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> LoadBeatmapAsync().Result; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (TaskCanceledException) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } } }</code> </pre> <br>  Nah, alat analisa itu benar. <br><br>  Untuk mempelajari lebih lanjut tentang bagaimana PVS-Studio mendeteksi bug seperti ini, dan tentang fitur baru yang ditambahkan dalam C # 8.0 yang ada hubungannya dengan penanganan referensi yang berpotensi nol, lihat artikel " <a href="https://www.viva64.com/en/b/0631/">Jenis referensi yang dapat dihapus dalam C # 8.0 dan analisis statis</a> ". <br><br>  <a href="https://www.viva64.com/en/w/v3083/">V3083</a> [CWE-367] Doa yang tidak aman dari acara 'ObjectConverted', NullReferenceException dimungkinkan.  Pertimbangkan menugaskan acara ke variabel lokal sebelum menjalankannya.  BeatmapConverter.cs 82 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> List&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">convertHitObjects</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">....</span></span></span><span class="hljs-function">)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ObjectConverted != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { converted = converted.ToList(); ObjectConverted.Invoke(obj, converted); } .... }</code> </pre> <br>  Ini adalah kesalahan kecil dan cukup umum.  Pelanggan dapat berhenti berlangganan dari acara antara cek nol dan permintaan acara, yang mengakibatkan crash.  Ini adalah salah satu cara untuk memperbaiki bug: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> List&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">convertHitObjects</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">....</span></span></span><span class="hljs-function">)</span></span> { .... converted = converted.ToList(); ObjectConverted?.Invoke(obj, converted); .... }</code> </pre> <br>  <a href="https://www.viva64.com/en/w/v3095/">V3095</a> [CWE-476] Objek 'kolom' digunakan sebelum diverifikasi terhadap nol.  Periksa baris: 141, 142. SquareGraph.cs 141 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">redrawProgress</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; ColumnCount; i++) columns[i].State = i &lt;= progress ? ColumnState.Lit : ColumnState.Dimmed; columns?.ForceRedraw(); }</code> </pre> <br>  Iterasi atas koleksi <i>kolom</i> dilakukan dengan cara yang berbahaya.  Pengembang mengasumsikan bahwa referensi <i>kolom</i> bisa nol, yang ditunjukkan dengan penggunaan operator akses bersyarat untuk mengakses koleksi lebih lanjut dalam kode. <br><br>  <a href="https://www.viva64.com/en/w/v3119/">V3119</a> Memanggil acara yang diganti 'OnNewResult' dapat menyebabkan perilaku yang tidak dapat diprediksi.  Pertimbangkan untuk menerapkan pengakses acara secara eksplisit atau gunakan kata kunci 'tersegel'.  DrawableRuleset.cs 256 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addHitObject</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">TObject hitObject</span></span></span><span class="hljs-function">)</span></span> { .... drawableObject.OnNewResult += (_, r) =&gt; OnNewResult?.Invoke(r); .... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">event</span></span> Action&lt;JudgementResult&gt; OnNewResult;</code> </pre> <br>  Penganalisa mengatakan berbahaya untuk menggunakan acara yang ditimpa atau virtual.  Lihat <a href="https://www.viva64.com/en/w/v3119/">deskripsi</a> diagnostik untuk penjelasan.  Saya juga menulis artikel tentang topik ini: " <a href="https://www.viva64.com/en/b/0453/">Peristiwa virtual di C #: ada yang salah</a> ". <br><br>  Berikut ini konstruksi serupa lainnya yang tidak aman: <br><br><ul><li>  V3119 Memanggil acara yang diganti dapat menyebabkan perilaku yang tidak terduga.  Pertimbangkan untuk menerapkan pengakses acara secara eksplisit atau gunakan kata kunci 'tersegel'.  DrawableRuleset.cs 257 </li></ul><br>  <a href="https://www.viva64.com/en/w/v3123/">V3123</a> [CWE-783] Mungkin '??'  Operator bekerja dengan cara yang berbeda dari yang diharapkan.  Prioritasnya lebih rendah daripada prioritas operator lain di bagian kirinya.  OsuScreenStack.cs 45 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onScreenChange</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IScreen prev, IScreen next</span></span></span><span class="hljs-function">)</span></span> { parallaxContainer.ParallaxAmount = ParallaxContainer.DEFAULT_PARALLAX_AMOUNT * ((IOsuScreen)next)?.BackgroundParallaxAmount ?? <span class="hljs-number"><span class="hljs-number">1.0f</span></span>; }</code> </pre> <br>  Untuk pemahaman yang lebih baik, berikut adalah contoh sintetis yang menunjukkan logika asli kode ini: <br><br><pre> <code class="cs hljs">x = (c * a) ?? b;</code> </pre> <br>  Bug berasal dari fakta bahwa prioritas operator "*" lebih tinggi daripada "??"  operator.  Ini adalah kode tetap yang seharusnya (dengan tanda kurung ditambahkan): <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onScreenChange</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IScreen prev, IScreen next</span></span></span><span class="hljs-function">)</span></span> { parallaxContainer.ParallaxAmount = ParallaxContainer.DEFAULT_PARALLAX_AMOUNT * (((IOsuScreen)next)?.BackgroundParallaxAmount ?? <span class="hljs-number"><span class="hljs-number">1.0f</span></span>); }</code> </pre> <br>  Bug serupa lainnya: <br><br>  <a href="https://www.viva64.com/en/w/v3123/">V3123</a> [CWE-783] Mungkin '??'  Operator bekerja dengan cara yang berbeda dari yang diharapkan.  Prioritasnya lebih rendah daripada prioritas operator lain di bagian kirinya.  FramedReplayInputHandler.cs 103 <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> inImportantSection { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> IsImportant(frame) &amp;&amp; Math.Abs(CurrentTime - NextFrame?.Time ?? <span class="hljs-number"><span class="hljs-number">0</span></span>) &lt;= AllowedImportantTimeSpan; } }</code> </pre> <br>  Seperti dalam kasus sebelumnya, programmer memiliki asumsi yang salah tentang prioritas operator.  Ekspresi asli yang diteruskan ke metode <i>Math.Abs</i> mengevaluasi sebagai berikut: <br><br><pre> <code class="cs hljs">(a ‚Äì b) ?? <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br>  Inilah cara memperbaikinya: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> inImportantSection { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> IsImportant(frame) &amp;&amp; Math.Abs(CurrentTime ‚Äì (NextFrame?.Time ?? <span class="hljs-number"><span class="hljs-number">0</span></span>)) &lt;= AllowedImportantTimeSpan; } }</code> </pre> <br>  <a href="https://www.viva64.com/en/w/v3142/">V3142</a> [CWE-561] Kode tidak terjangkau terdeteksi.  Mungkin saja ada kesalahan.  DrawableHoldNote.cs 214 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnPressed</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ManiaAction action</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.OnPressed(action)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Result.Type == HitResult.Miss) <span class="hljs-comment"><span class="hljs-comment">// &lt;= holdNote.hasBroken = true; .... }</span></span></code> </pre> <br>  Penganalisa percaya kode penangan <i>OnPressed</i> tidak dapat dijangkau dimulai dengan pernyataan <i>if</i> kedua.  Ini mengikuti dari fakta bahwa kondisi pertama selalu benar, yaitu bahwa metode <i>base.OnPressed</i> akan selalu mengembalikan <i>false</i> .  Mari kita lihat <i>basisnya.</i> Metode yang <i>ditekan</i> : <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnPressed</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ManiaAction action</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (action != Action.Value) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UpdateResult(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); }</code> </pre> <br>  Dan sekarang di metode <i>UpdateResult</i> : <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdateResult</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> userTriggered</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Time.Elapsed &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Judged) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; .... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Judged; }</code> </pre> <br>  Perhatikan bahwa implementasi properti yang <i>dinilai</i> tidak masalah di sini karena logika metode <i>UpdateResult</i> menyiratkan bahwa pernyataan <i>pengembalian</i> terakhir setara dengan yang berikut ini: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>;</code> </pre> <br>  Ini berarti metode <i>UpdateResult</i> akan mengembalikan <i>false</i> setiap saat, sehingga mengarah ke masalah kode yang tidak dapat dijangkau sebelumnya di stack. <br><br>  <a href="https://www.viva64.com/en/w/v3146/">V3146</a> [CWE-476] Kemungkinan null dereference dari 'ruleset'.  'FirstOrDefault' dapat mengembalikan nilai nol default.  APILegacyScoreInfo.cs 24 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ScoreInfo </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateScoreInfo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">RulesetStore rulesets</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ruleset = rulesets.GetRuleset(OnlineRulesetID); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mods = Mods != <span class="hljs-literal"><span class="hljs-literal">null</span></span> ? ruleset.CreateInstance() <span class="hljs-comment"><span class="hljs-comment">// &lt;= .GetAllMods().Where(....) .ToArray() : Array.Empty&lt;Mod&gt;(); .... }</span></span></code> </pre> <br>  Penganalisa percaya panggilan <i>ruleset.CreateInstance ()</i> menjadi tidak aman.  Sebelum panggilan ini, variabel <i>ruleset</i> diberi nilai sebagai hasil memanggil metode <i>GetRuleset</i> : <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> RulesetInfo </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetRuleset</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id</span></span></span><span class="hljs-function">)</span></span> =&gt; AvailableRulesets.FirstOrDefault(....);</code> </pre> <br>  Seperti yang Anda lihat, peringatan itu valid karena urutan panggilan menyertakan metode <i>FirstOrDefault</i> , yang dapat mengembalikan <i>nol</i> . <br><br><h2>  Kesimpulan </h2><br>  Tidak ada banyak bug dalam kode "osu!", Dan itu bagus.  Tetapi saya masih merekomendasikan agar penulis memeriksa masalah yang dilaporkan oleh penganalisa.  Saya harap ini akan membantu mempertahankan kualitas tinggi dan permainan akan terus membawa sukacita bagi para pemain. <br><br>  Sebagai pengingat, PVS-Studio adalah pilihan yang baik jika Anda suka mengutak-atik kode sumber.  Alat analisis tersedia untuk <a href="https://www.viva64.com/en/pvs-studio-download/">diunduh</a> di situs web resmi.  Hal lain yang saya ingin Anda ingat adalah bahwa pemeriksaan satu kali seperti ini tidak ada hubungannya dengan penggunaan normal analisis statis dalam proses pengembangan nyata.  Ini paling efektif hanya jika digunakan secara teratur baik pada server build maupun pada komputer pengembang (ini disebut analisis tambahan).  Tujuan utama Anda adalah mencegah bug masuk ke sistem kontrol versi dengan menangkapnya pada tahap pengkodean. <br><br>  Semoga berhasil, dan tetap kreatif! <br><br><h2>  Referensi </h2><br>  Ini adalah artikel pertama kami di tahun 2020. Sementara kami membahasnya, berikut adalah tautan ke cek proyek C # yang dilakukan selama setahun terakhir: <br><br><ul><li>  <a href="https://www.viva64.com/en/b/0605/">Mencari kesalahan dalam kode sumber SDK Layanan Web Amazon untuk .NET</a> </li><li>  <a href="https://www.viva64.com/en/b/0622/">Memeriksa Kode Sumber Roslyn</a> </li><li>  <a href="https://www.viva64.com/en/b/0631/">Jenis referensi yang dapat dihapus dalam C # 8.0 dan analisis statis</a> </li><li>  <a href="https://www.viva64.com/en/b/0653/">WinForms: Kesalahan, Holmes</a> </li><li>  <a href="https://www.viva64.com/en/b/0654/">Kisah bagaimana PVS-Studio menemukan kesalahan di perpustakaan yang digunakan di ... PVS-Studio</a> </li><li>  <a href="https://www.viva64.com/en/b/0656/">Memeriksa .NET Core Libraries Source Code oleh PVS-Studio Static Analyzer</a> </li><li>  <a href="https://www.viva64.com/en/b/0664/">Periksa analis roslyn</a> </li><li>  <a href="https://www.viva64.com/en/b/0677/">Memeriksa Telerik UI untuk UWP sebagai Cara Memulai dengan PVS-Studio</a> </li><li>  <a href="https://www.viva64.com/en/b/0678/">Azure PowerShell: Kebanyakan Tidak Berbahaya</a> </li><li>  <a href="https://www.viva64.com/en/b/0681/">Memindai kode Orchard CMS for Bugs</a> </li><li>  <a href="https://www.viva64.com/en/b/0683/">Memeriksa OpenCvSharp Wrapper untuk OpenCV dengan PVS-Studio</a> </li><li>  <a href="https://www.viva64.com/en/b/0692/">Azure SDK untuk .NET: Kisah tentang Pencarian Kesalahan yang Sulit</a> </li><li>  <a href="https://www.viva64.com/en/b/0694/">SARIF SDK dan Kesalahannya</a> </li><li>  <a href="https://www.viva64.com/en/b/0698/">10 Bug Top Ditemukan di Proyek C # pada tahun 2019</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id483436/">https://habr.com/ru/post/id483436/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id483416/index.html">Mencoba mengotomatiskan proses menggunakan Powershell</a></li>
<li><a href="../id483418/index.html">Sistem tiket: bagaimana Anda mendapatkan tiga OTRS gratis dibayar?</a></li>
<li><a href="../id483424/index.html">DBA: mentransfer nilai SEQUENCE antara database PostgreSQL</a></li>
<li><a href="../id483426/index.html">Survei Tab Jumat</a></li>
<li><a href="../id483428/index.html">Apa yang akan menjadi manajemen dokumen elektronik setelah berlakunya amandemen undang-undang tentang tanda tangan elektronik?</a></li>
<li><a href="../id483438/index.html">Mainkan "osu!", Jangan lupa tentang kesalahan</a></li>
<li><a href="../id483440/index.html">Kompiler D Terbaru</a></li>
<li><a href="../id483444/index.html">Laporan DORA 2019: Cara Meningkatkan Kinerja DevOps</a></li>
<li><a href="../id483446/index.html">Para ilmuwan telah menemukan cara baru untuk menurunkan kadar zat besi dalam air minum</a></li>
<li><a href="../id483448/index.html">Disney - Dua Arah Terhebat dalam Sejarah Manusia</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>