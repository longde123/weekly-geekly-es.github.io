<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üç£ üëÇüèæ üå¶Ô∏è Sistema de monitoreo para servidores de Windows en SQL puro, y c√≥mo lo hab√≠a arrastrado en secreto a la Producci√≥n üè≠ ü§üüèº üè•</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hace mucho tiempo, en una galaxia muy, muy lejana, hab√≠a una compa√±√≠a que creci√≥ de una startup a algo mucho m√°s grande, pero durante un tiempo el dep...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Sistema de monitoreo para servidores de Windows en SQL puro, y c√≥mo lo hab√≠a arrastrado en secreto a la Producci√≥n</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/437864/"> Hace mucho tiempo, en una galaxia muy, muy lejana, hab√≠a una compa√±√≠a que creci√≥ de una startup a algo mucho m√°s grande, pero durante un tiempo el departamento de TI a√∫n era compacto y muy eficiente.  Esa empresa aloj√≥ <i>en prem</i> cientos de servidores virtuales de Windows y, por supuesto, estos servidores fueron monitoreados.  Incluso antes de unirme a la compa√±√≠a, NetIQ hab√≠a sido elegida como una soluci√≥n de monitoreo. <br><br>  Una de mis nuevas tareas fue apoyar NetIQ.  La persona, que trabaj√≥ con NetIQ antes, dijo mucho sobre su experiencia con NetIQ, desafortunadamente, si trato de ponerlo aqu√≠, ser√≠a solo una larga l√≠nea de caracteres '****'.  Pronto me di cuenta por qu√©.  Steve Jobs probablemente est√© girando en su tumba mirando la interfaz as√≠: <br><br><img src="https://habrastorage.org/webt/wv/cq/kj/wvcqkjtunh0raiwt14rvhpbn-pw.png" alt="imagen"><br><a name="habracut"></a><br>  En la l√≠nea uno, la l√≥gica de la casilla de verificaci√≥n es positiva ( <i>evento de aumento</i> ), en la siguiente es negativa ( <i>no evento de aumento</i> ).  Entonces, ¬øc√≥mo funciona ' <i>Raise event only i</i> f'?  No tengo idea <br><br>  Sin embargo, hab√≠a algo mucho peor sobre NetIQ: su agente de monitoreo era muy fr√°gil.  Mucho m√°s vulnerable que el propio Windows.  Poca memoria?  El agente est√° ca√≠do.  CPU es 100%?  El agente no responde.  ¬øQuedan 0 bytes libres en una unidad de disco?  Bueno, para enviar un mensaje de alerta, un agente primero debe guardarlo en un archivo en un disco ... Entonces s√≠, no recibe ninguna alerta en ese caso. <br><br>  Sin embargo, "no arregles lo que no est√° roto", y de alguna manera, vivimos con √©l hasta que nuestra empresa fue comprada por una mucho m√°s grande.  Cuando una gran empresa compra una peque√±a, la peque√±a se disipa como una gota de agua en el mar.  Sin embargo, en nuestro caso nosotros (desde la perspectiva de TI) no √©ramos mucho m√°s peque√±os que la TI de una compa√±√≠a m√°s grande, y desde el principio era obvio que la fusi√≥n ser√≠a muy complicada.  Tan complicado que por un tiempo nos quedamos solos como un departamento independiente y todos los procesos comerciales y de TI se mantuvieron igual, justo bajo el paraguas del nuevo nombre.  Me recuerda el momento, cuando <b>EL ANILLO</b> estaba sobre la lava pero a√∫n no ha comenzado a derretirse. <br><br><img src="https://habrastorage.org/webt/qf/--/cy/qf--cyd5ehkjz_5zjhmogmwekcw.jpeg" alt="imagen"><br><br>  Mientras tanto, hab√≠a actualizado NetIQ de la versi√≥n 7 a la 8, y luego a la versi√≥n 9. Fue entonces cuando comenzaron todos nuestros problemas.  Est√°bamos usando NetIQ para monitorear solo algunas cosas b√°sicas: disponibilidad de un servidor, memoria, CPU, espacio en disco y lo m√°s importante para nosotros: el estado de los servicios locales.  Cuando cualquier tipo de inicio de servicio interno se estableci√≥ en "Autom√°tico", entonces deber√≠a estar siempre ejecut√°ndose (de lo contrario, consideramos que se bloque√≥).  No deber√≠a haber casos como este: <br><br><img src="https://habrastorage.org/webt/45/fz/1h/45fz1ho3t3mxx6ka8yjlhg-_yjs.jpeg" alt="imagen"><br><br>  Entonces, NetIQ dej√≥ de monitorear el estado de los servicios.  Despu√©s de una semana de experimentaci√≥n y otra semana de llamadas con soporte de NetIQ, hab√≠amos aprendido que " <i>no era un error, era una caracter√≠stica</i> " y la alerta se activaba solo cuando un proceso sal√≠a con un c√≥digo de salida espec√≠fico.  Y nuestros servicios fallaron con CUALQUIER c√≥digo. <br><br>  En ese momento ya era demasiado tarde para retroceder.  Como comprender√°, tan pronto como descubrimos que nuestra infraestructura cr√≠tica no era monitoreada, inmediatamente ... eh ... no hicimos nada.  Porque en ese momento el proceso de "fusi√≥n" de nuestra compa√±√≠a en una m√°s grande alcanz√≥ una fase activa, y se ve√≠a as√≠: <br><br><img src="https://habrastorage.org/webt/cq/y3/zk/cqy3zk1iyhts4aijbhx0umtxab8.jpeg" alt="imagen"><br><br>  Escuch√© sonidos de truenos desde muy arriba, y parec√≠a que los dioses en el Olimpo estaban decidiendo el destino del mundo, mientras trataba de distraerlos con mi peque√±o problema t√©cnico.  Al mismo tiempo, no pod√≠a dormir sabiendo que nuestro sistema de monitoreo era medio ciego. <br><br>  Despu√©s de darme cuenta de que no hab√≠a nada que esperar, decid√≠ crear una soluci√≥n r√°pida y sucia: un peque√±o esc√°ner de servicio que deber√≠a revisar todos los servidores para verificar los servicios y enviar correos electr√≥nicos para los servicios que estaban inactivos, exactamente como la versi√≥n anterior de NetIQ lo hizo.  Puede pensar que el script de PowerShell es la mejor manera de hacerlo, pero ... Si todo lo que tiene es un martillo, todo parece un clavo.  Si usted es un DBA que trabaj√≥ con SQL desde la versi√≥n 6.0, entonces ... Aqu√≠ hay un breve extracto del c√≥digo, para que pueda entender de lo que estoy hablando: <br><br><img src="https://habrastorage.org/webt/zt/bb/3h/ztbb3hzjroe6t_bzlsj1atrulbi.png" alt="imagen"><br><br>  Me tom√≥ solo unas pocas horas escribir la primera soluci√≥n.  Durante los pr√≥ximos d√≠as agregu√© una auditor√≠a, par√°metros y otras cosas elegantes.  Despu√©s de examinar lo que pod√≠a hacer el comando WMIC, no pude detenerme.  No recuerdo exactamente lo que sucedi√≥ durante las pr√≥ximas 2 semanas: todo estaba un poco borroso, pero cuando me despert√©, todas las caracter√≠sticas de NetIQ se implementaron utilizando SQL puro. <br><br>  No solo he copiado la funcionalidad de NetIQ "tal cual", he implementado todo lo que siempre so√±√©.  En la alerta por correo electr√≥nico de LOWDISK tambi√©n obtienes un PDF adjunto con una tabla de crecimiento del uso del disco para que puedas entender instant√°neamente si el crecimiento fue genuino o si algo sali√≥ mal.  Poca memoria: y obtiene no solo el gr√°fico, sino tambi√©n una distribuci√≥n de memoria por proceso, adem√°s de w3wp.exe obtiene un nombre de grupo agregado.  Tambi√©n hab√≠a implementado recordatorios inteligentes con protecci√≥n contra inundaciones y muchas otras cosas elegantes.  Por cierto, la lista de servidores virtuales se extrajo autom√°ticamente de los repositorios de VMware.  Simplemente mirando los temas de alerta en un cliente m√≥vil, puede decir instant√°neamente lo que estaba sucediendo, incluso sin abrir los correos electr√≥nicos: <br><br><img src="https://habrastorage.org/webt/ps/cq/fk/pscqfkh5qb23_oujl6zyjmeexzy.png" alt="imagen"><br><br>  Los desarrolladores modernos se acostumbraron a crear niveles de abstracci√≥n hasta el punto de perjudicar su capacidad de escribir un c√≥digo simple y directo.  No pueden crear un sistema de monitoreo sin decir: "Ok, entonces para cualquier servidor podemos ejecutar cualquier conjunto de scripts con reglas desde un repositorio ... Qu√© flexible ...".  Pero el monitoreo de algunas cosas fundamentales como la memoria, la CPU, el disco y el estado de los servicios es √∫nico.  Al implementar la verificaci√≥n de estas condiciones b√°sicas con un nivel de abstracci√≥n, terminan con un c√≥digo que funciona igualmente mal para todos los casos.  Este es un ejemplo del sistema SCOM.  Estoy seguro de que fue implementado exactamente por las especificaciones: <br><br><img src="https://habrastorage.org/webt/wm/3m/ut/wm3mutentcltlmpobwyjutqm0me.png" alt="imagen"><br><br>  Pero la principal ventaja del nuevo sistema era que no hab√≠a ning√∫n agente en absoluto.  Sin agentes: nada que instalar, nada que romper.  El sistema era simple y confiable como un hummer. <br><br>  Pocos el mes que viene vine a trabajar y pas√© una o dos horas trabajando en mi nueva creaci√≥n, lentamente, sin plazos ni ETA, sin dejar casi ninguna deuda t√©cnica.  Despu√©s de un rato me obligu√© a parar. <br><br>  NetIQ todav√≠a estaba en producci√≥n, pero la gente definitivamente prefer√≠a las alertas del nuevo sistema, m√°s confiables e informativas.  Gradualmente, mov√≠ todos los "suscriptores" de alerta al nuevo sistema, manteniendo, sin embargo, el antiguo sistema con vida.  Mientras tanto, el proceso de "fusi√≥n" de nuestra antigua compa√±√≠a en una m√°s grande hab√≠a alcanzado su etapa final: <br><br><img src="https://habrastorage.org/webt/8j/sy/da/8jsydazfbheft25w9ugymimk_hi.jpeg" alt="imagen"><br><br>  Bueno, todo tiene un final.  Incluso me sorprendi√≥ tener la oportunidad de jugar con esas cosas en una gran empresa burocr√°tica.  Despu√©s de un mes de preparaci√≥n, me dijeron que "est√° <i>bien, en una semana cerramos NetIQ y pasamos a SCOM como est√°ndar corporativo</i> ".  Cerr√© NetIQ (tengo que admitirlo, lo odi√© tanto que fue uno de los momentos m√°s felices de mi carrera) y comenc√© a esperar a que llegara SCOM.  Pero no hab√≠a ninguno.  Nada desde una semana, un mes e incluso una cuarta parte. <br><br>  Recibimos SCOM solo despu√©s de 6 meses completos: alguien se hab√≠a olvidado del costo de las licencias para la gran cantidad de servidores que ten√≠amos.  En estos 6 meses, muchos departamentos se volvieron tan dependientes del nuevo sistema, que mantuvo no solo las alertas, sino tambi√©n las m√©tricas de rendimiento y los inventarios, por lo que era imposible cerrarlo.  Se convirti√≥ en un segundo sistema de respaldo.  Para los auditores est√° SCOM, para las cosas realmente √∫tiles, est√° mi creaci√≥n. <br><br>  De vez en cuando, los gerentes en diferentes niveles de jerarqu√≠a pasaban por alto las alertas de ese sistema y preguntaban: ¬øqu√© es?  Recientemente hab√≠a explicado toda la historia detr√°s de este producto.  Se rieron y dejaron que ese sistema viviera, y para m√≠ fue una oportunidad de escribir un c√≥digo como cuando era un estudiante, guiado no por especificaciones sino por mi propia comprensi√≥n, como un hobby.  Fue muy divertido. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Art√≠culo en ruso</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/437864/">https://habr.com/ru/post/437864/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../437846/index.html">bobaoskit - accesorios, dnssd y WebSocket</a></li>
<li><a href="../437848/index.html">Hacemos que el proceso de desarrollo de software pesado para microcontroladores sea m√°s conveniente (no)</a></li>
<li><a href="../437850/index.html">¬øQui√©n es m√°s efectivo en el dise√±o de PCB?</a></li>
<li><a href="../437852/index.html">Historia de Shipastik</a></li>
<li><a href="../437858/index.html">Conferencias adicionales del curso "Dise√±o de sistemas altamente cargados" (oto√±o de 2018) en Technopolis</a></li>
<li><a href="../437868/index.html">Semana de la seguridad 05: impresoras, c√°maras, 7zip y √©tica</a></li>
<li><a href="../437870/index.html">C√≥mo Resident Evil 2 se vino abajo, pero fue capaz de convertirse en el mayor √©xito de Capcom</a></li>
<li><a href="../437872/index.html">Zapatero sin botas. C√≥mo los estudiantes escribieron correos electr√≥nicos de phishing</a></li>
<li><a href="../437876/index.html">"Nubes": cu√°l es la ventaja sobre el servidor corporativo</a></li>
<li><a href="../437878/index.html">Tendencias de ciberseguridad de BI.ZONE</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>