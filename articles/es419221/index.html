<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôã üçû üïì Uso de elementos dependientes en Zabbix 4.0 usando HPE MSA 2040/2050 como ejemplo üë®üèª ü§ì üìª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduccion 
 Todos los que usan el sistema de monitoreo Zabbix y monitorean su desarrollo saben que con el lanzamiento de Zabbix 3.4 tenemos una gra...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Uso de elementos dependientes en Zabbix 4.0 usando HPE MSA 2040/2050 como ejemplo</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/419221/"><h2>  Introduccion </h2><br>  Todos los que usan el sistema de monitoreo Zabbix y monitorean su desarrollo saben que con el lanzamiento de Zabbix 3.4 tenemos una gran caracter√≠stica: Elementos dependientes (elementos de datos dependientes), sobre los cuales ya hab√≠a una publicaci√≥n de blog <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">correspondiente</a> en Zabbix.  Sin embargo, en la forma en que se introdujo en 3.4, usarlo "al m√°ximo" era problem√°tico debido al hecho de que las macros LLD no eran compatibles para su uso en las reglas de preprocesamiento ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ZBXNEXT-4109</a> ), as√≠ como como un "padre" Solo se pudo seleccionar uno del elemento de datos creado por la propia regla LLD ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ZBXNEXT-4200</a> ).  En resumen, tuve que hacer todo exactamente como se describe en el enlace anterior: trabajar con sus manos, lo que, con una gran cantidad de m√©tricas, caus√≥ muchos inconvenientes.  Sin embargo, con el lanzamiento de Zabbix 4.0alpha9, todo ha cambiado. <br><a name="habracut"></a><br><h2>  Un poco de historia </h2><br>  Para m√≠, la funcionalidad descrita fue importante debido al hecho de que nuestra empresa utiliza varios sistemas de almacenamiento de HP, a saber, HP MSA 2040/2050, cuyas m√©tricas se eliminan mediante solicitudes a su API XML utilizando un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">script Python</a> . <br><br><img src="https://habrastorage.org/webt/fg/kr/pr/fgkrprt4os5uskdtfey9z3mgvw8.png"><br><br>  Al principio, cuando la tarea era monitorear el equipo designado y se encontr√≥ una opci√≥n usando la API, result√≥ que en el caso m√°s simple, para averiguar, por ejemplo, el estado de salud de un componente del sistema de almacenamiento, era necesario hacer dos consultas: <br><br><ul><li>  Solicitar token de autenticaci√≥n (clave de sesi√≥n); </li><li>  La solicitud en s√≠, devolviendo informaci√≥n sobre el componente. </li></ul><br>  Ahora imagine que el almacenamiento consta de 24 discos (o tal vez m√°s), dos fuentes de alimentaci√≥n, un par de controladores, ventiladores, varias agrupaciones de discos, etc. - multiplicamos todo esto por 2 y obtenemos m√°s de 50 elementos de datos, lo que equivale a la misma cantidad de solicitudes para API en las comprobaciones de cada minuto.  Si intenta ir por este camino, la API "se establece" r√°pidamente y, despu√©s de todo, solo estamos hablando de solicitar el "estado" de los componentes, sin tener en cuenta las otras m√©tricas posibles e interesantes: temperatura, horas de funcionamiento de los discos duros, velocidad del ventilador, etc. <br><br>  La primera decisi√≥n que tom√© para descargar la API, incluso antes del lanzamiento de la versi√≥n 3.4 de Zabbix, fue crear un cach√© para el token recibido, cuyo valor se escribi√≥ en el archivo y se almacen√≥ durante N minutos.  Esto permiti√≥ reducir el n√∫mero de llamadas a la API exactamente dos veces, sin embargo, la situaci√≥n no cambi√≥ mucho: fue dif√≠cil obtener algo m√°s que el estado de salud.  Alrededor de este tiempo, visit√© Zabbix Moscow Meetup 2017, organizado por Badoo, donde aprend√≠ sobre la funcionalidad de los elementos de datos dependientes mencionados anteriormente. <br><br>  La secuencia de comandos se modific√≥ para poder proporcionar objetos JSON detallados que contienen informaci√≥n de inter√©s para nosotros sobre varios componentes del repositorio y su salida comenz√≥ a parecerse a esto en lugar de una sola cadena o valores num√©ricos: <br><br><pre><code class="hljs objectivec">{<span class="hljs-string"><span class="hljs-string">"1.1"</span></span>:{<span class="hljs-string"><span class="hljs-string">"health"</span></span>:<span class="hljs-string"><span class="hljs-string">"OK"</span></span>,<span class="hljs-string"><span class="hljs-string">"health-num"</span></span>:<span class="hljs-string"><span class="hljs-string">"0"</span></span>,<span class="hljs-string"><span class="hljs-string">"error"</span></span>:<span class="hljs-string"><span class="hljs-string">"0"</span></span>,<span class="hljs-string"><span class="hljs-string">"temperature"</span></span>:<span class="hljs-string"><span class="hljs-string">"24"</span></span>,<span class="hljs-string"><span class="hljs-string">"power-on-hours"</span></span>:<span class="hljs-string"><span class="hljs-string">"27267"</span></span>},<span class="hljs-string"><span class="hljs-string">"1.2"</span></span>:{<span class="hljs-string"><span class="hljs-string">"health"</span></span>:<span class="hljs-string"><span class="hljs-string">"OK"</span></span>,<span class="hljs-string"><span class="hljs-string">"health-num"</span></span>:<span class="hljs-string"><span class="hljs-string">"0"</span></span>,<span class="hljs-string"><span class="hljs-string">"error"</span></span>:<span class="hljs-string"><span class="hljs-string">"0"</span></span>,<span class="hljs-string"><span class="hljs-string">"temperature"</span></span>:<span class="hljs-string"><span class="hljs-string">"23"</span></span>,<span class="hljs-string"><span class="hljs-string">"power-on-hours"</span></span>:<span class="hljs-string"><span class="hljs-string">"27266"</span></span>},<span class="hljs-string"><span class="hljs-string">"1.3"</span></span>:{<span class="hljs-string"><span class="hljs-string">"health"</span></span>:<span class="hljs-string"><span class="hljs-string">"OK"</span></span>,<span class="hljs-string"><span class="hljs-string">"health-num"</span></span>:<span class="hljs-string"><span class="hljs-string">"0"</span></span>,<span class="hljs-string"><span class="hljs-string">"error"</span></span>:<span class="hljs-string"><span class="hljs-string">"0"</span></span>,<span class="hljs-string"><span class="hljs-string">"temperature"</span></span>:<span class="hljs-string"><span class="hljs-string">"24"</span></span>,<span class="hljs-string"><span class="hljs-string">"power-on-hours"</span></span>:<span class="hljs-string"><span class="hljs-string">"27336"</span></span>}, ... }</code> </pre> <br>  Este es un ejemplo con los datos dados en todos los discos de almacenamiento.  Para otros componentes, la imagen es similar: la clave es la ID del componente y el valor es un objeto JSON que contiene las m√©tricas necesarias. <br><br>  Todo estaba bien, pero los matices descritos al principio del art√≠culo surgieron r√°pidamente: todas las m√©tricas dependientes tuvieron que crearse y actualizarse manualmente, lo que fue bastante doloroso (alrededor de 300 m√©tricas por sistema de almacenamiento m√°s desencadenantes y gr√°ficos).  LLD podr√≠a salvarnos, pero aqu√≠, al crear el prototipo, no nos permiti√≥ especificar el que no fue creado por la regla como elemento principal, y elimin√≥ el truco sucio al crear un elemento ficticio a trav√©s de LLD y reemplazar su itemid en la base de datos con el deseado Servidor Zabbix.  Las solicitudes de funciones mencionadas aparecieron r√°pidamente en el rastreador de errores Zabbix, lo que indicaba que esta funcionalidad era importante no solo para m√≠. <br><br>  Porque  se completaron todas las operaciones preparatorias de mi parte, decid√≠ tolerar y no producir soluciones temporales, como la generaci√≥n din√°mica de plantillas, y solo esper√© el cierre de los ZBXNEXT indicados al comienzo del art√≠culo y recientemente se hizo. <br><br><h2>  Como se ve ahora </h2><br>  Para demostrar las nuevas caracter√≠sticas de Zabbix tomamos: <br><br><ul><li>  Almacenamiento HPE MSA 2040 disponible a trav√©s de HTTP / HTTPS; </li><li>  Servidor Zabbix 4.0alpha9 instalado desde el repositorio oficial en CentOS 7.5.1804; </li><li>  Un script escrito en Python de la tercera versi√≥n y que nos brinda la capacidad de detectar componentes de almacenamiento (LLD) y devolver datos en formato JSON para analizar en el lado del servidor Zabbix usando la ruta JSON. </li></ul><br>  El elemento de datos principal ser√° una "verificaci√≥n externa" que llama al script con los argumentos necesarios y almacena los datos recibidos como texto. <br><br><h3>  Preparaci√≥n </h3><br>  El script Python se instala de acuerdo con la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">documentaci√≥n</a> y tiene una biblioteca de "solicitudes" en las dependencias de Python.  Si tiene una distribuci√≥n basada en RHEL, puede instalarla usando el administrador de paquetes yum: <br><br><pre> <code class="bash hljs">[root@zabbix]<span class="hljs-comment"><span class="hljs-comment"># yum install python3-requests</span></span></code> </pre><br>  O usando pip: <br><br><pre> <code class="bash hljs">[root@zabbix]<span class="hljs-comment"><span class="hljs-comment"># pip install requests</span></span></code> </pre><br>  Puede probar el script desde el shell solicitando, por ejemplo, datos LLD sobre discos: <br><br><pre> <code class="bash hljs">[root@zabbix]<span class="hljs-comment"><span class="hljs-comment"># ./zbx-hpmsa.py -m MSA_DNS_NAME_OR_IP -d -c disks {"data":[{"{#DISK.ID}":"1.1","{#DISK.SN}":"KFGY7LVF"},{"{#DISK.ID}":"1.2","{#DISK.SN}":"Z0K02QVG0000C4297CH3"},{"{#DISK.ID}":"1.3","{#DISK.SN}":"KLK7XG0F"}, ... }</span></span></code> </pre><br><h3>  Configuraci√≥n del host </h3><br>  Primero debe crear elementos de datos primarios que contendr√°n todas las m√©tricas que necesitamos.  Como ejemplo, cree un elemento para discos f√≠sicos: <br><br><img src="https://habrastorage.org/webt/l5/u4/t_/l5u4t_ruwd7ae4qjx5bkqvfyqgq.png"><br><br>  <b>Nombre</b> : especifique arbitrariamente; <br>  <b>Tipo</b> : verificaci√≥n externa; <br>  <b>La clave</b> es llamar al script con los par√°metros necesarios (consulte la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">documentaci√≥n</a> del <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">script</a> en GitHub); <br>  <b>Tipo de informaci√≥n</b> - texto; <br>  <b>Intervalo de actualizaci√≥n</b> : el ejemplo utiliza una macro personalizada {$ UPDATE} que se expande al valor "1m"; <br>  <b>El per√≠odo de almacenamiento del historial</b> es de un d√≠a.  Creo que almacenar el elemento de datos padre ya no tiene sentido. <br>  Verifique los √∫ltimos datos para el elemento creado: <br><br><img src="https://habrastorage.org/webt/gg/xu/yr/ggxuyr1cjvzptb332728c8kcdb4.png"><br><br>  JSON viene, entonces todo se hace correctamente. <br><br>  Lo siguiente ser√° establecer reglas de descubrimiento que encontrar√°n todos los componentes disponibles para monitorear y crear elementos dependientes y disparadores.  Continuando con el ejemplo con discos f√≠sicos, se ver√° as√≠: <br><br><img src="https://habrastorage.org/webt/th/sa/4-/thsa4-0teuslv_6ngcijvhwekfc.png"><br><br>  Despu√©s de crear la regla LLD, deber√° crear prototipos de elementos de datos.  Creemos un prototipo de este tipo, utilizando datos de temperatura como ejemplo: <br><br><img src="https://habrastorage.org/webt/fy/m_/jn/fym_jnzctgu7-bfrwrfmtdyzfw4.png"><br><br>  <b>Nombre</b> : especifique arbitrariamente; <br>  <b>El tipo</b> es dependiente.  Como elemento de datos principal, seleccione el elemento correspondiente creado previamente; <br>  <b>Clave</b> : mostraremos imaginaci√≥n, pero debemos tener en cuenta que cada clave debe ser √∫nica, por lo tanto, incluiremos la macro LLD en ella; <br>  <b>Tipo de informaci√≥n</b> , en este caso num√©rica; <br>  <b>Per√≠odo de almacenamiento del historial</b> : en el ejemplo, esta es una macro personalizada, indicada a su discreci√≥n; <br>  <b>El per√≠odo de almacenamiento de tendencias</b> es, nuevamente, una macro personalizada; <br><br>  Tambi√©n agregu√© un prototipo de la "Aplicaci√≥n": puede vincular convenientemente las m√©tricas relacionadas con un componente. <br><br>  En la pesta√±a "Preprocesamiento", cree un paso del tipo "Ruta JSON" con una regla que recupere las lecturas de temperatura: <br><br><img src="https://habrastorage.org/webt/mm/e1/ew/mme1ewdlmonbyzzhtouw7xvet_e.png"><br><br>  La expresi√≥n de paso se ve as√≠: <code>$['{#DISK.ID}']['temperature']</code> <br><br>  Tenga en cuenta que ahora puede usar macros LLD en la expresi√≥n, lo que no solo simplifica enormemente nuestro trabajo, sino que tambi√©n hace que sea bastante f√°cil hacer esas cosas (ya habr√≠a sido enviado a la API de Zabbix antes). <br><br>  A continuaci√≥n, por analog√≠a con la temperatura, cree los prototipos restantes de elementos de datos: <br><br><img src="https://habrastorage.org/webt/of/_x/ea/of_xeaktpnxwt1fkr_cyqxg6hm4.png"><br><br>  En esta etapa, puede verificar el resultado yendo a "Datos recientes" en el host.  Si todo le conviene all√≠, seguimos trabajando m√°s.  Termin√© con la siguiente imagen: <br><br><img src="https://habrastorage.org/webt/xz/8j/ra/xz8jradoaqbgb82jenxd5tb8og4.png"><br><br>  Estamos esperando que se actualice la cach√© de configuraci√≥n o la estamos empujando manualmente para actualizar: <br><br><pre> <code class="bash hljs">[root@zabbix]<span class="hljs-comment"><span class="hljs-comment"># zabbix_server -R config_cache_reload</span></span></code> </pre><br>  Despu√©s de eso, puede usar otro "truco" genial de la versi√≥n 4.0: el bot√≥n "Comprobar ahora" para ejecutar las reglas LLD creadas: <br><br><img src="https://habrastorage.org/webt/ve/1n/us/ve1nusqx9dxihlrl81irsegjsd0.png"><br><br>  Obtuve el siguiente resultado: <br><br><img src="https://habrastorage.org/webt/hu/wl/y4/huwly49ohgadt6smw7wgraj82kq.png"><br><br><h3>  Conclusi√≥n </h3><br>  Como resultado, con solo nueve solicitudes a la API XML, pudimos obtener m√°s de trescientas m√©tricas de un nodo de red, dedicando un m√≠nimo de tiempo y obteniendo la m√°xima flexibilidad.  LLD nos dar√° la capacidad de detectar autom√°ticamente nuevos componentes o actualizar los antiguos. <br><br>  Gracias por leer, los enlaces a los materiales utilizados y tambi√©n a la plantilla actual para el HPE MSA P2000G3 / 2040/2050 se pueden encontrar a continuaci√≥n. <br><br>  PD: Por cierto, en la versi√≥n 4.0 tambi√©n se introduce un nuevo tipo de comprobaciones: un agente HTTP, que, junto con el preprocesamiento y la ruta XML, puede potencialmente evitar que usemos scripts externos: solo necesita resolver el problema de obtener un token de autenticaci√≥n, que a√∫n debe actualizarse peri√≥dicamente.  Una de las opciones que veo es el uso de una macro global con este token, que se puede actualizar a trav√©s de la API de Zabbix por corona, incl.  Las personas interesadas pueden desarrollar esta idea.  =) <br><br>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Gui√≥n</a></b> <br>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Zabbix Share Template</a></b> <br>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Elementos de datos dependientes</a></b> <br>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Camino Json</a></b> <br>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Zabbix 4.0alpha9</a></b> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es419221/">https://habr.com/ru/post/es419221/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es419211/index.html">Algunas palabras en defensa de los bol√≠grafos inteligentes</a></li>
<li><a href="../es419213/index.html">Huawei super√≥ a Apple en t√©rminos de ventas. La capitalizaci√≥n de la compa√±√≠a estadounidense a√∫n alcanz√≥ $ 1 bill√≥n</a></li>
<li><a href="../es419215/index.html">Hf2Te2P: ¬øel "silicio" de las computadoras cu√°nticas?</a></li>
<li><a href="../es419217/index.html">Tripulaciones formadas para naves espaciales Boeing y SpaceX</a></li>
<li><a href="../es419219/index.html">Producto a granel: primer dep√≥sito de ADN comercial que se dar√° a conocer en 2019</a></li>
<li><a href="../es419223/index.html">C√≥mo ense√±amos a la IA a reconocer c√∫mulos de galaxias</a></li>
<li><a href="../es419227/index.html">Historia del primer iPad</a></li>
<li><a href="../es419229/index.html">Situaci√≥n: las aplicaciones de meditaci√≥n tienen m√°s √©xito que los podcasts</a></li>
<li><a href="../es419231/index.html">3 pecados de un programador: hardcoding, govnokoding y schizocoding</a></li>
<li><a href="../es419233/index.html">¬øPor qu√© la cafetera tiene su propia cuenta?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>