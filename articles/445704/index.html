<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üò∞ „äôÔ∏è üëõ Citymobil: una gu√≠a para nuevas empresas para aumentar la estabilidad en medio del crecimiento. Parte 2. ¬øCu√°les son los tipos de accidentes? ü§≥üèº ü§ΩüèΩ üî∏</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Este es el segundo art√≠culo de una serie sobre c√≥mo nosotros en Citymobil aumentamos la estabilidad del servicio (puede leer el primero aqu√≠ ). En est...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Citymobil: una gu√≠a para nuevas empresas para aumentar la estabilidad en medio del crecimiento. Parte 2. ¬øCu√°les son los tipos de accidentes?</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/445704/"><img src="https://habrastorage.org/getpro/habr/post_images/61f/db5/50d/61fdb550d3b183fa7f134339397e276f.png"><br><br>  Este es el segundo art√≠culo de una serie sobre c√≥mo nosotros en Citymobil aumentamos la estabilidad del servicio (puede leer el primero <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> ).  En este art√≠culo, profundizar√© en los detalles del an√°lisis de accidentes.  Pero antes de eso, cubrir√© un punto que ten√≠a que pensar de antemano y cubrir en el primer art√≠culo, pero no lo pens√©.  Y sobre lo que aprend√≠ de los comentarios de los lectores.  El segundo art√≠culo me da la oportunidad de eliminar este molesto defecto. <br><a name="habracut"></a><br><h2>  0. Pr√≥logo </h2><br>  Uno de los lectores hizo una pregunta muy justa: "¬øQu√© es dif√≠cil en el backend de un servicio de taxi?"  La pregunta es buena.  Me pregunt√© a m√≠ mismo el verano pasado antes de comenzar a trabajar en Citymobil.  Entonces pens√© "pensar, un taxi, una aplicaci√≥n con tres botones".  ¬øQu√© podr√≠a ser complicado al respecto?  Pero result√≥ que este es un servicio de muy alta tecnolog√≠a y un producto complejo.  Para al menos dejar en claro de qu√© se trata y qu√© es realmente un gran coloso tecnol√≥gico, hablar√© sobre varias √°reas de las actividades de productos de Citymobil: <br><br><ul><li>  Precios.  El equipo de fijaci√≥n de precios se ocupa de los problemas de precios en cada punto y en cualquier momento.  El precio se determina prediciendo el equilibrio de la oferta y la demanda en base a estad√≠sticas y otros datos.  Todo esto hace un servicio grande, complejo y en constante evoluci√≥n basado en el aprendizaje autom√°tico. </li><li>  Precios.  La implementaci√≥n de varios m√©todos de pago, la l√≥gica de los recargos despu√©s del viaje, la retenci√≥n de fondos en tarjetas bancarias, facturaci√≥n, interacci√≥n con socios y conductores. </li><li>  Distribuci√≥n de pedidos.  ¬øA qu√© m√°quina distribuir el pedido de ventas?  Por ejemplo, la opci√≥n de distribuci√≥n para el m√°s cercano no es la mejor en t√©rminos de aumentar el n√∫mero de viajes.  Una opci√≥n m√°s correcta es comparar clientes y autom√≥viles de tal manera que se maximice el n√∫mero de viajes, dada la probabilidad de cancelaci√≥n por parte de este cliente en particular en estas condiciones (porque lleva mucho tiempo) y la cancelaci√≥n o sabotaje del pedido por parte de este conductor (porque toma demasiado tiempo o demasiado bajo verificar). </li><li>  Geo.  Todo lo relacionado con la b√∫squeda y recepci√≥n de direcciones, puntos de aterrizaje, ajuste del tiempo de entrega (nuestros socios, proveedores de tarjetas y atascos de tr√°fico no siempre brindan informaci√≥n precisa sobre ETA, teniendo en cuenta los atascos de tr√°fico), mejorando la precisi√≥n de la geocodificaci√≥n directa e inversa, mejorando la precisi√≥n de la m√°quina.  Hay mucho trabajo con datos, muchos an√°lisis, muchos servicios basados ‚Äã‚Äãen aprendizaje autom√°tico. </li><li>  Antifraude  La diferencia en el precio de un viaje para un pasajero y para un conductor (por ejemplo, en viajes cortos) crea un incentivo econ√≥mico para los estafadores que intentan robar nuestro dinero.  Combatir el fraude es algo similar a combatir el spam en el servicio de correo electr√≥nico: la integridad y la precisi√≥n son importantes.  Es necesario bloquear el n√∫mero m√°ximo de estafadores (integridad), pero los buenos usuarios no deben confundirse con los estafadores (precisi√≥n). </li><li>  Motivaci√≥n de los conductores.  El equipo de motivaci√≥n del conductor se dedica al desarrollo de todo lo relacionado con aumentar el uso de nuestra plataforma por parte de los conductores y la lealtad del conductor debido a varios tipos de motivaci√≥n.  Por ejemplo, haz viajes X y obt√©n rublos Y adicionales para esto.  O compre un turno por Z rublos y viaje sin comisi√≥n. </li><li> Aplicaci√≥n de controlador de fondo.  Una lista de pedidos, un mapa de demanda (una pista de d√≥nde ir al conductor para maximizar sus ingresos), cambios de estado de prokidyvaniya, un sistema de comunicaci√≥n con conductores y mucho m√°s. </li><li>  El backend de la aplicaci√≥n del cliente (esta es probablemente la parte m√°s obvia y lo que generalmente se entiende por el backend de un taxi): hacer pedidos, desplazarse por los estados sobre cambiar el estado del pedido, garantizar el movimiento de los autom√≥viles en el mapa en el pedido y en la entrega, consejos de back-end y etc. </li></ul><br>  Esta es toda la punta del iceberg.  La funcionalidad es mucho m√°s.  La interfaz f√°cil de usar oculta una gran parte submarina del iceberg. <br><br>  Y ahora volviendo a los accidentes.  Durante los seis meses de historia de accidentes, hemos compilado la siguiente categorizaci√≥n: <br><br><ul><li>  lanzamiento pobre, errores 500; </li><li>  lanzamiento deficiente, c√≥digo sub√≥ptimo, carga en la base; </li><li>  intervenci√≥n manual fallida en el sistema; </li><li>  huevo de pascua </li><li>  causas externas; </li><li>  lanzamiento deficiente, funcionalidad rota. </li></ul><br>  A continuaci√≥n, escribir√© qu√© conclusiones hicimos sobre los tipos m√°s comunes de accidentes. <br><br><h2>  1. Mala versi√≥n, errores 500 </h2><br>  Casi todo nuestro backend est√° escrito en PHP, un lenguaje interpretado con escritura d√©bil.  Sucede que despliega el c√≥digo y se bloquea debido a un error en el nombre de la clase o funci√≥n.  Y este es solo un ejemplo cuando aparece el error n√∫mero 500.  Tambi√©n puede aparecer en caso de un error l√≥gico en el c√≥digo;  lam√≠ la rama equivocada;  borr√≥ accidentalmente la carpeta con el c√≥digo;  dej√≥ en el c√≥digo los artefactos temporales necesarios para la prueba;  no cambi√≥ la estructura de las tablas de acuerdo con el nuevo c√≥digo;  no reinici√≥ ni detuvo los scripts cron necesarios. <br><br>  Luchamos con este problema secuencialmente en varias etapas.  Los viajes perdidos debido a una mala liberaci√≥n son obviamente proporcionales al tiempo que estuvo en uso.  Es decir, debemos hacer todo lo posible para garantizar que una versi√≥n deficiente funcione lo menos posible.  Cualquier cambio en el proceso de desarrollo que reduzca el tiempo promedio que se tarda en utilizar una versi√≥n incorrecta en al menos 1 segundo es positivo para la empresa y debe implementarse. <br><br>  Una mala liberaci√≥n o cualquier accidente de producci√≥n generalmente pasa por dos estados, que llamamos "etapa pasiva" y "etapa activa".  La etapa pasiva es cuando a√∫n no nos damos cuenta del accidente.  La etapa activa es cuando ya estamos en el saber.  El accidente comienza en la etapa pasiva y, con el tiempo, cuando nos damos cuenta, el accidente pasa a la etapa activa: comenzamos a combatirlo: primero lo diagnosticamos y luego lo reparamos. <br><br>  Para reducir la duraci√≥n de cualquier accidente en la producci√≥n, es necesario reducir la duraci√≥n promedio de las etapas pasiva y activa.  Lo mismo ocurre con un mal lanzamiento, porque es en s√≠ mismo una especie de accidente. <br><br>  Comenzamos a analizar nuestro proceso actual de reparaci√≥n de accidentes.  Los lanzamientos incorrectos que encontramos en el momento del inicio del an√°lisis dieron como resultado un promedio inactivo (total o parcial) de 20-25 minutos.  La etapa pasiva usualmente toma 15 minutos, la activa 10 minutos.  Durante la fase pasiva, las quejas de los usuarios comenzaron a ser procesadas por el centro de contacto, y despu√©s de cierto umbral, el centro de contacto se quej√≥ de chats generales en Slack.  A veces, uno de los empleados se quejaba cuando no pod√≠a pedir un taxi.  Una queja de los empleados fue una se√±al para nosotros sobre un problema grave.  Despu√©s de la transici√≥n de una mala versi√≥n a la etapa activa, comenzamos a diagnosticar el problema, analizamos las √∫ltimas versiones, varios gr√°ficos y registros para determinar la causa del accidente.  Despu√©s de descubrir la raz√≥n, revertimos el c√≥digo si la versi√≥n incorrecta se bombe√≥ por √∫ltima vez, o hicimos una nueva reversi√≥n con una confirmaci√≥n de lanzamiento incorrecta inversa. <br><br>  Aqu√≠ hay un proceso para lidiar con lanzamientos malos, tuvimos que mejorar. <br><br><h3>  1.1.  Reducci√≥n de etapa pasiva </h3><br>  En primer lugar, notamos que si una versi√≥n deficiente est√° acompa√±ada de 500 errores, entonces podemos entender sin quejas que ha ocurrido un problema.  Afortunadamente, todos los errores n√∫mero 500 se registraron en New Relic (este es uno de los sistemas de monitoreo que usamos), y solo quedaba para atornillar las notificaciones de SMS e IVR sobre el exceso de una cierta frecuencia de "quinientos" (con el tiempo, el umbral se redujo constantemente). <br><br>  Esto llev√≥ al hecho de que la etapa activa del accidente, como "Mala versi√≥n, errores n√∫mero 500", comenz√≥ casi inmediatamente despu√©s de la liberaci√≥n.  El proceso en caso de accidente comenz√≥ a verse as√≠: <br><br><ol><li>  El programador implementa el c√≥digo. </li><li>  El lanzamiento lleva a un accidente (500 masivos). </li><li>  SMS llega. </li><li>  Los programadores y administradores comienzan a entender (a veces no de inmediato, pero despu√©s de 2-3 minutos: los SMS pueden retrasarse, el sonido en el tel√©fono puede apagarse y la cultura de acciones inmediatas despu√©s de SMS no puede aparecer en un d√≠a). </li><li>  Comienza la fase activa del accidente, que dura los mismos 10 minutos que antes. </li></ol><br>  Por lo tanto, la etapa pasiva se redujo de 15 minutos a 3. <br><br><h3>  1.2.  Reducci√≥n adicional de la etapa pasiva. </h3><br>  A pesar de la reducci√≥n de la etapa pasiva a 3 minutos, incluso una etapa pasiva tan corta nos molest√≥ m√°s que la activa, porque durante la etapa activa ya hacemos algo para resolver el problema, y ‚Äã‚Äãdurante la etapa pasiva el servicio no funciona en su totalidad o en parte, pero " los hombres no lo saben ". <br><br>  Para reducir a√∫n m√°s la etapa pasiva, decidimos sacrificar tres minutos de tiempo de desarrollador despu√©s de cada lanzamiento.  La idea era muy simple: despliega el c√≥digo y mira New Relic, Sentry, Kibana durante tres minutos para ver si hay 500 errores.  Tan pronto como vea un problema all√≠, a priori asume que est√° relacionado con su c√≥digo y comienza a comprender. <br><br>  Elegimos tres minutos en funci√≥n de las estad√≠sticas: a veces aparec√≠an problemas en los gr√°ficos con un retraso de 1-2 minutos, pero nunca hab√≠a m√°s de tres minutos. <br><br>  Esta regla se registr√≥ en lo que se debe y no se debe hacer.  Al principio no siempre se ejecut√≥, pero gradualmente los desarrolladores se acostumbraron a la regla como higiene elemental: cepillarse los dientes por la ma√±ana tambi√©n es una p√©rdida de tiempo, pero debe hacerlo. <br><br>  Como resultado, la etapa pasiva se redujo a 1 minuto (los horarios todav√≠a llegaban tarde a veces).  Como sorpresa agradable, esto simult√°neamente redujo la etapa activa.  Despu√©s de todo, el desarrollador encuentra un problema en buena forma y est√° listo para deshacer inmediatamente su c√≥digo.  Aunque esto no siempre ayuda, porque  El problema podr√≠a haber surgido debido al c√≥digo de otra persona que se estaba implementando en paralelo.  Pero, sin embargo, la etapa activa en promedio se redujo a 5 minutos. <br><br><h3>  1.3.  Reducci√≥n adicional en la etapa activa </h3><br>  M√°s o menos satisfechos con un minuto de la etapa pasiva, comenzamos a pensar en una reducci√≥n adicional en la etapa activa.  En primer lugar, prestamos atenci√≥n a la historia de los problemas (¬°es la piedra angular en la construcci√≥n de nuestra estabilidad!) Y descubrimos que en muchos casos no retrocedemos inmediatamente porque no entendemos a qu√© versi√≥n retroceder, porque hay muchas versiones paralelas.  Para resolver este problema, presentamos la siguiente regla (y la registramos en lo que se debe y no se debe hacer): antes del lanzamiento, escribes en el chat en Slack, para qu√© est√°s rodando y qu√©, y en caso de accidente, escribes en el chat "¬°accidente, no ruedes!".  Adem√°s, comenzamos a informar autom√°ticamente por SMS sobre los hechos de la publicaci√≥n para notificar a aquellos que no entran al chat. <br><br>  Esta simple regla redujo dr√°sticamente el n√∫mero de liberaciones ya durante los accidentes y redujo la etapa activa, de 5 minutos a 3. <br><br><h3>  1.4.  Una reducci√≥n a√∫n mayor en la etapa activa </h3><br>  A pesar del hecho de que advertimos en el chat sobre todos los lanzamientos y bloqueos, a veces aparec√≠an condiciones de carrera: uno escribi√≥ sobre el lanzamiento y el otro ya se lanz√≥ en ese momento;  o cuando comenz√≥ el accidente, escribieron sobre eso en el chat, y alguien acaba de lanzar un nuevo c√≥digo.  Estas circunstancias alargaron el diagn√≥stico.  Para resolver este problema, implementamos una prohibici√≥n autom√°tica de versiones paralelas.  La idea es muy simple: despu√©s de cada versi√≥n, el sistema CI / CD proh√≠be que todos se lancen durante los pr√≥ximos 5 minutos, excepto el autor de la √∫ltima versi√≥n (para que pueda lanzar o hacer hotfix si es necesario) y varios desarrolladores especialmente experimentados (en caso de emergencia).  Adem√°s, el sistema CI / CD proh√≠be el despliegue durante un accidente (es decir, desde el momento de la recepci√≥n de la notificaci√≥n del comienzo del accidente hasta el momento de la recepci√≥n de la notificaci√≥n de su finalizaci√≥n). <br><br>  Por lo tanto, el proceso se hizo as√≠: el desarrollador implementa, monitorea los gr√°ficos durante tres minutos, y despu√©s de eso durante dos minutos m√°s, nadie puede implementar nada.  Si hay un problema, entonces el desarrollador revierte la versi√≥n.  Esta regla simplific√≥ radicalmente el diagn√≥stico, y la duraci√≥n total de las etapas activa y pasiva disminuy√≥ de 3 + 1 = 4 minutos a 1 + 1 = 2 minutos. <br><br>  Pero dos minutos del accidente son muchos.  Por lo tanto, continuamos optimizando el proceso. <br><br><h3>  1.5.  Detecci√≥n autom√°tica de fallas y reversi√≥n </h3><br>  Hemos estado pensando durante mucho tiempo c√≥mo reducir la duraci√≥n del accidente debido a las bajas emisiones.  Incluso intentaron obligarse a mirar en la <code>tail -f error_log | grep 500</code>  <code>tail -f error_log | grep 500</code> .  Pero al final, todos se decidieron por una soluci√≥n cardinal autom√°tica. <br><br>  En resumen, este es un retroceso autom√°tico.  Configuramos un servidor web separado, en el que cargamos 10 veces menos carga del equilibrador que en otros servidores web.  Cada versi√≥n fue implementada autom√°ticamente por el sistema CI / CD en este servidor separado (lo llamamos preprod, aunque, a pesar del nombre, la carga real de los usuarios reales fue all√≠).  Y luego la automatizaci√≥n hizo <code>tail -f error_log | grep 500</code>  <code>tail -f error_log | grep 500</code> .  Si no se produjo el error n√∫mero 500 en un minuto, el CI / CD despleg√≥ el nuevo c√≥digo en producci√≥n.  Si aparecieron errores, el sistema inmediatamente revierte todo.  Al mismo tiempo, en el nivel de equilibrador, todas las solicitudes completadas con 500 errores en el preprod se duplicaron en uno de los servidores de producci√≥n. <br><br>  Esta medida redujo el efecto de las quinientas versiones a cero.  Al mismo tiempo, en caso de errores en la automatizaci√≥n, no cancelamos la regla durante tres minutos para monitorear los gr√°ficos.  Eso se trata de malas versiones y errores n√∫mero 500.  Pasamos al siguiente tipo de accidente. <br><br><h2>  2. Lanzamiento incorrecto, c√≥digo sub√≥ptimo, carga base </h2><br>  Comenzar√© de inmediato con un ejemplo concreto de un accidente de este tipo.  Implementamos la optimizaci√≥n: agregamos <code>USE INDEX</code> a la consulta SQL, durante la prueba de estas consultas cortas aceleradas, como en la producci√≥n, pero las consultas largas se ralentizaron.  La desaceleraci√≥n de las consultas largas solo se not√≥ en la producci√≥n.  Como resultado, el flujo de solicitudes largas puso a toda la base maestra durante una hora.  Entendimos completamente c√≥mo funciona <code>USE INDEX</code> , lo describimos en el archivo de hacer y no hacer, y advertimos a los desarrolladores contra el mal uso.  Tambi√©n analizamos la consulta y nos dimos cuenta de que devuelve principalmente datos hist√≥ricos, lo que significa que se puede ejecutar en una r√©plica separada para consultas hist√≥ricas.  Incluso si esta r√©plica se encuentra bajo carga, el negocio no se detendr√°. <br><br>  Despu√©s de este incidente, todav√≠a nos encontramos con problemas similares, y en alg√∫n momento decidimos abordar el problema sistem√°ticamente.  Escaneamos todo el c√≥digo con un peine frecuente y realizamos a la r√©plica todas las solicitudes que se pueden realizar all√≠ sin comprometer la calidad del servicio.  Al mismo tiempo, dividimos las r√©plicas de acuerdo con los niveles de criticidad para que la ca√≠da de cualquiera de ellas no detuviera el servicio.  Como resultado, llegamos a una arquitectura que tiene las siguientes bases: <br><br><ul><li>  base maestra (para operaciones de escritura y para consultas que son supercr√≠ticas para la actualizaci√≥n de datos); </li><li>  r√©plica de producci√≥n (para consultas cortas que son un poco menos cr√≠ticas para la actualizaci√≥n de datos); </li><li>  r√©plica para calcular las relaciones de precios, el llamado aumento de precios.  Esta r√©plica puede retrasarse entre 30 y 60 segundos: esto no es cr√≠tico, los coeficientes cambian con poca frecuencia y si esta r√©plica cae, el servicio no se detendr√°, solo los precios no coincidir√°n con el equilibrio de la oferta y la demanda; </li><li>  r√©plica para el panel de administraci√≥n de usuarios comerciales y el centro de contacto (si cae, el negocio principal no aumentar√°, pero el soporte no funcionar√° y no podremos ver ni cambiar la configuraci√≥n temporalmente); </li><li>  muchas r√©plicas para an√°lisis; </li><li>  Base de datos MPP para an√°lisis pesados ‚Äã‚Äãcon cortes completos seg√∫n datos hist√≥ricos. </li></ul><br>  Esta arquitectura nos dio m√°s espacio para el crecimiento y redujo el n√∫mero de bloqueos en un orden de magnitud debido a consultas SQL sub√≥ptimas.  Pero ella todav√≠a est√° lejos de ser ideal.  Planea hacer sharding para que puedas escalar actualizaciones y eliminaciones, as√≠ como consultas cortas supercr√≠ticas para la actualizaci√≥n de estos datos.  El margen de seguridad de MySQL no es infinito.  Pronto necesitaremos artiller√≠a pesada en forma de Tarantool.  ¬°Sobre esto ser√° necesario en los siguientes art√≠culos! <br><br>  En el proceso de la prueba con c√≥digo y solicitudes no √≥ptimos, nos dimos cuenta de lo siguiente: es mejor eliminar cualquier falta de optimizaci√≥n antes del lanzamiento, y no despu√©s.  Esto reduce el riesgo de un accidente y el tiempo dedicado por los desarrolladores a la optimizaci√≥n.  Porque si el c√≥digo ya se ha descargado y hay nuevas versiones adem√°s, es mucho m√°s dif√≠cil de optimizar.  Como resultado, introdujimos una verificaci√≥n de c√≥digo obligatoria para la optimizaci√≥n.  Lo llevan a cabo los desarrolladores m√°s experimentados, de hecho, nuestras fuerzas especiales. <br><br>  Adem√°s, comenzamos a recopilar en do's &amp; dont's los mejores m√©todos de optimizaci√≥n de c√≥digo que funcionan en nuestras realidades, se enumeran a continuaci√≥n.  Por favor, no perciban estas pr√°cticas como una verdad absoluta y no intenten repetirlas ciegamente en ustedes mismos.  Cada m√©todo tiene sentido solo para una situaci√≥n espec√≠fica y un negocio espec√≠fico.  Aqu√≠ se dan solo por ejemplo, para que los detalles sean claros: <br><br><ul><li>  Si la consulta SQL no depende del usuario actual (por ejemplo, un mapa de demanda de controladores que indique las tasas de viajes m√≠nimos y coeficientes para pol√≠gonos), entonces esta consulta debe ser realizada por cron con cierta frecuencia (en nuestro caso, una vez por minuto es suficiente).  Escriba el resultado en el cach√© (Memcached o Redis), que ya se usa en el c√≥digo de producci√≥n. </li><li>  Si la consulta SQL funciona con datos cuya acumulaci√≥n no es cr√≠tica para el negocio, entonces su resultado debe almacenarse en cach√© con algunos TTL (por ejemplo, 30 segundos).  Y luego, en solicitudes posteriores, leer desde el cach√©. </li><li>  Si en el contexto del procesamiento de una solicitud en la web (en nuestro caso, en el contexto de la implementaci√≥n de un m√©todo de servidor espec√≠fico en PHP) desea realizar una consulta SQL, debe asegurarse de que estos datos no hayan "llegado" con ninguna otra consulta SQL (y si llegar√°n m√°s lejos por c√≥digo).  Lo mismo se aplica al acceso a la memoria cach√©: tambi√©n se puede inundar con solicitudes si lo desea, por lo tanto, si los datos ya han "llegado" de la memoria cach√©, entonces no es necesario que vaya a la memoria cach√© como a su hogar y la retire, que ya est√° quitada. </li><li>  Si en el contexto del procesamiento de consultas en la web desea llamar a alguna funci√≥n, debe asegurarse de que no se realizar√°n consultas SQL adicionales ni acceso a la cach√© en sus menudillos.  Si llamar a una funci√≥n de este tipo es inevitable, debe asegurarse de que no se pueda modificar o que su l√≥gica se rompa para no realizar consultas innecesarias en las bases de datos / cach√©s. </li><li>  Si a√∫n necesita ingresar a SQL, debe asegurarse de que no puede agregar los campos necesarios m√°s altos o m√°s bajos en el c√≥digo a las consultas que ya existen en el c√≥digo. </li></ul><br><h2>  3. Intervenci√≥n manual fallida en el sistema </h2><br>  Ejemplos de tales accidentes: un ALTER sin √©xito (que sobrecarg√≥ la base de datos o provoc√≥ un retraso de la r√©plica) o DROP sin √©xito (se encontr√≥ con un error en MySQL, bloque√≥ la base de datos cuando se dej√≥ caer una nueva tabla);  fuerte solicitud de un maestro hecho por error a mano;  Realizamos trabajo en el servidor bajo carga, aunque pensamos que no ten√≠a trabajo. <br><br>  Para minimizar las ca√≠das por estos motivos, es necesario, desafortunadamente, comprender la naturaleza del accidente cada vez.  Todav√≠a no hemos encontrado la regla general.  De nuevo, prueba los ejemplos.  Digamos que, en alg√∫n momento, los coeficientes de sobretensi√≥n dejaron de funcionar (multiplican el precio del viaje en el lugar y momento de mayor demanda).  La raz√≥n fue que en la r√©plica de la base de datos, de donde provienen los datos para calcular los coeficientes, el script Python funcion√≥, que se comi√≥ toda la memoria, y la r√©plica se cay√≥.  El script se ha estado ejecutando durante mucho tiempo, funcion√≥ en una r√©plica solo por conveniencia.  El problema se resolvi√≥ reiniciando el script.  Las conclusiones fueron las siguientes: no ejecute scripts de terceros en una m√°quina con una base de datos (grabada en hacer y no hacer, de lo contrario, es un tiro en blanco!), Monitoree el final de la memoria en una m√°quina con una r√©plica y alerta por SMS si la memoria se agota pronto. <br><br>  Es muy importante sacar siempre conclusiones y no caer en una situaci√≥n c√≥moda "vieron un problema, lo solucionaron y lo olvidaron".  Un servicio de calidad solo se puede construir si se extraen conclusiones.  Adem√°s, las alertas por SMS son muy importantes: establecen la calidad del servicio en un nivel superior al que ten√≠an, evitan que se caiga y mejoran a√∫n m√°s la confiabilidad.  Como escalador de cada estado estable, se levanta y queda fijo en otro estado estable, pero a mayor altitud. <br><br>  Monitorear y alertar con ganchos de hierro invisibles pero r√≠gidos cortan la roca de la incertidumbre y nunca nos dejan caer por debajo del nivel de estabilidad que establecemos, que constantemente elevamos solo. <br><br><h2>  4. huevo de pascua </h2><br>  Lo que llamamos el "huevo de Pascua" es una bomba de tiempo que ha existido durante mucho tiempo, pero que no hemos encontrado.  Fuera de este art√≠culo, este t√©rmino se refiere a una caracter√≠stica no documentada hecha a prop√≥sito.  En nuestro caso, esto no es una caracter√≠stica en absoluto, sino m√°s bien un error, pero que funciona como una bomba de tiempo y que es un efecto secundario de las buenas intenciones. <br><br>  Por ejemplo: desbordamiento de 32 bits <code>auto_increment</code> ;  no optimidad en el c√≥digo / configuraci√≥n, "disparo" debido a la carga;  r√©plica retrasada (generalmente debido a una solicitud sub√≥ptima de una r√©plica que se activ√≥ por un nuevo patr√≥n de uso, o una carga m√°s alta, o debido a una ACTUALIZACI√ìN sub√≥ptima en el maestro que fue llamado por un nuevo patr√≥n de carga y carg√≥ la r√©plica). <br><br>  Otro tipo popular de huevo de Pascua es el c√≥digo no √≥ptimo y, m√°s espec√≠ficamente, la consulta SQL no √≥ptima.  Anteriormente, la tabla era m√°s peque√±a y la carga era menor: la consulta funcion√≥ bien.  Y con el aumento de la tabla, lineal en el tiempo y el crecimiento de la carga, lineal en el tiempo, el consumo de recursos DBMS creci√≥ de forma cuadr√°tica.  Por lo general, esto lleva a un efecto negativo agudo: todo estaba "bien" y explosi√≥n. <br><br>  Los escenarios m√°s raros son una combinaci√≥n de insectos y huevos de pascua.  Un lanzamiento con un error provoc√≥ un aumento en el tama√±o de la tabla o un aumento en el n√∫mero de registros en una tabla de cierto tipo, y un huevo de Pascua ya existente caus√≥ una carga excesiva en la base de datos debido a consultas m√°s lentas a esta tabla demasiado grande. <br><br>  Aunque, tambi√©n tuvimos huevos de Pascua, no relacionados con la carga.  Por ejemplo, <code>auto increment</code> 32 bits: despu√©s de dos y algunos miles de millones de registros en la tabla, las inserciones dejan de realizarse.  Por lo tanto, el campo de <code>auto increment</code> en el mundo moderno debe hacerse de 64 bits.  Aprendimos bien esta lecci√≥n. <br><br>  ¬øC√≥mo lidiar con los huevos de Pascua?  La respuesta es simple: a) busque "huevos" viejos yb) evite que aparezcan nuevos.  Intentamos cumplir ambos puntos.  La b√∫squeda de viejos "huevos" en nuestro pa√≠s est√° asociada con la optimizaci√≥n constante del c√≥digo.  Identificamos a dos de los desarrolladores m√°s experimentados para la optimizaci√≥n casi a tiempo completo.  Encuentran en slow.log consultas que consumen la mayor√≠a de los recursos de la base de datos, optimizan estas consultas y el c√≥digo que las rodea.  Reducimos la probabilidad de nuevos huevos al verificar el c√≥digo de optimizaci√≥n de cada confirmaci√≥n por parte del sensei rezrabotchiki mencionado anteriormente.  Su tarea es se√±alar errores que afectan el rendimiento;  decirle c√≥mo hacerlo mejor y transferir conocimientos a otros desarrolladores. <br><br>  En alg√∫n momento despu√©s del siguiente huevo de pascua que encontramos, nos dimos cuenta de que buscar consultas lentas es bueno, pero valdr√≠a la pena buscar consultas que parezcan lentas pero que funcionen r√°pido.  Estos son solo los pr√≥ximos candidatos para poner todo en caso de un crecimiento explosivo de la siguiente tabla. <br><br><h2>  5. Causas externas </h2><br>  Estas son razones que creemos que est√°n mal controladas por nosotros.  Por ejemplo: <br><br><ul><li>  Trote por Google Maps.  Puede evitarlo monitoreando el uso de este servicio, observando un cierto nivel de carga, planificando el crecimiento de la carga por adelantado y comprando la expansi√≥n del servicio. </li><li>  La ca√≠da de la red en el centro de datos.  Puede moverse colocando una copia del servicio en el centro de datos de respaldo. </li><li>  Accidente de servicio de pago.  Puede omitir la reserva de servicios de pago. </li><li>  Bloqueo de tr√°fico err√≥neo por parte del servicio de protecci√≥n DDoS.  Puede moverse deshabilitando el servicio de protecci√≥n DDoS predeterminado y habilit√°ndolo solo en caso de un ataque DDoS. </li></ul><br>  Dado que eliminar una causa externa es una tarea larga y costosa (por definici√≥n), acabamos de comenzar a recopilar estad√≠sticas sobre accidentes debido a causas externas y esperar la acumulaci√≥n de masa cr√≠tica.  No existe una receta para determinar la masa cr√≠tica.  Simplemente funciona la intuici√≥n.  Por ejemplo, si estuvi√©ramos 5 veces en tiempo de inactividad completo debido a problemas, por ejemplo, del servicio de control DDoS, entonces con cada pr√≥xima ca√≠da se volver√° cada vez m√°s agudo para plantear la cuesti√≥n de una alternativa. <br><br>  Por otro lado, si de alguna manera puede hacer que funcione con un servicio externo inaccesible, entonces definitivamente lo hacemos.  Y esto nos ayuda a realizar an√°lisis post-mortem de cada oto√±o.  Siempre debe haber una conclusi√≥n.  Eso significa que siempre quieres-no-quieres, pero puedes encontrar una soluci√≥n alternativa. <br><br><h2>  6. Mala versi√≥n, funcionalidad rota </h2><br>  Este es el tipo de accidente m√°s desagradable.  El √∫nico tipo de accidente que no es visible por ning√∫n s√≠ntoma que no sean las quejas de usuarios / negocios.  Por lo tanto, tal accidente, especialmente si no es grande, puede pasar desapercibido en la producci√≥n durante mucho tiempo. <br><br>  Todos los otros tipos de accidentes son m√°s o menos similares a "mala liberaci√≥n, errores n√∫mero 500".  Es solo que el disparador no es una liberaci√≥n, sino una carga, una operaci√≥n manual o un problema del lado de un servicio externo. <br><br>  Para describir el m√©todo de tratar este tipo de accidente, es suficiente recordar una an√©cdota barbuda: <br><br><blockquote>  A las matem√°ticas y la f√≠sica se les ofreci√≥ la misma tarea: hervir una tetera.  Se entregan herramientas auxiliares: estufa, hervidor de agua, grifo con agua, f√≥sforos.  Ambos vierten agua alternativamente en el hervidor, encienden el gas, lo encienden y encienden el hervidor.  Luego la tarea se simplific√≥: se propuso una tetera llena de agua y una estufa con gas ardiente.  El objetivo es el mismo: hervir agua.  El f√≠sico prende fuego a la tetera.  El matem√°tico vierte agua de la tetera, apaga el gas y dice: "La tarea se ha reducido a la anterior".  anekdotov.net </blockquote><br>  Este tipo de accidente debe reducirse por todos los medios a "mala liberaci√≥n, errores n√∫mero 500".  Idealmente, si los errores en el c√≥digo se guardaron en el registro como un error.  Bueno, o al menos dej√≥ rastros en la base de datos.  A partir de estos rastros, puede comprender que se ha producido un error e inmediatamente alertar.  ¬øC√≥mo contribuir a esto?  Comenzamos a analizar cada error importante y ofrecer soluciones, qu√© tipo de monitoreo / alerta de SMS se puede hacer para que este error se manifieste inmediatamente de la misma manera que el error n√∫mero 500. <br><br><h3>  6.1.  Ejemplo </h3><br>  Hubo quejas masivas: los pedidos pagados a trav√©s de Apple Pay no se cierran.  Comenzaron a entender, el problema se repiti√≥.  Encontramos la raz√≥n: realizamos mejoras en el formato de <code>expire date</code> de las tarjetas bancarias al interactuar con la adquisici√≥n, como resultado de lo cual comenzaron a transferirlo espec√≠ficamente para pagos a trav√©s de Apple Pay en el formato que se esperaba del servicio de procesamiento de pagos (de hecho, uno es tratable, mutilar algo m√°s), por lo que todos los pagos a trav√©s de Apple Pay comenzaron a declinar.  R√°pidamente arreglado, desplegado, el problema desapareci√≥.  Pero "vivieron" con el problema durante 45 minutos. <br><br>  Siguiendo los rastros de este problema, monitoreamos el n√∫mero de pagos fallidos a trav√©s de Apple Pay, y tambi√©n realizamos una alerta SMS / IVR con un umbral distinto de cero (porque los pagos fallidos son la norma desde el punto de vista del servicio, por ejemplo, el cliente no tiene dinero en la tarjeta o la tarjeta est√° bloqueada) .  A partir de este momento, cuando se supera el umbral, aprendemos instant√°neamente sobre el problema.  Si la nueva versi√≥n presenta CUALQUIER problema en el procesamiento de Apple Pay, lo que conducir√° a la inoperancia del servicio, incluso parcial, lo aprenderemos de inmediato a partir del monitoreo y revertiremos la versi√≥n en tres minutos (se describe anteriormente c√≥mo funciona el proceso de laminaci√≥n manual).  Fueron 45 minutos de tiempo de inactividad parcial, se convirtieron en 3 minutos.  Ganancia <br><br><h3>  6.2.  Otros ejemplos </h3><br>  Lanzamos la optimizaci√≥n de la lista de pedidos ofrecidos a los conductores.  Un error se desliz√≥ en el c√≥digo.  Como resultado, los conductores en algunos casos no vieron la lista de pedidos (estaba vac√≠a).  Descubrieron el error por accidente: uno de los empleados examin√≥ la solicitud del conductor.  Retrocedi√≥ r√°pidamente.  Como conclusi√≥n del accidente, hicimos un gr√°fico del n√∫mero promedio de pedidos en la lista de controladores de acuerdo con la base de datos, observamos el gr√°fico retroactivamente durante un mes, vimos una falla all√≠ e hicimos una alerta por SMS para la consulta SQL, que forma este gr√°fico cuando el n√∫mero promedio de pedidos en la lista debajo del umbral seleccionado en funci√≥n del m√≠nimo hist√≥rico del mes. <br><br>  Cambi√≥ la l√≥gica de dar devoluci√≥n de dinero a los usuarios para los viajes.  Incluido distribuido al grupo de usuarios incorrecto.  Solucionamos el problema, construimos un calendario de devoluciones de efectivo entregados, vimos un fuerte aumento all√≠, tambi√©n vimos que nunca hab√≠a habido tal crecimiento, hicimos una alerta por SMS. <br><br>  Con el lanzamiento, se rompi√≥ la funcionalidad de cerrar las √≥rdenes (la orden se cerr√≥ para siempre, el pago con tarjetas no funcion√≥, los conductores exigieron el pago en efectivo de los clientes).  El problema fue de 1,5 horas (etapas total pasiva y activa).  Aprendimos sobre el problema del centro de contacto de quejas.  Hicieron una correcci√≥n, monitorearon y alertaron sobre el tiempo de cierre de las √≥rdenes con umbrales encontrados en el estudio de gr√°ficos hist√≥ricos. <br><br>  Como puede ver, el enfoque para este tipo de accidente es siempre el mismo: <br><br><ol><li>  Lanza el lanzamiento. </li><li>  Aprende sobre el problema. </li><li>  Arreglarlo </li><li>  Determinamos qu√© rastros (en la base de datos, registros, Kiban) puede encontrar los signos del problema. </li><li>  Trazamos estos signos. </li><li>  Lo rebobinamos hacia el pasado y observamos las explosiones / ca√≠das. </li><li>  Seleccionamos el umbral correcto para la alerta. </li><li>  Cuando surge un problema nuevamente, nos enteramos de inmediato a trav√©s de una alerta. </li></ol><br>  Lo bueno de este m√©todo: una gran clase de problemas se cierra de inmediato con un gr√°fico y una alerta (ejemplos de clases de problemas: no cierre de pedidos, bonos adicionales, falta de pago a trav√©s de Apple Pay, etc.). <br><br>  Con el tiempo, hemos creado alertas y monitoreo para cada error importante como parte de la cultura de desarrollo.  Para evitar que esta cultura se pierda, la formalizamos un poco.  Para cada accidente, comenzaron a exigir un informe de ellos mismos.  Un informe es un formulario completo con respuestas a las siguientes preguntas: causa ra√≠z, m√©todo de eliminaci√≥n, impacto en el negocio, conclusiones.  Todos los art√≠culos son obligatorios.  Por lo tanto, si lo quieres o no, escribir√°s las conclusiones.  Este cambio de proceso, por supuesto, fue escrito por do's &amp; dont's. <br><br><h2>  7. Kotan </h2><br>    ,     ,    -,        .  - (  ,  )   ¬´¬ª.   ¬´¬ª.  :-) <br><br>  ¬´¬ª   : <br><br>  .          ‚Äî ,      .       ,   (  ),    (     )     ,        .      ( ,      ). <br><br>  .  ,    .   ,     :  ‚Äî   ,   ‚Äî   . , ¬´ 500-  1 %¬ª ‚Äî  .  ¬´ 500-  1 %,   - , - ,  - ¬ª ‚Äî  .         ,      .          (     ).         ,     :  ,   ¬´¬ª,   ,   ,    ,  .     ‚Äî     .      (  ,      ).      . <br><br> .      .        ,     (   ,     ,       ),   ,       :  ,  ,   , . <br><br>  .    ,   ,       ( ,   ). <br><br><h2> 8.      ? </h2><br>       ‚Äî  .    .  :   ,    .          ,    ,   .      ,  ,      , ..    ‚Äî  ,      ‚Äî !      ,     .           ,    ,  ?    ,       , .. ,    ,  . <br><br>           .      .     (    ,   ),    ,           :  ,  ,     ,   .     ,    ,        .          .           .       -,      ,    .    ,   ,      ,     ‚Äî   :          . <br><br><h2> 9.   </h2><br>      ,           . <br><br><table><tbody><tr><th>  ? </th><th>  ? </th></tr><tr><td>    . <br></td><td>        . <br></td></tr><tr><td>    (    )   post-mortem. <br></td><td>       . <br></td></tr><tr><td>    do's &amp; dont's. <br></td><td>     ,       ,   . <br></td></tr><tr><td>   ,    5 . <br></td><td>      . <br></td></tr><tr><td>        ,    . <br></td><td>      . <br></td></tr><tr><td>    . <br></td><td>      . <br></td></tr><tr><td>      <br></td><td>   . <br></td></tr><tr><td>       . <br></td><td>   . <br></td></tr><tr><td>        . <br></td><td>    . <br></td></tr><tr><td> SMS/IVR-  . <br></td><td>    . <br></td></tr><tr><td>   ( )    . <br></td><td>    . <br></td></tr><tr><td>    . <br></td><td>     -   . <br></td></tr><tr><td>    (   ‚Äî slow.log). <br></td><td>     - ¬´ ¬ª. <br></td></tr><tr><td>     . <br></td><td>       . <br></td></tr><tr><td>     . <br></td><td>        . <br></td></tr><tr><td>          . <br></td><td>   ,      ,         . <br></td></tr><tr><td> ¬´¬ª ‚Äî     . <br></td><td>   ,   . <br></td></tr><tr><td>  . <br></td><td>    . <br></td></tr></tbody></table><br>  ,    !       , , ,   ,    ! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/445704/">https://habr.com/ru/post/445704/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../445692/index.html">Descripci√≥n general de las caracter√≠sticas de PlayCanvas para crear aplicaciones Web VR</a></li>
<li><a href="../445696/index.html">C√≥mo se crean los robots que pueden ir a donde estamos</a></li>
<li><a href="../445698/index.html">Licencia de NanoCAD</a></li>
<li><a href="../445700/index.html">"33 palabras sobre dise√±o": qui√©n y por qu√© hace una pel√≠cula sobre dise√±o en Rusia</a></li>
<li><a href="../445702/index.html">SlowPochta: mensajero de entrega injustificada de mensajes con tiempo de reenv√≠o indefinido</a></li>
<li><a href="../445706/index.html">Intel GPU SGX: almacene sus datos en la tarjeta gr√°fica. Con una garantia</a></li>
<li><a href="../445708/index.html">UICollectionView alrededor de la cabeza: cambio de vistas sobre la marcha</a></li>
<li><a href="../445710/index.html">Equipo de gesti√≥n del clima</a></li>
<li><a href="../445712/index.html">Seis reglas para ayudarlo a alcanzar sus objetivos.</a></li>
<li><a href="../445714/index.html">El programa final de DUMP-2019 est√° listo. Nos encontramos el 19 de abril en Ekaterimburgo</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>