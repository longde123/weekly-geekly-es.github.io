<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø ü¶É üõê [Javawatch Live] La historia de una solicitud de extracci√≥n. `os.version` en SubstrateVM üöÆ ü§úüèª üë®üèº‚Äç‚öñÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ha pasado un a√±o desde que el truco anterior fue exitoso: publicar un video en YouTube en lugar de una publicaci√≥n. "Charla vergonzosa sobre singleton...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>[Javawatch Live] La historia de una solicitud de extracci√≥n. `os.version` en SubstrateVM</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/jugru/blog/420455/">  Ha pasado un a√±o desde que el truco anterior fue exitoso: publicar un video en YouTube en lugar de una publicaci√≥n.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">"Charla vergonzosa sobre singleton"</a> obtuvo 7k visitas en YouTube y el doble en Habr√© en la versi√≥n de texto.  Para un art√≠culo escrito en un estado completamente terco y que habla sobre el antiguo acorde√≥n de botones, esto es un poco exitoso. <br><br>  Hoy he estado instalando un nuevo lanzamiento toda la noche.  Esta vez, el tema es mucho m√°s reciente: la historia del compromiso con la tecnolog√≠a experimental: SubstrateVM.  Pero el grado de tenacidad ha aumentado a un nuevo nivel. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/f0nD_8G1uB0" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  Realmente espero sus comentarios!  Te recuerdo que si realmente quieres mejorar algo en esta publicaci√≥n, es mejor <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">archivarlo en Github</a> .  Me gustar√≠a decir "me gusta y suscribirme <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">al nuevo canal</a> , pero ¬øtodas sus versiones estar√°n en su centro Java de todos modos?" <br><br>  T√©cnicamente: el video tiene un pegado m√°s cerca del final.  Acabo de escribir un video sin comprimir, y mi m2 ssd de solo quinientos gigabytes de tama√±o se desbord√≥ r√°pidamente.  Y ning√∫n otro disco duro podr√≠a soportar tanta presi√≥n de datos.  Por lo tanto, tuve que desconectarme durante media hora y sal√≠ y encontr√© cincuenta conciertos adicionales para grabar los √∫ltimos minutos.  Esto se logr√≥ eliminando los archivos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">compilados por GoogleChrome</a> .  Escrib√≠ sobre el software de grabaci√≥n en el FB <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">justo en el momento de la grabaci√≥n</a> , hay mucho dolor. <br><br>  Otro de los t√©cnicamente interesantes: YouTube por alguna raz√≥n me bloque√≥ la transmisi√≥n en vivo.  Al mismo tiempo, no hay un solo golpe y estigma en la cuenta.  Esperemos que esto sea solo una jamba, y despu√©s de 90 d√≠as todo ser√° devuelto. <br><a name="habracut"></a><br><blockquote>  Este art√≠culo har√° referencia a un c√≥digo propiedad de Oracle.  No puede usar este c√≥digo para usted (a menos que lea la licencia original y lo permita bajo las condiciones de, por ejemplo, la GPL).  Esto no es una broma.  Olso, advert√≠. <br></blockquote><br><h1>  Prikazka (y un cuento de hadas estar√° por delante) </h1><br>  Muchos ya han escuchado historias de que "el nuevo Java se escribir√° en Java" y se preguntan c√≥mo podr√≠a ser esto.  Hay un documento de pol√≠tica del <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Proyecto Metr√≥polis</a> y una carta correspondiente de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">John Rose</a> , pero todo es bastante vago all√≠. <br><br>  Suena como una especie de magia espeluznante y sangrienta.  En la misma cosa que puedes probar en este momento, no solo no hay magia, sino que todo es est√∫pido como la parte posterior de una pala cuando te sacas los dientes con ella.  Por supuesto, hay algunos matices, pero esto ser√° alg√∫n d√≠a muy tarde. <br><br>  Lo mostrar√© en el ejemplo de una historia instructiva que sucedi√≥ en el verano.  C√≥mo escriben el ensayo "C√≥mo pas√© el verano" en las escuelas. <br><br>  Para comenzar un peque√±o comentario.  El proyecto que actualmente realiza la compilaci√≥n anticipada en Oracle Labs es GraalVM.  El componente que, de hecho, hace nishtyaki y convierte el c√≥digo Java en un archivo ejecutable (en un ejecutable) es SubstrateVM o SVM para abreviar.  No confunda esto con la misma abreviatura utilizada por los satanistas de datos (m√°quina de vectores de soporte).  Eso es sobre SVM, como parte clave, hablaremos m√°s. <br><br><h1>  Declaraci√≥n del problema. </h1><br>  Entonces, "c√≥mo pas√© el verano".  Me sent√© de vacaciones, pas√© dos F5 en el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">github</a> del <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Grial</a> y me encontr√© con <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">este</a> : <br><br><img src="https://habrastorage.org/webt/uy/pg/ig/uypgig4krayn8dmvfzif_rd3em0.png"><br><br>  Una persona quiere que <code>os.version</code> d√© el valor correcto. <br><br>  Bueno cho, ¬øquer√≠a arreglar el error?  El ni√±o dijo, el ni√±o hizo. <br><br>  Vamos a verificar si nuestro cliente est√° mintiendo. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Main</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span></span>{ System.out.println(System.getProperty(<span class="hljs-string"><span class="hljs-string">"os.version"</span></span>)); } }</code> </pre><br>  Primero, c√≥mo se ve el escape en Java real: <code>4.15.0-32-generic</code> .  S√≠, esto es Ubuntu LTS Bionic nuevo. <br><br>  Ahora intenta hacer lo mismo en SVM: <br><br><pre> <code class="bash hljs">$ ls Main.java $ javac -cp . Main.java $ ls Main.class Main.java $ native-image Main Build on Server(pid: 18438, port: 35415) classlist: 151.77 ms (<span class="hljs-built_in"><span class="hljs-built_in">cap</span></span>): 1,662.32 ms setup: 1,880.78 ms error: Basic header file missing (&lt;zlib.h&gt;). Make sure libc and zlib headers are available on your system. Error: Processing image build request failed</code> </pre><br>  Pues si.  Esto se debe a que hice una m√°quina virtual completamente nueva espec√≠ficamente para la prueba "limpia". <br><br><pre> <code class="bash hljs">$ sudo apt-get install zlib1g-dev libc6 libc6-dev $ native-image Main Build on Server(pid: 18438, port: 35415) classlist: 135.17 ms (<span class="hljs-built_in"><span class="hljs-built_in">cap</span></span>): 877.34 ms setup: 1,253.49 ms (typeflow): 4,103.97 ms (objects): 1,441.97 ms (features): 41.74 ms analysis: 5,690.63 ms universe: 252.43 ms (parse): 1,024.49 ms (inline): 819.27 ms (compile): 4,243.15 ms compile: 6,356.02 ms image: 632.29 ms write: 236.99 ms [total]: 14,591.30 ms</code> </pre><br>  Las cifras absolutas de tiempo de ejecuci√≥n pueden ser horribles.  Pero, en primer lugar, eso es lo que se pretend√≠a hacer: aqu√≠ se aplican optimizaciones muy infernales.  Y en segundo lugar, esta es una m√°quina virtual fr√°gil que desea. <br><br>  Y finalmente, el momento de la verdad: <br><br><pre> <code class="hljs cs">$ ./main <span class="hljs-literal"><span class="hljs-literal">null</span></span></code> </pre><br>  Parece que nuestro invitado no minti√≥, realmente no funciona. <br><br><h1>  Primer enfoque: robar propiedades del host </h1><br>  Luego busqu√© en <code>os.version</code> global <code>os.version</code> y descubr√≠ que todas estas propiedades est√°n en la clase <code>SystemPropertiesSupport</code> . <br><br>  No escribir√© la ruta completa al archivo, porque la capacidad de generar los proyectos correctos para IntelliJ IDEA y Eclipse est√° integrada directamente en SVM.  Esto es muy bueno y no recuerda en absoluto el tormento que la mayor√≠a de OpenJDK tiene que experimentar.  Deje que el IDE abra clases para nosotros.  Entonces <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SystemPropertiesSupport</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String[] HOSTED_PROPERTIES = { <span class="hljs-string"><span class="hljs-string">"java.version"</span></span>, ImageInfo.PROPERTY_IMAGE_KIND_KEY, <span class="hljs-string"><span class="hljs-string">"line.separator"</span></span>, <span class="hljs-string"><span class="hljs-string">"path.separator"</span></span>, <span class="hljs-string"><span class="hljs-string">"file.separator"</span></span>, <span class="hljs-string"><span class="hljs-string">"os.arch"</span></span>, <span class="hljs-string"><span class="hljs-string">"os.name"</span></span>, <span class="hljs-string"><span class="hljs-string">"file.encoding"</span></span>, <span class="hljs-string"><span class="hljs-string">"sun.jnu.encoding"</span></span>, }; <span class="hljs-comment"><span class="hljs-comment">//... }</span></span></code> </pre><br>  Luego, sin incluir mi cabeza en absoluto, simplemente <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">fui y agregu√©</a> otra variable a este conjunto: <br><br><pre> <code class="java hljs"><span class="hljs-string"><span class="hljs-string">"os.arch"</span></span>, <span class="hljs-string"><span class="hljs-string">"os.name"</span></span>, <span class="hljs-string"><span class="hljs-string">"os.version"</span></span></code> </pre><br>  Reconstruyo, corro, obtengo la codiciada l√≠nea <code>4.15.0-32-generic</code> .  ¬°Hurra! <br><br>  Pero aqu√≠ est√° el problema: ahora en <em>cada</em> m√°quina donde se ejecuta este c√≥digo, siempre emite <code>4.15.0-32-generic</code> .  Incluso donde <code>uname -a</code> devuelve la versi√≥n anterior del cubo, en el viejo Ubunt. <br><br>  Queda claro que estas variables se escriben en el archivo fuente en el momento de la compilaci√≥n. <br>  Y realmente, necesitas leer cuidadosamente los comentarios: <br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/** System properties that are taken from the VM hosting the image generator. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String[] HOSTED_PROPERTIES</code> </pre><br>  Otros m√©todos deben ser aplicados. <br><br><h2>  Conclusiones </h2><br><ul><li>  Si desea que una propiedad del sistema de "Java principal" aparezca en SVM, esto es muy simple.  Escribimos la propiedad deseada en el lugar correcto, eso es todo. </li><li>  Puede trabajar en el IDE, que admite Java y Python al mismo tiempo.  Por ejemplo, en IntelliJ IDEA Ultimate con un complemento de Python o el mismo en Eclipse. </li></ul><br><h1>  Segundo enfoque </h1><br>  Si revisa el <code>SystemPropertiesSupport</code> SystemPropertiesSupport, encontramos algo mucho m√°s razonable: <br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/** System properties that are lazily computed at run time on first access. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Map&lt;String, Supplier&lt;String&gt;&gt; lazyRuntimeValues;</code> </pre><br>  Entre otras cosas, el uso de estas propiedades a√∫n no bloquea el proceso de construcci√≥n de un ejecutable.  Est√° claro que si nos <code>HOSTED_PROPERTIES</code> mucho en <code>HOSTED_PROPERTIES</code> , entonces todo se ralentizar√°. <br><br>  El registro de propiedades diferidas se produce de manera obvia, por referencia a un m√©todo que devuelve: <br><br><pre> <code class="hljs kotlin">lazyRuntimeValues.put(<span class="hljs-string"><span class="hljs-string">"user.name"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>::userNameValue); lazyRuntimeValues.put(<span class="hljs-string"><span class="hljs-string">"user.home"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>::userHomeValue); lazyRuntimeValues.put(<span class="hljs-string"><span class="hljs-string">"user.dir"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>::userDirValue);</code> </pre><br>  Adem√°s, todas estas referencias de m√©todos son interfaces, y lo mismo <code>this::userDirValue</code> se implementa para cada una de las plataformas compatibles.  En este caso, estos son <code>PosixSystemPropertiesSupport</code> y <code>WindowsSystemPropertiesSupport</code> . <br><br>  Si vamos por curiosidad a una implementaci√≥n para Windows, veremos lo triste: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">userDirValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"C:\\Users\\somebody"</span></span>; }</code> </pre><br>  Como puede ver, Windows a√∫n no es compatible :-) Sin embargo, el verdadero problema es que la generaci√≥n de ejecutables para Windows a√∫n no se ha completado, por lo que admitir estos m√©todos ser√≠a un esfuerzo completamente innecesario. <br><br>  Es decir, debe implementar el siguiente m√©todo: <br><br><pre> <code class="java hljs">lazyRuntimeValues.put(<span class="hljs-string"><span class="hljs-string">"os.version"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>::osVersionValue);</code> </pre><br>  Y luego admitirlo en dos o tres interfaces disponibles. <br><br>  ¬øPero qu√© escribir all√≠? <br><br><h2>  Conclusiones </h2><br><ul><li>  Si desea agregar una nueva propiedad que se calcula en tiempo de ejecuci√≥n, entonces se trata de escribir un m√©todo.  El resultado puede depender del sistema operativo actual, el mecanismo de conmutaci√≥n ya est√° funcionando y no pregunta. </li></ul><br><h1>  Un poco de arqueolog√≠a </h1><br>  Lo primero que viene a la mente es echar un vistazo a una implementaci√≥n en OpenJDK y copiar y pegar descaradamente.  ¬°Un poco de arqueolog√≠a y saqueo nunca impedir√° a un valiente explorador! <br><br>  Si√©ntase libre de abrir cualquier proyecto Java en la Idea, escriba <code>System.getProperty("os.version")</code> y, mediante ctrl + clic, vaya a la implementaci√≥n del m√©todo <code>getProperty()</code> .  Resulta que todo esto est√∫pidamente reside en las <code>Properties</code> . <br><br>  Al parecer, solo copie y pegue el lugar donde se llenan estas <code>Properties</code> , y ri√©ndose fervientemente, huya al vac√≠o.  Desafortunadamente, nos encontramos con un problema: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">native</span></span></span><span class="hljs-function"> Properties </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initProperties</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Properties props)</span></span></span></span>;</code> </pre><br>  Noooooooooooooo. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d4d/ca9/698/d4dca9698ffccaf0de2944194698e857.gif"><br><br>  Pero todo comenz√≥ muy bien. <br><br><h1>  ¬øHab√≠a un ni√±o? </h1><br>  Como sabemos, usar C ++ es malo.  ¬øSe usa C ++ en SVM? <br><br>  Solo asi!  Incluso hay un paquete especial para esto: <code>src/com.oracle.svm.native</code> . <br><br>  Y en este paquete, horror-horror, se encuentra el archivo <code>getEnviron.c</code> con algo como esto: <br><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> **environ; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">char</span></span></span><span class="hljs-function"> **</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getEnviron</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> environ; }</code> </pre><br><h1>  Es hora de meterse con C ++ </h1><br>  Ahora sum√©rgete un poco m√°s y abre las fuentes completas de OpenJDK. <br><br>  Si alguien a√∫n no los tiene, puede <a href="">buscarlos en la web</a> o descargarlos.  Te lo advierto, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">est√°n</a> oscilando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">desde aqu√≠</a> , todav√≠a con la ayuda de Mercurial, y a√∫n as√≠ llevar√° aproximadamente media hora. <br><br>  El archivo que necesitamos est√° en <code>src/java.base/share/native/libjava/System.c</code> . <br><br>  ¬øNot√≥ que esta es la ruta al archivo, y no solo el nombre?  As√≠ es, puede empujar su nueva y brillante Idea de moda, comprada por $ 200 al a√±o.  Puede <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">probar CLion</a> , pero para evitar da√±os mentales irreversibles, es mejor simplemente tomar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Visual Studio Code</a> .  √âl ya resalta algo, pero a√∫n no entiende lo que vio (no tacha todo en rojo). <br><br>  Breve recuento de <code>System.c</code> : <br><br><pre> <code class="hljs lisp">java_props_t *sprops = GetJavaProperties(<span class="hljs-name"><span class="hljs-name">env</span></span>)<span class="hljs-comment"><span class="hljs-comment">; PUTPROP(props, "os.version", sprops-&gt;os_version);</span></span></code> </pre><br>  A su vez, se toman en <code>src/java.base/unix/native/libjava/java_props_md.c</code> . <br>  Cada plataforma tiene su propio archivo, cambian a trav√©s de <code>#define</code> . <br><br>  Y aqu√≠ comienza.  Hay muchas plataformas  Cualquier necrofilia como AIX se puede puntuar, porque GraalVM no lo admite oficialmente (hasta donde yo s√©, GNU-Linux, macOS y Windows est√°n planeados al principio).  GNU / Linux y Windows admiten el uso de <code>&lt;sys/utsname.h&gt;</code> , que tiene m√©todos predefinidos para obtener el nombre y la versi√≥n del sistema operativo. <br><br>  Pero macOS tiene una <a href="">terrible pieza de govnokod</a> . <br><br><ul><li>  El nombre "Mac OS X" est√° recubierto (aunque ha sido macOS durante mucho tiempo); </li><li>  Depende de la versi√≥n de makoshi.  Antes de 10.9, el SDK no ten√≠a una funci√≥n <code>operatingSystemVersion</code> , y ten√≠a que leer <code>SystemVersion.plist</code> mano; </li><li>  Para esta sustracci√≥n, usa la extensi√≥n ObjC algo como esto: </li></ul><br><pre> <code class="objectivec hljs"><span class="hljs-comment"><span class="hljs-comment">// Fallback if running on pre-10.9 Mac OS if (osVersionCStr == NULL) { NSDictionary *version = [NSDictionary dictionaryWithContentsOfFile : @"/System/Library/CoreServices/SystemVersion.plist"]; if (version != NULL) { NSString *nsVerStr = [version objectForKey : @"ProductVersion"]; if (nsVerStr != NULL) { osVersionCStr = strdup([nsVerStr UTF8String]); } } }</span></span></code> </pre><br>  Si inicialmente hubo una idea de reescribir esto manualmente en un buen estilo, entonces r√°pidamente se convirti√≥ en realidad.  ¬øQu√© pasa si estoy jugando en alg√∫n lugar en la jungla de estos fideos de ifs, alguien lo romper√° y me colgar√°n en la plaza central?  Bueno nafig.  <strong>Es necesario copiar y pegar.</strong> <br><br><h2>  Conclusiones </h2><br><ul><li>  IDE no es necesario; </li><li>  Cualquier comunicaci√≥n con C ++ es dolorosa, desagradable, no se entiende a primera vista. </li></ul><br><h1>  Copiar y pegar es la norma? </h1><br>  Este es un tema importante del que depend√≠a la cantidad de tormento adicional.  Realmente no quer√≠a volver a escribir manualmente, pero llegar a los tribunales por violar las licencias es a√∫n peor.  As√≠ que fui al github y le pregunt√© a Codrut Stancu al respecto directamente.  Aqu√≠ est√° lo que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">respondi√≥</a> : <br><br>  <em>¬ªReutilizar el c√≥digo OpenJDK, por ejemplo, copiar y pegar es algo normal desde el punto de vista de las licencias.</em>  <em>Sin embargo, hay una muy buena raz√≥n para esto.</em>  <em>Si se puede implementar una caracter√≠stica reutilizando el c√≥digo JDK sin copiar, por ejemplo, parche√°ndolo con sustituci√≥n, ser√° mucho mejor ".</em> <br><br>  ¬°Eso suena como un permiso oficial de copiar y pegar! <br><br><h1>  Hablamos normalmente ... </h1><br>  Comenc√© a portar este c√≥digo, pero me encontr√© con mi pereza.  Para probar macOS para diferentes versiones, debe encontrar al menos uno con el 10.8 Mountain Lion necr√≥filo.  Tengo dos de mis dispositivos Apple disponibles y uno de un amigo, adem√°s puedo implementarlo en alguna VMWare de prueba. <br><br>  Pero la pereza.  Y esta pereza me salv√≥. <br><br>  Fui a la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">sala de chat</a> y le pregunt√© a Chris Seaton qu√© cadena de herramientas es la m√°s adecuada para el ensamblaje.  Qu√© versi√≥n del sistema operativo es compatible, compilador de C ++, etc. <br><br>  En respuesta, recibi√≥ un silencio sorprendido del chat y Chris respondi√≥ que no entend√≠a la esencia del problema. <br><br>  Tom√≥ un poco de tiempo antes de que Chris pudiera darse cuenta de lo que quer√≠a hacer, y le ped√≠ que <strong>nunca lo volviera a hacer</strong> . <br><blockquote>  Eso realmente extra√±a la idea de SVM.  SVM es Java puro, no se supone que tenga c√≥digo puesto desde OpenJDK.  Puede leerlo, convertirlo a Java, pero nadie quiere el c√≥digo C ++ de OpenJDK.  Eso es lo √∫ltimo que queremos. <br></blockquote><br>  El ejemplo de las bibliotecas de matem√°ticas no lo convenci√≥.  Como m√≠nimo, est√°n escritos en C, y la inclusi√≥n de C ++ significar√≠a conectar un lenguaje completamente nuevo a la base del c√≥digo.  Y uno que es fufufu. <br><br>  Que necesitas hacer  Escribir en el <strong>sistema Java</strong> . <br><br>  Y si no se pueden evitar las llamadas al SDK de la plataforma C / C ++, entonces esta deber√≠a ser una sola llamada al sistema envuelta en la API de C.  Los datos se extraen en Java y luego la l√≥gica empresarial se escribe estrictamente en Java, incluso si Platform SDK tiene formas convenientes y listas para hacerlo de manera diferente en el lado de C ++. <br><br>  Suspir√© y comenc√© a estudiar el c√≥digo fuente para comprender c√≥mo se puede hacer esto de manera diferente. <br><br><h2>  Conclusiones </h2><br><ul><li>  Hable con las personas en el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">chat sobre</a> cualquier detalle oscuro.  Responden si las preguntas no son completamente idiotas.  Aunque este ejemplo muestra que Chris est√° listo para discutir cuestiones idiotas, incluso si esto no le ahorra su tiempo personalmente; </li><li>  C ++ no est√° presente en el proyecto en absoluto.  No hay raz√≥n para creer que alguien lo dejar√° arrastrarlo debajo del piso; </li><li>  En cambio, debe escribir en Java del sistema utilizando C como √∫ltimo recurso (por ejemplo, al llamar al SDK de la plataforma). </li></ul><br><h1>  No se necesita violinista </h1><br><blockquote>  No se necesita un violinista, querido.  √âl solo come exceso de combustible. <br></blockquote><br>  Luego me sent√≠ abrumado por la tristeza, porque mira aqu√≠.  Si en Windows tenemos <code>&lt;sys/utsname.h&gt;</code> , y esperamos est√∫pidamente su respuesta, es f√°cil y simple. <br><br>  Pero si √©l no est√° all√≠, ¬øqu√© habr√° que hacer? <br><br><ul><li>  ¬øLlamar a los comandos integrados de cmd o a las utilidades de Windows?  Emisi√≥n de texto en ruso que debe analizarse.  Este es el fondo, y puede que no coincida con lo que el OpenJDK real responder√° en este lugar. </li><li>  ¬øTomar del registro?  Incluso aqu√≠ hay matices, por ejemplo, al cambiar de Windows 7 a 10, el m√©todo de almacenamiento de n√∫meros digitales en el Registro cambi√≥, y en Windows 10 debe pegar las manos de los componentes principales y secundarios, o simplemente responder que es Windows 10 con un d√≠gito.  No est√° claro cu√°l de estos m√©todos es m√°s correcto (no har√° que los usuarios se arrepientan). </li></ul><br>  Afortunadamente, mi angustia fue <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">interrumpida por la</a> b√∫squeda de extracci√≥n de Paul Woegerer, que lo arregl√≥ todo. <br><br>  Curiosamente, al principio todo se repar√≥ en el asistente (la <code>os.version</code> dej√≥ de ser <code>null</code> en la prueba), y solo entonces not√© una solicitud de extracci√≥n.  El problema es que este commit no est√° marcado en el github como pullrequest; es un commit simple con la inscripci√≥n <code>PullRequest: graal/1885</code> en el comentario.  El hecho es que los tipos de Oracle Labs no usan Github, solo lo necesitan para interactuar con los encargados externos.  Todos los que no tuvimos la suerte de trabajar en Oracle Labs debemos suscribirnos a las notificaciones de nuevos compromisos en el repositorio y leerlos todos. <br><br>  Pero ahora puede relajarse y ver c√≥mo implementar esta funci√≥n <em>correctamente</em> . <br><br>  Veamos qu√© tipo de bestia es esta, System Java. <br><br>  Como dije antes, todo es simple, como la parte posterior de una pala, cuando intentan sacarte los dientes.  E igual de doloroso.  Echa un vistazo a la cita del grupo: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">osVersionValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (osVersionValue != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> osVersionValue; } <span class="hljs-comment"><span class="hljs-comment">/* On OSX Java returns the ProductVersion instead of kernel release info. */</span></span> CoreFoundation.CFDictionaryRef dict = CoreFoundation._CFCopyServerVersionDictionary(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dict.isNull()) { dict = CoreFoundation._CFCopySystemVersionDictionary(); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dict.isNull()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> osVersionValue = <span class="hljs-string"><span class="hljs-string">"Unknown"</span></span>; } CoreFoundation.CFStringRef dictKeyRef = DarwinCoreFoundationUtils.toCFStringRef(<span class="hljs-string"><span class="hljs-string">"MacOSXProductVersion"</span></span>); CoreFoundation.CFStringRef dictValue = CoreFoundation.CFDictionaryGetValue(dict, dictKeyRef); CoreFoundation.CFRelease(dictKeyRef); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dictValue.isNull()) { dictKeyRef = DarwinCoreFoundationUtils.toCFStringRef(<span class="hljs-string"><span class="hljs-string">"ProductVersion"</span></span>); dictValue = CoreFoundation.CFDictionaryGetValue(dict, dictKeyRef); CoreFoundation.CFRelease(dictKeyRef); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dictValue.isNull()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> osVersionValue = <span class="hljs-string"><span class="hljs-string">"Unknown"</span></span>; } osVersionValue = DarwinCoreFoundationUtils.fromCFStringRef(dictValue); CoreFoundation.CFRelease(dictValue); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> osVersionValue; }</code> </pre><br>  En otras palabras, escribimos en Java palabra por palabra lo que escribir√≠amos en C. <br><br>  <code>DarwinExecutableName</code> a c√≥mo <code>DarwinExecutableName</code> escribe <code>DarwinExecutableName</code> : <br><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Object </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">apply</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object[] args)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/* Find out how long the executable path is. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> CIntPointer sizePointer = StackValue.get(CIntPointer.class); sizePointer.write(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (DarwinDyld._NSGetExecutablePath(WordFactory.nullPointer(), sizePointer) != -<span class="hljs-number"><span class="hljs-number">1</span></span>) { VMError.shouldNotReachHere(<span class="hljs-string"><span class="hljs-string">"DarwinExecutableName.getExecutableName: Executable path length is 0?"</span></span>); } <span class="hljs-comment"><span class="hljs-comment">/* Allocate a correctly-sized buffer and ask again. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] byteBuffer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[sizePointer.read()]; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> (PinnedObject pinnedBuffer = PinnedObject.create(byteBuffer)) { <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> CCharPointer bufferPointer = pinnedBuffer.addressOfArrayElement(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (DarwinDyld._NSGetExecutablePath(bufferPointer, sizePointer) == -<span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-comment"><span class="hljs-comment">/* Failure to find executable path. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String executableString = CTypeConversion.toJavaString(bufferPointer); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String result = realpath(executableString); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } }</code> </pre><br>  Todos estos <code>CIntPointer</code> , <code>CCharPointer</code> , <code>PinnedObject</code> , qu√©. <br><br>  Para mi gusto, esto es inc√≥modo y feo.  Debe trabajar manualmente con punteros que parecen clases de Java.  Debe llamar a la <code>release</code> correspondiente a tiempo para que no se pierda la memoria. <br><br>  Pero si le parece que estas son medidas <em>injustificadas</em> , puede volver a mirar la <a href="">implementaci√≥n de GC en .NET</a> y horrorizarse de lo que lleva C ++ si no se detiene a tiempo.  Les recuerdo que este es un gran archivo CPP m√°s grande que un megabyte.  Hay <a href="">algunas descripciones de</a> su trabajo, pero son claramente insuficientes para que un colaborador externo las entienda.  El c√≥digo anterior, aunque de aspecto desagradable, es bastante comprensible y se analiza mediante an√°lisis est√°tico para Java. <br><br>  En cuanto a la esencia del compromiso, tengo preguntas para √©l.  Y al menos el soporte de Windows no est√° implementado all√≠.  Cuando aparezca un codegen para Windows, intentar√© asumir esta tarea. <br><br><h2>  Conclusiones </h2><br><ul><li>  Necesito escribir en System Java.  Alabado sea el pan dulce.  Todav√≠a no hay opciones; </li><li>  Suscr√≠base a las notificaciones del repositorio en GitHub y lea las confirmaciones; de lo contrario, pasar√°n por alto importantes relaciones p√∫blicas; </li><li>  Si es posible, pregunte sobre cualquier caracter√≠stica importante de los responsables de esta √°rea.  Hay muchas cosas que se implementan, pero a√∫n no son conocidas por el p√∫blico en general.  Existe la posibilidad de inventar una bicicleta, y mucho peor que la hecha por los muchachos de Oracle Labs; </li><li>  Al abordar una funci√≥n, aseg√∫rese de informar a la persona responsable en el github.  Si no responde, escriba una carta, las direcciones de todos los miembros del equipo se pueden buscar f√°cilmente en Google. </li></ul><br><h1>  Ep√≠logo </h1><br>  Esta batalla termina, pero no la guerra en absoluto. <br><br>  ¬°Luchador, espera con delicadeza nuevos art√≠culos sobre Habr√© y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">entra en nuestras filas</a> ! <br><br>  Quiero recordarles que Oleg Shelaev, el √∫nico evangelista <strong>oficial de</strong> GraalVM de Oracle, vendr√° a la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">pr√≥xima conferencia de Joker</a> .  No solo "el √∫nico hablante ruso", sino "el √∫nico en general".  El t√≠tulo del informe ( <em><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">"Compilaci√≥n de Java por adelantado con GraalVM"</a></em> ) sugiere que SubstrateVM no puede prescindir. <br><br>  Por cierto, Oleg recibi√≥ recientemente un arma de servicio: una cuenta en Habr√©, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">shelajev-oleg</a> .  Todav√≠a no hay publicaciones all√≠, pero puedes enviar este nombre de usuario. <br><br>  Puedes hablar con Oleg y Oleg en nuestra sala de chat-chat en Telegram: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">@graalvm_ru</a> .  A diferencia de ishshuyev en Github, all√≠ puede comunicarse de cualquier forma, y ‚Äã‚Äãnadie ser√° prohibido ( <em>pero esto no es exacto</em> ). <br><br>  Tambi√©n les recuerdo que cada semana, junto con el podcast Debriefing, hacemos el lanzamiento de Java Digest.  Por ejemplo, este fue el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">√∫ltimo resumen</a> .  De vez en cuando, las noticias sobre GraalVM pasan por alto (de hecho, no convierto todo el tema en un comunicado de prensa de GraalVM solo por respeto a la audiencia :-) <br><br>  Gracias por leer esto, ¬°y hasta pronto! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es420455/">https://habr.com/ru/post/es420455/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es420441/index.html">Los 10 errores de seguridad m√°s comunes en Python y c√≥mo evitarlos</a></li>
<li><a href="../es420443/index.html">Los expertos en ciberseguridad han creado un detector de skimmer - SkimReaper</a></li>
<li><a href="../es420447/index.html">Computer History Museum: el lugar donde se registra la TI</a></li>
<li><a href="../es420451/index.html">Servidor en las nubes: prepar√°ndose para lanzar</a></li>
<li><a href="../es420453/index.html">Seminarios web de Skillbox Friday: desarrollo y todo lo relacionado</a></li>
<li><a href="../es420457/index.html">Descripci√≥n general del software de impresi√≥n 3D Simplify3D</a></li>
<li><a href="../es420459/index.html">Icono con un contador en la barra de herramientas superior: un ejemplo de una variedad de enfoques para una tarea</a></li>
<li><a href="../es420461/index.html">10 citas de malos dise√±adores</a></li>
<li><a href="../es420463/index.html">ICO merecidamente en declive, pero tienen la oportunidad de cambiar</a></li>
<li><a href="../es420465/index.html">Variables Nginx con njs: simple, indoloro y a trav√©s de JavaScript</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>