<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü¶É üé≤ ü§úüèΩ Cara membuat ekstensi di PHP7 lebih sulit daripada "halo, dunia", dan tidak menjadi mata merah. Bagian 1 ü§¥üèª ü•¶ ü§Ωüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Mengapa 
 Saya menulis artikel ini sehingga jalur yang saya ambil total setidaknya satu tahun, pembaca bisa berjalan dalam beberapa jam. Seperti yang ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Cara membuat ekstensi di PHP7 lebih sulit daripada "halo, dunia", dan tidak menjadi mata merah. Bagian 1</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/428626/"><h2>  Mengapa </h2><br>  Saya menulis artikel ini sehingga jalur yang saya ambil total setidaknya satu tahun, pembaca bisa berjalan dalam beberapa jam.  Seperti yang ditunjukkan oleh pengalaman pribadi saya, hanya pemrograman dalam C sedikit lebih mudah daripada membuat ekstensi serius untuk pekerjaan PHP.  Di sini saya akan memberi tahu Anda sebanyak mungkin tentang cara membuat ekstensi menggunakan contoh perpustakaan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">libtrie</a> yang mengimplementasikan pohon awalan, lebih dikenal sebagai trie.  Saya akan menulis dan secara bersamaan melakukan tindakan yang dijelaskan pada sistem Lubuntu 18.04 yang baru diinstal. <br><br>  Mari kita mulai. <br><a name="habracut"></a><br><h2>  Instalasi perangkat lunak </h2><br><h4>  Php </h4><br><ol><li>  Pertama kita meletakkan paket php7.2-dev, di dalamnya diperlukan skrip phpize untuk membangun ekstensi.  Selain itu, kita membutuhkan versi php yang berfungsi, di mana kita akan memeriksa ekstensi kita.  Menginstal paket ini akan menarik sejumlah paket tergantung, kami meletakkan semua yang ditawarkan. <br><br><pre><code class="bash hljs">sudo apt install php7.2-dev</code> </pre> <br></li><li>  Kami pergi ke situs web php.net, pergi ke bagian unduhan dan menarik tautan ke arsip dengan versi stabil terbaru dari php, sekarang versi 7.2.11. <br>  Unduh arsip sumber php: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /tmp &amp;&amp; wget http://it2.php.net/get/php-7.2.11.tar.gz/from/this/mirror -O php7.tar.gz</code> </pre><br></li><li>  Sekarang buka arsipnya sendiri: <br><br><pre> <code class="bash hljs">sudo tar -xvf php7.tar.gz -C /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/src</code> </pre><br></li></ol><br><h4>  Editor Kode </h4><br>  Saya biasanya menggunakan 2 editor kode.  Simpel dan cepat, cepat, dan sangat kutu buku, tetapi sangat canggih dari JetBrains.  Geany menginstal dari lobak standar Ubuntu. <br><br><pre> <code class="bash hljs">sudo apt install geany</code> </pre><br>  Unduh Clion dari situs web JetBrains resmi: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/Downloads &amp;&amp; wget https://download.jetbrains.com/cpp/CLion-2018.2.5.tar.gz -O clion.tar.gz</code> </pre><br><pre> <code class="bash hljs">sudo tar -xvf clion.tar.gz -C /usr/share</code> </pre><br>  Mari buat tautan untuk membuatnya nyaman untuk menjalankan clion dari konsol. <br><br><pre> <code class="bash hljs">sudo ln -s /usr/share/clion-2018.2.5/bin/clion.sh /usr/bin/clion</code> </pre><br>  Setelah peluncuran pertama, clion sendiri akan membuat pintasan untuk dirinya sendiri dari menu shell LXpanel, tetapi pertama kali Anda perlu menjalankannya dengan tangan. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># clion</span></span></code> </pre><br><h2>  Buat ekstensi </h2><br>  Di sini kami memiliki setidaknya 3 opsi: <br><br><ol><li>  Ambil cakram standar mentah dari sumber php yang kami unduh. </li><li>  Melihat disk standar sedikit dengan skrip ext_skel khusus </li><li>  Dapatkan cakram minimalis yang bagus <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">dari sini</a> . </li></ol><br>  Saya paling suka opsi ketiga, tetapi saya akan menggunakan yang kedua, jika gagal, untuk meminimalkan jumlah tempat di mana saya bisa salah.  Meskipun memilih yang kosong dari pengembang masih menyenangkan :-) <br><br><ol><li>  Mari kita pergi ke direktori dengan ekstensi php standar. <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/src/php-7.2.11/ext</code> </pre><br>  Selain nama skrip, Anda dapat menentukan beberapa parameter ekstensi melalui file proto.  Semua ini tidak bisa dilakukan.  Saya akan melakukan semuanya dengan tangan, tetapi saya akan menunjukkan cara kerja proto.  Kami melakukan trie, jadi beri nama ekstensi kami libtrie.  Untuk bekerja di direktori / usr / local / src, Anda memerlukan hak administrator, agar tidak berakhir dengan menulis sudo, saya akan menyertakan bash dengan izin yang lebih tinggi. <br><br><pre> <code class="bash hljs">sudo bash</code> </pre><br></li><li>  Di sini saya akan menetapkan parameter hanya 1 fungsi yang akan diterapkan oleh ekstensi yang dibuat.  Ini hanya fungsi demo untuk menunjukkan bagaimana ini dilakukan. <br><br>  Kami akan melakukan analog penuh dari fungsi standar <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">array</span></span> array_fill ( int $start_index , int $num , mixed $value )</code> </pre><br>  Sintaks dalam file proto sangat sederhana, Anda hanya perlu menentukan nama fungsi.  Saya akan menulis sedikit lagi agar terlihat lebih informatif. <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> my_array_fill \( int start_index , int num , mixed value \) &gt;&gt; libtrie.proto</code> </pre><br></li><li>  Sekarang jalankan skrip ext_skel, berikan nama ekstensi dan file proto yang kami buat. <br><br><pre> <code class="bash hljs">./ext_skel --extname=libtrie --proto=./libtrie.proto</code> </pre><br></li><li>  Kami telah membuat direktori dengan ekstensi kami.  Mari kita membahasnya. <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> libtrie</code> </pre><br></li></ol><br><h4>  Struktur file dan prinsip perakitan </h4><br><div class="spoiler">  <b class="spoiler_title">Struktur file</b> <div class="spoiler_text"><pre> <code class="bash hljs">config.m4 -           phpize   ./configure,       makefile. CREDITS -  ,     ,    libtrie.c -      php_libtrie.h -     config.w32 -        windows EXPERIMENTAL -  .    ,    . libtrie.php -  php      . tests -  </code> </pre><br></div></div><br>  Untuk berhasil membangun ekstensi, Anda hanya perlu 3 file.  Pada disk ekstensi yang minimalis, yang saya sebutkan di atas, hanya ada 3 file. <br><br><pre> <code class="bash hljs">config.m4 php_libtrie.h libtrie.c</code> </pre><br>  Saya tidak suka penamaan standar yang diterima di php, saya suka file header dan file dengan badan program diberi nama yang sama.  Oleh karena itu ganti nama <br> <code>libtrie.c</code> <br>  masuk <br> <code>php_libtrie.c</code> <br> <br><pre> <code class="bash hljs">mv libtrie.c php_libtrie.c</code> </pre><br><h4>  Mengedit config.m4 </h4><br>  File config.m4 default benar-benar dijejali dengan konten, yang kelimpahannya membingungkan dan membingungkan.  Seperti yang saya katakan, file ini diperlukan untuk membentuk skrip konfigurasi.  Baca lebih lanjut tentang ini di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">sini</a> . <br><br><pre> <code class="bash hljs">geany config.m4 &amp;</code> </pre><br>  Kami hanya menyisakan ini: <br><br><pre> <code class="bash hljs">PHP_ARG_ENABLE(libtrie, whether to <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> libtrie support, [ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-libtrie Enable libtrie support]) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$PHP_LIBTRIE</span></span></span><span class="hljs-string">"</span></span> != <span class="hljs-string"><span class="hljs-string">"no"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-comment"><span class="hljs-comment">#    -    # PHP_ADD_INCLUDE() #   PHP_NEW_EXTENSION(libtrie, php_libtrie.c, $ext_shared) # PHP_NEW_EXTENSION(libtrie, php_libtrie.c, $ext_shared,, -DZEND_ENABLE_STATIC_TSRMLS_CACHE=1) fi</span></span></code> </pre><br><img src="https://habrastorage.org/webt/mb/fz/y_/mbfzy_te6ilmvy8oelvaf91_g20.png"><br><br>  Makro pertama menciptakan kemampuan untuk mengaktifkan dan menonaktifkan ekstensi kami saat menjalankan skrip konfigurasi yang dihasilkan. <br><br>  Blok kedua adalah yang paling penting, menentukan file mana yang akan dikompilasi sebagai bagian dari ekstensi kita, apakah ekstensi akan terhubung secara dinamis melalui file .so, atau apakah ekstensi akan statis dan akan diintegrasikan selama pembuatan php.  Kita akan menjadi dinamis. <br>  Simpan file. <br><br>  Kami menyalin file ke direktori pengguna sehingga tidak berfungsi dalam mode root. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#    exit</span></span></code> </pre><br>  Salin: <br><br><pre> <code class="bash hljs">cp /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/src/php-7.2.11/ext/libtrie ~/Documents/ -r</code> </pre><br><h3>  Fungsi demo </h3><br>  Biarkan saya mengingatkan Anda bahwa kami akan melakukan analog penuh array_fill ().  Saya akan bekerja melalui clion, tetapi panduan ini dapat dilakukan di editor mana pun.  Clion baik karena memungkinkan Anda untuk secara otomatis melakukan pemeriksaan sintaksis dasar, dan juga mendukung navigasi cepat melalui file atau fungsi melalui ctrl + klik.  Agar transisi seperti itu berfungsi di ekstensi kami, Anda harus mengonfigurasi file CMakeLists.txt <br><br>  Agar clion dapat berfungsi dengan baik, Anda perlu menginstal sistem build cmake, yang dengannya sekelompok paket dependen diinstal.  Instal semua ini dengan perintah: <br><br><pre> <code class="bash hljs">sudo apt install cmake</code> </pre><br><h4>  Konfigurasikan cmake </h4><br>  Kami membuka katalog kami dengan ekspansi di clion.  Buat file CMakeLists.txt dengan konten berikut melalui menu konteks dengan mengklik nama direktori root di bagian atas layar: <br><br><pre> <code class="bash hljs">cmake_minimum_required(VERSION 3.12) project(php-ext-libtrie C) <span class="hljs-built_in"><span class="hljs-built_in">set</span></span>(CMAKE_C_STANDARD 11) <span class="hljs-comment"><span class="hljs-comment">#   phproot,       php set(phproot /usr/local/src/php-7.2.11/) #   ,      #      clion       php include_directories(${phproot}) include_directories(${phproot}TSRM/) include_directories(${phproot}main/) include_directories(${phproot}Zend/) #    clion          add_executable(php-ext-libtrie php_libtrie.c)</span></span></code> </pre><br><img src="https://habrastorage.org/webt/ag/nc/qj/agncqji78vvzfcbyevpwi-9gszy.png"><br><br>  Mungkin seseorang tahu bagaimana membuat file ini lebih pendek sehingga clion mulai mengindeks file proyek.  Saya tidak menemukan cara yang lebih pendek.  Jika ada yang tahu, tulis di komentar. <br><br><h4>  Kode Fungsi Demo </h4><br>  Buka file kami dengan isi ekstensi <code>php_libtrie.c</code> dan <br>  hapus semua komentar sehingga mereka tidak membingungkan kami. <br><br><img src="https://habrastorage.org/webt/8x/sj/c2/8xsjc2q571audrqfbliblnct4-8.png"><br><br><img src="https://habrastorage.org/webt/vu/ql/mu/vuqlmu48nqu2fkkasdosjsma8zw.png"><br><br>  Clion memeriksa untuk melihat apakah semua fungsi dan makro yang digunakan dalam kode telah dideklarasikan dan melemparkan kesalahan jika tidak.  Jelas, pengembang PHP tidak menggunakan clion, kalau tidak mereka mungkin akan melakukan sesuatu tentang hal itu.  Untuk mencegah kesalahan ini terjadi di ekstensi kami, kami akan menyertakan file header yang hilang kepada kami. <br><br>  Untuk merampingkan semuanya, saya melakukan ini: <br>  Saya mentransfer semua sertakan dengan tajuk dari file <code>php_libtrie.h</code> ke <code>php_libtrie.h</code> , hanya 1 entri yang tersisa di file pertama: <br><br><pre> <code class="hljs cpp"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"php_libtrie.h"</span></span></span></span></code> </pre><br><img src="https://habrastorage.org/webt/ft/fe/yg/ftfeygfd1fznk5jxaccj8i9mt8k.png"><br><br>  File <code>php_libtrie.h</code> akan berisi semua inklusi yang diperlukan lainnya. <br><br><img src="https://habrastorage.org/webt/_v/_4/jg/_v_4jgpsak4g3aa7clykblcuq8y.png"><br><br><div class="spoiler">  <b class="spoiler_title">Isi file header saya</b> <div class="spoiler_text"><pre> <code class="hljs smalltalk"><span class="hljs-symbol"><span class="hljs-symbol">#ifndef</span></span> <span class="hljs-type"><span class="hljs-type">PHP_LIBTRIE_H</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">PHP_LIBTRIE_H</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#ifdef</span></span> <span class="hljs-type"><span class="hljs-type">HAVE_CONFIG_H</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"config.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#endif</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> &lt;stdarg.h&gt; //   va_start() <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> &lt;inttypes.h&gt; //    //  <span class="hljs-symbol"><span class="hljs-symbol">#if</span></span> defined(__GNUC__) &amp;&amp; __GNUC__ &gt;= <span class="hljs-number"><span class="hljs-number">4</span></span> # define <span class="hljs-type"><span class="hljs-type">ZEND_API</span></span> __attribute__ ((visibility(<span class="hljs-comment"><span class="hljs-comment">"default"</span></span>))) # define <span class="hljs-type"><span class="hljs-type">ZEND_DLEXPORT</span></span> __attribute__ ((visibility(<span class="hljs-comment"><span class="hljs-comment">"default"</span></span>))) <span class="hljs-symbol"><span class="hljs-symbol">#else</span></span> # define <span class="hljs-type"><span class="hljs-type">ZEND_API</span></span> # define <span class="hljs-type"><span class="hljs-type">ZEND_DLEXPORT</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#endif</span></span> # define <span class="hljs-type"><span class="hljs-type">SIZEOF_SIZE_T</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span> //   <span class="hljs-type"><span class="hljs-type">ZVAL_COPY_VALUE</span></span>() <span class="hljs-symbol"><span class="hljs-symbol">#ifndef</span></span> <span class="hljs-type"><span class="hljs-type">ZEND_DEBUG</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">ZEND_DEBUG</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#endif</span></span> //  ,      <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"php.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"php_ini.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"zend.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"zend_types.h"</span></span> //<span class="hljs-type"><span class="hljs-type">ZVAL_COPY_VALUE</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"ext/standard/info.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"zend_API.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"zend_modules.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"zend_string.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"spprintf.h"</span></span> extern zend_module_entry libtrie_module_entry; ...</code> </pre><br></div></div><br>  Jika semuanya dilakukan dengan benar, maka clion tester akan menampilkan kotak kuning atau hijau di sudut kanan atas, yang berarti bahwa tidak ada kesalahan kritis. <br><br><img src="https://habrastorage.org/webt/pt/gm/sa/ptgmsa8nlhkn1gs_ykyc8igavao.png"><br><br><h4>  Penyimpangan teoretis kecil </h4><br>  Agar ekstensi berfungsi dengan baik, 2 hal diperlukan: <br><br><ol><li>  Anda perlu menginisialisasi struktur khusus zend_module_entry, yang berisi yang berikut: <br><br><pre> <code class="hljs ruby">zend_module_entry libtrie_module_entry = { STANDARD_MODULE_HEADER, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  <span class="hljs-string"><span class="hljs-string">"libtrie"</span></span>, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  libtrie_functions, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>     PHP_MINIT(libtrie), <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>,     PHP_MSHUTDOWN(libtrie), <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   PHP_RINIT(libtrie), <span class="hljs-regexp"><span class="hljs-regexp">/* Replace with NULL if there's nothing to do at request start */</span></span> PHP_RSHUTDOWN(libtrie), <span class="hljs-regexp"><span class="hljs-regexp">/* Replace with NULL if there's nothing to do at request end */</span></span> PHP_MINFO(libtrie), <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> ,    php  phpinfo() PHP_LIBTRIE_VERSION, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> ,     STANDARD_MODULE_PROPERTIES /<span class="hljs-regexp"><span class="hljs-regexp">/    };</span></span></code> </pre><br></li><li>  Inisialisasi array yang sama yang berisi semua fungsi ekstensi kita. <br><br>  Di sini, melalui pembungkus makro khusus PHP_FE (), nama semua fungsi dalam ekstensi kami ditetapkan.  Secara umum, makro sangat aktif digunakan dalam PHP, ada banyak makro yang hanya merujuk ke makro lain, dan pada gilirannya lebih lanjut.  Anda harus terbiasa dengannya.  Anda dapat mengetahui apakah Anda pergi melalui makro melalui ctrl + klik.  Di sini, clion sangat diperlukan. <br><br>  Ingat file proto?  Kami menetapkan 1 fungsi my_array_fill ().  Jadi sekarang kita memiliki 3 elemen di sini: <br><br><pre> <code class="hljs objectivec"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> zend_function_entry libtrie_functions[] = { PHP_FE(confirm_libtrie_compiled, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) <span class="hljs-comment"><span class="hljs-comment">/* For testing, remove later. */</span></span> PHP_FE(my_array_fill, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) PHP_FE_END <span class="hljs-comment"><span class="hljs-comment">/* Must be the last line in libtrie_functions[] */</span></span> };</code> </pre><br>  Baris pertama adalah fungsi tes yang akan menunjukkan bahwa ekstensi berfungsi, yang kedua adalah fungsi kami, yang ketiga adalah makro khusus, yang harus menjadi yang terakhir dalam array ini. <br></li></ol><br>  Temukan fungsi kami: <br><br><pre> <code class="hljs lisp">PHP_FUNCTION(<span class="hljs-name"><span class="hljs-name">my_array_fill</span></span>)</code> </pre><br>  Seperti yang Anda lihat, ini juga diinisialisasi melalui makro.  Masalahnya adalah bahwa semua fungsi php tidak mengembalikan apa pun (tepatnya, mengembalikan batal) di dalam C, dan argumen mereka tidak dapat diubah.  Di suatu tempat bahkan lebih nyaman. <br><br>  Jika Anda melihat struktur file (bagian dari jendela di sebelah kiri), semua fungsi file tercantum di sini, tetapi dalam bentuk di mana mereka akan setelah mengkompilasi makro.  Tangkapan layar menunjukkan bahwa fungsi kami my_array_fill sebenarnya akan menjadi zif_my_array_fill. <br><br><img src="https://habrastorage.org/webt/ur/cl/m4/urclm4yrxdayv7heohr0puutrm8.png"><br><br>  Argumen dari usus php ke fungsi C kita kita dapatkan dengan makro.  Rincian lebih lanjut tentang makro ini dapat ditemukan di file: <br><br><pre> <code class="bash hljs">/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/src/php-7.2.11/README.PARAMETER_PARSING_API</code> </pre><br>  Di bawah ini adalah kode fungsi analog kami dengan penjelasan terperinci. <br><br><div class="spoiler">  <b class="spoiler_title">Kode</b> <div class="spoiler_text"><pre> <code class="hljs ruby">PHP_FUNCTION(my_array_fill) { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   ,     /<span class="hljs-regexp"><span class="hljs-regexp">/    2 : /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ zend_execute_data *execute_data, zval *return_value /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/     ,      /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/zend_long  int64_t  x64   int32_t  x86  /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/      zend_long zend_long start_index; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/1  , zend_long num; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/2   zval *value; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   mixed ,   zval,      /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/    ,          if (zend_parse_parameters(ZEND_NUM_ARGS(), "llz", &amp;start_index, &amp;num, &amp;value) == FAILURE) { /</span></span>*     *    RETURN<span class="hljs-number"><span class="hljs-number">_</span></span>    * return_value     *<span class="hljs-regexp"><span class="hljs-regexp">/ RETURN_FALSE; } /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   ,   -    if (num &lt;= 0) { php_error_docref(NULL TSRMLS_CC, E_WARNING, "argument 2 must be &gt; 0"); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/     RETURN_FALSE; } /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/zval *return_value  ,        /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/       zval,     ,  -  /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   zend_long  unsigned int32. /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/      + -. ..   1,    3,     4  array_init_size(return_value, (uint32_t)(start_index + num)); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  ,   ,   for(zend_long i = start_index, last = start_index + num; i &lt; last; ++i) { /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   zval       add_index_zval(return_value, i, value); } /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   ,      return_value return; }</span></span></code> </pre><br></div></div><br><br><br><h2>  Bangun dan uji ekstensi </h2><br>  Pertama, jalankan phpize, yang akan membuat kita mengonfigurasi file. <br><br><pre> <code class="bash hljs">phpize</code> </pre><br>  Sekarang jalankan ./configure, yang akan melakukan makefile. <br><br><pre> <code class="bash hljs">./configure</code> </pre><br>  Akhirnya, jalankan make, yang akan mengumpulkan ekstensi kita. <br><br><pre> <code class="bash hljs">make</code> </pre><br>  Mari kita periksa apa yang kita lakukan. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#    php,       # modules.  -a  php      php -d extension=modules/libtrie.so -a</span></span></code> </pre><br>  Kami masuk di konsol php: <br><br><pre> <code class="php hljs">print_r(my_array_fill(<span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"hello, baby!"</span></span>));</code> </pre><br>  Selamat menikmati hasilnya. <br><br><img src="https://habrastorage.org/webt/gn/sx/cy/gnsxcy1ihjtn6tgm7mpqjsz9hl4.png"><br><br>  Seseorang bertanya, di mana trie di sini?  Tentang fungsi yang mengimplementasikan pekerjaan trie, saya akan menulis di bagian kedua. <br><br>  <b>Tetap disini.</b> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id428626/">https://habr.com/ru/post/id428626/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id428610/index.html">Paradoks waktu menunggu, atau mengapa bus saya selalu terlambat?</a></li>
<li><a href="../id428612/index.html">Fungsi tingkat tinggi dalam JavaScript: apa itu?</a></li>
<li><a href="../id428614/index.html">Jumat Ocehan Programmer 4.2</a></li>
<li><a href="../id428616/index.html">Konversikan file XLS ke Google Spreadsheet menggunakan Google Apps Script</a></li>
<li><a href="../id428624/index.html">Jeffrey Richter, Pavel Yosifovich, Greg Young dan semuanya. Hardcore dan arsitektur di DotNext 2018 Moscow</a></li>
<li><a href="../id428628/index.html">Bekerja dengan pohon sintaksis JavaScript abstrak</a></li>
<li><a href="../id428630/index.html">Tidak, Bitcoin tidak akan menghancurkan iklim kita pada tahun 2033.</a></li>
<li><a href="../id428632/index.html">Berurusan dengan Pencegat dalam Bereaksi</a></li>
<li><a href="../id428634/index.html">Porting Quake3</a></li>
<li><a href="../id428636/index.html">Roskomnadzor akan memulihkan denda dari Google</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>