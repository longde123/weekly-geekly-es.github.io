<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßöüèΩ üçí üçÇ Microsservi√ßos. Controle de vers√£o em sistemas de integra√ß√£o cont√≠nua e implanta√ß√£o Estudo de caso de CI / CD usando TFS üçÖ üë£ üôáüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Edi√ß√£o 
 Para projetos grandes e tecnicamente complexos, nos quais, em regra, muitas equipes distribu√≠das trabalham simultaneamente, existe um problem...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Microsservi√ßos. Controle de vers√£o em sistemas de integra√ß√£o cont√≠nua e implanta√ß√£o Estudo de caso de CI / CD usando TFS</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/437992/"><h4>  Edi√ß√£o </h4><br>  Para projetos grandes e tecnicamente complexos, nos quais, em regra, muitas equipes distribu√≠das trabalham simultaneamente, existe um problema bem conhecido de software com vers√£o em desenvolvimento, que diferentes empresas resolvem de maneira diferente. <a name="habracut"></a><br><br>  Atualmente, v√°rios de nossos clientes e parceiros entregam as vers√µes mais recentes (CI / CD) para produ√ß√£o manualmente, instalando as vers√µes mais recentes / atuais de seus softwares, testando-as anteriormente com o restante do ambiente.  Por exemplo, fornecendo compila√ß√µes de aplicativos iOS, Android etc., se estivermos falando sobre software cliente, ou atualizando imagens de janela de encaixe em um ambiente de janela de encaixe, se estivermos falando de back-end.  Para projetos grandes e importantes em que a decis√£o de liberar uma nova vers√£o no Production a cada vez √© tomada pelo gerente de projetos, essa decis√£o √© justificada e n√£o √© muito cara, especialmente se as libera√ß√µes n√£o s√£o frequentemente lan√ßadas.  No entanto, para o ambiente de desenvolvimento de teste (ambiente Dev / Stage), o uso de ferramentas "manuais" leva √† complexidade do projeto, poss√≠vel interrup√ß√£o de impress√µes no Cliente e assim por diante.  Pode haver muitas raz√µes para isso, incluindo inconsist√™ncias nas vers√µes de v√°rios cont√™ineres no software de middleware ou a falta de um hist√≥rico detalhado de lan√ßamentos. <br><br>  Tivemos que garantir isso pessoalmente e enfrentar muitas dificuldades em um grande projeto, no qual eram lan√ßadas diariamente de 6 a 8 novas vers√µes de software no back-end e 2-3 vers√µes de software no front-end no sistema de CI, onde os engenheiros de teste n√£o podiam lidar objetivamente com a carga e havia uma constante falta de entendimento de qual vers√£o do software no front-end / back-end era considerada est√°vel no momento. <br><br><h4>  Nossa experi√™ncia </h4><br>  Nossa empresa utiliza v√°rios sistemas de CI / CD em seu trabalho, cuja escolha geralmente √© determinada pelos requisitos do Cliente.  Por exemplo, nossos especialistas geralmente encontram sistemas de CI / CD como Jenkins, TeamCity, Travis CI, Circle CI, Gitlab CI, Atlassian Bamboo, onde √†s vezes trabalhamos inteiramente na infraestrutura do cliente.  Dessa forma, com essa abordagem, o problema com a solu√ß√£o do controle de vers√£o √© inteiramente do Cliente. <br><br>  Ao desenvolver solu√ß√µes para os clientes, quando temos a oportunidade de fazer isso em nossa pr√≥pria infraestrutura, usamos o TFS vers√£o 2018 como base para o sistema de Integra√ß√£o Cont√≠nua / Entrega Cont√≠nua, o que nos permite resolver a principal tarefa de criar um ciclo completo de desenvolvimento de software, a saber: <br><br><ul><li>  Declara√ß√£o de tarefas (Problemas, Bugs, Tarefas) com base na abordagem de desenvolvimento de software usada no projeto atual; </li><li>  Armazenamento do c√≥digo fonte do projeto; </li><li>  Implanta√ß√£o da infraestrutura de agentes de constru√ß√£o para montagens para diferentes sistemas operacionais (Windows, Linux, MacOS); </li><li>  Montagem de projetos no modo "manual" e IC; </li><li>  Implanta√ß√£o de projetos no modo "manual" e CD; </li><li>  Testando projetos; </li><li>  Forma√ß√£o de dados sobre o tempo gasto pelos funcion√°rios no projeto e v√°rias fun√ß√µes adicionais que implementamos usando as Extens√µes TFS de nosso pr√≥prio design e adicionando est√°tica ao WIT (nesse formul√°rio, o TFS substituiu nossa empresa Redmine e simplificou a coleta de estat√≠sticas, relat√≥rios etc. no contexto de projetos ) </li></ul><br>  Nesse caso, seria l√≥gico atribuir a solu√ß√£o ao problema de controle de vers√£o ao TFS, finalizando a funcionalidade do TFS para nossas tarefas e os desejos do Cliente.  Como resultado, a tarefa de construir um sistema de vers√£o para projetos de arquitetura de microsservi√ßo foi resolvida pelas ferramentas TFS, personalizando v√°rios scripts de constru√ß√£o e organizando ambientes de teste / libera√ß√£o. <br><br><h4>  A solu√ß√£o: usando o TFS e ferramentas de terceiros </h4><br>  Portanto, precisamos de um sistema de vers√£o para projetos de arquitetura de microsservi√ßo para organizar ambientes de teste e lan√ßamentos. <br><br>  Como dados iniciais, temos: <br><br><ul><li>  Orquestra√ß√£o - usamos o docker swarm principalmente para reduzir o uso de outras ferramentas de terceiros.  Ao mesmo tempo, existem conversores para converter configura√ß√µes - por exemplo, o utilit√°rio <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Kompose</a> , que permitir√° usar o Kubernetes, se necess√°rio. </li><li>  Agentes de constru√ß√£o - VM baseada em servidores Linux. </li><li>  Reposit√≥rio de origem - Git baseado em TFS. </li><li>  Armazenamento de imagem - registro da janela de encaixe na VM. </li></ul><br><h4>  Para a pergunta do nome das compila√ß√µes </h4><br><ul><li>  Ser√° l√≥gico usar os padr√µes de nomenclatura existentes, por exemplo, como a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Semantic Versioning Specification</a> . </li><li>  Seguimos esse nome ao iniciar manualmente o processo de compila√ß√£o da vers√£o de lan√ßamento, porque, caso contr√°rio, voc√™ n√£o poder√° obter o nome correto automaticamente (a menos que o coloque manualmente no c√≥digo, que novamente tem pouca rela√ß√£o com a ideologia do IC). </li><li>  No modo CI para vers√µes de software de "depura√ß√£o", usamos os seguintes nomes em diferentes projetos: <br><br><ol><li>  Extens√µes TFS incorporadas </li><li>  Numera√ß√£o com base na data atual e n√∫mero da compila√ß√£o naquele dia; </li><li>  O n√∫mero da confirma√ß√£o que iniciou a constru√ß√£o. </li></ol></li></ul><br>  Uma solu√ß√£o espec√≠fica, por exemplo, pode ser visualizada com base em um exemplo do servi√ßo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Calculadora</a> , feito em Javascript, e em v√°rios projetos publicamente dispon√≠veis. <br><br><h4>  Algoritmo de decis√£o </h4><br>  <b>1.</b> No TFS2018, crie um projeto chamado SibEDGE Semver e importe o reposit√≥rio para o reposit√≥rio local <br><br><img src="https://habrastorage.org/webt/3n/9l/xi/3n9lxiufbqej7sscqofb3el3q58.jpeg" alt="imagem"><br>  <i>Figura 1 - Projeto SibEDGE Semver no reposit√≥rio do TFS 2018</i> <br><br>  <b>2.</b> Crie um arquivo Dockerfile com a descri√ß√£o do assembly node.js para nossas necessidades ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">link</a> ). <br><br><pre><code class="plaintext hljs">FROM node:7 WORKDIR /usr/src/app COPY package.json app.js LICENSE /usr/src/app/ COPY lib /usr/src/app/lib/ LABEL license MIT COPY tests tests ENV NODE_ENV dev RUN npm config set strict-ssl false RUN npm update &amp;&amp; \ npm install -g mocha CMD ["mocha", "tests/test.js", "--reporter", "spec"]</code> </pre> <br><h4>  Script 1 - Dockerfile para criar uma constru√ß√£o </h4><br>  <b>3.</b> Na bancada de testes (com a janela de encaixe instalada), onde planejamos implantar nosso ambiente, crie um cluster de enxame.  No nosso caso, ele consistir√° em um servidor. <br><br><pre> <code class="plaintext hljs">$ docker swarm init</code> </pre> <br>  <b>4.</b> Crie um arquivo yml com uma descri√ß√£o dos microsservi√ßos para as nossas necessidades ( <a href="">link</a> ). <br>  Observe que <code>vm-docker-registry.development.com:5000</code> √© o reposit√≥rio interno deste projeto, que preparamos com anteced√™ncia.  Para que o suporte de teste possa usar este reposit√≥rio, √© necess√°rio registrar um certificado SSL no suporte na pasta /etc/docker/certs.d/ &lt;nome do reposit√≥rio&gt; /ca.crt <br><br><pre> <code class="plaintext hljs">version: '3.6' services: #--- # Portainer for manage Docker #--- portainer: image: portainer/portainer:1.15.3 command: --templates http://templates/templates.json -d /data -H unix:///var/run/docker.sock networks: - semver-network ports: - 9000:9000 volumes: - /var/run/docker.sock:/var/run/docker.sock #--- #----Service Calculator Test# #--- semver-calc: image: vm-docker-registry.development.com:5000/calculator:latest networks: - semver-network #--- #----Pminder - Nginx# #--- nginx: image: nginx:1.9.6 depends_on: - mysql ports: - "8888:80" - "6443:443" networks: - semver-network # #----------------------------- # START NoSQL - Redis. #--- redis: image: redis:4.0 networks: - semver-network ports: - "8379:6379" # # END NoSQL - Redis. #--- #----Pminder - DB# #--- mysql: image: mysql:5.7 ports: - "3306:3306" environment: MYSQL_ROOT_PASSWORD: 'ODdsX0xcN5A9a6q' MYSQL_DATABASE: 'semver' MYSQL_USER: 'user' MYSQL_PASSWORD: 'uXcgTQS8XUm1RzR' networks: - semver-network #--- #----PhpMyAdmin # #--- phpmyadmin: image: phpmyadmin/phpmyadmin depends_on: - mysql environment: PMA_HOST: 'mysql' PMA_USER: 'user' PMA_PASSWORD: 'uXcgTQS8XUm1RzR' ports: - "8500:80" - "8600:9000" networks: - semver-network #--- networks: semver-network:</code> </pre><br><h4>  O script 2 √© o conte√∫do do arquivo semver.yml, que √© o arquivo do projeto docker-compose. </h4><br>  <b>5.</b> Crie uma descri√ß√£o da compila√ß√£o no TFS2018 (Defini√ß√£o da compila√ß√£o). <br><br>  <b>6.</b> A primeira a√ß√£o do nosso script √© criar a imagem do cont√™iner do docker: <br><br><img src="https://habrastorage.org/webt/ot/u2/hc/otu2hcqbokm6jsqq2xvrgdyo7ma.jpeg" alt="imagem"><br>  <i>Figura 2 - Criando uma imagem para nossa compila√ß√£o no TFS 2018</i> <br><br>  <b>7.</b> Envie a imagem do cont√™iner do docker criada na m√°quina de constru√ß√£o para o reposit√≥rio interno deste projeto: <br><br><img src="https://habrastorage.org/webt/c5/z0/-i/c5z0-irkolgl5vtvd_ljjmp4hte.jpeg" alt="imagem"><br>  <i>Figura 3 - Salvando a imagem do docker para nosso assembly no reposit√≥rio do TFS 2018</i> <br><br>  <b>8.</b> Para todo o ambiente na bancada de testes no arquivo de descri√ß√£o dos microsservi√ßos, altere o nome da imagem para um novo: <br><br><img src="https://habrastorage.org/webt/va/vs/-z/vavs-zlakgyiujowaaclrddgzd4.jpeg" alt="imagem"><br>  <i>Figura 4 - Substituindo o nome da imagem no script de compila√ß√£o por nossa compila√ß√£o no TFS 2018</i> <br><br>  <b>9.</b> Na bancada de testes, copie a imagem do cont√™iner do docker criado no reposit√≥rio interno e atualize o servi√ßo no swock do docker: <br><br><img src="https://habrastorage.org/webt/rc/gl/vq/rcglvqmsxim1iedm2ieq25_i_pq.jpeg" alt="imagem"><br>  <i>Figura 5 - Implantando o cont√™iner do docker com o script de compila√ß√£o para nossa compila√ß√£o a partir da imagem no TFS 2018</i> <br><br>  Como resultado, quando sa√≠mos para o reposit√≥rio TFS, temos um arquivo yml com vers√µes de libera√ß√£o das imagens do docker, que por sua vez tem um nome de libera√ß√£o para todo o projeto. <br><br>  <b>10.</b> Vamos para a bancada de testes e verificamos o trabalho dos servi√ßos e asseguramos que o servi√ßo Calculadora tenha sido atualizado e utilize a nova vers√£o do conjunto. <br><br><pre> <code class="plaintext hljs">$ docker service ls</code> </pre> <br><br><img src="https://habrastorage.org/webt/mj/tq/kh/mjtqkhpjmndkwu-gnac7rc_jteo.jpeg" alt="imagem"><br>  <i>Figura 6 - Atualizando o servi√ßo Calculadora e verificando sua vers√£o atual em nossa bancada de testes</i> <br><br>  Portanto, em nosso armazenamento de imagens do registro do docker, temos um conjunto de imagens de diferentes vers√µes de microsservi√ßos (nesse caso espec√≠fico, a vers√£o de apenas um microsservi√ßo √© alterada).  Ao iniciar um processo de implanta√ß√£o separado (por meio de um script que altera o arquivo de descri√ß√£o yml), a qualquer momento voc√™ pode obter o ambiente necess√°rio para o teste em um banco de testes e transferir essa configura√ß√£o para a divis√£o de controle de qualidade.  Ap√≥s o teste (regress√£o, carga etc.), obtemos informa√ß√µes de que o microsservi√ßo de uma determinada vers√£o funciona de forma est√°vel em um banco de testes com as vers√µes de lan√ßamento de outros microsservi√ßos dessas e de tais vers√µes, e a decis√£o final j√° est√° tomada sobre a atualiza√ß√£o ou n√£o suporte de lan√ßamento para a nova vers√£o. <br><br><h4>  Resumo - o que voc√™ conseguiu na sa√≠da </h4><br>  Gra√ßas √† implementa√ß√£o do controle de vers√£o em projetos com arquitetura de microsservi√ßo, o seguinte resultado foi alcan√ßado: <br><br><ul><li>  a quantidade de caos nas vers√µes diminuiu; </li><li>  a velocidade de implanta√ß√£o de um novo ambiente em projetos aumentou; </li><li>  a qualidade das montagens melhorou e o n√≠vel de erros nelas diminuiu; </li><li>  maior transpar√™ncia do desenvolvimento para os gerentes de projeto e o cliente; </li><li>  a intera√ß√£o entre departamentos melhorou; </li><li>  Existem novas dire√ß√µes no trabalho do DevOps. </li></ul><br>  <b>PS</b> Agrade√ßo ao meu colega Kirill B. por me ajudar a escrever este artigo. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt437992/">https://habr.com/ru/post/pt437992/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt437982/index.html">Novo ataque de criptografia da Shade visa usu√°rios de neg√≥cios russos</a></li>
<li><a href="../pt437984/index.html">Threading no Node.js: m√≥dulo worker_threads</a></li>
<li><a href="../pt437986/index.html">Por que o TypeScript est√° no centro de todos os novos aplicativos da web do PayPal?</a></li>
<li><a href="../pt437988/index.html">Tutorial React, Parte 12: Workshop, Aplica√ß√£o TODO da Fase 3</a></li>
<li><a href="../pt437990/index.html">Tutorial Reagir Parte 13: Componentes baseados em classe</a></li>
<li><a href="../pt437994/index.html">Ordenha autom√°tica e estufas autom√°ticas: como funciona uma pequena fazenda de alta tecnologia</a></li>
<li><a href="../pt437996/index.html">SITIS CTF: como o selo ajudou o CTF a vencer</a></li>
<li><a href="../pt437998/index.html">Fil√≥sofos "modernos" de restaurantes em C ++ por meio de atores e CSP</a></li>
<li><a href="../pt438000/index.html">Sucesso e falha na cria√ß√£o do seu projeto (inicializa√ß√£o)</a></li>
<li><a href="../pt438002/index.html">Configurar proxy reverso para Nextcloud e ONLYOFFICE</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>