<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèæ‚Äçüîß üçÅ üÜö Histoire de No√´l ‚úåüèæ üìï üå∂Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nous voulons partager l'histoire qui s'est produite lors de l'un de nos projets pour la nouvelle ann√©e. L'essence du projet est qu'il automatise le tr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Histoire de No√´l</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/simbirsoft/blog/432998/">  Nous voulons partager l'histoire qui s'est produite lors de l'un de nos projets pour la nouvelle ann√©e.  L'essence du projet est qu'il automatise le travail des m√©decins dans les institutions m√©dicales.  Pendant la visite du patient, le m√©decin √©crit des informations sur l'enregistreur, puis l'audio est transcrit.  Apr√®s le processus de transcription - c.-√†-d.  transformer l'enregistrement audio en texte - un document m√©dical est form√© selon les normes pertinentes et renvoy√© √† la clinique, d'o√π l'enregistrement audio est venu, o√π le m√©decin d'envoi le re√ßoit, le v√©rifie et l'approuve.  Apr√®s avoir pass√© les contr√¥les obligatoires, le document est envoy√© aux patients finaux. <br><a name="habracut"></a><br>  Toutes les institutions m√©dicales utilisant le produit peuvent √™tre conditionnellement divis√©es en deux grands groupes: <br><br><ul><li>  H√©bergement dans le centre de donn√©es de notre client, qui est enti√®rement responsable de la fonctionnalit√© de l'application, √† la fois pour le logiciel et le mat√©riel.  Par exemple, si l'espace disque est √©puis√© ou si les performances du serveur ne sont pas suffisantes sur le processeur; </li><li>  Auto-h√©berg√©s: ils placent tous les √©quipements directement chez eux et sont eux-m√™mes responsables de ses performances.  Notre client leur fournit l'application et son support. </li></ul><br>  C'est ainsi que notre √©quipe interagit avec les serveurs finaux h√©berg√©s directement dans le cloud de notre client. <br><br><img src="https://habrastorage.org/webt/fu/dh/qb/fudhqbrny8p_r3wcs4swokhglqw.png"><br><br>  Nous avons acc√®s √† ces serveurs pour effectuer tous les travaux et la maintenance planifi√©s qui sont n√©cessaires. <br><br>  Le deuxi√®me groupe - les clients auto-h√©berg√©s - pour eux, le cloud client agit comme une passerelle par laquelle nous nous connectons √† ces serveurs.  Dans ce cas, nous avons des droits limit√©s, souvent nous ne pouvons effectuer aucune op√©ration en raison des param√®tres de s√©curit√©.  Nous nous connectons aux serveurs via RDP, le protocole Remote Desktop sur Windows OS.  Naturellement, tout cela fonctionne via un VPN. <br><br>  Il convient de garder √† l'esprit que chaque serveur repr√©sent√© dans le diagramme est en r√©alit√© une combinaison d'un serveur d'applications et d'un serveur de base de donn√©es.  Sur le serveur de base de donn√©es, respectivement, le SGBD MS SQL Server et le service de g√©n√©ration de rapports SSRS sont install√©s.  De plus, la version de MSSQL Server est diff√©rente dans toutes les cliniques: 2008, 2012, 2014. En plus des versions elles-m√™mes, diff√©rents Service Packs et correctifs sont install√©s partout.  En g√©n√©ral, un zoo complet. <br><br>  Sur le serveur d'applications, nous avons install√© le serveur Web IIS et ElasticSearch.  ElasticSearch est un moteur de recherche qui impl√©mente √©galement la recherche en texte int√©gral. <br>  L'essence principale de notre produit est le ¬´travail¬ª.  Le travail est une entit√© abstraite qui relie toutes les informations li√©es √† la r√©ception d'un patient particulier.  Ces informations comprennent: <br><br><ul><li>  donn√©es sur le m√©decin; </li><li>  donn√©es patient; </li><li>  donn√©es sur la visite; </li><li>  fichier audio (discours du m√©decin); </li><li>  documents (plusieurs versions); </li><li>  historique de traitement du travail; </li><li>  informations sur la succursale, etc. </li></ul><br>  Ce diagramme montre un sch√©ma de base de donn√©es simplifi√© √† partir duquel vous pouvez voir les relations entre les tables principales.  Ce n'est que la partie de base, en fait, la base de donn√©es contient plus de 200 tables. <br><br><img src="https://habrastorage.org/webt/sc/ke/hl/sckehlss-czi3bz2kagmfecrroy.png"><br><br>  Un peu sur la clinique o√π l'incident s'est produit: <br><br><ul><li>  1500-2000 travaux par jour; </li><li>  1000+ utilisateurs actifs (m√©decins + secr√©taires); </li><li>  Auto-h√©berg√©. </li></ul><br>  DB: <br><br><ul><li>  Taille: 800+ Go (750K + ≈ìuvres, 2M + documents); </li><li>  SGBD: MS SQL Server 2008 R2; </li><li>  Mod√®le de r√©cup√©ration: simple. </li></ul><br>  Ici, je veux faire une petite explication.  Il existe 3 mod√®les de r√©cup√©ration dans SQL Server: simple, enregistr√© en bloc et complet.  Je ne parlerai pas du troisi√®me maintenant, je vais vous expliquer le premier et le deuxi√®me.  La principale diff√©rence est que dans le mod√®le simple, nous ne stockons pas l'historique des transactions dans le journal - d√®s que la transaction a √©t√© valid√©e, l'enregistrement du journal des transactions sera supprim√©.  Lorsque vous utilisez le mode de r√©cup√©ration compl√®te, l'historique complet des modifications de donn√©es est stock√© dans un journal des transactions.  Qu'est-ce que cela nous donne?  En cas de situation impr√©vue, lorsque nous devons restaurer la base de donn√©es √† partir de sauvegardes, nous pouvons revenir non seulement √† une sauvegarde sp√©cifique, mais √©galement √† tout moment, jusqu'√† une certaine transaction, c'est-√†-dire que nous avons dans les sauvegardes, non seulement un certain √©tat de la base de donn√©es au moment de la sauvegarde, mais aussi toute une histoire de modifications des donn√©es. <br><br>  Je pense que cela ne vaut pas la peine d'expliquer que le mode simple n'est utilis√© qu'en d√©veloppement, sur des serveurs de test et que son utilisation en production est inacceptable.  Pas du tout. <br><br>  Mais la clinique, apparemment, avait ses propres r√©flexions √† ce sujet;) <br><br><h3>  Commencer </h3><br>  Quelques jours plus tard, le Nouvel An, tout le monde se pr√©pare pour les vacances, ach√®te des cadeaux, d√©core les sapins de No√´l, passe les f√™tes d'entreprise et attend un long week-end. <br><br><h6>  22 d√©cembre (vendredi) 1 jour </h6><br>  <strong>14:31</strong> Le client a d√©clar√© qu'il n'avait pas re√ßu le prochain rapport quotidien.  Le rapport arrive par la poste deux fois par jour selon un calendrier; il est n√©cessaire de contr√¥ler l'envoi de donn√©es √† un syst√®me d'int√©gration externe, ce qui n'est pas trop critique. <br><br>  Il peut y avoir plusieurs raisons: <br><br><ol><li>  Probl√®mes avec SMTP, les lettres n'ont tout simplement pas √©t√© livr√©es (ils ont chang√© le mot de passe, par exemple, et ils n'en ont parl√© √† personne); </li><li>  Probl√®mes c√¥t√© serveur des rapports; </li><li>  Quelque chose est arriv√© √† la base de donn√©es. </li></ol><br>  <strong>16:03 La</strong> clinique change parfois le mot de passe en SMTP, sans en avertir personne, donc, apr√®s avoir termin√© les t√¢ches en cours, nous v√©rifions calmement le rapport manuellement en le lan√ßant via l'interface Web - nous obtenons une erreur qui indique des probl√®mes dans la base de donn√©es. <br><br>  Un exemple de l'erreur que nous avons re√ßue lors du d√©marrage du rapport. <br><br><pre><code class="plaintext hljs">SQL Server detected a logical consistency-based I/O error: incorrect checksum (expected: 0x9876641f; actual: 0xa3255fbf). It occurred during a read of page (1:876) in database ID 7 at offset 0x000000006d8000 in file 'D:\Program Files\Microsoft SQL Server\MSSQL10_50.MSSQLSERVER\MSSQL\DATA\ServerLive.mdf'.</code> </pre> <br>  Cela indique que la base de donn√©es contient des pages corrompues.  Nous avions un l√©ger sentiment d'anxi√©t√©. <br><br>  <strong>20:53</strong> Afin d'√©valuer l'√©tendue des dommages, nous <strong>ex√©cutons</strong> une v√©rification de la base de donn√©es √† l'aide de la <strong><em>commande</em></strong> sp√©ciale <strong><em>DBCC CHECKDB</em></strong> .  Selon la taille des d√©g√¢ts, la commande de test peut prendre un certain temps, nous ex√©cutons donc la commande la nuit.  Ici, nous avons de la chance que cela se soit produit vendredi apr√®s-midi, c'est-√†-dire que nous avions au moins tous les jours de cong√© pour r√©soudre ce probl√®me. <br><br>  √Ä ce moment, la situation √©tait la suivante: <br><br><img src="https://habrastorage.org/webt/dp/nq/jm/dpnqjm7rvkmtjtxoc534js439zq.png"><br><br><h6>  23 d√©cembre (samedi) 2e jour </h6><br>  <strong>10:02</strong> Le matin, nous constatons que la v√©rification de la base de donn√©es avec CHECKDB est disquette - cela √©tait d√ª √† un manque d'espace disque libre, car  au cours du processus de v√©rification, la base de donn√©es temporaire tempdb est activement utilis√©e et, √† un moment donn√©, l'espace disque libre s'est simplement √©puis√©. <br><br>  Par cons√©quent, nous d√©cidons au lieu de v√©rifier la base de donn√©es enti√®re de lancer imm√©diatement une analyse de table.  Pour ce faire, utilisez la <strong><em>commande DBCC CHECKTABLE</em></strong> . <br><br>  <strong>10:46</strong> Nous d√©cidons de commencer avec la table JobHistory, qui est probablement corrompue, car c'est elle qui a √©t√© utilis√©e pour g√©n√©rer le rapport.  Ce tableau, comme son nom l'indique, pr√©serve l'histoire de toutes les ≈ìuvres, c'est-√†-dire les transitions du travail entre les √©tapes. <br><br>  Ex√©cutez <strong><em>DBCC CHECKTABLE ('dbo.JobHistory')</em></strong> . <br><br>  La v√©rification de cette table r√©v√®le des tables endommag√©es dans la base de donn√©es, ce qui √©tait attendu en principe. <br><br>  <strong>12:00</strong> √Ä l'heure actuelle, si la base de donn√©es utilisait le mod√®le de r√©cup√©ration compl√®te, nous pourrions restaurer les pages endommag√©es √† partir de la sauvegarde, et ce serait fini, mais notre base de donn√©es √©tait en mode simple.  Par cons√©quent, la seule option pour r√©parer les dommages reste le lancement de la m√™me commande avec le param√®tre sp√©cial <strong><em>REPAIR_ALLOW_DATA_LOSS</em></strong> .  Cela peut entra√Æner une perte de donn√©es. <br><br>  Nous commen√ßons.  La v√©rification se termine √† nouveau avec une erreur - nous obtenons une erreur indiquant que la restauration de cette table est impossible jusqu'√† ce que les tables associ√©es soient restaur√©es.  La table d'historique fait r√©f√©rence √† la table de travail (Jobs) par la cl√© √©trang√®re, par cons√©quent, nous concluons qu'il y a √©galement des dommages dans la table de travail principale (Jobs). <br><br>  <strong>13:30</strong> La prochaine √©tape consiste √† v√©rifier le tableau des emplois, en m√™me temps - nous esp√©rons que les dommages se trouvent dans l'index, et non dans les donn√©es.  Dans ce cas, il nous suffira de reconstruire simplement l'index pour la r√©cup√©ration des donn√©es. <br><br>  <strong>17:33</strong> Apr√®s un certain temps, nous constatons que notre serveur n'est pas disponible via RDP.  Il a probablement √©t√© √©teint, le contr√¥le n'a pas √©t√© effectu√©, les travaux ont √©t√© suspendus.  Nous informons la clinique que le serveur n'est pas disponible, veuillez le soulever. <br><br>  Une l√©g√®re anxi√©t√© prend des formes tr√®s sp√©cifiques. <br><br><h6>  24 d√©cembre (dimanche) 3e jour </h6><br>  <strong>14:31</strong> Plus pr√®s du d√Æner, le serveur est relev√©, nous r√©ex√©cutons la v√©rification de la table Jobs. <br>  <strong><em>DBCC CHECKTABLE ('dbo.Jobs')</em></strong> <br><br>  <strong>16:05 La</strong> v√©rification n'est pas termin√©e, le serveur n'est pas disponible.  Encore une fois. <br><br>  Apr√®s un certain temps, le serveur n'est plus disponible, avant que nous ayons r√©ussi √† terminer la v√©rification de la table.  √Ä ce stade, le service informatique de la clinique effectue une s√©rie de v√©rifications de serveur.  Nous attendons la fin des travaux. <br><br>  En raison des vacances, la communication entre nous et le client a √©t√© lente - nous nous attendions √† des r√©ponses aux questions pendant plusieurs heures. <br><br><h6>  25 d√©cembre (lundi - No√´l) 4e jour </h6><br>  <strong>16:00</strong> Le lendemain, le serveur a √©t√© relev√©, le client a No√´l et nous recommen√ßons √† v√©rifier la table, mais cette fois nous excluons les index de l'analyse et nous laissons uniquement la v√©rification des donn√©es.  Et apr√®s un certain temps, le serveur n'est plus disponible. <br><br>  Que se passe-t-il? <br><br>  En ce moment, les pens√©es commencent √† s'infiltrer, ce n'est pas seulement une co√Øncidence, et on soup√ßonne qu'il pourrait √™tre endommag√© au niveau du fer (un disque dur est tomb√©).  Nous supposons qu'il y a des secteurs d√©fectueux sur le disque et lorsque l'analyse tente de lire les donn√©es de ces secteurs, le syst√®me se bloque.  Nous informons notre client de notre hypoth√®se. <br><br>  Le client ex√©cute une v√©rification du disque sur la machine h√¥te. <br><br>  <strong>17:19 Le</strong> service informatique de la clinique a signal√© que le fichier de la machine virtuelle √©tait endommag√© - c'est mauvais! ( <br>  Nous ne pouvons pas encore travailler et nous attendons un signal quand ils r√®glent le probl√®me et nous pouvons continuer notre travail. <br><br><h6>  26 d√©cembre (mardi) Jour 5 </h6><br>  <strong>14:05 Le</strong> service de la clinique informatique lance un autre processus de r√©cup√©ration de disque.  On nous a dit que nous pouvons ex√©cuter CHECKTABLE en parall√®le pour v√©rifier la table.  Nous recommen√ßons le test - la machine virtuelle plante √† nouveau, nous informons le client que le fichier de la machine virtuelle est toujours corrompu. <br><br>  De nos jours, toutes les communications avec le client sont tr√®s lentes avec un d√©calage √©norme d√ª aux vacances. <br><br><h6>  27 d√©cembre (mercredi) Jour 6 </h6><br>  <strong>14:00</strong> Nous commen√ßons la v√©rification du disque √† l'aide de Windows - <strong>checkdisk</strong> √† l'int√©rieur de la machine virtuelle - aucun probl√®me n'a √©t√© d√©tect√©. <br>  La base de donn√©es est en mode simple, donc les chances de corriger la base de donn√©es actuelle avec les outils SGBD ont tendance √† z√©ro, car  nous ne pouvons pas r√©cup√©rer les pages individuelles endommag√©es. <br>  Nous commen√ßons √† envisager l'option de restauration et de restauration de la base de donn√©es √† partir d'une sauvegarde. <br>  Nous v√©rifions les sauvegardes de la base de donn√©es et constatons que les sauvegardes n'ont pas √©t√© effectu√©es √† l'aide du SGBD, la derni√®re sauvegarde a eu lieu en 2014, c'est-√†-dire  Il n'y a aucune sauvegarde de la base de donn√©es.  La raison pour laquelle ils ne l'ont pas fait est un probl√®me distinct, il est de la responsabilit√© de la clinique d'assurer l'efficacit√© et la s√©curit√© de la base de donn√©es. <br><br>  Il y a une forte probabilit√© que cela ne fonctionne pas pour restaurer la base de donn√©es actuelle, nous commen√ßons √† envisager d'autres options de restauration. <br><br>  Arr√™tons-nous plus en d√©tail sur la situation des sauvegardes √† la clinique. <br><br>  La situation avec les sauvegardes: <br><br><ul><li>  Il n'y a pas de sauvegarde de base de donn√©es (!!!) </li><li>  Il n'y a pas d'instantan√©s de la machine virtuelle (!?) </li><li>  Mais il y a des sauvegardes sur disque (compl√®tes + inc) </li></ul><br>  La base de donn√©es se trouve sur le disque D, respectivement, ils ont effectu√© des sauvegardes compl√®tes hebdomadaires et des sauvegardes incr√©mentielles quotidiennes. <br><br><ul><li>  tous les vendredis √† 20h00 sauvegarde compl√®te </li><li>  sauvegarde incr√©mentielle quotidienne </li><li>  il y a une sauvegarde compl√®te du 15 et 22 </li><li>  il y a des sauvegardes quotidiennes jusqu'au 21 </li></ul><br>  C'est-√†-dire  en principe, nous pouvons revenir √† l'√©tat avant que le probl√®me ne survienne. <br>  Nous attendons une mise √† jour de la clinique pour d√©marrer la restauration de la base de donn√©es √† partir de la sauvegarde. <br><br>  Dans le m√™me temps, la clinique a envoy√© une demande au fournisseur de fer (HP) marqu√©e ¬´urgent¬ª. <br><br><h6>  28 d√©cembre (jeudi) Jour 7 </h6><br>  <strong>13:13 Le</strong> service informatique de la clinique commence √† configurer une nouvelle machine virtuelle,  Il n'est pas possible de r√©parer les dommages dans le fichier de l'ancienne machine virtuelle. <br><br>  <strong>19:09</strong> Une nouvelle <strong>machine</strong> virtuelle <strong>est</strong> disponible avec SQL Server install√©. <br>  L'√©tape suivante consiste √† restaurer la base de donn√©es √† partir de la sauvegarde sur disque.  Pour commencer, nous d√©cidons de revenir au 22e jour, si le probl√®me persiste, puis de revenir au 21e, 20e et ainsi de suite, jusqu'√† ce que nous arrivions √† un √©tat de fonctionnement. <br><br>  C'√©tait le 28e jour dans la cour, nous √©tions √† la f√™te d'entreprise, et ici, ils nous disent que la clinique a des probl√®mes avec la restauration des sauvegardes, car les SAUVEGARDES sont VIDE! <br><br>  Voici les nouvelles! <br><br>  Lors de la restauration d'une sauvegarde du lecteur D √† partir du 21, il s'av√®re qu'il est vide, comme tout le monde.  Des sauvegardes directes de broyeur sont obtenues - elles semblent √™tre l√†, mais en m√™me temps elles ne le sont pas.  On ne sait pas du tout comment cela s'est produit, mais, pour autant que nous ayons pu le comprendre, le probl√®me r√©side dans un espace disque insuffisant pour le stockage des sauvegardes sur disque.  Ils ont allou√© 500 Go de sauvegardes pour le stockage, mais au moment de l'incident, la base de donn√©es pesait d√©j√† 800 Go, donc, en principe, la sauvegarde ne pouvait pas r√©ussir.  C'est-√†-dire  les sauvegardes ont √©t√© effectu√©es r√©guli√®rement selon le calendrier, mais en raison du manque d'espace, elles se sont sold√©es par une erreur et, par cons√©quent, √©taient vides, et le service informatique de la clinique n'a m√™me pas eu l'id√©e de v√©rifier que tout allait bien.  Ne fais pas √ßa. <br><br><h6>  29 d√©cembre (vendredi) Jour 8 </h6><br>  <strong>13:11</strong> Discussion sur d'autres actions.  Options possibles: <br><br><ul><li>  Tentative de copier des fichiers de base de donn√©es (fichiers .ldf + .two) - les chances de succ√®s sont tr√®s faibles; </li><li>  Essayer de sauvegarder la base de donn√©es est encore tr√®s peu de chances; </li><li>  Configurer la r√©plication - peut fonctionner. </li></ul><br>  Un lecteur de 1 To a √©t√© allou√© sur le nouveau serveur, ce qui n'est √©videmment pas suffisant si nous essayons de sauvegarder et de restaurer √† partir de celui-ci, car  dans le pire des cas, sans compression, les sauvegardes prendront autant d'espace que la base de donn√©es d'origine, c'est-√†-dire  800 Go. <br>  Veuillez ajouter des emplacements sur le nouveau serveur et proc√©der √† la copie des fichiers de base de donn√©es. <br>  Une base de donn√©es a √©t√© cr√©√©e sur le nouveau serveur et le sch√©ma de base de donn√©es a √©t√© restaur√© - cela permettra au moins de traiter de nouveaux travaux.  La clinique pourra au moins accepter de nouveaux patients en utilisant un tel syst√®me. <br><br>  <strong>14:36</strong> Par cons√©quent, nous passons √† l‚Äôoption num√©ro un, bien que nous ne nous attendions pas √† beaucoup de succ√®s. <br>  Arr√™tez SQL Server, commencez √† copier le fichier de donn√©es (mdf) et le journal (ldf). <br><br>  <strong>16:13</strong> Apr√®s la moiti√© du fichier journal, il a √©t√© copi√© avec succ√®s (48 Go) et 50 Go du fichier de donn√©es ont d√©j√† √©t√© copi√©s (il reste 795 sur 846 Go).  √Ä cette vitesse, il faudra environ 12 heures pour terminer la copie. <br><br>  <strong>16:30 L'</strong> ancien serveur de base de donn√©es s'est √©teint lors de la copie du fichier, ce qui est tout √† fait normal. <br><br>  <strong>17:09</strong> Par cons√©quent, nous passons √† l'option suivante - configurer la r√©plication, alors que nous pouvons sp√©cifier quelles donn√©es seront r√©pliqu√©es, c'est-√†-dire que nous pouvons d'abord exclure les tables d√©lib√©r√©ment endommag√©es et copier d'abord les donn√©es intactes, puis transf√©rer les tables probl√©matiques en plusieurs parties.  Mais cette option, malheureusement, ne fonctionne pas non plus, car nous ne pouvons m√™me pas cr√©er une publication avec certaines tables en raison de la corruption de la base de donn√©es. <br>  Nous envisageons √©galement des options de transfert de donn√©es. <br><br>  <strong>20:01</strong> Par cons√©quent, nous commen√ßons simplement √† transf√©rer les donn√©es de l'ancien vers le nouveau serveur en les important et en les exportant par ordre de priorit√©. <br><br>  <strong>21:35</strong> D'abord, les donn√©es les plus critiques, puis d'archivage et moins critiques (~ 300 Go).  Lors de la premi√®re vague d'exportation, il restait moins de 300 Go de donn√©es.  Le tableau Documents (300 Go) est √©galement exclu.  Nous commen√ßons le processus de copie la nuit. <br><br><h6>  30 d√©cembre (samedi) Jour 9 </h6><br>  <strong>15:00 Nous</strong> continuons de transf√©rer des donn√©es.  La table Jobs n'est pas disponible du tout.  La plupart des tableaux ont √©t√© copi√©s √† cette √©poque. <br>  Mais sans <strong>Jobs, tout</strong> cela est inutile, car il est le lien principal entre toutes les donn√©es et leur donne un sens et une valeur d'un point de vue commercial.  Sans cela, nous avons juste un ensemble de donn√©es disparates que nous ne pouvons tout simplement pas utiliser. <br><br>  En outre, √† ce stade, la r√©cup√©ration du sch√©ma de base de donn√©es est termin√©e. <br><br>  <strong>Les cons√©quences de l'incident:</strong> <br><br>  √Ä ce stade, nous avons une √©norme perte de donn√©es en direct. <br>  C'est-√†-dire  formellement, nous avons certaines donn√©es dans la base de donn√©es, mais, en fait, il n'y a aucun moyen de les utiliser ou de les connecter, nous pouvons donc parler de la perte compl√®te de donn√©es. <br>  Donn√©es perdues sur plus de 750 000 admissions de patients. <br><br>  C'est vraiment triste! <br><br><ul><li>  C'est un coup dur port√© √† la r√©putation de notre client, qui peut s'av√©rer √™tre un gros probl√®me pour lui dans les affaires lors de la conclusion de nouveaux contrats et de la recherche de nouveaux clients. </li><li>  Perdre autant de donn√©es pour la clinique peut entra√Æner de graves probl√®mes et des amendes, car  Il s'agit de donn√©es confidentielles contenant une confidentialit√© m√©dicale et, au sens litt√©ral, d√©pendent de la vie des gens. </li></ul><br>  Nous avons commenc√© √† penser √† ce que nous pouvons faire dans cette situation.  Ils ont commenc√© √† trier le syst√®me par os pour trouver des indices. <br><br>  <strong>15:16</strong> En analysant tous les aspects du syst√®me, nous comprenons que nous pouvons essayer d'extraire les donn√©es manquantes de l'index ElasticSearch.  Le fait est qu'en raison de la configuration incorrecte des index ElasticSearch, il stocke non seulement les champs par lesquels la recherche en texte int√©gral est effectu√©e, mais en g√©n√©ral tout, c'est-√†-dire qu'il existe en fait une copie compl√®te des donn√©es et que nous pouvons th√©oriquement en extraire des donn√©es sur les ≈ìuvres et les remettre dans notre base de donn√©es.  On esp√®re que les donn√©es pourront toujours r√©cup√©rer. <br><br>  Un bug auquel vous pouvez mettre un monument! <br><br><img src="https://habrastorage.org/webt/oy/62/nt/oy62ntr-iiercftfvwmd_gzoide.png"><br><br>  <strong>18:00</strong> Un utilitaire a √©t√© rapidement √©crit pour extraire les donn√©es, et apr√®s quelques heures nous nous assurons que l'approche fonctionne et que les donn√©es peuvent √™tre restaur√©es. <br><br>  <strong>20:00 La</strong> restauration du travail √† partir d'ElasticSearch √† l'aide d'un utilitaire √©crit a commenc√©.  L'approche a fonctionn√©, nous pouvons restaurer les donn√©es sur le travail.  En parall√®le, nous commen√ßons √† extraire les derni√®res versions du document pour chaque ≈ìuvre. <br><br><h6>  31 d√©cembre (dimanche - nouvel an) Jour 10 </h6><br>  <strong>14:09</strong> Pendant la nuit, 188 811 ≈ìuvres ont √©t√© restaur√©es. <br><br>  <strong>20:13</strong> Voyant notre succ√®s, la clinique d√©cide de reporter le transfert du serveur vers le service HP afin de nous donner le temps d'extraire le maximum de donn√©es de l'ancien serveur. <br>  Avec de telles nouvelles, nous avons c√©l√©br√© le Nouvel An)) <br><br><h6>  01 janvier (lundi) 11e jour </h6><br>  <strong>11:23</strong> Pr√©paration du d√©marrage du syst√®me apr√®s l'incident: <br><br><ul><li>  reconfigur√© IIS sur le serveur d'applications; </li><li>  reconfigur√© tous les services n√©cessaires pour travailler avec le nouveau serveur de base de donn√©es; </li><li>  d√©clencheurs, proc√©dures stock√©es, fonctions restaur√©es. </li></ul><br>  <strong>14:28</strong> Puis ils ont commenc√© √† copier le tableau des documents, qui a √©t√© ignor√© en raison de la grande taille lors du transfert initial. <br>  - L'ancien serveur DB s'arr√™te √† nouveau.  √âvidemment, la table Documents est √©galement corrompue, c'est avec elle que toutes les informations patient sont stock√©es.  Heureusement, il n'est pas compl√®tement endommag√©, nous pouvons lui faire des demandes, et lorsqu'une demande nous renvoie un enregistrement endommag√©, √† ce moment le serveur se bloque et s'arr√™te.  Nous pouvons extraire certaines des donn√©es. <br><br>  En cons√©quence, nous signalons le client, ils l√®vent le serveur, et en parall√®le nous continuons √† pr√©parer la nouvelle base de donn√©es pour le lancement du syst√®me. <br><br>  <strong>18:01</strong> R√©cup√©ration de toutes les contraintes d'int√©grit√© apr√®s le transfert de la partie principale des donn√©es. <br><br>  <strong>22:02 Fin de la</strong> restauration des restrictions.  Nous avons simplement transf√©r√© les donn√©es brutes au maximum.  La pr√©sence de contraintes d'int√©grit√© compliquerait grandement notre t√¢che. <br><br><h6>  02 janvier (mardi) Jour 12 </h6><br>  <strong>05:52 L'</strong> ancien serveur DB s'est √† nouveau √©teint lors de la copie du document.  Il est rapidement relev√© pour que nous puissions continuer √† travailler. <br><br>  <strong>09:00</strong> Il a √©t√© possible de r√©cup√©rer par lots environ 200 000 documents (environ 20%) <br>  Nous avons commenc√© √† utiliser diff√©rentes m√©thodes de r√©cup√©ration: tri par diff√©rentes colonnes pour obtenir des donn√©es de la fin ou du d√©but de la table, jusqu'√† ce que nous tombions sur une partie endommag√©e de la table. <br><br>  <strong>13:42 A</strong> commenc√© √† copier les ≈ìuvres d'archives dans le tableau - heureusement, il n'est pas endommag√©. <br><br>  <strong>17:08</strong> Restauration de tous les documents d'archives (491 380 pi√®ces). <br><br>  Le syst√®me est pr√™t √† √™tre lanc√©: les utilisateurs peuvent cr√©er et traiter de nouveaux travaux. <br><br>  Malheureusement, en raison de dommages partiels √† la table de documents, vous ne pouvez pas simplement transf√©rer toutes les donn√©es de celle-ci, comme avec d'autres tables, car  la table est partiellement endommag√©e.  Par cons√©quent, lorsque vous essayez de r√©cup√©rer toutes les donn√©es, la demande se bloque lorsque vous essayez de lire des pages corrompues.  Par cons√©quent, nous extrayons les donn√©es au point en utilisant diff√©rentes sortes et tailles d'√©chantillon: <br><br><ul><li>  Tri par diff√©rents champs (ID, DateTime); </li><li>  Tri croissant, d√©croissant; </li><li>  Travailler avec de petits groupes de lignes (1000, 100); </li><li>  R√©cup√©ration des travaux par ID. </li></ul><br><br><h6>  03 janvier (mercredi) Jour 13 </h6><br>  <strong>08:58</strong> Poursuite du processus de restauration des documents.  Les documents ont √©t√© restaur√©s uniquement pour des travaux actifs et incomplets.  √Ä ce stade, 1000 ≈ìuvres (actives) sans documents. <br><br>  <strong>11:38</strong> Migration de tous les travaux SQL <br><br>  <strong>13:17</strong> 5 fonctionne sans documents, 231 pas de travail, mais il y a un fichier audio, vous devez resynchroniser. <br><br><h6>  04 janvier (jeudi) Jour 14 </h6><br>  La r√©cup√©ration manuelle et la v√©rification du travail restant ont commenc√©. <br>  Le syst√®me fonctionne, surveille et corrige les erreurs en ligne. <br><br><h6>  05 janvier (vendredi) Jour 15 </h6><br>  La migration des rapports vers SSRS est pr√©vue. <br>  Le transfert vers un nouveau serveur n'est pas possible, car  la clinique a install√© une ancienne version de SQL Server et il ne fonctionnera pas pour transf√©rer la base de donn√©es de l'ancien serveur. <br><br>  Options: <br><br><ul><li>  Mettre √† niveau SQL Server de 2008 √† 2008 R2; </li><li>  Configurez tout √† partir de z√©ro. </li></ul><br>  Il a √©t√© d√©cid√© d'attendre la mise √† jour de SQL Server. <br><br>  <strong>09:21</strong> La restauration en arri√®re-plan des documents pour les travaux termin√©s a commenc√© - le processus est long et prendra plusieurs jours. <br><br>  <strong>13:28</strong> Changement de priorit√© de restauration des documents par les services. <br><br>  <strong>18:18 La</strong> clinique a donn√© acc√®s √† SMTP, configuration du courrier <br><br><h3>  R√©sultat: </h3><br><ul><li>  Presque toutes les donn√©es ont √©t√© restaur√©es (seulement 5 emplois ont √©t√© perdus); </li><li>  Des recommandations sur la maintenance des bases de donn√©es ont √©t√© √©mises pour √©viter de telles situations; </li><li>  Les sauvegardes de base de donn√©es sont configur√©es √† l'aide de SQL Server; </li><li>  Surveillance suppl√©mentaire des sauvegardes de notre part, alertes en cas de panne. </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr432998/">https://habr.com/ru/post/fr432998/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr432988/index.html">Huiti√®me webmaster. En direct sur Habr√©</a></li>
<li><a href="../fr432990/index.html">Lampe en bois √† commande vocale Edison. Prix ‚Äã‚Äãd'√©mission 5 $</a></li>
<li><a href="../fr432992/index.html">Il a mis ses √©couteurs et est mort: nous parlons de la mort √©trange d'un √©colier √† Rimbau</a></li>
<li><a href="../fr432994/index.html">Vivaldi 2.2 - Conversion de quantit√© en qualit√©</a></li>
<li><a href="../fr432996/index.html">Un peu de dictionnaires internes en CPython (et PyPy)</a></li>
<li><a href="../fr433000/index.html">Compilation de Kotlin: JetBrains VS ANTLR VS JavaCC</a></li>
<li><a href="../fr433002/index.html">Venez vous-m√™me ... ou les r√®gles de la communication en √©quipe</a></li>
<li><a href="../fr433004/index.html">Une strat√©gie de migration cloud robuste pour 2019: 7 conseils</a></li>
<li><a href="../fr433008/index.html">Les p√©riph√©riques USB constituent une menace ¬´soudaine¬ª</a></li>
<li><a href="../fr433010/index.html">Avoir une id√©e: syst√®me d'autorisation pour les packages npm</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>