<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©‚Äçüëß‚Äçüëß üßïüèª üê£ Introdu√ß√£o ao MikroTik do firewall da camada 3 üíáüèΩ ü§òüèø ü§¨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O firewall (ou filtro de pacotes) √© um t√≥pico amplo e complexo, tanto em termos te√≥ricos quanto pr√°ticos. Um filtro de pacotes em v√°rios sistemas oper...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Introdu√ß√£o ao MikroTik do firewall da camada 3</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/435070/"><p>  O firewall (ou filtro de pacotes) √© um t√≥pico amplo e complexo, tanto em termos te√≥ricos quanto pr√°ticos.  Um filtro de pacotes em v√°rios sistemas operacionais pode ter seus pr√≥s e contras em compara√ß√£o com outras implementa√ß√µes.  Neste artigo, considerarei exclusivamente o Firewall no RouterOS de olho em suas tabelas de ip progenitoras. </p><a name="habracut"></a><br><h3 id="predislovie">  Pref√°cio </h3><br><h4 id="dlya-kogo-eta-statya">  Para quem √© este artigo? </h4><br><p>  Se voc√™ souber trabalhar com o iptables, v√° em frente e configure um firewall, neste artigo n√£o haver√° nada novo para voc√™ (bem, exceto que cadeias com outros nomes s√£o usadas na tabela NAT).  Se esta √© a primeira vez que voc√™ v√™ um firewall no RouterOS e deseja obter um script pronto para configura√ß√£o, voc√™ n√£o o encontrar√° aqui.  O material √© direcionado √†queles que desejam ter uma id√©ia <strong>b√°sica</strong> de como o firewall funciona e o que acontece com o pacote ip em diferentes est√°gios de seu processamento.  Um entendimento mais profundo vir√° com a experi√™ncia e a solu√ß√£o de problemas cotidianos e incomuns usando um filtro de pacotes. </p><br><h3 id="teoreticheskaya-chast">  Parte te√≥rica </h3><br><h4 id="chto-takoe-layer3-firewall">  O que √© o Layer3 Firewall? </h4><br><p><img src="https://habrastorage.org/webt/ai/xt/od/aixtod5yvn-bvirxxdvwmnm2m30.png"></p><br><p>  Suponha que voc√™ tenha um roteador com acesso √† Internet e duas interfaces de ponte: bridge-lan (ether2-ether5) e bridge-dmz (ether6-ether10). </p><br><p>  Na interface Bridge, os dispositivos encontram independentemente vizinhos de seus pacotes de sub-rede e de troca, o roteador atua como um comutador e n√£o monitora esse tr√°fego no n√≠vel da rede (√© claro, voc√™ pode for√ß√°-lo a fazer isso, mas falaremos sobre o Layer2 Firewall outra vez). </p><br><p>  Se necess√°rio, entre em contato com o dispositivo conectado a outra interface de ponte ou localizado na rede global. Os dispositivos transmitem pacotes ao roteador, que determina a rota e os processa no n√≠vel da rede (Camada 3). </p><br><h4 id="packet-flow-diagram">  Diagrama de fluxo de pacotes </h4><br><p>  O caminho completo do tr√°fego √© descrito no diagrama de fluxo de pacotes, existem v√°rias vers√µes oficiais (v5, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">v6</a> ), elas precisam ser conhecidas e usadas no trabalho di√°rio, mas para entender a opera√ß√£o do filtro de pacotes, elas est√£o sobrecarregadas, portanto, explicarei em uma vers√£o leve. </p><br><p><img src="https://habrastorage.org/webt/cb/fr/uu/cbfruui7ydb8lqm19myzozfotbo.png"></p><br><p>  A interface de entrada / sa√≠da √© qualquer interface de roteador da camada 3 (f√≠sica ou virtual).  Um pacote que vai da rede local para a Internet chega √† interface de entrada e sai da interface de sa√≠da.  Um pacote da Internet para a rede local tamb√©m acessa a interface de entrada e sai da interface de sa√≠da.  O fluxo de pacotes √© sempre lido em uma dire√ß√£o de entrada -&gt; sa√≠da. </p><br><h4 id="osobennosti-terminologii">  Recursos de terminologia </h4><br><p>  Estudando o fluxo de pacotes para o iptables, √© poss√≠vel encontrar descri√ß√µes em "cadeias nas tabelas" ou "tabelas nas cadeias".  O diagrama mostra as tabelas em cadeias; ao adicionar regras ao firewall, tudo ser√° vice-versa. </p><br><p>  Mas, de fato, o pacote se move entre os blocos [chain + tables], por exemplo, se voc√™ aceitar no bloco [prerouting + mangle], o pacote de tr√¢nsito ainda ser√° processado em [forward + mangle].  √â importante lembrar em configura√ß√µes complexas com pbr e filas. </p><br><p>  A documenta√ß√£o do iptables possui defini√ß√µes mais precisas, mas em palavras simples: <br>  <strong>As cadeias</strong> s√£o respons√°veis ‚Äã‚Äãpor onde o pacote √© processado e pela sequ√™ncia de regras. <br>  <strong>As tabelas</strong> determinam as a√ß√µes que podem ser executadas em um pacote. </p><br><h4 id="bazovye-varianty-sledovaniya-paketa">  Pacote b√°sico seguintes op√ß√µes </h4><br><p><img src="https://habrastorage.org/webt/1d/tm/6j/1dtm6j1wiiolczrm215gcz_imss.png"></p><br><p>  <strong>Tr√¢nsito</strong> </p><br><p><img src="https://habrastorage.org/webt/rj/9z/_w/rj9z_w8s9pc4valiwixtkrwpdke.png"></p><br><ol><li>  Um pacote da rede chega a uma das interfaces do roteador </li><li>  Na cadeia PREROUTING, o administrador pode influenciar a rota do pacote: determine a interface de sa√≠da (roteamento da base de pol√≠ticas) ou redirecione para outro endere√ßo (dst-nat). </li><li>  De acordo com a tabela de roteamento do pacote, a interface de sa√≠da √© determinada. </li><li>  A cadeia FORWARD √© o principal local de filtragem para a passagem de tr√°fego. </li><li>  O √∫ltimo item antes de entrar na rede √© a cadeia POSTROUTING, na qual voc√™ pode alterar o endere√ßo do remetente (src-nat). </li><li>  O pacote ficou online. </li></ol><br><p>  <strong>De entrada</strong> </p><br><p><img src="https://habrastorage.org/webt/qn/l8/gd/qnl8gdad6vpxhgdjnhvhpzngcau.png"></p><br><ol><li>  Um pacote da rede chegou a uma das interfaces do roteador </li><li>  Bata na cadeia PREROUTING. </li><li>  De acordo com a tabela de roteamento, o pacote foi enviado para processamento no processo local. </li><li>  A cadeia INPUT filtra o tr√°fego recebido pelo administrador. </li><li>  O pacote foi processado pelo processo local. </li></ol><br><p>  <strong>Sa√≠da</strong> </p><br><p><img src="https://habrastorage.org/webt/jh/qr/sd/jhqrsd8rq3lt8x1s3jzjuup_m-8.png"></p><br><ol><li>  Um dos processos do roteador gerou um pacote IP (novo ou resposta - isso n√£o importa). </li><li>  De acordo com a tabela de roteamento, uma interface de sa√≠da √© definida para o pacote. </li><li>  O administrador pode filtrar o tr√°fego de sa√≠da ou alterar a rota na cadeia OUTPUT. </li><li>  Para o pacote, √© tomada a decis√£o final sobre a interface de sa√≠da. </li><li>  O pacote cai em POSTROUTING, assim como o tr√°fego que <em>passa</em> . </li><li>  O pacote ficou online. </li></ol><br><h4 id="connection-tracker">  Rastreador de conex√£o </h4><br><p>  Primeiro, voc√™ precisa entender o que s√£o filtros de pacotes com e sem estado. </p><br><p><img src="https://habrastorage.org/webt/8c/lg/7z/8clg7zcfasexwuw3e3utjyhypl8.png"></p><br><p>  Um exemplo  O computador 192.168.100.10 abre uma conex√£o tcp com o servidor 192.0.2.10.  No lado do cliente, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">a porta din√¢mica</a> 49149 √© usada, no lado do servidor 80. Antes de o conte√∫do ser recebido, o cliente e o servidor devem trocar pacotes para estabelecer uma sess√£o tcp. </p><br><p>  No <em>estado sem estado, √©</em> necess√°rio abrir o tr√°fego da rede local para a Internet e da Internet para a rede local (pelo menos para o intervalo de portas din√¢micas).  Que como um todo √© um buraco. </p><br><p>  Em um roteador <em>stateful</em> , ele analisa os pacotes e, tendo recebido o tcp syn de 192.168.100.10:49149 para 192.0.2.10:80, considera isso o in√≠cio de uma nova conex√£o.  Todos os pacotes adicionais (em qualquer dire√ß√£o) entre 192.168.100.10:49149 e 192.0.2.10:80 ser√£o considerados parte da conex√£o estabelecida at√© que a sess√£o tcp seja fechada ou que os temporizadores expirem. </p><br><p>  Para UDP / ICMP e outros tipos de tr√°fego, onde o in√≠cio e o fim da conex√£o n√£o podem ser claramente distinguidos, o primeiro pacote √© o primeiro, o restante √© considerado parte da conex√£o estabelecida e atualiza os cron√¥metros, o roteador esquece essas conex√µes depois que os cron√¥metros expiram. </p><br><p>  O rastreador de conex√£o divide os pacotes em v√°rios tipos: </p><br><p><img src="https://habrastorage.org/webt/j2/do/3f/j2do3fsdj1-t-hq7p2wnf0pnqte.png"></p><br><p>  <em>novo</em> - um pacote que abre uma conex√£o, por exemplo, <em>syn</em> for tcp ou o primeiro pacote em um fluxo udp. <br>  <em>estabelecido</em> - um pacote relacionado a uma conex√£o conhecida. <br>  <em>related</em> - pacote relacionado √† conex√£o adicional no multiprotocolo (sip, pptp, ftp, ...). <br>  <em>inv√°lido</em> - pacote de uma conex√£o desconhecida. <br>  n√£o rastreado - pacote n√£o rastreado rastreador de conex√£o. </p><br><p>  <strong>Configura√ß√£o do rastreador de conex√£o</strong> <br>  enabled = yes - ativado. <br>  ativado = n√£o - desativado. <br>  enabed = desativado automaticamente at√© que uma regra que use os recursos do conntrack apare√ßa no firewall.  √â usado por padr√£o. </p><br><p><img src="https://habrastorage.org/webt/a9/2b/tl/a92btlt5yfxh9fhf7-wmpgrohbu.png"></p><br><p>  Os par√¢metros restantes s√£o temporizadores diferentes e geralmente n√£o requerem sintonia. </p><br><p>  O administrador pode visualizar e excluir conex√µes, por exemplo, a conex√£o com o NAT se parece com isso: </p><br><p><img src="https://habrastorage.org/webt/mb/i7/7x/mbi77x9oinpcys1ohb516glu4mc.png"></p><br><p>  O uso do conntrack afeta o desempenho e o consumo de recursos (especialmente com um grande n√∫mero de conex√µes), mas n√£o funciona na maioria das configura√ß√µes, pois  voc√™ ter√° um firewall sem estado sem NAT. </p><br><div class="spoiler">  <b class="spoiler_title">Lista de fun√ß√µes dependentes do rastreador de conex√£o</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/la/td/kz/latdkzskcwi9cx2o4lkdwtehps8.png"></p></div></div><br><h4 id="ttl">  TTL </h4><br><p>  Time To Live - um campo no cabe√ßalho do pacote IP que define o n√∫mero de roteadores pelos quais um pacote pode passar antes de ser destru√≠do, protege contra o encaminhamento de pacotes sem fim durante os loops de roteamento. </p><br><p><img src="https://habrastorage.org/webt/gp/qi/js/gpqijsw0wgsu2yqrkcamd3z0mhk.png"></p><br><p>  Ao encaminhar, o roteador diminui o valor TTL em 1, se TTL = 0.  Nesse caso, um pacote com TTL = 1 chegar√° ao processo local do roteador. </p><br><p>  Algumas operadoras usam truques TTL para impedir o uso de roteadores.  Todas essas limita√ß√µes valem o valor ttl na tabela mangle. </p><br><h4 id="nat">  NAT </h4><br><p>  Tradu√ß√£o de endere√ßos de rede - tecnologia para alterar endere√ßos no cabe√ßalho do pacote ip.  Como o Linux, o NAT faz parte do filtro de pacotes.  O NAT funciona com base no rastreador de conex√£o. </p><br><p>  Inicialmente, o NAT foi projetado como uma solu√ß√£o r√°pida para o problema de exaust√£o de endere√ßos IPv4; para redes locais, foi proposto o uso de uma sub-rede nos intervalos: 10.0.0.0/8;  172.16.0.0/12;  192.168.0.0/16 e converta-os em um (ou v√°rios) endere√ßos rote√°veis.  De fato, existem mais algumas sub-redes de servi√ßo que podem ser usadas em redes privadas e o roteador, em princ√≠pio, √© o mesmo que o NAT, mas √© recomend√°vel seguir os padr√µes. </p><br><p>  Apenas processos NAT: tcp, udp, icmp e alguns protocolos m√∫ltiplos de [IP] -&gt; [Firewall] -&gt; [Service Port].  Somente o primeiro pacote (estado da conex√£o = novo) na conex√£o √© processado, os pacotes restantes s√£o processados ‚Äã‚Äãautomaticamente sem a participa√ß√£o da tabela NAT.  Isso pode ser rastreado pela altera√ß√£o nos contadores nas regras. </p><br><p>  O cabe√ßalho do pacote cont√©m os endere√ßos de origem e de destino, respectivamente, e o NAT √© dividido em NAT de origem e de destino. </p><br><p>  <strong>Origem</strong> falsifica√ß√£o de endere√ßo do remetente <strong>NAT</strong> , presente na grande maioria dos roteadores dom√©sticos e corporativos do mundo. </p><br><p><img src="https://habrastorage.org/webt/2s/ej/or/2sejor290wkc26agkonobacposa.png"></p><br><p>  Ele permite que muitos dispositivos com endere√ßos "cinza" na rede local se comuniquem com a Internet usando um (ou v√°rios) endere√ßos reais. </p><br><p><img src="https://habrastorage.org/webt/hh/hi/du/hhhidurhkrsiiuflmg6dakupph8.png"></p><br><p>  Voltando ao fluxo de pacotes, vemos que o SRC-NAT est√° no Postrouting, depois de decidir se deve encaminhar o pacote. </p><br><p>  O pacote de resposta passa por <em>um</em> DST-NAT <em>impl√≠cito</em> no qual o endere√ßo do destinat√°rio √© alterado para local. </p><br><p>  <strong>NAT de destino</strong> - substitui√ß√£o do endere√ßo do destinat√°rio. </p><br><p><img src="https://habrastorage.org/webt/id/rb/l9/idrbl9jdlfgfvbftjkgwoorszae.png"></p><br><p>  √â usado, se necess√°rio, para encaminhar o pacote para outro endere√ßo, geralmente √© usado para "encaminhar portas" da rede externa para a local. </p><br><p><img src="https://habrastorage.org/webt/ju/uv/ly/juuvlyxr74gi8qykxx80vzhyvg4.png"></p><br><p>  De acordo com o Packet Flow, a opera√ß√£o DST-NAT ocorre antes da tomada de decis√£o sobre o roteamento no Pr√©-roteamento; SRC-NAT <em>impl√≠cito</em> est√° presente para o tr√°fego de resposta. </p><br><p>  O NAT √© uma ferramenta de gerenciamento de tr√°fego bastante poderosa, mas deve ser usada por √∫ltimo (quando outras ferramentas n√£o puderem ajudar). </p><br><h4 id="cepochkichains-bazovye-i-polzovatelskie">  Correntes (correntes) b√°sicas e de usu√°rio </h4><br><p>  As cadeias consistem em regras e for√ßam a l√≥gica do processamento de pacotes. <br>  Existem v√°rias cadeias b√°sicas mapeadas para o fluxo de pacotes: <br>  <strong>Pr√©-roteamento (dstnat)</strong> - processamento de pacotes antes de decidir sobre o roteamento <br>  Pacotes de processamento de <strong>entrada</strong> destinados aos processos locais do roteador <br>  <strong>Sa√≠da</strong> - pacotes de processamento de pacotes gerados pelos processos locais do roteador <br>  <strong>Encaminhar</strong> - Processando Tr√°fego de Passagem <br>  <strong>Postrouting (srcnat)</strong> - Processando o tr√°fego pronto para transmiss√£o √† interface </p><br><p>  <em>Tudo √© como no iptables, mas as cadeias no nat s√£o renomeadas.</em>  <em>O que isso est√° conectado (provavelmente com hotspot ou descarregamento de hardware nat) √© desconhecido para mim, mas n√£o muda nada.</em> </p><br><p>  O pacote passa as regras na cadeia sequencialmente, se for adequado para todas as condi√ß√µes, a a√ß√£o ser√° aplicada ao pacote.  Se a a√ß√£o estiver finalizando e n√£o soltar o pacote, ela ser√° passada para o pr√≥ximo bloco de fluxo de pacotes. </p><br><p>  Todas as cadeias de base t√™m uma a√ß√£o padr√£o (se o pacote n√£o couber em nenhuma das regras) - <em>aceite</em> . </p><br><p>  Cadeias personalizadas s√£o necess√°rias para reduzir o n√∫mero de regras que cada pacote passa e criar regras complexas para o processamento de tr√°fego.  Todas as cadeias de usu√°rios t√™m uma a√ß√£o padr√£o - <em>return</em> . </p><br><p><img src="https://habrastorage.org/webt/bk/rg/sk/bkrgskh5wudzzf54mueqiy9oehk.png"></p><br><p>  Dentro da tabela, voc√™ pode encaminhar as regras de v√°rias cadeias base (e usu√°rio) diferentes para a cadeia de usu√°rios, mas o pacote retornar√° √† cadeia da qual veio. </p><br><p><img src="https://habrastorage.org/webt/_8/kw/oi/_8kwoirut9mtd67elbejqkzdsek.png"></p><br><h4 id="usloviya-v-pravilah">  Termos e Condi√ß√µes Gerais </h4><br><p>  Cadeias consistem em regras, cada regra consiste em condi√ß√µes e a√ß√µes.  Existem muitas condi√ß√µes, mas nem todos voc√™s usar√£o em configura√ß√µes reais.  A maioria das condi√ß√µes pode ser prefixada com "not" (sinal "!").  Para coincidir com a regra, o pacote deve ser adequado para todas essas condi√ß√µes. </p><br><p><img src="https://habrastorage.org/webt/la/dh/or/ladhorisauzv81cnmffmkjo6_hi.png"></p><br><div class="spoiler">  <b class="spoiler_title">Algumas das condi√ß√µes</b> <div class="spoiler_text"><table><thead><tr><th>  Condi√ß√£o </th><th>  Descri√ß√£o do produto </th></tr></thead><tbody><tr><td>  src-address </td><td>  Endere√ßo de origem </td></tr><tr><td>  endere√ßo dst </td><td>  Endere√ßo do destinat√°rio </td></tr><tr><td>  src-address-list </td><td>  O endere√ßo de origem est√° listado. </td></tr><tr><td>  lista de endere√ßos dst </td><td>  O endere√ßo do destinat√°rio est√° listado </td></tr><tr><td>  protocolo </td><td>  Protocolo da camada de transporte </td></tr><tr><td>  src-port </td><td>  Porta de origem </td></tr><tr><td>  dst-port </td><td>  Porta do Destinat√°rio </td></tr><tr><td>  porta </td><td>  Porta de origem ou destino </td></tr><tr><td>  na interface </td><td>  A interface na qual o pacote veio </td></tr><tr><td>  interface externa </td><td>  A interface da qual o pacote ser√° enviado para a rede </td></tr><tr><td>  na lista de interface </td><td>  A interface para a qual o pacote veio √© listada </td></tr><tr><td>  lista de interface externa </td><td>  A interface da qual o pacote ser√° enviado para a rede est√° listada </td></tr><tr><td>  protocolo layer7 </td><td>  An√°lise do conte√∫do dos 10 primeiros pacotes em uma conex√£o </td></tr><tr><td>  conte√∫do </td><td>  Procure uma determinada sequ√™ncia em um lote </td></tr><tr><td>  tls-host </td><td>  Host de pesquisa no cabe√ßalho tls </td></tr><tr><td>  ipsec-policy </td><td>  Verifique se o pacote corresponde √† pol√≠tica ipsec ou n√£o </td></tr><tr><td>  tamanho do pacote </td><td>  tamanho do pacote em bytes </td></tr><tr><td>  src-mac-address </td><td>  endere√ßo de origem do pacote mac </td></tr><tr><td>  marca de conex√£o </td><td>  Etiqueta de conex√£o </td></tr><tr><td>  marca de pacote </td><td>  Etiqueta do pacote </td></tr><tr><td>  marca de roteamento </td><td>  Waypoint do pacote </td></tr><tr><td>  estado da conex√£o </td><td>  Status do pacote de conex√£o </td></tr><tr><td>  tcp-flags </td><td>  Pacote tcp de sinalizadores </td></tr><tr><td>  icmp-options </td><td>  Op√ß√µes de pacote ICMP </td></tr><tr><td>  aleat√≥rio </td><td>  A regra √© acionada (quando outras condi√ß√µes coincidem) com uma determinada probabilidade </td></tr><tr><td>  tempo </td><td>  Voc√™ pode especificar o hor√°rio de trabalho da regra, infelizmente sem uma convers√£o de data </td></tr><tr><td>  ttl </td><td>  Valor do campo ttl no pacote </td></tr><tr><td>  dscp </td><td>  Valor do campo DSCP (ToS) no pacote </td></tr><tr><td>  - // - </td><td>  - // - </td></tr><tr><td>  lugar antes </td><td>  Op√ß√£o de console (sem condi√ß√£o), permite adicionar uma regra antes do especificado </td></tr><tr><td>  desabilitado </td><td>  Op√ß√£o de console (n√£o condi√ß√£o), permite desativar a regra </td></tr></tbody></table><br><p>  <strong>Anota√ß√µes</strong> <br>  Como Endere√ßo src. (Dst.), Voc√™ pode especificar: um √∫nico ip, um intervalo de endere√ßos por meio de um h√≠fen ou uma sub-rede. <br>  S√£o necess√°rias listas de endere√ßos para combinar v√°rios ip n√£o conectados com o mesmo nome.  Diferentemente do ipset no netfilter, as entradas nas listas do MikroTik podem ser exclu√≠das ap√≥s um per√≠odo especificado.  Voc√™ pode visualizar as listas e fazer altera√ß√µes em [IP] -&gt; [Firewall] -&gt; [Listas de endere√ßos]. <br>  Como n√∫mero da porta (porta, src-porta, dst-porta), voc√™ pode especificar uma √∫nica porta, v√°rias portas separadas por v√≠rgulas ou um intervalo de portas atrav√©s de um h√≠fen. </p></div></div><br><p>  No √∫ltimo MUM no MSC, houve uma boa apresenta√ß√£o sobre o efeito de v√°rias condi√ß√µes na velocidade de processamento de pacotes (l√° voc√™ aprender√° como usar a tabela bruta para reduzir a carga no roteador), interessados ‚Äã‚Äãem: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">grava√ß√£o</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">apresenta√ß√£o</a> . </p><br><h4 id="deystviya-v-tablicah">  A√ß√µes de tabelas </h4><br><p>  O conjunto de a√ß√µes dispon√≠veis no pacote depende da tabela em que √© processado. <br><img src="https://habrastorage.org/webt/i3/ba/xj/i3baxjyyz-fnswxpanh_qek5kq8.png"><br>  <strong>Filtro</strong> - tabela de filtragem de tr√°fego, um dos dois lugares onde voc√™ pode soltar o pacote. </p><br><p>  <strong>NAT</strong> - tabela para modificar endere√ßos e portas IP (tpc, udp) no cabe√ßalho do pacote ip. </p><br><p>  <strong>Mangle</strong> - uma tabela para modificar outros campos do pacote ip e configurar v√°rios r√≥tulos. </p><br><p><img src="https://habrastorage.org/webt/w0/dc/n3/w0dcn3uinajpugbflfjha0pt5jy.png"></p><br><p>  Existem tr√™s tipos de etiquetas de pacotes internos: conex√£o, pacote, rota.  As etiquetas existem apenas dentro do roteador e n√£o v√£o para a rede.  Um pacote pode ter um r√≥tulo de cada tipo e, ao passar v√°rias regras mark- * em sequ√™ncia, os r√≥tulos s√£o substitu√≠dos. <br>  Os r√≥tulos de rota podem ser configurados apenas nas cadeias de pr√©-roteamento e sa√≠da, o restante em todas as cadeias. </p><br><p>  √â uma boa pr√°tica marcar primeiro a conex√£o, depois o pacote (pacote) ou a rota (rota).  A verifica√ß√£o de etiquetas √© mais r√°pida que os campos de pacotes.  Na pr√°tica, esse nem sempre √© o caso em filas complexas ou a marca√ß√£o adicional da conex√£o pbr n√£o √© √∫til. </p><br><p>  <strong>RAW</strong> - uma tabela que permite que os pacotes ignorem o rastreador de conex√£o.  √â usado para neutralizar o DoS e reduzir a carga na CPU (por exemplo, eliminando o tr√°fego multicast).  Permite soltar o pacote. </p><br><p>  As a√ß√µes de t√©rmino concluem o processamento de um pacote na cadeia e o passam para o pr√≥ximo bloco no fluxo de pacotes, ou descarte-o. </p><br><div class="spoiler">  <b class="spoiler_title">Ac√ß√µes</b> <div class="spoiler_text"><table><thead><tr><th>  Quadro </th><th>  Ac√ß√£o </th><th>  Descri√ß√£o do produto </th><th>  Terminando? </th></tr></thead><tbody><tr><td>  Todos </td><td>  aceitar </td><td>  Pare de processar o pacote e transfira-o para o pr√≥ximo bloco de fluxo Pakcet </td><td>  Sim </td></tr><tr><td>  Todos </td><td>  registro </td><td>  Informa√ß√µes do pacote de log. Nas vers√µes modernas, voc√™ pode adicionar log a qualquer outra a√ß√£o. </td><td>  N√£o </td></tr><tr><td>  Todos </td><td>  passagem </td><td>  Conte o n√∫mero de pacotes.  Usado para depura√ß√£o </td><td>  N√£o </td></tr><tr><td>  Todos </td><td>  adicione src √† lista de endere√ßos e adicione dst √† lista de endere√ßos </td><td>  Adicione o endere√ßo de origem (destino) do pacote √† lista fornecida </td><td>  N√£o </td></tr><tr><td>  Todos </td><td>  pular </td><td>  Ir para a cadeia de usu√°rios </td><td>  Sim </td></tr><tr><td>  Todos </td><td>  retornar </td><td>  Retornar √† cadeia pai.  Nas cadeias de base, funciona como aceitar </td><td>  Sim </td></tr><tr><td>  Filtro e Raw </td><td>  cair </td><td>  Pare o fluxo de pacotes no fluxo de pacotes e descarte </td><td>  Sim </td></tr><tr><td>  Filtro e Pr√©-roteamento </td><td>  fasttrack </td><td>  Pacote de sinalizador para fluxo r√°pido de pacotes </td><td>  Sim </td></tr><tr><td>  Filtro </td><td>  rejeitar </td><td>  Como queda, mas um remetente de pacote recebe uma notifica√ß√£o (tcp ou icmp) sobre o pacote descartado </td><td>  Sim </td></tr><tr><td>  Filtro </td><td>  armadilha </td><td>  Emule a presen√ßa de uma porta aberta.  Usado para prote√ß√£o contra DoS, enganosa e (√†s vezes) depura√ß√£o </td><td>  Sim </td></tr><tr><td>  NAT </td><td>  src-nat </td><td>  Substitui√ß√£o do endere√ßo do remetente pelo especificado </td><td>  Sim </td></tr><tr><td>  NAT </td><td>  mascarar </td><td>  Um caso especial de src-nat, substitui o endere√ßo do remetente por um dos endere√ßos da interface, √© usado em interfaces din√¢micas (dhcp, vpn).  N√£o √© recomend√°vel usar se houver v√°rios ip na interface </td><td>  Sim </td></tr><tr><td>  NAT </td><td>  o mesmo </td><td>  Um caso especial de src-nat.  Substitui o endere√ßo do remetente por um endere√ßo do intervalo especificado </td><td>  Sim </td></tr><tr><td>  NAT </td><td>  dst-nat </td><td>  Substitui o endere√ßo do destinat√°rio pelo especificado </td><td>  Sim </td></tr><tr><td>  NAT </td><td>  redirecionar </td><td>  Um caso especial de dst-nat, substitui o endere√ßo do destinat√°rio pelo endere√ßo da interface do roteador ao qual o pacote veio </td><td>  Sim </td></tr><tr><td>  NAT </td><td>  netmap </td><td>  N√£o √© um substituto para o dst-nat.  Usado para tradu√ß√£o rede a rede, veja exemplos </td><td>  Sim </td></tr><tr><td>  Mangle </td><td>  marcar conex√£o </td><td>  Etiqueta de conex√£o </td><td>  N√£o </td></tr><tr><td>  Mangle </td><td>  marcar pacote </td><td>  R√≥tulo de pacote aplicado em filas </td><td>  N√£o </td></tr><tr><td>  Mangle </td><td>  marcar roteamento </td><td>  R√≥tulo de rota aplicado no roteamento da base de diretiva </td><td>  N√£o </td></tr><tr><td>  Mangle </td><td>  mudar ttl </td><td>  Editar ttl </td><td>  N√£o </td></tr><tr><td>  Mangle </td><td>  alterar dcsp (tos) </td><td>  Alterar decimal dcsp </td><td>  N√£o </td></tr><tr><td>  Mangle </td><td>  mudar mss </td><td>  Alterar mss para tcp syn </td><td>  N√£o </td></tr><tr><td>  Mangle </td><td>  limpar df </td><td>  Sinalizador de limpar n√£o fragmentar </td><td>  N√£o </td></tr><tr><td>  Mangle </td><td>  op√ß√µes de strip ipv4 </td><td>  Op√ß√µes avan√ßadas de ipv4 </td><td>  N√£o </td></tr><tr><td>  Mangle </td><td>  definir prioridade </td><td>  Definir prioridade para CoS </td><td>  N√£o </td></tr><tr><td>  Mangle </td><td>  rota </td><td>  Defina o gateway para o pacote.  Vers√£o simples do PBR </td><td>  N√£o </td></tr><tr><td>  Mangle </td><td>  cheirar tzsp </td><td>  Encapsular pacotes no udp e enviar para o ip especificado </td><td>  N√£o </td></tr><tr><td>  Mangle </td><td>  cheirar pc </td><td>  Um an√°logo de tzsp, mas com um tipo diferente de encapsulamento.  No wiki, se casos de uso com calea </td><td>  N√£o </td></tr><tr><td>  Mangle </td><td>  passagem </td><td>  Por padr√£o, a maioria das regras do mangle n√£o impede a passagem do pacote, voc√™ pode alterar esse comportamento definindo passtrough = no </td><td>  N√£o </td></tr><tr><td>  Raw </td><td>  notrack </td><td>  N√£o rastrear pacote no rastreador de conex√£o </td><td>  Sim </td></tr></tbody></table><br><p>  <em>Se houver quem deseje, posso escrever mais sobre o FastTrack e o FastPath, mas voc√™ n√£o deve esperar milagres com essas tecnologias.</em> </p></div></div><br><h4 id="para-slov-pro-dpi">  Algumas palavras sobre o DPI </h4><br><p>  Existem v√°rias possibilidades de examinar o pacote um pouco mais profundo do que o cabe√ßalho da camada de transporte: <br>  <em>content</em> - procura por uma determinada string em um pacote. <br>  <em>layer7-protocol</em> - armazena em buffer os primeiros 10 pacotes (ou 2KiB) da conex√£o e procura regexp em dados armazenados em buffer.  Um grande n√∫mero de regras da camada7 afeta significativamente o desempenho. <br>  <em>tls-host</em> √© o endere√ßo do nome do host no cabe√ßalho TLS / SNI de uma conex√£o HTTPS. </p><br><h3 id="primery">  Exemplos </h3><br><p>  N√£o copie os exemplos sem pensar, √© melhor usar o dispositivo e tentar escrever a configura√ß√£o voc√™ mesmo (ou reescrever os exemplos, mas aprofundar-se no que cada uma das regras faz).  Se voc√™ n√£o sabe como complementar as regras: nas configura√ß√µes padr√£o e m√≠nima da casa, n√£o h√° acesso ao roteador a partir da interface wan, adicione-o com filtragem pela lista de endere√ßos. </p><br><h4 id="defoltnyy-firewall-routeros">  RouterOS de firewall padr√£o </h4><br><p>  Uma configura√ß√£o bastante segura, mas em locais muito confusos: </p><br><pre><code class="plaintext hljs">/ip firewall filter #     (established, related)   (untracked)  add action=accept chain=input connection-state=established,related,untracked #    (invalid)  add action=drop chain=input connection-state=invalid #  icmp  add action=accept chain=input protocol=icmp #          add action=drop chain=input in-interface-list=!LAN #   ipsec    add action=accept chain=forward ipsec-policy=in,ipsec add action=accept chain=forward ipsec-policy=out,ipsec #          add action=fasttrack-connection chain=forward connection-state=established,related #       add action=accept chain=forward connection-state=established,related,untracked #    add action=drop chain=forward connection-state=invalid #     wan ,     dstnat (,      src-nat   dst-nat) add action=drop chain=forward connection-nat-state=!dstnat connection-state=new in-interface-list=WAN /ip firewall nat #Source NAT      ipsec,      WAN add action=masquerade chain=srcnat ipsec-policy=out,none out-interface-list=WAN</code> </pre> <br><p>  Eu nunca usei a configura√ß√£o padr√£o, mas antes o firewall padr√£o era muito pior. </p><br><h4 id="minimalnyy-domashniy-firewall">  Firewall dom√©stico m√≠nimo </h4><br><p>  A coisa mais f√°cil de fazer.  Sim, o tr√°fego n√£o rastreado n√£o √© permitido nele (mas no est√°gio do estudo b√°sico do firewall voc√™ ainda n√£o precisa dele) e haver√° problemas com o ipsec do t√∫nel (novamente, se voc√™ pode configurar o ipsec, voc√™ mesmo sabe o que precisa ser feito). </p><br><pre> <code class="plaintext hljs">/ip firewall filter #     (established, related)  add chain=input connection-state=established,related action=accept #  icmp  add chain=input connection-state=new protocol=icmp action=accept #      add chain=input connection-state=new in-interface-list=LAN action=accept #     add chain=input action=drop #       add chain=forward connection-state=established,related action=accept #         add chain=forward connection-state=new in-interface-list=LAN action=accept #     add chain=forward action=drop /ip firewall nat #Source NAT        WAN add chain=srcnat out-interface-list=WAN action=masquerade</code> </pre> <br><h4 id="primer-s-dmz">  Exemplo DMZ </h4><br><p>  Nos roteadores "dom√©sticos", o acr√¥nimo DMZ gosta de chamar um computador na sub-rede local para o qual todas as portas da rede externa s√£o encaminhadas. </p><br><p>  De fato, n√£o √© assim, e uma das op√ß√µes da DMZ √© separar o recurso ao qual voc√™ deve fornecer acesso da Internet e um ataque bem-sucedido pode ser realizado (um servidor da Web com cms no qual buracos s√£o encontrados constantemente √© um bom alvo para um invasor).  No caso de hackers, um invasor n√£o poder√° afetar os participantes na rede local. </p><br><p><img src="https://habrastorage.org/webt/bb/pp/9g/bbpp9gbe7k4owuef7hxuzisrurg.png"></p><br><pre> <code class="plaintext hljs">#  /ip firewall nat add chain=dstnat dst-port=80,443 action=dst-nat to-address=192.168.200.2 /ip firewall filter #   icmp   add chain=input connection-state=established,related action=accept add chain=input protocol=icmp connection-state=new action=accept #      add chain=input in-interface=ether2-lan action=accept #    add chain=input action=drop #    add chain=forward connection-state=established,related action=accept #        add chain=forward in-interface=ether2-lan connection-state=new action=accept #    web  add chain=forward out-interface=ether3-dmz dst-address=192.168.200.2 dst-port=80,443 connection-state=new action=accept #   add chain=forward action=drop</code> </pre> <br><h4 id="hairpin-nat">  Hairpin NAT </h4><br><p><img src="https://habrastorage.org/webt/r5/ms/wv/r5mswv8kwtp0m3amzpl--bd5fn0.png"></p><br><pre> <code class="plaintext hljs">/ip firewall nat add chain=dstnat dst-port=80 action=dst-nat to-address=192.168.100.2</code> </pre> <br><p>  Uma situa√ß√£o t√≠pica √© quando voc√™ encaminha uma porta para um servidor em uma rede local e tudo funciona de fora, mas dentro da rede local o servidor n√£o est√° acess√≠vel em um endere√ßo externo. </p><br><p>  Vamos ver o que acontece: </p><br><ol><li>  O computador 192.168.100.10 envia uma solicita√ß√£o para 192.0.2.100 </li><li>  Ele executa o DST-NAT no roteador e o pacote √© encaminhado para 192.168.100.2 </li><li>  O servidor v√™ que um pacote de 192.168.100.10 chegou a ele no endere√ßo 192.168.100.2 e est√° respondendo a partir do endere√ßo local </li><li>  O computador recebe um pacote inesperado de 192.168.100.2 e o descarta. </li></ol><br><p>  A solu√ß√£o √© adicionar uma regra adicional que altere o endere√ßo de origem para o endere√ßo do roteador, para que o servidor retorne o pacote ao roteador, que o enviar√° ao computador inicializador. </p><br><pre> <code class="plaintext hljs">/ip firewall nat #  add chain=dstnat dst-port=80 action=dst-nat to-address=192.168.100.2 # ,      add chain=srcnat src-address=192.168.100.0/24 dst-address=192.168.100.2 action=masquerade</code> </pre> <br><p>  Na pr√°tica, esse esquema n√£o √© usado com frequ√™ncia, mas, como exemplo de depura√ß√£o de um firewall, eu realmente gosto dele. </p><br><h4 id="pravilnoe-ispolzovanie-netmap">  Uso adequado do netmap </h4><br><p><img src="https://habrastorage.org/webt/l9/xa/ox/l9xaoxkyat1phpmy6tnnhau6nls.png"><br>  O Netmap √© uma tecnologia para converter endere√ßos de uma sub-rede para os endere√ßos de outra sub-rede. <br>  O endere√ßo IP (na entrada da m√°scara) consiste em duas partes: a rede (o n√∫mero de bits especificado na m√°scara de sub-rede) e o host (bits restantes).  O Netmap altera a parte da rede do endere√ßo, mas n√£o toca na parte do host. </p><br><p><img src="https://habrastorage.org/webt/jy/eh/xh/jyehxh3hok1l5-wfw6c8n4czdlu.png"></p><br><p>  Existem dois roteadores conectados por um canal VPN.  Os roteadores servem sub-redes com o mesmo endere√ßamento.  √â necess√°rio fazer o acesso entre sub-redes. </p><br><p>  Voc√™ n√£o pode ficar sem endere√ßamento adicional. </p><br><p>  Os usu√°rios da sub-rede esquerda bater√£o para a direita atrav√©s da sub-rede 192.168.102.0/24 <br>  Os usu√°rios da sub-rede direita bater√£o para a esquerda na sub-rede 192.168.101.0/24 </p><br><p>  Configura√ß√£o no MikroTik 1. </p><br><pre> <code class="plaintext hljs">#     /ip route add distance=1 dst-address=192.168.102.0/24 gateway /ip firewall nat #       add action=netmap chain=srcnat dst-address=192.168.102.0/24 out-interface=ipip src-address=192.168.100.0/24 to-address=192.168.101.0/24 #       add action=netmap chain=dstnat dst-address=192.168.101.0/24 in-interface=ipip src-address=192.168.102.0/24 to-address=192.168.100.0/24</code> </pre> <br><p>  A configura√ß√£o do MikroTik2 √© quase a mesma: </p><br><pre> <code class="plaintext hljs">/ip route add distance=1 dst-address=192.168.101.0/24 gateway=10.10.10.1 /ip firewall nat add action=netmap chain=srcnat dst-address=192.168.101.0/24 out-interface=ipip src-address=192.168.100.0/24 to-address=192.168.102.0/24 add action=netmap chain=dstnat dst-address=192.168.102.0/24 in-interface=ipip src-address=192.168.101.0/24 to-address=192.168.100.0/24</code> </pre> <br><p>  Existem configura√ß√µes mais complexas usando o netmap, por exemplo, se voc√™ tiver muitas conex√µes com pontos remotos com sub-redes que se cruzam e n√£o houver maneira de alterar as configura√ß√µes no equipamento remoto, mas isso j√° √© um roteamento avan√ßado. </p><br><p>  Se voc√™ n√£o entende nada (sobre o netmap), n√£o precisa disso e simplesmente n√£o usa esta a√ß√£o ao encaminhar portas. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt435070/">https://habr.com/ru/post/pt435070/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt435054/index.html">Universidade ITMO "na pr√°tica": com que empresas de tecnologia cooperamos</a></li>
<li><a href="../pt435056/index.html">Samsung SSD 860 QVO 1 TB e 4 TB: o primeiro consumidor SATA QLC (3 partes)</a></li>
<li><a href="../pt435060/index.html">2018 foi o ano da scooter. O que vem a seguir?</a></li>
<li><a href="../pt435062/index.html">Guia: Thymeleaf + Spring. Parte 1</a></li>
<li><a href="../pt435064/index.html">Montamos o aspirador Xiaomi</a></li>
<li><a href="../pt435072/index.html">Mem√≥ria anal√≥gica de 8 bits para trabalhar com redes neurais</a></li>
<li><a href="../pt435074/index.html">Vulnerabilidades do Kyivstar: 1) an√°lise de um post anterior sobre senhas + 2) informa√ß√µes sobre compras que passam pelos servi√ßos Kyivstar</a></li>
<li><a href="../pt435076/index.html">Como os profissionais de marketing que trabalham com o Google monetizam nosso desconforto</a></li>
<li><a href="../pt435078/index.html">E se a intelig√™ncia artificial tornar os atores imortais?</a></li>
<li><a href="../pt435080/index.html">Guia: Thymeleaf + Spring. Parte 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>