<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üé± ‚ùáÔ∏è üëó Embox sur processeur Elbrus. Ou n'oublie jamais ce que tu as en intelligence üòÇ üë®üèª‚ÄçüöÄ üç∏</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Cet article est la conclusion logique d'une s√©rie d' articles sur l' escalade d'Elbrus sur l'introduction d' Embox √† l' architecture de processeur Elb...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Embox sur processeur Elbrus. Ou n'oublie jamais ce que tu as en intelligence</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/embox/blog/485694/"><img src="https://habrastorage.org/webt/ic/4z/5o/ic4z5olelesc04boln85goculk4.png" align="right" width="320">  Cet article est la conclusion logique d'une <a href="https://habr.com/ru/company/embox/blog/447704/">s√©rie d'</a> <a href="https://habr.com/ru/company/embox/blog/447744/">articles</a> sur l' <a href="https://habr.com/ru/company/embox/blog/421441/">escalade d'Elbrus</a> sur l'introduction d' <a href="http://embox.github.io/">Embox</a> √† l' <a href="https://ru.wikipedia.org/wiki/%25D0%25AD%25D0%25BB%25D1%258C%25D0%25B1%25D1%2580%25D1%2583%25D1%2581_2000">architecture de processeur Elbrus (E2K)</a> .  Pourquoi une conclusion logique, car en cons√©quence, il √©tait possible d'ex√©cuter via telnet une application qui affiche l'image √† l'√©cran, c'est-√†-dire pour r√©aliser le fonctionnement complet d'Embox sur cette architecture.  De nouvelles recherches peuvent difficilement √™tre qualifi√©es d'introduction, bien que, bien s√ªr, beaucoup de choses restent floues.  Et l'architecture elle-m√™me poss√®de de nombreuses fonctionnalit√©s int√©ressantes, qui ne sont pas non plus actuellement comprises.  Dans cet article, nous nous concentrerons sur l'organisation de la m√©moire virtuelle, nous aborderons le PCI, parlerons un peu d'une carte r√©seau et toucherons une carte vid√©o sur un mat√©riel sp√©cifique que nous avons. <a name="habracut"></a><br><br>  Pour ceux qui sont trop paresseux pour lire l'article, je vais imm√©diatement donner une courte vid√©o avec les r√©sultats. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/FqOSFJ36B48" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Et maintenant, pour ceux qui sont int√©ress√©s, nous allons r√©v√©ler les d√©tails techniques que nous avons pu comprendre dans le processus. <br><br><h3>  M√©moire virtuelle </h3><br><h4>  Notre erreur de pile </h4><br>  Commen√ßons par la m√©moire virtuelle.  En fait, c'est ce sur quoi nous nous sommes install√©s dans l' <a href="https://habr.com/ru/company/embox/blog/447744/">article</a> pr√©c√©dent <a href="https://habr.com/ru/company/embox/blog/447744/">de la</a> s√©rie.  Il convient de rappeler imm√©diatement pourquoi nous avions besoin de m√©moire virtuelle, car Embox peut fonctionner sans.  C'est simple: la chose est la mise en cache.  Vidyaha a fonctionn√©, mais j'ai d√ª enregistrer la m√™me chose deux fois dans la m√©moire vid√©o pour une r√©cup√©ration d'image fiable.  Bien s√ªr, il √©tait possible de g√©rer le cache, mais nos exemples impliquent l'utilisation de la m√©moire vid√©o directement √† partir d'une application utilisateur, sans aucun √©l√©ment nucl√©aire tel que la gestion du cache, il √©tait donc juste d'apprendre √† mapper la m√©moire comme non cache.  La m√™me chose peut √™tre faite sous Linux en mappant fb ( <a href="http://dmilvdv.narod.ru/Translate/ELSDD/elsdd_sample_frame_buffer_example.html">exemple</a> ). <br><br>  Il convient de noter que bien que nous n'ayons pas √©crit sur Elbrus depuis longtemps et qu'il puisse sembler que MMU dans cette architecture soit une sorte de super compliqu√©, mais la chose est diff√©rente.  En fait, nous avons ajout√© du soutien pendant l'√©t√©, nous n'avons tout simplement pas atteint nos mains pour √©crire √† ce sujet.  Beaucoup de temps (plusieurs mois) a √©t√© consacr√© √† notre stupide erreur.  Cette erreur a m√™me √©t√© commise dans le titre de l'article (¬´Ou n'oubliez jamais ce que vous avez obtenu pendant l'intelligence¬ª).  Nous parlons de piles avec lesquelles nous avons assez bien trait√© et d√©crit cela dans l'article Climbing <a href="https://habr.com/ru/company/embox/blog/447704/">Elbrus - Reconnaissance.</a>  <a href="https://habr.com/ru/company/embox/blog/447704/">Partie technique 1. Registres, piles et autres d√©tails techniques</a> . <a href="https://habr.com/ru/company/embox/blog/447704/">"</a>  Nous avons souffert pendant tr√®s longtemps, perdant stupidement le fait que nous prenions la pile initiale (sur laquelle le syst√®me est initialis√©) de quelque part √† l'ext√©rieur, et tout cartographi√©.  ce dont nous avons besoin pour que Embox fonctionne, nous n'avons pas cartographi√© ces donn√©es. <br><br>  Sous le chat, je vais donner une nouvelle fonction e2k_entry, d√©crite dans le deuxi√®me article de l' <a href="https://habr.com/ru/company/embox/blog/447744/">article de la s√©rie</a> . <br><br>  Si vous le souhaitez, vous pouvez comparer. <br><br><pre><code class="cpp hljs">__attribute__ ((__section__(<span class="hljs-string"><span class="hljs-string">".e2k_entry"</span></span>))) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">e2k_entry</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct pt_regs *regs)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/* Since we enable exceptions only when all CPUs except the main one * reached the idle state (cpu_idle), we can rely that order and can * guarantee exceptions happen strictly after all CPUS entries. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (entries_count &gt;= CPU_COUNT) { <span class="hljs-comment"><span class="hljs-comment">/* Entering here because of exception or interrupt */</span></span> e2k_trap_handler(regs); RESTORE_COMMON_REGS(regs); E2K_DONE; } <span class="hljs-comment"><span class="hljs-comment">/* It wasn't exception, so we decide this usual program execution, * that is, Embox started on CPU0 or CPU1 */</span></span> e2k_wait_all(); entries_count = __e2k_atomic32_add(<span class="hljs-number"><span class="hljs-number">1</span></span>, &amp;entries_count); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (entries_count &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-comment"><span class="hljs-comment">/* XXX currently we support only single core */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* Run cpu_idle on 2nd CPU */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* it's just needed if log_debug enabled in e2k_context module * else output will be wrong because 2 cpu printing at the same time */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(!sync_count); context_init(&amp;cpu_ctx[<span class="hljs-number"><span class="hljs-number">0</span></span>], CONTEXT_PRIVELEGED | CONTEXT_IRQDISABLE, cpu_idle, idle_stack, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(idle_stack)); context_switch(&amp;cpu_ctx_prev[<span class="hljs-number"><span class="hljs-number">0</span></span>], &amp;cpu_ctx[<span class="hljs-number"><span class="hljs-number">0</span></span>]); } <span class="hljs-comment"><span class="hljs-comment">/* Run e2k_kernel_start on 1st CPU */</span></span> context_init(&amp;cpu_ctx[<span class="hljs-number"><span class="hljs-number">1</span></span>], CONTEXT_PRIVELEGED | CONTEXT_IRQDISABLE, e2k_kernel_start, &amp;_stack_top, KERNEL_STACK_SZ); sync_count = __e2k_atomic32_add(<span class="hljs-number"><span class="hljs-number">1</span></span>, &amp;sync_count); context_switch(&amp;cpu_ctx_prev[<span class="hljs-number"><span class="hljs-number">1</span></span>], &amp;cpu_ctx[<span class="hljs-number"><span class="hljs-number">1</span></span>]); }</code> </pre> <br>  Je vais simplement expliquer que maintenant nous utilisons les fonctions context_init () et context_switch () uniquement pour basculer la pile en m√©moire dans l'espace Embox.  Et nous le faisons pour tous les c≈ìurs, y compris ceux qui ne sont pas utilis√©s. <br><br><h3>  Organisation MMU </h3><br>  Je vais maintenant parler un peu de l'organisation de MMU dans l'architecture E2k. <br><br>  En g√©n√©ral, l'architecture MMU est assez ordinaire et comporte des tables √† quatre niveaux (ou trois lorsque vous utilisez une page de 4 Mo). <br><br>  Il existe plusieurs registres de service dans l'architecture E2k, accessibles via des commandes d'acc√®s √† des espaces alternatifs, ainsi qu'√† l'espace d'E / S bri√®vement d√©crit dans l'article <a href="https://habr.com/ru/company/embox/blog/421441/">¬´Embox commence √† grimper sur Elbrus¬ª</a> . <br><br>  Nous aurons besoin de tels registres: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MMU_REG_CR 0x00 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Control register */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MMU_REG_CONT 0x10 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Context register */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MMU_REG_CR3_RG 0x20 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* CR3 register for INTEL only */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MMU_REG_ELB_PTB 0x30 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* ELBRUS page table virtual base */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MMU_REG_ROOT_PTB 0x40 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Root Page Table Base register */</span></span></span><span class="hljs-meta">/</span></span></code> </pre> <br>  En fait, c'est un registre de contr√¥le, un registre de num√©ros de contexte, un registre racine de tables et un peu obscur MMU_REG_ELB_PTB.  Commen√ßons par cela, ce registre devrait avoir une certaine valeur, les 512 Go suivants seront utilis√©s par le processeur pour les besoins de l'√©quipement, et ces adresses ne seront pas disponibles pour le programmeur.  Je fournirai des explications de la lettre du sp√©cialiste ICST, je peux difficilement mieux expliquer: <br><br><blockquote>  Sous Linux, nous d√©finissons MMU_ELB_PTB sur 0xff1 &lt;&lt; 39, puis <br>  zone sup√©rieure de la m√©moire virtuelle (0xff8000000000 - 0xffffffffffff) <br>  r√©serv√© aux besoins d'√©quipements, √† savoir TLB.  Chaque page <br>  page table (TS) obtient son adresse unique dans cette zone, <br>  de plus, ces adresses sont facilement obtenues √† partir de l'adresse √† laquelle le programme <br>  fait appel √† la m√©moire.  Et depuis  TLB stocke les mappages d'adresses virtuelles <br>  physique, cela vous permet de mettre en cache dans le m√™me tampon TLB <br>  diffuse non seulement pour les adresses des utilisateurs, mais aussi pour le v√©hicule lui-m√™me. <br><br>  Dans les processeurs / architectures o√π des TLB s√©par√©s sont faits pour diff√©rents <br>  niveaux de table de page, une telle astuce devient inutile. <br><br>  Ainsi, lorsque vous manquez le TLB, il devient possible de ne pas lancer la recherche <br>  √† partir du niveau z√©ro (pgd *), et v√©rifier imm√©diatement le dernier niveau du v√©hicule (pte *). <br>  Il n'y a aucun mat√©riel requis pour cartographier cette zone elle-m√™me, Wirth.  adresses de <br>  il n'est n√©cessaire que comme index pour la recherche TLB.  Cependant, au c≈ìur de <br>  le dernier pgd du niveau z√©ro de la table des pages est √©crit nat.  l'adresse de cette <br>  niveau le plus nul.  En cons√©quence, seulement <br>  les 4 derniers Ko de la zone ff80'0000'0000 - ffff'ffff'ffff - i.e.  juste <br>  niveau z√©ro du v√©hicule.  Cela permet d'acc√©der √† pgd * par un utilisateur ordinaire <br>  lire / √©crire des instructions sur des adresses virtuelles. </blockquote><br>  En cons√©quence, il a √©t√© d√©cid√© de simplement mettre dans ce registre une grande valeur, ce qui ne nous d√©rangera pas.  Apr√®s tout, la solution propos√©e nous permet d'optimiser la recherche de pages, mais nous ne sommes pas encore engag√©s dans l'optimisation.  Livr√© le m√™me que sous Linux. <br><br>  Maintenant, le registre de contr√¥le.  Vous devez activer MMU √† travers elle.  Les bits connus ressemblent √† ceci: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _MMU_CR_TLB_EN 0x0000000000000001 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* translation enable */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _MMU_CR_CD_MASK 0x0000000000000006 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* cache disable bits */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _MMU_CR_SET1 0x0000000000000008 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* set #1 enable for 4 MB pages */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _MMU_CR_SET2 0x0000000000000010 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* set #2 enable for 4 MB pages */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _MMU_CR_SET3 0x0000000000000020 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* set #3 enable for 4 MB pages */</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* paging enable for second space INTEL */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _MMU_CR_CR0_PG 0x0000000000000040 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* page size 4Mb enable for second space INTEL */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _MMU_CR_CR4_PSE 0x0000000000000080 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* cache disable for secondary space INTEL */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _MMU_CR_CR0_CD 0x0000000000000100 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* TLU enable for secondary space INTEL */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _MMU_CR_TLU2_EN 0x0000000000000200 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* memory protection table enable for LD from secondary space INTEL */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _MMU_CR_LD_MPT 0x0000000000000400 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _MMU_CR_IPD_MASK 0x0000000000000800 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Instruction Prefetch Depth */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _MMU_CR_UPT_EN 0x0000000000001000 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* enable UPT */</span></span></span></span></code> </pre> <br>  Nous nous int√©ressons au premier bit, qui comprend la traduction d'adresses. <br><br>  Nous avons √©galement d√©fini _MMU_CR_SET3, mais nous n'avons pas d√©termin√© dans quels cas particuliers cela devrait √™tre fait. <br><br>  Inscription au concours  Eh bien, si c'est simple, c'est le PID du processus ou de l'espace d'adressage.  Plus techniquement, il s'agit d'une extension d'adresse 11 bits.  Dans notre cas, nous avons rendu toutes les pages nucl√©aires, en mettant le bit de globalit√© dans toutes nos pages, nous utilisons le m√™me espace d'adressage et donc nous pouvons utiliser z√©ro dans ce registre. <br><br>  Dans le registre de la table racine se trouve un pointeur vers l'adresse physique du d√©but de la table de traduction.  Vous pouvez simplement faire une fraude en mappant la table √©galement √† l'adresse sp√©cifi√©e dans le registre MMU_REG_ELB_PTB, mais comme je l'ai dit, nous n'√©tions pas concentr√©s sur l'optimisation. <br><br>  Que puis-je dire d'autre, la structure des tableaux est assez ordinaire, les drapeaux sont les suivants: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> E2K_MMU_PAGE_P 0x0000000000000001ULL </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Page Present bit */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> E2K_MMU_PAGE_W 0x0000000000000002ULL </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Writable (0 - only read) */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> E2K_MMU_PAGE_UU2 0x0000000000000004ULL </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* unused bit # 2 */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> E2K_MMU_PAGE_PWT 0x0000000000000008ULL </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Write Through */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> E2K_MMU_PAGE_CD1 0x0000000000000010ULL </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Cache disable (right bit) */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> E2K_MMU_PAGE_A 0x0000000000000020ULL </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Accessed Page */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> E2K_MMU_PAGE_D 0x0000000000000040ULL </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Page Dirty */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> E2K_MMU_PAGE_HUGE 0x0000000000000080ULL </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Page Size */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> E2K_MMU_PAGE_G 0x0000000000000100ULL </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Global Page */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> E2K_MMU_PAGE_CD2 0x0000000000000200ULL </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Cache disable (left bit) */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> E2K_MMU_PAGE_NWA 0x0000000000000400ULL </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Prohibit address writing */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> E2K_MMU_PAGE_AVAIL 0x0000000000000800ULL </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Available page */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> E2K_MMU_PAGE_PFN 0x000000fffffff000ULL </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Physical Page Number */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> E2K_MMU_PAGE_VALID 0x0000010000000000ULL </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Valid Page */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> E2K_MMU_PAGE_PV 0x0000020000000000ULL </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* PriVileged Page */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> E2K_MMU_PAGE_INT_PR 0x0000040000000000ULL </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Integer address access Protection */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> E2K_MMU_PAGE_NON_EX 0x0000080000000000ULL </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Non Executable Page */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> E2K_MMU_PAGE_RES 0x0000f00000000000ULL </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Reserved bits */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> E2K_MMU_PAGE_C_UNIT 0xffff000000000000ULL </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Compilation Unit */</span></span></span></span></code> </pre> <br>  Pour la table √† 4 niveaux, les d√©calages d'adresses sont les suivants: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> __MMU_PGD_SHIFT (PAGE_SHIFT + 3 * (PAGE_SHIFT-3)) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* 39 */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> __MMU_PUD_SHIFT (PAGE_SHIFT + 2 * (PAGE_SHIFT-3)) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* 30 */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> __MMU_PMD_SHIFT (PAGE_SHIFT + 1 * (PAGE_SHIFT-3)) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* 21 */</span></span></span></span></code> </pre><br><h3>  Un peu sur PCI </h3><br><h4>  Communication via des espaces d'adresses alternatifs </h4><br>  Avant de passer √† vidyaha et √† la carte r√©seau, revenons bri√®vement √† PCI.  Nous en avons d√©j√† un peu parl√© dans la toute premi√®re partie de <a href="https://habr.com/ru/company/embox/blog/421441/">"Embox commence √† grimper le mont Elbrouz</a> . <a href="https://habr.com/ru/company/embox/blog/421441/">"</a>  Il a montr√© des macros pour communiquer avec d'autres espaces d'adressage: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _E2K_READ_MAS(addr, mas, type, size_letter, chan_letter) \ ({ \ register type res; \ asm volatile (</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ld"</span></span></span><span class="hljs-meta"> #size_letter </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">","</span></span></span><span class="hljs-meta"> #chan_letter </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">" \t0x0, [%1] %2, %0"</span></span></span><span class="hljs-meta"> \ : </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"=r"</span></span></span><span class="hljs-meta"> (res) \ : </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"r"</span></span></span><span class="hljs-meta"> ((__e2k_ptr_t) (addr)), \ </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"i"</span></span></span><span class="hljs-meta"> (mas)); \ res; \ }) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _E2K_WRITE_MAS(addr, val, mas, type, size_letter, chan_letter) \ ({ \ asm volatile (</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"st"</span></span></span><span class="hljs-meta"> #size_letter </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">","</span></span></span><span class="hljs-meta"> #chan_letter </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">" \t0x0, [%0] %2, %1"</span></span></span><span class="hljs-meta"> \ : \ : </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"r"</span></span></span><span class="hljs-meta"> ((__e2k_ptr_t) (addr)), \ </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"r"</span></span></span><span class="hljs-meta"> ((type) (val)), \ </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"i"</span></span></span><span class="hljs-meta"> (mas) \ : </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"memory"</span></span></span><span class="hljs-meta">); \ })</span></span></code> </pre> <br>  Et il y avait une r√©f√©rence au principe des espaces d'adressage.  Diff√©rents espaces d'adressage sont d√©finis √† l'aide du MAS (sp√©cificateur d'adresse m√©moire).  Et par exemple, pour acc√©der √† l'IO, par lequel le PCI est accessible, vous devez utiliser 6 et pour MMU 7. <br><br>  Mais avec une √©tude plus approfondie de la macro, vous pouvez remarquer une sorte de chan_letter.  Et si vous regardez la description des commandes e2k, nous trouvons <br><blockquote>  Lecture double mot LDD ddd <br>  ldd [adresse] mas, dst </blockquote><br>  Autrement dit, √† premi√®re vue, il n'y a pas de canaux.  Mais si vous suivez les liens, il s'av√®re que le code pour l'op√©ration donn√©e ldd est 67. Mais 67 est le code pour ldd uniquement pour les canaux AL0 / AL3 et AL2 / AL5, et pour les canaux AL1 / AL4 ce code correspond √† l'op√©ration POPCNTd. <br><br>  Ainsi, il n'a pas √©t√© possible de comprendre pleinement quels sont les canaux dans la terminologie d'Elbrus.  Je me risquerais √† sugg√©rer que cela est d√©j√† li√© au principe vliw, lorsque vous pouvez sp√©cifier quel alu est utilis√©, car dans ce type d'architecture, l'une des caract√©ristiques est la pr√©sence de plusieurs appareils informatiques ind√©pendants.  Je peux bien s√ªr me tromper, mais le fait est que pour acc√©der au PCI ou MMU, vous devez utiliser le deuxi√®me ou le cinqui√®me canal.  Ainsi, la commande ressemblera √† ceci: <br><blockquote>  ldd, 2 0x0, [addr_in_mas] mas_id,% reg </blockquote><br><h4>  lspci </h4><br>  Je vais maintenant donner le r√©sultat de la sortie de la commande lspci sur le p√©riph√©rique que nous avons: <br><blockquote>  root @ embox: (null) #lspci <br>  00: 0,0 (PCI dev E3E3: ABCD) [6 4] <br>  Pont PCI-√†-PCI: (null) Pont Elbrus PCIe (r√©v 01) <br>  00: 1.0 (PCI dev 8086: E3E3) [6 4] <br>  Pont PCI √† PCI: Intel PCI Elbrus Virt PCI bridge (rev 01) <br>  01: 0,0 (PCI dev 1FFF: 8000) [6 4] <br>  Pont PCI-√†-PCI: (nul) Pont Elbrus PCI (r√©v 05) <br>  01: 1.0 (PCI dev 8086: 4D45) [2 0] <br>  Contr√¥leur Ethernet: Intel Corporation MCST ETH1000 Gigabit Ethernet (r√©v 01) <br>  01: 2.0 (PCI dev 8086: 4D49) [1 1] <br>  Contr√¥leur IDE: Intel Corporation MCST IDE (rev 128) <br>  01: 2.1 (PCI dev 8086: 0002) [7 2] <br>  Comm simple.  contr√¥leur: Intel Corporation (null) (rev 05) <br>  01: 2.2 (PCI dev 8086: 8000) [7 128] <br>  Comm simple.  contr√¥leur: Intel Corporation Elbrus PCI bridge (rev 00) <br>  01: 2.3 (PCI dev 1013: 6005) [4 1] <br>  P√©riph√©rique multim√©dia: Cirrus Logic Crystal CS4281 PCI Audio (rev 01) <br>  01: 3.0 (PCI dev 8086: 4748) [1 6] <br>  Contr√¥leur de stockage de masse: Intel Corporation MCST SATA (r√©v 00) <br>  01: 4.0 (PCI dev 8086: 554F) [12 3] <br>  P√©riph√©rique USB: Intel Corporation OHCI pour Elbrus (r√©v 00) <br>  01: 4.1 (PCI dev 8086: 5545) [12 3] <br>  P√©riph√©rique USB: Intel Corporation EHCI pour Elbrus (r√©v 00) <br>  02: 1.0 (PCI dev 126F: 0718) [3 0] <br>  Contr√¥leur compatible VGA: Silicon Motion, Inc.  SM718 LynxSE + (r√©v 160) <br>  root @ embox: (null) # </blockquote><br>  Remarque <br><blockquote>  01: 2.2 (PCI dev 8086: 8000) [7 128] <br>  Comm simple.  contr√¥leur: Intel Corporation Elbrus PCI bridge (rev 00) </blockquote><br>  En fait, il s'agit d'un port s√©rie du MCST similaire √† l'am85c30, au moins via cet appareil, nous communiquons via minicom. <br><br><h3>  Carte r√©seau </h3><br><h4>  Structure g√©n√©rale </h4><br>  Passons maintenant √† la carte r√©seau. <br><br>  Si je comprends bien, il s'agit de la carte r√©seau d'origine, un peu similaire en fonctionnement √† e1000, mais uniquement en fonctionnement (comme la pr√©sence de descripteurs dans les files d'attente de r√©ception et de transmission). <br><br>  Maintenant, plus sur les points importants que nous avons rencontr√©s. <br><br>  Carte r√©seau PCI VID: PID 0x8086: 0x4D45.  Ne soyez pas surpris que le VID soit le m√™me qu'Intel, le MCST utilise souvent ce VID particulier, regardez au moins le p√©riph√©rique de port s√©rie mentionn√© ci-dessus. <br><br>  BAR0 contient une base de registres.  Les registres sont les suivants: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> L_E1000_E_CSR 0x00 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Ethernet Control/Status Register */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> L_E1000_MGIO_CSR 0x04 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* MGIO Control/Status Register */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> L_E1000_MGIO_DATA 0x08 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* MGIO Data Register */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> L_E1000_E_BASE_ADDR 0x0c </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* EthernetBase Address Register */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> L_E1000_DMA_BASE_ADDR 0x10 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* DMA Base Address Register */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> L_E1000_PSF_CSR 0x14 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Pause Frame Control/Status Register */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> L_E1000_PSF_DATA 0x18 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Pause Frame Data Register */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> L_E1000_INT_DELAY 0x1c </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Interrupt Delay Register */</span></span></span></span></code> </pre> <br>  Les trois derniers (L_E1000_PSF_CSR, L_E1000_PSF_DATA, L_E1000_INT_DELAY) que nous n'avons pas utilis√©s, nous n'en parlerons donc pas.  Commen√ßons par MGIO, tout est simple: lecture-√©criture en utilisant le protocole MII, c'est-√†-dire communication avec la puce PHY.  Plus pr√©cis√©ment, nous avons une puce DP83865. <br><br>  Les proc√©dures ne sont pas particuli√®rement remarquables, je vais simplement les √©num√©rer. <br><br>  Lecture: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">e1000_mii_readreg</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct net_device *dev, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> phy_id, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> reg_num)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">l_e1000_priv</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ep</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">netdev_priv</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dev</span></span></span><span class="hljs-class">);</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> rd; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> val_out = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; rd = <span class="hljs-number"><span class="hljs-number">0</span></span>; rd |= <span class="hljs-number"><span class="hljs-number">0x2</span></span> &lt;&lt; MGIO_CS_OFF; rd |= <span class="hljs-number"><span class="hljs-number">0x1</span></span> &lt;&lt; MGIO_ST_OF_F_OFF; rd |= <span class="hljs-number"><span class="hljs-number">0x2</span></span> &lt;&lt; MGIO_OP_CODE_OFF; <span class="hljs-comment"><span class="hljs-comment">/* Read */</span></span> rd |= (phy_id &amp; <span class="hljs-number"><span class="hljs-number">0x1f</span></span>) &lt;&lt; MGIO_PHY_AD_OFF; rd |= (reg_num &amp; <span class="hljs-number"><span class="hljs-number">0x1f</span></span>) &lt;&lt; MGIO_REG_AD_OFF; e1000_write_mgio_data(ep, rd); rd = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i != <span class="hljs-number"><span class="hljs-number">1000</span></span>; i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (e1000_read_mgio_csr(ep) &amp; MGIO_CSR_RRDY) { rd = (<span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span>)e1000_read_mgio_data(ep); val_out = rd &amp; <span class="hljs-number"><span class="hljs-number">0xffff</span></span>; log_debug(<span class="hljs-string"><span class="hljs-string">"reg 0x%x &gt;&gt;&gt; 0x%x"</span></span>, reg_num, val_out); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> val_out; } usleep(<span class="hljs-number"><span class="hljs-number">100</span></span>); } log_error(<span class="hljs-string"><span class="hljs-string">"mdio_read: Unable to read from MGIO_DATA reg\n"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> val_out; }</code> </pre> <br>  Record: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">e1000_mii_writereg</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct net_device *dev, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> phy_id, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> reg_num, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> val)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">l_e1000_priv</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ep</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">netdev_priv</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dev</span></span></span><span class="hljs-class">);</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> wr; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; wr = <span class="hljs-number"><span class="hljs-number">0</span></span>; wr |= <span class="hljs-number"><span class="hljs-number">0x2</span></span> &lt;&lt; MGIO_CS_OFF; wr |= <span class="hljs-number"><span class="hljs-number">0x1</span></span> &lt;&lt; MGIO_ST_OF_F_OFF; wr |= <span class="hljs-number"><span class="hljs-number">0x1</span></span> &lt;&lt; MGIO_OP_CODE_OFF; <span class="hljs-comment"><span class="hljs-comment">/* Write */</span></span> wr |= (phy_id &amp; <span class="hljs-number"><span class="hljs-number">0x1f</span></span>) &lt;&lt; MGIO_PHY_AD_OFF; wr |= (reg_num &amp; <span class="hljs-number"><span class="hljs-number">0x1f</span></span>) &lt;&lt; MGIO_REG_AD_OFF; wr |= val &amp; <span class="hljs-number"><span class="hljs-number">0xffff</span></span>; log_debug(<span class="hljs-string"><span class="hljs-string">"reg 0x%x &lt;&lt;&lt; 0x%x"</span></span>, reg_num, val); e1000_write_mgio_data(ep, wr); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i != <span class="hljs-number"><span class="hljs-number">1000</span></span>; i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (e1000_read_mgio_csr(ep) &amp; MGIO_CSR_RRDY) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } usleep(<span class="hljs-number"><span class="hljs-number">100</span></span>); } log_error(<span class="hljs-string"><span class="hljs-string">"Unable to write MGIO_DATA reg: val = 0x%x"</span></span>, wr); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; }</code> </pre> <br>  Maintenant L_E1000_DMA_BASE_ADDR et L_E1000_E_BASE_ADDR, en fait, ils d√©crivent un param√®tre, l'adresse du bloc de description de la carte r√©seau.  Autrement dit, l'adresse dans Elbrus est de 64 bits et les registres sont de 32 bits. <br><br>  Code actuellement: <br><br><pre> <code class="cpp hljs"> <span class="hljs-comment"><span class="hljs-comment">/* low 32 bits */</span></span> init_block_addr_part = (<span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span>)((<span class="hljs-keyword"><span class="hljs-keyword">uintptr_t</span></span>)ep-&gt;init_block &amp; <span class="hljs-number"><span class="hljs-number">0xffffffff</span></span>); e1000_write_e_base_addr(ep, init_block_addr_part); log_debug(<span class="hljs-string"><span class="hljs-string">"Init Block Low DMA addr: 0x%x"</span></span>, init_block_addr_part); <span class="hljs-comment"><span class="hljs-comment">/* high 32 bits */</span></span> init_block_addr_part = (<span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span>)(((<span class="hljs-keyword"><span class="hljs-keyword">uintptr_t</span></span>)(ep-&gt;init_block) &gt;&gt; <span class="hljs-number"><span class="hljs-number">32</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0xffffffff</span></span>); e1000_write_dma_base_addr(ep, init_block_addr_part); log_debug(<span class="hljs-string"><span class="hljs-string">"Init Block High DMA addr: 0x%x"</span></span>, init_block_addr_part); <span class="hljs-comment"><span class="hljs-comment">/************************************************************************/</span></span></code> </pre><br>  D'o√π on peut voir que L_E1000_DMA_BASE_ADDR est la partie sup√©rieure et L_E1000_DMA_BASE_ADDR est la partie inf√©rieure de l'adresse d'un certain bloc d'initialisation (en fait un bloc de description de carte). <br><br>  La structure de description est la suivante: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">l_e1000_init_block</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> mode; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> paddr[<span class="hljs-number"><span class="hljs-number">6</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">uint64_t</span></span> laddrf; <span class="hljs-comment"><span class="hljs-comment">/* 31:4 = addr of rx desc ring (16 bytes align) + * 3:0 = number of descriptors (the power of two) * 0x09 is max value (desc number = 512 if [3:0] &gt;= 0x09) */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> rdra; <span class="hljs-comment"><span class="hljs-comment">/* 31:4 = addr of tx desc ring (16 bytes align) + * 3:0 = number of descriptors (the power of two) * 0x09 is max value (desc number = 512 if [3:0] &gt;= 0x09) */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> tdra; } __attribute__((packed));</code> </pre> <br>  C laddrf - ne comprenait pas, pour une raison quelconque, il est mis √† z√©ro, nous avons fait de m√™me. <br><br>  paddr - comme vous pouvez le deviner, mac est l'adresse de la carte r√©seau. <br><br>  rdra et tdra contiennent les adresses des anneaux des descripteurs de m√©moire, les 4 bits inf√©rieurs sont allou√©s √† la taille de l'anneau, et c'est le logarithme de la taille.  Autrement dit, s'il y a 8, alors le nombre de descripteurs dans l'anneau sera 2 ^ 8 (1 &lt;&lt; 8 == 256). <br><br>  mode est le mode de fonctionnement de la carte, les bits sont les suivants: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> DRX (1 &lt;&lt; 0) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Receiver disable */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> DTX (1 &lt;&lt; 1) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Transmitter disable */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LOOP (1 &lt;&lt; 2) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* loopback */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> DTCR (1 &lt;&lt; 3) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* disable transmit crc */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> COLL (1 &lt;&lt; 4) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* force collision */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> DRTY (1 &lt;&lt; 5) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* disable retry */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> INTL (1 &lt;&lt; 6) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Internal loopback */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> EMBA (1 &lt;&lt; 7) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* enable modified back-off algorithm */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> EJMF (1 &lt;&lt; 8) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* enable jambo frame */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> EPSF (1 &lt;&lt; 9) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* enable pause frame */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> FULL (1 &lt;&lt; 10) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* full packet mode */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> PROM (1 &lt;&lt; 15) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* promiscuous mode */</span></span></span></span></code> </pre> <br>  Autrement dit, lorsque tout est configur√©, vous devez d√©finir le bit 10. Si vous voulez un mode promiscuous, puis √©galement 15. <br><br><h4>  Descripteurs de paquets </h4><br>  Maintenant sur le format des descripteurs de paquets. <br><br>  A la r√©ception: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">l_e1000_rx_desc</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> base; <span class="hljs-keyword"><span class="hljs-keyword">int16_t</span></span> buf_length; <span class="hljs-keyword"><span class="hljs-keyword">int16_t</span></span> status; <span class="hljs-keyword"><span class="hljs-keyword">int16_t</span></span> msg_length; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> reserved1; <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> etmr; } __attribute__((packed));</code> </pre> <br>  base - comprendre probablement que c'est l'adresse du tampon pour le paquet <br>  buf_length - taille du tampon <br>  msg_length - apr√®s r√©ception, contient la longueur du paquet re√ßu <br>  statut - statut du descripteur.  Lorsque le paquet est pr√©par√© et donn√© au DMA (carte), vous devez d√©finir le bit 15 (RD_OWN).  Si tout va bien, apr√®s avoir re√ßu le paquet dans ce descripteur, ce bit sera r√©initialis√© et 9 (RD_STP) et 8 (RD_ENP) seront d√©finis. <br><br>  Tous les bits d'√©tat sont les suivants: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* RX Descriptor status bits */</span></span> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> RD_OWN (1 &lt;&lt; 15) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> RD_ERR (1 &lt;&lt; 14) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> RD_FRAM (1 &lt;&lt; 13) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> RD_OFLO (1 &lt;&lt; 12) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> RD_CRC (1 &lt;&lt; 11) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> RD_BUFF (1 &lt;&lt; 10) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> RD_STP (1 &lt;&lt; 9) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> RD_ENP (1 &lt;&lt; 8) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> RD_PAM (1 &lt;&lt; 6) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> RD_LAFM (1 &lt;&lt; 4) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> RD_BAM (1 &lt;&lt; 3)</span></span></code> </pre> <br>  Au transfert: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">l_e1000_tx_desc</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> base; <span class="hljs-keyword"><span class="hljs-keyword">int16_t</span></span> buf_length; <span class="hljs-keyword"><span class="hljs-keyword">int16_t</span></span> status; <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> misc; <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> etmr; } __attribute__((packed));</code> </pre><br>  Presque identiques √† la r√©ception, les bits d'√©tat sont les suivants: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* TX Descriptor status bits */</span></span> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> TD_OWN (1 &lt;&lt; 15) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> TD_ERR (1 &lt;&lt; 14) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> TD_AFCS (1 &lt;&lt; 13) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> TD_NOINTR (1 &lt;&lt; 13) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> TD_MORE (1 &lt;&lt; 12) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> TD_ONE (1 &lt;&lt; 11) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> TD_DEF (1 &lt;&lt; 10) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> TD_STP (1 &lt;&lt; 9) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> TD_ENP (1 &lt;&lt; 8)</span></span></code> </pre> <br>  Lorsqu'un paquet est envoy√©, il est n√©cessaire de d√©finir 15 (TD_OWN), 9 (TD_STP) et 8 (TD_ENP) en cons√©quence.  Le bit 8 signifie que c'est le dernier paquet √† traiter, par cons√©quent, si un paquet est envoy√©, vous devez installer uniquement dans le dernier. <br><br>  J'ai √©galement oubli√© une caract√©ristique importante, la longueur du tampon dans les descripteurs est √©crite avec un signe moins, probablement dans du code suppl√©mentaire.  M√™me en petit-boutien, mais comme Elbrus a le m√™me ordre d'octets, ce n'est probablement pas important. <br><br><h4>  Registre de gestion </h4><br>  Nous d√©crivons maintenant le dernier registre non assembl√© L_E1000_E_CSR: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* E_CSR register bits */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* 31:21 unused, readed as 0 */</span></span> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> E_CSR_ATME (1 &lt;&lt; 24) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* RW, Add Timer Enable */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> E_CSR_TMCE (1 &lt;&lt; 23) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* RW, Timer Clear Enable */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> E_CSR_DRIN (1 &lt;&lt; 22) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* RW, Disable RX Interrupt */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> E_CSR_DTIN (1 &lt;&lt; 21) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* RW, Disable TX Interrupt */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> E_CSR_ESLE (1 &lt;&lt; 20) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* RW, Enable Slave Error */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> E_CSR_SLVE (1 &lt;&lt; 19) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* RW1c, Slave Error */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> E_CSR_PSFI (1 &lt;&lt; 18) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* RW1c, Pause Frame Interrupt */</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* 17 unused, read as 0 */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> E_CSR_SINT (1 &lt;&lt; 16) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* R, Status Interrupt */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> E_CSR_ERR (1 &lt;&lt; 15) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* R, Error */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> E_CSR_BABL (1 &lt;&lt; 14) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* RW1c, Babble */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> E_CSR_CERR (1 &lt;&lt; 13) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* RW1c, Collision Error */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> E_CSR_MISS (1 &lt;&lt; 12) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* RW1c, Missed Packet */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> E_CSR_MERR (1 &lt;&lt; 11) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* RW1c, Memory Error */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> E_CSR_RINT (1 &lt;&lt; 10) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* RW1c, Receiver Interrupt */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> E_CSR_TINT (1 &lt;&lt; 9) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* RW1c, Transmiter Interrupt */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> E_CSR_IDON (1 &lt;&lt; 8) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* RW1c, Initialization Done */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> E_CSR_INTR (1 &lt;&lt; 7) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* R, Interrupt Flag */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> E_CSR_INEA (1 &lt;&lt; 6) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* RW, Interrupt Enable */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> E_CSR_RXON (1 &lt;&lt; 5) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* R, Receiver On */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> E_CSR_TXON (1 &lt;&lt; 4) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* R, Transmiter On */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> E_CSR_TDMD (1 &lt;&lt; 3) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* RW1, Transmit Demand */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> E_CSR_STOP (1 &lt;&lt; 2) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* RW1, Stop */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> E_CSR_STRT (1 &lt;&lt; 1) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* RW1, Start */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> E_CSR_INIT (1 &lt;&lt; 0) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* RW1, Initialize */</span></span></span></span></code> </pre><br><h4>  Initialisation </h4><br>  Il y a une s√©quence d'initialisation quelque peu inhabituelle: <br><blockquote>  STOP-&gt; INIT-&gt; IDON-&gt; STRT </blockquote><br>  Dans ce cas, les bits RXON et TXON montent ind√©pendamment. <br>  Plus de d√©tails peuvent √™tre trouv√©s dans notre pilote. <br><br><h2>  Carte vid√©o </h2><br>  Comme d√©j√† indiqu√©, notre appareil utilise un vidyah Silicon Motion appel√© SM718 LynxSE +.  Par cons√©quent, tout est simple, il existe des <a href="https://github.com/torvalds/linux/tree/master/drivers/staging/sm750fb">sources de pilotes sous Linux</a> et il n'y a rien √† d√©crire en fait. <br><br>  Eh bien, sauf que la vid√©o montre qu'il s'est av√©r√© √™tre des images tr√®s faibles, cela ressemble √† un acc√®s lent √† la m√©moire.  Mais ceci est sans optimisation du compilateur, et en g√©n√©ral, c'est peut-√™tre notre probl√®me associ√© √† l'utilisation incorrecte de l'architecture e2k. <br><br><h3>  Eh bien, quoi d'autre √† dire sur <s>Sakhaline</s> Elbrus? </h3><br>  En principe, le temps est normal :) <br><br>  Apparemment, Elbrus existe, travaille.  Personnellement, je vois le principal probl√®me du d√©veloppement de cette architecture int√©ressante comme sa proximit√©.  Il est difficile de croire qu'une entreprise relativement petite puisse cr√©er un processeur, un compilateur, fournir un support et tout le reste.  Oui, des d√©veloppeurs de logiciels tiers ont commenc√© √† appara√Ætre, le m√™me Basalt-SPO prend en charge <a href="https://www.altlinux.org/%25D0%25AD%25D0%25BB%25D1%258C%25D0%25B1%25D1%2580%25D1%2583%25D1%2581">Alt-Linux, qui peut √™tre install√© sur Elbrus</a> . <br><br>  Oui, il a √©t√© signal√© que des d√©veloppeurs tiers fabriquaient du mat√©riel bas√© sur le processeur Elbrus, par exemple <a href="https://m.vk.com/wall-71796881_858">Fastwel</a> .  Mais ce ne sont l√† que de petites avanc√©es vers l'ouverture.  Un exemple tr√®s simple, afin de reproduire ce que nous avons dit et montr√© ici, nous avons besoin d'un compilateur, et seul le <a href="http://www.mcst.ru/">MCST l'a</a> , les informations donn√©es dans l'article sont un ajout aux informations re√ßues de, encore une fois, le <a href="http://www.mcst.ru/">MCST</a> , et je ne dis toujours pas qu'il est peu probable qu'un morceau de fer soit trouv√© m√™me au MCST.  Il est assez ancien et <a href="http://www.mcst.ru/">ICST</a> propose des mod√®les plus r√©cents. <br><br>  PS Naturellement, vous pouvez tout voir dans <a href="https://github.com/embox/embox">le r√©f√©rentiel Embox</a> . <br><br>  PPS Venez sur la cha√Æne de t√©l√©gramme russe via Embox ( <a href="https://t.me/embox_chat">https://t.me/embox_chat</a> ). <br><br>  PPS Embox a mis √† jour le deuxi√®me composant de la version, d√©sormais la version <a href="">0.4.0</a> actuelle </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr485694/">https://habr.com/ru/post/fr485694/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr485664/index.html">Cr√©ation de param√®tres dynamiques dans un travail Jenkins, ou comment rendre votre t√¢che conviviale</a></li>
<li><a href="../fr485672/index.html">Redis Best Practices, Partie 1</a></li>
<li><a href="../fr485682/index.html">La gestion du temps n'aidera pas: la procrastination est le probl√®me de la r√©gulation des √©motions, pas du temps</a></li>
<li><a href="../fr485688/index.html">Myapp prolonge ses vacances</a></li>
<li><a href="../fr485692/index.html">Conseils d'un sp√©cialiste informatique au client, ou comment automatiser le d√©sordre</a></li>
<li><a href="../fr485702/index.html">FunCorp iOS Meetup # 2</a></li>
<li><a href="../fr485704/index.html">Pixel art pour d√©butants: corriger les erreurs courantes</a></li>
<li><a href="../fr485706/index.html">Nous vous invitons √† la r√©union ¬´Transformation num√©rique et nouveaux r√¥les en science des donn√©es¬ª</a></li>
<li><a href="../fr485708/index.html">La blockchain change le fonctionnement de l'industrie ferroviaire</a></li>
<li><a href="../fr485710/index.html">Solution simple pour les tests de r√©gression visuelle dans Java + Selenium Webdriver + aShot</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>