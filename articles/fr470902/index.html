<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©‚Äçüë©‚Äçüëß‚Äçüëß ‚ú≥Ô∏è ‚ú°Ô∏è Hautes performances et partitionnement natif: Zabbix avec prise en charge de TimescaleDB üòø üññüèΩ üë®üèº‚Äçüíª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Zabbix est un syst√®me de surveillance. Comme tout autre syst√®me, il fait face √† trois probl√®mes principaux de tous les syst√®mes de surveillance: la co...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Hautes performances et partitionnement natif: Zabbix avec prise en charge de TimescaleDB</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/470902/">  Zabbix est un syst√®me de surveillance.  Comme tout autre syst√®me, il fait face √† trois probl√®mes principaux de tous les syst√®mes de surveillance: la collecte et le traitement des donn√©es, le stockage de l'historique et leur nettoyage. <br><br>  Les √©tapes d'acquisition, de traitement et d'enregistrement des donn√©es prennent du temps.  Pas grand-chose, mais pour un grand syst√®me, cela peut entra√Æner des retards importants.  Le probl√®me de stockage est un probl√®me d'acc√®s aux donn√©es.  Ils sont utilis√©s pour les rapports, les v√©rifications et les d√©clencheurs.  Les retards dans l'acc√®s aux donn√©es affectent √©galement les performances.  Lorsque la base de donn√©es se d√©veloppe, les donn√©es non pertinentes doivent √™tre supprim√©es.  L'enl√®vement est une op√©ration difficile qui consomme √©galement une partie des ressources. <br><br><img src="https://habrastorage.org/webt/jb/yy/zo/jbyyzopzw6gtfio8uhqbgushzo8.jpeg"><br><br>  Les probl√®mes de retards lors de la collecte et du stockage dans Zabbix sont r√©solus par la mise en cache: plusieurs types de caches, la mise en cache dans la base de donn√©es.  Pour r√©soudre le troisi√®me probl√®me, la mise en cache ne convient pas, par cons√©quent, Zabbix a utilis√© TimescaleDB.  <strong>Andrey Gushchin</strong> , ing√©nieur du support technique chez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Zabbix SIA,</a> en parlera.  Andrey soutient Zabbix depuis plus de 6 ans et est directement confront√© aux performances. <br><br>  Comment fonctionne TimescaleDB, quelles performances peut-il offrir par rapport √† PostgreSQL standard?  Quel r√¥le joue Zabbix dans TimescaleDB?  Comment ex√©cuter √† partir de z√©ro et comment migrer avec PostgreSQL et quelles performances sont les meilleures?  √Ä propos de tout cela sous la coupe. <br><a name="habracut"></a><br><iframe width="560" height="315" src="https://www.youtube.com/embed/umRk94j5M8o" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><h2>  D√©fis de performance </h2><br>  Chaque syst√®me de surveillance est confront√© √† des d√©fis de performances sp√©cifiques.  J'en parlerai trois: collecte et traitement des donn√©es, stockage, nettoyage de l'historique. <br><br>  <strong>Collecte et traitement rapides des donn√©es.</strong>  Un bon syst√®me de surveillance devrait recevoir rapidement toutes les donn√©es et les traiter selon des expressions de d√©clenchement - selon ses propres crit√®res.  Apr√®s le traitement, le syst√®me doit √©galement enregistrer rapidement ces donn√©es dans la base de donn√©es afin de les utiliser ult√©rieurement. <br><br>  <strong>Garder une histoire.</strong>  Un bon syst√®me de surveillance doit stocker l'historique dans la base de donn√©es et fournir un acc√®s pratique aux m√©triques.  Une histoire est n√©cessaire pour l'utiliser dans des rapports, des graphiques, des d√©clencheurs, des seuils et des √©l√©ments de donn√©es calcul√©s pour les alertes. <br><br>  <strong>Effacer l'histoire.</strong>  Parfois, un jour vient o√π vous n'avez pas besoin de stocker des m√©triques.  Pourquoi avez-vous besoin des donn√©es collect√©es il y a 5 ans, un mois ou deux: certains n≈ìuds sont supprim√©s, certains h√¥tes ou mesures ne sont plus n√©cessaires, car ils sont obsol√®tes et ont cess√© de collecter.  Un bon syst√®me de surveillance doit stocker les donn√©es historiques et les supprimer de temps en temps afin que la base de donn√©es ne se d√©veloppe pas. <br><br><blockquote>  La suppression des donn√©es obsol√®tes est un probl√®me br√ªlant qui a un impact important sur les performances de la base de donn√©es. </blockquote><br><h2>  Mise en cache Zabbix </h2><br>  Dans Zabbix, les premier et deuxi√®me appels sont r√©solus √† l'aide de la mise en cache.  La RAM est utilis√©e pour la collecte et le traitement des donn√©es.  Pour le stockage - des histoires dans des d√©clencheurs, des graphiques et des √©l√©ments de donn√©es calcul√©s.  Du c√¥t√© de la base de donn√©es, il existe une certaine mise en cache pour les principaux √©chantillons, par exemple les graphiques. <br><br>  La mise en cache sur le c√¥t√© du serveur Zabbix lui-m√™me est: <br><br><ul><li>  ConfigurationCache; </li><li>  ValueCache; </li><li>  HistoryCache; </li><li>  TrendsCache. </li></ul><br>  Examinons-les plus en d√©tail. <br><br><h3>  ConfigurationCache </h3><br>  Il s'agit du cache principal dans lequel nous stockons les m√©triques, les h√¥tes, les √©l√©ments de donn√©es, les d√©clencheurs - tout ce qui est n√©cessaire pour le pr√©traitement et la collecte de donn√©es. <br><br><img src="https://habrastorage.org/webt/g0/zd/er/g0zderqgjgddgeq0frjdyvgj-q0.png"><br><br>  Tout cela est stock√© dans ConfigurationCache afin de ne pas cr√©er de requ√™tes inutiles dans la base de donn√©es.  Apr√®s le d√©marrage du serveur, nous mettons √† jour ce cache, cr√©ons et mettons √† jour p√©riodiquement les configurations. <br><br><h3>  Collecte de donn√©es </h3><br>  Le sch√©ma est assez grand, mais l'essentiel est les <strong>assembleurs</strong> .  Ce sont les diff√©rents ¬´assembleurs¬ª - processus d'assemblage.  Ils sont responsables de diff√©rents types d'assemblage: ils collectent les donn√©es via SNMP, IPMI et transf√®rent le tout au pr√©-traitement. <br><br><img src="https://habrastorage.org/webt/z2/2r/jq/z22rjqgzyoam-61aadugsmowsbe.jpeg">  <em>Les collecteurs sont entour√©s d'orange.</em> <br><br>  Zabbix a calcul√© les √©l√©ments de donn√©es d'agr√©gation n√©cessaires pour agr√©ger les validations.  Si nous les avons, nous les prenons directement √† partir de ValueCache. <br><br><h3>  Historique de pr√©traitement </h3><br>  Tous les collecteurs utilisent ConfigurationCache pour recevoir des travaux.  Ils les transmettent ensuite au pr√©traitement. <br><br><img src="https://habrastorage.org/webt/f9/f-/yc/f9f-ycupjcyofnnz20injlmynty.png"><br><br>  Le pr√©traitement utilise ConfigurationCache pour recevoir les √©tapes de pr√©traitement.  Il traite ces donn√©es de diff√©rentes mani√®res. <br><br>  Apr√®s avoir trait√© les donn√©es √† l'aide du pr√©traitement, nous les enregistrons dans HistoryCache pour les traiter.  Cela met fin √† la collecte de donn√©es et nous passons au processus principal dans Zabbix - <strong>synchroniseur d'histoire</strong> , car il s'agit d'une architecture monolithique. <br><br>  <em>Remarque: le pr√©traitement est une op√©ration assez difficile.</em>  <em>Depuis la v 4.2, il a √©t√© soumis au proxy.</em>  <em>Si vous avez un tr√®s grand Zabbix avec un grand nombre d'√©l√©ments de donn√©es et une fr√©quence de collecte, cela facilite grandement le travail.</em> <br><br><h3>  Cache ValueCache, historique et tendances </h3><br><blockquote>  Le synchroniseur d'historique est le processus principal qui traite atomiquement chaque √©l√©ment de donn√©es, c'est-√†-dire chaque valeur. </blockquote><br>  Le synchroniseur d'historique prend des valeurs dans HistoryCache et v√©rifie dans la configuration les d√©clencheurs des calculs.  S'ils le sont, il calcule. <br><br>  Le synchroniseur d'historique cr√©e un √©v√©nement, une escalade pour cr√©er des alertes, si la configuration l'exige, et des enregistrements.  S'il existe des d√©clencheurs pour un traitement ult√©rieur, il se souvient de cette valeur dans ValueCache afin de ne pas acc√©der √† la table d'historique.  Donc ValueCache est rempli de donn√©es n√©cessaires au calcul des d√©clencheurs, des √©l√©ments calcul√©s. <br><br>  Le synchroniseur d'historique √©crit toutes les donn√©es dans la base de donn√©es et elles sont √©crites sur le disque.  Le processus de traitement se termine ici. <br><br><img src="https://habrastorage.org/webt/u7/v0/08/u7v0080wzx7v_fh8ej-fas7b1wg.jpeg"><br><br><h3>  Mise en cache DB </h3><br>  C√¥t√© DB, il existe diff√©rents caches lorsque vous souhaitez regarder des graphiques ou des rapports d'√©v√©nements: <br><br><ul><li> <code>Innodb_buffer_pool</code> du c√¥t√© MySQL; </li><li>  <code>shared_buffers</code> du c√¥t√© PostgreSQL; </li><li>  <code>effective_cache_size</code> du c√¥t√© Oracle; </li><li>  <code>shared_pool</code> du c√¥t√© DB2. </li></ul><br>  Il existe de nombreux autres caches, mais ce sont les principaux pour toutes les bases de donn√©es.  Ils vous permettent de conserver en m√©moire les donn√©es souvent n√©cessaires aux requ√™tes.  Ils ont leurs propres technologies pour cela. <br><br><h3>  Les performances de la base de donn√©es sont essentielles </h3><br>  Le serveur Zabbix collecte constamment des donn√©es et les √©crit.  Lors du red√©marrage, il lit √©galement √† partir de l'historique pour remplir ValueCache.  Les scripts et les rapports utilisent l' <strong>API Zabbix</strong> , qui est construite sur la base de l'interface Web.  L'API Zabbix contacte la base de donn√©es et re√ßoit les donn√©es n√©cessaires pour les graphiques, les rapports, les listes d'√©v√©nements et les probl√®mes r√©cents. <br><br><img src="https://habrastorage.org/webt/b5/48/rc/b548rcjuhprytj6zcpi_buqdr2c.png"><br><br>  Pour la visualisation - <strong>Grafana</strong> .  Parmi nos utilisateurs, c'est une solution populaire.  Il peut envoyer directement des requ√™tes via l'API Zabbix et vers la base de donn√©es, et cr√©e une certaine comp√©titivit√© pour la r√©ception des donn√©es.  Par cons√©quent, nous avons besoin d'un r√©glage plus fin et meilleur de la base de donn√©es pour correspondre √† la sortie rapide des r√©sultats et des tests. <br><br><h2>  Gouvernante </h2><br>  Le troisi√®me d√©fi de performance dans Zabbix est d'effacer l'histoire avec Housekeeper.  Il observe tous les param√®tres - les √©l√©ments de donn√©es indiquent combien conserver la dynamique des changements (tendances) en jours. <br><br>  Nous calculons TrendsCache √† la vol√©e.  Lorsque les donn√©es arrivent, nous les agr√©gons en une heure et les √©crivons dans des tableaux pour la dynamique des changements de tendance. <br><br>  Housekeeper d√©marre et supprime les informations de la base de donn√©es avec les "s√©lections" habituelles.  Ce n'est pas toujours efficace, ce qui peut √™tre compris √† partir des graphiques de performance des processus internes. <br><br><img src="https://habrastorage.org/webt/m0/3q/x_/m03qx_0sgbs_2bpjc_toewzmsbo.png"><br><br>  Un graphique rouge indique que le synchroniseur d'historique est constamment occup√©.  Le graphique orange ci-dessus est Housekeeper, qui fonctionne constamment.  Il s'attend √† ce que la base de donn√©es supprime toutes les lignes qu'il a sp√©cifi√©es. <br><br>  Quand d√©sactiver Housekeeper?  Par exemple, il existe un ¬´ID d'article¬ª et vous devez supprimer les 5 000 derni√®res lignes dans un certain temps.  Bien s√ªr, cela se produit par index.  Mais g√©n√©ralement, l'ensemble de donn√©es est tr√®s volumineux, et la base de donn√©es lit toujours √† partir du disque et le place dans le cache.  Il s'agit toujours d'une op√©ration tr√®s co√ªteuse pour la base de donn√©es et, selon la taille de la base de donn√©es, peut entra√Æner des probl√®mes de performances. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/w4/c4/y7/w4c4y7m_lwigpvwzq4bfsftktw8.png" width="500"></div><br><br>  La gouvernante vient de se d√©connecter.  Dans l'interface Web, il existe un param√®tre dans "Administration g√©n√©rale" pour Housekeeper.  D√©sactivez le nettoyage interne pour l'historique des tendances internes et il ne g√®re plus cela. <br><br>  Gouvernante a √©t√© d√©sactiv√©e, les graphiques ont √©t√© nivel√©s - quel pourrait √™tre le probl√®me dans ce cas et qu'est-ce qui peut aider √† r√©soudre le troisi√®me d√©fi de performance? <br><br><h2>  Partitionnement - partitionnement ou partitionnement </h2><br>  En r√®gle g√©n√©rale, le partitionnement est configur√© d'une mani√®re diff√©rente sur chaque base de donn√©es relationnelle que j'ai r√©pertori√©e.  Chacun a sa propre technologie, mais ils sont g√©n√©ralement similaires.  La cr√©ation d'une nouvelle partition entra√Æne souvent certains probl√®mes. <br><br>  Les partitions sont g√©n√©ralement configur√©es en fonction de la ¬´configuration¬ª - la quantit√© de donn√©es cr√©√©es en une journ√©e.  En r√®gle g√©n√©rale, le partitionnement est expos√© en une journ√©e, c'est un minimum.  Pour les tendances de la nouvelle partition - pendant 1 mois. <br><br>  Les valeurs peuvent changer dans le cas d'une ¬´configuration¬ª tr√®s importante.  Si la petite ¬´configuration¬ª va jusqu'√† 5 000 nvps (nouvelles valeurs par seconde), la moyenne est de 5 000 √† 25 000, alors la grande est sup√©rieure √† 25 000 nvps.  Ce sont des installations grandes et tr√®s grandes qui n√©cessitent une configuration minutieuse de la base de donn√©es. <br><br>  Sur de tr√®s grandes installations, une ex√©cution d'une journ√©e peut ne pas √™tre optimale.  J'ai vu sur des partitions MySQL de 40 Go ou plus par jour.  Il s'agit d'une tr√®s grande quantit√© de donn√©es qui peut entra√Æner des probl√®mes et doit √™tre r√©duite. <br><br><h3>  Qu'est-ce qui donne le partitionnement? </h3><br>  <strong>Tables de partitionnement</strong> .  Il s'agit souvent de fichiers distincts sur le disque.  Le plan de requ√™te s√©lectionne de mani√®re plus optimale une partition.  Le partitionnement est g√©n√©ralement utilis√© sur une plage - pour Zabbix, cela est √©galement vrai.  Nous utilisons l√† ¬´timestamp¬ª - le temps depuis le d√©but de l'√®re.  Nous avons des nombres ordinaires.  Vous d√©finissez le d√©but et la fin de la journ√©e - c'est une partition. <br><br>  <strong>Suppression rapide</strong> - <code>DELETE</code> .  Un seul fichier / sous-tableau est s√©lectionn√©, pas une s√©lection de lignes √† supprimer. <br><br>  <strong>Acc√©l√®re visiblement la r√©cup√©ration des donn√©es</strong> <code>SELECT</code> - utilise une ou plusieurs partitions, pas la table enti√®re.  Si vous demandez des donn√©es il y a deux jours, elles sont s√©lectionn√©es plus rapidement dans la base de donn√©es car vous devez charger dans le cache et √©mettre un seul fichier, pas une grande table. <br><br>  Souvent, de nombreuses bases de donn√©es acc√©l√®rent √©galement les insertions <code>INSERT</code> dans la table enfant. <br><br><h2>  Timescaledb </h2><br>  Pour la version 4.2, nous avons tourn√© notre attention vers TimescaleDB.  Il s'agit d'une extension pour PostgreSQL avec une interface native.  L'extension fonctionne efficacement avec les donn√©es de s√©ries chronologiques, sans perdre les avantages des bases de donn√©es relationnelles.  TimescaleDB partitionne √©galement automatiquement. <br><br>  TimescaleDB a le concept d'un <strong>hypertable</strong> que vous cr√©ez.  Il contient des <strong>morceaux</strong> - des partitions.  Les morceaux sont des fragments contr√¥l√©s automatiquement d'un hypertable qui n'affectent pas les autres fragments.  Chaque morceau a sa propre plage horaire. <br><br><img src="https://habrastorage.org/webt/0p/0g/mh/0p0gmhmshsg_htxuboh2w1xdmeo.jpeg"><br><br><h3>  TimescaleDB vs PostgreSQL </h3><br>  TimescaleDB fonctionne vraiment efficacement.  Les fabricants d'extensions affirment utiliser un algorithme de traitement des demandes plus correct, en particulier les &lt;code&gt; insertions &lt;/code&gt;.  Lorsque les dimensions de l'insertion de jeu de donn√©es augmentent, l'algorithme maintient des performances constantes. <br><br><img src="https://habrastorage.org/webt/_n/1v/vo/_n1vvoqc1hghllux5r_u7i_23q4.png"><br><br>  Apr√®s 200 millions de lignes, PostgreSQL commence g√©n√©ralement √† s'affaisser fortement et perd des performances jusqu'√† 0. TimescaleDB vous permet d'ins√©rer efficacement des ¬´insertions¬ª pour n'importe quelle quantit√© de donn√©es. <br><br><h3>  L'installation </h3><br>  L'installation de TimescaleDB est assez facile pour tous les packages.  La <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation</a> d√©crit tout en d√©tail - cela d√©pend des packages officiels de PostgreSQL.  TimescaleDB peut √©galement √™tre compil√© et compil√© manuellement. <br><br>  Pour la base de donn√©es Zabbix, nous activons simplement l'extension: <br><br><pre> <code class="sql hljs">echo "<span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> EXTENSION <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> timescaledb <span class="hljs-keyword"><span class="hljs-keyword">CASCADE</span></span>;" | sudo -u postgres psql zabbix</code> </pre> <br>  Vous activez l' <code>extension</code> et la cr√©ez pour la base de donn√©es Zabbix.  La derni√®re √©tape consiste √† cr√©er un hypertable. <br><br><h3>  Migration des tables d'historique vers TimescaleDB </h3><br>  Il existe une fonction sp√©ciale <code>create_hypertable</code> : <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> create_hypertable(<span class="hljs-string"><span class="hljs-string">'history'</span></span>, <span class="hljs-string"><span class="hljs-string">'clock'</span></span>, chunk_time_interval =&gt; <span class="hljs-number"><span class="hljs-number">86400</span></span>, migrate_data =&gt; <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> create_hypertable(<span class="hljs-string"><span class="hljs-string">'history_unit'</span></span>, <span class="hljs-string"><span class="hljs-string">'clock'</span></span>, chunk_time_interval =&gt; <span class="hljs-number"><span class="hljs-number">86400</span></span>, migrate_data =&gt; <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> create_hypertable(<span class="hljs-string"><span class="hljs-string">'history_log'</span></span>, <span class="hljs-string"><span class="hljs-string">'clock'</span></span>, chunk_time_interval =&gt; <span class="hljs-number"><span class="hljs-number">86400</span></span>, migrate_data =&gt; <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> create_hypertable(<span class="hljs-string"><span class="hljs-string">'history_text'</span></span>, <span class="hljs-string"><span class="hljs-string">'clock'</span></span>, chunk_time_interval =&gt; <span class="hljs-number"><span class="hljs-number">86400</span></span>, migrate_data =&gt; <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> create_hypertable(<span class="hljs-string"><span class="hljs-string">'history_str'</span></span>, <span class="hljs-string"><span class="hljs-string">'clock'</span></span>, chunk_time_interval =&gt; <span class="hljs-number"><span class="hljs-number">86400</span></span>, migrate_data =&gt; <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> create_hypertable(<span class="hljs-string"><span class="hljs-string">'trends'</span></span>, <span class="hljs-string"><span class="hljs-string">'clock'</span></span>, chunk_time_interval =&gt; <span class="hljs-number"><span class="hljs-number">86400</span></span>, migrate_data =&gt; <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> create_hypertable(<span class="hljs-string"><span class="hljs-string">'trends_unit'</span></span>, <span class="hljs-string"><span class="hljs-string">'clock'</span></span>, chunk_time_interval =&gt; <span class="hljs-number"><span class="hljs-number">86400</span></span>, migrate_data =&gt; <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> config <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> db_extension=<span class="hljs-string"><span class="hljs-string">'timescaledb'</span></span>, hk_history_global=<span class="hljs-number"><span class="hljs-number">1</span></span>, hk_trends_global=<span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br>  La fonction a trois param√®tres.  Le premier est un <strong>tableau de la base</strong> de <strong>donn√©es</strong> pour lequel vous devez cr√©er un hypertable.  Le second est le <strong>champ</strong> par lequel cr√©er <code>chunk_time_interval</code> - l'intervalle des morceaux de partitions que vous souhaitez utiliser.  Dans mon cas, l'intervalle est d'un jour - 86 400. <br><br>  Le troisi√®me param√®tre est <code><strong>migrate_data</strong></code> .  Si la valeur est <code>true</code> , toutes les donn√©es actuelles sont transf√©r√©es vers des blocs cr√©√©s pr√©c√©demment.  J'ai moi-m√™me utilis√© <code>migrate_data</code> .  J'ai eu environ 1 To, ce qui a pris plus d'une heure.  M√™me dans certains cas, lors des tests, j'ai supprim√© les donn√©es historiques des types de caract√®res qui √©taient facultatifs pour le stockage, afin de ne pas les transf√©rer. <br><br>  La derni√®re √©tape est <code><strong>UPDATE</strong></code> : nous d√©finissons <code>db_extension</code> dans <code>db_extension</code> pour que la base de donn√©es comprenne qu'il y a cette extension.  Zabbix l'active et utilise correctement la syntaxe et les requ√™tes d√©j√† dans la base de donn√©es - ces fonctionnalit√©s qui sont n√©cessaires pour TimescaleDB. <br><br><h2>  Configuration du fer </h2><br>  J'ai utilis√© deux serveurs.  Le premier est une <strong>machine VMware</strong> .  Il est assez petit: 20 processeurs Intel¬Æ Xeon¬Æ E5-2630 v 4 √† 2,20 GHz, 16 Go de RAM et un SSD de 200 Go. <br><br>  J'ai install√© PostgreSQL 10.8 dessus avec Debian 10.8-1.pgdg90 + 1 et le syst√®me de fichiers xfs.  J'ai tout configur√© de mani√®re minimale pour utiliser cette base de donn√©es particuli√®re, moins ce que Zabbix lui-m√™me utilisera. <br><br>  Sur la m√™me machine se trouvait un serveur Zabbix, PostgreSQL et <strong>des agents de chargement</strong> .  J'avais 50 agents actifs qui utilisaient le <code>LoadableModule</code> pour g√©n√©rer tr√®s rapidement divers r√©sultats: nombres, cha√Ænes.  J'ai obstru√© la base de donn√©es avec beaucoup de donn√©es. <br><br>  Initialement, la configuration contenait <strong>5 000 √©l√©ments de</strong> donn√©es par h√¥te.  Presque chaque √©l√©ment contenait un d√©clencheur, de sorte qu'il √©tait similaire aux installations r√©elles.  Dans certains cas, il y avait plus d'un d√©clencheur.  Il y avait 3 <strong>000 √† 7 000 d√©clencheurs par</strong> n≈ìud de r√©seau. <br><br>  L'intervalle de mise √† jour des √©l√©ments de donn√©es est de <strong>4 √† 7 secondes</strong> .  J'ai r√©gul√© la charge elle-m√™me en utilisant non seulement 50 agents, mais √©galement en ajoutant plus.  De plus, √† l'aide d'√©l√©ments de donn√©es, j'ai ajust√© dynamiquement la charge et r√©duit l'intervalle de mise √† jour √† 4 s. <br><br><h3>  PostgreSQL  35 000 nvps </h3><br>  La premi√®re ex√©cution sur ce mat√©riel que j'ai eu sur PostgreSQL pur - 35 000 valeurs par seconde.  Comme vous pouvez le voir, l'insertion de donn√©es prend des fractions de seconde - tout va bien et rapidement.  La seule chose qu'un SSD de 200 Go se remplit rapidement. <br><br><img src="https://habrastorage.org/webt/wp/pk/vq/wppkvqe33kjs-udv8qc75jynloq.jpeg"><br><br>  Il s'agit du tableau de bord standard des performances du serveur Zabbix. <br><br><img src="https://habrastorage.org/webt/nu/h1/jl/nuh1jlhlz3cyoxyrc94cybshjos.png"><br><br>  Le premier graphique bleu est le nombre de valeurs par seconde.  Le deuxi√®me graphique √† droite est le chargement des processus d'assemblage.  Le troisi√®me est le chargement des processus d'assemblage internes: les synchroniseurs d'historique et Housekeeper, qui fonctionne depuis un certain temps ici. <br><br>  Le quatri√®me graphique montre l'utilisation de HistoryCache.  Il s'agit d'un tampon avant l'insertion dans la base de donn√©es.  Le cinqui√®me graphique vert montre l'utilisation de ValueCache, c'est-√†-dire combien de hits ValueCache pour les d√©clencheurs sont plusieurs milliers de valeurs par seconde. <br><br><h3>  PostgreSQL  50 000 nvps </h3><br>  Ensuite, j'ai augment√© la charge √† 50 000 valeurs par seconde sur le m√™me mat√©riel. <br><br><img src="https://habrastorage.org/webt/wj/47/u6/wj47u6j2fycdpnx55-mrrqrwcp4.jpeg"><br><br>  Lors du chargement √† partir de Housekeeper, une insertion de 10 000 valeurs a √©t√© enregistr√©e pendant 2-3 s. <br><br><img src="https://habrastorage.org/webt/fn/qo/go/fnqogopttou4hwlygqckfoieht0.png"><br>  <em>La gouvernante commence d√©j√† √† se mettre en travers.</em> <br><br>  Le troisi√®me graphique montre qu'en g√©n√©ral, le chargement des trappeurs et des synchroniseurs d'historique est toujours √† 60%.  Dans le quatri√®me graphique, HistoryCache commence d√©j√† √† se remplir assez activement pendant le fonctionnement.  Il est plein √† 20% - il fait environ 0,5 Go. <br><br><h3>  PostgreSQL  80 000 nvps </h3><br>  J'ai ensuite augment√© la charge √† 80 000 valeurs par seconde.  Il s'agit d'environ 400 000 √©l√©ments de donn√©es et 280 000 d√©clencheurs. <br><br><img src="https://habrastorage.org/webt/8q/zh/5z/8qzh5zsbwvouradg7j-qxeksqfi.jpeg"><br>  <em>L'insert pour charger trente synchroniseurs d'historique est d√©j√† assez √©lev√©.</em> <br><br>  J'ai √©galement augment√© divers param√®tres: synchroniseurs d'historique, caches. <br><br><img src="https://habrastorage.org/webt/xs/3m/ia/xs3miafccbymaddfyzzj2l4e494.png"><br><br>  Sur mon mat√©riel, la charge des synchroniseurs d'historique a augment√© au maximum.  HistoryCache s'est rapidement rempli de donn√©es - les donn√©es de traitement accumul√©es dans le tampon. <br><br>  Pendant tout ce temps, j'ai regard√© comment le processeur, la RAM et d'autres param√®tres syst√®me √©taient utilis√©s, et j'ai constat√© que l'utilisation du disque √©tait maximis√©e. <br><br><img src="https://habrastorage.org/webt/zy/el/im/zyelimg6_immdsthjxburb1gjmw.jpeg"><br><br>  J'ai tir√© le <strong>meilleur parti du lecteur</strong> sur ce mat√©riel et sur cette machine virtuelle.  √Ä cette intensit√©, PostgreSQL a commenc√© √† vider les donn√©es assez activement, et le disque n'a plus eu le temps de travailler sur l'√©criture et la lecture. <br><br><h3>  Deuxi√®me serveur </h3><br>  J'ai pris un autre serveur qui avait d√©j√† 48 processeurs et 128 Go de RAM.  R√©glez-le - d√©finissez 60 synchroniseur d'historique et obtenez des performances acceptables. <br><br><img src="https://habrastorage.org/webt/hl/ae/ig/hlaeigh1dtxphardj6hkwmtas8w.png"><br><br>  En fait, c'est d√©j√† une limite de performance o√π quelque chose doit √™tre fait. <br><br><h3>  TimescaleDB.  80 000 nvps </h3><br>  Ma t√¢che principale est de tester les capacit√©s de TimescaleDB √† partir de la charge Zabbix.  80 000 valeurs par seconde, c'est beaucoup, la fr√©quence de collecte des m√©triques (sauf pour Yandex, bien s√ªr) et une ¬´configuration¬ª assez importante. <br><br><img src="https://habrastorage.org/webt/c-/45/yc/c-45yc-ctmrtj7o5td-ajwrtpdm.png"><br><br>  Il y a un √©chec sur chaque graphique - c'est juste une migration de donn√©es.  Apr√®s des √©checs sur le serveur Zabbix, le profil de d√©marrage du synchroniseur d'historique a beaucoup chang√© - il est tomb√© trois fois. <br><br><blockquote>  TimescaleDB vous permet d'ins√©rer des donn√©es presque 3 fois plus rapidement et d'utiliser moins HistoryCache. </blockquote><br>  En cons√©quence, les donn√©es vous seront livr√©es en temps opportun. <br><br><h3>  TimescaleDB.  120 000 nvps </h3><br>  Ensuite, j'ai augment√© le nombre d'√©l√©ments de donn√©es √† 500 000. La t√¢che principale √©tait de v√©rifier les capacit√©s de TimescaleDB - j'ai obtenu la valeur calcul√©e de 125 000 valeurs par seconde. <br><br><img src="https://habrastorage.org/webt/hi/hd/ce/hihdcemwxqcqfxnv3n5-4ypmvic.png"><br><br>  Il s'agit d'une ¬´configuration¬ª fonctionnelle qui peut fonctionner pendant longtemps.  Mais comme mon disque ne faisait que 1,5 To, je l'ai rempli en quelques jours. <br><br><img src="https://habrastorage.org/webt/vk/51/wz/vk51wzryy45k4sycilxbcj-pjcq.png"><br><br>  Plus important encore, en m√™me temps, de nouvelles partitions TimescaleDB ont √©t√© cr√©√©es. <br><br>  Pour les performances, cela est compl√®tement invisible.  Lorsque des partitions sont cr√©√©es dans MySQL, par exemple, tout est diff√©rent.  Habituellement, cela se produit la nuit, car cela bloque l'insertion g√©n√©rale, en travaillant avec des tables et peut entra√Æner une d√©gradation du service.  Dans le cas de TimescaleDB, ce n'est pas le cas. <br><br>  Pour un exemple, je vais montrer un graphique de l'ensemble dans la communaut√©.  TimescaleDB est inclus dans l'image, pour cette raison, la charge sur l'utilisation de io.weight sur le processeur a chut√©.  L'utilisation d'√©l√©ments de processus internes a √©galement diminu√©.  Et ceci est une machine virtuelle ordinaire sur des disques de cr√™pes ordinaires, pas un SSD. <br><br><img src="https://habrastorage.org/webt/e6/bm/a-/e6bma-otl8o5mcrt9z8wkrsq5du.jpeg"><br><br><h2>  Conclusions </h2><br>  <strong>TimescaleDB est une bonne solution pour les petites ¬´configurations¬ª</strong> qui d√©pendent des performances du disque.  Il vous permettra de continuer √† bien fonctionner jusqu'√† ce que la base de donn√©es soit migr√©e pour repasser plus rapidement. <br><br>  TimescaleDB est facile √† configurer, am√©liore les performances, fonctionne bien avec Zabbix et <strong>pr√©sente des avantages par rapport √† PostgreSQL</strong> . <br><br>  Si vous utilisez PostgreSQL et ne pr√©voyez pas de le changer, alors je recommande d' <strong>utiliser PostgreSQL avec l'extension TimescaleDB en conjonction avec Zabbix</strong> .  Cette solution fonctionne efficacement pour une ¬´configuration¬ª moyenne. <br><br><blockquote><p>  Nous <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">disons</a> ¬´haute performance¬ª - nous voulons dire <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">HighLoad ++</a> .  En attendant de se familiariser tr√®s bri√®vement avec les technologies et les pratiques qui permettent aux services de servir des millions d'utilisateurs.  Nous avons d√©j√† compil√© une liste de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">rapports</a> pour les 7 et 8 novembre, mais des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">mitaps</a> peuvent toujours √™tre propos√©s. <br><br>  Abonnez-vous √† notre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">newsletter</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">t√©l√©gramme</a> , dans lequel nous d√©voilons les puces de la conf√©rence √† venir, et d√©couvrez comment en tirer le meilleur parti. </p></blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr470902/">https://habr.com/ru/post/fr470902/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr470882/index.html">Pourquoi avez-vous attrap√© ma souris ou un jeu de soci√©t√© comme mod√®le d'interaction sociale</a></li>
<li><a href="../fr470884/index.html">√âcriture et lecture de donn√©es dans la blockchain Bitcoin</a></li>
<li><a href="../fr470888/index.html">L√©gislation russe et internationale dans le domaine de la protection des donn√©es personnelles</a></li>
<li><a href="../fr470892/index.html">Impl√©mentation simple d'un petit CAM sur FPGA</a></li>
<li><a href="../fr470894/index.html">Balle</a></li>
<li><a href="../fr470904/index.html">Le chemin le plus doux et le plus velu de l'apprentissage automatique et des r√©seaux de neurones profonds</a></li>
<li><a href="../fr470908/index.html">Pour la premi√®re fois au monde √† l'aide de technologies additives, un assemblage de moteur d'avion de grande taille a √©t√© obtenu</a></li>
<li><a href="../fr470910/index.html">Que peut-on faire avec les annotations des contrats de microservices?</a></li>
<li><a href="../fr470916/index.html">Le point de contr√¥le √©lectronique ¬´le moins cher¬ª en Russie contr√¥l√© depuis un smartphone</a></li>
<li><a href="../fr470918/index.html">F # 9: Option de type</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>