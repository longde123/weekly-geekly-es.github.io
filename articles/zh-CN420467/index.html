<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘— ğŸ¤²ğŸ¾ â˜¹ï¸ ç”¨äºCortexM4çš„â€œæ‰€æœ‰â€å®æ—¶æ“ä½œç³»ç»Ÿçš„C ++åŒ…è£…å™¨ ğŸ‘©ğŸ¾â€ğŸ“ ğŸ‘©ğŸ¿â€ğŸ¤â€ğŸ‘©ğŸ½ ğŸ¥Ÿ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="æˆ‘å·²ç»åœ¨æ–‡ç« STM32ï¼ŒC ++å’ŒFreeRTOSä¸­è®¨è®ºäº†å¦‚ä½•å¯¹ç”¨C ++ç¼–å†™çš„é¡¹ç›®ä½¿ç”¨FreeRtos ã€‚ ä»å¤´å¼€å§‹å‘å±•ã€‚ ç¬¬ä¸€éƒ¨åˆ† ä»é‚£ä»¥åï¼Œé•¿è¾¾3å¹´çš„æ—¶é—´ï¼Œæˆ‘ä¸¥é‡è¡°è€ï¼Œå¤±å»äº†ä¸€å †ç¥ç»è¿æ¥ï¼Œæ‰€ä»¥æˆ‘å†³å®šæ”¹å˜è¿‡å»ï¼Œä»¥æ¢å¤è¿™äº›è¿æ¥å¹¶æ‰«é™¤â€œä»»ä½•â€æµè¡Œçš„RTOSçš„åŒ…è£…ã€‚ æˆ‘å½“ç„¶æ˜¯åœ¨å¼€ç©ç¬‘ï¼Œæˆ‘æ•…æ„å°†â€œæ‰€æœ‰äºº...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ç”¨äºCortexM4çš„â€œæ‰€æœ‰â€å®æ—¶æ“ä½œç³»ç»Ÿçš„C ++åŒ…è£…å™¨</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/420467/"><img src="https://habrastorage.org/webt/s0/2o/ve/s02ovegatxm9x39z6c8x_5fydki.png" alt="å›¾ç‰‡"><br><br> æˆ‘å·²ç»åœ¨æ–‡ç« <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">STM32ï¼ŒC ++å’ŒFreeRTOSä¸­</a>è®¨è®ºäº†å¦‚ä½•å¯¹ç”¨C ++ç¼–å†™çš„é¡¹ç›®ä½¿ç”¨FreeRtos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ã€‚</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä»å¤´å¼€å§‹å‘å±•ã€‚</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ç¬¬ä¸€éƒ¨åˆ†</a> ä»é‚£ä»¥åï¼Œé•¿è¾¾3å¹´çš„æ—¶é—´ï¼Œæˆ‘ä¸¥é‡è¡°è€ï¼Œå¤±å»äº†ä¸€å †ç¥ç»è¿æ¥ï¼Œæ‰€ä»¥æˆ‘å†³å®šæ”¹å˜è¿‡å»ï¼Œä»¥æ¢å¤è¿™äº›è¿æ¥å¹¶æ‰«é™¤â€œä»»ä½•â€æµè¡Œçš„RTOSçš„åŒ…è£…ã€‚ æˆ‘å½“ç„¶æ˜¯åœ¨å¼€ç©ç¬‘ï¼Œæˆ‘æ•…æ„å°†â€œæ‰€æœ‰äººâ€éƒ½ç”¨å¼•å·å¼•èµ·æ¥ï¼Œä½†æ¯ä¸ªç©ç¬‘ä¸­éƒ½æœ‰ä¸€äº›é“ç†ã€‚ <br><a name="habracut"></a><br> é‚£ä¹ˆï¼Œä»»åŠ¡æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆå®ƒä¸ä¹‹ç›¸å…³ï¼Ÿ ç›®å‰æœ‰ä¸Šç™¾ä¸‡ç§ç”¨Cè¯­è¨€ç¼–å†™çš„æ“ä½œç³»ç»Ÿ-æˆ‘ä¸æƒ³ä¸ºæ¯ç§å£å‘³é€‰æ‹©ä»˜è´¹ï¼Œå…è´¹ï¼Œå°å‹ï¼Œå¤§å‹â€¦â€¦ä½†æ˜¯å¯¹äºæˆ‘å‚ä¸çš„é¡¹ç›®ï¼Œä¸éœ€è¦æ‰€æœ‰æ“ä½œç³»ç»Ÿçš„æ‰€æœ‰è¿™äº›èŠ¯ç‰‡ï¼Œè¯¸å¦‚ä»»åŠ¡ä¹‹ç±»çš„åŸºæœ¬åŠŸèƒ½å°±è¶³å¤Ÿäº†ï¼Œäº‹ä»¶ï¼Œä»»åŠ¡é€šçŸ¥ï¼Œå…³é”®éƒ¨åˆ†ï¼Œäº’æ–¥é”å’Œä¿¡å·ç¯ï¼ˆå°½ç®¡æˆ‘å°½é‡ä¸ä½¿ç”¨å®ƒä»¬ï¼‰ï¼Œé˜Ÿåˆ—ã€‚ æ‰€æœ‰è¿™äº›éƒ½éœ€è¦ä»¥ä¸€ç§éå¸¸ç®€å•çš„å½¢å¼è¿›è¡Œï¼Œå¹¶ä¸”æ²¡æœ‰ä»»ä½•å¤šä½™çš„è£…é¥°ã€‚ <br><br> æˆ‘è®¤ä¸ºï¼Œç”¨C ++ç¼–å†™çš„å®¶ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><b>OSRV MAX</b></a>éå¸¸é€‚åˆæˆ‘çš„é¡¹ç›®ï¼Œä½¿ç”¨å®ƒæ˜¯ä¸€ç§ä¹è¶£ã€‚ <br><br> ä½†æ˜¯è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬çš„è®¾å¤‡å¿…é¡»ç¬¦åˆIEC_61508æ ‡å‡†ï¼Œå…¶ä¸­ä¸€é¡¹è¦æ±‚æ˜¯<i>ç»è¿‡éªŒè¯çš„ç›®æ ‡åº“</i>çš„<i>E.29åº”ç”¨</i> ã€‚ å¥½å§ï¼Œæˆ–è€…ç®€å•åœ°è¯´ï¼Œå¦‚æœæ‚¨åˆ¶é€ çš„è®¾å¤‡ç¬¦åˆ<u>SIL3</u>çº§åˆ«ï¼Œé‚£ä¹ˆï¼ˆå»ºè®®æ›´é«˜ï¼‰è¯·ä½¿ç”¨ä¸è¯¥çº§åˆ«ç›¸å¯¹åº”ä¸”ç»è¿‡æ—¶é—´æµ‹è¯•çš„åº“ã€‚ <br><br> å…³äºæˆ‘ä»¬çš„ä»»åŠ¡ï¼Œè¿™æ„å‘³ç€å¯ä»¥å°†<b>MAX MAX RTOS</b>ç”¨äºæ­¤ç±»è®¾å¤‡ï¼Œä½†ä¸ä¼šå¢åŠ å¯é æ€§ç‚¹ã€‚ å› æ­¤ï¼ŒRTOSåˆ¶é€ å•†ä¼šåˆ¶é€ ç¬¦åˆIEC_61508æ ‡å‡†çš„ç‰¹æ®Šç‰ˆæœ¬çš„æ“ä½œç³»ç»Ÿï¼Œä¾‹å¦‚ï¼Œ <i>FreeRTOS</i>å…·æœ‰<i>SafeRTOS</i>å…‹éš†ï¼Œè€Œ<i>embOs</i>å…·æœ‰<i>embOS-Safe</i>å…‹éš†ï¼Œåˆ¶é€ å•†å½“ç„¶å¯ä»¥ä»ä¸­èµšé’±ï¼Œå› ä¸ºè¿™äº›OSçš„è®¸å¯è¯éœ€è¦èŠ±è´¹æ•°åƒç”šè‡³æ•°åç¾å…ƒã€‚ä¸€åƒç¾å…ƒã€‚ <br><br> é¡ºä¾¿è¯´ä¸€å¥ï¼Œä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­æ˜¯IARç¼–è¯‘å™¨ï¼Œå…¶è®¸å¯è¯çš„ä»·æ ¼çº¦ä¸º1,500ç¾å…ƒï¼Œä½†IARè®¤è¯çš„ç‰ˆæœ¬å·²ç»è€—èµ„çº¦10,000ç¾å…ƒï¼Œå°½ç®¡æˆ‘æ£€æŸ¥äº†å¤šä¸ªé¡¹ç›®-æ²¡æœ‰è¯ä¹¦ä¸”å¸¦æœ‰è¯ä¹¦çš„ç‰ˆæœ¬çš„è¾“å‡ºæ–‡ä»¶å®Œå…¨ç›¸åŒã€‚ å¥½å§ï¼Œæ‚¨äº†è§£æ‚¨éœ€è¦ä¸ºå’Œå¹³ä»˜å‡ºä»£ä»·ã€‚ <br><br> å› æ­¤ï¼Œé¦–å…ˆæˆ‘ä»¬ä½¿ç”¨<i>ä¸€ä¸ªæ“ä½œç³»ç»Ÿ</i> ï¼Œç„¶åæ ¹æ®éœ€è¦å¼€å§‹ä½¿ç”¨<i>FreeRTOS</i> ï¼Œç„¶ååˆ‡æ¢åˆ°<i>å¦ä¸€ä¸ª</i> <i>æ“ä½œç³»ç»Ÿ</i> ï¼Œé€šå¸¸ï¼Œæˆ‘ä»¬ç»å¸¸ä¸å¾—ä¸é‡å†™å®Œæˆçš„ä»£ç ã€‚ å¦å¤–ï¼Œæˆ‘å¸Œæœ›å®ƒçœ‹èµ·æ¥ç¾ä¸½è€Œç®€å•ï¼Œä»¥ä¾¿ä»»ä½•äººéƒ½å¯ä»¥é€šè¿‡ä»£ç æ¥ç†è§£æ­£åœ¨å‘ç”Ÿçš„äº‹æƒ…ï¼Œç„¶åä»£ç æ”¯æŒå¯¹äºå­¦ç”Ÿå’Œä»ä¸šè€…æ¥è¯´å°†æ˜¯ä¸€ä»¶ç®€å•çš„å·¥ä½œï¼Œå¤§å¸ˆå°†èƒ½å¤Ÿç»§ç»­åœ¨åˆ›æ–°è®¾å¤‡ä¸Šå·¥ä½œï¼Œè€Œä¸æ˜¯å»ç†è§£é¢æ¡ã€‚ æ€»çš„æ¥è¯´ï¼Œæˆ‘å¸Œæœ›çœ‹åˆ°è¿™æ ·çš„åƒµåŒ–ç°è±¡ï¼š <br><br><img src="https://habrastorage.org/webt/rc/2z/_k/rc2z_kzdcpu6isdhwojtbbi4wac.png" alt="å›¾ç‰‡"><br><br> å¥½å§ï¼Œè¿™æ ·çš„... <br><br><img src="https://habrastorage.org/webt/f7/li/48/f7li48lkaylpglvyjr-tiekmxai.png" alt="å›¾ç‰‡"><br><br> å› æ­¤ï¼Œæˆ‘å†³å®šå†™ä¸€ä¸ªé€‚åˆ<i>FreeRTOS</i>çš„åŒ…è£…ï¼Œå¹¶è¯´<i>embOSï¼Œ</i>ä¹Ÿé€‚ç”¨äºå…¶ä»–æ‰€æœ‰äºº:)ï¼Œä¸€å¼€å§‹ï¼Œæˆ‘å°±ç¡®å®šäº†è¦è·å¾—å®Œå…¨å¹¸ç¦æ‰€éœ€çš„ä¸œè¥¿ï¼š <br><br><ul><li> ä»»åŠ¡ </li><li> å…³é”®éƒ¨åˆ† </li><li> äº‹ä»¶å’Œä»»åŠ¡é€šçŸ¥ </li><li> ä¿¡å·é‡å’Œäº’æ–¥é‡ </li><li>  Queueåˆ— </li></ul><br> åŒ…è£…ç¨‹åºåº”è¯¥æ˜¯<u>SIL3</u>æ„è¯†å½¢æ€çš„ï¼Œå¹¶ä¸”æ­¤çº§åˆ«å¼ºåŠ äº†è®¸å¤šâ€œé«˜åº¦æ¨èâ€çš„ä¸œè¥¿ï¼Œå¦‚æœæ‚¨å®Œå…¨éµå¾ªå®ƒä»¬ï¼Œé‚£ä¹ˆæœ€å¥½ä¸è¦å®Œå…¨ç¼–å†™ä»£ç ã€‚ <br><br> ä½†æ˜¯ï¼Œè¯¥æ ‡å‡†ç®¡ç†ç€è®¸å¤šè§„åˆ™æˆ–å»ºè®®ï¼Œè¿™ä¸€äº‹å®å¹¶ä¸æ„å‘³ç€å®ƒä»¬ä¸èƒ½è¢«è¿å-æ‚¨å¯ä»¥ï¼Œä½†æ˜¯æ‚¨éœ€è¦éµå¾ªå°½å¯èƒ½å¤šçš„å»ºè®®æ‰èƒ½è·å¾—æ›´å¤šç§¯åˆ†ã€‚ å› æ­¤ï¼Œæˆ‘å†³å®šäº†ä¸€äº›é‡è¦çš„é™åˆ¶ï¼š <br><br><ul><li>  <b>æ²¡æœ‰å®</b> ï¼Œé™¤äº†é˜²æ­¢å¤´æ–‡ä»¶é‡å¤åŒ…å«çš„ä¿æŠ¤ä¹‹å¤–ã€‚ å®æ˜¯é‚ªæ¶çš„ï¼Œå¦‚æœæ‚¨è®¡ç®—èŠ±è´¹äº†å¤šå°‘æ—¶é—´æ¥æœç´¢ä¸å®ç›¸å…³çš„é”™è¯¯ï¼Œé‚£ä¹ˆäº‹å®è¯æ˜å®‡å®™å¹¶ä¸é‚£ä¹ˆå¤è€ï¼Œå¹¶ä¸”åœ¨è¿™æ®µæ—¶é—´å†…å¯ä»¥åšå¤šå°‘äº‹æƒ…ï¼Œæœ€å¥½æ˜¯åœ¨ç«‹æ³•å±‚é¢ä¸Šç¦æ­¢å®ƒä»¬ï¼Œå› ä¸ºæ´ªæµç¦æ­¢æˆ–ä¸ºæ‚¨ç¼–å†™çš„æ¯ä¸ªå®å–åŠ åˆ† </li><li> å½“ç„¶<b>ä¸è¦ä½¿ç”¨æŒ‡é’ˆ</b> ã€‚ å¯ä»¥å°è¯•ä¸€ç‚¹éƒ½ä¸ä½¿ç”¨å®ƒä»¬ï¼Œä½†æ˜¯ä»ç„¶æœ‰äº›åœ°æ–¹æ²¡æœ‰å®ƒä»¬æ˜¯æ²¡æœ‰åŠæ³•çš„ã€‚ æ— è®ºå¦‚ä½•ï¼ŒåŒ…è£…å™¨çš„ç”¨æˆ·ï¼ˆå¦‚æœå¯èƒ½çš„è¯ï¼‰ç”šè‡³éƒ½ä¸åº”è¯¥çŸ¥é“æŒ‡é’ˆæ˜¯ä»€ä¹ˆï¼Œå› ä¸ºä»–åªæ˜¯ä»ç¥–çˆ¶é‚£é‡Œå¬è¯´è¿‡æŒ‡é’ˆï¼Œå› ä¸ºç°åœ¨ä»–åªä½¿ç”¨é“¾æ¥ </li><li>  <b>ä¸ä½¿ç”¨åŠ¨æ€å†…å­˜åˆ†é…</b> -ä¸€åˆ‡éƒ½æ¸…æ¥šäº†ï¼Œä»…ä½¿ç”¨å †ä¼šå¯¼è‡´é¦–å…ˆéœ€è¦ä¸ºæ­¤å †ä¿ç•™RAMï¼Œå…¶æ¬¡ï¼Œç”±äºé¢‘ç¹ä½¿ç”¨å †ï¼Œä¼šå¯¹å…¶è¿›è¡Œç¢ç‰‡æ•´ç†å¹¶åœ¨å…¶ä¸Šåˆ›å»ºæ–°å¯¹è±¡çš„æ—¶é—´è¶Šæ¥è¶Šé•¿æ›´é•¿ã€‚ å› æ­¤ï¼Œ <i>å®é™…ä¸Šï¼Œ</i>æˆ‘é€šè¿‡è®¾ç½®<i>configSUPPORT_STATIC_ALLOCATION 1</i>ä»…åœ¨é™æ€åˆ†é…çš„å†…å­˜ä¸Šé…ç½®äº†<i>FreeRTOS</i> ã€‚ ä½†æ˜¯å¦‚æœè¦åœ¨é»˜è®¤æ¨¡å¼ä¸‹å·¥ä½œã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œ <i>FreeRTOS</i>ä½¿ç”¨åŠ¨æ€åˆ†é…çš„å†…å­˜æ¥åˆ›å»ºOSå…ƒç´ ï¼›ç„¶ååªéœ€è®¾ç½®<i>configSUPPORT_STATIC_ALLOCATION 0</i> ï¼Œç„¶å <br>  <i>configSUPPORT_DYNAMIC_ALLOCATION 1ï¼Œ</i>å¹¶ä¸”ä¸è¦å¿˜è®°ä»å†…å­˜ç®¡ç†å™¨è¿æ¥æ‚¨è‡ªå·±çš„Mallocå’ŒCallocçš„å®ç°ï¼Œä¾‹å¦‚ï¼Œæ­¤æ–‡ä»¶ä¸ºFreeRtos / Portable / MemMang / heap_1.cã€‚ ä½†è¯·è®°ä½ï¼Œæ‚¨å°†ä¸å¾—ä¸ä¸ºä¸€å †é¢„ç•™ç©ºé—´åˆ†é…RAMï¼Œå› ä¸ºæ‚¨å°†æ— æ³•ä½¿ç”¨æ‰€æœ‰è®¾ç½®æ¥è®¡ç®—æ‰€éœ€çš„ç¡®åˆ‡RAMæ•°é‡ï¼ˆç©ºé—²å¤„äºå¯ç”¨çŠ¶æ€ï¼Œç¨‹åºè®¡æ—¶å™¨ä»»åŠ¡å¤„äºå¯ç”¨çŠ¶æ€ï¼Œæˆ‘çš„ä¸¤ä¸ªä»»åŠ¡ï¼Œé˜Ÿåˆ—ï¼Œè®¡æ—¶å™¨10å’Œ10çš„é˜Ÿåˆ—å¤§å°ï¼‰å¦‚æ­¤è¯´æ¥ï¼Œå½“æˆ‘è¿™æ ·åˆ†é…å†…å­˜æ—¶ï¼Œè‚¯å®šä¸æ˜¯æœ€ä½³è®¾ç½®ï¼‰ï¼š <br><blockquote>  7357å­—èŠ‚çš„åªè¯»ä»£ç å­˜å‚¨å™¨ <br>  535å­—èŠ‚çš„åªè¯»æ•°æ®å­˜å‚¨å™¨ <br>  6,053å­—èŠ‚çš„è¯»å†™æ•°æ®å­˜å‚¨å™¨ </blockquote><br> é™æ€å†…å­˜åˆ†é…â€œç´§å‡‘â€ä¸€äº›ï¼š <br><blockquote>  7,329å­—èŠ‚çš„åªè¯»ä»£ç å­˜å‚¨å™¨ <br>  535å­—èŠ‚çš„åªè¯»æ•°æ®å­˜å‚¨å™¨ <br>  3,877å­—èŠ‚çš„è¯»å†™æ•°æ®å­˜å‚¨å™¨ </blockquote><br> æ‚¨å¯èƒ½ä¼šæƒ³ï¼Œâ€œå¤ªæ£’äº†â€¦â€¦æ‚¨è‡ªå·±ï¼Œâ€ï¼Œä½†æ˜¯ç°åœ¨æˆ‘ä»¬å¯¹æ–‡ç« <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">â€œæˆ‘ä¸ºæ“ä½œç³»ç»Ÿåˆ†é…äº†å¤šè¾¾3KBçš„å†…å­˜ï¼Œå¹¶ä»…é€šè¿‡128Bå †æ ˆå¯åŠ¨äº†3ä¸ªä»»åŠ¡ï¼Œå¹¶ä¸”ç”±äºæŸç§åŸå› ï¼Œç¬¬å››ä¸ªå†…å­˜å·²ç»ä¸è¶³â€ä¸€</a>æ–‡ä¸­çš„é—®é¢˜ä¸æ„Ÿå…´è¶£ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸ºæ¸…æ¥šèµ·è§ï¼Œæˆ‘æ•…æ„è¿™æ ·åšæ˜¯ä¸ºäº†æ˜¾ç¤ºå…·æœ‰ç›¸åŒè®¾ç½®çš„åŠ¨æ€å’Œé™æ€å†…å­˜åˆ†é…ä¹‹é—´çš„åŒºåˆ«ã€‚ <br></li><li> å¦‚æœå¯èƒ½ï¼Œ <b>ä¸è¦è½¬æ¢ç±»å‹</b> ã€‚ å°†ç±»å‹è™šæ‹ŸåŒ–ä¸ºå…¶ä»–ç±»å‹æœ¬èº«æ„å‘³ç€åœ¨è®¾è®¡ä¸­å‡ºç°äº†ä¸€äº›é—®é¢˜ï¼Œä½†æ˜¯åƒå¾€å¸¸ä¸€æ ·ï¼Œæœ‰æ—¶æ‚¨ä»å¿…é¡»å¼ºåˆ¶è½¬æ¢ä»¥æ˜“äºä½¿ç”¨ï¼ˆä¾‹å¦‚ï¼Œå¿…é¡»å°†æšä¸¾è½¬æ¢ä¸ºæ•´æ•°ï¼‰ï¼Œå¹¶ä¸”æœ‰æ—¶æ‚¨ä¸èƒ½è¿™ä¸ªï¼Œä½†æ˜¯å¿…é¡»é¿å…ã€‚ </li><li>  <b>ç®€å•æ–¹ä¾¿</b> ã€‚ å¯¹äºåŒ…è£…çº¸çš„ä½¿ç”¨è€…æ¥è¯´ï¼Œæ‰€æœ‰çš„å›°éš¾éƒ½å¿…é¡»éšè—èµ·æ¥ï¼Œæ‰€ä»¥ä»–çš„ç”Ÿæ´»è¿˜ä¸æ˜¯æ²¹ï¼Œä»–è¿˜ä¸æƒ³ä½¿å®ƒå˜å¾—å¤æ‚-ä»–åˆ›å»ºäº†ä»»åŠ¡ï¼Œæ‰§è¡Œäº†ä»»åŠ¡ä¸­éœ€è¦çš„ä¸€åˆ‡ï¼Œå¼€å§‹äº†ä»»åŠ¡å¹¶äº«å—ç”Ÿæ´»ã€‚ </li></ul><br> æˆ‘ä»¬å°†ä»æ­¤å¼€å§‹ï¼Œå› æ­¤æˆ‘ä»¬ä¸ºè‡ªå·±è®¾å®šäº†åˆ›å»ºä»»åŠ¡çš„ä»»åŠ¡ï¼ˆåŸæ¥æ˜¯ä»â€œç¦æ­¢â€ç³»åˆ—ä¸­å¾—å‡ºçš„ç»“æœï¼‰ã€‚ <br><br><h2> ä»»åŠ¡åˆ›å»º </h2><br> é€šè¿‡é•¿æœŸçš„ç ”ç©¶ï¼Œè‹±å›½ç§‘å­¦å®¶ï¼ˆ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æœ‰å…³Coin Wallsçš„RTOSçš„å…¨éƒ¨çœŸç›¸ã€‚ç¬¬4æ¡ã€‚ä»»åŠ¡ï¼Œä¸Šä¸‹æ–‡åˆ‡æ¢å’Œä¸­æ–­</a> ï¼‰ï¼ˆé¡ºä¾¿è¯´ä¸€å¥ï¼Œå¦‚æœæ‚¨ä¸çŸ¥é“ï¼ŒARMçš„æ±‡ç¼–å™¨ä¹Ÿæ˜¯ç”±è‹±å›½ç§‘å­¦å®¶å‘æ˜çš„ï¼Œæˆ‘å¯¹æ­¤ä¹Ÿä¸æ„Ÿåˆ°æƒŠè®¶ã€‚ä¸€æ¬¡:)ï¼‰ï¼Œå› æ­¤è‹±å›½ç§‘å­¦å®¶å‘ç°ï¼Œå¯¹äºå¤§å¤šæ•°â€œæ‰€æœ‰â€ RTOSï¼Œè¯¥ä»»åŠ¡éƒ½æœ‰ä¸€ä¸ª<i>åç§°</i> ï¼Œ <i>å †æ ˆ</i> ï¼Œ <i>å †æ ˆå¤§å°</i> ï¼Œ <i>â€œæ§åˆ¶å•å…ƒâ€</i> ï¼Œ <i>æ ‡è¯†ç¬¦æˆ–æŒ‡å‘â€œæ§åˆ¶å•å…ƒâ€çš„æŒ‡é’ˆ</i> ï¼Œ <i>ä¼˜å…ˆçº§</i> ï¼Œ <i>è¯¥ä»»åŠ¡ä¸­æ‰§è¡Œ</i>çš„<i>åŠŸèƒ½</i> ã€‚ ä»…æ­¤è€Œå·²ï¼Œå¯ä»¥å°†å…¶å…¨éƒ¨å¡å…¥ä¸€ä¸ªç±»ä¸­ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬ä¸æ‚¨ä¸€èµ·ç¼–å†™ä¸€ä¸ªOSï¼Œä½†æ˜¯æˆ‘ä»¬è¿›è¡ŒåŒ…è£…ï¼Œé‚£æ˜¯æ­£ç¡®çš„ï¼Œå› æ­¤å°†æ‰€æœ‰è¿™äº›å†…å®¹å­˜å‚¨åœ¨åŒ…è£…ä¸­æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œè¿™ä¸€åˆ‡å°†ç”±<u>SIL3</u>æ„è¯†å½¢æ€çš„OSä¸ºæ‚¨<u>å®Œæˆ</u> ã€‚æˆ‘ä»¬æ€»ç»“ã€‚ å®é™…ä¸Šï¼Œæˆ‘ä»¬åªéœ€è¦<i>åœ¨ä»»åŠ¡ä¸­æ‰§è¡Œ</i>çš„<i>åŠŸèƒ½</i>å’Œ<i>å­˜å‚¨â€œæ§åˆ¶å•å…ƒâ€</i>çš„<i>ç»“æ„ï¼Œ</i>è¯¥<i>ç»“æ„</i>åœ¨åˆ›å»ºä»»åŠ¡å’Œ<i>ä»»åŠ¡æ ‡è¯†ç¬¦</i>æ—¶å°±ä¼šå¡«å†™ã€‚ å› æ­¤ï¼Œä»»åŠ¡ç±»ï¼ˆæˆ‘ä»¬ç§°ä¹‹ä¸º<i>Threadï¼‰</i>çœ‹èµ·æ¥éå¸¸ç®€å•ï¼š <br><br><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Thread</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-number"><span class="hljs-number">0</span></span> ; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: tTaskHandle taskHandle ; tTaskContext context ; } ;</code> </pre> <br> æˆ‘åªæƒ³å£°æ˜æˆ‘çš„ä»»åŠ¡ç±»ï¼Œåœ¨å…¶ä¸­å¯ä»¥å®ç°æ‰€éœ€çš„æ‰€æœ‰å†…å®¹ï¼Œç„¶åå°†æŒ‡å‘æ­¤ç±»å¯¹è±¡çš„æŒ‡é’ˆä¼ é€’ç»™åŒ…è£…å™¨ï¼ŒåŒ…è£…å™¨å°†ä½¿ç”¨RTOS APIåˆ›å»ºä»»åŠ¡ï¼Œå¹¶åœ¨å…¶ä¸­å¯åŠ¨<i>Executeï¼ˆï¼‰</i>æ–¹æ³•ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyTask</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Thread { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> override </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { <span class="hljs-comment"><span class="hljs-comment">//do something.. } } ; using tMyTaskStack = std::array&lt;OsWrapper::tStack, static_cast&lt;tU16&gt;(OsWrapper::StackDepth::minimal)&gt; ; inline static tMyTaskStack Stack; //!C++17 } ; MyTask myDesiredTask int main() { Rtos::CreateThread(myTask, MyTask::Stack.data(), "myTask") ; }</span></span></code> </pre> <br> åœ¨â€œæ‰€æœ‰â€ RTOSä¸­ï¼Œä¸ºäº†åˆ›å»ºä»»åŠ¡ï¼Œå¿…é¡»å°†æŒ‡é’ˆä¼ é€’ç»™å°†ç”±è°ƒåº¦ç¨‹åºå¯åŠ¨çš„åŠŸèƒ½ã€‚ åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œè¿™æ˜¯<i>Executeï¼ˆï¼‰</i>å‡½æ•°ï¼Œä½†æ˜¯ç”±äºå®ƒä¸æ˜¯é™æ€çš„ï¼Œå› æ­¤æˆ‘æ— æ³•å°†æŒ‡é’ˆä¼ é€’ç»™è¯¥æ–¹æ³•ã€‚ å› æ­¤ï¼Œæˆ‘ä»¬ç ”ç©¶äº†å¦‚ä½•åœ¨â€œæ‰€æœ‰â€æ“ä½œç³»ç»Ÿçš„APIä¸­åˆ›å»ºä»»åŠ¡ï¼Œå¹¶æ³¨æ„åˆ°æˆ‘ä»¬å¯ä»¥é€šè¿‡å°†å‚æ•°ä¼ é€’ç»™ä»»åŠ¡å‡½æ•°æ¥åˆ›å»ºä»»åŠ¡ï¼Œä¾‹å¦‚ï¼Œå¯¹äº<i>embOS</i> ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OS_TASK_CreateEx</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( OS_TASK* pTask, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* pName, OS_PRIO Priority, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> (*pRoutine)(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * pVoid ), </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> OS_STACKPTR *pStack, OS_UINT StackSize, OS_UINT TimeSlice, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">* pContext)</span></span></span></span>;</code> </pre><br>  <b>void * pContext-</b>è¿™æ˜¯è§£å†³æ–¹æ¡ˆçš„å…³é”®ã€‚ è®©æˆ‘ä»¬æœ‰ä¸€ä¸ªé™æ€æ–¹æ³•ï¼Œä¸€ä¸ªæŒ‡é’ˆå°†ä½œä¸ºæŒ‡é’ˆä¼ é€’ç»™è°ƒåº¦ç¨‹åºè°ƒç”¨çš„æ–¹æ³•ï¼Œè€Œä½œä¸ºå‚æ•°ï¼Œæˆ‘ä»¬å°†æŒ‡é’ˆä¼ é€’ç»™<i>Thread</i>ç±»å‹çš„å¯¹è±¡ï¼Œåœ¨è¯¥å¯¹è±¡ä¸­æˆ‘ä»¬å¯ä»¥ç›´æ¥è°ƒç”¨<i>Executeï¼ˆï¼‰</i>æ–¹æ³•ã€‚ è¿™æ°å¥½æ˜¯æ²¡æœ‰æŒ‡é’ˆå¹¶å¼ºåˆ¶è½¬æ¢ä¸ºç±»å‹çš„é‚£ä¸€åˆ»ï¼Œä½†æ­¤ä»£ç å°†å¯¹ç”¨æˆ·éšè—ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *pContext )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;Thread*&gt;(pContext)-&gt;Execute() ; }</code> </pre> <br> å³ ä½¿ç”¨è¿™ç§æ“ä½œç®—æ³•ï¼Œè°ƒåº¦ç¨‹åºå°†å¯åŠ¨<i>Run</i>æ–¹æ³•ï¼Œå°†æŒ‡å‘<i>Thread</i>ç±»å‹çš„å¯¹è±¡çš„æŒ‡é’ˆä¼ é€’ç»™<i>Run</i>æ–¹æ³•ã€‚  <i>Run</i>æ–¹æ³•ç›´æ¥è°ƒç”¨<i>Executeï¼ˆï¼‰</i>æ–¹æ³•ï¼Œè¿™æ˜¯<i>Thread</i>ç±»çš„ç‰¹å®šå¯¹è±¡ï¼Œè¿™åªæ˜¯æˆ‘ä»¬å¯¹ä»»åŠ¡çš„å®ç°ã€‚ <br><br> é—®é¢˜å‡ ä¹è§£å†³äº†ï¼Œç°åœ¨æˆ‘ä»¬éœ€è¦å®ç°è¿™äº›æ–¹æ³•ã€‚ æ‰€æœ‰æ“ä½œç³»ç»Ÿéƒ½æœ‰ä¸åŒçš„APIï¼Œå› æ­¤è¦å®ç°ä¾‹å¦‚<i>embOS</i>çš„ä»»åŠ¡åˆ›å»ºåŠŸèƒ½<i>ï¼Œ</i>å¿…é¡»è°ƒç”¨void <i>OS_TASK_CreateExï¼ˆ..ï¼‰</i>æ–¹æ³•ï¼›å¯¹äºåŠ¨æ€å†…å­˜åˆ†é…æ¨¡å¼ä¸‹çš„<i>FreeRTOS</i> ï¼Œè¿™æ˜¯<i>xTaskCreateï¼ˆ..ï¼‰</i> ï¼Œå°½ç®¡å®ƒä»¬å…·æœ‰ç›¸åŒçš„æœ¬è´¨ç›¸åŒï¼Œä½†æ˜¯è¯­æ³•å’Œå‚æ•°ä¸åŒã€‚ ä½†æ˜¯æˆ‘ä»¬ä¸æƒ³éå†æ–‡ä»¶å¹¶ä¸ºæ–°æ“ä½œç³»ç»Ÿæ¯æ¬¡éƒ½ä¸ºç±»çš„æ¯ä¸ªæ–¹æ³•ç¼–å†™ä»£ç ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ä»¥æŸç§æ–¹å¼å°†å…¶æ”¾å…¥ä¸€ä¸ªæ–‡ä»¶å¹¶ä»¥å®çš„å½¢å¼æ‰§è¡Œã€‚ å¾ˆå¥½ï¼Œä½†æ˜¯è¯·åœä¸‹æ¥ï¼Œæˆ‘ç¦æ­¢è‡ªå·±ä½¿ç”¨å®-æˆ‘éœ€è¦ä¸€ç§ä¸åŒçš„æ–¹æ³•ã€‚ <br><br> å¯¹æˆ‘è€Œè¨€ï¼Œæœ€ç®€å•çš„äº‹æƒ…æ˜¯ä½¿ç”¨å†…è”åŠŸèƒ½ä¸ºæ¯ä¸ªOSåˆ›å»ºä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶ã€‚ å¦‚æœè¦ä½¿ç”¨ä»»ä½•å…¶ä»–æ“ä½œç³»ç»Ÿï¼Œåˆ™åªéœ€è¦ä½¿ç”¨æ­¤æ“ä½œç³»ç»Ÿçš„APIæ¥å®ç°æ‰€æœ‰è¿™äº›åŠŸèƒ½ã€‚ åŸæ¥ä»¥ä¸‹<b>rtosFreeRtos.cpp</b>æ–‡ä»¶ <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"rtos.hpp"</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//For FreeRTOS functions prototypes #include &lt;FreeRTOS.h&gt; //For xTaskCreate #include &lt;task.h&gt; namespace OsWrapper { void wCreateThread(Thread &amp; thread, const char * pName, ThreadPriority prior,const tU16 stackDepth, tStack *pStack) { #if (configSUPPORT_STATIC_ALLOCATION == 1) if (pStack != nullptr) { thread.handle = xTaskCreateStatic(static_cast&lt;TaskFunction_t&gt;(Rtos::Run), pName, stackDepth, &amp;thread, static_cast&lt;uint32_t&gt;(prior), pStack, &amp;thread.taskControlBlock); } #else thread.handle = (xTaskCreate(static_cast&lt;TaskFunction_t&gt;(Rtos::Run), pName, stackDepth, &amp;thread, static_cast&lt;uint32_t&gt;(prior), &amp;thread.handle) == pdTRUE) ? thread.handle : nullptr ; #endif }</span></span></span></span></code> </pre><br>  embOS <b>rtosEmbOS.cpp</b>çš„æ–‡ä»¶å¯èƒ½çœ‹èµ·æ¥å®Œå…¨<b>ä¸€æ ·</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"rtos.hpp"</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//For embOS functions prototypes #include &lt;rtos.h&gt; namespace OsWrapper { void wCreateThread(Thread &amp;thread, const char * pName, ThreadPriority prior,const tU16 stackDepth, tStack *pStack) { constexpr OS_UINT timeSliceNull = 0 ; if (pStack != nullptr) { OS_CreateTaskEx(&amp;(thread.handle), pName, static_cast&lt;OS_PRIO&gt;(prior), Rtos::Run, pStack, ((stackSize == 0U) ? sizeof(pStack) : stackSize), timeSliceNull, &amp;thread) ; } }</span></span></span></span></code> </pre> <br> ä¸åŒæ“ä½œç³»ç»Ÿçš„ç±»å‹ä¹Ÿä¸åŒï¼Œå°¤å…¶æ˜¯ä»»åŠ¡ä¸Šä¸‹æ–‡çš„ç»“æ„ï¼Œå› æ­¤è®©æˆ‘ä»¬ä½¿ç”¨è‡ªå·±çš„åŒ…è£…ç¨‹åºåˆ«ååˆ›å»ºrtosdefs.hppæ–‡ä»¶ã€‚ <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;FreeRTOS.h&gt; //For TaskHandle_t namespace OsWrapper { using tTaskContext = StaticTask_t; using tTaskHandle = TaskHandle_t; using tStack = StackType_t ; }</span></span></span></span></code> </pre><br> å¯¹äº<i>EmbOSï¼Œ</i>å®ƒå¯èƒ½å¦‚ä¸‹æ‰€ç¤ºï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;rtos.h&gt; //For OS_TASK namespace OsWrapper { using tTaskContext = OS_TASK; using tTaskHandle = OS_TASK; using tStack = tU16 //   void,      tU16 ; }</span></span></span></span></code> </pre><br> å› æ­¤ï¼Œè¦åœ¨å…¶ä»–ä»»ä½•RTOSä¸‹è¿›è¡Œæ›´æ”¹ï¼Œä»…åœ¨è¿™ä¸¤ä¸ªæ–‡ä»¶rtosdefs.cppå’Œrtos.cppä¸­è¿›è¡Œæ›´æ”¹å°±è¶³å¤Ÿäº†ã€‚ ç°åœ¨<i>Thread</i>å’Œ<i>Rtos</i>ç±»çœ‹èµ·æ¥åƒcå›¾ç‰‡ <br><br><img src="https://habrastorage.org/webt/gp/wq/zl/gpwqzlgnristquzlrcdbxyfm9ro.png" alt="å›¾ç‰‡"><br><br><h2> å¯åŠ¨æ“ä½œç³»ç»Ÿå¹¶å®Œæˆä»»åŠ¡ </h2><br> å¯¹äºCortex M4ï¼Œâ€œæ‰€æœ‰â€æ“ä½œç³»ç»Ÿéƒ½ä½¿ç”¨3ç§ä¸­æ–­ï¼Œå³<i>ç³»ç»Ÿæ»´ç­”è®¡æ—¶å™¨</i> ï¼Œ <i>é€šè¿‡SWIæŒ‡ä»¤è¿›è¡Œç³»ç»ŸæœåŠ¡è°ƒç”¨</i> ï¼Œ <i>å¯¹ç³»ç»ŸæœåŠ¡ä¸­æ–­çš„å¯æŒ‚èµ·è¯·æ±‚</i> ï¼Œè¿™ä¸»è¦æ˜¯ä¸ºRTOSå‘æ˜çš„ã€‚ æŸäº›RTOSä¹Ÿä½¿ç”¨å…¶ä»–ç³»ç»Ÿä¸­æ–­ï¼Œä½†å¯¹äºå¤§å¤šæ•°â€œæ‰€æœ‰â€æ“ä½œç³»ç»Ÿè€Œè¨€ï¼Œè¿™äº›ä¸­æ–­å°±è¶³å¤Ÿäº†ã€‚ å¦‚æœæ²¡æœ‰ï¼Œåˆ™å¯ä»¥æ·»åŠ ï¼Œå› æ­¤åªéœ€ä¸ºè¿™äº›ä¸­æ–­å®šä¹‰ä¸‰ä¸ªå¤„ç†ç¨‹åºå¹¶å¯åŠ¨RTOSï¼Œæˆ‘ä»¬éœ€è¦å¦ä¸€ä¸ªå¯åŠ¨æ–¹æ³•ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">HandleSvcInterrupt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">HandleSvInterrupt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">HandleSysTickInterrupt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Start</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>;</code> </pre><br> æˆ‘æ¢¦andä»¥æ±‚çš„äº‹æƒ…æ˜¯ï¼Œæˆ‘éœ€è¦åšçš„ç¬¬ä¸€ä»¶äº‹æ˜¯æ²¡æœ‰ä»»åŠ¡çš„é€šçŸ¥æœºåˆ¶ã€‚ æˆ‘é€šå¸¸å–œæ¬¢äº‹ä»¶é©±åŠ¨çš„ç¼–ç¨‹ï¼Œå› æ­¤æˆ‘éœ€è¦å¿«é€Ÿå®ç°åŒ…è£…å™¨æ¥é€šçŸ¥ä»»åŠ¡ã€‚ <br><br> äº‹å®è¯æ˜ä¸€åˆ‡éƒ½éå¸¸ç®€å•ï¼Œé™¤äº†<i>uc-OS-II</i>å’Œ<i>III</i>ä¹‹å¤–ï¼Œä»»ä½•æ“ä½œç³»ç»Ÿéƒ½å¯ä»¥åšåˆ°ï¼Œè™½ç„¶æˆ‘å¯èƒ½è¯»å¾—ä¸å¥½ï¼Œä½†æ˜¯æˆ‘è®¤ä¸ºäº‹ä»¶çš„æœºåˆ¶é€šå¸¸å¾ˆæ£˜æ‰‹ï¼Œä½†æ˜¯ï¼Œâ€œæ‰€æœ‰â€éƒ½æ˜¯å‰©ä¸‹çš„ä»–ä»¬å½“ç„¶å¯ä»¥ã€‚ <br><br> ä¸ºäº†é€šçŸ¥ä»»åŠ¡ï¼Œæ‚¨åªéœ€è¦å°†äº‹ä»¶å‘é€åˆ°ä¸æ˜¯ç©ºçš„ï¼Œè€Œæ˜¯å‘é€ç»™ä»»åŠ¡ï¼Œä¸ºæ­¤ï¼Œé€šçŸ¥æ–¹æ³•åº”è¯¥å…·æœ‰æŒ‡å‘ä»»åŠ¡ä¸Šä¸‹æ–‡æˆ–ä»»åŠ¡æ ‡è¯†ç¬¦çš„æŒ‡é’ˆã€‚ æˆ‘åªæ˜¯å°†å®ƒä»¬å­˜å‚¨åœ¨<i>Thread</i>ç±»ä¸­ï¼Œè¿™æ„å‘³ç€Threadç±»ä¹Ÿåº”è¯¥æœ‰ä¸€ä¸ªalertæ–¹æ³•ã€‚ è¿˜åº”è¯¥æœ‰ä¸€ç§ç­‰å¾…è­¦æŠ¥çš„æ–¹æ³•ã€‚ åŒæ—¶ï¼Œæˆ‘ä»¬æ·»åŠ äº†<i>Sleepï¼ˆ..ï¼‰</i>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æš‚åœäº†è°ƒç”¨ä»»åŠ¡çš„æ‰§è¡Œã€‚ ç°åœ¨ä¸¤ä¸ªç±»éƒ½çœ‹èµ·æ¥åƒè¿™æ ·ï¼š <br><br><img src="https://habrastorage.org/webt/ie/r_/35/ier_35fgsut4a_gf_ismmm91tuk.png" alt="å›¾ç‰‡"><br><br><div class="spoiler">  <b class="spoiler_title">rtos.hpp</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/******************************************************************************* * Filename : Rtos.hpp * * Details : Rtos class is used to create tasks, work with special Rtos * functions and also it contains a special static method Run. In this method * the pointer on Thread should be pass. This method is input point as * the task of Rtos. In the body of the method, the method of concrete Thread * will run. *******************************************************************************/</span></span> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifndef</span></span></span><span class="hljs-meta"> __RTOS_HPP #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> __RTOS_HPP #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"thread.hpp"</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// for Thread #include "../../Common/susudefs.hpp" #include "FreeRtos/rtosdefs.hpp" namespace OsWrapper { extern void wCreateThread(Thread &amp;, const char *, ThreadPriority, const tU16, tStack *) ; extern void wStart() ; extern void wHandleSvcInterrupt() ; extern void wHandleSvInterrupt() ; extern void wHandleSysTickInterrupt() ; extern void wEnterCriticalSection(); extern void wLeaveCriticalSection(); class Rtos { public: static void CreateThread(Thread &amp;thread , tStack * pStack = nullptr, const char * pName = nullptr, ThreadPriority prior = ThreadPriority::normal, const tU16 stackDepth = static_cast&lt;tU16&gt;(StackDepth::minimal)) ; static void Start() ; static void HandleSvcInterrupt() ; static void HandleSvInterrupt() ; static void HandleSysTickInterrupt() ; friend void wCreateThread(Thread &amp;, const char *, ThreadPriority, const tU16, tStack *); private: //cstat !MISRAC++2008-7-1-2 To prevent reinterpet_cast in the CreateTask static void Run(void *pContext ) { static_cast&lt;Thread*&gt;(pContext)-&gt;Execute() ; } } ; } ; #endif // __RTOS_HPP</span></span></span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">çº¿ç¨‹</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/******************************************************************************* * Filename : thread.hpp * * Details : Base class for any Taskis which contains the pure virtual * method Execute(). Any active classes which will have a method for running as * a task of RTOS should inherit the Thread and override the Execute() method. * For example: * class MyTask : public OsWrapper::Thread * { * public: * virtual void Execute() override { * while(true) { * //do something.. * } * } ; * *******************************************************************************/</span></span> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifndef</span></span></span><span class="hljs-meta"> __THREAD_HPP #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> __THREAD_HPP #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"FreeRtos/rtosdefs.hpp"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"../../Common/susudefs.hpp"</span></span></span><span class="hljs-meta"> namespace OsWrapper { extern void wSleep(const tTime) ; extern void wSleepUntil(tTime &amp;, const tTime) ; extern tTime wGetTicks() ; extern void wSignal(tTaskHandle const &amp;, const tTaskEventMask) ; extern tTaskEventMask wWaitForSignal(const tTaskEventMask, tTime) ; constexpr tTaskEventMask defaultTaskMaskBits = 0b010101010 ; enum class ThreadPriority { clear = 0, lowest = 10, belowNormal = 20, normal = 30, aboveNormal = 80, highest = 90, priorityMax = 255 } ; enum class StackDepth: tU16 { minimal = 128U, medium = 256U, big = 512U, biggest = 1024U }; class Thread { public: virtual void Execute() = 0 ; inline tTaskHandle GetTaskHanlde() const { return handle; } static void Sleep(const tTime timeOut = 1000ms) { wSleep(timeOut) ; }; inline void Signal(const tTaskEventMask mask = defaultTaskMaskBits) { wSignal(handle, mask); }; inline tTaskEventMask WaitForSignal(tTime timeOut = 1000ms, const tTaskEventMask mask = defaultTaskMaskBits) { return wWaitForSignal(mask, timeOut) ; } friend void wCreateThread(Thread &amp;, const char *, ThreadPriority, const tU16, tStack *); private: tTaskHandle handle ; tTaskContext context ; } ; } ; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// __THREAD_HPP</span></span></span></span></code> </pre><br></div></div><br> æˆ‘å¼€å§‹å®ç°å®ƒï¼Œè¿™é‡Œçš„ç¬¬ä¸€ä¸ªéº»çƒ¦å°±åœ¨ç­‰æˆ‘ï¼Œäº‹å®è¯æ˜ï¼Œâ€œä»»ä½•â€æ“ä½œç³»ç»Ÿéƒ½ä»¥ä¸åŒçš„æ–¹å¼ä»ä¸­æ–­ä¸­è°ƒç”¨å…¶åŠŸèƒ½ã€‚ ä¾‹å¦‚ï¼Œ <i>FreeRTOS</i>å…·æœ‰ç”¨äºä»ä¸­æ–­æ‰§è¡Œå®ƒä»¬çš„å‡½æ•°çš„ç‰¹æ®Šå®ç°ï¼Œä¾‹å¦‚ï¼Œå¦‚æœå­˜åœ¨<i>xTaskNotifyï¼ˆ..ï¼‰</i>å‡½æ•°ï¼Œåˆ™æ— æ³•ä»ä¸­æ–­è°ƒç”¨å®ƒï¼Œä½†éœ€è¦è°ƒç”¨<i>xTaskNotifyFromISRï¼ˆ..ï¼‰</i> ã€‚ <br> å¯¹äº<i>embOSï¼Œ</i>å¦‚æœä»ä¸­æ–­è°ƒç”¨ä»»ä½•å‡½æ•°ï¼Œè¯·åœ¨è¾“å…¥ä¸­æ–­æ—¶ä½¿ç”¨<i>OS_InInterruptï¼ˆï¼‰</i> ï¼Œåœ¨é€€å‡ºæ—¶ä½¿ç”¨<i>OS_LeaveInterruptï¼ˆï¼‰</i> ã€‚ æˆ‘å¿…é¡»åˆ¶ä½œä¸€ä¸ª<i>InterruptEntry</i>ç±»ï¼Œå®ƒåªæœ‰ä¸€ä¸ªæ„é€ å‡½æ•°å’Œä¸€ä¸ªææ„å‡½æ•°ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> OsWrapper { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">wEnterInterrupt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">wLeaveInterrupt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">InterruptEntry</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InterruptEntry</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ wEnterInterrupt() ; } <span class="hljs-keyword"><span class="hljs-keyword">inline</span></span> ~InterruptEntry() { wLeaveInterrupt() ; } } ; } ;</code> </pre> <br> æ‚¨å¯ä»¥åƒè¿™æ ·ä½¿ç”¨å®ƒï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Button::HandleInterrupt() { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> OsWrapper::InterruptEntry ie; EXTI-&gt;PR = EXTI_PR_PR13 ; myDesiredTask.Signal(); } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> myDesiredTask::Execute() { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (WaitForSignal(<span class="hljs-number"><span class="hljs-number">100000</span></span>ms) == defaultTaskMaskBits) { GPIOC-&gt;ODR ^= (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">5</span></span>) ; } } } ;</code> </pre> <br> æ˜¾ç„¶ï¼Œå¯¹äº<i>FreeRTOSï¼Œ</i>æ„é€ å‡½æ•°å’Œææ„å‡½æ•°éƒ½æ˜¯ç©ºçš„ã€‚ ä¸ºäº†è¿›è¡Œé€šçŸ¥ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨<i>xTaskNotifyFromISRï¼ˆ..ï¼‰</i>å‡½æ•°ï¼Œæ— è®ºä»ä½•å¤„è°ƒç”¨å®ƒéƒ½æœ‰ç‚¹<i>éº»çƒ¦</i> ï¼Œä½†æ˜¯ä¸ºäº†é€šç”¨èµ·è§ï¼Œæ‚¨ä¸ä¼šä½¿ç”¨å®ƒã€‚ æ‚¨å½“ç„¶å¯ä»¥åˆ›å»ºç”¨äºä»ä¸­æ–­è¿›è¡Œè°ƒç”¨çš„å•ç‹¬æ–¹æ³•ï¼Œä½†æ˜¯åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘å†³å®šåªè¿›è¡Œé€šç”¨å¤„ç†ã€‚ <br> å…³é”®éƒ¨åˆ†å¯ä»¥å®Œæˆä¸<i>InterruptEntry</i>ç›¸åŒçš„æŠ€å·§ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> OsWrapper{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CriticalSection</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CriticalSection</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ wEnterCriticalSection() ; } <span class="hljs-keyword"><span class="hljs-keyword">inline</span></span> ~CriticalSection() { wLeaveCriticalSection() ; } } ; } ;</code> </pre> <br> ç°åœ¨ï¼Œåªéœ€å°†ä½¿ç”¨<i>FreeRtos</i> APIçš„åŠŸèƒ½å®ç°æ·»åŠ åˆ°æ–‡ä»¶ä¸­ï¼Œç„¶åè¿è¡Œæ£€æŸ¥å³å¯ï¼Œå°½ç®¡æ‚¨æ— æ³•è¿è¡Œå®ƒï¼Œå› æ­¤å¾ˆæ˜æ˜¾å®ƒå¯ä»¥å·¥ä½œ:) <br><div class="spoiler">  <b class="spoiler_title">rtosFreeRtos.cpp</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/******************************************************************************* * Filename : rtosFreeRtos.cpp * * Details : This file containce implementation of functions of concrete * FreeRTOS to support another RTOS create the same file with the * same functions but another name&lt; for example rtosEmbOS.cpp and * implement these functions using EmbOS API. * *******************************************************************************/</span></span> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"../thread.hpp"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"../mutex.hpp"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"../rtos.hpp"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"../../../Common/susudefs.hpp"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"rtosdefs.hpp"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"../event.hpp"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;limits&gt; namespace OsWrapper { /***************************************************************************** * Function Name: wCreateThread * Description: Creates a new task and passes a parameter to the task. The * function should call appropriate RTOS API function to create a task. * * Assumptions: RTOS API create task function should get a parameter to pass the * paramete to task. * Some RTOS does not use pStack pointer so it should be set to nullptr * * Parameters: [in] thread - refernce on Thread object * [in] pName - name of task * [in] prior - task priority * [in] stackDepth - size of Stack * [in] pStack - pointer on task stack * Returns: No ****************************************************************************/ void wCreateThread(Thread &amp; thread, const char * pName, ThreadPriority prior, const tU16 stackDepth, tStack *pStack) { #if (configSUPPORT_STATIC_ALLOCATION == 1) if (pStack != nullptr) { thread.handle = xTaskCreateStatic(static_cast&lt;TaskFunction_t&gt;(Rtos::Run), pName, stackDepth, &amp;thread, static_cast&lt;uint32_t&gt;(prior), pStack, &amp;thread.context); } #else thread.handle = (xTaskCreate(static_cast&lt;TaskFunction_t&gt;(Rtos::Run), pName, stackDepth, &amp;thread, static_cast&lt;uint32_t&gt;(prior), &amp;thread.handle) == pdTRUE) ? thread.handle : nullptr ; #endif } /***************************************************************************** * Function Name: wStart() * Description: Starts the RTOS scheduler * * Assumptions: No * Parameters: No * Returns: No ****************************************************************************/ void wStart() { vTaskStartScheduler() ; } /***************************************************************************** * Function Name: wHandleSvcInterrupt() * Description: Handle of SVC Interrupt. The function should call appropriate * RTOS function to handle the interrupt * * Assumptions: No * Parameters: No * Returns: No ****************************************************************************/ void wHandleSvcInterrupt() { vPortSVCHandler() ; } /***************************************************************************** * Function Name: wHandleSvInterrupt() * Description: Handle of SV Interrupt. The function should call appropriate * RTOS function to handle the interrupt * * Assumptions: No * Parameters: No * Returns: No ****************************************************************************/ void wHandleSvInterrupt() { xPortPendSVHandler() ; } /***************************************************************************** * Function Name: wHandleSysTickInterrupt() * Description: Handle of System Timer Interrupt. The function should call * appropriate RTOS function to handle the interrupt * * Assumptions: No * Parameters: No * Returns: No ****************************************************************************/ void wHandleSysTickInterrupt() { xPortSysTickHandler() ; } /***************************************************************************** * Function Name: wSleep() * Description: Suspends the calling task for a specified period of time, * or waits actively when called from main() * * Assumptions: No * Parameters: [in] timeOut - specifies the time interval in system ticks * Returns: No ****************************************************************************/ void wSleep(const tTime timeOut) { vTaskDelay(timeOut) ; } /***************************************************************************** * Function Name: wEnterCriticalSection() * Description: Basic critical section implementation that works by simply * disabling interrupts * * Assumptions: No * Parameters: No * Returns: No ****************************************************************************/ void wEnterCriticalSection() { taskENTER_CRITICAL() ; } /***************************************************************************** * Function Name: wLeaveCriticalSection() * Description: Leave critical section implementation that works by simply * enabling interrupts * * Assumptions: No * Parameters: No * Returns: No ****************************************************************************/ void wLeaveCriticalSection() { taskEXIT_CRITICAL() ; } /**************************************************************************** * Function Name: wEnterInterrupt() * Description: Some RTOS requires to inform the kernel that interrupt code * is executing * * Assumptions: No * Parameters: No * Returns: No ****************************************************************************/ void wEnterInterrupt() { } /**************************************************************************** * Function Name: wLeaveInterrupt() * Description: Some RTOS requires to inform that the end of the interrupt r * outine has been reached; executes task switching within ISR * * Assumptions: No * Parameters: No * Returns: No ****************************************************************************/ void wLeaveInterrupt() { } /**************************************************************************** * Function Name: wSignal() * Description: Signals event(s) to a specified task * * Assumptions: No * Parameters: [in] taskHandle - Reference to the task structure * [in] mask - The event bit mask containing the event bits, * which shall be signaled. * Returns: No ****************************************************************************/ void wSignal(tTaskHandle const &amp;taskHandle, const tTaskEventMask mask) { BaseType_t xHigherPriorityTaskWoken = pdFALSE ; xTaskNotifyFromISR(taskHandle, mask, eSetBits, &amp;xHigherPriorityTaskWoken) ; portYIELD_FROM_ISR( xHigherPriorityTaskWoken ) ; } /**************************************************************************** * Function Name: wWaitForSignal() * Description: Waits for the specified events for a given time, and clears * the event memory when the function returns * * Assumptions: No * Parameters: [in] mask - The event bit mask containing the event bits, * which shall be waited for * [in] timeOut - Maximum time in system ticks waiting for events * to be signaled. * Returns: Set bits ****************************************************************************/ tTaskEventMask wWaitForSignal(const tTaskEventMask mask, tTime timeOut) { uint32_t ulNotifiedValue = 0U ; xTaskNotifyWait( 0U, std::numeric_limits&lt;uint32_t&gt;::max(), &amp;ulNotifiedValue, timeOut); return (ulNotifiedValue &amp; mask) ; } /**************************************************************************** * Function Name: wCreateEvent() * Description: Create an Event object * * Assumptions: No * Parameters: [in] event - reference on tEvent object * * Returns: Handle of created Event ****************************************************************************/ tEventHandle wCreateEvent(tEvent &amp;event) { #if (configSUPPORT_STATIC_ALLOCATION == 1) return xEventGroupCreateStatic(&amp;event); #else return xEventGroupCreate(); #endif } /**************************************************************************** * Function Name: wDeleteEvent() * Description: Create an Event object * * Assumptions: No * Parameters: [in] eventHandle - reference on tEventHandle object * * Returns: No ****************************************************************************/ void wDeleteEvent(tEventHandle &amp;eventHandle) { vEventGroupDelete(eventHandle); } /**************************************************************************** * Function Name: wSignalEvent() * Description: Sets an resumes tasks which are waiting at the event object * * Assumptions: No * Parameters: [in] event - reference on eventHandle object * [in] mask - The event bit mask containing the event bits, * which shall be signaled * * Returns: No ****************************************************************************/ void wSignalEvent(tEventHandle const &amp;eventHandle, const tEventBits mask) { BaseType_t xHigherPriorityTaskWoken = pdFALSE; xEventGroupSetBitsFromISR(eventHandle, mask, &amp;xHigherPriorityTaskWoken) ; portYIELD_FROM_ISR(xHigherPriorityTaskWoken) ; } /**************************************************************************** * Function Name: wWaitEvent() * Description: Waits for an event and suspends the task for a specified time * or until the event has been signaled. * * Assumptions: No * Parameters: [in] event - Reference on eventHandle object * [in] mask - The event bit mask containing the event bits, * which shall be signaled * [in] timeOut - Maximum time in RTOS system ticks until the * event must be signaled. * [in] mode - Indicate mask bit behaviour * * Returns: Set bits ****************************************************************************/ tEventBits wWaitEvent(tEventHandle const &amp;eventHandle, const tEventBits mask, const tTime timeOut, OsWrapper::EventMode mode) { BaseType_t xWaitForAllBits = pdFALSE ; if (mode == OsWrapper::EventMode::waitAnyBits) { xWaitForAllBits = pdFALSE; } return xEventGroupWaitBits(eventHandle, mask, pdTRUE, xWaitForAllBits, timeOut) ; } /**************************************************************************** * Function Name: wCreateMutex() * Description: Create an mutex. Mutexes are used for managing resources by * avoiding conflicts caused by simultaneous use of a resource. The resource * managed can be of any kind: a part of the program that is not reentrant, a * piece of hardware like the display, a flash prom that can only be written to * by a single task at a time, a motor in a CNC control that can only be * controlled by one task at a time, and a lot more. * * Assumptions: No * Parameters: [in] mutex - Reference on tMutex structure * [in] mode - Indicate mask bit behaviour * * Returns: Mutex handle ****************************************************************************/ tMutexHandle wCreateMutex(tMutex &amp;mutex) { #if (configSUPPORT_STATIC_ALLOCATION == 1) return xSemaphoreCreateMutexStatic(&amp;mutex) ; #else return xSemaphoreCreateMutex(); #endif } /**************************************************************************** * Function Name: wDeleteMutex() * Description: Delete the mutex. * * Assumptions: No * Parameters: [in] mutex - handle of mutex * * Returns: Mutex handle ****************************************************************************/ void wDeleteMutex(tMutexHandle &amp;handle) { vSemaphoreDelete(handle) ; } /**************************************************************************** * Function Name: wLockMutex() * Description: Claim the resource * * Assumptions: No * Parameters: [in] handle - handle of mutex * [in] timeOut - Maximum time until the mutex should be available * * Returns: true if resource has been claimed, false if timeout is expired ****************************************************************************/ bool wLockMutex(tMutexHandle const &amp;handle, tTime timeOut) { return static_cast&lt;bool&gt;(xSemaphoreTake(handle, timeOut)) ; } /**************************************************************************** * Function Name: wUnLockMutex() * Description: Releases a mutex currently in use by a task * * Assumptions: No * Parameters: [in] handle - handle of mutex * * Returns: No ****************************************************************************/ void wUnLockMutex(tMutexHandle const &amp;handle) { BaseType_t xHigherPriorityTaskWoken = pdFALSE ; xSemaphoreGiveFromISR(handle, &amp;xHigherPriorityTaskWoken) ; portYIELD_FROM_ISR( xHigherPriorityTaskWoken ) ; } /**************************************************************************** * Function Name: wSleepUntil() * Description: Suspends the calling task until a specified time, or waits * actively when called from main() * * Assumptions: No * Parameters: [in] last - Refence to a variable that holds the time at which * the task was last unblocked. The variable must be initialised * with the current time prior to its first use * [in] timeOut - Time to delay until, the task will be unblocked * at time * * Returns: No ****************************************************************************/ void wSleepUntil(tTime &amp; last, const tTime timeOut) { vTaskDelayUntil( &amp;last, timeOut) ; } /**************************************************************************** * Function Name: wGetTicks() * Description: Returns the current system time in ticks as a native integer * value * * Assumptions: No * Parameters: No * * Returns: Current system time in ticks ****************************************************************************/ tTime wGetTicks() { return xTaskGetTickCount(); } }</span></span></span></span></code> </pre><br></div></div><br><img src="https://habrastorage.org/webt/4a/sm/mm/4asmmm71hosjm510maad5hcadrm.png" alt="å›¾ç‰‡"><br><br><h2> æˆ‘ä»¬ç»§ç»­å®Œå–„ä»»åŠ¡ </h2><br> ç°åœ¨ï¼Œè¯¥ä»»åŠ¡å‡ ä¹å…·æœ‰æ‚¨æ‰€éœ€çš„ä¸€åˆ‡ï¼Œæˆ‘ä»¬æ·»åŠ äº†Sleepï¼ˆï¼‰æ–¹æ³•ã€‚ æ­¤æ–¹æ³•å°†ä»»åŠ¡æš‚åœæŒ‡å®šçš„æ—¶é—´ã€‚ åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œè¿™å°±è¶³å¤Ÿäº†ï¼Œä½†æ˜¯å¦‚æœæ‚¨éœ€è¦æ˜ç¡®ç¡®å®šçš„æ—¶é—´ï¼Œé‚£ä¹ˆSleepï¼ˆï¼‰å¯èƒ½ä¼šç»™æ‚¨å¸¦æ¥é—®é¢˜ã€‚ ä¾‹å¦‚ï¼Œæ‚¨è¦æ‰§è¡Œä¸€äº›è®¡ç®—å¹¶ä½¿LEDé—ªçƒï¼Œç„¶åæ¯100 msç²¾ç¡®åœ°æ‰§è¡Œä¸€æ¬¡ <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> MyTask::Execute() { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { DoCalculation(); <span class="hljs-comment"><span class="hljs-comment">//It takes about 10ms Led1.Toggle() ; Sleep(100ms) ; } }</span></span></code> </pre><br> è¯¥ä»£ç æ¯110æ¯«ç§’ä½¿LEDé—ªçƒä¸€æ¬¡ã€‚ ä½†æ˜¯ï¼Œæ‚¨å¸Œæœ›æ¯100msä¸€æ¬¡ï¼Œå°±å¯ä»¥ç²—ç•¥è®¡ç®—å‡ºè®¡ç®—æ—¶é—´ï¼Œç„¶åå°†Sleepï¼ˆç¡çœ æ—¶é—´ï¼‰è®¾ç½®ä¸º90msã€‚ ä½†æ˜¯ï¼Œå¦‚æœè®¡ç®—æ—¶é—´å–å†³äºè¾“å…¥å‚æ•°ï¼Œé‚£ä¹ˆé—ªçƒå°†å®Œå…¨æ— æ³•ç¡®å®šã€‚ å¯¹äºâ€œæ‰€æœ‰â€æ“ä½œç³»ç»Ÿä¸­çš„æ­¤ç±»æƒ…å†µï¼Œæœ‰ä¸€äº›ç‰¹æ®Šçš„æ–¹æ³•ï¼Œä¾‹å¦‚DelayUntilï¼ˆï¼‰ã€‚ å®ƒéµå¾ªæ­¤åŸåˆ™-é¦–å…ˆæ‚¨éœ€è¦è®°ä½æ“ä½œç³»ç»Ÿçš„æ»´ç­”è®¡æ•°å™¨çš„å½“å‰å€¼ï¼Œç„¶åå°†æ‚¨éœ€è¦æš‚åœä»»åŠ¡çš„æ»´ç­”æ•°æ·»åŠ åˆ°æ­¤å€¼ï¼Œä¸€æ—¦æ»´ç­”è®¡æ•°å™¨è¾¾åˆ°è¯¥å€¼ï¼Œä»»åŠ¡ä¾¿è¢«è§£é”ã€‚ å› æ­¤ï¼Œæ— è®ºè®¡ç®—æ—¶é—´é•¿çŸ­ï¼Œä»»åŠ¡éƒ½å°†å®Œå…¨é”å®šä¸ºæ‚¨è®¾ç½®çš„å€¼ï¼Œå¹¶ä¸”LEDå°†æ¯100msç²¾ç¡®é—ªçƒä¸€æ¬¡ã€‚ <br> åœ¨ä¸åŒçš„æ“ä½œç³»ç»Ÿä¸­ï¼Œæ­¤æœºåˆ¶çš„å®ç°æ–¹å¼æœ‰æ‰€ä¸åŒï¼Œä½†æ˜¯åªæœ‰ä¸€ç§ç®—æ³•ã€‚ ç»“æœï¼Œä¾‹å¦‚åœ¨FreeRTOSä¸Šå®ç°çš„æœºåˆ¶å°†ç®€åŒ–ä¸ºä¸‹å›¾æ‰€ç¤ºçš„çŠ¶æ€ï¼š <br><br><img src="https://habrastorage.org/webt/tg/n1/hb/tgn1hba-pczt2p5b0dzy0kut-ua.png" alt="å›¾ç‰‡"><br><br> å¦‚æ‚¨æ‰€è§ï¼Œæ“ä½œç³»ç»Ÿçš„æ»´ç­”è®¡æ•°å™¨çš„åˆå§‹çŠ¶æ€çš„è¯»å–å‘ç”Ÿåœ¨è¿›å…¥æ— é™å¾ªç¯ä¹‹å‰ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æƒ³å‡ºä¸€äº›åŠæ³•æ¥å®ç°è¿™ä¸€ç‚¹ã€‚ è®¾è®¡<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ¨¡æ¿</a>å¯ä»¥è§£å†³ã€‚    ,         ,    ,      ,      Execute(),     , ..    .     ,        (   ),      . <br><br><pre> <code class="cpp hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Thread</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-number"><span class="hljs-number">0</span></span> ; <span class="hljs-keyword"><span class="hljs-keyword">friend</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Rtos</span></span></span><span class="hljs-class"> ;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ lastWakeTime = wGetTicks() ; Execute(); } ... tTime lastWakeTime = <span class="hljs-number"><span class="hljs-number">0</span></span>ms ; ... }</code> </pre> <br>     Run  Rtos,      Execute(),   Run()  Thread.      Rtos ,       Run()   Thread. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *pContext )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;Thread*&gt;(pContext)-&gt;Run() ; }</code> </pre><br>     <i>SleepUntil()</i> ,          .  ,           ,         ,     <i>SleepUntil()</i> ,        .        : <br><img src="https://habrastorage.org/webt/aw/nx/ts/awnxtsvd-odgyfaagkl3egc_tvs.png" alt="image"><br><br><div class="spoiler"> <b class="spoiler_title">thread.hpp</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/******************************************************************************* * Filename : thread.hpp * * Details : Base class for any Taskis which contains the pure virtual * method Execute(). Any active classes which will have a method for running as * a task of RTOS should inherit the Thread and override the Execute() method. * For example: * class MyTask : public OsWrapper::Thread * { * public: * virtual void Execute() override { * while(true) { * //do something.. * } * } ; * * Author : Sergey Kolody *******************************************************************************/</span></span> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifndef</span></span></span><span class="hljs-meta"> __THREAD_HPP #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> __THREAD_HPP #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"FreeRtos/rtosdefs.hpp"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"../../Common/susudefs.hpp"</span></span></span><span class="hljs-meta"> namespace OsWrapper { extern void wSleep(const tTime) ; extern void wSleepUntil(tTime &amp;, const tTime) ; extern tTime wGetTicks() ; extern void wSignal(tTaskHandle const &amp;, const tTaskEventMask) ; extern tTaskEventMask wWaitForSignal(const tTaskEventMask, tTime) ; constexpr tTaskEventMask defaultTaskMaskBits = 0b010101010 ; enum class ThreadPriority { clear = 0, lowest = 10, belowNormal = 20, normal = 30, aboveNormal = 80, highest = 90, priorityMax = 255 } ; enum class StackDepth: tU16 { minimal = 128U, medium = 256U, big = 512U, biggest = 1024U }; class Thread { public: virtual void Execute() = 0 ; inline tTaskHandle GetTaskHanlde() const { return handle; } static void Sleep(const tTime timeOut = 1000ms) { wSleep(timeOut) ; }; void SleepUntil(const tTime timeOut = 1000ms) { wSleepUntil(lastWakeTime, timeOut); }; inline void Signal(const tTaskEventMask mask = defaultTaskMaskBits) { wSignal(handle, mask); }; inline tTaskEventMask WaitForSignal(tTime timeOut = 1000ms, const tTaskEventMask mask = defaultTaskMaskBits) { return wWaitForSignal(mask, timeOut) ; } friend void wCreateThread(Thread &amp;, const char *, ThreadPriority, const tU16, tStack *); friend class Rtos ; private: tTaskHandle handle ; tTaskContext context ; tTime lastWakeTime = 0ms ; void Run() { lastWakeTime = wGetTicks() ; Execute(); } } ; } ; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// __THREAD_HPP</span></span></span></span></code> </pre><br></div></div><br><div class="spoiler"> <b class="spoiler_title">rtos.hpp</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/******************************************************************************* * Filename : Rtos.hpp * * Details : Rtos class is used to create tasks, work with special Rtos * functions and also it contains a special static method Run. In this method * the pointer on Thread should be pass. This method is input point as * the task of Rtos. In the body of the method, the method of concrete Thread * will run. *******************************************************************************/</span></span> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifndef</span></span></span><span class="hljs-meta"> __RTOS_HPP #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> __RTOS_HPP #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"thread.hpp"</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// for Thread #include "../../Common/susudefs.hpp" #include "FreeRtos/rtosdefs.hpp" namespace OsWrapper { extern void wCreateThread(Thread &amp;, const char *, ThreadPriority, const tU16, tStack *) ; extern void wStart() ; extern void wHandleSvcInterrupt() ; extern void wHandleSvInterrupt() ; extern void wHandleSysTickInterrupt() ; extern void wEnterCriticalSection(); extern void wLeaveCriticalSection(); class Rtos { public: static void CreateThread(Thread &amp;thread , tStack * pStack = nullptr, const char * pName = nullptr, ThreadPriority prior = ThreadPriority::normal, const tU16 stackDepth = static_cast&lt;tU16&gt;(StackDepth::minimal)) ; static void Start() ; static void HandleSvcInterrupt() ; static void HandleSvInterrupt() ; static void HandleSysTickInterrupt() ; friend void wCreateThread(Thread &amp;, const char *, ThreadPriority, const tU16, tStack *); friend class Thread ; private: //cstat !MISRAC++2008-7-1-2 To prevent reinterpet_cast in the CreateTask static void Run(void *pContext ) { static_cast&lt;Thread*&gt;(pContext)-&gt;Run() ; } } ; } ; #endif // __RTOS_HPP</span></span></span></span></code> </pre><br></div></div><br><br><h2>  </h2><br>  , ,    ,    ,      ,   ,     .  ,     . <br><br>         ,     ,        ,    ,     ,         ,     ,             . ,          .      ,      ,     ,            ,        . <br><br><img src="https://habrastorage.org/webt/gv/na/8k/gvna8ktlrzvrposxbpwhzpn0keq.png"><br><br>    : <br><br><pre> <code class="cpp hljs">OsWrapper::Event event{<span class="hljs-number"><span class="hljs-number">10000</span></span>ms, <span class="hljs-number"><span class="hljs-number">3</span></span>}; <span class="hljs-comment"><span class="hljs-comment">//  ,    10000ms,    0    1. void SomeTask::Execute() { while(true) { using OsWrapper::operator""ms ; Sleep(1000ms); event.Signal() ; //      0   1. Sleep(1000ms); event.SetMaskBits(4) //    2. event.Signal() ; //      2. } } ; void AnotherTask::Execute() { while(true) { using namespace::OsWrapper ; //,      ,    10000ms if ((event.Wait() &amp; defaultTaskMaskBits) != 0) { GPIOC-&gt;ODR ^= (1 &lt;&lt; 5) ; } } } ;</span></span></code> </pre><br><br><h2> ,    </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æœ€åˆï¼Œå½“æˆ‘å†™è¿™ç¯‡æ–‡ç« æ—¶ï¼Œæˆ‘è¿˜æ²¡æœ‰å®ç°å®ƒä»¬ï¼Œä½†æ˜¯æ­£å¦‚æˆ‘ä¿è¯æˆ‘ä¼šå¼€å‘äº’æ–¥é”å’Œç”µå­é‚®ä»¶æ¡†ä¸€æ ·ï¼Œæºä»£ç åœ¨è¿™é‡Œï¼š</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHub OsWrapper</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">ä½¿ç”¨é‚®ç®±çš„ç¤ºä¾‹å¦‚ä¸‹ï¼š</font></font><br><pre> <code class="cpp hljs">OsWrapper::MailBox&lt;tU32, <span class="hljs-number"><span class="hljs-number">10</span></span>&gt; <span class="hljs-built_in"><span class="hljs-built_in">queue</span></span>; <span class="hljs-comment"><span class="hljs-comment">//    10   int void ReceiveTask::Execute() { tU32 item; while(true) { using OsWrapper::operator""ms ; if (queue.Get(item, 10000ms)) { //    GPIOC-&gt;ODR ^= (1 &lt;&lt; 9); } } } ; void SendTask::Execute() { tU32 item = 0U; while(true) { queue.Put(item); item ++; SleepUntil(1000ms); } } ;</span></span></code> </pre><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> å¦‚ä½•ä½¿ç”¨è¿™ä¸€åˆ‡ </font></font></h2><br>  ,       ,     ,   :  <i>LedTask</i> ,     2  ,    2     <i>myTask</i> ,   10  ,    ,    .          2 .      ,     <i>event</i> .      ,     :) <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> OsWrapper::<span class="hljs-keyword"><span class="hljs-keyword">operator</span></span><span class="hljs-string"><span class="hljs-string">""</span></span>ms ; OsWrapper::Event event{<span class="hljs-number"><span class="hljs-number">10000</span></span>ms, <span class="hljs-number"><span class="hljs-number">1</span></span>}; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyTask</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> OsWrapper::Thread { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> override </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (event.Wait() != <span class="hljs-number"><span class="hljs-number">0</span></span>) { GPIOC-&gt;ODR ^= (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">9</span></span>); } } } <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> tMyTaskStack = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">array</span></span>&lt;OsWrapper::tStack, <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;tU16&gt;(OsWrapper::StackDepth::minimal)&gt; ; <span class="hljs-keyword"><span class="hljs-keyword">inline</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> tMyTaskStack Stack; <span class="hljs-comment"><span class="hljs-comment">//C++17   IAR 8.30 } ; class LedTask : public OsWrapper::Thread { public: virtual void Execute() override { while(true) { GPIOC-&gt;ODR ^= (1 &lt;&lt; 5) ; using OsWrapper::operator""ms ; SleepUntil(2000ms); event.Signal() ; } } using tLedStack = std::array&lt;OsWrapper::tStack, static_cast&lt;tU16&gt;(OsWrapper::StackDepth::minimal)&gt; ; inline static tLedStack Stack; //C++17   IAR 8.30 } ; MyTask myTask; LedTask ledTask; int main() { using namespace OsWrapper ; Rtos::CreateThread(myTask, MyTask::Stack.data(), "myTask", ThreadPriority::lowest, MyTask::Stack.size()) ; Rtos::CreateThread(ledTask, LedTask::Stack.data()) ; Rtos::Start(); return 0; }</span></span></code> </pre> <br><br><h2> ç»“è®º </h2><br>           . ,    ++           ++ .          ++. <br>         ,   ++, ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><b> </b></a> ,      ,    ,         ,    ,    .         ,       . <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä½†æ˜¯ä¸æ­¤åŒæ—¶ï¼Œæˆ‘ä»¬å¤§å¤šæ•°äººéƒ½ä½¿ç”¨ä¼ ç»Ÿçš„Sishnaæ“ä½œç³»ç»Ÿï¼Œæ‚¨å¯ä»¥å°†åŒ…è£…å™¨ä½œä¸ºä½¿ç”¨C ++è¿‡æ¸¡åˆ°ç¾å¥½æœªæ¥çš„æœ€åˆèµ·ç‚¹ï¼šï¼‰</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æˆ‘åœ¨</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">Clionä¸­</font></a><font style="vertical-align: inherit;">æ•´ç†äº†ä¸€ä¸ªå°å‹æµ‹è¯•é¡¹ç›®</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"></font></a> .     ,           ,      IAR toolchain,   ,  ,   elf ,   hex , ,      GDB.     â€”   ,     ,      ,    2 ,      ,   ,    ,      .     ,     Clion.     ,   IAR toolchain ,  . <br><br>      IAR       8.30.1,        .   : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">XNUCLEO-F411RE</a> ,  ST-Link.   ,  ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Clion</a> â€”   ,    :) <br><br><img src="https://habrastorage.org/webt/tx/m_/e8/txm_e8pms1viazgy6cypd-kjj3q.png" alt="image"><br><br>   <i>IAR</i>    : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">  IAR 8.30.1</a>    ,    ,      github,   ,        ,               FreeRtos. <br><br> ..      GitHub <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="> </a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN420467/">https://habr.com/ru/post/zh-CN420467/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN420457/index.html">Simplify3D 3Dæ‰“å°è½¯ä»¶æ¦‚è¿°</a></li>
<li><a href="../zh-CN420459/index.html">ä¸Šéƒ¨å·¥å…·æ ä¸­å¸¦æœ‰è®¡æ•°å™¨çš„å›¾æ ‡ï¼šä¸€é¡¹ä»»åŠ¡çš„å¤šç§æ–¹æ³•çš„ç¤ºä¾‹</a></li>
<li><a href="../zh-CN420461/index.html">åè®¾è®¡å¸ˆçš„åå¥åè¨€</a></li>
<li><a href="../zh-CN420463/index.html">ICOå€¼å¾—ä¸‹é™ï¼Œä½†å®ƒä»¬æœ‰æœºä¼šæ”¹å˜</a></li>
<li><a href="../zh-CN420465/index.html">ä½¿ç”¨njsçš„Nginxå˜é‡ï¼šç®€å•ï¼Œè½»æ¾ä¸”é€šè¿‡JavaScript</a></li>
<li><a href="../zh-CN420469/index.html">åœ¨åŒå­¦ç¤ºä¾‹ä¸­ä½¿ç”¨Druidçš„åŠŸèƒ½</a></li>
<li><a href="../zh-CN420471/index.html">Pleskçš„ä¸‰ç¯‡RIT 2018æŠ€æœ¯æŠ¥å‘Š</a></li>
<li><a href="../zh-CN420473/index.html">é¢å‘æ–°ä»»é«˜ç®¡çš„ä¹¦ç±ï¼Œæˆ–è€…ä¸ºä»€ä¹ˆé˜…è¯»å¦‚æ­¤é‡è¦</a></li>
<li><a href="../zh-CN420475/index.html">Raylogic 11Gå’ŒRaylogic V12æ¿€å…‰åˆ‡å‰²æœºçš„æ¯”è¾ƒ</a></li>
<li><a href="../zh-CN420477/index.html">HyperX Cloud Stinger Coreè¯„æµ‹ï¼šè½»å·§è€ç”¨çš„è§’è‰²è€³æœº</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>