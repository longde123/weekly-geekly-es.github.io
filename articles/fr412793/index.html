<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üö≠ üñïüèº ‚úçüèΩ MassTransit, Saga et RabbitMQ pour l'impl√©mentation d'un gestionnaire de processus üèë üòô üõÄ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Une fois, nous avons √©t√© confront√©s √† la t√¢che d'automatiser divers flux de travail dans une grande entreprise. Pour nous, cela signifiait constituer ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>MassTransit, Saga et RabbitMQ pour l'impl√©mentation d'un gestionnaire de processus</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/true_engineering/blog/412793/"><p>  Une fois, nous avons √©t√© confront√©s √† la t√¢che d'automatiser divers flux de travail dans une grande entreprise.  Pour nous, cela signifiait constituer une dizaine de syst√®mes au moment du lancement.  De plus, tout devait √™tre connect√© de mani√®re asynchrone, √©volutive et fiable. </p><br><p>  Un processus simplifi√© peut √™tre d√©crit comme une s√©quence d'actions dans diff√©rents syst√®mes, qui ne peut pas √™tre enti√®rement automatis√©, car il n√©cessite la participation humaine.  Par exemple, pour s√©lectionner certaines actions ou coordination √©l√©mentaire, ce qui est n√©cessaire pour passer √† l'√©tape suivante du processus. </p><br><p>  Pour r√©soudre ce probl√®me, nous avons d√©cid√© d'utiliser l'architecture de messagerie via le bus de donn√©es, et MassTransit avec sa Saga en collaboration avec RabbitMQ nous convenait parfaitement. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/8f9/896/b2a/8f9896b2aade49a732cf10b63b8276ec.jpg" alt="image"><a name="habracut"></a></p><h2>  √Ä quoi ressemble Saga? </h2><br>  Saga est une impl√©mentation du mod√®le Process Manager du livre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Enterprise Application Integration Templates</a> , qui vous permet de d√©crire un processus comme une machine √† √©tats.  Un √©v√©nement arrive √† l'entr√©e, Saga effectue une s√©quence d'actions.  Dans le m√™me temps, √† n'importe quel stade de la saga, la d√©cision d'une personne peut √™tre requise.  Elle cr√©e ensuite une t√¢che dans le tracker et ¬´s'endort¬ª pendant une dur√©e ind√©termin√©e, en attendant de nouveaux √©v√©nements. <br><p>  Saga est bas√©e sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Automatonymous</a> .  Il est d√©crit de mani√®re d√©clarative dans une classe h√©rit√©e de MassTransitStateMachine &lt;&gt;.  Pour Saga, vous devez d√©crire tous les √©tats, √©v√©nements pris et actions prises lorsque certains √©v√©nements se produisent.  L'√©tat actuel est stock√© dans la base de donn√©es. </p><br><p>  Tout d'abord, nous d√©crivons tous les √©tats et √©v√©nements de Saga et leur donnons des noms compr√©hensibles.  Cela ressemble √† ceci: </p><br><pre><code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">StateMachine</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> State AwaitingTaskCreated { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> State AwaitingTaskTakedToWork { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> State AwaitingDecisionAboutTask { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> State Rejected { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Event&lt;IStartWorkflowCommand&gt; StartWorkflowCommandReceived { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Event&lt;TaskCreatedNotification&gt; TaskCreated { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Event&lt;TaskTakedToWorkNotification&gt; TaskTakedToWork { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Event&lt;TaskDeclinedNotification&gt; TaskDeclined { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Event&lt;TaskApprovedNotification&gt; TaskApproved { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BuildStateMachine</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { InstanceState(x =&gt; x.CurrentState); Event(() =&gt; StartWorkflowCommandReceived, x =&gt; x.CorrelateById(ctx =&gt; ctx.Message.CorrelationId) .SelectId(context =&gt; context.Message.CorrelationId)); Event(() =&gt; TaskCreated, x =&gt; x.CorrelateById(ctx =&gt; ctx.Message.CorrelationId)); Event(() =&gt; TaskTakedToWork, x =&gt; x.CorrelateById(ctx =&gt; ctx.Message.CorrelationId)); Event(() =&gt; TaskDeclined, x =&gt; x.CorrelateById(ctx =&gt; ctx.Message.CorrelationId)); Event(() =&gt; TaskApproved, x =&gt; x.CorrelateById(ctx =&gt; ctx.Message.CorrelationId)); } }</code> </pre> <br><p>  Nous avons lanc√© une classe partielle, o√π nous d√©clarons une liste de tous les √©tats et √©v√©nements, et la m√©thode BuildStateMachine, qui d√©crit la corr√©lation des √©v√©nements avec Saga.  Pour ce faire, un param√®tre sp√©cial CorrelationId est transmis dans chaque √©v√©nement - il s'agit de Guid, qui s'ex√©cute entre tous les syst√®mes connect√©s et dans les syst√®mes de surveillance. </p><br><p>  Ainsi, si des probl√®mes surviennent, nous pouvons restaurer l'image compl√®te de ce qui se passe avec les journaux de tous les syst√®mes connect√©s.  Nous envoyons CorrelationId dans les messages de Saga, les syst√®mes le renvoient dans les notifications afin que nous puissions corr√©ler le message avec une Saga sp√©cifique. </p><br><p>  Voici un exemple de la classe de machine d'√©tat elle-m√™me: </p><br><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> sealed partial <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> StateMachine : MassTransitStateMachine&lt;WorkflowSaga&gt; { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> StateMachine() { BuildStateMachine(); <span class="hljs-keyword"><span class="hljs-keyword">Initially</span></span>(WhenStartWorkflowCommandReceived()); During(AwaitingTaskCreatedInPlanner, WhenTaskCreated()); During(AwaitingTaskTakedToWork, WhenTaskTakedToWork()); During(AwaitingDecisionAboutTask, WhenTaskApproved(), WhenTaskDeclined()); } private EventActivityBinder&lt;WorkflowSaga, IStartWorkflowCommand&gt; WhenStartWorkflowCommandReceived() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">When</span></span>(StartWorkflowCommandReceived) .<span class="hljs-keyword"><span class="hljs-keyword">Then</span></span>(ctx =&gt; ctx.Instance.SaveConfigurationRequestInfo(ctx.Data)) .Send(TaskManagerQueue, ctx =&gt; <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CreateTaskCommand(ctx.Instance)) .TransitionTo(AwaitingTaskCreated); } private EventActivityBinder&lt;WorkflowSaga, TaskCreatedNotification&gt; WhenTaskCreated() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">When</span></span>(DPORPApproveTaskCreatedInPlanner) .<span class="hljs-keyword"><span class="hljs-keyword">Then</span></span>(ctx =&gt; ctx.Instance.SaveCreatedTaskInfo(ctx.Data)) .Send(MailServiceQueue, ctx =&gt; <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> NotifyRequestAuthorThatWorkflowStarted(ctx.Instance)) .TransitionTo(AwaitingTaskTakedToWork); } private EventActivityBinder&lt;WorkflowSaga, TaskTakedToWorkNotification&gt; WhenTaskTakedToWork() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">When</span></span>(TaskTakedToWork) .<span class="hljs-keyword"><span class="hljs-keyword">Then</span></span>(ctx =&gt; ctx.Instance.MarkTaskAsTakedToWork(ctx.Data)) .TransitionTo(AwaitingDecisionAboutTask); } private EventActivityBinder&lt;WorkflowSaga, TaskApprovedNotification&gt; WhenTaskApproved() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">When</span></span>(TaskApproved) .<span class="hljs-keyword"><span class="hljs-keyword">Then</span></span>(ctx =&gt; ctx.Instance.MarkTaskAsApproved(ctx.Data)) .Finalize(); } private EventActivityBinder&lt;WorkflowSaga, TaskDeclinedNotification&gt; WhenTaskDeclined() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">When</span></span>(TaskDeclined) .<span class="hljs-keyword"><span class="hljs-keyword">Then</span></span>(ctx =&gt; ctx.Instance.MarkTaskAsDeclined(ctx.Data)) .TransitionTo(Rejected); } }</code> </pre><br><p>  Le constructeur d√©crit les √©tats.  La r√©ception de chaque √©v√©nement se fait selon une m√©thode distincte afin de maintenir la lisibilit√©.  Toute la logique de construction des messages s'effectue dans les messages eux-m√™mes, sinon, avec la complexit√© croissante du syst√®me, Saga se gonfle assez rapidement. </p><br><p>  Il faut veiller √† √©laborer des conventions et √† maintenir la lisibilit√©.  En raison de l'imp√©rativit√© de C #, il est tr√®s difficile de d√©clarer une description des √©tats et des actions qu'il contient.  M√™me pour les machines √† √©tats simples, le v√©ritable enfer commence. </p><br><p>  Maintenant, quelques mots sur SagaInstance.  SagaInstance est une classe h√©rit√©e de SagaStateMachineInstance.  Il se compose d'objets et de champs qui caract√©risent la machine √† √©tats.  En gros, c'est le souvenir de Saga.  Nous stockons toutes les donn√©es Saga dont elle aura besoin tout au long de sa vie.  Dans cette classe est √©galement d√©crite la logique des modifications de ces donn√©es au cours du travail. </p><br><p>  Voici un exemple: </p><br><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> WorkflowSaga : SagaStateMachineInstance , ISagaWithState , ICreatedOnOffset , IModifiedOnOffset , ICreatedBy&lt;string&gt; , IModifiedBy&lt;string&gt; { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Guid CorrelationId { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string CurrentState { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string InitialRequestViewUrl { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string RequestNumber { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string RequestAuthor { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string RequestText { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> byte[] RowVersion { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string CreatedBy { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string ModifiedBy { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> DateTimeOffset CreatedOn { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> DateTimeOffset ModifiedOn { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> DateTimeOffset CompletedOn { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> virtual ICollection&lt;RelatedTask&gt; RelatedTasks { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> SaveGabrielConfigurationRequestInfo( ICreateGabrielConfigurationRequestCommand command) { CorrelationId = command.CorrelationId; RequestNumber = command.RequestNumber; RequestAuthor = command.Author; RequestText = command.RequestText; InitialRequestViewUrl = command.InitialRequestViewUrl; CreatedOn = RuntimeContext.<span class="hljs-keyword"><span class="hljs-keyword">Current</span></span>.DateTimeOffset.Now; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> SaveCreatedTaskInfo(ITaskCreationInfo taskCreationInfo) { RelatedPlannerTasks.<span class="hljs-keyword"><span class="hljs-keyword">Add</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> RelatedPlannerTask(taskCreationInfo)); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> MarkTaskAsTakedToWork(ITaskUpdatedInfo taskInfo) { UpdateTaskInfo(taskInfo, TaskStatus.TakedToWork); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> MarkTaskAsApproved(TaskApprovedNotification taskInfo) { UpdateTaskInfo(taskInfo, TaskStatus.Completed, taskInfo.<span class="hljs-keyword"><span class="hljs-keyword">Comment</span></span>); CompletedOn = RuntimeContext.<span class="hljs-keyword"><span class="hljs-keyword">Current</span></span>.DateTimeOffset.Now; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> MarkTaskAsDeclined(TaskDeclinedNotification taskInfo) { UpdateTaskInfo(taskInfo, TaskStatus.Declined, taskInfo.<span class="hljs-keyword"><span class="hljs-keyword">Comment</span></span>); CompletedOn = RuntimeContext.<span class="hljs-keyword"><span class="hljs-keyword">Current</span></span>.DateTimeOffset.Now; } private <span class="hljs-type"><span class="hljs-type">void</span></span> UpdateTaskInfo(ITaskUpdatedInfo taskInfo, TaskStatus taskStatus, string <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { var task = RelatedTasks.Single(t =&gt; t.Number == taskInfo.Number); task.ModifiedBy = taskInfo.TaskModifiedBy; task.<span class="hljs-keyword"><span class="hljs-keyword">Comment</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>; task.Status = taskStatus; } }</code> </pre><br><p>  Un exemple montre que dans SagaInstance CorrelationId est stock√© pour la corr√©lation des √©v√©nements avec Saga et CurrentState pour stocker l'√©tat actuel de Saga. </p><br><h2>  Gestion des erreurs </h2><br><p>  Qu'arrive-t-il √† Saga si une erreur se produit pendant le traitement des messages?  Il s'agit d'un probl√®me important, car tout le monde veut que la machine d'√©tat reste toujours coh√©rente, m√™me en cas de probl√®me.  Et avec MassTransit, Saga se porte bien. </p><br><p>  Comme vous l'avez d√©j√† remarqu√©, dans les exemples ci-dessus, il n'y a pas un seul bloc try catch pour g√©rer les exceptions.  La raison est simple: ils n'y sont pas n√©cessaires.  Si une exception se produit pendant le traitement du message, le message est renvoy√© dans la file d'attente et toutes les modifications sont annul√©es.  √âtant donn√© que nous effectuons toutes les manipulations de donn√©es dans la m√™me transaction que Saga, la transaction ne sera pas cl√¥tur√©e. </p><br><p>  En g√©n√©ral, la manipulation de quelque chose d'autre que Saga dans Saga elle-m√™me est une mauvaise pratique.  Selon le livre ¬´Mod√®les d'int√©gration pour les applications d'entreprise¬ª, le gestionnaire de processus devrait rester aussi mince et stupide que possible: il suffit de donner des commandes aux syst√®mes et de surveiller l'√©tat, mais lui-m√™me ne devrait rien faire. </p><br><p>  Bien s√ªr, il existe des sc√©narios plus complexes lorsque vous devez effectuer certaines actions de compensation pour g√©rer les exceptions.  Ensuite, le gestionnaire de machine d'√©tat ¬´.Catch¬ª est utilis√© pour intercepter une exception d'un certain type, puis ex√©cuter la logique de compensation. </p><br><p>  Et si vous avez juste besoin d'annoncer une exception, il est pr√©f√©rable d'utiliser un observateur (Observer). </p><br><p>  Imaginez maintenant la situation dans laquelle nous avons d√©j√† ex√©cut√© la commande Envoyer pendant le traitement des messages, apr√®s quoi une exception s'est produite.  Qu'adviendra-t-il de la commande envoy√©e √† cette √©tape?  Apr√®s tout, tout ce qui s'est envol√© ne peut pas √™tre retourn√©?  Mais ici tout est pens√©. </p><br><p>  Lors de la configuration du bus, vous pouvez activer l'option UseInMemoryOutbox.  Cette option vous permet de ne pas envoyer de messages tant que l'√©tape en cours n'est pas termin√©e.  Si une exception se produit, les messages ne seront pas envoy√©s du tout.  Voici un extrait de la documentation: </p><br><pre> <code class="hljs pgsql">/// &lt;<span class="hljs-keyword"><span class="hljs-keyword">summary</span></span>&gt; /// Includes an outbox <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the consume <span class="hljs-keyword"><span class="hljs-keyword">filter</span></span> <span class="hljs-type"><span class="hljs-type">path</span></span>, which delays outgoing messages <span class="hljs-keyword"><span class="hljs-keyword">until</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-type"><span class="hljs-type">path</span></span> /// <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> the pipeline <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> the outbox <span class="hljs-keyword"><span class="hljs-keyword">filter</span></span>. At this <span class="hljs-type"><span class="hljs-type">point</span></span>, the message execution pipeline should be /// nearly complete <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-keyword"><span class="hljs-keyword">only</span></span> the ack remaining. <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> an <span class="hljs-keyword"><span class="hljs-keyword">exception</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> thrown, the messages are <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> sent/published. /// &lt;/<span class="hljs-keyword"><span class="hljs-keyword">summary</span></span>&gt; /// &lt;param <span class="hljs-type"><span class="hljs-type">name</span></span>="configurator"&gt;The pipe configurator&lt;/param&gt; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static <span class="hljs-type"><span class="hljs-type">void</span></span> UseInMemoryOutbox(this IConsumePipeConfigurator configurator)</code> </pre> <br><h2>  Les tests </h2><br><p>  √Ä premi√®re vue, tester une machine √† √©tats asynchrone est toujours un plaisir.  Mais ici, tout va bien.  MassTransit fournit un bon cadre d'√©criture de test qui r√©pond pleinement √† tous nos besoins pour tester une machine d'√©tat. </p><br><p>  Le cadre fournit √† InMemory une impl√©mentation du bus de donn√©es (InMemoryTestHarness), qui vous permet d'envoyer et de recevoir des messages en contournant RabbitMQ ou une autre file d'attente. </p><br><p>  Eh bien, √† titre d'exemple: </p><br><pre> <code class="hljs pgsql">[TestFixture] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> SagaTests : TestFixtureBase { protected const string HostName = "HostName"; protected InMemoryTestHarness Harness; protected StateMachine StateMachine; protected StateMachineSagaTestHarness&lt;GabrielConfigurationRequestSaga, StateMachine&gt; Saga; [SetUp] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> SetUp() { StateMachine = (StateMachine)Kernel. <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>&lt;MassTransitStateMachine&lt;WorkflowSaga&gt;&gt;(); Harness = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> InMemoryTestHarness(HostName); Saga = Harness .StateMachineSaga&lt;WorkflowSaga, StateMachine&gt;(StateMachine); } [TearDown] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task TearDown() { await Harness.Stop(); } protected async Task&lt;WorkflowSaga&gt; InitializeSaga() { await Harness.<span class="hljs-keyword"><span class="hljs-keyword">Start</span></span>(); var command = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> TestStartWorkflowCommand { CorrelationId = SagaId, Author = RequestAuthor, InitialRequestViewUrl = InitialRequestViewUrl, RequestText = RequestText, RequestNumber = RequestNumber, }; await Harness.InputQueueSendEndpoint .Send&lt;IStartWorkflowCommand&gt;(command); //    ,  consume    , // ,  Saga  ,    <span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>.IsTrue(Harness.Consumed .<span class="hljs-keyword"><span class="hljs-keyword">Select</span></span>&lt;IStartWorkflowCommand&gt;().<span class="hljs-keyword"><span class="hljs-keyword">Any</span></span>()); var currentSaga = Saga.Created.Contains(SagaId); currentSaga.RelatedPlannerTasks = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> List&lt;RelatedPlannerTask&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSaga; } [Test] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task CheckCurrntStateWhenStartWorkflowCommand() { var saga = await InitializeSaga(); <span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>.IsNotNull(saga); <span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>.AreEqual(StateMachine .AwaitingORDTApproveTaskCreatedInPlanner.Name, saga.CurrentState); } } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> WhenTaskCreated : SagaTestsBase { private async Task&lt;WorkflowSaga&gt; InitializeState() { var saga = await InitializeSaga(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); saga.CurrentState = StateMachine.AwaitingTaskCreated.Name; InitializeRelatedTask(saga); await SendTaskCreatedNotification(); <span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>.IsTrue(Harness.Consumed .<span class="hljs-keyword"><span class="hljs-keyword">Select</span></span>&lt;TaskCreatedNotification&gt;().<span class="hljs-keyword"><span class="hljs-keyword">Any</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> saga; } [Test] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task SaveWorkflowDataWhenTaskCreated() { var saga = await InitializeState(); var taskInfo = saga.RelatedPlannerTasks .First(task =&gt; task.PlannerTaskType == PlannerTaskType.DPORPApprove); <span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>.AreEqual(TaskNumber, taskInfo.Number); <span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>.AreEqual(TaskUrl, taskInfo.TaskUrl); <span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>.AreEqual(SagaId, taskInfo.SagaCorrelationId); <span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>.AreEqual(TaskStatus.Created, taskInfo.Status); <span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>.AreEqual(<span class="hljs-keyword"><span class="hljs-keyword">User</span></span>, taskInfo.ModifiedBy); <span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>.AreEqual(saga.CurrentState, StateMachine.AwaitingTaskTakedToWork.Name); } [Test] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> async Task SendsMailWhenTaskCreated() { var mailConsumer = Harness .Consumer&lt;MockConsumer&lt;ISendEmailMessageWithTemplateCommand&gt;&gt; (RabbitMqRouting.QueueNames .SendEmailsQueueName); await InitializeState(); <span class="hljs-keyword"><span class="hljs-keyword">Assert</span></span>.IsTrue(mailConsumer.Consumed .<span class="hljs-keyword"><span class="hljs-keyword">Select</span></span>&lt;ISendEmailMessageWithTemplateCommand&gt;().<span class="hljs-keyword"><span class="hljs-keyword">Any</span></span>()); } private async Task SendTaskCreatedNotification() { await Harness.InputQueueSendEndpoint .Send(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> TaskCreatedNotification { TaskUrl = TaskUrl, Number = TaskNumber, TaskModifiedBy = <span class="hljs-keyword"><span class="hljs-keyword">User</span></span>, CorrelationId = SagaId }); } }</code> </pre><br><p>  Les tests se d√©roulent assez rapidement.  Par exemple, sur l'ordinateur d'un seul d√©veloppeur, 850 tests s'ex√©cutent en 21 secondes environ. </p><br><h2>  Conseils utiles </h2><br><p>  En conclusion, nous donnons une liste de conseils utiles bas√©s sur notre exp√©rience. </p><br><ol><li><p>  Les contrats et les syst√®mes de communication par bus sont mieux plac√©s dans une p√©pite priv√©e.  Ainsi, vous n'aurez pas de diff√©rences de noms du c√¥t√© de l'envoi et du c√¥t√© de r√©ception.  Vous pouvez √©galement mettre des constantes avec des files d'attente de noms et des h√¥tes dans nuget.  Nuget est personnalisable par jour.  Et aussi certains contr√¥les de source prennent en charge nuget, il existe des flux priv√©s payants. </p><br></li><li><p>  Comprendre les diff√©rences entre envoyer et publier.  Utilisez Envoyer si vous avez un abonn√© et que vous connaissez exactement le nom de la file d'attente √† laquelle vous envoyez la commande.  Publier est con√ßu pour envoyer des alertes de diffusion.  D√©tails sur le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">lien</a> . </p><br></li><li><p>  Si vous devez cr√©er un message de demande / r√©ponse, il est pr√©f√©rable d'ajouter le nom de file d'attente pour la r√©ponse au contrat plut√¥t que d'utiliser le sch√©ma de demande / r√©ponse de MassTransit, que MassTransit lui-m√™me sugg√®re d'√©viter.  √âtant donn√© que cela r√©duit consid√©rablement la fiabilit√©.  Vous perdez tous les avantages de l'asynchronie.  Mais si vous avez toujours besoin d'obtenir une r√©ponse dans un temps limit√©, il est pr√©f√©rable d'utiliser un appel direct.  Ceci est mieux √©crit dans le m√™me livre, ¬´Mod√®les d'int√©gration d'applications d'entreprise¬ª. </p><br></li><li><p>  La saga devrait √™tre mince.  Essayez de transporter toute la logique lourde vers d'autres syst√®mes.  Et Saga doit sauter √† travers les √©tats et disperser les messages de gauche √† droite. </p><br></li><li><p>  Ajoutez √† tous les messages CorrelationId, qui s'ex√©cutera entre les syst√®mes.  Il est donc beaucoup plus facile d'analyser les journaux et de lier tous les messages en une seule image.  Masstransit fait de m√™me.  CorrelationId est ajout√© aux messages lors de l'h√©ritage de l'interface CorrelatedBy. <br></p><br>  Configurez les journaux et la surveillance dans vos syst√®mes, cela ne fera jamais de mal.  Notre exp√©rience dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cet article</a> . <br></li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr412793/">https://habr.com/ru/post/fr412793/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr412783/index.html">Installation du proxy MTProto Telegram √† partir de la source sur Centos 7</a></li>
<li><a href="../fr412785/index.html">Master of Management et Freelancer. L'histoire en trois parties</a></li>
<li><a href="../fr412787/index.html">Int√©gration de Git dans un syst√®me de d√©veloppement d'entreprise</a></li>
<li><a href="../fr412789/index.html">¬´Aide au travail¬ª: comment rendre les robots de chat plus intelligents</a></li>
<li><a href="../fr412791/index.html">Am√©lioration des performances du syst√®me de vid√©osurveillance et pr√©vention des plantages</a></li>
<li><a href="../fr412795/index.html">Et tirons les conclusions de la discussion de l'article "Qu'est-ce qui ne va pas avec le retour des Geektimes √† Habr"</a></li>
<li><a href="../fr412797/index.html">√Ä propos des dangers du CDN, des services et des polices de Google</a></li>
<li><a href="../fr412799/index.html">Toujours en contact: Mango Talker - messenger et softphone</a></li>
<li><a href="../fr412801/index.html">√âtude: des pirates informatiques volent des millions de dollars en raison de la faible s√©curit√© des √©changes de crypto-monnaie</a></li>
<li><a href="../fr412803/index.html">Un regard plus approfondi sur les diff√©rentes plateformes de contrats intelligents</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>