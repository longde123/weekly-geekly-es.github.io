<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üéë üë¶ üßû Panneau de commande de bricolage de vaisseau spatial bricolage ‚öæÔ∏è üòî üè§</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour chers lecteurs! 

 Une id√©e m'est venue ici, mais pas pour assembler un panneau de commande pour un vaisseau spatial. Vers USB. Avec prise en ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Panneau de commande de bricolage de vaisseau spatial bricolage</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/434854/"><img src="https://habrastorage.org/webt/jq/jk/xz/jqjkxzwpn74xwt3quxzwbzwcxoa.jpeg"><br>  Bonjour chers lecteurs! <br><br>  Une id√©e m'est venue ici, mais pas pour assembler un panneau de commande pour un vaisseau spatial.  Vers USB.  Avec prise en charge du pilote natif.  HID personnalis√©.  Pour coller et tout fonctionne, sans danses ni tambourins.  En cons√©quence, nous avons obtenu une sorte de ¬´gamepad¬ª monstrueux pour les simulateurs spatiaux.  En g√©n√©ral, jugez par vous-m√™me. <br><a name="habracut"></a><br>  Au d√©but, je n'avais aucune id√©e de ce qui allait se passer √† la fin.  Je voulais deux joysticks principaux, comme sur Soyuz-MS, quelques commutateurs, boutons et plusieurs √©crans. <br><br>  Ayant estim√© la surface de travail de ma table, j'ai choisi les dimensions de la console en largeur et profondeur 500 * 300 mm.  Et apr√®s avoir fouill√© dans les entrep√¥ts de construction et les magasins √† la recherche de mat√©riaux de construction, il a choisi une hauteur de 125 mm.  En cons√©quence, j'ai acquis une feuille de contreplaqu√© de 4 mm, des lattes de 20 * 12 mm et une planche de 120 * 20 mm. <br><br>  Dans le cad, un croquis de la t√©l√©commande a √©t√© rapidement esquiss√©.  Et je l'ai fait dans un arbre pendant tr√®s longtemps.  Trois mois.  le week-end.  Et pas parce qu'il travaillait si imposant comme scie, mais par manque de temps.  Le panneau √©tait mastic, ponc√© et peint avec de la peinture √©maill√©e, de couleur similaire √† de vrais panneaux de vaisseaux spatiaux ou d'avions. <br><br><img src="https://habrastorage.org/webt/oa/oz/ck/oaozck0uudattfk5yl0mhztmx4o.jpeg"><br><br>  Mais pour l'instant, laissez le travail de peinture de c√¥t√© et je parlerai de rembourrage √©lectronique. <br><br>  Des pi√®ces radio ont √©t√© achet√©es sur Ali.  En tant que joysticks, je les ai trouv√©s.  En g√©n√©ral, la situation avec de tels joysticks est une couture compl√®te.  Les solutions industrielles sont trop ch√®res, mais bon march√©, se pr√©sentent comme des jouets et donc mauvaises.  Ils sont de tr√®s bonne qualit√©, mais ils ne sauront pas combien de temps ils seront. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/n-/4c/96/n-4c96az3dh--wj0w8ir1cqz1qw.jpeg"></div><br>  Le reste de la petite chose n'a pas caus√© de probl√®mes.  Le contr√¥leur a s√©lectionn√© STM32.  En tant qu'ADC pour joysticks, ADS1118 16 bits.  Une alimentation 12 V a √©galement √©t√© achet√©e. En fait, cette tension est due au fait que j'ai obtenu une jauge de carburant du ¬´shah¬ª, que je voulais √©galement attacher ici. <br><br><img src="https://habrastorage.org/webt/jz/0k/zq/jz0kzqxm-89ytb2bmexgkdqkm5i.jpeg"><br>  <i>Sur la photo, l'alimentation, stabilisateurs pour 5 et 3,3 V, STM32, MCP23017, ADS1118</i> <br><br>  Contr√¥leur 100 broches STM32F407VET6, connect√© √† celui-ci: <br><br>  2 s√©lecteurs √† 4 positions <br>  1 r√©sistance variable <br>  2 commutateurs d'essieu <br>  4 axes principaux <br>  2 axes auxiliaires <br>  2 essieux de contr√¥le <br>  4 interrupteurs √† cl√©, 2 boutons chacun <br>  20 boutons avec LED <br>  4 interrupteurs principaux avec LED <br>  2 boutons champignon avec LED <br>  2 boutons de minuterie <br>  3 interrupteurs avec LED <br>  13 interrupteurs <br>  2 ADS1118 (ADC) <br>  4 MAX7219 (√©crans LED √† 8 chiffres) <br>  2 TM1637 (heures d'affichage) <br>  1 PCF8574 (extenseur d'E / S, branch√© sur l'√©cran de synth√®se de caract√®res) <br><br><img src="https://habrastorage.org/webt/vl/6d/76/vl6d76rcv0daasbujiyeidj4fvc.png"><br>  <i>La structure r√©sultante</i> <br><br>  Ce sera un peu trop pour des centaines de jambes du MK, j'ai d√©cid√©, et j'ai ajout√© ici des extenseurs d'E / S: quatre pi√®ces de MCP23017, pour 16 entr√©es ou sorties chacune.  √Ä l'avenir, je dirai que le d√©lai d'interrogation des entr√©es de l'extenseur s'est av√©r√© √™tre d'environ 0,13 ms par puce, √† une vitesse de bus I2C de 400 kHz.  Autrement dit, il avec une marge couvre le temps d'interrogation USB minimum de 1 ms. <br><br>  Afin de ne pas piloter le bus I2C avec des requ√™tes inutiles, le MCP23017 poss√®de des sorties d'interruption qui sont r√©gl√©es lorsque l'√©tat des entr√©es change.  Je les ai √©galement appliqu√©s dans mon projet.  En fin de compte, en raison du vacillement des contacts, ces interruptions √©taient inutiles. <br><br>  L'ADS1118 ADC ne suit pas quelque peu la vitesse USB, ses performances d√©clar√©es sont au maximum de 820 √©chantillons par seconde, ce qui correspond √† 1,2 ms, tandis qu'il dispose de plusieurs entr√©es d√©j√† connect√©es √† l'ADC via le multiplexeur.  J'ai utilis√© 2 entr√©es sur une puce, donc le temps de mise √† jour des valeurs est de 2,4 ms.  Mauvais, mais que pouvez-vous faire?  Malheureusement, il n'y a pas d'autre ADC rapide 16 bits sur Ali. <br><br><img src="https://habrastorage.org/webt/sb/xt/jy/sbxtjyzbgnuutfbdhbh6iub1qpe.jpeg"><br>  <i>√Ä l'int√©rieur, cela ressemble √† ceci, mais apr√®s avoir install√© les fils, c'est bien pire</i> <br><br>  Le programme CPU est √©crit dans le style d'un programme PLC.  Aucune demande de blocage.  Le noyau n'attend pas la p√©riph√©rie, n'a pas eu le temps et l'enfer, au prochain cycle il interrogera.  Il n'y a pas non plus de RTOS dans le projet, je l'ai essay√©, j'ai rencontr√© un temps d'attente de t√¢che minimum de 1 ms - il s'av√®re lentement si nous devons envoyer des donn√©es via USB avec une fr√©quence de 1 ms.  En cons√©quence, j'ai r√©alis√© que j'utiliserais le syst√®me d'exploitation sans osDelay (), puis pourquoi RTOS?  Tout comme dans un automate, placer les instructions du programme une par une dans une boucle infinie suffit. <br><br>  Bien s√ªr, utilis√© les biblioth√®ques CubeMX et HAL.  Au fait, je suis r√©cemment pass√© √† HAL et je me suis interrog√© sur la commodit√©.  Je ne sais pas pourquoi ce n‚Äôest toujours pas tr√®s populaire, l‚Äôessentiel est de le comprendre au d√©but, puis √ßa se passera tr√®s simplement.  C'est comme si vous programmiez Arduino. <br><br>  L'appareil que nous aurons USB HID personnalis√©.  HID est une souris, un clavier, une manette de jeu, un joystick, et plus encore.  Et il y a une coutume.  Tout cela ne n√©cessite pas de pilotes du syst√®me d'exploitation.  Plus pr√©cis√©ment, ils sont d√©j√† √©crits par le d√©veloppeur.  Un appareil personnalis√© est bon en ce que nous combinons nous-m√™mes les capacit√©s de tous les appareils ci-dessus √† notre discr√©tion. <br><br>  En g√©n√©ral, le truc USB est tr√®s compliqu√©, il a un manuel de pr√®s de mille pages et vous ne pouvez pas le prendre en un clin d‚Äô≈ìil.  Qui ne veut pas lire les manuels lourds, il y a un super article USB dans un NutShell, google.  Elle a √©galement une traduction.  Je vais essayer d'expliquer certains points "sur les doigts". <br><br>  Transfert de donn√©es par paquets USB avec un tas de niveaux et d'abstractions.  L'appareil est avec nous - il ne peut pas demander de donn√©es, l'h√¥te initie l'int√©gralit√© du transfert.  L'h√¥te √©crit et demande des donn√©es aux soi-disant points de terminaison, physiquement ce sont des tampons dans la m√©moire MK.  Pour que l'h√¥te comprenne par quels points de terminaison il est possible d'√©crire, quels points de terminaison √† lire et quelles donn√©es il peut interpr√©ter comme des boutons et des axes de notre appareil et, en g√©n√©ral, quel type d'appareil nous avons ici, au d√©but de la connexion, il demande des descripteurs d'appareil.  Il y a beaucoup de ces descripteurs et il est difficile de les composer et vous pouvez comme vous le souhaitez, et aussi faire des erreurs n'importe o√π.  Physiquement, il s'agit d'un tableau d'octets. <br><br>  En fait, CubeMX g√©n√©rera un code d'initialisation HID personnalis√© mieux que nous. <br><br><img src="https://habrastorage.org/webt/dv/vh/vm/dvvhvm9hohydqeva77lahqhwer4.png"><br><br><img src="https://habrastorage.org/webt/b8/85/an/b885and1wp7m4r6yw9e21w-4hhs.png"><br><br>  Veuillez faire attention √† la derni√®re image sous le num√©ro 3. C'est la taille du descripteur en octets, qui d√©termine quels axes et boutons se trouvent sur notre appareil.  Ce descripteur est g√©n√©r√© dans l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">outil de description HID</a> .  Il existe plusieurs exemples d'autoformation.  En g√©n√©ral, voici mon descripteur.  Il n'y a pas encore de donn√©es pour les affichages, pour faciliter la compr√©hension, mais tous les boutons et axes des joysticks sont pr√©sents.  Il doit √™tre plac√© dans le fichier usbd_custom_hid_if.c.  Par d√©faut, cette poign√©e rend le cube vide. <br><br><div class="spoiler">  <b class="spoiler_title">Descripteur HID (taille 104 octets)</b> <div class="spoiler_text"><pre><code class="cpp hljs">__ALIGN_BEGIN <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> CUSTOM_HID_ReportDesc_FS[USBD_CUSTOM_HID_REPORT_DESC_SIZE] __ALIGN_END = { <span class="hljs-comment"><span class="hljs-comment">/* USER CODE BEGIN 0 */</span></span> <span class="hljs-number"><span class="hljs-number">0x05</span></span>, <span class="hljs-number"><span class="hljs-number">0x01</span></span>, <span class="hljs-comment"><span class="hljs-comment">// USAGE_PAGE (Generic Desktop) 0x15, 0x00, // LOGICAL_MINIMUM (0) 0x09, 0x04, // USAGE (Joystick) 0xa1, 0x01, // COLLECTION (Application) 0x05, 0x02, // USAGE_PAGE (Simulation Controls) 0x09, 0xbb, // USAGE (Throttle) 0x15, 0x00, // LOGICAL_MINIMUM (0) 0x27, 0xff, 0xff, 0x00, 0x00, // LOGICAL_MAXIMUM (65535) 0x75, 0x10, // REPORT_SIZE (16) 0x95, 0x01, // REPORT_COUNT (1) 0x81, 0x02, // INPUT (Data,Var,Abs) 0x05, 0x01, // USAGE_PAGE (Generic Desktop) 0x09, 0x01, // USAGE (Pointer) 0xa1, 0x00, // COLLECTION (Physical) 0x09, 0x30, // USAGE (X) 0x09, 0x31, // USAGE (Y) 0x95, 0x02, // REPORT_COUNT (2) 0x81, 0x02, // INPUT (Data,Var,Abs) 0xc0, // END_COLLECTION 0x05, 0x01, // USAGE_PAGE (Generic Desktop) 0x09, 0x32, // USAGE (Z) 0x95, 0x01, // REPORT_COUNT (1) 0x81, 0x02, // INPUT (Data,Var,Abs) 0x09, 0x33, // USAGE (Rx) 0x81, 0x02, // INPUT (Data,Var,Abs) 0x09, 0x34, // USAGE (Ry) 0x81, 0x02, // INPUT (Data,Var,Abs) 0x09, 0x35, // USAGE (Rz) 0x81, 0x02, // INPUT (Data,Var,Abs) 0x09, 0x36, // USAGE (Slider) 0x81, 0x02, // INPUT (Data,Var,Abs) 0x09, 0x39, // USAGE (Hat switch) 0x15, 0x01, // LOGICAL_MINIMUM (1) 0x25, 0x08, // LOGICAL_MAXIMUM (8) 0x35, 0x00, // PHYSICAL_MINIMUM (0) 0x46, 0x0e, 0x01, // PHYSICAL_MAXIMUM (270) 0x65, 0x14, // UNIT (Eng Rot:Angular Pos) 0x75, 0x08, // REPORT_SIZE (8) 0x95, 0x01, // REPORT_COUNT (1) 0x81, 0x02, // INPUT (Data,Var,Abs) 0x05, 0x09, // USAGE_PAGE (Button) 0x19, 0x01, // USAGE_MINIMUM (Button 1) 0x29, 0x40, // USAGE_MAXIMUM (Button 64) 0x15, 0x00, // LOGICAL_MINIMUM (0) 0x25, 0x01, // LOGICAL_MAXIMUM (1) 0x75, 0x01, // REPORT_SIZE (1) 0x95, 0x40, // REPORT_COUNT (64) 0x55, 0x00, // UNIT_EXPONENT (0) 0x65, 0x00, // UNIT (None) 0x81, 0x02, // INPUT (Data,Var,Abs) /* USER CODE END 0 */ 0xC0 /* END_COLLECTION */ };</span></span></code> </pre> <br></div></div><br>  En fait, il peut √™tre compos√© comme vous le souhaitez, vous d√©finissez d'abord la PAGE UTILISATION et l'UTILISATION requise, par exemple, l'axe USAGE (Throttle), puis apr√®s le mot INPUT (Data, Var, Abs), le syst√®me supposera que nous avons l'axe "Gas".  La dimension de l'axe variable et son nombre sont d√©finis par les param√®tres LOGICAL_MAXIMUM, MINIMUM, REPORT_SIZE, REPORT_COUNT, qui doivent √™tre avant INPUT. <br><br>  Plus de d√©tails sur ces param√®tres, ainsi que ce que (donn√©es, Var, Abs) peuvent √™tre trouv√©s dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">d√©finition de classe de p√©riph√©rique pour les p√©riph√©riques d'interface humaine (HID) v1.11</a> . <br><br>  Ce qui suit est un exemple d'initialisation de l'axe des gaz √† partir de mon descripteur.  Dans cet exemple, Throttle a une plage de valeurs de 0 √† 65535, ce qui correspond √† une variable uint16_t. <br><br><pre> <code class="cpp hljs"> <span class="hljs-number"><span class="hljs-number">0x05</span></span>, <span class="hljs-number"><span class="hljs-number">0x02</span></span>, <span class="hljs-comment"><span class="hljs-comment">// USAGE_PAGE (Simulation Controls) 0x09, 0xbb, // USAGE (Throttle) 0x15, 0x00, // LOGICAL_MINIMUM (0) 0x27, 0xff, 0xff, 0x00, 0x00, // LOGICAL_MAXIMUM (65535) 0x75, 0x10, // REPORT_SIZE (16) 0x95, 0x01, // REPORT_COUNT (1) 0x81, 0x02, // INPUT (Data,Var,Abs)</span></span></code> </pre> <br>  Et oui, pourtant, disons que vous ne pouvez pas √©crire LOGICAL_MAXIMUM, MINIMUM, REPORT_SIZE, REPORT_COUNT √† chaque fois, l'h√¥te d√©terminera cette valeur par le param√®tre pr√©c√©dent.  Ceci est illustr√© par les axes qui se succ√®dent, sans pr√©ciser la taille et le nombre: <br><br><pre> <code class="cpp hljs"> <span class="hljs-number"><span class="hljs-number">0x09</span></span>, <span class="hljs-number"><span class="hljs-number">0x32</span></span>, <span class="hljs-comment"><span class="hljs-comment">// USAGE (Z) 0x95, 0x01, // REPORT_COUNT (1) 0x81, 0x02, // INPUT (Data,Var,Abs) 0x09, 0x33, // USAGE (Rx) 0x81, 0x02, // INPUT (Data,Var,Abs) 0x09, 0x34, // USAGE (Ry) 0x81, 0x02, // INPUT (Data,Var,Abs) 0x09, 0x35, // USAGE (Rz) 0x81, 0x02, // INPUT (Data,Var,Abs) 0x09, 0x36, // USAGE (Slider)</span></span></code> </pre> <br>  La structure suivante correspond √† tout ce descripteur, qui est plus haut sous le spoiler.  En fait, il n'est plus obligatoire, il est juste plus pratique d'enregistrer sur la base de pointeurs. <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> pack(push, 1) typedef struct _myReportStruct { uint16_t Throttle; uint16_t X; uint16_t Y; uint16_t Z; uint16_t Rx; uint16_t Ry; uint16_t Rz; uint16_t Slider; uint8_t Hat; </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// 0 - none, 1 - up, 2 - up-right, 3 - right, 4 - down-right... uint32_t Buttons1; // 32 buttons of 1 bit each uint32_t Buttons2; // 32 buttons of 1 bit each }myReportStruct; #pragma pack(pop) volatile myReportStruct Desk;</span></span></span></span></code> </pre> <br>  Cette structure peut √™tre envoy√©e √† l'h√¥te par la fonction <br><br><pre> <code class="cpp hljs">USBD_CUSTOM_HID_SendReport(&amp;hUsbDeviceFS, (<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *) &amp;Desk, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(Desk));</code> </pre> <br>  Le premier param√®tre est une poign√©e USB, il est d√©j√† cr√©√© dans notre cube.  Vous devrez peut-√™tre inclure le fichier n√©cessaire avec l'inclusion o√π ce descripteur est initialis√© pour la premi√®re fois et √©crire <i>extern USBD_HandleTypeDef hUsbDeviceFS;</i>  afin que vous puissiez travailler avec lui.  Le deuxi√®me param√®tre est un pointeur sur notre structure et le troisi√®me est la taille de la structure en octets. <br><br>  Apr√®s avoir rempli et fait clignoter le contr√¥leur, vous remarquerez que quelque chose USB se d√©place lentement.  Les donn√©es de notre panel ne sont pas mises √† jour rapidement.  Pour √™tre rapide, dans les fichiers usbd_customhid.h, vous devez remplacer #define CUSTOM_HID_EPIN_SIZE par la valeur maximale 0x40, #define CUSTOM_HID_EPOUT_SIZE √©galement d√©fini 0x40.  Dans le fichier usbd_customhid.c, recherchez des commentaires dans le descripteur de noeud final "/ * bInterval: Polling Interval (20 ms) * /" et modifiez l'octet de descripteur sur 0x01 pour chaque noeud final, deux fois seulement.  Ce qui correspondra √† un √©change de donn√©es de 1 ms. <br><br><img src="https://habrastorage.org/webt/yf/zm/cx/yfzmcxseu1la7jgqxyql9qzm4ji.png"><br>  <i>Cela devrait √™tre quelque chose comme √ßa.</i>  <i>Appareil standard sans installer de pilote</i> <br><br>  En g√©n√©ral, la fonction de gestion est un peu mal comprise.  C'est assez facile √† faire et tous les boutons et axes fonctionnent d√©j√†.  Reste √† faire fonctionner les √©crans.  Je l'ai fait, environ six mois, et depuis six mois, le panneau ramasse de la poussi√®re dans une longue bo√Æte.  Pas de temps.  J'ai donc d√©cid√© de pr√©senter l'article sous cette forme, sinon il risque m√™me de ne pas sortir. <br><br>  Avec les √©crans, tout est le m√™me qu'avec les axes.  Pour eux, nous devons compl√©ter notre descripteur d'appareil HID, simplement indiquer qu'il s'agit d'affichages et au lieu d'accepter les donn√©es d'entr√©e, l'h√¥te enverra les donn√©es de sortie. <br><br>  La poign√©e de l'appareil HID a consid√©rablement augment√©.  Ici, j'ai d√©j√† appliqu√© les param√®tres Report ID afin de ne pas obstruer le tampon d'√©mission / r√©ception et les points d'extr√©mit√© avec des donn√©es compl√®tes et de distinguer le type de t√©l√©gramme que nous avons re√ßu.  L'ID de rapport est un octet uint8_t avec la valeur qui vient au d√©but du t√©l√©gramme.  La valeur que nous avons d√©finie dans le descripteur d'appareil HID. <br><br><div class="spoiler">  <b class="spoiler_title">CUSTOM_HID_ReportDesc_FS</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//AXIS 0x05, 0x01, // USAGE_PAGE (Generic Desktop) 0x09, 0x04, // USAGE (Joystick) 0xa1, 0x01, // COLLECTION (Application)28 0x05, 0x02, // USAGE_PAGE (Simulation Controls) 0x09, 0xbb, // USAGE (Throttle) 0x15, 0x00, // LOGICAL_MINIMUM (0) 0x27, 0xff, 0xff, 0x00, 0x00, // LOGICAL_MAXIMUM (65535) 0x75, 0x10, // REPORT_SIZE (16) 0x95, 0x01, // REPORT_COUNT (1) 0x85, 0x01, // REPORT_ID (1) 0x81, 0x02, // INPUT (Data,Var,Abs) 0x05, 0x01, // USAGE_PAGE (Generic Desktop) 0x09, 0x01, // USAGE (Pointer) 0xa1, 0x00, // COLLECTION (Physical) 0x09, 0x30, // USAGE (X) 0x09, 0x31, // USAGE (Y) 0x95, 0x02, // REPORT_COUNT (2) 0x81, 0x02, // INPUT (Data,Var,Abs) 0xc0, // END_COLLECTION 0x05, 0x01, // USAGE_PAGE (Generic Desktop) 0x09, 0x32, // USAGE (Z) 0x95, 0x01, // REPORT_COUNT (1) 0x81, 0x02, // INPUT (Data,Var,Abs) 0x09, 0x33, // USAGE (Rx) 0x81, 0x02, // INPUT (Data,Var,Abs) 0x09, 0x34, // USAGE (Ry) 0x81, 0x02, // INPUT (Data,Var,Abs) 0x09, 0x35, // USAGE (Rz) 0x81, 0x02, // INPUT (Data,Var,Abs) 0x09, 0x36, // USAGE (Slider) 0x81, 0x02, // INPUT (Data,Var,Abs) //HAT 0x09, 0x39, // USAGE (Hat switch) 0x15, 0x01, // LOGICAL_MINIMUM (1) 0x25, 0x08, // LOGICAL_MAXIMUM (8) 0x35, 0x00, // PHYSICAL_MINIMUM (0) 0x46, 0x0e, 0x01, // PHYSICAL_MAXIMUM (270) 0x65, 0x14, // UNIT (Eng Rot:Angular Pos) 0x75, 0x08, // REPORT_SIZE (8) 0x95, 0x01, // REPORT_COUNT (1) 0x81, 0x02, // INPUT (Data,Var,Abs) //Buttons 0x05, 0x09, // USAGE_PAGE (Button) 0x19, 0x01, // USAGE_MINIMUM (Button 1) 0x29, 0x40, // USAGE_MAXIMUM (Button 64) 0x15, 0x00, // LOGICAL_MINIMUM (0) 0x25, 0x01, // LOGICAL_MAXIMUM (1) 0x75, 0x01, // REPORT_SIZE (1) 0x95, 0x40, // REPORT_COUNT (64) 0x55, 0x00, // UNIT_EXPONENT (0) 0x65, 0x00, // UNIT (None) 0x81, 0x02, // INPUT (Data,Var,Abs) //LEDs 0x85, 0x02, // REPORT_ID (2) 0x05, 0x08, // USAGE_PAGE (LEDs) 0x09, 0x4B, // USAGE (Generic Indicator) 0x95, 0x40, // REPORT_COUNT (16) 0x91, 0x02, // OUTPUT (Data,Var,Abs) 0xc0, // END_COLLECTION //LCD Displays 0x05, 0x14, // USAGE_PAGE (Alphnumeric Display) 0x09, 0x01, // USAGE (Alphanumeric Display) 0x15, 0x00, // LOGICAL_MINIMUM (0) 0xa1, 0x02, // COLLECTION (Logical) 0x09, 0x32, // USAGE (Cursor Position Report) 0xa1, 0x02, // COLLECTION (Logical) 0x85, 0x04, // REPORT_ID (4) 0x75, 0x08, // REPORT_SIZE (8) 0x95, 0x01, // REPORT_COUNT (1) 0x25, 0x13, // LOGICAL_MAXIMUM (19) 0x09, 0x34, // USAGE (Column) 0xb1, 0x22, // FEATURE (Data,Var,Abs,NPrf) 0x25, 0x03, // LOGICAL_MAXIMUM (3) 0x09, 0x33, // USAGE (Row) 0x91, 0x22, // OUTPUT (Data,Var,Abs,NPrf) 0xc0, // END_COLLECTION 0x09, 0x2b, // USAGE (Character Report) 0xa1, 0x02, // COLLECTION (Logical) 0x85, 0x05, // REPORT_ID (5) 0x95, 0x14, // REPORT_COUNT (20) 0x26, 0xFF, 0x00, // LOGICAL_MAXIMUM (255) 0x09, 0x2c, // USAGE (Display Data) 0x92, 0x02, 0x01, // OUTPUT (Data,Var,Abs,Buf) 0xc0, // END_COLLECTION 0x09, 0x24, // USAGE (Display Control Report) 0x85, 0x06, // REPORT_ID (6) 0x95, 0x01, // REPORT_COUNT (1) 0x91, 0x22, // OUTPUT (Data,Var,Abs,NPrf) 0xc0, // END_COLLECTION //LED Displays 0x05, 0x14, // USAGE_PAGE (Alphnumeric Display) 0x09, 0x01, // USAGE (Alphanumeric Display) 0x15, 0x00, // LOGICAL_MINIMUM (0) 0xa1, 0x02, // COLLECTION (Logical) 0x09, 0x2b, // USAGE (Character Report) 0xa1, 0x02, // COLLECTION (Logical) 0x85, 0x07, // REPORT_ID (7) 0x75, 0x08, // REPORT_SIZE (8) 0x95, 0x28, // REPORT_COUNT (40) 0x26, 0xFF, 0x00, // LOGICAL_MAXIMUM (255) 0x09, 0x2c, // USAGE (Display Data) 0x92, 0x02, 0x01, // OUTPUT (Data,Var,Abs,Buf) 0xc0, // END_COLLECTION //Other DATA 0x06, 0x00, 0xff, // USAGE_PAGE (Generic Desktop) 0x09, 0x01, // USAGE (Vendor Usage 1) 0xa1, 0x01, // COLLECTION (Application) 0x85, 0x08, // REPORT_ID (8) 0x09, 0x01, // USAGE (Vendor Usage 1) 0x15, 0x00, // LOGICAL_MINIMUM (0) 0x27, 0xff, 0xff, 0x00, 0x00, // LOGICAL_MAXIMUM (65535) 0x75, 0x10, // REPORT_SIZE (16) 0x95, 0x0A, // REPORT_COUNT (10) 0x91, 0x82, // OUTPUT (Data,Var,Abs,Vol)</span></span></code> </pre> </div></div><br>  La sortie est <i>trait√©e</i> dans la fonction <i>statique int8_t CUSTOM_HID_OutEvent_FS (uint8_t event_idx, uint8_t state)</i> , qui, par d√©faut, se trouve dans usbd_custom_hid_if.c. <br><br><div class="spoiler">  <b class="spoiler_title">statique int8_t CUSTOM_HID_OutEvent_FS ()</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> int8_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CUSTOM_HID_OutEvent_FS</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> event_idx, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> state)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/* USER CODE BEGIN 6 */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> dataReceiveArray[USBD_CUSTOMHID_OUTREPORT_BUF_SIZE]; USBD_CUSTOM_HID_HandleTypeDef *hhid = (USBD_CUSTOM_HID_HandleTypeDef*)hUsbDeviceFS.pClassData; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; USBD_CUSTOMHID_OUTREPORT_BUF_SIZE; i++) { dataReceiveArray[i] = hhid-&gt;Report_buf[i]; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dataReceiveArray[<span class="hljs-number"><span class="hljs-number">0</span></span>] == <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-comment"><span class="hljs-comment">//report ID 2 leds { //  Report id == 2,   -     dataReceiveArray[1 + N], ,  LED } if (dataReceiveArray[0] == 4) //report ID 4 cursor position { //  Report id == 4,   -,     LCD } if (dataReceiveArray[0] == 5) //report ID 5 display data { //  Report id == 5,   -,     USB  LCD } //   ,   ID     return (USBD_OK); /* USER CODE END 6 */ }</span></span></code> </pre> <br></div></div><br>  Il ne reste plus qu'√† √©crire un programme sur un PC qui envoie les rapports n√©cessaires pour piloter les √©crans.  Cependant, pour v√©rifier le code MK, un excellent programme de ST: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">USB HID Demonstrator</a> convient.  Il vous permet d'envoyer des rapports depuis un PC avec n'importe quel contenu. <br><br><img src="https://habrastorage.org/webt/ft/bd/e3/ftbde3fwn14llpdhjmakp7pwx4a.jpeg"><br>  <i>Test d'affichage LED</i> <br><br>  √Ä ce stade, j'ai termin√© jusqu'√† pr√©sent.  Et on ne sait pas si je vais recommencer. <br><br>  Il se joue dans des simulateurs plus int√©ressants qu'avec un clavier.  Mais pas tellement qu'il y eut un effet wow direct.  Le clavier, √ßa ressemble aussi √† un panneau de contr√¥le.  Mais contr√¥ler les essieux du joystick est, au minimum, inhabituel.  Sentez-vous comme un astronaute.  Certes, une combinaison spatiale est n√©cessaire pour une immersion compl√®te. <br><br>  J'esp√®re que vous √©tiez int√©ress√©.  Des fautes de frappe, des inexactitudes et des d√©lires sont pr√©sents.  Ceux qui veulent approfondir le code peuvent le voir <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . <br><br>  Cordialement </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr434854/">https://habr.com/ru/post/fr434854/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr434838/index.html">Cr√©ation d'un bot pour participer √† la Russian AI Cup 2018 CodeBall</a></li>
<li><a href="../fr434840/index.html">Comment ai-je r√©alis√© "Your Diary" - ou la situation sur le march√© des agendas √©lectroniques</a></li>
<li><a href="../fr434842/index.html">Les fermes urbaines peuvent √™tre extr√™mement efficaces, mais pas pour le moment</a></li>
<li><a href="../fr434844/index.html">R√©cup√©ration des capacit√©s cognitives de 100 patients (traduction d'un article de Dale Bredesen)</a></li>
<li><a href="../fr434848/index.html">Le conseil d'administration de Tesla comprend deux administrateurs ind√©pendants - Larry Ellison et Caitlin Wilson-Thompson</a></li>
<li><a href="../fr434856/index.html">Montage vid√©o dans MPC √† l'aide de shaders</a></li>
<li><a href="../fr434858/index.html">Jetpack Racing 2019</a></li>
<li><a href="../fr434862/index.html">Une forme intelligente d'√©coliers chinois contribue √† r√©duire l'absent√©isme</a></li>
<li><a href="../fr434864/index.html">Ing√©nieur senior en recherche de travail. Comment j'ai v√©cu 15 entretiens techniques et ce que j'en pense</a></li>
<li><a href="../fr434868/index.html">La blockchain est morte. Longue vie √† la blockchain</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>