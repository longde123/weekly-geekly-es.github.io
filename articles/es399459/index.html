<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§∑üèª üòø üè¥Û†ÅßÛ†Å¢Û†Å∑Û†Å¨Û†Å≥Û†Åø Blackjack y protecci√≥n contra fugas ü•â ü§ûüèΩ üëÉüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Saludos Existe tal cosa - hydrolock \ neptune \ avkvastorozh - sistemas de cierre de agua si se produce una fuga incontrolada. El principio es simple:...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Blackjack y protecci√≥n contra fugas</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/399459/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Saludos Existe tal cosa - hydrolock \ neptune \ avkvastorozh - sistemas de cierre de agua si se produce una fuga incontrolada. El principio es simple: un sensor de agua + automatizaci√≥n + un par de grifos el√©ctricos. Pero el diablo, como de costumbre, est√° en los detalles: c√≥mo est√°n dispuestos los grifos, c√≥mo est√°n dispuestos los sensores de fugas y por qu√© uno cuesta 50 rublos y el otro cuesta 500 rublos. Un kilogramo de un bolet√≠n de dise√±o se envolver√° alrededor de todo esto, el empaque te sacar√° los ojos, etc. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En la historia, caminar√© a trav√©s de los ladrillos del sistema, que me gui√≥ en la elecci√≥n. Todo el sistema est√° construido con sensores de f√°brica y un controlador casero basado en Particle (por ejemplo, Park) Photon (como un esp8266 que tiene un IDE de nube en el cableado de la caja), la base del dispositivo es controlador stm + m√≥dulo wifi de Broadcom. Todo esto est√° vinculado a un servidor openhab en Orange Pi One.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/715/6ee/aa2/7156eeaa28b44479a5d5aff2e63ff89c.png" width="600"></div><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øPor qu√© no un sistema terminado? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 - Porque puedo hacerlo yo mismo y es alto </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 - La integraci√≥n con sistemas externos es escasa en los sistemas listos para usar. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 - Los sistemas listos para usar no tienen funciones auxiliares: tener en cuenta las lecturas del medidor, los sensores de temperatura del agua, la notificaci√≥n de cortes de agua y otras fantas√≠as er√≥ticas para caminar.</font></font><br>
 <br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comencemos con gr√∫as</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Elija est√∫pidamente en la frente en t√©rminos de torque. Durante alg√∫n tiempo vivi√≥ en los suburbios, donde la calidad del agua (como probablemente en todas partes en Zamkadye) deja mucho que desear. Entonces, las v√°lvulas de bola de 1/2 pulgada si no toca el a√±o, es muy dif√≠cil girar. Y en el toallero t√©rmico de 1 pulgada, ni siquiera trato de moverlo, solo si fortalezco el hombro con una llave, pero aqu√≠ puedes arrancar algo. El problema est√° en los dep√≥sitos de calcio-madera dura, "cubiertos de vegetaci√≥n" con una sola palabra. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En consecuencia, la elecci√≥n recay√≥ en la serie profesional del hidrolock: 21 N * m de torque no parece una charla publicitaria, la gr√∫a es simplemente enorme: eval√∫e el lugar de su instalaci√≥n antes de la compra. </font></font><br>
<br>
<img src="https://habrastorage.org/files/758/e07/18c/758e0718cc9a46e09306bac214db8cf1.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El grifo est√° sellado, un sello de goma alrededor del per√≠metro, la entrada debajo del prensaestopas. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Retirar la tapa.</font></font><br>
<br>
<img src="https://habrastorage.org/files/f9d/aa4/a25/f9daa4a251e140c3bbe4b049a5af7f46.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ante nosotros est√° la parte superior del tablero y el motor paso a paso. Todo esto funciona con 12 voltios. Cortar el cable de control a tierra pone la v√°lvula en la posici√≥n cerrada. En el tablero vemos un simple controlador PIC 12f629. Vivi√≥, el controlador en la unidad de la gr√∫a. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La parte posterior del tablero es la m√°s interesante. </font></font><br>
<br>
<img src="https://habrastorage.org/files/c14/e08/f2e/c14e08f2e4224088a534e1811fa3729a.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L293 shagovik driver y photocoupler (emisor + fotodetector). Ella mira el engranaje principal de la unidad, que est√° pintado en partes: blanco y negro, cerrado / abierto. </font></font><br>
<br>
<img src="https://habrastorage.org/files/a14/cec/177/a14cec1771ef4d52bc15c83e9183124e.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La gr√∫a gira todo el tiempo en una direcci√≥n, la l√≥gica del controlador es simple: giramos el eje hasta que cambiemos al color deseado. La rotaci√≥n de la gr√∫a en una direcci√≥n es menos desgaste, y es menos probable que la forma sin contacto de determinar la posici√≥n provoque un mal funcionamiento / mal funcionamiento de una resistencia variable o un interruptor de l√≠mite.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para la instalaci√≥n, puede desenroscar la gr√∫a de la unidad; se sujeta con 2 tuercas. Hay una junta aislante de calor entre el variador y la gr√∫a. </font></font><br>
<br>
<img src="https://habrastorage.org/files/bf7/37c/1f7/bf737c1f7a144c72baba7a17fdc94615.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tuve la reparaci√≥n hace un a√±o y medio. La gr√∫a se compr√≥ hace tres a√±os: para desmontar, mirar dentro, comprar m√°s y enrollarla durante la reparaci√≥n. S√≠, ahora ... lo m√°ximo que logr√© en este circo infernal fue colocar un recolector de suciedad en el ensamblaje del suministro de agua con la posibilidad de reemplazarlo con una gr√∫a. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y solo despu√©s de a√±o y medio, compr√© una segunda gr√∫a y la atornill√©.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, observamos un fen√≥meno extra√±o y raro (le√≠do en la voz de Drozdov): se confirm√≥ toda la informaci√≥n del sitio web del fabricante. Adem√°s, la descripci√≥n es peculiar, como si los t√©cnicos escribieran, y luego el marketing fue regado para la gente, pero todav√≠a pocas personas entienden todos los chips. No hay suficiente secci√≥n en el sitio, para integradores con detalles t√©cnicos en su interior. Incluso a expensas del aumento del torque, no se encontraban al inicio: la gr√∫a al comienzo golpea con un motor de 1.5A y despu√©s de 2-3 segundos comienza a subir en modo normal (corriente 0.7 A). Tarda unos 25-30 segundos en cerrarse.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Otra experiencia: a expensas del par, es excesivo para el tiempo de Mosc√∫, aqu√≠ el agua est√° bastante bien, durante un a√±o y medio en un filtro de 100 Œºm hay un par de escoria y no se produce un crecimiento excesivo. </font><font style="vertical-align: inherit;">Tienes que pagar por el gran torque con el precio, el tiempo de apertura y el lugar en el armario. </font><font style="vertical-align: inherit;">Creo que habr√° suficientes unidades convencionales de Hydrolock Ultimate, Neptune o Aquastorozh. </font><font style="vertical-align: inherit;">No puedo responder por los dos √∫ltimos: no lo logr√©, hace unos 5 a√±os ten√≠an engranajes parcialmente de pl√°stico, ahora parecen haberlo arreglado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tambi√©n hay un Winrolock Winner con conexi√≥n directa de sensores al variador, esto es si no necesita todo lo que he hecho. </font><font style="vertical-align: inherit;">All√≠, la potencia es aut√≥noma de 4 bater√≠as, y la base es similar a una unidad definitiva. </font><font style="vertical-align: inherit;">En general, tambi√©n es potencialmente interesante para un controlador hecho a s√≠ mismo: tiene 5 voltios, no necesita poner dos buses en 5 y 12 voltios y puede tirar el aislamiento √≥ptico.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sensores de fugas</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Compr√© los sensores del mismo contador WSU - universal. </font><font style="vertical-align: inherit;">Tienen dos salidas de "colector abierto", una tira al suelo solo si hay agua, la segunda, si entra agua, tira al suelo todo el tiempo hasta que se corta la energ√≠a. </font><font style="vertical-align: inherit;">Solo uso la primera salida, el resto de la l√≥gica est√° en el controlador, pero parece que esta salida puede ser √∫til para algunos sistemas de despacho de condominios. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los cables en el kit son tres metros en alguna parte. </font><font style="vertical-align: inherit;">El color de los cables es Ad_i_Israel. </font><font style="vertical-align: inherit;">Mira la cita:</font></font><br>
<br>
<blockquote><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cable rojo (marr√≥n) (Vcc) alimentado de +5 a +30 voltios. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
cable negro (blanco) (OUT2) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
cable verde (OUT1) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
cable amarillo (GND)</font></font></i></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esto es lo que evit√≥ hacer tierra blanca / negra? </font><font style="vertical-align: inherit;">En el accionamiento de la gr√∫a, por cierto, los cables en color con l√≥gica no son ale. </font><font style="vertical-align: inherit;">El primer sensor est√° en la cocina, debajo del fregadero al lado del lavavajillas. </font></font><br>
<br>
<img src="https://habrastorage.org/files/2ea/407/a25/2ea407a255b8420e9b1d6c26772e2709.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El segundo en el ba√±o en una zanja de drenaje especial. </font><font style="vertical-align: inherit;">Cuando hizo la regla, no la trajo a la pared. </font><font style="vertical-align: inherit;">El resultado fue una especie de sumidero para recoger agua del ba√±o y del inodoro. </font></font><br>
<br>
<img src="https://habrastorage.org/files/51d/715/898/51d71589848d4a77a59f8caf0dbf2041.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seg√∫n la experiencia operativa, ya hab√≠a una falsa alarma del sensor en el lavavajillas. </font><font style="vertical-align: inherit;">A juzgar por el registro de un ciclo de sondeo (500 ms) hubo un circuito, modific√≥ el c√≥digo: el cambio de estado ahora se produce a 10 valores id√©nticos consecutivos del sensor. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los contactos del sensor est√°n chapados en oro. </font><font style="vertical-align: inherit;">Un amigo ha tenido sensores similares durante varios a√±os, no se ha notado oxidaci√≥n.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sensores de presi√≥n</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pr√°cticamente - showometers. </font><font style="vertical-align: inherit;">Precisi√≥n + - 0.5 atm me conven√≠a completamente. </font><font style="vertical-align: inherit;">Seg√∫n los sensores, aparece una alerta de cierre de agua. </font><font style="vertical-align: inherit;">Compr√© en Ali </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqu√≠</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sensores de temperatura</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øY por qu√© no agregar? </font><font style="vertical-align: inherit;">De utilidad: podr√° informar una vez al a√±o sobre el cierre del agua caliente. </font><font style="vertical-align: inherit;">Banal ds18b20 usado.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Contadores</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El Itelma m√°s com√∫n, una vez cada 10 litros hace contacto. </font><font style="vertical-align: inherit;">En el lado del controlador, la salida se eleva a + 3.3v, el medidor la tira al suelo.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Controlador</font></font></h3><br>
<img src="https://habrastorage.org/files/318/4e6/d7a/3184e6d7ad9c4eab99d9962410c7918c.jpg"><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dentro</font></font></b><div class="spoiler_text"><img src="https://habrastorage.org/files/a83/72d/117/a8372d1170ca43f8b92925fa76a240f8.jpg"><br>
<img src="https://habrastorage.org/files/f7b/e62/ee8/f7be62ee80a54ff2a0ed60ad17467a8b.jpg"><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Basado en Particle Photon, m√°s detalles </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqu√≠</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Tienen una versi√≥n con un m√≥dulo 2G o 3G (Electron). El primer firmware fue escoria completa, parpadeando con diodos OK, pero tan pronto como comience la salchicha masticable complicada, jugar con i2c e interrupciones puede perder wifi. Ahora puedes vivir. En principio, puede arrojar sensores de presi√≥n fuera del circuito y agitar todo en el ESP8266; adelante. Primero, el fot√≥n debe estar vinculado a la cuenta de part√≠culas (a trav√©s de la aplicaci√≥n en el m√≥vil o a trav√©s de la consola Particle CLI; solo uso el segundo m√©todo) y registrar una red wifi. Despu√©s del enlace, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqu√≠</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en la secci√≥n del dispositivo aparece el controlador y su estado de conexi√≥n a la nube.</font></font><br>
<br>
<img src="https://habrastorage.org/files/71d/c17/687/71dc17687ccb4a289d0a0dd2296fdfca.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tengo todos los nodos conectados a la nube solo para actualizar el firmware. </font><font style="vertical-align: inherit;">No es que sea paranoico, solo trabajar con la nube no consume recursos de controlador ricos. </font><font style="vertical-align: inherit;">El IDE admite trabajar con bibliotecas, literalmente una docena cuenta con el respaldo del propio contador, el resto con la comunidad. </font><font style="vertical-align: inherit;">En mi observaci√≥n, todo lo com√∫n ha sido portado durante mucho tiempo, y otra caracter√≠stica es que el IDE sabe inmediatamente cu√°ntos proyectos usan la biblioteca.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥digo fuente del firmware</font></font></b><div class="spoiler_text"><pre><code class="hljs cpp"><span class="hljs-comment"><span class="hljs-comment">// This #include statement was automatically added by the Particle IDE.</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Adafruit_SSD1306/Adafruit_SSD1306.h"</span></span></span></span><font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">// This #include statement was automatically added by the Particle IDE.</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"MQTT/MQTT.h"</span></span></span></span><font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">// This #include statement was automatically added by the Particle IDE.</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"OneWire/OneWire.h"</span></span></span></span><font></font>
<font></font>
SYSTEM_THREAD(ENABLED);<font></font>
SYSTEM_MODE(MANUAL);<font></font>
STARTUP(WiFi.selectAntenna(ANT_EXTERNAL));<font></font>
STARTUP(System.enableFeature(FEATURE_RETAINED_MEMORY));<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">counter_struct</span></span></span><span class="hljs-class"> {</span></span>
  <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> value;<font></font>
  byte state;<font></font>
  <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> pin;<font></font>
};<font></font>
<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">valve_struct</span></span></span><span class="hljs-class"> {</span></span><font></font>
  byte state;<font></font>
  <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> pin;<font></font>
};<font></font>
<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sensor_struct</span></span></span><span class="hljs-class"> {</span></span>
  <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> timeout;<font></font>
  byte state;<font></font>
  <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> pin;<font></font>
};<font></font>
<font></font>
<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> currentMillis = <span class="hljs-number"><span class="hljs-number">0</span></span>;
<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> previous_conected = <span class="hljs-number"><span class="hljs-number">100000</span></span>; <span class="hljs-comment"><span class="hljs-comment">//  </span></span>
<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> previous_wifi_uptime = <span class="hljs-number"><span class="hljs-number">100000</span></span>; <span class="hljs-comment"><span class="hljs-comment">//  </span></span>
<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> previous_counter_read = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">//  </span></span>
<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> wifi_uptime;
<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> start_temp_timer = <span class="hljs-number"><span class="hljs-number">0</span></span>;
<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> read_temp_timer = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
byte display_timeout = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">//temp onewire </span></span><font></font>
OneWire ds0 = OneWire(D2);<font></font>
OneWire ds1 = OneWire(D3);<font></font>
byte addr0[<span class="hljs-number"><span class="hljs-number">8</span></span>];<font></font>
byte addr1[<span class="hljs-number"><span class="hljs-number">8</span></span>];
<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> presense0 = <span class="hljs-literal"><span class="hljs-literal">false</span></span>;
<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> presense1 = <span class="hljs-literal"><span class="hljs-literal">false</span></span>;<font></font>
byte data[<span class="hljs-number"><span class="hljs-number">12</span></span>];<font></font>
<font></font>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> OLED_RESET A7</span></span>
<span class="hljs-function"><span class="hljs-function">Adafruit_SSD1306 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">display</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(OLED_RESET)</span></span></span></span>;<font></font>
<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">//valve control</span></span>
retained valve_struct valve[<span class="hljs-number"><span class="hljs-number">2</span></span>] = { {<span class="hljs-number"><span class="hljs-number">0</span></span>, D4}, {<span class="hljs-number"><span class="hljs-number">0</span></span>, D5} };<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">//counter control</span></span>
retained counter_struct counter[<span class="hljs-number"><span class="hljs-number">2</span></span>] = { {<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, A0}, {<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, A1} };
<span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> pressure[<span class="hljs-number"><span class="hljs-number">2</span></span>] = {A2, A3};
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SENSOR_TIMEOUT 10</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> sensor_struct sensor[<span class="hljs-number"><span class="hljs-number">2</span></span>] = { {<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, D6}, {<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, D7} };<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">callback</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* topic, byte* payload, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> length)</span></span></span></span>;<font></font>
<font></font>
byte server[] = { <span class="hljs-number"><span class="hljs-number">192</span></span>,<span class="hljs-number"><span class="hljs-number">168</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">101</span></span>};
<span class="hljs-function"><span class="hljs-function">MQTT </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">client</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(server, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1883</span></span></span></span><span class="hljs-function"><span class="hljs-params">, callback)</span></span></span></span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">publish_message</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* t, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* p, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> retain)</span></span></span><span class="hljs-function"> 
</span></span>{
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client.publish(t, (<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span>*)p, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(p), retain);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">publish_message</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* t, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> p, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> retain)</span></span></span><span class="hljs-function"> 
</span></span>{   
    <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buf_d[<span class="hljs-number"><span class="hljs-number">12</span></span>];
    <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> n = <span class="hljs-built_in"><span class="hljs-built_in">sprintf</span></span>(buf_d,<span class="hljs-string"><span class="hljs-string">"%d"</span></span>,p);
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client.publish(t, (<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span>*)buf_d, n, retain);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">publish_message</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* t, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> p, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> retain)</span></span></span><span class="hljs-function"> 
</span></span>{   
    <span class="hljs-comment"><span class="hljs-comment">//char buf_f[18];</span></span>
    <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">s</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(p, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">4</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>;
<span class="hljs-comment"><span class="hljs-comment">//    dtostrf(p, 9, 4, buf_f);</span></span>
    <span class="hljs-comment"><span class="hljs-comment">//int n = sprintf(buf_f,"%f",p);</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client.publish(t, (<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span>*)s.c_str(), s.length(), retain);<font></font>
}<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">// recieve message</span></span>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">callback</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* topic, byte* payload, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> length)</span></span></span><span class="hljs-function"> </span></span>{
    <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> p[length + <span class="hljs-number"><span class="hljs-number">1</span></span>];
    <span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>(p, payload, length);<font></font>
    p[length] = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>;
    <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">message</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(p)</span></span></span></span>;
    <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(topic)</span></span></span></span>;
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (t.equals(<span class="hljs-string"><span class="hljs-string">"home/water_count/spark/set"</span></span>))<font></font>
    {<font></font>
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (message.equalsIgnoreCase(<span class="hljs-string"><span class="hljs-string">"1"</span></span>))<font></font>
        {<font></font>
            Particle.connect();<font></font>
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (waitFor(Particle.connected, <span class="hljs-number"><span class="hljs-number">10000</span></span>)) <font></font>
                {publish_message(<span class="hljs-string"><span class="hljs-string">"home/water_count/spark"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>);}
            <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>
                {Particle.disconnect(); publish_message(<span class="hljs-string"><span class="hljs-string">"home/water_count/spark"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>);}<font></font>
        }<font></font>
        <span class="hljs-keyword"><span class="hljs-keyword">else</span></span><font></font>
        {<font></font>
            Particle.disconnect();<font></font>
            publish_message(<span class="hljs-string"><span class="hljs-string">"home/water_count/spark"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>);<font></font>
        }<font></font>
    }<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (t.startsWith(<span class="hljs-string"><span class="hljs-string">"home/water_count/valve/"</span></span>))<font></font>
    {<font></font>
        <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> m = message.toInt();
        <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x = t.substring(<span class="hljs-number"><span class="hljs-number">23</span></span>,<span class="hljs-number"><span class="hljs-number">24</span></span>).toInt();
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (m &gt; <span class="hljs-number"><span class="hljs-number">-1</span></span> &amp;&amp; m &lt; <span class="hljs-number"><span class="hljs-number">2</span></span> &amp;&amp; x &gt; <span class="hljs-number"><span class="hljs-number">-1</span></span> &amp;&amp; x &lt;<span class="hljs-number"><span class="hljs-number">2</span></span>) <font></font>
        {<font></font>
            set_valve(x, m);<font></font>
        }<font></font>
        <span class="hljs-keyword"><span class="hljs-keyword">else</span></span><font></font>
        {<font></font>
            publish_message(<span class="hljs-string"><span class="hljs-string">"home/water_count/valve/"</span></span> + t.substring(<span class="hljs-number"><span class="hljs-number">23</span></span>,<span class="hljs-number"><span class="hljs-number">24</span></span>),  valve[x].state , <span class="hljs-literal"><span class="hljs-literal">true</span></span>);<font></font>
        }<font></font>
    }<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (t.startsWith(<span class="hljs-string"><span class="hljs-string">"home/water_count/counter/"</span></span>))<font></font>
    {<font></font>
        <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> m = message.toFloat();
        <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x = t.substring(<span class="hljs-number"><span class="hljs-number">25</span></span>,<span class="hljs-number"><span class="hljs-number">26</span></span>).toInt();
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (m &gt; <span class="hljs-number"><span class="hljs-number">-1</span></span> &amp;&amp; m &lt;= <span class="hljs-number"><span class="hljs-number">999999</span></span> &amp;&amp; x &gt; <span class="hljs-number"><span class="hljs-number">-1</span></span> &amp;&amp; x &lt;<span class="hljs-number"><span class="hljs-number">2</span></span>) <font></font>
        {<font></font>
            counter[x].value = m;<font></font>
        }<font></font>
        publish_message(<span class="hljs-string"><span class="hljs-string">"home/water_count/counter/"</span></span> + t.substring(<span class="hljs-number"><span class="hljs-number">25</span></span>,<span class="hljs-number"><span class="hljs-number">26</span></span>),  counter[x].value , <span class="hljs-literal"><span class="hljs-literal">true</span></span>);<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{
<span class="hljs-comment"><span class="hljs-comment">//Serial.begin(9600);</span></span><font></font>
    WiFi.on();<font></font>
    WiFi.connect();<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (waitFor(WiFi.ready, <span class="hljs-number"><span class="hljs-number">5000</span></span>)) {mqtt_connect();}
    <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">2</span></span>; i++) <font></font>
    {<font></font>
        pinMode(valve[i].pin, OUTPUT);<font></font>
        digitalWrite(valve[i].pin, valve[i].state);<font></font>
        pinMode(counter[i].pin, INPUT);<font></font>
        pinMode(sensor[i].pin, INPUT);<font></font>
        counter[i].state = digitalRead(counter[i].pin);<font></font>
        pinMode(pressure[i], AN_INPUT);<font></font>
    }<font></font>
    pinMode(A4, INPUT_PULLUP);<font></font>
<font></font>
    display.begin(SSD1306_SWITCHCAPVCC, <span class="hljs-number"><span class="hljs-number">0x3C</span></span>);  <span class="hljs-comment"><span class="hljs-comment">// initialize with the I2C addr 0x3C (for the 128x64)</span></span>
    display.clearDisplay();   <span class="hljs-comment"><span class="hljs-comment">// clears the screen and buffer</span></span><font></font>
<font></font>
    <span class="hljs-comment"><span class="hljs-comment">//Particle.connect();</span></span><font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> 
</span></span>{<font></font>
    currentMillis = millis();<font></font>
    <span class="hljs-comment"><span class="hljs-comment">//       MQTT </span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentMillis - previous_conected &gt;= <span class="hljs-number"><span class="hljs-number">30000</span></span> || previous_conected &gt; currentMillis)<font></font>
    {<font></font>
        previous_conected = currentMillis;<font></font>
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!client.isConnected() &amp; wifi_uptime &gt; <span class="hljs-number"><span class="hljs-number">60</span></span>)<font></font>
        {<font></font>
            mqtt_connect();<font></font>
        }<font></font>
        publish_message(<span class="hljs-string"><span class="hljs-string">"home/water_count/rssi"</span></span>, WiFi.RSSI(), <span class="hljs-literal"><span class="hljs-literal">true</span></span>);<font></font>
    }<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentMillis - previous_wifi_uptime &gt;= <span class="hljs-number"><span class="hljs-number">1000</span></span> || previous_wifi_uptime &gt; currentMillis)<font></font>
    {<font></font>
        previous_wifi_uptime = currentMillis;<font></font>
        WiFi.ready() ? wifi_uptime++ : wifi_uptime = <span class="hljs-number"><span class="hljs-number">0</span></span>;
        <span class="hljs-comment"><span class="hljs-comment">//work with button and display</span></span>
        <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> fg = digitalRead(A4);
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (display_timeout &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>)<font></font>
        {<font></font>
            display_timeout -= <span class="hljs-number"><span class="hljs-number">1</span></span>;
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (display_timeout == <span class="hljs-number"><span class="hljs-number">0</span></span>) <font></font>
            { <font></font>
                display.clearDisplay();<font></font>
                display.display();<font></font>
            } <font></font>
        }<font></font>
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fg == <span class="hljs-number"><span class="hljs-number">0</span></span>)<font></font>
        {<font></font>
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (display_timeout == <span class="hljs-number"><span class="hljs-number">0</span></span>)<font></font>
            {<font></font>
                display.clearDisplay();   <span class="hljs-comment"><span class="hljs-comment">// clears the screen and buffer</span></span>
                display.setTextSize(<span class="hljs-number"><span class="hljs-number">2</span></span>);<font></font>
                display.setTextColor(WHITE);<font></font>
                display.setCursor(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>);<font></font>
                display.print(<span class="hljs-string"><span class="hljs-string">"C="</span></span>);<font></font>
                display.println(counter[<span class="hljs-number"><span class="hljs-number">0</span></span>].value, <span class="hljs-number"><span class="hljs-number">4</span></span>);<font></font>
                display.setCursor(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">16</span></span>);<font></font>
                display.print(<span class="hljs-string"><span class="hljs-string">"H="</span></span>);<font></font>
                display.println(counter[<span class="hljs-number"><span class="hljs-number">1</span></span>].value, <span class="hljs-number"><span class="hljs-number">4</span></span>);<font></font>
                display.setCursor(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">32</span></span>);<font></font>
                display.print(<span class="hljs-string"><span class="hljs-string">"Valve="</span></span>);<font></font>
                display.print(valve[<span class="hljs-number"><span class="hljs-number">0</span></span>].state);<font></font>
                display.print(<span class="hljs-string"><span class="hljs-string">"|"</span></span>);<font></font>
                display.println(valve[<span class="hljs-number"><span class="hljs-number">1</span></span>].state);<font></font>
                display.setCursor(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">48</span></span>);<font></font>
                display.print(<span class="hljs-string"><span class="hljs-string">"Sensor="</span></span>);<font></font>
                display.print(sensor[<span class="hljs-number"><span class="hljs-number">0</span></span>].state);<font></font>
                display.print(<span class="hljs-string"><span class="hljs-string">"|"</span></span>);<font></font>
                display.println(sensor[<span class="hljs-number"><span class="hljs-number">1</span></span>].state);<font></font>
                display.display();<font></font>
            }<font></font>
            display_timeout = <span class="hljs-number"><span class="hljs-number">10</span></span>;<font></font>
        }<font></font>
    }<font></font>
    <span class="hljs-comment"><span class="hljs-comment">//counter check</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentMillis - previous_counter_read &gt;= <span class="hljs-number"><span class="hljs-number">500</span></span> || previous_counter_read &gt; currentMillis)<font></font>
    {<font></font>
        previous_counter_read = currentMillis;<font></font>
        <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">2</span></span>; i++) <font></font>
        {<font></font>
            byte count_state = digitalRead(counter[i].pin);<font></font>
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count_state != counter[i].state)<font></font>
            {<font></font>
                counter[i].state = count_state;<font></font>
                <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count_state == <span class="hljs-number"><span class="hljs-number">0</span></span>)<font></font>
                {<font></font>
                    counter[i].value += <span class="hljs-number"><span class="hljs-number">0.01</span></span>;
                    <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buf18[<span class="hljs-number"><span class="hljs-number">30</span></span>];
                    <span class="hljs-built_in"><span class="hljs-built_in">sprintf</span></span>(buf18,<span class="hljs-string"><span class="hljs-string">"home/water_count/counter/%d"</span></span>, i);<font></font>
                    publish_message(buf18 , counter[i].value, <span class="hljs-literal"><span class="hljs-literal">true</span></span>);<font></font>
                }<font></font>
            }<font></font>
            <span class="hljs-comment"><span class="hljs-comment">//    </span></span><font></font>
            byte sensor_state = digitalRead(sensor[i].pin);<font></font>
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sensor_state != sensor[i].state) <span class="hljs-comment"><span class="hljs-comment">//</span></span><font></font>
            {<font></font>
                sensor[i].state = sensor_state;<font></font>
                sensor[i].timeout = SENSOR_TIMEOUT; <font></font>
            }<font></font>
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sensor[i].timeout &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <font></font>
            {<font></font>
                sensor[i].timeout -= <span class="hljs-number"><span class="hljs-number">1</span></span>;
                <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sensor[i].timeout == <span class="hljs-number"><span class="hljs-number">0</span></span>)<font></font>
                {<font></font>
                    <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buf18[<span class="hljs-number"><span class="hljs-number">30</span></span>];
                    <span class="hljs-built_in"><span class="hljs-built_in">sprintf</span></span>(buf18,<span class="hljs-string"><span class="hljs-string">"home/water_count/sensor/%d"</span></span>, i);<font></font>
                    publish_message(buf18 , sensor[i].state, <span class="hljs-literal"><span class="hljs-literal">true</span></span>);
                    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sensor[i].state  == <span class="hljs-number"><span class="hljs-number">0</span></span>)<font></font>
                    {<font></font>
                        set_valve(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-comment"><span class="hljs-comment">//close both valve</span></span>
                        set_valve(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-comment"><span class="hljs-comment">//close both valve</span></span><font></font>
                    }<font></font>
                }<font></font>
            }<font></font>
        }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment"><span class="hljs-comment">// temp onewire</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentMillis - start_temp_timer &gt;= <span class="hljs-number"><span class="hljs-number">299000</span></span> || start_temp_timer &gt; currentMillis)<font></font>
    { <span class="hljs-comment"><span class="hljs-comment">// </span></span><font></font>
        start_temp_timer = currentMillis;<font></font>
        presense0 = start_temp0();<font></font>
        presense1 = start_temp1();<font></font>
    }<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentMillis - read_temp_timer &gt;= <span class="hljs-number"><span class="hljs-number">300000</span></span> || read_temp_timer &gt; currentMillis)<font></font>
    {<span class="hljs-comment"><span class="hljs-comment">// </span></span><font></font>
        read_temp_timer = currentMillis;<font></font>
        start_temp_timer = currentMillis;<font></font>
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (presense0) read_temp0();
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (presense1) read_temp1();
        <span class="hljs-comment"><span class="hljs-comment">//preasure calc and send</span></span>
        <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buf18[<span class="hljs-number"><span class="hljs-number">30</span></span>]; 
        <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">2</span></span>; i++)<font></font>
        {<font></font>
            <span class="hljs-built_in"><span class="hljs-built_in">sprintf</span></span>(buf18,<span class="hljs-string"><span class="hljs-string">"home/water_count/pressure/%d"</span></span>, i);
            <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> read_val = analogRead(pressure[i]);
            <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> value = (read_val - <span class="hljs-number"><span class="hljs-number">600.0</span></span>) / <span class="hljs-number"><span class="hljs-number">300.0</span></span> ;<font></font>
            publish_message(buf18 , value, <span class="hljs-literal"><span class="hljs-literal">false</span></span>);<font></font>
        }<font></font>
    }<font></font>
    <span class="hljs-comment"><span class="hljs-comment">//Particle.process();</span></span><font></font>
    client.loop();<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mqtt_connect</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">
</span></span>{
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (client.connect(<span class="hljs-string"><span class="hljs-string">"water_count"</span></span>))<font></font>
    { <span class="hljs-comment"><span class="hljs-comment">//  spark    </span></span>
        client.subscribe(<span class="hljs-string"><span class="hljs-string">"home/water_count/spark/set"</span></span>);<font></font>
        publish_message(<span class="hljs-string"><span class="hljs-string">"home/water_count/spark"</span></span>, Particle.connected() ? <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>);<font></font>
        client.subscribe(<span class="hljs-string"><span class="hljs-string">"home/water_count/valve/+/set"</span></span>);<font></font>
        client.subscribe(<span class="hljs-string"><span class="hljs-string">"home/water_count/counter/+/set"</span></span>);<font></font>
        <font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">start_temp0</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">
</span></span>{<font></font>
    <font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !ds0.search(addr0)) { ds0.reset_search(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>;}<font></font>
    ds0.reset_search();<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (OneWire::crc8(addr0, <span class="hljs-number"><span class="hljs-number">7</span></span>) != addr0[<span class="hljs-number"><span class="hljs-number">7</span></span>]) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>;}<font></font>
    <font></font>
    ds0.reset();<font></font>
    ds0.select(addr0);<font></font>
    ds0.write(<span class="hljs-number"><span class="hljs-number">0x44</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>);
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <font></font>
}<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">start_temp1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">
</span></span>{<font></font>
    <font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !ds1.search(addr1)) { ds1.reset_search(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>;}<font></font>
    ds1.reset_search();<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (OneWire::crc8(addr1, <span class="hljs-number"><span class="hljs-number">7</span></span>) != addr1[<span class="hljs-number"><span class="hljs-number">7</span></span>]) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>;}<font></font>
    <font></font>
    ds1.reset();<font></font>
    ds1.select(addr1);<font></font>
    ds1.write(<span class="hljs-number"><span class="hljs-number">0x44</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>);
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read_temp0</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">
</span></span>{
    <span class="hljs-comment"><span class="hljs-comment">//delay(1000);</span></span><font></font>
    ds0.reset();<font></font>
    ds0.select(addr0);<font></font>
    ds0.write(<span class="hljs-number"><span class="hljs-number">0xBE</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>);<font></font>
<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">9</span></span>; i++) <font></font>
    {<font></font>
        data[i] = ds0.read();<font></font>
    }<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">int16_t</span></span> raw = (data[<span class="hljs-number"><span class="hljs-number">1</span></span>] &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span>) | data[<span class="hljs-number"><span class="hljs-number">0</span></span>];
    <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> celsius = (<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>)raw * <span class="hljs-number"><span class="hljs-number">0.0625</span></span>;
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (celsius &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> || celsius &gt; <span class="hljs-number"><span class="hljs-number">100</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>;<font></font>
    publish_message(<span class="hljs-string"><span class="hljs-string">"home/water_count/temp/0"</span></span>, celsius, <span class="hljs-literal"><span class="hljs-literal">false</span></span>);
    <span class="hljs-comment"><span class="hljs-comment">//Serial.println(celsius);</span></span><font></font>
    ds0.reset_search();<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>;<font></font>
}<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read_temp1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">
</span></span>{
    <span class="hljs-comment"><span class="hljs-comment">//delay(1000);</span></span><font></font>
    ds1.reset();<font></font>
    ds1.select(addr1);<font></font>
    ds1.write(<span class="hljs-number"><span class="hljs-number">0xBE</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>);<font></font>
<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">9</span></span>; i++) <font></font>
    {<font></font>
        data[i] = ds1.read();<font></font>
    }<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">int16_t</span></span> raw = (data[<span class="hljs-number"><span class="hljs-number">1</span></span>] &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span>) | data[<span class="hljs-number"><span class="hljs-number">0</span></span>];
    <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> celsius = (<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>)raw * <span class="hljs-number"><span class="hljs-number">0.0625</span></span>;
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (celsius &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> || celsius &gt; <span class="hljs-number"><span class="hljs-number">100</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>;<font></font>
    publish_message(<span class="hljs-string"><span class="hljs-string">"home/water_count/temp/1"</span></span>, celsius, <span class="hljs-literal"><span class="hljs-literal">false</span></span>);
    <span class="hljs-comment"><span class="hljs-comment">//Serial.println(celsius);</span></span><font></font>
    ds1.reset_search();<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">set_valve</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> vlv, byte state)</span></span></span><span class="hljs-function">
</span></span>{<font></font>
    valve[vlv].state = state;<font></font>
    digitalWrite(valve[vlv].pin, state);<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buf26[<span class="hljs-number"><span class="hljs-number">26</span></span>];
    <span class="hljs-built_in"><span class="hljs-built_in">sprintf</span></span>(buf26,<span class="hljs-string"><span class="hljs-string">"home/water_count/valve/%d"</span></span>, vlv);<font></font>
    publish_message(buf26 , state , <span class="hljs-literal"><span class="hljs-literal">true</span></span>);<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A trav√©s de MQTT nos conectamos con el corredor. </font><font style="vertical-align: inherit;">Monitoree los sensores y el casco en las ramas correspondientes de eventos y valores mqtt. </font><font style="vertical-align: inherit;">Por ejemplo, home / water_count / valve / 0: una unidad de agua. </font><font style="vertical-align: inherit;">home / water_count / counter / 0: lecturas del contador de agua fr√≠a. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nos suscribimos a los comandos para cambiar el estado de la unidad y configurar el valor actual del contador (agua fr√≠a y caliente):</font></font><br>
<br>
<pre><code class="hljs axapta"><span class="hljs-keyword"><span class="hljs-keyword">client</span></span>.subscribe(<span class="hljs-string"><span class="hljs-string">"home/water_count/valve/+/set"</span></span>);
<span class="hljs-keyword"><span class="hljs-keyword">client</span></span>.subscribe(<span class="hljs-string"><span class="hljs-string">"home/water_count/counter/+/set"</span></span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hay un bot√≥n en el dispositivo: al presionar, activamos la pantalla y dibujamos las lecturas actuales de contadores, sensores y toques. Pantalla OLED, se desvanece r√°pidamente si est√° encendida todo el tiempo.</font></font><br>
<br>
<pre><code class="hljs lisp">STARTUP(<span class="hljs-name"><span class="hljs-name">System</span></span>.enableFeature(<span class="hljs-name"><span class="hljs-name">FEATURE_RETAINED_MEMORY</span></span>))<span class="hljs-comment"><span class="hljs-comment">;</span></span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esta es una caracter√≠stica interesante de hardware y software del controlador stm, en la Part√≠cula de referencia lo llaman BackupSRAM. El fot√≥n tiene una salida vbat; esto no es energ√≠a de la bater√≠a ni carga. Mientras haya voltaje en este tramo, el contenido de 4k bytes de SRAM se mantiene con el controlador completamente desenergizado. Esto elimina el problema del desgaste de la EEPROM. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el c√≥digo, las variables que deben introducirse en esta memoria se declaran con la indicaci√≥n: retenidas. Implement√© hardware del supercondensador a 1.5F. De acuerdo con la hoja de datos, la memoria morir√° a 1.6v, de acuerdo con mis experimentos de banco en el protoboard, vendr√° en 2 semanas con aproximadamente mi condensador. La l√≥gica de cerrar las gr√∫as cuando se activan los sensores es "aut√≥noma" y no depende de la conexi√≥n a openhab. Hay un interruptor de 3 v√≠as para el control de accionamiento directo: autom√°tico, apagado (grifos abiertos), cierre (cierre).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El diagrama de circuito a continuaci√≥n: </font></font><br>
<br>
<img src="https://habrastorage.org/files/1a8/f4c/63d/1a8f4c63dba34f4e9905b703fabad0fd.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
el proyecto Eagle, junto con las bibliotecas personalizadas, se puede descargar </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqu√≠</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La tarifa se hizo LUT, en las pistas no se redujo.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ba√±o de agua El mejor amigo de LUT</font></font></b><div class="spoiler_text"><img src="https://habrastorage.org/files/351/e37/1c3/351e371c3caf487d9f14f839f89402be.jpg"><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unidad de fuente de alimentaci√≥n. </font><font style="vertical-align: inherit;">Necesitamos 12 y 5 voltios. </font><font style="vertical-align: inherit;">Se busca en el donante en eBay la l√≠nea: "adaptador de alimentaci√≥n del disco duro 5v 12v", como </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">este</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vivienda</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fue impreso con pl√°stico PLA en una impresora 3D (Tar√°ntula Tevo). </font><font style="vertical-align: inherit;">Boquilla 0.4mm, capa 0.25mm. </font><font style="vertical-align: inherit;">La cubierta es al mismo tiempo y la base para montar la placa del controlador. </font><font style="vertical-align: inherit;">La base con la fuente de alimentaci√≥n est√° unida a la pared. </font><font style="vertical-align: inherit;">La base con la tapa no est√° sujeta con tornillos, hay suficiente tensi√≥n de la tapa (como la tapa de la abuela en frascos de mermelada) y la estructura en capas de las paredes funciona. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Modelo 3D en el </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">archivo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/files/945/110/37d/94511037d3734ad1a573e84e5fc426ef.png"><br>
<br>
<img src="https://habrastorage.org/files/5aa/546/c0b/5aa546c0b6dd41d58fd6b33bde08df74.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As√≠ es como se ve todo montado en una tuber√≠a de agua.</font></font><br>
<br>
<img src="https://habrastorage.org/files/cfb/293/f66/cfb293f66c3f4bb9ad2f46e812418918.jpg"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Openhab</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Desplegado en Orange Pi One bajo Armbian.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuraci√≥n del art√≠culo</font></font></b><div class="spoiler_text"><pre><code class="hljs julia">  -    ,  .
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_temp1	<span class="hljs-string"><span class="hljs-string">"T cool [%.1f ¬∞C]"</span></span>			(gWaterCount)		{ mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/temp1:state:default]"</span></span> }
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_temp2	<span class="hljs-string"><span class="hljs-string">"T hot [%.1f ¬∞C]"</span></span>			(gWaterCount)		{ mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/temp2:state:default]"</span></span> }
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_count0	<span class="hljs-string"><span class="hljs-string">"Count cool [%.2f ¬≥]"</span></span>					(gWaterCount)		{ mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/counter/0:state:default]"</span></span> }
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_count1	<span class="hljs-string"><span class="hljs-string">"Count hot [%.2f ¬≥]"</span></span>				(gWaterCount)		{ mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/counter/1:state:default]"</span></span> }
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_pressure0	<span class="hljs-string"><span class="hljs-string">"P cool [%.2f .]"</span></span>			(gWaterCount)		{ mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/pressure/0:state:default]"</span></span> }
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_pressure1	<span class="hljs-string"><span class="hljs-string">"P hot [%.2f .]"</span></span>				(gWaterCount)		{ mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/pressure/1:state:default]"</span></span> }
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_sensor0	<span class="hljs-string"><span class="hljs-string">"Sensor0 is [MAP(water_sensor.map):%s]"</span></span>		(gWaterCount)		{ mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/sensor/0:state:default]"</span></span> }
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_sensor1	<span class="hljs-string"><span class="hljs-string">"Sensor1 is [MAP(water_sensor.map):%s]"</span></span>		(gWaterCount)		{ mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/sensor/1:state:default]"</span></span> }
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_valve0	<span class="hljs-string"><span class="hljs-string">"Valve cool"</span></span>		(gWaterCount)		{ mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/valve/0:state:default], &gt;[mqtt_bro:home/water_count/valve/0/set:command:*:default]"</span></span> }
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_valve1	<span class="hljs-string"><span class="hljs-string">"Valve hot"</span></span>				(gWaterCount)		{ mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/valve/1:state:default], &gt;[mqtt_bro:home/water_count/valve/1/set:command:*:default]"</span></span> }
<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>	watercount_sendStr <span class="hljs-string"><span class="hljs-string">"LastVol:[%s]"</span></span>						(gWaterCount)
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_sendCool <span class="hljs-string"><span class="hljs-string">"Send cool [%.2f ¬≥]"</span></span>		(gWaterCount)
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_sendHot <span class="hljs-string"><span class="hljs-string">"Send hot [%.2f ¬≥]"</span></span>			(gWaterCount)
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_sendSwitch <span class="hljs-string"><span class="hljs-string">"Autosend"</span></span> 	(gWaterCount)
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_rssi	<span class="hljs-string"><span class="hljs-string">"WaterCount [%d dB]"</span></span>	(gSpark_RSSI)		{ mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/rssi:state:default]"</span></span> }
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_spark_state	<span class="hljs-string"><span class="hljs-string">"WaterCount Spark"</span></span>		(gSpark)		{ mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/spark:state:default], &gt;[mqtt_bro:home/water_count/spark/set:command:*:default]"</span></span> }</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se necesita una peque√±a regla de transformaci√≥n para el sensor de fugas.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Las configuraciones se transforman</font></font></b><div class="spoiler_text"><b>transform\water_sensor.map </b><br>
1=dry<br>
0=wet<br>
undefined=undefined<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Formamos la p√°gina para la gesti√≥n:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configs Sitemap</font></font></b><div class="spoiler_text"><b>Sitemap</b><br>
Text label=¬´¬ª icon=¬´water¬ª <br>
 {<br>
 Frame <br>
 {<br>
 Text item=watercount_temp1<br>
 Text item=watercount_count0<br>
 Text item=watercount_pressure0<br>
 Switch item=watercount_valve0 mappings=[1=¬´Close¬ª, 0=¬´Open¬ª]<br>
 }<br>
 Frame <br>
 {<br>
 Text item=watercount_temp2<br>
 Text item=watercount_count1<br>
 Text item=watercount_pressure1<br>
 Switch item=watercount_valve1 mappings=[1=¬´Close¬ª, 0=¬´Open¬ª]<br>
 }<br>
 Frame <br>
 {<br>
 Text item=watercount_sensor0<br>
 Text item=watercount_sensor1 <br>
 }<br>
 Frame <br>
 {<br>
 Switch item=watercount_sendSwitch mappings=[0=¬´OFF¬ª, 1=¬´ON¬ª]<br>
 Text item=watercount_sendStr<br>
 Text item=watercount_sendCool<br>
 Text item=watercount_sendHot<br>
 }<br>
 } <br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y reglas de procesamiento:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reglas de configuraci√≥n</font></font></b><div class="spoiler_text"><pre><code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> "Check watercount_sensor0"
	<span class="hljs-keyword"><span class="hljs-keyword">when</span></span>
		Item watercount_sensor0 received <span class="hljs-keyword"><span class="hljs-keyword">update</span></span>
	<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_sensor0.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) == <span class="hljs-number"><span class="hljs-number">1</span></span>)<font></font>
		{<font></font>
			<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_sensor0.historicState(now.minusSeconds(<span class="hljs-number"><span class="hljs-number">3</span></span>)).state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) == <span class="hljs-number"><span class="hljs-number">1</span></span>)<font></font>
			{<font></font>
				sendTelegram("****_bot", "Sensor0 was wet less than 5 seconds")<font></font>
			}<font></font>
			<span class="hljs-keyword"><span class="hljs-keyword">else</span></span><font></font>
			{<font></font>
				sendTelegram("****_bot", "Sensor0 become dry")<font></font>
			}<font></font>
		}<font></font>
		<span class="hljs-keyword"><span class="hljs-keyword">else</span></span><font></font>
		{<font></font>
			<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_sensor0.historicState(now.minusSeconds(<span class="hljs-number"><span class="hljs-number">3</span></span>)).state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) == <span class="hljs-number"><span class="hljs-number">0</span></span>)<font></font>
			{<font></font>
				sendTelegram("****_bot", "Sensor0 was dry less than 5 seconds");			<font></font>
			}<font></font>
			<span class="hljs-keyword"><span class="hljs-keyword">else</span></span><font></font>
			{<font></font>
				sendTelegram("****_bot", "Sensor0 become wet! Valves will be closed!")<font></font>
			}<font></font>
		}<font></font>
	<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> "Check watercount_sensor1"
	<span class="hljs-keyword"><span class="hljs-keyword">when</span></span>
		Item watercount_sensor1 received <span class="hljs-keyword"><span class="hljs-keyword">update</span></span>
	<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_sensor1.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) == <span class="hljs-number"><span class="hljs-number">1</span></span>)<font></font>
		{<font></font>
			<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_sensor1.historicState(now.minusSeconds(<span class="hljs-number"><span class="hljs-number">3</span></span>)).state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) == <span class="hljs-number"><span class="hljs-number">1</span></span>)<font></font>
			{<font></font>
				sendTelegram("****_bot", "Sensor1 was wet less than 5 seconds")<font></font>
			}<font></font>
			<span class="hljs-keyword"><span class="hljs-keyword">else</span></span><font></font>
			{<font></font>
				sendTelegram("****_bot", "Sensor1 become dry")<font></font>
			}<font></font>
		}<font></font>
		<span class="hljs-keyword"><span class="hljs-keyword">else</span></span><font></font>
		{<font></font>
			<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_sensor1.historicState(now.minusSeconds(<span class="hljs-number"><span class="hljs-number">3</span></span>)).state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) == <span class="hljs-number"><span class="hljs-number">0</span></span>)<font></font>
			{<font></font>
				sendTelegram("****_bot", "Sensor1 was dry less than 5 seconds");			<font></font>
			}<font></font>
			<span class="hljs-keyword"><span class="hljs-keyword">else</span></span><font></font>
			{<font></font>
				sendTelegram("****_bot", "Sensor1 become wet! Valves will be closed!")<font></font>
			}<font></font>
		}<font></font>
	<span class="hljs-keyword"><span class="hljs-keyword">end</span></span><font></font>
	<font></font>
<span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> "Check watercount_temp2"
	<span class="hljs-keyword"><span class="hljs-keyword">when</span></span>
		Item watercount_temp2 received <span class="hljs-keyword"><span class="hljs-keyword">update</span></span>
	<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_temp2.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) &lt; <span class="hljs-number"><span class="hljs-number">37</span></span> )<font></font>
		{<font></font>
			sendTelegram("****_bot", String::format("Hot water temp drop to %s", watercount_temp2.state.toString));<font></font>
		}<font></font>
	<span class="hljs-keyword"><span class="hljs-keyword">end</span></span><font></font>
<font></font>
<span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> "Check watercount_pressure0"
	<span class="hljs-keyword"><span class="hljs-keyword">when</span></span>
		Item watercount_pressure0 received <span class="hljs-keyword"><span class="hljs-keyword">update</span></span>
	<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_pressure0.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) &lt; <span class="hljs-number"><span class="hljs-number">1</span></span> &amp;&amp; (watercount_pressure0.historicState(now.minusSeconds(<span class="hljs-number"><span class="hljs-number">3</span></span>)).state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) &gt;= <span class="hljs-number"><span class="hljs-number">1</span></span>)<font></font>
		{<font></font>
			sendTelegram("****_bot", String::format("Cool pressure drop to %s", watercount_pressure0.state.toString));<font></font>
		}<font></font>
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_pressure0.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) &gt; <span class="hljs-number"><span class="hljs-number">1</span></span> &amp;&amp; (watercount_pressure0.historicState(now.minusSeconds(<span class="hljs-number"><span class="hljs-number">3</span></span>)).state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) &lt;= <span class="hljs-number"><span class="hljs-number">1</span></span>)<font></font>
		{<font></font>
			sendTelegram("****_bot", String::format("Cool pressure rise to %s", watercount_pressure0.state.toString));<font></font>
		}<font></font>
	<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> "Check watercount_pressure1"
	<span class="hljs-keyword"><span class="hljs-keyword">when</span></span>
		Item watercount_pressure1 received <span class="hljs-keyword"><span class="hljs-keyword">update</span></span>
	<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_pressure1.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) &lt; <span class="hljs-number"><span class="hljs-number">1</span></span> &amp;&amp; (watercount_pressure1.historicState(now.minusSeconds(<span class="hljs-number"><span class="hljs-number">3</span></span>)).state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) &gt;= <span class="hljs-number"><span class="hljs-number">1</span></span>)<font></font>
		{<font></font>
			sendTelegram("****_bot", String::format("Hot pressure drop to %s", watercount_pressure1.state.toString));<font></font>
		}<font></font>
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_pressure1.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) &gt; <span class="hljs-number"><span class="hljs-number">1</span></span> &amp;&amp; (watercount_pressure1.historicState(now.minusSeconds(<span class="hljs-number"><span class="hljs-number">3</span></span>)).state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) &lt;= <span class="hljs-number"><span class="hljs-number">1</span></span>)<font></font>
		{<font></font>
			sendTelegram("****_bot", String::format("Hot pressure rise to %s", watercount_pressure1.state.toString));<font></font>
		}<font></font>
	<span class="hljs-keyword"><span class="hljs-keyword">end</span></span><font></font>
<font></font>
<span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> "Generate send string counters" //every <span class="hljs-number"><span class="hljs-number">24</span></span> day <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> mounth  <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">00.01</span></span> minutes
	<span class="hljs-keyword"><span class="hljs-keyword">when</span></span>
		<span class="hljs-type"><span class="hljs-type">Time</span></span> cron "0 0 1 24 1/1 ?" 
	<span class="hljs-keyword"><span class="hljs-keyword">then</span></span><font></font>
		<font></font>
		var <span class="hljs-type"><span class="hljs-type">float</span></span> deltaCool = (watercount_count0.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType).floatValue() - (watercount_sendCool.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType).floatValue()<font></font>
		var <span class="hljs-type"><span class="hljs-type">float</span></span> deltaHot = (watercount_count1.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType).floatValue() - (watercount_sendHot.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType).floatValue()<font></font>
		<font></font>
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (deltaCool &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; deltaHot &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>)<font></font>
		{<font></font>
			watercount_sendStr.postUpdate(String::format(" %.2f / %.2f 3", deltaCool, deltaHot))<font></font>
			watercount_sendCool.state = watercount_count0.state<font></font>
			watercount_sendHot.state = watercount_count1.state<font></font>
			sendTelegram("****_bot", String::format(" 23,  5, . 23.  ‚Ññ2560097 (.) = %.2f 3. C ‚Ññ2538996 (.) = %.2f 3. %s", (watercount_sendCool.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType).floatValue(), (watercount_sendHot.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType).floatValue(), watercount_sendStr.state.toString()))<font></font>
		}<font></font>
		<span class="hljs-keyword"><span class="hljs-keyword">else</span></span><font></font>
		{<font></font>
			watercount_sendSwitch.postUpdate(<span class="hljs-number"><span class="hljs-number">0</span></span>)<font></font>
			sendTelegram("****_bot", "Current counters value less than sended last time. Turn off autosend.")<font></font>
		}<font></font>
<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> "Send string counters" 
	<span class="hljs-keyword"><span class="hljs-keyword">when</span></span>
		<span class="hljs-type"><span class="hljs-type">Time</span></span> cron "0 0 23 24 1/1 ?"
	<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (watercount_sendSwitch.state == <span class="hljs-number"><span class="hljs-number">1</span></span>)<font></font>
		{<font></font>
			sendMail("uk@uk.ru", " 23,  5, . 23", String::format(" 23,  5, . 23.  ‚Ññ2560097 (.) = %.2f 3. C ‚Ññ2538996 (.) = %.2f 3", (watercount_sendCool.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType).floatValue(), (watercount_sendHot.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType).floatValue()));<font></font>
			sendTelegram("****_bot", "Send email with watercount values");<font></font>
		}<font></font>
		<span class="hljs-keyword"><span class="hljs-keyword">else</span></span><font></font>
		{<font></font>
			sendTelegram("****_bot", "Can't send email with watercount values - autosend is OFF.");<font></font>
		}<font></font>
<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> "Rotate valves" 
	<span class="hljs-keyword"><span class="hljs-keyword">when</span></span>
		<span class="hljs-type"><span class="hljs-type">Time</span></span> cron "0 0 05 25 1/1 ?"
	<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (watercount_valve0.state == <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; watercount_valve1.state == <span class="hljs-number"><span class="hljs-number">0</span></span>)<font></font>
		{	<font></font>
			watercount_valve0.postUpdate(<span class="hljs-number"><span class="hljs-number">1</span></span>)<font></font>
			Thread::sleep(<span class="hljs-number"><span class="hljs-number">1000</span></span>)<font></font>
			watercount_valve1.postUpdate(<span class="hljs-number"><span class="hljs-number">1</span></span>)<font></font>
			Thread::sleep(<span class="hljs-number"><span class="hljs-number">1000</span></span>)<font></font>
			watercount_valve0.postUpdate(<span class="hljs-number"><span class="hljs-number">0</span></span>)<font></font>
			Thread::sleep(<span class="hljs-number"><span class="hljs-number">1000</span></span>)<font></font>
			watercount_valve1.postUpdate(<span class="hljs-number"><span class="hljs-number">0</span></span>)<font></font>
			sendTelegram("****_bot", "Valves was rotated.");<font></font>
		}<font></font>
		<span class="hljs-keyword"><span class="hljs-keyword">else</span></span><font></font>
		{<font></font>
			sendTelegram("****_bot", "Can't rotate valves, it's closed.");<font></font>
		}<font></font>
<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para enviar mensajes, no utilizo la funcionalidad integrada de la aplicaci√≥n de Android Openhab, ni me integro con su nube. </font><font style="vertical-align: inherit;">Me gusta el bot de Telegram. </font><font style="vertical-align: inherit;">C√≥mo configurar y conectar el bot se puede ver en la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wiki</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Para enviar cartas desde el buz√≥n de correo de gmail, si tiene autenticaci√≥n de dos factores, debe habilitar una contrase√±a √∫nica para la aplicaci√≥n de correo y establecer esta contrase√±a en la configuraci√≥n de openhab. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Camina por las reglas. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comprobar sensor_cuenta_agua</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- el controlador env√≠a nuevos valores del sensor de fugas solo cuando se cambia el valor o si hubo una falsa alarma (menos de 10 ciclos). Analizamos el significado hist√≥rico y surgido, formamos mensajes informativos. Hay un matiz, un intento de obtener prevoiusItem constantemente da el valor actual, no he encontrado una soluci√≥n, tomo el valor "-3 segundos", si alguien lo super√≥, escr√≠balo en comentarios o en PM. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comprobar watercount_temp2</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : compruebe si hay menos de 37, lo que significa que el agua caliente se ha enfriado, debe encender el calentador de flujo a su llegada. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Compruebe watercount_pressure</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : analizamos el valor actual y el anterior, respondemos con un mensaje a una ca√≠da por debajo de 1 atm y un crecimiento por encima de √©l. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Generar contadores de cadena de env√≠o</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- comienza en cron el 24 de cada mes a la 1 de la ma√±ana. Verificamos que los valores ahora sean mayores que los enviados la √∫ltima vez. Si es menos, apague el env√≠o autom√°tico y genere una alerta. Si est√° bien, recordamos los valores de los contadores para enviar al C√≥digo Penal, enviamos el cuerpo del mensaje futuro al telegrama. Al mismo tiempo, ahorramos en watercount_sendStr cu√°nto consumimos durante el mes pasado. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Generar contadores de cadena de env√≠o</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : comienza en cron el d√≠a 24 a las 23.00. Comprueba si el env√≠o autom√°tico est√° habilitado, si est√° activado: el casco env√≠a contadores al correo de la compa√±√≠a de env√≠o. Resulta que tengo el d√≠a 24 todo el d√≠a, algo para arreglar o simplemente reducir el env√≠o autom√°tico, si se produjo un error en los telegramas. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Actualizaci√≥n por comentario</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rotar las v√°lvulas</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- La regla para cerrar / abrir el grifo una vez al mes contra la ebullici√≥n. </font><font style="vertical-align: inherit;">El d√≠a 25 a las 5 am, para no entrar en el trabajo del lavavajillas o la lavadora, pero incluso si llega all√≠, no es cr√≠tico, el agua se cerrar√° durante unos 3-4 segundos. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Y solo aqu√≠ comienza la casa inteligente ... La</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
combinaci√≥n de sistemas en un solo punto (openhab) le permite construir una l√≥gica que no est√° disponible para un conjunto de sistemas aut√≥nomos. </font><font style="vertical-align: inherit;">Por ejemplo: ha llegado un evento de aumento en el medidor de agua: el sistema de seguridad est√° activo, las cerraduras de la puerta delantera est√°n cerradas, el consumo de energ√≠a del lavavajillas y la lavadora es inferior a 5 vatios, lo que significa que se detecta una fuga por parte de los sensores. </font><font style="vertical-align: inherit;">Formamos un comando para cerrar las gr√∫as, enviamos un mensaje al bot en el Telegram. </font><font style="vertical-align: inherit;">Pero esto es como un hilo m√°s tarde.</font></font></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es399459/">https://habr.com/ru/post/es399459/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es399449/index.html">El ADN es solo la mitad del tama√±o de los cromosomas. Todo lo dem√°s es una c√°scara de funcionalidad desconocida.</a></li>
<li><a href="../es399451/index.html">¬øPor qu√© no tenemos recuerdos infantiles?</a></li>
<li><a href="../es399453/index.html">Cinco formas de dinero blockchain disponibles ahora</a></li>
<li><a href="../es399455/index.html">No solo electrodom√©sticos: ¬øqu√© m√°s hay en Audiomania para amantes de la m√∫sica, amantes y m√∫sicos?</a></li>
<li><a href="../es399457/index.html">Russian FinTech Meetup # 2: Trading in the Digital Age</a></li>
<li><a href="../es399461/index.html">La inteligencia artificial ayudar√° a las personas a deshacerse de las fobias y los miedos.</a></li>
<li><a href="../es399463/index.html">Multicopter aprendi√≥ a sentarse en los techos de autom√≥viles en movimiento</a></li>
<li><a href="../es399469/index.html">La red neuronal de Pix2pix colorea realista bocetos a l√°piz y fotos en blanco y negro</a></li>
<li><a href="../es399471/index.html">Viviendas espaciales, parte 5: c√≥mo viviremos en Mercurio (o no)</a></li>
<li><a href="../es399473/index.html">Chip Intel 4004 cumpli√≥ 45 a√±os. Un poco de historia de TI</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>