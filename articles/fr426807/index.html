<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚úùÔ∏è üíï üé∂ √âcriture du syst√®me d'exploitation: multit√¢che üîÉ üéóÔ∏è üçª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, cher lecteur, tr√®s probablement, vous avez vu mon article pr√©c√©dent que vous pouvez vous-m√™me √©crire un syst√®me d'exploitation r√©alisable dan...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>√âcriture du syst√®me d'exploitation: multit√¢che</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/426807/"><img src="https://habrastorage.org/webt/dh/hl/fa/dhhlfalcgjm7ig8emfavk3uoji8.png" alt="image"><br>  Bonjour, cher lecteur, tr√®s probablement, vous avez vu mon article pr√©c√©dent que vous pouvez vous-m√™me √©crire un syst√®me d'exploitation r√©alisable dans un laps de temps assez court.  Eh bien, aujourd'hui, nous allons parler de la mise en ≈ìuvre du multit√¢che dans mon syst√®me d'exploitation. <a name="habracut"></a><br><br>  Eh bien, vous ne pouvez probablement pas imaginer un syst√®me d'exploitation unique en 2018, j'ai donc d√©cid√© de parler de la mise en ≈ìuvre du multit√¢che dans mon syst√®me d'exploitation.  Et donc, premi√®re chose - vous devez d√©cider du type de multit√¢che, j'ai choisi la pr√©emption. <br>  Comment est-elle?  Le multit√¢che pr√©emptif est un syst√®me de r√©partition de la puissance de calcul du processeur entre les processus: chacun a sa propre tranche de temps, chacun a sa propre priorit√©.  Et le premier probl√®me est quel quantum choisir en longueur, comment arr√™ter le processus de s'ex√©cuter apr√®s l'expiration du quantum?  En fait, tout est plus facile que jamais!  Nous utiliserons PIT avec la fr√©quence initialement fix√©e √† 10026 avec un sou d'interruptions par seconde, l√† nous r√©solvons un probl√®me de plus: nous arr√™tons d√©j√† le processus pr√©c√©dent.  Et donc, commen√ßons par PIT. <br><br><h2>  Fosse </h2><br>  PIT - Programmable Interval Timer - un compteur qui, lorsqu'il atteint un nombre d'incr√©ments programm√©, donne un signal.  En outre, en utilisant cette minuterie, vous pouvez grincer un grincement dans l'ordinateur (la chose qui grince apr√®s avoir pass√© le test de l'appareil).  Et donc, il compte √† une fr√©quence de 1193182 hertz, ce qui signifie que nous devons le programmer √† 119 (1193182/119 est approximativement √©gal √† 10026).  Pour ce faire, envoyez 2 octets au port du premier g√©n√©rateur, d'abord l'octet bas, puis le haut: <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> hz = <span class="hljs-number"><span class="hljs-number">119</span></span>; outportb(<span class="hljs-number"><span class="hljs-number">0x43</span></span>, <span class="hljs-number"><span class="hljs-number">0x34</span></span>); outportb(<span class="hljs-number"><span class="hljs-number">0x40</span></span>, (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>)hz &amp; <span class="hljs-number"><span class="hljs-number">0xFF</span></span>); <span class="hljs-comment"><span class="hljs-comment">//Low outportb(0x40, (unsigned char)(hz &gt;&gt; 8) &amp; 0xFF); //Hight, about 10026 times per second</span></span></code> </pre> <br><br>  Maintenant, cela vaut la peine de commencer la programmation de l'interruption √† partir de PIT, elle a un IRQ de 0, et apr√®s le remappage de PIC, ce sera 0x20m.  Pour l'IRQ du premier PIC, j'ai √©crit cette macro: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//PIC#0; port 0x20 #define IRQ_HANDLER(func) char func = 0x90;\ __asm__(#func ": \npusha \n call __"#func " \n movb $0x20,\ %al \n outb %al, $0x20 \n popa \n iret \n");\ void _## func()</span></span></code> </pre> <br><br><h2>  Structure et processus </h2><br>  Et donc, comme vous le comprenez, nous devons d√©velopper une structure pour chaque processus, ainsi qu'une structure qui me permette de me souvenir de toutes mes allocations de m√©moire. <br>  Voici ce que j'ai: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> _</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pralloc</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> * addr; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> _</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pralloc</span></span></span><span class="hljs-class"> * </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next</span></span></span><span class="hljs-class">;</span></span> } processAlloc; <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> * entry; processAlloc *allocs; } ELF_Process; <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> __</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attribute__</span></span></span><span class="hljs-class">((</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">packed</span></span></span><span class="hljs-class">)) _</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">E</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> eax;<span class="hljs-comment"><span class="hljs-comment">//4 unsigned int ebx;//8 unsigned int ecx;//12 unsigned int edx;//16 unsigned int ebp;//20 unsigned int esp;//24 unsigned int esi;//28 unsigned int edi;//32 unsigned int eflags;//36 unsigned int state;//40 void * startAddr;//44 void * currentAddr;//48 void * stack;//52 unsigned int sse[4 * 8];// unsigned int mmx[2 * 8];//244 unsigned int priority;//248 unsigned int priorityL;//252 void * elf_process;//256 char ** argv;//260 unsigned int argc;//264 unsigned int runnedFrom;//268 char * workingDir;//272 unsigned int cs;//276 - pop is 4 byte in IRET unsigned int ds;//280 } Process;</span></span></code> </pre><br><br>  Pour commencer, nous devons comprendre ce qui suit: nous pouvons quelque part √† l'adresse globale, par exemple, √† 0xDEAD mettre le num√©ro du processus en cours d'ex√©cution, puis lors de l'ex√©cution de tout code, nous pouvons √™tre s√ªrs: nous avons le num√©ro du processus en cours d'ex√©cution, cela signifie que lors de l'acc√®s √† malloc, nous savons √† qui nous allouons de la m√©moire et nous pouvons imm√©diatement ajouter l'adresse de la m√©moire allou√©e √† la liste des allocations. <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addProcessAlloc</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ELF_Process * p, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * addr)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> * z = p-&gt;allocs; p-&gt;allocs = malloc_wo_adding_to_process(<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(processAlloc)); p-&gt;allocs-&gt;addr = addr; p-&gt;allocs-&gt;next = z; }</code> </pre> <br><br>  Eh bien, nous avons √©crit la structure du tableau avec la description des processus, que faire ensuite, comment changer de t√¢che? <br>  Pour commencer, je veux noter que, par exemple, dans le gestionnaire, les variables locales sont stock√©es sur la pile, ce qui signifie qu'apr√®s √™tre entr√© dans le gestionnaire, le compilateur nous g√¢te esp.  Pour √©viter cela, cr√©ez une variable avec une adresse absolue, et avant d'appeler le gestionnaire, nous y mettrons l'ESP.  Dans le gestionnaire, nous devons envoyer l'EOI au premier PIC et trouver le processus vers lequel nous devons basculer (je ne d√©crirai pas le m√©canisme de priorit√©: c'est simple, comme un embouteillage).  Ensuite - nous devons sauvegarder tous les registres et drapeaux du processus en cours, donc juste avant de placer l'ESP dans une variable, nous enregistrerons tous les registres (y compris ceux du segment) sur la pile.  Dans le gestionnaire lui-m√™me, nous devons tr√®s soigneusement les supprimer de la pile, tout en pr√©servant les indicateurs et l'adresse de retour.  Je veux noter que la pile augmente (c'est-√†-dire que ESP diminue), ce qui signifie que le dernier registre que vous avez enregistr√© sur la pile sera √† ESP, l'avant-dernier sera ESP +4, etc.: <br><img src="https://habrastorage.org/webt/jz/ab/8j/jzab8jy-woe0_y1qpngddrl6pfi.png" alt="image"><br>  Il nous reste maintenant √† mettre les valeurs des registres de processus dans les registres vers lesquels nous sommes pass√©s et ex√©cutons IRET.  Profit! <br><br><h2>  D√©but du processus </h2><br>  Au d√©marrage du processus, il nous suffit d'allouer la pile pour le processus, puis d'y mettre argc et argv, l'adresse de la fonction qui recevra le contr√¥le une fois le processus termin√©.  Vous devez √©galement d√©finir les drapeaux du processeur √† la valeur dont vous avez besoin, par exemple, pour mon syst√®me d'exploitation, c'est 0x216, vous pouvez lire sur le registre des drapeaux sur Wikipedia. <br><br>  En fin de compte, je veux vous souhaiter beaucoup de succ√®s, je vous √©crirai bient√¥t sur la m√©moire et d'autres articles qui vous int√©ressent. <br>  Bonne chance et piratage √©thique! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr426807/">https://habr.com/ru/post/fr426807/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr426793/index.html">DotNext - il y a d'autres h√©ros</a></li>
<li><a href="../fr426797/index.html">R√©seau de neurones utilisant TensorFlow: classification d'images</a></li>
<li><a href="../fr426799/index.html">Avez-vous vraiment besoin d'une autorisation de confier ou de laravel pour mettre en ≈ìuvre votre autorisation?</a></li>
<li><a href="../fr426803/index.html">Un aper√ßu des techniques d'adaptation de domaine approfondi de base (partie 1)</a></li>
<li><a href="../fr426805/index.html">Amortisseurs, roulements de roue, freins, moteurs √©lectriques - futures sources de chaleur pour les voitures √©lectriques?</a></li>
<li><a href="../fr426809/index.html">Zeev Surasky: L'avenir du moteur et du framework Zend</a></li>
<li><a href="../fr426811/index.html">Parkour, danse et travaux de construction de Boston Dynamics</a></li>
<li><a href="../fr426813/index.html">? Skype est devenu un semblant ennuyeux ... et un produit qui vous permet d'avoir un acc√®s complet √† votre syst√®me? Y a-t-il un espoir?</a></li>
<li><a href="../fr426815/index.html">Comment obtenir une bourse de d√©veloppement de projet si vous √™tes un √©tudiant pauvre? Et √ßa vaut le coup</a></li>
<li><a href="../fr426817/index.html">Cl√©s priv√©es et API Web CommuniGate Pro</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>