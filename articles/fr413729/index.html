<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üïü üë® üìõ Comment et pourquoi nous avons √©crit notre ECS üôá üïë üöø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans un article pr√©c√©dent, j'ai d√©crit les technologies et les approches que nous utilisons lors du d√©veloppement d'un nouveau jeu de tir mobile rapid...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment et pourquoi nous avons √©crit notre ECS</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pixonic/blog/413729/">  Dans un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article pr√©c√©dent,</a> j'ai d√©crit les technologies et les approches que nous utilisons lors du d√©veloppement d'un nouveau jeu de tir mobile rapide.  Parce que  c'√©tait une revue et m√™me un article superficiel - aujourd'hui, je vais approfondir et expliquer en d√©tail pourquoi nous avons d√©cid√© d'√©crire notre propre framework ECS et n'avons pas utilis√© ceux existants.  Il y aura des exemples de code et un petit bonus √† la fin. <br><img src="https://habrastorage.org/webt/qn/lg/zw/qnlgzwthwpjkkzzeeilv257iiga.png"><br><a name="habracut"></a><br><h3>  Qu'est-ce que l'ECS √† titre d'exemple </h3><br>  J'ai d√©j√† bri√®vement d√©crit ce qu'est Entity Component System, et il y a des articles sur Habr√© √† propos d'ECS (en gros, cependant, des traductions d'articles - voir ma revue des plus int√©ressants d'entre eux √† la fin de l'article, en bonus).  Et aujourd'hui, je vais vous dire comment nous utilisons ECS - en utilisant notre exemple de code. <br><br>  Le diagramme ci-dessus d√©crit l'essence du lecteur, ses composants et leurs donn√©es, ainsi que les syst√®mes qui fonctionnent avec le lecteur et ses composants.  L'objet cl√© du diagramme est le joueur: <br><br><ul><li>  peut se d√©placer dans l'espace - Composants <i>Transform</i> et <i>Movement</i> , <i>MoveSystem</i> ; </li><li>  a une certaine sant√© et peut mourir - composant <i>Health</i> , <i>Damage</i> , <i>DamageSystem</i> ; </li><li>  apr√®s la mort appara√Æt au point de r√©apparition - le composant <i>Transformer</i> pour la position, le <i>RespawnSystem</i> ; </li><li>  peut √™tre invuln√©rable - composant <i>Invincible</i> . </li></ul><br>  Nous d√©crivons cela avec un code.  Tout d'abord, obtenons des interfaces pour les composants et les syst√®mes.  Les composants peuvent avoir des m√©thodes auxiliaires communes, le syst√®me n'a qu'une seule m√©thode <i>Execute</i> , qui re√ßoit l'√©tat du monde √† l'entr√©e pour le traitement: <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IComponent</span></span> { <span class="hljs-comment"><span class="hljs-comment">// &lt; &gt; } public interface ISystem { void Execute(GameState gs); }</span></span></code> </pre> <br>  Pour les composants, nous cr√©ons des classes de stub qui sont utilis√©es par notre g√©n√©rateur de code pour les convertir en code de composant r√©ellement utilis√©.  Obtenons quelques blancs pour <i>Health</i> , <i>Damage</i> et <i>Invincible</i> (pour le reste des composants, ce sera similaire). <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Component</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Health</span></span> { [Max(<span class="hljs-number"><span class="hljs-number">1000</span></span>)] <span class="hljs-comment"><span class="hljs-comment">//  -  1000 public int Hp; // -   public Health(int hp) {} } [Component] public class Damage { [DontSend] //      ,      public uint Amount; // -  public Entity Victim; //    public Entity Source; //    public Damage(uint amount, Entity victim, Entity source) {} } [Component] public class Invincible //   ,  ,    { }</span></span></code> </pre> <br>  Les composants d√©terminent l'√©tat du monde, ils ne contiennent donc que des donn√©es, sans m√©thodes.  En m√™me temps, il n'y a pas de donn√©es dans <i>Invincible</i> , elles sont utilis√©es en logique comme signe d'invuln√©rabilit√© - si l'essence du joueur a cette composante, alors le joueur est d√©sormais invuln√©rable. <br><br>  L'attribut <i>Component</i> est utilis√© par le g√©n√©rateur pour rechercher les classes vides pour les composants.  Les <i>attributs</i> <i>Max</i> et <i>DontSend</i> sont n√©cessaires comme conseils lors de la s√©rialisation et de la r√©duction de la taille de l'√©tat du monde transmis sur le r√©seau ou enregistr√©s sur le disque.  Dans ce cas, le serveur ne s√©rialisera pas le champ <i>Montant</i> et ne l'enverra pas sur le r√©seau (car les clients n'utilisent pas ce param√®tre, il n'est n√©cessaire que sur le serveur).  Et le champ <i>Hp</i> peut √™tre bien emball√© en plusieurs bits, √©tant donn√© la valeur maximale de la sant√©. <br><br>  Nous avons √©galement une classe <i>pr√©fabriqu√©e Entity</i> , o√π nous ajoutons des informations sur tous les composants possibles de toute entit√©, et le g√©n√©rateur va d√©j√† cr√©er une classe r√©elle √† partir de celle-ci: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Entity</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Health Health; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Damage Damage; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Invincible Invincible; <span class="hljs-comment"><span class="hljs-comment">// ... &lt; &gt; }</span></span></code> </pre> <br>  Apr√®s cela, notre g√©n√©rateur cr√©era le code des classes de composants <i>Health</i> , <i>Damage</i> et <i>Invincible</i> , qui sera d√©j√† utilis√© dans la logique du jeu: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Health</span></span> : <span class="hljs-title"><span class="hljs-title">IComponent</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Hp; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Reset</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Hp = <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>); } <span class="hljs-comment"><span class="hljs-comment">// ... &lt;  &gt; } public sealed class Damage : IComponent { public int Amount; public Entity Victim; public Entity Source; public void Reset() { Amount = default(int); Victim = default(Entity); Source = default(Entity); } // ... &lt;  &gt; } public sealed class Invincible : IComponent { }</span></span></code> </pre> <br>  Comme vous pouvez le voir, les donn√©es sont rest√©es dans les classes et des m√©thodes ont √©t√© ajout√©es, par exemple, <i>R√©initialiser</i> .  Il est n√©cessaire pour optimiser et r√©utiliser les composants dans les pools.  D'autres m√©thodes auxiliaires ne contiennent pas de logique m√©tier - je ne les donnerai pas par souci de concision. <br><br>  Une classe sera √©galement g√©n√©r√©e pour l'√©tat du monde, qui contient une liste de tous les composants et entit√©s: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">GameState</span></span> { <span class="hljs-comment"><span class="hljs-comment">//  public Table&lt;Movement&gt; Movements; public Table&lt;Health&gt; Healths; public Table&lt;Damage&gt; Damages; public Table&lt;Transform&gt; Transforms; public Table&lt;Invincible&gt; Invincibles; //   public Entity CreateEntity() { /* &lt;&gt; */ } public void Copy(GameState gs2) { /* &lt;&gt; */ } public Entity this[uint id] { /* &lt;&gt; */ } // ... &lt;   &gt; }</span></span></code> </pre> <br>  Et enfin, le code g√©n√©r√© pour <i>Entity</i> : <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Entity</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> Id; <span class="hljs-comment"><span class="hljs-comment">//   public GameState GameState; //     //     : public Health Health { get { return GameState.Healths[Id]; } } public Damage Damage { get { return GameState.Damages[Id]; } } public Invincible Invincible { get { return GameState.Invincibles[Id]; } } // ‚Ä¶     public Damage AddDamage() { return GameState.Damages.Insert(Id); } public Damage AddDamage(int total, Entity victim, Entity source) { var c = GameState.Damages.Insert(Id); c.Amount = total; c.Victim = victim; c.Source = source; return c; } public void DelDamage() { GameState.Damages.Delete(Id); } // ‚Ä¶ &lt;     &gt; }</span></span></code> </pre> <br>  La classe <i>Entity</i> n'est essentiellement qu'un identifiant de composant.  La r√©f√©rence aux objets du monde <i>GameState</i> n'est utilis√©e que dans les m√©thodes auxiliaires pour la commodit√© de l'√©criture du code logique m√©tier.  Connaissant l'identifiant d'un composant, nous pouvons l'utiliser pour s√©rialiser les relations entre entit√©s, impl√©menter des liens dans les composants vers d'autres entit√©s.  Par exemple, le composant <i>Damage</i> contient une r√©f√©rence √† l'entit√© <i>Victime</i> pour d√©terminer qui a √©t√© endommag√©. <br><br>  Ceci termine le code g√©n√©r√©.  En g√©n√©ral, nous avons besoin d'un g√©n√©rateur pour ne pas √©crire √† chaque fois des m√©thodes auxiliaires.  Nous d√©crivons uniquement les composants comme des donn√©es, puis le g√©n√©rateur fait tout le travail.  Exemples de m√©thodes d'assistance: <br><br><ul><li>  cr√©er / supprimer des entit√©s; </li><li>  ajouter / supprimer / copier un composant, y acc√©der s'il existe; </li><li>  comparer deux √©tats du monde; </li><li>  s√©rialiser l'√©tat du monde; </li><li>  compression delta; </li><li>  code d'une page Web ou d'une fen√™tre Unity pour afficher l'√©tat du monde, les entit√©s, les composants (voir d√©tails ci-dessous); </li><li>  et autres </li></ul><br>  Passons au code syst√®me.  Ils d√©finissent la logique m√©tier.  Par exemple, √©crivons le code d'un syst√®me qui calcule les dommages subis par un joueur: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DamageSystem</span></span> : <span class="hljs-title"><span class="hljs-title">ISystem</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> ISystem.Execute(GameState gs) { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> damage <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> gs.Damages) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> invincible = damage.Victim.Invincible; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (invincible != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> health = damage.Victim.Health; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (health == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; health.Hp -= damage.Amount; } } }</code> </pre> <br>  Le syst√®me passe par tous les composants de <i>dommages</i> dans le monde et cherche √† voir s'il y a un composant <i>invincible</i> sur un joueur potentiellement endommag√© ( <i>victime</i> ).  S'il l'est, le joueur est invuln√©rable, les d√©g√¢ts ne sont pas accumul√©s.  Ensuite, nous obtenons le composant <i>Sant√© de</i> la victime et r√©duisons la sant√© du joueur par la taille des d√©g√¢ts. <br><br>  Tenez compte des principales caract√©ristiques des syst√®mes: <br><br><ol><li>  Un syst√®me est g√©n√©ralement une classe sans √©tat, ne contient aucune donn√©e interne, n'essaie pas de l'enregistrer quelque part, √† l'exception des donn√©es sur le monde transmises de l'ext√©rieur. </li><li>  Les syst√®mes passent g√©n√©ralement par tous les composants d'un certain type et fonctionnent avec eux.  Ils sont g√©n√©ralement appel√©s par le type de composant ( <i>Damage</i> ‚Üí <i>DamageSystem</i> ) ou par l'action qu'ils effectuent ( <i>RespawnSystem</i> ). </li><li>  Le syst√®me impl√©mente une fonctionnalit√© minimale.  Par exemple, si nous allons plus loin, apr√®s l' <i>ex√©cution</i> du <i>DamageSystem,</i> un autre <i>RemoveDamageSystem</i> supprimera tous les composants de <i>Damage</i> .  Dans la coche suivante, un autre syst√®me <i>ApplyDamage</i> bas√© sur le tir du joueur peut √† nouveau bloquer le composant <i>Damage</i> avec de nouveaux d√©g√¢ts.  Et puis le <i>PlayerDeathSystem</i> v√©rifiera la sant√© du joueur ( <i>Health.Hp</i> ) et, s'il est inf√©rieur ou √©gal √† 0, il d√©truira tous les composants du joueur √† l'exception de <i>Transform</i> et ajoutera le composant <i>Dead</i> flag. </li></ol><br>  Au total, nous obtenons les classes suivantes et les relations entre elles: <br><img src="https://habrastorage.org/webt/g7/59/mq/g759mq06qfqqjymhz8ympcwejro.png"><br><br><h3>  Quelques faits sur ECS </h3><br>  ECS a ses avantages et ses inconv√©nients comme une approche du d√©veloppement et une fa√ßon de repr√©senter le monde du jeu, de sorte que chacun d√©cide lui-m√™me de l'utiliser ou non.  Commen√ßons par les pros: <br><br><ul><li>  <b>Composition versus h√©ritage multiple.</b>  Dans le cas d'un h√©ritage multiple, un tas de fonctionnalit√©s inutiles peuvent √™tre h√©rit√©es.  Dans le cas d'ECS, la fonctionnalit√© appara√Æt / dispara√Æt lorsqu'un composant est ajout√© / supprim√©. </li><li>  <b>S√©paration de la logique et des donn√©es.</b>  La possibilit√© de changer la logique (changer de syst√®me, supprimer / ajouter des composants) sans casser les donn√©es.  C'est-√†-dire  vous pouvez d√©sactiver le groupe de syst√®mes responsable d'une certaine fonctionnalit√© √† tout moment, tout le reste continuera √† fonctionner et cela n'affectera pas les donn√©es. </li><li>  <b>Le cycle de jeu est simplifi√©.</b>  Une <i>mise √† jour</i> appara√Æt et l'ensemble du cycle est divis√© en syst√®mes.  Les donn√©es sont trait√©es par le ¬´flux¬ª dans le syst√®me, quel que soit le moteur (il n'y a pas des millions d'appels de <i>mise √† jour</i> , comme dans Unity). </li><li>  <b>Une entit√© ne sait pas quelles classes l'affectent</b> (et ne doit pas savoir). </li><li>  <b>Utilisation efficace de la m√©moire</b> .  Cela d√©pend de la mise en ≈ìuvre d'ECS.  Vous pouvez r√©utiliser les objets et composants d'entit√© cr√©√©s √† l'aide de pools;  vous pouvez utiliser des types de valeurs pour les donn√©es et les stocker c√¥te √† c√¥te en m√©moire ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">localit√© des donn√©es</a> ). </li><li>  <b>Il est plus facile de tester</b> lorsque les donn√©es sont s√©par√©es de la logique.  Surtout quand on consid√®re que la logique est un petit syst√®me avec plusieurs lignes de code. </li><li>  <b>Affichez et modifiez l'√©tat du monde en temps r√©el</b> .  Parce que  l'√©tat du monde n'est que des donn√©es, nous avons √©crit un outil qui affiche sur la page web tout l'√©tat du monde dans un match sur le serveur (ainsi que la sc√®ne du match en 3D).  Tout composant d'une entit√© peut √™tre affich√©, modifi√©, supprim√©.  La m√™me chose peut √™tre effectu√©e dans l'√©diteur Unity pour le client. </li></ul><br><img src="https://habrastorage.org/webt/zd/rz/a-/zdrza-80yltaqp8g3dqwd59zgqw.jpeg"><br><br>  Et maintenant les inconv√©nients: <br><br><ul><li>  <b>Vous devez apprendre √† penser, concevoir et √©crire du code diff√©remment</b> .  Pensez en termes d'entit√©s, de composants et de syst√®mes.  De nombreux mod√®les de conception dans ECS sont impl√©ment√©s d'une mani√®re compl√®tement diff√©rente (voir un exemple d'impl√©mentation du mod√®le <i>State</i> dans l'un des articles de revue √† la fin). </li><li>  <b>Plus de code</b> .  Discutable.  D'une part, en raison du fait que nous divisons la logique en petits syst√®mes, au lieu de d√©crire toutes les fonctionnalit√©s dans une classe, il y a plus de classes, mais il n'y a pas beaucoup plus de code. </li><li>  <b>L'ordre dans lequel les syst√®mes sont appel√©s affecte le fonctionnement de l'ensemble du jeu</b> .  Habituellement, les syst√®mes d√©pendent les uns des autres, l'ordre de leur ex√©cution est d√©fini par la liste et ils sont ex√©cut√©s dans cet ordre.  Par exemple, d'abord <i>DamageSystem</i> consid√®re les dommages, puis <i>RemoveDamageSystem</i> supprime le composant <i>Damage</i> .  Si vous modifiez accidentellement la commande, tout fonctionnera diff√©remment.  En g√©n√©ral, cela est √©galement vrai pour le cas OOP habituel, si vous modifiez l'ordre des appels de m√©thode, mais il est plus facile de faire des erreurs dans ECS.  Par exemple, si une partie de la logique s'ex√©cute sur le client pour la pr√©diction, l'ordre doit √™tre le m√™me que sur le serveur. </li><li>  <b>Nous devons en quelque sorte connecter les donn√©es et les √©v√©nements de la logique avec la vue</b> .  Dans le cas d'Unity, nous avons MVP: <br><br>  - Mod√®le - <i>GameState</i> d'ECS; <br>  - Afficher - avec nous, ce sont exclusivement des classes <i>MonoBehavior</i> Unity standard ( <i>Renderer</i> , <i>Text</i> , etc.) et prefabs; <br>  - Le pr√©sentateur utilise le <i>GameState</i> pour d√©terminer les √©v√©nements d'apparition / disparition d'entit√©s, de composants, etc., cr√©e des objets Unity √† partir de pr√©fabriqu√©s et les modifie en fonction des changements de l'√©tat du monde. </li></ul><br>  <i>Saviez-vous que:</i> <br><br><ul><li>  <b>ECS ne concerne pas seulement la localisation des donn√©es</b> .  Pour moi, c'est plus un paradigme de programmation, un mod√®le, une autre fa√ßon de concevoir le monde du jeu - appelez-le comme vous voulez.  La localisation des donn√©es n'est qu'une optimisation. </li><li>  <b>L'unit√© n'a pas d'ECS!</b>  Souvent, vous demandez aux candidats lors d'un entretien d'√©quipe - que savez-vous d'ECS?  Si vous n‚Äôavez pas entendu, vous leur dites, et ils ont r√©pondu: "Ah, c‚Äôest comme dans Unity, alors je sais!".  Mais non, ce n'est pas comme dans le moteur Unity.  L√†, les donn√©es et la logique sont combin√©es dans le composant <i>MonoBehaviour</i> , et <i>GameObject</i> (par rapport √† une entit√© dans ECS) a des donn√©es suppl√©mentaires - un nom, une place dans la hi√©rarchie, etc. Les d√©veloppeurs Unity <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">travaillent</a> actuellement sur une impl√©mentation normale d'ECS dans le moteur, et jusqu'√† pr√©sent, il semble que ce sera bon.  Ils ont embauch√© des sp√©cialistes dans ce domaine - j'esp√®re que ce sera cool. </li></ul><br><h3>  Nos crit√®res de s√©lection pour le cadre ECS </h3><br>  Lorsque nous avons d√©cid√© de cr√©er un jeu sur ECS, nous avons commenc√© √† chercher une solution toute faite et avons not√© les conditions requises en fonction de l'exp√©rience de l'un des d√©veloppeurs.  Et ils ont peint comment les solutions existantes r√©pondent √† nos exigences.  C'√©tait il y a un an, en ce moment, quelque chose aurait pu changer.  Comme solutions, nous avons consid√©r√©: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Entitas</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Artemis C #</a> </li><li>  <a href="">Ash.net</a> </li><li>  ECS est notre propre solution au moment o√π nous l'avons con√ßue.  C'est-√†-dire  nos hypoth√®ses et souhaits, ce que nous pouvons faire nous-m√™mes. </li></ul><br>  Nous avons compil√© un tableau de comparaison, o√π j'ai √©galement inclus notre solution actuelle (d√©sign√©e comme <i>ECS (maintenant)</i> ): <br><br><img src="https://habrastorage.org/webt/0p/eh/hk/0pehhk27fihkyp-qmuhlpu0m5m4.png"><br>  <i>Couleur rouge - la solution ne prend pas en charge notre exigence, orange - prend en charge partiellement, vert - prend enti√®rement en charge.</i> <br><br>  Pour nous, l'analogie des op√©rations d'acc√®s aux composants et de recherche d'entit√©s dans ECS √©tait des op√©rations dans une base de donn√©es SQL.  Par cons√©quent, nous avons utilis√© des concepts tels que table (table), jointure (op√©ration de jointure), indices (indices), etc. <br><br>  Nous d√©crirons nos exigences et dans quelle mesure les biblioth√®ques et frameworks tiers leur correspondent: <br><br><ul><li>  <b>ensembles de donn√©es s√©par√©s (historique, actuel, visuel, statique)</b> - la possibilit√© d'obtenir et de stocker s√©par√©ment les √©tats du monde (par exemple, l'√©tat actuel pour le traitement, le rendu, l'historique des √©tats, etc.).  <i>Toutes les d√©cisions examin√©es appuyaient cette exigence</i> . </li><li>  <b>ID d'entit√© sous forme d'entier</b> - prise en charge de la repr√©sentation d'une entit√© par son num√©ro d'identification.  Il est n√©cessaire pour la transmission sur le r√©seau et la capacit√© de connecter des entit√©s dans l'histoire des √©tats.  <i>Aucune des solutions consid√©r√©es comme prises en charge.</i>  <i>Par exemple, dans Entitas, une entit√© est repr√©sent√©e par un objet √† part enti√®re (comme un GameObject dans Unity).</i> </li><li>  <b>join by ID O (N + M)</b> - prise en charge d'un √©chantillonnage relativement rapide de deux types de composants.  Par exemple, lorsque vous devez obtenir toutes les entit√©s avec des composants de type D√©g√¢ts (par exemple, leurs N pi√®ces) et Sant√© (M pi√®ces) pour calculer et causer des dommages.  <i>Il y avait un soutien total √† Artemis;</i>  <i>dans Entitas et Ash.NET, il est plus rapide que O (N¬≤), mais plus lent que O (N + M).</i>  <i>Je ne me souviens plus de l'√©valuation maintenant.</i> </li><li>  <b>joindre par r√©f√©rence ID O (N + M)</b> - le m√™me que ci-dessus uniquement lorsqu'un composant d'une entit√© a un lien avec un autre, et que ce dernier a besoin d'obtenir un autre composant (dans notre exemple, le composant <i>Damage</i> sur l'entit√© auxiliaire se r√©f√®re √† l'entit√© joueur <i>Victime</i> et √† partir de l√†, vous devez obtenir le volet <i>Sant√©</i> ).  <i>N'est pris en charge par aucune des solutions envisag√©es.</i> </li><li>  <b>aucune</b> allocation de <b>requ√™te</b> - aucune allocation de m√©moire suppl√©mentaire lors de l'interrogation de composants et d'entit√©s √† partir de l'√©tat du monde.  Dans Entitas, c'√©tait dans certains cas, mais insignifiant pour nous. </li><li>  <b>tables de pool</b> - stockage des donn√©es mondiales dans des pools, possibilit√© de r√©utiliser la m√©moire, allocation uniquement lorsque le pool est vide.  <i>Il y avait "un" support dans Entitas et Artemis, une absence totale dans Ash.NET.</i> </li><li>  <b>comparer par ID (ajouter, supprimer)</b> - prise en charge int√©gr√©e des √©v√©nements de cr√©ation / destruction d'entit√©s et de composants par ID.  Il est n√©cessaire que le niveau d'affichage (Affichage) affiche / masque les objets, joue les animations, les effets.  <i>N'est pris en charge par aucune des solutions envisag√©es.</i> </li><li>  <b>Œî s√©rialisation (quantification, skip)</b> - compression delta int√©gr√©e pour s√©rialiser l'√©tat du monde (par exemple, pour r√©duire la taille des donn√©es envoy√©es sur le r√©seau).  <i>Out of the Box n'√©tait pris en charge dans aucune des solutions.</i> </li><li>  <b>L'interpolation</b> est un m√©canisme d'interpolation int√©gr√© entre les √©tats du monde.  <i>Aucune des solutions prises en charge.</i> </li><li>  <b>r√©utiliser le type de composant</b> - la possibilit√© d'utiliser une fois le type de composant √©crit dans diff√©rents types d'entit√©s.  <i>Entitas uniquement pris en charge</i> . </li><li>  <b>ordre explicite des syst√®mes</b> - la possibilit√© de d√©finir vos propres syst√®mes d'ordre d'appel.  <i>Toutes les d√©cisions sont appuy√©es.</i> </li><li>  <b>√©diteur (unit√© / serveur)</b> - prise en charge de la visualisation et de l'√©dition des entit√©s en temps r√©el, √† la fois pour le client et pour le serveur.  <i>Entitas a uniquement pris en charge la possibilit√© d'afficher et de modifier des entit√©s et des composants dans l'√©diteur Unity.</i> </li><li>  <b>copie / remplacement rapide</b> - la possibilit√© de copier / remplacer des donn√©es √† moindre co√ªt.  <i>Aucune des solutions prises en charge.</i> </li><li>  <b>composant comme type de valeur (struct)</b> - composants comme types de valeur.  En principe, je voulais atteindre de bonnes performances sur cette base.  <i>Aucun syst√®me n'√©tait pris en charge, les classes de composants √©taient partout.</i> </li></ul><br>  Exigences facultatives ( <i>aucune des solutions √† l'√©poque ne les supportait</i> ): <br><br><ul><li>  <b>indices</b> - indexation des donn√©es comme dans une base de donn√©es. </li><li>  <b>cl√©s composites</b> - <b>cl√©s</b> complexes pour un acc√®s rapide aux donn√©es (comme dans la base de donn√©es). </li><li>  <b>v√©rification d'int√©grit√©</b> - la capacit√© de v√©rifier l'int√©grit√© des donn√©es dans un √©tat du monde.  Utile pour le d√©bogage. </li><li>  <b>la compression sensible au contenu</b> est la meilleure compression de donn√©es bas√©e sur la connaissance de la nature des donn√©es.  Par exemple, si nous connaissons la taille maximale de la carte ou le nombre maximum d'objets dans le monde. </li><li>  <b>types / syst√®mes limite</b> - restriction du nombre de types de composants ou de syst√®mes.  <i>√Ä l'√©poque, √† Artemis, il √©tait impossible de cr√©er plus de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">32 ou 64 types de composants et de syst√®mes</a></i> . </li></ul><br>  Comme on peut le voir dans le tableau, nous voulions nous-m√™mes impl√©menter toutes les exigences, sauf celles facultatives.  En fait, pour le moment, nous n'avons <i>pas</i> fait: <br><br><ul><li>  <i>joindre par ID O (N + M)</i> et <i>joindre par r√©f√©rence ID O (N + M)</i> - la s√©lection pour deux composants diff√©rents occupe toujours O (N¬≤) (en fait, une boucle imbriqu√©e <i>pour</i> ).  D'un autre c√¥t√©, il n'y a pas autant d'entit√©s et de composants pour une correspondance. </li><li>  <i>comparer par ID (ajouter, supprimer)</i> - pas n√©cessaire au niveau du framework.  Nous l'avons impl√©ment√© √† un niveau sup√©rieur dans MVP. </li><li>  <i>copie / remplacement rapide</i> et <i>composant comme type de valeur (struct)</i> - √† un moment donn√©, nous avons r√©alis√© que travailler avec des structures ne serait pas aussi pratique qu'avec des classes, et nous nous sommes install√©s sur les classes - nous avons pr√©f√©r√© la commodit√© du d√©veloppement plut√¥t que de meilleures performances.  Soit dit en passant, les d√©veloppeurs d'Entitas ont <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">finalement fait de m√™me</a> . </li></ul><br>  Dans le m√™me temps, nous avons n√©anmoins r√©alis√© une des exigences initialement facultatives selon nous: <br><br><ul><li>  <i>compression sensible au contenu</i> - gr√¢ce √† elle, nous avons pu r√©duire de mani√®re significative (des dizaines de fois) la taille du paquet transmis sur le r√©seau.  Pour les r√©seaux de donn√©es mobiles, il est tr√®s important d'ajuster la taille du paquet dans le MTU afin qu'il ne soit pas ¬´d√©compos√©¬ª en petites parties qui pourraient se perdre, passer dans un ordre diff√©rent, puis devoir √™tre assembl√© en parties.  Par exemple, dans Photon, si la taille des donn√©es ne tient pas dans la biblioth√®que MTU, il divise les donn√©es en paquets et les envoie comme fiables (avec livraison garantie), m√™me si vous les envoyez comme ¬´non fiables¬ª par le haut.  Test√© avec douleur de premi√®re main. </li></ul><br><h3>  Caract√©ristiques de notre d√©veloppement chez ECS </h3><br><ul><li>  <b>Chez ECS, nous √©crivons exclusivement la logique m√©tier</b> .  Pas de travail avec les ressources, les vues, etc.  √âtant donn√© que le code logique ECS s'ex√©cute simultan√©ment sur le client dans Unity et sur le serveur, il doit √™tre aussi ind√©pendant que possible des autres niveaux et modules. </li><li>  <b>Nous essayons de minimiser les composants et les syst√®mes</b> .  Habituellement, pour chaque nouvelle t√¢che, nous d√©marrons de nouveaux composants et syst√®mes.  Mais il arrive parfois que nous modifions les anciens, ajoutions de nouvelles donn√©es aux composants et ¬´gonflions¬ª les syst√®mes. </li><li>  <b>Dans notre impl√©mentation ECS, vous ne pouvez pas ajouter plusieurs composants du m√™me type √† une seule entit√©</b> .  Par cons√©quent, si un joueur a √©t√© touch√© plusieurs fois en une seule fois (par exemple, plusieurs adversaires), nous cr√©ons g√©n√©ralement une nouvelle entit√© pour chaque d√©g√¢t et lui ajoutons un composant <i>D√©g√¢ts</i> . </li><li>  <b>Parfois, la pr√©sentation ne suffit pas des informations contenues dans le <i>GameState</i></b> .  Ensuite, vous devez ajouter des composants sp√©ciaux ou des donn√©es suppl√©mentaires qui ne sont pas impliqu√©s dans la logique, mais dont la vue a besoin.  Par exemple, la prise de vue est instantan√©e sur le serveur, une tique vit et visuellement, elle est plus longue sur le client.  Par cons√©quent, pour le client, la prise de vue est ajout√©e au param√®tre "dur√©e de vie de la prise de vue". </li><li>  <b>Nous mettons en ≈ìuvre des √©v√©nements / demandes en cr√©ant des composants sp√©ciaux</b> .  Par exemple, si un joueur est d√©c√©d√©, nous lui accrochons un composant sans donn√©es <i>Dead</i> , qui est un √©v√©nement pour d'autres syst√®mes et le niveau de vue que le joueur est d√©c√©d√©.  Ou si nous devons faire revivre le joueur sur le point, nous cr√©ons une entit√© distincte avec le composant <i>Respawn</i> avec des informations suppl√©mentaires sur qui revivre.  Un <i>RespawnSystem</i> s√©par√© au tout d√©but du cycle de jeu passe par ces composants et cr√©e d√©j√† l'essence du joueur.  C'est-√†-dire  en fait, la premi√®re entit√© est une demande de cr√©ation de la seconde. </li><li>  <b>Nous avons des composants / entit√©s ¬´singleton¬ª sp√©ciaux</b> .  Par exemple, nous avons une entit√© avec ID = 1, sur laquelle pendent des composants sp√©ciaux - les param√®tres du jeu. </li></ul><br><h3>  Bonus </h3><br>    ‚Äî       ECS ‚Äî    .     ,        ,   ,   : <br><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Unity, ECS  --</a> ‚Äî       ECS   .  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">mopsicus</a>  ,   ECS,  .        :  Unity  ECS   ,   .    .   ¬´¬ª ECS    Unity.    ECS-,      : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">LeoECS</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">BrokenBricksECS</a> , <a href="">Svelto.ECS</a> . </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Unity3D ECS  Job System</a> ‚Äî   ,      ECS  Unity.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">fstleo</a>   ,   Unity ECS,     ,         -      ,    JobSystem. </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">  Entity System Framework      ?</a> ‚Äî    Ash-  ActionScript.  ,   ,        OOP-  ECS-. </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">    Ash Entity System </a> ‚Äî   ,    FSM  State  ECS ‚Äî      ,       . </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">  Entity-Component-System ‚Äî    </a> ‚Äî     ECS  C++. </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr413729/">https://habr.com/ru/post/fr413729/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr413717/index.html">GraphQL pour les plates-formes InterSystems</a></li>
<li><a href="../fr413719/index.html">C ++ 20 en route! Rencontre √† Rapperswil Yona</a></li>
<li><a href="../fr413721/index.html">Time Checking: Timejacking vs Bitcoin</a></li>
<li><a href="../fr413723/index.html">Saga des services √©lectroniques et de leurs emplacements. Partie 2. Armoire √©lectronique</a></li>
<li><a href="../fr413725/index.html">Travailler avec des tableaux dans bash</a></li>
<li><a href="../fr413731/index.html">√âtude du march√© du travail BA / SA</a></li>
<li><a href="../fr413733/index.html">Mikrosh, Krista, Apogee, Lviv - les premiers ordinateurs sovi√©tiques √† emporter</a></li>
<li><a href="../fr413739/index.html">Comment nous avons scann√© tout Internet et ce que nous avons appris</a></li>
<li><a href="../fr413741/index.html">Qu'est-ce que c'√©tait et comment: impressions de l'√©quipe WWDC Redmadrobot</a></li>
<li><a href="../fr413743/index.html">Lancez LAMP et des centaines d'autres applications Web en quelques clics</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>