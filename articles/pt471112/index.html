<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßïüèº üï∞Ô∏è ü§¶ Raz√£o est√∫pida por que seu aplicativo de vis√£o de m√°quina astuto n√£o funciona: orienta√ß√£o em EXIF üçÖ üëÉüèº üíû</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Escrevi muito sobre projetos de vis√£o computacional e aprendizado de m√°quina, como sistemas de reconhecimento de objetos e projetos de reconhecimento ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Raz√£o est√∫pida por que seu aplicativo de vis√£o de m√°quina astuto n√£o funciona: orienta√ß√£o em EXIF</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/471112/"> Escrevi muito sobre projetos de vis√£o computacional e aprendizado de m√°quina, como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">sistemas de reconhecimento de objetos</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">projetos de reconhecimento de faces</a> .  Eu tamb√©m tenho uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">biblioteca de reconhecimento facial de</a> c√≥digo-fonte Python que de alguma forma chegou √†s <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">10 bibliotecas de aprendizado de m√°quina mais populares no Github</a> .  Tudo isso levou os rec√©m-chegados ao Python e √† vis√£o de m√°quina a me fazerem <i>muitas</i> perguntas. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c4b/b2f/40c/c4bb2f40c4522fd2caee36c65a8f4b09.png"><br><br>  Por experi√™ncia, h√° um problema t√©cnico espec√≠fico que muitas vezes confunde as pessoas.  N√£o, essa n√£o √© uma quest√£o te√≥rica dif√≠cil ou um problema com GPUs caras.  O fato √© que quase todo mundo carrega imagens na mem√≥ria rotacionada, mesmo sem saber.  E os computadores <i>n√£o</i> detectam objetos <i>muito bem</i> ou reconhecem rostos em imagens rotacionadas. <br><a name="habracut"></a><br><h1>  Como as c√¢meras digitais giram imagens automaticamente </h1><br>  Quando voc√™ tira uma foto, a c√¢mera registra a posi√ß√£o do telefone, para que em outro programa a imagem seja exibida na orienta√ß√£o correta: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/cd0/0e3/ebd/cd00e3ebd77f1d9e920128d76b4f776a.png"><br><br>  Mas a c√¢mera n√£o gira os dados de pixel dentro do arquivo.  Como os sensores de imagem nas c√¢meras digitais s√£o lidos linha a linha como um fluxo cont√≠nuo de informa√ß√µes em pixels, √© mais f√°cil para a c√¢mera armazenar sempre os dados em pixels na mesma ordem, independentemente da posi√ß√£o real do telefone. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3f4/5ba/d70/3f45bad70377a193db2bf631ef1a91ab.png"><br><br>  Essa √© a preocupa√ß√£o do programa para visualizar - gire a imagem corretamente antes de exibi-la na tela.  Juntamente com os dados da pr√≥pria imagem, a c√¢mera tamb√©m salva metadados - configura√ß√µes da lente, dados de localiza√ß√£o e, √© claro, o √¢ngulo de rota√ß√£o da c√¢mera.  O visualizador deve usar essas informa√ß√µes para exibir corretamente. <br><br>  O formato mais comum de metadados de imagem √© chamado <b>EXIF</b> (abrevia√ß√£o de Exchangeable Image File Format).  Os metadados EXIF ‚Äã‚Äãs√£o incorporados em todos os arquivos jpeg.  Voc√™ n√£o pode v√™-los na tela, mas eles s√£o lidos por qualquer programa que sabe onde procurar. <br><br>  Aqui est√£o os metadados EXIF ‚Äã‚Äãdentro da imagem JPEG do nosso ganso da ferramenta <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">exiftool</a> : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/601/cad/fda/601cadfda25a8aab0af8ccb2b8c699b1.png"><br><br>  Veja o elemento 'Orienta√ß√£o'?  Ele diz ao espectador que, antes de exibir na tela, a imagem deve ser girada 90 graus no sentido hor√°rio.  Se o programa se esquecer de fazer isso, a imagem estar√° do seu lado! <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3d7/c9d/230/3d7c9d230dab3133a1628aec93169824.png"><br><br><h1>  Por que isso quebra tantos aplicativos de vis√£o de m√°quina em Python? </h1><br>  Os metadados EXIF ‚Äã‚Äãn√£o faziam parte originalmente do formato JPEG.  Eles foram introduzidos muito mais tarde, emprestando a id√©ia do formato TIFF.  Para compatibilidade com vers√µes anteriores, esses metadados s√£o opcionais e alguns programas n√£o se preocupam em analis√°-los. <br><br>  A maioria das bibliotecas de imagens Python, como numpy, scipy, TensorFlow, Keras, etc., se consideram <i>ferramentas cient√≠ficas para pessoas s√©rias</i> que trabalham com conjuntos de dados compartilhados.  Eles n√£o se importam com quest√µes no <i>n√≠vel do consumidor</i> , como a rota√ß√£o autom√°tica da imagem, embora isso seja necess√°rio para quase todas as fotografias do mundo tiradas com c√¢meras modernas. <br><br>  Isso significa que, ao processar uma imagem com quase qualquer biblioteca Python, voc√™ obt√©m os dados da imagem original sem rota√ß√£o.  E adivinhe o que acontece quando voc√™ tenta fazer upload de uma foto do seu lado ou de cabe√ßa para baixo no modelo de detec√ß√£o de rosto ou objeto?  O detector n√£o dispara porque voc√™ forneceu dados incorretos. <br><br>  Voc√™ pode pensar que os problemas surgem apenas nos programas de iniciantes e estudantes, mas n√£o √© assim!  Mesmo a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">vers√£o demo da API principal da Google, Vision,</a> n√£o trata a orienta√ß√£o EXIF ‚Äã‚Äãcorretamente: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e81/3e6/0dc/e813e60dcc810a22eb21a15b3adb52f2.jpg"><br>  <i><font color="gray">Demonstra√ß√£o A API do Google Vision n√£o sabe como girar imagens orientadas a retrato tiradas de um telefone celular padr√£o</font></i> <br><br>  Embora o Google Vision reconhe√ßa alguns animais ao seu lado, ele os marca com o r√≥tulo comum "animal", porque os modelos de vis√£o por computador s√£o muito mais dif√≠ceis de reconhecer um ganso do que um ganso vertical.  Aqui est√° o resultado, se voc√™ girar a imagem corretamente antes de envi√°-la ao modelo: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/68f/7c9/a07/68f7c9a073642c35d200cacbe9d89838.jpg"><br><br>  Com a orienta√ß√£o correta, o Google detecta p√°ssaros com uma marca de ganso mais espec√≠fica e um indicador de confian√ßa mais alto.  Muito melhor! <br><br>  Esse √© um problema super √≥bvio quando voc√™ <i>v√™ claramente que a imagem est√° do lado</i> , como nesta demonstra√ß√£o.  Mas √© aqui que tudo se torna insidioso - geralmente voc√™ n√£o v√™!  Todos os programas normais do seu computador exibir√£o a imagem na orienta√ß√£o correta, e n√£o como ela √© realmente armazenada no disco.  Portanto, quando voc√™ tenta visualizar uma imagem para ver por que seu modelo n√£o est√° funcionando, ela ser√° exibida corretamente e voc√™ n√£o entender√° por que o modelo n√£o est√° funcionando! <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2b6/cb5/a01/2b6cb5a010eca220dd2f9887c4c24e27.png"><br>  <i><font color="gray">O Finder no Mac sempre exibe fotos giradas corretamente a partir do EXIF.</font></i>  <i><font color="gray">N√£o h√° como ver se a imagem est√° realmente armazenada de lado</font></i> <br><br>  Isso inevitavelmente leva a muitos tickets abertos no Github: as pessoas reclamam que os projetos de c√≥digo aberto est√£o com problemas e os modelos n√£o s√£o muito precisos.  Mas o problema √© muito mais simples - eles apenas colocam fotos giradas ou invertidas na entrada! <br><br><h1>  Corre√ß√£o </h1><br>  A solu√ß√£o √© que, sempre que voc√™ carregar imagens em programas Python, verifique os metadados da orienta√ß√£o EXIF ‚Äã‚Äãe gire as imagens, se necess√°rio.  √â muito f√°cil de fazer, mas na Internet √© surpreendentemente dif√≠cil encontrar exemplos de c√≥digo que sejam adequados para todas as orienta√ß√µes. <br><br>  Aqui est√° o c√≥digo para carregar qualquer imagem em uma matriz numpy com a orienta√ß√£o correta: <br><br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> PIL.Image <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> PIL.ImageOps <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> numpy <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> np <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">exif_transpose</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(img)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> img: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> img exif_orientation_tag = <span class="hljs-number"><span class="hljs-number">274</span></span> <span class="hljs-comment"><span class="hljs-comment"># Check for EXIF data (only present on some files) if hasattr(img, "_getexif") and isinstance(img._getexif(), dict) and exif_orientation_tag in img._getexif(): exif_data = img._getexif() orientation = exif_data[exif_orientation_tag] # Handle EXIF Orientation if orientation == 1: # Normal image - nothing to do! pass elif orientation == 2: # Mirrored left to right img = img.transpose(PIL.Image.FLIP_LEFT_RIGHT) elif orientation == 3: # Rotated 180 degrees img = img.rotate(180) elif orientation == 4: # Mirrored top to bottom img = img.rotate(180).transpose(PIL.Image.FLIP_LEFT_RIGHT) elif orientation == 5: # Mirrored along top-left diagonal img = img.rotate(-90, expand=True).transpose(PIL.Image.FLIP_LEFT_RIGHT) elif orientation == 6: # Rotated 90 degrees img = img.rotate(-90, expand=True) elif orientation == 7: # Mirrored along top-right diagonal img = img.rotate(90, expand=True).transpose(PIL.Image.FLIP_LEFT_RIGHT) elif orientation == 8: # Rotated 270 degrees img = img.rotate(90, expand=True) return img def load_image_file(file, mode='RGB'): # Load the image with PIL img = PIL.Image.open(file) if hasattr(PIL.ImageOps, 'exif_transpose'): # Very recent versions of PIL can do exit transpose internally img = PIL.ImageOps.exif_transpose(img) else: # Otherwise, do the exif transpose ourselves img = exif_transpose(img) img = img.convert(mode) return np.array(img)</span></span></code> </pre> <br>  A partir daqui, voc√™ pode transferir uma matriz de dados de imagem para qualquer biblioteca padr√£o de vis√£o de m√°quina Python que espera uma matriz de entrada: por exemplo, Keras ou TensorFlow. <br><br>  Como o problema √© onipresente, publiquei essa fun√ß√£o como uma biblioteca de pips chamada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">image_to_numpy</a> .  Voc√™ pode instal√°-lo da seguinte maneira: <br><br><pre>  instala√ß√£o do pip3 image_to_numpy </pre><br>  Funciona com qualquer programa Python, corrigindo o carregamento de imagens, por exemplo: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> matplotlib.pyplot <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> plt <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> image_to_numpy <span class="hljs-comment"><span class="hljs-comment"># Load your image file img = image_to_numpy.load_image_file("my_file.jpg") # Show it on the screen (or whatever you want to do) plt.imshow(img) plt.show()</span></span></code> </pre> <br>  Veja o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">arquivo leia</a> - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">me</a> para mais detalhes. <br><br>  Aproveite! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt471112/">https://habr.com/ru/post/pt471112/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt471096/index.html">Teste p√∫blico: solu√ß√£o para privacidade e escalabilidade no Ethereum</a></li>
<li><a href="../pt471098/index.html">Inova√ß√£o digital - como foi</a></li>
<li><a href="../pt471100/index.html">Intera√ß√£o entre componentes angulares usando RxJS</a></li>
<li><a href="../pt471102/index.html">DNS din√¢mico personalizado com CloudFlare</a></li>
<li><a href="../pt471104/index.html">Resumo dos eventos de TI de outubro (parte dois)</a></li>
<li><a href="../pt471116/index.html">5 dispositivos de tecnologia de alimentos e um rob√¥ com tomates</a></li>
<li><a href="../pt471118/index.html">Como apresentar sua organiza√ß√£o ao OpenStack</a></li>
<li><a href="../pt471120/index.html">Como resolver problemas atuais de TI no gerenciamento de reparos de equipamentos</a></li>
<li><a href="../pt471122/index.html">Not√≠cias do mundo do OpenStreetMap n¬∫ 480 (24.09.2019 - 09.09.2019)</a></li>
<li><a href="../pt471126/index.html">Lidando com backups do Dell EMC UnityVSA</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>