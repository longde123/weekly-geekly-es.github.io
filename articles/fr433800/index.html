<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üè´ ‚úãüèø üññüèø Utilisation des contr√¥leurs UDB PSoC de Cypress pour r√©duire les interruptions dans une imprimante 3D üö∂üèæ üê¢ üë©üèæ‚Äçüéì</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans les commentaires sur la traduction de la documentation propri√©taire sur UDB, il a √©t√© not√© √† juste titre que des faits purement secs ne contribue...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Utilisation des contr√¥leurs UDB PSoC de Cypress pour r√©duire les interruptions dans une imprimante 3D</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/433800/"><img src="https://habrastorage.org/webt/8h/et/xb/8hetxbp_jjuad07ws86ov24ch-c.jpeg"><br><br>  Dans les commentaires sur la traduction de la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation propri√©taire sur UDB,</a> il a √©t√© not√© √† juste titre que des faits purement secs ne contribuent pas √† la compr√©hension du mat√©riel.  Mais ce document contient pr√©cis√©ment les faits secs.  Pour les diluer avec de la pratique, prenons une pause dans la traduction.  Tournons ce bloc entre nos mains et voyons quoi et comment il peut √™tre r√©alis√© dans la pratique. <br><a name="habracut"></a><br><h2>  Introduction longue </h2><br>  Cet article est la deuxi√®me partie de la trilogie con√ßue.  La premi√®re partie se trouve <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> (contr√¥le LED RGB via le microcontr√¥leur Cypress UDB PSoC). <br><br>  En plus des contr√¥leurs UDB PSoC de Cypress, o√π certaines interfaces sont impl√©ment√©es sur eux, il serait int√©ressant de v√©rifier comment ces blocs peuvent faciliter la vie des programmeurs en d√©chargeant le processeur central de certaines t√¢ches gourmandes en ressources.  Mais pour clarifier ce que je vais faire, je dois √©crire une pr√©face compl√®te. <br><br>  √Ä l'automne 2015, j'ai achet√© une toute nouvelle imprimante 3D MZ3D, et au printemps 2016, j'√©tais fatigu√©e de la fa√ßon dont ses moteurs pas √† pas vibraient.  Les temps √©taient sauvages, nous avons surv√©cu du mieux que nous pouvions, alors la seule solution √©tait alors de passer du micropas 1/16 au 1/32.  La correspondance avec l'usine a montr√© que cela n'est pas possible √† Arduino.  Il s'est av√©r√© qu'il y avait une restriction dans le ¬´firmware¬ª de ces ann√©es, avec une fr√©quence de pas sup√©rieure √† 10 KHz, pas de pas virtuels ont √©t√© effectu√©s, mais deux pas virtuels, sinon le syst√®me n'avait tout simplement pas assez de temps pour traiter toutes les interruptions de ¬´pas¬ª.  Il n'y avait qu'une seule issue: tout faire glisser sur la plateforme ARM.  C'√©tait un glisser-d√©poser, pas un t√©l√©chargement, car il n'y avait pas non plus de solutions ARM pr√™tes √† l'emploi √† l'√©poque.  En quelques semaines, j'ai transf√©r√© tout cela sur STM32F4, le son des moteurs est devenu plus agr√©able, le probl√®me a √©t√© r√©solu. <br><br>  Ensuite, le d√©veloppement de l'OS a commenc√© dans notre entreprise, et lors des r√©unions, j'ai d√ª prouver pendant longtemps que l'approche typique du traitement des interruptions n'est pas toujours acceptable en termes de vitesse, faisant uniquement appel √† ce cas typique, mais tr√®s gourmand.  Les discussions √† ce sujet sont publi√©es dans mon article sur les interruptions dans le syst√®me d'exploitation <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> (Aper√ßu d'un RTOS russe, partie 8. Travailler avec les interruptions).  En g√©n√©ral, un probl√®me s'est install√© dans ma t√™te depuis longtemps: des interruptions auxiliaires fr√©quentes desservant un sous-syst√®me ralentissent tout le reste.  Le simple raffinement du processeur central, bien s√ªr, √©limine le probl√®me, mais n'apporte pas la satisfaction morale profonde que tout est bien fait. <br><br>  P√©riodiquement, je reviens sur cette question dans un sens purement th√©orique.  Par exemple, un jour, l'id√©e m'est venue √† l'esprit qu'au lieu d'utiliser un contr√¥leur co√ªteux, vous pouvez prendre trois STM32F103C8T6, dans lesquels une planche √† pain pr√™te √† l'emploi co√ªte 110 roubles, compte tenu de la livraison, et la puce elle-m√™me est encore moins ch√®re.  Dans l'un d'eux pour ne retirer que la fonction de commande du moteur.  Laissez-le d√©penser toute sa puissance de calcul sur cette fonction.  Quelques autres (peut-√™tre m√™me une) r√©solvent d'autres t√¢ches (commandes de traitement, travail avec PWM, maintien de la temp√©rature, etc.) dans un environnement calme.  Cette solution a √©galement un √©norme c√¥t√© plus - le nombre total de broches pour plusieurs contr√¥leurs est tout simplement √©norme.  Sur un STM32, j'ai d√ª √©tendre le solitaire pendant longtemps, √† quelle jambe attribuer.  Bien que les jambes des sorties de la minuterie et les jambes ADC des ARM soient affect√©es de mani√®re plus flexible que les anciens contr√¥leurs (une sortie de l'unit√© mat√©rielle peut aller √† l'une des plusieurs jambes physiques), mais lorsque vous d√©pliez le solitaire, vous comprenez que la flexibilit√© peut ne pas √™tre suffisante.  S'il y a beaucoup de contr√¥leurs, le choix augmente.  Sur celui qui sert aux moteurs pas √† pas, en g√©n√©ral, nous attribuons simplement toutes les jambes comme sorties num√©riques.  Les autres ont √©galement o√π se retourner. <br><br>  Un probl√®me avec cette approche est de savoir comment synchroniser ces contr√¥leurs?  En th√©orie, le MAX Max RTOS contient tout ce dont vous avez besoin.  Le gestionnaire de commandes g√©n√®re une liste de t√¢ches pour d√©placer les t√™tes.  Il les modifie p√©riodiquement (en coordonnant les acc√©l√©rations avec les t√¢ches nouvellement arriv√©es).  La m√©moire du shaper et de l'interpr√®te doit donc √™tre partag√©e.  RTOS MAX contient la fonctionnalit√© d'organisation de cette m√©moire partag√©e.  Je l'ai d√©crit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> (Vue d'ensemble d'un RTOS russe, partie 7. Moyens d'√©change de donn√©es entre les t√¢ches).  Mais dans la pratique, une nuance g√¢che tout: l'entretien des moteurs pas √† pas est un type de t√¢che critique.  Le moindre retard, et nous obtenons des flux de plastique pour une imprimante 3D, pour d'autres machines CNC - enfin, par exemple, des filetages mal filet√©s.  Toute communication via des interfaces s√©rie n'est pas la plus rapide.  Plus - temps pour l'arbitrage et autres besoins officiels.  Et il s'av√®re que tous les gains de la suppression des fonctionnalit√©s du processeur principal vont aux frais g√©n√©raux.  Bien s√ªr, j'ai profit√© de ma position officielle: je suis all√© discuter de ce probl√®me avec les d√©veloppeurs de ce sous-syst√®me.  H√©las.  Ils ont dit qu'il y a une synchronisation sans trop de surcharge dans le syst√®me d'exploitation, mais pour les √©quipements qui prennent en charge les bus correspondants.  Maintenant, si je prends l'architecture TigerShark comme base, le syst√®me d'exploitation organisera tout pour moi sans frais g√©n√©raux.  Seuls les contr√¥leurs r√©alis√©s selon cette architecture sont plusieurs fois plus chers que l'ensemble de l'imprimante 3D que je souhaitais y mettre.  En g√©n√©ral, encore une fois inacceptable. <br><br>  Nous approchons de la fin d'une introduction prolong√©e.  Quelqu'un dira que pour une raison quelconque, je cherche toujours un prince sur un cheval blanc.  Vous pouvez tout prendre et tout faire sans syst√®me d'exploitation, et ici j'envisage toutes sortes d'options ... Vous pouvez, mais vous pouvez, mais quand le probl√®me pratique "Fatigu√© d'√©couter le crash de l'imprimante" s'est pos√©, il a √©t√© rapidement r√©solu.  C‚Äôest tout.  Elle n'est plus.  De plus, depuis lors, de nouveaux pilotes de moteur pas √† pas sont apparus qui r√©solvent g√©n√©ralement le probl√®me d'une mani√®re compl√®tement diff√©rente (ils obtiennent un micropas 1/16 et donnent 1/256).  Et dans cette introduction, je d√©cris pr√©cis√©ment qu '"il n'y a pas de <b>belle</b> solution au probl√®me des interruptions fr√©quentes".  Une d√©cision laide a √©t√© prise depuis longtemps.  Je ne voulais pas perdre de temps √† v√©rifier d'autres d√©cisions laides.  Ils ont juste d√©fil√© dans ma t√™te. <br><br>  Mais lorsque j'ai trait√© des blocs UDB, il m'a sembl√© que le probl√®me pouvait √™tre r√©solu magnifiquement et de mani√®re spectaculaire.  Vous pouvez simplement prendre le traitement des interruptions du logiciel au niveau du firmware, laissant la partie informatique √† la conscience du processeur principal.  Aucun contr√¥leur suppl√©mentaire n√©cessaire!  Tout est plac√© sur la m√™me puce!  Commen√ßons donc. <br><br><h2>  Cheval sph√©rique dans le vide </h2><br>  Dans cet article, travailler avec UDB lui-m√™me sera au premier plan.  Si je parlais d'√™tre li√© √† un ¬´firmware¬ª sp√©cifique, ils pourraient √† juste titre me faire remarquer que je me trompais avec le hub.  Qu'est-ce que c'est pour GeekTimes.  Par cons√©quent, l'UDB est primaire et les moteurs pas √† pas ne sont qu'une belle chose √† illustrer.  Dans cette partie je ferai g√©n√©ralement un cheval sph√©rique dans le vide.  Il aura des lacunes pratiques que j'√©liminerai dans la deuxi√®me partie.  Mais en r√©p√©tant mes actions, les lecteurs pourront ma√Ætriser la m√©thodologie de d√©veloppement du firmware pour UDB. <br><br>  Alors.  Comment fonctionne le m√©canisme de commande du moteur pas √† pas?  Il y a une t√¢che qui met en ligne les segments que la t√™te doit passer avec une vitesse lin√©aire.  Jusqu'√† pr√©sent, je ferai semblant de ne pas me souvenir de l'acc√©l√©ration au d√©but et √† la fin du segment.  Seule la t√™te doit passer.  De nouveaux segments sont plac√©s √† la fin de la file d'attente.  Sur la base de l'enregistrement de la t√™te, une t√¢che distincte envoie des signaux <b>STEP</b> √† tous les moteurs actifs. <br><br>  Laissez l'imprimante avoir une vitesse de t√™te maximale de 200 mm / s.  Soit 200 pas n√©cessaires pour 1 millim√®tre de mouvement (ce chiffre correspond √† une v√©ritable imprimante MZ3D-256C avec un micropas 1/32).  Ensuite, les impulsions doivent √™tre fournies avec une fr√©quence allant jusqu'√† 200 * 200 = 40 000 Hz = 40 KHz.  C'est √† une telle fr√©quence qu'une t√¢che envoyant des impulsions de pas peut tr√®s bien √™tre appel√©e.  Il doit former par programme les impulsions elles-m√™mes et √©galement calculer la dur√©e apr√®s laquelle la prochaine interruption l'activant doit √™tre appel√©e. <br><br>  Je me souviens d'une blague sur Kolobok et les Trois Bogatyrs, o√π Kolobok saluait constamment les Bogatyrs, puis leur posait constamment des questions et recevait des r√©ponses.  Puis successivement, leur a dit au revoir.  Eh bien, il a ensuite rencontr√© les trente-trois chevaliers.  Le processeur est dans le r√¥le d'un chignon, et les moteurs pas √† pas sont dans le r√¥le de Bogatyrs.  Il est clair qu'en pr√©sence d'un grand nombre de blocs UDB, il est possible de parall√©liser le travail avec les moteurs, chaque moteur √©tant entretenu sur son bloc.  Et puisque nous avons des segments au cours desquels les moteurs se d√©placeront uniform√©ment, essayons de faire fonctionner l'√©quipement avec de telles transactions, et non √† chaque √©tape. <br><br>  Quelles informations sont n√©cessaires pour qu'un cheval sph√©rique traverse une section lin√©aire dans le vide? <br><br><ul><li>  Nombre d'√©tapes. </li><li>  La p√©riode de temps entre les √©tapes. </li></ul><br>  Deux param√®tres.  L'UDB n'a que deux batteries et deux registres de param√®tres D0 et D1.  Il semble que tout soit r√©alisable.  Nous estimons uniquement la profondeur de bits que ces registres devraient avoir. <br><br>  Tout d'abord, le nombre d'√©tapes.  S'il y a 8 chiffres, alors en un cycle de fonctionnement UDB, l'imprimante pourra d√©placer la t√™te de l'imprimante cart√©sienne d'un peu plus de 1 mm (200 micropas).  Pas assez.  Si la capacit√© est de 16 bits, le nombre d'√©tapes sera de 65536. Il s'agit de 65536/200 = 327 millim√®tres.  Acceptable pour la plupart des mod√®les.  Pour Core, Delta et autres, il est n√©cessaire d'estimer, mais dans son ensemble - pour un coup complet, le segment peut √™tre divis√© en plusieurs parties.  Il n'y en aura pas autant (deux, enfin, un maximum de trois). <br><br>  Maintenant la p√©riode.  Soit la fr√©quence d'horloge √† 48 MHz.  48000000/65536 = 732.  Autrement dit, la fr√©quence minimale autoris√©e qui peut √™tre obtenue √† l'aide d'un diviseur 16 bits est de 732 Hz.  Trop.  Dans le micrologiciel Marlin, le minimum est de 120 Hz (ce qui correspond √† peu pr√®s √† 8 MHz divis√© par la m√™me constante 65536).  Nous devrons faire les registres 24 bits.  La fr√©quence minimale sera alors √©gale √† 48000000 / (2 ^ 24) = 48000000/16777216 = 2,861 Hz. <br><br>  Bon.  Arr√™tez la th√©orie ennuyeuse!  Passons √† la pratique!  Lancez PSoC Creator et s√©lectionnez Fichier-&gt; Nouveau-&gt; Projet: <br><br><img src="https://habrastorage.org/webt/tk/9t/bj/tk9tbjfppfjemih3s-ydrk54lfc.png"><br><br>  Ensuite, j'ai s√©lectionn√© la maquette que j'ai, √† partir de laquelle l'environnement prendra des informations de base sur le contr√¥leur utilis√© et ses param√®tres: <br><br><img src="https://habrastorage.org/webt/dv/st/hi/dvsthib82j6ynrdxc0sk-5j20nk.png"><br><br>  Je me sens d√©j√† pr√™t √† cr√©er un projet √† partir de z√©ro, alors je s√©lectionne <b>Sch√©ma vide</b> : <br><br><img src="https://habrastorage.org/webt/oi/fx/vv/oifxvvsf0qye7j-mdyoxmbfux4q.png"><br><br>  Donnez √† l'environnement de travail le nom <b>PSoC3DTest</b> : <br><br><img src="https://habrastorage.org/webt/rr/0u/pd/rr0updtyevaseusbwel37v76bgc.png"><br><br>  Et le voil√†, un projet termin√©! <br><br><img src="https://habrastorage.org/webt/fw/0s/xu/fw0sxucryznmujjsvr5ockarrjc.png"><br><br>  La premi√®re chose que je veux faire est de cr√©er mon propre composant bas√© sur UDB.  Par cons√©quent, comme d√©j√† indiqu√© dans le dernier article, je dois basculer vers l'onglet <b>Composants</b> : <br><br><img src="https://habrastorage.org/webt/oa/o8/s5/oao8s5whrsdn9xsnophfoaom_n4.png"><br><br>  Cliquez avec le bouton droit sur le projet et s√©lectionnez <b>Ajouter un √©l√©ment de composant</b> : <br><br><img src="https://habrastorage.org/webt/zq/kt/hu/zqkthur3pa19fpcrq4kcrmdac_y.png"><br><br>  Nous disons que nous devons ajouter un <b>document UDB</b> , changer le nom en <b>StepperController</b> et cliquer sur <b>Cr√©er nouveau</b> : <br><br><img src="https://habrastorage.org/webt/tz/v8/qk/tzv8qkfqumypnq3ctjeh9moitpc.png"><br><br>  Le composant est apparu dans l'arborescence, plus - l'√©diteur de ce composant a ouvert: <br><br><img src="https://habrastorage.org/webt/yo/4g/np/yo4gnpvs5fuewpovam09lbq3zmw.png"><br><br>  Placez le bloc Datapath sur le formulaire: <br><br><img src="https://habrastorage.org/webt/nx/1o/bl/nx1oblbig1eqyqat0yj-evlvwo0.png"><br><br>  Apr√®s avoir s√©lectionn√© ce bloc, nous allons √† ses propri√©t√©s et modifions la profondeur de bits de 8 √† 24. Les param√®tres restants peuvent rester inchang√©s. <br><br><img src="https://habrastorage.org/webt/1e/oq/rf/1eoqrfsjz5uh1fj2mopwtmf5vao.png"><br><br>  Pour d√©marrer tous les blocs (pour tous les moteurs) en m√™me temps, je vais d√©marrer le signal de d√©marrage de l'ext√©rieur (ajouter l'entr√©e <b>Start</b> ).  Sorties: Je ferai la sortie <b>Step</b> directement, afin de pouvoir la soumettre au pilote du moteur pas √† pas, ainsi qu'√† <b>Out_Idle</b> .  Sur la base de ce signal, le processeur sera en mesure de d√©terminer qu'au moment o√π l'unit√© a termin√© son travail.  Les noms des circuits correspondant √† ces entr√©es et sorties sont visibles sur la figure. <br><br><img src="https://habrastorage.org/webt/sx/xq/gv/sxxqgvsyvpyr_jvzdblaf_l1soc.png"><br><br>  Avant de parler de la logique de l'automate, je d√©crirai un autre probl√®me purement technique: le r√©glage de la dur√©e d'impulsion <b>Step</b> .  La documentation du pilote DRV8825 n√©cessite que la largeur d'impulsion soit d'au moins 1,9 Œºs.  Les autres conducteurs sont moins exigeants sur sa largeur.  Comme d√©j√† not√© dans la partie th√©orique, les registres existants sont d√©j√† occup√©s en r√©glant la dur√©e des pas et le nombre de pas.  Qu'on le veuille ou non, un compteur √† sept bits doit √™tre plac√© sur le circuit.  Nous appelons cela un one-shot, qui d√©finit l'impulsion de pas.  √Ä une fr√©quence de 48 MHz, pour assurer une dur√©e de 1,9 Œºs, ce compteur doit compter au moins 91,2 pas.  Arrondissez √† 92. Toute valeur sup√©rieure √† cette valeur ne sera pas inf√©rieure.  Il s'av√®re que le param√®tre suivant: <br><br><img src="https://habrastorage.org/webt/6w/k9/em/6wk9emz-qedseywswmgk24bdjqe.png"><br><br>  Nom du compteur <b>SingleVibrator</b> .  Il n'est jamais r√©initialis√©, donc l'entr√©e <b>Reset</b> est toujours connect√©e √† z√©ro, elle consid√®re que lorsque la machine (d√©crite ci-dessous) est dans l'√©tat One, elle se charge dans tous les autres √©tats (au d√©but, j'ai s√©lectionn√© des √©tats sp√©cifiques de la machine, mais il s'est av√©r√© qu'avec une m√©thode aussi d√©licate , beaucoup moins de ressources PLD sont n√©cessaires, mais le r√©sultat est le m√™me).  La valeur de charge est d√©cimale 92. Vrai, un bon √©diteur remplacera imm√©diatement cette valeur par hexad√©cimal: <br><br><img src="https://habrastorage.org/webt/qt/h0/nv/qth0nvcbb_8m7qty2mj1zpde2m4.png"><br><br>  Lorsque le compteur est compt√© jusqu'√† z√©ro, il le signale √† la cha√Æne avec le nom <b>One_Finished</b> .  Avec le compteur - c'est tout. <br><br>  Quel type d'indicateur d'√©tat notre machine utilisera-t-elle?  Je l'ai comme √ßa (je vous rappelle de double-cliquer sur la liste des sorties dans Datapath pour les param√©trer): <br><br><img src="https://habrastorage.org/webt/mk/oo/z_/mkooz_ywbi5vnaenpgfqo98p580.png"><br><br><img src="https://habrastorage.org/webt/br/u9/rz/bru9rzw4kk4ja4j6ehutvm7od14.png"><br><br>  J'utiliserai la batterie A0 comme compteur pendant la dur√©e de l'impulsion, donc lorsque sa valeur atteindra z√©ro, le drapeau auquel j'ai donn√© le nom <b>Pulse_Finished</b> sera arm√©.  La batterie A1 comptera des impulsions pour moi.  Par cons√©quent, sa mise √† z√©ro <b>armera</b> le drapeau <b>Process_Finished</b> . <br><br>  Nous construisons le graphe de transition de l'automate: <br><br><img src="https://habrastorage.org/webt/bv/rr/cv/bvrrcv0pgjs9fvadt08iyqaj92i.png"><br><br>  La variable qui d√©finit son √©tat est appel√©e <b>√âtat</b> .  Mappez imm√©diatement cette variable au registre d'adresses de l'instruction ALU.  Au d√©but, j'ai oubli√© de le faire, donc pendant longtemps je n'ai pas pu comprendre pourquoi ma machine ne fonctionnait pas.  Double-cliquez sur le bloc d'entr√©es dans Datapath: <br><br><img src="https://habrastorage.org/webt/zl/z2/e0/zlz2e0tvkl11wc5ot0id4vsdnh4.png"><br><br>  Et correspondre: <br><br><img src="https://habrastorage.org/webt/1e/sp/q1/1espq1co36mt063kgyvig-kzhsw.png"><br><br>  Nous commen√ßons √† traiter le graphe de transition et les instructions ALU qui lui sont associ√©es. <br><br>  Commen√ßons par l'√©tat de <b>veille</b> .  Il est assez satur√© dans ses actions. <br><br>  Tout d'abord, la valeur des registres de donn√©es D0 et D1 est constamment plac√©e dans les batteries A0 et A1, respectivement: <br><br><img src="https://habrastorage.org/webt/hz/8p/c-/hz8pc-lydhvzq3cnvsg2jw2qcem.png"><br><br>  √Ä partir de cette entr√©e, l'≈ìil exerc√© verra tout ce dont vous avez besoin.  Puisque nos yeux ne sont toujours pas fix√©s, nous double-cliquez sur l'entr√©e et voyons la m√™me chose, mais plus en d√©tail: <br><br><img src="https://habrastorage.org/webt/yu/yy/qe/yuyyqemtvqbcsp25mbud7y3y1mu.png"><br><br>  La valeur principale ici est de remplir la batterie A1, le compteur d'impulsions.  Lorsque le programme entre dans la valeur D1, il passe imm√©diatement √† A1.  Le programme n'aura certainement pas le temps de d√©marrer le processus jusqu'√† la prochaine mesure.  Cette valeur est v√©rifi√©e pour former une condition de sortie de cet √©tat, c'est-√†-dire qu'il n'y a nulle part ailleurs o√π la remplir. <br><br>  Voyons maintenant ce qui se fait au niveau du graphe de transition: <br><br><img src="https://habrastorage.org/webt/97/p-/2d/97p-2dwdvbxyb_tpi-xaqjdhuck.png"><br><br>  Le d√©clencheur auxiliaire <b>Start_Prev vous</b> permet d'attraper un <b>front</b> positif √† l'entr√©e <b>Start</b> , en organisant une ligne √† retard pour 1 cycle.  Il contiendra toujours l'√©tat de l'entr√©e <b>Start</b> , qui √©tait sur la mesure pr√©c√©dente.  Quelqu'un conna√Æt mieux cela dans Verilog: <br><br><img src="https://habrastorage.org/webt/mm/pc/vw/mmpcvwuturlr5nieqnkgieml_tm.png"><br><br><div class="spoiler">  <b class="spoiler_title">M√™me texte</b> <div class="spoiler_text"><pre><code class="plaintext hljs">always @ (posedge clock) begin : Idle_state_logic case(State) Idle : begin Start_Prev &lt;= (Start); IsIdle &lt;= (1); if (( Start&amp;(!Start_Prev)&amp;(!Process_Finished) ) == 1'b1) begin State &lt;= One ; end end</code> </pre> <br></div></div><br>  Par cons√©quent, la condition <b>Start &amp; (! Start_Prev) n'est</b> vraie que lorsqu'une diff√©rence de ligne de <b>d√©part</b> positive <b>se produit entre les mesures</b> . <br><br>  De plus, lorsque la machine est dans cet √©tat, la sortie <b>IsIdle</b> est <b>amen√©e</b> dans un √©tat unique, informant l'environnement externe que le bloc est passif.  Avec cette approche, moins de ressources PLD sont d√©pens√©es que si la construction <b>State == Idle</b> √©tait soumise √† la sortie. <br><br>  Lorsque la diff√©rence de signal de <b>d√©marrage</b> provient de l'environnement externe et que l'accumulateur A1 a une valeur non nulle, la machine <b>quitte l'</b> √©tat <b>inactif</b> .  Si z√©ro est entr√© dans A1, le moteur n'est pas impliqu√© dans le d√©veloppement de ce segment, de sorte que la diff√©rence sur la ligne de <b>d√©part</b> est ignor√©e.  Cela s'applique √† une extrudeuse non utilis√©e.  Pour certaines imprimantes, le moteur de l'axe Z est √©galement rarement utilis√©. Permettez-moi de vous rappeler comment une condition est form√©e qui r√©v√®le une valeur nulle dans A1 (et non nulle est son inversion): <br><br><img src="https://habrastorage.org/webt/ez/kk/up/ezkkuprcmblrfjx22av9dlfu5bc.png"><br><br>  Ensuite, la machine entre dans l'√©tat <b>One</b> : <br><br><img src="https://habrastorage.org/webt/zr/qc/cm/zrqccmzwghfncwcqyfekuhawmcg.png"><br><br>  Dans cet √©tat, la sortie <b>Step</b> est d√©finie sur 1. Une impulsion Step est appliqu√©e au pilote.  De plus, la valeur du d√©clencheur <b>IsIdle</b> est <b>r√©initialis√©e</b> .  L'environnement externe est inform√© que l'unit√© est en phase active. <br><br>  Cet √©tat est <b>quitt√©</b> par le signal <b>One_Finished</b> , qui sera √©lev√© √† un lorsque le compteur √† sept bits comptera jusqu'√† z√©ro.  Permettez-moi de vous rappeler que le signal <b>One_Finished est</b> g√©n√©r√© par ce compteur particulier: <br><br><img src="https://habrastorage.org/webt/ls/yp/re/lsypreow8ydou_tqhrls8us-qem.png"><br><br>  Pendant que la machine est dans cet √©tat, l'ALU charge dans la batterie A0 (r√©glage de la dur√©e d'impulsion) la valeur du registre D0.  Permettez-moi de vous montrer seulement une courte note disant ceci: <br><br><img src="https://habrastorage.org/webt/am/b_/fa/amb_faw1o-9vsgframn5iswseas.png"><br><br>  La valeur charg√©e sera utilis√©e dans l'√©tat suivant.  En y √©tant, la machine g√©n√®re un retard qui r√®gle la dur√©e de l'impulsion: <br><br><img src="https://habrastorage.org/webt/hh/eb/kf/hhebkfiwmsmnnrtkf17w2wqby8o.png"><br><br>  La sortie <b>Step</b> est remise √† z√©ro.  La batterie A0 diminue, comme en t√©moigne la br√®ve entr√©e suivante: <br><br><img src="https://habrastorage.org/webt/bb/63/dk/bb63dkglkjd8_7wn1s2by22_hym.png"><br><br>  Et si vous double-cliquez dessus - une entr√©e compl√®te: <br><br><img src="https://habrastorage.org/webt/-8/6d/ry/-86dryefyslh1qsvlo4ggkdojhg.png"><br><br>  Lorsque la valeur de A0 atteint z√©ro, le drapeau Pules_Finished sera lev√© et la machine passera √† l'√©tat <b>d√©cr√©menter</b> : <br><br><img src="https://habrastorage.org/webt/6k/sw/yv/6kswyvakmiszucfe1cx49pjcyig.png"><br><br>  Dans cet √©tat, en ALU, la valeur de l'accumulateur A1 diminue, ce qui fixe le nombre d'impulsions: <br><br><img src="https://habrastorage.org/webt/ci/9r/1e/ci9r1ervyzj1gyma_tpj4uxnzfq.png"><br><br>  Version compl√®te du dossier: <br><br><img src="https://habrastorage.org/webt/l9/dk/hy/l9dkhy0a6bb2bqpzgmzgtox7clk.png"><br><br>  Selon le r√©sultat, une transition soit vers l'impulsion suivante, soit vers l'√©tat de <b>veille</b> se produit.  Double-cliquez sur l'√©tat pour voir les transitions en tenant compte des priorit√©s: <br><br><img src="https://habrastorage.org/webt/jm/r-/7n/jmr-7nle2advdfl95fn8hnkid0i.png"><br><br>  En fait, avec tout UDB.  Maintenant, nous faisons le symbole correspondant.  Pour ce faire, cliquez avec le bouton droit sur l'√©diteur et s√©lectionnez <b>G√©n√©rer un symbole</b> : <br><br><img src="https://habrastorage.org/webt/j6/j3/qc/j6j3qcgoye9-2gac8fgowordfx8.png"><br><br>  Nous allons au sch√©ma du projet: <br><br><img src="https://habrastorage.org/webt/ab/hb/l4/abhbl4ocjtfgw8r4vjfo8nfs05c.png"><br><br>  Et nous introduisons un circuit dans lequel il y a un certain nombre de ces contr√¥leurs.  J'en ai choisi cinq (trois axes plus deux extrudeuses).  Les imprimantes avec un grand nombre d'extrudeuses ne seront pas consid√©r√©es comme bon march√©.  Vous pouvez y mettre FPGA.  En chemin, pour voir la vraie complexit√©, j'ai jet√© un bloc USB-UART (pour recevoir des donn√©es d'un ordinateur ou du m√™me Raspberry Pi) et un vrai UART (il fournira la communication avec un module Wi-Fi bon march√© ESP8266 ou, disons, un √©cran intelligent qui peut envoyer GCODE via UART).  Je n'ai pas ajout√© de PWM et ainsi de suite, car leur complexit√© est √† peu pr√®s claire et le vrai syst√®me est encore loin.  Il s'est av√©r√© en quelque sorte comme ceci: <br><br><img src="https://habrastorage.org/webt/he/a6/ok/hea6okfr7irbrzjwm-bze2xlfxy.png"><br><br>  Le registre de contr√¥le g√©n√®re un signal de d√©clenchement, qui va √† tous les blocs simultan√©ment.  De plus, laissez sortir des signaux qui sont statiques lors de la formation du segment.  J'ai collect√© toutes les sorties <b>inactives</b> par "Et" et appliqu√© √† l'entr√©e d'interruption.  J'ai nomm√© une interruption sur un front positif.  Si au moins un moteur d√©marre, l'entr√©e d'interruption sera r√©initialis√©e.  √Ä la fin du dernier moteur, il sera arm√©, ce qui informera le processeur de l'√©tat de pr√©paration pour la conclusion du segment suivant.  Ajustez maintenant les fr√©quences en double-cliquant sur l'√©l√©ment d'arbre <b>Horloges</b> : <br><br><img src="https://habrastorage.org/webt/zy/yf/kl/zyyfklrmcfz5kmg-59qmzgdztug.png"><br><br>  Dans le tableau qui appara√Æt, double-cliquez sur l'√©l√©ment <b>PLL_OUT</b> : <br><br><img src="https://habrastorage.org/webt/8z/m0/r1/8zm0r10tu28rjatkhmo1h0skp80.png"><br><br>  Nous allons remplir le tableau d'une mani√®re ou d'une autre (je n'ai pas assez bien compris les r√®gles de configuration de ce tableau, c'est pourquoi j'utilise le terme "quelque chose comme √ßa"): <br><br><img src="https://habrastorage.org/webt/se/55/ps/se55ps9rti9fyvyguffgxdx0f0i.png"><br><br>  Maintenant, double-cliquez sur la ligne <b>Clock_1</b> : <br><br><img src="https://habrastorage.org/webt/vn/py/px/vnpypxluipgeeme1fyf9icn9tu4.png"><br><br>  R√©glez la fr√©quence d'horloge des blocs UDB sur 48 MHz: <br><br><img src="https://habrastorage.org/webt/8z/sk/ik/8zskik6rpyovzo7ryqrxjeptinm.png"><br><br>  Comme le projet est exp√©rimental, cela n'a aucun sens de lui faire une API.  Mais afin de consolider le mat√©riel √©tudi√© dans l'article pr√©c√©dent, nous allons de nouveau dans l'onglet Composants et pour le projet StepperController, cliquez avec le bouton droit sur Ajouter un √©l√©ment de composant, nous ajoutons d'abord le fichier d'en-t√™te, puis le fichier de code source C: <br><br><img src="https://habrastorage.org/webt/3i/bg/zk/3ibgzkq8nugwau5lszhe9ikudxi.png"><br><br><img src="https://habrastorage.org/webt/bm/k3/iw/bmk3iwh-aouvspv20g7_1bgi3wq.png"><br><br>  Je vais montrer superficiellement les deux fonctions d'initialisation et de d√©but du segment que j'ai ajout√©.  Le reste peut √™tre vu dans l'exemple de l'article. <br><br><pre> <code class="plaintext hljs">void `$INSTANCE_NAME`_Start() { `$INSTANCE_NAME`_SingleVibrator_Start(); //"One" Generator start } void `$INSTANCE_NAME`_PrepareStep(int nSteps,int duration) { CY_SET_XTND_REG24(`$INSTANCE_NAME`_Datapath_1_D0_PTR, duration&gt;92?duration-92:0); CY_SET_XTND_REG24(`$INSTANCE_NAME`_Datapath_1_D1_PTR, nSteps&gt;1?nSteps-1:0); }</code> </pre><br>  J'ai remplac√© le nom de <b>main.c</b> par <b>main.cpp</b> pour v√©rifier que l'environnement de d√©veloppement r√©pondra normalement √† C ++, car le firmware Marlin est orient√© objet.  Des erreurs pr√©visibles qui ont √©t√© √©limin√©es de mani√®re pr√©visible par l'ajout d'un √©l√©ment r√©gulier: <br><br><img src="https://habrastorage.org/webt/5m/mn/cd/5mmncdgxig9oxchcekaofuv1k9y.png"><br><br><div class="spoiler">  <b class="spoiler_title">M√™me texte</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">extern "C" { #include "project.h" }</code> </pre><br></div></div><br>  Pour le lancement mondial des moteurs, j'ai fait une telle fonction (c'est tr√®s rude, mais pour des exp√©riences avec un cheval sph√©rique dans le vide, √ßa va faire, dans les exp√©riences le temps de d√©veloppement est plus important que la beaut√©): <br><pre> <code class="plaintext hljs">void StartSteppers() { Stepper_Control_Reg_Write (1); Stepper_Control_Reg_Write (1); Stepper_Control_Reg_Write (1); Stepper_Control_Reg_Write (0); }</code> </pre><br>  Elle d√©marre le signal de <b>d√©marrage</b> , juste au cas o√π, imm√©diatement pendant trois mesures, puis le rel√¢che. <br><br>  Eh bien, commen√ßons les exp√©riences.  Tout d'abord, passez simplement sur les moteurs X et Y (dans l'exemple, le premier groupe d'appels initialise tous les contr√¥leurs, le second d√©finit les contr√¥leurs X et Y sur le nombre d'√©tapes requis et d√©marre le processus): <br><br><pre> <code class="plaintext hljs">int main(void) { CyGlobalIntEnable; /* Enable global interrupts. */ StepperController_X_Start(); StepperController_Y_Start(); StepperController_Z_Start(); StepperController_E0_Start(); StepperController_E1_Start(); StepperController_X_PrepareStep (10,1000); //    StepperController_Y_PrepareStep (50,500); StartSteppers(); //   for(;;) { } }</code> </pre><br>  Nous regardons le r√©sultat: <br><br><img src="https://habrastorage.org/webt/6x/io/v7/6xiov7g15a-ksl1_6kw7vkko0dc.png"><br><br>  V√©rifiez la dur√©e de l'impulsion positive: <br><br><img src="https://habrastorage.org/webt/ay/hk/jy/ayhkjyjphl4-pearn7zi3hnnknc.png"><br><br>  C'est vrai.  Enfin, nous v√©rifions le bon fonctionnement de l'interruption.  Ajoutez une variable de compteur globale: <br><br><pre> <code class="plaintext hljs">static int nStep=0;</code> </pre><br>  Cette variable est affect√©e √† une dans la fonction <b>principale</b> et augmente dans la fonction de gestionnaire d'interruption.  Le gestionnaire d'interruption ne se d√©clenche qu'une seule fois, uniquement √† des fins de v√©rification.  Je l'ai fait comme √ßa: <br><br><pre> <code class="plaintext hljs">extern "C" { CY_ISR(StepperFinished) { if (nStep == 1) { StepperController_X_PrepareStep (5,500); StartSteppers(); nStep += 1; } } }</code> </pre><br>  Et dans la fonction <b>principale</b> , j'ai ajout√© litt√©ralement deux lignes: l'inclusion des interruptions et l'affectation de cette m√™me variable.  Et j'attribue d√©j√† quand les machines ont d√©marr√©.  Sinon, une fausse demande d'interruption est venue.  Il n'y a aucune raison particuli√®re de le combattre maintenant.  Le projet est exp√©rimental. <br><br><img src="https://habrastorage.org/webt/kb/v2/dm/kbv2dmk2s6cg9nzc9fjzypg5uyo.png"><br><br><div class="spoiler">  <b class="spoiler_title">M√™me texte</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">int main(void) { CyGlobalIntEnable; /* Enable global interrupts. */ isr_1_StartEx(StepperFinished); StepperController_X_Start(); StepperController_Y_Start(); StepperController_Z_Start(); StepperController_E0_Start(); StepperController_E1_Start(); /* Place your initialization/startup code here (eg MyInst_Start()) */ StepperController_X_PrepareStep (10,1000); StepperController_Y_PrepareStep (20,500); StartSteppers(); nStep = 1; for(;;) { } }</code> </pre><br></div></div><br>  Nous v√©rifions le r√©sultat (dans la deuxi√®me √©tape, seul le moteur X devrait fonctionner, et les √©tapes devraient devenir moiti√© moins): <br><br><img src="https://habrastorage.org/webt/0q/vi/iq/0qviiqvpko6m9i7o9tub3gmnqhw.png"><br><br>  C'est vrai. <br><br><h2>  Conclusion </h2><br>  En g√©n√©ral, il est d√©j√† clair que les blocs UDB peuvent √™tre utilis√©s non seulement pour d√©finir des fonctions mat√©rielles rapides, mais aussi pour d√©placer la logique du logiciel au niveau du micrologiciel.  Malheureusement, le volume de l'article s'est av√©r√© si important qu'il n'est pas possible de terminer la revue et d'obtenir une r√©ponse non ambigu√´ si les capacit√©s UDB sont suffisantes pour la solution finale de la t√¢che.  Jusqu'√† pr√©sent, seul un cheval sph√©rique est pr√™t dans le vide, dont les actions sont en principe tr√®s similaires √† celles requises, mais un lecteur ennuyeux familiaris√© avec la th√©orie de la commande du moteur pas √† pas y trouvera de nombreuses lacunes.  L'unit√© pr√©sent√©e ne prend pas en charge l'acc√©l√©ration, sans laquelle le fonctionnement d'un v√©ritable moteur pas √† pas est impossible.  Au contraire, il prend en charge, mais √† ce stade, un taux d'interruption √©lev√© sera n√©cessaire, et tout a √©t√© con√ßu pour √©viter cela. <br><br>  La pr√©cision du r√©glage de la fr√©quence du bloc pr√©sent√© est loin d'√™tre acceptable.  En particulier, il fournira une fr√©quence d'impulsion de 40 000 Hz avec un diviseur de 1200 et 39966 Hz avec un diviseur de 1201. Les fr√©quences interm√©diaires entre ces deux valeurs sur ce bloc sont inaccessibles. <br><br>  Peut-√™tre y a-t-il d'autres lacunes.  Mais nous les traiterons dans le prochain article pour v√©rifier s'il y a suffisamment de ressources UDB. <br><br>  Dans l'intervalle, les lecteurs ont re√ßu, entre autres, un v√©ritable exemple de cr√©ation d'un bloc bas√© sur UDB √† partir de z√©ro.  Le projet de test obtenu lors de la r√©daction de cet article <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">peut √™tre pris ici</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr433800/">https://habr.com/ru/post/fr433800/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr433788/index.html">Offre s√©curis√©e et nouveaux avis ind√©pendants</a></li>
<li><a href="../fr433790/index.html">Mod√®les de construction avanc√©s en plusieurs √©tapes</a></li>
<li><a href="../fr433792/index.html">Scripts shell dans Ansible</a></li>
<li><a href="../fr433796/index.html">Comment Homo Sapiens a conquis le monde. Comp√©tences en communication et n√©gociation</a></li>
<li><a href="../fr433798/index.html">HomeKit et ioBroker Faisons des amis √† la maison</a></li>
<li><a href="../fr433802/index.html">Comment et pourquoi nous avons remport√© la piste Big Data au Urban Tech Challenge Hackathon</a></li>
<li><a href="../fr433804/index.html">R√©seaux de densit√© de m√©lange</a></li>
<li><a href="../fr433806/index.html">Quand l'archive en ligne oublie</a></li>
<li><a href="../fr433808/index.html">5 erreurs les plus courantes commises par les programmeurs lors de l'entretien</a></li>
<li><a href="../fr433810/index.html">Une approche orient√©e probl√®me des projets de marketing Internet</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>