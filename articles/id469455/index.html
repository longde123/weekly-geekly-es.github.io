<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üö¥üèº ü§Ωüèª üõèÔ∏è Bermigrasi dari Nginx ke Utusan Proksi üëßüèª üòå üë∑üèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Halo, Habr! Saya membawa perhatian Anda pada terjemahan pos: Migrasi dari Nginx ke Utusan Utusan . 


 Utusan adalah server proxy terdistribusi kinerj...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Bermigrasi dari Nginx ke Utusan Proksi</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/469455/"><p>  Halo, Habr!  Saya membawa perhatian Anda pada terjemahan pos: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Migrasi dari Nginx ke Utusan Utusan</a> . </p><br><p>  Utusan adalah server proxy terdistribusi kinerja tinggi (ditulis dalam C ++) yang dirancang untuk layanan dan aplikasi individual, juga merupakan bus komunikasi dan "pesawat data universal" yang dirancang untuk arsitektur "service mesh" layanan mikro yang besar.  Saat membuat itu, solusi untuk masalah yang muncul selama pengembangan server seperti NGINX, HAProxy, penyeimbang beban perangkat keras, dan penyeimbang beban awan turut diperhitungkan.  Utusan bekerja dengan setiap aplikasi dan abstrak jaringan, menyediakan fungsi-fungsi umum tanpa memandang platform.  Ketika semua lalu lintas kantor dalam infrastruktur melewati grid Utusan, menjadi mudah untuk memvisualisasikan area bermasalah dengan kemampuan pengamatan yang konsisten, penyempurnaan kinerja keseluruhan, dan menambahkan fungsi dasar di lokasi tertentu. </p><br><h2 id="vozmozhnosti">  Kemungkinan </h2><br><ul><li> Arsitektur di luar proses: utusan adalah server mandiri berperforma tinggi yang mengkonsumsi sejumlah kecil RAM.  Ia bekerja bersama dengan bahasa aplikasi atau kerangka kerja apa pun. </li><li>  Dukungan untuk http / 2 dan grpc: utusan memiliki dukungan kelas satu untuk http / 2 dan grpc untuk koneksi masuk dan keluar.  Ini adalah proxy transparan dari http / 1.1 ke http / 2. </li><li>  Penyeimbangan beban yang ditingkatkan: utusan mendukung fitur-fitur penyeimbangan beban tingkat lanjut, termasuk percobaan ulang otomatis, sirkuit terbuka, batasan kecepatan global, permintaan bayangan, keseimbangan beban zona lokal, dll. </li><li>  API Manajemen Konfigurasi: utusan menyediakan API yang kuat untuk mengelola konfigurasinya secara dinamis. </li><li>  Pengamatan: pengamatan lalu lintas L7 yang dalam, dukungan bawaan untuk penelusuran terdistribusi dan pengamatan mongodb, dynamodb, dan banyak aplikasi lainnya. </li></ul><a name="habracut"></a><br><h2 id="shag-1---primer-konfiga-nginx">  Langkah 1 - Contoh NGINX Config </h2><br><p>  Script ini menggunakan file <em>nginx.conf yang</em> dibuat khusus, berdasarkan contoh lengkap dari <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Wiki NGINX</a> .  Anda dapat melihat konfigurasi di editor dengan membuka <em>nginx.conf</em> </p><br><p>  Sumber nginx config </p><br><pre><code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">user</span></span> www www; <span class="hljs-attribute"><span class="hljs-attribute">pid</span></span> /var/run/nginx.pid; <span class="hljs-attribute"><span class="hljs-attribute">worker_processes</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-section"><span class="hljs-section">events</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">worker_connections</span></span> <span class="hljs-number"><span class="hljs-number">2000</span></span>; } <span class="hljs-section"><span class="hljs-section">http</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">gzip</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">gzip_min_length</span></span> <span class="hljs-number"><span class="hljs-number">1100</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">gzip_buffers</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">8k</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">gzip_types</span></span> text/plain; <span class="hljs-attribute"><span class="hljs-attribute">log_format</span></span> main <span class="hljs-string"><span class="hljs-string">'</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$remote_addr</span></span></span><span class="hljs-string"> - </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$remote_user</span></span></span><span class="hljs-string"> [</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$time_local</span></span></span><span class="hljs-string">] '</span></span> <span class="hljs-string"><span class="hljs-string">'"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$request</span></span></span><span class="hljs-string">" </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$status</span></span></span><span class="hljs-string"> </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$bytes_sent</span></span></span><span class="hljs-string"> '</span></span> <span class="hljs-string"><span class="hljs-string">'"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$http_referer</span></span></span><span class="hljs-string">" "</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$http_user_agent</span></span></span><span class="hljs-string">" '</span></span> <span class="hljs-string"><span class="hljs-string">'"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$gzip_ratio</span></span></span><span class="hljs-string">"'</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">log_format</span></span> download <span class="hljs-string"><span class="hljs-string">'</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$remote_addr</span></span></span><span class="hljs-string"> - </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$remote_user</span></span></span><span class="hljs-string"> [</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$time_local</span></span></span><span class="hljs-string">] '</span></span> <span class="hljs-string"><span class="hljs-string">'"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$request</span></span></span><span class="hljs-string">" </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$status</span></span></span><span class="hljs-string"> </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$bytes_sent</span></span></span><span class="hljs-string"> '</span></span> <span class="hljs-string"><span class="hljs-string">'"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$http_referer</span></span></span><span class="hljs-string">" "</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$http_user_agent</span></span></span><span class="hljs-string">" '</span></span> <span class="hljs-string"><span class="hljs-string">'"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$http_range</span></span></span><span class="hljs-string">" "</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$sent_http_content_range</span></span></span><span class="hljs-string">"'</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">upstream</span></span> targetCluster { 172.18.0.3:80; 172.18.0.4:80; } <span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> <span class="hljs-number"><span class="hljs-number">8080</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">server_name</span></span> one.example.com www.one.example.com; <span class="hljs-attribute"><span class="hljs-attribute">access_log</span></span> /var/log/nginx.access_log main; <span class="hljs-attribute"><span class="hljs-attribute">error_log</span></span> /var/log/nginx.error_log <span class="hljs-literal"><span class="hljs-literal">info</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> / { <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> http://targetCluster/; <span class="hljs-attribute"><span class="hljs-attribute">proxy_redirect</span></span> <span class="hljs-literal"><span class="hljs-literal">off</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> Host <span class="hljs-variable"><span class="hljs-variable">$host</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-Real-IP <span class="hljs-variable"><span class="hljs-variable">$remote_addr</span></span>; } } }</code> </pre> <br><p>  Konfigurasi NGINX biasanya memiliki tiga elemen kunci: </p><br><ol><li>  Mengkonfigurasi server NGINX, struktur log, dan fungsionalitas Gzip.  Ini ditentukan secara global dalam semua kasus. </li><li>  Mengkonfigurasi NGINX untuk menerima permintaan untuk satu <em>host.example.com</em> pada port 8080. </li><li>  Menetapkan lokasi tujuan Anda, cara menangani lalu lintas untuk berbagai bagian URL. </li></ol><br><p>  Tidak semua konfigurasi akan diterapkan ke Utusan Proksi, dan Anda tidak perlu mengkonfigurasi beberapa pengaturan.  Utusan Proksi memiliki <strong>empat jenis utama</strong> yang mendukung infrastruktur dasar yang ditawarkan oleh NGINX.  Intinya adalah: </p><br><ul><li>  <strong>Pendengar:</strong> Mereka menentukan bagaimana Utusan Utusan menerima permintaan yang masuk.  Utusan Proksi saat ini hanya mendukung pendengar berbasis TCP.  Setelah koneksi dibuat, itu ditransfer ke satu set filter untuk diproses. </li><li>  <strong>Filter:</strong> Mereka adalah bagian dari arsitektur pipelined yang dapat memproses data yang masuk dan keluar.  Fungsionalitas ini mencakup filter, seperti Gzip, yang memampatkan data sebelum mengirimnya ke klien. </li><li>  <strong>Router:</strong> Mereka mengarahkan lalu lintas ke tujuan yang diinginkan, didefinisikan sebagai sebuah cluster. </li><li>  <strong>Cluster:</strong> Mereka menentukan titik akhir untuk pengaturan lalu lintas dan konfigurasi. </li></ul><br><p>  Kami akan menggunakan keempat komponen ini untuk membuat konfigurasi Proxy Utusan agar sesuai dengan konfigurasi NGINX tertentu.  Tujuan utusan itu bekerja dengan API dan konfigurasi dinamis.  Dalam hal ini, konfigurasi dasar akan menggunakan parameter statis, kode-keras dari NGINX. </p><br><h2 id="shag-2---konfiguraciya-nginx">  Langkah 2 - Konfigurasikan NGINX </h2><br><p>  Bagian pertama dari <em>nginx.conf</em> mendefinisikan beberapa komponen NGINX internal yang perlu dikonfigurasi. </p><br><h4 id="worker-connections-rabochie-soedineniya">  Koneksi Pekerja </h4><br><p>  Konfigurasi di bawah ini menentukan jumlah proses kerja dan koneksi.  Ini menunjukkan bagaimana NGINX akan berskala untuk memenuhi permintaan. </p><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">worker_processes</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-section"><span class="hljs-section">events</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">worker_connections</span></span> <span class="hljs-number"><span class="hljs-number">2000</span></span>; }</code> </pre> <br><p>  Utusan Proxy mengelola alur kerja dan koneksi secara berbeda. </p><br><p>  Utusan menciptakan alur kerja untuk setiap utas perangkat keras dalam sistem.  Setiap thread pekerja menjalankan loop acara non-blocking yang bertanggung jawab untuk </p><br><ol><li>  Mendengarkan setiap pendengar </li><li>  Terima koneksi baru </li><li>  Membuat set filter untuk koneksi </li><li>  Menangani semua operasi I / O selama masa koneksi. </li></ol><br><p>  Semua pemrosesan koneksi lebih lanjut sepenuhnya diproses dalam alur kerja, termasuk perilaku penerusan apa pun. </p><br><p>  Untuk setiap alur kerja di Utusan, ada koneksi di kolam.  Dengan demikian, kumpulan koneksi HTTP / 2 hanya membangun satu koneksi untuk setiap host eksternal sekaligus, jika ada empat utas pekerja, akan ada empat koneksi HTTP / 2 untuk setiap host eksternal dalam kondisi stabil.  Dengan menyimpan semuanya dalam satu alur kerja, hampir semua kode dapat ditulis tanpa mengunci, seolah-olah itu adalah single-threaded.  Jika lebih dari alur kerja yang diperlukan dialokasikan, ini dapat mengarah pada penggunaan memori yang tidak rasional, penciptaan sejumlah besar koneksi idle dan penurunan jumlah koneksi yang dikembalikan ke pool. </p><br><p>  Untuk informasi lebih lanjut, kunjungi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">blog Utusan Proksi</a> . </p><br><h4 id="konfiguraciya-http">  Konfigurasi HTTP </h4><br><p>  Blok konfigurasi NGINX berikut mendefinisikan pengaturan HTTP, seperti: </p><br><ul><li>  Jenis mime apa yang didukung </li><li>  Batas waktu default </li><li>  Konfigurasi gzip </li></ul><br><p>  Anda dapat mengkonfigurasi aspek-aspek ini menggunakan filter di Utusan Proksi, yang akan kita bahas nanti. </p><br><h2 id="shag-3---konfiguraciya-server">  Langkah 3 - Konfigurasi Server </h2><br><p>  Di blok konfigurasi HTTP, konfigurasi NGINX memerintahkan Anda untuk mendengarkan pada port 8080 dan menanggapi permintaan masuk untuk domain <em>one.example.com</em> dan <em>www.one.example.com</em> . </p><br><pre> <code class="nginx hljs"> <span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> <span class="hljs-number"><span class="hljs-number">8080</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">server_name</span></span> one.example.com www.one.example.com;</code> </pre> <br><p>  Di dalam Utusan, para Pendengar mengendalikannya. </p><br><h4 id="slushateli-envoy">  Utusan pendengar </h4><br><p>  Aspek paling penting untuk memulai dengan Utusan Utusan adalah mengidentifikasi pendengar.  Anda perlu membuat file konfigurasi yang menjelaskan bagaimana Anda ingin menjalankan instance Utusan. </p><br><p>  Cuplikan di bawah ini akan membuat pendengar baru dan mengaitkannya dengan port 8080. Konfigurasi tersebut memberi tahu Envoy Proxy port mana yang harus terikat untuk permintaan yang masuk. </p><br><p>  Utusan Proksi menggunakan notasi YAML untuk konfigurasinya.  Untuk membiasakan diri dengan notasi ini, lihat <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">tautan di</a> sini. </p><br><pre> <code class="plaintext hljs">Copy to Editorstatic_resources: listeners: - name: listener_0 address: socket_address: { address: 0.0.0.0, port_value: 8080 }</code> </pre> <br><p>  Tidak perlu mendefinisikan <em>server_name</em> , karena filter Proxy Utusan dapat menangani ini. </p><br><h2 id="shag-4---konfiguraciya-mestopolozheniya">  Langkah 4 - Konfigurasi Lokasi </h2><br><p>  Saat permintaan tiba di NGINX, blok lokasi menentukan cara memproses dan ke mana mengarahkan lalu lintas.  Dalam fragmen berikut, semua lalu lintas ke situs ditransmisikan ke cluster hulu (catatan penerjemah: hulu biasanya server aplikasi) bernama <em>targetCluster</em> .  Cluster upstream mendefinisikan node yang harus memproses permintaan.  Kami akan membahas ini di langkah berikutnya. </p><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">location</span></span> / { <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> http://targetCluster/; <span class="hljs-attribute"><span class="hljs-attribute">proxy_redirect</span></span> <span class="hljs-literal"><span class="hljs-literal">off</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> Host <span class="hljs-variable"><span class="hljs-variable">$host</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-Real-IP <span class="hljs-variable"><span class="hljs-variable">$remote_addr</span></span>; }</code> </pre> <br><p>  Di Utusan, Filter melakukan ini. </p><br><h4 id="envoy-filters">  Filter utusan </h4><br><p>  Untuk konfigurasi statis, filter menentukan cara menangani permintaan yang masuk.  Dalam hal ini, kami menetapkan filter yang cocok dengan nama <em>server</em> pada langkah sebelumnya.  Ketika permintaan masuk tiba yang sesuai dengan domain dan rute tertentu, lalu lintas dialihkan ke kluster.  Ini setara dengan konfigurasi hulu NGINX. </p><br><pre> <code class="plaintext hljs">Copy to Editor filter_chains: - filters: - name: envoy.http_connection_manager config: codec_type: auto stat_prefix: ingress_http route_config: name: local_route virtual_hosts: - name: backend domains: - "one.example.com" - "www.one.example.com" routes: - match: prefix: "/" route: cluster: targetCluster http_filters: - name: envoy.router</code> </pre> <br><p>  Nama <em>envoy.http_connection_manager</em> adalah <em>filter bawaan</em> di Envoy Proxy.  Filter lain termasuk <em>Redis</em> , <em>Mongo</em> , <em>TCP</em> .  Anda dapat menemukan daftar lengkap dalam <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">dokumentasi</a> . </p><br><p>  Untuk informasi lebih lanjut tentang kebijakan penyeimbangan beban lainnya, kunjungi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Dokumentasi Utusan</a> . </p><br><h2 id="step-5---proxy-and-upstream-configuration">  Langkah 5 - Konfigurasi Proxy dan Hulu </h2><br><p>  Di NGINX, konfigurasi hulu menentukan kumpulan server target yang akan menangani lalu lintas.  Dalam hal ini, dua kelompok ditugaskan. </p><br><pre> <code class="nginx hljs"> <span class="hljs-attribute"><span class="hljs-attribute">upstream</span></span> targetCluster { 172.18.0.3:80; 172.18.0.4:80; }</code> </pre> <br><p>  Dalam Utusan, itu adalah cluster yang dikelola. </p><br><h4 id="envoy-clusters">  Cluster utusan </h4><br><p>  Setara dengan hulu didefinisikan sebagai cluster.  Dalam hal ini, host yang akan melayani lalu lintas diidentifikasi.  Metode mengakses host, seperti batas waktu, didefinisikan sebagai konfigurasi cluster.  Ini memungkinkan Anda untuk mengontrol rincian aspek yang lebih akurat seperti latensi dan penyeimbangan muatan. </p><br><pre> <code class="plaintext hljs">Copy to Editor clusters: - name: targetCluster connect_timeout: 0.25s type: STRICT_DNS dns_lookup_family: V4_ONLY lb_policy: ROUND_ROBIN hosts: [ { socket_address: { address: 172.18.0.3, port_value: 80 }}, { socket_address: { address: 172.18.0.4, port_value: 80 }} ]</code> </pre> <br><p>  Saat menggunakan <em>penemuan</em> layanan <em>STRICT_DNS,</em> Utusan akan terus-menerus dan secara tidak sinkron menyelesaikan target DNS yang ditentukan.  Setiap alamat IP yang dikembalikan sebagai hasil dari DNS akan dianggap sebagai host eksplisit di cluster hulu.  Ini berarti bahwa jika permintaan mengembalikan dua alamat IP, Utusan akan menganggap bahwa ada dua host di cluster, dan keduanya harus memuat seimbang.  Jika host dihapus dari hasilnya, Utusan mengasumsikan bahwa tidak ada lagi dan akan memilih lalu lintas dari kumpulan koneksi yang ada. </p><br><p>  Untuk informasi lebih lanjut, lihat <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Utusan Proksi Utusan</a> . </p><br><h2 id="shag-6---dostup-k-zhurnalu-i-oshibki">  Langkah 6 - Akses Log dan Kesalahan </h2><br><p>  Konfigurasi terakhir adalah pendaftaran.  Alih-alih mentransfer log kesalahan ke disk, Utusan Proksi menggunakan pendekatan berbasis cloud.  Semua log aplikasi ditampilkan dalam <em>stdout</em> dan <em>stderr</em> . </p><br><p>  Saat pengguna mengajukan permintaan, log akses bersifat opsional dan dinonaktifkan secara default.  Untuk mengaktifkan log akses untuk permintaan HTTP, aktifkan konfigurasi <em>access_log</em> untuk Manajer Koneksi HTTP.  Path dapat berupa perangkat, seperti <em>stdout</em> , atau file pada disk, tergantung pada kebutuhan Anda. </p><br><p>  Konfigurasi berikut akan mengarahkan semua log akses ke <em>stdout</em> (catatan penerjemah - stdout diperlukan untuk menggunakan utusan di dalam buruh pelabuhan. Jika Anda menggunakan tanpa buruh pelabuhan, ganti / dev / stdout dengan path ke file log biasa).  Salin cuplikan ke bagian konfigurasi untuk manajer koneksi: </p><br><pre> <code class="plaintext hljs">Copy to Clipboardaccess_log: - name: envoy.file_access_log config: path: "/dev/stdout"</code> </pre> <br><p>  Hasilnya akan terlihat seperti ini: </p><br><pre> <code class="plaintext hljs"> - name: envoy.http_connection_manager config: codec_type: auto stat_prefix: ingress_http access_log: - name: envoy.file_access_log config: path: "/dev/stdout" route_config:</code> </pre> <br><p>  Secara default, Utusan memiliki string format yang mencakup rincian permintaan HTTP: </p><br><pre> <code class="plaintext hljs">[%START_TIME%] "%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%" %RESPONSE_CODE% %RESPONSE_FLAGS% %BYTES_RECEIVED% %BYTES_SENT% %DURATION% %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% "%REQ(X-FORWARDED-FOR)%" "%REQ(USER-AGENT)%" "%REQ(X-REQUEST-ID)%" "%REQ(:AUTHORITY)%" "%UPSTREAM_HOST%"\n</code> </pre> <br><p>  Hasil dari string format ini: </p><br><pre> <code class="bash hljs">[2018-11-23T04:51:00.281Z] <span class="hljs-string"><span class="hljs-string">"GET / HTTP/1.1"</span></span> 200 - 0 58 4 1 <span class="hljs-string"><span class="hljs-string">"-"</span></span> <span class="hljs-string"><span class="hljs-string">"curl/7.47.0"</span></span> <span class="hljs-string"><span class="hljs-string">"f21ebd42-6770-4aa5-88d4-e56118165a7d"</span></span> <span class="hljs-string"><span class="hljs-string">"one.example.com"</span></span> <span class="hljs-string"><span class="hljs-string">"172.18.0.4:80"</span></span></code> </pre> <br><p>  Isi output dapat disesuaikan dengan mengatur bidang format.  Sebagai contoh: </p><br><pre> <code class="plaintext hljs">access_log: - name: envoy.file_access_log config: path: "/dev/stdout" format: "[%START_TIME%] "%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%" %RESPONSE_CODE% %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% "%REQ(X-REQUEST-ID)%" "%REQ(:AUTHORITY)%" "%UPSTREAM_HOST%"\n"</code> </pre> <br><p>  String log juga bisa menjadi output dalam format JSON dengan mengatur bidang <em>json_format</em> .  Sebagai contoh: </p><br><pre> <code class="plaintext hljs">access_log: - name: envoy.file_access_log config: path: "/dev/stdout" json_format: {"protocol": "%PROTOCOL%", "duration": "%DURATION%", "request_method": "%REQ(:METHOD)%"}</code> </pre> <br><p>  Untuk informasi lebih lanjut tentang teknik pendaftaran utusan, kunjungi </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">https://www.envoyproxy.io/docs/envoy/latest/configuration/access_log#config-access-log-format-dictionaries</a> </p><br><p>  Logging bukan satu-satunya cara untuk mendapatkan ide bekerja dengan Utusan Utusan.  Ini memiliki fitur canggih bawaan untuk penelusuran dan metrik.  Anda dapat menemukan lebih banyak dalam <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">dokumentasi penelusuran</a> atau melalui <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Script</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Pelacakan</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Interaktif</a> . </p><br><h2 id="shag-7---zapusk">  Langkah 7 - Luncurkan </h2><br><p>  Sekarang Anda telah mentransfer konfigurasi dari NGINX ke Utusan Proksi.  Langkah terakhir adalah menjalankan instance Proxy Utusan untuk mengujinya. </p><br><h4 id="zapusk-ot-polzovatelya">  Jalankan dari pengguna </h4><br><p>  Di bagian atas konfigurasi NGINX, <em>pengguna</em> garis <em>www www;</em>  menunjukkan bahwa NGINX telah diluncurkan sebagai pengguna dengan hak istimewa rendah untuk meningkatkan keamanan. </p><br><p>  Utusan Proksi mengambil pendekatan berbasis cloud untuk mengelola siapa yang memiliki proses.  Saat kami menjalankan Utusan Proksi melalui wadah, kami dapat menentukan pengguna dengan tingkat privilege rendah. </p><br><h4 id="zapusk-envoy-proxy">  Luncurkan Utusan Utusan </h4><br><p>  Perintah di bawah ini akan meluncurkan Proxy Utusan melalui wadah Docker di host.  Perintah ini menyediakan Utusan dengan kemampuan untuk mendengarkan permintaan masuk melalui port 80. Namun, seperti yang ditunjukkan dalam konfigurasi pendengar, Utusan Proxy mendengarkan lalu lintas masuk melalui port 8080. Ini memungkinkan proses untuk dijalankan sebagai pengguna dengan hak istimewa rendah. </p><br><pre> <code class="bash hljs">docker run --name proxy1 -p 80:8080 --user 1000:1000 -v /root/envoy.yaml:/etc/envoy/envoy.yaml envoyproxy/envoy</code> </pre> <br><h4 id="testirovanie">  Pengujian </h4><br><p>  Dengan proksi berjalan, tes sekarang dapat dilakukan dan diproses.  Perintah cURL berikut ini mengeluarkan permintaan dengan header host yang ditentukan dalam konfigurasi proxy. </p><br><pre> <code class="bash hljs">curl -H <span class="hljs-string"><span class="hljs-string">"Host: one.example.com"</span></span> localhost -i</code> </pre> <br><p>  Permintaan HTTP akan menghasilkan kesalahan <em>503</em> .  Hal ini disebabkan oleh fakta bahwa koneksi hulu tidak berfungsi dan tidak tersedia.  Dengan demikian, Utusan Utusan tidak memiliki tujuan target yang tersedia untuk permintaan tersebut.  Perintah berikut akan meluncurkan serangkaian layanan HTTP yang cocok dengan konfigurasi yang ditentukan untuk Utusan. </p><br><pre> <code class="bash hljs">docker run -d katacoda/docker-http-server; docker run -d katacoda/docker-http-server;</code> </pre> <br><p>  Dengan layanan yang tersedia, Utusan dapat berhasil proxy lalu lintas ke tujuannya. </p><br><pre> <code class="bash hljs">curl -H <span class="hljs-string"><span class="hljs-string">"Host: one.example.com"</span></span> localhost -i</code> </pre> <br><p>  Anda akan melihat respons yang menunjukkan wadah Docker mana yang telah memproses permintaan tersebut.  Dalam Utusan Proksi log, Anda juga harus melihat string akses yang ditampilkan. </p><br><h4 id="dopolnitelnye-zagolovki-otveta-http-http-response">  Header Respon HTTP Tambahan </h4><br><p>  Anda akan melihat tajuk HTTP tambahan di tajuk respons permintaan sebenarnya.  Header menampilkan waktu yang dihabiskan host hulu untuk memproses permintaan.  Ini dinyatakan dalam milidetik.  Ini berguna jika klien ingin menentukan waktu layanan dibandingkan dengan latensi jaringan. </p><br><pre> <code class="plaintext hljs">x-envoy-upstream-service-time: 0 server: envoy</code> </pre> <br><h2 id="itogovyy-konfig">  Konfigurasi terakhir </h2><br><pre> <code class="plaintext hljs">static_resources: listeners: - name: listener_0 address: socket_address: { address: 0.0.0.0, port_value: 8080 } filter_chains: - filters: - name: envoy.http_connection_manager config: codec_type: auto stat_prefix: ingress_http route_config: name: local_route virtual_hosts: - name: backend domains: - "one.example.com" - "www.one.example.com" routes: - match: prefix: "/" route: cluster: targetCluster http_filters: - name: envoy.router clusters: - name: targetCluster connect_timeout: 0.25s type: STRICT_DNS dns_lookup_family: V4_ONLY lb_policy: ROUND_ROBIN hosts: [ { socket_address: { address: 172.18.0.3, port_value: 80 }}, { socket_address: { address: 172.18.0.4, port_value: 80 }} ] admin: access_log_path: /tmp/admin_access.log address: socket_address: { address: 0.0.0.0, port_value: 9090 }</code> </pre> <br><h2 id="dopolnitelnaya-informaciya-ot-perevodchika">  Informasi tambahan dari penerjemah </h2><br><p>  Instruksi pemasangan Utusan Proksi dapat ditemukan di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">https://www.getenvoy.io/</a> </p><br><p>  Secara default dalam rpm tidak ada konfigurasi layanan systemd. </p><br><p>  Tambahkan config layanan systemd /etc/systemd/system/envoy.service: </p><br><pre> <code class="bash hljs">[Unit] Description=Envoy Proxy Documentation=https://www.envoyproxy.io/ After=network-online.target Requires=envoy-auth-server.service Wants=nginx.service [Service] User=root Restart=on-failure ExecStart=/usr/bin/envoy --config-path /etc/envoy/config.yaml [Install] WantedBy=multi-user.target</code> </pre> <br><p>  Anda perlu membuat direktori / etc / utusan / dan meletakkan config.yaml config di sana. </p><br><p>  Dengan proxy utusan ada obrolan telegram: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">https://t.me/envoyproxy_ru</a> </p><br><p>  Utusan Proksi tidak mendukung distribusi konten statis.  Jadi siapa yang dapat memilih fitur: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">https://github.com/envoyproxy/envoy/issues/378</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id469455/">https://habr.com/ru/post/id469455/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id469445/index.html">Tinjauan Umum AngularConnect 2019. Bagian 2</a></li>
<li><a href="../id469447/index.html">Jalur kecerdasan buatan dari ide yang fantastis ke industri ilmiah</a></li>
<li><a href="../id469449/index.html">Sertifikat SSL EV: Apakah Ada Kehidupan Setelah Mati?</a></li>
<li><a href="../id469451/index.html">Filosofi nol</a></li>
<li><a href="../id469453/index.html">Manajemen tim terdistribusi dalam mode multi-proyek (review dan laporan video)</a></li>
<li><a href="../id469457/index.html">Di mana Extravaganza memimpin</a></li>
<li><a href="../id469459/index.html">Menghubungkan perangkat IoT di Kota Cerdas</a></li>
<li><a href="../id469461/index.html">"To the Stars": Anti-Cosmic "Apocalypse Today"</a></li>
<li><a href="../id469463/index.html">Tren dan Prakiraan dalam Pemrosesan Bahasa Alami</a></li>
<li><a href="../id469465/index.html">Inisialisasi dalam C ++ modern</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>