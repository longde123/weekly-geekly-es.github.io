<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üìà üéÖüèø üèáüèø PHP asincr√≥nico y la historia de una bicicleta üêü üî° üßôüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Despu√©s del lanzamiento de PHP7, se hizo posible escribir aplicaciones de larga duraci√≥n a un costo relativamente bajo. Para los programadores, se han...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>PHP asincr√≥nico y la historia de una bicicleta</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/451916/"><p> Despu√©s del lanzamiento de PHP7, se hizo posible escribir aplicaciones de larga duraci√≥n a un costo relativamente bajo.  Para los programadores, se han puesto a disposici√≥n proyectos como <code>prooph</code> , <code>broadway</code> , <code>tactician</code> , <code>messenger</code> , cuyos autores toman la soluci√≥n a los problemas m√°s comunes.  Pero, ¬øqu√© pasa si das un peque√±o paso adelante y profundizas en la pregunta? </p><br><p>  Intentemos averiguar el destino de otra bicicleta, que le permite implementar la aplicaci√≥n Publicar / Suscribir. </p><a name="habracut"></a><br><p>  Para comenzar, trataremos de revisar brevemente las tendencias actuales en el mundo de PHP, as√≠ como un breve vistazo a la operaci√≥n asincr√≥nica. </p><br><h3 id="php-sozdan-chtoby-umirat">  PHP creado para morir </h3><br><p>  Durante mucho tiempo, PHP se utiliz√≥ principalmente en el flujo de trabajo de solicitud / respuesta.  Desde el punto de vista de los desarrolladores, esto es bastante conveniente, porque no hay necesidad de preocuparse por las p√©rdidas de memoria, monitorear las conexiones. </p><br><p>  Todas las consultas se ejecutar√°n de manera aislada, se liberar√°n los recursos utilizados y las conexiones, por ejemplo, a la base de datos se cerrar√°n cuando se complete el proceso. </p><br><p>  Como ejemplo, puede tomar una aplicaci√≥n CRUD regular escrita sobre la base del marco de Symfony.  Para leer de la base de datos y devolver JSON, es necesario realizar una serie de pasos (para ahorrar espacio y tiempo, excluir los pasos para generar / ejecutar c√≥digos de operaci√≥n): </p><br><ul><li>  An√°lisis de la configuraci√≥n; </li><li>  Compilaci√≥n de contenedores; </li><li>  Solicitar enrutamiento </li><li>  Cumplimiento; </li><li>  Representando el resultado. </li></ul><br><p>  Como en el caso de PHP (que usa aceleradores), el marco utiliza activamente el almacenamiento en cach√© (algunas tareas no se completar√°n en la pr√≥xima solicitud), as√≠ como la inicializaci√≥n retrasada.  A partir de la versi√≥n 7.4, la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">precarga</a> estar√° disponible, lo que optimizar√° a√∫n m√°s la inicializaci√≥n de la aplicaci√≥n. </p><br><p>  Sin embargo, no es posible eliminar por completo todos los costos generales para la inicializaci√≥n. </p><br><h3 id="pomozhem-php-vyzhit">  Ayudemos a PHP a sobrevivir </h3><br><p>  La soluci√≥n al problema parece bastante simple: si ejecuta la aplicaci√≥n cada vez que es demasiado costosa, debe inicializarla una vez y luego pasarle las solicitudes, controlando su ejecuci√≥n. </p><br><p>  Hay proyectos en el ecosistema PHP como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">php-pm</a> y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">RoadRunner</a> .  Ambos conceptualmente hacen lo mismo: </p><br><ul><li>  Se crea un proceso principal que act√∫a como supervisor; </li><li>  Se crea un grupo de procesos secundarios; </li><li>  Cuando se recibe una solicitud, el maestro recupera el proceso del grupo y le pasa la solicitud.  El cliente est√° pendiente en este momento; </li><li>  Una vez que se completa la tarea, el maestro devuelve el resultado al cliente y el proceso secundario se env√≠a de vuelta al grupo. </li></ul><br><p>  Si alg√∫n proceso secundario muere, el supervisor lo crea nuevamente y lo agrega al grupo.  Creamos un demonio desde nuestra aplicaci√≥n con un √∫nico prop√≥sito: eliminar la sobrecarga de inicializaci√≥n, aumentando significativamente la velocidad de procesamiento de solicitudes.  Esta es la forma m√°s indolora de aumentar la productividad, pero no la √∫nica. </p><br><blockquote>  Nota: <br>  Muchos ejemplos de la serie "tomar ReactPHP y acelerar Laravel N veces" caminan por la red.  Es importante comprender la diferencia entre demonizar (y, como resultado, ahorrar tiempo en el arranque de la aplicaci√≥n) y la multitarea. <br>  Cuando use php-pm o roadrunner, su c√≥digo no se bloquear√°.  Simplemente ahorra tiempo en la inicializaci√≥n. <br>  La comparaci√≥n de php-pm, roadrunner y ReactPHP / Amp / Swoole es incorrecta por definici√≥n. </blockquote><br><h5 id="php-i-io">  PHP y E / S </h5><br><p>  La interacci√≥n con E / S en PHP se ejecuta por defecto en modo de bloqueo.  Esto significa que si ejecutamos una solicitud para actualizar la informaci√≥n en la tabla, el flujo de ejecuci√≥n se detendr√° esperando una respuesta de la base de datos.  Cuantas m√°s llamadas est√©n en proceso de procesar la solicitud, m√°s tiempo estar√°n inactivos los recursos del servidor.  De hecho, en el proceso de procesamiento de la solicitud, tenemos que ir a la base de datos varias veces, escribir algo en el registro y devolver el resultado al cliente, al final, tambi√©n una operaci√≥n de bloqueo. </p><br><blockquote>  Imagine que es un operador de centro de llamadas y necesita llamar a 50 clientes en una hora. <br>  Marcas el primer n√∫mero, y all√≠ est√° ocupado (el suscriptor discute por tel√©fono la √∫ltima serie del Juego de Tronos y en qu√© consiste la serie). <br>  Y ahora est√°s sentado y tratando de alcanzarlo antes de la victoria.  El tiempo pasa, el cambio est√° llegando a su fin.  Despu√©s de perder 40 minutos tratando de llegar al primer suscriptor, perdi√≥ la oportunidad de contactar a otros y, naturalmente, recibi√≥ del jefe. <br>  Pero puede hacerlo de otra manera: no espere hasta que el primer suscriptor est√© libre y, tan pronto como escuche un pitido, cuelgue y comience a marcar el siguiente n√∫mero.  Puedes volver al primero un poco m√°s tarde. <br>  Con este enfoque, las posibilidades de llamar al n√∫mero m√°ximo de personas aumentan considerablemente, y la velocidad de su trabajo no descansa en la tarea m√°s lenta. </blockquote><p>  El c√≥digo que no bloquea el hilo de ejecuci√≥n (no usa llamadas de bloqueo de E / S, as√≠ como funciones como <code>sleep()</code> ), se llama as√≠ncrono. </p><br><p>  Volvamos a nuestra aplicaci√≥n Symfony CRUD.  Es casi imposible que funcione en modo as√≠ncrono debido a la abundancia del uso de funciones de bloqueo: todos funcionan con configuraciones, cach√©s, registros, representaci√≥n de la respuesta, interacci√≥n con la base de datos. </p><br><p>  Pero todas estas son convenciones, intentemos lanzar Symfony y usar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Amp</a> , que proporciona una implementaci√≥n de Event Loop (incluyendo una serie de carpetas), Promesas y Corutinas, como una guinda para resolver nuestro problema. </p><br><p>  Promise es una forma de organizar el c√≥digo asincr√≥nico.  Por ejemplo, necesitamos acceder a alg√∫n recurso http. </p><br><p>  Creamos un objeto de solicitud y lo pasamos al transporte, que Promise nos devuelve con el estado actual.  Hay tres estados posibles: </p><br><ul><li>  √âxito: nuestra solicitud se complet√≥ con √©xito; </li><li>  Error: durante la ejecuci√≥n de la solicitud, algo sali√≥ mal (por ejemplo, el servidor devolvi√≥ una respuesta 500); </li><li>  En espera: el procesamiento de solicitudes a√∫n no ha comenzado. </li></ul><br><p>  Cada Promesa tiene un m√©todo (en el ejemplo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Promise es</a> analizado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">por Amp</a> ): <code>onResolve()</code> , en el que se pasa una funci√≥n de devoluci√≥n de llamada con dos argumentos </p><br><pre> <code class="php hljs">$promise-&gt;onResolve( <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(?/Throwable $throwable, $result)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span> !== $throwable) { <span class="hljs-comment"><span class="hljs-comment">/**   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/**  */</span></span> } );</code> </pre> <br><p>  Despu√©s de recibir Promise, surge la pregunta: ¬øqui√©n supervisar√° su estado y nos notificar√° el cambio de estado? </p><br><p>  Para esto, se usa Event Loop. </p><br><p>  En esencia, un bucle de eventos es un programador que supervisa la ejecuci√≥n.  Tan pronto como se complete la tarea (no importa c√≥mo), se llamar√° al invocable que pasamos a Promise. </p><br><p>  En cuanto a los matices, recomendar√≠a leer un art√≠culo de Nikita Popov: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Multitarea cooperativa utilizando corutinas</a> .  Ayudar√° a aportar algo de claridad sobre lo que est√° sucediendo y d√≥nde est√°n los generadores. </p><br><p>  Armados con nuevos conocimientos, intentemos volver a nuestra tarea de renderizaci√≥n JSON. <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://github.com/amphp/">Un ejemplo de</a> procesamiento de una solicitud HTTP entrante usando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://github.com/amphp/">amphp / http-server</a> . <br>  Tan pronto como recibamos la solicitud, se realiza una lectura asincr√≥nica de la base de datos (obtenemos Promesa) y, una vez completada, el usuario recibir√° el codiciado JSON, formado sobre la base de los datos recibidos. </p><br><blockquote>  Si necesitamos escuchar un puerto de varios procesos, podemos mirar hacia <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">amphp / cluster</a> </blockquote><p>  La principal diferencia es que un solo proceso puede atender varias solicitudes a la vez debido al hecho de que el hilo de ejecuci√≥n no est√° bloqueado.  El cliente recibir√° su respuesta cuando se complete la lectura de la base de datos, y si bien no hay respuesta, puede comenzar a atender la siguiente solicitud. </p><br><h3 id="divnyy-mir-asinhronnogo-php">  El maravilloso mundo del PHP asincr√≥nico </h3><br><blockquote>  Descargo de responsabilidad <br>  El PHP asincr√≥nico se considera en el contexto de los ex√≥ticos y no se considera algo saludable / normal.  B√°sicamente, esperar√°n risas al estilo de "take GO / Kotlin, a tonto", etc.  No dir√≠a que estas personas est√°n equivocadas, pero ... </blockquote><p>  Hay una serie de proyectos que ayudan a escribir c√≥digo PHP sin bloqueo.  En el marco del art√≠culo, no analizar√© completamente todos los pros y los contras, pero tratar√© de examinar cada uno de ellos superficialmente. </p><br><h5 id="swoolehttpswwwswoolecouk">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Swoole</a> </h5><br><p>  Un marco asincr√≥nico escrito en contraste con los dem√°s en C y entregado como una extensi√≥n a PHP.  Posee quiz√°s los mejores indicadores de rendimiento en este momento. </p><br><p>  Hay una implementaci√≥n de canales, corutina y otras cosas sabrosas, pero tiene 1 gran inconveniente: la documentaci√≥n.  Aunque est√° parcialmente en ingl√©s, en mi opini√≥n no es muy detallado, y la API en s√≠ no es muy obvia. </p><br><p>  En cuanto a la comunidad, tampoco todo es simple e inequ√≠voco.  Personalmente, no conozco a una sola persona viva que use Swoole en la batalla.  Quiz√°s supere mis miedos y migre a √©l, pero esto no suceder√° en un futuro cercano. </p><br><p>  A las desventajas, tambi√©n puede agregar que contribuir con el proyecto (usando la solicitud de extracci√≥n) con cualquier cambio tambi√©n es dif√≠cil si no conoce C en el nivel adecuado. </p><br><h5 id="workermanhttpsgithubcomwalkorworkerman">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Trabajador</a> </h5><br><p>  Si pierde velocidad con respecto a su competidor (hablando de Swoole), entonces no es muy notable y la diferencia en varios escenarios puede ser descuidada. </p><br><p>  Tiene integraci√≥n con ReactPHP, que a su vez expande el n√∫mero de implementaciones de problemas de infraestructura.  Para ahorrar espacio, describir√© las desventajas junto con ReactPHP. </p><br><h5 id="reactphphttpsreactphporg">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ReactPHP</a> </h5><br><p>  Las ventajas incluyen una comunidad bastante grande y una gran cantidad de ejemplos.  Los contras comienzan a aparecer en el proceso de uso: este es el concepto de Promesa. <br>  Si necesita realizar varias operaciones asincr√≥nicas, el c√≥digo se convierte en una papelera interminable de llamadas (aqu√≠ hay <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">un ejemplo de una conexi√≥n simple a RabbiqMQ</a> sin crear intercambio / cola y sus carpetas). </p><br><p>  Con un poco de refinamiento con un archivo (considerado la norma), puede obtener una implementaci√≥n de la rutina, que ayudar√° a deshacerse de Promise hell. </p><br><p>  Sin el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">proyecto recoilphp / recoil,</a> usar ReactPHP, en mi opini√≥n, no es posible en una aplicaci√≥n sensata. </p><br><p>  Adem√°s, adem√°s de todo lo dem√°s, uno tiene la sensaci√≥n de que su desarrollo se ha ralentizado mucho.  No es suficiente, por ejemplo, el trabajo normal con PostgreSQL. </p><br><h5 id="amphttpsamphporgamp">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Amplificador</a> </h5><br><p>  En mi opini√≥n, la mejor de las opciones que existen en este momento. <br>  Adem√°s de la Promesa habitual, hay una implementaci√≥n de Coroutine, que facilita enormemente el proceso de desarrollo y el c√≥digo se ve m√°s familiar para los programadores de PHP. </p><br><p>  Los desarrolladores complementan y mejoran constantemente el proyecto, con la retroalimentaci√≥n tampoco hay problemas. </p><br><p>  Desafortunadamente, con todas las ventajas del marco, la comunidad es relativamente peque√±a, pero al mismo tiempo hay implementaciones, por ejemplo, trabajando con PostgreSQL, as√≠ como todas las cosas b√°sicas (sistema de archivos, cliente http, DNS, etc.). </p><br><p>  Todav√≠a no entiendo muy bien el destino del proyecto ext-async, pero los chicos contin√∫an con √©l.  Lo que saldr√° de esto en la tercera versi√≥n, el tiempo lo dir√°. </p><br><h3 id="pristupaem-k-realizacii">  Empezando </h3><br><p>  Entonces, resolvimos un poco la parte te√≥rica, es hora de pasar a practicar y llenar los baches. </p><br><p>  Primero, formalizamos un poco los requisitos: </p><br><ul><li>  Mensajer√≠a asincr√≥nica (el concepto de <code>message</code> s√≠ puede dividirse en 2 tipos) <br><ul><li>  <code>command</code> : indica la necesidad de completar la tarea.  No devuelve un resultado (al menos en el caso de comunicaci√≥n asincr√≥nica); </li><li>  <code>event</code> : informa cualquier cambio de estado (por ejemplo, como resultado de un comando). </li></ul></li><li>  Formato sin bloqueo para trabajar con E / S; </li><li>  La capacidad de aumentar f√°cilmente el n√∫mero de procesadores; </li><li>  Capacidad para escribir manejadores de mensajes en cualquier idioma. </li></ul><br><blockquote>  Cualquier mensaje es inherentemente una estructura simple y compartida solo por la sem√°ntica.  El nombramiento de mensajes es extremadamente importante desde el punto de vista de entender el tipo y el prop√≥sito (aunque este punto se ignora en el ejemplo). </blockquote><p>  Para obtener una lista de requisitos, una implementaci√≥n simple del patr√≥n <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Publicar / Suscribir</a> es la m√°s adecuada. <br>  Para garantizar la ejecuci√≥n distribuida, utilizaremos RabbitMQ como intermediario de mensajes. </p><br><p>  El prototipo fue escrito usando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ReactPHP</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Bunny</a> y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">DoctrineDBAL</a> . <br>  Un lector atento puede haber notado que Dbal usa llamadas de bloqueo pdo / mysqli internamente, pero en la etapa actual esto no era particularmente importante, ya que ten√≠a que entender lo que deber√≠a suceder al final. </p><br><p>  Uno de los problemas fue la falta de bibliotecas para trabajar con PostgreSQL.  Hay algunos borradores, pero esto no es suficiente para el trabajo completo (m√°s sobre esto a continuaci√≥n). </p><br><p>  Despu√©s de una breve investigaci√≥n, ReactPHP se elimin√≥ a favor de Amp, ya que es relativamente simple y se desarrolla de manera muy activa. </p><br><h5 id="rabbitmq-transport">  RabbitMQ transport </h5><br><p>  Pero con todas las ventajas de Amp, hubo 1 problema: Amp no tiene un controlador para RabbitMQ ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Bunny</a> solo es compatible con ReactPHP). </p><br><p>  En teor√≠a, Amp te permite usar Promise de un competidor.  Parece que todo deber√≠a ser simple, pero ReactPHP usa Event Loop para trabajar con sockets en la biblioteca. <br>  En un momento dado, obviamente, no se pudieron iniciar dos bucles de eventos diferentes, por lo que no pude usar la funci√≥n <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">adapt ()</a> . </p><br><p>  Desafortunadamente, la calidad del c√≥digo en bunny dej√≥ mucho que desear y no fue posible reemplazar adecuadamente una implementaci√≥n con otra.  Para no detener el trabajo, se decidi√≥ reescribir un poco la biblioteca para que funcione con Amp y no conduzca a bloquear el flujo de ejecuci√≥n. </p><br><p>  Esta adaptaci√≥n parec√≠a muy aterradora, todo el tiempo me daba mucha verg√ºenza, pero lo m√°s importante, funcion√≥.  Bueno, dado que no hay nada m√°s permanente que temporal, el adaptador se anticip√≥ a una persona que no es demasiado perezosa para involucrarse en la implementaci√≥n del controlador. </p><br><p>  Y tal hombre fue encontrado.  El proyecto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">PHPinnacle</a> , entre otras cosas, proporciona una implementaci√≥n de un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">adaptador</a> adaptado para Amp. </p><br><blockquote>  El nombre del autor es Anton Shabovta, quien <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">hablar√° sobre php as√≠ncrono</a> en el marco de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">PHP Rusia</a> y sobre el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">desarrollo de controladores</a> para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">PHP fwdays</a> . </blockquote><br><h5 id="postgresql">  PostgreSQL </h5><br><p>  La segunda caracter√≠stica del trabajo es la interacci√≥n con la base de datos.  En las condiciones de PHP "tradicional", todo es simple: tenemos una conexi√≥n y todas las solicitudes se ejecutan secuencialmente. </p><br><p>  En el caso de la ejecuci√≥n asincr√≥nica, debemos poder ejecutar simult√°neamente varias solicitudes (por ejemplo, 3 transacciones).  Para poder hacer esto, se requiere una implementaci√≥n de grupo de conexi√≥n. </p><br><p>  El mecanismo de trabajo es bastante simple: </p><br><ul><li>  abrimos <em>N</em> conexiones al inicio (o inicializaci√≥n retrasada, no el punto); </li><li>  si es necesario, tomamos la conexi√≥n del grupo, asegurando que nadie m√°s pueda usarla; </li><li>  Ejecutamos la solicitud y destruimos la conexi√≥n o la devolvemos al grupo (preferido). </li></ul><br><p>  En primer lugar, nos permite iniciar varias transacciones a la vez, y en segundo lugar, acelera el trabajo debido a la presencia de conexiones ya abiertas.  Amp tiene un componente <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">amphp / postgres</a> .  √âl se encarga de las conexiones: monitorea su n√∫mero, vida √∫til y todo esto sin bloquear el flujo de ejecuci√≥n. </p><br><p>  Por cierto, cuando utilice, por ejemplo, ReactPHP, deber√° implementarlo usted mismo si desea trabajar con una base de datos. </p><br><h5 id="mutex">  Mutex </h5><br><p>  Para un funcionamiento efectivo y, lo m√°s importante, adecuado de la aplicaci√≥n, es necesario implementar algo similar a los mutexes.  Podemos distinguir 3 escenarios para su uso: </p><br><ul><li>  Dentro del marco de un proceso, un mecanismo simple en memoria es adecuado sin ning√∫n excedente; </li><li>  Si queremos proporcionar el bloqueo en varios procesos, entonces podemos usar el sistema de archivos (por supuesto, en modo sin bloqueo); </li><li>  Si en el contexto de varios servidores, ya necesita pensar en algo como Zookeeper. </li></ul><br><p>  Se necesitan mutexes para resolver problemas de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">condici√≥n de carrera</a> .  Despu√©s de todo, no sabemos (y no podemos saber) en qu√© orden se realizar√°n nuestras tareas, pero, sin embargo, debemos garantizar la integridad de los datos. </p><br><h5 id="logirovaniekonteksty">  Registro / Contextos </h5><br><p>  Para iniciar sesi√≥n, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Monolog</a> ya se ha convertido en est√°ndar, pero con algunas advertencias: no podemos utilizar los controladores integrados, ya que conducir√°n a bloqueos. <br>  Para escribir en stdOut, puede tomar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">amphp / log</a> , o escribir un mensaje simple envi√°ndolo a Graylog. </p><br><p>  Dado que en un momento dado, podemos procesar muchas tareas, y al grabar registros, debe comprender en qu√© contexto se escriben los datos.  Durante los experimentos, se decidi√≥ hacer <code>trace_id</code> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">rastreo distribuido</a> ).  La conclusi√≥n es que toda la cadena de llamadas debe ir acompa√±ada de un identificador de transferencia que pueda rastrearse.  Adem√°s, en el momento de recibir el mensaje, <code>package_id</code> genera <code>package_id</code> , que indica exactamente el mensaje recibido. </p><br><p>  Por lo tanto, usando ambos identificadores, podemos rastrear f√°cilmente a qu√© se refiere un registro en particular.  La cuesti√≥n es que en PHP tradicional todos los registros que obtenemos en el registro est√°n principalmente en el orden en que fueron escritos.  En el caso de ejecuci√≥n asincr√≥nica, no hay patr√≥n en el orden de las entradas. </p><br><h5 id="terminating">  Terminando </h5><br><p>  Otro de los matices del desarrollo asincr√≥nico es controlar el cierre de nuestro demonio.  Si acaba de matar el proceso, entonces no se completar√°n todas las tareas que est√°n en progreso y se perder√°n los datos. En el enfoque habitual, tambi√©n existe un problema, pero no es tan grande, porque solo se realiza una tarea a la vez. </p><br><p>  Para completar la ejecuci√≥n correctamente, necesitamos: </p><br><ul><li>  Darse de baja de la cola.  En otras palabras, hacer imposible recibir nuevos mensajes; </li><li>  Complete todas las tareas restantes (espere a resolver las promesas); </li><li>  Y solo despu√©s de eso termina el gui√≥n. </li></ul><br><h5 id="utechki-otladka">  Fugas, depuraci√≥n </h5><br><p>  Contrariamente a la creencia popular, en PHP moderno no es tan simple enfrentar situaciones en las que ocurre una p√©rdida de memoria.  Es necesario hacer algo absolutamente malo. </p><br><p>  Sin embargo, una vez enfrentado a esto, pero debido al descuido banal.  Durante la implementaci√≥n de heartbeat, se agreg√≥ un nuevo temporizador cada 40 segundos para consultar la conexi√≥n.  No es dif√≠cil adivinar que despu√©s de un tiempo el uso de la memoria comenz√≥ a aumentar progresivamente. </p><br><p>  Adem√°s, entre otras cosas, escribi√≥ un observador simple que opcionalmente comenzar√° cada 10 minutos y llamar√° a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">gc_collect_cycles ()</a> y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">gc_mem_caches ()</a> . <br>  Pero el inicio forzado del recolector de basura no es algo necesario y fundamental. </p><br><p>  Para ver constantemente el uso de la memoria, se agreg√≥ un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">MemoryUsageProcessor</a> est√°ndar al <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">registro</a> . </p><br><p>  Si tiene la idea de que Event Loop se est√° bloqueando con algo, esto tambi√©n se puede verificar f√°cilmente: solo conecte <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">LoopBlockWatcher</a> . </p><br><p>   ,       production .       . </p><br><h3 id="rezultaty">  </h3><br><p>     : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">php-service-bus</a> ,    Message Based . </p><br><p>    ,         : </p><br><pre> <code class="plaintext hljs">composer create-project php-service-bus/skeleton pub-sub-example cd pub-sub-example docker-compose up --build -d</code> </pre> <br><p>   ,      ,   . </p><br><p>   <code>/bin/consumer</code>   ,    . <br>   <code>/src</code>  3 : <code>Ping</code>   ; <code>Pong</code> :    ; <code>PingService</code> : ,   . <br>     <code>PingService</code> ,      2 : </p><br><pre> <code class="php hljs"> <span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@CommandHandler</span></span></span><span class="hljs-comment">() */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Ping $command, KernelContext $context)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Promise</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $context-&gt;delivery(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Pong()); } <span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@EventListener</span></span></span><span class="hljs-comment">() */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">whenPong</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Pong $event, KernelContext $context)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span></span>{ $context-&gt;logContextMessage(<span class="hljs-string"><span class="hljs-string">'Pong message received'</span></span>); }</code> </pre> <br><ul><li> <code>handle</code>    (        1 ).      <code>@CommandHandler</code> ; <br><ul><li>   Promise ,        RabbitMQ (   <code>delivery()</code> ).       ,   RabbitMQ    . </li></ul></li><li> <code>whenPong</code> ‚Äî   <code>Pong</code> .            .     <code>@EventListener</code> ; <br><blockquote>  ,     ‚Äî   . , , ,     .     php-service-bus  , ,            . <br></blockquote></li></ul><br><p>     2 : ,   (  )  .          ,     ,     (, ). </p><br><p>     <code>Ping</code> ,      <code>Pong</code> .     . </p><br><p>    ,       RabbitMQ: </p><br><pre> <code class="plaintext hljs">tools/ping</code> </pre> <br><p>    ,  php-service-bus     ,  Message based . </p><br><p> Ping\Pong,    ‚Äî ,  ,  <code>Hello, world</code>       . </p><br><p>     ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="></a> . </p><br><p>     - ,    , , Saga pattern (Process manager)        . </p><br><h3 id="nu-i-kak-zhe-ne-pomeryatsya">       </h3><br><p>   ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">  symfony/messenger</a> . </p><br><p>    ,      ,      . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/451916/">https://habr.com/ru/post/451916/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../451902/index.html">Microsoft Azure Developer Camp Rusia</a></li>
<li><a href="../451904/index.html">A veces m√°s es menos. Cuando una disminuci√≥n en la carga conduce a un aumento en el retraso</a></li>
<li><a href="../451906/index.html">Vulnerabilidad de Exchange: c√≥mo detectar la elevaci√≥n de privilegios a un administrador de dominio</a></li>
<li><a href="../451908/index.html">La historia de las computadoras: una noche en el Museo Yandex</a></li>
<li><a href="../451912/index.html">La red neuronal profunda de MuseNet escribe m√∫sica</a></li>
<li><a href="../451918/index.html">A la pregunta de TI</a></li>
<li><a href="../451920/index.html">Optimice el almacenamiento de correo en Zimbra Collaboration Suite</a></li>
<li><a href="../451922/index.html">Aritm√©tica de punto fijo en C ++</a></li>
<li><a href="../451926/index.html">Acerca del c√≥digo en vivo despu√©s de 130 transmisiones</a></li>
<li><a href="../451928/index.html">C√≥mo configurar an√°lisis web en p√°ginas AMP</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>