<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚óΩÔ∏è üôåüèæ ü§¶üèø Implementa√ß√£o mais simples do sistema de componentes de entidade üë©üèº‚Äçüéì ü§£ üßëüèª‚Äçü§ù‚Äçüßëüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√° pessoal! 

 O quarto fluxo ‚ÄúC ++ Developer‚Äù come√ßa aqui, um dos cursos mais ativos em nosso pa√≠s, a julgar pelas reuni√µes reais, onde n√£o apenas o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Implementa√ß√£o mais simples do sistema de componentes de entidade</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/422981/">  Ol√° pessoal! <br><br>  O quarto fluxo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">‚ÄúC ++ Developer‚Äù</a> come√ßa aqui, um dos cursos mais ativos em nosso pa√≠s, a julgar pelas reuni√µes reais, onde n√£o apenas os ‚Äúcruzados‚Äù v√™m conversar com <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Dima Shebordaev</a> :) Em geral, o curso j√° cresceu para uma das maiores do pa√≠s, permanece inalterado o fato de a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Dima</a> ministrar aulas abertas e selecionarmos materiais interessantes antes do in√≠cio do curso. <br><br>  Vamos l√°! <br><br><h3>  Entrada </h3><br>  O Sistema de Componentes de Entidades (ECS, "sistema de componentes de entidades") est√° agora no auge da popularidade como uma alternativa arquitet√¥nica que enfatiza o princ√≠pio da Composi√ß√£o sobre a heran√ßa.  Neste artigo, n√£o abordarei os detalhes do conceito, pois j√° existem recursos suficientes sobre esse t√≥pico.  Existem v√°rias maneiras de implementar o ECS e, mas, na maioria das vezes, escolho formas bastante complexas que podem confundir iniciantes e levar muito tempo. <br><br>  Neste post, descreverei uma maneira muito simples de implementar o ECS, cuja vers√£o funcional requer quase nenhum c√≥digo, mas segue completamente o conceito. <br><br><img src="https://habrastorage.org/webt/6s/g8/jk/6sg8jksoaekqfccdwlnma-rbz0w.png"><a name="habracut"></a><br><br><h3>  ECS </h3><br>  Falando em ECS, as pessoas geralmente significam coisas diferentes.  Quando falo sobre ECS, quero dizer um sistema que permite definir entidades que possuem zero ou mais componentes de dados puros.  Esses componentes s√£o processados ‚Äã‚Äãseletivamente por sistemas l√≥gicos puros.  Por exemplo, a posi√ß√£o, velocidade, hitbox e integridade de um componente est√£o vinculados √† entidade E.  Eles simplesmente armazenam dados em si mesmos.  Por exemplo, um componente de integridade pode armazenar dois n√∫meros inteiros: um para a integridade atual e outro para o m√°ximo.  Um sistema pode ser um sistema de regenera√ß√£o de integridade que localiza todas as inst√¢ncias de um componente de integridade e as aumenta em 1 a cada 120 quadros. <br><br><h3>  Implementa√ß√£o t√≠pica de C ++ </h3><br>  Existem muitas bibliotecas que oferecem implementa√ß√µes de ECS.  Geralmente, eles incluem um ou mais itens da lista: <br><br><ul><li> Heran√ßa do componente / sistema base da classe <code>GravitySystem : public ecs::System</code> ; </li><li>  Uso ativo de modelos; </li><li>  Tanto isso quanto outro em algum aspecto do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">CRTP</a> ; </li><li>  A classe <code>EntityManager</code> , que controla a cria√ß√£o / armazenamento de entidades de maneira impl√≠cita. </li></ul><br>  Alguns exemplos r√°pidos do Google: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">entidade dos alectosmasx</a> ; </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ECS do redxdev</a> ; </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">corgi do google</a> (ent√£o eu descobri que o google tem uma implementa√ß√£o ECS). </li></ul><br>  Todos esses m√©todos t√™m direito √† vida, mas existem algumas desvantagens neles.  A maneira como eles processam os dados de maneira opaca significa que ser√° dif√≠cil entender o que est√° acontecendo l√° dentro e se a desacelera√ß√£o do desempenho ocorreu.  Isso tamb√©m significa que voc√™ deve estudar toda a camada de abstra√ß√£o e garantir que ela se encaixe bem no c√≥digo existente.  N√£o se esque√ßa dos bugs ocultos, que provavelmente est√£o muito ocultos na quantidade de c√≥digo que voc√™ precisa depurar. <br><br>  Uma abordagem baseada em modelo pode afetar bastante o tempo de compila√ß√£o e com que frequ√™ncia voc√™ precisar√° reconstruir a compila√ß√£o.  Embora os conceitos baseados em heran√ßa possam prejudicar o desempenho. <br><br>  A principal raz√£o pela qual considero excessivas essas abordagens √© que o problema que elas resolvem √© muito simples.  No final, esses s√£o apenas componentes de dados adicionais associados √† entidade e seu processamento seletivo.  Abaixo, mostrarei uma maneira muito simples de como isso pode ser implementado. <br><br><h3>  Minha abordagem simples </h3><br>  <i>Essence</i> <br><br>  Em algumas abordagens, a classe Entity √© definida; em outras, elas trabalham com entidades como ID / identificador.  Em uma abordagem de componente, uma entidade nada mais √© do que os componentes associados a ela e, para isso, uma classe n√£o √© necess√°ria.  Uma entidade existir√° explicitamente com base em seus componentes relacionados.  Para fazer isso, defina: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> EntityID = <span class="hljs-keyword"><span class="hljs-keyword">int64_t</span></span>; <span class="hljs-comment"><span class="hljs-comment">//    , int64_t -  </span></span></code> </pre> <br>  <i>Componentes da entidade</i> <br><br>  Componentes s√£o diferentes tipos de dados associados a entidades existentes.  Podemos dizer que para cada entidade e, e ter√° zero e mais tipos de componentes acess√≠veis.  Em ess√™ncia, essa √© uma rela√ß√£o de valor-chave explodida e, felizmente, existem ferramentas de biblioteca padr√£o na forma de cart√µes para isso. <br><br>  Ent√£o, eu defino os componentes da seguinte maneira: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Position</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> x; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> y; }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Velocity</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> x; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> y; }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Health</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> max; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> current; }; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Type&gt; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> ComponentMap = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">unordered_map</span></span>&lt;EntityID, Type&gt;; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Positions = ComponentMap&lt;Position&gt;; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Velocities = ComponentMap&lt;Velocity&gt;; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Healths = ComponentMap&lt;Health&gt;; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Components</span></span></span><span class="hljs-class"> {</span></span> Positions positions; Velocities velocities; Healths healths; };</code> </pre> <br>  Isso √© suficiente para indicar entidades atrav√©s de componentes, conforme o esperado do ECS.  Por exemplo, para criar uma entidade com uma posi√ß√£o e integridade, mas sem velocidade, voc√™ precisa: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//given a Components instance c EntityID newID = /*obtain new entity ID*/; c.positions[newID] = Position{0.0f, 0.0f}; c.healths[newID] = Health{100, 100};</span></span></code> </pre><br>  Para destruir uma entidade com um determinado ID, simplesmente as <code>.erase()</code> de cada cart√£o. <br><br>  <i>Sistemas</i> <br><br>  O √∫ltimo componente que precisamos √© de sistemas.  Essa √© a l√≥gica que trabalha com os componentes para obter um comportamento espec√≠fico.  Como gosto de simplificar as coisas, uso fun√ß√µes normais.  O sistema de regenera√ß√£o de sa√∫de mencionado acima pode ser simplesmente a pr√≥xima fun√ß√£o. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updateHealthRegeneration</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int64_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> currentFrame, Healths&amp; healths)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(currentFrame % <span class="hljs-number"><span class="hljs-number">120</span></span> == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">auto</span></span>&amp; [id, health] : healths) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(health.current &lt; health.max) ++health.current; } } }</code> </pre><br>  Podemos colocar a chamada para essa fun√ß√£o em um local apropriado no loop principal e transferi-la para o armazenamento do componente de integridade.  Como o reposit√≥rio de integridade cont√©m apenas registros para entidades que t√™m integridade, ele pode process√°-los isoladamente.  Isso tamb√©m significa que a fun√ß√£o pega apenas os dados necess√°rios e n√£o toca no irrelevante. <br><br>  Mas e se o sistema funcionar com mais de um componente?  Diga um sistema f√≠sico que mude de posi√ß√£o com base na velocidade.  Para fazer isso, precisamos cruzar todas as chaves de todos os tipos de componentes envolvidos e iterar sobre seus valores.  Nesse ponto, a biblioteca padr√£o n√£o √© mais suficiente, mas escrever auxiliares n√£o √© t√£o dif√≠cil.  Por exemplo: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updatePhysics</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Positions&amp; positions, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Velocities&amp; velocities)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//   ,   N   //   ID,    . std::unordered_set&lt;EntityID&gt; targets = mapIntersection(positions, velocities); // target'     ,   //  ,       . for(EntityID id : targets) { Position&amp; pos = positions.at(id); const Velocity&amp; vel = velocities.at(id); pos.x += vel.x; pos.y += vel.y; } }</span></span></code> </pre> <br>  Ou voc√™ pode escrever um auxiliar mais compacto que permita acesso mais eficiente via itera√ß√£o, em vez de pesquisar. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updatePhysics</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Positions&amp; positions, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Velocities&amp; velocities)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//   ,    //  .        //    . intersectionInvoke&lt;Position, Velocity&gt;(positions, velocities, [] (EntityID id, Position&amp; pos, const Velocity&amp; vel) { pos.x += vel.x; pos.y += vel.y; } ); }</span></span></code> </pre> <br>  Assim, nos familiarizamos com a funcionalidade b√°sica de um ECS regular. <br><br><h3>  Os benef√≠cios </h3><br>  Essa abordagem √© muito eficaz, pois √© criada do zero, sem restringir a abstra√ß√£o.  Voc√™ n√£o precisa integrar bibliotecas externas ou adaptar a base de c√≥digo √†s id√©ias predefinidas de quais entidades / componentes / sistemas devem ser. <br>  E como essa abordagem √© completamente transparente, voc√™ pode criar utilit√°rios e auxiliares.  Essa implementa√ß√£o cresce com as necessidades do seu projeto.  Provavelmente, para prot√≥tipos simples ou jogos para jogos jam'ov, voc√™ ter√° o suficiente da funcionalidade descrita acima. <br><br>  Portanto, se voc√™ √© novo em todo esse campo da ECS, uma abordagem t√£o direta ajudar√° a entender as id√©ias principais. <br><br><h3>  Limita√ß√µes </h3><br>  Mas, como em qualquer outro m√©todo, existem algumas limita√ß√µes.  Na minha experi√™ncia, √© precisamente essa implementa√ß√£o usando <code>unordered_map</code> em qualquer jogo n√£o trivial que levar√° a problemas de desempenho. <br><br>  Iterar interse√ß√µes de chave em v√°rias inst√¢ncias de <code>unordered_map</code> com v√°rias entidades n√£o √© escal√°vel porque voc√™ est√° realmente pesquisando <code>N*M</code> , em que N √© o n√∫mero de componentes sobrepostos, M √© o n√∫mero de entidades correspondentes e <code>unordered_map</code> n√£o <code>unordered_map</code> muito bom em cache.  Esse problema pode ser corrigido usando um armazenamento de valores-chave mais adequado para itera√ß√£o, em vez de <code>unordered_map</code> . <br><br>  Outra limita√ß√£o √© a caldeira.  Dependendo do que voc√™ faz, identificar novos componentes pode se tornar tedioso.  Pode ser necess√°rio adicionar um an√∫ncio n√£o apenas na estrutura de componentes, mas tamb√©m na fun√ß√£o de gera√ß√£o, serializa√ß√£o, utilit√°rio de depura√ß√£o etc.  Eu me deparei com isso sozinho e resolvi o problema gerando c√≥digo - defini componentes em arquivos json externos e, em seguida, gerei componentes C ++ e fun√ß√µes auxiliares no est√°gio de constru√ß√£o.  Tenho certeza de que voc√™ pode encontrar outros m√©todos baseados em modelos para corrigir quaisquer problemas que voc√™ encontrar. <br><br>  O FIM <br><br>  Se voc√™ tiver perguntas e coment√°rios, pode deix√°-los aqui ou ir a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">uma aula aberta</a> com <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Dima</a> , ouvi-lo e perguntar por a√≠. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt422981/">https://habr.com/ru/post/pt422981/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt422969/index.html">Anomalia de Frango, Outset</a></li>
<li><a href="../pt422971/index.html">Sistema especialista em Rails</a></li>
<li><a href="../pt422973/index.html">Anatomia de um incidente ou como trabalhar para reduzir o tempo de inatividade</a></li>
<li><a href="../pt422977/index.html">Mikhail Bessmeltsev e seu colega desenvolveram novos algoritmos para vetoriza√ß√£o de gr√°ficos</a></li>
<li><a href="../pt422979/index.html">An√°logo americano do GDPR: o que voc√™ precisa saber sobre o CCPA</a></li>
<li><a href="../pt422985/index.html">In√≠cio r√°pido de um projeto web (BE - Java Spring, FE - React Redux, intera√ß√£o - Rest, WebSocket)</a></li>
<li><a href="../pt422987/index.html">E, novamente, o 256¬∫ dia do ano</a></li>
<li><a href="../pt422989/index.html">Um banco de dados n√£o √© apenas um armaz√©m de dados</a></li>
<li><a href="../pt422993/index.html">Gravando TVs OLED em testes reais</a></li>
<li><a href="../pt422995/index.html">Meta de controle de qualidade em Redmadrobot</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>