<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§∏üèæ üèì üöó Operador Tarantool kubernetes üéπ üßõüèª ‚ôâÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O Kubernetes est√° se tornando o padr√£o de fato para a execu√ß√£o de aplicativos sem estado. Principalmente porque pode reduzir significativamente o temp...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Operador Tarantool kubernetes</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/465823/"><img src="https://habrastorage.org/webt/pm/mm/lk/pmmmlkexzrcniami66ljv1ynirg.jpeg"><br><br>  O Kubernetes est√° se tornando o padr√£o de fato para a execu√ß√£o de aplicativos sem estado.  Principalmente porque pode reduzir significativamente o tempo de coloca√ß√£o no mercado para a entrega de novos recursos.  O lan√ßamento de aplicativos com estado - bancos de dados, microsservi√ßos com estado - ainda √© uma tarefa dif√≠cil, mas a necessidade de resistir √† concorr√™ncia e manter uma alta taxa de entrega leva as empresas a experimentar nesta √°rea e cria uma demanda por essas solu√ß√µes. <br><br>  Apresentamos a voc√™ nossa solu√ß√£o para o lan√ßamento de clusters com estado de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">cartucho</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Tarantool</a> : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Operador Tarantool Kubernetes</a> , para obter detalhes que eu solicito em cat. <br><a name="habracut"></a><br>  Sum√°rio: <br><br><ol><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Em vez de mil palavras</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O que o operador faz de todo</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Um pouco sobre as nuances</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Como o operador trabalha</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O que o operador expande</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Sum√°rio</a> </li></ol><br><br>  Tarantool √© um banco de dados de c√≥digo aberto e servidor de aplicativos em um pacote.  Como banco de dados, ele possui v√°rias caracter√≠sticas √∫nicas: alta efici√™ncia na utiliza√ß√£o do ferro, esquema de dados flex√≠vel, suporte para armazenamento em mem√≥ria e em disco e a possibilidade de expans√£o atrav√©s do uso da linguagem Lua.  Como servidor de aplicativos, permite mover o c√≥digo do aplicativo o mais pr√≥ximo poss√≠vel dos dados, enquanto obt√©m tempo de resposta m√≠nimo e taxa de transfer√™ncia m√°xima.  Al√©m disso, o Tarantool possui <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">um extenso ecossistema</a> , fornecendo m√≥dulos prontos para solucionar problemas de aplicativos: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">sharding</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">fila</a> , m√≥dulos para facilitar o desenvolvimento ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">cartucho</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">luatest</a> ), solu√ß√µes para opera√ß√£o ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">m√©tricas</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ansible</a> ) - esses s√£o apenas alguns exemplos. <br><br>  Por todos os seus m√©ritos, os recursos de uma √∫nica inst√¢ncia do Tarantool n√£o s√£o ilimitados: para armazenar terabytes de dados e processar milh√µes de solicita√ß√µes, √© necess√°rio aumentar dezenas e centenas de inst√¢ncias, e este √© um sistema distribu√≠do, com todos os seus problemas inerentes.  Para resolv√™-los, temos o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Tarantool Cartridge</a> , uma estrutura cuja principal tarefa √© ocultar todos os tipos de dificuldades na cria√ß√£o de aplicativos distribu√≠dos e permitir que os desenvolvedores se concentrem no valor comercial do aplicativo.  O cartucho fornece um conjunto poderoso de componentes para orquestra√ß√£o autom√°tica de cluster, distribui√ß√£o autom√°tica de dados, webui para opera√ß√£o e ferramentas de desenvolvedor. <br><br>  O Tarantool n√£o √© apenas tecnologia, mas tamb√©m uma equipe de engenheiros envolvidos no desenvolvimento de sistemas corporativos chave na m√£o, solu√ß√µes de caixa e suporte para componentes de c√≥digo-fonte aberto. <br><br>  Globalmente, nossas tarefas podem ser divididas em duas √°reas: o desenvolvimento de novos sistemas e o aumento das solu√ß√µes existentes.  Por exemplo, h√° uma grande base de um fornecedor famoso.  Para escal√°-lo para leitura, eles colocaram um cache finalmente consistente no Tarantool por tr√°s dele.  Ou vice-versa: para escalar o registro, eles colocam o Tarantool na configura√ß√£o quente / frio, onde, quando "esfriam", os dados s√£o despejados no armazenamento a frio e em paralelo √† fila de an√°lise.  Ou, para fazer o backup de um sistema existente, √© gravada uma vers√£o leve desse sistema (reserva funcional), que reserva o principal "quente" com a replica√ß√£o de dados do sistema principal.  Mais informa√ß√µes podem ser encontradas nos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">relat√≥rios do T + 2019</a> . <br><br>  Todos esses sistemas t√™m uma coisa em comum: s√£o bastante dif√≠ceis de operar.  Implemente rapidamente um cluster de mais de 100 inst√¢ncias com redund√¢ncia para 3 data centers, atualize o aplicativo que armazena dados sem tempo de inatividade e rebaixamentos de manuten√ß√£o, fa√ßa uma restaura√ß√£o de backup em caso de cat√°strofe ou erros causados ‚Äã‚Äãpelo homem, garanta o failover discreto de componentes, organize o gerenciamento de configura√ß√£o ... Em geral, uma tonelada interessante <br><br>  E seria √≥timo se tudo isso ainda fosse operado da maneira mais simples poss√≠vel.  O Kubernetes possibilita alcan√ßar o resultado desejado, mas o uso de um operador especializado torna a vida ainda mais f√°cil. <br><br><a name="1"></a><h2>  Em vez de mil palavras </h2><br>  Preparamos um pequeno exemplo baseado no cartucho Tarantool e vamos trabalhar com ele.  Um aplicativo simples como "armazenamento de valor-chave distribu√≠do com interface HTTP".  Ap√≥s o lan√ßamento, temos esta imagem: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c24/235/2c7/c242352c708a0e0dfa8fc0896bbb986d.png"><br><br>  Onde: <br><br><ul><li>  Roteadores - a parte do cluster respons√°vel por aceitar e processar solicita√ß√µes HTTP recebidas; <br></li><li>  Armazenamentos √© a parte do cluster respons√°vel pelo armazenamento e processamento de dados; tr√™s fragmentos surgem da caixa, em cada mestre e r√©plica. <br></li></ul><br>  Para equilibrar o tr√°fego HTTP de entrada nos roteadores, o ingresso Kubernetian √© usado.  Os dados s√£o distribu√≠dos no armazenamento no n√≠vel do Tarantool, usando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">o componente vshard</a> . <br><br>  Precisamos do kubernetes 1.14+, o minikube <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">funcionar√°</a> .  Al√©m disso, a disponibilidade do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">kubectl</a> n√£o prejudicar√°.  Para iniciar o operador, voc√™ precisa criar um ServiceAccount, Role e RoleBinding para ele: <br><br><pre><code class="bash hljs">$ kubectl create -f https://raw.githubusercontent.com/tarantool/tarantool-operator/0.0.1/deploy/service_account.yaml $ kubectl create -f https://raw.githubusercontent.com/tarantool/tarantool-operator/0.0.1/deploy/role.yaml $ kubectl create -f https://raw.githubusercontent.com/tarantool/tarantool-operator/0.0.1/deploy/role_binding.yaml</code> </pre> <br>  O Tarantool Operator estende a API do Kubernetes com suas defini√ß√µes de recursos, n√≥s as criaremos: <br><br><pre> <code class="bash hljs">$ kubectl create -f https://raw.githubusercontent.com/tarantool/tarantool-operator/0.0.1/deploy/crds/tarantool_v1alpha1_cluster_crd.yaml $ kubectl create -f https://raw.githubusercontent.com/tarantool/tarantool-operator/0.0.1/deploy/crds/tarantool_v1alpha1_role_crd.yaml $ kubectl create -f https://raw.githubusercontent.com/tarantool/tarantool-operator/0.0.1/deploy/crds/tarantool_v1alpha1_replicasettemplate_crd.yaml</code> </pre> <br>  Tudo est√° pronto para iniciar o operador, vamos: <br><br><pre> <code class="bash hljs">$ kubectl create -f https://raw.githubusercontent.com/tarantool/tarantool-operator/0.0.1/deploy/operator.yaml</code> </pre> <br>  Estamos aguardando o in√≠cio do operador e podemos iniciar o aplicativo: <br><br><pre> <code class="bash hljs">$ kubectl create -f https://raw.githubusercontent.com/tarantool/tarantool-operator/0.0.1/examples/kv/deployment.yaml</code> </pre> <br>  No arquivo yaml com o exemplo, o Ingress √© declarado na interface da web;  est√° dispon√≠vel em <code>cluster_ip/admin/cluster</code> .  Quando pelo menos um Pod do Ingress est√° ativo, voc√™ pode ir l√° e observar como novas inst√¢ncias s√£o adicionadas ao cluster e como sua topologia √© alterada. <br><br>  Estamos aguardando o cluster ser usado: <br><br><pre> <code class="bash hljs">$ kubectl describe clusters.tarantool.io examples-kv-cluster</code> </pre> <br>  Esperamos que no Status do cluster haja o seguinte: <br><br><pre> <code class="plaintext hljs">‚Ä¶ Status: State: Ready ‚Ä¶</code> </pre> <br>  Tudo, o aplicativo est√° pronto para uso! <br><br>  Precisa de mais espa√ßo de armazenamento?  Adicione fragmentos: <br><br><pre> <code class="bash hljs">$ kubectl scale roles.tarantool.io storage --replicas=3</code> </pre> <br>  Os fragmentos n√£o conseguem lidar com a carga?  Aumente o n√∫mero de inst√¢ncias no shard editando o modelo de replicaset: <br><br><pre> <code class="bash hljs">$ kubectl edit replicasettemplates.tarantool.io storage-template</code> </pre> <br>  Defina <code>.spec.replicas</code> , por exemplo 2, para aumentar o n√∫mero de inst√¢ncias em cada replicaset para duas. <br><br>  Um cluster n√£o √© mais necess√°rio?  N√≥s o exclu√≠mos junto com todos os recursos: <br><br><pre> <code class="bash hljs">$ kubectl delete clusters.tarantool.io examples-kv-cluster</code> </pre> <br>  Algo deu errado?  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Pontua√ß√£o do bilhete</a> , vamos desmontar rapidamente.  :) <br><br><a name="2"></a><h2>  O que o operador faz de todo </h2><br>  O lan√ßamento e a opera√ß√£o do cluster Tarantool Cartridge √© a hist√≥ria de executar determinadas a√ß√µes, em uma ordem espec√≠fica, em um determinado momento. <br><br>  O cluster em si √© gerenciado principalmente por meio da API de administra√ß√£o: GraphQL sobre HTTP.  Voc√™ pode, √© claro, descer um n√≠vel mais baixo e acionar comandos diretamente no console, mas isso raramente acontece.  Por exemplo, √© assim que o cluster √© iniciado: <br><br><ol><li>  Aumentamos o n√∫mero necess√°rio de inst√¢ncias do Tarantool, por exemplo, no systemd. <br></li><li>  Mesclar inst√¢ncias na associa√ß√£o: <br><br><pre> <code class="plaintext hljs">mutation { probe_instance: probe_server(uri: "storage:3301") }</code> </pre> <br></li><li>  Atribua fun√ß√µes a inst√¢ncias, prescreva identificadores de inst√¢ncia e replicaset.  A API GraphQL tamb√©m √© usada para isso: <br><br><pre> <code class="plaintext hljs">mutation { join_server( uri:"storage:3301", instance_uuid: "cccccccc-cccc-4000-b000-000000000001", replicaset_uuid: "cccccccc-0000-4000-b000-000000000000", roles: ["storage"], timeout: 5 ) }</code> </pre> <br></li><li>  Realizamos bootstrap do componente respons√°vel pelo sharding.  Tamb√©m atrav√©s da API: <br><br><pre> <code class="plaintext hljs">mutation { bootstrap_vshard cluster { failover(enabled:true) } }</code> </pre> <br></li></ol><br>  F√°cil n√©? <br><br>  Tudo se torna mais interessante quando se trata de expandir um cluster.  O papel dos roteadores do exemplo √© dimensionado de forma simples: aumente mais inst√¢ncias, conecte-as a um cluster existente - pronto!  O papel dos armazenamentos √© um pouco mais complicado.  O armazenamento √© fragmentado; portanto, ao adicionar / remover inst√¢ncias, √© necess√°rio reequilibrar os dados para mudar para novas inst√¢ncias / para mudar de inst√¢ncias exclu√≠das.  Se isso n√£o for feito, em um caso, teremos inst√¢ncias com carga insuficiente, no segundo - perderemos dados.  E se n√£o for apenas um, mas uma d√∫zia desses clusters com diferentes topologias est√£o em opera√ß√£o? <br><br>  Em geral, o Tarantool Operator est√° ocupado com tudo isso.  O usu√°rio descreve o estado desejado do cluster do Tarantool Cartridge e o operador converte isso em um conjunto de a√ß√µes nos recursos do k8s e em determinadas chamadas para as APIs do painel de administra√ß√£o do cluster Tarantool - em uma ordem espec√≠fica, em um determinado momento e geralmente tenta ocultar todas as nuances do usu√°rio. <br><br><a name="3"></a><h2>  Um pouco sobre as nuances </h2><br>  Ao trabalhar com a API do cluster administrativo do Tarantool Cartridge, √© importante a ordem das chamadas e de onde elas s√£o recebidas.  Porque <br><br>  O Tarantool Cartridge carrega seu reposit√≥rio de topologia, seu componente de descoberta de servi√ßo e seu componente de configura√ß√£o.  Cada inst√¢ncia do cluster armazena uma c√≥pia da topologia e configura√ß√£o em um arquivo yaml. <br><br><pre> <code class="plaintext hljs">servers: d8a9ce19-a880-5757-9ae0-6a0959525842: uri: storage-2-0.examples-kv-cluster:3301 replicaset_uuid: 8cf044f2-cae0-519b-8d08-00a2f1173fcb 497762e2-02a1-583e-8f51-5610375ebae9: uri: storage-0-0.examples-kv-cluster:3301 replicaset_uuid: 05e42b64-fa81-59e6-beb2-95d84c22a435 ‚Ä¶ vshard: bucket_count: 30000 ...</code> </pre> <br>  A atualiza√ß√£o ocorre em conjunto usando o mecanismo de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">confirma√ß√£o de duas fases</a> .  Uma atualiza√ß√£o bem-sucedida requer um quorum de 100%: cada inst√¢ncia deve responder, caso contr√°rio, a revers√£o.  O que isso significa em termos de opera√ß√£o?  Todas as solicita√ß√µes √† API do administrador que modificam o estado do cluster s√£o mais confi√°veis ‚Äã‚Äãpara serem enviadas a uma inst√¢ncia, ao l√≠der, caso contr√°rio, corremos o risco de obter configura√ß√µes diferentes em inst√¢ncias diferentes.  O Cartucho Tarantool n√£o sabe como fazer uma elei√ß√£o de l√≠der (ainda n√£o sabe como), e o Operador Tarantool pode - e voc√™ s√≥ pode saber sobre isso como um fato interessante, porque o operador estragar√° tudo. <br><br>  Al√©m disso, cada inst√¢ncia deve ter uma identidade fixa, ou seja, um conjunto de <code>instance_uuid</code> e <code>replicaset_uuid</code> , al√©m de <code>advertise_uri</code> .  Se o armazenamento reiniciar repentinamente e um desses par√¢metros for alterado, voc√™ corre o risco de quebrar o quorum - o operador tamb√©m faz isso. <br><br><a name="4"></a><h2>  Como o operador trabalha </h2><br>  A tarefa do operador √© trazer o sistema para o estado definido pelo usu√°rio e manter o sistema nesse estado at√© que novas dire√ß√µes sejam recebidas.  Para que o operador possa executar seu trabalho, ele precisa: <br><br><ol><li>  Descri√ß√£o do status do sistema. <br></li><li>  O c√≥digo que leva o sistema a esse estado. <br></li><li>  Um mecanismo para integrar esse c√≥digo nos k8s (por exemplo, para receber notifica√ß√µes de altera√ß√µes de estado). <br></li></ol><br>  O cluster do Tarantool Cartridge √© descrito em termos de k8s por meio de uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">defini√ß√£o de recurso personalizado (CRD)</a> ;  o operador precisa de 3 desses recursos personalizados, unidos no grupo tarantool.io/v1alpha: <br><br><ul><li>  O cluster √© um recurso de n√≠vel superior que corresponde a um cluster do Tarantool Cartridge. <br></li><li>  Fun√ß√£o - em termos de cartucho Tarantool, essa √© uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">fun√ß√£o do usu√°rio</a> . <br></li><li>  ReplicasetTemplate - um modelo pelo qual os StatefulSets ser√£o criados (por que stateful - vou lhe contar um pouco mais tarde; n√£o confunda com o k8s ReplicaSet). <br></li></ul><br>  Todos esses recursos refletem diretamente o modelo de descri√ß√£o de cluster do Tarantool Cartridge.  Com um dicion√°rio comum, √© mais f√°cil para um operador se comunicar com os desenvolvedores e entender o que eles querem ver no produto. <br><br>  O c√≥digo que leva o sistema ao estado especificado - em termos de k8s, esse √© o Controller.  No caso do operador Tarantool, existem v√°rios controladores: <br><br><ul><li>  ClusterController - √© respons√°vel por interagir com o cluster do Tarantool Cartridge, conecta inst√¢ncias ao cluster, desconecta inst√¢ncias do cluster. <br></li><li>  RoleController - controlador de fun√ß√£o de usu√°rio, √© respons√°vel pela implanta√ß√£o de StatefulSets a partir do modelo e pela manuten√ß√£o de seu n√∫mero em um determinado n√∫mero. <br></li></ul><br>  Como √© um controlador?  Um conjunto de c√≥digos que gradualmente coloca o mundo ao seu redor em ordem.  ClusterController pode ser representado esquematicamente assim: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/132/1d2/317/1321d23173a37f65743fcc0ee4d48ad2.png"><br><br>  Um ponto de entrada √© uma verifica√ß√£o para ver se existe um recurso de cluster em rela√ß√£o ao qual o evento ocorreu.  N√£o existe?  N√≥s estamos indo embora.  Existe?  Passamos para o pr√≥ximo bloco: conquistar a propriedade sobre as fun√ß√µes de usu√°rio.  Capturado um - esquerdo, no segundo c√≠rculo capturamos o segundo.  E assim por diante, at√© capturarmos tudo.  Todas as fun√ß√µes s√£o capturadas?  Ent√£o v√° para o pr√≥ximo bloco de opera√ß√µes.  E assim, at√© chegarmos ao √∫ltimo;  ent√£o podemos assumir que o sistema controlado est√° em um determinado estado. <br><br>  Em geral, tudo √© simples.  √â importante determinar os crit√©rios de sucesso para passar em cada est√°gio.  Por exemplo, consideramos bem-sucedida a opera√ß√£o de ingressar em um cluster n√£o quando ele retornou sucesso condicional = true, mas quando retornou um erro como "j√° ingressado". <br><br>  E a √∫ltima parte desse mecanismo √© a integra√ß√£o do controlador com o k8s.  Vista a√©rea, todo o k8s consiste em um conjunto de controladores que geram eventos e respondem a eles.  Os eventos passam por filas nas quais podemos nos inscrever.  Esquematicamente, isso pode ser representado da seguinte maneira: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/094/d57/3fb/094d573fbcf511ba2eea8e707a575423.jpg"><br><br>  O usu√°rio chama <code>kubectl create -f tarantool_cluster.yaml</code> , o recurso de cluster correspondente √© criado.  ClusterController √© notificado sobre a cria√ß√£o de um recurso de cluster.  E a primeira coisa que ele est√° tentando fazer √© encontrar todos os recursos da fun√ß√£o que devem fazer parte desse cluster.  Se encontrar, designa Cluster como Propriet√°rio da Fun√ß√£o e atualiza o recurso Fun√ß√£o.  O RoleController recebe uma notifica√ß√£o de atualiza√ß√£o de fun√ß√£o, v√™ que o recurso tem um propriet√°rio e come√ßa a criar StatefulSets.  E assim por diante em um c√≠rculo: o primeiro gatilho do segundo, o segundo gatilho do terceiro - e assim por diante at√© que algu√©m pare.  E voc√™ tamb√©m pode acionar a tempo, por exemplo, a cada 5 segundos, o que √†s vezes √© √∫til. <br><br>  Esse √© o operador inteiro: crie um recurso personalizado e escreva um c√≥digo que responda a eventos nos recursos. <br><br><a name="5"></a><h2>  O que o operador expande </h2><br>  As a√ß√µes do operador levam os k8s a criar Pods e cont√™ineres.  No cluster do Tarantool Cartridge implantado nos k8s, todos os Pods s√£o mesclados no StatefulSets. <br><br>  Por que StatefulSet?  Como escrevi anteriormente, cada inst√¢ncia do Tarantool Cluster mant√©m uma c√≥pia da topologia e configura√ß√£o do cluster e, geralmente, no servidor de aplicativos, n√£o, n√£o, e eles usam algum tipo de espa√ßo, por exemplo, dados alternativos ou de refer√™ncia, e esse j√° √© um estado completo .  E StatefulSet tamb√©m garante a preserva√ß√£o dos Pods de identidade, o que √© importante ao agrupar inst√¢ncias em um cluster: a identidade das inst√¢ncias deve ser corrigida; caso contr√°rio, corremos o risco de perder o quorum ao reiniciar. <br><br>  Quando todos os recursos do cluster s√£o criados e trazidos para o estado desejado, eles formam a seguinte hierarquia: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e27/89f/f7e/e2789ff7e8bf174c20baf8cc077bdad2.png"><br><br>  As setas indicam o relacionamento Dependente do propriet√°rio entre os recursos.  √â necess√°rio que o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Garbage Collector fa√ßa uma</a> limpeza depois de n√≥s no caso, por exemplo, da remo√ß√£o do Cluster. <br><br>  Al√©m do StatefulSets, o Operador Tarantool cria o Servi√ßo Sem Cabe√ßa, necess√°rio para a elei√ß√£o do l√≠der e, por meio dele, as inst√¢ncias se comunicam. <br><br>  Sob o cap√¥ do operador Tarantool est√° a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">estrutura</a> do operador, o pr√≥prio c√≥digo do operador est√° em golang, nada de extraordin√°rio aqui. <br><br><a name="6"></a><h2>  Sum√°rio </h2><br>  Isso √© tudo, em geral!  Estamos aguardando seus coment√°rios e tickets - onde, sem eles, a vers√£o alfa √© a mesma.  O que vem a seguir?  E, em seguida, h√° muito trabalho para lembrar tudo isso: <br><br><ul><li>  Unidade, teste E2E; <br></li><li>  Teste do macaco do caos <br></li><li>  teste de estresse; <br></li><li>  backup / restaura√ß√£o; <br></li><li>  provedor de topologia externa. <br></li></ul><br>  Cada um desses t√≥picos √© extenso por si s√≥ e merece um material separado, aguarde atualiza√ß√µes! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt465823/">https://habr.com/ru/post/pt465823/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt465811/index.html">14 dicas para escrever um c√≥digo React limpo. Parte 1</a></li>
<li><a href="../pt465813/index.html">14 dicas para escrever um c√≥digo React limpo. Parte 2</a></li>
<li><a href="../pt465815/index.html">Cientistas desenvolveram aglomerados de c√©lulas nervosas e as enviaram para a ISS</a></li>
<li><a href="../pt465817/index.html">Como o desconforto nos ajuda a melhorar o processo de desenvolvimento.</a></li>
<li><a href="../pt465819/index.html">LAN ideal</a></li>
<li><a href="../pt465825/index.html">Diret√≥rio telef√¥nico do Asterisk FreePBX a partir de tabelas SQL (diret√≥rio baseado na Web, upload para arquivo xml para telefones Grandstream)</a></li>
<li><a href="../pt465829/index.html">[Tutorial] Como criar seu primeiro jogo incremental IDLE JavaScript</a></li>
<li><a href="../pt465833/index.html">TOKEN2 Molto-1, o primeiro token de hardware TOTP de v√°rios perfis do mundo</a></li>
<li><a href="../pt465835/index.html">F√°brica abstrata nos dedos</a></li>
<li><a href="../pt465839/index.html">Tudo o que voc√™ precisa saber sobre a margem CSS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>