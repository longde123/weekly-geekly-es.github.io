<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🐹 ☮️ 👨🏾 我们使为微控制器开发重型软件的过程更加方便（否） 🧑🏾‍🤝‍🧑🏼 👩‍🍳 🧔🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="现在，任何人都不会对具有512 KB或更大的非易失性（通常是闪存）存储器的微控制器感到惊讶。 它们的成本正在逐渐降低，而可访问性却在不断增长。 如此大量的非易失性存储器的存在使得有可能编写就占用的存储器而言“繁重”的应用程序，同时通过使用来自各种标准库的现成解决方案来促进代码的后续维护。 然而，这导...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>我们使为微控制器开发重型软件的过程更加方便（否）</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/437848/">现在，任何人都不会对具有512 KB或更大的非易失性（通常是闪存）存储器的微控制器感到惊讶。 它们的成本正在逐渐降低，而可访问性却在不断增长。 如此大量的非易失性存储器的存在使得有可能编写就占用的存储器而言“繁重”的应用程序，同时通过使用来自各种标准库的现成解决方案来促进代码的后续维护。 然而，这导致目标设备的固件文件量的增加，每次以最小的代码变化就需要将其完全重新加载到微控制器的非易失性存储器中。 <br><br> 本文的目的是讨论用C和/或C ++构建项目的方法，其中在更改最经常调试的代码段的情况下，不需要重写大多数项目。 并说明为什么这种方法并不总是一种有效的解决方案。 <br><a name="habracut"></a><br><h2> 读者要求 </h2><br> 在叙述的过程中，我将假定读者： <br><br><ul><li> 他精通C和C ++。 </li><li> 具有使用基于Cortex-M3 / Cortex-M4内核的微控制器（例如stm32f4系列）的经验； </li><li> 知道如何从项目源构建最终的缝纫文件（elf / bin）； </li><li> 想象一下链接脚本文件的用途； </li><li> 对文本，bss，数据和其他部分有所了解； </li><li> 与任何linux发行版一起工作； </li><li> 最少拥有bash； </li><li> 在gcc上具有Cortex-M3 / Cortex-M4处理器（工具链arm-none-eabi）的体系结构的经验； </li><li> 具有cmake的初步技能。 </li></ul><br><h2> 方法的本质 </h2><br> 在针对微控制器的“经典”项目中，所有不可变数据（文本，rodata段，初始数据值等）通常从非易失性存储器的起始地址开始（连续排列）（对于基于Cortex-M3 / Cortex-M4内核的微控制器而言）-c地址0x08000000）。 以简化的形式，使用C ++编写的基于Cortex-M3 / Cortex-M4内核的微控制器程序的非易失性存储器使用图如下所示： <br><br><img src="https://habrastorage.org/webt/hl/dw/jx/hldwjx8d-f6k7ogodnjthokeefc.png"><br><br> 此类项目的mem.ld文件通常看起来像这样： <br><br><pre><code class="bash hljs">MEMORY { FLASH (rx) : ORIGIN = 0x08000000, LENGTH = 768K RAM (xrw) : ORIGIN = 0x20000000, LENGTH = 112K }</code> </pre> <br> 在此，所有非易失性存储器是一个名为“ FLASH”的单个分区，而所有RAM是一个名为“ RAM”的分区。 以这种形式，当其中一个代码段更改时，其余所有代码段都开始“移位”。 为了避免这种情况，您可以将固件文件“拆分”为一些逻辑块。 例如，如下： <br><br><ul><li> 中断向量表； </li><li> 自己的图书馆； </li><li> 第三方库（不打算更改）； </li><li> 经常修改的代码。 </li></ul><br> 在这种情况下，当更改代码段时，在最终的bin文件中，仅更改代码已更改的段以及以某种方式与其连接的段（例如，如果处理程序在某些位置的中断向量表）从部分）。 <br><br> 本质上讲， <b>静态库</b>是添加到项目中的。 <br><br> 接收到项目文件的bin后，可以将其划分为多个部分，并分别刷新每个部分。 因此，将仅缝合更改的区域。 这也意味着在调试之前不需要固件，因为假定微控制器将立即具有微控制器中的最新固件，并且您可以立即开始调试。 <br><br> 接下来，我将详细描述如何在实际项目中实现这一点。 这种决定的利弊将在本文的结尾给出。 <br><br><h2> 实验领域 </h2><br> 在建议工作中进行任何形式的创新之前，请在我的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">家庭项目中</a>尝试一下。 由于其规模接近工作中日常项目的规模，因此有可能了解这项创新是否可行以及它所带来的细微差别。 <br><br><h2> 项目说明 </h2><br> 该项目包含： <br><br><ul><li> 使用虚拟表，new / delete（通过一堆FreeRTOS），shared_ptr（和其他智能指针）以及其他标准C ++ 14库的C ++ 14中主项目的代码； </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">FreeRTOS</a>使用约6项任务来维护硬件外围基础设施，并使用约10项业务逻辑（ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">MakiseGUI</a>图形<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">库</a> ，单击处理，使用fat（ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">FatFS</a> ）等）； </li><li>  16个存储库，带有自己的库，用于与主板上的硬件外围设备进行交互，用于系统调用的存根等； </li></ul><br> 使用汇编参数-O0 -g3，在完全实现中的代码（支持unicode，Cyrillic等）大约需要700 KB。 但是，在当前阶段，当硬件外围设备稳定并且仅需要调试业务逻辑时，要更改的代码量约为20 KB。 因此，乍看之下，当前的方法似乎是解决该问题的理想解决方案（出于某种原因，不考虑在计算机上进行模拟的选项）。 <br><br><h2> 行动清单 </h2><br> 要实现上述方法，您将需要： <br><br><ul><li> 将所有子模块组装为静态库（本文的分析项目列表中未包含此项目的描述）； </li><li> 重写mem.ld; </li><li> 重写section.ld； </li><li> 向主项目添加实用程序，以从最终bin文件中提取节； </li><li> 向项目添加对脚本的调用，以在更新固件文件时更新微控制器的非易失性存储器。 </li></ul><br><h2> 重写mem.ld </h2><br> 第一步是针对当前概念完善“标准”mem.ld。 在完成时，应考虑到非易失性存储器由扇区清除。 请在文档中阅读有关特定微控制器中扇区结构的更多信息（对于stm32微控制器，请参阅参考手册）。 每个部分至少可以占据一个扇区（可以更多），否则一个部分将覆盖另一个扇区。 <br><br> 还应该记住，如果库使用全局变量，那么对于该库，您需要在链接阶段在RAM中保留一个位置。 否则，您可能会遇到不愉快的错误，这些错误将非常难以捕获。 例如，FatFS库的代码将在ROM_EXTERNAL_LIBRARIES节中，但是在构建阶段它需要4个字节的RAM。 因此，您需要确保RAM中有一部分用于ROM_EXTERNAL_LIBRARIES中的代码将使用的字段。 在此示例中，它是RAM_EXTERNAL_LIBRARIES。 <br><br> 非易失性存储器的最后一节值得特别注意。 根据section.ld（稍后会介绍），之前未分解为相应部分的所有内容都将纳入其中。 <br><br><div class="spoiler">  <b class="spoiler_title">在当前项目的上下文中，mem.ld将如下所示。</b> <div class="spoiler_text"><pre> <code class="bash hljs">/*    stm32f405rgt6   ChiptunePlayer-2.22-MainBoard-v2-Firmware. */ MEMORY { /*-----------------------------FLASH-------------------------------*/ /*  0-1  . */ ROM_BOOTLOADER (RX) : ORIGIN = 0x08000000, LENGTH = 32K /*  2     . */ ROM_SYSCFG_PAGE_1 (R) : ORIGIN = 0x08008000, LENGTH = 16K /*  3      . */ ROM_SYSCFG_PAGE_2 (R) : ORIGIN = 0x0800C000, LENGTH = 16K /*  4 . */ ROM_RESERVE (R) : ORIGIN = 0x08010000, LENGTH = 16K /*  5, 6, 7      (FATFS, FREERTOS...). */ ROM_EXTERNAL_LIBRARIES (RX) : ORIGIN = 0x08020000, LENGTH = 384K /*  8, 9      ( ,  ...). */ ROM_USER_LIBRARIES (RX) : ORIGIN = 0x08080000, LENGTH = 384K /*  5, 6      . */ ROM_MAIN_PROGRAMM (RX) : ORIGIN = 0x080E0000, LENGTH = 128K /*-----------------------------RAM---------------------------------*/ /*      RAM    . */ RAM_PAGE_1 (RW) : ORIGIN = 0x20000000, LENGTH = 112K RAM_PAGE_2 (RW) : ORIGIN = 0x2001C000, LENGTH = 16K /*           FATFS  FreeRTOS. */ RAM_EXTERNAL_LIBRARIES (RW) : ORIGIN = 0x20000000, LENGTH = 10K /*        . */ RAM_USER_LIBRARIES (RW) : ORIGIN = 0x20002800, LENGTH = 90K /*    RAM    . */ RAM_MAIN_PROGRAMM (RW) : ORIGIN = 0x20019000, LENGTH = 27K /*   RAM    .    FreeRTOS. */ RAM_MAIN_PROGRAMM_STACK (RW) : ORIGIN = 0x2001FC00, LENGTH = 1K }</code> </pre> </div></div><br><h2> 重写section.ld </h2><br> 将现有存储卡分为几部分后，应说明要放置的分区。 对于每个库（如果库中有相应的节），请指示.text，.rodata，.data，.bss和其他节的位置。 可以使用objdump查看库中可用的节列表。 例如，对于libstdc ++ _ nano.a库，您需要指定放置文本的位置，ARM.attributes，rodata，data，bss和COMMON节。 <br><br><div class="spoiler">  <b class="spoiler_title">在当前项目的上下文中，section.ld将如下所示。</b> <div class="spoiler_text"><pre> <code class="bash hljs">/*             RAM. */ __estack = ORIGIN(RAM_MAIN_PROGRAMM_STACK) + LENGTH(RAM_MAIN_PROGRAMM_STACK); /*   . */ __stack_size = LENGTH(RAM_MAIN_PROGRAMM_STACK); /*     Reset_Handler. */ ENTRY(Reset_Handler) /*  . */ SECTIONS { /*---------------------ROM  ------------------------*/ .section_bootloader : ALIGN(4) { /*     .             .          .o ,     .*/ . = ALIGN(4); KEEP(*(.user_code_isr_vector .user_code_isr_vector*)) . = ALIGN(4); } &gt;ROM_BOOTLOADER /*----------------ROM    -----------------*/ /* . */ .section_external_libraries_text : ALIGN(4) { /*  . */ . = ALIGN(4); *libstdc++_nano.a:*(.text .text*); . = ALIGN(4); *libgcc.a:*(.text .text*); . = ALIGN(4); *libg_nano.a:*(.text .text*); /*   */ . = ALIGN(4); *libSTM32F4_LOW_LEVEL_BY_ST.a:*(.text .text*); . = ALIGN(4); *libFATFS.a:*(.text .text*); . = ALIGN(4); *libFREERTOS.a:*(.text .text*); . = ALIGN(4); *libMAKISE_GUI.a:*(.text .text*); . = ALIGN(4); } &gt;ROM_EXTERNAL_LIBRARIES /* ,   */ .section_external_libraries_required_by_the_compiler : ALIGN(4) { /*  . */ . = ALIGN(4); *libgcc.a:*(.ARM.attributes .ARM.attributes*); . = ALIGN(4); *libstdc++_nano.a:*(.ARM.attributes .ARM.attributes*); . = ALIGN(4); *libg_nano.a:*(.ARM.attributes .ARM.attributes*); /*   */ . = ALIGN(4); *libSTM32F4_LOW_LEVEL_BY_ST.a:*(.ARM.attributes .ARM.attributes*); . = ALIGN(4); *libFATFS.a:*(.ARM.attributes .ARM.attributes*); . = ALIGN(4); *libFREERTOS.a:*(.ARM.attributes .ARM.attributes*); . = ALIGN(4); *libMAKISE_GUI.a:*(.ARM.attributes .ARM.attributes*); . = ALIGN(4); } &gt;ROM_EXTERNAL_LIBRARIES /*    . */ .section_external_libraries_rodata : ALIGN(4) { /*  . */ . = ALIGN(4); *libgcc.a:*(.rodata .rodata*); . = ALIGN(4); *libstdc++_nano.a:*(.rodata .rodata*); . = ALIGN(4); *libg_nano.a:*(.rodata .rodata*); /*   */ . = ALIGN(4); *libSTM32F4_LOW_LEVEL_BY_ST.a:*(.rodata .rodata*); . = ALIGN(4); *libFATFS.a:*(.rodata .rodata*); . = ALIGN(4); *libFREERTOS.a:*(.rodata .rodata*); . = ALIGN(4); *libMAKISE_GUI.a:*(.rodata .rodata*); . = ALIGN(4); } &gt;ROM_EXTERNAL_LIBRARIES /*----------------------- ---------------------*/ /* . */ .section_user_libraries_text : ALIGN(4) { . = ALIGN(4); *libUSER_FREERTOS_LEVEL.a:*(.text .text*); . = ALIGN(4); *libUSER_BSP_LEVEL.a:*(.text .text*); . = ALIGN(4); *libMC_INTERRUPT.a:*(.text .text*); . = ALIGN(4); *libMC_HARDWARE.a:*(.text .text*); . = ALIGN(4); *libPCB_HARDWARE.a:*(.text .text*); . = ALIGN(4); *libUSER_STARTUP.a:*(.text .text*); . = ALIGN(4); *libBUTTONS.a:*(.text .text*); . = ALIGN(4); *libCHIPTUNE.a:*(.text .text*); . = ALIGN(4); *libDIGITAL_POTENTIOMETER.a:*(.text .text*); . = ALIGN(4); *libLCD_DRIVER.a:*(.text .text*); . = ALIGN(4); *libMAKISE_GUI_ELEMENTS_BY_VADIMATORIK_ELEMENTS_BY_VADIMATORIK.a:*(.text .text*); . = ALIGN(4); *libMC_HARDWARE_INTERFACES_IMPLEMENTATION_FOR_STM32.a:*(.text .text*); . = ALIGN(4); *libMICROSD_LOW_LEVEL_DRIVER.a:*(.text .text*); . = ALIGN(4); *libSHIFT_REGISTER.a:*(.text .text*); . = ALIGN(4); *libWAVE_GENERATORS.a:*(.text .text*); . = ALIGN(4); *libRUN_TIME_LOGGER.a:*(.text .text*); . = ALIGN(4); } &gt;ROM_USER_LIBRARIES /* ,   */ .section_user_libraries_required_by_the_compiler : ALIGN(4) { . = ALIGN(4); *libUSER_FREERTOS_LEVEL.a:*(.ARM.attributes .ARM.attributes*); . = ALIGN(4); *libUSER_BSP_LEVEL.a:*(.ARM.attributes .ARM.attributes*); . = ALIGN(4); *libMC_INTERRUPT.a:*(.ARM.attributes .ARM.attributes*); . = ALIGN(4); *libMC_HARDWARE.a:*(.ARM.attributes .ARM.attributes*); . = ALIGN(4); *libPCB_HARDWARE.a:*(.ARM.attributes .ARM.attributes*); . = ALIGN(4); *libUSER_STARTUP.a:*(.ARM.attributes .ARM.attributes*); . = ALIGN(4); *libUSER_CODE.a:*(.ARM.attributes .ARM.attributes*); . = ALIGN(4); *libBUTTONS.a:*(.ARM.attributes .ARM.attributes*); . = ALIGN(4); *libCHIPTUNE.a:*(.ARM.attributes .ARM.attributes*); . = ALIGN(4); *libDIGITAL_POTENTIOMETER.a:*(.ARM.attributes .ARM.attributes*); . = ALIGN(4); *libLCD_DRIVER.a:*(.ARM.attributes .ARM.attributes*); . = ALIGN(4); *libMAKISE_GUI_ELEMENTS_BY_VADIMATORIK_ELEMENTS_BY_VADIMATORIK.a:*(.ARM.attributes .ARM.attributes*); . = ALIGN(4); *libMC_HARDWARE_INTERFACES_IMPLEMENTATION_FOR_STM32.a:*(.ARM.attributes .ARM.attributes*); . = ALIGN(4); *libMICROSD_LOW_LEVEL_DRIVER.a:*(.ARM.attributes .ARM.attributes*); . = ALIGN(4); *libSHIFT_REGISTER.a:*(.ARM.attributes .ARM.attributes*); . = ALIGN(4); *libWAVE_GENERATORS.a:*(.ARM.attributes .ARM.attributes*); . = ALIGN(4); *libRUN_TIME_LOGGER.a:*(.ARM.attributes .ARM.attributes*); . = ALIGN(4); } &gt;ROM_EXTERNAL_LIBRARIES /*    . */ .section_user_libraries_rodata : ALIGN(4) { . = ALIGN(4); *libUSER_FREERTOS_LEVEL.a:*(.rodata .rodata*); . = ALIGN(4); *libUSER_BSP_LEVEL.a:*(.rodata .rodata*); . = ALIGN(4); *libMC_INTERRUPT.a:*(.rodata .rodata*); . = ALIGN(4); *libMC_HARDWARE.a:*(.rodata .rodata*); . = ALIGN(4); *libPCB_HARDWARE.a:*(.rodata .rodata*); . = ALIGN(4); *libUSER_STARTUP.a:*(.rodata .rodata*); . = ALIGN(4); *libBUTTONS.a:*(.rodata .rodata*); . = ALIGN(4); *libCHIPTUNE.a:*(.rodata .rodata*); . = ALIGN(4); *libDIGITAL_POTENTIOMETER.a:*(.rodata .rodata*); . = ALIGN(4); *libLCD_DRIVER.a:*(.rodata .rodata*); . = ALIGN(4); *libMAKISE_GUI_ELEMENTS_BY_VADIMATORIK_ELEMENTS_BY_VADIMATORIK.a:*(.rodata .rodata*); . = ALIGN(4); *libMC_HARDWARE_INTERFACES_IMPLEMENTATION_FOR_STM32.a:*(.rodata .rodata*); . = ALIGN(4); *libMICROSD_LOW_LEVEL_DRIVER.a:*(.rodata .rodata*); . = ALIGN(4); *libSHIFT_REGISTER.a:*(.rodata .rodata*); . = ALIGN(4); *libWAVE_GENERATORS.a:*(.rodata .rodata*); . = ALIGN(4); *libRUN_TIME_LOGGER.a:*(.rodata .rodata*); . = ALIGN(4); } &gt;ROM_USER_LIBRARIES /*------------------------- ------------------------*/ /* . */ .section_user_code_text : ALIGN(4) { . = ALIGN(4); *(.text .text.*) . = ALIGN(4); } &gt;ROM_MAIN_PROGRAMM /* ,   */ .sections_user_code_required_by_the_compiler : ALIGN(4) { . = ALIGN(4); *(.glue_7 .glue_7*) /*  -  ARMv7 */ . = ALIGN(4); *(.glue_7t .glue_7t*) . = ALIGN(4); *(.vfp11_veneer .vfp11_veneer*) /*   . */ . = ALIGN(4); *(.v4_bx .v4_bx*) . = ALIGN(4); *(.iplt .iplt*) . = ALIGN(4); *(.rel.dyn .rel.dyn*) . = ALIGN(4); KEEP(*(.eh_frame .eh_frame*)) /*     CPP. */ . = ALIGN(4); *(.eh_framehdr .eh_framehdr*) . = ALIGN(4); *(.ARM.attributes .ARM.attributes.*) /*    ,  . */ . = ALIGN(4); *(vtable) /* C++ virtual tables */ PROVIDE_HIDDEN (__preinit_array_start = .); /*  ,   . */ . = ALIGN(4); KEEP(*(.preinit_array_sysinit .preinit_array_sysinit*)) . = ALIGN(4); KEEP(*(.preinit_array_platform .preinit_array_platform.*)) . = ALIGN(4); KEEP(*(.preinit_array .preinit_array.*)) PROVIDE_HIDDEN (__preinit_array_end = .); PROVIDE_HIDDEN (__init_array_start = .); /*    . */ . = ALIGN(4); KEEP(*(SORT(.init_array.*))) . = ALIGN(4); KEEP(*(.init_array)) . = ALIGN(4); PROVIDE_HIDDEN (__init_array_end = .); PROVIDE_HIDDEN (__fini_array_start = .); /*    . */ . = ALIGN(4); KEEP(*(SORT(.fini_array.*))) . = ALIGN(4); KEEP(*(.fini_array)) . = ALIGN(4); PROVIDE_HIDDEN (__fini_array_end = .); . = ALIGN(4); KEEP(*(.cfmconfig)) . = ALIGN(4); *(.after_vectors .after_vectors.*) . = ALIGN(4); } &gt;ROM_MAIN_PROGRAMM /*    . */ .section_user_code_rodata : ALIGN(4) { . = ALIGN(4); *(.rodata .rodata.*) . = ALIGN(4); } &gt;ROM_MAIN_PROGRAMM /*  stack trace. */ .ARM.exidx : { . = ALIGN(4); *(.ARM.extab* .gnu.linkonce.armextab.*) . = ALIGN(4); *(.ARM.exidx* .gnu.linkonce.armexidx.*) . = ALIGN(4); } &gt; ROM_MAIN_PROGRAMM /*-------------------------------RAM-----------------------------*/ /*    . */ .section_external_libraries_data : ALIGN(4) { . = ALIGN(4); __external_lib_data_start = . ; /*  . */ . = ALIGN(4); *libgcc.a:*(.data .data*); . = ALIGN(4); *libstdc++_nano.a:*(.data .data*); . = ALIGN(4); *libg_nano.a:*(.data .data*); /*   */ . = ALIGN(4); *libSTM32F4_LOW_LEVEL_BY_ST.a:*(.data .data*); . = ALIGN(4); *libFATFS.a:*(.data .data*); . = ALIGN(4); *libFREERTOS.a:*(.data .data*); . = ALIGN(4); *libMAKISE_GUI.a:*(.data .data*); . = ALIGN(4); __external_lib_data_end = . ; } &gt;RAM_EXTERNAL_LIBRARIES AT&gt; ROM_EXTERNAL_LIBRARIES /*       RAM */ .section_external_libraries_bss : ALIGN(4) { . = ALIGN(4); __external_lib_bss_start = .; /*  . */ . = ALIGN(4); *libgcc.a:*(.bss .bss*); . = ALIGN(4); *libstdc++_nano.a:*(.bss .bss*); . = ALIGN(4); *libg_nano.a:*(*COMMON); . = ALIGN(4); *libgcc.a:*(*COMMON); . = ALIGN(4); *libstdc++_nano.a:*(*COMMON); . = ALIGN(4); *libg_nano.a:*(*COMMON); /*   */ . = ALIGN(4); *libSTM32F4_LOW_LEVEL_BY_ST.a:*(.bss .bss*); . = ALIGN(4); *libFATFS.a:*(.bss .bss*); . = ALIGN(4); *libFREERTOS.a:*(.bss .bss*); . = ALIGN(4); *libMAKISE_GUI.a:*(.bss .bss*); . = ALIGN(4); *libSTM32F4_LOW_LEVEL_BY_ST.a:*(*COMMON); . = ALIGN(4); *libFATFS.a:*(*COMMON); . = ALIGN(4); *libFREERTOS.a:*(*COMMON); . = ALIGN(4); *libMAKISE_GUI.a:*(*COMMON); . = ALIGN(4); __external_lib_bss_end = .; } &gt;RAM_EXTERNAL_LIBRARIES /*    . */ .section_user_libraries_data : ALIGN(4) { . = ALIGN(4); __user_lib_data_start = . ; . = ALIGN(4); *libUSER_FREERTOS_LEVEL.a:*(.data .data*); . = ALIGN(4); *libUSER_BSP_LEVEL.a:*(.data .data*); . = ALIGN(4); *libMC_INTERRUPT.a:*(.data .data*); . = ALIGN(4); *libMC_HARDWARE.a:*(.data .data*); . = ALIGN(4); *libPCB_HARDWARE.a:*(.data .data*); . = ALIGN(4); *libUSER_STARTUP.a:*(.data .data*); . = ALIGN(4); *libBUTTONS.a:*(.data .data*); . = ALIGN(4); *libCHIPTUNE.a:*(.data .data*); . = ALIGN(4); *libDIGITAL_POTENTIOMETER.a:*(.data .data*); . = ALIGN(4); *libLCD_DRIVER.a:*(.data .data*); . = ALIGN(4); *libMAKISE_GUI_ELEMENTS_BY_VADIMATORIK_ELEMENTS_BY_VADIMATORIK.a:*(.data .data*); . = ALIGN(4); *libMC_HARDWARE_INTERFACES_IMPLEMENTATION_FOR_STM32.a:*(.data .data*); . = ALIGN(4); *libMICROSD_LOW_LEVEL_DRIVER.a:*(.data .data*); . = ALIGN(4); *libSHIFT_REGISTER.a:*(.data .data*); . = ALIGN(4); *libWAVE_GENERATORS.a:*(.data .data*); . = ALIGN(4); *libRUN_TIME_LOGGER.a:*(.data .data*); . = ALIGN(4); __user_lib_data_end = . ; } &gt;RAM_USER_LIBRARIES AT&gt; ROM_USER_LIBRARIES .section_user_libraries_bss : ALIGN(4) { . = ALIGN(4); __user_lib_bss_start = .; . = ALIGN(4); *libUSER_FREERTOS_LEVEL.a:*(.bss .bss*); . = ALIGN(4); *libUSER_BSP_LEVEL.a:*(.bss .bss*); . = ALIGN(4); *libMC_INTERRUPT.a:*(.bss .bss*); . = ALIGN(4); *libMC_HARDWARE.a:*(.bss .bss*); . = ALIGN(4); *libPCB_HARDWARE.a:*(.bss .bss*); . = ALIGN(4); *libUSER_CODE.a:*(.bss .bss*); . = ALIGN(4); *libBUTTONS.a:*(.bss .bss*); . = ALIGN(4); *libCHIPTUNE.a:*(.bss .bss*); . = ALIGN(4); *libDIGITAL_POTENTIOMETER.a:*(.bss .bss*); . = ALIGN(4); *libLCD_DRIVER.a:*(.bss .bss*); . = ALIGN(4); *libMAKISE_GUI_ELEMENTS_BY_VADIMATORIK_ELEMENTS_BY_VADIMATORIK.a:*(.bss .bss*); . = ALIGN(4); *libMC_HARDWARE_INTERFACES_IMPLEMENTATION_FOR_STM32.a:*(.bss .bss*); . = ALIGN(4); *libMICROSD_LOW_LEVEL_DRIVER.a:*(.bss .bss*); . = ALIGN(4); *libSHIFT_REGISTER.a:*(.bss .bss*); . = ALIGN(4); *libWAVE_GENERATORS.a:*(.bss .bss*); . = ALIGN(4); *libUSER_FREERTOS_LEVEL.a:*(.bss .bss*); . = ALIGN(4); *libRUN_TIME_LOGGER.a:*(.bss .bss*); . = ALIGN(4); *libUSER_BSP_LEVEL.a:*(*COMMON); . = ALIGN(4); *libMC_INTERRUPT.a:*(*COMMON); . = ALIGN(4); *libMC_HARDWARE.a:*(*COMMON); . = ALIGN(4); *libPCB_HARDWARE.a:*(*COMMON); . = ALIGN(4); *libUSER_CODE.a:*(*COMMON); . = ALIGN(4); *libBUTTONS.a:*(*COMMON); . = ALIGN(4); *libCHIPTUNE.a:*(*COMMON); . = ALIGN(4); *libDIGITAL_POTENTIOMETER.a:*(*COMMON); . = ALIGN(4); *libLCD_DRIVER.a:*(*COMMON); . = ALIGN(4); *libMAKISE_GUI_ELEMENTS_BY_VADIMATORIK_ELEMENTS_BY_VADIMATORIK.a:*(*COMMON); . = ALIGN(4); *libMC_HARDWARE_INTERFACES_IMPLEMENTATION_FOR_STM32.a:*(*COMMON); . = ALIGN(4); *libMICROSD_LOW_LEVEL_DRIVER.a:*(*COMMON); . = ALIGN(4); *libSHIFT_REGISTER.a:*(*COMMON); . = ALIGN(4); *libWAVE_GENERATORS.a:*(*COMMON); . = ALIGN(4); *libRUN_TIME_LOGGER.a:*(.COMMON*); . = ALIGN(4); __user_lib_bss_end = .; } &gt;RAM_USER_LIBRARIES /*    . */ .section_user_code_data : ALIGN(4) { . = ALIGN(4); __user_code_data_start = . ; . = ALIGN(4); *(.data .data.*) . = ALIGN(4); __user_code_data_end = . ; } &gt;RAM_MAIN_PROGRAMM AT&gt; ROM_MAIN_PROGRAMM .section_user_code_bss : ALIGN(4) { . = ALIGN(4); __bss_start__ = .; __user_code_bss_start = .; *(.bss .bss.*) *(COMMON) . = ALIGN(4); __bss_end__ = .; __user_code_bss_end = .; } &gt;RAM_MAIN_PROGRAMM __external_lib_data_in_rom_start = LOADADDR(.section_external_libraries_data); __user_lib_data_in_rom_start = LOADADDR(.section_user_libraries_data); __user_code_data_in_rom_start = LOADADDR(.section_user_code_data); /*------------------------- -----------------*/ /* Stabs debugging sections. */ .stab 0 : { *(.stab) } .stabstr 0 : { *(.stabstr) } .stab.excl 0 : { *(.stab.excl) } .stab.exclstr 0 : { *(.stab.exclstr) } .stab.index 0 : { *(.stab.index) } .stab.indexstr 0 : { *(.stab.indexstr) } .comment 0 : { *(.comment) } /* * DWARF debug sections. * Symbols <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the DWARF debugging sections are relative to the beginning * of the section so we begin them at 0. */ /* DWARF 1 */ .debug 0 : { *(.debug) } .line 0 : { *(.line) } /* GNU DWARF 1 extensions */ .debug_srcinfo 0 : { *(.debug_srcinfo) } .debug_sfnames 0 : { *(.debug_sfnames) } /* DWARF 1.1 and DWARF 2 */ .debug_aranges 0 : { *(.debug_aranges) } .debug_pubnames 0 : { *(.debug_pubnames) } /* DWARF 2 */ .debug_info 0 : { *(.debug_info .gnu.linkonce.wi.*) } .debug_abbrev 0 : { *(.debug_abbrev) } .debug_line 0 : { *(.debug_line) } .debug_frame 0 : { *(.debug_frame) } .debug_str 0 : { *(.debug_str) } .debug_loc 0 : { *(.debug_loc) } .debug_macinfo 0 : { *(.debug_macinfo) } /* SGI/MIPS DWARF 2 extensions */ .debug_weaknames 0 : { *(.debug_weaknames) } .debug_funcnames 0 : { *(.debug_funcnames) } .debug_typenames 0 : { *(.debug_typenames) } .debug_varnames 0 : { *(.debug_varnames) } .debug_macro 0 : { *(.debug_macro) } .debug_ranges 0 : { *(.debug_ranges) } }</code> </pre> </div></div><br><h2> 在主项目中添加实用程序，以从最终bin文件中提取节 </h2><br> 不幸的是，无法在objcopy或objdump中找到用于从elf文件提取特定地址之间的代码的标志。 有一个<b>--only-section</b>标志，但是，它没有考虑到在section.ld中列出的所有实体实体之后，调试信息仍放置在非易失性存储器中的事实。 没有它，最终的固件（由各个部件组装而成）将无法工作（出于明显的原因）。 因此，我必须编写一个简单的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">实用程序</a> ，该<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">实用程序</a>采用一个公共bin文件并将所需节提取到用于指定地址范围的单独文件中。 但是，在这里出现以下细微差别。 默认情况下，objcopy用0填充节之间的空间。 但是，闪存中的空白空间为0xFF。 要解决此问题，您需要使用标志<b>--gap-fill = 0xff</b>组成输出bin文件。 <br><br><h2> 在更新固件文件时，将对脚本的调用添加到项目中以更新微控制器的非易失性存储器 </h2><br> 要跟踪项目中的更改，在每次重建elf文件之后，您需要调用一个验证脚本，该脚本将从elf文件中提取最终的bin文件，比较其中所需的部分，将其与先前提取的文件进行比较，如果发生任何差异，请更新微控制器内存中的部分。 <br><br><div class="spoiler">  <b class="spoiler_title">比较脚本代码</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash # # $1 -  .   ,    . # $2 -     elf . # $3 -      STM32. # echo "Old file name: $1" echo "New file name: $2" # ,     . flag_rewrite=0 #    ,         #  ,      (   #     ). #    ,   ,   -    #  ,     .  ,   . if [ -e $1 ] then #         . echo "Both files exist." #  md5   ,     . buf=$(md5sum $1 --binary) md5_old=${buf:0:32} #      md5   . #   32 . buf=$(md5sum $2 --binary) md5_new=${buf:0:32} echo "Started file comparison." if [ $md5_old == $md5_new ] then #     ,  . echo "The file has not been updated." echo "The new file will be deleted." rm $2 echo "Removed." else #   ,    . echo "The file has been modified." echo "Old will be replaced by new." mv $2 $1 echo "Replaced." flag_rewrite=1 #    . fi else #    . echo "Old file does not exist." echo "New will be renamed to old." mv $2 $1 #    . flag_rewrite=1 #    . echo "Renamed." fi #       ,     . if [ $flag_rewrite -eq 1 ] then echo "Started flashing." echo "CMD params: $3" $3 fi</span></span></code> </pre> <br></div></div><br>      cmake ,    : <br><div class="spoiler"> <b class="spoiler_title">Cmake  </b> <div class="spoiler_text"><pre> <code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">function</span></span>(write_sector SECTOR ADDR_BASE ADDR_START ADDR_END) <span class="hljs-keyword"><span class="hljs-keyword">add_custom_command</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">TARGET</span></span> <span class="hljs-variable"><span class="hljs-variable">${PROJECT_NAME}</span></span>.elf POST_BUILD <span class="hljs-keyword"><span class="hljs-keyword">COMMAND</span></span> <span class="hljs-variable"><span class="hljs-variable">${ARM_OBJCOPY}</span></span> --output-<span class="hljs-keyword"><span class="hljs-keyword">target</span></span>=binary --gap-fill=<span class="hljs-number"><span class="hljs-number">0</span></span>xff <span class="hljs-variable"><span class="hljs-variable">${PROJECT_BINARY_DIR}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${PROJECT_NAME}</span></span>.elf <span class="hljs-variable"><span class="hljs-variable">${PROJECT_BINARY_DIR}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${PROJECT_NAME}</span></span>_all.bin COMMENT <span class="hljs-string"><span class="hljs-string">"Creating a binary file of the &lt;&lt;${SECTOR}&gt;&gt; sector"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COMMAND</span></span> <span class="hljs-variable"><span class="hljs-variable">${BIN_EXTRACTOR}</span></span> -p <span class="hljs-variable"><span class="hljs-variable">${PROJECT_BINARY_DIR}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${PROJECT_NAME}</span></span>_all.bin -o <span class="hljs-variable"><span class="hljs-variable">${PROJECT_BINARY_DIR}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${PROJECT_NAME}</span></span>_section_<span class="hljs-variable"><span class="hljs-variable">${SECTOR}</span></span>_new.bin -b <span class="hljs-variable"><span class="hljs-variable">${ADDR_BASE}</span></span> -s <span class="hljs-variable"><span class="hljs-variable">${ADDR_START}</span></span> -e <span class="hljs-variable"><span class="hljs-variable">${ADDR_END}</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COMMAND</span></span> cd <span class="hljs-variable"><span class="hljs-variable">${CMAKE_SOURCE_DIR}</span></span> &amp;&amp; ./cmp.sh <span class="hljs-variable"><span class="hljs-variable">${PROJECT_BINARY_DIR}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${PROJECT_NAME}</span></span>_section_<span class="hljs-variable"><span class="hljs-variable">${SECTOR}</span></span>.bin <span class="hljs-variable"><span class="hljs-variable">${PROJECT_BINARY_DIR}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${PROJECT_NAME}</span></span>_section_<span class="hljs-variable"><span class="hljs-variable">${SECTOR}</span></span>_new.bin <span class="hljs-string"><span class="hljs-string">"${STM32PROG} -c port=${STM32PROG_PORT} freq=${STM32PROG_FREQ} -w ${PROJECT_BINARY_DIR}/${PROJECT_NAME}_section_${SECTOR}.bin ${ADDR_START}"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">endfunction</span></span>(write_sector)</code> </pre> </div></div><br>     stm32programmer. <br><div class="spoiler"> <b class="spoiler_title">     </b> <div class="spoiler_text"><pre> <code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (STM32PROG_USE <span class="hljs-keyword"><span class="hljs-keyword">STREQUAL</span></span> <span class="hljs-string"><span class="hljs-string">"ON"</span></span>) write_sector(<span class="hljs-string"><span class="hljs-string">"bootloader"</span></span> <span class="hljs-variable"><span class="hljs-variable">${SECTION_BOOTLOADER_ADDRESS}</span></span> <span class="hljs-variable"><span class="hljs-variable">${SECTION_BOOTLOADER_ADDRESS}</span></span> <span class="hljs-variable"><span class="hljs-variable">${SECTION_SYSCFG_PAGE_1_ADDRESS}</span></span>) write_sector(<span class="hljs-string"><span class="hljs-string">"external_libraries"</span></span> <span class="hljs-variable"><span class="hljs-variable">${SECTION_BOOTLOADER_ADDRESS}</span></span> <span class="hljs-variable"><span class="hljs-variable">${SECTION_EXTERNAL_LIB_ADDRESS}</span></span> <span class="hljs-variable"><span class="hljs-variable">${SECTION_USER_LIBRARIES_ADDRESS}</span></span>) write_sector(<span class="hljs-string"><span class="hljs-string">"user_libraries"</span></span> <span class="hljs-variable"><span class="hljs-variable">${SECTION_BOOTLOADER_ADDRESS}</span></span> <span class="hljs-variable"><span class="hljs-variable">${SECTION_USER_LIBRARIES_ADDRESS}</span></span> <span class="hljs-variable"><span class="hljs-variable">${SECTION_USER_CODE_ADDRESS}</span></span>) write_sector(<span class="hljs-string"><span class="hljs-string">"main_programm"</span></span> <span class="hljs-variable"><span class="hljs-variable">${SECTION_BOOTLOADER_ADDRESS}</span></span> <span class="hljs-variable"><span class="hljs-variable">${SECTION_USER_CODE_ADDRESS}</span></span> <span class="hljs-variable"><span class="hljs-variable">${ADDR_END_FLASH}</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">endif</span></span> ()</code> </pre> </div></div><br><br><h2> 结论 </h2><br>   : <br><br><ol><li>  95%    ,  ; </li></ol><br>   : <br><ol><li>     ,              (   stm32programmer-).   ,    ,       ; </li><li>  section.ld         -.         ,     GUI    ; </li><li>  ,     ,    ,         (  , )        :). </li></ol><br>          <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="> </a> .     CLion-,        bin . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN437848/">https://habr.com/ru/post/zh-CN437848/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN437836/index.html">深入浅出-面向程序员的MMO沙箱中的虚拟化</a></li>
<li><a href="../zh-CN437838/index.html">机器学习技术有时会加速患者适应仿生假体的过程</a></li>
<li><a href="../zh-CN437842/index.html">大金刚的秘密故事：从街机到NES</a></li>
<li><a href="../zh-CN437844/index.html">静态与动态类型的持久冲突-TypeScript将无济于事</a></li>
<li><a href="../zh-CN437846/index.html">bobaoskit-附件，dnssd和WebSocket</a></li>
<li><a href="../zh-CN437850/index.html">谁在PCB布局上最有效？</a></li>
<li><a href="../zh-CN437852/index.html">Shipastik的历史</a></li>
<li><a href="../zh-CN437858/index.html">Technopolis的“设计高负载系统”课程（2018年秋季）的其他讲座</a></li>
<li><a href="../zh-CN437864/index.html">用于基于纯SQL的Windows服务器的监视系统，以及我如何将其秘密地拖入生产环境</a></li>
<li><a href="../zh-CN437868/index.html">安全周05：打印机，相机，7zip和道德规范</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>