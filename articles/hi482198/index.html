<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>тЫО ЁЯжМ ЁЯХ║ рдХреИрд╕реЗ рдПрдХ рдХреНрд▓рд╕реНрдЯрд░ рдХреЗ рд▓рд┐рдП рдЕрдкрдиреЗ рдСрдЯреЛрд╕реНрдХреЛрд▓рд░ рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП ЁЯПЖ ЁЯЧДя╕П ЁЯСжЁЯП╝</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="рдирдорд╕реНрддреЗ! рд╣рдо рд▓реЛрдЧреЛрдВ рдХреЛ рдмрдбрд╝реЗ рдбреЗрдЯрд╛ рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рд╢рд┐рдХреНрд╖рд┐рдд рдХрд░рддреЗ рд╣реИрдВред рдЕрдкрдиреЗ рд╕реНрд╡рдпрдВ рдХреЗ рдХреНрд▓рд╕реНрдЯрд░ рдХреЗ рдмрд┐рдирд╛ рдмрдбрд╝реЗ рдбреЗрдЯрд╛ рдкрд░ рдПрдХ рд╢реИрдХреНрд╖рд┐рдХ рдХрд╛рд░реНрдпрдХреНрд░рдо рдХреА рдХрд▓реНрдкрдирд╛ рдХрд░...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>рдХреИрд╕реЗ рдПрдХ рдХреНрд▓рд╕реНрдЯрд░ рдХреЗ рд▓рд┐рдП рдЕрдкрдиреЗ рдСрдЯреЛрд╕реНрдХреЛрд▓рд░ рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/newprolab/blog/482198/"><p>  рдирдорд╕реНрддреЗ!  рд╣рдо рд▓реЛрдЧреЛрдВ рдХреЛ рдмрдбрд╝реЗ рдбреЗрдЯрд╛ рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рд╢рд┐рдХреНрд╖рд┐рдд рдХрд░рддреЗ рд╣реИрдВред  рдЕрдкрдиреЗ рд╕реНрд╡рдпрдВ рдХреЗ рдХреНрд▓рд╕реНрдЯрд░ рдХреЗ рдмрд┐рдирд╛ рдмрдбрд╝реЗ рдбреЗрдЯрд╛ рдкрд░ рдПрдХ рд╢реИрдХреНрд╖рд┐рдХ рдХрд╛рд░реНрдпрдХреНрд░рдо рдХреА рдХрд▓реНрдкрдирд╛ рдХрд░рдирд╛ рдЕрд╕рдВрднрд╡ рд╣реИ, рдЬрд┐рд╕ рдкрд░ рд╕рднреА рдкреНрд░рддрд┐рднрд╛рдЧреА рдПрдХ рд╕рд╛рде рдХрд╛рдо рдХрд░рддреЗ рд╣реИрдВред  рдЗрд╕ рдХрд╛рд░рдг рд╕реЗ, рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рд╣рдореЗрд╢рд╛ рдпрд╣ рд╣рдорд╛рд░реЗ рдХрд╛рд░реНрдпрдХреНрд░рдо рдкрд░ рд╣реИ :) рд╣рдо рдЗрд╕рдХреА рдЯреНрдпреВрдирд┐рдВрдЧ, рдЯреНрдпреВрдирд┐рдВрдЧ рдФрд░ рдкреНрд░рд╢рд╛рд╕рди рдореЗрдВ рд▓рдЧреЗ рд╣реБрдП рд╣реИрдВ, рдФрд░ рд▓реЛрдЧ рд╕реАрдзреЗ рд╡рд╣рд╛рдВ MapReduce-jobs рд▓реЙрдиреНрдЪ рдХрд░рддреЗ рд╣реИрдВ рдФрд░ рд╕реНрдкрд╛рд░реНрдХ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВред </p><br><p>  рдЗрд╕ рдкреЛрд╕реНрдЯ рдореЗрдВ, рд╣рдо рдпрд╣ рд╡рд░реНрдгрди рдХрд░реЗрдВрдЧреЗ рдХрд┐ рд╣рдордиреЗ <a href="https://mcs.mail.ru/">рдореЗрд▓ рдСрдЯреЛрдЬрд╝ рдХреНрд▓рд╛рдЙрдб рд╕реЙрд▓реНрдпреВрд╢рдВрд╕</a> рдХреНрд▓рд╛рдЙрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЕрдкрдиреЗ рдСрдЯреЛрд╕реИрдХреНрдЯрд░ рдХреЛ рд▓рд┐рдЦрдХрд░ рдЕрд╕рдорд╛рди рдХреНрд▓рд╕реНрдЯрд░ рд▓реЛрдбрд┐рдВрдЧ рдХреА рд╕рдорд╕реНрдпрд╛ рдХреЛ рдХреИрд╕реЗ рд╣рд▓ рдХрд┐рдпрд╛ред </p><a name="habracut"></a><br><h2 id="problema">  рд╕рдорд╕реНрдпрд╛ </h2><br><p>  рд╣рдорд╛рд░реЗ рджреНрд╡рд╛рд░рд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рдиреЗ рд╡рд╛рд▓рд╛ рдХреНрд▓рд╕реНрдЯрд░ рдХрд╛рдлреА рд╡рд┐рд╢рд┐рд╖реНрдЯ рдирд╣реАрдВ рд╣реИред  рдирд┐рдкрдЯрд╛рди рдЕрддреНрдпрдзрд┐рдХ рдЕрд╕рдорд╛рди рд╣реИред  рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рд╡реНрдпрд╛рд╡рд╣рд╛рд░рд┐рдХ рдЕрднреНрдпрд╛рд╕ рд╣реИрдВ рдЬрдм рд╕рднреА 30 рд▓реЛрдЧ рдФрд░ рд╢рд┐рдХреНрд╖рдХ рдХреНрд▓рд╕реНрдЯрд░ рдореЗрдВ рдкреНрд░рд╡реЗрд╢ рдХрд░рддреЗ рд╣реИрдВ рдФрд░ рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рд╢реБрд░реВ рдХрд░рддреЗ рд╣реИрдВред  рдпрд╛, рдлрд┐рд░ рд╕реЗ, рд╕рдордп рд╕реАрдорд╛ рд╕реЗ рдкрд╣рд▓реЗ рджрд┐рди рд╣реЛрддреЗ рд╣реИрдВ, рдЬрдм рднрд╛рд░ рдирд╛рдЯрдХреАрдп рд░реВрдк рд╕реЗ рдмрдврд╝ рдЬрд╛рддрд╛ рд╣реИред  рдмрд╛рдХреА рд╕рдордп, рдХреНрд▓рд╕реНрдЯрд░ рдЕрдВрдбрд░рд▓реЛрдб рдореЛрдб рдореЗрдВ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИред </p><br><p>  рд╕рдорд╛рдзрд╛рди # 1 рдПрдХ рдХреНрд▓рд╕реНрдЯрд░ рд░рдЦрдиреЗ рдХреЗ рд▓рд┐рдП рд╣реИ рдЬреЛ рдЪреЛрдЯреА рдХреЗ рднрд╛рд░ рдХрд╛ рд╕рд╛рдордирд╛ рдХрд░реЗрдЧрд╛, рд▓реЗрдХрд┐рди рдмрд╛рдХреА рд╕рдордп рдмреЗрдХрд╛рд░ рд░рд╣реЗрдЧрд╛ред </p><br><p>  рд╕рдорд╛рдзрд╛рди рдирдВрдмрд░ 2 рдПрдХ рдЫреЛрдЯрд╛ рдХреНрд▓рд╕реНрдЯрд░ рд░рдЦрдирд╛ рд╣реИ рдЬрд┐рд╕рдореЗрдВ рдХрдХреНрд╖рд╛рдУрдВ рд╕реЗ рдкрд╣рд▓реЗ рдФрд░ рдкреАрдХ рд▓реЛрдб рдХреЗ рджреМрд░рд╛рди рдореИрдиреНрдпреБрдЕрд▓ рд░реВрдк рд╕реЗ рдиреЛрдбреНрд╕ рдЬреЛрдбрд╝рдирд╛ рд╣реИред </p><br><p>  рд╕рдорд╛рдзрд╛рди # 3 рдПрдХ рдЫреЛрдЯрд╛ рдХреНрд▓рд╕реНрдЯрд░ рд░рдЦрдирд╛ рд╣реИ рдФрд░ рдПрдХ рдСрдЯреЛрд╕реИрдХрд░ рд▓рд┐рдЦрдирд╛ рд╣реИ рдЬреЛ рд╡рд░реНрддрдорд╛рди рдХреНрд▓рд╕реНрдЯрд░ рд▓реЛрдб рдХреА рдирд┐рдЧрд░рд╛рдиреА рдХрд░реЗрдЧрд╛ рдФрд░, рд╡рд┐рднрд┐рдиреНрди рдПрдкреАрдЖрдИ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ, рдХреНрд▓рд╕реНрдЯрд░ рд╕реЗ рдиреЛрдбреНрд╕ рдЬреЛрдбрд╝ рдФрд░ рд╣рдЯрд╛ рджреЗрдЧрд╛ред </p><br><p>  рдЗрд╕ рдкреЛрд╕реНрдЯ рдореЗрдВ рд╣рдо рдирд┐рд░реНрдгрдп рд╕рдВрдЦреНрдпрд╛ 3 рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдмрд╛рдд рдХрд░реЗрдВрдЧреЗред  рдЗрд╕ рддрд░рд╣ рдХрд╛ рдПрдХ рдСрдЯреЛрд╕реИрдХрд░ рдмрд╛рд╣рд░реА рдХрд╛рд░рдХреЛрдВ рдкрд░ рдЕрддреНрдпрдзрд┐рдХ рдирд┐рд░реНрднрд░ рд╣реИ, рдФрд░ рдЖрдВрддрд░рд┐рдХ рд▓реЛрдЧреЛрдВ рдкрд░ рдирд╣реАрдВ, рдФрд░ рдкреНрд░рджрд╛рддрд╛ рдЕрдХреНрд╕рд░ рдЗрд╕реЗ рдкреНрд░рджрд╛рди рдирд╣реАрдВ рдХрд░рддреЗ рд╣реИрдВред  рд╣рдо Mail.ru Cloud Solutions рдХреНрд▓рд╛рдЙрдб рдЗрдВрдлреНрд░рд╛рд╕реНрдЯреНрд░рдХреНрдЪрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ рдФрд░ MCS API рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реБрдП рдПрдХ рдСрдЯреЛрд╕реИрдХрд░ рд▓рд┐рдЦрд╛ рд╣реИред  рдФрд░ рдЬрдм рд╕реЗ рд╣рдо рдбреЗрдЯрд╛ рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рдиреЗ рдХрд╛ рдкреНрд░рд╢рд┐рдХреНрд╖рдг рд▓реЗ рд░рд╣реЗ рд╣реИрдВ, рд╣рдордиреЗ рдпрд╣ рджрд┐рдЦрд╛рдиреЗ рдХрд╛ рдлреИрд╕рд▓рд╛ рдХрд┐рдпрд╛ рдХрд┐ рдЖрдк рдЕрдкрдиреЗ рдЙрджреНрджреЗрд╢реНрдпреЛрдВ рдХреЗ рд▓рд┐рдП рдПрдХ рд╕рдорд╛рди рдСрдЯреЛрдХреИрд╕рд▓рд░ рдХреИрд╕реЗ рд▓рд┐рдЦ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдЕрдкрдиреЗ рдХреНрд▓рд╛рдЙрдб рдХреЗ рд╕рд╛рде рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ </p><br><h2 id="prerequisites">  рдЖрд╡рд╢реНрдпрдХ рд╢рд░реНрддреЗрдВ </h2><br><p>  рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ, рдЖрдкрдХреЗ рдкрд╛рд╕ рдПрдХ Hadoop рдХреНрд▓рд╕реНрдЯрд░ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдПред  рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рд╣рдо рдПрдЪрдбреАрдкреА рд╡рд┐рддрд░рдг рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВред </p><br><p>  рддрд╛рдХрд┐ рдЖрдкрдХреЗ рдиреЛрдбреНрд╕ рдХреЛ рдЬрд▓реНрджреА рд╕реЗ рдЬреЛрдбрд╝рд╛ рдФрд░ рд╣рдЯрд╛рдпрд╛ рдЬрд╛ рд╕рдХреЗ, рдЖрдкрдХреЗ рдкрд╛рд╕ рдиреЛрдбреНрд╕ рдХреЗ рдмреАрдЪ рдХреБрдЫ рдирд┐рд╢реНрдЪрд┐рдд рднреВрдорд┐рдХрд╛рдПрдВ рд╣реЛрдиреА рдЪрд╛рд╣рд┐рдПред </p><br><ol><li>  рдорд╛рд╕реНрдЯрд░ рдиреЛрдбред  рдЦреИрд░, рдпрд╣рд╛рдВ рдЖрдкрдХреЛ рдХреБрдЫ рднреА рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рд╕рдордЭрд╛рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИ: рдХреНрд▓рд╕реНрдЯрд░ рдХрд╛ рдореБрдЦреНрдп рдиреЛрдб, рдЬрд┐рд╕ рдкрд░, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рд╕реНрдкрд╛рд░реНрдХ рдбреНрд░рд╛рдЗрд╡рд░ рд▓реЙрдиреНрдЪ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдпрджрд┐ рдЖрдк рдЗрдВрдЯрд░реИрдХреНрдЯрд┐рд╡ рдореЛрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВред </li><li>  рджрд┐рдирд╛рдВрдХ рдиреЛрдбред  рдпрд╣ рд╡рд╣ рдиреЛрдб рд╣реИ рдЬрд┐рд╕ рдкрд░ рдЖрдк рдПрдЪрдбреАрдПрдлрдПрд╕ рдкрд░ рдбреЗрдЯрд╛ рд╕реНрдЯреЛрд░ рдХрд░рддреЗ рд╣реИрдВ рдФрд░ рдЙрд╕ рдкрд░ рдЧрдгрдирд╛ рдХреА рдЬрд╛рддреА рд╣реИред </li><li>  рдХрдореНрдкреНрдпреВрдЯрд┐рдВрдЧ рдиреЛрдбред  рдпрд╣ рдПрдХ рдиреЛрдб рд╣реИ рдЬрд┐рд╕ рдкрд░ рдЖрдк рдПрдЪрдбреАрдПрдлрдПрд╕ рдкрд░ рдХреБрдЫ рднреА рд╕реНрдЯреЛрд░ рдирд╣реАрдВ рдХрд░рддреЗ рд╣реИрдВ, рд▓реЗрдХрд┐рди рдЧрдгрдирд╛ рдЙрд╕ рдкрд░ рдХреА рдЬрд╛рддреА рд╣реИред </li></ol><br><p>  рдПрдХ рдорд╣рддреНрд╡рдкреВрд░реНрдг рдмрд┐рдВрджреБред  рддреАрд╕рд░реЗ рдкреНрд░рдХрд╛рд░ рдХреЗ рдиреЛрдбреНрд╕ рдХреЗ рдХрд╛рд░рдг рдСрдЯреЛрд╕реНрдХреЛрд▓рд┐рдВрдЧ рд╣реЛрдЧрд╛ред  рдпрджрд┐ рдЖрдк рджреВрд╕рд░реЗ рдкреНрд░рдХрд╛рд░ рдХреЗ рдиреЛрдбреНрд╕ рдХреЛ рдЪреБрдирдирд╛ рдФрд░ рдЬреЛрдбрд╝рдирд╛ рд╢реБрд░реВ рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдХреА рдЧрддрд┐ рдмрд╣реБрдд рдХрдо рд╣реЛрдЧреА - рд╡рд┐рдШрдЯрд┐рдд рдФрд░ рдЕрдиреБрд╢рдВрд╕рд┐рдд рдЖрдкрдХреЗ рдХреНрд▓рд╕реНрдЯрд░ рдкрд░ рдШрдВрдЯреЗ рд▓рдЧреЗрдВрдЧреЗред  рдпрд╣, рдирд┐рд╢реНрдЪрд┐рдд рд░реВрдк рд╕реЗ, рдЖрдк рдСрдЯреЛрд╕рд╛рд▓рд┐рдВрдЧ рд╕реЗ рдХреНрдпрд╛ рдЙрдореНрдореАрдж рдирд╣реАрдВ рдХрд░рддреЗ рд╣реИрдВред  рдпрд╣реА рд╣реИ, рд╣рдо рдкрд╣рд▓реЗ рдФрд░ рджреВрд╕рд░реЗ рдкреНрд░рдХрд╛рд░ рдХреЗ рдиреЛрдбреНрд╕ рдХреЛ рдирд╣реАрдВ рдЫреВрддреЗ рд╣реИрдВред  рд╡реЗ рдПрдХ рдиреНрдпреВрдирддрдо рд╡реНрдпрд╡рд╣рд╛рд░реНрдп рдХреНрд▓рд╕реНрдЯрд░ рд╣реЛрдВрдЧреЗ рдЬреЛ рдкреВрд░реЗ рдХрд╛рд░реНрдпрдХреНрд░рдо рдореЗрдВ рдореМрдЬреВрдж рд╣реЛрдВрдЧреЗред </p><br><p>  рддреЛ, рд╣рдорд╛рд░рд╛ рдСрдЯреЛрд╕рдХреЛрд▓рд░ рдкрд╛рдпрдерди 3 рдореЗрдВ рд▓рд┐рдЦрд╛ рдЧрдпрд╛ рд╣реИ, рдХреНрд▓рд╕реНрдЯрд░ рд╕реЗрд╡рд╛рдУрдВ рдХрд╛ рдкреНрд░рдмрдВрдзрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЕрдВрдмрд╛рд░реА рдПрдкреАрдЖрдИ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ, рдорд╢реАрдиреЛрдВ рдХреЛ рд╢реБрд░реВ рдХрд░рдиреЗ рдФрд░ рдмрдВрдж рдХрд░рдиреЗ рдХреЗ <a href="https://mcs.mail.ru/help/iaas-api/openstack-api">рд▓рд┐рдП Mail.ru Cloud Solutions</a> (MCS) <a href="https://mcs.mail.ru/help/iaas-api/openstack-api">API</a> рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ <a href="https://mcs.mail.ru/help/iaas-api/openstack-api">рд╣реИ</a> ред </p><br><h2 id="arhitektura-resheniya">  рд╕рдорд╛рдзрд╛рди рд╡рд╛рд╕реНрддреБрдХрд▓рд╛ </h2><br><ol><li> рдореЙрдбреНрдпреВрд▓ <code>autoscaler.py</code>  рдЗрд╕рдореЗрдВ рддреАрди рдХрдХреНрд╖рд╛рдПрдВ рдкрдВрдЬреАрдХреГрдд рд╣реИрдВ: 1) рдЕрдореНрдмрд╛рд░реА рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, 2) рдПрдорд╕реАрдПрд╕ рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП 2) рдХрд╛рд░реНрдп, 3) рдХрд╛рд░реНрдп рд╕реАрдзреЗ рдСрдЯреЛрд╕рд╛рд▓реНрдХрд░ рддрд░реНрдХ рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд рд╣реИрдВред </li><li>  рд╕реНрдХреНрд░рд┐рдкреНрдЯ <code>observer.py</code>  рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ, рдЗрд╕рдореЗрдВ рдЕрд▓рдЧ-рдЕрд▓рдЧ рдирд┐рдпрдо рд╣реЛрддреЗ рд╣реИрдВ: рдХрдм рдФрд░ рдХрд┐рди рдХреНрд╖рдгреЛрдВ рдореЗрдВ рдСрдЯреЛрд╕рд╛рд▓рд░ рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдХреЙрд▓ рдХрд░рдирд╛ рд╣реИред </li><li>  рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдорд╛рдкрджрдВрдбреЛрдВ рдХреЗ рд╕рд╛рде рдлрд╝рд╛рдЗрд▓ <code>config.py</code> ред  рдЗрд╕рдореЗрдВ рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдСрдЯреЛрд╕реНрдХреЛрд▓рд┐рдВрдЧ рдФрд░ рдЕрдиреНрдп рдорд╛рдкрджрдВрдбреЛрдВ рдХреЗ рд▓рд┐рдП рдЕрдиреБрдордд рдиреЛрдбреНрд╕ рдХреА рдПрдХ рд╕реВрдЪреА рд╣реИ рдЬреЛ рдкреНрд░рднрд╛рд╡рд┐рдд рдХрд░рддреЗ рд╣реИрдВ, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдПрдХ рдирдП рдиреЛрдб рдХреЛ рдЬреЛрдбрд╝рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рддрдирд╛ рд╕рдордп рдЗрдВрддрдЬрд╛рд░ рдХрд░рдирд╛ рдкрдбрд╝рддрд╛ рд╣реИред  рдХрдХреНрд╖рд╛рдУрдВ рдХреА рд╢реБрд░реБрдЖрдд рдХреЗ рдЯрд╛рдЗрдорд╕реНрдЯреИрдореНрдк рднреА рд╣реИрдВ, рддрд╛рдХрд┐ рд╕рддреНрд░ рд╕реЗ рдкрд╣рд▓реЗ рдЕрдзрд┐рдХрддрдо рдЕрдиреБрдордд рдХреНрд▓рд╕реНрдЯрд░ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рд▓реЙрдиреНрдЪ рд╣реЛред </li></ol><br><p>  рдЖрдЗрдП рдкрд╣рд▓реЗ рджреЛ рдлрд╛рдЗрд▓реЛрдВ рдХреЗ рдЕрдВрджрд░ рдХреЛрдб рдХреЗ рдЯреБрдХрдбрд╝реЛрдВ рдХреЛ рджреЗрдЦреЗрдВред </p><br><h2 id="1-modul-autoscalerpy">  1. autoscaler.py рдореЙрдбреНрдпреВрд▓ </h2><br><h3 id="klass-ambari">  рдХрдХреНрд╖рд╛ рдЕрдореНрдмрд╛рд░реА </h3><br><p>  рдпрд╣ рдХреЛрдб рдХрд╛ рдЯреБрдХрдбрд╝рд╛ рд╣реИ рдЬрд┐рд╕рдореЗрдВ <code>Ambari</code> рд╡рд░реНрдЧ рд╢рд╛рдорд┐рд▓ рд╣реИ: </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Ambari</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, ambari_url, cluster_name, headers, auth)</span></span></span><span class="hljs-function">:</span></span> self.ambari_url = ambari_url self.cluster_name = cluster_name self.headers = headers self.auth = auth <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stop_all_services</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, hostname)</span></span></span><span class="hljs-function">:</span></span> url = self.ambari_url + self.cluster_name + <span class="hljs-string"><span class="hljs-string">'/hosts/'</span></span> + hostname + <span class="hljs-string"><span class="hljs-string">'/host_components/'</span></span> url2 = self.ambari_url + self.cluster_name + <span class="hljs-string"><span class="hljs-string">'/hosts/'</span></span> + hostname req0 = requests.get(url2, headers=self.headers, auth=self.auth) services = req0.json()[<span class="hljs-string"><span class="hljs-string">'host_components'</span></span>] services_list = list(map(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> x: x[<span class="hljs-string"><span class="hljs-string">'HostRoles'</span></span>][<span class="hljs-string"><span class="hljs-string">'component_name'</span></span>], services)) data = { <span class="hljs-string"><span class="hljs-string">"RequestInfo"</span></span>: { <span class="hljs-string"><span class="hljs-string">"context"</span></span>:<span class="hljs-string"><span class="hljs-string">"Stop All Host Components"</span></span>, <span class="hljs-string"><span class="hljs-string">"operation_level"</span></span>: { <span class="hljs-string"><span class="hljs-string">"level"</span></span>:<span class="hljs-string"><span class="hljs-string">"HOST"</span></span>, <span class="hljs-string"><span class="hljs-string">"cluster_name"</span></span>: self.cluster_name, <span class="hljs-string"><span class="hljs-string">"host_names"</span></span>: hostname }, <span class="hljs-string"><span class="hljs-string">"query"</span></span>:<span class="hljs-string"><span class="hljs-string">"HostRoles/component_name.in({0})"</span></span>.format(<span class="hljs-string"><span class="hljs-string">","</span></span>.join(services_list)) }, <span class="hljs-string"><span class="hljs-string">"Body"</span></span>: { <span class="hljs-string"><span class="hljs-string">"HostRoles"</span></span>: { <span class="hljs-string"><span class="hljs-string">"state"</span></span>:<span class="hljs-string"><span class="hljs-string">"INSTALLED"</span></span> } } } req = requests.put(url, data=json.dumps(data), headers=self.headers, auth=self.auth) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> req.status_code <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> [<span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-number"><span class="hljs-number">201</span></span>, <span class="hljs-number"><span class="hljs-number">202</span></span>]: message = <span class="hljs-string"><span class="hljs-string">'Request accepted'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: message = req.status_code <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message</code> </pre> <br><p>  рдЙрдкрд░реЛрдХреНрдд рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдЖрдк <code>stop_all_services</code> рдлрд╝рдВрдХреНрд╢рди рдХреЗ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рдХреЛ рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ, рдЬреЛ рд╡рд╛рдВрдЫрд┐рдд рдХреНрд▓рд╕реНрдЯрд░ рдиреЛрдб рдкрд░ рд╕рднреА рд╕реЗрд╡рд╛рдУрдВ рдХреЛ рд░реЛрдХрддрд╛ рд╣реИред </p><br><p>  <code>Ambari</code> рд╡рд░реНрдЧ рдХреЗ рд▓рд┐рдП рдЖрдк рдкрд╛рд╕: </p><br><ul><li>  <code>ambari_url</code> , рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, <code>'http://localhost:8080/api/v1/clusters/'</code> рдлреЙрд░реНрдо </li><li>  <code>cluster_name</code> рдЕрдВрдмрд╛рд░реА рдореЗрдВ рдЖрдкрдХреЗ рдХреНрд▓рд╕реНрдЯрд░ рдХрд╛ рдирд╛рдо рд╣реИ, </li><li> <code>headers = {'X-Requested-By': 'ambari'}</code> </li> <li>  рдФрд░ рдЕрдВрджрд░ рд╕реНрдерд┐рдд рдЕрдВрдмрд╛рд░реА рд╕реЗ рдЖрдкрдХрд╛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдирд╛рдо рдФрд░ рдкрд╛рд╕рд╡рд░реНрдб рдирд┐рд╣рд┐рдд рд╣реИ: <code>auth = ('login', 'password')</code> ред </li></ul><br><p>  рдлрд╝рдВрдХреНрд╢рди рд╕реНрд╡рдпрдВ REST API рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ Ambari рдкрд░ рдХреЙрд▓ рдХреЗ рдПрдХ рдЬреЛрдбрд╝реЗ рд╕реЗ рдЕрдзрд┐рдХ рдХреБрдЫ рдирд╣реАрдВ рд╣реИред  рддрд░реНрдХ рдХреА рджреГрд╖реНрдЯрд┐ рд╕реЗ, рд╣рдореЗрдВ рдкрд╣рд▓реЗ рдиреЛрдб рдкрд░ рдЪрд▓рдиреЗ рд╡рд╛рд▓реА рд╕реЗрд╡рд╛рдУрдВ рдХреА рдПрдХ рд╕реВрдЪреА рдорд┐рд▓рддреА рд╣реИ, рдФрд░ рдлрд┐рд░ рд╣рдо рдЗрд╕ рдиреЛрдб рдкрд░ рдХреНрд▓рд╕реНрдЯрд░ рд╕реЗ, рд╕реЗрд╡рд╛рдУрдВ рдХреЛ рд╕реВрдЪреА рд╕реЗ <code>INSTALLED</code> рдЕрд╡рд╕реНрдерд╛ рдореЗрдВ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд╣рддреЗ рд╣реИрдВред  <code>Maintenance</code> рд░рд╛рдЬреНрдп рдореЗрдВ рдиреЛрдбреНрд╕ рд▓рдЧрд╛рдиреЗ рдХреЗ рд▓рд┐рдП рд╕рднреА рд╕реЗрд╡рд╛рдУрдВ рдХреЛ рд╢реБрд░реВ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд╛рд░реНрдп, рдЖрджрд┐ рд╕рдорд╛рди рджрд┐рдЦрддреЗ рд╣реИрдВ - рд╡реЗ рдПрдкреАрдЖрдИ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдХреЗрд╡рд▓ рдХреБрдЫ рдЕрдиреБрд░реЛрдз рд╣реИрдВред </p><br><h3 id="klass-mcs">  рдХреНрд▓рд╛рд╕ рдПрдордХреЗрдПрд╕ </h3><br><p>  рдпрд╣ рдХреЛрдб рдХрд╛ рдЯреБрдХрдбрд╝рд╛ рд╣реИ рдЬрд┐рд╕рдореЗрдВ <code>Mcs</code> рд╡рд░реНрдЧ рд╢рд╛рдорд┐рд▓ рд╣реИ: </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Mcs</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, id1, id2, password)</span></span></span><span class="hljs-function">:</span></span> self.id1 = id1 self.id2 = id2 self.password = password self.mcs_host = <span class="hljs-string"><span class="hljs-string">'https://infra.mail.ru:8774/v2.1'</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">vm_turn_on</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, hostname)</span></span></span><span class="hljs-function">:</span></span> self.token = self.get_mcs_token() host = self.hostname_to_vmname(hostname) vm_id = self.get_vm_id(host) mcs_url1 = self.mcs_host + <span class="hljs-string"><span class="hljs-string">'/servers/'</span></span> + self.vm_id + <span class="hljs-string"><span class="hljs-string">'/action'</span></span> headers = { <span class="hljs-string"><span class="hljs-string">'X-Auth-Token'</span></span>: <span class="hljs-string"><span class="hljs-string">'{0}'</span></span>.format(self.token), <span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>: <span class="hljs-string"><span class="hljs-string">'application/json'</span></span> } data = {<span class="hljs-string"><span class="hljs-string">'os-start'</span></span> : <span class="hljs-string"><span class="hljs-string">'null'</span></span>} mcs = requests.post(mcs_url1, data=json.dumps(data), headers=headers) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mcs.status_code</code> </pre> <br><p>  <code>Mcs</code> рд╡рд░реНрдЧ рдХреЗ рд▓рд┐рдП, рд╣рдо рдХреНрд▓рд╛рдЙрдб рдФрд░ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЖрдИрдбреА рдХреЗ рд╕рд╛рде-рд╕рд╛рде рдЙрд╕рдХреЗ рдкрд╛рд╕рд╡рд░реНрдб рдХреЗ рд╕рд╛рде рдкреНрд░реЛрдЬреЗрдХреНрдЯ рдЖрдИрдбреА рдкрд╛рд╕ рдХрд░рддреЗ рд╣реИрдВред  <code>vm_turn_on</code> рдлрд╝рдВрдХреНрд╢рди рдореЗрдВ рд╣рдо рдХрд┐рд╕реА рдПрдХ рдорд╢реАрди рдХреЛ рд╕рдХреНрд╖рдо рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВред  рдпрд╣рд╛рдБ рддрд░реНрдХ рдереЛрдбрд╝рд╛ рдФрд░ рдЬрдЯрд┐рд▓ рд╣реИред  рдХреЛрдб рдХреА рд╢реБрд░реБрдЖрдд рдореЗрдВ, рддреАрди рдЕрдиреНрдп рдХрд╛рд░реНрдпреЛрдВ рдХреЛ рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИ: 1) рд╣рдореЗрдВ рдЯреЛрдХрди рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ, 2) рд╣рдореЗрдВ рд╣реЛрд╕реНрдЯрдирд╛рдо рдХреЛ рдПрдорд╕реАрдПрд╕ рдореЗрдВ рдорд╢реАрди рдХреЗ рдирд╛рдо рдореЗрдВ рдмрджрд▓рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ, 3) рдЗрд╕ рдорд╢реАрди рдХреА рдЖрдИрдбреА рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВред  рдЕрдЧрд▓рд╛, рд╣рдо рдПрдХ рд╕рд░рд▓ рдкреЛрд╕реНрдЯ-рдЕрдиреБрд░реЛрдз рдХрд░рддреЗ рд╣реИрдВ рдФрд░ рдЗрд╕ рдорд╢реАрди рдХреЛ рдЪрд▓рд╛рддреЗ рд╣реИрдВред </p><br><p>  рдЗрд╕ рдкреНрд░рдХрд╛рд░ рдЯреЛрдХрди рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХрд╛ рдХрд╛рд░реНрдп рджрд┐рдЦрддрд╛ рд╣реИ: </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_mcs_token</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> url = <span class="hljs-string"><span class="hljs-string">'https://infra.mail.ru:35357/v3/auth/tokens?nocatalog'</span></span> headers = {<span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>: <span class="hljs-string"><span class="hljs-string">'application/json'</span></span>} data = { <span class="hljs-string"><span class="hljs-string">'auth'</span></span>: { <span class="hljs-string"><span class="hljs-string">'identity'</span></span>: { <span class="hljs-string"><span class="hljs-string">'methods'</span></span>: [<span class="hljs-string"><span class="hljs-string">'password'</span></span>], <span class="hljs-string"><span class="hljs-string">'password'</span></span>: { <span class="hljs-string"><span class="hljs-string">'user'</span></span>: { <span class="hljs-string"><span class="hljs-string">'id'</span></span>: self.id1, <span class="hljs-string"><span class="hljs-string">'password'</span></span>: self.password } } }, <span class="hljs-string"><span class="hljs-string">'scope'</span></span>: { <span class="hljs-string"><span class="hljs-string">'project'</span></span>: { <span class="hljs-string"><span class="hljs-string">'id'</span></span>: self.id2 } } } } params = ((<span class="hljs-string"><span class="hljs-string">'nocatalog'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>),) req = requests.post(url, data=json.dumps(data), headers=headers, params=params) self.token = req.headers[<span class="hljs-string"><span class="hljs-string">'X-Subject-Token'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.token</code> </pre> <br><h3 id="klass-autoscaler">  рдХреНрд▓рд╛рд╕ рдСрдЯреЛрд╕рд╛рд▓рд░ </h3><br><p>  рдЗрд╕ рд╡рд░реНрдЧ рдореЗрдВ рдХрд╛рд░реНрдп рдХреЗ рддрд░реНрдХ рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд рдХрд╛рд░реНрдп рд╢рд╛рдорд┐рд▓ рд╣реИрдВред </p><br><p>  рдЗрд╕ рддрд░рд╣ рдЗрд╕ рд╡рд░реНрдЧ рдХрд╛ рдПрдХ рдХреЛрдб рджрд┐рдЦрддрд╛ рд╣реИ: </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Autoscaler</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, ambari, mcs, scaling_hosts, yarn_ram_per_node, yarn_cpu_per_node)</span></span></span><span class="hljs-function">:</span></span> self.scaling_hosts = scaling_hosts self.ambari = ambari self.mcs = mcs self.q_ram = deque() self.q_cpu = deque() self.num = <span class="hljs-number"><span class="hljs-number">0</span></span> self.yarn_ram_per_node = yarn_ram_per_node self.yarn_cpu_per_node = yarn_cpu_per_node <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">scale_down</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, hostname)</span></span></span><span class="hljs-function">:</span></span> flag1 = flag2 = flag3 = flag4 = flag5 = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> hostname <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> self.scaling_hosts: <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: time.sleep(<span class="hljs-number"><span class="hljs-number">5</span></span>) status1 = self.ambari.decommission_nodemanager(hostname) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> status1 == <span class="hljs-string"><span class="hljs-string">'Request accepted'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> status1 == <span class="hljs-number"><span class="hljs-number">500</span></span>: flag1 = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> logging.info(<span class="hljs-string"><span class="hljs-string">'Decomission request accepted: {0}'</span></span>.format(flag1)) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: time.sleep(<span class="hljs-number"><span class="hljs-number">5</span></span>) status3 = self.ambari.check_service(hostname, <span class="hljs-string"><span class="hljs-string">'NODEMANAGER'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> status3 == <span class="hljs-string"><span class="hljs-string">'INSTALLED'</span></span>: flag3 = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> logging.info(<span class="hljs-string"><span class="hljs-string">'Nodemaneger decommissioned: {0}'</span></span>.format(flag3)) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: time.sleep(<span class="hljs-number"><span class="hljs-number">5</span></span>) status2 = self.ambari.maintenance_on(hostname) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> status2 == <span class="hljs-string"><span class="hljs-string">'Request accepted'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> status2 == <span class="hljs-number"><span class="hljs-number">500</span></span>: flag2 = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> logging.info(<span class="hljs-string"><span class="hljs-string">'Maintenance request accepted: {0}'</span></span>.format(flag2)) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: time.sleep(<span class="hljs-number"><span class="hljs-number">5</span></span>) status4 = self.ambari.check_maintenance(hostname, <span class="hljs-string"><span class="hljs-string">'NODEMANAGER'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> status4 == <span class="hljs-string"><span class="hljs-string">'ON'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> status4 == <span class="hljs-string"><span class="hljs-string">'IMPLIED_FROM_HOST'</span></span>: flag4 = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> self.ambari.stop_all_services(hostname) logging.info(<span class="hljs-string"><span class="hljs-string">'Maintenance is on: {0}'</span></span>.format(flag4)) logging.info(<span class="hljs-string"><span class="hljs-string">'Stopping services'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> time.sleep(<span class="hljs-number"><span class="hljs-number">90</span></span>) status5 = self.mcs.vm_turn_off(hostname) <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: time.sleep(<span class="hljs-number"><span class="hljs-number">5</span></span>) status5 = self.mcs.get_vm_info(hostname)[<span class="hljs-string"><span class="hljs-string">'server'</span></span>][<span class="hljs-string"><span class="hljs-string">'status'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> status5 == <span class="hljs-string"><span class="hljs-string">'SHUTOFF'</span></span>: flag5 = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> logging.info(<span class="hljs-string"><span class="hljs-string">'VM is turned off: {0}'</span></span>.format(flag5)) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> flag1 <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> flag2 <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> flag3 <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> flag4 <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> flag5: message = <span class="hljs-string"><span class="hljs-string">'Success'</span></span> logging.info(<span class="hljs-string"><span class="hljs-string">'Scale-down finished'</span></span>) logging.info(<span class="hljs-string"><span class="hljs-string">'Cooldown period has started. Wait for several minutes'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message</code> </pre> <br><p>  рдЗрдирдкреБрдЯ рдХреЗ рд▓рд┐рдП рд╣рдо <code>Ambari</code> рдФрд░ <code>Mcs</code> рдХрдХреНрд╖рд╛рдУрдВ рдХреЛ рд▓реЗрддреЗ рд╣реИрдВ, рд╕реНрдХреЗрд▓рд┐рдВрдЧ рдХреЗ рд▓рд┐рдП рдЕрдиреБрдорддрд┐ рджреЗрдиреЗ рд╡рд╛рд▓реЗ рдиреЛрдбреНрд╕ рдХреА рд╕реВрдЪреА, рд╕рд╛рде рд╣реА рдиреЛрдбреНрд╕ рдХреЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдкреИрд░рд╛рдореАрдЯрд░: рд╕реНрдореГрддрд┐ рдФрд░ рд╕реАрдкреАрдпреВ рдХреЛ рдпрд╛рд░реНрди рдореЗрдВ рдиреЛрдб рдХреЛ рдЖрд╡рдВрдЯрд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ред  2 рдЖрдВрддрд░рд┐рдХ рдкреИрд░рд╛рдореАрдЯрд░ q_ram, q_cpu рднреА рд╣реИрдВ, рдЬреЛ рдХрддрд╛рд░ рдореЗрдВ рд╣реИрдВред  рдЙрдирдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реБрдП, рд╣рдо рд╡рд░реНрддрдорд╛рди рдХреНрд▓рд╕реНрдЯрд░ рд▓реЛрдб рдХреЗ рдореВрд▓реНрдпреЛрдВ рдХреЛ рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд░рддреЗ рд╣реИрдВред  рдпрджрд┐ рд╣рдо рджреЗрдЦрддреЗ рд╣реИрдВ рдХрд┐ рдкрд┐рдЫрд▓реЗ 5 рдорд┐рдирдЯреЛрдВ рдореЗрдВ рд╕реНрдерд┐рд░ рд╡реГрджреНрдзрд┐ рд╣реБрдИ рд╣реИ, рддреЛ рд╣рдо рддрдп рдХрд░рддреЗ рд╣реИрдВ рдХрд┐ рд╣рдореЗрдВ рдХреНрд▓рд╕реНрдЯрд░ рдореЗрдВ +1 рдиреЛрдб рдЬреЛрдбрд╝рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред  рдХреНрд▓рд╕реНрдЯрд░ рдЕрдВрдбрд░рд▓реЛрдб рд╕реНрдерд┐рддрд┐ рдХреЗ рд▓рд┐рдП рднреА рдпрд╣реА рд╕рдЪ рд╣реИред </p><br><p>  рдЙрдкрд░реЛрдХреНрдд рдХреЛрдб рдПрдХ рдлрд╝рдВрдХреНрд╢рди рдХрд╛ рдПрдХ рдЙрджрд╛рд╣рд░рдг рджрд┐рдЦрд╛рддрд╛ рд╣реИ рдЬреЛ рдПрдХ рдорд╢реАрди рдХреЛ рдХреНрд▓рд╕реНрдЯрд░ рд╕реЗ рдирд┐рдХрд╛рд▓рддрд╛ рд╣реИ рдФрд░ рдЗрд╕реЗ рдХреНрд▓рд╛рдЙрдб рдореЗрдВ рд░реЛрдХрддрд╛ рд╣реИред  рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ, <code>YARN Nodemanager</code> , рдлрд┐рд░ <code>Maintenance</code> рдореЛрдб рдЪрд╛рд▓реВ рд╣реЛрддрд╛ рд╣реИ, рдлрд┐рд░ рд╣рдо рдорд╢реАрди рдкрд░ рд╕рднреА рд╕реЗрд╡рд╛рдУрдВ рдХреЛ рдмрдВрдж рдХрд░ рджреЗрддреЗ рд╣реИрдВ рдФрд░ рдХреНрд▓рд╛рдЙрдб рдореЗрдВ рд╡рд░реНрдЪреБрдЕрд▓ рдорд╢реАрди рдХреЛ рдмрдВрдж рдХрд░ рджреЗрддреЗ рд╣реИрдВред </p><br><h2 id="2-skript-observerpy">  2. рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдкреНрд░реЗрдХреНрд╖рдХ </h2><br><p>  рд╡рд╣рд╛рдВ рд╕реЗ рдирдореВрдирд╛ рдХреЛрдб: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> scaler.assert_up(config.scale_up_thresholds) == <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: hostname = cloud.get_vm_to_up(config.scaling_hosts) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> hostname != <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: status1 = scaler.scale_up(hostname) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> status1 == <span class="hljs-string"><span class="hljs-string">'Success'</span></span>: text = {<span class="hljs-string"><span class="hljs-string">"text"</span></span>: <span class="hljs-string"><span class="hljs-string">"{0} has been successfully scaled-up"</span></span>.format(hostname)} post = {<span class="hljs-string"><span class="hljs-string">"text"</span></span>: <span class="hljs-string"><span class="hljs-string">"{0}"</span></span>.format(text)} json_data = json.dumps(post) req = requests.post(webhook, data=json_data.encode(<span class="hljs-string"><span class="hljs-string">'ascii'</span></span>), headers={<span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>: <span class="hljs-string"><span class="hljs-string">'application/json'</span></span>}) time.sleep(config.cooldown_period*<span class="hljs-number"><span class="hljs-number">60</span></span>)</code> </pre> <br><p>  рдЗрд╕рдореЗрдВ, рд╣рдо рдЬрд╛рдБрдЪрддреЗ рд╣реИрдВ рдХрд┐ рдХреНрд▓рд╕реНрдЯрд░ рдХреНрд╖рдорддрд╛ рдмрдврд╝рд╛рдиреЗ рдХреЗ рд▓рд┐рдП рд╕реНрдерд┐рддрд┐рдпрд╛рдБ рдореМрдЬреВрдж рд╣реИрдВ рдпрд╛ рдирд╣реАрдВ рдФрд░ рд░рд┐рдЬрд╝рд░реНрд╡ рдореЗрдВ рдорд╢реАрдиреЗрдВ рд╣реИрдВ рдпрд╛ рдирд╣реАрдВ, рд╣рдо рдЙрдирдореЗрдВ рд╕реЗ рдХрд┐рд╕реА рдПрдХ рдХрд╛ рд╣реЛрд╕реНрдЯрдирд╛рдо рдкреНрд░рд╛рдкреНрдд рдХрд░рддреЗ рд╣реИрдВ, рдЗрд╕реЗ рдХреНрд▓рд╕реНрдЯрд░ рдореЗрдВ рдЬреЛрдбрд╝рддреЗ рд╣реИрдВ рдФрд░ рд╣рдорд╛рд░реА рдЯреАрдо рдХреЗ рд╕реНрд▓реИрдХ рдореЗрдВ рдЗрд╕ рдмрд╛рд░реЗ рдореЗрдВ рдПрдХ рд╕рдВрджреЗрд╢ рдкреНрд░рдХрд╛рд╢рд┐рдд рдХрд░рддреЗ рд╣реИрдВред  рдЙрд╕рдХреЗ рдмрд╛рдж, <code>cooldown_period</code> рд▓реЙрдиреНрдЪ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдЬрдм рд╣рдо рдХреНрд▓рд╕реНрдЯрд░ рд╕реЗ рдХреБрдЫ рднреА рдирд╣реАрдВ рдЬреЛрдбрд╝рддреЗ рдпрд╛ рд╣рдЯрд╛рддреЗ рд╣реИрдВ, рд▓реЗрдХрд┐рди рдмрд╕ рд▓реЛрдб рдХреА рдирд┐рдЧрд░рд╛рдиреА рдХрд░рддреЗ рд╣реИрдВред  рдпрджрд┐ рдпрд╣ рд╕реНрдерд┐рд░ рд╣реЛ рдЧрдпрд╛ рд╣реИ рдФрд░ рдЗрд╖реНрдЯрддрдо рднрд╛рд░ рдореВрд▓реНрдпреЛрдВ рдХреЗ рдЧрд▓рд┐рдпрд╛рд░реЗ рдХреЗ рдЕрдВрджрд░ рд╣реИ, рддреЛ рд╣рдо рдмрд╕ рдирд┐рдЧрд░рд╛рдиреА рдЬрд╛рд░реА рд░рдЦрддреЗ рд╣реИрдВред  рдпрджрд┐ рдПрдХ рдиреЛрдб рдкрд░реНрдпрд╛рдкреНрдд рдирд╣реАрдВ рдерд╛, рддреЛ рдПрдХ рдФрд░ рдЬреЛрдбрд╝реЗрдВред </p><br><p>  рдРрд╕реЗ рдорд╛рдорд▓реЛрдВ рдХреЗ рд▓рд┐рдП рдЬрдм рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рдПрдХ рд╕рдмрдХ рд╣реИ, рд╣рдо рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдпрд╣ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЬрд╛рдирддреЗ рд╣реИрдВ рдХрд┐ рдПрдХ рдиреЛрдб рдкрд░реНрдпрд╛рдкреНрдд рдирд╣реАрдВ рд╣реИ, рдЗрд╕рд▓рд┐рдП рд╣рдо рддреБрд░рдВрдд рд╕рднреА рдореБрдлреНрдд рдиреЛрдб рд╢реБрд░реВ рдХрд░рддреЗ рд╣реИрдВ рдФрд░ рдкрд╛рда рдХреЗ рдЕрдВрдд рддрдХ рдЙрдиреНрд╣реЗрдВ рд╕рдХреНрд░рд┐рдп рд░рдЦрддреЗ рд╣реИрдВред  рдпрд╣ рдЯрд╛рдЗрдорд╕реНрдЯреИрдореНрдк рд╡рд░реНрдЧреЛрдВ рдХреА рд╕реВрдЪреА рдХреЗ рд╕рд╛рде рд╣реЛрддрд╛ рд╣реИред </p><br><h2 id="zaklyuchenie">  рдирд┐рд╖реНрдХрд░реНрд╖ </h2><br><p>  рдЬрдм рдЖрдк рдЕрд╕рдорд╛рди рдХреНрд▓рд╕реНрдЯрд░ рд▓реЛрдб рд╣реЛ рд░рд╣реЗ рд╣реИрдВ, рддреЛ рдЙрди рдорд╛рдорд▓реЛрдВ рдХреЗ рд▓рд┐рдП рдСрдЯреЛрд╕реНрдХреЛрд▓рд░ рдПрдХ рдЕрдЪреНрдЫрд╛ рдФрд░ рд╕реБрд╡рд┐рдзрд╛рдЬрдирдХ рд╕рдорд╛рдзрд╛рди рд╣реИред  рдЖрдк рдПрдХ рд╕рд╛рде рдкреАрдХ рд▓реЛрдб рдХреЗ рд▓рд┐рдП рд╡рд╛рдВрдЫрд┐рдд рдХреНрд▓рд╕реНрдЯрд░ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдкреНрд░рд╛рдкреНрдд рдХрд░рддреЗ рд╣реИрдВ, рдФрд░ рд╕рд╛рде рд╣реА рдЗрд╕ рдХреНрд▓рд╕реНрдЯрд░ рдХреЛ рдЕрдВрдбрд░рд▓реЛрдбрд┐рдВрдЧ рдХреЗ рджреМрд░рд╛рди, рдкреИрд╕реЗ рдмрдЪрд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдирд╣реАрдВ рдкрдХрдбрд╝рддреЗ рд╣реИрдВред  рдЦреИрд░, рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдпрд╣ рд╕рдм рдЖрдкрдХреА рднрд╛рдЧреАрджрд╛рд░реА рдХреЗ рдмрд┐рдирд╛ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рд╣реЛрддрд╛ рд╣реИред  рдСрдЯреЛрд╕реИрдХрд░ рд╕реНрд╡рдпрдВ рдХреНрд▓рд╕реНрдЯрд░ рдкреНрд░рдмрдВрдзрдХ рдПрдкреАрдЖрдИ рдФрд░ рдХреНрд▓рд╛рдЙрдб рдкреНрд░рджрд╛рддрд╛ рдПрдкреАрдЖрдИ рдХреЗ рдЕрдиреБрд░реЛрдзреЛрдВ рдХреЗ рдПрдХ рд╕реЗрдЯ рд╕реЗ рдЬреНрдпрд╛рджрд╛ рдХреБрдЫ рдирд╣реАрдВ рд╣реИ, рдЬреЛ рдПрдХ рдирд┐рд╢реНрдЪрд┐рдд рддрд░реНрдХ рдХреЗ рдЕрдиреБрд╕рд╛рд░ рдкрдВрдЬреАрдХреГрдд рд╣реИрдВред  рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдпрд╛рдж рд░рдЦрдиреЗ рдХреА рдЬрд░реВрд░рдд рд╣реИ рдХрд┐ рдиреЛрдбреНрд╕ рдХреЛ 3 рдкреНрд░рдХрд╛рд░реЛрдВ рдореЗрдВ рдЕрд▓рдЧ рдХрд░рдирд╛ рд╣реИ, рдЬреИрд╕рд╛ рдХрд┐ рд╣рдордиреЗ рдкрд╣рд▓реЗ рд▓рд┐рдЦрд╛ рдерд╛ред  рдФрд░ рдЖрдк рдЦреБрд╢ рд░рд╣реЗрдВрдЧреЗред </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/hi482198/">https://habr.com/ru/post/hi482198/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../hi482186/index.html">рдЬреАрд╡рди рдФрд░ рдЖрдИрдЯреА рдпрд╛ рд╡рд░реНрд╖ рдореИрдВрдиреЗ рдЕрдкрдиреА рдЖрдЦрд┐рд░реА рдиреМрдХрд░реА рдЫреЛрдбрд╝ рджреА</a></li>
<li><a href="../hi482188/index.html">рдЕрджреНрдпрддрди рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рд╢реБрдХреНрд░рд╡рд╛рд░ рдкреЛрд▓</a></li>
<li><a href="../hi482190/index.html">Durex рдХрдВрдЯреЗрдВрдЯ рдЪреАрди рдореЗрдВ рд╕реЛрд╢рд▓ рдиреЗрдЯрд╡рд░реНрдХ рдкрд░ рдХреИрд╕рд╛ рджрд┐рдЦрддрд╛ рд╣реИ</a></li>
<li><a href="../hi482194/index.html">рдСрдЯреЛ рдЙрддреНрдкрдиреНрди рдФрд░ рднрд░реЗрдВ рдиреЗрдЯрд╡рд░реНрдХ рдбрд┐рд╡рд╛рдЗрд╕ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рддрддреНрд╡ Nornir рдХреЗ рд╕рд╛рде</a></li>
<li><a href="../hi482196/index.html">рдЙрддреНрдкрд╛рджрди рдореЙрдбрд▓рд┐рдВрдЧ рдХреНрдпрд╛ рд╣реИ рдФрд░ рдЗрд╕рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдХреНрдпреЛрдВ рд╣реИ?</a></li>
<li><a href="../hi482200/index.html">рд╕рд╛рдЗрдмрд░рд╕рд┐рдЯреА рдХреЗ рд▓рд┐рдП рдмреНрд▓реЙрдХрдЪреИрди: рдЕрдкреЗрдХреНрд╖рд╛рдПрдВ рдФрд░ рд╡рд╛рд╕реНрддрд╡рд┐рдХрддрд╛</a></li>
<li><a href="../hi482202/index.html">GOST 2012 рдХреЛ рдЪреЗрдХ рдкреНрд╡рд╛рдЗрдВрдЯ рдЙрдкрдХрд░рдг рдкрд░ рдХреНрд░рд┐рдкреНрдЯреЛрдЧреНрд░рд╛рдлреА рдЕрдкрдбреЗрдЯ рдХрд░рдиреЗ рдХреЗ рддрд░реАрдХреЗ</a></li>
<li><a href="../hi482208/index.html">рдЙрдкрд╣рд╛рд░ рдЬреЛ рдЖрдкрдХреЛ рдирдП рд╕рд╛рд▓ рдХреЛ рдпрд╛рдж рдХрд░рддреЗ рд╣реИрдВ</a></li>
<li><a href="../hi482210/index.html">рдЯреЗрдЯреНрд░рд┐рд╕ рдХреЗ рд▓рд┐рдП рдмреЙрдЯ рдФрд░ рд░рд┐рд╡рд░реНрд╕ рдЗрдВрдЬреАрдирд┐рдпрд░рд┐рдВрдЧ рдПрдиреАрдореЗрд╢рдиред рджреВрд╕рд░реА рдкреНрд░реЛрдЧреНрд░рд╛рдорд┐рдВрдЧ рдЪреИрдореНрдкрд┐рдпрдирд╢рд┐рдк рдХреЗ рдореЛрдмрд╛рдЗрд▓ рдЯреНрд░реИрдХ рдХрд╛ рд╡рд┐рд╢реНрд▓реЗрд╖рдг</a></li>
<li><a href="../hi482212/index.html">рдмрд╛рдд рдХрд░рддреЗ рд╣реИрдВ ... рдкрдиреАрд░?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>