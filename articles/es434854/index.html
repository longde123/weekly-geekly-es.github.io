<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèæ‚Äçü§ù‚Äçüë®üèø ‚ôéÔ∏è üë©üèæ‚Äçü§ù‚Äçüë®üèΩ Panel de control de bricolaje nave espacial de bricolaje ü§¢ üë©üèº‚ÄçüöÄ üèä</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hola queridos lectores! 

 Aqu√≠ se me ocurri√≥ una idea, pero no armar un panel de control para una nave espacial. A USB. Con soporte de controladores ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Panel de control de bricolaje nave espacial de bricolaje</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/434854/"><img src="https://habrastorage.org/webt/jq/jk/xz/jqjkxzwpn74xwt3quxzwbzwcxoa.jpeg"><br>  Hola queridos lectores! <br><br>  Aqu√≠ se me ocurri√≥ una idea, pero no armar un panel de control para una nave espacial.  A USB.  Con soporte de controladores nativos.  HID personalizado.  Para pegar y todo funciona, sin bailes y panderetas.  Como resultado, obtuvimos una especie de monstruoso "gamepad" para simuladores espaciales.  En general, juzga por ti mismo. <br><a name="habracut"></a><br>  Al principio, ten√≠a poca idea de lo que suceder√≠a al final.  Quer√≠a dos joysticks principales, como en Soyuz-MS, algunos interruptores, botones y varias pantallas. <br><br>  Habiendo estimado la superficie de trabajo de mi mesa, eleg√≠ las dimensiones de la consola en ancho y profundidad 500 * 300 mm.  Y tras hurgar en los almacenes y tiendas de construcci√≥n en busca de materiales de construcci√≥n, eligi√≥ una altura de 125 mm.  Como resultado, adquir√≠ una l√°mina de madera contrachapada de 4 mm, listones de 20 * 12 mm y un tablero de 120 * 20 mm. <br><br>  En el cad, se dibuj√≥ r√°pidamente un boceto del control remoto.  Y lo hice en un √°rbol durante mucho tiempo.  Tres meses  los fines de semana  Y no porque trabajara tan imponentemente como una sierra, sino por falta de tiempo.  El panel se coloc√≥, lij√≥ y pint√≥ con pintura de esmalte, de color similar a los paneles reales de naves espaciales o aviones. <br><br><img src="https://habrastorage.org/webt/oa/oz/ck/oaozck0uudattfk5yl0mhztmx4o.jpeg"><br><br>  Pero por ahora, deje de lado el trabajo de pintura y hablar√© sobre el relleno electr√≥nico. <br><br>  Se compraron piezas de radio en Ali.  Como joysticks, encontr√© estos.  En general, la situaci√≥n con tales joysticks es una costura completa.  Las soluciones industriales son demasiado caras, pero baratas, vienen como juguetes y, por lo tanto, son malas.  Estos son de bastante alta calidad, pero no sabr√°n cu√°nto tiempo durar√°n. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/n-/4c/96/n-4c96az3dh--wj0w8ir1cqz1qw.jpeg"></div><br>  El resto de la peque√±a cosa no caus√≥ problemas.  El controlador seleccion√≥ STM32.  Como ADC para joysticks, ADS1118 de 16 bits.  Tambi√©n se compr√≥ una fuente de alimentaci√≥n de 12 V. En realidad, este voltaje se debe al hecho de que obtuve un indicador de combustible del "shah", que tambi√©n quer√≠a conectar aqu√≠. <br><br><img src="https://habrastorage.org/webt/jz/0k/zq/jz0kzqxm-89ytb2bmexgkdqkm5i.jpeg"><br>  <i>En la foto, la fuente de alimentaci√≥n, estabilizadores para 5 y 3.3 V, STM32, MCP23017, ADS1118</i> <br><br>  Controlador STM32F407VET6 de 100 pines, conectado a √©l: <br><br>  2 selectores a 4 posiciones <br>  1 resistencia variable <br>  2 interruptores de eje <br>  4 ejes principales <br>  2 ejes auxiliares <br>  2 ejes de control <br>  4 interruptores de llave, 2 botones cada uno <br>  20 botones con LEDs <br>  4 interruptores principales con LED <br>  2 botones de hongos con LED <br>  2 botones de temporizador <br>  3 interruptores con LED <br>  13 interruptores <br>  2 ADS1118 (ADC) <br>  4 MAX7219 (pantallas LED de 8 d√≠gitos) <br>  2 TM1637 (horas de visualizaci√≥n) <br>  1 PCF8574 (expansor de E / S, conectado a la pantalla de s√≠ntesis de caracteres) <br><br><img src="https://habrastorage.org/webt/vl/6d/76/vl6d76rcv0daasbujiyeidj4fvc.png"><br>  <i>La estructura resultante</i> <br><br>  Decid√≠ que ser√≠a demasiado para cientos de patas del MK, y agregu√© aqu√≠ expansores de E / S: cuatro piezas de MCP23017, para 16 entradas o salidas cada una.  Mirando hacia el futuro, dir√© que el retraso en el sondeo de las entradas del expansor result√≥ ser de aproximadamente 0.13 ms por chip, a una velocidad de bus I2C de 400 kHz.  Es decir, con un margen cubre el tiempo m√≠nimo de sondeo USB de 1 ms. <br><br>  Para no conducir el bus I2C con solicitudes in√∫tiles, el MCP23017 tiene salidas de interrupci√≥n que se configuran cuando cambia el estado de las entradas.  Tambi√©n los apliqu√© en mi proyecto.  Al final result√≥ que, debido al ruido de los contactos, estas interrupciones fueron in√∫tiles. <br><br>  El ADS1118 ADC no se mantiene al d√≠a con la velocidad del USB, su rendimiento declarado es de 820 muestras por segundo, que es de 1.2 ms, mientras que tiene varias entradas que ya est√°n conectadas al ADC a trav√©s del multiplexor.  Us√© 2 entradas en un chip, por lo que el tiempo de actualizaci√≥n de los valores es de 2.4 ms.  Malo, pero ¬øqu√© puedes hacer?  Desafortunadamente, no hay otros ADC r√°pidos de 16 bits en Ali. <br><br><img src="https://habrastorage.org/webt/sb/xt/jy/sbxtjyzbgnuutfbdhbh6iub1qpe.jpeg"><br>  <i>Por dentro se ve as√≠, pero despu√©s de instalar los cables es mucho peor</i> <br><br>  El programa de la CPU est√° escrito al estilo de un programa de PLC.  No hay solicitudes de bloqueo.  El n√∫cleo no espera a la periferia, no ha tenido tiempo y al diablo con ella, en el pr√≥ximo ciclo interrogar√°.  Tampoco hay RTOS en el proyecto, lo prob√©, me encontr√© con un tiempo de espera de tarea m√≠nimo de 1 ms: resulta lento si necesitamos enviar datos a trav√©s de USB con una frecuencia de 1 ms.  Como resultado, me di cuenta de que usar√≠a el sistema operativo sin osDelay (), y luego ¬øpor qu√© RTOS?  Al igual que en un PLC, basta con colocar las instrucciones del programa una por una dentro de un bucle infinito. <br><br>  Usado, por supuesto, las bibliotecas CubeMX y HAL.  Por cierto, recientemente cambi√© a HAL y me pregunt√© sobre la conveniencia.  No s√© por qu√© todav√≠a no es muy popular, lo principal es descubrirlo al principio, y luego ser√° muy simple.  Se siente como si estuvieras programando arduino. <br><br>  El dispositivo tendremos USB HID personalizado.  HID es mouse, teclado, gamepad, joystick, algunos m√°s.  Y hay costumbre.  Todo esto no requiere controladores del sistema operativo.  M√°s precisamente, ya est√°n escritos por el desarrollador.  Un dispositivo personalizado es bueno porque combinamos las capacidades de todos los dispositivos anteriores a nuestra discreci√≥n. <br><br>  En general, lo de USB es muy complicado, tiene un manual de casi mil p√°ginas y no se puede sacar de un instante.  Quien no quiera leer manuales pesados, hay un gran art√≠culo sobre USB en un NutShell, google.  Ella tambi√©n tiene una traducci√≥n.  Tratar√© de explicar algunos puntos "en los dedos". <br><br>  USB: transferencia de datos en paquetes con un mont√≥n de niveles y abstracciones.  El dispositivo est√° con nosotros; no puede solicitar ning√∫n dato, el host inicia la transferencia completa.  El host escribe y solicita datos a los llamados puntos finales, f√≠sicamente estos son algunos buffers en la memoria MK.  Para que el host entienda por qu√© puntos finales es posible escribir, qu√© puntos finales leer y qu√© datos puede interpretar como botones y ejes de nuestro dispositivo y, en general, qu√© tipo de dispositivo tenemos aqu√≠, al comienzo de la conexi√≥n solicita descriptores de dispositivo.  Hay muchos de estos descriptores y es dif√≠cil componerlos y puedes hacerlo como quieras y tambi√©n cometer errores en cualquier lugar.  F√≠sicamente, son una matriz de bytes. <br><br>  De hecho, CubeMX generar√° un c√≥digo de inicializaci√≥n HID personalizado mejor que nosotros. <br><br><img src="https://habrastorage.org/webt/dv/vh/vm/dvvhvm9hohydqeva77lahqhwer4.png"><br><br><img src="https://habrastorage.org/webt/b8/85/an/b885and1wp7m4r6yw9e21w-4hhs.png"><br><br>  Preste atenci√≥n a la √∫ltima imagen debajo del n√∫mero 3. Este es el tama√±o del descriptor en bytes, que determina qu√© ejes y botones hay en nuestro dispositivo.  Este descriptor se genera en la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">herramienta de descriptor HID</a> .  Hay varios ejemplos para el autoestudio.  En general, aqu√≠ est√° mi descriptor.  Todav√≠a no hay datos para las pantallas, para facilitar la comprensi√≥n, pero todos los botones y ejes de los joysticks est√°n presentes.  Debe colocarse en el archivo usbd_custom_hid_if.c.  Por defecto, este controlador hace que el cubo est√© vac√≠o. <br><br><div class="spoiler">  <b class="spoiler_title">Descriptor HID (tama√±o 104 bytes)</b> <div class="spoiler_text"><pre><code class="cpp hljs">__ALIGN_BEGIN <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> CUSTOM_HID_ReportDesc_FS[USBD_CUSTOM_HID_REPORT_DESC_SIZE] __ALIGN_END = { <span class="hljs-comment"><span class="hljs-comment">/* USER CODE BEGIN 0 */</span></span> <span class="hljs-number"><span class="hljs-number">0x05</span></span>, <span class="hljs-number"><span class="hljs-number">0x01</span></span>, <span class="hljs-comment"><span class="hljs-comment">// USAGE_PAGE (Generic Desktop) 0x15, 0x00, // LOGICAL_MINIMUM (0) 0x09, 0x04, // USAGE (Joystick) 0xa1, 0x01, // COLLECTION (Application) 0x05, 0x02, // USAGE_PAGE (Simulation Controls) 0x09, 0xbb, // USAGE (Throttle) 0x15, 0x00, // LOGICAL_MINIMUM (0) 0x27, 0xff, 0xff, 0x00, 0x00, // LOGICAL_MAXIMUM (65535) 0x75, 0x10, // REPORT_SIZE (16) 0x95, 0x01, // REPORT_COUNT (1) 0x81, 0x02, // INPUT (Data,Var,Abs) 0x05, 0x01, // USAGE_PAGE (Generic Desktop) 0x09, 0x01, // USAGE (Pointer) 0xa1, 0x00, // COLLECTION (Physical) 0x09, 0x30, // USAGE (X) 0x09, 0x31, // USAGE (Y) 0x95, 0x02, // REPORT_COUNT (2) 0x81, 0x02, // INPUT (Data,Var,Abs) 0xc0, // END_COLLECTION 0x05, 0x01, // USAGE_PAGE (Generic Desktop) 0x09, 0x32, // USAGE (Z) 0x95, 0x01, // REPORT_COUNT (1) 0x81, 0x02, // INPUT (Data,Var,Abs) 0x09, 0x33, // USAGE (Rx) 0x81, 0x02, // INPUT (Data,Var,Abs) 0x09, 0x34, // USAGE (Ry) 0x81, 0x02, // INPUT (Data,Var,Abs) 0x09, 0x35, // USAGE (Rz) 0x81, 0x02, // INPUT (Data,Var,Abs) 0x09, 0x36, // USAGE (Slider) 0x81, 0x02, // INPUT (Data,Var,Abs) 0x09, 0x39, // USAGE (Hat switch) 0x15, 0x01, // LOGICAL_MINIMUM (1) 0x25, 0x08, // LOGICAL_MAXIMUM (8) 0x35, 0x00, // PHYSICAL_MINIMUM (0) 0x46, 0x0e, 0x01, // PHYSICAL_MAXIMUM (270) 0x65, 0x14, // UNIT (Eng Rot:Angular Pos) 0x75, 0x08, // REPORT_SIZE (8) 0x95, 0x01, // REPORT_COUNT (1) 0x81, 0x02, // INPUT (Data,Var,Abs) 0x05, 0x09, // USAGE_PAGE (Button) 0x19, 0x01, // USAGE_MINIMUM (Button 1) 0x29, 0x40, // USAGE_MAXIMUM (Button 64) 0x15, 0x00, // LOGICAL_MINIMUM (0) 0x25, 0x01, // LOGICAL_MAXIMUM (1) 0x75, 0x01, // REPORT_SIZE (1) 0x95, 0x40, // REPORT_COUNT (64) 0x55, 0x00, // UNIT_EXPONENT (0) 0x65, 0x00, // UNIT (None) 0x81, 0x02, // INPUT (Data,Var,Abs) /* USER CODE END 0 */ 0xC0 /* END_COLLECTION */ };</span></span></code> </pre> <br></div></div><br>  De hecho, se puede componer a su gusto, primero configure los par√°metros de la P√ÅGINA DE USO y el USO requerido, por ejemplo, el eje de USO (Acelerador), y luego despu√©s de la palabra ENTRADA (Datos, Var, Abs), el sistema asumir√° que tenemos el eje "Gas".  La dimensi√≥n del eje variable y su n√∫mero se establecen mediante los par√°metros LOGICAL_MAXIMUM, MINIMUM, REPORT_SIZE, REPORT_COUNT, que deben estar antes de INPUT. <br><br>  M√°s detalles sobre estos par√°metros, as√≠ como sobre qu√© (Datos, Var, Abs) se pueden encontrar en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Definici√≥n de clase de dispositivo para dispositivos de interfaz humana (HID) v1.11</a> . <br><br>  El siguiente es un ejemplo de inicializaci√≥n del eje del acelerador desde mi descriptor.  En este ejemplo, Throttle tiene un rango de 0-65535, que corresponde a una variable uint16_t. <br><br><pre> <code class="cpp hljs"> <span class="hljs-number"><span class="hljs-number">0x05</span></span>, <span class="hljs-number"><span class="hljs-number">0x02</span></span>, <span class="hljs-comment"><span class="hljs-comment">// USAGE_PAGE (Simulation Controls) 0x09, 0xbb, // USAGE (Throttle) 0x15, 0x00, // LOGICAL_MINIMUM (0) 0x27, 0xff, 0xff, 0x00, 0x00, // LOGICAL_MAXIMUM (65535) 0x75, 0x10, // REPORT_SIZE (16) 0x95, 0x01, // REPORT_COUNT (1) 0x81, 0x02, // INPUT (Data,Var,Abs)</span></span></code> </pre> <br>  Y s√≠, todav√≠a, digamos que no puede escribir LOGICAL_MAXIMUM, MINIMUM, REPORT_SIZE, REPORT_COUNT cada vez, el host determinar√° este valor por el par√°metro anterior.  Esto se ilustra mediante los ejes que van uno tras otro, sin especificar el tama√±o y el n√∫mero: <br><br><pre> <code class="cpp hljs"> <span class="hljs-number"><span class="hljs-number">0x09</span></span>, <span class="hljs-number"><span class="hljs-number">0x32</span></span>, <span class="hljs-comment"><span class="hljs-comment">// USAGE (Z) 0x95, 0x01, // REPORT_COUNT (1) 0x81, 0x02, // INPUT (Data,Var,Abs) 0x09, 0x33, // USAGE (Rx) 0x81, 0x02, // INPUT (Data,Var,Abs) 0x09, 0x34, // USAGE (Ry) 0x81, 0x02, // INPUT (Data,Var,Abs) 0x09, 0x35, // USAGE (Rz) 0x81, 0x02, // INPUT (Data,Var,Abs) 0x09, 0x36, // USAGE (Slider)</span></span></code> </pre> <br>  La siguiente estructura corresponde a todo este descriptor, que es m√°s alto bajo el spoiler.  De hecho, ya no es obligatorio, es m√°s conveniente grabar seg√∫n los punteros. <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> pack(push, 1) typedef struct _myReportStruct { uint16_t Throttle; uint16_t X; uint16_t Y; uint16_t Z; uint16_t Rx; uint16_t Ry; uint16_t Rz; uint16_t Slider; uint8_t Hat; </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// 0 - none, 1 - up, 2 - up-right, 3 - right, 4 - down-right... uint32_t Buttons1; // 32 buttons of 1 bit each uint32_t Buttons2; // 32 buttons of 1 bit each }myReportStruct; #pragma pack(pop) volatile myReportStruct Desk;</span></span></span></span></code> </pre> <br>  Esta estructura puede ser enviada al host por la funci√≥n <br><br><pre> <code class="cpp hljs">USBD_CUSTOM_HID_SendReport(&amp;hUsbDeviceFS, (<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *) &amp;Desk, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(Desk));</code> </pre> <br>  El primer par√°metro es un controlador USB; ya est√° creado en nuestro cubo.  Es posible que deba incluir el archivo necesario con la inclusi√≥n donde este identificador se inicializa por primera vez y escribir <i>USBD_HandleTypeDef hUsbDeviceFS externo;</i>  para que puedas trabajar con √©l.  El segundo par√°metro es un puntero a nuestra estructura y el tercero es el tama√±o de la estructura en bytes. <br><br>  Despu√©s de llenar y flashear el controlador, notar√° que algo USB se mueve lentamente.  Los datos de nuestro panel no se actualizan r√°pidamente.  Para ser r√°pido, en los archivos usbd_customhid.h necesita cambiar #define CUSTOM_HID_EPIN_SIZE al valor m√°ximo 0x40, #define CUSTOM_HID_EPOUT_SIZE tambi√©n establece 0x40.  En el archivo usbd_customhid.c, busque comentarios en el descriptor de punto final "/ * bInterval: Polling Interval (20 ms) * /" y cambie el byte del descriptor a 0x01 para cada punto final, solo dos veces.  Lo que corresponder√° a 1 ms de intercambio de datos. <br><br><img src="https://habrastorage.org/webt/yf/zm/cx/yfzmcxseu1la7jgqxyql9qzm4ji.png"><br>  <i>Deber√≠a ser algo como esto.</i>  <i>Dispositivo est√°ndar sin instalar ning√∫n controlador</i> <br><br>  En general, la funci√≥n de gesti√≥n se entiende poco.  Es bastante f√°cil de hacer y todos los botones y ejes ya est√°n funcionando.  Queda por hacer que las pantallas funcionen.  Lo hice, unos seis meses, y durante medio a√±o el panel ha estado acumulando polvo en una caja larga.  No hay tiempo  Por lo tanto, decid√≠ dise√±ar el art√≠culo de esta forma, de lo contrario, corre el riesgo de no salir. <br><br>  Con las pantallas, todo es igual que con los ejes.  Para ellos, necesitamos complementar nuestro descriptor HID del dispositivo, solo indicar que se trata de pantallas y, en lugar de aceptar datos de entrada, el host enviar√° datos de salida. <br><br>  El manejo del dispositivo HID ha crecido significativamente.  Aqu√≠ ya he aplicado los par√°metros de ID de informe para no obstruir el b√∫fer de transmisi√≥n / recepci√≥n y los puntos finales con datos completos y para distinguir qu√© tipo de telegrama hemos recibido.  La ID del informe es un byte uint8_t con el valor que viene al comienzo del telegrama.  El valor que establecemos en el descriptor de dispositivo HID. <br><br><div class="spoiler">  <b class="spoiler_title">CUSTOM_HID_ReportDesc_FS</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//AXIS 0x05, 0x01, // USAGE_PAGE (Generic Desktop) 0x09, 0x04, // USAGE (Joystick) 0xa1, 0x01, // COLLECTION (Application)28 0x05, 0x02, // USAGE_PAGE (Simulation Controls) 0x09, 0xbb, // USAGE (Throttle) 0x15, 0x00, // LOGICAL_MINIMUM (0) 0x27, 0xff, 0xff, 0x00, 0x00, // LOGICAL_MAXIMUM (65535) 0x75, 0x10, // REPORT_SIZE (16) 0x95, 0x01, // REPORT_COUNT (1) 0x85, 0x01, // REPORT_ID (1) 0x81, 0x02, // INPUT (Data,Var,Abs) 0x05, 0x01, // USAGE_PAGE (Generic Desktop) 0x09, 0x01, // USAGE (Pointer) 0xa1, 0x00, // COLLECTION (Physical) 0x09, 0x30, // USAGE (X) 0x09, 0x31, // USAGE (Y) 0x95, 0x02, // REPORT_COUNT (2) 0x81, 0x02, // INPUT (Data,Var,Abs) 0xc0, // END_COLLECTION 0x05, 0x01, // USAGE_PAGE (Generic Desktop) 0x09, 0x32, // USAGE (Z) 0x95, 0x01, // REPORT_COUNT (1) 0x81, 0x02, // INPUT (Data,Var,Abs) 0x09, 0x33, // USAGE (Rx) 0x81, 0x02, // INPUT (Data,Var,Abs) 0x09, 0x34, // USAGE (Ry) 0x81, 0x02, // INPUT (Data,Var,Abs) 0x09, 0x35, // USAGE (Rz) 0x81, 0x02, // INPUT (Data,Var,Abs) 0x09, 0x36, // USAGE (Slider) 0x81, 0x02, // INPUT (Data,Var,Abs) //HAT 0x09, 0x39, // USAGE (Hat switch) 0x15, 0x01, // LOGICAL_MINIMUM (1) 0x25, 0x08, // LOGICAL_MAXIMUM (8) 0x35, 0x00, // PHYSICAL_MINIMUM (0) 0x46, 0x0e, 0x01, // PHYSICAL_MAXIMUM (270) 0x65, 0x14, // UNIT (Eng Rot:Angular Pos) 0x75, 0x08, // REPORT_SIZE (8) 0x95, 0x01, // REPORT_COUNT (1) 0x81, 0x02, // INPUT (Data,Var,Abs) //Buttons 0x05, 0x09, // USAGE_PAGE (Button) 0x19, 0x01, // USAGE_MINIMUM (Button 1) 0x29, 0x40, // USAGE_MAXIMUM (Button 64) 0x15, 0x00, // LOGICAL_MINIMUM (0) 0x25, 0x01, // LOGICAL_MAXIMUM (1) 0x75, 0x01, // REPORT_SIZE (1) 0x95, 0x40, // REPORT_COUNT (64) 0x55, 0x00, // UNIT_EXPONENT (0) 0x65, 0x00, // UNIT (None) 0x81, 0x02, // INPUT (Data,Var,Abs) //LEDs 0x85, 0x02, // REPORT_ID (2) 0x05, 0x08, // USAGE_PAGE (LEDs) 0x09, 0x4B, // USAGE (Generic Indicator) 0x95, 0x40, // REPORT_COUNT (16) 0x91, 0x02, // OUTPUT (Data,Var,Abs) 0xc0, // END_COLLECTION //LCD Displays 0x05, 0x14, // USAGE_PAGE (Alphnumeric Display) 0x09, 0x01, // USAGE (Alphanumeric Display) 0x15, 0x00, // LOGICAL_MINIMUM (0) 0xa1, 0x02, // COLLECTION (Logical) 0x09, 0x32, // USAGE (Cursor Position Report) 0xa1, 0x02, // COLLECTION (Logical) 0x85, 0x04, // REPORT_ID (4) 0x75, 0x08, // REPORT_SIZE (8) 0x95, 0x01, // REPORT_COUNT (1) 0x25, 0x13, // LOGICAL_MAXIMUM (19) 0x09, 0x34, // USAGE (Column) 0xb1, 0x22, // FEATURE (Data,Var,Abs,NPrf) 0x25, 0x03, // LOGICAL_MAXIMUM (3) 0x09, 0x33, // USAGE (Row) 0x91, 0x22, // OUTPUT (Data,Var,Abs,NPrf) 0xc0, // END_COLLECTION 0x09, 0x2b, // USAGE (Character Report) 0xa1, 0x02, // COLLECTION (Logical) 0x85, 0x05, // REPORT_ID (5) 0x95, 0x14, // REPORT_COUNT (20) 0x26, 0xFF, 0x00, // LOGICAL_MAXIMUM (255) 0x09, 0x2c, // USAGE (Display Data) 0x92, 0x02, 0x01, // OUTPUT (Data,Var,Abs,Buf) 0xc0, // END_COLLECTION 0x09, 0x24, // USAGE (Display Control Report) 0x85, 0x06, // REPORT_ID (6) 0x95, 0x01, // REPORT_COUNT (1) 0x91, 0x22, // OUTPUT (Data,Var,Abs,NPrf) 0xc0, // END_COLLECTION //LED Displays 0x05, 0x14, // USAGE_PAGE (Alphnumeric Display) 0x09, 0x01, // USAGE (Alphanumeric Display) 0x15, 0x00, // LOGICAL_MINIMUM (0) 0xa1, 0x02, // COLLECTION (Logical) 0x09, 0x2b, // USAGE (Character Report) 0xa1, 0x02, // COLLECTION (Logical) 0x85, 0x07, // REPORT_ID (7) 0x75, 0x08, // REPORT_SIZE (8) 0x95, 0x28, // REPORT_COUNT (40) 0x26, 0xFF, 0x00, // LOGICAL_MAXIMUM (255) 0x09, 0x2c, // USAGE (Display Data) 0x92, 0x02, 0x01, // OUTPUT (Data,Var,Abs,Buf) 0xc0, // END_COLLECTION //Other DATA 0x06, 0x00, 0xff, // USAGE_PAGE (Generic Desktop) 0x09, 0x01, // USAGE (Vendor Usage 1) 0xa1, 0x01, // COLLECTION (Application) 0x85, 0x08, // REPORT_ID (8) 0x09, 0x01, // USAGE (Vendor Usage 1) 0x15, 0x00, // LOGICAL_MINIMUM (0) 0x27, 0xff, 0xff, 0x00, 0x00, // LOGICAL_MAXIMUM (65535) 0x75, 0x10, // REPORT_SIZE (16) 0x95, 0x0A, // REPORT_COUNT (10) 0x91, 0x82, // OUTPUT (Data,Var,Abs,Vol)</span></span></code> </pre> </div></div><br>  La salida se <i>procesa</i> en la funci√≥n <i>est√°tica int8_t CUSTOM_HID_OutEvent_FS (uint8_t event_idx, uint8_t state)</i> , que, de forma predeterminada, se encuentra en usbd_custom_hid_if.c. <br><br><div class="spoiler">  <b class="spoiler_title">static int8_t CUSTOM_HID_OutEvent_FS ()</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> int8_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CUSTOM_HID_OutEvent_FS</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> event_idx, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> state)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/* USER CODE BEGIN 6 */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> dataReceiveArray[USBD_CUSTOMHID_OUTREPORT_BUF_SIZE]; USBD_CUSTOM_HID_HandleTypeDef *hhid = (USBD_CUSTOM_HID_HandleTypeDef*)hUsbDeviceFS.pClassData; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; USBD_CUSTOMHID_OUTREPORT_BUF_SIZE; i++) { dataReceiveArray[i] = hhid-&gt;Report_buf[i]; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dataReceiveArray[<span class="hljs-number"><span class="hljs-number">0</span></span>] == <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-comment"><span class="hljs-comment">//report ID 2 leds { //  Report id == 2,   -     dataReceiveArray[1 + N], ,  LED } if (dataReceiveArray[0] == 4) //report ID 4 cursor position { //  Report id == 4,   -,     LCD } if (dataReceiveArray[0] == 5) //report ID 5 display data { //  Report id == 5,   -,     USB  LCD } //   ,   ID     return (USBD_OK); /* USER CODE END 6 */ }</span></span></code> </pre> <br></div></div><br>  Solo queda escribir un programa en una PC que env√≠e los informes necesarios para dirigir las pantallas.  Sin embargo, para verificar el c√≥digo MK, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">es</a> adecuado un excelente programa de ST: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">USB HID Demonstrator</a> .  Le permite enviar informes desde una PC con cualquier contenido. <br><br><img src="https://habrastorage.org/webt/ft/bd/e3/ftbde3fwn14llpdhjmakp7pwx4a.jpeg"><br>  <i>Prueba de pantalla LED</i> <br><br>  En esta etapa, he terminado hasta ahora.  Y no se sabe si volver√© a comenzar. <br><br>  Se juega en simuladores m√°s interesantes que con un teclado.  Pero no tanto como para que haya un efecto wow directo.  El teclado, tambi√©n se ve como un panel de control.  Pero controlar los ejes del joystick es, como m√≠nimo, inusual.  Si√©ntete como un astronauta.  Es cierto que se necesita un traje espacial para una inmersi√≥n completa. <br><br>  Espero que te haya interesado.  Errores tipogr√°ficos, imprecisiones y delirios est√°n presentes.  Aquellos que quieran profundizar en el c√≥digo pueden ver <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> . <br><br>  Saludos </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es434854/">https://habr.com/ru/post/es434854/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es434838/index.html">Crear un bot para participar en el CodeBall ruso de la Copa AI 2018</a></li>
<li><a href="../es434840/index.html">¬øC√≥mo hice "Your Diary" - o la situaci√≥n en el mercado de diarios electr√≥nicos</a></li>
<li><a href="../es434842/index.html">Las granjas de la ciudad pueden ser extremadamente efectivas, pero no ahora</a></li>
<li><a href="../es434844/index.html">Recuperaci√≥n de las capacidades cognitivas de 100 pacientes (traducci√≥n del art√≠culo de Dale Bredesen)</a></li>
<li><a href="../es434848/index.html">El Consejo de Administraci√≥n de Tesla incluye dos directores independientes: Larry Ellison y Caitlin Wilson-Thompson.</a></li>
<li><a href="../es434856/index.html">Edici√≥n de video en MPC usando sombreadores</a></li>
<li><a href="../es434858/index.html">Jetpack Racing 2019</a></li>
<li><a href="../es434862/index.html">La forma inteligente de los escolares chinos ayuda a reducir el absentismo</a></li>
<li><a href="../es434864/index.html">Ingeniero Senior en busca de trabajo. C√≥mo pas√© por 15 entrevistas t√©cnicas y qu√© pienso al respecto</a></li>
<li><a href="../es434868/index.html">La cadena de bloques est√° muerta. Larga vida a blockchain</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>