<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤴🏻 🧑🏻 🏤 交互器，操作模式 🔞 🕗 ☁️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="本文是对Laravel框架Hanami框架手册的一部分的改编。 是什么引起了对这种特殊材料的兴趣？ 它提供了分步说明，并演示了编程语言和框架的常见用法，例如： 


- 使用交互器模式。 
- 演示TDD \ BDD。 


 应当立即指出，这些不仅是具有不同意识形态的不同框架（特别是关于ORM），...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>交互器，操作模式</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/438052/"><p> 本文是对Laravel框架Hanami框架手册的一部分的改编。 是什么引起了对这种特殊材料的兴趣？ 它提供了分步说明，并演示了编程语言和框架的常见用法，例如： </p><br><ul><li> 使用交互器模式。 </li><li> 演示TDD \ BDD。 </li></ul><br><p> 应当立即指出，这些不仅是具有不同意识形态的不同框架（特别是关于ORM），而且是不同的编程语言，每种语言都有其特定的文化并出于历史原因建立了“最佳实践”。 不同的编程语言和框架往往会相互借鉴最成功的解决方案，因此，尽管细节有所不同，但基本内容不会有所不同，除非我们当然将PL最初采用不同的范例。 比较有趣的是，比较如何在不同的生态系统中解决同一问题。 </p><br><p> 因此，最初我们有Hanami（ruby）框架-这是一个相当新的框架，在思想上更倾向于Symfony，并且ORM位于“存储库”中。 而目标Laravel \ Lumen（php）框架具有Active Record。 </p><a name="habracut"></a><br><p> 在适应过程中，最锐角被切掉： </p><br><ul><li> 该项目的初始化，对框架功能的描述以及类似的特定内容都省略了指南的第一部分。 </li><li>  ORM Eloquent被推向全球，并充当存储库。 </li><li> 生成代码和发送电子邮件模板的步骤。 </li></ul><br><p> 保存并强调： </p><br><ul><li> 交互器-在接口上进行了最低限度的适当实现。 </li><li> 通过TDD进行测试，逐步开发。 </li></ul><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Hanami原始教程的第一部分，将在下面的文本中引用。</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">原始交互式教程文本</a> <br> 在文本末尾使用修改后的php代码链接到存储库。 </p><br><h3 id="interaktory"> 互动者 </h3><br><h4 id="novaya-ficha-uvedomleniya-po-elektronnoy-pochte"> 新功能：电子邮件通知 </h4><br><p> 功能场景：作为管理员，当我添加一本书时，我想接收电子邮件通知。 </p><br><p> 由于该应用程序没有身份验证，因此任何人都可以添加新书。 我们将通过环境变量指定管理员的电子邮件地址。 </p><br><p> 这只是显示何时使用交互器，尤其是如何使用Hanami交互器的示例。 </p><br><p>  <em>此示例可以用作其他功能的基础，例如管理员在发行新书之前对其进行确认。</em>  <em>或者使用户能够通过特殊链接指定电子邮件地址来编辑图书。</em> </p><br><p> 实际上，您可以使用交互器来实现从网络层抽象的任何业务逻辑。 当您想要组合几件事以控制代码库的复杂性时，这特别有用。 </p><br><p> 它们用于遵循单一职责原则隔离非平凡的业务逻辑。 </p><br><p> 在Web应用程序中，通常是通过控制器操作来使用它们。 这样，您就可以分离任务，业务逻辑对象和交互器；它们对应用程序的网络层一无所知。 </p><br><h4 id="kolbeki-oni-nam-ne-nuzhny"> 回调？ 我们不需要它们！ </h4><br><p> 实现电子邮件通知的最简单方法是添加回调。 </p><br><p> 也就是说，在数据库中创建新书条目之后，将发送电子邮件。 </p><br><p> 在结构上，Hanami不提供这种机制。 这是因为我们认为模型回调是一种反模式。 他们违反了唯一责任原则。 在我们的案例中，他们错误地将持久层与电子邮件通知混合在一起。 </p><br><p> 在测试期间（很可能在其他情况下），您将要跳过回调。 这很快就会造成混乱，因为可以按特定顺序触发单个事件的多个回调。 另外，您可以跳过一些回调。 回调使代码易碎且难以理解。 </p><br><p> 相反，我们建议使用显式而不是隐式。 </p><br><p> 交互器是代表特定用例的对象。 </p><br><p> 他们允许每个班级都有一个责任。 交互者的唯一责任是将对象和方法调用结合起来以达到特定的结果。 </p><br><h4 id="ideya"> 主意 </h4><br><p> 交互器的主要思想是将功能的隔离部分提取到新类中。 </p><br><p>您应该只编写两个公共方法： <code>__construct</code>和<code>call</code> 。 <br>  <em>在交互器的php实现中，call方法具有protected修饰符，并通过<code>__invoke</code>进行<code>__invoke</code> 。</em> </p><br><p> 这意味着此类对象易于解释，因为只有一种可用的方法可以使用它们。 </p><br><p> 将行为封装在一个对象中使测试变得更加容易。 它还使您更容易理解代码库，而不仅仅是隐式地保留隐藏的复杂性。 </p><br><h4 id="podgotovka"> 准备工作 </h4><br><p> 假设我们有<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">“入门</a> ”书架应用程序，并且我们想添加“已添加书的电子邮件通知”功能。 </p><br><h4 id="pishem-interaktor"> 编写一个交互器 </h4><br><p> 让我们为交互器创建一个文件夹，为他们的测试创建一个文件夹： </p><br><pre> <code class="plaintext hljs">$ mkdir lib/bookshelf/interactors $ mkdir tests/bookshelf/interactors</code> </pre> <br><p> 我们将它们放在<code>lib/bookshelf</code>因为它们与Web应用程序无关。 您可以稍后通过管理门户，API甚至命令行实用程序添加书籍。 </p><br><p> 添加<code>AddBook</code>交互器并编写一个新的测试<code>tests/bookshelf/interactors/AddBookTest.php</code> ： </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment"># tests/bookshelf/interactors/AddBookTest.php &lt;?php use Lib\Bookshelf\Interactors\AddBook; class AddBookTest extends TestCase { private function interactor() { return $this-&gt;app-&gt;make(AddBook::class); } private function bookAttributes() { return [ "author" =&gt; "James Baldwin", 'title' =&gt; "The Fire Next Time", ]; } private function subjectCall() { return $this-&gt;interactor()($this-&gt;bookAttributes()); } public function testSucceeds() { $result = $this-&gt;subjectCall(); $this-&gt;assertTrue($result-&gt;successful()); } }</span></span></code> </pre><br><p> 由于没有<code>AddBook</code>类，因此运行测试套件将引发<code>Class does not exist</code> is <code>Class does not exist</code>错误。 让我们在文件<code>lib/bookshelf/interactors/AddBook.php</code> ： </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Lib</span></span>\<span class="hljs-title"><span class="hljs-title">Bookshelf</span></span>\<span class="hljs-title"><span class="hljs-title">Interactors</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Lib</span></span>\<span class="hljs-title"><span class="hljs-title">Interactor</span></span>\<span class="hljs-title"><span class="hljs-title">Interactor</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AddBook</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Interactor</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ } }</code> </pre> <br><p> 此类仅应包含两个方法：用于设置数据的<code>__construct</code>和用于实现脚本的<code>call</code> 。 </p><br><p> 这些方法（尤其是<code>call</code> ）应调用您编写的私有方法。 </p><br><p> 默认情况下，结果被认为是成功的，因为我们没有明确指出操作失败。 </p><br><p> 让我们运行测试： </p><br><pre> <code class="plaintext hljs">$ phpunit</code> </pre> <br><p> 所有测试必须通过！ </p><br><p> 现在，让我们的<code>AddBook</code>交互器真正发挥作用！ </p><br><h3 id="sozdanie-knigi"> 书籍创作 </h3><br><p> 更改<code>tests/bookshelf/interactors/AddBookTest.php</code> ： </p><br><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testCreateBook</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $result = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;subjectCall(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;assertEquals(<span class="hljs-string"><span class="hljs-string">"The Fire Next Time"</span></span>, $result-&gt;book-&gt;title); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;assertEquals(<span class="hljs-string"><span class="hljs-string">"James Baldwin"</span></span>, $result-&gt;book-&gt;author); }</code> </pre> <br><p> 如果运行<code>phpunit</code>测试，将会看到错误： </p><br><pre> <code class="plaintext hljs">Exception: Undefined property Lib\Interactor\InteractorResult::$book</code> </pre> <br><p> 让我们填写我们的交互器，然后解释我们做了什么： </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Lib</span></span>\<span class="hljs-title"><span class="hljs-title">Bookshelf</span></span>\<span class="hljs-title"><span class="hljs-title">Interactors</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Lib</span></span>\<span class="hljs-title"><span class="hljs-title">Interactor</span></span>\<span class="hljs-title"><span class="hljs-title">Interactor</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Lib</span></span>\<span class="hljs-title"><span class="hljs-title">Bookshelf</span></span>\<span class="hljs-title"><span class="hljs-title">Book</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AddBook</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Interactor</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> $expose = [<span class="hljs-string"><span class="hljs-string">"book"</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $book = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($bookAttributes)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;book = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Book($bookAttributes); } }</code> </pre> <br><p> 这里要注意的两个重要事项： </p><br><p>  <code>protected static $expose = ["book"];</code>字符串<code>protected static $expose = ["book"];</code> 将<code>book</code>属性添加到调用交互器时将返回的结果对象。 </p><br><p>  <code>call</code>方法将<code>Book</code>模型分配给<code>book</code>属性，结果将可用。 </p><br><p> 现在测试应该通过了。 </p><br><p> 我们初始化了<code>Book</code>模型，但是它没有存储在数据库中。 </p><br><h4 id="sohranenie-knigi"> 保存书 </h4><br><p> 我们有一本新书，是从书名和作者那里获得的，但尚未在数据库中。 </p><br><p> 我们需要使用<code>BookRepository</code>保存它。 </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// tests/bookshelf/interactors/AddBookTest.php public function testPersistsBook() { $result = $this-&gt;subjectCall(); $this-&gt;assertNotNull($result-&gt;book-&gt;id); }</span></span></code> </pre> <br><p> 如果运行测试，您将看到一个新错误，并显示消息<code>Failed asserting that null is not null</code> 。 </p><br><p> 这是因为我们创建的书没有标识符，因为它只有在保存时才会收到。 </p><br><p> 为了使测试通过，我们需要创建一个保存的书。 另一种同样正确的方法是保存我们已经拥有的书。 </p><br><p> 在<code>lib/bookshelf/interactors/AddBook.php</code>编辑<code>call</code>方法： </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($bookAttributes)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;book = Book::create($bookAttributes); }</code> </pre> <br><p> 我们不调用<code>new Book</code>而是使用<code>new Book</code>的属性来<code>Book::create</code> 。 </p><br><p> 该方法仍返回书籍，并将此记录保存在数据库中。 </p><br><p> 如果现在运行测试，您将看到所有测试均通过。 </p><br><h4 id="vnedrenie-zavisimostey-dependency-injection"> 依赖注入 </h4><br><p> 让我们重构为使用依赖注入。 </p><br><p> 测试仍然可以进行，但是它们取决于保存到数据库的功能（id属性是在成功保存之后确定的）。 这是保护工作原理的实施细节。 例如，如果要在保存前创建一个UUID并通过保存ID列以外的其他方式指示保存成功，则必须更改此测试。 </p><br><p> 我们可以修改测试和交互器以使其更可靠：由于其文件外部的更改，它不太容易损坏。 </p><br><p> 这是我们可以在交互器中使用依赖注入的方法： </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// lib/bookshelf/interactors/AddBook.php public function __construct(Book $repository) { $this-&gt;repository = $repository; } protected function call($bookAttributes) { $this-&gt;book = $this-&gt;repository-&gt;create($bookAttributes); }</span></span></code> </pre> <br><p> 从本质上讲，创建<code>repository</code>属性的过程是相同的，只是添加了一些代码。 </p><br><p> 现在，测试将检查<code>create</code>方法的行为，以确保其标识符填充有<code>$this-&gt;assertNotNull($result-&gt;book-&gt;id)</code> 。 </p><br><p> 这是一个实现细节。 </p><br><p> 相反，我们可以修改测试以确保在存储库上调用了<code>create</code>方法，并相信存储库将保存对象（因为这是它的责任）。 </p><br><p> 让我们更改<code>testPersistsBook</code>测试： </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// tests/bookshelf/interactors/AddBookTest.php public function testPersistsBook() { $repository = Mockery::mock(Book::class); $this-&gt;app-&gt;instance(Book::class, $repository); $attributes = [ "author" =&gt; "James Baldwin", 'title' =&gt; "The Fire Next Time", ]; $repository-&gt;expects()-&gt;create($attributes); $this-&gt;subjectCall($attributes); }</span></span></code> </pre> <br><p> 现在我们的测试没有违反其区域的边界。 </p><br><p> 我们所做的只是在存储库上添加了交互器依赖项。 </p><br><h4 id="uvedomlenie-na-elektronnuyu-pochtu"> 电邮通知 </h4><br><p> 让我们添加电子邮件通知！ </p><br><p>  <em>您还可以在此处执行任何操作，例如，发送短信，发送聊天消息或激活Web挂钩。</em> </p><br><p> 我们将邮件正文保留为空，但是在主题字段中，我们将指示“已添加图书！”。 </p><br><p> 创建一个通知测试<code>tests/bookshelf/mail/BookAddedNotificationTest.php</code> ： </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Lib</span></span>\<span class="hljs-title"><span class="hljs-title">Bookshelf</span></span>\<span class="hljs-title"><span class="hljs-title">Mail</span></span>\<span class="hljs-title"><span class="hljs-title">BookAddedNotification</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Illuminate</span></span>\<span class="hljs-title"><span class="hljs-title">Support</span></span>\<span class="hljs-title"><span class="hljs-title">Facades</span></span>\<span class="hljs-title"><span class="hljs-title">Mail</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BookAddedNotificationTest</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestCase</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setUp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>::setUp(); Mail::fake(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;mail = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BookAddedNotification(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testCorrectAttributes</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;mail-&gt;build(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;assertEquals(<span class="hljs-string"><span class="hljs-string">'no-reply@example.com'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;mail-&gt;from[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-string"><span class="hljs-string">'address'</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;assertEquals(<span class="hljs-string"><span class="hljs-string">'admin@example.com'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;mail-&gt;to[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-string"><span class="hljs-string">'address'</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;assertEquals(<span class="hljs-string"><span class="hljs-string">'Book added!'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;mail-&gt;subject); } }</code> </pre> <br><p> 添加通知类<code>lib/Bookshelf/Mail/BookAddedNotification.php</code> ： </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Lib</span></span>\<span class="hljs-title"><span class="hljs-title">Bookshelf</span></span>\<span class="hljs-title"><span class="hljs-title">Mail</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Illuminate</span></span>\<span class="hljs-title"><span class="hljs-title">Mail</span></span>\<span class="hljs-title"><span class="hljs-title">Mailable</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Illuminate</span></span>\<span class="hljs-title"><span class="hljs-title">Queue</span></span>\<span class="hljs-title"><span class="hljs-title">SerializesModels</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BookAddedNotification</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Mailable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">SerializesModels</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">build</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;from(<span class="hljs-string"><span class="hljs-string">'no-reply@example.com'</span></span>) -&gt;to(<span class="hljs-string"><span class="hljs-string">'admin@example.com'</span></span>) -&gt;subject(<span class="hljs-string"><span class="hljs-string">'Book added!'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;view(<span class="hljs-string"><span class="hljs-string">'emails.book_added_notification'</span></span>); } }</code> </pre> <br><p> 现在我们所有的测试都通过了！ </p><br><p> 但是通知尚未发送。 我们需要从<code>AddBook</code>交互器调用发送。 </p><br><p>  <code>AddBook</code>测试，以确保将调用该邮件： </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testSendMail</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Mail::fake(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;subjectCall(); Mail::assertSent(BookAddedNotification::class, <span class="hljs-number"><span class="hljs-number">1</span></span>); }</code> </pre> <br><p> 如果运行测试， <code>The expected [Lib\Bookshelf\Mail\BookAddedNotification] mailable was sent 0 times instead of 1 times.</code>出现错误： <code>The expected [Lib\Bookshelf\Mail\BookAddedNotification] mailable was sent 0 times instead of 1 times.</code>  。 </p><br><p> 现在，我们将通知发送集成到交互器中。 </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Book $repository, BookAddedNotification $mail)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;repository = $repository; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;mail = $mail; } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($bookAttributes)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;book = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;repository-&gt;create($bookAttributes); Mail::send(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;mail); }</code> </pre> <br><p> 结果，交互器将发送有关将书添加到电子邮件的通知。 </p><br><h4 id="integraciya-s-kontrollerom"> 控制器整合 </h4><br><p> 最后，我们需要从动作中调用交互器。 </p><br><p> 编辑动作文件<code>app/Http/Controllers/BooksCreateController.php</code> ： </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span>\<span class="hljs-title"><span class="hljs-title">Http</span></span>\<span class="hljs-title"><span class="hljs-title">Controllers</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Lib</span></span>\<span class="hljs-title"><span class="hljs-title">Bookshelf</span></span>\<span class="hljs-title"><span class="hljs-title">Interactors</span></span>\<span class="hljs-title"><span class="hljs-title">AddBook</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Illuminate</span></span>\<span class="hljs-title"><span class="hljs-title">Http</span></span>\<span class="hljs-title"><span class="hljs-title">Request</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Illuminate</span></span>\<span class="hljs-title"><span class="hljs-title">Http</span></span>\<span class="hljs-title"><span class="hljs-title">Response</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BooksCreateController</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Controller</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * Create a new controller instance. * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> void */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AddBook $addBook)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;addBook = $addBook; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Request $request)</span></span></span><span class="hljs-function"> </span></span>{ $input = $request-&gt;all(); (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;addBook)($input); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Response(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-number"><span class="hljs-number">201</span></span>)); } }</code> </pre> <br><p> 我们的测试通过了，但是有一个小问题。 </p><br><p> 我们对书籍创建代码进行了两次测试。 </p><br><p> 这通常是一个不好的做法，我们可以通过说明交互器的另一个优点来修复它。 </p><br><p> 我们将在测试中删除<code>BookRepository</code>上的提及， <code>BookRepository</code>模拟用于我们的<code>AddBook</code>交互器： </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Lib</span></span>\<span class="hljs-title"><span class="hljs-title">Bookshelf</span></span>\<span class="hljs-title"><span class="hljs-title">Interactors</span></span>\<span class="hljs-title"><span class="hljs-title">AddBook</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BooksCreateControllerTest</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestCase</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testCallsInteractor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $attributes = [<span class="hljs-string"><span class="hljs-string">'title'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'1984'</span></span>, <span class="hljs-string"><span class="hljs-string">'author'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'George Orwell'</span></span>]; $addBook = Mockery::mock(AddBook::class); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;app-&gt;instance(AddBook::class, $addBook); $addBook-&gt;expects()-&gt;__invoke($attributes); $response = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;call(<span class="hljs-string"><span class="hljs-string">'POST'</span></span>, <span class="hljs-string"><span class="hljs-string">'/books'</span></span>, $attributes); } }</code> </pre> <br><p> 现在我们的测试通过了，它们更加可靠！ </p><br><p> 该动作（从http请求的参数中）获取输入，并调用交互程序以完成其工作。 该操作的唯一责任是使用网络。 交互器与我们真正的业务逻辑一起工作。 </p><br><p> 这极大地简化了动作及其测试。 </p><br><p> 实际上，操作不受业务逻辑的约束。 </p><br><p> 当我们修改交互器时，我们不再需要更改操作或其测试。 </p><br><p>  <em>请注意，在实际的应用程序中，您可能想要做的不仅仅是上述逻辑，例如，确保结果成功。</em>  <em>如果发生故障，您将需要从交互器返回错误。</em> </p><br><p>  <strong><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">带有代码的存储库</a></strong> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN438052/">https://habr.com/ru/post/zh-CN438052/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN438020/index.html">卡特彼勒推出配备300 kWh巨型电池的26吨电动挖掘机</a></li>
<li><a href="../zh-CN438022/index.html">代码的大小取决于最小化器，收集器和语言。 意外的Webpack更新</a></li>
<li><a href="../zh-CN438028/index.html">您不需要区块链：8个流行的用户案例以及它们为什么不起作用</a></li>
<li><a href="../zh-CN438034/index.html">Android，Rx和Kotlin，或如何使乐高爪缩小。 第一部分</a></li>
<li><a href="../zh-CN438046/index.html">如何快速在Spark上对百万点进行地理编码？</a></li>
<li><a href="../zh-CN438058/index.html">“ Python中的数据分析”分为两部分</a></li>
<li><a href="../zh-CN438060/index.html">估计空间方向，或者如何不惧怕Mahoney和Majwik过滤器</a></li>
<li><a href="../zh-CN438062/index.html">我的地址不是房屋或街道，我的地址是苏联？</a></li>
<li><a href="../zh-CN438064/index.html">清单：在产品中启动微服务之前必须做什么</a></li>
<li><a href="../zh-CN438066/index.html">您从未听说过的10个英语教育YouTube频道</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>