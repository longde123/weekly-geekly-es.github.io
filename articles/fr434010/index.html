<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🐅 🙏🏾 👝 Vous développe ou configure les proxys Nginx pour Apache Tomcat sur Ubuntu en 5 minutes avec https et pare-feu ⚜️ 🤾 👋🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Je ne suis pas administrateur, mais il y a parfois des tâches plus faciles (et plus intéressantes) à résoudre que de déléguer à quelqu'un. 

 Parfois,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Vous développe ou configure les proxys Nginx pour Apache Tomcat sur Ubuntu en 5 minutes avec https et pare-feu</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/434010/"><img src="https://habrastorage.org/getpro/habr/post_images/039/571/089/039571089fb10bc2e457428ec7d35244.jpg"><br><br>  Je ne suis pas administrateur, mais il y a parfois des tâches plus faciles (et plus intéressantes) à résoudre que de déléguer à quelqu'un. <br><br>  Parfois, nous devons «élever» le conteneur de servlet (le plus souvent Apache Tomcat) et configurer le proxy pour lui, la terminaison ssl (ou simplement https) et tout couvrir avec un pare-feu (en ne laissant que ssh et http / https). <br><br>  Il s'est avéré que la semaine dernière, j'ai résolu ce problème à trois reprises (lorsque les étoiles sont devenues, et avant cela - il y a deux ans) et cette expérience s'est transformée en ce petit opus. <br><a name="habracut"></a><br>  Donc, étant donné le serveur Ubuntu 18.04 ou 16.04 (vous n'aurez probablement pas de problèmes avec les versions antérieures 14.04 ou plus).  Si vous ne possédez pas de serveur Ubuntu, vous pouvez rapidement le «récupérer», par exemple, vers <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Digital Ocean</a> (mon lien de référence).  Après avoir écrit l'article, j'ai remarqué que DO pour les nouveaux comptes donne 100 $ pour 60 jours à essayer, si vous indiquez un prêt. <br><br><h2>  DNS </h2><br>  Pour un schéma simple pour obtenir un certificat https gratuit de Let's Encrypt, nous devons avoir accès au serveur DNS.  Nous y écrivons l'adresse IP de notre serveur Ubuntu avec le nom, disons, xyz.  Disons, pour être sûr, que vous avez mydomain.com, c'est-à-dire  Le nom DNS de notre serveur sera xyz.mydomain.com <br><br><h2>  L'installation </h2><br>  Installez Apache Tomcat (j'utiliserai la version 8) <br><br><pre><code class="bash hljs">apt install tomcat8</code> </pre> <br>  Et maintenant Nginx <br><br><pre> <code class="bash hljs">apt install nginx-core</code> </pre> <br><h2>  Personnalisation </h2><br><h3>  Nginx </h3><br>  Configurer Nginx précédemment enregistré dans le nom du serveur DNS (fichier <i>/ etc / nginx / sites-available / default</i> ) <br><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">server_name</span></span> xyz.mydomain.com;</code> </pre> <br>  Nous enregistrons le lien vers Apache Tomcat installé (si vous n’avez rien changé, il «vit» sur le port 8080).  Nous devons ajouter le bloc <i>amont au</i> bloc <i>serveur</i> . <br><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">upstream</span></span> tomcat { <span class="hljs-attribute"><span class="hljs-attribute">server</span></span> <span class="hljs-number"><span class="hljs-number">127.0.0.1:8080</span></span> fail_timeout=<span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-section"><span class="hljs-section">server</span></span> { ...</code> </pre> <br>  Apportez des modifications au bloc d' <i>emplacement</i> et redirigez tout le trafic vers Apache Tomcat <br><br><pre> <code class="nginx hljs"><span class="hljs-section"><span class="hljs-section">server</span></span> { ... <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> / { <span class="hljs-comment"><span class="hljs-comment"># try_files $uri $uri/ =404; include proxy_params; proxy_pass http://tomcat/; }</span></span></code> </pre> <br>  Nous vérifions que tout est entré correctement <br><br><pre> <code class="bash hljs">service nginx configtest</code> </pre> <br>  et redémarrez nginx <br><br><pre> <code class="bash hljs">service nginx restart</code> </pre> <br><h3>  Apache tomcat </h3><br>  En principe, cette partie est facultative, et si cela n'a pas d'importance pour vous que les adresses IP réelles, les ports, le schéma pour lequel la demande est envoyée (je parle de https) et le serveur demandé soient envoyés à tomcat, cette étape peut être omise.  Cependant, dans certains cas, cette étape est requise (par exemple, pour Java Web Start aka JNLP technology). <br><br>  Ajoutez au fichier <i>/etc/tomcat8/server.xml</i> dans le bloc <i>&lt;Host /&gt;</i> . <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Host</span></span></span><span class="hljs-tag">&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Valve</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">className</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"org.apache.catalina.valves.RemoteIpValve"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">remoteIpHeader</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"x-forwarded-for"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">remoteIpProxiesHeader</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"x-forwarded-by"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">protocolHeader</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"x-forwarded-proto"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Host</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Redémarrez Tomcat <br><br><pre> <code class="bash hljs">service tomcat8 restart</code> </pre> <br><h2>  Certificat HTTP </h2><br>  Un certificat https avec vérification via http nous aidera à obtenir le bot certbot, ou plutôt sa modification pour nginx'a - python-certbot-nginx <br><br>  Sur Ubuntu 18.04, pour installer certbot, lancez simplement <br><br><pre> <code class="bash hljs">apt install python-certbot-nginx</code> </pre> <br>  Pour Ubuntu 16.04 - vous devez bricoler avec l'ajout de référentiels, etc. (voir le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">guide détaillé pour le lien</a> ). <br><br>  Nous lançons <br><br><pre> <code class="bash hljs">certbot --nginx</code> </pre> <br>  Dans le processus, spécifiez votre e-mail, acceptez le contrat de licence, ne nous autorisez pas à «fouiller» nos données avec Let's Encrypt, confirmez le nom DNS auquel le certificat sera émis, acceptez que le bot lui-même «configure» nginx. <br><br>  Voila :) <br><br>  Au cas où, nous vérifions que le renouvellement du certificat se passera sans problème (le certificat est délivré pour 90 jours et ensuite il peut être prolongé indéfiniment pour la même période). <br><br><pre> <code class="bash hljs">certbot renew --dry-run</code> </pre> <br>  Et pour la paranoïa interne, on vérifie que le fichier cron est en place <br><br><pre> <code class="bash hljs">ls -al /etc/cron.d/certbot</code> </pre> <br><h2>  Pare-feu </h2><br>  Nous arrêtons et faisons une sauvegarde (instantané) de la machine virtuelle. <br><br><pre> <code class="bash hljs">ufw allow ssh ufw allow http ufw allow https ufw default allow outgoing ufw default deny incoming ufw show added</code> </pre> <br>  Priez! <br><pre> <code class="bash hljs">ufw <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> ufw status</code> </pre> <br>  Nous vérifions que tout s'est bien passé - le site est accessible via https, le trafic http est redirigé et les ports autres que ceux listés ci-dessus et ssh sont bien fermés. <br><br>  PS J'espère sincèrement que ce texte pourra être utile à quelqu'un et je me ferai un plaisir de faire des critiques constructives. <br><br>  PPS Ou peut-être que le ALL-know all me dira le remplacement de certbot pour Windows?  Vous devez obtenir le certificat initial (idéalement, le mettre à jour selon le calendrier, ou en général l'éclat chic) ​​J'ai configuré moi-même nginx.  Oui, je comprends que vous pouvez probablement prendre l'outil pour encrypta + IIS et l'utiliser dans mon script, mais tout à coup il y a un "idéal" prêt à l'emploi? </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr434010/">https://habr.com/ru/post/fr434010/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr434000/index.html">Les fuites de données les plus importantes en 2018. Deuxième partie (juillet-décembre)</a></li>
<li><a href="../fr434002/index.html">Systèmes de surveillance du trafic dans les réseaux VoIP. Première partie - Aperçu</a></li>
<li><a href="../fr434004/index.html">Plateforme Wargaming: Hello World</a></li>
<li><a href="../fr434006/index.html">Avons-nous besoin de cookies à l'ère du RGPD? Nous discutons de la situation et des exigences de la loi</a></li>
<li><a href="../fr434008/index.html">Comment arrêter de s'inquiéter et commencer à écrire des tests basés sur les propriétés</a></li>
<li><a href="../fr434012/index.html">PVS-Studio gratuit pour ceux qui développent des projets open source</a></li>
<li><a href="../fr434016/index.html">Fonctionnement des lapins (RabbitMQ) dans le mode "Survivre à tout prix"</a></li>
<li><a href="../fr434018/index.html">Obtenez un certificat de développeur Android associé Google</a></li>
<li><a href="../fr434034/index.html">Bons tutoriels sur YouTube</a></li>
<li><a href="../fr434036/index.html">Happy and end - les boîtes aux lettres sur les domaines du portail Qip.ru ont migré vers Yandex</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>