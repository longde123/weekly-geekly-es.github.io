<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🕥 🐑 🚴🏼 Nouveau codec AV1: accélérez le chargement vidéo dans un navigateur 🚖 📝 🏎️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans ce guide, nous apprendrons à utiliser la vidéo sur le Web, comme il est de coutume en 2019. Chrome et Firefox ont commencé à prendre en charge le...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Nouveau codec AV1: accélérez le chargement vidéo dans un navigateur</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/442020/"> Dans ce guide, nous apprendrons à utiliser la vidéo sur le Web, comme il est de coutume en 2019. Chrome et Firefox ont commencé à prendre en charge le nouveau codec AV1 - pour eux, la vidéo peut être faite deux fois moins. <br><br>  Nous parlerons séparément de la façon de remplacer les GIF par des vidéos en AV1 et H.264 - puis sa taille diminuera de 20 à 40 fois. <br><br><img src="https://habrastorage.org/webt/e6/ma/qx/e6maqxoeu5hqqh3ilpk5vh6ozvk.jpeg" alt="AV1 dans le navigateur"><br><br>  YouTube l'utilise déjà sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">TestTube</a> .  Netflix a déclaré que l'AV1 serait " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">leur codec de prochaine génération</a> ". <br><br>  Nous, les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">Evil Martians, l'</a> utilisons déjà sur notre site Web et sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">Amplifer</a> .  Dans cet article, je vais partager l'expérience de la mise en œuvre d'AV1 et vous expliquer étape par étape comment intégrer une vidéo afin qu'elle fonctionne dans tous les navigateurs. <br><a name="habracut"></a><br><h2>  Codecs et conteneurs </h2><br>  Avec les images, tout est simple: soit JPEG avec PNG pour tous les navigateurs, soit créer des fichiers plus compacts dans WebP pour <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">les navigateurs modernes</a> .  Nous pouvons toujours être sûrs que les fichiers <code>.png</code> auront un format PNG (à l'exception des bombes PNG contre lesquelles <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">imgproxy</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">peut protéger</a> ). <br><br>  Les fichiers vidéo sont plus compliqués.  L'extension de fichier ( <code>.mp4</code> , <code>.wmv</code> , <code>.webm</code> ou <code>.mov</code> ) ne parle que du conteneur.  Alors que les fichiers vidéo se composent de trois composants différents: <br><br><ol><li>  <b>Le codec vidéo</b> détermine combien vous pouvez compresser la vidéo et ce que vous devez sacrifier.  Les principaux codecs vidéo du Web: H.264, HEVC, VP9 et, maintenant, AV1. </li><li>  <b>Le codec audio</b> comprime le son.  Bien sûr, ce n'est pas nécessaire s'il n'y a pas de son dans la vidéo.  Les choix populaires sont MP3, Opus et AAC. </li><li>  <b>Le conteneur</b> stocke à la fois la vidéo (compressée par une sorte de codec vidéo) et le flux audio (compressé par une sorte de codec audio).  Ainsi que des données supplémentaires, telles que les sous-titres et les méta-informations.  Conteneurs populaires: MP4, MOV, WebM. </li></ol><br>  Lorsque nous voyons l'extension de fichier <code>.mp4</code> , nous pouvons seulement dire que le conteneur MP4 a été utilisé.  Mais les codecs peuvent être différents - l'auteur pourrait prendre H.264 et AAC, AV1 et Opus, ou autre chose. <br><br><h2>  Voici AV1 </h2><br>  AV1 est un codec vidéo sorti il ​​y a un an, en mars 2018. Il a été créé pour dépasser les codecs de la génération précédente - HEVC, VP9, ​​H.264 et VP8. <br><br><img src="https://habrastorage.org/webt/l1/pr/n6/l1prn6kicyr6f7smayebyp7m85m.jpeg" alt="Tableau de génération des codecs vidéo"><br>  <i>Diagramme de codec de génération de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">Tsahi Levent-Levy</a></i> <br><br><blockquote>  Si vous vous êtes intéressé à savoir comment AV1 a réussi à dépasser le reste des codecs en compression, lisez les détails techniques dans les traductions sur Habré: <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Vidéo nouvelle génération: Présentation d'AV1</a> <br>  « <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Codec AV1 nouvelle génération: filtre directionnel correctif CDEF</a> » <br></blockquote><br>  Grâce à de nouvelles optimisations, AV1 compresse la vidéo 30 à 50% mieux que H.264 ou VP8, et jusqu'à 30% mieux que HEVC.  Mais le codec a été publié récemment et a jusqu'à présent plusieurs maladies infantiles: <br><br><ul><li>  L'encodeur actuel n'est pas optimisé.  AV1 comprime la vidéo <i>très</i> lentement (un nouvel <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">encodeur rapide sur Rust est</a> déjà en développement).  Le codec n'est pas adapté à la diffusion en continu.  Si nous parlons de vidéos statiques sur les atterrissages - ce problème ne nous concerne pas. </li><li>  Jusqu'à présent, le codec n'est pris en charge que sur Chrome de bureau et Firefox sur Windows.  Il n'y a pas encore de support pour Safari et Edge (bien que Microsoft le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">teste déjà</a> ).  Vous aurez besoin d'au moins 2 fichiers: AV1 pour Chrome et Firefox et H.264 pour les autres navigateurs. </li></ul><br>  Le plus cool avec AV1, c'est que les carrés de « <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">jackalisation</a> » n'apparaissent pas à des débits binaires faibles. <br><br><img src="https://habrastorage.org/webt/kd/fi/gm/kdfigmacjbsduq4reyw7fsjvygo.png" alt="Comparaison de la qualité d'image pour différents codecs à différents débits binaires"><br>  <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">Comparaison de la</a> qualité d'image pour différents codecs à différents débits binaires - AV1 gagne</i> <br><br><h2>  Cuisiner AV1 correctement </h2><br>  Mettons-nous enfin à la pratique.  Décidons d'abord du conteneur.  En théorie, AV1 peut être placé dans différents conteneurs, mais MP4 est plus compact et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">recommandé</a> dans la spécification.  Pour le son en AV1, nous prenons Opus, car il <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">comprime parfaitement le son</a> . <br><br>  Pour que la vidéo fonctionne dans tous les navigateurs, nous générerons 3 fichiers: <br><br><ol><li>  Pour les ordinateurs de bureau Chrome et Firefox sous Windows ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">31% du marché</a> en mars 2019): conteneur MP4 avec AV1 pour la vidéo et Opus pour le son. </li><li>  Pour Safari et Edge ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">16% du marché</a> ) - MP4 avec HEVC et AAC. </li><li>  Pour le reste: un gros fichier MP4 avec H.264 et AAC. </li></ol><br>  Vous ne pouvez prendre que AV1 et H.264 - la vidéo fonctionnera également pour tout le monde. <br><br>  Pour la compression, je recommande de prendre la console <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">FFmpeg</a> .  Il existe de nombreux utilitaires graphiques, mais il est plus facile d'enregistrer les options dans la console, puis de démarrer la conversion automatiquement.  Assurez-vous d'utiliser la dernière version de FFmpeg.  Les versions antérieures à <b>4.1</b> ne prennent pas en charge AV1 dans MP4. <br><br>  Pour Mac OS X: <br><br><ol><li>  Installez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">Homebrew</a> . </li><li> <code>brew install ffmpeg</code> </li> </ol><br>  Pour Linux, il est préférable de prendre une nouvelle version du site officiel - alors que dans de nombreuses distributions, il n'y a pas de version prenant en charge AV1 en MP4: <br><br><ol><li> <code>wget https://johnvansickle.com/ffmpeg/releases/ffmpeg-release-amd64-static.tar.xz</code> </li> <li> <code>tar -xf ffmpeg-release-amd64-static.tar.xz</code> </li> <li> <code>sudo cp ffmpeg-4.1-64bit-static/ff* /usr/local/bin/</code> </li> </ol><br>  Pour Windows, vous pouvez installer FFmpeg <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">par William Diaz</a> . <br><br>  Nous passons à la conversion du fichier H.264, dont nous avons besoin pour les anciens navigateurs.  Étant donné que tous nos fichiers utilisent le conteneur MP4, j'utiliserai les <code>.av1.mp4</code> , <code>.hevc.mp4</code> et <code>.h264.mp4</code> .  Ne vous inquiétez pas de la longue équipe, nous analyserons ensuite tout cela: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#  SOURCE.mov     - ffmpeg -i SOURCE.mov -map_metadata -1 -c:a libfdk_aac -c:v libx264 -crf 24 -preset veryslow -profile:v main -pix_fmt yuv420p -movflags +faststart -vf "scale=trunc(iw/2)*2:trunc(ih/2)*2" video.h264.mp4</span></span></code> </pre><br>  Ouvrez maintenant <code>video.h264.mp4</code> .  Si la qualité est bonne et la taille importante, essayez d'augmenter <code>-crf</code> ( <code>-crf 26</code> puis <code>-crf 28</code> ).  Cette option réduira la taille du fichier au prix d'une qualité réduite.  Équilibrer la qualité et la taille est un art. <br><br><blockquote>  S'il n'y a pas de fichier vidéo d'origine, vous pouvez convertir l'ancien fichier H.264 en AV1. </blockquote><br>  Il est maintenant temps de convertir AV1 - je vous rappelle que ce sera plus long que H.264.  Le codec n'utilise pas encore toute la puissance du processeur (il est logique de commencer à convertir plusieurs fichiers en parallèle). <br><br><pre> <code class="bash hljs">ffmpeg -i SOURCE.mov -map_metadata -1 -c:a libopus -c:v libaom-av1 -crf 34 -b:v 0 -pix_fmt yuv420p -movflags +faststart -vf <span class="hljs-string"><span class="hljs-string">"scale=trunc(iw/2)*2:trunc(ih/2)*2"</span></span> -strict experimental video.av1.mp4</code> </pre><br>  <code>-crf</code> à nouveau avec <code>-crf</code> pour <code>-crf</code> équilibre parfait entre qualité et taille. <br><br>  Maintenant la même chose pour HEVC. <br><br><pre> <code class="bash hljs">ffmpeg -i SOURCE.mov -map_metadata -1 -c:a libfdk_aac -c:v libx265 -crf 24 -preset veryslow -pix_fmt yuv420p -movflags +faststart -vf <span class="hljs-string"><span class="hljs-string">"scale=trunc(iw/2)*2:trunc(ih/2)*2"</span></span> video.hevc.mp4</code> </pre><br>  Copiez <code>video.h264.mp4</code> , <code>video.hevc.mp4</code> et <code>video.av1.mp4</code> à la racine de votre site. <br><br><h3>  Comprendre les options FFmpeg </h3><br>  Les commandes ci-dessus ressemblent-elles à un sort d'invocation de démon?  Ne vous inquiétez pas, ce n'est <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">pas PostCSS</a> .  Examinons les options. <br><br>  <code>-i SOURCE.mov</code> indique le fichier d'entrée, d'où FFmpeg prendra les flux vidéo et audio, les compressera et les emballera dans un nouveau conteneur. <br><br>  <code>-map_metadata -1</code> supprimera les métadonnées de la vidéo (par exemple, le programme dans lequel la vidéo a été créée).  Ces informations sont rarement utiles sur le Web. <br><br>  <code>-c:a libopus</code> ou <code>-c:a libfdk_aac</code> définit les codecs audio.  Si vous n'avez pas besoin de son, remplacez-les par <code>-an</code> . <br><br>  <code>-c:v libaom-av1</code> sélectionne le codec vidéo - une bibliothèque qui compressera les images du flux vidéo. <br><br>  <code>-crf 34</code> - Facteur de taux constant, un équilibre entre qualité et taille.  C'est comme un curseur de qualité JPEG, mais il va dans une direction différente (0 est la meilleure qualité et le plus gros fichier).  L'échelle CRF est différente pour H.264 et AV1 - pour H.264 elle va jusqu'à 51, pour AV1 elle monte jusqu'à 61. La CRF pour AV1 et H.264 sera différente. <br><br><blockquote>  Facebook a trouvé une correspondance approximative entre les valeurs CRF pour H.264 et AV1: <br>  19 → 27, 23 → 33, 27 → 39, 31 → 45, 35 → 51, 39 → 57. <br></blockquote><br>  <code>-preset veryslow</code> oblige les codecs H.264 et HEVC à compresser encore plus le fichier au prix d'une forte augmentation du temps de conversion. <br><br>  <code>-profile:v main</code> utilisé par H.264 pour sélectionner <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">un profil de codec</a> .  Seul «Main» fonctionnera dans Safari. <br><br>  <code>-b:v 0</code> définit le débit binaire minimum pour AV1 afin que la vidéo ait une qualité constante. <br><br>  <code>-pix_fmt yuv420p</code> (format pixel) est un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">moyen</a> délicat <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">de</a> réduire la taille du fichier.  Il laisse la résolution d'origine pour la luminosité, mais réduit la résolution pour la couleur.  Nos yeux voient la couleur pire, donc ils ne remarquent pas cette astuce.  Supprimez cette option si, dans votre cas, elle interfère. <br><br>  <code>-movflags +faststart</code> déplace tout ce qui est important au début du fichier afin que le navigateur puisse lire la vidéo jusqu'à la fin du téléchargement. <br><br>  <code>-vf "scale=trunc(iw/2)*2:trunc(ih/2)*2"</code> changera la taille des côtés de la vidéo en les paires les plus proches (certains codecs peuvent fonctionner avec une résolution de 300 × 200 et 302 × 200, mais ne fonctionneront pas avec 301 × 200).  Si vous êtes sûr que partout la résolution est divisée par 2, vous pouvez supprimer cette option. <br><br>  <code>-strict experimental</code> nécessaire pour AV1, son encodeur est toujours expérimental. <br><br>  <code>video.av1.mp4</code> définit le nom du fichier résultant. <br><br><h3>  Nous lançons la vidéo dans les navigateurs </h3><br>  Maintenant, nous avons besoin de chaque navigateur pour télécharger la vidéo qu'il prend en charge.  Pour cela, &lt;source&gt; a un attribut <code>type</code> .  Et je vous conseille de lire les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">options sur &lt;video&gt;</a> . <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">video</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">controls</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"600"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"400"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">source</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"video.hevc.mp4"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"video/mp4; codecs=hevc,mp4a.40.2"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">source</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"video.av1.mp4"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"video/mp4; codecs=av01.0.05M.08,opus"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">source</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"video.h264.mp4"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"video/mp4; codecs=avc1.4D401E,mp4a.40.2"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">video</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  &lt;source&gt; sont comme des expressions <code>if…else</code> - le navigateur les lit de haut en bas jusqu'à ce qu'il trouve celle dont il prend en charge le <code>type</code> . <br><br>  En <code>type</code> vous pouvez spécifier le format de fichier complet: conteneur ( <code>video/mp4</code> pour MP4), codec vidéo ( <code>av01.0.05M.08</code> pour AV1, <code>hevc</code> pour HEVC et <code>avc1.4D401E</code> pour H.264) et codec audio ( <code>opus</code> pour Opus et <code>mp4a.40.2</code> pour AAC). <br><br><h2>  Bonus: comment convertir GIF en AV1 et H.264 </h2><br>  En 2019, l'utilisation de GIF pour de courtes vidéos est un gros péché.  GIF pèse 20 à 40 fois plus que H.264 ou AV1.  GIF frappe plus fort le CPU et accélère la fuite de la batterie.  Si vous avez besoin d'une courte vidéo en boucle, prenez des codecs vidéo.  Et FFmpeg peut convertir la vidéo directement à partir de GIF. <br><br>  Convertissez GIF en H.264: <br><br><pre> <code class="bash hljs">ffmpeg -i IMAGE.gif -map_metadata -1 -an -c:v libx264 -crf 24 -preset veryslow -profile:v main -pix_fmt yuv420p -movflags +faststart -vf <span class="hljs-string"><span class="hljs-string">"scale=trunc(iw/2)*2:trunc(ih/2)*2"</span></span> video.h264.mp4</code> </pre><br>  Générez un AV1 encore plus petit: <br><br><pre> <code class="bash hljs">ffmpeg -i IMAGE.gif -map_metadata -1 -an opus -c:v libaom-av1 -crf 50 -b:v 0 -pix_fmt yuv420p -movflags +faststart -vf <span class="hljs-string"><span class="hljs-string">"scale=trunc(iw/2)*2:trunc(ih/2)*2"</span></span> -strict experimental video.av1.mp4</code> </pre><br>  Insérez maintenant <code>animation.h264.mp4</code> et <code>animation.av1.mp4</code> dans le HTML. <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">video</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">autoplay</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">loop</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">muted</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">playsinline</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"300"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"200"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">source</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"animation.av1.mp4"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"video/mp4; codecs=av01.0.05M.08"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">source</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"animation.h264.mp4"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"video/mp4"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">video</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Les options de <code>autoplay</code> et de <code>loop</code> font de la vidéo un «GIF» - une vidéo en boucle qui est lue immédiatement après le chargement de la page.  <code>playsinline</code> Safari d'ouvrir la vidéo en plein écran lorsque vous cliquez sur la vidéo. <br><br><h2>  Temps de retrait </h2><br>  AV1 est encore expérimental.  Mais il peut déjà être utilisé pour rendre plus heureux un quart de vos utilisateurs.  Une paire de commandes FFmpeg générera des fichiers vidéo.  &lt;video&gt; a été créé dès le début pour rendre les vidéos en fonction des capacités du navigateur.  Nous utilisons déjà AV1 en production et tout fonctionne bien (sauf pour le temps d'attente jusqu'à ce que l'encodeur AV1 finisse de fonctionner). </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr442020/">https://habr.com/ru/post/fr442020/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr442010/index.html">Python et FPGA. Test</a></li>
<li><a href="../fr442012/index.html">Expérience: nous collectons un répertoire des unités qui ont délivré un passeport</a></li>
<li><a href="../fr442014/index.html">Dart 2.2 annoncé: code machine plus efficace, prise en charge des littéraux définis</a></li>
<li><a href="../fr442016/index.html">Les pirates informatiques sont pires que la peinture, ou comment protéger les applications Web</a></li>
<li><a href="../fr442018/index.html">Loi de printemps en termes de constitution. Pourquoi</a></li>
<li><a href="../fr442022/index.html">Conception sur CodeFest. Mais ce n'est pas sûr</a></li>
<li><a href="../fr442024/index.html">Une stratégie nationale d'intelligence artificielle est en cours de création en Russie</a></li>
<li><a href="../fr442026/index.html">Trojan.Multi.BroSubsc.gen - Kaspersky fonctionne</a></li>
<li><a href="../fr442028/index.html">Stéroïdes de carrière. Samurai Way</a></li>
<li><a href="../fr442032/index.html">Réintroduction du bison (petite victoire des zoologistes)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>