<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>๐๏ธ ๐๐ฝ โ๐ฟ ุชูุตูู OpenSSL ุจู Mono ๐ ๐ง๐ฝ ๐ค๐ป</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ูู ููุงู ุณุงุจู ุ ุชู ูุตู ุนูููุฉ ุฏูุฌ ุดูุงุฏุงุช GOST ูู CryptoPro ูุน mono. ูู ุงูููุช ููุณู ุ ูุญู ูุชุญุฏุซ ุนู ุฑุจุท ุดูุงุฏุงุช RSA. 


 ูุงุตููุง ููู ุฃุญุฏ ุฃูุธูุฉ ุงูุฎุงุฏู ุงูุฎุงุตุฉ ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ุชูุตูู OpenSSL ุจู Mono</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/423769/" style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl">  ูู ููุงู ุณุงุจู ุ ุชู ูุตู ุนูููุฉ ุฏูุฌ ุดูุงุฏุงุช GOST ูู CryptoPro ูุน mono.  ูู ุงูููุช ููุณู ุ ูุญู ูุชุญุฏุซ ุนู ุฑุจุท ุดูุงุฏุงุช RSA. </p><br><p style=";text-align:right;direction:rtl">  ูุงุตููุง ููู ุฃุญุฏ ุฃูุธูุฉ ุงูุฎุงุฏู ุงูุฎุงุตุฉ ุจูุง ุงูููุชูุจุฉ ุจูุบุฉ C # ุฅูู Linux ุ ููุตูุช ูุงุฆูุฉ ุงูุงูุชุธุงุฑ ุฅูู ุงูุฌุฒุก ุงููุชุนูู ุจู RSA.  ุฅุฐุง ูุงูุช ุงููุฑุฉ ุงูุฃุฎูุฑุฉ ุงูุชู ุชู ูููุง ุดุฑุญ ุตุนูุจุงุช ุงูุงุชุตุงู ุจุณูููุฉ ูู ุฎูุงู ุชูุงุนู ูุธุงููู ูู ูููุง ูุชุตููู ุจุจุนุถููุง ูู ุงูุฃุตู ุ ูุนูุฏ ุชูุตูู ุดูุงุฏุงุช RSA "ุงูุนุงุฏูุฉ" ูู ุฃุญุงุฏูุฉ ุ ูู ููู ุฃุญุฏ ูุชููุน ุญุฏูุซ ุตูุฏ. </p><br><a name="habracut"></a><br><p style=";text-align:right;direction:rtl">  ูู ูุชุณุจุจ ุชุซุจูุช ุงูุดูุงุฏุฉ ูุงูููุชุงุญ ูู ุญุฏูุซ ูุดููุงุช ุ ุจู ููุฏ ุฑุขูุง ุงููุธุงู ูู ูุญุฏุฉ ุงูุชุฎุฒูู ุงูููุงุณูุฉ.  ููุน ุฐูู ุ ูู ูุนุฏ ูู ุงููููู ุชูููุน ุงูุจูุงูุงุช ุฃู ุชุดููุฑูุง ุฃู ุงุณุชุฎุฑุงุฌูุง ูู ุชูููุน ุชู ุฅูุดุงุคู ุณุงุจููุง - ููุฏ ุญุฏุซ ุฎุทุฃ ุฃุญุงุฏู ุจุดูู ุซุงุจุช.  ุงุถุทุฑุฑุช ุ ููุง ูู ุงูุญุงู ูู CryptoPro ุ ุฅูู ุงูุงุชุตุงู ูุจุงุดุฑุฉ ุจููุชุจุฉ ุงูุชุดููุฑ.  ุจุงููุณุจุฉ ูุดูุงุฏุงุช RSA ูู Linux ุ ูุฅู ุงููุฑุดุญ ุงูุฑุฆูุณู ููุซู ูุฐุง ุงูุงุชุตุงู ูู OpenSSL. </p><br><h2 style=";text-align:right;direction:rtl">  ุชุซุจูุช ุงูุดูุงุฏุฉ </h2><br><p style=";text-align:right;direction:rtl">  ูุญุณู ุงูุญุธ ุ ูุญุชูู Centos 7 ุนูู ุฅุตุฏุงุฑ ูุถูู ูู OpenSSL - 1.0.2k.  ูู ุฃุฌู ุนุฏู ุฅุฏุฎุงู ุตุนูุจุงุช ุฅุถุงููุฉ ูู ุงููุธุงู ุ ูุฑุฑูุง ุงูุงุชุตุงู ุจูุฐุง ุงูุฅุตุฏุงุฑ.  ูุณูุญ ูู OpenSSL ุจุฅูุดุงุก ูุฎุงุฒู ุดูุงุฏุงุช ูููุงุช ุฎุงุตุฉ ุ ููุน ุฐูู: </p><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ูุญุชูู ูุฐุง ุงููุชุฌุฑ ุนูู ุดูุงุฏุงุช ู CRLs ุ ูููุณ ููุงุชูุญ ุฎุงุตุฉ ุ ูุฐุง ูู ูุฐู ุงูุญุงูุฉ ูุฌุจ ุชุฎุฒูููุง ุจุดูู ูููุตู ุ </li><li style=";text-align:right;direction:rtl">  ุชุฎุฒูู ุงูุดูุงุฏุงุช ูุงูููุงุชูุญ ุงูุฎุงุตุฉ ูู Windows ุนูู ูุฑุต ูู ุดูู ุบูุฑ ุขูู ูู "ุบูุฑ ุขูู ููุบุงูุฉ" (ุงููุณุคูููู ุนู ุงูุฃูู ุงูุฑููู ุนุงุฏุฉ ูุง ูุตูููู ุจุดูู ุฃูุซุฑ ููุฉ ูุฃูู ุฑูุงุจุฉ) ุ ููููู ุตุงุฏููู ุ ูุฐุง ููุณ ุขูููุง ุฌุฏูุง ูู Linux ุ ูููู ูู ุงููุงูุน ุ ูู ุงูุดุงุฆุน ุงูููุงุฑุณุฉ ุ </li><li style=";text-align:right;direction:rtl">  ุฅู ุชูุณูู ูููุน ูุฐู ุงููุณุชูุฏุนุงุช ุนูู ูุธุงูู ุงูุชุดุบูู Windows ู Linux ููุซู ูุดููุฉ ูุจูุฑุฉ ุ </li><li style=";text-align:right;direction:rtl">  ูู ุญุงูุฉ ุงูุชูููุฐ ุงููุฏูู ููุชุฎุฒูู ุ ุณุชููู ููุงู ุญุงุฌุฉ ุฅูู ุฃุฏุงุฉ ูุฅุฏุงุฑุฉ ูุฌููุนุฉ ุงูุดูุงุฏุงุช ุ </li><li style=";text-align:right;direction:rtl">  ูุณุชุฎุฏู mono ููุณู ุชุฎุฒูู ุงููุฑุต ุจูููู OpenSSL ุ ููููู ุฃูุถูุง ุจุชุฎุฒูู ุงูููุงุชูุญ ุงูุฎุงุตุฉ ูู ุดูู ููุชูุญ ูุฑูุจ ุ </li></ol><br>  ููุฐู ุงูุฃุณุจุงุจ ุ ุณูุณุชุฎุฏู ูุฎุงุฒู ุงูุดูุงุฏุงุช .Net ู mono ุงูููุงุณูุฉ ูุชูุตูู OpenSSL.  ููููุงู ุจุฐูู ุ ุนูู Linux ุ ูุฌุจ ุฃููุงู ูุถุน ุงูุดูุงุฏุฉ ูุงูููุชุงุญ ุงูุฎุงุต ูู ุงููุณุชูุฏุน ุงูุฃุญุงุฏู. <br><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ุชุซุจูุช ุงูุดูุงุฏุฉ</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"> ุณูุณุชุฎุฏู ุงูุฃุฏุงุฉ certmgr ุงูููุงุณูุฉ ููุฐุง ุงูุบุฑุถ.  ุฃููุงู ุ ูู ุจุชุซุจูุช ุงูููุชุงุญ ุงูุฎุงุต ูู pfx: <br><br> <code>certmgr -importKey -c -p {password} My {pfx file}</code> <br> <br>  ุซู ูุถุน ุงูุดูุงุฏุฉ ูู ูุฐุง pfx ุ ุณูุชุตู ุจูุง ุงูููุชุงุญ ุงูุฎุงุต ุชููุงุฆููุง: <br><br> <code>certmgr -add -c My {cer file}</code> <br> <br>  ุฅุฐุง ููุช ุชุฑุบุจ ูู ุชุซุจูุช ุงูููุชุงุญ ูู ุงูุชุฎุฒูู ููุฌูุงุฒ ุ ูุฌุจ ุนููู ุฅุถุงูุฉ ุงูุฎูุงุฑ -m. <br><br>  ุจุนุฏ ุฐูู ูููู ุฑุคูุฉ ุงูุดูุงุฏุฉ ูู ุงููุณุชูุฏุน: <br><br> <code>certmgr -list -c -v My</code> <br> <br>  ุงูุชุจู ุฅูู ุงูุฅุตุฏุงุฑ.  ูุชุฌุฏุฑ ุงูุฅุดุงุฑุฉ ุฅูู ุฃู ุงูุดูุงุฏุฉ ูุฑุฆูุฉ ูููุธุงู ูุชุฑุชุจุท ุจุงูููุชุงุญ ุงูุฎุงุต ุงูุฐู ุชู ุชูุฒููู ุณุงุจููุง.  ุจุนุฏ ุฐูู ุ ููููู ุงููุชุงุจุนุฉ ุฅูู ุงูุงุชุตุงู ูู ุงูุฑูุฒ. <br></div></div><br><h2 style=";text-align:right;direction:rtl">  ุงูุงุชุตุงู ูู ุงูุชุนูููุงุช ุงูุจุฑูุฌูุฉ </h2><br><p style=";text-align:right;direction:rtl">  ุชูุงููุง ูุซู ุขุฎุฑ ูุฑุฉ ุ ูุงู ูุฌุจ ุฃู ูุณุชูุฑ ุงููุธุงู ูู ุจูุฆุฉ Windows ุ ุนูู ุงูุฑุบู ูู ูููู ุฅูู Linux.  ูุฐูู ุ ูุฌุจ ุฃู ูุชู ุงูุนูู ุจุงุณุชุฎุฏุงู ุงูุชุดููุฑ ุธุงูุฑููุง ูู ุฎูุงู ุงูุทุฑู ุงูุนุงูุฉ ูููููุฐุฌ "byte [] SignData (byte [] _arDataุ X509Certificate2 _pCert)" ุ ูุงูุชู ูุฌุจ ุฃู ุชุนูู ุจููุณ ุงูุทุฑููุฉ ูู ูู ูู Linux ู Windows. </p><br><p style=";text-align:right;direction:rtl">  ูู ุงููุงุญูุฉ ุงููุซุงููุฉ ุ ูุฌุจ ุฃู ุชููู ููุงู ุทุฑู ุชุนูู ุชูุงููุง ูุซู Windows - ุจุบุถ ุงููุธุฑ ุนู ููุน ุงูุดูุงุฏุฉ (ุนูู Linux ูู ุฎูุงู OpenSSL ุฃู CryptoPro ุงุนุชูุงุฏูุง ุนูู ุงูุดูุงุฏุฉ ุ ูุนูู Windows ูู ุฎูุงู crypt32). </p><br><p style=";text-align:right;direction:rtl">  ุฃุธูุฑ ุชุญููู ููุชุจุงุช OpenSSL ุฃูู ูู ูุธุงู ุงูุชุดุบูู Windows ูุฅู ุงูููุชุจุฉ ุงูุฑุฆูุณูุฉ ูู "libeay32.dll" ุ ูุนูู Linux "libcrypto.so.10".  ุจุงูุฅุถุงูุฉ ุฅูู ุงููุฑุฉ ุงูุฃุฎูุฑุฉ ุ ูููุง ุจุชุดููู ูุฆุชูู WOpenSSLAPI ู LOpenSSLAPI ุ ุชุญุชูู ุนูู ูุงุฆูุฉ ุจุฃุณุงููุจ ููุชุจุฉ ุงูููุชุจุฉ: <br><br></p><pre style=";text-align:right;direction:rtl"> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">DllImport(CTRYPTLIB, CharSet = CharSet.Auto, SetLastError = true, CallingConvention = CallingConvention.Cdecl)</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OPENSSL_init</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>;</code> </pre><br><p style=";text-align:right;direction:rtl">  ุงูุชุจู ุฅูู ุงุชูุงููุฉ ุงูุงุชุตุงู ุ ุนูู ุนูุณ CryptoPro - ููุง ูุฌุจ ุชุญุฏูุฏูุง ุจุดูู ุตุฑูุญ.  ูุฌุจ ุฃู ูุชู ุฅูุดุงุก ุจูุงุก ุงูุฌููุฉ ูุชูุตูู ูู ูู ูุฐู ุงูุทุฑู ุจุดูู ูุณุชูู ุจูุงุกู ุนูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ูููุงุช</a> ูุตุฏุฑ * .h OpenSSL. </p><br><p style=";text-align:right;direction:rtl">  ุงูููุงุนุฏ ุงูุฃุณุงุณูุฉ ูุฅูุดุงุก ุจููุฉ ุงุณุชุฏุนุงุก ูู C # ุงุณุชูุงุฏุงู ุฅูู ุงูุจูุงูุงุช ูู ูููุงุช .h ูู ููุง ููู: </p><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุฃู ุฑูุงุจุท ุฅูู ุงูููุงูู ูุงูุณูุงุณู ููุง ุฅูู ุฐูู - IntPtr ุ ุจูุง ูู ุฐูู ุงูุฑูุงุจุท ุฏุงุฎู ุงูููุงูู ููุณูุง ุ </li><li style=";text-align:right;direction:rtl">  ุฑูุงุจุท ุฅูู ุฑูุงุจุท - ุงููุฑุฌุน IntPtr ุ ุฅุฐุง ูู ูุนูู ูุฐุง ุงูุฎูุงุฑ ุ ูุนูุฏุฆุฐ ููุท IntPtr.  ูู ูุฐู ุงูุญุงูุฉ ุ ูุฌุจ ูุถุน ุงูุฑุงุจุท ูุฅุฒุงูุชู ูุฏูููุง ุ </li><li style=";text-align:right;direction:rtl">  ุตูุงุฆู - ุจุงูุช [] ุ </li><li style=";text-align:right;direction:rtl">  ุทููู ูู C (OpenSSL) ูู ุนุฏุฏ ุตุญูุญ ูู C # (ูููููุฉ ุงูุฃููู ุ ูููู ุฃู ูุชุญูู ุงูุฎุทุฃ ุฅูู ุณุงุนุงุช ูู ุงูุจุญุซ ุนู ูุตุฏุฑ ุงูุฃุฎุทุงุก ุบูุฑ ุงููุชููุนุฉ) ุ </li></ol><br><p style=";text-align:right;direction:rtl">  ูู ุงูุฅุนูุงู ุ ุจุฏุงูุน ุงูุนุงุฏุฉ ุ ููููู ุชุญุฏูุฏ SetLastError = true ุ ููู ุงูููุชุจุฉ ุณุชุชุฌุงูู ุฐูู - ูู ุชููู ุงูุฃุฎุทุงุก ูุชุงุญุฉ ูู ุฎูุงู Marshal.GetLastWin32Error ().  OpenSSL ูู ุทุฑูู ุงูุฎุงุตุฉ ูููุตูู ุฅูู ุงูุฃุฎุทุงุก. </p><br><p style=";text-align:right;direction:rtl">  ุซู ูููู ุจุชุดููู ุงููุฆุฉ ุงูุซุงุจุชุฉ ุงููุฃูููุฉ ุจุงููุนู "UOpenSSLAPI" ูุงูุชู ุ ุจูุงุกู ุนูู ุงููุธุงู ุ ุณุชุทูู ุนูู ุทุฑููุฉ ูุงุญุฏุฉ ูู ูุฆุชูู: </p><br><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> fpOSSection = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>(); <span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt;  OpenSSL&lt;/summary&gt;**/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OPENSSL_init</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">lock</span></span> (pOSSection) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fIsLinux) LOpenSSLAPI.OPENSSL_init(); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> WOpenSSLAPI.OPENSSL_init(); } } <span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt;    OpenSSL&lt;/summary&gt;**/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> pOSSection { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fpOSSection; } } <span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt;  &lt;/summary&gt;**/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> fIsLinux { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> iPlatform = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) Environment.OSVersion.Platform; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (iPlatform == <span class="hljs-number"><span class="hljs-number">4</span></span>) || (iPlatform == <span class="hljs-number"><span class="hljs-number">6</span></span>) || (iPlatform == <span class="hljs-number"><span class="hljs-number">128</span></span>); } }</code> </pre><br><p style=";text-align:right;direction:rtl">  ุนูู ุงูููุฑ ููุงุญุธ ูุฌูุฏ ูุณู ุญุงุณู.  ูููุฑ OpenSSL <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ูุธุฑููุง</a> ุงูุนูู ูู ุจูุฆุฉ ูุชุนุฏุฏุฉ ุงูุฎููุท.  ูููู ุ ุฃููุงู ุ ุนูู ุงูููุฑ ูู ุงููุตู ููุงู ุฃู ูุฐุง ุบูุฑ ูุถููู: </p><br><blockquote style=";text-align:right;direction:rtl">  ูููู ูุง ูุฒุงู ูุชุนุฐุฑ ุนููู ุงุณุชุฎุฏุงู ูุนุธู ุงููุงุฆูุงุช ูู ุณูุงุณู ุฑุณุงุฆู ูุชุนุฏุฏุฉ ูู ููุณ ุงูููุช. </blockquote><br><p style=";text-align:right;direction:rtl">  ูุซุงูููุง ุ ุทุฑููุฉ ุงูุงุชุตุงู ููุณุช ุงูุฃูุซุฑ ุชุงููุฉ.  ูููุญ ุฌูุงุฒ VM ุงููุนุชุงุฏ ุซูุงุฆู ุงูููุงุฉ (ุฎุงุฏู ูุฒูุฏ ุจูุนุงูุฌ Intel Xeon E5649 ูู ูุถุน Hyper-Threading) ุญูุงูู 100 ุฏูุฑุฉ ูุงููุฉ (ุงูุธุฑ ุฎูุงุฑุฒููุฉ ุงูุงุฎุชุจุงุฑ ูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุงูููุงูุฉ</a> ุงูุณุงุจูุฉ) ุฃู 600 ุชูููุน ูู ุงูุซุงููุฉ ุ ููู ูุง ูููู ุจุดูู ุฃุณุงุณู ููุนุธู ุงูููุงู ( ุชุญุช ุงูุฃุญูุงู ุงูุซูููุฉ ุ ุณูุชู ุงุณุชุฎุฏุงู ุงูุฎุฏูุงุช ุงููุตุบุฑุฉ ุฃู ุจููุฉ ุงูุนูุฏ ูููุธุงู ุนูู ุฃู ุญุงู). </p><br><h2 style=";text-align:right;direction:rtl">  ุชููุฆุฉ ูุชูุฑูุบ OpenSSL </h2><br><p style=";text-align:right;direction:rtl">  ุนูู ุนูุณ CryptoPro OpenSSL ูุชุทูุจ ุฅุฌุฑุงุกุงุช ูุนููุฉ ูุจู ุงูุจุฏุก ูู ุงุณุชุฎุฏุงูู ูุจุนุฏ ุงูุงูุชูุงุก ูู ุงูุนูู ูุน ุงูููุชุจุฉ: <br><br></p><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt; OpenSSL&lt;/summary&gt;**/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InitOpenSSL</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { UOpenSSLAPI.OPENSSL_init(); UOpenSSLAPI.ERR_load_crypto_strings(); UOpenSSLAPI.ERR_load_RSA_strings(); UOpenSSLAPI.OPENSSL_add_all_algorithms_conf(); UOpenSSLAPI.OpenSSL_add_all_ciphers(); UOpenSSLAPI.OpenSSL_add_all_digests(); } <span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt; OpenSSL&lt;/summary&gt;**/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CleanupOpenSSL</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { UOpenSSLAPI.EVP_cleanup(); UOpenSSLAPI.CRYPTO_cleanup_all_ex_data(); UOpenSSLAPI.ERR_free_strings(); }</code> </pre><br><br><h2 style=";text-align:right;direction:rtl">  ูุนูููุงุช ุงูุฎุทุฃ </h2><br><p style=";text-align:right;direction:rtl">  ูููู OpenSSL ุจุชุฎุฒูู ูุนูููุงุช ุงูุฎุทุฃ ูู ุงูููุงูู ุงูุฏุงุฎููุฉ ุงูุชู ุชูุฌุฏ ุจูุง ุทุฑู ุฎุงุตุฉ ูู ุงูููุชุจุฉ.  ูุณูุก ุงูุญุธ ุ ุจุนุถ ุงูุทุฑู ุงูุจุณูุทุฉ ุ ูุซู ERR_error_string ุ ุบูุฑ ูุณุชูุฑุฉ ุ ูุฐุง ุนููู ุงุณุชุฎุฏุงู ุทุฑู ุฃูุซุฑ ุชุนููุฏูุง: </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ุงูุญุตูู ุนูู ูุนูููุงุช ุงูุฎุทุฃ</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt;    OpenSSL&lt;/summary&gt; * &lt;param name="_iErr"&gt; &lt;/param&gt; * &lt;param name="_iPart"&gt;&lt;/param&gt; * &lt;returns&gt; &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetErrStrPart</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ulong</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _iErr, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _iPart</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">// 0)    IntPtr hErrStr = IntPtr.Zero; switch (_iPart) { case 0: hErrStr = UOpenSSLAPI.ERR_lib_error_string(_iErr); break; case 1: hErrStr = UOpenSSLAPI.ERR_func_error_string(_iErr); break; case 2: hErrStr = UOpenSSLAPI.ERR_reason_error_string(_iErr); break; } // 1)   return PtrToFirstStr(hErrStr); } /**&lt;summary&gt;    OpenSSL&lt;/summary&gt; * &lt;param name="_iErr"&gt; &lt;/param&gt; * &lt;returns&gt; &lt;/returns&gt; * **/ public static string GetErrStr(ulong _iErr ) { return UCConsts.S_GEN_LIB_ERR_MAKRO.Frm(_iErr, GetErrStrPart(_iErr, 0), GetErrStrPart(_iErr, 1), GetErrStrPart(_iErr, 2)); } /**&lt;summary&gt;    OpenSSL&lt;/summary&gt; * &lt;returns&gt; &lt;/returns&gt; * **/ public static string GetErrStrOS() { return GetErrStr(UOpenSSLAPI.ERR_get_error()); }</span></span></code> </pre></div></div><br><p style=";text-align:right;direction:rtl">  ูุญุชูู ุฎุทุฃ ูู OpenSSL ุนูู ูุนูููุงุช ุญูู ุงูููุชุจุฉ ุงูุชู ุญุฏุซุช ูููุง ุ ูุงูุทุฑููุฉ ูุงูุณุจุจ.  ูุฐูู ุ ุจุนุฏ ุชููู ุฑูุฒ ุงูุฎุทุฃ ููุณู ุ ูู ุงูุถุฑูุฑู ุงุณุชุฎุฑุงุฌ ุฌููุน ูุฐู ุงูุฃุฌุฒุงุก ุงูุซูุงุซุฉ ุจุดูู ูููุตู ูุฌูุนูุง ูุนูุง ูู ุณุทุฑ ูุตู.  ูุง ูุชุฌุงูุฒ ุทูู ูู ุณุทุฑ ุ ููููุง <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ููุซุงุฆู</a> OpenSSL <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุ</a> 120 ุญุฑููุง ุ ููุฃููุง ูุณุชุฎุฏู ุงูุชุนูููุงุช ุงูุจุฑูุฌูุฉ ุงูููุฏุงุฑุฉ ุ ูุฌุจ ุนูููุง ุงุณุชุฎุฑุงุฌ ุงูุฎุท ุจุนูุงูุฉ ูู ุงูุฑุงุจุท: </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ุงูุญุตูู ุนูู ุณูุณูุฉ ุจูุงุณุทุฉ IntPtr</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt;    PChar     _iLen&lt;/summary&gt; * &lt;param name="_hPtr"&gt;    &lt;/param&gt; * &lt;param name="_iLen"&gt;  &lt;/param&gt; * &lt;returns&gt; &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PtrToFirstStr</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr _hPtr, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _iLen = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">256</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(_hPtr == IntPtr.Zero) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] arStr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[_iLen]; Marshal.Copy(_hPtr, arStr, <span class="hljs-number"><span class="hljs-number">0</span></span>, arStr.Length); <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] arRes = Encoding.ASCII.GetString(arStr).Split(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>[] { (<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>)<span class="hljs-number"><span class="hljs-number">0</span></span> }, StringSplitOptions.RemoveEmptyEntries); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (arRes.Length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> arRes[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span>; }<span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span>; } }</code> </pre></div></div><br><p style=";text-align:right;direction:rtl">  ุงูุฃุฎุทุงุก ุงูุชู ุชุญุฏุซ ุนูุฏ ูุญุต ุงูุดูุงุฏุงุช ูุง ุชูุฏุฑุฌ ูู ุงููุงุฆูุฉ ุงูุนุงูุฉ ุ ููุฌุจ ุงุณุชุฎุฑุงุฌูุง ุจุทุฑููุฉ ูููุตูุฉ ุ ููููุง ูุณูุงู ุงูุชุญูู: </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ุชููู ุฎุทุฃ ุงูุชุญูู ูู ุงูุดูุงุฏุฉ</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt;   &lt;/summary&gt; * &lt;param name="_hStoreCtx"&gt; &lt;/param&gt; * &lt;returns&gt; &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetCertVerifyErr</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr _hStoreCtx</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> iErr = UOpenSSLAPI.X509_STORE_CTX_get_error(_hStoreCtx); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> PtrToFirstStr(UOpenSSLAPI.X509_verify_cert_error_string(iErr)); }</code> </pre></div></div><br><h2 style=";text-align:right;direction:rtl">  ุจุญุซ ุงูุดูุงุฏุฉ </h2><br><p style=";text-align:right;direction:rtl">  ููุง ูู ุงูุญุงู ุฏุงุฆููุง ุ ูุจุฏุฃ ุงูุชุดููุฑ ุจุงูุจุญุซ ุนู ุงูุดูุงุฏุฉ.  ูุณุชุฎุฏู ุณุนุฉ ุชุฎุฒูู ุจุฏูุงู ูุงูู ุ ูุฐูู ุณูุจุญุซ ุจุงุณุชุฎุฏุงู ุทุฑู ุนุงุฏูุฉ: </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ุจุญุซ ุงูุดูุงุฏุฉ</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt;  (   )&lt;/summary&gt; * &lt;param name="_pFindType"&gt; &lt;/param&gt; * &lt;param name="_pFindValue"&gt; &lt;/param&gt; * &lt;param name="_pLocation"&gt; &lt;/param&gt; * &lt;param name="_pName"&gt; &lt;/param&gt; * &lt;param name="_pCert"&gt; &lt;/param&gt; * &lt;param name="_sError"&gt;   &lt;/param&gt; * &lt;param name="_fVerify"&gt; &lt;/param&gt; * &lt;returns&gt;  ,  UConsts.S_OK   &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FindCertificateOS</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _pFindValue, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> X509Certificate2 _pCert, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sError, StoreLocation _pLocation = StoreLocation.CurrentUser, StoreName _pName = StoreName.My, X509FindType _pFindType = X509FindType.FindByThumbprint, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _fVerify = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">false</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">lock</span></span> (UOpenSSLAPI.pOSSection) { <span class="hljs-comment"><span class="hljs-comment">// 0)    _pCert = null; X509Store pStore = new X509Store(_pName, _pLocation); X509Certificate2Collection pCerts = null; try { // 1)   pStore.Open(OpenFlags.ReadOnly); // 2)    ( , .. Verify  Linux  false) pCerts = pStore.Certificates.Find(_pFindType, _pFindValue, false); if (pCerts.Count == 0) return UConsts.E_NO_CERTIFICATE; // 3)     if (!_fVerify) { _pCert = ISDP_X509Cert.Create(pCerts[0], TCryptoPath.cpOpenSSL); return UConsts.S_OK; } // 4)       foreach (X509Certificate2 pCert in pCerts) { ISDP_X509Cert pISDPCert = ISDP_X509Cert.Create(pCert, TCryptoPath.cpOpenSSL); if (pISDPCert.ISDPVerify()) { _pCert = pISDPCert; return UConsts.S_OK; } } return UConsts.E_NO_CERTIFICATE; } finally { if(pCerts != null) pCerts.Clear(); pStore.Close(); } } }</span></span></code> </pre></div></div><br><p style=";text-align:right;direction:rtl">  ุงูุชุจู ุฅูู ุงููุณู ุงูุญุงุณู.  ูุนูู Mono ูุน ุงูุดูุงุฏุงุช ุฃูุถูุง ูู ุฎูุงู OpenSSL ุ ูููู ููุณ ูู ุฎูุงู UOpenSSLAPI.  ุฅุฐุง ูู ุชูุนู ุฐูู ููุง ุ ููููู ุงูุญุตูู ุนูู ุชุณุฑุจ ููุฐุงูุฑุฉ ูุฃุฎุทุงุก ุนุงุฆูุฉ ุบูุฑ ูููููุฉ ุชุญุช ุงูุญูู. </p><br><p style=";text-align:right;direction:rtl">  ุงูุณูุฉ ุงูุฑุฆูุณูุฉ ูู ุฅูุดุงุก ุดูุงุฏุฉ.  ุนูู ุนูุณ ุฅุตุฏุงุฑ CryptoPro ุ ูู ูุฐู ุงูุญุงูุฉ ูุญุตู ุนูู ุงูุดูุงุฏุฉ ููุณูุง (X509Certificate2) ูู ุงููุชุฌุฑ ุ ูุงูุงุฑุชุจุงุท ุงูููุฌูุฏ ูู ุงูููุจุถ ููุฌูู ุจุงููุนู ุฅูู ุจููุฉ OpenSSL X509_st.  ูุจุฏู ุฃูู ูู ุงูุถุฑูุฑู ุ ูููู ูุง ููุฌุฏ ูุคุดุฑ ูู EVP_PKEY (ุงุฑุชุจุงุท ุจูููู ุงูููุชุงุญ ุงูุฎุงุต ูู OpenSSL) ูู ุงูุดูุงุฏุฉ. <br></p><p style=";text-align:right;direction:rtl">  ูุชู ุชุฎุฒูู ุงูููุชุงุญ ุงูุฎุงุต ููุณู ุ ููุง ุงุชุถุญ ุ ูู ุงููุณุญ ูู ุงูุญูู ุงูุฏุงุฎูู ููุดูุงุฏุฉ - impl / Fallback / _cert / _rsa / rsa.  ูุฐู ูู ูุฆุฉ RSAManaged ุ ููุธูุฑ ูุธุฑุฉ ุณุฑูุนุฉ ุนูู <a href="">ุฑูุฒูุง</a> (ุนูู ุณุจูู ุงููุซุงู ุ ุทุฑููุฉ <a href="">DecryptValue</a> ) ูุฏู ุณูุก ุฃุญุงุฏูุฉ ูุน ุงูุชุดููุฑ.  ุจุฏูุงู ูู ุงุณุชุฎุฏุงู ุชูููุงุช ุงูุชุดููุฑ OpenSSL ุจุตุฏู ุ ูุจุฏู ุฃููู ูุงููุง ุจุชูููุฐ ุงูุนุฏูุฏ ูู ุงูุฎูุงุฑุฒููุงุช ูุฏูููุง.  ูุฐุง ุงูุงูุชุฑุงุถ ูุฏุนูู ุจูุชูุฌุฉ ุจุญุซ ูุงุฑุบุฉ ููุดุฑูุนูู ูุทุฑู OpenSSL ูุซู CMS_final ุฃู CMS_sign ุฃู CMS_ContentInfo_new.  ูุจุฏูููุง ุ ูู ุงูุตุนุจ ุชุฎูู ุชุดููู ูููู ุชูููุน CMS ููุงุณู.  ูู ุงูููุช ููุณู ุ ูุชู ุงูุนูู ุนูู ุงูุดูุงุฏุงุช ุฌุฒุฆููุง ูู ุฎูุงู OpenSSL. </p><br><p style=";text-align:right;direction:rtl">  ููุฐุง ูุนูู ุฃูู ูุฌุจ ุฅูุบุงุก ุชุญููู ุงูููุชุงุญ ุงูุฎุงุต ูู mono ูุชุญูููู ุฅูู EVP_PKEY ุนุจุฑ pem.  ูุจุณุจุจ ูุฐุง ุ ูุญุชุงุฌ ูุฑุฉ ุฃุฎุฑู ุฅูู ูุฑุงุซุฉ ุงููุตู ูู X509Certificate ุ ุงูุชู ุณุชุฎุฒู ุฌููุน ุงูุฑูุงุจุท ุงูุฅุถุงููุฉ. </p><br><p style=";text-align:right;direction:rtl">  ูููุง ููู ูุฌุฑุฏ ูุญุงููุงุช ุ ููุง ูู ุงูุญุงู ูู CryptoPro ูุฅูุดุงุก ุดูุงุฏุฉ ุฌุฏูุฏุฉ ูู ุงูููุจุถ - ุฃูุถูุง ูุง ุชุคุฏู ุฅูู ุงููุฌุงุญ (ุชุนุทู ุฃุญุงุฏู ูุน ูุฌูุฏ ุฎุทุฃ) ุ ููุคุฏู ุงูุฅูุดุงุก ุนูู ุฃุณุงุณ ุงูุดูุงุฏุฉ ุงููุณุชููุฉ ุฅูู ุญุฏูุซ ุชุณุฑุจ ููุฐุงูุฑุฉ.  ูุฐูู ุ ุงูุฎูุงุฑ ุงููุญูุฏ ูู ุฅูุดุงุก ุดูุงุฏุฉ ุชุณุชูุฏ ุฅูู ุตููู ุจุงูุช ูุญุชูู ุนูู pem.  ูููู ุงูุญุตูู ุนูู ุดูุงุฏุฉ PEM ุนูู ุงููุญู ุงูุชุงูู: </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ุงูุญุตูู ุนูู ุดูุงุฏุฉ PEM</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt;  &lt;/summary&gt; * &lt;param name="_pCert"&gt;&lt;/param&gt; * &lt;param name="_arData"&gt;  &lt;/param&gt; * &lt;param name="_fBase64"&gt; Base64&lt;/param&gt; * &lt;param name="_sError"&gt;   &lt;/param&gt; * &lt;returns&gt;  ,  UConsts.S_OK   &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ToCerFile</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params"> X509Certificate2 _pCert, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] _arData, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sError, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _fBase64 = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">true</span></span></span></span></span><span class="hljs-function">)</span></span> { _arData = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] arData = _pCert.Export(X509ContentType.Cert); <span class="hljs-comment"><span class="hljs-comment">// 0) DER if (!_fBase64) { _arData = arData; return UConsts.S_OK; } // 1) Base64 using (TextWriter pWriter = new StringWriter()) { pWriter.WriteLine(UCConsts.S_PEM_BEGIN_CERT); pWriter.WriteLine(Convert.ToBase64String(arData, Base64FormattingOptions.InsertLineBreaks)); pWriter.WriteLine(UCConsts.S_PEM_END_CERT); // 1.2)   _arData = Encoding.UTF8.GetBytes(pWriter.ToString()); } return UConsts.S_OK; } catch (Exception E) { _sError = UCConsts.S_TO_PEM_ERR.Frm(E.Message); return UConsts.E_GEN_EXCEPTION; } }</span></span></code> </pre></div></div><br><p style=";text-align:right;direction:rtl">  ูุชู ุงูุญุตูู ุนูู ุงูุดูุงุฏุฉ ุจุฏูู ููุชุงุญ ุฎุงุต ููููู ุจุชูุตูููุง ุจุฃููุณูุง ุ ูุชุดููู ุญูู ูููุตู ููุงุฑุชุจุงุท ุจู ENV_PKEY: </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ุฅูุดุงุก ENV_PKEY ุจูุงุกู ุนูู ููุชุงุญ PEM ุงูุฎุงุต</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt; OpenSSL    (EVP_PKEY)    &lt;/summary&gt; * &lt;remarks&gt;      PEM&lt;/remarks&gt; * &lt;param name="_arData"&gt;   &lt;/param&gt; * &lt;returns&gt;   (EVP_PKEY)&lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> IntPtr </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetENV_PKEYOS</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] _arData</span></span></span><span class="hljs-function">)</span></span> { IntPtr hBIOPem = IntPtr.Zero; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">// 0)   BIO hBIOPem = UOpenSSLAPI.BIO_new_mem_buf( _arData, _arData.Length); if (hBIOPem == IntPtr.Zero) return IntPtr.Zero; IntPtr hKey = IntPtr.Zero; // 1)     UOpenSSLAPI.PEM_read_bio_PrivateKey(hBIOPem, ref hKey, IntPtr.Zero, 0); return hKey; } finally { if(hBIOPem != IntPtr.Zero) UOpenSSLAPI.BIO_free(hBIOPem); } }</span></span></code> </pre></div></div><br><p style=";text-align:right;direction:rtl">  ุนูุฏ ุชุญููู ุงูููุชุงุญ ุงูุฎุงุต ูู PEM ุ ุชููู ุงููููุฉ ุฃูุซุฑ ุชุนููุฏูุง ุจูุซูุฑ ูู ุดูุงุฏุฉ PEM ุ ูููููุง ููุตููุฉ ุจุงููุนู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ููุง</a> .  ูุงุญุธ ุฃู ุชูุฑูุบ ุงูููุชุงุญ ุงูุฎุงุต ูู ุนูู "ุบูุฑ ุขูู ููุบุงูุฉ" ุ ููุฌุจ ุชุฌูุจ ุฐูู ุจูู ุทุฑููุฉ.  ูุจูุง ุฃู ูุฐุง ุงูุชูุฑูุบ ูุทููุจ ููุนูู ูุน OpenSSL ุ ููู ุงูุฃูุถู ูู Windows ุงุณุชุฎุฏุงู ุฃุณุงููุจ crypt32.dll ุฃู ูุฆุงุช .Net ุงูุนุงุฏูุฉ ุนูุฏ ุงุณุชุฎุฏุงู ูุฐู ุงูููุชุจุฉ.  ูู Linux ุ ูู ุงูููุช ุงูุญุงูู ุ ุนููู ุงูุนูู ุจูุฐู ุงูุทุฑููุฉ. </p><br><p style=";text-align:right;direction:rtl">  ูู ุงูุฌุฏูุฑ ุจุงูุฐูุฑ ุฃูุถูุง ุฃู ุงูุฑูุงุจุท ุงูุชู ุชู ุฅูุดุงุคูุง ุชุดูุฑ ุฅูู ููุทูุฉ ุฐุงูุฑุฉ ุบูุฑ ููุฏุงุฑุฉ ููุฌุจ ุชุญุฑูุฑูุง.  ูุฃู  ูู .Net 4.5 X509Certificate2 ุบูุฑ ุงููุงุจู ููุชุตุฑู ุ ูุฃูุช ุจุญุงุฌุฉ ุฅูู ุงูููุงู ุจุฐูู ูู ุงููุฏูุฑ </p><br><h2 style=";text-align:right;direction:rtl">  ุงูุชูููุน </h2><br><p style=";text-align:right;direction:rtl">  ูุชุณุฌูู OpenSSL ุ ููููู ุงุณุชุฎุฏุงู ุทุฑููุฉ CMS_sign ุงููุจุณุทุฉ ุ ููุน ุฐูู ุ ูุฅูู ูุนุชูุฏ ุนูู ููู ุชูููู ูู ุงุฎุชูุงุฑ ุฎูุงุฑุฒููุฉ ุ ูุงูุชู ุณุชููู ูู ููุณูุง ูุฌููุน ุงูุดูุงุฏุงุช.  ูุฐูู ุ ูู ุงูุฃูุถู ุงูุงุนุชูุงุฏ ุนูู <a href="">ููุฏ</a> ูุฐู ุงูุทุฑููุฉ ูุชูููุฐ ุฌูู ุชูููุน ููุงุซู: </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ุชูููุน ุงูุจูุงูุงุช</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt;  &lt;/summary&gt; * &lt;param name="_arData"&gt;  &lt;/param&gt; * &lt;param name="_pCert"&gt;&lt;/param&gt; * &lt;param name="_sError"&gt;   &lt;/param&gt; * &lt;param name="_arRes"&gt; &lt;/param&gt; * &lt;returns&gt;  ,  UConsts.S_OK   &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SignDataOS</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] _arData, X509Certificate2 _pCert, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] _arRes, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sError</span></span></span><span class="hljs-function">)</span></span> { _arRes = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> iFlags = UCConsts.CMS_DETACHED; IntPtr hData = IntPtr.Zero; IntPtr hBIORes = IntPtr.Zero; IntPtr hCMS = IntPtr.Zero; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">// 0)   ISDP_X509Cert pCert = ISDP_X509Cert.Convert(_pCert, TCryptoPath.cpOpenSSL); // 1)  BIO   int iRes = GetBIOByBytesOS(_arData, out hData, ref _sError); if (iRes != UConsts.S_OK) return iRes; // 2)   BIO hBIORes = UOpenSSLAPI.BIO_new(UOpenSSLAPI.BIO_s_mem()); // 3)    hCMS = UOpenSSLAPI.CMS_ContentInfo_new(); if (hCMS == IntPtr.Zero) return RetErrOS(ref _sError, UCConsts.S_OS_CMS_CR_ERR); if (!UOpenSSLAPI.CMS_SignedData_init(hCMS)) return RetErrOS(ref _sError, UCConsts.S_OS_CMS_INIT_ERR); // 4)   if(UOpenSSLAPI.CMS_add1_signer(hCMS, pCert.hRealHandle, pCert.hOSKey, pCert.hOSDigestAlg, iFlags) == IntPtr.Zero) return RetErrOS(ref _sError, UCConsts.S_OS_CMS_SET_SIGNER_ERR); // 5)   -   if (!UOpenSSLAPI.CMS_set_detached(hCMS, 1)) return RetErrOS(ref _sError, UCConsts.S_OS_CMS_SET_DET_ERR); // 6)    if (!UOpenSSLAPI.CMS_final(hCMS, hData, IntPtr.Zero, iFlags)) return RetErrOS(ref _sError, UCConsts.S_OS_CMS_FINAL_ERR); // 7)    BIO if (!UOpenSSLAPI.i2d_CMS_bio_stream(hBIORes, hCMS, IntPtr.Zero, iFlags)) return RetErrOS(ref _sError, UCConsts.S_OS_CMS_EXP_TO_BIO_ERR); // 8)     BIO return ReadFromBIO_OS(hBIORes, out _arRes, ref _sError); } catch (Exception E) { _sError = UCConsts.S_SIGN_OS_GEN_ERR.Frm(E.Message); return UConsts.E_GEN_EXCEPTION; } finally { if(hBIORes != IntPtr.Zero) UOpenSSLAPI.BIO_free(hBIORes); if(hData != IntPtr.Zero) UOpenSSLAPI.BIO_free(hData); if(hCMS != IntPtr.Zero) UOpenSSLAPI.CMS_ContentInfo_free(hCMS); } }</span></span></code> </pre></div></div><br><p style=";text-align:right;direction:rtl">  ุชูุฏู ุงูุฎูุงุฑุฒููุฉ ุนูู ุงููุญู ุงูุชุงูู.  ุฃููุงู ุ ูู ุจุชุญููู ุงูุดูุงุฏุฉ ุงููุงุฑุฏุฉ (ุฅุฐุง ูุงูุช X509Certificate2) ุฅูู ููุนูุง.  ูุฃู  ูุธุฑูุง ูุฃููุง ูุนูู ูุน ุงูุฑูุงุจุท ุฅูู ููุทูุฉ ุฐุงูุฑุฉ ุบูุฑ ููุฏุงุฑุฉ ุ ูุฌุจ ุนูููุง ูุฑุงูุจุชูุง ุจุนูุงูุฉ.  ุจุนุฏ ูุฑูุฑ ุจุนุถ ุงูููุช ูู ุฎุฑูุฌ ุงุฑุชุจุงุท ุงูุดูุงุฏุฉ ุนู ุงููุทุงู ุ ุณูุชู ุชุดุบูู ุงููุฏูุฑ.  ูููู ูููุง ุจุงููุนู ุจุชุญุฏูุฏ ุงูุฃุณุงููุจ ุงูุถุฑูุฑูุฉ ููุณุญ ูู ุงูุฐุงูุฑุฉ ุบูุฑ ุงูููุฏุงุฑุฉ ุงููุฑุชุจุทุฉ ุจูุง ุจุฏูุฉ.  ูุณูุญ ููุง ูุฐุง ุงูููุฌ ุจุนุฏู ุฅุถุงุนุฉ ุงูููุช ูู ุชุชุจุน ูุฐู ุงูุฑูุงุจุท ูุจุงุดุฑุฉ ุฏุงุฎู ุงูุทุฑููุฉ. </p><br><p style=";text-align:right;direction:rtl">  ุจุนุฏ ุงูุชุนุงูู ูุน ุงูุดูุงุฏุฉ ุ ูุดูู ุณูุฑุฉ ุฐุงุชูุฉ ูุน ุงูุจูุงูุงุช ููููู ุงูุชูููุน.  ุซู ูุถูู ุจูุงูุงุช ุงูููููุน ุ ููุถุน ุนูุงูุฉ ููุตู ุงูุชูููุน ูุจุฏุก ุงูุชุดููู ุงูููุงุฆู ููุชูููุน.  ูุชู ููู ุงููุชูุฌุฉ ุฅูู BIO.  ูุจูู ููุท ูุงุณุชุฎุฑุงุฌ ูุฌููุนุฉ ูู ุงูุจุงูุชุงุช ูู BIO.  ุบุงูุจูุง ูุง ูุชู ุงุณุชุฎุฏุงู ุชุญููู BIO ุฅูู ูุฌููุนุฉ ูู ูุญุฏุงุช ุงูุจุงูุช ูุงูุนูุณ ุ ูุฐูู ูู ุงูุฃูุถู ูุถุนูุง ูู ุทุฑููุฉ ูููุตูุฉ: </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">BIO ุจุงูุจุงูุช [] ูุงูุนูุณ ุจุงูุนูุณ</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt;  BIO    OpenSSL&lt;/summary&gt; * &lt;param name="_hBIO"&gt; BIO&lt;/param&gt; * &lt;param name="_sError"&gt;   &lt;/param&gt; * &lt;param name="_arRes"&gt;&lt;/param&gt; * &lt;param name="_iLen"&gt; ,  0 -    &lt;/param&gt; * &lt;returns&gt;   ,  UConsts.S_OK   &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReadFromBIO_OS</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr _hBIO, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] _arRes, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sError, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _iLen = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span></span><span class="hljs-function">)</span></span> { _arRes = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[<span class="hljs-number"><span class="hljs-number">0</span></span>]; IntPtr hRes = IntPtr.Zero; <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> iLen = _iLen; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(iLen == <span class="hljs-number"><span class="hljs-number">0</span></span>) iLen = <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>.MaxValue; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">// 0)   iLen = UOpenSSLAPI.BIO_read(_hBIO, IntPtr.Zero, int.MaxValue); // 1)      hRes = Marshal.AllocHGlobal((int)iLen); if (UOpenSSLAPI.BIO_read(_hBIO, hRes, iLen) != iLen) { _sError = UCConsts.S_OS_BIO_READ_LEN_ERR; return UConsts.E_CRYPTO_ERR; } // 2)   _arRes = new byte[iLen]; Marshal.Copy(hRes, _arRes, 0, _arRes.Length); return UConsts.S_OK;; } catch (Exception E) { _sError = UCConsts.S_OS_BIO_READ_GEN_ERR.Frm(E.Message); return UConsts.E_GEN_EXCEPTION; } finally { if(hRes != IntPtr.Zero) Marshal.FreeHGlobal(hRes); } } /**&lt;summary&gt; BIO   &lt;/summary&gt; * &lt;param name="_arData"&gt;&lt;/param&gt; * &lt;param name="_hBIO"&gt;   BIO&lt;/param&gt; * &lt;param name="_sError"&gt;   &lt;/param&gt; * &lt;returns&gt;  ,  UConsts.S_OK   &lt;/returns&gt; * **/ internal static int GetBIOByBytesOS(byte[] _arData, out IntPtr _hBIO, ref string _sError) { _hBIO = UOpenSSLAPI.BIO_new_mem_buf( _arData, _arData.Length); if (_hBIO == IntPtr.Zero) return RetErrOS(ref _sError, UCConsts.S_OS_CM_BIO_CR_ERR); return UConsts.S_OK; }</span></span></code> </pre></div></div><br><p style=";text-align:right;direction:rtl">  ููุง ูู ุงูุญุงู ูู CryptoPro ุ ูู ุงูุถุฑูุฑู ุงุณุชุฎุฑุงุฌ ูุนูููุงุช ุญูู ุฎูุงุฑุฒููุฉ ุชุฌุฒุฆุฉ ุงูุชูููุน ูู ุงูุดูุงุฏุฉ.  ูููู ูู ุญุงูุฉ OpenSSL ุ ูุชู ุชุฎุฒูููุง ูุจุงุดุฑุฉ ูู ุงูุดูุงุฏุฉ: </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ุฌูุจ ุฎูุงุฑุฒููุฉ ุงูุชุฌุฒุฆุฉ</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt;      OpenSSL&lt;/summary&gt; * &lt;param name="_hCert"&gt;  (X509)&lt;/param&gt; * &lt;returns&gt; &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> IntPtr </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetDigestAlgOS</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr _hCert</span></span></span><span class="hljs-function">)</span></span> { x509_st pCert = (x509_st)Marshal.PtrToStructure(_hCert, <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(x509_st)); X509_algor_st pAlgInfo = (X509_algor_st)Marshal.PtrToStructure(pCert.sig_alg, <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(X509_algor_st)); IntPtr hAlgSn = UOpenSSLAPI.OBJ_nid2sn(UOpenSSLAPI.OBJ_obj2nid(pAlgInfo.algorithm)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UOpenSSLAPI.EVP_get_digestbyname(hAlgSn); }</code> </pre></div></div><br><p style=";text-align:right;direction:rtl">  ุงุชุถุญ ุฃู ุงูุทุฑููุฉ ุตุนุจุฉ ููุบุงูุฉ ุ ููููุง ุชุนูู.  ููููู ุงูุนุซูุฑ ุนูู ุทุฑููุฉ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">EVP_get_digestbynid</a> ูู ุงููุซุงุฆู 1.0.2 ุ ูููู ููุชุจุงุช ุงูุฅุตุฏุงุฑ ุงูุชู ูุณุชุฎุฏููุง ูุง ุชููู ุจุชุตุฏูุฑูุง.  ูุฐูู ุ ูุดูู ุฃููุงู nid ุ ูุนูู ุฃุณุงุณู ุงุณู ูุตูุฑ.  ูุจูุงุณุทุฉ ุงุณู ูุตูุฑ ุ ููููู ุงุณุชุฎุฑุงุฌ ุงูุฎูุงุฑุฒููุฉ ุจุงูุทุฑููุฉ ุงูุนุงุฏูุฉ ููุจุญุซ ุจุงูุงุณู. </p><br><h2 style=";text-align:right;direction:rtl">  ุงูุชุญูู ูู ุงูุชูููุน </h2><br><p style=";text-align:right;direction:rtl">  ูุญุชุงุฌ ุงูุชูููุน ุงููุณุชูู ุฅูู ุงูุชุญูู.  ูุชุญูู OpenSSL ูู ุงูุชูููุน ุนูู ุงููุญู ุงูุชุงูู: </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ุงูุชุญูู ูู ุงูุชูููุน</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt; &lt;/summary&gt; * &lt;param name="_arData"&gt;,   &lt;/param&gt; * &lt;param name="_arSign"&gt;&lt;/param&gt; * &lt;param name="_pCert"&gt;&lt;/param&gt; * &lt;param name="_sError"&gt;   &lt;/param&gt; * &lt;param name="_pLocation"&gt;&lt;/param&gt; * &lt;param name="_fVerifyOnlySign"&gt;  &lt;/param&gt; * &lt;returns&gt;  ,  UConsts.S_OK   &lt;/returns&gt; * &lt;remarks&gt;   &lt;/remarks&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CheckSignOS</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] _arData, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] _arSign, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> X509Certificate2 _pCert, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sError, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _fVerifyOnlySign = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">true</span></span></span></span><span class="hljs-function"><span class="hljs-params">, StoreLocation _pLocation = StoreLocation.CurrentUser</span></span></span><span class="hljs-function">)</span></span>{ _pCert = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; IntPtr hBIOData = IntPtr.Zero; IntPtr hCMS = IntPtr.Zero; IntPtr hTrStore = IntPtr.Zero; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">// 0)  BIO     int iRes = GetBIOByBytesOS(_arData, out hBIOData, ref _sError); if (iRes != UConsts.S_OK) return iRes; // 1)   CMS iRes = GetCMSFromBytesOS(_arSign, out hCMS, ref _sError); if (iRes != UConsts.S_OK) return iRes; uint iFlag = UCConsts.CMS_DETACHED; // 2)    if (!_fVerifyOnlySign) { iRes = GetTrustStoreOS(_pLocation, out hTrStore, ref _sError); if (iRes != UConsts.S_OK) return iRes; } else iFlag |= UCConsts.CMS_NO_SIGNER_CERT_VERIFY; // 3)   if (!UOpenSSLAPI.CMS_verify(hCMS, IntPtr.Zero, hTrStore, hBIOData, IntPtr.Zero, iFlag)) return RetErrOS(ref _sError, UCConsts.S_OS_CM_CHECK_ERR); return UConsts.S_OK; } finally { if(hBIOData != IntPtr.Zero) UOpenSSLAPI.BIO_free(hBIOData); if(hCMS != IntPtr.Zero) UOpenSSLAPI.CMS_ContentInfo_free(hCMS); if(hTrStore != IntPtr.Zero) UOpenSSLAPI.X509_STORE_free(hTrStore); } }</span></span></code> </pre></div></div><br><p style=";text-align:right;direction:rtl">  ุฃููุงู ุ ูุชู ุชุญููู ุจูุงูุงุช ุงูุชูููุน ูู ุตููู ุงูุจุงูุช ุฅูู ุจููุฉ CMS: <br></p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ุชุดููู ูููู CMS</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt; CMS   &lt;/summary&gt; * &lt;param name="_arData"&gt; CMS&lt;/param&gt; * &lt;param name="_hCMS"&gt;    CMS&lt;/param&gt; * &lt;param name="_sError"&gt;   &lt;/param&gt; * &lt;returns&gt;  ,  UConsts.S_OK   &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetCMSFromBytesOS</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] _arData, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> IntPtr _hCMS, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sError</span></span></span><span class="hljs-function">)</span></span> { _hCMS = IntPtr.Zero; IntPtr hBIOCMS = IntPtr.Zero; IntPtr hCMS = IntPtr.Zero; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">// 0)   CMS hCMS = UOpenSSLAPI.CMS_ContentInfo_new(); if (hCMS == IntPtr.Zero) return RetErrOS(ref _sError); if (!UOpenSSLAPI.CMS_SignedData_init(hCMS)) return RetErrOS(ref _sError); // 1)    BIO hBIOCMS = UOpenSSLAPI.BIO_new_mem_buf(_arData, _arData.Length); if (hBIOCMS == IntPtr.Zero) return RetErrOS(ref _sError); // 2)   CMS if (UOpenSSLAPI.d2i_CMS_bio(hBIOCMS, ref hCMS) == IntPtr.Zero) return RetErrOS(ref _sError); // 3)   - ,    _hCMS = hCMS; hCMS = IntPtr.Zero; return UConsts.S_OK; } finally { if(hBIOCMS != IntPtr.Zero) UOpenSSLAPI.BIO_free(hBIOCMS); if(hCMS != IntPtr.Zero) UOpenSSLAPI.CMS_ContentInfo_free(hCMS); } }</span></span></code> </pre></div></div><br><p style=";text-align:right;direction:rtl">     ,     BIO.    ,    ,        (  )      : </p><br><div class="spoiler" style=";text-align:right;direction:rtl"> <b class="spoiler_title">  </b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt;    &lt;/summary&gt; * &lt;param name="_hStore"&gt;   &lt;/param&gt; * &lt;param name="_pLocation"&gt; &lt;/param&gt; * &lt;param name="_sError"&gt;   &lt;/param&gt; * &lt;returns&gt;  ,  UConsts.S_OK   &lt;/returns&gt; */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetTrustStoreOS</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">StoreLocation _pLocation, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> IntPtr _hStore, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sError</span></span></span><span class="hljs-function">)</span></span> { _hStore = IntPtr.Zero; IntPtr hStore = IntPtr.Zero; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { List&lt;X509Certificate2&gt; pCerts = GetCertList(_pLocation, StoreName.Root, TCryptoPath.cpOpenSSL); pCerts.AddRange(GetCertList(_pLocation, StoreName.AuthRoot, TCryptoPath.cpOpenSSL)); <span class="hljs-comment"><span class="hljs-comment">// 1)   hStore = UOpenSSLAPI.X509_STORE_new(); foreach (X509Certificate2 pCert in pCerts) { //      (    ) UOpenSSLAPI.X509_STORE_add_cert(hStore, pCert.getRealHandle()); } // 2)   UOpenSSLAPI.ERR_clear_error(); _hStore = hStore; hStore = IntPtr.Zero; return UConsts.S_OK; } catch (Exception E) { _sError = UCConsts.S_FORM_TRUST_STORE_ERR.Frm(E.Message); return UConsts.E_GEN_EXCEPTION; } finally { if (hStore != IntPtr.Zero) UOpenSSLAPI.X509_STORE_free(hStore); }</span></span></code> </pre></div></div><br><p style=";text-align:right;direction:rtl">         ,         (   ,    ).     CMS_Verify,    . </p><br><p style=";text-align:right;direction:rtl">       (,       CRL),      iFlag   . </p><br><h2 style=";text-align:right;direction:rtl">    </h2><br><p style=";text-align:right;direction:rtl">               .        ,   ,           .  .Net    โ SignedCms,                   . </p><br><p style=";text-align:right;direction:rtl">        (   ,     )        .         โ     ,    . </p><br><div class="spoiler" style=";text-align:right;direction:rtl"> <b class="spoiler_title">  </b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt;  &lt;/summary&gt; * &lt;param name="_arSign"&gt;&lt;/param&gt; * &lt;param name="_sError"&gt;   &lt;/param&gt; * &lt;param name="_arContent"&gt;  &lt;/param&gt; * &lt;returns&gt;  ,  UConsts.S_OK   &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DecodeOS</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] _arSign, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] _arContent, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sError</span></span></span><span class="hljs-function">)</span></span> { IntPtr hBIOData = IntPtr.Zero; IntPtr hCMS = IntPtr.Zero; IntPtr hCerts = IntPtr.Zero; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">// 0)    MS int iRes = UCUtils.GetCMSFromBytesOS(_arSign, out hCMS, ref _sError); if(iRes != UConsts.S_OK) return iRes; iRes = UCUtils.GetBIOByBytesOS(_arContent, out hBIOData, ref _sError); if(iRes != UConsts.S_OK) return iRes; // 1)   uint iFlags = UCConsts.CMS_NO_SIGNER_CERT_VERIFY; if(_arContent.Length == 0) iFlags |= UCConsts.CMS_NO_CONTENT_VERIFY; // 2)  CMS if (!UOpenSSLAPI.CMS_verify(hCMS, IntPtr.Zero, IntPtr.Zero, hBIOData, IntPtr.Zero, iFlags)) return UCUtils.RetErrOS(ref _sError, UCConsts.S_OS_CMS_VERIFY_ERR); // 3)   hCerts = UOpenSSLAPI.CMS_get0_signers(hCMS); int iCnt = UOpenSSLAPI.sk_num(hCerts); for (int i = 0; i &lt; iCnt; i++) { IntPtr hCert = UOpenSSLAPI.sk_value(hCerts, i); byte[] arData; iRes = UCUtils.GetCertBytesOS(hCert, out arData, ref _sError); if(iRes != UConsts.S_OK) return iRes; fpCertificates.Add(ISDP_X509Cert.Create(arData, TCryptoPath.cpOpenSSL)); } // 4)   IntPtr hSigners = UOpenSSLAPI.CMS_get0_SignerInfos(hCMS); iCnt = UOpenSSLAPI.sk_num(hSigners); for (int i = 0; i &lt; iCnt; i++) { IntPtr hSignerInfo = UOpenSSLAPI.sk_value(hSigners, i); // 4.1)    ISDPSignerInfo pInfo = new ISDPSignerInfo(this); iRes = pInfo.DecodeOS(hSignerInfo, ref _sError); if(iRes != UConsts.S_OK) return iRes; fpSignerInfos.Add(pInfo); } return UConsts.S_OK; } catch (Exception E) { _sError = UCConsts.S_OS_CMS_DECODE.Frm(E.Message); return UConsts.E_GEN_EXCEPTION; } finally { if(hCerts != IntPtr.Zero) UOpenSSLAPI.sk_free(hCerts); if(hBIOData != IntPtr.Zero) UOpenSSLAPI.BIO_free(hBIOData); if(hCMS != IntPtr.Zero) UOpenSSLAPI.CMS_ContentInfo_free(hCMS); } }</span></span></code> </pre></div></div><br><p style=";text-align:right;direction:rtl">     ,      BIO     ( )   CMS,    .    ,          โ        . </p><br><p style=";text-align:right;direction:rtl">         (STACK_OF(X509)),      sk_pop,       .     ,          sk_value. </p><br><p style=";text-align:right;direction:rtl">  ,         CMS_get0_signers  CMS_get1_certs.     ,   .      ,       ,         : </p><br><pre style=";text-align:right;direction:rtl"> <code class="hljs lisp">CRYPTO_add(<span class="hljs-name"><span class="hljs-name">&amp;cch-&gt;d</span></span>.certificate-&gt;references, <span class="hljs-number"><span class="hljs-number">1</span></span>, CRYPTO_LOCK_X509)<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre><br><p style=";text-align:right;direction:rtl">   <a href="">1.1.0</a>    X509_up_ref,      . <br>         : </p><br><div class="spoiler" style=";text-align:right;direction:rtl"> <b class="spoiler_title">   </b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt;   &lt;/summary&gt; * &lt;param name="_hSignerInfo"&gt;Handler    (OpenSSL)&lt;/param&gt; * &lt;param name="_sError"&gt;   &lt;/param&gt; * &lt;returns&gt;  ,  UConsts.S_OK   &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DecodeOS</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr _hSignerInfo, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sError</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">// 0)    int iRes = UCUtils.GetSignerInfoCertOS(_hSignerInfo, fpSignedCMS.pCertificates, out fpCertificate, ref _sError); if(iRes != UConsts.S_OK) return iRes; // 1)    uint iPos = UOpenSSLAPI.CMS_signed_get_attr_by_NID(_hSignerInfo, UCConsts.NID_pkcs9_signingTime, 0); IntPtr hAttr = UOpenSSLAPI.CMS_signed_get_attr(_hSignerInfo, iPos); IntPtr hDateTime = UOpenSSLAPI.X509_ATTRIBUTE_get0_data(hAttr, 0, UCConsts.V_ASN1_UTCTIME, IntPtr.Zero); asn1_string_st pDate = (asn1_string_st)Marshal.PtrToStructure(hDateTime, typeof(asn1_string_st)); // 2)   Pkcs9SigningTime byte[] arDateAttr = new byte[pDate.iLength]; Marshal.Copy(pDate.hData, arDateAttr, 0, (int)pDate.iLength); arDateAttr = new byte[] { (byte)UCConsts.V_ASN1_UTCTIME, (byte)pDate.iLength}.Concat(arDateAttr).ToArray(); fpSignedAttributes.Add(new Pkcs9SigningTime(arDateAttr)); return UConsts.S_OK; } catch (Exception E) { _sError = UCConsts.S_CMS_SIGNER_DEC_OS_ER.Frm(E.Message); return UConsts.E_GEN_EXCEPTION; } }</span></span></code> </pre></div></div><br><p style=";text-align:right;direction:rtl">  ,    ,     .          ASN.1.      asn1_string_st         Pkcs9SigningTime. </p><br><p style=";text-align:right;direction:rtl">    : </p><br><div class="spoiler" style=";text-align:right;direction:rtl"> <b class="spoiler_title">  </b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt;  &lt;/summary&gt; * &lt;param name="_hSignerInfo"&gt;  &lt;/param&gt; * &lt;param name="_pCert"&gt; &lt;/param&gt; * &lt;param name="_pCerts"&gt;   &lt;/param&gt; * &lt;param name="_sError"&gt;   &lt;/param&gt; * &lt;returns&gt;  ,  UConsts.S_OK   &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetSignerInfoCertOS</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr _hSignerInfo, X509Certificate2Collection _pCerts, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> X509Certificate2 _pCert, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sError</span></span></span><span class="hljs-function">)</span></span> { _pCert = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">// 0)     IntPtr hKey = IntPtr.Zero; IntPtr hIssuer = IntPtr.Zero; IntPtr hSNO = IntPtr.Zero; if (!UOpenSSLAPI.CMS_SignerInfo_get0_signer_id(_hSignerInfo, ref hKey, ref hIssuer, ref hSNO)) return RetErrOS(ref _sError, UCConsts.S_GET_RECEIP_INFO_ERR); // 1)    string sSerial; int iRes = GetBinaryHexFromASNOS(hSNO, out sSerial, ref _sError); if(iRes != UConsts.S_OK) return iRes; X509Certificate2Collection pResCerts = _pCerts.Find(X509FindType.FindBySerialNumber, sSerial, false); if(pResCerts.Count == 0) return RetErrOS(ref _sError, UCConsts.S_NO_CERTIFICATE, UConsts.E_NO_CERTIFICATE); _pCert = pResCerts[0]; return UConsts.S_OK; } catch (Exception E) { _sError = UCConsts.S_GET_SIGN_INFO_GEN_ERR.Frm(E.Message); return UConsts.E_GEN_EXCEPTION; } }</span></span></code> </pre></div></div><br><p style=";text-align:right;direction:rtl">        ,          .       asn1_string_st,         hex : </p><br><div class="spoiler" style=";text-align:right;direction:rtl"> <b class="spoiler_title"> hex    ANS.1</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"> <span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt; Hex     ASN.1&lt;/summary&gt; * &lt;param name="_hASN"&gt;   ASN.1&lt;/param&gt; * &lt;param name="_sError"&gt;   &lt;/param&gt; * &lt;param name="_sHexData"&gt;   Hex&lt;/param&gt; * &lt;returns&gt;  ,  UConsts.S_OK   &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetBinaryHexFromASNOS</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr _hASN, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sHexData, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sError</span></span></span><span class="hljs-function">)</span></span> { _sHexData = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { asn1_string_st pSerial = (asn1_string_st)Marshal.PtrToStructure(_hASN, <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(asn1_string_st)); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] arStr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[pSerial.iLength]; Marshal.Copy(pSerial.hData, arStr, <span class="hljs-number"><span class="hljs-number">0</span></span>, (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)pSerial.iLength); _sHexData = arStr.ToHex().ToUpper(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UConsts.S_OK; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception E) { _sError = UCConsts.S_HEX_ASN_BINARY_ERR.Frm(E.Message); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UConsts.E_GEN_EXCEPTION; } }</code> </pre></div></div><br><p style=";text-align:right;direction:rtl">      ,      ,    . </p><br><h2 style=";text-align:right;direction:rtl">  </h2><br><p style=";text-align:right;direction:rtl">   OpenSSL    : </p><br><div class="spoiler" style=";text-align:right;direction:rtl"> <b class="spoiler_title"> </b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt; &lt;/summary&gt; * &lt;param name="_arInput"&gt;  &lt;/param&gt; * &lt;param name="_pReceipients"&gt;  &lt;/param&gt; * &lt;param name="_arRes"&gt;&lt;/param&gt; * &lt;param name="_sError"&gt;   &lt;/param&gt; * &lt;returns&gt;   ,  UConsts.S_OK   &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EncryptDataOS</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] _arInput, List&lt;X509Certificate2&gt; _pReceipients, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] _arRes, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sError</span></span></span><span class="hljs-function">)</span></span> { _arRes = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> iFlags = UCConsts.CMS_BINARY; IntPtr hData = IntPtr.Zero; IntPtr hReceipts = IntPtr.Zero; IntPtr hBIORes = IntPtr.Zero; IntPtr hCMS = IntPtr.Zero; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">// 0)  BIO     int iRes = GetBIOByBytesOS(_arInput, out hData, ref _sError); if (iRes != UConsts.S_OK) return iRes; // 1)     iRes = GetCertsStackOS(_pReceipients, out hReceipts, ref _sError); if (iRes != UConsts.S_OK) return iRes; // 2)  CMS hCMS = UOpenSSLAPI.CMS_encrypt(hReceipts, hData, UOpenSSLAPI.EVP_des_ede3_cbc(), iFlags); if (hCMS == IntPtr.Zero) return RetErrOS(ref _sError, UCConsts.S_ENC_CMS_ERR); // 3)  CMS  BIO hBIORes = UOpenSSLAPI.BIO_new(UOpenSSLAPI.BIO_s_mem()); if (!UOpenSSLAPI.i2d_CMS_bio_stream(hBIORes, hCMS, IntPtr.Zero, iFlags)) return RetErrOS(ref _sError, UCConsts.S_OS_CMS_EXP_TO_BIO_ERR); // 4)   BIO    return ReadFromBIO_OS(hBIORes, out _arRes, ref _sError); } catch (Exception E) { _sError = UCConsts.S_ENC_OS_GEN_ERR.Frm(E.Message); return UConsts.E_GEN_EXCEPTION; } finally { if(hBIORes != IntPtr.Zero) UOpenSSLAPI.BIO_free(hBIORes); if(hData != IntPtr.Zero) UOpenSSLAPI.BIO_free(hData); if(hCMS != IntPtr.Zero) UOpenSSLAPI.CMS_ContentInfo_free(hCMS); if(hReceipts != IntPtr.Zero) UOpenSSLAPI.sk_free(hReceipts); } }</span></span></code> </pre></div></div><br><p style=";text-align:right;direction:rtl">    BIO      โ .        .    ,       BIO    . OpenSSL      ,    ,    ,   .          EVP_des_ede3_cbc,       . </p><br><p style=";text-align:right;direction:rtl">         , . .           OpenSSL: </p><br><div class="spoiler" style=";text-align:right;direction:rtl"> <b class="spoiler_title">  </b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt;  &lt;/summary&gt;* &lt;param name="_hStack"&gt; &lt;/param&gt; * &lt;param name="_pCerts"&gt; &lt;/param&gt; * &lt;param name="_sError"&gt;   &lt;/param&gt; * &lt;returns&gt;  ,  UConsts.S_OK   &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetCertsStackOS</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">List&lt;X509Certificate2&gt; _pCerts, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> IntPtr _hStack, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sError</span></span></span><span class="hljs-function">)</span></span> { _hStack = IntPtr.Zero; IntPtr hStack = IntPtr.Zero; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { hStack = UOpenSSLAPI.sk_new_null(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (X509Certificate2 pCert <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> _pCerts) { <span class="hljs-comment"><span class="hljs-comment">// 0)  ,     ISDP_X509Cert pLocCert = ISDP_X509Cert.Convert(pCert, TCryptoPath.cpOpenSSL); // 1)  UOpenSSLAPI.sk_push(hStack, pLocCert.hRealHandle); } _hStack = hStack; hStack = IntPtr.Zero; return UConsts.S_OK; } catch (Exception E) { _sError = UCConsts.S_GEN_CERT_STACK_ERR.Frm(E.Message); return UConsts.E_GEN_EXCEPTION; } finally { if(hStack != IntPtr.Zero) UOpenSSLAPI.sk_free(hStack); } }</span></span></code> </pre></div></div><br><h2 style=";text-align:right;direction:rtl">  </h2><br><p style=";text-align:right;direction:rtl">     ,        .      : </p><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl"> ,       ; </li><li style=";text-align:right;direction:rtl">   ; </li><li style=";text-align:right;direction:rtl">           ; </li><li style=";text-align:right;direction:rtl">     ; </li><li style=";text-align:right;direction:rtl">      BIO    ; </li></ol><br><div class="spoiler" style=";text-align:right;direction:rtl"> <b class="spoiler_title"> </b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt; &lt;/summary&gt; * &lt;param name="_arInput"&gt;  &lt;/param&gt; * &lt;param name="_arRes"&gt;&lt;/param&gt; * &lt;param name="_pLocation"&gt; ,  &lt;/param&gt; * &lt;param name="_sError"&gt;   &lt;/param&gt; * &lt;param name="_pCert"&gt;&lt;/param&gt; * &lt;returns&gt;  ,  UCOnsts.S_OK   &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DecryptDataOS</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] _arInput, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> X509Certificate2 _pCert, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] _arRes, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sError, StoreLocation _pLocation = StoreLocation.CurrentUser </span></span></span><span class="hljs-function">)</span></span> { _arRes = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[<span class="hljs-number"><span class="hljs-number">0</span></span>]; _pCert = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> iFlag = UCConsts.CMS_BINARY; IntPtr hBIORes = IntPtr.Zero; IntPtr hCMS = IntPtr.Zero; X509Certificate2 pCert; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">// 0)   CMS int iRes = GetCMSFromBytesOS(_arInput, out hCMS, ref _sError); if (iRes != UConsts.S_OK) return iRes; // 1)     IntPtr hReceipts = UOpenSSLAPI.CMS_get0_RecipientInfos(hCMS); int iCnt = UOpenSSLAPI.sk_num(hReceipts); for(int i = 0; i &lt; iCnt; i++) { IntPtr hRecep = UOpenSSLAPI.sk_value(hReceipts, i); iRes = GetRecepInfoCertOS(hRecep, _pLocation, out pCert, ref _sError); if (iRes != UConsts.S_OK &amp;&amp; iRes != UConsts.E_NO_CERTIFICATE) return iRes; // 1.1)   if (iRes == UConsts.E_NO_CERTIFICATE) continue; ISDP_X509Cert pLocCert = ISDP_X509Cert.Convert(pCert); // 1.2)    if (pLocCert.hOSKey == IntPtr.Zero) continue; // 1.3)   if (!UOpenSSLAPI.CMS_RecipientInfo_set0_pkey(hRecep, pLocCert.hOSKey)) return RetErrOS(ref _sError, UCConsts.S_OS_CMS_SET_DEC_KEY_ERR); try { // 1.4)  if (!UOpenSSLAPI.CMS_RecipientInfo_decrypt(hCMS, hRecep)) return RetErrOS(ref _sError, UCConsts.S_OS_CMS_REC_DEC_ERR); } finally { // !!      UOpenSSLAPI.CMS_RecipientInfo_set0_pkey(hRecep, IntPtr.Zero); } // 1.5)   hBIORes = UOpenSSLAPI.BIO_new(UOpenSSLAPI.BIO_s_mem()); if (!UOpenSSLAPI.CMS_decrypt(hCMS, IntPtr.Zero, pLocCert.hRealHandle, IntPtr.Zero, hBIORes, iFlag)) return RetErrOS(ref _sError, UCConsts.S_OS_CMS_FULL_DEC_ERR); _pCert = pLocCert; // 2)     BIO return ReadFromBIO_OS(hBIORes, out _arRes, ref _sError); } _sError = UCConsts.S_DEC_NO_CERT_ERR; return UConsts.E_NO_CERTIFICATE; } catch (Exception E) { _sError = UCConsts.S_DEC_GEN_ERR.Frm(E.Message); return UConsts.E_GEN_EXCEPTION; } finally { if(hBIORes != IntPtr.Zero) UOpenSSLAPI.BIO_free(hBIORes); if(hCMS != IntPtr.Zero) UOpenSSLAPI.CMS_ContentInfo_free(hCMS); } }</span></span></code> </pre></div></div><br><p style=";text-align:right;direction:rtl">        .   ,          CMS_RecipientInfo_set0_pkey,       CMS,            . </p><br><p style=";text-align:right;direction:rtl">  ,   ,       .        ,        .        : </p><br><div class="spoiler" style=";text-align:right;direction:rtl"> <b class="spoiler_title">  </b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt;  &lt;/summary&gt; * &lt;param name="_hRecep"&gt;  &lt;/param&gt; * &lt;param name="_pCert"&gt; &lt;/param&gt; * &lt;param name="_pLocation"&gt;   &lt;/param&gt; * &lt;param name="_sError"&gt;   &lt;/param&gt; * &lt;returns&gt;  ,  UConsts.S_OK   &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetRecepInfoCertOS</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr _hRecep, StoreLocation _pLocation, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> X509Certificate2 _pCert, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sError</span></span></span><span class="hljs-function">)</span></span> { _pCert = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">// 0)     IntPtr hKey = IntPtr.Zero; IntPtr hIssuer = IntPtr.Zero; IntPtr hSNO = IntPtr.Zero; if (!UOpenSSLAPI.CMS_RecipientInfo_ktri_get0_signer_id(_hRecep, ref hKey, ref hIssuer, ref hSNO)) return RetErrOS(ref _sError, UCConsts.S_GET_RECEIP_INFO_ERR); // 1)    string sSerial; int iRes = GetBinaryHexFromASNOS(hSNO, out sSerial, ref _sError); if(iRes != UConsts.S_OK) return iRes; // 2)   iRes = FindCertificateOS(sSerial, out _pCert, ref _sError, _pLocation, StoreName.My, X509FindType.FindBySerialNumber); if(iRes != UConsts.S_OK) return iRes; return UConsts.S_OK; } catch (Exception E) { _sError = UCConsts.S_GET_RECEIP_INFO_GEN_ERR.Frm(E.Message); return UConsts.E_GEN_EXCEPTION; } }</span></span></code> </pre></div></div><br><p style=";text-align:right;direction:rtl">  CMS_RecipientInfo_ktri_get0_signer_id     ,        hSNO        .      . </p><br><p style=";text-align:right;direction:rtl"> C  ,  ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="></a> .          ktri โ      .      OpenSSL    : CMS_RecipientInfo_kari_*, CMS_RecipientInfo_kekri_*   CMS_RecipientInfo_set0_password  pwri. </p><br><h2 style=";text-align:right;direction:rtl">   </h2><br><p style=";text-align:right;direction:rtl">      ,          .               .        , . .         .  OpenSSL     .         (    ),      ,      . <br></p><p style=";text-align:right;direction:rtl"> ,  ,   ,           : </p><br><div class="spoiler" style=";text-align:right;direction:rtl"> <b class="spoiler_title"> </b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt;    OpenSSL&lt;/summary&gt; * &lt;param name="_iRevFlag"&gt; &lt;/param&gt; * &lt;param name="_iRevMode"&gt; &lt;/param&gt; * &lt;param name="_hCert"&gt; &lt;/param&gt; * &lt;param name="_rOnDate"&gt; &lt;/param&gt; * &lt;param name="_pLocation"&gt; &lt;/param&gt; * &lt;param name="_sError"&gt;   &lt;/param&gt; * &lt;returns&gt;  ,  UConsts.S_OK   &lt;/returns&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">VerifyCertificateOS</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr _hCert, X509RevocationMode _iRevMode, X509RevocationFlag _iRevFlag, StoreLocation _pLocation, DateTime _rOnDate, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _sError</span></span></span><span class="hljs-function">)</span></span> { IntPtr hStore = IntPtr.Zero; IntPtr hStoreCtx = IntPtr.Zero; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">// 0)   int iRes = GetTrustStoreOS(_pLocation, out hStore, ref _sError); if(iRes != UConsts.S_OK) return iRes; // 1)    hStoreCtx = UOpenSSLAPI.X509_STORE_CTX_new(); if (!UOpenSSLAPI.X509_STORE_CTX_init(hStoreCtx, hStore, _hCert, IntPtr.Zero)) { _sError = UCConsts.S_CRYPTO_CONTEXT_CER_ERR; return UConsts.E_CRYPTO_ERR; } // 2)       SetStoreCtxCheckDate(hStoreCtx, _rOnDate); // 3)  if (!UOpenSSLAPI.X509_verify_cert(hStoreCtx)) { _sError = UCConsts.S_CRYPTO_CHAIN_CHECK_ERR.Frm(GetCertVerifyErr(hStoreCtx)); return UConsts.E_CRYPTO_ERR; } return UConsts.S_OK; } finally { if (hStore != IntPtr.Zero) UOpenSSLAPI.X509_STORE_free(hStore); if (hStoreCtx != IntPtr.Zero) UOpenSSLAPI.X509_STORE_CTX_free(hStoreCtx); } }</span></span></code> </pre></div></div><br><p style=";text-align:right;direction:rtl">     (X509_STORE_CTX)     .      : </p><br><div class="spoiler" style=";text-align:right;direction:rtl"> <b class="spoiler_title">    </b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**&lt;summary&gt;   &lt;/summary&gt; * &lt;param name="_hStoreCtx"&gt; &lt;/param&gt; * &lt;param name="_rDate"&gt;&lt;/param&gt; * **/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetStoreCtxCheckDate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr _hStoreCtx, DateTime _rDate</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> iFlags = UCConsts.X509_V_FLAG_USE_CHECK_TIME | UCConsts.X509_V_FLAG_X509_STRICT | UCConsts.X509_V_FLAG_CRL_CHECK_ALL; <span class="hljs-comment"><span class="hljs-comment">//   UOpenSSLAPI.X509_STORE_CTX_set_flags(_hStoreCtx, iFlags); //   UOpenSSLAPI.X509_STORE_CTX_set_time(_hStoreCtx, iFlags, (uint)_rDate.ToUnix()); //   -   UOpenSSLAPI.X509_STORE_CTX_set_trust(_hStoreCtx, UCConsts.X509_TRUST_TRUSTED); }</span></span></code> </pre></div></div><br><p style=";text-align:right;direction:rtl">     ,           . </p><br><h1 style=";text-align:right;direction:rtl">  ุงูุฎูุงุตุฉ </h1><br><p style=";text-align:right;direction:rtl">     ,      .       X509Certificate2 (mono)      .      . </p><br><p style=";text-align:right;direction:rtl">   ,  Windows              .       .  Linux ,        ,        . </p><br><p style=";text-align:right;direction:rtl">       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">CSP 5.0</a> ,     RSA .      ,     ,   ,          RSA, ,    . </p><br><h1 style=";text-align:right;direction:rtl">  ุงููุฑุงุฌุน </h1><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl"> OpenSSL 1.0.2 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ManPages</a> ; </li><li style=";text-align:right;direction:rtl">   OpenSSL <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">1</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">2</a> ; </li><li style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">OpenSSL</a> : <br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl"> <a href="">cms_smime.c;</a> </li></ol></li><li style=";text-align:right;direction:rtl"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">Wiki OpenSSL</a> ; </li><li style=";text-align:right;direction:rtl">  mono: <ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  <a href="">RSAManaged</a> ; </li></ol><br></li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar423769/">https://habr.com/ru/post/ar423769/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar423753/index.html">ุงูุญูุงุธ ุนูู ุฑููุฒ ุงูุชูููุถ ุขููุฉ</a></li>
<li><a href="../ar423759/index.html">Fintech-digest: ุงูุจูุงูุงุช ุงูุดุฎุตูุฉ ูููุงุทูู ุงูุงุชุญุงุฏ ุงูุฑูุณู ุ ูุณูู ุงูุจูู ุงููุฑูุฒู ุ ุฎุฏูุฉ ุฌุฏูุฏุฉ ูู CloudFlare</a></li>
<li><a href="../ar423763/index.html">ูุง ูุนููู Uber Cash ุงููุจุฏุนูู</a></li>
<li><a href="../ar423765/index.html">ูุญู ููุชุจ ุทูุจูุง ููุชุญูู ุนู ุจูุนุฏ ูู ูุดุบู MPV ูู RetroOrangePi</a></li>
<li><a href="../ar423767/index.html">ูุงุฌู ูุฑุงุตูุฉ ุดุฑูุฉ ุงูุฎุทูุท ุงูุฌููุฉ ุงูุจุฑูุทุงููุฉ: ุณุฑูุช 380ุ000 ุจุทุงูุฉ ูุตุฑููุฉ ููุนููุงุก</a></li>
<li><a href="../ar423771/index.html">ูุฑุฉ ุฃุฎุฑู ุ ุชุจูู ุฃู ูุญูู PVS-Studio ุฃูุซุฑ ุงูุชุจุงููุง ูู ุงูุดุฎุต</a></li>
<li><a href="../ar423775/index.html">ุฃุฑุฏุช ูุทุนุฉ ุญุฏูุฏ ุฌูููุฉ. ุงุชุถุญ</a></li>
<li><a href="../ar423777/index.html">Keystone Project: ุจูุฆุฉ ููุซููุฉ ูุชุดุบูู ุงูุชุทุจููุงุช ุงููุณุชูุฏุฉ ุฅูู RISC-V</a></li>
<li><a href="../ar423779/index.html">ุงููุณุฎ ุงูุงุญุชูุงุทู ูู ุงูุณุญุงุจุฉ ุฅูู ุงูุณุญุงุจุฉ: ูุง ูู ูููุงุฐุง ูู ูุทููุจ</a></li>
<li><a href="../ar423781/index.html">ููุงุญุธุงุช ูููุฑ ุฅูุชุฑูุช ุงูุฃุดูุงุก. ุงูุญุงูุฉ: ูู ุจุฅูุดุงุก ุดุจูุฉ LoRa ูููุฒุน ุงููููุฏ ูู ุชุดูููุงุจููุณู</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>