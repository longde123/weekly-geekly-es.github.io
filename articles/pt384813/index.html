<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üìã üëÜüèº ü•ò Adaptador PPM para USB no STM32F3Discovery, ou Conectamos o console do modelo da aeronave ao computador como um joystick HID com o STM32Cube üöì ü§ôüèΩ üñïüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Neste artigo, mostrarei como:
 

- Crie um projeto no STM32CubeMX e configure temporizadores para capturar sinais externos. 
- Decodifique um sinal PP...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Adaptador PPM para USB no STM32F3Discovery, ou Conectamos o console do modelo da aeronave ao computador como um joystick HID com o STM32Cube</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/384813/"><img src="https://habrastorage.org/files/42a/e17/45b/42ae1745bcc442529f2839504fdf51f4.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Neste artigo, mostrarei como:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Crie um projeto no STM32CubeMX e configure temporizadores para capturar sinais externos. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Decodifique um sinal PPM a partir de um console de modelo de aeronave. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Crie o dispositivo de interface humana no STM32 e escreva seu descritor de relat√≥rio HID. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Voe em um simulador em um quadrocopter de corrida. </font><font style="vertical-align: inherit;">:)</font></font></li>
</ul><a name="habracut"></a><br>
<h3><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pref√°cio</font></font></b></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Recentemente, corridas de FPV em quadrocopters da 250¬™ classe (FPV - First Person View) est√£o ganhando cada vez mais popularidade. </font><font style="vertical-align: inherit;">O n√∫mero 250 significa a dist√¢ncia entre os eixos dos motores na diagonal, t√≠pica de pequenos helic√≥pteros manobr√°veis. </font><font style="vertical-align: inherit;">Tais dispositivos s√£o constru√≠dos sobre estruturas de carbono dur√°veis ‚Äã‚Äãque suportam quedas e colis√µes. </font><font style="vertical-align: inherit;">H√©lices com di√¢metro de 5 a 6 polegadas com um grande passo (√¢ngulo de inclina√ß√£o das p√°s) s√£o colocadas em motores potentes para o v√¥o mais din√¢mico. </font><font style="vertical-align: inherit;">A imagem da c√¢mera de v√≠deo com cabe√ßalho anal√≥gico √© transmitida a uma frequ√™ncia de 5,8 GHz para o monitor ou √≥culos de v√≠deo do piloto. </font><font style="vertical-align: inherit;">Como a transmiss√£o digital via WiFi cria um longo atraso (200 a 300 ms), o v√≠deo √© sempre transmitido em um canal anal√≥gico. </font><font style="vertical-align: inherit;">Para gravar clipes espetaculares, as c√¢meras de a√ß√£o s√£o colocadas a bordo (GoPro, Mobius, SJcam, Xiaomi Yi, etc.).</font></font><br>
<br>
<div style="text-align:center;"><img width="40%" src="https://habrastorage.org/files/727/722/0e5/7277220e5a8c4b749415d16d28091648.jpg"></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aqui est√£o alguns v√≠deos interessantes sobre helic√≥pteros FPV:</font></font></b><div class="spoiler_text"><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://www.youtube.com/embed/NsxyV-kgfio%3Ffeature%3Doembed&amp;usg=ALkJrhikMAL4ivIU_CKMz9CJNrYOoMo78g" frameborder="0" allowfullscreen=""></iframe><br>
<iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://www.youtube.com/embed/1MBW8zoZUR4%3Ffeature%3Doembed&amp;usg=ALkJrhieQvICO_KJS3iqFSMF4-Xg5y0MZg" frameborder="0" allowfullscreen=""></iframe><br>
<iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://www.youtube.com/embed/70pusNNunMA%3Ffeature%3Doembed&amp;usg=ALkJrhj3WxTxrGUz_s8dhK_YE4JKIfopVw" frameborder="0" allowfullscreen=""></iframe></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Antes de montar meu mini quadrocopter, eu queria voar em um simulador e ver se estaria interessado em corridas de FPV. Para treinamento, o simulador </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FPV FreeRider</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© adequado </font><font style="vertical-align: inherit;">. √â barato, possui uma vers√£o demo gratuita e, de acordo com pilotos experientes, imita com muita precis√£o a mec√¢nica real do voo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ pode controlar a aeronave no simulador a partir do teclado ou do joystick. O teclado √© pouco adequado para pilotagem, pois os bot√µes podem transmitir apenas um valor discreto (o bot√£o √© pressionado / n√£o pressionado) e √© imposs√≠vel transmitir suavemente os valores intermedi√°rios alterados. Os joysticks de consoles de jogos com man√≠pulos anal√≥gicos s√£o muito melhores, mas possuem um man√≠pulo muito pequeno, o que n√£o permite que voc√™ controle o dispositivo com precis√£o. Uma op√ß√£o ideal para um simulador √© um console de modelo de aeronave conectado a um computador atrav√©s de um adaptador especial, gra√ßas ao qual o sistema operacional o v√™ como um joystick.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu j√° tinha um quadroc√≥ptero, montado para voos e fotografias de lazer, mas muito grande e pesado para corridas. Consequentemente, havia um controle remoto - Turnigy 9X (na primeira ilustra√ß√£o). Na parte traseira, possui um conector para conectar um adaptador ao qual √© emitido um sinal PPM. Este sinal √© um pulso curto com intervalos de 1 a 2 milissegundos, cuja dura√ß√£o corresponde √† posi√ß√£o dos controles (mais sobre isso na se√ß√£o sobre decodifica√ß√£o).</font></font><br>
<br>
<div style="text-align:center;"><img width="33%" src="https://habrastorage.org/files/68b/cc1/4f0/68bcc14f02164d51a17401da82253df4.jpg"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Devo dizer que os adaptadores para conectar o controle remoto do PPM ao USB foram lan√ßados h√° muito tempo e est√£o sendo vendidos com for√ßa e principal. </font><font style="vertical-align: inherit;">Um adaptador semelhante no formato flash drive pode ser comprado por US $ 5 na China ou um pouco mais caro nas lojas russas. </font><font style="vertical-align: inherit;">Tamb√©m existem </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">projetos de</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> adaptador de </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">c√≥digo aberto</font></a><font style="vertical-align: inherit;"> nos controladores AVR. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas um desejo agudo de voar imediatamente me ocorreu no final da noite, quando todas as lojas de modelos de avi√µes de Moscou j√° estavam fechadas. </font><font style="vertical-align: inherit;">Como n√£o queria esperar pela manh√£, n√£o havia tempo para envenenar e soldar a placa com o ATmega, por isso decidi fazer um adaptador PPM-USB na placa STM32F3Discovery, que estava inativa e estava √† m√£o.</font></font><br>
<br>
<h3><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O que √© solicitado</font></font></b></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para fazer um adaptador, voc√™ precisar√° de:</font></font><br>
<br>
<ul>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">STM32F3Discovery</a>.     STM32,     USB,   . </li>
<li>  c - 3,5     ( Turnigy)   BLS-,   ,   ( Discovery).</li>
<li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">STM32CubeMX</a>. </li>
<li>IDE    ARM.   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Keil uVision 5</a>.          32 ,      .</li>
<li> Turnigy 9X     PPM-.       FlySky FS-i6.</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As placas de depura√ß√£o de descoberta s√£o muito caras. </font><font style="vertical-align: inherit;">O F3 descrito custa cerca de US $ 20 e suas capacidades s√£o redundantes para um projeto t√£o simples. </font><font style="vertical-align: inherit;">Eu o usei porque, no momento em que escrevi, essa era a √∫nica placa com hardware USB que encontrei em casa. </font><font style="vertical-align: inherit;">Para aqueles que ainda n√£o o compraram, posso aconselh√°-lo a prestar aten√ß√£o √†s placas em miniatura com o controlador </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">STM32F103C8T6 do AliExpress por US $ 3</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e o programador ST-Link de l√°. </font><font style="vertical-align: inherit;">O processo n√£o difere daquele descrito no artigo. </font><font style="vertical-align: inherit;">A menos que seja necess√°rio escolher outro controlador no in√≠cio, indicar a presen√ßa de um ressonador de quartzo e usar uma pinagem ligeiramente diferente.</font></font><br>
<br>
<div style="text-align:center;"><img width="30%" src="https://habrastorage.org/files/cf1/88d/0a1/cf188d0a1da94acfb233350ff94830ae.jpg"></div><br>
<br>
<a name="cube"></a><h3><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Criando um projeto no STM32CubeMX</font></font></b></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
STM32Cube √© um pacote desenvolvido pela STMicroelectronics para facilitar a vida dos desenvolvedores de dispositivos STM32. Ele consiste no utilit√°rio de gr√°ficos CubeMX, drivers HAL e componentes de Middleware. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O CubeMX</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© uma ferramenta para criar projetos e inicializar perif√©ricos. Para come√ßar, basta selecionar o controlador, marque as caixas dos m√≥dulos necess√°rios, selecione os modos necess√°rios no menu e insira os valores desejados em v√°rios campos. O CubeMX ir√° gerar o projeto e conectar as bibliotecas necess√°rias a ele. O desenvolvedor do dispositivo escrever√° apenas a l√≥gica do aplicativo. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Drivers HAL</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(Camada de abstra√ß√£o de hardware) √© uma API para trabalhar com m√≥dulos e perif√©ricos do microcontrolador. O HAL permite separar a camada superior do aplicativo que o desenvolvedor cria do trabalho com registradores e tornar o c√≥digo do programa o mais port√°til poss√≠vel entre as fam√≠lias de controladores STM32. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Os middlewares</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou componentes intermedi√°rios incluem o sistema operacional FreeRTOS, uma biblioteca para trabalhar com o sistema de arquivos, bibliotecas USB, TCP / IP, etc.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parece que agora √© poss√≠vel "programar com o mouse" em vez de escrever manualmente os bits nos registros. </font><font style="vertical-align: inherit;">Mas a simplicidade e a conveni√™ncia n√£o cancelam o fato de que voc√™ precisa estudar a documenta√ß√£o, especialmente nos casos em que voc√™ precisa reduzir a velocidade m√°xima, o consumo m√≠nimo de energia ou usar perif√©ricos em modos fora do padr√£o. </font><font style="vertical-align: inherit;">O STM32Cube ainda n√£o cobre 100% de todos os recursos do microcontrolador, mas est√° se aproximando disso. </font><font style="vertical-align: inherit;">A STMicroelectronics atualiza o Cube de tempos em tempos, estende fun√ß√µes e corrige bugs. </font><font style="vertical-align: inherit;">Portanto, se voc√™ j√° possui o Cube instalado, verifique se √© a vers√£o mais recente.</font></font><br>
<br>
<h5><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configura√ß√µes iniciais</font></font></b></h5><br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/acf/6b2/4fc/acf6b24fc6c449f58c2be3b9ce9d1c1e.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O trabalho com o projeto come√ßa com a escolha do controlador. Inicie o STM32CubeMX, clique em </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Novo Projeto</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Na guia </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Seletor</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> do </font><i><font style="vertical-align: inherit;">MCU</font></i><font style="vertical-align: inherit;"> , </font><font style="vertical-align: inherit;">voc√™ pode selecionar o controlador desejado nos filtros. Como temos uma placa de depura√ß√£o conclu√≠da, na guia </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Seletor de </font></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">placas</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , encontramos </font><i><font style="vertical-align: inherit;">STM32F3Discovery</font></i><font style="vertical-align: inherit;"> . Depois de escolher um quadro, uma imagem do controlador com pinos destacados e assinados ser√° exibida. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existem quatro abas grandes na parte superior da janela: </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pinagem</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - para configurar as fun√ß√µes de pinos e pr√©-configurar os m√≥dulos. Estamos nisso no momento. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configura√ß√£o do</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> rel√≥gio - ajuste do rel√≥gio, PLL, divisores. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configura√ß√£o</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font><i><font style="vertical-align: inherit;">configura√ß√£o</font></i><font style="vertical-align: inherit;"> mais detalhada de perif√©ricos e middleware.</font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Calculadora de consumo de energia</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - c√°lculo da energia consumida pelo microcontrolador. </font></font><br>
<br>
<img src="https://habrastorage.org/files/d02/a54/3a7/d02a543a7fe148d99d67ae83ad6a8fc9.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No menu esquerdo da guia </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pinagem</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font><i><font style="vertical-align: inherit;">voc√™</font></i><font style="vertical-align: inherit;"> pode usar os perif√©ricos desejados e, no circuito do controlador, selecionar uma fun√ß√£o para qualquer uma das sa√≠das do microcontrolador. Alguns itens √† esquerda s√£o √≠cones de aviso. Isso significa que os m√≥dulos (neste caso ADC, DAC, OPAMP2, RTC) agora podem ser usados ‚Äã‚Äãincompletamente, pois algumas de suas sa√≠das j√° est√£o ocupadas por outras fun√ß√µes.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os pinos configurados s√£o destacados em verde no circuito do controlador. </font><font style="vertical-align: inherit;">Como escolhemos n√£o um controlador simples sem amarra√ß√£o, mas uma placa de depura√ß√£o F3-Discovery pronta para o uso, algumas das sa√≠das j√° est√£o configuradas, por exemplo, um bot√£o azul √© conectado ao PA0 e os LEDs ao PE8 ... 15. </font><font style="vertical-align: inherit;">Os pinos aos quais alguns dispositivos externos est√£o conectados no Discovery s√£o destacados em laranja, mas os m√≥dulos perif√©ricos para eles ainda n√£o foram configurados. </font><font style="vertical-align: inherit;">Como voc√™ pode ver, s√£o pinos para USB, ressonadores de quartzo, SPI e I2C para girosc√≥pio e b√∫ssola, DP e DM para USB. </font><font style="vertical-align: inherit;">Atualmente, conclus√µes cinzentas n√£o s√£o usadas, nenhuma delas podemos aplicar para nossos prop√≥sitos.</font></font><br>
<br>
<h5><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sele√ß√£o de entrada</font></font></b></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√≥s vamos capturar a dura√ß√£o dos pulsos, ent√£o a entrada deve estar conectada a um dos canais de qualquer timer. </font><font style="vertical-align: inherit;">Al√©m disso, o n√≠vel de sinal do Turnigy 9X n√£o √© de 3,3V, como a tens√£o de alimenta√ß√£o do STM32, mas de 5V. </font><font style="vertical-align: inherit;">Estamos com pregui√ßa de soldar o divisor de tens√£o, ent√£o voc√™ precisa escolher uma entrada que possa suportar 5V (essas entradas s√£o chamadas tolerantes a 5V). </font><font style="vertical-align: inherit;">Os pinos adequados podem ser encontrados na </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">folha</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">dados</font></a><font style="vertical-align: inherit;"> em STM32F303VCT6 na se√ß√£o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pinagens e descri√ß√£o dos pinos</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Existem muitos temporizadores no STM32F3, eles est√£o espalhados por quase todos os pinos. </font><font style="vertical-align: inherit;">Uma op√ß√£o conveniente √© o PC6. </font><font style="vertical-align: inherit;">Ele suporta 5 volts e est√° localizado no canto inferior esquerdo da placa, ao lado de GND. </font><font style="vertical-align: inherit;">Atribua o 1¬∫ canal do 3¬∫ temporizador TIM3_CH1 a este pino.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/eb7/4b2/67e/eb74b267e70140b9842408158de617e8.png"></div><br>
<br>
<h5><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Acerto do rel√≥gio</font></font></b></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para que o USB funcione, o microcontrolador deve ter uma freq√º√™ncia muito est√°vel, raz√£o pela qual quase todos os dispositivos USB t√™m ressonadores de quartzo. A estabilidade da frequ√™ncia do gerador RC embutido n√£o √© suficiente para USB. Mas na placa STM32F3 Discovery, os desenvolvedores, por algum motivo, eram gananciosos e n√£o colocaram quartzo. No entanto, se voc√™ estudar cuidadosamente o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">circuito</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , poder√° ver que o </font><font style="vertical-align: inherit;">sinal </font><i><font style="vertical-align: inherit;">MCO</font></i><font style="vertical-align: inherit;"> est√° conectado </font><font style="vertical-align: inherit;">√† entrada </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PF0-OSC_IN</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , onde o quartzo deve ser conectado </font><font style="vertical-align: inherit;">. Ele vem do programador ST-Link na mesma placa em que h√° quartzo. O </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">Manual do Usu√°rio</font></a><font style="vertical-align: inherit;"> da Descoberta F3 (UM1570) na se√ß√£o </font><i><font style="vertical-align: inherit;">Rel√≥gio</font></i><font style="vertical-align: inherit;"> do </font><i><font style="vertical-align: inherit;">OSC</font></i><font style="vertical-align: inherit;"> diz que 8 MHz est√£o sendo </font><font style="vertical-align: inherit;">enviados </font><font style="vertical-align: inherit;">para esta linha.</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br>
<br>
<img width="30%" src="https://habrastorage.org/files/b5c/234/80f/b5c23480ffca498d8e52e6fef4c0892f.png"><img width="65%" src="https://habrastorage.org/files/c00/160/fb8/c00160fb809b4c7190390d8a8ccd3ac6.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Assim, o microcontrolador tem clock de uma fonte externa. Esse modo √© chamado de desvio. No menu de configura√ß√µes perif√©ricas na se√ß√£o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RCC</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font><font style="vertical-align: inherit;">para registrar o rel√≥gio de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">alta velocidade,</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> selecione </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Origem do rel√≥gio BYPASS</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/files/934/7e5/17e/9347e517e21540a88c922d35d881c009.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Antes de prosseguir para uma configura√ß√£o mais detalhada do rel√≥gio, observamos no menu perif√©rico que o microcontrolador atuar√° como um dispositivo USB. </font></font><br>
<br>
<img src="https://habrastorage.org/files/597/c20/ddb/597c20ddbe2e4c2898c90db97110e454.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora voc√™ pode ir para a pr√≥xima aba grande - </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configura√ß√£o do rel√≥gio</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Aqui veremos um diagrama enorme, que mostra quais sinais de rel√≥gio est√£o presentes no microcontrolador, de onde eles v√™m, como se ramificam, se multiplicam e se dividem. Em amarelo, destaquei os par√¢metros que devem ser observados. </font></font><br>
<br>
<img src="https://habrastorage.org/files/1a5/9a8/596/1a59a8596d434c1f8d09ee5e8335adee.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Verifique se a frequ√™ncia de entrada</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A frequ√™ncia de entrada</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© de 8 MHz. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Definimos o comutador </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PLL Source Mux</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> como </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HSE</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (High Speed ‚Äã‚ÄãExternal) para fazer o clock de uma fonte externa e n√£o de uma fonte interna. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PLL</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Loop de bloqueio de fase, ou PLL - loop de bloqueio de fase, serve para multiplicar a frequ√™ncia externa v√°rias vezes. </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Defina o</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> multiplicador </font><i><font style="vertical-align: inherit;">PLLMul</font></i><font style="vertical-align: inherit;"> como 9. Em seguida, atingiremos a frequ√™ncia m√°xima poss√≠vel para o STM32F303 - 72 MHz. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O Clock do sistema Mux</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> deve estar na posi√ß√£o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PLLCLK para</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que a frequ√™ncia do rel√≥gio seja multiplicada pelo PLL. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para o m√≥dulo USB, s√£o necess√°rios 48 MHz, portanto, coloque um divisor de 1,5 na frente do USB. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Preste aten√ß√£o √† frequ√™ncia</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O cron√¥metro APB1 fica</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> no lado esquerdo do circuito. </font><font style="vertical-align: inherit;">Vai para os temporizadores e √© √∫til para n√≥s no futuro. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se alguma frequ√™ncia estiver configurada incorretamente, exceder o valor m√°ximo poss√≠vel ou os comutadores estiverem em uma posi√ß√£o inv√°lida, o CubeMX destacar√° esse local em vermelho.</font></font><br>
<br>
<h5><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configura√ß√£o do temporizador</font></font></b></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para medir a dura√ß√£o do pulso, iniciaremos o timer TIM3 no modo Captura de entrada. No </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Manual de Refer√™ncia</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , na se√ß√£o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Temporizadores de uso geral (TIM2 / TIM3 / TIM4),</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> h√° um diagrama que ilustra a opera√ß√£o dos temporizadores. Com cores, destaquei os sinais e registradores usados ‚Äã‚Äãno modo Captura de entrada. </font></font><br>
<br>
<img src="https://habrastorage.org/files/e76/54c/ea5/e7654cea52cb46c891e5a73e91068b71.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O sinal do rel√≥gio destacado em verde entra continuamente no registro do contador CNT e aumenta seu valor em 1 a cada ciclo do rel√≥gio. No divisor </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prescaler PSC</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , a </font><font style="vertical-align: inherit;">frequ√™ncia </font><font style="vertical-align: inherit;">do </font><font style="vertical-align: inherit;">rel√≥gio pode diminuir para uma contagem mais lenta. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um </font><font style="vertical-align: inherit;">sinal externo √© </font><font style="vertical-align: inherit;">inserido no </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TIMx_CH1</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Detector de borda</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reconhece as bordas do sinal de entrada - transi√ß√µes de 0 a 1 ou 1 a 0. Ao registrar a borda, ele envia dois comandos destacadas em amarelo: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
- um comando para escrever o valor da </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CNT</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> balc√£o </font><font style="vertical-align: inherit;">ao </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Capture / comparar 1 registo (CCR1)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> eo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CC1I</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> interrup√ß√£o </font><i><font style="vertical-align: inherit;">de chamadas</font></i><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
- um comando para o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">controlador do modo escravo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , pelo qual o valor </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CNT</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© </font><font style="vertical-align: inherit;">redefinido para 0 e a contagem regressiva √© iniciada novamente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui est√° uma ilustra√ß√£o do processo em uma linha do tempo:</font></font><br>
<br>
<img width="50%" src="https://habrastorage.org/files/3b5/80b/ab0/3b580bab0b894981b8d28eadd9f444b2.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando ocorre uma interrup√ß√£o, executaremos a√ß√µes com o valor capturado. Se os pulsos de entrada ocorrerem com muita frequ√™ncia e as a√ß√µes que ocorrerem no manipulador de interrup√ß√µes forem muito longas, o valor de CCR1 poder√° ser sobrescrito antes de lermos o anterior. Nesse caso, √© necess√°rio verificar o sinalizador Overcapture ou aplicar o DMA (Direct Memory Access) quando os dados do CCR1 preencherem automaticamente a matriz preparada na mem√≥ria. No nosso caso, o pulso mais curto tem a dura√ß√£o de 1 milissegundo e o manipulador de interrup√ß√µes ser√° simples e curto, portanto, n√£o se preocupe com a substitui√ß√£o. </font><i><font style="vertical-align: inherit;">Volte</font></i></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
para a guia </font><i><font style="vertical-align: inherit;">Pinagem</font></i><font style="vertical-align: inherit;"> e defina o timer </font><i><font style="vertical-align: inherit;">TIM3</font></i><font style="vertical-align: inherit;"> no menu </font><i><font style="vertical-align: inherit;">Perif√©ricos</font></i><font style="vertical-align: inherit;"> . </font><i><font style="vertical-align: inherit;">Modo Escravo: Modo Reset</font></i></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br>
<br>
<img src="https://habrastorage.org/files/437/703/50b/43770350badf4efcb4d02a11ea2f9db0.png"><br>
<br>
<i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- significa que, em algum evento, o timer ser√° redefinido para 0. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fonte de Disparo: TI1FP1</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - o evento usado para redefinir e iniciar o timer √© a borda do sinal capturada da entrada TI1. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ClockSource: Internal Clock</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - o timer √© gerado a partir do gerador interno do microcontrolador. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Canal 1: Modo direto de captura de entrada</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - capture intervalos do 1¬∫ canal no registro CCR1. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na pr√≥xima grande guia </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configura√ß√£o</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , faremos </font><font style="vertical-align: inherit;">configura√ß√µes adicionais de timer.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/db8/b67/8d8/db8b678d8f7846c9af081a0bfdb0d7b1.png"></div><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/63b/6ac/c06/63b6acc06716451399d01566635d2f87.png"></div><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prescaler</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© um divisor de temporizador. Se for 0, a frequ√™ncia √© obtida diretamente do rel√≥gio APB do barramento de clock - 72 MHz. Se o pr√©-calibrador for 1, a frequ√™ncia √© dividida por 2 e passa a 36 MHz. Defina o divisor como 71 para que a frequ√™ncia seja dividida por 72. A frequ√™ncia do temporizador ser√° de 1 MHz e os intervalos ser√£o medidos com uma resolu√ß√£o de 1 microssegundo. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Per√≠odo do contador</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - defina o valor m√°ximo poss√≠vel de 16 bits 0xFFFF. O per√≠odo √© importante para gerar intervalos de tempo, por exemplo, para PWM. Mas o per√≠odo n√£o √© importante para capturar sinais; n√≥s o tornaremos conhecido por ser grande para qualquer pulso de entrada. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sele√ß√£o de polaridade: Borda de queda</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - os valores do temporizador ser√£o capturados na borda de queda do sinal de entrada. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na guia </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NVIC Settings</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font><font style="vertical-align: inherit;">coloque um daw</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Interrup√ß√£o global TIM3</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , para que eventos relacionados ao terceiro temporizador gerem uma interrup√ß√£o.</font></font><br>
<br>
<h5><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configura√ß√£o do dispositivo USB</font></font></b></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J√° observamos que o controlador ser√° um dispositivo USB. </font><font style="vertical-align: inherit;">Como o joystick pertence √† classe de dispositivos HID, no </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">menu Middlewares -&gt; USB_DEVICE,</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> selecione </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Classe para IP FS: Classe de dispositivo de interface humana (HID)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Em seguida, o CubeMX conectar√° bibliotecas para o dispositivo HID ao projeto. </font></font><br>
<br>
<img src="https://habrastorage.org/files/3fe/080/472/3fe0804729bd4b2f995c5f32a9173d47.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos para as configura√ß√µes </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">USB_DEVICE</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> na guia </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configura√ß√£o</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> na se√ß√£o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Middlewares</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/574/ba7/dde/574ba7dde3794ce4911f955e628f7ce7.png"></div><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O ID do fornecedor</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e o </font><i><font style="vertical-align: inherit;">ID do </font></i></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">produto</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> s√£o dois identificadores de 16 bits exclusivos para cada modelo de dispositivo USB. O VID corresponde ao fabricante do dispositivo e cada fabricante atribui o PID, guiado por suas pr√≥prias considera√ß√µes. N√£o consegui encontrar a lista oficial de VID e PID, apenas encontrei </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a base de identificadores</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> suportada por entusiastas. Para obter seu pr√≥prio ID de fornecedor, voc√™ precisa ir ao USB Implementers Forum no </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">usb.org</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e pagar alguns milhares de d√≥lares. Pequenas empresas ou desenvolvedores de c√≥digo aberto que n√£o podem pagar seu VID podem solicitar um fabricante de chips USB e receber oficialmente um par VID / PID para seu projeto. Esse servi√ßo √© oferecido, por exemplo, pela FTDI ou Silicon Laboratories.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se voc√™ conectar dois dispositivos com o mesmo VID / PID, mas de um tipo diferente (por exemplo, um √© um dispositivo HID e o outro √© Armazenamento em Massa), o sistema operacional tentar√° instalar o mesmo driver para eles e pelo menos um deles n√£o funciona. √â por isso que os pares VID / PID para diferentes modelos de dispositivos devem ser exclusivos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como n√£o estamos fabricando um dispositivo para n√≥s mesmos, n√£o o venderemos e distribuiremos, deixaremos o VID 0x0483, correspondente √† STMicroelectronics, e criaremos nosso pr√≥prio PID. Por padr√£o, o CubeMX oferece o PID 0x5710 para o dispositivo HID. Substitua-o, por exemplo, por 0x57FF. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Substitua </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">corda Produto</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> com </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">STM32 PPM-USB Adapter</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Este nome aparecer√° na lista de dispositivos no Painel de Controle do Windows. Ainda n√£o alteraremos o n√∫mero de s√©rie (S \ N). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando o Windows detecta, ele detecta um dispositivo com uma combina√ß√£o de VID, PID e S \ N que nunca havia visto antes, o sistema instala o driver apropriado para ele. Se a combina√ß√£o de VID, PID e S \ N j√° tiver sido usada, o Windows substituir√° automaticamente o driver usado anteriormente. Voc√™ pode ver isso, por exemplo, quando conecta a unidade flash ao USB. A primeira vez que conectar e instalar leva algum tempo. Nas conex√µes subseq√ºentes, a unidade come√ßa a funcionar quase que instantaneamente. No entanto, se voc√™ conectar outra inst√¢ncia da unidade Flash do mesmo modelo, mas com um n√∫mero de s√©rie diferente, o sistema instalar√° um novo driver para ele, mesmo com o mesmo VID e PID.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vou explicar por que isso √© importante. </font><font style="vertical-align: inherit;">Se voc√™ criou um mouse USB no seu STM32 com seu VID, PID e S \ N, conectou-o ao computador e criou um joystick USB sem alterar o VID, PID e S \ N, o Windows perceber√° o novo dispositivo como um mouse que j√° usado no sistema e n√£o instalar√° o driver do joystick. </font><font style="vertical-align: inherit;">Consequentemente, o joystick n√£o funcionar√°. </font><font style="vertical-align: inherit;">Portanto, se voc√™ deseja alterar o tipo do seu dispositivo, deixando o VID / PID inalterado, altere o n√∫mero de s√©rie.</font></font><br>
<br>
<h5><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gera√ß√£o de projeto para IDE</font></font></b></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As √∫ltimas configura√ß√µes que voc√™ precisa fazer s√£o as configura√ß√µes de gera√ß√£o do projeto. Isso √© feito atrav√©s de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Projeto -&gt; Configura√ß√µes</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ... L√°, definiremos o nome, a pasta de destino e o IDE desejado, sob o qual o CubeMX criar√° o projeto. Eu escolhi o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MDK-ARM V5</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , porque uso o Keil uVision 5. Na guia </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gerador de c√≥digo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font><font style="vertical-align: inherit;">voc√™ pode marcar a caixa de sele√ß√£o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Copiar apenas os arquivos de biblioteca necess√°rios</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para </font><font style="vertical-align: inherit;">n√£o confundir o projeto com arquivos desnecess√°rios. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pressione o bot√£o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Projeto -&gt; Gerar c√≥digo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . O CubeMX criar√° um projeto com c√≥digo que pode ser aberto no Keil uVision e compilado e exibido sem configura√ß√µes adicionais. No arquivo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">main.c</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> na fun√ß√£o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">principal (nula)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fun√ß√µes j√° foram inseridas para inicializar o rel√≥gio, portas, timer e USB. Neles, os m√≥dulos do microcontrolador s√£o configurados de acordo com os modos que definimos no CubeMX. </font></font><br>
<br>
<img src="https://habrastorage.org/files/fb6/a32/393/fb6a323933734c7cb3ac4e11550d7420.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No c√≥digo, constru√ß√µes desse tipo s√£o frequentemente encontradas:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">/* USER CODE BEGIN 0 */</span><font></font>
(...)<font></font>
<span class="hljs-comment">/* USER CODE END 0 */</span><font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sup√µe-se que o usu√°rio incorporar√° seu c√≥digo nessas se√ß√µes. Se a op√ß√£o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Manter c√≥digo do usu√°rio ao gerar novamente</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> estiver ativada nas configura√ß√µes do projeto CubeMX </font><font style="vertical-align: inherit;">, o c√≥digo entre essas linhas n√£o ser√° substitu√≠do durante a gera√ß√£o secund√°ria de um projeto existente. Infelizmente, apenas as se√ß√µes criadas pelo CubeMX s√£o salvas. As se√ß√µes </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ * C√ìDIGO DO USU√ÅRIO * /</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> criadas pelo usu√°rio ser√£o perdidas. Portanto, se depois de escrever o c√≥digo no IDE, voc√™ desejar retornar ao CubeMX e gerar o projeto novamente com as novas configura√ß√µes, recomendo fazer uma c√≥pia de backup do projeto. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nas configura√ß√µes de firmware do uVision ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Flash -&gt; Configurar ferramentas do Flash</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), aconselho a ativar a op√ß√£o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Redefinir ap√≥s o flash</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para que o microcontrolador inicie imediatamente ap√≥s piscar. </font><font style="vertical-align: inherit;">Por padr√£o, ele est√° desativado e, ap√≥s cada piscar, voc√™ deve pressionar o bot√£o Redefinir na placa.</font></font><br>
<br>
<img src="https://habrastorage.org/files/1e1/a3d/20d/1e1a3d20dd994c1787f8a8758fcd200e.png"><br>
<br>
<a name="ppm"></a><h3><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Decodifica√ß√£o PPM</font></font></b></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PPM - Pulse Position Modulation - um m√©todo de codifica√ß√£o de sinais transmitidos, muito difundido nos modelos eletr√¥nicos de aeronaves. </font><font style="vertical-align: inherit;">√â uma sequ√™ncia de pulsos, cujos intervalos de tempo correspondem aos valores num√©ricos transmitidos.</font></font><br>
<br>
<div style="text-align:center;"><img width="80%" src="https://habrastorage.org/files/905/3ec/257/9053ec2573f8438b9a3053f2ef408739.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De acordo com este protocolo, o console envia informa√ß√µes ao m√≥dulo de r√°dio transmissor, que √© inserido no console na parte traseira. Muitos receptores que s√£o colocados a bordo do helic√≥ptero podem transmitir sinais de controle para o controlador de v√¥o via PPM. Al√©m disso, quase qualquer console possui conectores para conectar um segundo console no modo treinador-aluno e para conectar o console a um simulador, que tamb√©m costuma usar o PPM. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Escrevemos um sinal da sa√≠da do simulador do Turnigy 9X com um analisador l√≥gico:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/53e/da5/319/53eda5319a6d45b59ee6e265de445992.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cada sequ√™ncia codifica o estado atual dos controles no controle remoto. Geralmente, os quatro primeiros valores (tamb√©m chamados de canais) correspondem √† posi√ß√£o dos man√≠pulos anal√≥gicos e os subsequentes √† posi√ß√£o dos interruptores ou potenci√¥metros. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A posi√ß√£o m√≠nima do controle corresponde ao intervalo 1000 Œºs, o m√°ximo - 2000 Œºs, a posi√ß√£o m√©dia - 1500 Œºs. Explos√µes de pulsos, ou quadros, s√£o separadas por intervalos substancialmente mais longos e seguem com um per√≠odo de 20 a 25 ms. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos dar uma olhada no sinal:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/703/86d/84e/70386d84efe24577a958767f8c5b7ae9.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como voc√™ pode ver, tr√™s paus est√£o na posi√ß√£o neutra (1, 3, 4) e um est√° na posi√ß√£o extrema (2). </font><font style="vertical-align: inherit;">Tr√™s interruptores est√£o desativados (5, 6, 7) e o √∫ltimo est√° ativado (8). </font><font style="vertical-align: inherit;">O microcontrolador, atuando como um adaptador, deve capturar essa sequ√™ncia, adicionar os valores a uma matriz e envi√°-la via USB como um comando a partir do joystick. </font><font style="vertical-align: inherit;">Vamos escrever um decodificador de seq√º√™ncia de pulsos.</font></font><br>
<br>
<h5><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Interrup√ß√£o de captura</font></font></b></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ap√≥s a inicializa√ß√£o no </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">main.c,</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> antes do </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">loop while</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> principal </font><i><font style="vertical-align: inherit;">,</font></i><font style="vertical-align: inherit;"> inicie o timer TIM3 no modo de captura Input Capture a partir do canal 1, com a gera√ß√£o de interrup√ß√µes de captura. </font><font style="vertical-align: inherit;">Para fazer isso, use a fun√ß√£o correspondente do HAL:</font></font><br>
<br>
<pre><code class="cpp hljs">HAL_TIM_IC_Start_IT(&amp;htim3, TIM_CHANNEL_1);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A estrutura </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">htim3</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> declarada em </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">main.c</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© o manipulador de timer TIM3, que cont√©m todas as estruturas e vari√°veis ‚Äã‚Äãassociadas ao timer: par√¢metros para inicializa√ß√£o, ponteiros para todos os registros de timer (valor do contador, divisor, todas as configura√ß√µes, sinalizadores de interrup√ß√£o), ponteiro em um manipulador de DMA que funcione com esse timer, etc. O desenvolvedor n√£o precisa procurar por quais bits nos quais o registro √© respons√°vel por qu√™, e manualmente os define e redefine. √â o suficiente para passar o manipulador para a fun√ß√£o HAL. As bibliotecas HAL far√£o o resto elas mesmas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os princ√≠pios da estrutura HAL s√£o descritos em mais detalhes no documento </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">Descri√ß√£o dos drivers STAL32F3xx HAL</font></a><font style="vertical-align: inherit;"> .</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(UM1786). Deve-se notar que as pr√≥prias bibliotecas HAL est√£o bem documentadas. Para entender como o HAL funciona para o temporizador e como us√°-lo, voc√™ pode ler os coment√°rios nos </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stm32f3xx_hal_tim.h</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">arquivos stm32f3xx_hal_tim.c</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para cada interrup√ß√£o que o timer TIM3 gera, o manipulador </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TIM3_IRQHandler</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© </font><i><font style="vertical-align: inherit;">chamado</font></i><font style="vertical-align: inherit;"> . Ele est√° localizado no arquivo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stm32f3xx_it.c</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , por sua vez, o manipulador </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HAL_TIM_IRQHandler</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font><font style="vertical-align: inherit;">padr√£o para todos os timers, √© </font><i><font style="vertical-align: inherit;">chamado</font></i><font style="vertical-align: inherit;"> nele e um ponteiro para a estrutura htim3 √© passado para ele.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">TIM3_IRQHandler</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span><font></font><span class="hljs-function">
</span>{<font></font>
  <span class="hljs-comment">/* USER CODE BEGIN TIM3_IRQn 0 */</span><font></font>
<font></font>
  <span class="hljs-comment">/* USER CODE END TIM3_IRQn 0 */</span><font></font>
  HAL_TIM_IRQHandler(&amp;htim3);<font></font>
  <span class="hljs-comment">/* USER CODE BEGIN TIM3_IRQn 1 */</span><font></font>
<font></font>
  <span class="hljs-comment">/* USER CODE END TIM3_IRQn 1 */</span><font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se olharmos para dentro </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HAL_TIM_IRQHandler</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> arquivo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stm32f3xx_hal_tim.c</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , vemos uma enorme manipulador que verifica os sinalizadores de interrup√ß√£o para causas temporizador callback-fun√ß√£o e limpa o sinalizador ap√≥s a execu√ß√£o. </font><font style="vertical-align: inherit;">Se ocorrer um evento de captura, ele chamar√° a fun√ß√£o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HAL_TIM_IC_CaptureCallback</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Se parece com isso:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function">__weak <span class="hljs-keyword">void</span> <span class="hljs-title">HAL_TIM_IC_CaptureCallback</span><span class="hljs-params">(TIM_HandleTypeDef *htim)</span></span><font></font><span class="hljs-function">
</span>{<font></font>
<span class="hljs-comment">/* NOTE : This function Should not be modified, when the callback is needed, the __HAL_TIM_IC_CaptureCallback could be implemented in the user file</span><font></font><span class="hljs-comment">
*/</span><font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Isto significa que pode substituir essa fun√ß√£o em </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">main.c</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Portanto, insira </font><font style="vertical-align: inherit;">esse retorno de chamada </font><font style="vertical-align: inherit;">antes da fun√ß√£o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">int main (void)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">HAL_TIM_IC_CaptureCallback</span><span class="hljs-params">(TIM_HandleTypeDef *htim)</span></span><font></font><span class="hljs-function">
</span>{<font></font>
};<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu gostaria de ver como a interrup√ß√£o √© realizada. </font><font style="vertical-align: inherit;">Adicione a ele um r√°pido in√≠cio de uma das conclus√µes:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">HAL_TIM_IC_CaptureCallback</span><span class="hljs-params">(TIM_HandleTypeDef *htim)</span></span><font></font><span class="hljs-function">
</span>{<font></font>
  HAL_GPIO_WritePin(GPIOE, GPIO_PIN_8, GPIO_PIN_SET);<font></font>
  __nop();__nop();__nop();__nop();__nop();__nop();<font></font>
  HAL_GPIO_WritePin(GPIOE, GPIO_PIN_8, GPIO_PIN_RESET);<font></font>
};<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O pino PE8 j√° foi inicializado como uma sa√≠da. </font><font style="vertical-align: inherit;">Entre ligar e desligar, as instru√ß√µes </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__nop ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> s√£o inseridas </font><font style="vertical-align: inherit;">, formando um atraso de 1 ciclo de rel√≥gio. </font><font style="vertical-align: inherit;">Isso √© feito para que meu analisador l√≥gico chin√™s de US $ 8, operando a 24 MHz, n√£o perca um pulso muito curto de um microcontrolador de 72 MHz. </font><font style="vertical-align: inherit;">Agora compile o projeto </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Projeto -&gt; Construir alvo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e pe√ßa ao controlador </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Flash -&gt; Download</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Vamos conectar o PPM do controle remoto ao PC6 e ver o que acontece no PC6 e PE8 com o analisador.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/abf/64c/e2c/abf64ce2c6874057933df9edb58dff8f.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O retorno de chamada √© realmente chamado nos momentos certos - logo ap√≥s a transi√ß√£o do sinal de entrada de 1 para 0. Portanto, tudo foi feito corretamente.</font></font><br>
<br>
<h5><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Capturar e processar dados capturados</font></font></b></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Editaremos o retorno de chamada para que ele adicione cada valor capturado ao buffer de </font><font style="vertical-align: inherit;">valor_ </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">capturado</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> inalterado. Se o timer capturar um valor muito grande (mais de 5000 Œºs), isso significa que uma pausa foi registrada, o pacote foi recebido na √≠ntegra e pode ser processado. Os valores processados ‚Äã‚Äãs√£o adicionados √† matriz </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rc_data</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de 5 elementos. Nos quatro primeiros, as posi√ß√µes do manche s√£o reduzidas para o intervalo [0; 1000], no quinto, os bits individuais s√£o definidos de acordo com as chaves de altern√¢ncia, que ser√£o interpretadas como pressionando bot√µes no gamepad.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">uint16_t</span> captured_value[<span class="hljs-number">8</span>] = {<span class="hljs-number">0</span>};<font></font>
<span class="hljs-keyword">uint16_t</span> rc_data[<span class="hljs-number">5</span>] = {<span class="hljs-number">0</span>};<font></font>
<span class="hljs-keyword">uint8_t</span> pointer = <span class="hljs-number">0</span>;<font></font>
<span class="hljs-keyword">uint8_t</span> data_ready = <span class="hljs-number">0</span>;<font></font>
<font></font>
...<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">HAL_TIM_IC_CaptureCallback</span><span class="hljs-params">(TIM_HandleTypeDef *htim)</span></span><font></font><span class="hljs-function">
</span>{<font></font>
    <span class="hljs-keyword">uint8_t</span> i;<font></font>
    <span class="hljs-keyword">uint16_t</span> temp;<font></font>
    <span class="hljs-comment">//     </span><font></font>
    temp = HAL_TIM_ReadCapturedValue(htim, TIM_CHANNEL_1);<font></font>
    <span class="hljs-comment">//    , ,  </span><font></font>
    <span class="hljs-keyword">if</span> ((temp &gt; <span class="hljs-number">5000</span>) &amp;&amp; (!data_ready))<font></font>
    {<font></font>
        pointer = <span class="hljs-number">0</span>;<font></font>
        <span class="hljs-comment">//        [0;1000]</span><font></font>
        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">4</span>; i++)<font></font>
        {<font></font>
            <span class="hljs-keyword">if</span> (captured_value[i] &lt; <span class="hljs-number">1000</span>)<font></font>
                captured_value[i] = <span class="hljs-number">1000</span>;<font></font>
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (captured_value[i] &gt; <span class="hljs-number">2000</span>)<font></font>
                captured_value[i] = <span class="hljs-number">2000</span>;<font></font>
            rc_data[i] = captured_value[i]<span class="hljs-number">-1000</span>;<font></font>
        };<font></font>
        <span class="hljs-comment">//     </span><font></font>
        rc_data[<span class="hljs-number">4</span>] = <span class="hljs-number">0</span>;<font></font>
        <span class="hljs-keyword">if</span> (captured_value[<span class="hljs-number">4</span>] &gt; <span class="hljs-number">1500</span>)<font></font>
            rc_data[<span class="hljs-number">4</span>] |= (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">4</span>);<font></font>
        <span class="hljs-keyword">if</span> (captured_value[<span class="hljs-number">5</span>] &gt; <span class="hljs-number">1500</span>)<font></font>
            rc_data[<span class="hljs-number">4</span>] |= (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">5</span>);<font></font>
        <span class="hljs-keyword">if</span> (captured_value[<span class="hljs-number">6</span>] &gt; <span class="hljs-number">1500</span>)<font></font>
            rc_data[<span class="hljs-number">4</span>] |= (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">6</span>);<font></font>
        <span class="hljs-keyword">if</span> (captured_value[<span class="hljs-number">7</span>] &gt; <span class="hljs-number">1500</span>)<font></font>
            rc_data[<span class="hljs-number">4</span>] |= (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">7</span>);<font></font>
        data_ready = <span class="hljs-number">1</span>;<font></font>
    }<font></font>
    <span class="hljs-keyword">else</span> <span class="hljs-comment">//      </span><font></font>
    {<font></font>
        captured_value[pointer] = temp;<font></font>
        pointer++;<font></font>
    };<font></font>
    <span class="hljs-keyword">if</span> (pointer == <span class="hljs-number">8</span>) <span class="hljs-comment">//   </span><font></font>
        pointer = <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Deixe-me explicar por que coloquei os bits correspondentes aos bot√µes n√£o nos 4 bits inferiores, mas nos quintos aos oitavos bits. No simulador, √© suposto conectar um gamepad do Xbox, onde os bot√µes LB, RB, Start e Back s√£o usados, e eles t√™m n√∫meros de 5 a 8. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No loop principal, o sinalizador data_ready ser√° rotacionado continuamente, pelo qual os dados ser√£o enviados ao computador.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>)<font></font>
{<font></font>
  <span class="hljs-keyword">if</span> (data_ready)<font></font>
  {<font></font>
    <span class="hljs-comment">//      </span><font></font>
    data_ready = <span class="hljs-number">0</span>;<font></font>
  }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para verificar como isso funciona, conecte o controle remoto, compile e fa√ßa o flash novamente e inicie a depura√ß√£o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Debug -&gt; Start / Stop Debug Session</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Abra a janela para rastrear vari√°veis </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ver -&gt; Observar Janelas -&gt; Observar 1</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e adicione o </font><i><font style="vertical-align: inherit;">valor_ </font></i></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">capturado</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rc_data l√°</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Iniciamos a depura√ß√£o com o comando </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Debug -&gt; Run</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e, em tempo real, sem adicionar pontos de interrup√ß√£o, veremos como os n√∫meros mudam ap√≥s os ataques.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/5cf/7da/c9c/5cf7dac9c152498e89ea3948a8549efb.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em seguida, voc√™ precisa enviar dados para o computador na forma de um comando do joystick.</font></font><br>
<br>
<h3><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configurar dispositivo HID e criar descritor de relat√≥rio HID</font></font></b></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O USB HID (Dispositivo de interface humana) √© uma classe de dispositivos para intera√ß√£o homem-computador. Isso inclui teclados, mouses, joysticks, gamepads, pain√©is de toque. A principal vantagem dos dispositivos HID √© que eles n√£o exigem drivers especiais em nenhum sistema operacional: Windows, OS X, Android e at√© iOS (via adaptador USB-Lightning). Uma descri√ß√£o detalhada pode ser encontrada no documento </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Device Class Definition for HID</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . A principal coisa que precisamos saber para criar um adaptador PPM-USB √© o que o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HID Report</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HID Report Descriptor s√£o</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O dispositivo HID envia pacotes de bytes para o computador em um formato predefinido. Cada um desses pacotes √© um relat√≥rio HID. O dispositivo informa o computador sobre o formato dos dados quando ele se conecta, enviando um Descritor de Relat√≥rio HID, uma descri√ß√£o do pacote que indica quantos bytes o pacote cont√©m e a finalidade de cada byte e bit no pacote. Por exemplo, o Relat√≥rio HID de um mouse simples consiste em quatro bytes: o primeiro byte cont√©m informa√ß√µes sobre os bot√µes pressionados, o segundo e o terceiro bytes cont√™m o movimento relativo do cursor ao longo de X e Y e o quarto byte cont√©m a rota√ß√£o da roda de rolagem. O Descritor de Relat√≥rios √© armazenado na mem√≥ria do controlador do dispositivo como uma matriz de bytes.</font></font><br>
<br>
<div style="text-align:center;"><img width="35%" src="https://habrastorage.org/files/22f/dd2/aa6/22fdd2aa67154365a6f89f6a2f7f2798.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Antes de criar um descritor, gostaria de me debru√ßar sobre terminologia separadamente. Dois termos s√£o comuns no ambiente em ingl√™s - </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">joystick</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gamepad</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . A palavra </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">joystick</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> geralmente </font><i><font style="vertical-align: inherit;">√©</font></i><font style="vertical-align: inherit;"> chamada de manipulador, que √© segurada com uma m√£o e inclinada em dire√ß√µes diferentes, e </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gamepad</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© um dispositivo com bot√µes e paus que √© segurado com as duas m√£os. Usu√°rios de l√≠ngua russa costumam chamar o joystick disso e de outro. Na descri√ß√£o do dispositivo HID, h√° uma diferen√ßa entre o joystick e o gamepad. O console do modelo de aeronave √© mais semelhante em termos de funcionalidade a um gamepad; portanto, no futuro, usarei o termo "gamepad".</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Geramos um projeto, indicando que o dispositivo atuar√° como um dispositivo de interface humana. </font><font style="vertical-align: inherit;">Isso significa que uma biblioteca USB HID est√° conectada ao projeto e um descritor de dispositivo j√° foi gerado. </font><font style="vertical-align: inherit;">Ele est√° localizado no arquivo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">usbd_hid.c</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , descreve o relat√≥rio do mouse e tem a seguinte apar√™ncia:</font></font><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HID_Mouse_Report_Descriptor</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs">__ALIGN_BEGIN <span class="hljs-keyword">static</span> <span class="hljs-keyword">uint8_t</span> HID_MOUSE_ReportDesc[HID_MOUSE_REPORT_DESC_SIZE]  __ALIGN_END =<font></font>
{<font></font>
  <span class="hljs-number">0x05</span>,   <span class="hljs-number">0x01</span>,
  <span class="hljs-number">0x09</span>,   <span class="hljs-number">0x02</span>,
  <span class="hljs-number">0xA1</span>,   <span class="hljs-number">0x01</span>,
  <span class="hljs-number">0x09</span>,   <span class="hljs-number">0x01</span>,<font></font>
<font></font>
  <span class="hljs-number">0xA1</span>,   <span class="hljs-number">0x00</span>,
  <span class="hljs-number">0x05</span>,   <span class="hljs-number">0x09</span>,
  <span class="hljs-number">0x19</span>,   <span class="hljs-number">0x01</span>,
  <span class="hljs-number">0x29</span>,   <span class="hljs-number">0x03</span>,<font></font>
<font></font>
  <span class="hljs-number">0x15</span>,   <span class="hljs-number">0x00</span>,
  <span class="hljs-number">0x25</span>,   <span class="hljs-number">0x01</span>,
  <span class="hljs-number">0x95</span>,   <span class="hljs-number">0x03</span>,
  <span class="hljs-number">0x75</span>,   <span class="hljs-number">0x01</span>,<font></font>
<font></font>
  <span class="hljs-number">0x81</span>,   <span class="hljs-number">0x02</span>,
  <span class="hljs-number">0x95</span>,   <span class="hljs-number">0x01</span>,
  <span class="hljs-number">0x75</span>,   <span class="hljs-number">0x05</span>,
  <span class="hljs-number">0x81</span>,   <span class="hljs-number">0x01</span>,<font></font>
<font></font>
  <span class="hljs-number">0x05</span>,   <span class="hljs-number">0x01</span>,
  <span class="hljs-number">0x09</span>,   <span class="hljs-number">0x30</span>,
  <span class="hljs-number">0x09</span>,   <span class="hljs-number">0x31</span>,
  <span class="hljs-number">0x09</span>,   <span class="hljs-number">0x38</span>,<font></font>
<font></font>
  <span class="hljs-number">0x15</span>,   <span class="hljs-number">0x81</span>,
  <span class="hljs-number">0x25</span>,   <span class="hljs-number">0x7F</span>,
  <span class="hljs-number">0x75</span>,   <span class="hljs-number">0x08</span>,
  <span class="hljs-number">0x95</span>,   <span class="hljs-number">0x03</span>,<font></font>
<font></font>
  <span class="hljs-number">0x81</span>,   <span class="hljs-number">0x06</span>,
  <span class="hljs-number">0xC0</span>,   <span class="hljs-number">0x09</span>,
  <span class="hljs-number">0x3c</span>,   <span class="hljs-number">0x05</span>,
  <span class="hljs-number">0xff</span>,   <span class="hljs-number">0x09</span>,<font></font>
<font></font>
  <span class="hljs-number">0x01</span>,   <span class="hljs-number">0x15</span>,
  <span class="hljs-number">0x00</span>,   <span class="hljs-number">0x25</span>,
  <span class="hljs-number">0x01</span>,   <span class="hljs-number">0x75</span>,
  <span class="hljs-number">0x01</span>,   <span class="hljs-number">0x95</span>,<font></font>
<font></font>
  <span class="hljs-number">0x02</span>,   <span class="hljs-number">0xb1</span>,
  <span class="hljs-number">0x22</span>,   <span class="hljs-number">0x75</span>,
  <span class="hljs-number">0x06</span>,   <span class="hljs-number">0x95</span>,
  <span class="hljs-number">0x01</span>,   <span class="hljs-number">0xb1</span>,<font></font>
<font></font>
  <span class="hljs-number">0x01</span>,   <span class="hljs-number">0xc0</span><font></font>
};<font></font>
</code></pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Criar manualmente o Descritor de Relat√≥rios HID consome muito tempo. </font><font style="vertical-align: inherit;">Para facilitar a tarefa, existe uma ferramenta chamada </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HID Descriptor Tool</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (DT). </font><font style="vertical-align: inherit;">Este programa pode criar um descritor para o seu dispositivo. </font><font style="vertical-align: inherit;">No arquivo, voc√™ encontra v√°rios exemplos de descritores para diferentes dispositivos.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/a3c/6fd/07c/a3c6fd07c997415ab94ba603edda628d.png"></div><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aqui est√° um</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> artigo muito bom sobre como criar seu pr√≥prio descritor HID para mouse e teclado (em ingl√™s). Vou dizer em russo como lidar com um gamepad. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O relat√≥rio HID enviado pelo console deve conter quatro valores de 16 bits para dois eixos de man√≠pulos anal√≥gicos e 16 valores de um bit para bot√µes. Total de 10 bytes. Seu identificador criado no DT ter√° a seguinte apar√™ncia:</font></font><br>
<br>
<pre><code class="cpp hljs">    <span class="hljs-number">0x05</span>, <span class="hljs-number">0x01</span>,                    <span class="hljs-comment">// USAGE_PAGE (Generic Desktop)</span><font></font>
    <span class="hljs-number">0x09</span>, <span class="hljs-number">0x05</span>,                    <span class="hljs-comment">// USAGE (Game Pad)</span><font></font>
    <span class="hljs-number">0xa1</span>, <span class="hljs-number">0x01</span>,                    <span class="hljs-comment">// COLLECTION (Application)</span><font></font>
    <span class="hljs-number">0x09</span>, <span class="hljs-number">0x01</span>,                    <span class="hljs-comment">//   USAGE (Pointer)</span><font></font>
    <span class="hljs-number">0xa1</span>, <span class="hljs-number">0x00</span>,                    <span class="hljs-comment">//   COLLECTION (Physical)</span><font></font>
    <span class="hljs-number">0x09</span>, <span class="hljs-number">0x30</span>,                    <span class="hljs-comment">//     USAGE (X)</span><font></font>
    <span class="hljs-number">0x09</span>, <span class="hljs-number">0x31</span>,                    <span class="hljs-comment">//     USAGE (Y)</span><font></font>
    <span class="hljs-number">0x15</span>, <span class="hljs-number">0x00</span>,                    <span class="hljs-comment">//     LOGICAL_MINIMUM (0)</span><font></font>
    <span class="hljs-number">0x26</span>, <span class="hljs-number">0xe8</span>, <span class="hljs-number">0x03</span>,              <span class="hljs-comment">//     LOGICAL_MAXIMUM (1000)</span><font></font>
    <span class="hljs-number">0x75</span>, <span class="hljs-number">0x10</span>,                    <span class="hljs-comment">//     REPORT_SIZE (16)</span><font></font>
    <span class="hljs-number">0x95</span>, <span class="hljs-number">0x02</span>,                    <span class="hljs-comment">//     REPORT_COUNT (2)</span><font></font>
    <span class="hljs-number">0x81</span>, <span class="hljs-number">0x02</span>,                    <span class="hljs-comment">//     INPUT (Data,Var,Abs)</span><font></font>
    <span class="hljs-number">0xc0</span>,                          <span class="hljs-comment">//   END_COLLECTION</span><font></font>
    <span class="hljs-number">0xa1</span>, <span class="hljs-number">0x00</span>,                    <span class="hljs-comment">//   COLLECTION (Physical)</span><font></font>
    <span class="hljs-number">0x09</span>, <span class="hljs-number">0x33</span>,                    <span class="hljs-comment">//     USAGE (Rx)</span><font></font>
    <span class="hljs-number">0x09</span>, <span class="hljs-number">0x34</span>,                    <span class="hljs-comment">//     USAGE (Ry)</span><font></font>
    <span class="hljs-number">0x15</span>, <span class="hljs-number">0x00</span>,                    <span class="hljs-comment">//     LOGICAL_MINIMUM (0)</span><font></font>
    <span class="hljs-number">0x26</span>, <span class="hljs-number">0xe8</span>, <span class="hljs-number">0x03</span>,              <span class="hljs-comment">//     LOGICAL_MAXIMUM (1000)</span><font></font>
    <span class="hljs-number">0x75</span>, <span class="hljs-number">0x10</span>,                    <span class="hljs-comment">//     REPORT_SIZE (16)</span><font></font>
    <span class="hljs-number">0x95</span>, <span class="hljs-number">0x02</span>,                    <span class="hljs-comment">//     REPORT_COUNT (2)</span><font></font>
    <span class="hljs-number">0x81</span>, <span class="hljs-number">0x02</span>,                    <span class="hljs-comment">//     INPUT (Data,Var,Abs)</span><font></font>
    <span class="hljs-number">0xc0</span>,                          <span class="hljs-comment">//   END_COLLECTION</span><font></font>
    <span class="hljs-number">0x05</span>, <span class="hljs-number">0x09</span>,                    <span class="hljs-comment">//   USAGE_PAGE (Button)</span><font></font>
    <span class="hljs-number">0x19</span>, <span class="hljs-number">0x01</span>,                    <span class="hljs-comment">//   USAGE_MINIMUM (Button 1)</span><font></font>
    <span class="hljs-number">0x29</span>, <span class="hljs-number">0x10</span>,                    <span class="hljs-comment">//   USAGE_MAXIMUM (Button 16)</span><font></font>
    <span class="hljs-number">0x15</span>, <span class="hljs-number">0x00</span>,                    <span class="hljs-comment">//   LOGICAL_MINIMUM (0)</span><font></font>
    <span class="hljs-number">0x25</span>, <span class="hljs-number">0x01</span>,                    <span class="hljs-comment">//   LOGICAL_MAXIMUM (1)</span><font></font>
    <span class="hljs-number">0x75</span>, <span class="hljs-number">0x01</span>,                    <span class="hljs-comment">//   REPORT_SIZE (1)</span><font></font>
    <span class="hljs-number">0x95</span>, <span class="hljs-number">0x10</span>,                    <span class="hljs-comment">//   REPORT_COUNT (16)</span><font></font>
    <span class="hljs-number">0x81</span>, <span class="hljs-number">0x02</span>,                    <span class="hljs-comment">//   INPUT (Data,Var,Abs)</span><font></font>
    <span class="hljs-number">0xc0</span>                           <span class="hljs-comment">// END_COLLECTION</span><font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parece n√£o menos intimidador do que um descritor de mouse. </font><font style="vertical-align: inherit;">Mas se voc√™ entende o que cada linha significa, tudo acaba sendo bastante compreens√≠vel e l√≥gico. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
USAGE mostra como o sistema deve interpretar dados que v√£o al√©m. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existem muitos tipos de uso, eles s√£o classificados em grupos - p√°ginas de uso. </font><font style="vertical-align: inherit;">Portanto, para selecionar um Uso espec√≠fico, voc√™ deve primeiro consultar o USAGE_PAGE correspondente. </font><font style="vertical-align: inherit;">Sobre o que o uso pode ser encontrado no documento </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hid Usage Tables</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">No in√≠cio do descritor, indicamos que o joystick ser√° descrito:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">USAGE_PAGE (√°rea de trabalho gen√©rica) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
USAGE (Game Pad)</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
COLLECTION combina v√°rios conjuntos de dados relacionados. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Coleta f√≠sica √© usada para dados relacionados a um ponto geom√©trico espec√≠fico, por exemplo, um stick anal√≥gico. </font><font style="vertical-align: inherit;">A cole√ß√£o de aplicativos √© usada para combinar diferentes fun√ß√µes em um dispositivo. </font><font style="vertical-align: inherit;">Por exemplo, um teclado com um trackpad integrado pode ter duas cole√ß√µes de aplicativos. </font><font style="vertical-align: inherit;">Descrevemos apenas o joystick, o que significa que a cole√ß√£o ser√° uma:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">COLEC√á√ÉO (aplica√ß√£o) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
END_COLLECTION</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depois disso, voc√™ precisa especificar que os elementos que transmitem as coordenadas ser√£o descritos. </font><font style="vertical-align: inherit;">Ponteiro de uso √© usado para descrever mouses, joysticks, gamepads, digitalizadores:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">USAGE (Ponteiro)</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A seguir, s√£o apresentadas descri√ß√µes de sticks anal√≥gicos combinados em uma cole√ß√£o:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">COLE√á√ÉO (F√≠sica)</font></font><br>
 <blockquote>USAGE (X)<br>
 USAGE (Y)<br>
 LOGICAL_MINIMUM (0)<br>
 LOGICAL_MAXIMUM (1000)<br>
 REPORT_SIZE (16)<br>
 REPORT_COUNT (2)<br>
 INPUT (Data,Var,Abs)</blockquote>END_COLLECTION</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
USAGE aqui indica que os valores de desvio ao longo dos dois eixos, X e Y, s√£o </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
usados </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">LOGICAL_MINIMUM e LOGICAL_MAXIMUM especificam at√© que ponto o valor transmitido pode variar. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
REPORT_COUNT e REPORT_SIZE definem, respectivamente, quantos n√∫meros e qual tamanho vamos transferir, ou seja, dois n√∫meros de 16 bits. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ENTRADA (Dados, Var, Abs) significa que os dados v√™m do dispositivo para o computador e esses dados podem ser alterados. Os valores em nosso caso s√£o absolutos. Por exemplo, valores relativos v√™m do mouse para mover o cursor. √Äs vezes, os dados s√£o descritos como Const, n√£o Var. Isso √© necess√°rio para transmitir bits n√£o significativos. Por exemplo, em um relat√≥rio de mouse com tr√™s bot√µes, 3 bits de Var para bot√µes e 5 bits de Const s√£o transferidos para complementar o tamanho da transfer√™ncia para um byte.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como voc√™ pode ver, as descri√ß√µes dos eixos X e Y s√£o agrupadas. </font><font style="vertical-align: inherit;">Eles t√™m o mesmo tamanho, os mesmos limites. </font><font style="vertical-align: inherit;">O mesmo bast√£o anal√≥gico pode ser descrito a seguir, descrevendo cada eixo individualmente. </font><font style="vertical-align: inherit;">Esse descritor funcionar√° de maneira semelhante ao anterior:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">COLE√á√ÉO (F√≠sica)</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UTILIZA√á√ÉO (X) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 LOGICAL_MINIMUM (0) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 LOGICAL_MAXIMUM (1000) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 REPORT_SIZE (16) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 REPORT_COUNT (1) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 ENTRADA (Dados, Var, Abs)</font></font></blockquote><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UTILIZA√á√ÉO (Y) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 LOGICAL_MINIMUM (0) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 LOGICAL_MAXIMUM (1000) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 REPORT_SIZE (16) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 REPORT_COUNT (1) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 ENTRADA (Dados, Var, Abs)</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">END_COLLECTION</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ap√≥s o primeiro stick, o segundo stick anal√≥gico √© descrito. </font><font style="vertical-align: inherit;">Seus eixos t√™m um uso diferente, para que voc√™ possa distingui-los do primeiro bast√£o - Rx e Ry:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">COLE√á√ÉO (F√≠sica)</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">USAGE (Rx) </font><font style="vertical-align: inherit;">
 USAGE </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 (Ry) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LOGICAL_MINIMUM (0) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 LOGICAL_MAXIMUM (1000) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 REPORT_SIZE (16) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 REPORT_COUNT (2) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 ENTRADA (Dados, Var, Abs)</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">END_COLLECTION</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora voc√™ precisa descrever alguns bot√µes do gamepad. </font><font style="vertical-align: inherit;">Isso pode ser feito da seguinte forma:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">USAGE_PAGE (bot√£o) USAGE (bot√£o </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
USAGE (bot√£o 2) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
USAGE (bot√£o 3) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
USAGE (bot√£o 16)</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A grava√ß√£o complicada de bot√µes do mesmo tipo pode ser reduzida usando o intervalo de Uso:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">USAGE_PAGE (bot√£o) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
USAGE_MINIMUM (bot√£o 1) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
USAGE_MAXIMUM (bot√£o 16)</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os dados transmitidos pelos bot√µes s√£o 16 valores de bit √∫nico, variando de 0 a 1:</font></font><br>
<blockquote>LOGICAL_MINIMUM (0)<br>
LOGICAL_MAXIMUM (1)<br>
REPORT_SIZE (1)<br>
REPORT_COUNT (16)<br>
INPUT (Data,Var,Abs)</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A ordem das linhas no descritor n√£o √© rigorosa. Por exemplo, Logical_Minimum e Logical_Maximum podem ser gravados antes de Usage (Button), ou as linhas Report_Size e Report_Count podem ser trocadas. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â importante que o comando Entrada tenha todos os par√¢metros necess√°rios para a transfer√™ncia de dados (Uso, M√≠nimo, M√°ximo, Tamanho, Contagem). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando o descritor √© formado, ele pode ser verificado com o comando </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Parse Descriptor</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> quanto a erros. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se tudo estiver em ordem, exporte-o com a extens√£o h. No arquivo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">usbd_hid.c,</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> substitua o descritor por um novo e ajuste em </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">usbd_hid.h o</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tamanho do descritor </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HID_MOUSE_REPORT_DESC_SIZE</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de 74 a 61. Os </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
relat√≥rios s√£o enviados usando o sinalizador </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">data_ready</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Para isso</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">main.c</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> incluiremos o arquivo de cabe√ßalho </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">usbd_hid.h</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e no loop principal chamaremos a fun√ß√£o de envio de relat√≥rio. </font><font style="vertical-align: inherit;">A matriz </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rc_data</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© do tipo uint16, portanto, o ponteiro para ela deve ser convertido para um tipo de 8 bits e passar o tamanho 10 em vez de 5.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"usbd_hid.h"</span></span><font></font>
...<font></font>
<span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>)<font></font>
{<font></font>
  <span class="hljs-keyword">if</span> (data_ready)<font></font>
  {<font></font>
    USBD_HID_SendReport(&amp;hUsbDeviceFS, (<span class="hljs-keyword">uint8_t</span>*)rc_data, <span class="hljs-number">10</span>);<font></font>
    data_ready = <span class="hljs-number">0</span>;<font></font>
  };<font></font>
};<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Compilamos o projeto e o exibimos novamente.</font></font><br>
<br>
<h3><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conex√£o e uso</font></font></b></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Reconecte o cabo USB do conector USB do ST-LINK ao conector USB do USU√ÅRIO. </font><font style="vertical-align: inherit;">O Windows detectar√° o novo dispositivo e instalar√° automaticamente o driver. </font><font style="vertical-align: inherit;">Vamos ao </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Painel de controle -&gt; Dispositivos e impressoras</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e ver nosso dispositivo adaptador STM32 USB-PPM com um √≠cone de gamepad.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/1ee/5ad/846/1ee5ad84654545dfbcec807073ef8207.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nos par√¢metros do dispositivo, voc√™ pode ver como a cruz se move ao redor do campo e as colunas se movem depois que os paus s√£o movidos, e os s√≠mbolos dos bot√µes acendem na chave seletora. </font><font style="vertical-align: inherit;">A calibra√ß√£o n√£o √© necess√°ria porque os valores m√≠nimo e m√°ximo j√° foram definidos no descritor.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/52c/4b0/9db/52c4b09db3074871b917aa74b3375de6.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Iniciando o FPV FreeRider, veremos como na tela principal do gamepad virtual desenhado os man√≠pulos se movem de acordo com nosso controle remoto. </font><font style="vertical-align: inherit;">Se os eixos n√£o forem atribu√≠dos corretamente por algum motivo, voc√™ poder√° reconfigur√°-los na se√ß√£o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Calibrar controlador</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os interruptores correspondentes aos bot√µes do controle remoto s√£o usados ‚Äã‚Äãpara alternar entre os modos de voo (acrob√°tico / estabilizado), alternar a visualiza√ß√£o da c√¢mera (do quadro / do solo), iniciar um voo desde o in√≠cio ou iniciar a corrida por um tempo.</font></font><br>
<br>
<div style="text-align:center;"><img width="70%" src="https://habrastorage.org/files/153/bc2/3a8/153bc23a87bd4fedad1dd9b04c2aae22.png"></div><br>
<br>
<h3><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Voou!</font></font></b></h3><br>
<iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://www.youtube.com/embed/ilMeTba4EOE%3Ffeature%3Doembed&amp;usg=ALkJrhg2LebpOj5JfjOsxJfq-ZxD3TZEbA" frameborder="0" allowfullscreen=""></iframe><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No v√≠deo - o resultado de v√°rios dias do meu treinamento. Enquanto estou voando com nivelamento autom√°tico, e n√£o no modo acrob√°tico, como fazem todos os mestres em corridas de FPV. No modo acro, se voc√™ soltar os man√≠pulos, o helic√≥ptero n√£o retornar√° automaticamente para a posi√ß√£o horizontal, mas continuar√° voando no mesmo √¢ngulo em que voou. Gerenciar no modo acro √© muito mais dif√≠cil, mas voc√™ pode obter maior velocidade, capacidade de manobra, fazer agita√ß√µes no ar e at√© voar de cabe√ßa para baixo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mestres Charpu</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ainda estou muito longe, mas continuo treinando e posso dizer com certeza que a ideia de um mini-helic√≥ptero de corrida me interessou ainda mais. </font><font style="vertical-align: inherit;">E em breve estarei definitivamente engajado em sua constru√ß√£o e v√¥os n√£o mais no simulador, mas em dura realidade, com acidentes reais, h√©lices quebradas, motores quebrados e baterias queimadas. </font><font style="vertical-align: inherit;">Mas este √© um t√≥pico para outros artigos :)</font></font><br>
<br>
<hr><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O projeto para o Keil uVision 5 e STM32CubeMX est√° no </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt384813/">https://habr.com/ru/post/pt384813/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt384801/index.html">–ü–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å –ü–æ–º–ø–µ–∏: –∏—Ç–∞–ª—å—è–Ω—Å–∫–∏–µ —É—á–µ–Ω—ã–µ –ø—Ä–æ–≤–µ–ª–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–∫–æ–≤ –∂–µ—Ä—Ç–≤ –∫–∞—Ç–∞—Å—Ç—Ä–æ—Ñ—ã</a></li>
<li><a href="../pt384803/index.html">Paul Graham: Id√©ias para uma startup org√¢nica</a></li>
<li><a href="../pt384805/index.html">Especialistas do IFixit derrubam AppleTV e Apple desinstala o aplicativo iFixit da AppStore</a></li>
<li><a href="../pt384809/index.html">Papel ou "n√∫mero"? Ambos: revis√£o da caneta inteligente NeoLAB Convergence Neo smartpen N2</a></li>
<li><a href="../pt384811/index.html">Opini√£o de especialista: Materiais semicondutores em eletr√¥nica</a></li>
<li><a href="../pt384815/index.html">Telefones para seguran√ßa infantil e paz dos pais: bb-mobile news</a></li>
<li><a href="../pt384817/index.html">Milhares de Apollo Fotos carregadas no Flickr</a></li>
<li><a href="../pt384819/index.html">Em vez de "n√£o ser mau", o "Google" agora est√° "fazendo a coisa certa"</a></li>
<li><a href="../pt384821/index.html">O aluno introduziu uma luva que permitir√° que pessoas com dist√∫rbios da fala se comuniquem</a></li>
<li><a href="../pt384823/index.html">–ù–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è –º–æ–±–∏–ª—å–Ω—ã—Ö –∏–≥—Ä</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>