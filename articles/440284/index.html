<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚¨úÔ∏è ‚õîÔ∏è üêΩ Una nueva mirada a la visualizaci√≥n de cuadros de di√°logo en Android üôÖ üíÜüèΩ üçå</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="La imagen muestra el primer pensamiento del lector que se pregunta qu√© se puede escribir sobre una tarea tan simple como mostrar un di√°logo. El gerent...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Una nueva mirada a la visualizaci√≥n de cuadros de di√°logo en Android</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mobileup/blog/440284/"><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><img src="https://habrastorage.org/webt/cu/u9/xl/cuu9xl-sjrrfz5v4pqqh9hocnxo.png"></a> </p><br><p>  La imagen muestra el primer pensamiento del lector que se pregunta qu√© se puede escribir sobre una tarea tan simple como mostrar un di√°logo.  El gerente piensa de manera similar: "No hay nada complicado aqu√≠, nuestro <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Vasya</a> lo har√° en 5 minutos".  Por supuesto, exagero, pero en realidad no todo es tan simple como parece a primera vista.  Especialmente si estamos hablando de Android. </p><br><p>  Entonces, 2019 estaba en el patio, y <strong>todav√≠a no sabemos c√≥mo mostrar los di√°logos correctamente</strong> . </p><a name="habracut"></a><br><p>  Hag√°moslo en orden y comencemos con la declaraci√≥n del problema: </p><br><blockquote>  Es necesario mostrar un di√°logo simple con el texto para confirmar la acci√≥n y los botones "confirmar / cancelar".  Al hacer clic en el bot√≥n "confirmar", realice una acci√≥n, mediante el bot√≥n "cancelar", cierre el cuadro de di√°logo. </blockquote><br><h1 id="reshenie-v-lob">  Soluci√≥n de frente </h1><br><p>  Yo llamar√≠a a este m√©todo junior, porque esta no es la primera vez que me encuentro con un malentendido por qu√© no puedes usar AlertDialog, como se muestra a continuaci√≥n: </p><br><pre><code class="kotlin hljs">AlertDialog.Builder(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>) .setMessage(<span class="hljs-string"><span class="hljs-string">"Please, confirm the action"</span></span>) .setPositiveButton(<span class="hljs-string"><span class="hljs-string">"Confirm"</span></span>) { dialog, which -&gt; <span class="hljs-comment"><span class="hljs-comment">// handle click } .setNegativeButton("Cancel", null) .create() .show()</span></span></code> </pre> <br><p>  Una forma bastante com√∫n para un desarrollador novato, es obvio e intuitivo.  Pero, como en muchos casos cuando se trabaja con Android, este m√©todo es completamente incorrecto.  De la nada, obtenemos una p√©rdida de memoria, solo gira el dispositivo y ver√°s el siguiente error en los registros: </p><br><div class="spoiler">  <b class="spoiler_title">traza</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">E/WindowManager: android.view.WindowLeaked: Activity com.example.testdialog.MainActivity has leaked window DecorView@71b5789[MainActivity] that was originally added here at android.view.ViewRootImpl.&lt;init&gt;(ViewRootImpl.java:511) at android.view.WindowManagerGlobal.addView(WindowManagerGlobal.java:346) at android.view.WindowManagerImpl.addView(WindowManagerImpl.java:93) at android.app.Dialog.show(Dialog.java:329) at com.example.testdialog.MainActivity.onCreate(MainActivity.kt:27) at android.app.Activity.performCreate(Activity.java:7144) at android.app.Activity.performCreate(Activity.java:7135) at android.app.Instrumentation.callActivityOnCreate(Instrumentation.java:1271) at android.app.ActivityThread.performLaunchActivity(ActivityThread.java:2931) at android.app.ActivityThread.handleLaunchActivity(ActivityThread.java:3086) at android.app.servertransaction.LaunchActivityItem.execute(LaunchActivityItem.java:78) at android.app.servertransaction.TransactionExecutor.executeCallbacks(TransactionExecutor.java:108) at android.app.servertransaction.TransactionExecutor.execute(TransactionExecutor.java:68) at android.app.ActivityThread$H.handleMessage(ActivityThread.java:1816) at android.os.Handler.dispatchMessage(Handler.java:106) at android.os.Looper.loop(Looper.java:193) at android.app.ActivityThread.main(ActivityThread.java:6718) at java.lang.reflect.Method.invoke(Native Method) at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:493) at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:858)</code> </pre></div></div><br><p>  En Stackoverflow, la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">pregunta</a> sobre este tema es una de las m√°s populares.  En resumen, el problema es que mostramos el cuadro de di√°logo o no lo cerramos despu√©s de que se completa la activaci√≥n. </p><br><p>  Por supuesto, puede llamar a descartar en el di√°logo en la actividad onPause o onDestroy, como se recomienda en la respuesta por <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">referencia</a> .  Pero esto no es exactamente lo que necesitamos.  Queremos que el di√°logo se recupere despu√©s de encender el dispositivo. </p><br><h1 id="ustarevshiy-sposob">  Manera anticuada </h1><br><p>  Antes de que aparecieran fragmentos en Android, los cuadros de di√°logo deber√≠an haberse mostrado mediante una llamada al m√©todo de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">activaci√≥n showDialog</a> .  En este caso, la actividad controla correctamente el ciclo de vida del di√°logo y lo restaura despu√©s de un turno.  La creaci√≥n del di√°logo en s√≠ tuvo que implementarse en la devoluci√≥n de llamada onCreateDialog: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainActivity</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Activity</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> CONFIRMATION_DIALOG_ID = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-comment"><span class="hljs-comment">// ... @Override protected Dialog onCreateDialog(int id, Bundle args) { if (id == CONFIRMATION_DIALOG_ID) { return new AlertDialog.Builder(this) .setMessage("Please, confirm the action") .setPositiveButton("Confirm", new DialogInterface.OnClickListener() { @Override public void onClick(DialogInterface dialog, int which) { // handle click } }) .create(); } else { return super.onCreateDialog(id, args); } } }</span></span></code> </pre> <br><p>  No es muy conveniente que tenga que iniciar un identificador de di√°logo y pasar par√°metros a trav√©s del paquete.  Y todav√≠a podemos obtener el problema de la "ventana filtrada" si intentamos mostrar un cuadro de di√°logo despu√©s de llamar a Destroy sobre la actividad.  Esto es posible, por ejemplo, cuando se intenta mostrar un error despu√©s de una operaci√≥n asincr√≥nica. </p><br><p>  En general, este problema es t√≠pico de Android, cuando necesita hacer algo despu√©s de una operaci√≥n asincr√≥nica, y la actividad o fragmento ya est√° destruido en ese momento.  Esta es probablemente la raz√≥n por la cual los patrones MV * son m√°s populares en la comunidad de Android que entre los desarrolladores de iOS. </p><br><h1 id="sposob-iz-dokumentacii">  M√©todo de la documentaci√≥n. </h1><br><p>  Los fragmentos aparecieron en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Android Honeycomb</a> , y el m√©todo descrito anteriormente est√° en desuso, y el m√©todo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">showDialog</a> de la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">actividad est√°</a> marcado como en desuso.  No, AlertDialog no est√° desactualizado, ya que muchos est√°n equivocados.  Justo ahora hay <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">DialogFragment</a> , que envuelve el objeto de di√°logo y controla su ciclo de vida. </p><br><blockquote>  Los fragmentos nativos tambi√©n est√°n en desuso desde la API 28.  Ahora debe usar solo la implementaci√≥n de la Biblioteca de soporte (AndroidX). </blockquote><p>  Realicemos nuestra tarea, seg√∫n lo prescrito por la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">documentaci√≥n oficial</a> : </p><br><ol><li>  Primero debe heredar de DialogFragment e implementar la creaci√≥n de un di√°logo en el m√©todo onCreateDialog. </li><li>  Describa la interfaz del evento de di√°logo e instancia el oyente en el m√©todo onAttach. </li><li>  Implemente una interfaz de evento de di√°logo en una actividad o fragmento. </li></ol><br><blockquote>  Si el lector no tiene muy claro por qu√© el oyente no puede pasar por el constructor, puede leer m√°s sobre esto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> </blockquote><p>  C√≥digo de fragmento de di√°logo: </p><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConfirmationDialogFragment</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DialogFragment</span></span></span></span>() { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConfirmationListener</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">confirmButtonClicked</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cancelButtonClicked</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lateinit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> listener: ConfirmationListener <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onAttach</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(context: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Context</span></span></span></span><span class="hljs-function"><span class="hljs-params">?)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onAttach(context) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">// Instantiate the ConfirmationListener so we can send events to the host listener = activity as ConfirmationListener } catch (e: ClassCastException) { // The activity doesn't implement the interface, throw exception throw ClassCastException(activity.toString() + " must implement ConfirmationListener") } } override fun onCreateDialog(savedInstanceState: Bundle?): Dialog { return AlertDialog.Builder(context!!) .setMessage("Please, confirm the action") .setPositiveButton("Confirm") { _, _ -&gt; listener.confirmButtonClicked() } .setNegativeButton("Cancel") { _, _ -&gt; listener.cancelButtonClicked() } .create() } }</span></span></code> </pre> <br><p>  C√≥digo de activaci√≥n: </p><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainActivity</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AppCompatActivity</span></span></span></span>(), ConfirmationListener { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">showConfirmationDialog</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { ConfirmationDialogFragment() .show(supportFragmentManager, <span class="hljs-string"><span class="hljs-string">"ConfirmationDialogFragmentTag"</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">confirmButtonClicked</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-comment"><span class="hljs-comment">// handle click } override fun cancelButtonClicked() { // handle click } }</span></span></code> </pre> <br><p>  Suficiente c√≥digo result√≥, ¬øverdad? </p><br><p>  Como regla, hay alg√∫n tipo de MVP en el proyecto, pero decid√≠ que las llamadas de presentador pueden omitirse en este caso.  En el ejemplo anterior, vale la pena agregar el m√©todo est√°tico para crear el cuadro de di√°logo newInstance y pasar par√°metros a los argumentos del fragmento, todo como se esperaba. </p><br><p>  Y esto es todo para que el di√°logo se oculte a tiempo y se restaure correctamente.  No es sorprendente que tales preguntas surjan en Stackoverflow: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">uno</a> y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">dos</a> . </p><br><h1 id="poisk-idealnogo-resheniya">  Encontrar la soluci√≥n perfecta </h1><br><p>  El estado actual de las cosas no nos conven√≠a, y comenzamos a buscar una manera de hacer que trabajar con di√°logos fuera m√°s c√≥modo.  Hubo la sensaci√≥n de que puedes hacerlo m√°s f√°cil, casi como en el primer m√©todo. </p><br><p>  Las siguientes son las consideraciones que nos guiaron: </p><br><ul><li>  <strong>¬øNecesito guardar y restaurar el di√°logo despu√©s de finalizar el proceso de solicitud?</strong> <br>  En la mayor√≠a de los casos, esto no es obligatorio, como en nuestro ejemplo, cuando necesita mostrar un mensaje simple o preguntar algo.  Tal di√°logo es relevante hasta que se pierde la atenci√≥n del usuario.  Si lo restaura despu√©s de una larga ausencia en la aplicaci√≥n, el usuario perder√° el contexto con la acci√≥n planificada.  Por lo tanto, <strong>solo necesita soportar los giros del dispositivo</strong> y manejar correctamente el ciclo de vida del di√°logo.  De lo contrario, debido al movimiento inc√≥modo del dispositivo, el usuario puede perder el mensaje que se acaba de abrir sin leerlo. </li><li>  Cuando se usa DialogFragment, aparece demasiado c√≥digo repetitivo, se pierde simplicidad.  Por lo tanto, ser√≠a bueno deshacerse del fragmento como envoltorio y <strong>usar Dialog directamente</strong> .  Para hacer esto, debe almacenar el estado del cuadro de di√°logo para mostrarlo nuevamente despu√©s de volver a crear la Vista y ocultarlo cuando la Vista muera. </li><li>  Todos est√°n acostumbrados a percibir la visualizaci√≥n del di√°logo como un equipo, especialmente si trabajas solo con MVP.  La tarea de la restauraci√≥n posterior del estado es asumida por el FragmentManager.  Pero puede ver esta situaci√≥n de manera diferente y comenzar a <strong>percibir el di√°logo como un estado</strong> .  Esto es mucho m√°s conveniente cuando se trabaja con patrones PM o MVVM. </li><li>  Dado que la mayor√≠a de las aplicaciones ahora usan enfoques reactivos, es necesario <strong>que los di√°logos sean reactivos</strong> .  La tarea principal es no romper la cadena que inicia la visualizaci√≥n del di√°logo, y adjuntar una secuencia reactiva de eventos para obtener un resultado del mismo.  Esto es muy conveniente en el lado PresentationModel / ViewModel cuando est√° manipulando m√∫ltiples flujos de datos. </li></ul><br><p>  Tomamos en cuenta todos los requisitos anteriores y se nos ocurri√≥ una forma de mostrar reactivamente los di√°logos que implementamos con √©xito en nuestra biblioteca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">RxPM</a> (hay un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">art√≠culo</a> separado al respecto). </p><br><p>  La soluci√≥n en s√≠ no requiere una biblioteca y se puede hacer por separado.  Guiado por la idea del "di√°logo como estado", puede intentar construir una soluci√≥n basada en el moderno ViewModel y LiveData.  Pero dejar√© esto al lector, y luego hablaremos sobre una soluci√≥n preparada de la biblioteca. </p><br><h1 id="reaktivnyy-sposob">  M√©todo reactivo </h1><br><p>  Mostrar√© c√≥mo se resuelve la tarea inicial en RxPM, pero primero algunas palabras sobre los conceptos clave de la biblioteca: </p><br><ul><li>  <strong>PresentationModel</strong> : almacena un estado de reacci√≥n, contiene l√≥gica de interfaz de usuario, sobrevive a los turnos. </li><li>  <strong>El estado</strong> es un <strong>estado</strong> reactivo.  Puede pensarlo como un contenedor sobre BehaviorRelay. </li><li>  <strong>Acci√≥n</strong> : un contenedor sobre PublishRelay, sirve para transferir eventos de View a PresentationModel. </li><li>  <strong>Estado</strong> y <strong>Acci√≥n</strong> tienen observable y consumidor. </li></ul><br><p>  La clase <a href="">DialogControl</a> es responsable del estado del di√°logo.  Tiene dos par√°metros: el primero para el tipo de datos que deben mostrarse en el cuadro de di√°logo, el segundo para el tipo de resultado.  En nuestro ejemplo, el tipo de datos ser√° Unidad, pero puede ser un mensaje para el usuario o cualquier otro tipo. </p><br><p>  DialogControl tiene los siguientes m√©todos: </p><br><ul><li>  <code>show(data: T)</code> : solo da un comando para mostrar. </li><li>  <code>showForResult(data: T): Maybe&lt;R&gt;</code> : muestra un cuadro de di√°logo y abre la secuencia para obtener el resultado. </li><li>  <code>sendResult(result: R)</code> : env√≠a el resultado, se llama desde el lado Vista. </li><li>  <code>dismiss()</code> : solo oculta el di√°logo. </li></ul><br><p>  DialogControl almacena el estado: ¬øhay un di√°logo en la pantalla o no? (Visualizado / Ausente).  As√≠ es como se ve en el c√≥digo de clase: </p><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DialogControl</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">T, R</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">internal</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">constructor</span></span></span></span>(pm: PresentationModel) { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> displayed = pm.State&lt;Display&gt;(Absent) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> result = pm.Action&lt;R&gt;() <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Display</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">data</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Displayed</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">T</span></span></span><span class="hljs-class">&gt;</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">val</span></span> <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>: T) : Display() <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> Absent : Display() } <span class="hljs-comment"><span class="hljs-comment">// ... }</span></span></code> </pre> <br><p>  Cree un PresentationModel simple: </p><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SamplePresentationModel</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PresentationModel</span></span></span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConfirmationDialogResult</span></span></span><span class="hljs-class"> </span></span>{ CONFIRMED, CANCELED } <span class="hljs-comment"><span class="hljs-comment">//        enum    val confirmationDialog = dialogControl&lt;Unit, ConfirmationDialogResult&gt;() val buttonClicks = Action&lt;Unit&gt;() override fun onCreate() { super.onCreate() buttonClicks.observable .switchMapMaybe { //           confirmationDialog.showForResult(Unit) .filter { it == ConfirmationDialogResult.CONFIRMED } } .subscribe { //   } .untilDestroy() } }</span></span></code> </pre> <br><p>  Tenga en cuenta que el procesamiento de clics, la confirmaci√≥n de confirmaci√≥n y el procesamiento de acciones se implementan en la misma cadena.  Esto le permite enfocar el c√≥digo y no dispersar la l√≥gica en varias devoluciones de llamada. </p><br><p>  Luego, simplemente vinculamos DialogControl a la Vista usando la extensi√≥n bindTo. <br>  Recopilamos el AlertDialog habitual y enviamos el resultado a trav√©s de sendResult: </p><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SampleActivity</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PmSupportActivity</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SamplePresentationModel</span></span></span><span class="hljs-class">&gt;</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">providePresentationModel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> = SamplePresentationModel() <span class="hljs-comment"><span class="hljs-comment">//     View  PresentationModel override fun onBindPresentationModel(pm: SamplePresentationModel) { pm.confirmationDialog bindTo { data, dialogControl -&gt; AlertDialog.Builder(this@SampleActivity) .setMessage("Please, confirm the action") .setPositiveButton("Confirm") { _, _ -&gt; dialogControl.sendResult(CONFIRMED) } .setNegativeButton("Cancel") { _, _ -&gt; dialogControl.sendResult(CANCELED) } .create() } button.clicks() bindTo pm.buttonClicks } }</span></span></code> </pre> <br><p>  En un escenario t√≠pico, algo as√≠ sucede debajo del cap√≥: </p><br><ol><li>  Hacemos clic en el bot√≥n, el evento a trav√©s de la acci√≥n "buttonClicks" entra en PresentationModel. </li><li>  Para este evento, iniciamos la visualizaci√≥n del cuadro de di√°logo a trav√©s de la llamada a showForResult. </li><li>  Como resultado, el estado en DialogControl cambia de Ausente a Visualizado. </li><li>  Cuando se recibe el evento Displayed, se llama a la lambda que pasamos en el enlace bindTo.  Se crea un objeto de di√°logo en √©l, que luego se muestra. </li><li>  El usuario presiona el bot√≥n Confirmar, el oyente dispara y el resultado del clic se env√≠a a DialogControl llamando a sendResult. </li><li>  A continuaci√≥n, el resultado cae en el "resultado" interno de la acci√≥n, y el estado de Visualizado cambia a Ausente. </li><li>  Cuando se recibe un evento ausente, se cierra el di√°logo actual. </li><li>  El evento del "resultado" de la acci√≥n cae en la secuencia que abri√≥ la llamada a showForResult y es procesada por la cadena en PresentationModel. </li></ol><br><p>  Vale la pena se√±alar que el cuadro de di√°logo se cierra incluso cuando la vista se desata de PresentationModel.  En este caso, el estado permanece Visualizado.  Se recibir√° en el pr√≥ximo enlace y se restablecer√° el di√°logo. </p><br><p>  Como puede ver, la necesidad de DialogFragment ha desaparecido.  El cuadro de di√°logo se muestra cuando la Vista se adjunta al Modelo de presentaci√≥n y se oculta cuando la Vista se desata.  Debido al hecho de que el estado se almacena en DialogControl, que a su vez se almacena en PresentationModel, el di√°logo se restaura despu√©s de que se gira el dispositivo. </p><br><h1 id="pishite-dialogi-pravilno">  Escribir di√°logos correctamente </h1><br><p>  Hemos examinado varias formas de mostrar cuadros de di√°logo.  Si sigues apareciendo de la primera manera, te lo ruego, no lo hagas m√°s.  Para los amantes de MVP no queda nada m√°s que usar el m√©todo est√°ndar, que se describe en la documentaci√≥n oficial.  Desafortunadamente, la tendencia al imperativo de este patr√≥n no permite hacer lo contrario.  Bueno, les recomiendo a los fan√°ticos de RxJava que observen m√°s de cerca el m√©todo reactivo y nuestra biblioteca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">RxPM</a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/440284/">https://habr.com/ru/post/440284/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../440274/index.html">Construyendo un servicio de moneda privada usando Exonum</a></li>
<li><a href="../440276/index.html">Depuraci√≥n frontal y posterior</a></li>
<li><a href="../440278/index.html">Cambiar Yesca a Kubernetes</a></li>
<li><a href="../440280/index.html">Revisi√≥n de software libre de Android</a></li>
<li><a href="../440282/index.html">Los marcos web Python m√°s r√°pidos en 2019</a></li>
<li><a href="../440286/index.html">Ruido Perlin, generaci√≥n de contenido procesal y espacio interesante.</a></li>
<li><a href="../440288/index.html">Seguridad de IoT. N√∫mero 1. Relojes inteligentes, rastreadores de ejercicios y escalas</a></li>
<li><a href="../440292/index.html">El libro ‚ÄúUnidad en acci√≥n. Desarrollo multiplataforma en C #. 2nd int. edici√≥n ¬ª</a></li>
<li><a href="../440294/index.html">Enrutador MIDI en Raspberry Pi</a></li>
<li><a href="../440296/index.html">6 aplicaciones para el IoT industrial</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>