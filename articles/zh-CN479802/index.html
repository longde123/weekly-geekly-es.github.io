<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ• ğŸ–ï¸ â˜˜ï¸ C ++ vtablesã€‚ ç¬¬1éƒ¨åˆ†ï¼ˆåŸºç¡€çŸ¥è¯†+å¤šé‡ç»§æ‰¿ï¼‰ ğŸ¢ ğŸ¦‹ â˜ğŸ½</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="å¤§å®¶å¥½ï¼ æœ¬æ–‡çš„ç¿»è¯‘æ˜¯ä¸“é—¨ä¸ºâ€œ C ++å¼€å‘äººå‘˜â€è¯¾ç¨‹çš„å­¦ç”Ÿå‡†å¤‡çš„ã€‚ æœè¿™ä¸ªæ–¹å‘å‘å±•æ˜¯å¦æœ‰è¶£ï¼Ÿ 12æœˆ13æ—¥åœ¨è«æ–¯ç§‘æ—¶é—´20:00ä¸Šçº¿ã€‚ åˆ°â€œä½¿ç”¨Googleæµ‹è¯•æ¡†æ¶çš„å®è·µâ€å¤§å¸ˆç­ï¼ 





 åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†ç ”ç©¶clangå¦‚ä½•å®ç°vtableï¼ˆè™šæ‹Ÿæ–¹æ³•è¡¨ï¼‰å’ŒRTTIï¼ˆè¿è¡Œæ—¶ç±»å‹æ ‡è¯†ï¼‰ã€‚ åœ¨ç¬¬ä¸€...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>C ++ vtablesã€‚ ç¬¬1éƒ¨åˆ†ï¼ˆåŸºç¡€çŸ¥è¯†+å¤šé‡ç»§æ‰¿ï¼‰</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/479802/"><p>  <em>å¤§å®¶å¥½ï¼</em>  <em>æœ¬æ–‡çš„ç¿»è¯‘æ˜¯ä¸“é—¨ä¸º<a href="https://otus.pw/d2qJ/">â€œ C ++å¼€å‘äººå‘˜â€</a>è¯¾ç¨‹çš„å­¦ç”Ÿå‡†å¤‡çš„ã€‚</em>  <em>æœè¿™ä¸ªæ–¹å‘å‘å±•æ˜¯å¦æœ‰è¶£ï¼Ÿ</em>  <em>12æœˆ13æ—¥åœ¨è«æ–¯ç§‘æ—¶é—´20:00ä¸Šçº¿ã€‚</em>  <em>åˆ°<a href="https://otus.pw/x79M/">â€œä½¿ç”¨Googleæµ‹è¯•æ¡†æ¶çš„å®è·µâ€</a>å¤§å¸ˆç­ï¼</em> </p><br><p><img src="https://habrastorage.org/webt/eh/lh/ox/ehlhoxzs1sz7v7xtni9lizjefxq.png"></p><br><p> åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†ç ”ç©¶clangå¦‚ä½•å®ç°vtableï¼ˆè™šæ‹Ÿæ–¹æ³•è¡¨ï¼‰å’ŒRTTIï¼ˆè¿è¡Œæ—¶ç±»å‹æ ‡è¯†ï¼‰ã€‚ åœ¨ç¬¬ä¸€éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬ä»åŸºç±»å¼€å§‹ï¼Œç„¶åç ”ç©¶å¤šé‡å’Œè™šæ‹Ÿç»§æ‰¿ã€‚ <a name="habracut"></a></p><br><p> è¯·æ³¨æ„ï¼Œåœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å¿…é¡»æ·±å…¥ç ”ç©¶ä½¿ç”¨gdbä¸ºä»£ç çš„å„ä¸ªéƒ¨åˆ†ç”Ÿæˆçš„äºŒè¿›åˆ¶è¡¨ç¤ºå½¢å¼ã€‚ è¿™æ˜¯ä¸€ä¸ªå¾ˆä½çš„æ°´å¹³ï¼Œä½†æ˜¯æˆ‘ä¼šä¸ºæ‚¨åšæ‰€æœ‰çš„åŠªåŠ›å·¥ä½œã€‚ æˆ‘è®¤ä¸ºå°†æ¥çš„å¤§å¤šæ•°èŒä½éƒ½ä¸ä¼šæè¿°å¦‚æ­¤ä½æ°´å¹³çš„ç»†èŠ‚ã€‚ </p><br><blockquote>  <em>å…è´£å£°æ˜</em> ï¼šæ­¤å¤„ç¼–å†™çš„æ‰€æœ‰å†…å®¹å‡å–å†³äºå®ç°ï¼Œåœ¨å°†æ¥çš„ä»»ä½•ç‰ˆæœ¬ä¸­éƒ½å¯èƒ½ä¼šæ›´æ”¹ï¼Œå› æ­¤æ‚¨ä¸åº”ä¾èµ–å®ƒã€‚ æˆ‘ä»¬ä»…å‡ºäºæ•™è‚²ç›®çš„è€ƒè™‘ã€‚ </blockquote><p><img src="https://habrastorage.org/webt/40/po/du/40podustjhxkcl7_keexd9uea2e.png"></p><br><p> å¤ªå¥½äº†ï¼Œé‚£å°±å¼€å§‹å§ã€‚ </p><br><h2 id="chast-1---vtables---osnovy"> ç¬¬1éƒ¨åˆ†-vtables-åŸºç¡€ </h2><br><p> è®©æˆ‘ä»¬çœ‹ä¸‹é¢çš„ä»£ç ï¼š </p><br><pre><code class="plaintext hljs">#include &lt;iostream&gt; using namespace std; class NonVirtualClass { public: void foo() {} }; class VirtualClass { public: virtual void foo() {} }; int main() { cout &lt;&lt; "Size of NonVirtualClass: " &lt;&lt; sizeof(NonVirtualClass) &lt;&lt; endl; cout &lt;&lt; "Size of VirtualClass: " &lt;&lt; sizeof(VirtualClass) &lt;&lt; endl; }</code> </pre> <br><pre> <code class="plaintext hljs">$ #    main.cpp $ clang++ main.cpp &amp;&amp; ./a.out Size of NonVirtualClass: 1 Size of VirtualClass: 8</code> </pre> <br><p>  <code>NonVirtualClass</code>çš„å¤§å°ä¸º1ä¸ªå­—èŠ‚ï¼Œå› ä¸ºåœ¨C ++ä¸­ï¼Œç±»çš„å¤§å°ä¸èƒ½ä¸ºé›¶ã€‚ ä½†æ˜¯ï¼Œè¿™ç°åœ¨å¹¶ä¸é‡è¦ã€‚ </p><br><p> åœ¨64ä½è®¡ç®—æœºä¸Šï¼Œ <code>VirtualClass</code>æ˜¯8ä¸ªå­—èŠ‚ã€‚ æ€ä¹ˆäº† å› ä¸ºé‡Œé¢æœ‰ä¸€ä¸ªæŒ‡å‘vtableçš„éšè—æŒ‡é’ˆã€‚  vtableæ˜¯ä¸ºæ¯ä¸ªè™šæ‹Ÿç±»åˆ›å»ºçš„é™æ€è½¬æ¢è¡¨ã€‚ æœ¬æ–‡è®¨è®ºäº†å®ƒä»¬çš„å†…å®¹ä»¥åŠå¦‚ä½•ä½¿ç”¨å®ƒä»¬ã€‚ </p><br><p> ä¸ºäº†æ›´æ·±å…¥åœ°äº†è§£vtableçš„å¤–è§‚ï¼Œè®©æˆ‘ä»¬ç”¨gdbæŸ¥çœ‹ä»¥ä¸‹ä»£ç ï¼Œä»¥äº†è§£å¦‚ä½•åˆ†é…å†…å­˜ï¼š </p><br><pre> <code class="plaintext hljs">#include &lt;iostream&gt; class Parent { public: virtual void Foo() {} virtual void FooNotOverridden() {} }; class Derived : public Parent { public: void Foo() override {} }; int main() { Parent p1, p2; Derived d1, d2; std::cout &lt;&lt; "done" &lt;&lt; std::endl; }</code> </pre> <br><pre> <code class="plaintext hljs">$ #         ,  gdb $ clang++ -std=c++14 -stdlib=libc++ -g main.cpp &amp;&amp; gdb ./a.out ... (gdb) #  gdb  -  C++ (gdb) set print asm-demangle on (gdb) set print demangle on (gdb) #     main (gdb) b main Breakpoint 1 at 0x4009ac: file main.cpp, line 15. (gdb) run Starting program: /home/shmike/cpp/a.out Breakpoint 1, main () at main.cpp:15 15 Parent p1, p2; (gdb) #     (gdb) n 16 Derived d1, d2; (gdb) #     (gdb) n 18 std::cout &lt;&lt; "done" &lt;&lt; std::endl; (gdb) #  p1, p2, d1, d2 -     ,    (gdb) p p1 $1 = {_vptr$Parent = 0x400bb8 &lt;vtable for Parent+16&gt;} (gdb) p p2 $2 = {_vptr$Parent = 0x400bb8 &lt;vtable for Parent+16&gt;} (gdb) p d1 $3 = {&lt;Parent&gt; = {_vptr$Parent = 0x400b50 &lt;vtable for Derived+16&gt;}, &lt;No data fields&gt;} (gdb) p d2 $4 = {&lt;Parent&gt; = {_vptr$Parent = 0x400b50 &lt;vtable for Derived+16&gt;}, &lt;No data fields&gt;}</code> </pre> <br><p> è¿™æ˜¯æˆ‘ä»¬ä»ä¸Šé¢ä¸­å­¦åˆ°çš„å†…å®¹ï¼š <br>  -å°½ç®¡ç±»æ²¡æœ‰æ•°æ®æˆå‘˜ï¼Œä½†å­˜åœ¨æŒ‡å‘vtableçš„éšè—æŒ‡é’ˆï¼› <br>  -p1å’Œp2çš„vtableç›¸åŒã€‚  vtableæ˜¯æ¯ç§ç±»å‹çš„é™æ€æ•°æ®ï¼› <br>  -d1å’Œd2ç»§æ‰¿äº†Parentçš„vtable-pointerï¼Œè¯¥æŒ‡é’ˆæŒ‡å‘vtable Derivedï¼› <br>  -æ‰€æœ‰vtableæŒ‡ç¤ºè¯¥vtableä¸­æœ‰16ï¼ˆ0x10ï¼‰ä¸ªå­—èŠ‚çš„åç§»é‡ã€‚ æˆ‘ä»¬ç¨åè¿˜å°†è®¨è®ºã€‚ </p><br><p> è®©æˆ‘ä»¬ç»§ç»­æˆ‘ä»¬çš„gdbä¼šè¯ä»¥æŸ¥çœ‹vtablesçš„å†…å®¹ã€‚ æˆ‘å°†ä½¿ç”¨xå‘½ä»¤ï¼Œè¯¥å‘½ä»¤åœ¨å±å¹•ä¸Šæ˜¾ç¤ºå†…å­˜ã€‚ æˆ‘ä»¬å°†ä»0x400b40å¼€å§‹ä»¥åå…­è¿›åˆ¶è¾“å‡º300ä¸ªå­—èŠ‚ã€‚ ä¸ºä»€ä¹ˆè¦è¿™ä¸ªåœ°å€å‘¢ï¼Ÿ å› ä¸ºæˆ‘ä»¬åœ¨ä¸Šé¢çœ‹åˆ°vtableæŒ‡é’ˆæŒ‡å‘0x400b50ï¼Œå¹¶ä¸”è¯¥åœ°å€çš„ç¬¦å·<code>vtable for Derived+16 (16 == 0x10)</code>æ˜¯<code>vtable for Derived+16 (16 == 0x10)</code> ã€‚ </p><br><pre> <code class="plaintext hljs">(gdb) x/300xb 0x400b40 0x400b40 &lt;vtable for Derived&gt;: 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x400b48 &lt;vtable for Derived+8&gt;: 0x90 0x0b 0x40 0x00 0x00 0x00 0x00 0x00 0x400b50 &lt;vtable for Derived+16&gt;: 0x80 0x0a 0x40 0x00 0x00 0x00 0x00 0x00 0x400b58 &lt;vtable for Derived+24&gt;: 0x90 0x0a 0x40 0x00 0x00 0x00 0x00 0x00 0x400b60 &lt;typeinfo name for Derived&gt;: 0x37 0x44 0x65 0x72 0x69 0x76 0x65 0x64 0x400b68 &lt;typeinfo name for Derived+8&gt;: 0x00 0x36 0x50 0x61 0x72 0x65 0x6e 0x74 0x400b70 &lt;typeinfo name for Parent+7&gt;: 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x400b78 &lt;typeinfo for Parent&gt;: 0x90 0x20 0x60 0x00 0x00 0x00 0x00 0x00 0x400b80 &lt;typeinfo for Parent+8&gt;: 0x69 0x0b 0x40 0x00 0x00 0x00 0x00 0x00 0x400b88: 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x400b90 &lt;typeinfo for Derived&gt;: 0x10 0x22 0x60 0x00 0x00 0x00 0x00 0x00 0x400b98 &lt;typeinfo for Derived+8&gt;: 0x60 0x0b 0x40 0x00 0x00 0x00 0x00 0x00 0x400ba0 &lt;typeinfo for Derived+16&gt;: 0x78 0x0b 0x40 0x00 0x00 0x00 0x00 0x00 0x400ba8 &lt;vtable for Parent&gt;: 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x400bb0 &lt;vtable for Parent+8&gt;: 0x78 0x0b 0x40 0x00 0x00 0x00 0x00 0x00 0x400bb8 &lt;vtable for Parent+16&gt;: 0xa0 0x0a 0x40 0x00 0x00 0x00 0x00 0x00 0x400bc0 &lt;vtable for Parent+24&gt;: 0x90 0x0a 0x40 0x00 0x00 0x00 0x00 0x00 ...</code> </pre> <br><blockquote> æ³¨æ„ï¼šæˆ‘ä»¬çœ‹ä¸€ä¸‹ç»è¿‡ä¿®é¥°çš„å­—ç¬¦ã€‚ å¦‚æœæ‚¨çœŸçš„å¾ˆæ„Ÿå…´è¶£ï¼Œåˆ™_ZTVæ˜¯vtableçš„å‰ç¼€ï¼Œ_ZTSæ˜¯ç±»å‹å­—ç¬¦ä¸²ï¼ˆåç§°ï¼‰çš„å‰ç¼€ï¼Œè€Œ_ZTIæ˜¯typeinfoçš„å‰ç¼€ã€‚ </blockquote><br><hr><br><p> è¿™æ˜¯<code>vtable Parent</code>ç»“æ„ï¼š </p><br><div class="scrollable-table"><table><thead><tr><th> åœ°å€ </th><th> ä»·å€¼ </th><th> ç›®å½•å†…å®¹ </th></tr></thead><tbody><tr><td>  0x400ba8 </td><td>  0x0 </td><td>  top_offsetï¼ˆç¨åä¼šè¯¦ç»†ä»‹ç»ï¼‰ </td></tr><tr><td>  0x400bb0 </td><td>  0x400b78 </td><td> æŒ‡å‘Parentçš„typeinfoçš„æŒ‡é’ˆï¼ˆä¹Ÿæ˜¯ä¸Šè¿°å†…å­˜è½¬å‚¨çš„ä¸€éƒ¨åˆ†ï¼‰ </td></tr><tr><td>  0x400bb8 </td><td>  0x400aa0 </td><td> æŒ‡å‘çˆ¶çº§çš„æŒ‡é’ˆ:: Fooï¼ˆï¼‰ <em>ï¼ˆ1ï¼‰</em> ã€‚  _vptrçˆ¶é¡¹æŒ‡å‘æ­¤å¤„ã€‚ </td></tr><tr><td>  0x400bc0 </td><td>  0x400a90 </td><td> æŒ‡å‘çˆ¶çº§çš„æŒ‡é’ˆ:: FooNotOverriddenï¼ˆï¼‰ <em>ï¼ˆ2ï¼‰</em> </td></tr></tbody></table></div><br><p> è¿™æ˜¯<code>vtable Derived</code>ç»“æ„ï¼š </p><br><div class="scrollable-table"><table><thead><tr><th> åœ°å€ </th><th> ä»·å€¼ </th><th> ç›®å½•å†…å®¹ </th></tr></thead><tbody><tr><td>  0x400b40 </td><td>  0x0 </td><td>  top_offsetï¼ˆç¨åä¼šè¯¦ç»†ä»‹ç»ï¼‰ </td></tr><tr><td>  0x400b48 </td><td>  0x400b90 </td><td> æŒ‡å‘æ´¾ç”Ÿçš„typeinfoçš„æŒ‡é’ˆï¼ˆä¹Ÿæ˜¯ä¸Šè¿°å†…å­˜è½¬å‚¨çš„ä¸€éƒ¨åˆ†ï¼‰ </td></tr><tr><td>  0x400b50 </td><td>  0x400a80 </td><td> æŒ‡å‘æ´¾ç”ŸæŒ‡é’ˆ:: Fooï¼ˆï¼‰ <em>ï¼ˆ3ï¼‰</em> ã€‚ï¼Œ_ Vptræ´¾ç”ŸæŒ‡å‘æ­¤å¤„ã€‚ </td></tr><tr><td>  0x400b58 </td><td>  0x400a90 </td><td> æŒ‡å‘çˆ¶çº§çš„æŒ‡é’ˆ:: FooNotOverriddenï¼ˆï¼‰ï¼ˆä¸çˆ¶çº§ç›¸åŒï¼‰ </td></tr></tbody></table></div><br><p>  1ï¼š </p><br><pre> <code class="plaintext hljs">(gdb) # ,        0x400aa0 (gdb) info symbol 0x400aa0 Parent::Foo() in section .text of a.out</code> </pre> <br><p>  2ï¼š </p><br><pre> <code class="plaintext hljs">(gdb) info symbol 0x400a90 Parent::FooNotOverridden() in section .text of a.out</code> </pre> <br><p>  3ï¼š </p><br><pre> <code class="plaintext hljs">(gdb) info symbol 0x400a80 Derived::Foo() in section .text of a.out</code> </pre> <br><p> è¿˜è®°å¾—Derivedä¸­çš„vtableæŒ‡é’ˆæŒ‡å‘vtableä¸­+16å­—èŠ‚çš„åç§»å—ï¼Ÿ ç¬¬ä¸‰ä¸ªæŒ‡é’ˆæ˜¯ç¬¬ä¸€ç§æ–¹æ³•çš„æŒ‡é’ˆçš„åœ°å€ã€‚ æƒ³è¦ç¬¬ä¸‰ç§æ–¹æ³•ï¼Ÿ æ²¡é—®é¢˜-å‘vtableæŒ‡é’ˆæ·»åŠ 2 <em>sizeofï¼ˆvoid</em> ï¼‰ã€‚ éœ€è¦typeinfoè®°å½•å—ï¼Ÿ è½¬åˆ°å®ƒå‰é¢çš„æŒ‡é’ˆã€‚ </p><br><p> ç»§ç»­-typeinfoè®°å½•ç»“æ„å¦‚ä½•ï¼Ÿ </p><br><p>  <code>Parent</code> ï¼š </p><br><div class="scrollable-table"><table><thead><tr><th> åœ°å€ </th><th> ä»·å€¼ </th><th> ç›®å½•å†…å®¹ </th></tr></thead><tbody><tr><td>  0x400b78 </td><td>  0x602090 </td><td>  type_info <em>ï¼ˆ1ï¼‰</em>æ–¹æ³•çš„å¸®åŠ©ç¨‹åºç±» </td></tr><tr><td>  0x400b80 </td><td>  0x400b69 </td><td> ä»£è¡¨ç±»å‹åç§°çš„å­—ç¬¦ä¸²<em>ï¼ˆ2ï¼‰</em> </td></tr><tr><td>  0x400b88 </td><td>  0x0 </td><td>  0è¡¨ç¤ºæ²¡æœ‰çˆ¶ç±»å‹ä¿¡æ¯æ¡ç›® </td></tr></tbody></table></div><br><p> è¿™æ˜¯<code>typeinfo Derived</code>æ¡ç›®ï¼š </p><br><div class="scrollable-table"><table><thead><tr><th> åœ°å€ </th><th> ä»·å€¼ </th><th> ç›®å½•å†…å®¹ </th></tr></thead><tbody><tr><td>  0x400b90 </td><td>  0x602210 </td><td>  type_info <em>ï¼ˆ3ï¼‰</em>æ–¹æ³•çš„å¸®åŠ©ç¨‹åºç±» </td></tr><tr><td>  0x400b98 </td><td>  0x400b60 </td><td> ä»£è¡¨ç±»å‹åç§°çš„å­—ç¬¦ä¸²<em>ï¼ˆ4ï¼‰</em> </td></tr><tr><td>  0x400ba0 </td><td>  0x400b78 </td><td> æŒ‡å‘typeinfoçˆ¶é¡¹çš„æŒ‡é’ˆ </td></tr></tbody></table></div><br><p>  1ï¼š </p><br><pre> <code class="plaintext hljs">(gdb) info symbol 0x602090 vtable for __cxxabiv1::__class_type_info@@CXXABI_1.3 + 16 in section .bss of a.out</code> </pre> <br><p>  2ï¼š </p><br><pre> <code class="plaintext hljs">(gdb) x/s 0x400b69 0x400b69 &lt;typeinfo name for Parent&gt;: "6Parent"</code> </pre> <br><p>  3ï¼š </p><br><pre> <code class="plaintext hljs">(gdb) info symbol 0x602210 vtable for __cxxabiv1::__si_class_type_info@@CXXABI_1.3 + 16 in section .bss of a.out</code> </pre> <br><p>  4ï¼š </p><br><pre> <code class="plaintext hljs">(gdb) x/s 0x400b60 0x400b60 &lt;typeinfo name for Derived&gt;: "7Derived"</code> </pre> <br><p> å¦‚æœæ‚¨æƒ³äº†è§£æœ‰å…³__si_class_type_infoçš„æ›´å¤šä¿¡æ¯ï¼Œå¯ä»¥<a href="https://refspecs.linuxfoundation.org/LSB_4.0.0/LSB-CXX-generic/LSB-CXX-generic/baselib.html">åœ¨æ­¤å¤„</a>å’Œ<a href="https://gcc.gnu.org/onlinedocs/gcc-4.6.2/libstdc%2B%2B/api/a01094_source.html">æ­¤å¤„</a>æ‰¾åˆ°ä¸€äº›ä¿¡æ¯ã€‚ </p><br><p> è¿™ç”¨å°½äº†æˆ‘åœ¨gdbä¸Šçš„æŠ€èƒ½ï¼Œå¹¶ä¸”è¿˜å®Œæˆäº†è¿™ä¸€éƒ¨åˆ†ã€‚ æˆ‘å»ºè®®æœ‰äº›äººè®¤ä¸ºè¿™å¤ªä½äº†ï¼Œæˆ–è€…æ ¹æœ¬å°±æ²¡æœ‰å®ç”¨ä»·å€¼ã€‚ å¦‚æœæ˜¯è¿™æ ·ï¼Œæˆ‘å»ºè®®è·³è¿‡ç¬¬2éƒ¨åˆ†å’Œç¬¬3 <a href="https://shaharmike.com/cpp/vtable-part4/">éƒ¨åˆ†</a> ï¼Œç›´æ¥è¿›å…¥<a href="https://shaharmike.com/cpp/vtable-part4/">ç¬¬4éƒ¨åˆ†</a> ã€‚ </p><br><h2 id="chast-2---mnozhestvennoe-nasledovanie"> ç¬¬2éƒ¨åˆ†-å¤šé‡ç»§æ‰¿ </h2><br><p> å•ä¸€ç»§æ‰¿å±‚æ¬¡ç»“æ„çš„ä¸–ç•Œå¯¹äºç¼–è¯‘å™¨æ¥è¯´æ›´å®¹æ˜“ã€‚ æ­£å¦‚æˆ‘ä»¬åœ¨ç¬¬ä¸€éƒ¨åˆ†ä¸­çœ‹åˆ°çš„ï¼Œæ¯ä¸ªå­ç±»é€šè¿‡ä¸ºæ¯ä¸ªæ–°çš„è™šæ‹Ÿæ–¹æ³•æ·»åŠ æ¡ç›®æ¥æ‰©å±•çˆ¶vtableã€‚ </p><br><p> è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹å¤šé‡ç»§æ‰¿ï¼Œå®ƒä½¿æƒ…å†µå˜å¾—å¤æ‚ï¼Œå³ä½¿ä»…ä»æ¥å£å®ç°ç»§æ‰¿ä¹Ÿæ˜¯å¦‚æ­¤ã€‚ </p><br><p> è®©æˆ‘ä»¬çœ‹ä¸‹é¢çš„ä»£ç ç‰‡æ®µï¼š </p><br><pre> <code class="plaintext hljs">class Mother { public: virtual void MotherMethod() {} int mother_data; }; class Father { public: virtual void FatherMethod() {} int father_data; }; class Child : public Mother, public Father { public: virtual void ChildMethod() {} int child_data; };</code> </pre> <br><div class="scrollable-table"><table><thead><tr><th> å­ç»“æ„ </th></tr></thead><tbody><tr><td>  _vptr $æ¯äº² </td></tr><tr><td>  mother_dataï¼ˆ+å¡«å……ï¼‰ </td></tr><tr><td>  _vptr $çˆ¶äº² </td></tr><tr><td> çˆ¶äº²æ•°æ® </td></tr><tr><td>  child_data <em>ï¼ˆ1ï¼‰</em> </td></tr></tbody></table></div><br><p> è¯·æ³¨æ„ï¼Œæœ‰2ä¸ªvtableæŒ‡é’ˆã€‚ å‡­ç›´è§‰ï¼Œæˆ‘æœŸæœ›1æˆ–3ä¸ªæŒ‡é’ˆï¼ˆæ¯äº²ï¼Œçˆ¶äº²å’Œå­©å­ï¼‰ã€‚ å®é™…ä¸Šï¼Œä¸å¯èƒ½æœ‰ä¸€ä¸ªæŒ‡é’ˆï¼ˆç¨åä¼šè¯¦ç»†ä»‹ç»ï¼‰ï¼Œå¹¶ä¸”ç¼–è¯‘å™¨è¶³å¤Ÿèªæ˜ï¼Œå¯ä»¥å°†å­çº§vtable Childçš„æ¡ç›®ç»„åˆä¸ºvtable Motherçš„æ‰©å±•ï¼Œä»è€ŒèŠ‚çœäº†1ä¸ªæŒ‡é’ˆã€‚ </p><br><p> ä¸ºä»€ä¹ˆå­©å­ä¸èƒ½ä¸ºæ‰€æœ‰ä¸‰ç§ç±»å‹ä½¿ç”¨ä¸€ä¸ªvtableæŒ‡é’ˆï¼Ÿ è¯·è®°ä½ï¼Œå¯ä»¥å°†ChildæŒ‡é’ˆä¼ é€’ç»™æ¥å—æ¯äº²æˆ–çˆ¶äº²æŒ‡é’ˆçš„å‡½æ•°ï¼Œå¹¶ä¸”ä¸¤è€…éƒ½å¸Œæœ›thisæŒ‡é’ˆåœ¨æ­£ç¡®çš„åç§»é‡å¤„åŒ…å«æ­£ç¡®çš„æ•°æ®ã€‚ è¿™äº›åŠŸèƒ½ä¸éœ€è¦äº†è§£Childï¼Œå› æ­¤æ‚¨ç»å¯¹ä¸åº”å‡å®šChildç¡®å®æ˜¯å®ƒä»¬æ‰€ä¾æ®çš„â€œæ¯äº²/çˆ¶äº²â€æŒ‡é’ˆä¸‹çš„å†…å®¹ã€‚ </p><br><p>  <em>ï¼ˆ1ï¼‰ä¸æœ¬ä¸»é¢˜æ— å…³ï¼Œä½†æ˜¯ï¼Œæœ‰è¶£çš„æ˜¯ï¼Œå°†child_dataå®é™…ä¸Šæ”¾ç½®åœ¨çˆ¶äº²çš„å¡«å……ç‰©ä¸­ã€‚</em>  <em>è¿™ç§°ä¸ºå°¾å·´å¡«å……ï¼Œå¯èƒ½æ˜¯å°†æ¥å‘å¸ƒçš„ä¸»é¢˜ã€‚</em> </p><br><p> è¿™æ˜¯<code>vtable</code>ç»“æ„ï¼š </p><br><div class="scrollable-table"><table><thead><tr><th> åœ°å€ </th><th> ä»·å€¼ </th><th> ç›®å½•å†…å®¹ </th></tr></thead><tbody><tr><td>  0x4008b8 </td><td>  0 </td><td>  top_offsetï¼ˆç¨åä¼šè¯¦ç»†ä»‹ç»ï¼‰ </td></tr><tr><td>  0x4008c0 </td><td>  0x400930 </td><td> æŒ‡å‘Childçš„typeinfoçš„æŒ‡é’ˆ </td></tr><tr><td>  0x4008c8 </td><td>  0x400800 </td><td> æ¯äº²:: MotherMethodï¼ˆï¼‰ã€‚  _vptr $å¦ˆå¦ˆç‚¹åœ¨è¿™é‡Œã€‚ </td></tr><tr><td>  0x4008d0 </td><td>  0x400810 </td><td> å­:: ChildMethodï¼ˆï¼‰ </td></tr><tr><td>  0x4008d8 </td><td>  -16 </td><td>  top_offsetï¼ˆç¨åä¼šè¯¦ç»†ä»‹ç»ï¼‰ </td></tr><tr><td>  0x4008e0 </td><td>  0x400930 </td><td> æŒ‡å‘Childçš„typeinfoçš„æŒ‡é’ˆ </td></tr><tr><td>  0x4008e8 </td><td>  0x400820 </td><td> çˆ¶äº²::çˆ¶äº²æ–¹æ³•ï¼ˆï¼‰ã€‚  _vptr $çˆ¶äº²åœ¨è¿™é‡ŒæŒ‡å‘ã€‚ </td></tr></tbody></table></div><br><p> åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼ŒChildå®ä¾‹åœ¨è½¬æ¢ä¸ºMotheræŒ‡é’ˆæ—¶å°†å…·æœ‰ç›¸åŒçš„æŒ‡é’ˆã€‚ ä½†æ˜¯ï¼Œå½“è½¬æ¢ä¸ºçˆ¶äº²æŒ‡é’ˆæ—¶ï¼Œç¼–è¯‘å™¨å°†è®¡ç®—thisæŒ‡é’ˆçš„åç§»é‡ï¼Œä»¥æŒ‡å‘Childçš„_vptr $çˆ¶äº²éƒ¨åˆ†ï¼ˆChildç»“æ„ä¸­çš„ç¬¬3ä¸ªå­—æ®µï¼Œè¯·å‚è§ä¸Šè¡¨ï¼‰ã€‚ </p><br><p> æ¢å¥è¯è¯´ï¼Œå¯¹äºç»™å®šçš„å­ä»£c; ::ï¼ˆvoid <em>ï¼‰ï¼†cï¼=ï¼ˆVoid</em> ï¼‰static_cast &lt;çˆ¶äº²*&gt;ï¼ˆï¼†cï¼‰ã€‚ æŸäº›äººå¹¶ä¸æœŸæœ›è¿™æ ·åšï¼Œä¹Ÿè®¸æœ‰ä¸€å¤©è¿™äº›ä¿¡æ¯å°†ä¸ºæ‚¨èŠ‚çœä¸€äº›è°ƒè¯•æ—¶é—´ã€‚ </p><br><p> æˆ‘å‘ç°æ­¤åŠŸèƒ½ä¸æ­¢ä¸€æ¬¡ã€‚ ä½†æ˜¯ï¼Œç­‰ç­‰ï¼Œè¿˜ä¸æ˜¯å…¨éƒ¨ã€‚ </p><br><p> å¦‚æœå­©å­å†³å®šæ›¿ä»£çˆ¶äº²çš„æ–¹æ³•ä¹‹ä¸€æ€ä¹ˆåŠï¼Ÿ è€ƒè™‘ä»¥ä¸‹ä»£ç ï¼š </p><br><pre> <code class="plaintext hljs">class Mother { public: virtual void MotherFoo() {} }; class Father { public: virtual void FatherFoo() {} }; class Child : public Mother, public Father { public: void FatherFoo() override {} };</code> </pre> <br><p> æƒ…å†µè¶Šæ¥è¶Šéš¾äº†ã€‚ è¯¥å‡½æ•°å¯ä»¥æ¥å—å‚æ•°Father *ï¼Œå¹¶ä¸ºå…¶è°ƒç”¨FatherFooï¼ˆï¼‰ã€‚ ä½†æ˜¯ï¼Œå¦‚æœä¼ é€’Childå®ä¾‹ï¼Œåˆ™åº”è¯¥ä½¿ç”¨æ­£ç¡®çš„thisæŒ‡é’ˆè°ƒç”¨é‡å†™çš„Childæ–¹æ³•ã€‚ ä½†æ˜¯ï¼Œå‘¼å«è€…ä¸çŸ¥é“ä»–ç¡®å®åŒ…å«Childã€‚ å®ƒå…·æœ‰ä¸€ä¸ªæŒ‡å‘â€œå­ä»£æ•°â€åç§»é‡çš„æŒ‡é’ˆï¼Œå³çˆ¶ä»£çš„ä½ç½®ã€‚ æœ‰äººå¿…é¡»åç§»æ­¤æŒ‡é’ˆï¼Œä½†æ˜¯è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿ ç¼–è¯‘å™¨æ‰§è¡Œæ­¤é­”æœ¯æœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ </p><br><p>  <em>åœ¨æˆ‘ä»¬å›ç­”è¿™ä¸ªé—®é¢˜ä¹‹å‰ï¼Œè¯·æ³¨æ„ï¼Œè¦†ç›–æ­¤Motheræ–¹æ³•ä¹‹ä¸€å¹¶ä¸æ˜¯å¾ˆæ£˜æ‰‹ï¼Œå› ä¸ºthisæŒ‡é’ˆæ˜¯ç›¸åŒçš„ã€‚</em>  <em>ChildçŸ¥é“vtable Motherä¹‹åè¦é˜…è¯»çš„å†…å®¹ï¼Œå¹¶å¸Œæœ›Childæ–¹æ³•ç´§éšå…¶åã€‚</em> </p><br><p> è§£å†³æ–¹æ³•æ˜¯ï¼šç¼–è¯‘å™¨åˆ›å»ºä¸€ä¸ªthunkæ–¹æ³•æ¥çº æ­£thisæŒ‡é’ˆï¼Œç„¶åè°ƒç”¨â€œ realâ€æ–¹æ³•ã€‚ é€‚é…å™¨æ–¹æ³•çš„åœ°å€å°†åœ¨vtableçˆ¶ç›®å½•ä¸‹ï¼Œè€Œâ€œçœŸå®â€æ–¹æ³•çš„åœ°å€å°†åœ¨vtableå­ç›®å½•ä¸‹ã€‚ </p><br><p> è¿™æ˜¯<code>vtable Child</code> ï¼š </p><br><pre> <code class="plaintext hljs">0x4008e8 &lt;vtable for Child&gt;: 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x4008f0 &lt;vtable for Child+8&gt;: 0x60 0x09 0x40 0x00 0x00 0x00 0x00 0x00 0x4008f8 &lt;vtable for Child+16&gt;: 0x00 0x08 0x40 0x00 0x00 0x00 0x00 0x00 0x400900 &lt;vtable for Child+24&gt;: 0x10 0x08 0x40 0x00 0x00 0x00 0x00 0x00 0x400908 &lt;vtable for Child+32&gt;: 0xf8 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0x400910 &lt;vtable for Child+40&gt;: 0x60 0x09 0x40 0x00 0x00 0x00 0x00 0x00 0x400918 &lt;vtable for Child+48&gt;: 0x20 0x08 0x40 0x00 0x00 0x00 0x00 0x00</code> </pre> <br><p> è¿™æ˜¯ä»€ä¹ˆæ„æ€ï¼š </p><br><div class="scrollable-table"><table><thead><tr><th> åœ°å€ </th><th> ä»·å€¼ </th><th> ç›®å½•å†…å®¹ </th></tr></thead><tbody><tr><td>  0x4008e8 </td><td>  0 </td><td>  top_offsetï¼ˆå³å°†æ¨å‡ºï¼ï¼‰ </td></tr><tr><td>  0x4008f0 </td><td>  0x400960 </td><td> å„¿ç«¥çš„typeinfo </td></tr><tr><td>  0x4008f8 </td><td>  0x400800 </td><td> æ¯äº²:: MotherFooï¼ˆï¼‰ </td></tr><tr><td>  0x400900 </td><td>  0x400810 </td><td> å­©å­::çˆ¶äº²ä¹‹çˆ¶ï¼ˆï¼‰ </td></tr><tr><td>  0x400908 </td><td>  -8 </td><td>  top_offset </td></tr><tr><td>  0x400910 </td><td>  0x400960 </td><td> å„¿ç«¥çš„typeinfo </td></tr><tr><td>  0x400918 </td><td>  0x400820 </td><td> ä¸æ˜¯è™šæ‹Ÿé€‚é…å™¨çš„å­çº§ï¼š:: FatherFooï¼ˆï¼‰ </td></tr></tbody></table></div><br><p> è¯´æ˜ï¼šå¦‚æˆ‘ä»¬å…ˆå‰æ‰€è§ï¼ŒChildæœ‰2ä¸ªvtable-ä¸€ä¸ªç”¨äºæ¯äº²å’Œå­©å­ï¼Œå¦ä¸€ä¸ªç”¨äºçˆ¶äº²ã€‚ åœ¨vtableçˆ¶äº²ä¸­ï¼ŒFatherFooï¼ˆï¼‰æŒ‡å‘â€œé€‚é…å™¨â€ï¼Œè€Œåœ¨vtableä¸­ï¼ŒChildç›´æ¥æŒ‡å‘Child :: FatherFooï¼ˆï¼‰ã€‚ </p><br><p> æ‚¨é—®è¿™ä¸ªâ€œé€‚é…å™¨â€æ˜¯ä»€ä¹ˆï¼Ÿ </p><br><pre> <code class="plaintext hljs">(gdb) disas /m 0x400820, 0x400850 Dump of assembler code from 0x400820 to 0x400850: 15 void FatherFoo() override {} 0x0000000000400820 &lt;non-virtual thunk to Child::FatherFoo()+0&gt;: push %rbp 0x0000000000400821 &lt;non-virtual thunk to Child::FatherFoo()+1&gt;: mov %rsp,%rbp 0x0000000000400824 &lt;non-virtual thunk to Child::FatherFoo()+4&gt;: sub $0x10,%rsp 0x0000000000400828 &lt;non-virtual thunk to Child::FatherFoo()+8&gt;: mov %rdi,-0x8(%rbp) 0x000000000040082c &lt;non-virtual thunk to Child::FatherFoo()+12&gt;: mov -0x8(%rbp),%rdi 0x0000000000400830 &lt;non-virtual thunk to Child::FatherFoo()+16&gt;: add $0xfffffffffffffff8,%rdi 0x0000000000400837 &lt;non-virtual thunk to Child::FatherFoo()+23&gt;: callq 0x400810 &lt;Child::FatherFoo()&gt; 0x000000000040083c &lt;non-virtual thunk to Child::FatherFoo()+28&gt;: add $0x10,%rsp 0x0000000000400840 &lt;non-virtual thunk to Child::FatherFoo()+32&gt;: pop %rbp 0x0000000000400841 &lt;non-virtual thunk to Child::FatherFoo()+33&gt;: retq 0x0000000000400842: nopw %cs:0x0(%rax,%rax,1) 0x000000000040084c: nopl 0x0(%rax)</code> </pre> <br><p> æ­£å¦‚æˆ‘ä»¬å·²ç»è®¨è®ºçš„é‚£æ ·ï¼Œè¿™æ˜¯åç§»é‡ï¼Œå¹¶ä¸”è°ƒç”¨äº†FatherFooï¼ˆï¼‰ã€‚ æˆ‘ä»¬åº”è¯¥æ”¹å˜å¤šå°‘æ‰èƒ½è®©å­©å­å¾—åˆ°ï¼Ÿ  top_offsetï¼ </p><br><p>  <em>è¯·æ³¨æ„ï¼Œæˆ‘ä¸ªäººè®¤ä¸ºéè™šæ‹Ÿthunkåç§°éå¸¸ä»¤äººå›°æƒ‘ï¼Œå› ä¸ºå®ƒæ˜¯è™šæ‹Ÿå‡½æ•°çš„è™šæ‹Ÿè¡¨æ¡ç›®ã€‚</em>  <em>æˆ‘ä¸ç¡®å®šå®ƒä¸æ˜¯è™šæ‹Ÿçš„ï¼Œä½†è¿™åªæ˜¯æˆ‘çš„çœ‹æ³•ã€‚</em> </p><br><hr><br><p>  <em>ç›®å‰ä»…æ­¤è€Œå·²ï¼Œåœ¨ä¸ä¹…çš„å°†æ¥ï¼Œæˆ‘ä»¬å°†ç¿»è¯‘3å’Œ4éƒ¨åˆ†ã€‚</em>  <em>å…³æ³¨æ–°é—»ï¼</em> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN479802/">https://habr.com/ru/post/zh-CN479802/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN479780/index.html">DevOps Moscow Meetup 17/12ï¼šåŠ å…¥å¹¿æ’­</a></li>
<li><a href="../zh-CN479790/index.html">ä¸‰ä¸ªå­µåŒ–å™¨ä¸ºç¬¬ä¸€æ‰¹å­¦ç”Ÿè¿›è¡Œäº†åŸå‹è®¾è®¡è¯¾ç¨‹</a></li>
<li><a href="../zh-CN479794/index.html">æˆ‘ä»¬ç»“åˆäº†â€œå„¿ç«¥â€å¾®æ§åˆ¶å™¨å’Œæ£‹ç›˜æ¸¸æˆ</a></li>
<li><a href="../zh-CN479796/index.html">é‡‘å£«é¡¿çš„è¨è¯ºæ–¯çº§å¨èƒ</a></li>
<li><a href="../zh-CN479800/index.html">æˆ‘æ­£åœ¨ç”¨Cï¼ƒç¼–å†™ï¼Œä»¥ä¾¿å‰ç«¯æ›´å®¹æ˜“</a></li>
<li><a href="../zh-CN479810/index.html">æˆ‘å¦‚ä½•åœ¨ã€Šè‡ªç„¶ã€‹æ‚å¿—ä¸Šå‘è¡¨ç§‘å­¦æ–‡ç« </a></li>
<li><a href="../zh-CN479814/index.html">Active Directoryæ•°æ®éšç§é—®é¢˜</a></li>
<li><a href="../zh-CN479816/index.html">Pythonç»„åˆå­¦</a></li>
<li><a href="../zh-CN479818/index.html">å¦‚ä½•è¯„ä¼°è‹±è¯­æ°´å¹³</a></li>
<li><a href="../zh-CN479820/index.html">åœ¨ITæ ‘ä¸‹æ”¾ç½®ä»€ä¹ˆï¼Ÿ äºŒè¿›åˆ¶æ—¶é’Ÿ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>