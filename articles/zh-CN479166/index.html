<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ§ ğŸ“³ ğŸŒ² ä¸ºtarantoolç¼–å†™ä¸Šé™çš„è¿‡æœŸæ¨¡å— ğŸš ğŸ–ï¸ ğŸš²</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="å‰ä¸€æ®µæ—¶é—´ï¼Œæˆ‘ä»¬é¢ä¸´ç€åœ¨tarantool ç©ºé—´æ¸…æ´å…ƒç»„çš„é—®é¢˜ã€‚ ä¸æ˜¯å¿…é¡»åœ¨tarantoolå†…å­˜ä¸è¶³æ—¶å¼€å§‹æ¸…æ´ï¼Œè€Œæ˜¯æå‰å¹¶ä»¥ä¸€å®šé¢‘ç‡å¼€å§‹æ¸…æ´ã€‚ Tarantoolæœ‰ä¸€ä¸ªç”¨Luaç¼–å†™çš„ç”¨äºå®Œæˆæ­¤ä»»åŠ¡çš„æ¨¡å—ï¼Œç§°ä¸ºexpirationd ã€‚ çŸ­æš‚ä½¿ç”¨æ­¤æ¨¡å—åï¼Œæˆ‘ä»¬æ„è¯†åˆ°å®ƒä¸é€‚åˆæˆ‘ä»¬ï¼šåœ¨ä¸æ–­æ¸…ç†å¤§é‡æ•°æ®æ—¶...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ä¸ºtarantoolç¼–å†™ä¸Šé™çš„è¿‡æœŸæ¨¡å—</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/479166/"><p><img src="https://habrastorage.org/webt/7d/um/q8/7dumq8efywfthrj1x0jkxzh55ya.jpeg" alt="å›¾ç‰‡"></p><br><p> å‰ä¸€æ®µæ—¶é—´ï¼Œæˆ‘ä»¬é¢ä¸´ç€åœ¨tarantool <a href="https://www.tarantool.io/" rel="nofollow">ç©ºé—´</a>æ¸…æ´å…ƒç»„çš„é—®é¢˜ã€‚ ä¸æ˜¯å¿…é¡»åœ¨tarantoolå†…å­˜ä¸è¶³æ—¶å¼€å§‹æ¸…æ´ï¼Œè€Œæ˜¯æå‰å¹¶ä»¥ä¸€å®šé¢‘ç‡å¼€å§‹æ¸…æ´ã€‚  Tarantoolæœ‰ä¸€ä¸ªç”¨Luaç¼–å†™çš„ç”¨äºå®Œæˆæ­¤ä»»åŠ¡çš„æ¨¡å—ï¼Œç§°ä¸º<a href="https://github.com/tarantool/expirationd" rel="nofollow">expirationd</a> ã€‚ çŸ­æš‚ä½¿ç”¨æ­¤æ¨¡å—åï¼Œæˆ‘ä»¬æ„è¯†åˆ°å®ƒä¸é€‚åˆæˆ‘ä»¬ï¼šåœ¨ä¸æ–­æ¸…ç†å¤§é‡æ•°æ®æ—¶ï¼ŒLuaæŒ‚åœ¨GCä¸Šã€‚ å› æ­¤ï¼Œæˆ‘ä»¬è€ƒè™‘å¼€å‘æœ‰ä¸Šé™çš„è¿‡æœŸæ¨¡å—ï¼Œå¸Œæœ›ä»¥æœ¬æœºç¼–ç¨‹è¯­è¨€ç¼–å†™çš„ä»£ç å°†ä»¥æœ€ä½³æ–¹å¼è§£å†³æˆ‘ä»¬çš„é—®é¢˜ã€‚ </p><br><p>ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­æ˜¯åä¸º<a href="https://github.com/tarantool/memcached" rel="nofollow">memcached</a>çš„tarantoolæ¨¡å—ã€‚ å…¶ä¸­ä½¿ç”¨çš„æ–¹æ³•åŸºäºä»¥ä¸‹äº‹å®ï¼šåœ¨è¡¨ç¤ºå…ƒç»„å¯¿å‘½çš„ç©ºé—´ï¼ˆå³ttlï¼‰ä¸­è¾“å…¥äº†å•ç‹¬çš„å­—æ®µã€‚ åå°æ¨¡å—æ‰«æç©ºé—´ï¼Œå°†ttlä¸å½“å‰æ—¶é—´è¿›è¡Œæ¯”è¾ƒï¼Œå¹¶å†³å®šæ˜¯å¦åˆ é™¤å…ƒç»„ã€‚  memcachedæ¨¡å—ä»£ç æ—¢ç®€å•åˆä¼˜é›…ï¼Œä½†æ˜¯å¤ªç¬¼ç»Ÿäº†ã€‚ é¦–å…ˆï¼Œå®ƒæ²¡æœ‰è€ƒè™‘ç”¨äºçˆ¬ç½‘å’Œåˆ é™¤çš„ç´¢å¼•ç±»å‹ã€‚ å…¶æ¬¡ï¼Œåœ¨æ¯æ¬¡é€šè¿‡æ—¶ï¼Œå°†æ‰«ææ‰€æœ‰å…ƒç»„ï¼Œå…¶æ•°é‡å¯èƒ½éå¸¸å¤§ã€‚ å¹¶ä¸”ï¼Œå¦‚æœåœ¨è¿‡æœŸæ¨¡å—ä¸­è§£å†³äº†ç¬¬ä¸€ä¸ªé—®é¢˜ï¼ˆå°†æ ‘ç´¢å¼•åˆ†é…åœ¨å•ç‹¬çš„ç±»ä¸­ï¼‰ï¼Œåˆ™ç¬¬äºŒä¸ªé—®é¢˜ä»ç„¶æ²¡æœ‰å¾—åˆ°å…³æ³¨ã€‚ è¿™é¢„ç¤ºäº†é€‰æ‹©ç¼–å†™è‡ªå·±çš„ä»£ç çš„é€‰æ‹©ã€‚ </p><a name="habracut"></a><br><h4 id="opisanie"> å†…å®¹æè¿° </h4><br><p>  tarantoolçš„æ–‡æ¡£ä¸­æœ‰ä¸€ä¸ªå¾ˆå¥½çš„<a href="https://www.tarantool.io/en/doc/1.10/tutorials/c_tutorial/" rel="nofollow">æ•™ç¨‹</a> ï¼Œä»‹ç»å¦‚ä½•ç”¨Cè¯­è¨€ç¼–å†™å­˜å‚¨è¿‡ç¨‹ã€‚é¦–å…ˆï¼Œæˆ‘å»ºè®®æ‚¨ç†Ÿæ‚‰ä¸€ä¸‹å®ƒï¼Œä»¥ä¾¿ç†è§£å¸¦æœ‰å‘½ä»¤å’Œä»£ç çš„æ’å…¥å†…å®¹ï¼Œè¿™äº›å†…å®¹å°†åœ¨ä¸‹é¢æ‰¾åˆ°ã€‚ ç¼–å†™è‡ªå·±çš„åŠ ç›–æ¨¡å—ï¼ˆå³<a href="https://www.tarantool.io/en/doc/1.10/dev_guide/reference_capi/box/" rel="nofollow">box</a> ï¼Œ <a href="https://www.tarantool.io/en/doc/1.10/dev_guide/reference_capi/fiber/" rel="nofollow">fibre</a> ï¼Œ <a href="https://www.tarantool.io/en/doc/1.10/dev_guide/reference_capi/box_index/" rel="nofollow">index</a>å’Œ<a href="https://www.tarantool.io/en/doc/1.10/dev_guide/reference_capi/txn/" rel="nofollow">txnï¼‰</a>æ—¶å¯ç”¨çš„å¯¹è±¡çš„<a href="https://www.tarantool.io/en/doc/1.10/dev_guide/reference_capi/" rel="nofollow">å¼•ç”¨</a>ä¹Ÿåº”å¼•èµ·æ³¨æ„ã€‚ </p><br><p> è®©æˆ‘ä»¬ä»è¿œå¤„å¼€å§‹ï¼Œçœ‹çœ‹ä»å¤–é¢çœ‹ï¼Œæœ‰ä¸Šé™çš„è¿‡æœŸæ¨¡å—çš„å¤–è§‚ï¼š </p><br><pre><code class="lua hljs">fiber = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'fiber'</span></span>) net_box = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'net.box'</span></span>) box.cfg{listen = <span class="hljs-number"><span class="hljs-number">3300</span></span>} box.schema.func.<span class="hljs-built_in"><span class="hljs-built_in">create</span></span>(<span class="hljs-string"><span class="hljs-string">'libcapped-expirationd.start'</span></span>, {language = <span class="hljs-string"><span class="hljs-string">'C'</span></span>}) box.schema.user.grant(<span class="hljs-string"><span class="hljs-string">'guest'</span></span>, <span class="hljs-string"><span class="hljs-string">'execute'</span></span>, <span class="hljs-string"><span class="hljs-string">'function'</span></span>, <span class="hljs-string"><span class="hljs-string">'libcapped-expirationd.start'</span></span>) box.schema.func.<span class="hljs-built_in"><span class="hljs-built_in">create</span></span>(<span class="hljs-string"><span class="hljs-string">'libcapped-expirationd.kill'</span></span>, {language = <span class="hljs-string"><span class="hljs-string">'C'</span></span>}) box.schema.user.grant(<span class="hljs-string"><span class="hljs-string">'guest'</span></span>, <span class="hljs-string"><span class="hljs-string">'execute'</span></span>, <span class="hljs-string"><span class="hljs-string">'function'</span></span>, <span class="hljs-string"><span class="hljs-string">'libcapped-expirationd.kill'</span></span>) box.schema.space.<span class="hljs-built_in"><span class="hljs-built_in">create</span></span>(<span class="hljs-string"><span class="hljs-string">'tester'</span></span>) box.space.tester:create_index(<span class="hljs-string"><span class="hljs-string">'primary'</span></span>, {unique = <span class="hljs-literal"><span class="hljs-literal">true</span></span>, parts = {<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'unsigned'</span></span>}}) capped_connection = net_box:new(<span class="hljs-number"><span class="hljs-number">3300</span></span>)</code> </pre> <br><p> ä¸ºç®€å•èµ·è§ï¼Œè¯·åœ¨æˆ‘ä»¬çš„åº“libcapped-expirationd.soæ‰€åœ¨çš„ç›®å½•ä¸­è¿è¡Œtarantoolã€‚ ä»åº“ä¸­å¯¼å‡ºäº†ä¸¤ä¸ªå‡½æ•°ï¼šstartå’Œkillã€‚ é¦–å…ˆï¼Œæ‚¨éœ€è¦ä½¿ç”¨box.schema.func.createå’Œbox.schema.user.grantä»Luaæä¾›è¿™äº›åŠŸèƒ½ã€‚ ç„¶ååˆ›å»ºä¸€ä¸ªç©ºé—´ï¼Œå…¶å…ƒç»„å°†ä»…åŒ…å«ä¸‰ä¸ªå­—æ®µï¼šç¬¬ä¸€ä¸ªæ˜¯å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œç¬¬äºŒä¸ªæ˜¯ç”µå­é‚®ä»¶ï¼Œç¬¬ä¸‰ä¸ªæ˜¯å…ƒç»„çš„ç”Ÿå­˜æœŸã€‚ åœ¨ç¬¬ä¸€ä¸ªå­—æ®µçš„é¡¶éƒ¨ï¼Œæ„å»ºä¸€ä¸ªæ ‘ç´¢å¼•å¹¶å°†å…¶ç§°ä¸ºä¸»ç´¢å¼•ã€‚ æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è·å¾—å¯¹è±¡ä»¥è¿æ¥åˆ°æˆ‘ä»¬çš„æœ¬æœºåº“ã€‚ </p><br><p> å‡†å¤‡å·¥ä½œç»“æŸåï¼Œæˆ‘ä»¬å¯åŠ¨å¯åŠ¨åŠŸèƒ½ï¼š </p><br><pre> <code class="lua hljs">capped_connection:call(<span class="hljs-string"><span class="hljs-string">'libcapped-expirationd.start'</span></span>, {<span class="hljs-string"><span class="hljs-string">'non-indexed'</span></span>, box.space.tester.id, box.space.tester.index.primary, box.space.tester.index.primary, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">1024</span></span>, <span class="hljs-number"><span class="hljs-number">3600</span></span>})</code> </pre> <br><p> è¯¥ç¤ºä¾‹å°†åƒä½¿ç”¨Luaç¼–å†™çš„è¿‡æœŸæ¨¡å—ä¸€æ ·è¿›è¡Œæ‰«æã€‚ å¯åŠ¨å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä»»åŠ¡çš„å”¯ä¸€åç§°ã€‚ ç¬¬äºŒä¸ªæ˜¯ç©ºé—´æ ‡è¯†ç¬¦ã€‚ ç¬¬ä¸‰ä¸ªæ˜¯å”¯ä¸€ç´¢å¼•ï¼Œé€šè¿‡è¯¥ç´¢å¼•å°†åˆ é™¤å…ƒç»„ã€‚ ç¬¬å››ä¸ªæ˜¯å…ƒç»„å°†è¢«ç»•è¿‡çš„ç´¢å¼•ã€‚ ç¬¬äº”-å…·æœ‰ç”Ÿå­˜æœŸçš„å…ƒç»„å­—æ®µçš„ç¼–å·ï¼ˆç¼–å·ä»1å¼€å§‹ï¼Œè€Œä¸æ˜¯0ï¼ï¼‰ã€‚ ç¬¬å…­å’Œç¬¬ä¸ƒ-æ‰«æè®¾ç½®ã€‚  1024æ˜¯å•ä¸ªäº‹åŠ¡ä¸­å¯ä»¥æŸ¥çœ‹çš„æœ€å¤§å…ƒç»„æ•°ã€‚  3600-å®Œæ•´æ‰«ææ—¶é—´ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰ã€‚ </p><br><p> è¯·æ³¨æ„ï¼Œåœ¨ç¤ºä¾‹ä¸­ï¼Œç›¸åŒçš„ç´¢å¼•ç”¨äºçˆ¬ç½‘å’Œåˆ é™¤ã€‚ å¦‚æœå®ƒæ˜¯æ ‘ç´¢å¼•ï¼Œåˆ™çˆ¬ç½‘æ˜¯ä»è¾ƒå°çš„é”®åˆ°è¾ƒå¤§çš„é”®ã€‚ å¦‚æœæ˜¯å…¶ä»–å“ˆå¸Œç´¢å¼•ï¼Œåˆ™é€šå¸¸æŒ‰ä»»æ„é¡ºåºæ‰§è¡Œéå†ã€‚ åœ¨ä¸€æ¬¡æ‰«æä¸­ï¼Œå°†æŸ¥çœ‹æ‰€æœ‰ç©ºé—´å…ƒç»„ã€‚ </p><br><p> è®©æˆ‘ä»¬å°†å‡ ä¸ªå…ƒç»„æ’å…¥ç©ºé—´ï¼Œç”Ÿå‘½å‘¨æœŸä¸º60ç§’ï¼š </p><br><pre> <code class="lua hljs">box.space.tester:<span class="hljs-built_in"><span class="hljs-built_in">insert</span></span>{<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'user0@tarantool.io'</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">math</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(fiber.<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>()) + <span class="hljs-number"><span class="hljs-number">60</span></span>} box.space.tester:<span class="hljs-built_in"><span class="hljs-built_in">insert</span></span>{<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'user1@tarantool.io'</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">math</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(fiber.<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>()) + <span class="hljs-number"><span class="hljs-number">60</span></span>} box.space.tester:<span class="hljs-built_in"><span class="hljs-built_in">insert</span></span>{<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">'user2@tarantool.io'</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">math</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(fiber.<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>()) + <span class="hljs-number"><span class="hljs-number">60</span></span>}</code> </pre> <br><p> æ£€æŸ¥æ’å…¥æ˜¯å¦æˆåŠŸï¼š </p><br><pre> <code class="lua hljs">tarantool&gt; box.space.tester.index.primary:<span class="hljs-built_in"><span class="hljs-built_in">select</span></span>() <span class="hljs-comment"><span class="hljs-comment">--- - - [0, 'user0@tarantool.io', 1576418976] - [1, 'user1@tarantool.io', 1576418976] - [2, 'user2@tarantool.io', 1576418976] ...</span></span></code> </pre> <br><p>  60+ç§’åï¼ˆä»æ’å…¥ç¬¬ä¸€ä¸ªå…ƒç»„çš„å¼€å§‹ç®—èµ·ï¼‰é‡å¤æ‰§è¡Œselectï¼Œç„¶åæŸ¥çœ‹å·²è®¾ç½®ä¸Šé™çš„è¿‡æœŸæ¨¡å—å·²æ­£å¸¸å·¥ä½œï¼š </p><br><pre> <code class="lua hljs">tarantool&gt; box.space.tester.index.primary:<span class="hljs-built_in"><span class="hljs-built_in">select</span></span>() <span class="hljs-comment"><span class="hljs-comment">--- - [] ...</span></span></code> </pre> <br><p> åœæ­¢ä»»åŠ¡ï¼š </p><br><pre> <code class="lua hljs">capped_connection:call(<span class="hljs-string"><span class="hljs-string">'libcapped-expirationd.kill'</span></span>, {<span class="hljs-string"><span class="hljs-string">'non-indexed'</span></span>})</code> </pre> <br><p> è®©æˆ‘ä»¬çœ‹ç¬¬äºŒä¸ªç¤ºä¾‹ï¼Œå…¶ä¸­ä½¿ç”¨å•ç‹¬çš„ç´¢å¼•è¿›è¡Œçˆ¬ç½‘ï¼š </p><br><pre> <code class="lua hljs">fiber = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'fiber'</span></span>) net_box = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'net.box'</span></span>) box.cfg{listen = <span class="hljs-number"><span class="hljs-number">3300</span></span>} box.schema.func.<span class="hljs-built_in"><span class="hljs-built_in">create</span></span>(<span class="hljs-string"><span class="hljs-string">'libcapped-expirationd.start'</span></span>, {language = <span class="hljs-string"><span class="hljs-string">'C'</span></span>}) box.schema.user.grant(<span class="hljs-string"><span class="hljs-string">'guest'</span></span>, <span class="hljs-string"><span class="hljs-string">'execute'</span></span>, <span class="hljs-string"><span class="hljs-string">'function'</span></span>, <span class="hljs-string"><span class="hljs-string">'libcapped-expirationd.start'</span></span>) box.schema.func.<span class="hljs-built_in"><span class="hljs-built_in">create</span></span>(<span class="hljs-string"><span class="hljs-string">'libcapped-expirationd.kill'</span></span>, {language = <span class="hljs-string"><span class="hljs-string">'C'</span></span>}) box.schema.user.grant(<span class="hljs-string"><span class="hljs-string">'guest'</span></span>, <span class="hljs-string"><span class="hljs-string">'execute'</span></span>, <span class="hljs-string"><span class="hljs-string">'function'</span></span>, <span class="hljs-string"><span class="hljs-string">'libcapped-expirationd.kill'</span></span>) box.schema.space.<span class="hljs-built_in"><span class="hljs-built_in">create</span></span>(<span class="hljs-string"><span class="hljs-string">'tester'</span></span>) box.space.tester:create_index(<span class="hljs-string"><span class="hljs-string">'primary'</span></span>, {unique = <span class="hljs-literal"><span class="hljs-literal">true</span></span>, parts = {<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'unsigned'</span></span>}}) box.space.tester:create_index(<span class="hljs-string"><span class="hljs-string">'exp'</span></span>, {unique = <span class="hljs-literal"><span class="hljs-literal">false</span></span>, parts = {<span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">'unsigned'</span></span>}}) capped_connection = net_box:new(<span class="hljs-number"><span class="hljs-number">3300</span></span>)</code> </pre> <br><p> æ­¤å¤„çš„ä¸€åˆ‡ä¸ç¬¬ä¸€ä¸ªç¤ºä¾‹ç›¸åŒï¼Œä½†æœ‰ä¸€äº›ä¾‹å¤–ã€‚ åœ¨ç¬¬ä¸‰ä¸ªå­—æ®µçš„é¡¶éƒ¨ï¼Œæˆ‘ä»¬å»ºç«‹ä¸€ä¸ªæ ‘ç´¢å¼•å¹¶å°†å…¶ç§°ä¸ºexpã€‚ ä¸ç§°ä¸ºä¸»ç´¢å¼•çš„ç´¢å¼•ä¸åŒï¼Œæ­¤ç´¢å¼•ä¸å¿…æ˜¯å”¯ä¸€çš„ã€‚ ç»•è¿‡å°†åœ¨expç´¢å¼•å¤„å®Œæˆï¼Œå¹¶åœ¨ä¸»ç´¢å¼•å¤„è¿›è¡Œåˆ é™¤ã€‚ æˆ‘ä»¬è®°å¾—ä»¥å‰ï¼Œä¸¤è€…éƒ½ä»…ä½¿ç”¨ä¸»ç´¢å¼•å®Œæˆã€‚ </p><br><p> å‡†å¤‡å·¥ä½œå®Œæˆåï¼Œæˆ‘ä»¬ä½¿ç”¨æ–°çš„å‚æ•°å¯åŠ¨startå‡½æ•°ï¼š </p><br><pre> <code class="lua hljs">capped_connection:call(<span class="hljs-string"><span class="hljs-string">'libcapped-expirationd.start'</span></span>, {<span class="hljs-string"><span class="hljs-string">'indexed'</span></span>, box.space.tester.id, box.space.tester.index.primary, box.space.tester.index.<span class="hljs-built_in"><span class="hljs-built_in">exp</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">1024</span></span>, <span class="hljs-number"><span class="hljs-number">3600</span></span>})</code> </pre> <br><p> åŒæ ·ï¼Œæˆ‘ä»¬å°†åœ¨ç©ºé—´ä¸­æ’å…¥å‡ ä¸ªå…ƒç»„ï¼Œç”Ÿå‘½å‘¨æœŸä¸º60ç§’ï¼š </p><br><pre> <code class="lua hljs">box.space.tester:<span class="hljs-built_in"><span class="hljs-built_in">insert</span></span>{<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'user0@tarantool.io'</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">math</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(fiber.<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>()) + <span class="hljs-number"><span class="hljs-number">60</span></span>} box.space.tester:<span class="hljs-built_in"><span class="hljs-built_in">insert</span></span>{<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'user1@tarantool.io'</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">math</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(fiber.<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>()) + <span class="hljs-number"><span class="hljs-number">60</span></span>} box.space.tester:<span class="hljs-built_in"><span class="hljs-built_in">insert</span></span>{<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">'user2@tarantool.io'</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">math</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(fiber.<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>()) + <span class="hljs-number"><span class="hljs-number">60</span></span>}</code> </pre> <br><p> ç±»ä¼¼åœ°ï¼Œåœ¨30ç§’ä¹‹åï¼Œæ·»åŠ ä¸€äº›å…ƒç»„ï¼š </p><br><pre> <code class="lua hljs">box.space.tester:<span class="hljs-built_in"><span class="hljs-built_in">insert</span></span>{<span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">'user3@tarantool.io'</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">math</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(fiber.<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>()) + <span class="hljs-number"><span class="hljs-number">60</span></span>} box.space.tester:<span class="hljs-built_in"><span class="hljs-built_in">insert</span></span>{<span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-string"><span class="hljs-string">'user4@tarantool.io'</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">math</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(fiber.<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>()) + <span class="hljs-number"><span class="hljs-number">60</span></span>} box.space.tester:<span class="hljs-built_in"><span class="hljs-built_in">insert</span></span>{<span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">'user5@tarantool.io'</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">math</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(fiber.<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>()) + <span class="hljs-number"><span class="hljs-number">60</span></span>}</code> </pre> <br><p> æ£€æŸ¥æ’å…¥æ˜¯å¦æˆåŠŸï¼š </p><br><pre> <code class="lua hljs">tarantool&gt; box.space.tester.index.primary:<span class="hljs-built_in"><span class="hljs-built_in">select</span></span>() <span class="hljs-comment"><span class="hljs-comment">--- - - [0, 'user0@tarantool.io', 1576421257] - [1, 'user1@tarantool.io', 1576421257] - [2, 'user2@tarantool.io', 1576421257] - [3, 'user3@tarantool.io', 1576421287] - [4, 'user4@tarantool.io', 1576421287] - [5, 'user5@tarantool.io', 1576421287] ...</span></span></code> </pre> <br><p>  60+ç§’åï¼ˆä»æ’å…¥ç¬¬ä¸€ä¸ªå…ƒç»„çš„å¼€å§‹ç®—èµ·ï¼‰é‡å¤æ‰§è¡Œselectï¼Œç„¶åæŸ¥çœ‹å·²è®¾ç½®ä¸Šé™çš„è¿‡æœŸæ¨¡å—å·²æ­£å¸¸å·¥ä½œï¼š </p><br><pre> <code class="lua hljs">tarantool&gt; box.space.tester.index.primary:<span class="hljs-built_in"><span class="hljs-built_in">select</span></span>() <span class="hljs-comment"><span class="hljs-comment">--- - - [3, 'user3@tarantool.io', 1576421287] - [4, 'user4@tarantool.io', 1576421287] - [5, 'user5@tarantool.io', 1576421287] ...</span></span></code> </pre> <br><p> å…ƒç»„ä¿ç•™åœ¨è¯¥ç©ºé—´ä¸­ï¼Œè¯¥ç©ºé—´å­˜æ´»çº¦30ç§’ã€‚ æ­¤å¤–ï¼Œå½“ä»æ ‡è¯†ç¬¦ä¸º2ä¸”å¯¿å‘½ä¸º1576421257çš„å…ƒç»„åˆ‡æ¢ä¸ºæ ‡è¯†ç¬¦ä¸º3ä¸”å¯¿å‘½ä¸º1576421287çš„å…ƒç»„æ—¶ï¼Œæ‰«æåœæ­¢ã€‚ç”±äºexpç´¢å¼•é”®çš„é¡ºåºï¼ŒæœªæŸ¥çœ‹å¯¿å‘½ä¸º1576421287åŠä»¥ä¸Šçš„å…ƒç»„ã€‚ è¿™æ˜¯æˆ‘ä»¬ä¸€å¼€å§‹å°±å¸Œæœ›å®ç°çš„èŠ‚çœã€‚ </p><br><p> åœæ­¢ä»»åŠ¡ï¼š </p><br><pre> <code class="lua hljs">capped_connection:call(<span class="hljs-string"><span class="hljs-string">'libcapped-expirationd.kill'</span></span>, {<span class="hljs-string"><span class="hljs-string">'indexed'</span></span>})</code> </pre> <br><h4 id="realizaciya"> å®ä½œ </h4><br><p> æœ€å¥½çš„æ˜¯ï¼Œé¡¹ç›®çš„æ‰€æœ‰åŠŸèƒ½å°†å§‹ç»ˆå‘Šè¯‰å…¶æº<a href="https://github.com/sonntex/tarantool-capped-expirationd" rel="nofollow">ä»£ç </a> ï¼ ä½œä¸ºå‡ºç‰ˆç‰©çš„ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†ä»…å…³æ³¨æœ€é‡è¦çš„æ–¹é¢ï¼Œå³ç©ºé—´æ—è·¯ç®—æ³•ã€‚ </p><br><p> æˆ‘ä»¬ä¼ é€’ç»™startå‡½æ•°çš„å‚æ•°å­˜å‚¨åœ¨ç§°ä¸ºexpirationd_taskçš„ç»“æ„ä¸­ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">expirationd_task</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> name[<span class="hljs-number"><span class="hljs-number">256</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> space_id; <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> rm_index_id; <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> it_index_id; <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> it_index_type; <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> field_no; <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> scan_size; <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> scan_time; };</code> </pre> <br><p>  nameå±æ€§æ˜¯ä»»åŠ¡çš„åç§°ã€‚  space_idå±æ€§æ˜¯ç©ºé—´çš„æ ‡è¯†ç¬¦ã€‚  rm_index_idå±æ€§æ˜¯å°†åˆ é™¤å…ƒç»„çš„å”¯ä¸€ç´¢å¼•çš„æ ‡è¯†ç¬¦ã€‚  it_index_idå±æ€§æ˜¯å°†å¯¹å…ƒç»„è¿›è¡Œçˆ¬ç½‘çš„ç´¢å¼•çš„æ ‡è¯†ç¬¦ã€‚  it_index_typeå±æ€§æ˜¯å°†éå†å…ƒç»„çš„ç´¢å¼•çš„ç±»å‹ã€‚  filed_noå±æ€§æ˜¯å…·æœ‰ç”Ÿå­˜æœŸçš„å…ƒç»„å­—æ®µå·ã€‚  scan_sizeå±æ€§æ˜¯åœ¨å•ä¸ªäº‹åŠ¡ä¸­æŸ¥çœ‹çš„æœ€å¤§å…ƒç»„æ•°ã€‚  scan_timeå±æ€§æ˜¯å®Œæ•´æ‰«æçš„æ—¶é—´ï¼Œä»¥ç§’ä¸ºå•ä½ã€‚ </p><br><p> æˆ‘ä»¬å°†ä¸è€ƒè™‘è§£æå‚æ•°ã€‚ è¿™æ˜¯ä¸€é¡¹è‰°è‹¦è€Œç®€å•çš„å·¥ä½œï¼Œ <a href="https://github.com/tarantool/msgpuck" rel="nofollow">msgpuck</a>åº“å°†ä¸ºæ‚¨æä¾›å¸®åŠ©ã€‚ ä»…å½“ç´¢å¼•æ˜¯ä»Luaä½œä¸ºmp_mapç±»å‹çš„å¤æ‚æ•°æ®ç»“æ„ä¼ è¾“çš„ï¼Œè€Œä¸æ˜¯å€ŸåŠ©ç®€å•ç±»å‹mp_boolï¼Œmp_doubleï¼Œmp_intï¼Œmp_uintå’Œmp_arrayæ—¶ï¼Œæ‰å¯èƒ½å‡ºç°å›°éš¾ã€‚ ä½†æ˜¯æ•´ä¸ªç´¢å¼•æ²¡æœ‰è¢«è§£æã€‚ æ£€æŸ¥å…¶å”¯ä¸€æ€§ï¼Œè®¡ç®—ç±»å‹å¹¶æå–æ ‡è¯†ç¬¦å°±è¶³å¤Ÿäº†ã€‚ </p><br><p> æˆ‘ä»¬åˆ—å‡ºäº†ç”¨äºè§£æçš„æ‰€æœ‰å‡½æ•°çš„åŸå‹ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">expirationd_parse_name</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct expirationd_task *task, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> **pos)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">expirationd_parse_space_id</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct expirationd_task *task, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> **pos)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">expirationd_parse_rm_index_id</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct expirationd_task *task, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> **pos)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">expirationd_parse_rm_index_unique</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct expirationd_task *task, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> **pos)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">expirationd_parse_rm_index</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct expirationd_task *task, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> **pos)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">expirationd_parse_it_index_id</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct expirationd_task *task, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> **pos)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">expirationd_parse_it_index_type</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct expirationd_task *task, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> **pos)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">expirationd_parse_it_index</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct expirationd_task *task, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> **pos)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">expirationd_parse_field_no</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct expirationd_task *task, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> **pos)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">expirationd_parse_scan_size</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct expirationd_task *task, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> **pos)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">expirationd_parse_scan_time</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct expirationd_task *task, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> **pos)</span></span></span></span>;</code> </pre> <br><p> ç°åœ¨è®©æˆ‘ä»¬ç»§ç»­æœ€é‡è¦çš„äº‹æƒ…-ç»•è¿‡ç©ºé—´å¹¶åˆ é™¤å…ƒç»„çš„é€»è¾‘ã€‚ åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸‹æŸ¥çœ‹å’Œæ›´æ”¹ä¸å¤§äºscan_sizeçš„æ¯ä¸ªå…ƒç»„å—ã€‚ å¦‚æœæˆåŠŸï¼Œåˆ™æäº¤è¯¥äº‹åŠ¡ï¼›å¦‚æœå‡ºé”™ï¼Œåˆ™å›æ»šã€‚  expirationd_iterateå‡½æ•°çš„æœ€åä¸€ä¸ªå‚æ•°æ˜¯æŒ‡å‘è¿­ä»£å™¨çš„æŒ‡é’ˆï¼Œä»è¯¥è¿­ä»£å™¨å¼€å§‹æˆ–ç»§ç»­æ‰«æã€‚ è¯¥è¿­ä»£å™¨åœ¨å†…éƒ¨é€’å¢ï¼Œç›´åˆ°å‘ç”Ÿé”™è¯¯ï¼Œç©ºæ ¼ç»“æŸæˆ–æ²¡æœ‰æœºä¼šæå‰åœæ­¢è¿›ç¨‹ä¸ºæ­¢ã€‚  expirationd_expiredå‡½æ•°æ£€æŸ¥å…ƒç»„çš„ç”Ÿå‘½å‘¨æœŸï¼Œexpirationd_delete-åˆ é™¤å…ƒç»„ï¼Œexpirationd_breakable-æ£€æŸ¥æˆ‘ä»¬æ˜¯å¦éœ€è¦ç»§ç»­ã€‚ </p><br><p>  Expirationd_iterateå‡½æ•°ä»£ç ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">expirationd_iterate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct expirationd_task *task, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">box_iterator_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> **iterp)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">box_iterator_t</span></span> *iter = *iterp; box_txn_begin(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; task-&gt;scan_size; ++i) { <span class="hljs-keyword"><span class="hljs-keyword">box_tuple_t</span></span> *tuple = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (box_iterator_next(iter, &amp;tuple) &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { box_iterator_free(iter); *iterp = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; box_txn_rollback(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!tuple) { box_iterator_free(iter); *iterp = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; box_txn_commit(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (expirationd_expired(task, tuple)) expirationd_delete(task, tuple); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (expirationd_breakable(task)) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } box_txn_commit(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; }</code> </pre> <br><p>  Expirationd_expiredå‡½æ•°ä»£ç ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">expirationd_expired</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct expirationd_task *task, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">box_tuple_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *tuple)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *buf = box_tuple_field(tuple, task-&gt;field_no - <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!buf || mp_typeof(*buf) != MP_UINT) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">uint64_t</span></span> val = mp_decode_uint(&amp;buf); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (val &gt; fiber_time64() / <span class="hljs-number"><span class="hljs-number">1000000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; }</code> </pre> <br><p> åŠŸèƒ½ä»£ç expirationd_deleteï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">expirationd_delete</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct expirationd_task *task, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">box_tuple_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *tuple)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> len; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *str = box_tuple_extract_key(tuple, task-&gt;space_id, task-&gt;rm_index_id, &amp;len); box_delete(task-&gt;space_id, task-&gt;rm_index_id, str, str + len, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); }</code> </pre> <br><p>  Expirationd_breakableå‡½æ•°ä»£ç ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">expirationd_breakable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct expirationd_task *task)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> task-&gt;it_index_id != task-&gt;rm_index_id &amp;&amp; task-&gt;it_index_type == ITER_GT; }</code> </pre> <br><h4 id="prilozhenie"> åº”ç”¨ç¨‹å¼ </h4><br><p>  <a href="https://github.com/sonntex/tarantool-capped-expirationd" rel="nofollow">åœ¨æ­¤å¤„</a>æŸ¥çœ‹æºä»£ç ï¼ </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN479166/">https://habr.com/ru/post/zh-CN479166/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN479154/index.html">è¿˜æ˜¯æ‰“æ¶è¿˜æ˜¯è¶³å¤Ÿï¼Ÿ</a></li>
<li><a href="../zh-CN479156/index.html">ESP32 + Arduino Core + FreeRTOS + Blynk =åˆè¡·çš„æˆ¿å­</a></li>
<li><a href="../zh-CN479158/index.html">ITILçš„7æ¡åŸºæœ¬åŸåˆ™</a></li>
<li><a href="../zh-CN479162/index.html">å¤ªé˜³ç³»è¡Œæ˜Ÿä¸Šçš„æå…‰</a></li>
<li><a href="../zh-CN479164/index.html">ä»€ä¹ˆæ˜¯è„‘ç”µå›¾ï¼Œä¸ºä»€ä¹ˆéœ€è¦</a></li>
<li><a href="../zh-CN479168/index.html">å¦‚ä½•åœ¨Symfony 5 + APIå¹³å°ä¸Šä¸ºMODXé¡¹ç›®åˆ›å»ºRESTful API</a></li>
<li><a href="../zh-CN479170/index.html">å‘¨æœ«é˜…è¯»ï¼šæµåª’ä½“æœåŠ¡å’ŒéŸ³ä¹è¡Œä¸šçš„éŸ³é¢‘æ‘˜è¦</a></li>
<li><a href="../zh-CN479176/index.html">Moddersç”¨äº†15å¹´çš„æ—¶é—´ä¿®å¤äº†æ—§å…±å’Œå›½éª‘å£«2</a></li>
<li><a href="../zh-CN479178/index.html">å¯¹æ¤­åœ†æ•°æ®é›†äº¤æ˜“è¿›è¡ŒåŒ¿åå¤„ç†</a></li>
<li><a href="../zh-CN479180/index.html">åœ¨.NET Coreä¸Šåˆ›å»ºDiscord-botå¹¶å°†å…¶éƒ¨ç½²åˆ°VPSæœåŠ¡å™¨</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>