<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚úåüèΩ üìµ üßëüèΩ‚Äçü§ù‚ÄçüßëüèΩ Archivos locales al portar una aplicaci√≥n a Kubernetes üèí üë®üèæ‚Äç‚öñÔ∏è ü§≥üèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Cuando se crea un proceso de CI / CD con Kubernetes, a veces hay un problema de incompatibilidad de los requisitos de la nueva infraestructura y la ap...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Archivos locales al portar una aplicaci√≥n a Kubernetes</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/471582/"><img src="https://habrastorage.org/webt/bx/1x/lp/bx1xlp1iax5bfqfwuggugmedkkq.png"><br><br>  Cuando se crea un proceso de CI / CD con Kubernetes, a veces hay un problema de incompatibilidad de los requisitos de la nueva infraestructura y la aplicaci√≥n que se le transfiere.  En particular, en la etapa de ensamblaje de la aplicaci√≥n, es importante obtener <i>una</i> imagen que se utilizar√° en <i>todos los</i> entornos y cl√∫steres del proyecto.  Este principio subyace a la correcta gesti√≥n de contenedores en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">la opini√≥n de Google</a> (nuestro techdir ha <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">hablado</a> repetidamente de esto). <br><br>  Sin embargo, no sorprender√° a nadie con situaciones en las que se utiliza un marco listo para usar en el c√≥digo del sitio, cuyo uso impone restricciones en su funcionamiento posterior.  Y si es f√°cil de manejar en un "entorno normal", en Kubernetes, este tipo de comportamiento puede ser un problema, especialmente cuando lo encuentras por primera vez.  Aunque una mente ingeniosa puede ofrecer soluciones de infraestructura que parecen obvias e incluso bastante buenas a primera vista ... es importante recordar que la mayor√≠a de las situaciones pueden y deben <b>resolverse arquitect√≥nicamente</b> . <br><br>  Analicemos las soluciones alternativas populares para almacenar archivos, que pueden tener consecuencias desagradables durante el funcionamiento del cl√∫ster, y tambi√©n se√±alar una ruta m√°s correcta. <a name="habracut"></a><br><br><h2>  Almacenamiento est√°tico </h2><br>  Para ilustrar, considere una aplicaci√≥n web que utiliza un generador est√°tico para obtener un conjunto de im√°genes, estilos y m√°s.  Por ejemplo, el framework Yii PHP tiene un administrador de activos incorporado que genera nombres de directorio √∫nicos.  En consecuencia, la salida es un conjunto de rutas obviamente no intersectadas para las estad√≠sticas del sitio (esto se hizo por varias razones, por ejemplo, para excluir duplicados cuando se usa el mismo recurso con muchos componentes).  Entonces, fuera de la caja, cuando accede por primera vez al m√≥dulo de recursos web, se forman y presentan estad√≠sticas (de hecho, a menudo enlaces simb√≥licos, pero m√°s sobre eso m√°s adelante) con un directorio ra√≠z com√∫n que es √∫nico para esta implementaci√≥n: <br><br><ul><li> <code>webroot/assets/2072c2df/css/‚Ä¶</code> </li> <li> <code>webroot/assets/2072c2df/images/‚Ä¶</code> </li> <li> <code>webroot/assets/2072c2df/js/‚Ä¶</code> </li> </ul><br>  ¬øQu√© es esto cargado en t√©rminos de un cl√∫ster? <br><br><h3>  Ejemplo m√°s simple </h3><br>  Tomemos un caso bastante com√∫n cuando PHP se enfrenta a nginx para distribuir estad√≠sticas y manejar consultas simples.  La forma m√°s f√°cil es la <i>implementaci√≥n</i> con dos contenedores: <br><br><pre> <code class="plaintext hljs">apiVersion: apps/v1 kind: Deployment metadata: name: site spec: selector: matchLabels: component: backend template: metadata: labels: component: backend spec: volumes: - name: nginx-config configMap: name: nginx-configmap containers: - name: php image: own-image-with-php-backend:v1.0 command: ["/usr/local/sbin/php-fpm","-F"] workingDir: /var/www - name: nginx image: nginx:1.16.0 command: ["/usr/sbin/nginx", "-g", "daemon off;"] volumeMounts: - name: nginx-config mountPath: /etc/nginx/conf.d/default.conf subPath: nginx.conf</code> </pre> <br>  En una forma simplificada, la configuraci√≥n de nginx se reduce a lo siguiente: <br><br><pre> <code class="plaintext hljs">apiVersion: v1 kind: ConfigMap metadata: name: "nginx-configmap" data: nginx.conf: | server { listen 80; server_name _; charset utf-8; root /var/www; access_log /dev/stdout; error_log /dev/stderr; location / { index index.php; try_files $uri $uri/ /index.php?$args; } location ~ \.php$ { fastcgi_pass 127.0.0.1:9000; fastcgi_index index.php; include fastcgi_params; } }</code> </pre> <br>  Cuando accede por primera vez al sitio en un contenedor con PHP, aparecen los activos.  Pero en el caso de dos contenedores dentro del mismo pod, nginx no sabe nada acerca de estos archivos est√°ticos, que (de acuerdo con la configuraci√≥n) se les debe dar.  Como resultado, el cliente ver√° el error 404 para todas las solicitudes de archivos CSS y JS. La soluci√≥n m√°s simple aqu√≠ es organizar un directorio com√∫n para contenedores.  Una opci√≥n primitiva es el gen√©rico <code>emptyDir</code> : <br><br><pre> <code class="plaintext hljs">apiVersion: apps/v1 kind: Deployment metadata: name: site spec: selector: matchLabels: component: backend template: metadata: labels: component: backend spec: volumes: - name: assets emptyDir: {} - name: nginx-config configMap: name: nginx-configmap containers: - name: php image: own-image-with-php-backend:v1.0 command: ["/usr/local/sbin/php-fpm","-F"] workingDir: /var/www volumeMounts: - name: assets mountPath: /var/www/assets - name: nginx image: nginx:1.16.0 command: ["/usr/sbin/nginx", "-g", "daemon off;"] volumeMounts: - name: assets mountPath: /var/www/assets - name: nginx-config mountPath: /etc/nginx/conf.d/default.conf subPath: nginx.conf</code> </pre> <br>  Ahora los archivos est√°ticos generados en el contenedor son dados por nginx correctamente.  Pero perm√≠tame recordarle que esta es una soluci√≥n primitiva, lo que significa que est√° lejos de ser ideal y tiene sus propios matices y deficiencias, que se analizan a continuaci√≥n. <br><br><h3>  Almacenamiento m√°s avanzado </h3><br>  Ahora imagine una situaci√≥n en la que un usuario visit√≥ un sitio, carg√≥ una p√°gina con los estilos disponibles en el contenedor y, mientras estaba leyendo esta p√°gina, volvimos a implementar el contenedor.  El directorio de activos se ha quedado vac√≠o y requiere una solicitud a PHP para comenzar a generar nuevos.  Sin embargo, incluso despu√©s de esto, los enlaces a las estad√≠sticas antiguas estar√°n desactualizadas, lo que provocar√° errores al mostrar las estad√≠sticas. <br><br>  Adem√°s, lo m√°s probable es que tengamos un proyecto m√°s o menos cargado, lo que significa que una copia de la aplicaci√≥n no ser√° suficiente: <br><br><ul><li>  Escale la <i>implementaci√≥n</i> a dos r√©plicas. </li><li>  Cuando accede por primera vez al sitio en una r√©plica, se crearon activos. </li><li>  En alg√∫n momento, la entrada decidi√≥ (para equilibrar la carga) enviar una solicitud de una segunda r√©plica, y estos activos a√∫n no est√°n all√≠.  O tal vez ya no est√°n all√≠, porque usamos <code>RollingUpdate</code> y actualmente estamos haciendo un despliegue. </li></ul><br>  En general, el resultado son errores nuevamente. <br><br>  Para no perder los activos antiguos, puede cambiar <code>emptyDir</code> a <code>hostPath</code> , agregando f√≠sicamente las estad√≠sticas al nodo del cl√∫ster.  Este enfoque es malo porque debemos <b>vincularnos a un nodo de cl√∫ster espec√≠fico</b> con nuestra aplicaci√≥n, porque, en caso de pasar a otros nodos, el directorio no contendr√° los archivos necesarios.  O bien, se requiere una sincronizaci√≥n en segundo plano del directorio entre nodos. <br><br>  ¬øCuales son las soluciones? <br><br><ol><li>  Si el hardware y los recursos lo permiten, puede usar <a href="">cephfs</a> para organizar un directorio <a href="">igualmente</a> accesible para las necesidades de las estad√≠sticas.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">La documentaci√≥n oficial</a> recomienda SSD, al menos una triple replicaci√≥n y una conexi√≥n robusta y "gruesa" entre nodos del cl√∫ster. </li><li>  Una opci√≥n menos exigente ser√≠a organizar un servidor NFS.  Sin embargo, debe considerar el posible aumento en el tiempo de respuesta a las solicitudes de procesamiento por parte del servidor web, y la tolerancia a fallas dejar√° mucho que desear.  Las consecuencias de la falla son catastr√≥ficas: la p√©rdida de montura destruye el grupo hasta la muerte bajo el ataque de la carga de Los √Ångeles que se precipita hacia el cielo. </li></ol><br>  Entre otras cosas, para todas las opciones para crear almacenamiento persistente, se requerir√° la <b>limpieza en segundo plano de</b> los conjuntos de archivos obsoletos acumulados durante un cierto per√≠odo de tiempo.  Antes de los contenedores con PHP, puede poner <i>DaemonSet</i> en el almacenamiento en cach√© de nginx, que almacenar√° copias de activos por un tiempo limitado.  Este comportamiento se puede configurar f√°cilmente usando <code>proxy_cache</code> con profundidad de almacenamiento en d√≠as o gigabytes de espacio en disco. <br><br>  La combinaci√≥n de este m√©todo con los sistemas de archivos distribuidos mencionados anteriormente proporciona un campo enorme para la imaginaci√≥n, una limitaci√≥n solo en el presupuesto y el potencial t√©cnico de quienes lo implementar√°n y respaldar√°n.  Por experiencia, decimos que cuanto m√°s simple es el sistema, m√°s estable funciona.  Con la adici√≥n de tales capas, se hace mucho m√°s dif√≠cil mantener la infraestructura y, al mismo tiempo, aumenta el tiempo dedicado al diagn√≥stico y la recuperaci√≥n en caso de fallas. <br><br><h3>  Recomendaci√≥n </h3><br>  Si la implementaci√≥n de las opciones de almacenamiento propuestas tambi√©n le parece injustificada (complicada, costosa ...), entonces debe mirar la situaci√≥n desde el otro lado.  Es decir, profundizar en la arquitectura del proyecto y <b>erradicar el problema en el c√≥digo</b> mediante el enlace a alguna estructura de datos est√°tica en la imagen, proporciona una definici√≥n inequ√≠voca de los contenidos o el procedimiento de "calentamiento" y / o precompilaci√≥n de activos en la etapa de ensamblaje de la imagen.  Por lo tanto, obtenemos un comportamiento absolutamente predecible y el mismo conjunto de archivos para todos los entornos y r√©plicas de la aplicaci√≥n en ejecuci√≥n. <br><br>  Si volvemos a un ejemplo espec√≠fico con el marco Yii y no profundizamos en su estructura (que no es el prop√≥sito del art√≠culo), es suficiente se√±alar dos enfoques populares: <br><br><ol><li>  Modifique el proceso de ensamblar la imagen para que los activos se coloquen en un lugar predecible.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Ofrezca</a> / implemente en extensiones como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">yii2-static-assets</a> . </li><li>  Defina hashes espec√≠ficos para directorios de activos, como se describe, por ejemplo, en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">esta presentaci√≥n</a> (comenzando con la diapositiva 35).  Por cierto, el autor del informe en √∫ltima instancia (¬°y no sin raz√≥n!) Aconseja despu√©s de ensamblar los activos en el servidor de compilaci√≥n para cargarlos en un repositorio central (como S3), frente al cual colocar el CDN. </li></ol><br><h2>  Archivos descargables </h2><br>  Otro caso que seguramente se disparar√° al transferir una aplicaci√≥n a un cl√∫ster de Kubernetes es almacenar archivos de usuario en el sistema de archivos.  Por ejemplo, nuevamente tenemos una aplicaci√≥n PHP que acepta archivos a trav√©s del formulario de carga, hace algo con ellos en el proceso y lo devuelve. <br><br>  El lugar donde deber√≠an ubicarse estos archivos en las realidades de Kubernetes deber√≠a ser com√∫n a todas las r√©plicas de aplicaciones.  Dependiendo de la complejidad de la aplicaci√≥n y la necesidad de organizar la persistencia de estos archivos, tal lugar puede ser las opciones para dispositivos compartidos mencionados anteriormente, pero, como vemos, tienen sus inconvenientes. <br><br><h3>  Recomendaci√≥n </h3><br>  Una soluci√≥n es <b>usar un almacenamiento compatible con S3</b> (incluso si alg√∫n tipo de categor√≠a autohospedada como minio).  La transici√≥n para trabajar con S3 requerir√° cambios <i>a nivel de c√≥digo</i> , y ya <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">escribimos</a> c√≥mo se devolver√° el contenido en la interfaz. <br><br><h2>  Sesiones personalizadas </h2><br>  Por separado, vale la pena se√±alar la organizaci√≥n del almacenamiento de las sesiones de los usuarios.  A menudo, estos tambi√©n son archivos en el disco que, en el contexto de Kubernetes, generar√°n solicitudes de autorizaci√≥n constantes del usuario si su solicitud cae en otro contenedor. <br><br>  Parte del problema se resuelve mediante la inclusi√≥n de <code>stickySessions</code> en el ingreso <i>(la funci√≥n es compatible con todos los controladores de ingreso populares; consulte <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">nuestra revisi√≥n</a> para m√°s detalles)</i> para vincular al usuario a un pod espec√≠fico con la aplicaci√≥n: <br><br><pre> <code class="plaintext hljs">apiVersion: networking.k8s.io/v1beta1 kind: Ingress metadata: name: nginx-test annotations: nginx.ingress.kubernetes.io/affinity: "cookie" nginx.ingress.kubernetes.io/session-cookie-name: "route" nginx.ingress.kubernetes.io/session-cookie-expires: "172800" nginx.ingress.kubernetes.io/session-cookie-max-age: "172800" spec: rules: - host: stickyingress.example.com http: paths: - backend: serviceName: http-svc servicePort: 80 path: /</code> </pre> <br>  Pero esto no lo salvar√° de implementaciones repetidas. <br><br><h3>  Recomendaci√≥n </h3><br>  Una forma m√°s correcta ser√≠a transferir la aplicaci√≥n para <b>almacenar sesiones en Memcached, Redis y soluciones similares</b> , en general, abandonar completamente las opciones de archivo. <br><br><h2>  Conclusi√≥n </h2><br>  Las soluciones de infraestructura consideradas en el texto son dignas de aplicaci√≥n solo en el formato de "muletas" temporales (que suena m√°s hermoso en ingl√©s como una soluci√≥n alternativa).  Pueden ser relevantes en las primeras etapas de la migraci√≥n de aplicaciones a Kubernetes, pero no deben "enraizarse". <br><br>  La forma general recomendada es deshacerse de ellos en favor del refinamiento arquitect√≥nico de la aplicaci√≥n de acuerdo con la ya conocida aplicaci√≥n de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">12 factores</a> .  Sin embargo, esto, llevar la aplicaci√≥n a una forma sin estado, significa inevitablemente que se requerir√°n cambios en el c√≥digo, y es importante encontrar un equilibrio entre las capacidades / requisitos del negocio y las perspectivas para implementar y mantener la ruta elegida. <br><br><h2>  PS </h2><br>  Lea tambi√©n en nuestro blog: <br><br><ul><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Proxing archivos de AWS S3 utilizando herramientas nginx</a> "; </li><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">7 mejores pr√°cticas para la operaci√≥n de contenedores seg√∫n Google</a> "; </li><li>  ‚Äú <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">7 principios para dise√±ar aplicaciones basadas en contenedores</a> ‚Äù <i>(de Red Hat)</i> ; </li><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">7 factores faltantes en el enfoque de la aplicaci√≥n de 12 factores</a> ". </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/471582/">https://habr.com/ru/post/471582/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../471570/index.html">Smartphones restaurados: ¬øganancia o enga√±o?</a></li>
<li><a href="../471572/index.html">M√∫ltiples solicitudes de API utilizando mergeMap y forkJoin en lugar de suscribirse</a></li>
<li><a href="../471574/index.html">Oracle Database 19c: diferencias fundamentales con respecto a versiones anteriores</a></li>
<li><a href="../471576/index.html">C√≥mo el control de calidad genera una interacci√≥n efectiva con los desarrolladores. Una manera posible</a></li>
<li><a href="../471580/index.html">Conferencia para desarrolladores de plataformas de Stripe, Intercom, JetBrains, Miro, ManyChat, Wrike, Targetprocess, etc.</a></li>
<li><a href="../471588/index.html">Internet industrial de las cosas: hablando de casos exitosos</a></li>
<li><a href="../471590/index.html">Los primeros seis meses como l√≠der de equipo: c√≥mo no volverse loco si todo parece estar mal</a></li>
<li><a href="../471592/index.html">MacOS 10.15 ya no admite aplicaciones de 32 bits. Que puedes hacer</a></li>
<li><a href="../471594/index.html">Beeline Kazakhstan y Slerm celebran el D√≠a Beeline DevOps en Almaty del 6 al 7 de noviembre</a></li>
<li><a href="../471596/index.html">MacOS 10.15 ya no admite aplicaciones de 32 bits. Que puedes hacer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>