<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚è∞ üë®üèø‚Äçüíª ü§î Test du code SQL Server avec tSQLt üñçÔ∏è üï• ü§∞</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pour info: cet article est une version √©largie de mon discours lors des SQA Days # 25. 

 Sur la base de mon exp√©rience avec des coll√®gues, je peux af...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Test du code SQL Server avec tSQLt</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/arcadia/blog/465567/">  <i>Pour info: cet article est une version √©largie de mon <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">discours</a> lors des SQA Days # 25.</i> <br><br>  Sur la base de mon exp√©rience avec des coll√®gues, je peux affirmer: le test de code DB n'est pas une pratique largement r√©pandue.  Cela peut √™tre potentiellement dangereux.  La logique DB est √©crite par des √™tres humains comme tous les autres codes "habituels".  Il peut donc y avoir des pannes qui peuvent avoir des cons√©quences n√©gatives sur un produit, une entreprise ou des utilisateurs.  Qu'il s'agisse de proc√©dures stock√©es aidant le backend ou de modifications de donn√©es ETL dans un entrep√¥t - il y a toujours un risque et les tests contribuent √† le diminuer.  Je veux vous dire ce qu'est tSQLt et comment il nous aide √† tester le code DB. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/2e/-h/nx/2e-hnxb3bddbq3ck_8vi4jwah8i.jpeg"></div><a name="habracut"></a><br><h1>  Le contexte </h1><br>  Il existe un grand entrep√¥t utilisant SQL Server et contenant diff√©rentes donn√©es d'essais cliniques.  Il est rempli √† partir d'une vari√©t√© de sources (bases de donn√©es orient√©es documents principalement).  De nombreux ETL transforment les donn√©es de l'entrep√¥t √† plusieurs reprises.  Ces donn√©es peuvent √™tre charg√©es dans des bases de donn√©es plus petites pour √™tre utilis√©es par des applications Web orient√©es sur de petites t√¢ches sp√©cifiques.  Certains clients du client ont demand√© √† impl√©menter des API pour leurs besoins.  Ces API utilisent souvent des proc√©dures stock√©es et des requ√™tes diff√©rentes. <br><br><div style="text-align:center;"><img width="75%" height="75%" src="https://habrastorage.org/webt/iw/vu/rz/iwvurz8sbflhuz3mkj39ipf9rag.png"></div><br>  En g√©n√©ral, il y a une assez grande quantit√© de code du c√¥t√© SGBD. <br><br><h1>  Pourquoi en avons-nous besoin? </h1><br>  Comme vous pouvez le voir dans l'introduction, le code DB fait partie du code de l'application et peut √©galement contenir des bogues. <br><br>  Je suppose que beaucoup d'entre nous connaissent la courbe de Boehm: les bogues sont toujours plus chers √† corriger plus tard dans le processus.  Une erreur commise √† un stade de d√©veloppement ant√©rieur et localis√©e √† un stade ult√©rieur peut co√ªter plus cher.  Cela est d√ª √† la n√©cessit√© de passer par de nombreuses √©tapes interm√©diaires (codage, tests unitaires, tests d'int√©gration, tests syst√®me, etc.) deux fois: pour le d√©bogage et pour ramener le code √† l'√©tape o√π il a √©t√© trouv√©.  Cet effet est √©galement vrai pour le cas d'entrep√¥t.  S'il y a une erreur dans une proc√©dure ETL et que les donn√©es sont modifi√©es plusieurs fois, nous devons: <br><br><ol><li>  passer par toutes les √©tapes de transformation des donn√©es jusqu'√† la source du probl√®me </li><li>  r√©soudre le probl√®me </li><li>  d√©river √† nouveau les donn√©es appropri√©es (des modifications manuelles suppl√©mentaires peuvent √™tre n√©cessaires) </li><li>  assurez-vous qu'il n'y a pas d'autres donn√©es cass√©es caus√©es par le bogue. </li></ol><br>  N'oubliez pas que nous ne vendons pas de peluches.  Une erreur dans un domaine tel que les essais cliniques peut nuire non seulement aux entreprises mais √©galement √† la sant√© humaine. <br><br><h1>  Comment tester? </h1><br>  Puisque nous parlons de tests de code, nous entendons les tests unitaires et d'int√©gration.  Ces choses sont tr√®s r√©p√©titives et impliquent une r√©gression persistante.  √Ä strictement parler, ces tests ne sont jamais effectu√©s manuellement (enfin, sauf dans certains cas singuliers). <br><br>  Bon bonus: les tests peuvent √™tre des supports pour la documentation du code.  Par exemple, les exigences peuvent ressembler √† ceci (cliquable): <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/webt/fh/af/xb/fhafxb5yph-tgvy2zhka9jfcvmk.png"></a> </div><br>  Fichier XLS, 2 colonnes avec exigences + informations suppl√©mentaires fragment√©es dans d'autres colonnes + balisage d√©routant.  Il peut √™tre difficile de restaurer les souhaits initiaux si n√©cessaire.  Les tests peuvent aider √† enregistrer les nuances d'impl√©mentation.  Bien s√ªr, ils ne doivent pas √™tre consid√©r√©s comme un remplacement de la documentation. <br><br>  Malheureusement, la complexit√© des tests augmente avec la croissance de la complexit√© du code, donc cet effet peut √™tre att√©nu√©. <br><br>  Les tests peuvent constituer une couche de s√©curit√© suppl√©mentaire contre les fusions spontan√©es.  Les tests automatiques CI aident √† r√©soudre ce probl√®me en raison de leur formalisme. <br><br>  Donc, si nous avons d√©cid√© d'utiliser l'automatisation, nous devons choisir un outil pour cela. <br><br><h1>  Que faut-il utiliser pour les tests? </h1><br>  En cas de test de code DB, je vois 2 approches: aliment√© par SQL (lorsqu'un outil fonctionne directement dans le SGBD) et non aliment√© par SQL.  Voici les principales diff√©rences que j'ai trouv√©es: <br><div class="scrollable-table"><table><tbody><tr><th>  Aliment√© par SQL <br></th><th>  Non aliment√© par SQL <br></th></tr><tr><td>  N√©cessite l'installation d'objets DB <br></td><td>  N√©cessite l'installation d'outils externes (par rapport √† la base de donn√©es) <br></td></tr><tr><td>  Les tests sont ind√©pendants des technologies utilis√©es en dehors de DB <br></td><td>  Les tests peuvent d√©pendre des technologies utilis√©es en dehors de DB <br></td></tr><tr><td>  Le framework est toujours d√©di√© √† un seul SGBD <br></td><td>  Le framework prend souvent en charge plusieurs SGBD <br></td></tr><tr><td>  La connaissance du SGBD est la seule exigence pour √©crire des tests;  il est possible d'utiliser des testeurs manuels ou DBA <br></td><td>  Une connaissance suppl√©mentaire des langages ou technologies de programmation est requise pour la r√©daction des tests;  l'aide d'un d√©veloppeur est souvent n√©cessaire <br></td></tr><tr><td>  L'ex√©cution au niveau du SGBD permet une utilisation avanc√©e des contrefa√ßons et des assertions. <br></td><td>  L'ex√©cution en dehors d'un SGBD peut limiter les fonctionnalit√©s de l'outil <br></td></tr></tbody></table></div>  Dans le cas de SQL Server, nous avons plusieurs choix: <br><div class="scrollable-table"><table><tbody><tr><th colspan="6" align="center">  Informations g√©n√©rales </th></tr><tr><th>  Nom </th><th>  Approche </th><th>  L'architecture </th><th>  Langue / Plateforme </th><th>  Teste la langue </th></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">tSQLt</a> </td><td>  Aliment√© par SQL </td><td>  xUnit </td><td>  T-SQL + CLR </td><td>  T-sql </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">TSQLUnit</a> </td><td>  Aliment√© par SQL </td><td>  xUnit </td><td>  T-sql </td><td>  T-sql </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">utTSQL</a> </td><td>  Aliment√© par SQL </td><td>  xUnit </td><td>  T-sql </td><td>  T-sql </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Tst</a> </td><td>  Aliment√© par SQL </td><td>  xUnit </td><td>  T-sql </td><td>  T-sql </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Dbfit</a> </td><td>  Non aliment√© par SQL </td><td>  Fitnessess </td><td>  C # / java </td><td>  D√©marque wiki </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Slacker</a> </td><td>  Non aliment√© par SQL </td><td>  RSpec (orient√© BDD) </td><td>  Rubis </td><td>  Rubis </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">NUnit</a> , etc. </td><td>  Non aliment√© par SQL </td><td>  xUnit </td><td>  N / a </td><td>  N / a </td></tr></tbody></table></div><div class="scrollable-table"><table><tbody><tr><th colspan="4" align="center">  Les dates </th></tr><tr><th>  Nom </th><th>  Premi√®re apparition </th><th>  Dernier commit </th><th>  Derni√®re version </th></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">tSQLt</a> </td><td>  2007-07-27 </td><td>  07/07/2019 </td><td>  31/01/2016 </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">TSQLUnit</a> </td><td>  16/12/2006 (0,9) <br>  2007-07-21 (0,91 rc1) </td><td>  26/04/2018 (GitHub) </td><td>  04/09/2011 (SourceForge) </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">utTSQL</a> </td><td>  2003-03-12 </td><td>  2003-03-12 </td><td>  2003-03-12 </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Tst</a> </td><td>  02-03-2009 (v1.0) </td><td>  N / a </td><td>  30-03-2012 </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Dbfit</a> </td><td>  12-01-2009 </td><td>  10-09-2018 </td><td>  15/08/2015 </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Slacker</a> </td><td>  23/06/2011 </td><td>  12-12-2018 </td><td>  12-12-2018 </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">NUnit</a> , etc. </td><td>  N / a </td><td>  N / a </td><td>  N / a </td></tr></tbody></table></div><div class="scrollable-table"><table><tbody><tr><th colspan="7" align="center">  CARACT√âRISTIQUES </th></tr><tr><th>  Nom </th><th>  CLR n'est pas requis </th><th>  Sortie XML </th><th>  Tests dans des transactions s√©par√©es </th><th>  Faux </th><th>  Gestionnaires d'erreurs </th><th>  Assertions </th></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">tSQLt</a> </td><td>  - </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  Excellent </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">TSQLUnit</a> </td><td>  + </td><td>  - </td><td>  + </td><td>  - </td><td>  - </td><td>  A d√©faut </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">utTSQL</a> </td><td>  + </td><td>  - </td><td>  - </td><td>  - </td><td>  - </td><td>  Inf√©rieur √† la moyenne </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Tst</a> </td><td>  + </td><td>  + </td><td>  + (facultatif) </td><td>  - </td><td>  + </td><td>  Excellent </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Dbfit</a> </td><td>  + </td><td>  - </td><td>  + (facultatif) </td><td>  - </td><td>  + </td><td>  Tr√®s bien;  nuanc√© </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Slacker</a> </td><td>  + </td><td>  - </td><td>  + (facultatif) </td><td>  - </td><td>  - </td><td>  Tr√®s bien;  nuanc√© </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">NUnit</a> , etc. </td><td>  + </td><td>  + </td><td>  N / a </td><td>  N / a </td><td>  N / a </td><td>  Excellent;  nuanc√© </td></tr></tbody></table></div><div class="scrollable-table"><table><tbody><tr><th colspan="3" align="center">  Autre </th></tr><tr><th>  Nom </th><th>  La documentation </th><th>  Communaut√© </th></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">tSQLt</a> </td><td>  Excellent;  nuanc√© </td><td>  Excellent </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">TSQLUnit</a> </td><td>  Inf√©rieur √† la moyenne </td><td>  Inf√©rieur √† la moyenne </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">utTSQL</a> </td><td>  Excellent </td><td>  Inf√©rieur √† la moyenne </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Tst</a> </td><td>  Excellent </td><td>  Inf√©rieur √† la moyenne </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Dbfit</a> </td><td>  Excellent </td><td>  Moyenne </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Slacker</a> </td><td>  Excellent </td><td>  Moyenne </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">NUnit</a> , etc. </td><td>  Excellent </td><td>  Excellent </td></tr></tbody></table></div>  L'√©chelle "Excellent - √âchec" est subjective, d√©sol√©, il est difficile de trouver un moyen de contourner. <br><br>  ¬´Premi√®re apparition¬ª - la premi√®re date d'apparition du framework que j'ai pu trouver - la premi√®re version ou validation. <br><br>  Comme vous pouvez le voir, les alternatives bas√©es sur SQL ont √©t√© abandonn√©es il y a assez longtemps et tSQLt est le seul produit actuellement pris en charge.  De plus, tSQLt gagne fonctionnellement.  La seule chose est que TST poss√®de un ensemble d'assertions un peu plus riche que tSQLt;  cependant, je doute que cela puisse l'emporter sur tous les inconv√©nients. <br><br>  La documentation tSQLt a quelques nuances, je les d√©crirai plus tard. <br><br>  Dans le monde non propuls√© par SQL, les choses ne sont pas aussi claires.  Des alternatives se d√©veloppent, bien qu'elles ne soient pas super-actives.  DbFit est un outil assez int√©ressant bas√© sur le framework FitNesse.  Cela implique d'utiliser le balisage wiki pour √©crire des tests.  Slacker est √©galement int√©ressant: l'approche BDD est sugg√©r√©e pour les tests de code DB. <br><br>  Je devrais dire √† propos des assertions dans les solutions non propuls√©es par SQL.  √Ä premi√®re vue, le nombre d'assertions est moindre et nous pouvons penser que de tels outils sont pires.  Mais nous devons garder √† l'esprit qu'ils sont fondamentalement diff√©rents de tSQLt, donc un tel regard superficiel est incorrect. <br><br>  La derni√®re ligne - "NUnit, etc."  - ressemble plus √† un rappel.  Un grand nombre de frameworks de tests unitaires habituels peuvent √™tre appliqu√©s au code DB √† l'aide de biblioth√®ques suppl√©mentaires.  Il y a beaucoup de N / A dans cette ligne car cette ligne, en fait, comprend plusieurs outils.  C'est la source des "nuances" dans la colonne "assertions" - diff√©rents outils peuvent fournir diff√©rents ensembles et il n'y a aucune garantie que toutes les assertions peuvent √™tre appliqu√©es √† DB. <br><br>  Comme autre mesure int√©ressante, nous pouvons consid√©rer <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">les tendances de Google</a> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ud/2u/km/ud2ukmcoyjvstvhcu2taegpib34.png"></div><br>  Nuances: <br><br><ol><li>  J'ai d√©cid√© de ne pas inclure Slacker car ce nom peut signifier diff√©rentes choses (et des requ√™tes comme "Slacker framework" sont √† peine visibles sur le graphique). </li><li>  Par curiosit√© (et parce qu'un emplacement est rest√© vide), j'ai ajout√© la tendance TST.  Mais cela nous montre √† peine la vraie image car c'est une abr√©viation qui peut aussi signifier diff√©rentes choses. </li><li>  Je n'ai pas inclus NUnit et ses analogues.  Ces outils sont des cadres pour les tests de code "habituels", donc leurs tendances ne sont pas descriptives pour notre contexte. </li></ol><br>  Comme vous pouvez le voir, tSQLt est l'outil le plus consultable de la liste.  Un autre outil (moins) populaire est DbFit.  D'autres outils ont une popularit√© limit√©e. <br><br>  Dans l'ensemble, nous pouvons voir que tSQLt brille en arri√®re-plan. <br><br><h1>  Qu'est-ce que tSQLt? </h1><br>  Il est facile de deviner que tSQLt est un framework de tests unitaires bas√© sur SQL.  Le site officiel est <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://tsqlt.org</a> . <br><br>  Il est promis que tSQLt prend en charge SQL Server √† partir de 2005 SP2.  Je n'ai pas v√©rifi√© ces r√©visions pr√©coces, mais je ne vois aucun probl√®me avec 2012 sur notre serveur de d√©veloppement et 2017 sur ma machine locale. <br><br>  Open source, licence Apache 2.0, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">disponible sur GitHub</a> .  Comme d'habitude, nous pouvons cr√©er, contribuer, utiliser gratuitement dans des projets commerciaux et, ce qui est plus important, ne pas avoir peur des logiciels espions dans CLR. <br><br><h1>  La m√©canique </h1><br><div style="text-align:center;"><img width="85%" height="85%" src="https://habrastorage.org/webt/1v/kx/wi/1vkxwixwjyna756vsce7uhwqzw0.png"></div><br>  Les cas de test sont des proc√©dures stock√©es.  Ils peuvent √™tre combin√©s en classes de test (suite de tests en terminologie xUnit). <br><br>  Les classes de test ne sont rien d'autre que des sch√©mas DB.  tSQLt n√©cessite de les enregistrer avec la proc√©dure NewTestClass qui ajoute des classes de test √† une table sp√©ciale. <br><br>  Il est possible de d√©terminer une proc√©dure SetUp.  Cette proc√©dure s'ex√©cutera avant chaque ex√©cution de sc√©nario de test s√©par√©. <br><br>  La proc√©dure de d√©montage apr√®s l'ex√©cution du sc√©nario de test n'est pas requise.  Chaque sc√©nario de test avec sa configuration est ex√©cut√© dans une transaction s√©par√©e qui est annul√©e apr√®s la collecte des r√©sultats.  C'est tr√®s pratique mais a des cons√©quences n√©gatives - je les d√©crirai un peu plus tard. <br><br>  Le cadre permet d'ex√©cuter des cas de test un par un, toutes les classes de test en m√™me temps ou m√™me toutes les classes de test enregistr√©es avec une seule commande. <br><br><h1>  Caract√©ristiques et exemples </h1><br>  Ne voulant pas r√©p√©ter le guide officiel, je montrerai les fonctionnalit√©s de tSQLt sur des exemples. <br><br>  <i>Avertissement:</i> <br><br><ul><li>  <i>les exemples sont simplifi√©s</i> </li><li>  <i>le code d'origine n'est pas compl√®tement √† moi - ce sont des cr√©ations plut√¥t collectives</i> </li><li>  <i>l'exemple 2 est fictif par moi afin de d√©montrer plus compl√®tement les fonctionnalit√©s.</i> </li></ul><br><h3>  Exemple # 1: CsvSql </h3><br>  Ce qui suit a √©t√© mis en ≈ìuvre √† la demande de l'un des clients du client.  Il existe des requ√™tes SQL stock√©es dans les champs Nvarchar (MAX).  L'interface utilisateur minimale est cr√©√©e pour les afficher.  Les jeux de r√©sultats g√©n√©r√©s par ces requ√™tes sont utilis√©s dans le backend pour une composition ult√©rieure sous forme de fichiers CSV.  Les fichiers CSV peuvent √™tre demand√©s par un appel API. <br><br><div style="text-align:center;"><img width="75%" height="75%" src="https://habrastorage.org/webt/5q/mu/oy/5qmuoyyjjvlphk79jt-xtawwjn8.png"></div><br>  Les jeux de r√©sultats sont volumineux et contiennent un grand nombre de colonnes.  Un exemple hypoth√©tique d'un tel ensemble de r√©sultats: <br><br><div style="text-align:center;"><img width="75%" height="75%" src="https://habrastorage.org/webt/dg/50/bb/dg50bbx25qaw6ycwpfqcsfj5kyk.png"></div><br>  Cet ensemble de r√©sultats repr√©sente les donn√©es des essais cliniques.  Examinons de plus pr√®s le calcul [ClinicsNum].  Nous avons 2 tableaux: [Trial] et [Clinic]. <br><br><div style="text-align:center;"><img width="85%" height="85%" src="https://habrastorage.org/webt/qo/mu/n-/qomun-gdbdl05teniypbtzi8jio.png"></div><br>  Il existe un FK: [Clinic]. [TrialID] -&gt; [Trial]. [TrialID].  De toute √©vidence, il suffit d'utiliser COUNT (*) pour d√©river un certain nombre de cliniques: <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(*), ...  <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dbo.Trial  <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> dbo.Clinic    <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> Trial.ID = Clinic.TrialID  <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> Trial.Name = @trialName  <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> ...</code> </pre> <br>  Comment tester une telle requ√™te?  Tout d'abord, utilisons stub FakeTable, ce qui rendra notre travail beaucoup plus facile. <br><br><pre> <code class="plaintext hljs">EXEC tSQLt.FakeTable 'dbo.Trial'; EXEC tSQLt.FakeTable 'dbo.Clinic';</code> </pre> <br>  FakeTable fait une chose simple - renomme les anciennes tables et en cr√©e de nouvelles avec le m√™me nom.  Les m√™mes noms, les m√™mes colonnes, mais sans contraintes ni d√©clencheurs. <br><br>  Nous en avons besoin parce que: <br><br><ol><li>  La base de donn√©es de test peut contenir certaines donn√©es qui peuvent emp√™cher l'ex√©cution correcte du test.  FakeTable nous permet de ne pas d√©pendre d'eux. </li><li>  Habituellement, nous devons remplir seulement quelques colonnes aux fins du test.  La table peut en contenir beaucoup, contenant souvent des contraintes et des d√©clencheurs.  Nous facilitons l'insertion des donn√©es plus tard - nous n'ins√©rerons que les informations requises pour le test, en gardant le test aussi minimaliste que possible. </li><li>  Il n'y aura pas de d√©clenchements ind√©sirables, nous n'avons donc pas √† nous soucier des post-effets. </li></ol><br>  Ensuite, nous ins√©rons les donn√©es de test requises: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> dbo.Trial ([<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>], [<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>,   <span class="hljs-string"><span class="hljs-string">'Valerian'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> dbo.Clinic ([<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>], [TrialID], [<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>,   <span class="hljs-number"><span class="hljs-number">1</span></span>,        <span class="hljs-string"><span class="hljs-string">'Clinic1'</span></span>), (<span class="hljs-number"><span class="hljs-number">2</span></span>,   <span class="hljs-number"><span class="hljs-number">1</span></span>,        <span class="hljs-string"><span class="hljs-string">'Clinic2'</span></span>);</code> </pre> <br>  Nous d√©rivons la requ√™te de la base de donn√©es, cr√©ons une table [r√©elle] et la remplissons avec le r√©sultat <br>  d√©fini √† partir de la requ√™te. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @sqlStatement <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) = (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span>‚Ä¶ <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> actual ([TrialID], ...); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> actual EXEC sp_executesql @sqlStatement, ...</code> </pre> <br>  Maintenant, nous remplissons [Attendu] - nos valeurs attendues: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> expected (   ClinicsNum <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> expected <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span></code> </pre> <br>  Je veux attirer votre attention sur le fait que nous n'avons qu'une seule colonne dans le tableau [Expected], bien que nous ayons l'ensemble complet dans la colonne [Actual]. <br><br><div style="text-align:center;"><img width="80%" height="80%" src="https://habrastorage.org/webt/qd/gx/ga/qdgxgaqr4cjp2eayoz0eycjs8cg.png"></div><br>  Cela est d√ª √† une caract√©ristique utile de la proc√©dure AssertEqualsTable que nous utiliserons pour la v√©rification des valeurs. <br><br><pre> <code class="sql hljs">EXEC tSQLt.AssertEqualsTable   'expected',   'actual',   'incorrect number of clinics';</code> </pre> <br>  Il compare uniquement les colonnes qui sont pr√©sent√©es dans les deux tableaux.  C'est tr√®s pratique dans notre cas car la requ√™te en cours de test retourne beaucoup de colonnes, chacune connect√©e √† une logique assez compliqu√©e.  Nous ne voulons pas gonfler les cas de test, donc cette fonctionnalit√© aide vraiment.  Bien s√ªr, cette fonctionnalit√© est une √©p√©e √† double tranchant.  Si [R√©el] est rempli via SELECT TOP 0 et √† un moment donn√© une colonne inattendue appara√Æt, un tel cas de test ne le d√©tectera pas.  Vous devez r√©diger des ch√®ques suppl√©mentaires pour couvrir cela. <br><br><h3>  Proc√©dures jumelles AssertEqualsTable </h3><br>  Il convient de mentionner que tSQLt contient 2 proc√©dures comme AssertEqualsTable.  Ce sont AssertEqualsTableSchema et AssertResultSetsHaveSameMetaData.  Le premier fait la m√™me chose que AssertEqualsTable mais sur les m√©tadonn√©es des tables.  Le second fait de m√™me mais sur les m√©tadonn√©es des jeux de r√©sultats. <br><br><h3>  Exemple # 2: Contraintes </h3><br>  L'exemple pr√©c√©dent nous a montr√© comment supprimer les contraintes.  Mais que faire si nous devons les v√©rifier?  Techniquement, les contraintes font √©galement partie de la logique, et elles peuvent √™tre consid√©r√©es comme candidates √† la couverture par des tests. <br><br>  Consid√©rez la situation de l'exemple pr√©c√©dent.  2 tableaux - [Essai] et [Clinique];  [TrialID] FK: <br><br><div style="text-align:center;"><img width="80%" height="80%" src="https://habrastorage.org/webt/-8/zu/v3/-8zuv3clqoo3ygm9wko5hpibc90.png"></div><br>  Essayons d'√©crire un cas de test pour le v√©rifier.  Tout d'abord, comme dans le cas pr√©c√©dent, nous simulons les tables: <br><br><pre> <code class="sql hljs">EXEC tSQLt.FakeTable '[dbo].[Trial]' EXEC tSQLt.FakeTable '[dbo].[Clinic]'</code> </pre> <br>  Le but est le m√™me: √©liminer les limites inutiles.  Nous voulons des ch√®ques isol√©s sans effort indu. <br><br>  Ensuite, nous retournons la contrainte que nous voulons tester en utilisant ApplyConstraint: <br><br><pre> <code class="sql hljs">EXEC tSQLt.ApplyConstraint   '[dbo].[Clinic]',   'Trial_FK';</code> </pre> <br>  Nous avons maintenant une configuration pour le contr√¥le.  La v√©rification elle-m√™me est que la tentative d'insertion de donn√©es provoquera une exception.  Pour que le sc√©nario de test r√©ussisse, nous devons intercepter cette exception.  Le gestionnaire d'exceptions ExpectException peut vous aider. <br><br><pre> <code class="sql hljs">EXEC tSQLt.ExpectException   @ExpectedMessage = 'The <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">statement</span></span> conflicted...<span class="hljs-string"><span class="hljs-string">',   @ExpectedSeverity = 16,   @ExpectedState = 0;</span></span></code> </pre> <br>  Nous pouvons essayer d'ins√©rer non ins√©rable apr√®s le param√®tre du gestionnaire. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> [dbo].[Clinic] ([TrialID])   <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre> <br>  L'exception a √©t√© intercept√©e.  Test r√©ussi. <br><br><h3>  Proc√©dures jumelles ApplyConstraint </h3><br>  La mani√®re de tester les d√©clencheurs propos√©e par les auteurs de tSQLt est similaire √† celle des contraintes de test.  Nous pouvons utiliser la proc√©dure ApplyTrigger pour retourner le d√©clencheur √† la table.  Apr√®s cela, tout se passe comme dans l'exemple ci-dessus - d√©marrez le d√©clencheur, v√©rifiez le r√©sultat. <br><br><h3>  ExpectNoException - l'Antonyme d'ExpectException </h3><br>  Il existe une proc√©dure ExpectNoException pour les cas o√π aucune exception ne doit se produire.  Il fonctionne de la m√™me mani√®re que ExpectException, sauf que le test √©choue en cas d'exception. <br><br><h3>  Exemple # 3: s√©maphore </h3><br>  Il existe des proc√©dures stock√©es et des services Windows.  Le d√©but de leur ex√©cution peut √™tre provoqu√© par diff√©rents √©v√©nements ext√©rieurs.  Cependant, l'ordre de leur ex√©cution est fixe.  Il est donc n√©cessaire d'impl√©menter le contr√¥le d'acc√®s du c√¥t√© DB - c'est-√†-dire un s√©maphore.  Dans notre cas, le s√©maphore est un groupe de proc√©dures stock√©es fonctionnant ensemble. <br><br>  Regardons une proc√©dure dans le s√©maphore.  Nous avons 2 tableaux - [Process] et [ProcStatus]: <br><br><div style="text-align:center;"><img width="80%" height="80%" src="https://habrastorage.org/webt/-m/hz/8-/-mhz8-fm_n1w7njpryiv8z3epiw.png"></div><br>  La table [Processus] contient une liste des processus autoris√©s √† √™tre ex√©cut√©s.  [ProcStatus], √©videmment, contient la liste des statuts du processus du tableau pr√©c√©dent. <br><br>  Alors, que fait notre proc√©dure?  Tout d'abord, il effectue les v√©rifications suivantes: <br><br><ol><li>  Nous avons pass√© un nom de processus comme l'un des param√®tres d'entr√©e de la proc√©dure.  Ce nom est recherch√© dans le champ [Nom] de la table [Processus]. </li><li>  Si le nom du processus a √©t√© trouv√©, il v√©rifie l'indicateur [IsRunable] de la table [Process]. </li><li>  Si l'indicateur est activ√©, nous consid√©rons que le processus peut s'ex√©cuter.  La derni√®re v√©rification a lieu dans la table [ProcStatus].  Nous devons nous assurer que le processus n'est pas actuellement ex√©cut√©, ce qui signifie l'absence d'enregistrements sur le processus avec le statut "InProg" dans la table [ProcStatus]. </li></ol><br>  Si tout va bien et que toutes les v√©rifications sont r√©ussies, nous ajoutons un nouvel enregistrement sur notre processus dans la table [ProcStatus] avec le statut "InProg".  L'ID de ce nouvel enregistrement est retourn√© avec le param√®tre de sortie ProcStatusId. <br><br>  En cas de probl√®me, nous nous attendons √† ce qui suit: <br><br><ol><li>  Un e-mail √† un administrateur syst√®me est envoy√©. </li><li>  ProcStatusId = -1 est retourn√©. </li><li>  Aucun nouvel enregistrement [ProcStatus] ajout√©. </li></ol><br>  Cr√©ons un cas de test pour v√©rifier le cas d'absence de processus dans la table [Processus]. <br><br>  Nous utilisons √† nouveau FakeTable.  Ce n'est pas si critique ici, mais cela peut √™tre pratique car: <br><br><ol><li>  Il est garanti qu'aucune donn√©e ne pourra perturber l'ex√©cution du sc√©nario de test. </li><li>  La v√©rification suppl√©mentaire de l'absence de nouveaux enregistrements [ProcStatus] sera simplifi√©e. </li></ol><br><pre> <code class="sql hljs">EXEC tSQLt.FakeTable 'dbo.Process'; EXEC tSQLt.FakeTable 'dbo.ProcStatus';</code> </pre> <br>  Il existe une proc√©dure [SendEmail] dont le nom parle de lui-m√™me.  Nous devons saisir son appel.  tSQLt sugg√®re d'utiliser la simulation SpyProcedure pour cela. <br><br><pre> <code class="plaintext hljs">EXEC tSQLt.SpyProcedure 'dbo.SendEmail'</code> </pre> <br>  SpyProcedure effectue les op√©rations suivantes: <br><br><ol><li>  Cr√©e une table avec un nom qui ressemble √† [dbo]. [ProcedureName_SpyProcedureLog] </li><li>  Tout comme FakeTable, remplace la proc√©dure d'origine par une proc√©dure g√©n√©r√©e automatiquement, avec le m√™me nom, mais avec une logique de journalisation √† l'int√©rieur.  Vous pouvez √©galement ajouter votre propre logique √† la proc√©dure g√©n√©r√©e si n√©cessaire. </li></ol><br>  Il n'est pas difficile de deviner que les journaux sont enregistr√©s dans la table [dbo]. [SendEmail_SpyProcedureLog].  Ce tableau contient une colonne [_ID_] qui correspond aux num√©ros de s√©quence des appels.  Les colonnes suivantes sont nomm√©es d'apr√®s les param√®tres pass√©s √† la proc√©dure et utilis√©es pour les collecter, de sorte que les valeurs des param√®tres peuvent √©galement √™tre v√©rifi√©es. <br><br><div style="text-align:center;"><img width="75%" height="75%" src="https://habrastorage.org/webt/ko/gh/4h/kogh4hgcdsxagldk2bmdcfrptzi.png"></div><br>  La derni√®re chose que nous devons faire avant l'appel du s√©maphore est de cr√©er une variable pour stocker la valeur [ProcStatusId] (pour √™tre plus exact, -1, car l'enregistrement ne sera pas ajout√©). <br><br><pre> <code class="plaintext hljs">DECLARE @ProcStatusId BIGINT;</code> </pre> <br>  Nous appelons le s√©maphore: <br><br><pre> <code class="plaintext hljs">EXEC dbo.[Semaphore_JobStarter]   'SomeProcess',   @ProcStatusId OUTPUT; -- here we get -1</code> </pre> <br>  Nous avons maintenant toutes les donn√©es n√©cessaires pour les contr√¥les.  Commen√ßons par v√©rifier <br>  que le message a bien √©t√© envoy√©. <br><br><pre> <code class="plaintext hljs">IF NOT EXISTS (   SELECT *   FROM dbo.SendEmail_SpyProcedureLog) EXEC tSQLt.Fail 'SendEmail has not been run.';</code> </pre> <br>  Dans ce cas, nous ne v√©rifions pas les param√®tres pass√©s et testons le fait d'envoyer uniquement.  Je souhaite attirer votre attention sur la proc√©dure d'√©chec.  Cela nous permet d'√©chouer ¬´officiellement¬ª un cas de test.  Si vous avez besoin de construire une construction sophistiqu√©e, Fail peut vous aider. <br><br>  Nous v√©rifions maintenant l'absence d'enregistrements dans la table [ProcStatus] avec la proc√©dure AssertEmptyTable. <br><br><pre> <code class="plaintext hljs">EXEC tSQLt.AssertEmptyTable 'dbo.ProcStatus';</code> </pre> <br>  C'est l√† que FakeTable que nous avons utilis√© au d√©but nous a aid√©s.  Avec cela, nous pouvons nous attendre √† une table vide et tester en utilisant une seule ligne de code.  La bonne fa√ßon de v√©rifier cela sans falsification de table serait de comparer le nombre de lignes avant et apr√®s l'ex√©cution de la proc√©dure, ce qui n√©cessiterait plus d'actions. <br><br>  Nous pouvons facilement v√©rifier l'√©galit√© ProcStatusId = -1 avec AssertEquals. <br><br><pre> <code class="sql hljs">EXEC tSQLt.AssertEquals   -1,       @ProcStatusId,       'Wrong ProcStatusId.';</code> </pre> <br>  AssertEquals est minimaliste.  Il compare juste 2 valeurs, rien d'extraordinaire. <br><br><h3>  Proc√©dures jumelles AssertEquals </h3><br>  Nous avons les proc√©dures suivantes pour la comparaison des valeurs: <br><br><ul><li>  AssertEquals </li><li>  AssertNotEquals </li><li>  AssertEqualsString </li><li>  Assertike </li></ul><br>  Je pense que les noms sont explicites.  La seule proc√©dure que je veux souligner est AssertEqualsString.  C'est la proc√©dure d√©di√©e √† la v√©rification des valeurs de cha√Æne.  Pourquoi avons-nous besoin d'une proc√©dure de plus, compte tenu des AssertEquals universels donn√©s?  Le probl√®me est que AssertEquals / AssertNotEquals / AssertLike fonctionne avec le type SQL_VARIANT.  NVARCHAR (MAX) n'est pas inclus dans SQL_VARIANT, les d√©veloppeurs tSQLt ont donc d√ª effectuer une proc√©dure suppl√©mentaire. <br><br><h3>  Fausse fonction </h3><br>  Sur simple pression, nous pouvons appeler FakeFunction une proc√©dure similaire √† SpyProcedure.  Ce faux permet de remplacer n'importe quelle fonction par une plus simple.  Comme les fonctions SQL Server fonctionnent comme un tube de dentifrice (le r√©sultat est renvoy√© par le seul ¬´trou¬ª), il est techniquement impossible d'impl√©menter une fonctionnalit√© de journalisation.  Le remplacement de la logique interne est le seul moyen disponible. <br><br><h1>  Pi√®ges </h1><br>  Je veux vous parler de certains pi√®ges auxquels vous pouvez faire face lors de l'utilisation de tSQLt.  Dans ce cas, les ¬´pi√®ges¬ª signifient certains probl√®mes qui sont caus√©s par des restrictions SQL Server et / ou qui sont impossibles √† r√©soudre par les d√©veloppeurs de framework. <br><br><h3>  Annulation et annulation de transactions </h3><br>  Le premier et le principal probl√®me rencontr√© par notre √©quipe est le retour en arri√®re et la condamnation des transactions.  SQL Server ne peut pas restaurer la transaction imbriqu√©e s√©par√©ment.  Il annule toujours toutes les transactions jusqu'√† l'extr√™me.  √âtant donn√© que tSQLt encapsule chaque test dans une transaction distincte, cela peut devenir un probl√®me car la restauration dans une proc√©dure stock√©e peut interrompre un test avec une erreur d'ex√©cution non descriptive. <br><br>  Pour contourner ce probl√®me, nous utilisons des points de sauvegarde.  L'id√©e est simple.  Au d√©but, nous v√©rifions si nous sommes dans une transaction ou non.  Si oui, nous supposons que c'est une transaction tSQLt et mettons un point de sauvegarde, nous allons donc y revenir si n√©cessaire.  Si non, nous commen√ßons une nouvelle transaction.  En fait, nous n'autorisons pas l'imbrication. <br><br><div style="text-align:center;"><img width="85%" height="85%" src="https://habrastorage.org/webt/bu/ih/vl/buihvlf1ffnwuzbotecbqtev09o.png"></div><br>  Le probl√®me est compliqu√© par le transfert de transaction - il peut se produire si une exception a √©t√© lev√©e.  Une transaction vou√©e √† l'√©chec ne peut pas √™tre valid√©e ni annul√©e dans un point de sauvegarde, nous devons donc la restaurer √† nouveau jusqu'√† la transaction la plus externe. <br><br>  Compte tenu des points d√©crits ci-dessus, nous devons utiliser la structure suivante: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @isNestedTransaction <span class="hljs-built_in"><span class="hljs-built_in">BIT</span></span> =   <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> @@trancount &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'true'</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-string"><span class="hljs-string">'false'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> TRY   <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @isNestedTransaction = <span class="hljs-string"><span class="hljs-string">'false'</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">SAVE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span> SavepointName;       <span class="hljs-comment"><span class="hljs-comment">-- something useful   IF @isNestedTransaction = 'false'   COMMIT TRANSACTION; END TRY BEGIN CATCH   DECLARE @isCommitable BIT =       CASE WHEN XACT_STATE() = 1           THEN 'true'           ELSE 'false'   END;   IF @isCommitable = 'true' AND @isNestedTransaction = 'true'       ROLLBACK TRANSACTION SavepointName;   ELSE       ROLLBACK;   THROW; END CATCH;</span></span></code> </pre> <br>  Passons en revue le code morceau par morceau.  Tout d'abord, nous devons d√©terminer si nous sommes dans une transaction ou non. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @isNestedTransaction <span class="hljs-built_in"><span class="hljs-built_in">BIT</span></span> =   <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> @@trancount &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'true'</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-string"><span class="hljs-string">'false'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>;</code> </pre> <br>  Apr√®s avoir d√©riv√© l'indicateur @isNestedTransaction, nous pouvons d√©marrer le bloc TRY et d√©finir un point de sauvegarde ou d√©marrer une transaction en fonction de la situation. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> TRY   <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @isNestedTransaction = <span class="hljs-string"><span class="hljs-string">'false'</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">SAVE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span> SavepointName;       <span class="hljs-comment"><span class="hljs-comment">-- something useful</span></span></code> </pre> <br>  Apr√®s avoir fait quelque chose d'utile, nous validons les r√©sultats s'il s'agit d'une "vraie" ex√©cution de proc√©dure. <br><br><pre> <code class="sql hljs">       <span class="hljs-comment"><span class="hljs-comment">-- something useful   IF @isNestedTransaction = 'false'   COMMIT TRANSACTION; END TRY</span></span></code> </pre> <br>  Bien s√ªr, s'il s'agit d'un sc√©nario de test, nous n'avons besoin de rien engager.  tSQLt annulera automatiquement les modifications √† la fin. <br><br>  Si quelque chose a mal tourn√© et que nous entrons dans le bloc CATCH, nous devons d√©terminer si la transaction est validable ou non. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> CATCH   <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @isCommitable <span class="hljs-built_in"><span class="hljs-built_in">BIT</span></span> =       <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> XACT_STATE() = <span class="hljs-number"><span class="hljs-number">1</span></span>           <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'true'</span></span>           <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-string"><span class="hljs-string">'false'</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>;</code> </pre> <br>  Nous ne pouvons revenir au point de sauvegarde que si: <br><br><ol><li>  La transaction est engageable </li><li>  C'est un test, donc, le point de sauvegarde existe. </li></ol><br>  Dans tous les autres cas, nous devons annuler l'ensemble de la transaction. <br><br><pre> <code class="sql hljs">   IF @isCommitable = 'true' AND @isNestedTransaction = 'true'       <span class="hljs-keyword"><span class="hljs-keyword">ROLLBACK</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span> SavepointName;   ELSE       <span class="hljs-keyword"><span class="hljs-keyword">ROLLBACK</span></span>;   THROW; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> CATCH;</code> </pre> <br>  Oui, malheureusement, si nous avons atteint un √©tat de transaction non validable lors d'un test, nous obtenons toujours l'erreur d'ex√©cution. <br><br><h3>  Faketable et la question des cl√©s √©trang√®res </h3><br>  Passons en revue les tableaux familiers [Essai] et [Clinique] <br><br><div style="text-align:center;"><img width="85%" height="85%" src="https://habrastorage.org/webt/fy/k7/nm/fyk7nmhfha_fnezignyxclpflay.png"></div><br>  Nous nous souvenons de [TrialID] FK.  Quel probl√®me peut-il causer?  Dans les exemples ci-dessus, nous avons appliqu√© FakeTable sur les deux tables.  Si nous l'utilisons uniquement sur l'un d'entre eux, nous atteindrons la configuration suivante: <br><br><div style="text-align:center;"><img width="85%" height="85%" src="https://habrastorage.org/webt/og/to/3-/ogto3-drjheieblpi1_gsyup4hs.png"></div><br>  Ainsi, une tentative d'insertion d'un dossier dans [Clinic] peut √©chouer m√™me si nous avons pr√©par√© des donn√©es dans la fausse version de [Trial]. <br><br><pre> <code class="sql hljs">[dbo].[Test_FK_Problem] failed: (Error) The <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">statement</span></span> conflicted <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constraint</span></span> <span class="hljs-string"><span class="hljs-string">"Trial_Fk"</span></span>. The conflict occurred <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">database</span></span> <span class="hljs-string"><span class="hljs-string">"HabrDemo"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-string"><span class="hljs-string">"dbo.tSQLt_tempobject_ba8f36353f7a44f6a9176a7d1db02493"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">column</span></span> <span class="hljs-string"><span class="hljs-string">'TrialID'</span></span>.[<span class="hljs-number"><span class="hljs-number">16</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>]{Test_FK_Problem,<span class="hljs-number"><span class="hljs-number">14</span></span>}</code> </pre> <br>  Conclusion: faux tout ou rien.  Dans le cas contraire, vous devez √©videmment pr√©parer une base de donn√©es avec toutes les donn√©es de test requises. <br><br><h3>  SpyProcedure sur les proc√©dures syst√®me </h3><br>  Malheureusement, nous ne pouvons pas espionner les proc√©dures syst√®me: <br><br><pre> <code class="sql hljs">[HabrDemo].[test_test] failed: (Error) Cannot <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> SpyProcedure <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> sys.sp_help because the <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> does <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> exist[<span class="hljs-number"><span class="hljs-number">16</span></span>,<span class="hljs-number"><span class="hljs-number">10</span></span>] {tSQLt.Private_ValidateProcedureCanBeUsedWithSpyProcedure,<span class="hljs-number"><span class="hljs-number">7</span></span>}</code> </pre> <br>  Dans l'exemple du s√©maphore, nous avons suivi les appels de la proc√©dure [SendEmail], qui a √©t√© cr√©√©e par nos d√©veloppeurs.  Dans ce cas, il n'√©tait pas requis uniquement par les tests.  Il √©tait n√©cessaire de cr√©er une proc√©dure distincte car il est n√©cessaire de pr√©parer certaines donn√©es avant l'envoi.  Mais vous devez √™tre mentalement pr√™t √† √©crire une proc√©dure intercouche afin de r√©pondre aux objectifs de test. <br><br><h1>  Avantages </h1><br><h3>  Installation rapide </h3><br>  L'installation de tSQLt se compose de 2 √©tapes et dure environ 2 minutes.  Vous devez activer CLR s'il n'est pas actuellement actif et ex√©cuter un seul script SQL.  C'est tout: vous pouvez maintenant ajouter votre premi√®re classe de test et √©crire des cas de test. <br><br><h3>  Apprentissage rapide </h3><br>  tSQLt est facile √† apprendre.  Cela m'a pris un peu plus d'une journ√©e de travail.  J'ai demand√© √† mes coll√®gues et cela semble prendre environ 1 journ√©e de travail pour les autres aussi.  Je doute que cela puisse prendre beaucoup plus de temps. <br><br><h3>  Int√©gration CI rapide </h3><br>  Il a fallu environ 2 heures pour configurer l'int√©gration CI sur notre projet.  Le temps peut varier, bien s√ªr, mais ce n'est pas un probl√®me en g√©n√©ral, et cela peut se faire rapidement. <br><br><h3>  Un large √©ventail d'instruments </h3><br>  C'est subjectif, mais √† mon avis, la fonctionnalit√© tSQLt est riche et la part du lion des besoins peut √™tre couverte par elle.  Si cela ne suffit pas, vous pouvez toujours utiliser la proc√©dure d'√©chec pour les cas rares et sophistiqu√©s. <br><br><h3>  Documentation pratique </h3><br>  Les guides officiels sont pratiques et coh√©rents.  Vous pouvez facilement comprendre l'utilisation de tSQLt en peu de temps, m√™me s'il s'agit de votre premier outil de test unitaire. <br><br><h3>  Sortie claire </h3><br>  La sortie du test peut √™tre prise dans un format texte illustratif: <br><br><pre> <code class="plaintext hljs">[tSQLtDemo].[test_error_messages] failed: (Failure) Expected an error to be raised. [tSQLtDemo].[test_tables_comparison] failed: (Failure) useful and descriptive error message Unexpected/missing resultset rows! |_m_|Column1|Column2| +---+-------+-------+ |&lt; |2 |Value2 | |= |1 |Value1 | |= |3 |Value3 | |&gt; |2 |Value3 | +----------------------+ |Test Execution Summary| +----------------------+ |No|Test Case Name |Dur(ms)|Result | +--+------------------------------------+-------+-------+ |1 |[tSQLtDemo].[test_constraint] | 83|Success| |2 |[tSQLtDemo].[test_trial_view] | 83|Success| |3 |[tSQLtDemo].[test_error_messages] | 127|Failure| |4 |[tSQLtDemo].[test_tables_comparison]| 147|Failure| ----------------------------------------------------------------------------- Msg 50000, Level 16, State 10, Line 1 Test Case Summary: 4 test case(s) executed, 2 succeeded, 2 failed, 0 errored. -----------------------------------------------------------------------------</code> </pre><br>  Il peut √©galement √™tre d√©riv√© de la base de donn√©es (cliquable) ... <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/webt/-f/83/la/-f83lajcz1mfcnkhtttz45b0x3g.png"></a> </div><br>  ... ou m√™me en XML. <br><br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">testsuites</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">testsuite</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tSQLtDemo"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">tests</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"3"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">errors</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">failures</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">timestamp</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2019-06-22T16:46:06"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">time</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0.433"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">hostname</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"BLAHBLAHBLAH\SQL2017"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">package</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tSQLt"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">properties</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">testcase</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">classname</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tSQLtDemo"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"test_constraint"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">time</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0.097"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">testcase</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">classname</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tSQLtDemo"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"test_error_messages"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">time</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0.153"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">failure</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">message</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Expected an error to be raised."</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tSQLt.Fail"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">testcase</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">testcase</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">classname</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tSQLtDemo"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"test_trial_view"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">time</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0.156"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system-out</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system-err</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">testsuite</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">testsuites</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Le dernier format permet l'int√©gration CI sans aucun probl√®me.  Plus pr√©cis√©ment, nous utilisons tSQLt avec Atlassian Bamboo. <br><br><h3>  Prise en charge de Redgate </h3><br>  En tant que l'un des pros, je peux nommer le support de l'un des plus grands fournisseurs d'outils DBA - RedGate.  Leur plug-in SQL Server Management Studio nomm√© SQL Test fonctionne avec tSQLt depuis le d√©but.  De plus, RedGate aide le d√©veloppeur principal de tSQLt avec dev-environment, selon ses mots dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">les groupes Google</a> . <br><br><h1>  Inconv√©nients </h1><br><h3>  Pas de simulation de tables temporaires </h3><br>  tSQLt ne permet pas de truquer des tables temporaires.  R√©flexions, en cas de n√©cessit√©, vous pouvez utiliser un addon non officiel.  Malheureusement, cet addon fonctionne uniquement avec SQL Server 2016+. <br><br><h3>  Travailler avec des bases de donn√©es externes </h3><br>  tSQLt est con√ßu pour fonctionner avec le code dans la m√™me base de donn√©es dans laquelle le framework est install√©.  Ainsi, il peut √™tre impossible de l'utiliser avec une base de donn√©es externe.  Au moins, les contrefa√ßons ne fonctionneront pas. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> [tSQLtDemo].[test_outer_db] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP <span class="hljs-number"><span class="hljs-number">10</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [AdventureWorks2017].[Person].[<span class="hljs-keyword"><span class="hljs-keyword">Password</span></span>]   EXEC tSQLt.FakeTable <span class="hljs-string"><span class="hljs-string">'[AdventureWorks2017].[Person].[Password]'</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP <span class="hljs-number"><span class="hljs-number">10</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [AdventureWorks2017].[Person].[<span class="hljs-keyword"><span class="hljs-keyword">Password</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">END</span></span></code> </pre><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ga/au/ny/gaaunygdr124sssxhonbb2s0b_0.png"></div><br>  Il semble que les assertions fonctionnent, mais leur ouvrabilit√© n'est pas garantie, bien s√ªr. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> [tSQLtDemo].[test_outer_db_assertions] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP <span class="hljs-number"><span class="hljs-number">1</span></span> *   <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-comment"><span class="hljs-comment">#Actual   FROM [AdventureWorks2017].[Person].[Password]   SELECT *   INTO #Expected   FROM (          SELECT 'bE3XiWw=' AS [PasswordSalt]   ) expectedresult;   EXEC tSQLt.AssertEqualsTable '#Expected', '#Actual', 'The salt is not salty'; END</span></span></code> </pre> <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/cg/dk/ow/cgdkowych69imevqmbirkkgsniq.png"></div><br><h3>  Bogues de documentation </h3><br>  M√™me si j'ai mentionn√© ci-dessus que les guides sont pratiques et coh√©rents, la documentation pr√©sente certains probl√®mes.  Il contient des parties obsol√®tes. <br><br>  Exemple 1. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">¬´Guide de d√©marrage rapide¬ª</a> sugg√®re de t√©l√©charger le framework depuis SourceForge. <br>  Ils ont quitt√© SourceForge <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">jusqu'en 2015</a> . <br><br>  Exemple 2. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Le guide ApplyConstraint</a> utilise une conception volumineuse avec la proc√©dure Fail dans un exemple de capture d'exception.  Cela peut √™tre remplac√© par du code simple et clair √† l'aide d'ExpectException. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> ConstraintTests.[<span class="hljs-keyword"><span class="hljs-keyword">test</span></span> ReferencingTable_ReferencedTable_FK prevents <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> orphaned <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> EXEC tSQLt.FakeTable <span class="hljs-string"><span class="hljs-string">'dbo.ReferencedTable'</span></span>; EXEC tSQLt.FakeTable 'dbo.ReferencingTable'; EXEC tSQLt.ApplyConstraint 'dbo.ReferencingTable','ReferencingTable_ReferencedTable_FK'; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @ErrorMessage <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @ErrorMessage = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* [NB] Why don't we use ExceptException below? */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> TRY <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> dbo.ReferencingTable ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, ReferencedTableId ) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> ( <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">11</span></span> ) ; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> TRY <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> CATCH <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @ErrorMessage = ERROR_MESSAGE(); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> CATCH <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @ErrorMessage <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIKE</span></span> <span class="hljs-string"><span class="hljs-string">'%ReferencingTable_ReferencedTable_FK%'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> EXEC tSQLt.Fail <span class="hljs-string"><span class="hljs-string">'Expected error message containing ''ReferencingTable_ReferencedTable_FK'' but got: '''</span></span>,@ErrorMessage,<span class="hljs-string"><span class="hljs-string">'''!'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre><br>  Et cela est attendu, √† cause de ... <br><br><h3>  Abandon partiel </h3><br>  Il y a eu une pause prolong√©e dans le d√©veloppement du d√©but de 2016 √† juin 2019. Oui, malheureusement, cet outil est partiellement abandonn√©.  Le d√©veloppement a lentement commenc√© en 2019, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">selon GitHub</a> .  Bien que les groupes Google officiels <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">aient un fil de discussion</a> o√π Sebastian, le principal d√©veloppeur de tSQLt, a √©t√© interrog√© sur l'avenir du projet.  La derni√®re question a √©t√© pos√©e le 2 mars 2019, sans r√©ponse. <br><br><h3>  Probl√®me avec SQL Server 2017 </h3><br>  L'installation de tSQLt peut n√©cessiter des actions suppl√©mentaires si vous utilisez SQL Server 2017. Microsoft a impl√©ment√© la premi√®re modification de s√©curit√© depuis 2012 dans cette version.  Un indicateur de niveau serveur "CLR strict security" a √©t√© ajout√©.  Ce drapeau interdit la cr√©ation d'assemblages non sign√©s (m√™me SAFE).  Une description d√©taill√©e m√©rite un article s√©par√© (et, heureusement, nous en avons <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">d√©j√†</a> un bon; voir √©galement les articles suivants dans la s√©quence. Soyez juste pr√©par√© mentalement pour cela. <br><br>  Bien s√ªr, je pourrais attribuer ce probl√®me aux "pi√®ges", mais ce probl√®me peut √™tre r√©solu par les d√©veloppeurs de tSQLt.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Le probl√®me GitHub a d√©j√† √©t√© soulev√©</a> .  Pourtant, il n'a pas √©t√© r√©solu depuis octobre 2017. <br><br><h1>  Alternatives (¬±) pour d'autres SGBD </h1><br>  tSQLt n'est pas unique en son genre.  Bien que vous ne puissiez pas l'utiliser dans d'autres SGBD en raison des nuances CLR et T-SQL, vous pouvez toujours trouver quelque chose de similaire.  Il convient de mentionner que ces alternatives ne sont pas tr√®s proches de tSQLt, donc je veux dire une approche bas√©e sur SQL. <br><br>  Par exemple, les utilisateurs de PostgreSQL peuvent essayer <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pgTAP</a> .  Il s'agit d'un outil bien d√©velopp√© et en d√©veloppement actif utilisant PL / pgSQL natif pour les tests et le format de sortie TAP.  L'outil similaire <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">MyTap</a> peut vous aider avec des tests sous MySQL.  Ce framework est un peu moins fonctionnel que pgTAP mais peut toujours √™tre utile.  Et c'est aussi en d√©veloppement actif.  Si vous √™tes un utilisateur Oracle heureux, vous avez la possibilit√© d'utiliser l'outil tr√®s puissant <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">utPLSQL</a> .  Il se d√©veloppe tr√®s activement et offre un grand nombre de fonctionnalit√©s. <br><br><h1>  Conclusion </h1><br>  Je voulais transmettre 2 id√©es: <br><br>  Le premier: l'utilit√© des tests de code DB.  Ce n'est pas important si vous utilisez SQL Server, Oracle, MySQL ou autre chose.  Si votre base de donn√©es contient une logique non test√©e, vous prenez des risques.  Comme tous les autres bogues de tout autre code, les bogues de code DB peuvent endommager le produit et la soci√©t√© qui le fournit. <br><br>  Le second: le choix de l'outil.  Pour ceux qui travaillent avec SQL Server, tSQLt, m√™me s'il n'est pas gagnant √† 100%, m√©rite certainement l'attention.  Malgr√© un d√©veloppement lent et certains probl√®mes, c'est toujours un cadre pratique qui pourrait rendre votre travail beaucoup plus facile. <br><br><div class="spoiler">  <b class="spoiler_title">Sources qui m'ont aid√© (liste non exhaustive)</b> <div class="spoiler_text">  DbFit - Test automatis√© de base de donn√©es Open Source: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">http://www.methodsandtools.com/tools/dbfit.php</a> <br><br>  Documentation DbFit: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://dbfit.github.io/dbfit/docs/</a> <br><br>  Wiki Slacker: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://github.com/vassilvk/slacker/wiki</a> <br><br>  Documentation TST: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://archive.codeplex.com/projects/TST/4e04e281-9f35-4891-809a-15f09d304f4e</a> <br><br>  Assertions NUnit: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://github.com/nunit/docs/wiki/Assertions</a> <br><br>  code utTSQL: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://sourceforge.net/p/uttsql/code/HEAD/tree/</a> <br><br>  Assert de classe Junit: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://junit.org/junit4/javadoc/latest/org/junit/Assert.html</a> <br><br>  pgTap: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://pgtap.org/</a> <br><br>  utPLSQL: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">http://utplsql.org/</a> <br><br>  MyTap: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://github.com/hepabolu/mytap</a> <br><br>  Groupes Google tSQLt: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://groups.google.com/forum/#!forum/tsqlt</a> <br><br>  Site officiel de tSQLt: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://tsqlt.org/</a> <br><br>  tSQLt GitHub: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://github.com/tSQLt-org/tSQLt</a> <br><br>  Tendances Google: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://bit.ly/2x7BQL6</a> <br><br>  Comment ROLLBACK une transaction lors d'un test √† l'aide de tSQLt: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://stackoverflow.com/questions/8973138/how-to-rollback-a-transaction-when-testing-using-tsqlt</a> <br><br>  Quels sont les avantages et les inconv√©nients des tests unitaires manuels par rapport aux tests unitaires automatis√©s?: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Https://stackoverflow.com/questions/2948337/what-are-the-pros-and-cons-of-manual-unit-testing-against -les-unit√©s-automatis√©es # 2948354</a> <br><br>  Le bon, le mauvais et l'Ugle¬Øe¬Ø: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://sqlquantumleap.com/2017/08/07/sqlclr-vs-sql-server-2017-part-1-clr-strict-security/</a> <br><br>  Rex Black, Erik Van Veenendal, Dorothy Graham, Foundations of Software Testing, troisi√®me √©dition, 2012 Cengage Learning EMEA <br></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr465567/">https://habr.com/ru/post/fr465567/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr465551/index.html">R√©sum√© des √©v√©nements informatiques de septembre (premi√®re partie)</a></li>
<li><a href="../fr465553/index.html">Langage de programmation √ú. Introduction, motivation pour cr√©er, objectifs</a></li>
<li><a href="../fr465555/index.html">12 comp√©tences g√©n√©rales qui rendent les chefs de projet informatiques imparables</a></li>
<li><a href="../fr465557/index.html">D√©lais de d√©veloppement de produits</a></li>
<li><a href="../fr465561/index.html">Ce que j'ai appris d'un grand programmeur</a></li>
<li><a href="../fr465569/index.html">Carte de d√©veloppement des d√©veloppeurs mobiles</a></li>
<li><a href="../fr465571/index.html">Comment vendre des cigarettes aux hommes pour les femmes et prot√©ger les sauvages: des r√©dacteurs qui pourraient</a></li>
<li><a href="../fr465573/index.html">Toute la puissance d'IntelliJ IDEA sur l'exemple d'une langue (en images)</a></li>
<li><a href="../fr465575/index.html">Op√©rations de comparaison en C ++ 20</a></li>
<li><a href="../fr465577/index.html">Nouveaux types de micro-marquage pour les extraits interactifs avanc√©s</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>