<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏠 🈳 🚒 Cara membuat pembungkus Python dan tidak menjadi gila 🤘🏻 🚣🏾 👨🏻‍🏭</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Baru-baru ini saya membaca sebuah artikel tentang Habré tentang alat yang sangat berguna, dan karena saya sudah lama mencari proyek untuk mulai berkon...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Cara membuat pembungkus Python dan tidak menjadi gila</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/467615/"><p> Baru-baru ini saya membaca sebuah artikel tentang Habré tentang alat yang sangat berguna, dan karena saya sudah lama mencari proyek untuk mulai berkontribusi, saya memutuskan untuk melihat apa yang ada di github dan bagaimana saya dapat membantu.  Satu masalah adalah tentang membuat pembungkus (saya akan menggunakan pembungkus nanti) untuk C-library.  Pada saat itu saya berpikir, "Oh, sesuatu yang menarik, saya yakin itu akan memakan waktu tidak lebih dari satu jam."  Betapa saya salah. </p><br><p>  Dalam artikel ini, saya memutuskan untuk menunjukkan bukan satu cara untuk menyelesaikan masalah yang sama, tetapi beberapa opsi berbeda.  Saya akan menunjukkan kepada Anda opsi untuk membuat modul dalam Python dengan kompilasi dalam C, menggunakan pustaka tulisan-sendiri C kecil di Python, dan - opsi terakhir - menggunakan pustaka C besar di Python tanpa file-file pxd yang sakit. </p><a name="habracut"></a><br><h1 id="cython">  Cython </h1><br><p>  Buku telah ditulis tentang ini, ada banyak artikel, termasuk di Habré, jadi saya tidak akan terlalu fokus pada instalasi atau beberapa hal mendasar.  Baca lebih lanjut <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">di sini</a> </p><br><p>  Dengan menggunakan Cython, kita dapat memecahkan beberapa masalah.  Untuk beberapa contoh kode C dalam python, biasanya cocok dan sebagian menyelesaikan masalah dengan impor perpustakaan. </p><br><p>  Mari kita lihat contoh sederhana dari dokumentasi resmi. </p><br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> __future__ <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> print_function <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fib</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""Print the Fibonacci series up to n."""</span></span> a, b = <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> b &lt; n: print(b, end=<span class="hljs-string"><span class="hljs-string">' '</span></span>) a, b = b, a + b print()</code> </pre> <br><p>  Simpan file ini sebagai <code>fib.pyx</code> . <br>  <em>.pyx</em> adalah format khusus file Cython, yang mirip dengan <em>.c</em> untuk kode C dan berisi beberapa fungsi.  Ada juga <em>.pxd</em> , di C adalah <em>.h</em> dan berisi deskripsi fungsi, struktur, dll. </p><br><p>  Untuk berinteraksi dengan fungsi fib, kita perlu "mengkompilasi" kode tersebut.  Untuk melakukan ini, buat <code>setup.py</code> dengan konten ini. </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> distutils.core <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> setup <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> Cython.Build <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> cythonize setup( ext_modules=cythonize(<span class="hljs-string"><span class="hljs-string">"fib.pyx"</span></span>), )</code> </pre> <br><p>  Setelah menjalankan perintah <code>python3 setup.py build_ext --inplace</code> Anda dapat mengimpornya dengan python biasa dan menikmati kecepatan kerja seperti pada <del>  normal </del>  bahasa yang dikompilasi. </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> fib fib.fib(<span class="hljs-number"><span class="hljs-number">2000</span></span>)</code> </pre> <br><p>  Tapi di sini kita menulis kode Python dan mengubahnya menjadi C, tetapi bagaimana dengan menulis kode C dan menjalankannya dengan Python? </p><br><p>  Tidak masalah  Kami membuat folder baru, di dalam kami membuat folder <code>lib</code> di mana kami akan membuat <code>lib/include</code> dan <code>lib/src</code> , pada kenyataannya, semua orang yang bekerja dengan C sudah tahu apa yang akan ada di sana.  Di folder utama, buat folder <code>python_wrap</code> lain. </p><br><p>  Mari kita <code>struct.h</code> ke <code>lib/include</code> dan buat <code>struct.h</code> , di mana kita akan menjelaskan satu fungsi dan melihat bagaimana bekerja dengan struktur dalam C melalui Cython. </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">struct_test</span></span></span><span class="hljs-class">{</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> b; } struct_test; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">minus</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct_test a)</span></span></span></span>;</code> </pre><br><p>  Mari kita buat file lain, yang akan kita panggil <code>include.h</code> , ia akan memiliki fungsi lain dan mengimpor struktur dari <code>struct.h</code> </p><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"struct.h"</span></span></span><span class="hljs-meta"> int sum(struct_test param_in_struct);</span></span></code> </pre><br><p>  Sekarang kita akan menjelaskan fungsi-fungsi ini di file <code>lib/src/test_main.c</code> </p><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"include.h"</span></span></span><span class="hljs-meta"> int sum(struct_test param_in_struct){ return param_in_struct.a+param_in_struct.b; } int minus(struct_test param_in_struct){ return param_in_struct.a-param_in_struct.b; }</span></span></code> </pre> <br><p>  Ya, saya tidak berpura-pura menjadi orisinal untuk nama-nama variabel, tetapi kami hampir menyelesaikan bagian-C.  Apa lagi  Tambahkan Makefile, atau lebih tepatnya CMake.  Di folder <code>lib</code> , buat <code>CMakeLists.txt</code> . </p><br><pre> <code class="plaintext hljs">set (TARGET "mal") include_directories( include src ) set (SOURCES ./src/test_main.c ) set (CMAKE_C_FLAGS "${CMAKE_C_FLAGS}") add_library(${TARGET} SHARED ${SOURCES}) target_link_libraries(${TARGET} ${LINKLIBS}) add_library(${TARGET}static STATIC ${SOURCES}) target_link_libraries(${TARGET}static ${LINKLIBS})</code> </pre> <br><p>  Dari direktori utama, kita perlu mengindikasikan bahwa kita memiliki proyek untuk dikompilasi di folder <code>lib</code> .  Buat file <code>CMakeLists.txt</code> lain, tetapi sudah di root. </p><br><pre> <code class="plaintext hljs">cmake_minimum_required(VERSION 2.8.2 FATAL_ERROR) cmake_policy(VERSION 2.8) project( TEST ) set (CMAKE_C_FLAGS "-Werror -Wall -Wextra -Wno-unused-parameter -D_GNU_SOURCE -std=c11 -O3 -g ${CMAKE_C_FLAGS}") add_custom_target( ReplicatePythonSourceTree ALL ${CMAKE_COMMAND} -P ${CMAKE_CURRENT_SOURCE_DIR}/cmake/ReplicatePythonSourceTree.cmake ${CMAKE_CURRENT_BINARY_DIR} WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR} ) include( GNUInstallDirs ) add_subdirectory(lib)</code> </pre> <br><p>  Di sini saya menggunakan file kecil yang mentransfer struktur pembungkus Python ke direktori build sehingga Anda dapat mengkompilasi file Python.  Ini mungkin tidak diperlukan jika Anda melewati jalur relatif ke direktori <code>include</code> dan tempat perpustakaan akan berada.  Misalnya, jika pustaka sudah dikompilasi dan diinstal dalam sistem, maka kita akan mengatur path ke direktori sistem, tetapi lebih lanjut tentang itu nanti. </p><br><div class="spoiler">  <b class="spoiler_title">cmake / ReplicatePythonSourceTree.cmake</b> <div class="spoiler_text"><pre> <code class="plaintext hljs"># Note: when executed in the build dir, then CMAKE_CURRENT_SOURCE_DIR is the # build dir. file( COPY setup.py DESTINATION "${CMAKE_ARGV3}" FILES_MATCHING PATTERN "*.py" ) file( COPY lib/src lib/include DESTINATION "${CMAKE_ARGV3}") file(GLOB MY_WRAP "python_wrap/*" ) file( COPY ${MY_WRAP} DESTINATION "${CMAKE_ARGV3}")</code> </pre> </div></div><br><p>  Sebelum merakit proyek kami, mari kita lihat bagian Python.  Dalam folder <code>python_wrap</code> membuat dua file <code>main.pxd</code> dan <code>main.pyx</code> .  Di <code>main.pxd</code> kita perlu menjelaskan apa yang kita miliki di file <code>*.h</code> . </p><br><pre> <code class="python hljs">cdef extern <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"include/include.h"</span></span>: ctypedef struct struct_test: int a int b int sum(struct_test param_in_struct); int minus(struct_test param_in_struct);</code> </pre> <br><p>  Menggunakan <code>cdef extern from "include/include.h"</code> , kami menunjukkan file mana yang akan kami uraikan.  Selanjutnya adalah <code>ctypedef struct struct_test:</code> deskripsi struktur sehingga dapat digunakan dari kode Python.  Pada akhirnya, pada kenyataannya, deskripsi dua fungsi.  Saya ingin mencatat bahwa kita perlu menjelaskan semua include yang ada di <code>include.h</code> , jika itu mengimpor struktur dan fungsi dari file header lain, kami percaya bahwa semua ini ada dalam satu file. </p><br><p>  Di <code>main.pyx</code> kita menulis fungsi transisi dari Python ke C. Ini tidak perlu, tetapi mengapa memuat kode Python dengan struktur untuk C. Untuk membuat struktur, cukup mendefinisikan kamus dengan semua parameter. </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> main cimport sum, minus <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sum_py</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(int x, int y)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sum({<span class="hljs-string"><span class="hljs-string">"a"</span></span>:x,<span class="hljs-string"><span class="hljs-string">"b"</span></span>:y}) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">minus_py</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(int x, int y)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> minus({<span class="hljs-string"><span class="hljs-string">"a"</span></span>:x,<span class="hljs-string"><span class="hljs-string">"b"</span></span>:y})</code> </pre> <br><p>  Sekarang kita harus menyatukan semuanya.  Tambahkan file <code>setup.py</code> ke root proyek, seperti yang kami lakukan sebelumnya. </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> distutils.core <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> setup <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> distutils.extension <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Extension <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> Cython.Distutils <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> build_ext ext_modules = [Extension(<span class="hljs-string"><span class="hljs-string">'main'</span></span>, [<span class="hljs-string"><span class="hljs-string">'main.pyx'</span></span>], libraries=[<span class="hljs-string"><span class="hljs-string">'mal'</span></span>], library_dirs=[<span class="hljs-string"><span class="hljs-string">'lib/'</span></span>])] setup(name = <span class="hljs-string"><span class="hljs-string">'work extension module'</span></span>, cmdclass = {<span class="hljs-string"><span class="hljs-string">'build_ext'</span></span>: build_ext}, ext_modules = ext_modules)</code> </pre> <br><p>  Untuk mengkompilasi kode C dan mengkompilasi perpustakaan kami, kami akan membuat skrip bash sederhana. </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh rm -rf build; mkdir build &amp;&amp; cd build cmake .. &amp;&amp; make $@ python3 setup.py build_ext -i</span></span></code> </pre> <br><p>  Kami meluncurkan dan memeriksa </p><br><pre> <code class="plaintext hljs">$ sh build.sh $ python3 &gt; import build.main as main &gt; dir(main) [.... 'minus_py', 'sum_py'] &gt; main.minus_py(10,2) 8 &gt; main.sum_py(10,2) 12</code> </pre> <br><h1 id="ctypesgen">  Ctypesgen </h1><br><p>  Contoh sebelumnya sangat sederhana dan mudah, tetapi bagaimana jika Anda perlu membungkus perpustakaan yang sangat besar, tulis semua file <em>.pxd</em> dengan tangan Anda untuk waktu yang sangat lama dan sulit, sehingga muncul pertanyaan yang masuk akal, apa yang dapat digunakan untuk mengotomatiskan proses? </p><br><p>  Kami <code>git clone https://github.com/davidjamesca/ctypesgen.git</code> repositori <code>git clone https://github.com/davidjamesca/ctypesgen.git</code> .  Buka pustaka <code>build/lib/</code> dibangun sebelumnya <code>build/lib/</code> dan jalankan skrip. </p><br><pre> <code class="plaintext hljs">python3 ~/ctypesgen/run.py -lmal ../include/*.h -o main_wrap.py</code> </pre> <br><p>  Setelah itu, kami memeriksa pekerjaan. </p><br><pre> <code class="plaintext hljs">$ python3 &gt; import main_wrap as main &gt; dir(main) [... 'struct_test', 'minus', 'sum'] &gt; main.sum(main.struct_struct_test(1,2)) 3 &gt; main.minus(main.struct_struct_test(1,2)) -1</code> </pre> <br><p>  Nah, kembali ke pertanyaan pustaka yang sudah diinstal, katakanlah kita ingin membuat pembungkus pada pustaka neon (yang sudah diinstal pada sistem dengan cara yang mudah), seperti yang ditunjukkan pada Readme Stypesgen. </p><br><pre> <code class="python hljs">$ ctypesgen.py -lneon /usr/local/include/neon/ne_*.h -o neon.py $ python &gt; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> neon &gt; dir(neon) [...,<span class="hljs-string"><span class="hljs-string">'sys'</span></span>, <span class="hljs-string"><span class="hljs-string">'time_t'</span></span>, <span class="hljs-string"><span class="hljs-string">'union_ne_session_status_info_u'</span></span>, <span class="hljs-string"><span class="hljs-string">'wstring_at'</span></span>]</code> </pre> <br><p>  Akhirnya, tautan ke <a href="">github</a> , bagaimana mungkin tanpa itu. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id467615/">https://habr.com/ru/post/id467615/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id467599/index.html">Render grafik 3D dengan OpenGL</a></li>
<li><a href="../id467605/index.html">Yang Anda butuhkan hanyalah URL</a></li>
<li><a href="../id467607/index.html">Pengakuan pembenci buruh pelabuhan</a></li>
<li><a href="../id467609/index.html">Membuat aplikasi seluler di React Native</a></li>
<li><a href="../id467611/index.html">Algoritma Deteksi Garis Besar Gambar</a></li>
<li><a href="../id467617/index.html">Kaspresso: kerangka kerja autotest yang Anda tunggu-tunggu</a></li>
<li><a href="../id467619/index.html">Aquafor pitcher adalah contoh yang baik tentang bagaimana filter untuk pengolahan air tidak dapat dirancang</a></li>
<li><a href="../id467621/index.html">Pertemuan Elasticsearch Moscow di Ozon</a></li>
<li><a href="../id467623/index.html">Bereaksi Asli: Membuat Bidang Input Animasi menggunakan API Animasi</a></li>
<li><a href="../id467625/index.html">10 layanan untuk membuat struktur situs pada tahun 2020</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>