<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üè≠ üëèüèº üëæ Soft Delete in der REST-API üë©üèø‚Äçüè≠ ‚óºÔ∏è ‚ñ∂Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Damit der Benutzer keine Schmerzen durch unwiederbringlich verlorene Daten versp√ºrt, sollten Sie √ºber das sanfte L√∂schen nachdenken. Beim weichen L√∂sc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Soft Delete in der REST-API</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/440886/"><img src="https://habrastorage.org/webt/oe/bg/db/oebgdbwbph1kzflig9jyrabyozo.gif" alt="Bild"><br><br>  Damit der Benutzer keine Schmerzen durch unwiederbringlich verlorene Daten versp√ºrt, sollten Sie √ºber das sanfte L√∂schen nachdenken.  Beim weichen L√∂schen wird der Datensatz nicht physisch aus der Datenbank gel√∂scht, sondern nur als gel√∂scht markiert.  Dies erleichtert das Wiederherstellen von Daten durch Zur√ºcksetzen des Flags. <br><br>  Ich habe k√ºrzlich das weiche L√∂schen in einem unserer REST-Services implementiert.  Diejenigen, die sich f√ºr das interessieren, was ich getan habe, lade ich zur Katze ein. <br><a name="habracut"></a><br><h2>  Erforderlicher Eintrag </h2><br>  Die Debatte √ºber die Verwendung einer milden Entfernung ist sehr alt.  Schauen Sie sich <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> die langen Holivars <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">an</a> . <br><br>  Am vern√ºnftigsten ist die Position, nach der alles von der Situation abh√§ngt.  Es gibt F√§lle, in denen eine weiche L√∂schung zweckm√§√üig oder sogar notwendig ist, und es gibt F√§lle, in denen die Argumente der Gegner einer weichen L√∂schung Beachtung verdienen.  Ein wichtiges Argument gegen das weiche L√∂schen ist √ºbrigens die Antwort aus dem Jahr 2018: Wenn es sich um Benutzerkonten handelt, widerspricht das weiche L√∂schen der <abbr title="Allgemeine Datenschutzverordnung - Verordnung der Europ√§ischen Union">DSGVO</abbr> . <br><br>  Wir haben entschieden, dass in unserem Service zur Speicherung von Dokumenten ein sanftes L√∂schen erforderlich ist. <br><br><h2>  RESTful Ansatz </h2><br>  Wenn wir das weiche L√∂schen in einem Dienst implementieren m√∂chten, m√ºssen wir verstehen, wie es aus Sicht der Schnittstelle aussehen sollte.  Eine Suche im Internet ergab, dass eine typische Frage ist, ob DELETE {resource} wie zuvor verwendet werden soll oder ob es besser ist, die PATCH-Methode stattdessen mit einem Body zu verwenden, der so etwas wie <i>{status: 'deleted'} enth√§lt.</i> . <br><br>  Hier ist die Meinung der Leute eindeutig: Sie m√ºssen immer noch DELETE verwenden.  Aus Sicht des Kunden ist das L√∂schen auch in Afrika ein L√∂schen.  Nichts sollte sich √§ndern: Wenn eine Ressource gel√∂scht wird, kann nicht mehr darauf zugegriffen werden.  Wenn der Client die Ressource l√∂schen m√∂chte, wei√ü er, dass die HTTP DELETE-Methode f√ºr diesen Zweck vorgesehen ist.  Es ist nicht erforderlich, den Client genau zu beschreiben, wie der Dienst das L√∂schen implementiert. <br><br>  Abgesehen davon war ich besorgt √ºber die Frage, wie gel√∂schte Ressourcen wiederhergestellt werden k√∂nnen.  Dieses Problem wird nat√ºrlich durch die Verwaltung der Datenbank gel√∂st.  Ich m√∂chte dies jedoch √ºber die REST-API tun k√∂nnen.  Und hier kommen wir in Konflikt.  Es stellt sich heraus, dass der Client noch den Implementierungsdetails gewidmet sein muss? <br><br>  Die lange Suche ergab keine Ergebnisse, bis ich auf <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://www.pandastrike.com/posts/20161004-soft-deletes-">einen guten Artikel von Dan Yoder stie√ü</a> .  Der Artikel untersucht die Semantik verschiedener HTTP-Anforderungen und schl√§gt vor, Remote-Ressourcen anstelle des physischen L√∂schens in das <i>Archiv zu verschieben</i> .  Au√üerdem ist es sch√∂n, wenn DELETE einen Link zur archivierten Ressource zur√ºckgibt.  Der Benutzer kann die gel√∂schte Ressource jederzeit wiederherstellen, indem er eine POST-Anforderung an das Archiv sendet. <br><br><h2>  Design </h2><br>  Unser REST-Service basiert auf der ASP.NET-Web-API unter Verwendung des Entity Framework.  Wie gesagt, ich l√∂sche sanft eine Ressource namens document. <br><br>  Zuerst m√ºssen Sie die Spalten zur entsprechenden Tabelle hinzuf√ºgen.  Als Flag verwende ich einen Zeitstempel namens Gel√∂scht.  Wenn der Wert nicht NULL ist, wird die Ressource als gel√∂scht betrachtet.  Dar√ºber hinaus ist es hilfreich, Informationen dar√ºber zu haben, wer die Ressource gel√∂scht hat. <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> Documents <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> Deleted datetime <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, DeletedBy <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre> <br>  Die Aktion L√ñSCHEN in der Steuerung legt jetzt einfach die Werte dieser Felder fest, anstatt den Datensatz physisch zu l√∂schen.  Dar√ºber hinaus gibt DELETE einen Text mit einem Standardverweis auf das archivierte Dokument zur√ºck: <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"links"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"archive"</span></span>: <span class="hljs-string"><span class="hljs-string">"documents/{id}/deleted"</span></span> } }</code> </pre> <br>  In der Tat ist dies ein wichtiger Punkt: Der Link hilft dem Kunden zu verstehen, dass das Dokument nicht gel√∂scht, sondern <i>verschoben wird</i> . <br><br>  Der neue Controller f√ºr archivierte Dokumente sollte die folgenden Methoden bereitstellen: <br><table><tbody><tr><td>  Dokumente abrufen / gel√∂scht </td><td>  Ruft eine Sammlung aller gel√∂schten Dokumente ab </td></tr><tr><td>  Dokumente abrufen / {id} / gel√∂scht </td><td>  Gibt das gel√∂schte Dokument zur√ºck </td></tr><tr><td>  POST-Dokumente / {id} / gel√∂scht </td><td>  Stellt gel√∂schtes Dokument wieder her; <br>  ben√∂tigt keinen K√∂rper;  gibt 201 Erstellt zur√ºck </td></tr><tr><td>  Dokumente l√∂schen / {id} / gel√∂scht </td><td>  L√∂scht ein Dokument physisch </td></tr></tbody></table><br><h2>  Implementierung </h2><br>  Zun√§chst wollte ich meiner Datenbank zwei Ansichten hinzuf√ºgen: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VIEW</span></span> DeletedDocuments <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Documents <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> Deleted <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VIEW</span></span> AvailableDocuments <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Documents <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> Deleted <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre> <br>  Es schien mir, dass dies weniger Probleme bereiten w√ºrde: Anstatt Bedingungen im Code festzulegen, erhalte ich nur zwei verschiedene DbSet-Eigenschaften in meinem DB-Kontext.  Zwar m√ºssen zwei identische Entit√§ten im Modell vorhanden sein, dies ist jedoch die Eigenschaft von POCO-Objekten im Kontext von EF - jede Tabelle entspricht genau einer Entit√§t. <br><br>  √úbrigens k√∂nnen Darstellungen in SQL f√ºr das Entity Framework in anderer Hinsicht n√ºtzlich sein: Mit ihrer Hilfe k√∂nnen Sie beispielsweise auf Tabellen aus einer anderen Datenbank verweisen, wenn Sie nicht mehrere DB-Kontexte erstellen m√∂chten. <br><br>  In meinem Fall hat die Nummer mit den Ansichten jedoch nicht bestanden.  W√§hrend der Autorisierung m√ºssen Sie mit allen Dokumenten arbeiten, da Benutzer die gleichen Rechte zum L√∂schen von Dokumenten haben wie vorhandene. <br><br>  Aus diesem Grund habe ich beschlossen, nur ein DbSet-Dokument in DbContext und im Code zu haben, wenn ich herausfinde, was genau im Moment ben√∂tigt wird: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> availableDocuments = DbContext.Documents.Where(d =&gt; d.Deleted == <span class="hljs-literal"><span class="hljs-literal">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> deletedDocuments = DbContext.Documents.Where(d =&gt; d.Deleted != <span class="hljs-literal"><span class="hljs-literal">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> allDocuments = DbContext.Documents;</code> </pre> <br><h2>  Verwandte Ressourcen </h2><br>  Ein Dokument ist eine Ressource, der andere Ressourcen zugeordnet sind.  Zum Beispiel haben wir einen Dokumentalias.  Das hei√üt, Sie k√∂nnen ein Dokument nicht nur √ºber den Pfad <i>documents / {id}</i> abrufen, sondern auch √ºber den Pfad <i>documents / {alias}</i> , wobei <i>alias</i> eine eindeutige Zeichenfolge ist. <br><br>  Nach dem L√∂schen eines Dokuments sollten alle damit verbundenen Aliase "unsichtbar" werden: Wenn der Client fr√ºher eine Liste aller Aliase mit GET-Dokumenten / Aliasen erhalten hat, werden nach dem L√∂schen des Dokuments seine Aliase aus der Liste ausgeblendet. <br><br>  Aber sie blieben in der Datenbank!  Wir m√∂chten die M√∂glichkeit bieten, das Dokument in dem Zustand wiederherzustellen, in dem es gel√∂scht wurde.  Dies kann zu Verwirrung f√ºr den Client f√ºhren: Er versucht, einen neuen Alias ‚Äã‚Äãf√ºr ein anderes Dokument hinzuzuf√ºgen, die von <i>GET-Dokumenten / Aliasnamen zur√ºckgegebene</i> Liste enth√§lt keine solche Zeile, und der Dienst weigert sich dennoch, sie hinzuzuf√ºgen. <br><br>  Ich denke nicht, dass dies ein ernstes Problem ist.  Wenn Sie es dennoch l√∂sen m√ºssen, k√∂nnen Sie die Endpunkt- <i>GET-Dokumente / gel√∂schten / Aliase</i> hinzuf√ºgen.  Dann passt alles zusammen: Der Dienst kann keinen Alias ‚Äã‚Äãhinzuf√ºgen, da ein solcher Wert bereits vom entfernten Dokument verwendet wird. <br><br>  Es kann sich die Frage stellen: Lohnt es sich, einen Alias ‚Äã‚Äãaus der Liste zu werfen, die von <i>Dokumenten / Aliasnamen zur√ºckgegeben wird</i> ?  Lass sie bleiben!  Ich denke nicht, dass eine solche Entscheidung richtig w√§re.  Dann stellt sich heraus, dass die Liste der Aliase fehlerhafte Links enth√§lt, da der Dienst 404 Not Found zur√ºckgibt, wenn der Client versucht, das gel√∂schte Dokument per Alias ‚Äã‚Äãabzurufen.  Wenn es um die untergeordneten Ressourcen geht, die dem Dokument zugeordnet sind, sollte das Verhalten genau so sein, als ob wir das Dokument physisch l√∂schen w√ºrden. <br><br><h2>  Archivreinigung </h2><br>  Das weiche L√∂schen bietet neben der einfachen Wiederherstellung von Daten mehrere weitere Vorteile.  Der L√∂schvorgang in relationalen Datenbanken ist ein teurer Vorgang.  Und wenn selbst das L√∂schen eines Datensatzes zum kaskadierenden L√∂schen von Datens√§tzen in anderen Tabellen f√ºhrt, ist dies mit Deadlocks behaftet.  Daher ist die weiche Entfernung schneller und zuverl√§ssiger als die physische Entfernung. <br><br>  Es gibt jedoch einen wesentlichen Nachteil.  Die Basis beginnt zu wachsen. <br><br>  Daher sollten Sie sich im Endstadium um die automatische Reinigung des Archivs k√ºmmern.  Sie k√∂nnen die Basis nat√ºrlich manuell reinigen, aber es ist besser, diesen Prozess zu automatisieren.  Wenn wir das Ablaufdatum eines Remote-Objekts direkt festlegen, z. B. 30 Tage, kann der Client die Archivseite anzeigen, auf der die Elemente hervorgehoben werden, deren Lebensdauer sich dem Ende n√§hert. <br><br>  Meine H√§nde haben diese Aufgabe noch nicht erreicht.  Wir planen, unserem Task-System eine Task hinzuzuf√ºgen, die einmal t√§glich eine einfache SQL-Abfrage ausf√ºhrt, mit der alle fehlerhaften Objekte aus dem Archiv entfernt werden.  Als Parameter sollte die Aufgabe ein Ablaufdatum haben.  Es muss sichergestellt werden, dass der aktuelle Wert dieses Parameters an einem Ort gespeichert wird.  Anschlie√üend kann im Dienst eine Methode implementiert werden, die diesen Wert an den Client zur√ºckgibt. <br></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de440886/">https://habr.com/ru/post/de440886/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de440874/index.html">Implementierung der freien Partikelbewegung auf ReactJS</a></li>
<li><a href="../de440878/index.html">Webanalyse f√ºr Unternehmen</a></li>
<li><a href="../de440880/index.html">Top 10 IoT-Sensoren im Jahr 2019</a></li>
<li><a href="../de440882/index.html">Entfliehen Sie Crypto Pro. GOST 34.10-2012 Ausgabe</a></li>
<li><a href="../de440884/index.html">Die Verarbeitung nicht behebbarer Fehler in Swift</a></li>
<li><a href="../de440888/index.html">Unabh√§ngige Tests von Baikal-T1 - dem ersten russischen 28-nm-SoC - und BFK 3.1 Evaluation Board</a></li>
<li><a href="../de440890/index.html">Patriotismus in Computerspielen: die Meinung eines ehemaligen Spielers</a></li>
<li><a href="../de440892/index.html">Die unerwartete Effizienz quasi zuf√§lliger Sequenzen</a></li>
<li><a href="../de440894/index.html">Sound f√ºr Pathfinder entwerfen: Kingmaker</a></li>
<li><a href="../de440896/index.html">Additive Technologien und 3D-Scannen im Maschinenbau: 7 Erfolgsgeschichten</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>