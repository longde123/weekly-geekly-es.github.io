<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèº‚Äçüíº ‚úäüèΩ üèîÔ∏è So erstellen Sie eine mandantenf√§hige Anwendung aus einer nicht mandantenf√§higen Anwendung üå≥ ü¶É ‚õπÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ich werde keine Definition von Mandantenf√§higkeit geben, sie haben bereits mehrmals hier und hier dar√ºber geschrieben . Es ist besser, direkt zum Them...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>So erstellen Sie eine mandantenf√§hige Anwendung aus einer nicht mandantenf√§higen Anwendung</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/directum/blog/483784/"><p><img src="https://habrastorage.org/webt/-8/wa/hf/-8wahfnvtijn8bqkeopcgo0an1g.png" alt="Bild"></p><br><p>  Ich werde keine Definition von Mandantenf√§higkeit geben, sie haben bereits mehrmals <a href="https://habr.com/ru/company/microsoft/blog/145027/">hier</a> und <a href="https://habr.com/ru/company/1c/blog/326654/">hier dar√ºber geschrieben</a> .  Es ist besser, direkt zum Thema des Artikels zu gehen und mit den folgenden Fragen zu beginnen: </p><br><h2 id="pochemu-prilozhenie-ne-delayut-srazu-multitenantnym">  Warum ist die Anwendung nicht sofort mandantenf√§hig? </h2><br><p>  Es kommt vor, dass die Anwendung zun√§chst nur f√ºr die Installation auf der Clientseite entwickelt wird.  Sie k√∂nnen eine solche Anwendung in der Verpackung oder <i>als Software als Produkt bezeichnen</i> .  Ein Client kauft eine Box und stellt die Anwendung auf seinen Servern bereit (es gibt viele Beispiele f√ºr solche Anwendungen). </p><br><p>  Mit der Zeit k√∂nnte die Entwicklerfirma jedoch der Meinung sein, dass es hilfreich w√§re, die Anwendung in der Cloud zu platzieren, damit sie gemietet wird (Software as a Service).  Diese Bereitstellungsmethode bietet sowohl f√ºr Kunden als auch f√ºr das Entwicklerunternehmen Vorteile.  Kunden erhalten schnell ein funktionierendes System und m√ºssen sich nicht um Bereitstellung und Verwaltung k√ºmmern.  Wenn Sie eine Anwendung mieten, ben√∂tigen Sie keine gro√üen einmaligen Investitionen. </p><br><p>  Das Entwicklerunternehmen erh√§lt neue Kunden und neue Aufgaben: Bereitstellung der Anwendung in der Cloud, Verwaltung, Aktualisierung auf neue Versionen, Migration von Daten w√§hrend der Aktualisierung, Datensicherung, √úberwachung der Geschwindigkeit und Fehler sowie Behebung von Problemen, wenn diese auftreten. </p><a name="habracut"></a><br><h2 id="pochemu-prilozhenie-v-oblake-dolzhno-byt-multitenantnym">  Warum sollte die Anwendung in der Cloud mandantenf√§hig sein? </h2><br><p>  Um eine Anwendung in der Cloud zu platzieren, muss sie nicht mandantenf√§hig sein.  Dann ergibt sich jedoch das folgende Problem: Sie m√ºssen f√ºr jeden Client einen dedizierten Stand in der Cloud mit der geleasten Anwendung bereitstellen, und dies ist sowohl im Hinblick auf den Verbrauch von Cloud-Standressourcen als auch im Hinblick auf die Verwaltung bereits kostspielig.  Es ist rentabler, Mandantenf√§higkeit in der Anwendung zu implementieren, sodass eine Instanz mehrere Clients (Organisationen) bedienen kann. </p><br><p>  Wenn die Anwendung 1000 gleichzeitig arbeitende Benutzer abruft, ist es vorteilhaft, Clients (Organisationen) so zu gruppieren, dass sie insgesamt die gew√ºnschte Last von 1000 Benutzern pro Anwendungsinstanz ergeben.  Und dann werden die Cloud-Ressourcen optimal genutzt. </p><br><p>  Angenommen, die Anwendung wird von einer Organisation f√ºr 20 Benutzer (Mitarbeiter der Organisation) gemietet.  Dann m√ºssen Sie 50 dieser Organisationen gruppieren, um die richtige Last zu erreichen.  Es ist wichtig, Organisationen voneinander zu isolieren.  Eine Organisation mietet eine Anwendung, l√§sst nur ihre Mitarbeiter dorthin, speichert nur ihre Daten und sieht nicht, dass auch andere Organisationen von derselben Anwendung bedient werden. </p><br><p>  Die Implementierung einer Mandantenf√§higkeit bedeutet nicht, dass die Anwendung nicht mehr lokal auf dem Server des Unternehmens bereitgestellt werden kann.  Sie k√∂nnen zwei Bereitstellungsmethoden gleichzeitig unterst√ºtzen: </p><br><ul><li>  mandantenf√§hige Anwendung in der Cloud; </li><li>  Mandantenanwendung auf dem Client-Server. </li></ul><br><p>  Unsere Anwendung hat einen √§hnlichen Weg beschritten: vom Nicht-Mandanten zum Multi-Mandanten.  In diesem Artikel werde ich einige Ans√§tze zur Entwicklung von Mandantenf√§higkeit vorstellen. </p><br><h2 id="kak-realizovat-multitenantnost-v-prilozhenii-kotoroe-sproektirovano-kak-ne-tenantnoe">  Wie implementiere ich Mandantenf√§higkeit in einer Anwendung, die als Nicht-Mandanten ausgelegt ist? </h2><br><p>  Wir werden das Thema sofort einschr√§nken, wir werden nur die Entwicklung in Betracht ziehen, wir werden nicht auf Fragen des Testens, der Freigabe einer Version, der Bereitstellung und der Verwaltung eingehen.  In all diesen Bereichen sollte auch die Entstehung von Mandantenf√§higkeit ber√ºcksichtigt werden, aber im Moment werden wir nur √ºber Entwicklung sprechen. </p><br><p>  Um zu verstehen, was eine Anwendung ist, die nicht Mandantenf√§hig und mandantenunabh√§ngig war, beschreibe ich ihren Zweck, eine Liste der verwendeten Dienste und Technologien. </p><br><p>  Dies ist ein ECM-System (DirectumRX), das aus 10 Diensten (5 monolithischen Diensten und 5 Mikrodiensten) besteht.  Alle diese Dienste k√∂nnen entweder auf einem leistungsstarken Server oder auf mehreren Servern abgelegt werden. </p><br><div class="spoiler">  <b class="spoiler_title">Dienstleistungen sind</b> <div class="spoiler_text"><ul><li>  Webservice - f√ºr die Wartung von Web-Clients (Browsern). </li><li>  WCF-Dienst - zum Warten von Desktop-Clients (WPF-Anwendungen). </li><li>  Service f√ºr mobile Anwendungen. </li><li>  Service zur Durchf√ºhrung von Hintergrundprozessen. </li><li>  Service zur Planung von Hintergrundprozessen. </li><li>  Workflow Scheme Execution Service </li><li>  Workflow Block Execution Service </li><li>  Dokumentenspeicherdienst (Bin√§rdaten). </li><li>  Dienst zum Konvertieren von Dokumenten in HTML (Vorschau in einem Browser). </li><li>  Dienst zum Speichern von Konvertierungsergebnissen in HTML </li></ul></div></div><br><p>  Stapel der verwendeten Technologien: <br>  .NET + SQLServer / Postgres + NHibernate + IIS + RabbitMQ + Redis </p><br><p>  Was kann also bewirken, dass Services mandantenf√§hig werden?  Dazu m√ºssen Sie die folgenden Mechanismen in Diensten verfeinern: </p><br><ul><li>  Datenspeicherung; </li><li>  ORM; </li><li>  Daten-Caching; </li><li>  Anfragebearbeitung; </li><li>  Verarbeiten von Warteschlangennachrichten; </li><li>  Konfiguration; </li><li>  Protokollierung; </li><li>  Ausf√ºhren von Hintergrundaufgaben; </li><li>  Wechselwirkung mit Mikrodiensten; </li><li>  Interaktion mit dem Nachrichtenbroker. </li></ul><br><p>  Bei unserer Anwendung waren dies die wichtigsten Stellen, an denen Verbesserungen erforderlich waren.  Betrachten wir sie getrennt. </p><br><h2 id="vybor-sposoba-hraneniya-dannyh">  Ausw√§hlen einer Datenspeichermethode </h2><br><p>  Wenn Sie Artikel zum Thema Mandantenf√§higkeit lesen, ist das erste, was sie aussortieren, die Organisation der Datenspeicherung.  In der Tat ist der Punkt wichtig. </p><br><p>  Bei unserem ECM-System ist der Hauptspeicher eine relationale Datenbank mit etwa 100 Tabellen.  Wie kann die Speicherung von Daten vieler Organisationen so organisiert werden, dass Organisation A die Daten von Organisation B in keiner Weise sieht? </p><br><p>  Es sind mehrere Schemata bekannt (√ºber diese Schemata wurde bereits viel geschrieben): </p><br><ul><li>  Erstellen Sie eine eigene Datenbank f√ºr jede Organisation (f√ºr jeden Mandanten). </li><li>  Verwenden Sie eine Datenbank f√ºr alle Organisationen. Erstellen Sie jedoch f√ºr jede Organisation ein eigenes Schema in der Datenbank. </li><li>  Verwenden Sie eine Datenbank f√ºr alle Organisationen, f√ºgen Sie jedoch in jeder Tabelle eine Spalte "Mandant / Organisationsschl√ºssel" hinzu. </li></ul><br><p>  Die Wahl des Schemas ist nicht zuf√§llig.  In unserem Fall ist es ausreichend, die F√§lle der Systemadministration zu ber√ºcksichtigen, um die bevorzugte Option zu verstehen.  F√§lle sind wie folgt: </p><br><ul><li>  Mieter hinzuf√ºgen (eine neue Organisation mietet ein System); </li><li>  Mieter entfernen (die Organisation weigerte sich zu mieten); </li><li>  Mieter auf einen anderen Cloud-Stand √ºbertragen (die Last zwischen den Cloud-St√§nden umverteilen, wenn ein Stand die Last nicht mehr bew√§ltigt). </li></ul><br><p>  Betrachten Sie ein Mieterverteilergetriebe.  Die Hauptaufgabe der √úbertragung besteht darin, die Daten der Organisation auf einen anderen Stand zu √ºbertragen.  Das √úbertragen ist nicht schwierig, wenn der Mandant √ºber eine eigene Datenbank verf√ºgt. Es bereitet jedoch Kopfzerbrechen, wenn Sie die Daten verschiedener Organisationen in 100 Tabellen zusammenfassen.  Versuchen Sie, nur die erforderlichen Daten aus den Tabellen zu extrahieren, und √ºbertragen Sie sie in eine andere Datenbank, in der bereits Daten von anderen Mandanten vorhanden sind, sodass sich deren Bezeichner nicht √ºberschneiden. </p><br><p>  Der n√§chste Fall ist das Hinzuf√ºgen eines neuen Mieters.  Der Fall ist auch nicht einfach.  Beim Hinzuf√ºgen eines Mandanten m√ºssen Systemverzeichnisse, Benutzer und Rechte ausgef√ºllt werden, damit Sie sich √ºberhaupt beim System anmelden k√∂nnen.  Diese Aufgabe l√§sst sich am besten l√∂sen, indem Sie eine Referenzdatenbank klonen, die bereits √ºber alles verf√ºgt, was Sie ben√∂tigen. </p><br><p>  Der Tenant Removal-Fall l√§sst sich sehr einfach durch Deaktivieren der Tenant-Datenbank l√∂sen. </p><br><p>  Aus diesen Gr√ºnden haben wir uns f√ºr ein Schema entschieden: <strong>ein Mandant - eine Datenbank</strong> . </p><br><h2 id="orm">  ORM </h2><br><p>  Wir w√§hlten die Datenspeichermethode, die n√§chste Frage: Wie bringt man ORM bei, mit dem ausgew√§hlten Schema zu arbeiten? </p><br><p>  Wir verwenden Nhibernate.  Es war erforderlich, dass Nhibernate mit mehreren Datenbanken arbeitet und regelm√§√üig auf die richtige umschaltet, zum Beispiel abh√§ngig von der http-Anforderung.  Wenn wir die Anforderung von Organisation A verarbeiten, wurde Datenbank A verwendet, und wenn die Anforderung von Organisation B stammt, wird Datenbank B verwendet. </p><br><p>  NHibernate hat eine solche Gelegenheit.  Sie m√ºssen die Implementierung von <em>NHibernate.Connection.DriverConnectionProvider √ºberschreiben</em> .  Wenn NHibernate eine Datenbankverbindung √∂ffnen m√∂chte, ruft es <em>DriverConnectionProvider</em> auf, um eine Verbindungszeichenfolge <em>abzurufen</em> .  Hier ersetzen wir es durch das Notwendige: </p><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MyDriverConnectionProvider</span></span> : <span class="hljs-title"><span class="hljs-title">DriverConnectionProvider</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConnectionString =&gt; TenantRegistry.Instance.CurrentTenant.ConnectionString; }</code> </pre> <br><p>  Was ist <em>TenantRegistry.Instance.CurrentTenant</em> Ich werde etwas sp√§ter erz√§hlen. </p><br><h2 id="keshirovanie-dannyh">  Daten-Caching </h2><br><p>  Services zwischenspeichern h√§ufig Daten, um Datenbankabfragen zu minimieren oder um nicht dasselbe vielfach zu berechnen.  Das Problem ist, dass die Caches nach Mandanten aufgeteilt werden m√ºssen, wenn Mandantendaten zwischengespeichert werden.  Es ist nicht akzeptabel, dass der Datencache einer Organisation verwendet wird, wenn eine Anforderung von einer anderen Organisation verarbeitet wird.  Die einfachste L√∂sung besteht darin, dem Schl√ºssel jedes Caches eine Mandanten-ID hinzuzuf√ºgen: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tenantCacheKey = cacheKey + TenantRegistry.Instance.CurrentTenant.Id;</code> </pre> <br><p>  Dieses Problem muss beim Erstellen der einzelnen Caches beachtet werden.  Es gibt viele Caches in unseren Diensten.  Um nicht zu vergessen, die Mandanten-ID in jeder zu ber√ºcksichtigen, ist es besser, die Arbeit mit Caches zu vereinheitlichen.  Erstellen Sie beispielsweise einen allgemeinen Caching-Mechanismus, der im Kontext von Mandanten sofort zwischengespeichert wird. </p><br><h2 id="logirovanie">  Protokollierung </h2><br><p>  Fr√ºher oder sp√§ter tritt im System ein Fehler auf. Sie m√ºssen die Protokolldatei √∂ffnen und mit dem Studium beginnen.  Die erste Frage lautet: F√ºr welchen Benutzer und f√ºr welche Organisation wurden diese Aktionen durchgef√ºhrt? </p><br><p>  Es ist praktisch, wenn in jeder Zeile des Protokolls eine Mandanten-ID und ein Mandanten-Benutzername vorhanden sind.  Diese Information wird so notwendig wie zum Beispiel die Nachrichtenzeit: </p><br><pre> <code class="plaintext hljs">2019-05-24 17:05:27.985 &lt;message&gt; [User2 :Tenant1] 2019-05-24 17:05:28.126 &lt;message&gt; [User3 :Tenant2] 2019-05-24 17:05:28.173 &lt;message&gt; [User4 :Tenant3]</code> </pre> <br><p>  Der Entwickler sollte nicht dar√ºber nachdenken, welchen Mandanten er in das Protokoll schreiben soll, er sollte automatisiert und "unter der Haube" des Protokollierungssystems verborgen sein. </p><br><p>  Wir verwenden NLog, deshalb werde ich ein Beispiel daf√ºr geben.  Am einfachsten k√∂nnen Sie die Mandanten- <em>ID</em> sichern, <em>indem</em> Sie <em>NLog.LayoutRenderers.LayoutRenderer</em> erstellen, mit dem Sie die Mandanten- <em>ID</em> f√ºr jeden Protokolleintrag <em>abrufen</em> k√∂nnen: </p><br><pre> <code class="cs hljs"> [<span class="hljs-meta"><span class="hljs-meta">LayoutRenderer(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"tenant"</span></span></span><span class="hljs-meta">)</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">TenantLayoutRenderer</span></span> : <span class="hljs-title"><span class="hljs-title">LayoutRenderer</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Append</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">StringBuilder builder, LogEventInfo logEvent</span></span></span><span class="hljs-function">)</span></span> { builder.Append(TenantRegistry.Instance.CurrentTenant.Id); } }</code> </pre> <br><p>  Verwenden Sie dann diesen LayoutRenderer in der Protokollvorlage: </p><br><pre> <code class="plaintext hljs">&lt;target layout="${odate} ${message} [${user} :${tenant}]"/&gt;</code> </pre> <br><h2 id="vypolnenie-koda">  Code-Ausf√ºhrung </h2><br><p>  In den obigen Beispielen habe ich oft den folgenden Code verwendet: </p><br><pre> <code class="cs hljs">TenantRegistry.Instance.CurrentTenant</code> </pre> <br><p>  Es ist Zeit zu sagen, was das bedeutet.  Aber zuerst m√ºssen Sie den Ansatz verstehen, den wir bei Dienstleistungen verfolgen: </p><br><blockquote>  Jede Codeausf√ºhrung (Verarbeiten einer http-Anforderung, Verarbeiten einer Warteschlangennachricht, Ausf√ºhren einer Hintergrundaufgabe in einem separaten Thread) muss mit einem Mandanten verkn√ºpft sein. </blockquote><p>  Dies bedeutet, dass an jeder Stelle in der Codeausf√ºhrung gefragt werden kann: "F√ºr welchen Mandanten funktioniert dieser Thread?"  oder anders ausgedr√ºckt: "Was ist der aktuelle Mieter?" </p><br><p>  <em>TenantRegistry.Instance.CurrentTenant</em> ist der aktuelle <em>Mandant</em> f√ºr den aktuellen Stream.  Stream und Mieter k√∂nnen in unseren Anwendungen verkn√ºpft werden.  Sie werden vor√ºbergehend verbunden, z. B. w√§hrend der Verarbeitung einer http-Anforderung oder einer Nachricht aus der Warteschlange.  So binden Sie einen Mandanten an einen Stream: </p><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//    . using (TenantRegistry.Instance.SwitchTo(tenantId)) { // ,     . var tenant = TenantRegistry.Instance.CurrentTenant; //     . var connectionString = tenant.ConnectionString; //  . var id = tenant.Id; }</span></span></code> </pre> <br><p>  Ein an einen Thread gebundener <em>Mandant</em> kann an einer beliebigen Stelle im Code durch Kontaktaufnahme mit <em>TenantRegistry</em> abgerufen werden. Hierbei handelt es sich um einen Singleton, einen Zugriffspunkt f√ºr die Arbeit mit Mandanten.  Daher k√∂nnen Nhibernate und NLog (an Erweiterungspunkten) auf diesen Singleton zugreifen, um die Verbindungszeichenfolge oder die Mandanten-ID zu ermitteln. </p><br><h2 id="fonovye-zadachi">  Hintergrundaufgaben </h2><br><p>  Dienste haben h√§ufig Hintergrundaufgaben, die auf einem Zeitgeber ausgef√ºhrt werden m√ºssen.  Hintergrundaufgaben k√∂nnen auf die Datenbank der Organisation zugreifen. Anschlie√üend muss die Hintergrundaufgabe f√ºr jeden Mandanten ausgef√ºhrt werden.  Dazu muss nicht f√ºr jeden Mandanten ein separater Timer oder Thread gestartet werden.  Es ist m√∂glich, eine Aufgabe in verschiedenen Mandanten innerhalb eines Threads / Timers auszuf√ºhren.  Zu diesem Zweck sortieren wir im Timer-Handler die Mandanten, ordnen jedem Mandanten einen Stream zu und f√ºhren eine Hintergrundaufgabe aus: </p><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//    . foreach (var tenant in TenantRegistry.Instance.Tenants) { //    . using (TenantRegistry.Instance.SwitchTo(tenant.Id)) { //     . } }</span></span></code> </pre> <br><p>  Es k√∂nnen nicht zwei Mandanten gleichzeitig an den Datenfluss angeh√§ngt werden. Wenn wir einen anh√§ngen, wird der andere vom Datenfluss getrennt.  Wir verwenden diesen Ansatz aktiv, um keine Threads / Timer f√ºr Hintergrundaufgaben zu erstellen. </p><br><h2 id="kak-sootnesti-http-zapros-c-tenantom">  So korrelieren Sie eine http-Anfrage mit einem Mandanten </h2><br><p>  Um die http-Anfrage des Kunden zu verarbeiten, m√ºssen Sie wissen, von welcher Organisation er kam.  Wenn der Benutzer bereits authentifiziert ist, kann die Mandanten-ID im Authentifizierungscookie (wenn die Arbeit mit der Anwendung √ºber den Browser ausgef√ºhrt wird) oder im JWT-Token gespeichert werden.  Was aber, wenn der Benutzer sich noch nicht authentifiziert hat?  Beispielsweise hat ein anonymer Benutzer eine Anwendungswebsite ge√∂ffnet und m√∂chte sich authentifizieren.  Dazu sendet er eine Anfrage mit Login und Passwort.  In der Datenbank von welcher Organisation soll nach diesem Benutzer gesucht werden? </p><br><p>  Anonyme Anfragen beziehen sich auch auf das Abrufen der Anmeldeseite f√ºr die Anwendung und k√∂nnen f√ºr verschiedene Organisationen unterschiedlich sein, z. B. die Sprache der Lokalisierung. </p><br><p>  Um das Problem der Korrelation von anonymer http-Anfrage und Organisation (Mandant) zu l√∂sen, verwenden wir Subdomains f√ºr Organisationen.  Der Name der Unterdom√§ne setzt sich aus dem Namen der Organisation zusammen.  Benutzer m√ºssen die Unterdom√§ne verwenden, um mit dem System zu arbeiten: </p><br><pre> <code class="plaintext hljs">https://company1.service.com https://company2.service.com</code> </pre> <br><p>  Unter diesen Adressen ist derselbe mandantenf√§hige Webdienst verf√ºgbar.  Jetzt wei√ü der Dienst jedoch, von welcher Organisation eine anonyme http-Anfrage kommt, die sich auf den Domain-Namen konzentriert. <br>  Die Bindung von Domainname und Mandant erfolgt in der Konfigurationsdatei des Webdienstes: </p><br><pre> <code class="json hljs">&lt;tenant name=<span class="hljs-string"><span class="hljs-string">"company1"</span></span> db=<span class="hljs-string"><span class="hljs-string">"database1"</span></span> host=<span class="hljs-string"><span class="hljs-string">"company1.service.com"</span></span> /&gt; &lt;tenant name=<span class="hljs-string"><span class="hljs-string">"company2"</span></span> db=<span class="hljs-string"><span class="hljs-string">"database2"</span></span> host=<span class="hljs-string"><span class="hljs-string">"company2.service.com"</span></span> /&gt;</code> </pre> <br><p>  Informationen zum Konfigurieren von Diensten werden im Folgenden beschrieben. </p><br><h2 id="mikroservisy-hranenie-dannyh">  Microservices.  Datenspeicherung </h2><br><p>  Als ich sagte, dass das ECM-System 100 Tische ben√∂tigt, sprach ich √ºber monolithische Dienste.  Es kommt jedoch vor, dass ein Mikrodienst einen relationalen Speicher ben√∂tigt, in dem 2-3 Tabellen zum Speichern seiner Daten erforderlich sind.  Im Idealfall verf√ºgt jeder Mikrodienst √ºber einen eigenen Speicher, auf den nur er Zugriff hat.  Und der Microservice entscheidet, wie Daten im Kontext von Mietern gespeichert werden. </p><br><p>  Wir sind jedoch den anderen Weg gegangen: Wir haben beschlossen, alle Daten der Organisation in einer Datenbank zu speichern.  Wenn f√ºr einen Mikrodienst ein relationaler Speicher erforderlich ist, wird die vorhandene Organisationsdatenbank verwendet, sodass die Daten nicht auf verschiedene Speicher verteilt, sondern in einer Datenbank gesammelt werden.  Monolithische Dienste verwenden dieselbe Datenbank. </p><br><p>  Microservices arbeiten nur mit ihren Tabellen in der Datenbank und versuchen nicht, mit Tabellen eines Monolithen oder eines anderen Microservices zu arbeiten.  Dieser Ansatz hat Vor- und Nachteile. </p><br><p>  Vorteile: </p><br><ul><li>  Organisationsdaten an einem Ort; </li><li>  einfache Sicherung und Wiederherstellung von Organisationsdaten; </li><li>  In der Sicherung sind die Daten aller Dienste konsistent. </li></ul><br><p>  Nachteile: </p><br><ul><li>  Eine Datenbank f√ºr alle Services ist ein Engpass bei der Skalierung (die Anforderungen an die DBMS-Ressourcen steigen). </li><li>  microservices haben physischen Zugriff auf die Tabellen des jeweils anderen, verwenden diese Funktion jedoch nicht. </li></ul><br><h2 id="mikroservisy-znanie-o-tenantah-ne-vsegda-trebuetsya">  Microservices.  Kenntnisse der Mieter sind nicht immer erforderlich. </h2><br><p>  Ein Microservice wei√ü m√∂glicherweise nicht, dass er in einer Umgebung mit mehreren Mandanten funktioniert.  Betrachten Sie einen unserer Services, der sich mit der Konvertierung von Dokumenten in HTML befasst. </p><br><p>  Was der Service macht: </p><br><ol><li>  Nimmt eine Nachricht aus einer RabbitMQ-Warteschlange, um ein Dokument zu konvertieren. <br><ul><li>  Ruft die Dokument- und Mandanten-ID aus der Nachricht ab </li></ul></li><li>  Laden Sie ein Dokument von einem Dokumentenspeicherdienst herunter. <br><ul><li>  hierf√ºr wird eine Anfrage generiert, in der die Dokumentenkennung und die Mandantenkennung √ºbertragen werden </li></ul></li><li>  Konvertiert ein Dokument in HTML. </li><li>  Gibt HTML an den Dienst zum Speichern von Conversion-Ergebnissen. </li></ol><br><p>  Der Dienst speichert keine Dokumente und speichert keine Konvertierungsergebnisse.  Er kennt die Mieter indirekt: Die Mieteridentifikation durchl√§uft die Dienstleistung auf dem Transportweg. </p><br><h2 id="mikroservisy-poddomeny-ne-nuzhny">  Microservices.  Subdomains werden nicht ben√∂tigt </h2><br><p>  Ich habe oben geschrieben, dass Subdomains helfen, das Problem anonymer http-Anfragen zu l√∂sen: </p><br><pre> <code class="plaintext hljs">https://company1.service.com https://company2.service.com</code> </pre> <br><p>  Nicht alle Dienste funktionieren jedoch mit anonymen Anforderungen. Die meisten erfordern eine bereits bestandene Authentifizierung.  Daher ist es Mikrodiensten, die √ºber http arbeiten, h√§ufig egal, von welchem ‚Äã‚ÄãHostnamen die Anforderung stammt. Sie erhalten alle Informationen √ºber den Mandanten aus dem JWT-Token oder dem Authentifizierungscookie, das mit jeder Anforderung geliefert wird. </p><br><h2 id="konfigurirovanie">  Konfiguration </h2><br><p>  Die Dienste m√ºssen so konfiguriert werden, dass sie die Mandanten kennen.  N√§mlich: </p><br><ul><li>  Geben Sie die Zeichenfolgen f√ºr die Verbindung zur Datenbank der Mandanten an. </li><li>  Domainnamen an Mieter binden; </li><li>  Geben Sie die Standardsprache und die Zeitzone des Mandanten an. </li></ul><br><p>  Mieter k√∂nnen viele Einstellungen haben.  F√ºr unsere Services legen wir die Mandanteneinstellungen in XML-Konfigurationsdateien fest.  Dies ist nicht web.config und nicht app.config.  Dies ist eine separate XML-Datei, deren √Ñnderungen erfasst werden m√ºssen, ohne dass die Dienste neu gestartet werden m√ºssen, damit durch das Hinzuf√ºgen eines neuen Mandanten nicht das gesamte System neu gestartet wird. </p><br><p>  Die Liste der Einstellungen sieht ungef√§hr so ‚Äã‚Äãaus: </p><br><pre> <code class="xml hljs"><span class="hljs-comment"><span class="hljs-comment">&lt;!--  . --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">block</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"TENANTS"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tenant</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Jupiter"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">db</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"DirectumRX_Jupiter"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">login</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"admin"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">password</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"password"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">hyperlinkUriScheme</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"jupiter"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">hyperlinkFileExtension</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">".jupiter"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">hyperlinkServer</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://jupiter-rx.directum.ru/Sungero"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">helpAddress</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://jupiter-rx.directum.ru/Sungero/help"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">devHelpAddress</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://jupiter-rx.directum.ru/Sungero/dev_help"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">language</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Ru-ru"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">isAttributesSignatureAbsenceAllowed</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">endorsingSignatureLocksSignedProperties</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">administratorEmail</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"admin@jupiter-company.ru"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">feedbackEmail</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"support@jupiter-company.ru"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">isSendFeedbackAllowed</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">serviceUserPassword</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"password"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">utcOffset</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"5"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">collaborativeEditingEnabled</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">collaborativeEditingForced</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tenant</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Mars"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">db</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"DirectumRX_Mars"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">login</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"admin"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">password</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"password"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">hyperlinkUriScheme</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"mars"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">hyperlinkFileExtension</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">".mars"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">hyperlinkServer</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://mars-rx.directum.ru/Sungero"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">helpAddress</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://mars-rx.directum.ru/Sungero/help"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">devHelpAddress</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://mars-rx.directum.ru/Sungero/dev_help"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">language</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Ru-ru"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">isAttributesSignatureAbsenceAllowed</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">endorsingSignatureLocksSignedProperties</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">administratorEmail</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"root@mars-ooo.ru"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">feedbackEmail</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"support@mars-ooo.ru"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">isSendFeedbackAllowed</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">serviceUserPassword</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"password"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">utcOffset</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"-1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">collaborativeEditingEnabled</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">collaborativeEditingForced</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">block</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  Wenn eine neue Organisation einen Service mietet, muss sie einen neuen Mandanten zur Konfigurationsdatei hinzuf√ºgen.  Und es ist w√ºnschenswert, dass andere Organisationen dies nicht sp√ºren.  Im Idealfall sollte kein Neustart der Dienste erfolgen. </p><br><p>  Bei uns k√∂nnen nicht alle Dienste eine Konfiguration ohne Neustart abrufen, aber die kritischsten Dienste (Monolithen) k√∂nnen dies. </p><br><h2 id="itog">  Zusammenfassung </h2><br><p>  Wenn eine Anwendung mandantenf√§hig wird, scheint die Komplexit√§t der Entwicklung dramatisch zuzunehmen.  Aber dann gew√∂hnt man sich an Mandantenf√§higkeit und behandelt die Unterst√ºtzung als normale Anforderung. </p><br><p>  Beachten Sie auch, dass Mandantenf√§higkeit nicht nur Entwicklung, sondern auch Test, Verwaltung, Bereitstellung, Aktualisierung, Sicherung und Datenmigration umfasst.  Aber besser √ºber sie ein anderes Mal. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de483784/">https://habr.com/ru/post/de483784/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de483770/index.html">Auf dem Weg zur SSL-Automatisierung</a></li>
<li><a href="../de483774/index.html">Die Zusammenfassung der Ereignisse f√ºr Personalfachleute in der IT f√ºr Januar 2020</a></li>
<li><a href="../de483776/index.html">Einf√ºhrung in die semantische Differentialmethode in 5 Minuten</a></li>
<li><a href="../de483778/index.html">Sicherheitswoche 03: Verantwortungsvolle Fehlerberichte</a></li>
<li><a href="../de483780/index.html">Was ist Slack und wie funktioniert es?</a></li>
<li><a href="../de483786/index.html">Hybrides Sortieren</a></li>
<li><a href="../de483788/index.html">Winzige Inselnation verdient dank Twitch</a></li>
<li><a href="../de483790/index.html">Hinweise des IoT-Anbieters. Technologie und Wirtschaft LoRaWAN in der Stadtbeleuchtung</a></li>
<li><a href="../de483794/index.html">Los geht's: warum solltest du nicht kontroffer nehmen</a></li>
<li><a href="../de483796/index.html">Optionale Parameter in Spring-Datenrepositorys</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>