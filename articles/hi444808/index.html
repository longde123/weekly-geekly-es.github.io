<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>тЫ┤я╕П тЫФя╕П ЁЯОЕЁЯП╜ рдлреНрд▓реИрдЧрд░ рдФрд░ рдЗрд╕реНрддрд┐рдпреЛ рдХреЗ рд╕рд╛рде рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдХреИрдирд░реА рдХреА рддреИрдирд╛рддреА ЁЯНТ ЁЯМЯ ЁЯСйтАНЁЯТ╝</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="рд╕реАрдбреА рдХреЛ рдЙрджреНрдпрдо рд╕реЙрдлреНрдЯрд╡реЗрдпрд░ рд╡рд┐рдХрд╛рд╕ рдЕрднреНрдпрд╛рд╕ рдХреЗ рд░реВрдк рдореЗрдВ рдорд╛рдиреНрдпрддрд╛ рдкреНрд░рд╛рдкреНрдд рд╣реИ, рдпрд╣ рд╕реНрдерд╛рдкрд┐рдд рд╕реАрдЖрдИ рд╕рд┐рджреНрдзрд╛рдВрддреЛрдВ рдХреЗ рдкреНрд░рд╛рдХреГрддрд┐рдХ рд╡рд┐рдХрд╛рд╕ рдХрд╛ рдкрд░рд┐рдгрд╛рдо рд╣реИред рд╣рд╛рд▓рд╛рдВрдХрд┐, рд╕реАрдбреА рдЕрднреА рднреА рдП...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>рдлреНрд▓реИрдЧрд░ рдФрд░ рдЗрд╕реНрддрд┐рдпреЛ рдХреЗ рд╕рд╛рде рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдХреИрдирд░реА рдХреА рддреИрдирд╛рддреА</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/southbridge/blog/444808/"><p><img src="https://habrastorage.org/webt/ol/eo/lt/oleoltogrvhcuhjuil5zmvmbpxi.png"></p><br><p>  рд╕реАрдбреА рдХреЛ рдЙрджреНрдпрдо рд╕реЙрдлреНрдЯрд╡реЗрдпрд░ рд╡рд┐рдХрд╛рд╕ рдЕрднреНрдпрд╛рд╕ рдХреЗ рд░реВрдк рдореЗрдВ рдорд╛рдиреНрдпрддрд╛ рдкреНрд░рд╛рдкреНрдд рд╣реИ, рдпрд╣ рд╕реНрдерд╛рдкрд┐рдд рд╕реАрдЖрдИ рд╕рд┐рджреНрдзрд╛рдВрддреЛрдВ рдХреЗ рдкреНрд░рд╛рдХреГрддрд┐рдХ рд╡рд┐рдХрд╛рд╕ рдХрд╛ рдкрд░рд┐рдгрд╛рдо рд╣реИред  рд╣рд╛рд▓рд╛рдВрдХрд┐, рд╕реАрдбреА рдЕрднреА рднреА рдПрдХ рджреБрд░реНрд▓рдн рдШрдЯрдирд╛ рд╣реИ, рд╕рдВрднрд╡рддрдГ рдкреНрд░рдмрдВрдзрди рдХреА рдЬрдЯрд┐рд▓рддрд╛ рдФрд░ рдЕрд╕рдлрд▓ рддреИрдирд╛рддреА рдХреЗ рдбрд░ рд╕реЗ рдЬреЛ рдЙрдкрд▓рдмреНрдзрддрд╛ рдХреЛ рдкреНрд░рднрд╛рд╡рд┐рдд рдХрд░рддреЗ рд╣реИрдВред </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдлреНрд▓реИрдЧрд░</a> рдПрдХ рдЦреБрд▓рд╛ рд╕реНрд░реЛрдд рдХреБрдмреЗрд░рдиреЗрдЯреНрд╕ рдСрдкрд░реЗрдЯрд░ рд╣реИ рдЬрд┐рд╕рдХрд╛ рдЙрджреНрджреЗрд╢реНрдп рднреНрд░рдорд┐рдд рд╕рдВрдмрдВрдзреЛрдВ рдХреЛ рдЦрддреНрдо рдХрд░рдирд╛ рд╣реИред  рдпрд╣ рдкреНрд░рдмрдВрдзрд┐рдд рд░реЛрд▓рдЖрдЙрдЯ рдХреЗ рджреМрд░рд╛рди рдПрдкреНрд▓рд┐рдХреЗрд╢рди рд╡реНрдпрд╡рд╣рд╛рд░ рдХрд╛ рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЗрд╕реНрддрд┐рдпреЛ рдЯреНрд░реИрдлрд╝рд┐рдХ рдСрдлрд╝рд╕реЗрдЯ рдФрд░ рдкреНрд░реЛрдореЗрдерд┐рдпрд╕ рдореЗрдЯреНрд░рд┐рдХреНрд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдХреИрдирд░реА рддреИрдирд╛рддреА рдХреЛ рдмрдврд╝рд╛рд╡рд╛ рджреЗрддрд╛ рд╣реИред </p><br><p>  рдиреАрдЪреЗ Google Kubernetes Engine (GKE) рдореЗрдВ рдлреНрд▓реИрдЧрд░ рдХреЛ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдФрд░ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рддрд░реАрдХреЗ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЪрд░рдг-рджрд░-рдЪрд░рдг рдорд╛рд░реНрдЧрджрд░реНрд╢рд┐рдХрд╛ рджреА рдЧрдИ рд╣реИред </p><a name="habracut"></a><br><h3 id="nastroyka-klastera-kubernetes">  Kubernetes рдХреНрд▓рд╕реНрдЯрд░ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░реЗрдВ </h3><br><p>  рдЖрдк рдПрдХ рдЗрд╕реНрддрд┐рдпреЛ рдРрдб-рдЗрди (рдпрджрд┐ рдЖрдкрдХреЗ рдкрд╛рд╕ рдЬреАрд╕реАрдкреА рдЦрд╛рддрд╛ рдирд╣реАрдВ рд╣реИ, рддреЛ рдЖрдк рдореБрдлреНрдд рдХреНрд░реЗрдбрд┐рдЯ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдпрд╣рд╛рдВ</a> рдкрдВрдЬреАрдХрд░рдг рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ) рдХреЗ рд╕рд╛рде рдПрдХ рдЬреАрдХреЗрдЖрд░ рдХреНрд▓рд╕реНрдЯрд░ рдмрдирд╛рдХрд░ рд╢реБрд░реВ рдХрд░рддреЗ рд╣реИрдВред </p><br><p> Google рдХреНрд▓рд╛рдЙрдб рдореЗрдВ рд▓реЙрдЧ рдЗрди рдХрд░реЗрдВ, рдПрдХ рдкреНрд░реЛрдЬреЗрдХреНрдЯ рдмрдирд╛рдПрдВ рдФрд░ рдЗрд╕рдХреЗ рд▓рд┐рдП рдмрд┐рд▓рд┐рдВрдЧ рд╕рдХреНрд╖рдо рдХрд░реЗрдВред  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">Gcloud</a> рдХрдорд╛рдВрдб рд▓рд╛рдЗрди <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдЙрдкрдпреЛрдЧрд┐рддрд╛</a> рд╕реНрдерд╛рдкрд┐рдд рдХрд░реЗрдВ рдФрд░ <code>gcloud init</code> рд╕рд╛рде рдЕрдкрдиреА рдкрд░рд┐рдпреЛрдЬрдирд╛ рдХреЛ рдЕрдиреБрдХреВрд▓рд┐рдд рдХрд░реЗрдВред </p><br><p>  рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдкреНрд░реЛрдЬреЗрдХреНрдЯ, рдЧрдгрдирд╛ рдХреНрд╖реЗрддреНрд░ рдФрд░ рдХреНрд╖реЗрддреНрд░ рд╕реЗрдЯ рдХрд░реЗрдВ (рдЕрдкрдиреА рдкрд░рд┐рдпреЛрдЬрдирд╛ рдХреЗ рд╕рд╛рде <code>PROJECT_ID</code> рдХреЛ рдмрджрд▓реЗрдВ): </p><br><pre> <code class="plaintext hljs">gcloud config set project PROJECT_ID gcloud config set compute/region us-central1 gcloud config set compute/zone us-central1-a</code> </pre> <br><p>  GKE рд╕реЗрд╡рд╛ рд╕рдХреНрд╖рдо рдХрд░реЗрдВ рдФрд░ HPA рдФрд░ Istio рдРрдб-рдСрди рдХреЗ рд╕рд╛рде рдПрдХ рдХреНрд▓рд╕реНрдЯрд░ рдмрдирд╛рдПрдВ: </p><br><pre> <code class="plaintext hljs">gcloud services enable container.googleapis.com K8S_VERSION=$(gcloud beta container get-server-config --format=json | jq -r '.validMasterVersions[0]') gcloud beta container clusters create istio \ --cluster-version=${K8S_VERSION} \ --zone=us-central1-a \ --num-nodes=2 \ --machine-type=n1-standard-2 \ --disk-size=30 \ --enable-autorepair \ --no-enable-cloud-logging \ --no-enable-cloud-monitoring \ --addons=HorizontalPodAutoscaling,Istio \ --istio-config=auth=MTLS_PERMISSIVE</code> </pre> <br><p>  рдЙрдкрд░реЛрдХреНрдд рдХрдорд╛рдВрдб рдПрдХ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдиреЛрдб рдкреВрд▓ рдмрдирд╛рдПрдЧрд╛ рдЬрд┐рд╕рдореЗрдВ рджреЛ VMs <code>n1-standard-2</code> (vCPU: 2, RAM 7.5 GB, рдбрд┐рд╕реНрдХ: 30 GB) рд╢рд╛рдорд┐рд▓ рд╣реИрдВред  рдЖрджрд░реНрд╢ рд░реВрдк рд╕реЗ, рдЖрдкрдХреЛ рдЕрдкрдиреЗ рдХрд╛рд░реНрдпрднрд╛рд░ рд╕реЗ Istio рдШрдЯрдХреЛрдВ рдХреЛ рдЕрд▓рдЧ рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдП, рд▓реЗрдХрд┐рди рд╕рдорд░реНрдкрд┐рдд рдиреЛрдб рдкреВрд▓ рдореЗрдВ Istio рдкреЙрдбреНрд╕ рдХреЛ рдЪрд▓рд╛рдиреЗ рдХрд╛ рдХреЛрдИ рдЖрд╕рд╛рди рддрд░реАрдХрд╛ рдирд╣реАрдВ рд╣реИред  рдЗрд╕реНрддрд┐рдпреЛ рдореЗрдирд┐рдлреЗрд╕реНрдЯреЛрдВ рдХреЛ рдХреЗрд╡рд▓-рдкрдврд╝рдиреЗ рдХреЗ рд▓рд┐рдП рдорд╛рдирд╛ рдЬрд╛рддрд╛ рд╣реИ, рдФрд░ рдЬреАрдХреЗрдИ рдХрд┐рд╕реА рднреА рдмрджрд▓рд╛рд╡ рдХреЛ рдкреВрд░реНрд╡рд╡рдд рдХрд░ рджреЗрдЧрд╛, рдЬреИрд╕реЗ рдХрд┐ рдиреЛрдб рдХреЗ рд▓рд┐рдП рдмрд╛рдзреНрдп рдХрд░рдирд╛ рдпрд╛ рдЪреВрд▓реНрд╣рд╛ рд╕реЗ рдбрд┐рд╕реНрдХрдиреЗрдХреНрдЯ рдХрд░рдирд╛ред </p><br><p>  <code>kubectl</code> рд▓рд┐рдП рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░реЗрдВ: </p><br><pre> <code class="plaintext hljs">gcloud container clusters get-credentials istio</code> </pre> <br><p>  рдХреНрд▓рд╕реНрдЯрд░ рд╡реНрдпрд╡рд╕реНрдерд╛рдкрдХ рд░реЛрд▓ рдмрд╛рдЗрдВрдбрд┐рдВрдЧ рдмрдирд╛рдПрдБ: </p><br><pre> <code class="plaintext hljs">kubectl create clusterrolebinding "cluster-admin-$(whoami)" \ --clusterrole=cluster-admin \ --user="$(gcloud config get-value core/account)"</code> </pre> <br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рд╣реЗрд▓реНрдо</a> рдХрдорд╛рдВрдб рд▓рд╛рдЗрди рдЯреВрд▓ рдЗрдВрд╕реНрдЯреЙрд▓ рдХрд░реЗрдВ: </p><br><pre> <code class="plaintext hljs">brew install kubernetes-helm</code> </pre> <br><p>  Homebrew 2.0 рдЕрдм <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рд▓рд┐рдирдХреНрд╕ рдХреЗ</a> рд▓рд┐рдП рднреА рдЙрдкрд▓рдмреНрдз рд╣реИред </p><br><p>  рдЯрд┐рд▓рд░ рдХреЗ рд▓рд┐рдП рдПрдХ рд╕реЗрд╡рд╛ рдЦрд╛рддрд╛ рдФрд░ рдХреНрд▓рд╕реНрдЯрд░ рд░реЛрд▓ рдмрд╛рдЗрдВрдбрд┐рдВрдЧ рдмрдирд╛рдПрдБ: </p><br><pre> <code class="plaintext hljs">kubectl -n kube-system create sa tiller &amp;&amp; \ kubectl create clusterrolebinding tiller-cluster-rule \ --clusterrole=cluster-admin \ --serviceaccount=kube-system:tiller</code> </pre> <br><p>  <code>kube-system</code> рдореЗрдВ рдЯрд┐рд▓рд░ рдХрд╛ рд╡рд┐рд╕реНрддрд╛рд░ рдХрд░реЗрдВ: </p><br><pre> <code class="plaintext hljs">helm init --service-account tiller</code> </pre> <br><p>  рдЖрдкрдХреЛ рд╣реЗрд▓реНрдо рдФрд░ рдЯрд┐рд▓рд░ рдХреЗ рдмреАрдЪ рдПрд╕рдПрд╕рдПрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдкрд░ рд╡рд┐рдЪрд╛рд░ рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдПред  рд╣реЗрд▓реНрдо рдЗрдВрд╕реНрдЯреЙрд▓реЗрд╢рди рд╣рд╛рд╕рд┐рд▓ рдХрд░рдиреЗ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдбреЙрдХреНрд╕</a> </p><br><p>  рд╕реЗрдЯрд┐рдВрдЧреНрд╕ рдХреА рдкреБрд╖реНрдЯрд┐ рдХрд░реЗрдВ: </p><br><pre> <code class="plaintext hljs">kubectl -n istio-system get svc</code> </pre> <br><p>  рдХреБрдЫ рд╕реЗрдХрдВрдб рдХреЗ рдмрд╛рдж, GCP рдХреЛ <code>istio-ingressgateway</code> рд▓рд┐рдП рдПрдХ рдмрд╛рд╣рд░реА IP рдкрддрд╛ рдЕрд╕рд╛рдЗрди рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдПред </p><br><h3 id="nastroyka-vhodnogo-shlyuza-istio">  рдЗрд╕реНрддрд┐рдпреЛ рдЗрдирдкреБрдЯ рдЧреЗрдЯрд╡реЗ рд╕реЗрдЯрдЕрдк </h3><br><p>  <code>istio-gateway</code> рдХреЗ рдЖрдИрдкреА рдкрддреЗ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ <code>istio-gateway</code> рдирд╛рдордХ рдПрдХ рд╕реНрдерд┐рд░ IP рдкрддрд╛ рдмрдирд╛рдПрдБ: </p><br><pre> <code class="plaintext hljs">export GATEWAY_IP=$(kubectl -n istio-system get svc/istio-ingressgateway -ojson | jq -r .status.loadBalancer.ingress[0].ip) gcloud compute addresses create istio-gateway --addresses ${GATEWAY_IP} --region us-central1</code> </pre> <br><p>  рдЕрдм рдЖрдкрдХреЛ рдПрдХ рдЗрдВрдЯрд░рдиреЗрдЯ рдбреЛрдореЗрди рдФрд░ рдЕрдкрдиреЗ DNS рд░рдЬрд┐рд╕реНрдЯреНрд░рд╛рд░ рддрдХ рдкрд╣реБрдВрдЪ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред  рджреЛ A рдкреНрд░рд╡рд┐рд╖реНрдЯрд┐рдпрд╛рдБ рдЬреЛрдбрд╝реЗрдВ ( <code>example.com</code> рдХреЛ рдЕрдкрдиреЗ рдбреЛрдореЗрди рдХреЗ рд╕рд╛рде рдмрджрд▓реЗрдВ): </p><br><pre> <code class="plaintext hljs">istio.example.com A ${GATEWAY_IP} *.istio.example.com A ${GATEWAY_IP}</code> </pre> <br><p>  рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░реЗрдВ рдХрд┐ DNS рд╡рд╛рдЗрд▓реНрдбрдХрд╛рд░реНрдб рдХрд╛рдо рдХрд░ рд░рд╣рд╛ рд╣реИ: </p><br><pre> <code class="plaintext hljs">watch host test.istio.example.com</code> </pre> <br><p>  HTTP рдкрд░ рд╕реЗрд╡рд╛ рдЬрд╛рд▓ рдХреЗ рдмрд╛рд╣рд░ рд╕реЗрд╡рд╛рдПрдВ рдкреНрд░рджрд╛рди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рд╕рд╛рдорд╛рдиреНрдп рд╕рд╛рдорд╛рдиреНрдп рдЧреЗрдЯрд╡реЗ рдмрдирд╛рдПрдБ: </p><br><pre> <code class="plaintext hljs">apiVersion: networking.istio.io/v1alpha3 kind: Gateway metadata: name: public-gateway namespace: istio-system spec: selector: istio: ingressgateway servers: - port: number: 80 name: http protocol: HTTP hosts: - "*"</code> </pre> <br><p>  рдЙрдкрд░реЛрдХреНрдд рд╕рдВрд╕рд╛рдзрди рдХреЛ public-gateway.yaml рдХреЗ рд░реВрдк рдореЗрдВ рд╕рд╣реЗрдЬреЗрдВ рдФрд░ рдлрд┐рд░ рдЗрд╕реЗ рд▓рд╛рдЧреВ рдХрд░реЗрдВ: </p><br><pre> <code class="plaintext hljs">kubectl apply -f ./public-gateway.yaml</code> </pre> <br><p>  рдПрд╕рдПрд╕рдПрд▓ рдХреЗ рдмрд┐рдирд╛ рдХрд┐рд╕реА рднреА рдЙрддреНрдкрд╛рджрди рдкреНрд░рдгрд╛рд▓реА рдХреЛ рдЗрдВрдЯрд░рдиреЗрдЯ рдкрд░ рд╕реЗрд╡рд╛рдПрдВ рдирд╣реАрдВ рджреЗрдиреА рдЪрд╛рд╣рд┐рдПред  рдкреНрд░рдорд╛рдгрд┐рдд рдкреНрд░рдмрдВрдзрдХ, CloudDNS рдФрд░ рд▓реЗрдЯреНрд╕ рдПрдирдХреНрд░рд┐рдкреНрдЯ рдХреЗ рд╕рд╛рде Istio рдЧреЗрдЯрд╡реЗ рдХреА рд╕реБрд░рдХреНрд╖рд╛ рдХреЗ рд▓рд┐рдП, рдХреГрдкрдпрд╛ рдлреНрд▓реИрдЧрд░ GKE <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдкреНрд░рд▓реЗрдЦрди</a> рдкрдврд╝реЗрдВред </p><br><h3 id="ustanovka-flagger">  рдзреНрд╡рдЬ рд╕реНрдерд╛рдкрдирд╛ </h3><br><p>  GKE Istio рдРрдб-рдЗрди рдореЗрдВ Prometheus рдЙрджрд╛рд╣рд░рдг рд╢рд╛рдорд┐рд▓ рдирд╣реАрдВ рд╣реИ, рдЬреЛ Istio рдЯреЗрд▓реАрдореЗрдЯреНрд░реА рд╕реЗрд╡рд╛ рдХреЛ рд╕рд╛рдлрд╝ рдХрд░рддрд╛ рд╣реИред  рдЪреВрдБрдХрд┐ рдлреНрд▓реИрдЧрд░ рдХреИрдирд░реА рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЗрд╕реНрддрд┐рдпреЛ HTTP рдореЗрдЯреНрд░рд┐рдХреНрд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЖрдкрдХреЛ рдЖрдзрд┐рдХрд╛рд░рд┐рдХ рдЗрд╕реНрддрд┐рдпреЛ рд╣реЗрд▓рдо рдпреЛрдЬрдирд╛ рдХреЗ рд╕рд╛рде рдЖрдкреВрд░реНрддрд┐ рдХрд┐рдП рдЧрдП рд╕рдорд╛рди рдкреНрд░реЛрдореЗрдерд┐рдпрд╕ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреЛ рддреИрдирд╛рдд рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред </p><br><pre> <code class="plaintext hljs">REPO=https://raw.githubusercontent.com/stefanprodan/flagger/master kubectl apply -f ${REPO}/artifacts/gke/istio-prometheus.yaml</code> </pre> <br><p>  рдлреНрд▓реИрдЧрд░ рд╣реЗрд▓реНрдо рднрдВрдбрд╛рд░ рдЬреЛрдбрд╝реЗрдВ: </p><br><pre> <code class="plaintext hljs">helm repo add flagger https://flagger.app</code> </pre> <br><p>  рд╕реБрд╕реНрдд рд╕реВрдЪрдирд╛рдУрдВ <code>istio-system</code> рд╕рдХреНрд╖рдо <code>istio-system</code> istio -system <code>istio-system</code> рдореЗрдВ рдлреНрд▓реИрдЧрд░ рдХрд╛ рд╡рд┐рд╕реНрддрд╛рд░ рдХрд░реЗрдВ: </p><br><pre> <code class="plaintext hljs">helm upgrade -i flagger flagger/flagger \ --namespace=istio-system \ --set metricsServer=http://prometheus.istio-system:9090 \ --set slack.url=https://hooks.slack.com/services/YOUR-WEBHOOK-ID \ --set slack.channel=general \ --set slack.user=flagger</code> </pre> <br><p>  рдЖрдк рдХрд┐рд╕реА рднреА рдирд╛рдорд╕реНрдерд╛рди рдореЗрдВ рдлреНрд▓реИрдЧрд░ рд╕реНрдерд╛рдкрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдпрджрд┐ рдпрд╣ рдкреЛрд░реНрдЯ 9090 рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЗрд╕реНрддрд┐рдпреЛ рдкреНрд░реЛрдореЗрдерд┐рдпрд╕ рд╕реЗрд╡рд╛ рдХреЗ рд╕рд╛рде рд╕рдВрд╡рд╛рдж рдХрд░ рд╕рдХрддрд╛ рд╣реИред </p><br><p>  рдзреНрд╡рдЬрд╡рд╛рд╣рдХ рдХреЗ рдкрд╛рд╕ рдХреИрдирд░реА рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдХреЗ рд▓рд┐рдП рдЧреНрд░рд╛рдлрд╛рдирд╛ рдбреИрд╢рдмреЛрд░реНрдб рд╣реИред  Grafana рдХреЛ <code>istio-system</code> рдореЗрдВ рд╕реНрдерд╛рдкрд┐рдд рдХрд░реЗрдВ: </p><br><pre> <code class="plaintext hljs">helm upgrade -i flagger-grafana flagger/grafana \ --namespace=istio-system \ --set url=http://prometheus.istio-system:9090 \ --set user=admin \ --set password=change-me</code> </pre> <br><p>  рдПрдХ рдЖрднрд╛рд╕реА рд╕реЗрд╡рд╛ (рдЕрдкрдиреЗ рдбреЛрдореЗрди рдХреЗ рд╕рд╛рде <code>example.com</code> рдкреНрд░рддрд┐рд╕реНрдерд╛рдкрд┐рдд рдХрд░реЗрдВ) рдмрдирд╛рдХрд░ рдПрдХ рдЦреБрд▓реЗ рдкреНрд░рд╡реЗрд╢ рджреНрд╡рд╛рд░ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЧреНрд░рд╛рдлреНрдЯрд╛рдирд╛ рдХрд╛ рд╡рд┐рд╕реНрддрд╛рд░ рдХрд░реЗрдВ: </p><br><pre> <code class="plaintext hljs">apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: grafana namespace: istio-system spec: hosts: - "grafana.istio.example.com" gateways: - public-gateway.istio-system.svc.cluster.local http: - route: - destination: host: flagger-grafana</code> </pre> <br><p>  рдЙрдкрд░реЛрдХреНрдд рд╕рдВрд╕рд╛рдзрди рдХреЛ grafana-virtual-service.yaml рдХреЗ рд░реВрдк рдореЗрдВ рд╕рд╣реЗрдЬреЗрдВ рдФрд░ рдлрд┐рд░ рдЗрд╕реЗ рд▓рд╛рдЧреВ рдХрд░реЗрдВ: </p><br><pre> <code class="plaintext hljs">kubectl apply -f ./grafana-virtual-service.yaml</code> </pre> <br><p>  рдЬрдм рдЖрдк рдХрд┐рд╕реА рдмреНрд░рд╛рдЙрдЬрд╝рд░ рдореЗрдВ <code>http://grafana.istio.example.com</code> рдЬрд╛рддреЗ рд╣реИрдВ, рддреЛ рдЖрдкрдХреЛ Grafana рд▓реЙрдЧрд┐рди рдкреГрд╖реНрда рдкрд░ рдирд┐рд░реНрджреЗрд╢рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдПред </p><br><h3 id="deploy-veb-prilozheniy-s-flagger">  рдлреНрд▓реИрдЧрд░ рдХреЗ рд╕рд╛рде рд╡реЗрдм рдЕрдиреБрдкреНрд░рдпреЛрдЧ рдкрд░рд┐рдирд┐рдпреЛрдЬрди </h3><br><p>  рдлреНрд▓реИрдЧрд░ рдХреБрдмреЗрд░рдиреЗрдЯреНрд╕ рдХреЛ рдЪрд┐рддреНрд░рд┐рдд рдХрд░рддрд╛ рд╣реИ рдФрд░, рдпрджрд┐ рдЖрд╡рд╢реНрдпрдХ рд╣реЛ, рдХреНрд╖реИрддрд┐рдЬ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд╕реНрдХреЗрд▓рд┐рдВрдЧ (рдПрдЪрдкреАрдП), рддреЛ рд╡рд╕реНрддреБрдУрдВ рдХреА рдПрдХ рд╢реНрд░реГрдВрдЦрд▓рд╛ рдмрдирд╛рддрд╛ рд╣реИ (рдХреБрдмреЗрд░рдиреЗрдЯреНрд╕ рддреИрдирд╛рддреА, рдХреНрд▓рд╕реНрдЯрд░ рд╕реЗрд╡рд╛ рдФрд░ рдЗрд╕реНрддрд┐рдпреЛ рдЖрднрд╛рд╕реА рд╕реЗрд╡рд╛рдПрдВ)ред  рдпреЗ рдСрдмреНрдЬреЗрдХреНрдЯ рд╕реЗрд╡рд╛ рдЬрд╛рд▓ рдореЗрдВ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдЦреЛрд▓рддреЗ рд╣реИрдВ рдФрд░ рдХреИрдирд░реА рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдФрд░ рдкреНрд░рдЪрд╛рд░ рдХрд╛ рдкреНрд░рдмрдВрдзрди рдХрд░рддреЗ рд╣реИрдВред </p><br><p> <a href=""><img src="https://habrastorage.org/webt/la/cg/h5/lacgh59saaxevwtpgoiby77xe7u.png"></a> </p><br><p>  Istio Sidecar рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рд╕рдХреНрд╖рдо рд╣реЛрдиреЗ рдХреЗ рд╕рд╛рде рдПрдХ рдЯреЗрд╕реНрдЯ рдиреЗрдорд╕реНрдкреЗрд╕ рдмрдирд╛рдПрдВ: </p><br><pre> <code class="plaintext hljs">REPO=https://raw.githubusercontent.com/stefanprodan/flagger/master kubectl apply -f ${REPO}/artifacts/namespaces/test.yaml</code> </pre> <br><p>  рдПрдХ рддреИрдирд╛рддреА рдФрд░ рдЪреВрд▓реНрд╣рд╛ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдХреНрд╖реИрддрд┐рдЬ рд╕реНрдХреЗрд▓рд┐рдВрдЧ рдЯреВрд▓ рдмрдирд╛рдПрдВ: </p><br><pre> <code class="plaintext hljs">kubectl apply -f ${REPO}/artifacts/canaries/deployment.yaml kubectl apply -f ${REPO}/artifacts/canaries/hpa.yaml</code> </pre> <br><p>  рдХреИрдирд░реА рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдХреЗ рджреМрд░рд╛рди рдЯреНрд░реИрдлрд╝рд┐рдХ рдЙрддреНрдкрдиреНрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдкрд░реАрдХреНрд╖рдг рд▓реЛрдб рд╕реЗрд╡рд╛ рддреИрдирд╛рдд рдХрд░реЗрдВ: </p><br><pre> <code class="plaintext hljs">helm upgrade -i flagger-loadtester flagger/loadtester \ --namepace=test</code> </pre> <br><p>  рдПрдХ рдХрд╕реНрдЯрдо рдХреИрдирд░реА рд╕рдВрд╕рд╛рдзрди рдмрдирд╛рдПрдВ ( <code>example.com</code> рдХреЛ рдЕрдкрдиреЗ рдбреЛрдореЗрди рд╕реЗ рдмрджрд▓реЗрдВ): </p><br><pre> <code class="plaintext hljs">apiVersion: flagger.app/v1alpha3 kind: Canary metadata: name: podinfo namespace: test spec: targetRef: apiVersion: apps/v1 kind: Deployment name: podinfo progressDeadlineSeconds: 60 autoscalerRef: apiVersion: autoscaling/v2beta1 kind: HorizontalPodAutoscaler name: podinfo service: port: 9898 gateways: - public-gateway.istio-system.svc.cluster.local hosts: - app.istio.example.com canaryAnalysis: interval: 30s threshold: 10 maxWeight: 50 stepWeight: 5 metrics: - name: istio_requests_total threshold: 99 interval: 30s - name: istio_request_duration_seconds_bucket threshold: 500 interval: 30s webhooks: - name: load-test url: http://flagger-loadtester.test/ timeout: 5s metadata: cmd: "hey -z 1m -q 10 -c 2 http://podinfo.test:9898/"</code> </pre> <br><p>  рдЙрдкрд░реЛрдХреНрдд рд╕рдВрд╕рд╛рдзрди рдХреЛ podinfo-canary.yaml рдХреЗ рд░реВрдк рдореЗрдВ рд╕рд╣реЗрдЬреЗрдВ рдФрд░ рдлрд┐рд░ рдЗрд╕реЗ рд▓рд╛рдЧреВ рдХрд░реЗрдВ: </p><br><pre> <code class="plaintext hljs">kubectl apply -f ./podinfo-canary.yaml</code> </pre> <br><p>  рдЙрдкрд░реЛрдХреНрдд рд╡рд┐рд╢реНрд▓реЗрд╖рдг, рдпрджрд┐ рд╕рдлрд▓ рд╣реБрдЖ, рддреЛ рд╣рд░ рдЖрдзреЗ рдорд┐рдирдЯ рдореЗрдВ HTTP рдореЗрдЯреНрд░рд┐рдХреНрд╕ рдХреА рдЬрд╛рдБрдЪ рдкрд╛рдБрдЪ рдорд┐рдирдЯ рдХреЗ рднреАрддрд░ рдХреА рдЬрд╛рдПрдЧреАред  рдЖрдк рдирд┐рдореНрди рд╕реВрддреНрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ рдХреИрдирд░реА рддреИрдирд╛рддреА рдХреЛ рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░рдиреЗ рдФрд░ рдмрдврд╝рд╛рд╡рд╛ рджреЗрдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рдиреНрдпреВрдирддрдо рд╕рдордп рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ: <code>interval * (maxWeight / stepWeight)</code> ред  рдХреИрдирд░реА CRD рдлрд╝реАрд▓реНрдб <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдпрд╣рд╛рдБ</a> рдкреНрд░рд▓реЗрдЦрд┐рдд <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рд╣реИрдВ</a> ред </p><br><p>  рдХреБрдЫ рд╕реЗрдХрдВрдб рдореЗрдВ, рдлреНрд▓реИрдЧрд░ рдХреИрдирд░реА рдСрдмреНрдЬреЗрдХреНрдЯ рдмрдирд╛ рджреЗрдЧрд╛: </p><br><pre> <code class="plaintext hljs"># applied deployment.apps/podinfo horizontalpodautoscaler.autoscaling/podinfo canary.flagger.app/podinfo # generated deployment.apps/podinfo-primary horizontalpodautoscaler.autoscaling/podinfo-primary service/podinfo service/podinfo-canary service/podinfo-primary virtualservice.networking.istio.io/podinfo</code> </pre> <br><p>  рдПрдХ рдмреНрд░рд╛рдЙрдЬрд╝рд░ рдЦреЛрд▓реЗрдВ рдФрд░ <code>app.istio.example.com</code> рдкрд░ <code>app.istio.example.com</code> , рдЖрдкрдХреЛ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдбреЗрдореЛ рдПрдкреНрд▓рд┐рдХреЗрд╢рди</a> рдХрд╛ рд╕рдВрд╕реНрдХрд░рдг рдирдВрдмрд░ рджреЗрдЦрдирд╛ рдЪрд╛рд╣рд┐рдПред </p><br><h3 id="avtomaticheskiy-canary-analiz-i-prodvizhenie">  рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдХреИрдирд░реА рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдФрд░ рд╕рдВрд╡рд░реНрдзрди </h3><br><p>  рдлрд╝реНрд▓реИрдЧрд░ рдПрдХ рдирд┐рдпрдВрддреНрд░рдг рд▓реВрдк рдХреЛ рд▓рд╛рдЧреВ рдХрд░рддрд╛ рд╣реИ рдЬреЛ рдзреАрд░реЗ-рдзреАрд░реЗ рдХреИрдирд░реА рдкрд░ рдЬрд╛рддрд╛ рд╣реИ, рдЬрдмрдХрд┐ рдкреНрд░рдореБрдЦ рдкреНрд░рджрд░реНрд╢рди рд╕рдВрдХреЗрддрдХ рдорд╛рдкрддреЗ рд╣реИрдВ, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, HTTP рдЕрдиреБрд░реЛрдзреЛрдВ рдХреА рд╕рдлрд▓рддрд╛ рджрд░, рдЕрдиреБрд░реЛрдзреЛрдВ рдХреА рдФрд╕рдд рдЕрд╡рдзрд┐ рдФрд░ рдЪреВрд▓реНрд╣рд╛ рдХрд╛ рдкреНрд░рджрд░реНрд╢рдиред  рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдХреЗ рдЖрдзрд╛рд░ рдкрд░, KPI рдХреИрдирд░реА рдкреНрд░рдЧрддрд┐ рдпрд╛ рдмрд╛рдзрд┐рдд рд╣реЛрддреА рд╣реИ, рдФрд░ рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдкрд░рд┐рдгрд╛рдо рд╕реНрд▓реИрдХ рдореЗрдВ рдкреНрд░рдХрд╛рд╢рд┐рдд рд╣реЛрддреЗ рд╣реИрдВред </p><br><p> <a href=""><img src="https://habrastorage.org/webt/bw/85/ua/bw85uavib13od3yhfyv7yaqbdmo.png"></a> </p><br><p>  рдХреИрдирд░реА рдкрд░рд┐рдирд┐рдпреЛрдЬрди рддрдм рд╢реБрд░реВ рд╣реЛрддрд╛ рд╣реИ рдЬрдм рдирд┐рдореНрди рдореЗрдВ рд╕реЗ рдПрдХ рд╡рд╕реНрддреБ рдмрджрд▓рддреА рд╣реИ: </p><br><ul><li>  рдкреЙрдбрд╕реНрдкреАрдХ (рдХрдВрдЯреЗрдирд░ рдЫрд╡рд┐, рдХрдорд╛рдВрдб, рдкреЛрд░реНрдЯ, рдПрдирд╡реА, рдЖрджрд┐) рддреИрдирд╛рдд рдХрд░реЗрдВ </li><li>  ConfigMaps рд╡реЙрд▓реНрдпреВрдо рдХреЗ рд░реВрдк рдореЗрдВ рдорд╛рдЙрдВрдЯ рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВ рдпрд╛ рдкрд░реНрдпрд╛рд╡рд░рдг рдЪрд░ рдореЗрдВ рдкрд░рд┐рд╡рд░реНрддрд┐рдд рд╣реЛрддреЗ рд╣реИрдВ </li><li>  рдЧреЛрдкрдиреАрдпрддрд╛ рдХреЛ рд╕рдВрд╕реНрдХрд░рдгреЛрдВ рдХреЗ рд░реВрдк рдореЗрдВ рдорд╛рдЙрдВрдЯ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдпрд╛ рдкрд░реНрдпрд╛рд╡рд░рдг рдЪрд░ рдореЗрдВ рдкрд░рд┐рд╡рд░реНрддрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ </li></ul><br><p>  рдХрдВрдЯреЗрдирд░ рдЫрд╡рд┐ рдХреЛ рдЕрдкрдбреЗрдЯ рдХрд░рддреЗ рд╕рдордп рдПрдХ рдХреИрдирд░реА рддреИрдирд╛рддреА рд╢реБрд░реВ рдХрд░рдирд╛: </p><br><pre> <code class="plaintext hljs">kubectl -n test set image deployment/podinfo \ podinfod=quay.io/stefanprodan/podinfo:1.4.1</code> </pre> <br><p>  рдлреНрд▓реИрдЧрд░ рдХреЛ рдкрддрд╛ рдЪрд▓рддрд╛ рд╣реИ рдХрд┐ рддреИрдирд╛рддреА рдХрд╛ рд╕рдВрд╕реНрдХрд░рдг рдмрджрд▓ рдЧрдпрд╛ рд╣реИ, рдФрд░ рдЗрд╕рдХрд╛ рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдХрд░рдирд╛ рд╢реБрд░реВ рдХрд░рддрд╛ рд╣реИ: </p><br><pre> <code class="plaintext hljs">kubectl -n test describe canary/podinfo Events: New revision detected podinfo.test Scaling up podinfo.test Waiting for podinfo.test rollout to finish: 0 of 1 updated replicas are available Advance podinfo.test canary weight 5 Advance podinfo.test canary weight 10 Advance podinfo.test canary weight 15 Advance podinfo.test canary weight 20 Advance podinfo.test canary weight 25 Advance podinfo.test canary weight 30 Advance podinfo.test canary weight 35 Advance podinfo.test canary weight 40 Advance podinfo.test canary weight 45 Advance podinfo.test canary weight 50 Copying podinfo.test template spec to podinfo-primary.test Waiting for podinfo-primary.test rollout to finish: 1 of 2 updated replicas are available Promotion completed! Scaling down podinfo.test</code> </pre> <br><p>  рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдХреЗ рджреМрд░рд╛рди, рдХреИрдирд░реА рдкрд░рд┐рдгрд╛рдореЛрдВ рдХреЛ рдЧреНрд░рд╛рдлрд╛рдирд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЯреНрд░реИрдХ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ: </p><br><p> <a href=""><img src="https://habrastorage.org/webt/so/xr/cr/soxrcrt3wvsgtnbwpukfwbzityy.png"></a> </p><br><p>  рдХреГрдкрдпрд╛ рдзреНрдпрд╛рди рджреЗрдВ: рдпрджрд┐ рдХреИрдирд░реА рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдХреЗ рджреМрд░рд╛рди рддреИрдирд╛рддреА рдореЗрдВ рдирдП рдкрд░рд┐рд╡рд░реНрддрди рд▓рд╛рдЧреВ рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВ, рддреЛ рдлреНрд▓реИрдЧрд░ рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдЪрд░рдг рдХреЛ рдлрд┐рд░ рд╕реЗ рд╢реБрд░реВ рдХрд░реЗрдЧрд╛ред </p><br><p>  рдЕрдкрдиреЗ рдХреНрд▓рд╕реНрдЯрд░ рдореЗрдВ рд╕рднреА "рдХреИрдирд░реА" рдХреА рдПрдХ рд╕реВрдЪреА рдмрдирд╛рдПрдВ: </p><br><pre> <code class="plaintext hljs">watch kubectl get canaries --all-namespaces NAMESPACE NAME STATUS WEIGHT LASTTRANSITIONTIME test podinfo Progressing 15 2019-01-16T14:05:07Z prod frontend Succeeded 0 2019-01-15T16:15:07Z prod backend Failed 0 2019-01-14T17:05:07Z</code> </pre> <br><p>  рдпрджрд┐ рдЖрдкрдиреЗ рд╕реБрд╕реНрдд рд╕реВрдЪрдирд╛рдПрдВ рд╕рдХреНрд╖рдо рдХреА рд╣реИрдВ, рддреЛ рдЖрдкрдХреЛ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╕рдВрджреЗрд╢ рдкреНрд░рд╛рдкреНрдд рд╣реЛрдВрдЧреЗ: </p><br><p> <a href=""><img src="https://habrastorage.org/webt/xx/0v/cn/xx0vcnpcarb8nb3xivkmfz_6pfw.png"></a> </p><br><h3 id="avtomaticheskiy-otkat">  рдСрдЯреЛ рд░реЛрд▓рдмреИрдХ </h3><br><p>  рдХреИрдирд░реА рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдХреЗ рджреМрд░рд╛рди, рдЖрдк рд╕рд┐рдВрдереЗрдЯрд┐рдХ HTTP 500 рддреНрд░реБрдЯрд┐рдпреЛрдВ рдХреЛ рдЙрддреНрдкрдиреНрди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдпрд╣ рдЬрд╛рдВрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдЙрдЪреНрдЪ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рд╡рд┐рд▓рдВрдм рдЙрддреНрдкрдиреНрди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдХреНрдпрд╛ рдлреНрд▓реИрдЧрд░ рддреИрдирд╛рддреА рдХреЛ рд░реЛрдХ рджреЗрдЧрд╛ред </p><br><p>  рдПрдХ рдкрд░реАрдХреНрд╖рдг рдЙрдк рдмрдирд╛рдПрдБ рдФрд░ рдЗрд╕рдореЗрдВ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХрд░реЗрдВ: </p><br><pre> <code class="plaintext hljs">kubectl -n test run tester \ --image=quay.io/stefanprodan/podinfo:1.2.1 \ -- ./podinfo --port=9898 kubectl -n test exec -it tester-xx-xx sh</code> </pre> <br><p>  HTTP 500 рддреНрд░реБрдЯрд┐ рдЬрдирд░реЗрд╢рди: </p><br><pre> <code class="plaintext hljs">watch curl http://podinfo-canary:9898/status/500</code> </pre> <br><p>  рд╡рд┐рд▓рдВрдм рдЬрдирд░реЗрд╢рди: </p><br><pre> <code class="plaintext hljs">watch curl http://podinfo-canary:9898/delay/1</code> </pre> <br><p>  рдЬрдм рдЕрд╕рдлрд▓ рдЪреЗрдХреЛрдВ рдХреА рд╕рдВрдЦреНрдпрд╛ рдереНрд░реЗрд╢реЛрд▓реНрдб рдорд╛рди рддрдХ рдкрд╣реБрдБрдЪ рдЬрд╛рддреА рд╣реИ, рддреЛ рдЯреНрд░реИрдлрд╝рд┐рдХ рдХреЛ рдкреНрд░рд╛рдердорд┐рдХ рдЪреИрдирд▓ рдкрд░ рд╡рд╛рдкрд╕ рднреЗрдЬрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдХреИрдирд░реА рдХреЛ рд╢реВрдиреНрдп рдкрд░ рд╕реНрдХреЗрд▓ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдФрд░ рдкрд░рд┐рдирд┐рдпреЛрдЬрди рдХреЛ рдЕрд╕рдлрд▓ рдХреЗ рд░реВрдк рдореЗрдВ рдЪрд┐рд╣реНрдирд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред </p><br><p>  рдХреИрдирд░реА рддреНрд░реБрдЯрд┐рдпреЛрдВ рдФрд░ рджреЗрд░реА рдЪреЛрдЯрд┐рдпреЛрдВ рдХреЛ рдХреБрдмреЗрд░рдиреЗрдЯ рдШрдЯрдирд╛рдУрдВ рдХреЗ рд░реВрдк рдореЗрдВ рд▓реЙрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ рдлреНрд▓реИрдЧрд░ рджреНрд╡рд╛рд░рд╛ JSON рдкреНрд░рд╛рд░реВрдк рдореЗрдВ рджрд░реНрдЬ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ: </p><br><pre> <code class="plaintext hljs">kubectl -n istio-system logs deployment/flagger -f | jq .msg Starting canary deployment for podinfo.test Advance podinfo.test canary weight 5 Advance podinfo.test canary weight 10 Advance podinfo.test canary weight 15 Halt podinfo.test advancement success rate 69.17% &lt; 99% Halt podinfo.test advancement success rate 61.39% &lt; 99% Halt podinfo.test advancement success rate 55.06% &lt; 99% Halt podinfo.test advancement success rate 47.00% &lt; 99% Halt podinfo.test advancement success rate 37.00% &lt; 99% Halt podinfo.test advancement request duration 1.515s &gt; 500ms Halt podinfo.test advancement request duration 1.600s &gt; 500ms Halt podinfo.test advancement request duration 1.915s &gt; 500ms Halt podinfo.test advancement request duration 2.050s &gt; 500ms Halt podinfo.test advancement request duration 2.515s &gt; 500ms Rolling back podinfo.test failed checks threshold reached 10 Canary failed! Scaling down podinfo.test</code> </pre> <br><p>  рдпрджрд┐ рдЖрдкрдиреЗ рд╕реНрд▓реИрдХ рдиреЛрдЯрд┐рдлрд┐рдХреЗрд╢рди рдХреЛ рд╕рдХреНрд╖рдо рдХрд┐рдпрд╛ рд╣реИ, рддреЛ рдЖрдкрдХреЛ рдПрдХ рд╕рдВрджреЗрд╢ рдкреНрд░рд╛рдкреНрдд рд╣реЛрдЧрд╛ рдЬрдм рд╕рдордп рд╕реАрдорд╛ рд╕рдорд╛рдкреНрдд рд╣реЛ рдЧрдИ рд╣реИ рдпрд╛ рдЬрдм рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдХреЗ рджреМрд░рд╛рди рд╡рд┐рдлрд▓ рдЪреЗрдХ рдХреА рдЕрдзрд┐рдХрддрдо рд╕рдВрдЦреНрдпрд╛ рдкрд╣реБрдВрдЪ рдЧрдИ рд╣реИ: </p><br><p> <a href=""><img src="https://habrastorage.org/webt/wo/te/dq/wotedqdhoxxyhjug_lcuy57wno0.png"></a> </p><br><h3 id="v-zaklyuchenie">  рдирд┐рд╖реНрдХрд░реНрд╖ рдореЗрдВ </h3><br><p>  рдХреБрдмреЗрд░рдиреЗрдЯреНрд╕ рдХреЗ рдЕрд▓рд╛рд╡рд╛ рдПрдХ рд╕реЗрд╡рд╛ рдЬрд╛рд▓, рдЬреИрд╕реЗ рдХрд┐ рдЗрд╕реНрддрд┐рдпреЛ, рдХреЛ рд▓реЙрдиреНрдЪ рдХрд░рдирд╛ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдореИрдЯреНрд░рд┐рдХреНрд╕, рд▓реЙрдЧ рдФрд░ рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдкреНрд░рджрд╛рди рдХрд░реЗрдЧрд╛, рд▓реЗрдХрд┐рди рд╡рд░реНрдХрд▓реЛрдб рдХреА рддреИрдирд╛рддреА рдЕрднреА рднреА рдмрд╛рд╣рд░реА рдЙрдкрдХрд░рдгреЛрдВ рдкрд░ рдирд┐рд░реНрднрд░ рдХрд░рддреА рд╣реИред  рдлреНрд▓реИрдЧрд░ рдЗрд╕реЗ рдЗрд╕реНрддрд┐рдпреЛ рдХреА <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдкреНрд░рдЧрддрд┐рд╢реАрд▓ рд╡рд┐рддрд░рдг</a> рдХреНрд╖рдорддрд╛рдУрдВ рдХреЛ рдЬреЛрдбрд╝рдХрд░ рдЗрд╕реЗ рдмрджрд▓рдирд╛ рдЪрд╛рд╣рддрд╛ рд╣реИред </p><br><p>  рдлреНрд▓реИрдЧрд░ рдХрд┐рд╕реА рднреА рдХреБрдмреЗрд░рдиреЗрдЯреНрд╕ рд╕реАрдЖрдИ / рд╕реАрдбреА рд╕рдорд╛рдзрд╛рди рдХреЗ рд╕рд╛рде рд╕рдВрдЧрдд рд╣реИ, рдФрд░ рд╕рд┐рд╕реНрдЯрдо рдПрдХреАрдХрд░рдг / рд╕реНрд╡реАрдХреГрддрд┐ рдкрд░реАрдХреНрд╖рдг, рддрдирд╛рд╡ рдкрд░реАрдХреНрд╖рдг рдпрд╛ рдХрд┐рд╕реА рдЕрдиреНрдп рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдкрд░реАрдХреНрд╖рдгреЛрдВ рдХреЛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рд╡реЗрдмрд╣реВрдХ</a> рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдХреИрдирд░реА рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдХреЛ рдЖрд╕рд╛рдиреА рд╕реЗ рдмрдврд╝рд╛рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред  рдХреНрдпреЛрдВрдХрд┐ рдлреНрд▓реИрдЧрд░ рдШреЛрд╖рдгрд╛рддреНрдордХ рдФрд░ рдХреБрдмреЗрд░рдиреЗрдЯ рдШрдЯрдирд╛рдУрдВ рдХреЗ рд▓рд┐рдП рдЙрддреНрддрд░рджрд╛рдпреА рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЗрд╕реЗ рдЧреАрд╡ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдлреНрд▓рдХреНрд╕</a> рдпрд╛ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдЬреЗрдирдХрд┐рдВрд╕рдПрдХреНрд╕ рдХреЗ</a> рд╕рд╛рде рдЧрд┐рдЯреНрд╕ рдкрд╛рдЗрдкреНрд╕ рдкрд░ рдЗрд╕реНрддреЗрдорд╛рд▓ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред  рдпрджрд┐ рдЖрдк рдЬреЗрдирдХрд┐рдВрд╕рдПрдХреНрд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд░рд╣реЗ рд╣реИрдВ, рддреЛ рдЖрдк рдлреНрд▓реИрдХреНрд╕ рдХреЛ рдЬреЗрдПрдХреНрд╕ рдРрдб-рдСрди рдХреЗ рд╕рд╛рде рд╕реНрдерд╛рдкрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред </p><br><p>  рдлреНрд▓реИрдЧрд░ рдХреЛ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рд╡реАрд╡рд░реНрд╕</a> рджреНрд╡рд╛рд░рд╛ рд╕рдорд░реНрдерд┐рдд рдХрд┐рдпрд╛ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдЧрдпрд╛ рд╣реИ</a> рдФрд░ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рд╡реАрд╡</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдХреНрд▓рд╛рдЙрдб</a> рдХреЛ рдХреИрдирд░реА рдХреА рддреИрдирд╛рддреА рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред  рдкрд░рд┐рдпреЛрдЬрдирд╛ рдХрд╛ рдкрд░реАрдХреНрд╖рдг GKE, EX рдФрд░ рдирдВрдЧреЗ рдзрд╛рддреБ рдкрд░ рдХреБрдмреЗрджрдо рдХреЗ рд╕рд╛рде рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред </p><br><p>  рдпрджрд┐ рдЖрдкрдХреЗ рдкрд╛рд╕ рдлреНрд▓реИрдЧрд░ рдХреЛ рдмреЗрд╣рддрд░ рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдХреЛрдИ рд╕реБрдЭрд╛рд╡ рд╣реИ, рддреЛ рдХреГрдкрдпрд╛ рдПрдХ рдкреНрд░рд╢реНрди рдпрд╛ PR рдХреЛ GitHub рдХреЛ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">stefanprodan / flagger</a> рдкрд░ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рднреЗрдЬреЗрдВ</a> ред  рдпреЛрдЧрджрд╛рди рд╕реНрд╡рд╛рдЧрдд рд╕реЗ рдЕрдзрд┐рдХ рд╣реИ! </p><br><p>  рдзрдиреНрдпрд╡рд╛рдж <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рд░реЗ рддреНрд╕рд╛рдВрдЧ</a> ред </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/hi444808/">https://habr.com/ru/post/hi444808/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../hi444796/index.html">рдЯреНрд░реИрдХреНрдЯрд░ рд░рд┐рд╡рд░реНрд╕ рдЗрдВрдЬреАрдирд┐рдпрд░рд┐рдВрдЧ: рдорд╛рдк рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рдЖрдзрд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреИрд╕реЗ рддреЗрдЬ рдХрд░реЗрдВ</a></li>
<li><a href="../hi444798/index.html">DUMP рд╕рдореНрдореЗрд▓рди рдореЗрдВ рдлреНрд░рдВрдЯреЗрдВрдб рд╕реЗрдХреНрд╢рди рдХрд╛ рдЕрд╡рд▓реЛрдХрди: рдЗрд╕рдХреА рд╕рдВрдкреВрд░реНрдгрддрд╛ рдореЗрдВ рд╡рд┐рдХрд╛рд╕ рдХрд╛ рджреГрд╢реНрдп</a></li>
<li><a href="../hi444800/index.html">рдУрдкрди рд╕реЛрд░реНрд╕ рдкреИрд╕рд╛ рдирд╣реАрдВ рдмрдирд╛рддрд╛ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ рдЗрд╕рдХреЗ рд▓рд┐рдП рдирд╣реАрдВ рдмрдирд╛рдпрд╛ рдЧрдпрд╛ рдерд╛</a></li>
<li><a href="../hi444804/index.html">рдмреАрдЯреАрд╕реА-рдИ рдПрдХреНрд╕рдЪреЗрдВрдЬ рдСрдкрд░реЗрдЯрд░ рд░реВрд╕ рдХреЛ рдкреНрд░рддреНрдпрд░реНрдкрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд╣рддрд╛ рд╣реИ</a></li>
<li><a href="../hi444806/index.html">Moira рдХреЛрдб 2019 рдХреЗ Google рд╕рдорд░ рдореЗрдВ рднрд╛рдЧ рд▓реЗрддрд╛ рд╣реИ</a></li>
<li><a href="../hi444810/index.html">рдХрдВрдкреНрдпреВрдЯрд░ рдкреНрд░реМрджреНрдпреЛрдЧрд┐рдХреА рдореЗрдВ рдкреНрд░реЛрд╕реЗрд╕рд░ рдФрд░ рд╡рд┐рдкрдгрди</a></li>
<li><a href="../hi444814/index.html">рдЬрд╛рд╡рд╛ рдореЗрдВ рдХреНрд░рд┐рдкреНрдЯреЛрдЧреНрд░рд╛рдлреАред рдХрдХреНрд╖рд╛ рдХрд╛ рд╕рд┐рдлрд░</a></li>
<li><a href="../hi444816/index.html">DIY рдмрдврд╝рдИрдЧреАрд░реА: рдЙрдореНрдореАрджреЛрдВ рдФрд░ рд╡рд╛рд╕реНрддрд╡рд┐рдХрддрд╛</a></li>
<li><a href="../hi444818/index.html">Citymobil - рд╡рд┐рдХрд╛рд╕ рдХреЗ рдмреАрдЪ рд╕реНрдерд┐рд░рддрд╛ рдмрдврд╝рд╛рдиреЗ рдХреЗ рд▓рд┐рдП рд╕реНрдЯрд╛рд░реНрдЯрдЕрдк рдХреЗ рд▓рд┐рдП рдПрдХ рдЧрд╛рдЗрдбред рднрд╛рдЧ 1</a></li>
<li><a href="../hi444820/index.html">рдореЙрдХрдбрд╛рдЙрди: рд╡рд╛рдпрд░рдлреНрд░реЗрдо рдмрдирд╛рдиреЗ рдХрд╛ рд╕рдмрд╕реЗ рддреЗрдЬрд╝ рддрд░реАрдХрд╛</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>