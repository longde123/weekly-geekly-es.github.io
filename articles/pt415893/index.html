<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üéûÔ∏è üïî üõÅ Como tornar os processos Java em execu√ß√£o no Linux / Docker simples e diretos ‚õµÔ∏è üôåüèº üé≠</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Como engenheiro de DevOps, frequentemente trabalho para automatizar a instala√ß√£o e configura√ß√£o de uma variedade de sistemas de TI em v√°rios ambientes...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como tornar os processos Java em execu√ß√£o no Linux / Docker simples e diretos</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/415893/"><p>  Como engenheiro de DevOps, frequentemente trabalho para automatizar a instala√ß√£o e configura√ß√£o de uma variedade de sistemas de TI em v√°rios ambientes: dos cont√™ineres √† nuvem.  Eu tive que trabalhar com muitos sistemas baseados na pilha Java: de pequeno (como Tomcat) a grande escala (Hadoop, Cassandra, etc.). </p><br><p> Al√©m disso, quase todos os sistemas, mesmo o mais simples, por algum motivo, possu√≠am um sistema de lan√ßamento √∫nico e complexo.  No m√≠nimo, esses eram scripts shell de v√°rias linhas, como no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Tomcat</a> , e at√© estruturas inteiras, como no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Hadoop</a> .  Meu atual "paciente" nesta s√©rie, que me inspirou a escrever este artigo, √© o reposit√≥rio de artefatos do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Nexus OSS 3</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">cujo script de inicializa√ß√£o</a> requer ~ 400 linhas de c√≥digo. </p><br><p>  A opacidade, redund√¢ncia e complexidade dos scripts de inicializa√ß√£o cria problemas, mesmo ao instalar manualmente um componente no sistema local.  Agora imagine que voc√™ precisa empacotar um conjunto desses componentes e servi√ßos em um cont√™iner Docker, escrever outra camada de abstra√ß√£o ao longo das linhas de orquestra√ß√£o adequada, implant√°-lo em um cluster Kubernetes e implementar esse processo como um pipeline de CI / CD ... </p><br><p> Em resumo, vejamos o exemplo do Nexus 3 mencionado, como retornar do labirinto de scripts de shell para algo mais semelhante ao <code>java -jar &lt;program.jar&gt;</code> , dada a disponibilidade de ferramentas modernas e pr√°ticas de DevOps. </p><a name="habracut"></a><br><h1 id="otkuda-takaya-slozhnost">  De onde vem essa complexidade? </h1><br><p>  Em poucas palavras, nos tempos antigos, quando o UNIX n√£o era perguntado novamente: "no sentido do Linux?", N√£o havia Systemd e Docker e outros, scripts de shell port√°teis (scripts de inicializa√ß√£o) e PID eram usados ‚Äã‚Äãpara controlar os processos arquivos  Os scripts init definem as configura√ß√µes de ambiente necess√°rias, que foram diferentes em diferentes UNIX e, dependendo dos argumentos, iniciaram o processo ou o reiniciaram / pararam usando o ID do arquivo PID.  A abordagem √© simples e clara, mas esses scripts deixaram de funcionar em todas as situa√ß√µes incomuns, exigindo interven√ß√£o manual, n√£o permitiram a execu√ß√£o de v√°rias c√≥pias do processo ... mas n√£o o ponto. </p><br><p>  Portanto, se voc√™ observar cuidadosamente os scripts de inicializa√ß√£o mencionados acima nos projetos Java, poder√° ver os sinais √≥bvios dessa abordagem pr√©-hist√≥rica, incluindo at√© a men√ß√£o de SunOS, HP-UX e outros UNIXs.  Normalmente, esses scripts fazem algo assim: </p><br><ul><li>  use a sintaxe do shell POSIX com todas as suas muletas para portabilidade UNIX / Linux </li><li>  determinar a vers√£o do sistema operacional e liberar atrav√©s de <code>uname</code> , <code>/etc/*release</code> , etc. </li><li>  eles pesquisam o JRE / JDK nos cantos do sistema de arquivos e selecionam a vers√£o mais "adequada" de acordo com regras inteligentes, √†s vezes tamb√©m espec√≠ficas para cada SO </li><li>  Os par√¢metros num√©ricos da JVM s√£o calculados, por exemplo, tamanho da mem√≥ria ( <code>-Xms</code> , <code>-Xmx</code> ), o n√∫mero de encadeamentos do GC etc. </li><li>  otimizar a JVM atrav√©s de <code>-XX</code> par√¢metros, levando em considera√ß√£o as especificidades da vers√£o selecionada do JRE / JDK </li><li>  procure seus componentes, bibliotecas, caminhos para eles nos diret√≥rios, arquivos de configura√ß√£o, etc. </li><li>  personalizar o ambiente: ulimits, vari√°veis ‚Äã‚Äãde ambiente etc. </li><li>  gerar CLASSPATH com um loop como: <code>for f in $path/*.jar; do CLASSPATH="${CLASSPATH}:$f"; done</code> <code>for f in $path/*.jar; do CLASSPATH="${CLASSPATH}:$f"; done</code> </li><li>  argumentos de linha de comando analisados: <code>start|stop|restart|reload|status|...</code> </li><li>  compile o comando Java que voc√™ precisa executar a partir do acima </li><li>  e finalmente <strong>execute este comando java</strong> .  Freq√ºentemente, os mesmos arquivos PID not√≥rios, <code>&amp;</code> , <code>nohup</code> , portas TCP especiais e outros truques do s√©culo passado s√£o usados ‚Äã‚Äãexpl√≠cita ou implicitamente (veja o <a href="">exemplo do Karaf</a> ) </li></ul><br><p>  O <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">script de inicializa√ß√£o do Nexus 3</a> mencionado √© um exemplo adequado desse script. </p><br><p>  De fato, toda a l√≥gica de script listada acima, por assim dizer, est√° tentando substituir o administrador do sistema, que instalaria e configuraria tudo manualmente para um sistema espec√≠fico, do come√ßo ao fim.  Mas, em geral, √© imposs√≠vel levar em considera√ß√£o quaisquer requisitos dos mais diversos sistemas.  Portanto, resulta, pelo contr√°rio, uma dor de cabe√ßa, tanto para desenvolvedores que precisam suportar esses scripts quanto para engenheiros de sistema que precisam entender esses scripts posteriormente.  Do meu ponto de vista, √© muito mais f√°cil para um engenheiro de sistema entender os par√¢metros da JVM uma vez e configur√°-lo como deveria, do que entender os meandros de seus scripts de inicializa√ß√£o toda vez que voc√™ instala um novo sistema. </p><br><h1 id="chto-zhe-delat">  O que fazer? </h1><br><p>  Perdoe!  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">KISS</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">YAGNI</a> est√£o em nossas m√£os.  Al√©m disso, o ano de 2018 √© no quintal, o que significa que: </p><br><ul><li>  com muito poucas exce√ß√µes, UNIX == Linux </li><li>  o problema de controle de processo √© resolvido para um servidor separado ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Systemd</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Docker</a> ) e para clusters ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Kubernetes</a> etc.) </li><li>  Existem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">v√°rias</a> ferramentas convenientes de gerenciamento de configura√ß√£o ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Ansible</a> , etc.) </li><li>  a automa√ß√£o total chegou √† administra√ß√£o e j√° se solidificou completamente: em vez de configurar manualmente <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">"servidores de floco de neve"</a> √∫nicos e fr√°geis <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">,</a> agora √© poss√≠vel montar automaticamente m√°quinas virtuais e cont√™ineres reproduz√≠veis unificados usando v√°rias ferramentas convenientes, incluindo o Ansible e o Docker acima mencionados </li><li>  As ferramentas para coletar estat√≠sticas de tempo de execu√ß√£o s√£o amplamente utilizadas, tanto para a pr√≥pria JVM ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">exemplo</a> ) quanto para um aplicativo Java ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">exemplo</a> ) </li><li>  e, o mais importante, surgiram especialistas: engenheiros de sistema e DevOps que podem usar as tecnologias listadas acima e entender como instalar corretamente a JVM em um sistema espec√≠fico e, posteriormente, ajust√°-lo com base nas estat√≠sticas de tempo de execu√ß√£o coletadas </li></ul><br><p>  Ent√£o, vamos examinar a funcionalidade dos scripts de inicializa√ß√£o novamente, levando em considera√ß√£o os pontos listados acima, sem tentar fazer o trabalho para o engenheiro de sistema e remover todos os "desnecess√°rios" de l√°. </p><br><ul><li><del>  Sintaxe do shell POSIX </del>  ‚áí <code>/bin/bash</code> </li><li><del>  Detec√ß√£o de vers√£o do SO </del>  ‚áí UNIX == Linux, se houver par√¢metros espec√≠ficos do SO, voc√™ poder√° descrev√™-los na documenta√ß√£o </li><li><del>  Pesquisa JRE / JDK </del>  ‚áí temos a √∫nica vers√£o, e este √© o OpenJDK (bem, ou Oracle JDK, se voc√™ realmente precisar), <code>java</code> e a empresa est√£o no caminho padr√£o do sistema </li><li><del>  c√°lculo de par√¢metros num√©ricos JVM, ajustando JVM </del>  ‚áí isso pode ser descrito na documenta√ß√£o de dimensionamento do aplicativo </li><li><del>  procure seus componentes e bibliotecas </del>  ‚áí descrever a estrutura do aplicativo e como configur√°-lo na documenta√ß√£o </li><li><del>  configura√ß√£o do ambiente </del>  ‚áí descrever os requisitos e recursos na documenta√ß√£o </li><li><del>  Gera√ß√£o CLASSPATH </del>  ‚áí <code>-cp path/to/my/jars/*</code> ou mesmo, em geral, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Uber-JAR</a> </li><li><del>  Analisando Argumentos da Linha de Comandos </del>  ‚áí n√£o haver√° argumentos, porque  o gerente de processo cuidar√° de tudo, exceto o lan√ßamento </li><li>  Montagem de Comando Java </li><li>  execu√ß√£o de comando java </li></ul><br><p>  Como resultado, basta montar e executar um comando Java no formato <code>java &lt;opts&gt; -jar &lt;program.jar&gt;</code> usando o gerenciador de processos selecionado (Systemd, Docker, etc.).  Todos os par√¢metros e op√ß√µes ( <code>&lt;opts&gt;</code> ) s√£o deixados a crit√©rio do engenheiro do sistema, que os ajustar√° a um ambiente espec√≠fico.  Se a lista de op√ß√µes <code>&lt;opts&gt;</code> bastante longa, voc√™ poder√° voltar √† ideia de um script de inicializa√ß√£o, mas, nesse caso, o <strong>mais compacto e declarativo poss√≠vel</strong> , ou seja,  n√£o cont√©m nenhuma l√≥gica de software. </p><br><h1 id="primer">  Exemplo </h1><br><p>  Como exemplo, vamos ver como voc√™ pode simplificar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">o script de inicializa√ß√£o do Nexus 3</a> . </p><br><p>  A op√ß√£o mais f√°cil, para n√£o entrar na selva desse script - basta execut√°-lo em condi√ß√µes reais ( <code>./nexus start</code> ) e ver o resultado.  Por exemplo, voc√™ pode encontrar a lista completa de argumentos do aplicativo em execu√ß√£o na tabela de processos (via <code>ps -ef</code> ) ou executar o script no modo de depura√ß√£o ( <code>bash -x ./nexus start</code> ) para observar todo o processo de sua execu√ß√£o e, no final, o comando de inicializa√ß√£o. </p><br><div class="spoiler">  <b class="spoiler_title">Eu terminei com o seguinte comando Java</b> <div class="spoiler_text"><pre> <code class="bash hljs">/usr/java/jdk1.8.0_171-amd64/bin/java -server -Dinstall4j.jvmDir=/usr/java/jdk1.8.0_171-amd64 -Dexe4j.moduleName=/home/nexus/nexus-3.12.1-01/bin/nexus -XX:+UnlockDiagnosticVMOptions -Dinstall4j.launcherId=245 -Dinstall4j.swt=<span class="hljs-literal"><span class="hljs-literal">false</span></span> -Di4jv=0 -Di4jv=0 -Di4jv=0 -Di4jv=0 -Di4jv=0 -Xms1200M -Xmx1200M -XX:MaxDirectMemorySize=2G -XX:+UnlockDiagnosticVMOptions -XX:+UnsyncloadClass -XX:+LogVMOutput -XX:LogFile=../sonatype-work/nexus3/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/jvm.log -XX:-OmitStackTraceInFastThrow -Djava.net.preferIPv4Stack=<span class="hljs-literal"><span class="hljs-literal">true</span></span> -Dkaraf.home=. -Dkaraf.base=. -Dkaraf.etc=etc/karaf -Djava.util.logging.config.file=etc/karaf/java.util.logging.properties -Dkaraf.data=../sonatype-work/nexus3 -Djava.io.tmpdir=../sonatype-work/nexus3/tmp -Dkaraf.startLocalConsole=<span class="hljs-literal"><span class="hljs-literal">false</span></span> -Di4j.vpt=<span class="hljs-literal"><span class="hljs-literal">true</span></span> -classpath /home/nexus/nexus-3.12.1-01/.install4j/i4jruntime.jar:/home/nexus/nexus-3.12.1-01/lib/boot/nexus-main.jar:/home/nexus/nexus-3.12.1-01/lib/boot/org.apache.karaf.main-4.0.9.jar:/home/nexus/nexus-3.12.1-01/lib/boot/org.osgi.core-6.0.0.jar:/home/nexus/nexus-3.12.1-01/lib/boot/org.apache.karaf.diagnostic.boot-4.0.9.jar:/home/nexus/nexus-3.12.1-01/lib/boot/org.apache.karaf.jaas.boot-4.0.9.jar com.install4j.runtime.launcher.UnixLauncher start 9d17dc87 <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span> org.sonatype.nexus.karaf.NexusMain</code> </pre> </div></div><br><p>  Primeiro, aplique alguns truques simples: </p><br><ul><li>  mude <code>/the/long/and/winding/road/to/my/java</code> para <code>java</code> , porque est√° no caminho do sistema </li><li>  coloque a lista de par√¢metros Java em uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">matriz</a> separada, classifique-a e remova duplicatas </li></ul><br><div class="spoiler">  <b class="spoiler_title">J√° temos algo mais diger√≠vel</b> <div class="spoiler_text"><pre> <code class="bash hljs">JAVA_OPTS = ( <span class="hljs-string"><span class="hljs-string">'-server'</span></span> <span class="hljs-string"><span class="hljs-string">'-Dexe4j.moduleName=/home/nexus/nexus-3.12.1-01/bin/nexus'</span></span> <span class="hljs-string"><span class="hljs-string">'-Di4j.vpt=true'</span></span> <span class="hljs-string"><span class="hljs-string">'-Di4jv=0'</span></span> <span class="hljs-string"><span class="hljs-string">'-Dinstall4j.jvmDir=/usr/java/jdk1.8.0_171-amd64'</span></span> <span class="hljs-string"><span class="hljs-string">'-Dinstall4j.launcherId=245'</span></span> <span class="hljs-string"><span class="hljs-string">'-Dinstall4j.swt=false'</span></span> <span class="hljs-string"><span class="hljs-string">'-Djava.io.tmpdir=../sonatype-work/nexus3/tmp'</span></span> <span class="hljs-string"><span class="hljs-string">'-Djava.net.preferIPv4Stack=true'</span></span> <span class="hljs-string"><span class="hljs-string">'-Djava.util.logging.config.file=etc/karaf/java.util.logging.properties'</span></span> <span class="hljs-string"><span class="hljs-string">'-Dkaraf.base=.'</span></span> <span class="hljs-string"><span class="hljs-string">'-Dkaraf.data=../sonatype-work/nexus3'</span></span> <span class="hljs-string"><span class="hljs-string">'-Dkaraf.etc=etc/karaf'</span></span> <span class="hljs-string"><span class="hljs-string">'-Dkaraf.home=.'</span></span> <span class="hljs-string"><span class="hljs-string">'-Dkaraf.startLocalConsole=false'</span></span> <span class="hljs-string"><span class="hljs-string">'-XX:+LogVMOutput'</span></span> <span class="hljs-string"><span class="hljs-string">'-XX:+UnlockDiagnosticVMOptions'</span></span> <span class="hljs-string"><span class="hljs-string">'-XX:+UnlockDiagnosticVMOptions'</span></span> <span class="hljs-string"><span class="hljs-string">'-XX:+UnsyncloadClass'</span></span> <span class="hljs-string"><span class="hljs-string">'-XX:-OmitStackTraceInFastThrow'</span></span> <span class="hljs-string"><span class="hljs-string">'-XX:LogFile=../sonatype-work/nexus3/log/jvm.log'</span></span> <span class="hljs-string"><span class="hljs-string">'-XX:MaxDirectMemorySize=2G'</span></span> <span class="hljs-string"><span class="hljs-string">'-Xms1200M'</span></span> <span class="hljs-string"><span class="hljs-string">'-Xmx1200M'</span></span> <span class="hljs-string"><span class="hljs-string">'-classpath /home/nexus/nexus-3.12.1-01/.install4j/i4jruntime.jar:/home/nexus/nexus-3.12.1-01/lib/boot/nexus-main.jar:/home/nexus/nexus-3.12.1-01/lib/boot/org.apache.karaf.main-4.0.9.jar:/home/nexus/nexus-3.12.1-01/lib/boot/org.osgi.core-6.0.0.jar:/home/nexus/nexus-3.12.1-01/lib/boot/org.apache.karaf.diagnostic.boot-4.0.9.jar:/home/nexus/nexus-3.12.1-01/lib/boot/'</span></span> ) java <span class="hljs-variable"><span class="hljs-variable">${JAVA_OPTS[*]}</span></span> com.install4j.runtime.launcher.UnixLauncher start 9d17dc87 <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span> org.sonatype.nexus.karaf.NexusMain</code> </pre> </div></div><br><p>  Agora voc√™ pode ir fundo. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O Install4j</a> √© um instalador Java gr√°fico.  Parece ser usado para a instala√ß√£o inicial do sistema.  N√≥s n√£o precisamos dele no servidor, n√≥s o removemos. </p><br><p>  Concordamos com o posicionamento dos componentes e dados do Nexus no sistema de arquivos: </p><br><ul><li>  coloque o aplicativo em <code>/opt/nexus-&lt;version&gt;</code> </li><li>  por conveni√™ncia, crie um link simb√≥lico <code>/opt/nexus -&gt; /opt/nexus-&lt;version&gt;</code> </li><li>  coloque o pr√≥prio script em vez do original como <code>/opt/nexus/bin/nexus</code> </li><li>  todos os dados do nosso Nexus estar√£o em um sistema de arquivos separado montado como <code>/data/nexus</code> </li></ul><br><p>  A pr√≥pria cria√ß√£o de diret√≥rios e links √© o destino dos sistemas de gerenciamento de configura√ß√£o (para tudo sobre todas as linhas de 5 a 10 no Ansible), ent√£o vamos deixar essa tarefa para os engenheiros de sistema. </p><br><p>  Deixe nosso script na inicializa√ß√£o alterar o diret√≥rio de trabalho para <code>/opt/nexus</code> - ent√£o podemos alterar os caminhos dos componentes do Nexus para os relativos. </p><br><p>  Op√ß√µes do formul√°rio <code>-Dkaraf.*</code> as configura√ß√µes do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Apache Karaf</a> , o cont√™iner OSGi no qual nosso Nexus est√° obviamente "empacotado".  Altere <code>karaf.home</code> , <code>karaf.base</code> , <code>karaf.etc</code> e <code>karaf.data</code> acordo com a localiza√ß√£o dos componentes, usando caminhos relativos, se poss√≠vel. </p><br><p>  Visto que CLASSPATH consiste em uma lista de arquivos jar que est√£o no mesmo diret√≥rio <code>lib/</code> , substitua toda a lista por <code>lib/*</code> (voc√™ tamb√©m precisar√° desativar a expans√£o de curinga com <code>set -o noglob</code> ). </p><br><p>  Altere <code>java</code> para <code>exec java</code> para que nosso script n√£o inicie o <code>java</code> como um processo filho (o gerenciador de processos n√£o ver√° esse processo filho), mas "substitua" a si mesmo por <code>java</code> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">descri√ß√£o do exec</a> ). </p><br><p>  Vamos ver o que aconteceu: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash JAVA_OPTS=( '-Xms1200M' '-Xmx1200M' '-XX:+UnlockDiagnosticVMOptions' '-XX:+LogVMOutput' '-XX:+UnsyncloadClass' '-XX:LogFile=/data/nexus/log/jvm.log' '-XX:MaxDirectMemorySize=2G' '-XX:-OmitStackTraceInFastThrow' '-Djava.io.tmpdir=/data/nexus/tmp' '-Djava.net.preferIPv4Stack=true' '-Djava.util.logging.config.file=etc/karaf/java.util.logging.properties' '-Dkaraf.home=.' '-Dkaraf.base=.' '-Dkaraf.etc=etc/karaf' '-Dkaraf.data=/data/nexus/data' '-Dkaraf.startLocalConsole=false' '-server' '-cp lib/boot/*' ) set -o noglob cd /opt/nexus \ &amp;&amp; exec java ${JAVA_OPTS[*]} org.sonatype.nexus.karaf.NexusMain</span></span></code> </pre> <br><p>  Um total de 27 linhas, em vez de&gt; 400, transparente, clara, declarativa, sem l√≥gica desnecess√°ria.  Se necess√°rio, esse script pode ser facilmente transformado em um modelo para Ansible / Puppet / Chef e adicionar apenas a l√≥gica necess√°ria para uma situa√ß√£o espec√≠fica. </p><br><p>  Esse script pode ser usado como um ENTRYPOINT em um Dockerfile ou chamado no arquivo de unidade Systemd, ao mesmo tempo ajustando ulimits e outros par√¢metros do sistema, por exemplo: </p><br><pre> <code class="hljs powershell">[<span class="hljs-type"><span class="hljs-type">Unit</span></span>] Description=Nexus After=network.target [<span class="hljs-type"><span class="hljs-type">Service</span></span>] Type=simple LimitNOFILE=<span class="hljs-number"><span class="hljs-number">1048576</span></span> ExecStart=/opt/nexus/bin/nexus User=nexus Restart=on<span class="hljs-literal"><span class="hljs-literal">-abort</span></span> [<span class="hljs-type"><span class="hljs-type">Install</span></span>] WantedBy=multi<span class="hljs-literal"><span class="hljs-literal">-user</span></span>.target</code> </pre> <br><h1 id="zaklyuchenie">  Conclus√£o </h1><br><p>  Que conclus√µes podem ser tiradas deste artigo?  Em princ√≠pio, tudo se resume a alguns pontos: </p><br><ol><li>  Cada sistema tem seu pr√≥prio objetivo, ou seja, n√£o √© necess√°rio martelar as unhas com um microsc√≥pio. </li><li>  Regras de simplicidade (KISS, YAGNI) - para implementar apenas o necess√°rio para uma determinada situa√ß√£o espec√≠fica. </li><li>  E o mais importante: √© legal que existam especialistas em TI de diferentes perfis.  Vamos interagir e tornar nossos sistemas de TI mais simples, claros e melhores!  :) </li></ol><br><p>  Obrigado pela aten√ß√£o!  Ficarei feliz em receber coment√°rios e discuss√µes construtivas nos coment√°rios. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt415893/">https://habr.com/ru/post/pt415893/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt415875/index.html">Uma palavra para o linguista: e se os computadores falarem melhor</a></li>
<li><a href="../pt415879/index.html">Eventos digitais em Moscou, de 2 a 8 de julho</a></li>
<li><a href="../pt415881/index.html">Como o JS funciona: tecnologia Shadow DOM e componentes da Web</a></li>
<li><a href="../pt415887/index.html">Que tipo de rob√¥s-aranha sobrevoam est√°dios e jogam futebol. Entrevista com o criador do Robycam</a></li>
<li><a href="../pt415891/index.html">Quais s√£o os jogos de sequela legais?</a></li>
<li><a href="../pt415895/index.html">O padr√£o mais importante na programa√ß√£o</a></li>
<li><a href="../pt415897/index.html">Fun√ß√µes para documentar bancos de dados PostgreSQL. Parte dois</a></li>
<li><a href="../pt415899/index.html">O Office 365 Outlook encontrou APIs n√£o documentadas com logs detalhados de atividades do usu√°rio</a></li>
<li><a href="../pt415901/index.html">A Comiss√£o do Conselho da Federa√ß√£o apoiou a ideia de criar uma base IMEI para todos os telefones brancos</a></li>
<li><a href="../pt415903/index.html">Bem-vindo ao ver√£o DIYorDIE Meetup em 7 de julho</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>