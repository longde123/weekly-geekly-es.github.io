<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🦃 🥞 🚣🏼 Bibliothèque Ethernet ou pourquoi dans la nature il n'y a pas de serveurs sur Arduino 🚵🏽 ⌚️ 🕺</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans cet article, je décrirai la situation que j'ai rencontrée lors du développement du projet Arduino Mega Server . L'essentiel est qu'il existe une ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Bibliothèque Ethernet ou pourquoi dans la nature il n'y a pas de serveurs sur Arduino</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/382565/"><img src="https://habrastorage.org/files/013/400/80a/01340080a06e4ff5ba887dabd987b4eb.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans cet article, je décrirai la situation que j'ai rencontrée lors du développement du projet </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arduino Mega Server</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . L'essentiel est qu'il existe une telle bibliothèque Ethernet Arduino, écrite pour prendre en charge la carte réseau Ethernet Shield sur la puce W5100. Il s'agit d'une carte standard et d'une bibliothèque standard fournies avec l'environnement de développement Arduino depuis de nombreuses années. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et cette bibliothèque est la base de tous les projets qui utilisent l'échange d'informations sur un réseau câblé. Il s'est donc avéré que cette bibliothèque est tout simplement inadaptée. Sur celui-ci, en principe, il est impossible de construire une interaction réseau normale. Vous ne pouvez "vous livrer" qu'à des demandes et des réponses uniques. Nous ne pouvons pas parler de la création de serveurs basés sur cette bibliothèque. Pourquoi?</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parce que cette bibliothèque a un «bogue» intégré qui suspend les demandes non uniques pendant une période de trois à dix secondes ou plus. </font><font style="vertical-align: inherit;">Le bogue est intégré et l'auteur de la bibliothèque le savait, comme en témoignent ses notes dans la source (mais plus à ce sujet plus tard). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ici, vous devez comprendre que la bibliothèque fournie avec l'environnement de développement officiel est un certain standard et si le projet ne fonctionne pas pour vous, vous chercherez le défaut n'importe où, mais pas dans la bibliothèque standard, car il a été utilisé pendant de nombreuses années par des centaines de milliers, voire des millions de personnes. </font><font style="vertical-align: inherit;">Ne peuvent-ils pas tous se tromper?</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pourquoi dans la nature il n'y a pas de serveurs sur Arduino</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le développement du projet s'est déroulé comme il se doit et, finalement, il s'agit d'optimiser le code et d'augmenter la vitesse du serveur, et là, je suis confronté à la situation suivante: les requêtes entrantes du navigateur sont reçues et «suspendues» pour une durée de trois à dix secondes, en moyenne, jusqu'à vingt et vingt plus de secondes avec un échange plus intense. Voici une capture d'écran qui montre que le retard anormal dans les réponses du serveur «parcourt» diverses requêtes. </font></font><br>
<br>
<img src="https://habrastorage.org/files/9c4/7ef/c67/9c47efc67e8748729d33908b136ea0fd.jpg" alt="retard anormal"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quand j'ai commencé à comprendre, il s'est avéré que rien n'empêchait le serveur de répondre, mais, néanmoins, la demande a «suspendu» pendant plus de neuf secondes, et à une autre itération, la même demande avait déjà été suspendue pendant environ trois secondes.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De telles observations m'ont plongé dans une profonde réflexion et j'ai déterré tout le code du serveur (en même temps je me suis étiré) mais n'ai trouvé aucun défaut et toute la logique a conduit à la bibliothèque Ethernet Arduino "sacrée des saints". Mais l'idée séditieuse que la bibliothèque standard était à blâmer a été rejetée comme inadéquate. En effet, non seulement les utilisateurs travaillent avec la bibliothèque, mais aussi un grand nombre de développeurs professionnels. Ne voient-ils pas tous des choses aussi évidentes?</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour l'avenir, je dirai que lorsqu'il s'est avéré que le problème se trouvait dans la bibliothèque standard, il est devenu clair pourquoi, dans la nature, il n'y a pas de serveurs (normaux) sur l'Arduino. </font><font style="vertical-align: inherit;">Parce que sur la base de la bibliothèque standard (avec laquelle la plupart des développeurs travaillent), il est fondamentalement impossible de construire un serveur. </font><font style="vertical-align: inherit;">Un retard d'une réponse de dix secondes ou plus fait sortir le serveur de la catégorie des serveurs et en fait un jouet simple (ringard). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Retrait intermédiaire. </font><font style="vertical-align: inherit;">Ce n'est pas Arduino n'est pas adapté à la construction de serveurs, et la bibliothèque réseau met fin à une classe d'appareils très intéressante.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anatomie du problème</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Passons maintenant des paroles à une description technique du problème et de sa solution pratique. </font><font style="vertical-align: inherit;">Pour ceux qui ne sont pas à jour, l'emplacement standard de la bibliothèque (sous Windows): </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
arduino \ bibliothèques \ Ethernet </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et la première chose que nous verrons est la fonction du fichier EthernetServer.cpp</font></font><br>
<br>
<pre><code class="java hljs">EthernetClient EthernetServer::available() {<font></font>
  accept();<font></font>
<font></font>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> sock = <span class="hljs-number">0</span>; sock &lt; MAX_SOCK_NUM; sock++) {
    <span class="hljs-function">EthernetClient <span class="hljs-title">client</span><span class="hljs-params">(sock)</span></span>;
    <span class="hljs-keyword">if</span> (EthernetClass::_server_port[sock] == _port &amp;&amp;<font></font>
        (client.status() == SnSR::ESTABLISHED ||<font></font>
         client.status() == SnSR::CLOSE_WAIT)) {<font></font>
      <span class="hljs-keyword">if</span> (client.available()) {
        <span class="hljs-comment">// <span class="hljs-doctag">XXX:</span> don't always pick the lowest numbered socket.</span>
        <span class="hljs-keyword">return</span> client;<font></font>
      }<font></font>
    }<font></font>
  }<font></font>
  <span class="hljs-keyword">return</span> EthernetClient(MAX_SOCK_NUM);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quand j'ai surmonté la barrière psychologique (sous la pression de la logique) et commencé à chercher un défaut dans la bibliothèque Ethernet, j'ai commencé avec cette fonction. </font><font style="vertical-align: inherit;">J'ai remarqué un commentaire étrange de l'auteur, mais n'y attache aucune importance. </font><font style="vertical-align: inherit;">Après avoir pelleté toute la bibliothèque, j'ai de nouveau, mais après quelques jours et après avoir fait de grands progrès dans les technologies de réseau, je suis retourné à cette fonction parce que la logique suggérait que le problème était là et regardait de plus près le commentaire.</font></font><br>
<br>
<pre><code class="java hljs">
        <span class="hljs-comment">// <span class="hljs-doctag">XXX:</span> don't always pick the lowest numbered socket.</span><font></font>
<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Amis, tout est écrit en texte clair. Dans une traduction gratuite, cela ressemble à ceci: "ça marche, mais pas toujours". Attendez une minute, que signifie «pas toujours»? Nous n'avons pas de club de loto du dimanche. Et quand ça ne marche pas, alors quoi? Mais lorsque «ne fonctionne pas» et que les problèmes commencent avec un délai de dix secondes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et l'auteur était certainement au courant de cela, comme en témoigne l'estime de soi de sa création - trois x. Sans commentaires. Cette bibliothèque est à la base de nombreux clones et, attention, ces trois X se déplacent d'un projet à l'autre. Si vous êtes développeur, vous ne pouvez pas remarquer ce problème une seule fois sans tester l'échange réseau. Pas de commentaire non plus.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour ceux qui connaissent mal le code, je vais expliquer l'essence du problème avec des mots simples. </font><font style="vertical-align: inherit;">La boucle parcourt les sockets et, dès qu'elle trouve celle qui convient, renvoie le client et ignore simplement le reste. </font><font style="vertical-align: inherit;">Et ils pendent pendant dix secondes, jusqu'à ce que "les cartes s'allongent favorablement".</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Solution au problème</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ayant compris la cause du problème, nous ne nous arrêterons certainement pas là et tenterons de le résoudre. </font><font style="vertical-align: inherit;">Tout d'abord, réécrivons la fonction pour que la réception ou la non réception d'une socket ne dépende pas de la volonté du cas et se produise toujours s'il y en a une. </font><font style="vertical-align: inherit;">Cela résoudra deux problèmes:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">les demandes ne seront pas bloquées</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les requêtes "séquentielles" se transformeront en "parallèles", ce qui accélérera considérablement le travail</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi, le code de la nouvelle fonction:</font></font><br>
<br>
<pre><code class="java hljs">EthernetClient EthernetServer::available_(<span class="hljs-keyword">int</span> sock) {<font></font>
  accept_(sock);<font></font>
  <span class="hljs-function">EthernetClient <span class="hljs-title">client</span><span class="hljs-params">(sock)</span></span>;
  <span class="hljs-keyword">if</span> (EthernetClass::_server_port[sock] == _port &amp;&amp;<font></font>
      (client.status() == SnSR::ESTABLISHED ||<font></font>
       client.status() == SnSR::CLOSE_WAIT)) {<font></font>
    <span class="hljs-keyword">if</span> (client.available()) {
      <span class="hljs-keyword">return</span> client;<font></font>
    }<font></font>
  }<font></font>
  <span class="hljs-keyword">return</span> EthernetClient(MAX_SOCK_NUM);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous supprimons la boucle, spécifions explicitement la socket et ne perdons rien - si elle est gratuite, alors nous sommes garantis de recevoir un client (si cela nous convient). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous faisons le même «chaînage» avec le code de la fonction accept, supprimons la boucle et spécifions explicitement le socket.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">void</span> EthernetServer::accept_(<span class="hljs-keyword">int</span> sock) {
  <span class="hljs-keyword">int</span> listening = <span class="hljs-number">0</span>;
  <span class="hljs-function">EthernetClient <span class="hljs-title">client</span><span class="hljs-params">(sock)</span></span>;<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (EthernetClass::_server_port[sock] == _port) {
    <span class="hljs-keyword">if</span> (client.status() == SnSR::LISTEN) {<font></font>
      listening = <span class="hljs-number">1</span>;<font></font>
    } <font></font>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (client.status() == SnSR::CLOSE_WAIT &amp;&amp; !client.available()) {<font></font>
      client.stop();<font></font>
    }<font></font>
  } <font></font>
<font></font>
  <span class="hljs-keyword">if</span> (!listening) {
    <span class="hljs-comment">//begin();</span>
    begin_(sock); <span class="hljs-comment">// added</span><font></font>
  }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et n'oubliez pas de corriger le fichier EthernetServer.h</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EthernetServer</span> : 
<span class="hljs-title">public</span> <span class="hljs-title">Server</span> </span>{
<span class="hljs-keyword">private</span>:<font></font>
  uint16_t _port;<font></font>
  <span class="hljs-comment">//void accept();</span>
  <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">accept_</span><span class="hljs-params">(<span class="hljs-keyword">int</span> sock)</span></span>;
<span class="hljs-keyword">public</span>:<font></font>
  EthernetServer(uint16_t);<font></font>
  <span class="hljs-comment">//EthernetClient available();</span>
  <span class="hljs-function">EthernetClient <span class="hljs-title">available_</span><span class="hljs-params">(<span class="hljs-keyword">int</span> sock)</span></span>;
  <span class="hljs-function">virtual <span class="hljs-keyword">void</span> <span class="hljs-title">begin</span><span class="hljs-params">()</span></span>;
  <span class="hljs-function">virtual <span class="hljs-keyword">void</span> <span class="hljs-title">begin_</span><span class="hljs-params">(<span class="hljs-keyword">int</span> sock)</span></span>;
  <span class="hljs-function">virtual size_t <span class="hljs-title">write</span><span class="hljs-params">(uint8_t)</span></span>;
  <span class="hljs-function">virtual size_t <span class="hljs-title">write</span><span class="hljs-params">(<span class="hljs-keyword">const</span> uint8_t *buf, size_t size)</span></span>;<font></font>
  using Print::write;<font></font>
};<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est tout. </font><font style="vertical-align: inherit;">Nous avons apporté des modifications à la bibliothèque standard et le comportement du serveur a radicalement changé. </font><font style="vertical-align: inherit;">Si auparavant tout fonctionnait très lentement, au-delà de toute idée de convivialité, maintenant la vitesse de chargement des pages a considérablement augmenté et est devenue tout à fait acceptable pour une utilisation normale. </font></font><br>
<br>
<img src="http://habrastorage.org/files/3b3/298/9fa/3b32989fa04a4ec9a34b0c6aaa2e47af.jpg" alt="augmentation de la vitesse de téléchargement"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Faites attention à la réduction du délai de 3 à 5 fois pour différents fichiers et à la nature complètement différente du téléchargement, ce qui est très visible dans la pratique.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Code complet pour EthernetServer.cpp modifié</font></font></b><div class="spoiler_text">/*<br>
 Mod for Arduino Mega Server project<br>
 fix bug delay answer server<br>
*/<br>
<br>
#include «w5100.h»<br>
#include «socket.h»<br>
extern «C» {<br>
#include «string.h»<br>
}<br>
<br>
#include «Ethernet.h»<br>
#include «EthernetClient.h»<br>
#include «EthernetServer.h»<br>
<br>
EthernetServer::EthernetServer(uint16_t port) {<br>
 _port = port;<br>
}<br>
<br>
void EthernetServer::begin() {<br>
 for (int sock = 0; sock &lt; MAX_SOCK_NUM; sock++) {<br>
 EthernetClient client(sock);<br>
 if (client.status() == SnSR::CLOSED) {<br>
 socket(sock, SnMR::TCP, _port, 0);<br>
 listen(sock);<br>
 EthernetClass::_server_port[sock] = _port;<br>
 break;<br>
 }<br>
 } <br>
}<br>
<br>
void EthernetServer::begin_(int sock) {<br>
 EthernetClient client(sock);<br>
 if (client.status() == SnSR::CLOSED) {<br>
 socket(sock, SnMR::TCP, _port, 0);<br>
 listen(sock);<br>
 EthernetClass::_server_port[sock] = _port;<br>
 }<br>
}<br>
<br>
/*<br>
<br>
void EthernetServer::accept() {<br>
 int listening = 0;<br>
<br>
for (int sock = 0; sock &lt; MAX_SOCK_NUM; sock++) {<br>
 EthernetClient client(sock);<br>
<br>
if (EthernetClass::_server_port[sock] == _port) {<br>
 if (client.status() == SnSR::LISTEN) {<br>
 listening = 1;<br>
 } <br>
 else if (client.status() == SnSR::CLOSE_WAIT &amp;&amp; !client.available()) {<br>
 client.stop();<br>
 }<br>
 } <br>
 }<br>
<br>
if (!listening) {<br>
 begin();<br>
 }<br>
}<br>
<br>
*/<br>
<br>
void EthernetServer::accept_(int sock) {<br>
 int listening = 0;<br>
 EthernetClient client(sock);<br>
<br>
if (EthernetClass::_server_port[sock] == _port) {<br>
 if (client.status() == SnSR::LISTEN) {<br>
 listening = 1;<br>
 } <br>
 else if (client.status() == SnSR::CLOSE_WAIT &amp;&amp; !client.available()) {<br>
 client.stop();<br>
 }<br>
 } <br>
<br>
if (!listening) {<br>
 //begin();<br>
 begin_(sock); // added<br>
 }<br>
}<br>
<br>
/*<br>
<br>
EthernetClient EthernetServer::available() {<br>
 accept();<br>
<br>
for (int sock = 0; sock &lt; MAX_SOCK_NUM; sock++) {<br>
 EthernetClient client(sock);<br>
 if (EthernetClass::_server_port[sock] == _port &amp;&amp;<br>
 (client.status() == SnSR::ESTABLISHED ||<br>
 client.status() == SnSR::CLOSE_WAIT)) {<br>
 if (client.available()) {<br>
 // XXX: don't always pick the lowest numbered socket.<br>
 return client;<br>
 }<br>
 }<br>
 }<br>
 return EthernetClient(MAX_SOCK_NUM);<br>
}<br>
<br>
*/<br>
<br>
EthernetClient EthernetServer::available_(int sock) {<br>
 accept_(sock);<br>
 EthernetClient client(sock);<br>
 if (EthernetClass::_server_port[sock] == _port &amp;&amp;<br>
 (client.status() == SnSR::ESTABLISHED ||<br>
 client.status() == SnSR::CLOSE_WAIT)) {<br>
 if (client.available()) {<br>
 return client;<br>
 }<br>
 }<br>
 return EthernetClient(MAX_SOCK_NUM);<br>
}<br>
<br>
size_t EthernetServer::write(uint8_t b) {<br>
 return write(&amp;b, 1);<br>
}<br>
<br>
size_t EthernetServer::write(const uint8_t *buffer, size_t size) {<br>
 size_t n = 0;<br>
 //accept();<br>
<br>
for (int sock = 0; sock &lt; MAX_SOCK_NUM; sock++) {<br>
 accept_(sock); // added<br>
 EthernetClient client(sock);<br>
<br>
if (EthernetClass::_server_port[sock] == _port &amp;&amp;<br>
 client.status() == SnSR::ESTABLISHED) {<br>
 n += client.write(buffer, size);<br>
 }<br>
 }<br>
 return n;<br>
}<br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Code complet pour EthernetServer.h modifié</font></font></b><div class="spoiler_text">/*<br>
 Mod for Arduino Mega Server project<br>
 fix bug delay answer server<br>
*/<br>
<br>
#ifndef ethernetserver_h<br>
#define ethernetserver_h<br>
<br>
#include «Server.h»<br>
<br>
class EthernetClient;<br>
<br>
class EthernetServer: <br>
public Server {<br>
private:<br>
 uint16_t _port;<br>
 //void accept();<br>
 void accept_(int sock);<br>
public:<br>
 EthernetServer(uint16_t);<br>
 //EthernetClient available();<br>
 EthernetClient available_(int sock);<br>
 virtual void begin();<br>
 virtual void begin_(int sock);<br>
 virtual size_t write(uint8_t);<br>
 virtual size_t write(const uint8_t *buf, size_t size);<br>
 using Print::write;<br>
};<br>
<br>
#endif<br>
<br>
</div></div><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problèmes restants</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sous cette forme, le serveur de la démonstration de l'idée entre dans la catégorie des choses qui peuvent être utilisées dans la vie quotidienne, mais certains problèmes subsistent. </font><font style="vertical-align: inherit;">Comme vous pouvez le voir sur la capture d'écran, il n'y a toujours pas de délai fondamental, mais un délai désagréable de trois secondes, qui ne devrait pas l'être. </font><font style="vertical-align: inherit;">La bibliothèque est écrite de telle manière qu'il y a beaucoup d'endroits où le code ne fonctionne pas comme il se doit, et si vous êtes un développeur qualifié, votre aide pour déterminer la cause du retard de trois secondes sera très précieuse. </font><font style="vertical-align: inherit;">À la fois pour le projet Arduino Mega Server et pour tous les utilisateurs d'Arduino.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dernier moment</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puisque nous avons changé le code de la bibliothèque standard, nous devons appeler ses fonctions d'une manière légèrement différente. </font><font style="vertical-align: inherit;">Ici, je donne le code qui fonctionne vraiment et qui a fourni AMS dans la capture d'écran ci-dessus.</font></font><br>
<br>
<pre><code class="java hljs">  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> sock = <span class="hljs-number">0</span>; sock &lt; MAX_SOCK_NUM; sock++) {<font></font>
    EthernetClient sclient = server.available_(sock);<font></font>
    serverWorks2(sclient);<font></font>
  }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ici, la tâche de tri des prises a été transférée au niveau de l'esquisse du client et, plus important encore, et quel est le sens de tout ce qui précède, il n'y a pas de «gel» des demandes. Et la fonction du serveur lui-même:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">serverWorks2</span><span class="hljs-params">(EthernetClient sclient)</span> </span>{<font></font>
...<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez vous familiariser avec le code serveur complet en téléchargeant le kit de distribution sur le site officiel du projet </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arduino Mega Server</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Et vous pouvez poser vos questions sur le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">forum</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Il reste à résoudre le dernier problème d'un délai de trois secondes et nous aurons un vrai serveur rapide sur Arduino. </font><font style="vertical-align: inherit;">Soit dit en passant, une nouvelle version d'AMS sera bientôt publiée avec toutes les corrections et améliorations dans lesquelles l'un des problèmes les plus urgents a été résolu - le travail hors ligne sans prise en charge du serveur MajorDoMo. </font></font><br>
<br>
<img src="http://habrastorage.org/files/ab0/f1b/223/ab0f1b223d6b49848c358847cf2b7959.png" alt="Arduino Mega Server"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et cela est devenu possible en grande partie grâce aux corrections de la bibliothèque Ethernet Arduino standard dont je viens de vous parler. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Addition</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Une chaîne Youtube est ouverte et voici une </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vidéo promo du</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Arduino Mega Server, qui montre comment travailler avec un vrai système.</font></font></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr382565/">https://habr.com/ru/post/fr382565/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr382555/index.html">[Annonce] HyperX a présenté la RAM Fury DDR4 pour la plate-forme Intel Skylake-S Socket 1151</a></li>
<li><a href="../fr382557/index.html">"Bossu, j'ai dit bossu!" Débogage de la position des "servomoteurs" et des "pilotes"</a></li>
<li><a href="../fr382559/index.html">Les voitures peuvent extraire l'énergie des puits sur la route</a></li>
<li><a href="../fr382561/index.html">Sur le développement des têtes d'impression FDM 3D. Partie 1</a></li>
<li><a href="../fr382563/index.html">Lune, personnes et robots</a></li>
<li><a href="../fr382567/index.html">Imprimante 3D VS Axe (Dota2) Partie 1</a></li>
<li><a href="../fr382569/index.html">Quand la beauté n'est pas nécessaire: conception d'un système d'automatisation de restaurant</a></li>
<li><a href="../fr382571/index.html">Bureaucratie dans l'espace: Buzz Aldrin a publié une lettre de voyage pour un voyage sur la lune</a></li>
<li><a href="../fr382573/index.html">Un robot auto-stoppeur meurt à Philadelphie</a></li>
<li><a href="../fr382575/index.html">Des scientifiques de l'Université de Cambridge ont développé un jeu pour aider à traiter les patients schizophrènes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>