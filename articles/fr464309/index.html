<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ú≥Ô∏è üë©‚Äçüîß üéÖüèª Bouton d'appel bricolage. Raspberry Pi, MajorDoMo, Freeswitch et Linphonec üöò üßîüèæ üó£Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Il y a quelque temps, j'avais besoin de communiquer avec une personne apr√®s une maladie qui ne pouvait pas utiliser physiquement le t√©l√©phone. Un simp...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Bouton d'appel bricolage. Raspberry Pi, MajorDoMo, Freeswitch et Linphonec</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/464309/">  Il y a quelque temps, j'avais besoin de communiquer avec une personne apr√®s une maladie qui ne pouvait pas utiliser physiquement le t√©l√©phone.  Un simple dispositif d'appel √©tait n√©cessaire, un appel vocal a √©t√© effectu√© au simple toucher d'un bouton.  Le besoin a disparu, cependant, apr√®s avoir visit√© l'h√¥pital lui-m√™me, en regardant les patients, on pensait qu'une telle solution pourrait √™tre utile. <br>  Maintenant, je vois l'utilisation personnelle de cet appareil comme une sonnette SIP. <br><br>  Peut-√™tre avec de petites modifications, la combinaison de la t√©l√©phonie VoIP avec un syst√®me domotique.  Comme options d'utilisation - sonnette SIP, interphone, syst√®me de communication vocale (client-personnel, directeur-secr√©taire), etc. <br><br><img src="https://habrastorage.org/webt/lr/x1/5g/lrx15gxymgjqei5tsqgkgzxtaiy.jpeg"><br><br>  Toute la d√©cision est prise sur les logiciels libres et open source: syst√®me d'exploitation - Raspbian Stretch (Debian 9), syst√®me domotique - MajorDoMo, serveur VoIP - Freeswitch, client logiciel de t√©l√©phonie IP avec la possibilit√© de travailler en mode terminal Linphonec. <br><br>  Dans cette partie, sous la coupe, nous parlerons principalement de l'installation du client SIP de la console Linphonec. <br><a name="habracut"></a><br>  Nous aurons besoin de: <br><br><ol><li>  Raspberry Pi - Ordinateur monocarte (j'ai un mod√®le Raspberry Pi 3B) </li><li>  Carte m√©moire Micro SD d'au moins 16 Go, chargeur USB, bo√Ætier. </li><li>  Carte son USB (l'une des moins ch√®res, utilis√©e par Gembird), microphone, haut-parleur (casque). </li><li>  Bouton et une paire de cavaliers BBJ pour broches GPIO. </li></ol><br>  1. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Premi√®re √©tape - Installation d'une image MajorDoMo pour RPI</a> <br>  Actuellement, la version actuelle de l'image pour le Raspberry Pi est v.  3.40.  Voici une br√®ve description des images et des modifications de MajorDoMo: <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">Images de base MajorDoMo pour Raspberry Pi</a> <br><br>  Apr√®s l'installation et lorsque le syst√®me d√©marre, connectez les haut-parleurs au connecteur 3.5 - nous entendrons les messages syst√®me et l'adresse IP de Raspberry. <br><br>  Le nom d'utilisateur par d√©faut est: mot de passe pi: framboise. <br><br>  2. Installez FREESWITCH, <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Installation du serveur VoIP FRESWITCH pour Raspberry</a> <br><br>  Apr√®s cela, nous proc√©dons √† l'installation des composants n√©cessaires.  Une √©tape facultative, mais peut-√™tre utile ult√©rieurement. <br><br><h4>  Installer RPi-Monitor </h4><br>  Installez un utilitaire de surveillance RPI petit mais utile qui montre les ressources de notre Raspberry PI. <br><br>  RPi-Monitor est un logiciel de surveillance de carte Raspberry Pi bas√© sur le Web.  Cet outil peut √™tre utile pour contr√¥ler l'utilisation de l'espace disque, la charge CPU, la m√©moire et le trafic r√©seau, la temp√©rature.  RPI-Monitor est assez simple √† installer et affiche visuellement des informations sur le syst√®me. <br><br>  Tout d'abord, je vais donner un lien vers la source: <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">RPi-Monitor</a> . <br><br>  Installez la cl√© publique RPi-Monitor et ajoutez-la aux r√©f√©rentiels approuv√©s: <br><br><pre><code class="plaintext hljs">sudo apt-get install dirmngr sudo apt-key adv --recv-keys --keyserver keyserver.ubuntu.com 2C0D3C0F sudo wget http://goo.gl/vewCLL -O /etc/apt/sources.list.d/rpimonitor.list</code> </pre> <br>  Ensuite, mettez √† jour le syst√®me et installez le moniteur RPI lui-m√™me: <br><br><pre> <code class="plaintext hljs">sudo apt-get update sudo apt-get install rpimonitor</code> </pre><br>  Ouvrez l'IP de votre ordinateur dans le navigateur avec le port: 8888, sur lequel le moniteur fonctionne, et voyez l'√©tat RPI. <br><br><img src="https://habrastorage.org/webt/97/xd/rb/97xdrbtse_r_tukes5aqhdz5c_8.png"><br><br><h4>  Installation d'une carte audio USB et configuration du son dans le syst√®me d'exploitation Raspberry Pi </h4><br>  Malheureusement, notre mini ordinateur Raspberry n'a pas son propre microphone int√©gr√© et une entr√©e pour cela.  Par cons√©quent, pour connecter un microphone, vous devrez utiliser une carte son USB externe.  Nous connectons la carte au port USB Raspberry et ex√©cutons la commande (qui montre les p√©riph√©riques audio du syst√®me): <br><br><pre> <code class="plaintext hljs">cat /proc/asound/cards</code> </pre> <br>  Nous voyons la r√©ponse avec deux cartes, bcm2835 - int√©gr√©es, externes d√©finies comme p√©riph√©rique audio USB: <br><br>  <i>0 [ALSA]: bcm2835_alsa - bcm2835 ALSA</i> <i><br></i>  <i>bcm2835 ALSA</i> <i><br></i>  <i>1 [P√©riph√©rique]: USB-Audio - P√©riph√©rique audio USB</i> <i><br></i>  <i>P√©riph√©rique audio USB GeneralPlus √† usb-3f980000.usb-1.4, pleine vitesse</i> <br>  Le syst√®me d'exploitation voit notre carte son, mais elle n'est pas encore enregistr√©e dans le syst√®me. <br><br>  Cr√©ez un fichier: <br><br><pre> <code class="plaintext hljs">sudo nano /etc/modprobe.d/alsa-base.conf</code> </pre> <br>  Nous √©crivons (collons) la ligne suivante: <br><br>  <i>options index snd-usb-audio = 1</i> <br><br>  Enregistrez (dans l'√©diteur Ctrl + X). <br><br>  Cr√©ez un autre fichier: <br><br><pre> <code class="plaintext hljs">sudo nano /etc/asound.conf</code> </pre> <br>  Ajouter du contenu: <br><br><div class="spoiler">  <b class="spoiler_title">contenu du fichier</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">pcm.!default { type plug slave { pcm "hw:1,0" } } ctl.!default { type hw card 1 }</code> </pre> <br></div></div><br>  Nous √©ditons le fichier de configuration suivant: <br><br><pre> <code class="plaintext hljs">sudo nano /usr/share/alsa/alsa.conf</code> </pre> <br>  Changez la carte son par d√©faut de 0 √† 1 (carte USB). √âvidemment, 0 par d√©faut est la sortie audio int√©gr√©e du mini-ordinateur, d√©finissez les param√®tres suivants sur 2 lignes: <br><br><pre> <code class="plaintext hljs">defaults.ctl.card 1 defaults.pcm.card 1</code> </pre> <br>  Les modifications prendront effet, apr√®s le red√©marrage, on surchargera en tapant dans la console: <br><br><pre> <code class="plaintext hljs">sudo reboot</code> </pre> <br>  Nous connectons un microphone et des haut-parleurs (casque) √† une carte audio externe.  Apr√®s le red√©marrage, ex√©cutez l'utilitaire de configuration du son Alsamixer. <br><br><pre> <code class="plaintext hljs">alsamixer</code> </pre> <br>  Nous voyons nos appareils que nous avons d√©finis dans le syst√®me par d√©faut: <br><br><img src="https://habrastorage.org/webt/bx/em/kt/bxemktswfv1xvsofnautaly542i.png"><br><br>  Utilisez les touches de curseur gauche et droite, s√©lectionnez l'appareil souhait√©, haut et bas, ajustez, faites attention aux symboles sous l'appareil s√©lectionn√©: <br><br>  xOOx - l'appareil est allum√©, xMMx - l'appareil est √©teint.  Comme vous pouvez le voir sur la capture d'√©cran, mon microphone a √©t√© d√©sactiv√© par d√©faut dans le syst√®me. <br>  Pour allumer / √©teindre l'appareil, vous devez appuyer sur <b>M</b> sur le clavier. <br>  Quittez alsamixer (quittez ctr + C). <br>  V√©rification du son dans le syst√®me.  Des haut-parleurs et un microphone sont connect√©s aux sorties USB correspondantes de la carte son. <br><br>  Nous donnons la commande: <br><br><pre> <code class="plaintext hljs">arecord -D plughw:1,0 -f cd /home/pi/test_record.wav</code> </pre> <br>  Avec cette commande, un fichier son est enregistr√© via le microphone dans le r√©pertoire appropri√© (dans notre cas, le home pi de l'utilisateur).  Arr√™tez l'enregistrement <b>Ctrl + c</b> . <br><br>  V√©rifiez le fichier enregistr√©: <br><br><pre> <code class="plaintext hljs">aplay /home/pi/test_record.wav</code> </pre> <br>  Nous effectuerons un meilleur contr√¥le plus tard. <br><br><h4>  Installation du client VoIP de la console Linphonec </h4><br>  Il n'y a pas tellement de programmes qui peuvent fonctionner dans le syst√®me d'exploitation sans interface graphique; je me suis install√© sur le package Linphone. <br><br>  Le paquet est assez grand, il a de nombreuses fonctionnalit√©s potentielles, mais jusqu'√† pr√©sent, nous n'avons besoin que d'un petit utilitaire Linphonec qui peut fonctionner dans le terminal et a la fonction de r√©ponse automatique (ramassage automatique). <br><br>  Pour elle, les actions suivantes seront effectu√©es. <br><br>  Je note que lors de l'installation √† partir du r√©f√©rentiel Raspbian, une version 3.6.1 assez ancienne est install√©e, qui ne fonctionne pas correctement avec le syst√®me audio ALSA, j'ai eu une perte de son, le programme s'est √©cras√© plusieurs fois. <br><br>  Par cons√©quent, j'utiliserai une version plus r√©cente. <br><br>  Pour l'auto-assemblage du package √† partir des sources, nous installons des d√©pendances suppl√©mentaires: <br><br><pre> <code class="plaintext hljs">sudo apt-get install cmake automake autoconf libtool intltool yasm libasound2-dev libpulse-dev libv4l-dev nasm git libglew-dev</code> </pre><br>  Acc√©dez au r√©pertoire personnel: <br><br><pre> <code class="plaintext hljs">cd /home/pi/</code> </pre> <br>  T√©l√©chargez le package Linphone lui-m√™me, le t√©l√©chargement a pris environ 20 minutes. <br><br><pre> <code class="plaintext hljs">git clone git://git.linphone.org/linphone-desktop.git --recursive</code> </pre> <br>  Je ne pouvais pas compiler et compiler le package Linphone de la premi√®re ou m√™me de la deuxi√®me fois.  Par cons√©quent, je vais donner mon algorithme d'action. <br><br>  Nous arr√™tons presque tous les services en cours d'ex√©cution, mais actuellement inutilis√©s, √† l'aide du syst√®me de gestion des services systemctl. <br><br>  Il y a eu des erreurs lors du montage, notre mini PC n'a tout simplement pas assez de ressources.  Lib√©rez-les pour l'installation. <br><br><div class="spoiler">  <b class="spoiler_title">Arr√™t des services</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">sudo systemctl stop freeswitch.service sudo systemctl stop majordomo.service sudo systemctl stop avahi-daemon.socket sudo systemctl stop avahi-daemon.service sudo systemctl stop mosquitto.service sudo systemctl stop mysql sudo systemctl stop mpd.service sudo systemctl stop mpd.socket sudo systemctl stop homebridge.service sudo systemctl stop nginx.service sudo systemctl stop bluetooth.target sudo systemctl stop bluetooth.service</code> </pre><br></div></div><br>  Au cas o√π, nous pouvons cr√©er un fichier d'√©change temporaire (avant de red√©marrer) (espace disque dur), que le syst√®me d'exploitation utilise en cas de RAM insuffisante. <br>  Pour v√©rifier si le fichier d'√©change est inclus dans notre installation Raspbian (Debian) en tapant: <br><br><pre> <code class="plaintext hljs">sudo swapon --show</code> </pre> <br>  La sortie est vide, ce qui signifie que le syst√®me n'a pas de fichier d'√©change. <br>  Ajoutez un swap 1G et cr√©ez un fichier: <br><br><pre> <code class="plaintext hljs">sudo fallocate -l 1G /swapfile</code> </pre> <br>  Seul l'utilisateur root peut lire et √©crire dans le fichier d'√©change, nous d√©finissons donc les autorisations appropri√©es: <br><br><pre> <code class="plaintext hljs">sudo chmod 600 /swapfile</code> </pre> <br>  Nous utilisons l'outil mkswap pour configurer la zone d'√©change Linux dans le fichier et l'activer en tapant les commandes suivantes: <br><br><pre> <code class="plaintext hljs">sudo mkswap /swapfile sudo swapon /swapfile</code> </pre><br>  Acc√©dez au r√©pertoire cr√©√© lors du t√©l√©chargement du package: <br><br><pre> <code class="plaintext hljs">cd linphone-desktop</code> </pre> <br>  Nous pr√©parons pour l'installation une version sans interface graphique: <br><br><pre> <code class="plaintext hljs">sudo ./prepare.py no-ui -DENABLE_OPENH264=ON -DENABLE_WEBRTC_AEC=OFF -DENABLE_UNIT_TESTS=OFF -DENABLE_MKV=OFF -DENABLE_FFMPEG=ON -DENABLE_CXX_WRAPPER=OFF -DENABLE_NON_FREE_CODECS=ON -DENABLE_VCARD=OFF -DENABLE_BV16=OFF -DENABLE_V4L=OFF</code> </pre><br>  G√©n√©rez en utilisant l'attribut ‚Äìj4 (c'est-√†-dire, cr√©ez en 4 threads en m√™me temps. <br><br><pre> <code class="plaintext hljs">sudo make -j4</code> </pre> <br>  Lors de l'installation, nous pouvons regarder l'√©tat de notre ordinateur dans RPI-Monitor: <br><br><img src="https://habrastorage.org/webt/mo/av/vx/moavvxkzq01wxkp5hxayi-oip2y.png"><br><br>  Le temps de construction pour moi √©tait d'environ 30 √† 40 minutes. <br><br>  Les fichiers de programme compil√©s sont apparus dans le r√©pertoire OUTPUT / no-ui / bin.  Pour ex√©cuter le programme, allons-y: <br><br><pre> <code class="plaintext hljs">cd OUTPUT/no-ui/bin</code> </pre> <br>  V√©rifiez la version du programme: <br><br><pre> <code class="plaintext hljs">./linphonec -v</code> </pre> <br>  On obtient le r√©sultat: version: 3.12.0 <br>  Surcharger notre framboise <br>  Au red√©marrage, le fichier d'√©change dispara√Æt, tous les services en cours d'ex√©cution enregistr√©s au d√©marrage sont restaur√©s. <br><br><h4>  Une petite configuration initiale de Freeswitch. </h4><br>  Le serveur FREESWITCH est install√© par d√©faut dans le r√©pertoire / usr / local / freeswitch /.  Le dossier conf contient des fichiers de configuration.  Par d√©faut, la configuration de test vanilla est install√©e, ce qui sert pour la plupart √† vous familiariser avec la possibilit√© d'un serveur VoIP et contient un grand nombre d'exemples qui sont clairement redondants pour un usage domestique.  Tout d'abord, voyons la configuration pr√™te √† l'emploi du serveur VoIP. <br><br>  Modifiez le fichier de configuration vars.xml <br><br><pre> <code class="plaintext hljs">sudo nano /usr/local/freeswitch/conf/vars.xml</code> </pre> <br>  Tout d'abord, remplacez le mot de passe par d√©faut 1234 par une autre valeur, par exemple 1111. Si vous ne le faites pas, avant chaque appel, une pause est d√©finie avant de composer 10 secondes. <br><br>  Par d√©faut, comme je l'ai √©crit dans un article pr√©c√©dent, nous avons 20 num√©ros d'abonn√© 1001-1020.  Dialplan est √©galement install√© par d√©faut. <br><br>  Pour une raison quelconque, ces fois, par rapport √† il y a six mois, lorsque le module mod_xml_rpc √©tait allum√©, le serveur se bloquait constamment. <br><br>  Dialplan FreeSWITCH utilise largement les expressions r√©guli√®res.  Le plan de num√©rotation par d√©faut est responsable du traitement des appels, la section suivante du fichier Local_Extension est responsable de l'envoi √† nos num√©ros locaux.  Commentez quelques lignes: <br><br><pre> <code class="plaintext hljs">sudo nano /usr/local/freeswitch/conf/dialplan/defaults.xml</code> </pre> <br>  √âdition de la bo√Æte de dialogue, ins√©rez un symbole de commentaire dans cette section: <br><br><div class="spoiler">  <b class="spoiler_title">Modification de la bo√Æte de dialogue des num√©ros 1001-1019</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">extension</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Local_Extension"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">condition</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">field</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"destination_number"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">expression</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"^(10[01][0-9])$"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">action</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">application</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"export"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"dialed_extension=$1"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- &lt;action application="bind_meta_app" data="1 bs execute_extension::dx XML features"/&gt; &lt;action application="bind_meta_app" data="2 bs record_session::$${recordings_dir}/${caller_id_number}.${strftime(%Y-%m-%d-%H-%M-%S)}.wav"/&gt; &lt;action application="bind_meta_app" data="3 bs execute_extension::cf XML features"/&gt; &lt;action application="bind_meta_app" data="4 bs execute_extension::att_xfer XML features"/&gt; --&gt;</span></span></code> </pre><br></div></div><br>  <i>Une petite digression, √† mon avis, malgr√© la capacit√© de travail du FS, apr√®s nos plusieurs changements, il est pr√©f√©rable de refaire les fichiers de configuration FS pour vous-m√™me, y compris</i>  <i>abonnement, plan de num√©rotation, etc., mais vous ne pouvez pas tout ranger dans un seul article, nous nous tournons donc vers notre client terminal.</i> <br><br><h4>  Configurer et lancer le client terminal Linphonec </h4><br>  Ex√©cutez Linphonec en mode de r√©ponse automatique √† partir de l'utilisateur pi actuel: <br><br><pre> <code class="plaintext hljs">/home/pi/linphone-desktop/OUTPUT/no-ui/bin/linphonec -a</code> </pre> <br>  Au premier lancement, Linphonec essaie de cr√©er un fichier de base de donn√©es et un fichier de param√®tres.  Cependant, le lancement est par erreur. <br><br><div class="spoiler">  <b class="spoiler_title">erreur au d√©marrage de linphonec</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">2019-08-02 18:02:58:715 mediastreamer-error-Connection to the pulseaudio server failed 2019-08-02 18:02:58:946 belle-sip-error-udp bind() failed for ::0 port 5060: Address already in use 2019-08-02 18:02:58:947 belle-sip-error-TCP bind() failed for ::0 port 5060: Address already in use 2019-08-02 18:02:59:126 liblinphone-fatal-Unable to open linphone database. Aborted</code> </pre> <br></div></div><br>  Dans un premier temps, nous traiterons de la derni√®re erreur, en ouvrant le fichier de base de donn√©es. <br><br>  Le fichier de base de donn√©es est cr√©√© dans le r√©pertoire personnel le long du chemin suivant: /home/pi/.local/share/linphone <br>  Un fichier (ou r√©pertoire) Linux est consid√©r√© comme masqu√© si son nom commence par un point ".".  Par exemple, ".myfile".  En r√®gle g√©n√©rale, ces fichiers sont utilis√©s par les applications pour stocker les param√®tres, les configurations et d'autres informations qui doivent √™tre cach√©es √† l'utilisateur. <br>  Cr√©er un r√©pertoire √† partir de l'utilisateur actuel (pi) <br><pre> <code class="plaintext hljs">mkdir /home/pi/.local mkdir /home/pi/.local/share mkdir /home/pi/.local/share/linphone</code> </pre> <br>  Nous d√©marrons le programme, le programme a d√©marr√©, mais il donne une erreur: <br><div class="spoiler">  <b class="spoiler_title">Erreur d'ouverture de port</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">2019-08-07 11:29:32:780 mediastreamer-error-Connection to the pulseaudio server failed 2019-08-07 11:29:32:866 belle-sip-error-udp bind() failed for ::0 port 5060: Address already in use 2019-08-07 11:29:32:866 belle-sip-error-TCP bind() failed for ::0 port 5060: Address already in use</code> </pre> <br></div></div><br>  Nous avons d√©couvert le premier probl√®me de cr√©ation d'une base de donn√©es; au lancement initial, le programme a g√©n√©r√© un fichier de base de donn√©es. <br><br>  L'erreur associ√©e au syst√®me audio Pulseaudio - n'interf√®re pas avec le fonctionnement du programme, je pr√©vois d'utiliser ALSA, si n√©cessaire, un serveur audio peut toujours √™tre install√© avant. <br><br>  Le second - les ports 5060 sont occup√©s.  Ces ports sont couramment utilis√©s par les applications SIP.  Nous pouvons quitter le programme et donner la commande: <br><br><pre> <code class="plaintext hljs">sudo netstat -tulpn | grep LISTEN</code> </pre> <br>  Nous verrons que le port 5060 utilise notre serveur VoIP FREESWITCH.  Eh bien, nous utiliserons des ports gratuits. <br><br>  Nous revenons au programme linphonec.  Et faites un peu de configuration. <br><br>  Tout d'abord, changez le port pour Linfon, puis indiquez l'enregistrement sur le serveur VoIP, v√©rifiez l'√©tat de l'enregistrement et consultez la liste des cartes son, la carte utilis√©e et configurez-la sur une cl√© USB externe (avec l'index dans le programme Linphone - 2): <br><br><pre> <code class="plaintext hljs">ports sip 5062 register sip:1001@192.168.15.13 192.168.15.13 1111 linphonec&gt; help register status register soundcard list soundcard show soundcard use 2 soundcard show</code> </pre><br><img src="https://habrastorage.org/webt/o3/1u/3d/o31u3dvxihunuxmqclxmbfkwfng.png"><br><br>  Dans l'√©quipe d'inscription, nous utilisons le format suivant: ID utilisateur Sip - par d√©faut, nous avons 20 abonn√©s avec les num√©ros 1001-1019.  Ces num√©ros sont les noms d'utilisateurs des abonn√©s Connexion abonn√© @ [Nom de domaine] - nom de domaine - Adresse IP de notre Raspberry.  Sip proxy - correspond √† l'adresse IP RPI et, √† la fin, au mot de passe de l'utilisateur que nous avons r√©cemment configur√© 1111. <br><br>  Quittez le programme (Ctrl + x), les param√®tres ne sont pas toujours appliqu√©s √† la vol√©e.  Apr√®s avoir quitt√© le r√©pertoire personnel / home / pi, le fichier de configuration du client de la console est apparu: .linphonerc. <br>  Nous pouvons d√©j√† apporter des modifications en √©ditant le fichier de configuration du client SIP. <br>  Sur une nouvelle console de lancement client SIP. <br>  Parall√®lement √† la session SSH en cours, ouvrez-en une nouvelle, connectez-vous en utilisant votre nom d'utilisateur et votre mot de passe. <br>  Nous commen√ßons alsamixer.  Dans une session, nous avons Linphonec, dans la seconde, un utilitaire de r√©glage du son. <br>  Nous effectuons la configuration de l'appel √† partir du client SIP sur un smartphone ou un PC (comme d√©crit dans l'article sur l'installation de FREESWITCH) en changeant le mot de passe par d√©faut en votre propre et en composant un num√©ro, dans notre cas 1001. Nous pouvons aller sur le portail freswitch √† IP_Raspberry: 8080, voir l'enregistrement des abonn√©s, le statut appeler, etc. <br><br><img src="https://habrastorage.org/webt/wu/qq/ta/wuqqta-dhsd0j8nr_mixybesqam.png"><br><br>  En utilisant alsamixer, nous ajustons le son.  Les modifications sonores sont appliqu√©es √† la vol√©e, sans quitter les programmes. <br><br>  Malheureusement, en raison de l'utilisation d'une carte audio bon march√©, je n'ai pas pu obtenir un son acceptable, un √©cho a √©t√© entendu dans les haut-parleurs.  Il peut √™tre minimis√© quelque peu, mais compl√®tement supprim√© - je n'ai pas r√©ussi. <br><br>  Par cons√©quent, comme il n'a pas √©t√© possible de le supprimer d'une mani√®re, nous l'√©liminons d'une autre. <br>  Fermez Linphonec, √©ditez le fichier de configuration: <br><br><pre> <code class="plaintext hljs">sudo nano /home/pi/.linphonerc</code> </pre> <br>  Dans la section son, nous apportons les trois derni√®res lignes √† ce formulaire: <br><br><div class="spoiler">  <b class="spoiler_title">Section du son de Linphonerc</b> <div class="spoiler_text"><pre> <code class="xml hljs">[sound] remote_ring=/home/pi/linphone-desktop/OUTPUT/no-ui/share/sounds/linphone/ringback.wav playback_gain_db=0.000000 mic_gain_db=0.000000 ringer_dev_id=ALSA: bcm2835 ALSA playback_dev_id=ALSA: bcm2835 ALSA capture_dev_id=ALSA: USB Audio Device</code> </pre><br></div></div><br>  De cette fa√ßon, nous avons forc√© la sonnerie et le p√©riph√©rique de sortie audio √† fonctionner sur la prise framboise 3,5 int√©gr√©e, et le p√©riph√©rique d'enregistrement - le microphone fonctionnant via une carte son externe - l'√©cho a disparu. <br><br>  Basculez les haut-parleurs sur le propre connecteur de la framboise. <br><br>  Nous prenons en compte le moment suivant: lors du chargement et dans certains cas, le syst√®me de maison intelligente lit ses messages syst√®me via cette sortie audio. <br><br>  √âteignez-les.  Nous passons IP_Rasberry √† la page principale, ouvrant le syst√®me domotique MajorDoMo. <br><br>  Nous entrons dans le panneau de configuration - l'objet Ordinateur (d√©veloppez l'appareil) - ThisComputer sur l'onglet Propri√©t√©s et d√©finissons les valeurs: <br><br><pre> <code class="plaintext hljs"> ThisComputer.minMsgLevel 100 ThisComputer.volumeLevel 0</code> </pre> <br><img src="https://habrastorage.org/webt/tr/to/tj/trtotjj9oalk1kj-3tddund0ggi.png"><br><br>  Ajoutez une entr√©e √† cron (un programme d√©mon con√ßu pour effectuer des t√¢ches √† un moment pr√©cis ou √† certains intervalles. L'utilitaire crontab est utilis√© pour modifier des t√¢ches): <br><br><pre> <code class="plaintext hljs">crontab ‚Äìe</code> </pre> <br>  Je note que nous faisons cela sous l'utilisateur pi. <br><br>  Ins√©rez la ligne √† la toute fin: <br><br><pre> <code class="xml hljs">@reboot /home/pi/linphone-desktop/OUTPUT/no-ui/bin/linphonec ‚Äìa</code> </pre> <br>  Lors du red√©marrage, de la mise sous tension de l'ordinateur, cette ligne lance le programme Linphonec en mode de r√©ponse automatique. <br>  Retour √† MajorDoMo: <br>  Allons √† la page principale, dans la section service: <br>  Dans le menu de cette section, des boutons sont cr√©√©s pour red√©marrer (√©teindre) l'ordinateur. <br>  Le fait est que pour √©conomiser les ressources de la carte m√©moire SD, les modifications sont enregistr√©es dans le syst√®me ¬´maison intelligente¬ª apr√®s un certain temps (15 minutes).  Par cons√©quent, si vous devez surcharger les framboises, il est pr√©f√©rable de le faire correctement.  Nous red√©marrons le syst√®me. <br><br><img src="https://habrastorage.org/webt/bn/wl/dg/bnwldg1njtqrveligvtgmkm9iya.png"><br><br>  Apr√®s le red√©marrage, acc√©dez √† la page principale de MajorDoMo, acc√©dez au panneau de configuration et, comme dans le dernier article, nous appelons √† partir de la console en utilisant le format suivant: <br><br><pre> <code class="xml hljs">GetURL("http://freeswitch:works@192.168.1.103:8080/webapi/originate?user/1001%201003%20XML%20default")</code> </pre> <br>  Apr√®s la commande, Linphonec d√©croche automatiquement le t√©l√©phone.  Dans le haut-parleur RPI, un fichier son est en cours de lecture, un appel est envoy√© vers le second softphone (PC / smartphone).  Apr√®s avoir d√©croch√© le combin√© (en appuyant sur le bouton de r√©ponse dans le programme), la connexion est √©tablie. <br><br><img src="https://habrastorage.org/webt/ry/4p/qk/ry4pqktur2kidele7g7hvs0mgou.png"><br><br>  Sur ce, je termine cette partie.  J'essaierai de d√©crire un peu plus tard le bouton lui-m√™me en utilisant GPIO et en configurant des appels en dehors de mon r√©seau local. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr464309/">https://habr.com/ru/post/fr464309/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr464295/index.html">Exemples d'utilisation de nouvelles fonctionnalit√©s JavaScript</a></li>
<li><a href="../fr464299/index.html">0, 0, 1, 0, 2, 0, 2, 2, 1, 6, 0, 5, 0, 2, 6, 5, 4, 0, 5, 3, 0, 3, 2, 9, 0, 4, 9, 3, 6, 14, 0, 6, 3, 5, 15, 0, 5, 3, 5 ...</a></li>
<li><a href="../fr464303/index.html">Donn√©es de s√©ries chronologiques dans un SGBD relationnel. Extensions TimescaleDB et PipelineDB pour PostgreSQL</a></li>
<li><a href="../fr464305/index.html">Petit, oui. D√©ballage du p√©tard microvirtuel</a></li>
<li><a href="../fr464307/index.html">Test d'int√©gration de microservices sur Scala</a></li>
<li><a href="../fr464315/index.html">Le film dans lequel il y avait de la terre. Recherche sur Yandex et bref historique de la recherche par sens</a></li>
<li><a href="../fr464317/index.html">Projet Konbanwa</a></li>
<li><a href="../fr464325/index.html">Comment Scrumban unit le meilleur des m√©thodologies Kanban et Scrum</a></li>
<li><a href="../fr464327/index.html">Comparaison de l'utilisation de la m√©moire des diff√©rentes interfaces graphiques de la bo√Æte √† outils</a></li>
<li><a href="../fr464331/index.html">Avantages inutiles: synth√®se de produits chimiques absorbant les UV √† partir de noix de cajou</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>