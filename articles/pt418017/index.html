<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üè£ üëÑ üíÉüèΩ An√°lise do comportamento do Trojan Pegasus na rede üí¥ üçá ü¶ê</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O c√≥digo fonte do Trojan banc√°rio Pegasus foi publicado recentemente. Apesar da men√ß√£o do grupo Carbanak em nome do arquivo, pesquisadores do Minerva ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>An√°lise do comportamento do Trojan Pegasus na rede</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pt/blog/418017/">  O c√≥digo fonte do Trojan banc√°rio Pegasus foi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">publicado</a> recentemente.  Apesar da men√ß√£o do grupo Carbanak em nome do arquivo, pesquisadores do Minerva Labs <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">negaram o</a> envolvimento do Trojan nesse grupo e provaram seu envolvimento no grupo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Buhtrap</a> (Ratopak).  Dentro do arquivo, h√° uma breve descri√ß√£o do trabalho do Trojan, seus c√≥digos-fonte, uma descri√ß√£o do sistema de pagamento banc√°rio e os dados de funcion√°rios de muitos bancos russos. <br><br>  A arquitetura do c√≥digo-fonte desse malware √© bastante interessante.  A funcionalidade √© dividida em m√≥dulos montados em um √∫nico "binpack" no est√°gio de compila√ß√£o.  O processo de compila√ß√£o tamb√©m inclui a assinatura de arquivos execut√°veis ‚Äã‚Äãcom um certificado do arquivo tric.pfx, que n√£o est√° no arquivo morto. <br><br>  N√£o menos curiosa √© a atividade de rede do Pegasus, que, ap√≥s a infec√ß√£o, tenta se espalhar dentro do dom√≠nio e sabe como proxy de dados entre m√°quinas que usam pipes e o transporte Mailslot.  N√≥s nos concentramos em estudar os recursos da atividade de rede do Trojan e adicionamos rapidamente o Pegasus detecta o produto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">PT Network Attack Discovery</a> .  Isso permitir√° que todos os seus usu√°rios detectem oportunamente a atividade desse cavalo de Troia e suas modifica√ß√µes na rede.  Neste artigo, darei uma descri√ß√£o detalhada dos mecanismos de distribui√ß√£o de rede e a intera√ß√£o entre c√≥pias do Pegasus. <br><br><img src="https://habrastorage.org/webt/yn/sn/-u/ynsn-udu1ai9y-xbrolf4fubrta.png"><a name="habracut"></a><br><br><h2>  Introdu√ß√£o </h2><br>  Uma vez na m√°quina, o m√≥dulo principal InstallerExe injeta o c√≥digo no svchost.exe usando a t√©cnica Process Hollowing e, ap√≥s inicializar os m√≥dulos principais, o Pegasus inicia v√°rios processos paralelos: <br><br><ol><li>  Replica√ß√£o de Dom√≠nio - envolve intelig√™ncia na rede e tenta se espalhar para outras m√°quinas Windows. </li><li>  O Ouvinte do Mailslot ouve mensagens de broadcast do slot de correio, atrav√©s das quais o Pegasus envia contas mineradas.  O nome do slot √© gerado em tempo de compila√ß√£o. </li><li>  O ouvinte do servidor de tubos escuta o tubo do Windows com o nome gerado em nome da m√°quina.  Esses tubos s√£o usados ‚Äã‚Äãprincipalmente para detectar outras c√≥pias do Pegasus na rede e sua intera√ß√£o. </li><li>  Senhas de logon periodicamente, a cada poucos minutos, tentam despejar dados da conta com um m√≥dulo da Mimikatz. </li><li>  A conectividade de rede √© respons√°vel pela comunica√ß√£o com o servidor CnC e mensagens peri√≥dicas. </li></ol><br><pre><code class="bash hljs">// start transports <span class="hljs-built_in"><span class="hljs-built_in">which</span></span> links data with our CB-manager pwInitPipeServerAsync(dcmGetServerCallback()); mwInitMailslotServer(dcmGetServerCallback()); ... // start broadcasting creds to other machines cmStartupNetworkBroadcaster();</code> </pre> <br><h2>  Replica√ß√£o de dom√≠nio </h2><br>  Um dos subsistemas do Pegasus √© respons√°vel pelo movimento lateral em uma rede Windows.  A distribui√ß√£o √© dividida em duas etapas importantes: <br><br><ol><li>  Detec√ß√£o de carros vizinhos. </li><li>  Tentativa de replica√ß√£o em uma m√°quina. </li></ol><br>  A descoberta de m√°quinas vizinhas em um dom√≠nio √© feita atrav√©s de duas chamadas de API: <br><br><img src="https://habrastorage.org/webt/-p/6f/sj/-p6fsjb6pe8v-rdjacycwncholk.png" align="left">  NetServerEnum, que requer o servi√ßo Navegador e chama WNetOpenEnum / WNetEnumResource. <br>  Todas as m√°quinas encontradas no dom√≠nio devem ser verificadas se j√° estiverem infectadas.  O Pegasus pesquisa o nome do tubo gerado a cada 200 milissegundos por mais de 20 vezes seguidas.  Usamos esse comportamento anormal como um dos indicadores da atividade do Pegasus no dom√≠nio.  Como n√£o detectou nenhum sinal de infec√ß√£o, o malware prossegue para a pr√≥xima etapa - tentativa de replica√ß√£o. <br><br><img src="https://habrastorage.org/webt/j0/nw/yl/j0nwylxgv6mvqzd8krxwf2su2x8.png" align="left">  A replica√ß√£o √© a seguinte.  Usando as contas encontradas (KM) no host, o Pegasus tenta efetuar login na m√°quina usando o protocolo SMB nas esferas IPC $ e ADMIN $ e, se houver acesso ao IPC $ e n√£o houver acesso ao ADMIN $, o Pegasus conclui que est√° certo a conta √© insuficiente e deve ser marcada como inv√°lida.  Tendo obtido acesso ao ADMIN $ ball, que √© um alias para a pasta% windir%, o malware tenta determinar a arquitetura da m√°quina para usar o m√≥dulo apropriado no futuro. <br><br>  O algoritmo de determina√ß√£o da arquitetura √© baseado em cabe√ßalhos de arquivo PE na m√°quina remota.  Como um arquivo, o Pegasus tenta ler os 4 primeiros kilobytes do notepad.exe na pasta% windir%.  Uma desvantagem √≥bvia desse m√©todo √© que, no Windows Server 2012, o bloco de notas est√° localizado no caminho% windir% \ System32. <br><br>  Localiza√ß√£o notepad.exe no Windows 7: <br><br><pre> <code class="bash hljs">C:\Users\Administrator&gt;<span class="hljs-built_in"><span class="hljs-built_in">where</span></span> notepad.exe C:\Windows\System32\notepad.exe C:\Windows\notepad.exe</code> </pre><br>  No Windows Server 2012: <br><br><pre> <code class="bash hljs">C:\Users\Administrator&gt;<span class="hljs-built_in"><span class="hljs-built_in">where</span></span> notepad.exe C:\Windows\System32\notepad.exe</code> </pre><br>  Se n√£o detectar o notepad.exe, o Pegasus n√£o poder√° infectar o servidor, mesmo que tenha informa√ß√µes da conta com os direitos necess√°rios.  A simples aus√™ncia de bloco de notas em% windir% pode interromper a distribui√ß√£o do Pegasus no Windows Server 2012. O uso do regedit.exe a esse respeito √© mais confi√°vel. <br><br>  Ap√≥s definir com √™xito a arquitetura do servidor de destino, o Pegasus carrega um pequeno conta-gotas RSE (Remote Service Exe) com cerca de 10 kilobytes de tamanho, cuja tarefa √© carregar o pacote de bin dos m√≥dulos Pegasus atrav√©s do tubo de forma clara e transferir o controle para o m√≥dulo Shellcode.  O nome do conta-gotas √© composto de maneira pseudo-aleat√≥ria e consiste em uma sequ√™ncia de caracteres hexadecimais de 8 a 15 caracteres.  O gerador pseudo-aleat√≥rio √© inicializado dependendo do nome da m√°quina de destino e ser√° o mesmo entre as partidas para evitar poss√≠veis desordens de% windir% com c√≥pias anteriores do conta-gotas. <br><br><img src="https://habrastorage.org/webt/pu/qb/hf/puqbhf_9-i8k7civefzklrqegxk.png"><br><br>  O conta-gotas √© verificado quanto √† integridade e poss√≠vel exclus√£o pelo antiv√≠rus, ap√≥s o qual √© iniciado por um dos dois mecanismos implementados - SCM ou WMI, e primeiro o Pegasus tenta iniciar o RSE por meio do mecanismo WMI e, somente depois, usando o Service Control Manager (SCM).  Isso ocorre porque o SCM deixa mais rastreamentos nos logs do Windows.  Os criadores do Pegasus tamb√©m planejaram outros m√©todos de distribui√ß√£o - Wsh Remote, Powershell Remoting, Task Scheduler e um m√≥dulo para executar comandos via RDP estava em desenvolvimento. <br><br>  Como mencionado acima, ap√≥s um lan√ßamento bem-sucedido, o conta-gotas verifica e abre o canal para ouvir e transfere o controle para a carga √∫til recebida. <br><br><img src="https://habrastorage.org/webt/od/zt/to/odztto9o8_yrp0galq3-9_owej4.png"><br><br>  Como o c√≥digo Pegasus √© injetado pelo m√©todo Process Hollowing no processo svchost.exe, nem o m√≥dulo InstallerExe original deve permanecer no disco no caso de uma infec√ß√£o prim√°ria, nem o conta-gotas RSE no caso de distribui√ß√£o.  Se o conta-gotas ainda estiver acess√≠vel por um caminho conhecido, o Pegasus o remover√° do seu pr√≥prio modo: <br><br><ol><li>  substituindo o conte√∫do do arquivo por dados aleat√≥rios; </li><li>  sobrescrever com dados vazios (zeros); </li><li>  renomear arquivo; </li><li>  exclus√£o de arquivo. </li></ol><br><img src="https://habrastorage.org/webt/up/ti/uy/uptiuydt0vx1zc9lz29l2kcdy80.png"><br><br>  Ap√≥s uma infec√ß√£o bem-sucedida, o processo de distribui√ß√£o da Replica√ß√£o de Dom√≠nio √© iniciado novamente. <br><br><h2>  Trabalhos de e-mail </h2><br><img src="https://habrastorage.org/webt/z1/oa/hu/z1oahuoskry5bzymotu4d6n_9kk.png" align="left">  Depois que o Pegasus obtiver acesso aos dados da conta de outra c√≥pia do Pegasus ou do m√≥dulo mod_LogonPasswords, ele come√ßar√° a transmitir dados dos EUA por dom√≠nio.  A distribui√ß√£o √© realizada usando o mecanismo SMB baseado em Mailslot, que permite a transmiss√£o unidirecional de uma pequena por√ß√£o de dados em um dom√≠nio.  A distribui√ß√£o ocorre de acordo com um nome de slot gerado aleatoriamente e, para que todas as m√°quinas infectadas no dom√≠nio possam enviar e receber dados por um √∫nico nome, o gerador pseudo-aleat√≥rio de nomes √© inicializado a partir da vari√°vel TARGET_BUILDCHAIN_HASH especificada na configura√ß√£o durante a compila√ß√£o. <br><br>  Como o mecanismo Mailslot imp√µe um limite no tamanho m√°ximo do pacote, apenas um KM √© enviado por vez, de acordo com o princ√≠pio da √∫ltima hora de correspond√™ncia: entre todos os KMs dispon√≠veis, o dom√≠nio cuja √∫ltima data de correspond√™ncia √© a mais antiga √© enviado por dom√≠nio. <br><br><img src="https://habrastorage.org/webt/e6/rw/wt/e6rwwt8svxdb_yzrszemgjeonlk.png" align="right">  Os dados no Mailslot n√£o s√£o transmitidos em texto n√£o criptografado, mas agrupados em tr√™s camadas de criptografia XOR, e as chaves s√£o transmitidas junto com os dados.  A primeira camada de dados √© o envelope NetMessageEnvelope com verifica√ß√£o de integridade de dados pelo algoritmo SHA1, usado para todos os dados transmitidos pela rede local.  4 bytes de dados no in√≠cio do pacote s√£o a chave, que √© alterada por mudan√ßas de bits de 5 bits √† direita por ciclo.  Dentro do envelope, h√° uma estrutura de dados codificada em XOR com campos diretos nos EUA e a data em que foram adicionados.  A chave de 8 bytes tamb√©m est√° localizada no in√≠cio da estrutura, mas √© aplicada sem compensa√ß√µes.  Ap√≥s decodificar a estrutura do KM, resta apenas desserializar os campos individuais das estruturas ENC_BUFFER, como nome do computador, nome do dom√≠nio, nome do usu√°rio e senha.  Esses campos s√£o criptografados com uma chave de 8 bytes com compensa√ß√µes.  O script para descriptografar o pacote Mailslot e um exemplo desse pacote podem ser encontrados aqui: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">script</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">PCAP</a> . <br><br>  O per√≠odo para o envio de mensagens do Mailslot na vers√£o de lan√ßamento varia de 20 segundos a 11 minutos. <br><br><pre> <code class="bash hljs">// some random <span class="hljs-built_in"><span class="hljs-built_in">wait</span></span> before making next step DbgPrint(<span class="hljs-string"><span class="hljs-string">"going to sleep"</span></span>); <span class="hljs-comment"><span class="hljs-comment">#ifdef _DEBUG // debug - 2-5 s Sleep(rg.rgGetRnd(&amp;rg, 2000, 5000)); #else // release - 20 - 650 s //Sleep(rg.rgGetRnd(&amp;rg, 2000, 65000) * 10); Sleep(rg.rgGetRnd(&amp;rg, 2000, 15000)); #endif</span></span></code> </pre> <br>  Al√©m de trocar contas, o mecanismo Mailslot √© usado para procurar uma m√°quina infectada com acesso √† Internet e para anunciar o acesso √† Internet.  O envelope NetMessageEnvelope armazena o tipo de mensagem que est√° sendo enviada.  A troca de dados entre a m√°quina sem acesso e a m√°quina com acesso √† Internet √© realizada atrav√©s dos tubos. <br><br><h2>  Obras de tubula√ß√£o </h2><br>  Para comunica√ß√£o bidirecional ou transfer√™ncia de grandes quantidades de dados, as c√≥pias Pegasus usam pipes como canal de comunica√ß√£o.  O nome do canal, embora tamb√©m seja gerado por um gerador pseudo-aleat√≥rio, mas depende do nome da m√°quina e da constru√ß√£o e, portanto, permite que as partes do cliente e do servidor usem o mesmo nome. <br><br>  Na comunica√ß√£o unidirecional, por exemplo, ao transferir o binpack durante a replica√ß√£o para outra m√°quina, os dados n√£o s√£o criptografados e transmitidos de forma clara.  O Binpack come√ßa com uma estrutura SHELLCODE_CONTEXT com um comprimento de 561 bytes. <br><br><img src="https://habrastorage.org/webt/qf/ja/89/qfja89-eipqz2lncisi7fkcuqbe.png"><br><br>  Durante a transmiss√£o bidirecional, por exemplo, proxy de dados entre uma c√≥pia do Pegasus sem acesso √† Internet e um servidor CnC, a mesma estrutura de envelope NetMessageEnvelope com criptografia XOR √© usada como no caso do Mailslot, porque  permite distinguir entre diferentes tipos de mensagens no campo id. <br><br>  Em termos de arquitetura, o proxy de dados √© realizado por meio de uma solicita√ß√£o para transferir uma parte dos dados (PMI_SEND_QUERY), receber a identifica√ß√£o da solicita√ß√£o em resposta e consultar o status da tarefa por identifica√ß√£o (PMI_CHECK_STATUS_QUERY).  Como regra, outra estrutura do Envelope √© transferida como carga, adicionando v√°rias funcionalidades e outra camada de criptografia. <br><br>  Al√©m disso, trabalhar com pipes n√£o termina na intera√ß√£o entre m√°quinas infectadas.  O m√≥dulo mod_KBRI_hd injeta c√≥digo nos processos cmd.exe que intercepta as chamadas MoveFileExW e analisa todos os dados que est√£o sendo copiados, pois isso faz parte do processo de pagamento.  Se o arquivo copiado contiver dados de interesse dos invasores - dados com pagamentos, uma notifica√ß√£o sobre isso ser√° enviada ao servidor CnC.  A comunica√ß√£o entre o m√≥dulo mod_KBRI injetado no cmd.exe e uma c√≥pia do Pegasus √© realizada dentro da m√°quina infectada por meio de um canal cujo nome n√£o √© gerado, mas est√° codificado no c√≥digo fonte: <br><br><pre> <code class="bash hljs">\.\pipe\pg0F9EC0DB75F67E1DBEFB3AFA2</code> </pre> <br><img src="https://habrastorage.org/webt/xr/eh/uj/xrehuj7ia40r-g4ka-osjtq9gjc.png" align="left">  A funcionalidade do m√≥dulo tamb√©m inclui a substitui√ß√£o de contas de dados em tempo real, de acordo com o modelo.  Um exemplo de padr√µes para pesquisar na captura de tela. <br><br><h2>  Tr√°fego Cnc </h2><br>  Um fluxo separado √© respons√°vel pela troca direta de dados com o servidor CnC, que verifica a fila de blocos de dados de processos internos ou outras c√≥pias de malware a cada poucos minutos e os envia ao servidor. <br><br>  Durante a inicializa√ß√£o do m√≥dulo mod_NetworkConnectivity, ele executa uma verifica√ß√£o de v√°rios est√°gios da conex√£o de rede: <br><br>  1) Detectando configura√ß√µes do servidor proxy e tentando se conectar ao <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">www.google.com</a> : <br><br><ul><li>  Na ramifica√ß√£o do registro \\ Software \\ Microsoft \\ Windows \\ CurrentVersion \\ Internet Settings. </li><li>  Via WPAD (chame WinHttpGetProxyForUrl). </li><li>  Por meio da configura√ß√£o de proxy para o usu√°rio atual (chame WinHttpGetIEProxyConfigForCurrentUser). </li></ul><br>  2) Verificando a conex√£o com os servidores de atualiza√ß√£o da Microsoft e os dados retornados ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">authrootseq.txt</a> , <a href="">authrootstl.cab</a> , <a href="">rootsupd.exe</a> ) <br><br>  3) Testando conex√µes HTTPS com um dos 6 endere√ßos: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">safebrowsing.google.com</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aus3.mozilla.org</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">addons.mozilla.org</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">fhr.data.mozilla.com</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">versioncheck-bg.addons.mozilla.org</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">services.addons.mozilla.org</a> </li></ul><br>  Somente ap√≥s passar todas as verifica√ß√µes, a Pegasus acredita que possui o acesso necess√°rio √† rede externa e pode anunciar isso atrav√©s do dom√≠nio Mailslot com uma mensagem.  Al√©m disso, o Pegasus pode se disfar√ßar e se comunicar com o servidor CnC apenas durante o hor√°rio comercial - das 9h √†s 19h, hor√°rio local. <br><br>  O Pegasus envia peda√ßos de dados embrulhados em um envelope com o c√°lculo do hash da quantia no formato criptografado usando a criptografia DES no modo CRYPT_MODE_CBC / PKCS5_PADDING.  A chave de criptografia depende apenas da vari√°vel durante a compila√ß√£o e, portanto, podemos descriptografar o tr√°fego entre o malware e o servidor, conhecendo apenas seu BUILDCHAIN_HASH.  No c√≥digo-fonte dentro do arquivo morto, essa vari√°vel tinha o valor 0x7393c9a643eb4a76.  Um script para descriptografar o Check-in no servidor e um exemplo desse pacote podem ser encontrados aqui: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">script</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">PCAP</a> . <br><br>  Ele transfere esse conte√∫do (estrutura INNER_ENVELOPE) para o servidor CnC durante o Check-in ou junto com qualquer dado.  Inicialmente, existem 28 bytes de um envelope com um campo de comprimento e uma soma SHA1. <br><br><img src="https://habrastorage.org/webt/po/zs/7s/pozs7shklsxh653kgnbxkgnmgl0.png"><br><br>  Os mesmos dados s√£o transferidos entre m√°quinas durante o proxy atrav√©s de pipes, mas agrupados dentro do envelope NetMessageEnvelope que conhecemos com uma soma de hash e criptografia XOR. <br><br>  O operador CnC pode enviar comandos para execu√ß√£o √†s c√≥pias e mensagens do Pegasus com comandos ou outros dados, por exemplo, EID_CREDENTIALS_LIST pode conter suas pr√≥prias camadas de criptografia de campo, como vimos no exemplo de contas de transmiss√£o. <br><br><h2>  Detec√ß√£o </h2><br>  Antes de tudo, est√°vamos interessados ‚Äã‚Äãem detectar a atividade do Pegasus na rede e, depois de estudar cuidadosamente os c√≥digos-fonte e executar no ambiente de teste, descobrimos essas anomalias e artefatos de rede que indicam claramente a presen√ßa desse malware complexo na rede.  O Pegasus realmente pode ser chamado de vers√°til - ele usa ativamente o protocolo SMB para enviar mensagens e estabelecer comunica√ß√£o com outras c√≥pias, se espalha para outras m√°quinas e se comunica com o servidor CnC de maneira especial.  Ao instalar uma rede ponto a ponto no dom√≠nio, as c√≥pias do Pegasus abrem caminho para a rede externa e se comunicam com o servidor CnC ao proxyizar o tr√°fego entre si.  O uso de certificados para assinar arquivos execut√°veis ‚Äã‚Äãe o acesso aos recursos da Microsoft e Mozilla durante a verifica√ß√£o da conex√£o dificulta a detec√ß√£o de sua atividade e detec√ß√£o no host. <br><br>  O projeto de c√≥digo-fonte do Pegasus √© bastante bem estruturado e descrito, portanto, em um futuro pr√≥ximo, podemos esperar o empr√©stimo de partes de seu c√≥digo por outros programas maliciosos e o aparecimento de modifica√ß√µes. <br><br>  Muitos dos mecanismos para executar comandos remotamente e pesquisar dados da conta permaneceram n√£o realizados, os desenvolvedores tamb√©m adicionariam a capacidade de alterar o c√≥digo de shell durante a implementa√ß√£o em tempo real.  E estas n√£o s√£o todas as suas id√©ias. <br><br>  Desenvolvemos v√°rias assinaturas para PT NAD e IDS Suricata, que nos permitem identificar a atividade de rede espec√≠fica do Pegasus em diferentes est√°gios, a partir dos primeiros segundos de sua atividade.  Voc√™ pode encontrar assinaturas abertas para o Suricata IDS no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">github</a> e no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Twitter</a> ; elas chegar√£o automaticamente ao seu Suricata se voc√™ usar o mecanismo de atualiza√ß√£o suricata-update. <br><br>  Voc√™ pode ver como as assinaturas da atividade Pegasus funcionam na captura de tela abaixo.  Este √© o nosso novo produto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">PT Network Attack Discovery</a> que identifica incidentes e ajuda a investig√°-los: <br><br> <a href=""><img src="https://habrastorage.org/webt/cc/ok/ou/ccokou2rr1ed01valiivylk6prs.png"></a> <br><br>  Al√©m disso, os seguintes indicadores de comprometimento (IC) podem ser usados ‚Äã‚Äãpara detec√ß√£o: <br><br><pre>  MAILSLOT \ 46CA075C165CBB2786 
 pipe \ pg0F9EC0DB75F67E1DBEFB3AFA2<font></font>
<font></font>
 hxxp: //denwer/pegasus/index.php
 hxxp: //mp3.ucrazy.org/music/index.php
 hxxp: //support.zakon-auto.net/tuning/index.asp
 hxxp: //video.tnt-online.info/tnt-comedy-tv/stream.php </pre><br>  <b>Postado por</b> Cyril Shipulin de @attackdetection, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Twitter</a> |  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Telegram</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt418017/">https://habr.com/ru/post/pt418017/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt418007/index.html">Desenvolvimento de plataforma cruzada com .NET, programa√ß√£o reativa, padr√£o MVVM e gera√ß√£o de c√≥digo</a></li>
<li><a href="../pt418009/index.html">Node.js e renderiza√ß√£o de servidor no Airbnb</a></li>
<li><a href="../pt418011/index.html">P√°ginas individuais e SEO. Segredos de otimiza√ß√£o</a></li>
<li><a href="../pt418013/index.html">O Intel Core i7-8086K (parte 3)</a></li>
<li><a href="../pt418015/index.html">Novo Vasyuki. Desenvolvimento inovador de Moscou at√© 2100</a></li>
<li><a href="../pt418023/index.html">Ponteiros em C s√£o mais abstratos do que voc√™ imagina</a></li>
<li><a href="../pt418025/index.html">O livro ‚ÄúAprendendo Java EE. Programa√ß√£o moderna para grandes empresas "</a></li>
<li><a href="../pt418027/index.html">Microservice Blitz</a></li>
<li><a href="../pt418029/index.html">ReactOS 0.4.9: haters ter√£o que procurar novos argumentos</a></li>
<li><a href="../pt418031/index.html">Empilhamento em massa de modelos ML em produ√ß√£o: real ou n√£o?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>