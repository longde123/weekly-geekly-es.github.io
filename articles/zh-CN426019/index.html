<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🍾 👩🏿‍🚒 💆🏾 Arduino上的气象站，从A到Z。第5部分 👏 🤕 🤛</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="结局。 上一部分 。 


 目录： 


- 第1部分。要求。 铁的选择。 一般方案 
- 第2部分。软件。 中央单元，铁 
- 第3部分。中央单元，软件 
- 第4部分。窗口传感器 
- 第5部分。MySQL，PHP，WWW，Android 
 舷外传感器。 软体类 


 讨论用于海外传感器的...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Arduino上的气象站，从A到Z。第5部分</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/426019/"><p> 结局。  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">上一部分</a> 。 </p><br><p> 目录： </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第1部分。要求。</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">铁的选择。</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">一般方案</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第2部分。软件。</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">中央单元，铁</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第3部分。中央单元，软件</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第4部分。窗口传感器</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第5部分。MySQL，PHP，WWW，Android</a> </li></ul><br><h1 id="zaokonnyy-datchik-programmnoe-obespechenie"> 舷外传感器。 软体类 </h1><br><p> 讨论用于海外传感器的软件。 之后，您将获得一个已经可以尝试的完整系统。 </p><br><p> 让我提醒您， <em>服务器</em>是可以通过WiFi与Internet进行通信的中央家用设备，而<em>客户端</em>是可以通过无线方式将数据传输到服务器的现成的远程传感器。 </p><br><p>服务器和客户端的源代码都在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">这里</a> 。 <br> 源文本提供了详细的注释。 </p><br><p> 客户端几乎不需要配置任何内容。 </p><a name="habracut"></a><br><p>  nRF24L01 +无线电发送器，更确切地说是RadioHead库，需要指定服务器和客户端地址。 如果您有多个服务器和客户端，则提供地址。 地址就是任何整数。 当客户端将数据包发送到服务器时，它指示该数据包用于哪个服务器。 然后，服务器知道自己的地址，然后确定此数据包是否打算发送给它。 </p><br><p>因此，服务器和客户端上的<code>SERVER_ADDRESS</code>应该相同，但是不同客户端的<code>CLIENT_ADDRESS</code>应该不同。 换句话说，如果将来您将另一个新传感器连接到我们的系统，则需要更改<code>CLIENT_ADDRESS</code> 。 </p><br><pre> <code class="hljs erlang-repl">//     #define SERVER_ADDRESS <span class="hljs-number"><span class="hljs-number">10</span></span> #define CLIENT_ADDRESS <span class="hljs-number"><span class="hljs-number">20</span></span> //     !!!</code> </pre> <br><p> 每个人的<code>RF_CHANNEL</code>无线电频道<code>RF_CHANNEL</code>必须相同。 默认为2。我更改了默认数字，您可以选择其他任何数字。 </p><br><pre> <code class="hljs objectivec"><span class="hljs-comment"><span class="hljs-comment">//  .       #define RF_CHANNEL 73</span></span></code> </pre> <br><p> 必须更改用于测量电池电源电压的电压表设置： </p><br><pre> <code class="hljs ruby">/<span class="hljs-regexp"><span class="hljs-regexp">/   ,   const float r1 = 100400; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ 100K const float r2 = 9960; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ 10K /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/      /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/    http:/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/localhost/arduino</span></span>-secret-<span class="hljs-literal"><span class="hljs-literal">true</span></span>-voltmeter/ const float typVbg = <span class="hljs-number"><span class="hljs-number">1.082</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    <span class="hljs-number"><span class="hljs-number">1.0</span></span> -- <span class="hljs-number"><span class="hljs-number">1.2</span></span> </code> </pre> <br><p> 为了节省能源， <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">使用了Arduino</a>的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">轻量级低功耗库</a> 。 </p><br><p> 这是我使用此库的Arduino Pro Mini的实际功耗测量： </p><br><ul><li> 通常为25mA </li><li> 与DHT一起使用时 </li><li> 无线电传输38 mA </li><li> 在低功耗时空闲15 mA </li><li> 低功耗时7.5 mA </li></ul><br><p> 客户端对温度，湿度和电源电压进行测量，将所有这些数据打包到一个数据结构中，然后将数据发送到服务器，然后“入睡”。 如果在传输过程中发生错误，将立即重复传输。 </p><br><p> 服务器（中央，家庭单元）依次接收数据，确认接收并进行处理。 </p><br><h1 id="baza-dannyh-mysql-php-www-server"> 数据库，MySQL，PHP，WWW服务器 </h1><br><p> 完成工作后，我们对气象站进行了功能齐全的设计。 但是现在有十角钱的这种气象站，当地的手工艺品不再流行。 毕竟，我们拥有物联网。 </p><br><p> 因此，我们将讨论如何访问您的Internet，并将数据库和Web面附加到数据库和气象站。 </p><br><p>  “网络摄像头”的问题说明： </p><br><ul><li> 接收和存储气象站数据：温度，湿度，大气压力，电源电压 </li><li> 显示此数据 </li><li> 建立图表。 </li></ul><br><p> 在这种情况下，我们需要使用mysqli模块托管对Apache，PHP和MySQL的支持。 这些条件几乎可以通过地球上的任何宿主来满足。 或代替托管，您的计算机将扮演连接到家庭网络路由器并可以访问Internet的服务器的角色。 </p><br><h2 id="sozdanie-bazy-dannyh"> 数据库创建 </h2><br><p> 让我们从头开始，即从数据库的设计和创建开始。 </p><br><p> 数据库是您的世界，您可以对其进行长期研究，因此，我们仅简要介绍一下我们直接需要的内容。 </p><br><p> 所有的SQL脚本都在<code>weather-station/server/php-sql/</code>目录中 </p><br><p> 数据库设计从哪里开始？ 具有逻辑和物理表示。 </p><br><p> 逻辑视图或数据库模式： </p><br><ul><li>  DHT温湿度表 </li><li> 压力和温度传感器BMP数据表 </li><li> 指示的表之间没有任何关系，更确切地说，不需要链接。 </li></ul><br><p> 物理方案依赖于特定的DBMS和数据类型。 使用特定示例更容易拆卸。  <code>make_tables.sql</code> SQL脚本<code>make_tables.sql</code>了逻辑和物理模式。 </p><br><p> 每个表应具有一个类型字段 </p><br><pre> <code class="sql hljs">id INTEGER UNSIGNED NOT NULL AUTO_INCREMENT</code> </pre> <br><p> 字段名称在不同的数据库中可能有所不同，但是只有一种含义-这是唯一的标识符，即记录键。 将来，如果您在没有此类计数器的表中看到一个数据库，则应该知道该数据库是由与编程无关的人（很可能是人文科学）设计的。 </p><br><p> 我们将来自同一类型的传感器的数据存储在一个表中；对于另一类型的传感器，我们创建另一个表。 这会使数据库和与其绑定的PHP稍微复杂化，但将来会简化整个系统的扩展或修改。 </p><br><p> 我们的项目中有两个表。  <code>arduino_dht</code>表存储来自DHT类型的传感器（温度，湿度）的数据， <code>arduino_bmp</code>表存储来自BMP类型的传感器（温度，压力）的数据。 如果将来您想拥有例如气体传感器或运动检测器，那么可以创建其他表，不要偷懒。 如果连接了DHT11或DHT22类型的另一个传感器，则不需要创建其他表，请使用<code>arduino_dht</code>表。 我希望原则很明确：一个单独的物理实体是一个单独的表。 </p><br><p> 如果将来自多个相同类型传感器的数据存储在一个表中，那么如何区分它们呢？ 为此，请在每个表中输入一个字段 </p><br><pre> <code class="hljs pgsql">idSensor <span class="hljs-type"><span class="hljs-type">INTEGER</span></span></code> </pre> <br><p> 实际上，这是<code>CLIENT_ADDRESS</code> ，我们在远程客户端-客户端的每个实例的<code>client/client.ino</code>中以及在<code>server/server.ino</code> <code>client/client.ino</code>为直接连接到服务器（中央单元）的传感器注册了<code>CLIENT_ADDRESS</code> 。 </p><br><p> 在工业系统中，应该有另一个表<code>idSensor</code>及其对应的口头，人类可读描述的对应关系。 例如， <code>idSensor</code> = 2的传感器是<em>“温度，公寓内的湿度”</em>等。 但是在我们的项目中，我们不会复杂化，只是记住： </p><br><ul><li> 带有<code>idSensor</code>的传感器，它是<code>CLIENT_ADDRESS</code> ，等于11-这是服务器上的家庭传感器-中央单元， </li><li> 带有<code>idSensor</code>的传感器，它也是<code>CLIENT_ADDRESS</code> ，等于20-这是第一个（在我们的项目中，也是唯一的）基于窗口的传感器客户端。 </li></ul><br><p> 下一个 这些表存储以下数据： </p><br><ul><li>  ipRemote-数据来自的气象站（服务器）的IP地址，对于调试和监控非常有用， </li><li>  dateCreate-创建记录的日期， </li><li>  millis-对调试很有用，这是自Arduino上的草图开始以来的时间（以毫秒为单位）， </li><li> 温度-温度 </li><li> 湿度-湿度 </li><li> 电压-电源电压 </li><li> 压力-压力 </li><li>  errors-错误数（未使用）。 它旨在存储传输错误等的数量，以便您可以远程评估整个系统的状态。 </li></ul><br><p> 如您所见， <code>arduino_dht</code>和<code>arduino_bmp</code>非常相似，区别仅在于压力和湿度字段，并且希望将所有内容转储到一个堆（表）中。 但是第<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">一个普通形式</a>并不能命令执行此操作，许多新手程序员试图解决这个问题，但是没有一个成功，而我们不会。 这是为什么暂时不注意万有引力定律的事实。 </p><br><p>  <code>arduino_error_log</code>表对于调试很有用-它是错误和其他系统消息的日志。 </p><br><p>  <code>make_db.sql</code>描述了创建数据库及其具有权限的用户 </p><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">-- .  config.php --   CREATE DATABASE IF NOT EXISTS db_weather; --   CREATE USER 'u_weather'@'localhost' IDENTIFIED BY '***PASSWORD***'; GRANT ALL ON db_weather.* TO 'u_weather'@'localhost';</span></span></code> </pre> <br><p> 只需完成一次，数据库名称和用户名就可以自己输入。 真正需要做的是设置密码。 </p><br><h2 id="php-i-veb-server">  PHP和Web服务器 </h2><br><p> 所有Web界面设置都存储在<code>config.php</code> 。 根据您的数据库设置对其进行修改。 </p><br><p> 将时区设置为PHP格式 </p><br><pre> <code class="hljs lisp">date_default_timezone_set('Europe/Prague')<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">此处描述了</a>所有可用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">时区</a> 。 </p><br><p> 设置访问密钥（以数字形式），该密钥必须与草图<code>SOURCE_KEY</code>中的常量<code>SOURCE_KEY</code>相匹配。 </p><br><pre> <code class="hljs perl">$access_key = <span class="hljs-string"><span class="hljs-string">'***KEY***'</span></span>;</code> </pre> <br><p> 在我们的Web服务器中，没有授权，密码输入，这会使整个设计复杂化。 对于原型，这不是必需的。 因此，所有保护都建立在<code>robots.txt</code>文件上，缺少<code>index.php</code>和此访问密钥。 </p><br><p>  PHP的主要脚本<code>weather.php</code>接受带有数据的简单HTTP GET请求并将其存储在相应的数据库表中。 如果密钥<code>$access_key</code>不匹配，则该请求将被拒绝。 </p><br><p>  <code>weather-view.php</code>用于查看数据表，并包含指向其他Web界面脚本的超链接。 这样叫他 </p><br><pre> <code class="hljs objectivec">http:<span class="hljs-comment"><span class="hljs-comment">// / /weather-view.php?k= access_key</span></span></code> </pre> <br><p> 举个例子 </p><br><pre> <code class="hljs objectivec">http:<span class="hljs-comment"><span class="hljs-comment">//yourhost/iot/weather-view.php?k=12345</span></span></code> </pre> <br><p>  <code>weather-view.php</code>显示简单的标签，您需要记住以下<code>weather-view.php</code> ： </p><br><ul><li>  ID为11的传感器是服务器上的家庭传感器， </li><li>  ID为20的传感器是窗户传感器。 </li></ul><br><p>  <code>function.php</code>脚本包含所有PHP脚本共有的功能。 </p><br><p>  <code>chart-dht.php</code>负责使用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Google Charts</a>进行图表绘制。 这里，例如是海外传感器的电源电压的曲线图。 在阳光灿烂的日子，由于太阳能电池，电压升高，然后电池上的电源逐渐放电。 </p><br><p><img src="https://habrastorage.org/webt/fb/ne/sg/fbnesguoqhfpwcgfa--lcrtpf4m.png" alt="图表"></p><br><p>  <code>export-dht.php</code>将数据从MySQL数据库表导出到CSV文件。 用于在电子表格中进一步导入和分析。 </p><br><p>  <code>export-voltage.php</code>将来自窗口传感器的电源电压数据从MySQL数据库导出到CSV文件。 对于调试很有用。 </p><br><p>  <code>truncate.php</code>清除所有表，即 删除我们所有的数据。 对于调试很有用。 从<code>weather-view.php</code>没有此脚本的链接，因此您需要使用<code>$access_key</code>浏览器地址栏中的直接链接来调用它。 </p><br><p> 接收数据时，通常使用<code>mysqli_real_escape_string()</code>函数来防止错误的值进入数据库。 </p><br><p> 不要忘记将<code>robots.txt</code>放在您网站的根目录，以防止它进入搜索引擎。 </p><br><h1 id="esp8266-wifi-i-peredacha-dannyh">  ESP8266，WiFi和数据传输 </h1><br><p> 现在回到<code>server.ino</code>草图，再回到连接WiFi接入点并将数据发送到Web服务器的部分。 </p><br><p> 正如我已经写的，我找不到用于使用AT命令控制ESP8266模块的Arduino常规库，我不得不自己“集体农场”。 让我还提醒您，您必须在ESP8266-01中刷新特定版本的固件。 现在，当一切准备就绪时，让我们看看它是如何工作的。 </p><br><p> 要在<code>server.ino</code>草图中访问Web服务器， <code>server.ino</code>需要更改这些常量 </p><br><pre> <code class="hljs julia"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> DEST_HOST = <span class="hljs-string"><span class="hljs-string">" "</span></span>; //  habr.com <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> DEST_PORT = <span class="hljs-string"><span class="hljs-string">" "</span></span>; //  <span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> DEST_URL = <span class="hljs-string"><span class="hljs-string">"/ /weather.php"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> SOURCE_KEY= <span class="hljs-string"><span class="hljs-string">"  "</span></span>; //    $access_key  config.php</code> </pre> <br><p> 在<code>server.ino</code>在<code>void setup()</code>函数中，ESP8266首先切换到Station模式，即 它开始作为WiFi客户端工作 </p><br><pre> <code class="hljs lisp">espSendCmd(«AT+CWMODE_CUR=1», «OK», <span class="hljs-number"><span class="hljs-number">3000</span></span>)<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br><p> 然后跟随连接到接入点 </p><br><pre> <code class="hljs lisp">espState = espConnectToWiFi()<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br><p> 如果未发生连接，则重复尝试一次 </p><br><pre> <code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( espState != <span class="hljs-type"><span class="hljs-type">ESP_SUCCESS</span></span> ) { delay(<span class="hljs-number"><span class="hljs-number">5000</span></span>); <span class="hljs-type"><span class="hljs-type">Serial</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">println</span></span>(<span class="hljs-string"><span class="hljs-string">"WiFi not connected! Try again ..."</span></span>); espConnectToWiFi(); }</code> </pre> <br><p> 然后选择TCP / IP单连接模式 </p><br><pre> <code class="hljs lisp">espSendCmd(<span class="hljs-string"><span class="hljs-string">"AT+CIPMUX=0"</span></span>, <span class="hljs-string"><span class="hljs-string">"OK"</span></span>, <span class="hljs-number"><span class="hljs-number">2000</span></span>)<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br><p> 将数据从DHT类型的传感器发送到Web服务器时，使用一个函数将数据<code>type=dht</code>指示为<code>type=dht</code> </p><br><pre> <code class="hljs lisp">espSendData( <span class="hljs-string"><span class="hljs-string">"type=dht&amp;t="</span></span> + String(<span class="hljs-name"><span class="hljs-name">dhtData</span></span>.temperature) + <span class="hljs-string"><span class="hljs-string">"&amp;h="</span></span> + String(<span class="hljs-name"><span class="hljs-name">dhtData</span></span>.humidity) + <span class="hljs-string"><span class="hljs-string">"&amp;v="</span></span> + String(<span class="hljs-name"><span class="hljs-name">dhtData</span></span>.voltage) + <span class="hljs-string"><span class="hljs-string">"&amp;s="</span></span> + String(<span class="hljs-name"><span class="hljs-name">CLIENT_ADDRESS</span></span>) )<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br><p> 从BMP传感器向Web服务器发送数据时，使用相同的功能，数据类型表示为<code>type=bmp</code> </p><br><pre> <code class="hljs lisp">espSendData( <span class="hljs-string"><span class="hljs-string">"type=bmp&amp;t="</span></span> + String(<span class="hljs-name"><span class="hljs-name">temperature_bmp</span></span>) + <span class="hljs-string"><span class="hljs-string">"&amp;p="</span></span> + String(<span class="hljs-name"><span class="hljs-name">pressure_bmp</span></span>) + <span class="hljs-string"><span class="hljs-string">"&amp;s="</span></span> + String(<span class="hljs-name"><span class="hljs-name">CLIENT_ADDRESS</span></span>) )<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br><p>  <code>espSendData()</code>函数接受HTTP GET请求字符串，并按预期将其发送到Web服务器。 </p><br><p> 在其内部， <code>espSendData()</code>通过向其发送“ AT”命令来检查ESP模块的可用性，然后检查WiFi连接并在必要时重新连接。 然后发送数据并关闭TCP连接。 </p><br><h1 id="android-prilozhenie">  Android应用 </h1><br><p> 如今，当每个人都可以使LED闪烁时，拥有气象站的任何人都不会感到惊讶。 但是，如果工艺师知道如何通过WiFi与服务器通信，具有Web界面和移动应用程序，那么就可以了！ 这里的服务器我们当然是指应用程序服务器，即 在我们的例子中，这是一个PHP绑定和一个MySQL DBMS。 蛋糕上没有足够的樱桃，即我们现在要编写的Android应用程序。 </p><br><h2 id="arhitektura"> 建筑学 </h2><br><p> 整个气象站软件平台的架构很简单： </p><br><ul><li> 气象站的服务器部分（中央单元）从远程传感器客户端收集数据 </li><li> 然后将数据传输到应用程序的Web服务器，该服务器将这些数据保存到数据库 </li><li>  Android应用程序（或任何其他远程应用程序：iOS，浏览器）从Web服务器请求数据并将其显示在屏幕上。 </li></ul><br><p> 在Android设备屏幕上，我们将显示当前的最新传感器读数。 </p><br><h2 id="http-get-i-json">  HTTP GET和JSON </h2><br><p> 首先需要解决的问题是如何将数据从Web服务器传输到Android应用程序。 </p><br><p> 这里不需要发明任何东西，所有东西都已经为我们发明了-这些是HTTP GET和JSON。 </p><br><p> 在我们的情况下，可以在Android应用尚未准备就绪时手动编译和调试对Web服务器的简单GET请求。 </p><br><p> 在Java和Android中，有现成的库用于处理JSON格式的数据。  JSON是一种人类可读的文本格式，对于调试非常有用。 </p><br><p> 为了从气象站传感器生成当前数据， <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">请</a>在Web服务器上创建一个新的PHP脚本<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">last-data-to-json.php</a> 。 </p><br><p> 脚本调用： </p><br><pre> <code class="hljs powershell">http://&lt;&gt;/last<span class="hljs-literal"><span class="hljs-literal">-data</span></span><span class="hljs-literal"><span class="hljs-literal">-to</span></span><span class="hljs-literal"><span class="hljs-literal">-json</span></span>.php?k=&lt;access_key&gt;</code> </pre> <br><p> 我们记得，其中<code>&lt;access_key&gt;</code>是秘密数据库访问密钥。 </p><br><p>  JSON格式的示例响应： </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"DHT 11"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"idSensor"</span></span>:<span class="hljs-string"><span class="hljs-string">"11"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dateCreate"</span></span>:<span class="hljs-string"><span class="hljs-string">"2016-04-20 18:06:03"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"temperature"</span></span>:<span class="hljs-string"><span class="hljs-string">"19"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"humidity"</span></span>:<span class="hljs-string"><span class="hljs-string">"26"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"voltage"</span></span>:<span class="hljs-string"><span class="hljs-string">"5.01"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"DHT 20"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"idSensor"</span></span>:<span class="hljs-string"><span class="hljs-string">"20"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dateCreate"</span></span>:<span class="hljs-string"><span class="hljs-string">"2016-04-18 07:36:26"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"temperature"</span></span>:<span class="hljs-string"><span class="hljs-string">"10"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"humidity"</span></span>:<span class="hljs-string"><span class="hljs-string">"26"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"voltage"</span></span>:<span class="hljs-string"><span class="hljs-string">"3.7"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"BMP 11"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"idSensor"</span></span>:<span class="hljs-string"><span class="hljs-string">"11"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dateCreate"</span></span>:<span class="hljs-string"><span class="hljs-string">"2016-04-20 18:06:22"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"temperature"</span></span>:<span class="hljs-string"><span class="hljs-string">"19"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pressure"</span></span>:<span class="hljs-string"><span class="hljs-string">"987.97"</span></span> } }</code> </pre> <br><p> 必须记住，我们有3个传感器。 它们的ID和类型（DHT或BMP）在整个气象站代码中都进行了硬编码。 这种硬核编码方法在思想上是不正确的，但是对于膝上绘制的原型（需要快速简便的解决方案），这是一个合理的折衷方案。 </p><br><pre> <code class="hljs ruby">$idSensor = <span class="hljs-number"><span class="hljs-number">11</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  DHT  $idSensor = <span class="hljs-number"><span class="hljs-number">11</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  BMP  $idSensor = <span class="hljs-number"><span class="hljs-number">20</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  DHT </code> </pre> <br><p>  <code>last-data-to-json.php</code>从数据库中获取来自这些异构传感器的最新数据，并将其打包为JSON格式。 以这种方式从数据库“从头开始”选择数据： </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> &lt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> &lt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre> <br><h2 id="android"> 安卓系统 </h2><br><p> 现在，我们将编写一个简单的Android应用程序，该应用程序可以请求，接收，解码JSON数据并在屏幕上显示信息。 </p><br><p> 我们的Android应用程序将尽可能简单，这只是技术的精髓。 围绕这个“骨骼”，将已经有可能结束各种“美丽”。 </p><br><p> 这是应该导致的结果的屏幕截图 </p><br><p><img src="https://habrastorage.org/webt/ca/qb/wx/caqbwxzdlsu2a83atqsmzslebvy.jpeg" alt="安卓系统"></p><br><p> 如您所见，UI只是基于LinearLayout的Spartan，仅此而已。 </p><br><p> 在TextView的顶部显示传感器的ID及其气象数据。 刷新按钮向Web服务器发起第二个请求。  EditText中的Next是唯一的程序设置-这是表单中的请求URL </p><br><pre> <code class="hljs powershell">http://&lt; &gt;/last<span class="hljs-literal"><span class="hljs-literal">-data</span></span><span class="hljs-literal"><span class="hljs-literal">-to</span></span><span class="hljs-literal"><span class="hljs-literal">-json</span></span>.php?k=&lt;access_key&gt;</code> </pre> <br><p> 应该注意什么？ </p><br><p> 在清单中，添加允许Internet并检查网络连接状态的行： </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-permission</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.permission.ACCESS_NETWORK_STATE"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-permission</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.permission.INTERNET"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre> <br><p> 使用网络并从网站接收数据的方法如下。 </p><br><p> 我们使用AsyncTask来创建一个与主UI线程分开的后台任务。 此后台任务获取请求URL并使用它创建<code>HttpURLConnection</code> 。 </p><br><p> 建立连接后，AsyncTask将网页的内容作为InputStream加载。 接下来，将InputStream转换为字符串，然后使用JSONObject对其进行解码，并使用<code>onPostExecute()</code>方法将其显示在用户界面中。 </p><br><p> 在MainActivity.java中，将URL更改为： </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String defUrl = <span class="hljs-string"><span class="hljs-string">"http://host/dir/last-data-to-json.php?k=&lt; &gt;"</span></span>;</code> </pre> <br><p> 默认情况下，它将在您首次运行Android应用程序时使用。 </p><br><h2 id="epilog"> 结语 </h2><br><p> 好吧，有些事情已经奏效了。 然后，您可以优化某些内容，替换某些内容，丢弃所有内容，也可以借用某些内容。 </p><br><p> 一个单独的大痛点是<strong>能耗</strong> 。 我建议您阅读有很多实用技巧的帖子的评论。 </p><br><p>  <em>达到无限……甚至超越。</em> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN426019/">https://habr.com/ru/post/zh-CN426019/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN426001/index.html">麻省理工学院的课程“计算机系统安全”。 第11课：Ur / Web编程语言，第3部分</a></li>
<li><a href="../zh-CN426009/index.html">史诗般的失败抵抗力1或Fox未被发现。 为用户测试匿名性和安全性+ VPN</a></li>
<li><a href="../zh-CN426013/index.html">职业类固醇</a></li>
<li><a href="../zh-CN426015/index.html">使用锯切民用无人机进行该地区的专业大地航空摄影</a></li>
<li><a href="../zh-CN426017/index.html">如何减少动物实验次数</a></li>
<li><a href="../zh-CN426021/index.html">libgdx和感受</a></li>
<li><a href="../zh-CN426023/index.html">公开课“ Vagrant的虚拟实验室”</a></li>
<li><a href="../zh-CN426025/index.html">使用进攻性方法丰富威胁情报</a></li>
<li><a href="../zh-CN426027/index.html">亚马逊云服务和投资组合分析</a></li>
<li><a href="../zh-CN426029/index.html">您是否放弃并想要退出任务？ 这就是有效的开发人员培训的样子</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>