<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üåû üëàüèº üìç Exportez Google Forms + t√©l√©chargez Google Script via l'API REST (Python) üéÆ üë∑üèº üõ¥</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nous avions deux formulaires Google, 75 questions chacun, 5 utilisateurs professionnels qui ont activement √©dit√© ces formulaires, ainsi qu'un script G...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Exportez Google Forms + t√©l√©chargez Google Script via l'API REST (Python)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/485898/"><img src="https://habrastorage.org/webt/gi/tl/nl/gitlnlklzpbmybk3jz3utl4_uow.png"><br><br>  Nous avions deux formulaires Google, 75 questions chacun, 5 utilisateurs professionnels qui ont activement √©dit√© ces formulaires, ainsi qu'un script Google exportant le formulaire vers JSON.  Non pas qu'il serait difficile de l'ex√©cuter √† chaque fois avec vos mains, mais une fois que vous commencez √† automatiser votre travail, passez √† ce passe-temps jusqu'√† la fin. <br><br>  Dans la documentation officielle, le diable se cassera la jambe, donc sous le chat, nous allons regarder de plus pr√®s le t√©l√©chargement et le lancement √† distance de Google Apps Script via l'API REST en utilisant Python. <br><a name="habracut"></a><br><h2>  Pr√©sentation </h2><br>  Dans Doctor Near, nous d√©veloppons une plateforme pour les robots de chat, dans laquelle les formulaires Google sont utilis√©s pour d√©crire des sc√©narios.  En cons√©quence, je veux obtenir un JSON des formulaires au clic d'un bouton qui contient des n≈ìuds (points de formulaire) et des m√©tadonn√©es pour eux (transitions entre les n≈ìuds, types de n≈ìuds, leur nom).  Il semblerait que le d√©sir soit simple, mais Google ne prend pas en charge cette fonctionnalit√© et vous devez assembler cet "exportateur" de vos propres mains.  Consid√©rez les √©tapes pour le cr√©er. <br><br><h2>  √âTAPE 1. Script Google Apps </h2><br>  Google a fourni la possibilit√© d'interagir avec ses services (Sheets, Docs, Forms) via Google Apps Script - des scripts √©crits en google script (.gs).  Cet article ne fournit pas d'analyse du langage de script Google, je vais donc donner un exemple de script termin√© qui cr√©e JSON √† partir d'un formulaire Google existant.  Le <a href="" rel="nofollow">code</a> utilisateur <a href="https://github.com/stevenschmatz" rel="nofollow">Steven Schmatz a</a> √©t√© pris comme base sur le github, pour lequel je lui exprime ma gratitude. <br><br><div class="spoiler">  <b class="spoiler_title">Code de script</b> <div class="spoiler_text"><pre><code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// Steven Schmatz // Humanitas Labs // 13 October, 2016. // Roman Shekhovtsov // dr-telemed.ru // Autumn 2019 // Nikita Orekhov // dr-telemed.ru // Autumn 2019 /** * Converts the given form URL into a JSON object. */ function main() { form_url = "&lt;YOUR_FORM_URL&gt;" var form = FormApp.openByUrl(form_url); var items = form.getItems(); var result = { "metadata": getFormMetadata(form), "items": items.map(itemToObject), "count": items.length }; // sendEmail("&lt;YOUR_EMAIL&gt;", result) return result; } /** If we want to receive data by email * Sends JSON as text to recipient email * @param recipient: String * @param result: JSON */ function sendEmail(recipient, json_file){ var subject = "google form json import" var body = JSON.stringify(json_file); Logger.log(body); MailApp.sendEmail(recipient, subject, body); } /** * Returns the form metadata object for the given Form object. * @param form: Form * @returns (Object) object of form metadata. */ function getFormMetadata(form) { return { "title": form.getTitle(), "id": form.getId(), "description": form.getDescription(), "publishedUrl": form.getPublishedUrl(), "editorEmails": form.getEditors().map(function(user) { return user.getEmail() }), "count": form.getItems().length, "confirmationMessage": form.getConfirmationMessage(), "customClosedFormMessage": form.getCustomClosedFormMessage() }; } /** * Returns an Object for a given Item. * @param item: Item * @returns (Object) object for the given item. */ function itemToObject(item) { var data = {}; data.type = item.getType().toString(); // Downcast items to access type-specific properties var itemTypeConstructorName = snakeCaseToCamelCase("AS_" + item.getType().toString() + "_ITEM"); var typedItem = item[itemTypeConstructorName](); // Keys with a prefix of "get" have "get" stripped var getKeysRaw = Object.keys(typedItem).filter(function(s) {return s.indexOf("get") == 0}); getKeysRaw.map(function(getKey) { var propName = getKey[3].toLowerCase() + getKey.substr(4); // Image data, choices, and type come in the form of objects / enums if (["image", "choices", "type", "alignment"].indexOf(propName) != -1) {return}; // Skip feedback-related keys if ("getFeedbackForIncorrect".equals(getKey) || "getFeedbackForCorrect".equals(getKey) || "getGeneralFeedback".equals(getKey)) {return}; var propValue = typedItem[getKey](); data[propName] = propValue; }); // Bool keys are included as-is var boolKeys = Object.keys(typedItem).filter(function(s) { return (s.indexOf("is") == 0) || (s.indexOf("has") == 0) || (s.indexOf("includes") == 0); }); boolKeys.map(function(boolKey) { var propName = boolKey; var propValue = typedItem[boolKey](); data[propName] = propValue; }); // Handle image data and list choices switch (item.getType()) { case FormApp.ItemType.LIST: case FormApp.ItemType.CHECKBOX: data.choices = typedItem.getChoices().map(function(choice) { return choice.getValue() }); case FormApp.ItemType.MULTIPLE_CHOICE: data.choices = typedItem.getChoices().map(function(choice) { gotoPage = choice.getGotoPage() if (gotoPage == null) return choice.getValue() else return { "value": choice.getValue(), "gotoPage":choice.getGotoPage().getId() }; }); break; case FormApp.ItemType.IMAGE: data.alignment = typedItem.getAlignment().toString(); if (item.getType() == FormApp.ItemType.VIDEO) { return; } var imageBlob = typedItem.getImage(); data.imageBlob = { "dataAsString": "", //imageBlob.getDataAsString(), - BLOB too big "name": imageBlob.getName(), "isGoogleType": imageBlob.isGoogleType() }; break; case FormApp.ItemType.PAGE_BREAK: data.pageNavigationType = typedItem.getPageNavigationType().toString(); break; default: break; } // Have to do this because for some reason Google Scripts API doesn't have a // native VIDEO type if (item.getType().toString() === "VIDEO") { data.alignment = typedItem.getAlignment().toString(); } return data; } /** * Converts a SNAKE_CASE string to a camelCase string. * @param s: string in snake_case * @returns (string) the camelCase version of that string */ function snakeCaseToCamelCase(s) { return s.toLowerCase().replace(/(\_\w)/g, function(m) {return m[1].toUpperCase();}); }</span></span></code> </pre> <br></div></div><br>  Que se passe-t-il dans le code: <br><br><ul><li>  Fonction <i>getFormMetadata</i> - renvoie JSON avec les m√©tadonn√©es du formulaire </li><li>  Fonction <i>itemToObject</i> - convertit l'objet <i>form.item</i> en JSON avec les champs obligatoires </li><li>  Fonction <i>sendEmail</i> - envoie un fichier JSON au courrier sp√©cifi√© en texte </li><li>  fonction <i>principale</i> - retourne le JSON r√©sultant </li><li>  la variable <i>form_url</i> dans la fonction <i>principale</i> est l'adresse de notre formulaire google </li></ul><br><h2>  √âTAPE 2. Test du script </h2><br>  Pour le moment, les performances du script peuvent √™tre v√©rifi√©es comme suit: <br><br><ol><li>  <a href="https://script.google.com/home/start" rel="nofollow">cr√©ez</a> votre propre projet de script d'application </li><li>  copier le code dedans </li><li>  au lieu de <i>&lt;YOUR_FORM_URL&gt;, nous</i> substituons l'adresse de notre formulaire au formulaire <i><a href="https://docs.google.com/forms/d/FORM_IDENTIFICATOR/edit" rel="nofollow">docs.google.com/forms/d/FORM_IDENTIFICATOR/edit</a></i> </li><li>  d√©commenter l'appel √† <i>sendEmail</i> dans la fonction <i>principale</i> </li><li>  au lieu de <i>&lt;YOUR_EMAIL&gt;, nous</i> substituons l'adresse e-mail √† laquelle nous voulons recevoir JSON </li><li>  enregistrer le projet </li><li>  ex√©cuter la fonction <i>principale</i> </li><li>  s'il s'agit de la premi√®re ex√©cution du script, le syst√®me vous informera de la n√©cessit√© de donner au script l'autorisation d'envoyer des e-mails √† partir de votre adresse.  N'ayez pas peur.  Il s'agit de la proc√©dure standard requise pour tester le script.  Passez par "Examiner les autorisations" -&gt; s√©lectionnez votre compte -&gt; "Avanc√©" -&gt; "Acc√©dez au projet PROJECT_NAME (dangereux)" -&gt; "Autoriser" </li><li>  en attendant que le script fonctionne </li><li>  regardez dans la bo√Æte aux lettres et voyez le fichier JSON sous forme de texte </li></ol><br>  Tout irait bien, mais une utilisation ult√©rieure des donn√©es obtenues implique une copie manuelle √† partir du courrier, le traitement de ce texte (en python, par exemple) et l'enregistrement du fichier r√©sultant.  Cela ne semble pas trop pr√™t pour la production.  Nous automatisons le lancement de ce script et obtenons son r√©sultat via l'API de script Google Apps, mais nous configurons d'abord notre projet Google en cons√©quence. <br><br>  <b>Attention:</b> Pour la commodit√© de comprendre ce qui se passe, ci-dessous je ne ferai r√©f√©rence qu'√† deux pages, il est donc recommand√© de les ouvrir dans les onglets adjacents: <br><br><ol><li>  Page Script / √âdition de script - <i>¬´Page 1¬ª</i> </li><li>  Page Google Cloud Platform - <i>¬´Page 2¬ª</i> </li></ol><br><h2>  √âTAPE 3. Configurer Google Cloud Platform </h2><br>  Nous allons sur Google Cloud Platform (page 2), cr√©ons un nouveau projet.  Il est n√©cessaire de cr√©er un nouveau projet, car par d√©faut, l'√©tat du projet est Par d√©faut et Standart est requis pour nos besoins.  Plus de d√©tails peuvent √™tre trouv√©s <a href="https://developers.google.com/apps-script/guides/cloud-platform-projects" rel="nofollow">ici</a> (point 3). <br><br>  Nous revenons √† la page 2, allez dans l'onglet "API et services", puis "Fen√™tre de demande d'acc√®s OAuth".  D√©finissez le type d'utilisateur sur "Externe". <br><br>  Dans la fen√™tre qui appara√Æt, remplissez le "Nom de l'application". <br><br>  Ouvrez la page d'accueil sur Google Cloud Platform.  Dans le bloc "Informations sur le projet", copiez le num√©ro de projet. <br><br>  Allez √† la page 1. Ouvrez le script cr√©√© pr√©c√©demment.  Dans la fen√™tre d'√©dition de script ouverte, allez dans ¬´Ressources¬ª -&gt; ¬´Projet Cloud Platform¬ª.  Dans le champ ¬´Modifier le projet¬ª, entrez le num√©ro de projet pr√©c√©demment copi√©.  Maintenant, ce script est associ√© au projet cr√©√©. <br><br><h2>  √âTAPE 4. API REST Python </h2><br>  Il est temps d'automatiser le script √† l'aide de l' <a href="https://developers.google.com/apps-script/api/reference/rest" rel="nofollow">API REST</a> .  Python a √©t√© utilis√© comme langage. <br><br><h3>  Connexion √† l'API Apps Script </h3><br>  Le code doit avoir acc√®s au projet, donc la premi√®re et tr√®s importante proc√©dure est la connexion dans l'API Apps Script.  Ouvrez la page 2 -&gt; ¬´API et services¬ª -&gt; ¬´Credentials¬ª -&gt; ¬´Create Credentials¬ª -&gt; ¬´OAuth Client Identifier¬ª -&gt; ¬´Other Types¬ª.  Nous appelons notre identifiant, allez-y.  √âtant dans l'onglet "Informations d'identification", s√©lectionnez "T√©l√©charger le fichier JSON".  Cela chargera le fichier de cl√© pour l'acc√®s du code au projet dans Google.  Nous pla√ßons ce fichier dans le dossier des informations d'identification. <br><br>  Vous devez maintenant autoriser l'utilisation de l'API (dans notre cas, l'API Apps Script) dans le cadre de ce projet.  Pour ce faire, allez dans ¬´API et services¬ª -&gt; ¬´Biblioth√®que¬ª -&gt; tapez ¬´Apps Script API¬ª dans la recherche et cliquez sur ¬´Activer¬ª. <br><br>  Les applications qui interagissent avec Google ont un tas d'autorisations que l'utilisateur doit donner lors de son lancement.  Cette copie d√©pend des fonctions utilis√©es par un script particulier et vous pouvez le d√©couvrir en allant √† la page 1 dans la fen√™tre d'√©dition de script dans "Fichier" -&gt; "Propri√©t√©s du projet" -&gt; "√âtendues".  Ces autorisations doivent √™tre conserv√©es pour r√©f√©rence future dans le code. <br><br>  Dans ce cas, la fonction de connexion ressemblera √† ceci: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pickle <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os.path <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> googleapiclient.discovery <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> build <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> google_auth_oauthlib.flow <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> InstalledAppFlow <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> google.auth.transport.requests <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Request <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">login</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(config)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: creds = <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-comment"><span class="hljs-comment"># The file token.pickle stores the user's access and refresh tokens, and is # created automatically when the authorization flow completes for the first # time. token_file = config['credentials_path'] + config['token_file'] credentials_file = config['credentials_path'] + config['credentials_file'] if os.path.exists(token_file): with open(token_file, 'rb') as token: creds = pickle.load(token) # If there are no (valid) credentials available, let the user log in. if not creds or not creds.valid: if creds and creds.expired and creds.refresh_token: creds.refresh(Request()) else: flow = InstalledAppFlow.from_client_secrets_file(credentials_file, config['SCOPES']) creds = flow.run_local_server(port=0) # Save the credentials for the next run with open(token_file, 'wb') as token: pickle.dump(creds, token) service = build('script', 'v1', credentials=creds) pprint('Login successful') return service except Exception as e: pprint(f'Login failure: {e}') return None</span></span></code> </pre><br>  Ce bloc de code est la proc√©dure standard pour d√©marrer avec Google App Script. <br>  Nous utilisons un jeton d'authentification et, en nous connectant, nous cr√©ons un nouveau jeton ou nous en utilisons un existant. <br><br>  Pour plus de commodit√©, un fichier de configuration JSON a √©t√© cr√©√©, qui a la forme suivante: <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"SCOPES"</span></span>: [<span class="hljs-string"><span class="hljs-string">"https://www.googleapis.com/auth/forms"</span></span>, <span class="hljs-string"><span class="hljs-string">"https://www.googleapis.com/auth/script.send_mail"</span></span>], <span class="hljs-attr"><span class="hljs-attr">"credentials_path"</span></span>: <span class="hljs-string"><span class="hljs-string">"credentials/"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"credentials_file"</span></span>: <span class="hljs-string"><span class="hljs-string">"google_test_project.json"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"token_file"</span></span>: <span class="hljs-string"><span class="hljs-string">"token.pickle"</span></span> }</code> </pre><br>  <b>Important: le</b> jeton est cr√©√© pour l'authentification avec une √©tendue d'autorisations sp√©cifique.  En d'autres termes, lorsque vous modifiez la port√©e des autorisations, vous devez supprimer le jeton et en cr√©er un nouveau lors de la connexion. <br><br><h3>  Code de script de mise √† jour √† distance </h3><br>  Nous allons maintenant apprendre √† mettre √† jour √† distance le code du script, puis √† ex√©cuter ce code et √† obtenir le r√©sultat.  En fait, en plus du code que nous ex√©cutons dans l'√©diteur Google, il existe √©galement un <a href="https://developers.google.com/apps-script/concepts/manifests" rel="nofollow">fichier manifeste</a> qui contient les droits de lancement, les param√®tres de d√©ploiement, etc.  Vous trouverez plus d'informations sur sa structure <a href="https://developers.google.com/apps-script/manifest/" rel="nofollow">ici</a> . <br>  Pour consulter le fichier manifeste par d√©faut cr√©√© par Google pour votre script, acc√©dez √† l'√©diteur de script dans "Affichage" -&gt; "Afficher le fichier manifeste".  Le manifeste appara√Ætra dans la liste des fichiers li√©s √† ce script. <br><br>  Le discours sur le manifeste n'√©tait pas sans raison: la mise √† jour du script √† distance n√©cessite le t√©l√©chargement du code des fichiers (* .gs) et du manifeste (appscript.json). <br><br>  Tout d'abord, lisez le code du fichier .gs que nous voulons d√©ployer: <br><br><pre> <code class="python hljs"> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">'export-google-form.gs'</span></span>, <span class="hljs-string"><span class="hljs-string">'r'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: sample_code = f.read()</code> </pre><br>  Copiez maintenant le manifeste g√©n√©r√© automatiquement et modifiez-le un peu pour nos besoins.  La documentation d√©crit assez compl√®tement la structure du fichier manifeste, donc je ne m'attarderai pas sur ce point.  Pour que le script fonctionne, vous devez ajouter la section "executionApi" au manifeste par d√©faut, qui est requis pour ex√©cuter le script √† distance via l'API.  Dans cette section, nous indiquons le cercle de personnes qui ont la capacit√© de l'ex√©cuter.  J'ai autoris√© le lancement pour tous ceux qui ont pass√© l'autorisation, ce qui correspond √† l'identifiant "N'IMPORTE QUI": <br><br><pre> <code class="python hljs">MANIFEST = <span class="hljs-string"><span class="hljs-string">''' { "timeZone": "America/New_York", "exceptionLogging": "STACKDRIVER", "executionApi": { "access": "ANYONE" } } '''</span></span>.strip()</code> </pre><br>  Le corps de la demande de mise √† jour doit contenir un tableau de fichiers avec la structure suivante: <br><br><ul><li>  <i>nom</i> : nom du fichier √† cr√©er sur le serveur, sans extension </li><li>  <i>type</i> : <i>type de</i> fichier (JSON pour manifeste, SERVER_JS pour .gs) </li><li>  <i>source</i> : code de fichier </li></ul><br><pre> <code class="python hljs">request = { <span class="hljs-string"><span class="hljs-string">'files'</span></span>: [{ <span class="hljs-string"><span class="hljs-string">'name'</span></span>: <span class="hljs-string"><span class="hljs-string">'hello'</span></span>, <span class="hljs-string"><span class="hljs-string">'type'</span></span>: <span class="hljs-string"><span class="hljs-string">'SERVER_JS'</span></span>, <span class="hljs-string"><span class="hljs-string">'source'</span></span>: sample_code }, { <span class="hljs-string"><span class="hljs-string">'name'</span></span>: <span class="hljs-string"><span class="hljs-string">'appsscript'</span></span>, <span class="hljs-string"><span class="hljs-string">'type'</span></span>: <span class="hljs-string"><span class="hljs-string">'JSON'</span></span>, <span class="hljs-string"><span class="hljs-string">'source'</span></span>: MANIFEST } ] }</code> </pre><br>  Enfin, la demande de mise √† jour elle-m√™me doit contenir le corps (demande d√©crite ci-dessus) et l'ID de script.  Ce dernier peut √™tre obtenu en allant dans le "Fichier" -&gt; "Propri√©t√©s du projet" dans l'√©diteur de script et en copiant le "Script ID": <br><br><pre> <code class="python hljs">script_id = <span class="hljs-string"><span class="hljs-string">'qwertyuiopQWERTYUIOPasdfghjkl123456789zxcvbnmASDFGHJKL54'</span></span></code> </pre><br>  Pour l'objet de service obtenu √† la suite de la connexion, nous obtenons le champ projects () et appelons la m√©thode updateContent (), apr√®s quoi nous appelons la m√©thode execute () pour l'objet HttpRequest re√ßu: <br><br><pre> <code class="python hljs">service.projects().updateContent( body=request, scriptId=script_id ).execute()</code> </pre><br>  Cependant, pour l'instant, l'ex√©cution du code entra√Ænera une erreur: <br><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"error"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"code"</span></span>: <span class="hljs-number"><span class="hljs-number">403</span></span>, <span class="hljs-attr"><span class="hljs-attr">"message"</span></span>: <span class="hljs-string"><span class="hljs-string">"Request had insufficient authentication scopes."</span></span>, <span class="hljs-attr"><span class="hljs-attr">"status"</span></span>: <span class="hljs-string"><span class="hljs-string">"PERMISSION_DENIED"</span></span> }</code> </pre><br>  Comme vous pouvez le voir, il n'y a pas suffisamment d'autorisations dans le balbuzard d'authentification, que nous avons indiqu√© plus t√¥t.  Nous nous tournons vers la documentation officielle de l'API, √† savoir la m√©thode <a href="https://developers.google.com/apps-script/api/reference/rest/v1/projects/updateContent" rel="nofollow">updateContent</a> , que nous avons utilis√©e pour mettre √† jour le script √† distance.  La documentation indique que l'utilisation de cette m√©thode n√©cessite l'activation de l'acc√®s √† script.projects: <br><br><pre> <code class="python hljs">https://www.googleapis.com/auth/script.projects</code> </pre> <br>  Ajoutez-le √† notre fichier de configuration dans la section SCOPES.  Comme je l'ai √©crit ci-dessus, lors du changement du balbuzard p√™cheur, il est n√©cessaire de supprimer le jeton g√©n√©r√© automatiquement. <br><br>  Super!  Pour le moment, nous avons appris √† mettre √† jour √† distance le script Google.  Il reste √† l'ex√©cuter et √† obtenir le r√©sultat de l'ex√©cution. <br><br><h3>  Ex√©cution de script </h3><br>  La demande de <a href="https://developers.google.com/apps-script/api/reference/rest/v1/scripts/run" rel="nofollow">lancement de script</a> contient le scriptID et le corps avec la structure suivante: <br><br><ul><li>  <i>fonction</i> : nom de la fonction que nous voulons ex√©cuter </li><li>  <i>param√®tres</i> : <i>(facultatif) un</i> ensemble de param√®tres de type primitif (cha√Æne, tableau ...) transmis √† la fonction </li><li>  <i>sessionState</i> : <i>(facultatif)</i> n'est requis que pour les applications Android </li><li>  <i>devMode</i> : <i>(facultatif)</i> True si l'utilisateur est le propri√©taire du script et que la derni√®re version sera lanc√©e par rapport √† celle qui a √©t√© d√©ploy√©e √† l'aide de l'API Apps Script.  (par d√©faut - Faux) </li></ul><br>  Afin de ne pas assembler l'URL du formulaire Google dans le script, nous passerons <i>form_url</i> √† la fonction <i>principale</i> comme argument. <br><br>  <b>Attention</b>  Lorsque nous avons test√© le script, la fonction <i>principale</i> n‚Äôacceptait rien. Nous allons donc modifier les premi√®res lignes de code du fichier .gs comme suit: <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">form_url</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> form = FormApp.openByUrl(form_url); .......</code> </pre><br>  Puisque notre application n'est pas pour Android et que nous sommes les propri√©taires du script, le corps ressemblera √† ceci: <br><br><pre> <code class="python hljs">body = { <span class="hljs-string"><span class="hljs-string">"function"</span></span>: <span class="hljs-string"><span class="hljs-string">"main"</span></span>, <span class="hljs-string"><span class="hljs-string">"devMode"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, <span class="hljs-string"><span class="hljs-string">"parameters"</span></span>: form_url }</code> </pre><br>  Ex√©cutez le script et √©crivez le r√©sultat de l'ex√©cution dans la variable resp: <br><br><pre> <code class="python hljs">resp = service.scripts().run(scriptId=script_id, body=body).execute()</code> </pre><br>  Enregistrez resp dans un fichier avec un formatage JSON pratique: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">'habr_auto.json'</span></span>, <span class="hljs-string"><span class="hljs-string">'w'</span></span>, encoding=<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: json.dump(resp[<span class="hljs-string"><span class="hljs-string">'response'</span></span>][<span class="hljs-string"><span class="hljs-string">'result'</span></span>], f, ensure_ascii=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>, indent=<span class="hljs-number"><span class="hljs-number">4</span></span>)</code> </pre><br>  <b>Attention</b>  Du fait que la requ√™te script.run () attend le r√©sultat via le socket, lorsque le d√©lai est d√©pass√© par le temps d'ex√©cution, une erreur du type suivant se produit: <br><br><pre> <code class="python hljs">socket.timeout: The read operation timed out</code> </pre><br>  Pour √©viter ce probl√®me, je recommande qu'au d√©but du programme d√©finissez une limite sur le temps de socket ouvert, ce qui est √©videmment suffisant pour qu'il attende la fin de l'ex√©cution du script.  Dans mon cas, 120 secondes suffisent: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> socket socket.setdefaulttimeout(<span class="hljs-number"><span class="hljs-number">120</span></span>)</code> </pre><br>  Voila!  Un pipeline pratique pour la mise √† jour et le lancement √† distance des scripts Google est pr√™t.  Le code complet adapt√© au lancement depuis le terminal est donn√© dans mon <a href="https://github.com/nikanor97/habr_google_script_api" rel="nofollow">github</a> . <br><br>  Aussi, je vais donner le code des fonctions principales ci-dessous <br><br><div class="spoiler">  <b class="spoiler_title">login.py</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pprint <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pprint <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pickle <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os.path <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> googleapiclient.discovery <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> build <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> google_auth_oauthlib.flow <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> InstalledAppFlow <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> google.auth.transport.requests <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Request <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">login</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(config)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: creds = <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-comment"><span class="hljs-comment"># The file token.pickle stores the user's access and refresh tokens, and is # created automatically when the authorization flow completes for the first # time. token_file = config['credentials_path'] + config['token_file'] credentials_file = config['credentials_path'] + config['credentials_file'] if os.path.exists(token_file): with open(token_file, 'rb') as token: creds = pickle.load(token) # If there are no (valid) credentials available, let the user log in. if not creds or not creds.valid: if creds and creds.expired and creds.refresh_token: creds.refresh(Request()) else: flow = InstalledAppFlow.from_client_secrets_file(credentials_file, config['SCOPES']) creds = flow.run_local_server(port=0) # Save the credentials for the next run with open(token_file, 'wb') as token: pickle.dump(creds, token) service = build('script', 'v1', credentials=creds) pprint('Login successful') return service except Exception as e: pprint(f'Login failure: {e}') return None</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">update_script.py</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pprint <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pprint <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sys <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> googleapiclient <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> errors <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> google_habr_login <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> login MANIFEST = <span class="hljs-string"><span class="hljs-string">''' { "timeZone": "America/New_York", "exceptionLogging": "STACKDRIVER", "executionApi": { "access": "ANYONE" } } '''</span></span>.strip() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">update_project</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(service, script_id, script_file_name)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># Read from file code we want to deploy with open(script_file_name, 'r') as f: sample_code = f.read() # Upload two files to the project request = { 'files': [{ 'name': 'hello', 'type': 'SERVER_JS', 'source': sample_code }, { 'name': 'appsscript', 'type': 'JSON', 'source': MANIFEST } ] } # Update files in the project service.projects().updateContent( body=request, scriptId=script_id ).execute() pprint('Project was successfully updated') def main(): try: args = sys.argv if len(args) != 4: raise TypeError('Wrong number of arguments. Three argument required: &lt;config_file_name&gt;, &lt;script_id&gt; and ' '&lt;script_file_name&gt;') config_file_name = args[1] script_id = args[2] script_file_name = args[3] with open(config_file_name, "r") as f: config = json.load(f) service = login(config) update_project(service, script_id, script_file_name) except (errors.HttpError, ) as error: # The API encountered a problem. pprint(error.content.decode('utf-8')) if __name__ == '__main__': main()</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">export_form.py</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pprint <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pprint <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> socket <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sys <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> googleapiclient <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> errors <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> google_habr_login <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> login socket.setdefaulttimeout(<span class="hljs-number"><span class="hljs-number">120</span></span>) <span class="hljs-comment"><span class="hljs-comment"># Get JSON, which is returned by script def get_json(service, file_name, script_id, form_url): pprint('Exporting form...') body = { "function": "main", "devMode": True, "parameters": form_url } # Get JSON from script resp = service.scripts().run(scriptId=script_id, body=body).execute() # Write out JSON to file with open(file_name, 'w', encoding='utf-8') as f: json.dump(resp['response']['result'], f, ensure_ascii=False, indent=4) pprint('Form was successfully exported') def main(): try: args = sys.argv if len(args) != 5: raise TypeError('Wrong number of arguments. Four arguments required: &lt;config_file_name&gt;, ' '&lt;result_file_name&gt;, &lt;script_id&gt; and &lt;google_form_url&gt;') config_file_name = args[1] file_name = args[2] script_id = args[3] form_url = args[4] with open(config_file_name, "r") as f: config = json.load(f) service = login(config) get_json(service, file_name, script_id, form_url) except (errors.HttpError, ) as error: # The API encountered a problem. pprint(error.content.decode('utf-8')) if __name__ == '__main__': main()</span></span></code> </pre><br></div></div><br>  Pour commencer, vous devez placer le fichier JSON avec les cl√©s d'acc√®s Google dans le dossier des informations d'identification et la configuration JSON dans le m√™me r√©pertoire que les scripts. <br><br>  Ensuite, si nous voulons mettre √† jour le script √† distance, alors dans l'appel du terminal: <br><br><pre> <code class="bash hljs">python update_script.py &lt;config_file_name&gt; &lt;script_id&gt; &lt;script_file_name&gt;</code> </pre><br>  Dans ce cas: <br><br><ul><li>  <i>config_file_name</i> - nom du fichier de configuration JSON </li><li>  <i>script_id</i> - ID de script </li><li>  <i>script_file_name</i> - le nom du fichier .gs qui sera t√©l√©charg√© sur google </li></ul><br>  Pour ex√©cuter le script, appelez: <br><br><pre> <code class="bash hljs">python export_form.py &lt;config_file_name&gt; &lt;result_file_name&gt; &lt;script_id&gt; &lt;google_form_url&gt;</code> </pre><br>  Dans ce cas: <br><br><ul><li>  <i>config_file_name</i> - nom du fichier de configuration JSON </li><li>  <i>result_file_name</i> - le nom du fichier JSON dans lequel le formulaire sera d√©charg√© </li><li>  <i>script_id</i> - ID de script </li><li>  <i>google_form_url</i> - URL du formulaire Google </li></ul><br>  Merci de votre attention, en attendant vos suggestions et commentaires :) </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr485898/">https://habr.com/ru/post/fr485898/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr485878/index.html">Une s√©quence d'√©tapes pour organiser la comptabilit√© de gestion sur la plate-forme JetCalc</a></li>
<li><a href="../fr485884/index.html">Comment configurer le Levitron chinois</a></li>
<li><a href="../fr485886/index.html">Comment (et pourquoi) analyser gratuitement les cl√©s et les annonces de concurrents de Yandex.Direct et Google Ads</a></li>
<li><a href="../fr485892/index.html">La fin de l'√®re Trident</a></li>
<li><a href="../fr485896/index.html">Base de donn√©es massivement parall√®le Greenplum - un programme √©ducatif court</a></li>
<li><a href="../fr485904/index.html">Meetup Test de charge √† Raiffeisenbank</a></li>
<li><a href="../fr485908/index.html">Gr√¢ce √† l'incroyable p√©pin dans Ocarina of Time, il a √©t√© possible d'ajouter des mod√®les de Star Fox 64</a></li>
<li><a href="../fr485910/index.html">D√©ploiement d'API avec AWS Elastic Beanstalk</a></li>
<li><a href="../fr485914/index.html">Propuls√© par ZeroTier. Un guide pratique pour la construction de r√©seaux virtuels. Partie 1</a></li>
<li><a href="../fr485916/index.html">Supprimer les inutiles [effacer le calendrier des inutiles]</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>