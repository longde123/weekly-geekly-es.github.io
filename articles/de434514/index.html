<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®‚Äç‚ù§Ô∏è‚Äçüë® ‚ùóÔ∏è „äôÔ∏è "Geheimnisse" DPAPI oder DPAPI f√ºr Pentester üôáüèº üç• üê§</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Der zweite Artikel basiert auf den Ergebnissen der Leistung unseres Teams bei OFFZONE-2018. Betrachten Sie diesmal ein Gespr√§ch mit MainTrack ‚ÄûWindows...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>"Geheimnisse" DPAPI oder DPAPI f√ºr Pentester</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/434514/">  Der zweite Artikel basiert auf den Ergebnissen der Leistung unseres Teams bei OFFZONE-2018.  Betrachten Sie diesmal ein Gespr√§ch mit MainTrack ‚ÄûWindows DPAPI‚Äû Sekretiki ‚Äúoder DPAPI f√ºr Pentester‚Äú. <br><br>  Achtung!  Viele Buchen! <br><br>  Bei der Durchf√ºhrung von RedTeam-Kampagnen m√∂chte ich weniger Gr√ºnde f√ºr die Reaktion von BlueTeam angeben, aber es kann viele geben.  F√ºhren Sie beispielsweise mimikatz aus, um Benutzerkennw√∂rter oder Zertifikate abzurufen.  Selbst wenn wir ihn von Kaspersky aus ‚Äûotmazyvat‚Äú konnten, kann BlueTeam mithilfe spezieller Tools wie Sysmon, Microsoft ATA usw. nachverfolgen.  Gleichzeitig m√∂chte ich die maximalen Informationen von einem kompromittierten Benutzercomputer erhalten.  Im Verlauf von Kampagnen, die RedTeam wiederholt durchf√ºhrte, um echten BlueTeam-Teams entgegenzuwirken, kamen wir zu dem Schluss, dass Ma√ünahmen, die als Indikatoren f√ºr Systemkompromisse dienen k√∂nnen, maximal vermieden werden m√ºssen.  Um dieses Ziel zu erreichen, k√∂nnen rechtliche Mechanismen und Ma√ünahmen verwendet werden, die das Betriebssystem f√ºr den Benutzer bereitstellt. <br><br>  Eines dieser rechtlichen Tools ist der DPAPI-Mechanismus (Windows Data Protection API), mit dem das Betriebssystem und verschiedene Anwendungen vertrauliche Benutzerdaten (haupts√§chlich Kennw√∂rter, kryptografische Schl√ºssel usw.) verschl√ºsseln. F√ºr den Endbenutzer und seine Anwendungen sieht DPAPI √§u√üerst einfach aus : Es gibt nur 2 Funktionen - "Daten verschl√ºsseln" und "Daten entschl√ºsseln".  In diesem Artikel m√∂chte ich untersuchen, wie n√ºtzlich ein solcher Mechanismus f√ºr Pentester w√§hrend RedTeam-Kampagnen ist. <br><a name="habracut"></a><br><h3>  Was ist DPAPI?  Nur kurz und auf Russisch </h3><br>  Seit dem Jahr 2000 verwenden alle Windows-Betriebssysteme die DPAPI-Engine, um die Sicherheit der Benutzerdaten zu gew√§hrleisten. <br><br>  Wenn wir die gesamte Kryptografie √ºberspringen, die wir im Bericht untersucht haben, ben√∂tigen wir zum Entschl√ºsseln der √ºber DPAPI verschl√ºsselten Daten: einen Hauptschl√ºssel, eine Benutzer-SID, einen Benutzerpasswort-Hash und einen DPAPI-Blob selbst (DPAPI-verschl√ºsselte Daten). <br><br>  Im Allgemeinen sieht der Prozess folgenderma√üen aus: <br><br><img src="https://habrastorage.org/webt/n1/ex/ah/n1exahepzml5ykake_tcy_qaj6i.jpeg"><br><br>  In unserem "kryptografischen Hut" gibt es viele verschiedene Kryptomechanismen, die wir in diesem Artikel nicht ber√ºcksichtigen werden, um den Leser nicht zu √ºberlasten.  Wir stellen nur fest, dass der Hauptteil von DPAPI der sogenannte Masterkey (Hauptschl√ºssel) ist.  In einfachen Worten, der Hauptschl√ºssel besteht aus 64 Bytes zuf√§lliger Daten, die mit dem Prekey verschl√ºsselt wurden und aus dem Kennwort des Benutzers und seiner SID generiert werden. <br><img src="https://habrastorage.org/webt/dr/gu/b2/drgub2ccge4pjhkz1czilfleveg.jpeg"><br><br>  Zus√§tzliche Parameter nehmen ebenfalls an der Prekey-Generierung teil: die Anzahl der Iterationen (IterN), Salt und HMAC, die von Fall zu Fall variieren k√∂nnen.  Die Werte dieser Parameter werden zusammen mit dem Hauptschl√ºssel in einer Datei gespeichert. <br><br>  Wenn wir also das Passwort des Benutzers, seine SID kennen und die Generierungsparameter aus der Hauptschl√ºsseldatei (HMAC, Salt, InterN) lesen, k√∂nnen wir einen Vorschl√ºssel erzeugen und den Hauptschl√ºssel entschl√ºsseln, d.h.  Holen Sie sich die sehr zuf√§lligen 64 Bytes, die wir zum Entschl√ºsseln von DPAPI-Blobs verwenden. <br><br><h3>  Was ist, wenn ich mein Passwort √§ndere? </h3><br>  Normalerweise √§ndern sich Benutzerkennw√∂rter in regelm√§√üigen Abst√§nden.  Was passiert, wenn der Benutzer das Passwort √§ndert?  Wo ist der vorherige hingegangen?  Um den Hauptschl√ºssel zu entschl√ºsseln, m√ºssen Sie das Benutzerkennwort kennen, und das erneute Verschl√ºsseln aller Benutzerhauptschl√ºssel ist jedes Mal zu teuer.  In diesem Fall ist alles in Windows durchdacht. <br><br>  Es gibt eine spezielle Datei (CREDHIST), deren Aufgabe darin besteht, alle vorherigen Benutzerkennw√∂rter zu speichern.  Es wird auch mit dem aktuellen Kennwort des Benutzers verschl√ºsselt und auf dem Stapel gespeichert.  Wenn das System den Hauptschl√ºssel pl√∂tzlich nicht mehr entschl√ºsselt, geht es wie folgt vor: Mit dem aktuellen Kennwort entschl√ºsselt es den ersten Datensatz in CREDHIST.  Das Kennwort versucht erneut, den Hauptschl√ºssel zu entschl√ºsseln usw., bis die Kennw√∂rter in der Kette abgelaufen sind oder der Hauptschl√ºssel entschl√ºsselt ist. <br><br><h3>  Ein bisschen √ºber die privaten Schl√ºssel eines Dom√§nencontrollers </h3><br>  Wie Sie vielleicht vermutet haben, wird DPAPI auf alle Benutzer angewendet, einschlie√ülich Dom√§nenbenutzer.  Um das Passwort auf einen Benutzer zur√ºcksetzen zu k√∂nnen, der es nach einer Party am Freitagabend erfolgreich vergessen hat, ben√∂tigen Sie einen Ersatzschl√ºssel, der an einem sicheren Ort aufbewahrt wird.  Laut Microsoft ist ein so zuverl√§ssiger Ort ein Dom√§nencontroller. <br><br>  Der Mechanismus zum Entschl√ºsseln des Hauptschl√ºssels nach dem Zur√ºcksetzen des Benutzerkennworts besteht im Wesentlichen wie folgt: Auf dem Dom√§nencontroller wird ein Paar RSA-Schl√ºssel - privat und √∂ffentlich - erstellt.  Der private Schl√ºssel wird auf dem Dom√§nencontroller in der NTDS-Datenbank gespeichert und hei√üt BCKUPKEY_xxxx (siehe Abbildung unten). Der √∂ffentliche Schl√ºssel wird an alle Dom√§nensysteme verteilt und zum Generieren eines Duplikats des Hauptschl√ºssels verwendet. <br><br>  Nach dem Erstellen eines Hauptschl√ºssels auf einem Dom√§nencomputer wird auch dessen Duplikat erstellt (oder besser gesagt, das Hauptschl√ºsselmaterial sind seine 64 Bytes), das zusammen mit dem Hauptschl√ºssel in einer Datei gespeichert wird und als Dom√§nenschl√ºssel bezeichnet wird.  Wenn Sie den Hauptschl√ºssel verlieren, d.h.  Beim Zur√ºcksetzen des Benutzerkennworts sendet das System ein Duplikat davon an den Dom√§nencontroller und fordert Sie auf, es zu entschl√ºsseln.  Nachdem der Controller den Benutzer autorisiert hat, entschl√ºsselt er das Duplikat und gibt es an das System zur√ºck. Danach wird das Hauptschl√ºsselmaterial bereits wieder mit einem neuen Kennwort verschl√ºsselt. <br><br><img src="https://habrastorage.org/webt/jj/7h/zr/jj7hzrqypjkdjwiaooxks9wcbj0.jpeg"><br><br>  Mit den entsprechenden Berechtigungen in der Dom√§ne (meistens Administrator) k√∂nnen Sie diese privaten RSA-Schl√ºssel √ºber den Replikationsmechanismus vom Dom√§nencontroller abrufen und zur weiteren Entschl√ºsselung der auf den Dom√§nencomputern erstellten Hauptschl√ºssel verwenden.  Dies kann mit Mimikatz oder DSInternals erfolgen.  Weitere Informationen hierzu finden Sie im Mimikatz-Wiki oder im <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">DSInternals-</a> Blog. <br><br><h3>  Wo sind die Hauptschl√ºssel gespeichert und was sind sie? </h3><br>  Der Hauptschl√ºssel kann Benutzer und System sein, je nachdem, wessen Geheimnisse verschl√ºsselt sind.  Der Benutzerstammschl√ºssel wird folgenderma√üen im Benutzerprofil gespeichert: <br><br> <code>Users\%USER%\AppData\Roaming\Microsoft\Protect\%SID%\</code> <br> <br>  F√ºr alle F√§lle speichert das System alle Hauptschl√ºssel, die jemals vom Benutzer verwendet wurden.  Schlie√ülich wei√ü sie nicht im Voraus, welcher Master etwas mit einem Schl√ºssel entschl√ºsseln muss.  Die GUID des aktuell verwendeten Schl√ºssels wird in der Preferred-Datei gespeichert. <br><br><img src="https://habrastorage.org/webt/xf/vm/dr/xfvmdrhqgsspxyznypourrwceh8.jpeg"><br><br>  Systemhauptschl√ºssel werden folgenderma√üen gespeichert: <br> <code>windows\system32\Microsoft\Protect\S-1-5-18\</code> <br> <br>  √Ñhnlich wie beim Benutzer wird ein Hauptschl√ºssel verwendet, dessen Name in der bevorzugten Datei enthalten ist, in der alle jemals verwendeten Schl√ºssel gespeichert sind. <br><br><img src="https://habrastorage.org/webt/zt/xt/xj/ztxtxjcblhgk7ugrwxwgosbtmjw.jpeg"><br><br><h3>  Was kann diese DPAPI dem Pentester geben? </h3><br>  Da DPAPI ein legaler und einfacher Mechanismus ist, versuchen verschiedene Anwendungen, ihn zu verwenden.  Weil es bequem und sicher ist.  Vorerst nat√ºrlich. <br><br>  Beispielsweise wird DPAPI verwendet, um private Schl√ºssel von Client- und Systemzertifikaten, WIFI-Schl√ºsseln, Chrome (Cookies, Kennw√∂rter), DropBox, Skype und RSA SecurID (eine Softwareanwendung, die einmalige Schl√ºssel generiert) zu verschl√ºsseln.  Und dies ist keineswegs eine vollst√§ndige Liste. <br><br>  Die Aufgabe des Pentesters ist es, die erforderlichen Blobs zu entschl√ºsseln und Passw√∂rter, Cookies usw. zu erhalten. <br><br>  Es gibt verschiedene M√∂glichkeiten, dies zu tun.  Auf die eine oder andere Weise beschr√§nken sich alle auf zwei Transkripte - online und offline.  Bei der Online-Entschl√ºsselung rufen wir auf dem Computer des Benutzers einfach die Systemfunktionen zum Entschl√ºsseln der Daten auf und √ºbergeben den DPAPI-Blob an das System. Das System erledigt alles selbst - es sucht nach dem Hauptschl√ºssel, mit dem der Blob verschl√ºsselt wurde, und entschl√ºsselt ihn mithilfe der SID des Benutzers und einen Passwort-Hash, der im LSASS-Speicher gespeichert ist. <br><br>  Die folgende Abbildung zeigt ein Beispiel f√ºr den Aufruf von DPAPI-Funktionen zur Ver- und Entschl√ºsselung auf Powershell. <br><br><img src="https://habrastorage.org/webt/nj/h3/ko/njh3koyjpr5f1yft8o6zllkpjfw.jpeg"><br><br>  Zuerst verschl√ºsseln wir unser Geheimnis (in diesem Fall das Wort ‚ÄûPasswort‚Äú), indem wir die Funktion [Security.Cryptography.ProtectedData] :: Protect () aufrufen.  Und das zweimal - im ersten Fall mit dem Hauptschl√ºssel des Benutzers (Parameter CurrentUser) und im zweiten mit dem Systemhauptschl√ºssel (Parameter LocalMachine).  Dann k√∂nnen wir die resultierenden Blobs entschl√ºsseln, indem wir die Umkehrfunktion aufrufen - [Security.Cryptography.ProtectedData] :: UnProtect (). <br><br>  Dar√ºber hinaus spielt in diesem Fall der Wert des Parameters CurrentUser oder LocalMachine keine Rolle, da  Das System selbst findet einen Hauptschl√ºssel, der zum Dekodieren des Blobs geeignet ist, und erledigt alles Notwendige.  In beiden F√§llen erhalten wir unser erstes Geheimnis - das Wort ‚ÄûPasswort‚Äú (seine byteweise Darstellung). <br><br>  Beim Online-Entschl√ºsseln ist es wichtig zu verstehen, in welchem ‚Äã‚ÄãKontext Sie die Funktion UnProtect () aufrufen.  Damit die Entschl√ºsselung erfolgreich ist, m√ºssen Sie sich in einer Benutzersitzung befinden oder sich unter einer neuen Sitzung anmelden.  Die Sache ist der Passwort-Hash, der im LSASS-Speicher gespeichert ist.  Wenn Sie au√üerhalb der Sitzung des Benutzers einen Anruf t√§tigen (z. B. Sie haben sich √ºber das Netzwerk √ºber psexec oder meterpreter beim System angemeldet), ben√∂tigen Sie dementsprechend keinen Kennwort-Hash, um den Hauptschl√ºssel zu entschl√ºsseln.  Er ist nat√ºrlich in der n√§chsten Sitzung, aber LSASS wird es Ihnen nicht geben, weil  Dies ist eine weitere Sitzung, obwohl sie unter demselben Benutzer erstellt wurde.  F√ºr eine erfolgreiche Online-Entschl√ºsselung m√ºssen Sie entweder zu einem Prozess migrieren, der von dem √ºber die GUI angemeldeten Benutzer gestartet wurde, oder sich vollst√§ndig √ºber RDP beim System anmelden. <br><br>  Eine Alternative zu Powershell f√ºr die Online-Entschl√ºsselung von DPAPI-Blobs kann ein Aufruf von mimiktaz :: blob mit dem Parameter / unprotect sein.  Bei der Eingabe erh√§lt er eine Bin√§rdatei mit einem DPAPI-Blob, und bei der Ausgabe erhalten wir entschl√ºsselte Daten.  Weitere F√§lle mit Mimikatz sind <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">im</a> HarmJ0y- <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Blog beschrieben</a> . <br><br><h3>  Der Spielball fiel.  Was mache ich mit meiner Farm mit Vidyuhi? </h3><br>  Aufgrund der Tatsache, dass DPAPI-Hauptschl√ºssel mit dem Kennwort des Benutzers verschl√ºsselt sind, k√∂nnen Sie den umgekehrten Vorgang versuchen - Brute Force das Kennwort des Benutzers durch seinen Hauptschl√ºssel.  Zum Beispiel haben wir eine umgekehrte Verbindung von unserem Makro oder DDE aus der gesendeten docx-Datei erhalten.  Wir k√∂nnen den Hauptschl√ºssel des Benutzers nehmen und das Kennwort des Benutzers wiederherstellen, ohne dass es zu einer Eskalation von Berechtigungen und Mimikatz-Starts kommt. <br><br>  Kann ich Hashcat oder JohnTheRipper f√ºr Passwort Bruteforce verwenden?  Zuvor m√ºssen Sie jedoch die Parameter f√ºr Brute Force aus der Komposition von John mit dem entsprechenden Skript abrufen: <br><br><pre> <code class="xml hljs">./DPAPImk2john.py ‚ÄìS <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">sid</span></span></span><span class="hljs-tag">&gt;</span></span> -mk <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">masterkey</span></span></span><span class="hljs-tag">&gt;</span></span> -c <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">domain|local</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Dann k√∂nnen wir das Ergebnis des Skripts bereits mit Grafikkarten an unsere Farm senden und hoffen, dass der Benutzer ein schwaches Passwort hat, weil  Die Brute-Force-Geschwindigkeit des Hauptschl√ºssels ist ungef√§hr vergleichbar mit der WPA2-Aufz√§hlungsgeschwindigkeit, d.h.  ziemlich langsam. <br><br>  Hierbei ist zu beachten, dass f√ºr den Fall, dass ein Hauptschl√ºssel unter Windows 10 generiert wird, der Prekey-Generierung weitere 10.000 Runden PBKDF2-Algorithmus hinzugef√ºgt werden.  Schlimmer noch, weder Hashcat noch JohnTheRipper wissen davon (zumindest zum Zeitpunkt dieses Schreibens), was bedeutet, dass sie das Passwort nicht von einem solchen Hauptschl√ºssel entfernen k√∂nnen. <br><br><h3>  "Um alles, was schlecht ist, wegzunehmen und es dann herauszufinden ..." </h3><br>  Wie bereits erw√§hnt, kann die Ausf√ºhrung verd√§chtiger Aktionen auf dem Computer des Benutzers zus√§tzliches Interesse beim Blueteam-Team hervorrufen. Dies ist dementsprechend mit der Tatsache behaftet, dass das gesamte RedTeam dort endet.  Ein Beispiel ist der Start von Powershell auf dem Computer eines Buchhalters oder einer Sekret√§rin, gefolgt von einer Untersuchung des Vorfalls.  Um keinen unn√∂tigen Verdacht zu erregen, ist es besser, Offline-Methoden zum Dekodieren von DPAPI-Blobs zu verwenden.  Dazu m√ºssen Sie zuerst alles, was Sie brauchen, von der Maschine abholen, n√§mlich: <br><br><ul><li>  Benutzerhauptschl√ºssel </li><li>  Systemhauptschl√ºssel </li><li>  CREDHIST-Datei (wenn es sich nicht um einen Dom√§nencomputer handelt); </li><li>  Benutzerkennwort (oder dessen sha1 / ntlm-Hash); </li><li>  SID des Benutzers; </li><li>  DPAPI-Blobs, die wir entschl√ºsseln m√∂chten. </li></ul><br>  Bei der Entschl√ºsselung im Offline-Modus k√∂nnen wir nicht auf spezielle Tools verzichten.  Solche Werkzeuge k√∂nnen sein: <br><br><ul><li>  Mimikatz; </li><li>  Impacket (ab der 18. Version mit DPAPI-Funktionalit√§t); </li><li>  Dpapick Framework. </li></ul><br>  Es geht um das dpapick-Framework, √ºber das wir ausf√ºhrlicher sprechen werden. <br><br>  Das Python-dpapick-Framework selbst wurde 2014 vom Forscher Jean-Michel Pikode erstellt und ist eine Implementierung von DPAPI-Mechanismen in Python-Kryptobibliotheken.  Die Verwendung von Python sowie die Struktur des Frameworks erm√∂glichen eine einfache Anpassung an verschiedene DPAPI-Mechanismen.  In der urspr√ºnglichen Version konnte dpapick den Dom√§nensicherungsschl√ºssel nicht zum Entschl√ºsseln von Hauptschl√ºsseln verwenden, und es gab keine Mechanismen zum Entschl√ºsseln von Hauptschl√ºsseln, die unter Windows 10 im Dom√§nencomputermodus erstellt wurden. <br><br>  Nachdem diese M√§ngel behoben und die Funktionalit√§t zum Entschl√ºsseln von DPAPI-Blobs erweitert worden war, entwickelte sich dpapick zu einem ziemlich guten Tool f√ºr die Offline-Dekodierung von DPAPI.  Im Folgenden werden als Beispiele die Optionen f√ºr die Verwendung dieses Frameworks zum Entschl√ºsseln von √ºber DPAPI verschl√ºsselten Benutzerdaten gezeigt. <br><br><h3>  Chrome - Cookies und Passw√∂rter nehmen und entschl√ºsseln </h3><br>  Chrome- <code>%localappdata%\Google\Chrome\User Data\Default\Cookies</code> werden in der Datei <code>%localappdata%\Google\Chrome\User Data\Default\Cookies</code> gespeichert <br>  Die <code>%localappdata%\Google\Chrome\User Data\Default\Login Data</code> befinden sich in der Datei <code>%localappdata%\Google\Chrome\User Data\Default\Login Data</code> <br><br>  Beide Dateien sind SQLite3-Datenbanken, in denen vertrauliche Daten als DPAPI-Blobs gespeichert sind.  Als Teil von dpapick gibt es einen vorgefertigten Dissektor (Parser) dieser Daten (examples / chrome.py).  F√ºr eine erfolgreiche Entschl√ºsselung muss er das Verzeichnis mit den Hauptschl√ºsseln, die Benutzerseite, sein Kennwort oder den Speicherort des privaten Schl√ºssels des Dom√§nencontrollers sowie die sqlite3-Datei aus Chrome (Cookie- oder Anmeldedaten) angeben. <br><br>  Offline-Entschl√ºsselung von Chrome-Cookies mit Benutzerkennwort <br><br><pre> <code class="xml hljs">./chrome.py --cookie <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">cookiefile</span></span></span><span class="hljs-tag">&gt;</span></span> --sid <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SID</span></span></span><span class="hljs-tag">&gt;</span></span> --password <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">..</span></span></span><span class="hljs-tag">&gt;</span></span> --masterkey <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">masterkeydir</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Offline-Entschl√ºsselung eines Chrome-Cookies mithilfe eines Hash aus dem Kennwort eines Benutzers <br><br><pre> <code class="xml hljs">./chrome.py --cookie <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">cookiefile</span></span></span><span class="hljs-tag">&gt;</span></span> --sid <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SID</span></span></span><span class="hljs-tag">&gt;</span></span> --hash <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">..</span></span></span><span class="hljs-tag">&gt;</span></span> --masterkey <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">masterkeydir</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Offline-Entschl√ºsselung von Chrome-Kennw√∂rtern mithilfe eines privaten Schl√ºssels von einem Dom√§nencontroller <br><br><pre> <code class="xml hljs">./chrome.py --chrome <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">login</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">file</span></span></span><span class="hljs-tag">&gt;</span></span> --pkey <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">rsa-priv.pem</span></span></span><span class="hljs-tag">&gt;</span></span> --masterkey <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">masterkeydir</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><h3>  DPAPI f√ºr Client-Zertifikate </h3><br>  Client-Zertifikate werden h√§ufig verwendet, um - OTP, EFS oder Authentifizierung in VPN, Webanwendungen usw. zu generieren. <br><br>  Die Public-Key-Zertifikate selbst werden im Benutzerprofil gespeichert: <br> <code>%APPDATA%\Microsoft\SystemCertificates\My\Certificates\</code> <br>  Und private Schl√ºssel, mit deren Hilfe die Signatur tats√§chlich ausgef√ºhrt wird, oder andere kryptografische Operationen werden √ºber DPAPI verschl√ºsselt und befinden sich auch im Benutzerprofil entlang des Pfads: <br><br><pre> <code class="bash hljs">%APPDATA%\Roaming\Microsoft\Crypto\RSA\&lt;SID&gt;\</code> </pre> <br>  Um private Zertifikatschl√ºssel erfolgreich zu entschl√ºsseln und anschlie√üend PFX-Dateien neu zu erstellen, ben√∂tigen wir zus√§tzlich zu den oben genannten Dateien auch die Hauptschl√ºssel des Benutzers sowie seine SID und sein Kennwort (oder einen privaten RSA-Schl√ºssel vom Controller). <br><br>  Mit Dpapick und dem Benutzerpasswort entschl√ºsseln wir Folgendes: <br><br><pre> <code class="xml hljs">./efs.py --certificates <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">cert</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">dir</span></span></span><span class="hljs-tag">&gt;</span></span> --rsakyes <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">RSA</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">dir</span></span></span><span class="hljs-tag">&gt;</span></span> --sid <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">..</span></span></span><span class="hljs-tag">&gt;</span></span> --password <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">..</span></span></span><span class="hljs-tag">&gt;</span></span> --masterkey <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">masterkeydir</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><img src="https://habrastorage.org/webt/tx/kf/bp/txkfbp91hcb6pg_rq7wgh8w7v5u.jpeg"><br><br>  Mit dem optionalen Parameter rsaout im Screenshot k√∂nnen Sie zus√§tzlich entschl√ºsselte RSA-Schl√ºssel im PEM-Format exportieren.  Das Ergebnis des Skripts ist eine neu erstellte PFX-Datei ohne Kennwort, die bereits in sich selbst importiert und f√ºr den vorgesehenen Zweck verwendet werden kann.  Wenn sich in den oben genannten Verzeichnissen mehrere Zertifikate und private Schl√ºssel befinden, versucht dpapick, jedes davon zu entschl√ºsseln und mehrere pfx-Dateien zu erstellen. <br><br>  Dieselben Aktionen k√∂nnen mit einem privaten Dom√§nenschl√ºssel ausgef√ºhrt werden, um den Hauptschl√ºssel durch Angabe des entsprechenden Parameters zu entschl√ºsseln: <br><br><pre> <code class="xml hljs">./efs.py --certificates <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">cert</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">dir</span></span></span><span class="hljs-tag">&gt;</span></span> --rsakyes <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">RSA</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">dir</span></span></span><span class="hljs-tag">&gt;</span></span> --masterkey <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">masterkeydir</span></span></span><span class="hljs-tag">&gt;</span></span> --pkey <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">domain</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">bkp</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">key</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><h3>  Ein bisschen mehr √ºber die "Chips" der Domain </h3><br>  In Bezug auf die Active Directory-Dom√§ne ist eine wunderbare Funktion wie das Roaming von Anmeldeinformationen zu erw√§hnen - eine Dom√§nenfunktion, wenn Hauptschl√ºssel, verschl√ºsselte Kennw√∂rter und Zertifikate f√ºr den Benutzer in der gesamten Active Directory-Dom√§ne ‚Äû√ºbertragen‚Äú werden.  Sie sind nicht an einen bestimmten Computer gebunden und werden auf dem Computer "ankommen", auf dem sich der Dom√§nenbenutzer anmeldet. <br><br>  Wenn diese "Funktion" aktiviert ist, werden alle vom Benutzer importierten Zertifikate sowie alle seine privaten Schl√ºssel und Kennw√∂rter in AD √ºbertragen und in den entsprechenden Kontoattributen gespeichert: msPKIAccountCrdentailas und msPKIDPAPIMasterKeys. <br><br>  Sie k√∂nnen sehen, wie es in AD aussieht, zum Beispiel durch ldapsearch: <br><br><pre> <code class="xml hljs">ldapsearch -x -h dc1.lab.local -D ‚Äúuser1@lab.local" -s sub "samAccountname=user1" ldapsearch -x -h dc1.lab.local -D "admin@lab.local" -s sub "samAccountname=anyuser"</code> </pre> <br><img src="https://habrastorage.org/webt/vl/sh/01/vlsh019lykontfubtr-g5rx__dc.jpeg"><br><br>  Standardm√§√üig kann ein Benutzer nur DPAPI-Attribute f√ºr sein Konto empfangen.  Mit erh√∂hten Berechtigungen kann dies jedoch f√ºr jedes Konto durchgef√ºhrt werden, einschlie√ülich eines Computerkontos. <br><br>  Credential Roaming ist eine sehr praktische Technologie, nicht nur f√ºr Administratoren, sondern auch f√ºr Pentester.  Nachdem Sie √ºber ldap auf den Dom√§nencontroller zugegriffen haben, k√∂nnen Sie alle Benutzerzertifikate, seine Hauptschl√ºssel und Kennw√∂rter zusammenf√ºhren, die √ºber DPAPI verschl√ºsselt sind (z. B. Kennw√∂rter f√ºr die Verbindung mit Netzwerklaufwerken). <br><br>  Und warum nicht solche Funktionen zu dpapick hinzuf√ºgen, dachten wir - und lehrten es, Zertifikate automatisch von einem Dom√§nencontroller √ºber ldap zu extrahieren, sie zu entschl√ºsseln und pfx-Dateien zu generieren. <br><br><pre> <code class="xml hljs">./efs.py ‚Äìldap-server <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">..</span></span></span><span class="hljs-tag">&gt;</span></span> --ldap-connect admin:Passw0rd@lab.local --ldap-user user1 --password Password1 ./efs.py ‚Äìldap-server <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">..</span></span></span><span class="hljs-tag">&gt;</span></span> --ldap-connect admin:Passw0rd@lab.local --ldap-user user1 --pkey <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">rsa-priv.pem</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><img src="https://habrastorage.org/webt/an/_p/bi/an_pbimm2jjr-iuapm945q43rzs.jpeg"><br><br>  Um das Skript auszuf√ºhren, m√ºssen Sie den Dom√§nencontroller als LDAP-Server, die Details der Verbindung, den Namen des Kontos, f√ºr das wir Zertifikate erhalten, und ein Kennwort zum Entschl√ºsseln des Hauptschl√ºssels (oder eines privaten Sicherungsschl√ºssels des Controllers) angeben. <br><br><h3>  Dropbox  In 60 Sekunden verschwunden ... </h3><br>  Dropbox ist ein weiteres Beispiel f√ºr die Verwendung von DPAPI zum Speichern von Benutzergeheimnissen.  Autorisierungstoken f√ºr Dropbox werden in folgenden Dateien gespeichert: <br><br><pre> <code class="bash hljs">c:\users\&lt;username&gt;\Appdata\Local\Dropbox\instance1\config.dbx c:\users\&lt;username&gt;\Appdata\Local\Dropbox\instance_db\instanse.dbx</code> </pre> <br>  Dies sind verschl√ºsselte SQLite3-Datenbanken, die Daten f√ºr die Verbindung enthalten.  F√ºr die Verschl√ºsselung wird ein symmetrischer Schl√ºssel verwendet, der wiederum √ºber DPAPI verschl√ºsselt und in der Registrierung gespeichert wird: <br><br> <code>HKCU\SOFTWARE\Dropbox\ks <br> HKCU\SOFTWARE\Dropbox\ks1</code> <br> <br>  Daher ist die allgemeine Reihenfolge der Dropbox-Entf√ºhrung wie folgt: <br><br><ol><li>  Wir nehmen zwei Datenbankdateien vom Computer. </li><li>  Wir holen die Schl√ºssel aus der Registrierung und entschl√ºsseln sie mit dpapick. </li><li>  Mit DPAPI verschl√ºsseln wir die empfangenen Schl√ºssel auf unserem Computer und legen sie in der Registrierung ab. </li><li>  Auf unserem Computer ersetzen wir die Datenbankdateien und f√ºhren Dropbox aus. </li></ol><br>  Beachten Sie, dass f√ºr die oben genannten Registrierungszweige spezielle Berechtigungen festgelegt sind.  Sie k√∂nnen nur vom Benutzer gelesen werden.  Weder der Administrator noch das System k√∂nnen sie lesen.  Wenn Sie also im Namen eines anderen Benutzers (sogar eines Administrators) auf die Registrierung zugreifen, m√ºssen Sie zuerst die entsprechenden Berechtigungen f√ºr die angegebenen Registrierungszweige festlegen.  Zum Beispiel so (Powershell): <br><br><pre> <code class="xml hljs">$Sid="S-1-5-21-3463664321-2923530833-3546627382-1000"; $key=[Microsoft.Win32.Registry]::USERS.OpenSubKey("$sid\SOFTWARE\Dropbox\ks",[Microsoft.Win32.RegistryKeyPermissionCheck]::ReadWriteSubTree,[System.Security.AccessControl.RegistryRights]::ChangePermissions); $acl = $key.GetAccessControl(); $rule = New-Object System.Security.AccessControl.RegistryAccessRule ("administrator","FullControl","Allow"); $acl.SetAccessRule($rule); $key.SetAccessControl($acl); $key_path = "REGISTRY::HKEY_USERS\$Sid\SOFTWARE\Dropbox\ks"; (Get-ItemProperty -Path $key_path -Name Client).Client;</code> </pre> <br>  Die Schl√ºssel ks und ks1 enthalten den Header (8 Byte) der DBX-Version vor dem DPAPI-Blob und dem md5-HMAC-DPAPI-Blob (letzte 16 Byte).  Der DPAPI-Blob selbst beginnt mit dem 9. Byte 0x01000000D0 ... Diese Bytes m√ºssen im Base64-Format in eine Datei kopiert werden, die dann √ºber dpapick entschl√ºsselt wird: <br><br><pre> <code class="xml hljs">./filegeneric.py --sid <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">..</span></span></span><span class="hljs-tag">&gt;</span></span> --password <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">..</span></span></span><span class="hljs-tag">&gt;</span></span> --masterkey <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">..</span></span></span><span class="hljs-tag">&gt;</span></span> --base64file <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">..</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Dann m√ºssen Sie auf Ihrem Computer die in der letzten Phase erhaltenen Schl√ºssel mit unserem Hauptschl√ºssel verschl√ºsseln und das Ergebnis in die entsprechenden Registrierungszweige einf√ºgen. <br><br>  F√ºr die Verschl√ºsselung ist es am bequemsten, Powershell zu verwenden: <br><br><pre> <code class="xml hljs">$hdata="4efebbdf394d4003317fc5c357beac4b"; [Byte[]] $dv0_entropy = 0xd1,0x14,0xa5,0x52,0x12,0x65,0x5f,0x74,0xbd,0x77,0x2e,0x37,0xe6,0x4a,0xee,0x9b; $data = ($hdata -split "(?<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">=\G\w{2})(?=\w{2})"</span></span></span><span class="hljs-tag"> | %{ [</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Convert</span></span></span><span class="hljs-tag">]</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">::ToByte</span></span></span><span class="hljs-tag">( $</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">_</span></span></span><span class="hljs-tag">, </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">16</span></span></span><span class="hljs-tag"> ) }); </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Add-Type</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">-AssemblyName</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">System.Security</span></span></span><span class="hljs-tag">; $</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">dk1</span></span></span><span class="hljs-tag"> = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">[system.security.cryptography.protecteddata]::Protect($data,$dv0_entropy,[System.Security.Cryptography.DataProtectionScope]::CurrentUser);</span></span></span><span class="hljs-tag"> $</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">pr</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">([System.BitConverter]::ToString($dk1));$pr</span></span></span><span class="hljs-tag"> $</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">OBJ_hmac</span></span></span><span class="hljs-tag"> = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">New-Object</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">System.Security.Cryptography.HMACMD5</span></span></span><span class="hljs-tag"> $</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">hmac</span></span></span><span class="hljs-tag"> = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">$OBJ_hmac.ComputeHash($dk1)</span></span></span><span class="hljs-tag"> $</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">pr</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">([System.BitConverter]::ToString($hmac));$pr</span></span></span></span></code> </pre> <br>  In diesem Fall ist hdata der Schl√ºssel, der in der Entschl√ºsselungsphase empfangen wurde.  dv0_entropy ist die Entropiekonstante, die von DBOX in DPAPI verwendet wird.  Dem resultierenden Blob m√ºssen Sie der Vorderseite einen 8-Byte-Header 0x00000000F6000000 und der R√ºckseite HMACMD5 + 0x00 zuweisen <br>  Danach k√∂nnen Sie Daten in die entsprechenden Registrierungsschl√ºssel schreiben. <br><br><h3>  DPAPI und RSA SecurID </h3><br>  RSA SecurID ist ein Client-Programm, mit dem ein von RSA entwickeltes Einmalkennwort generiert wird. <br><br>  Es ist eine sehr beliebte Sache f√ºr gro√üe Unternehmen und verwendet auch DPAPI, nur ein wenig komplizierter.  In diesem Fall beschlossen die RSA-Ingenieure, verwirrt zu werden, und wendeten komplexere DPAPI-Schemata an. <br><br>  Token-Daten werden in der Datei <code>%LOCALAPPDATA%\RSA\SecurIDStorage</code> , bei der es sich um die sqlite3-Datenbank handelt.  Jedes verschl√ºsselte Token enth√§lt seine verschl√ºsselte EnTokenSid (Parameter f√ºr die anf√§ngliche Initialisierung des Codegenerierungsalgorithmus).  EnTokenSid wird auf der Basis von DBKey, der SID des Tokens und der Benutzer-SID generiert, und DBKey wird bereits durch die DPAPI-Entschl√ºsselung DBKeyEnc in der folgenden Reihenfolge generiert: <br> <code>DBKeyEnc = DPAPI(CurrenUser, DPAPI(LocalSystem(DBKey))</code> <br> <br>  Das hei√üt,  Zuerst wird der DB-Schl√ºssel mit dem Systemhauptschl√ºssel verschl√ºsselt, und dann wird der resultierende DPAPI-Blob erneut mit dem Benutzerhauptschl√ºssel verschl√ºsselt. <br><br>  Ebenfalls in der Datenbank befindet sich CryptoCheckSum von CheckSum: <br>  CryptoCheckSum = DPAPI-Blob (CurrenUser) <br><br>  Damit der zusammengef√ºhrte SecurIDStorage auf Ihrem Computer funktioniert, m√ºssen Sie: <br><br><ol><li>  Aufgrund der Tatsache, dass die SID des Benutzers an der Bildung der EncTokenSid beteiligt ist, muss die aktuelle Benutzer-SID in der virtuellen Maschine auf denselben Wert wie die SID des Benutzers festgelegt werden, von dem die SecurIDStorage-Basis stammt.  Das NewSid-Dienstprogramm von SysInternals hilft uns dabei. </li><li>  Entschl√ºsseln Sie DBKeyEnc mit dem Hauptschl√ºssel und dem Kennwort des Benutzers oder dem privaten Dom√§nenschl√ºssel (falls der Computer eine Dom√§ne ist). </li><li>  Entschl√ºsseln Sie das Ergebnis der vorherigen Entschl√ºsselung mit dem Systemhauptschl√ºssel und dem Wert des Parameters DPAPI_SYSTEM. </li><li>  Entschl√ºsseln Sie CryptoCheckSum mit dem Hauptschl√ºssel des Benutzers </li><li>  Verschl√ºsseln Sie die empfangenen DBKey- und CheckSum-Werte bereits auf Ihrer virtuellen Maschine in umgekehrter Reihenfolge. </li><li>  In einigen Versionen von SecurID m√ºssen Sie au√üerdem die Festplattengr√∂√üe der virtuellen Maschine auf die gleiche Gr√∂√üe wie die Festplattengr√∂√üe der Quellmaschine einstellen  Das Programm √ºberpr√ºft es beim Start. </li></ol><br>  Wie oben erw√§hnt, ben√∂tigen wir zum Entschl√ºsseln von DBKeyEnc zus√§tzlich zum Hauptschl√ºssel des Benutzers einen Systemhauptschl√ºssel sowie den Wert DPAPI_SYSTEM, mit dem die Systemhauptschl√ºssel entschl√ºsselt werden.  DAPPI_SYSTEM ist tats√§chlich ein bereits gebildeter Prekey, der an der Bildung von Systemhauptschl√ºsseln beteiligt ist.  Sie k√∂nnen es aus dem LSASS-Speicher (√ºber Mimikatz oder durch Analyse des Prozess-Dumps) oder aus den entsprechenden Registrierungszweigen (HKLM \ SYSTEM, HKLM \ SECURITY) abrufen, sichern und dasselbe Impacket analysieren. <br><br>  Dann k√∂nnen wir das erhaltene DPAPI_SYSTEM verwenden, um die erforderlichen Blobs mit dpapick zu entschl√ºsseln (der Parser ist examples / filegeneric.py), wie in den folgenden Screenshots gezeigt: <br><br>  1) DPAPI_SYSTEM √ºber mimikatz offline abrufen <br><br><img src="https://habrastorage.org/webt/ww/xi/ov/wwxiovhm-6gdcbn7tmmpr7-qsim.jpeg"><br><br>  2) DPAPI_SYSTEM √ºber Impacket offline abrufen <br><br><img src="https://habrastorage.org/webt/s7/9v/5g/s79v5gxvzjjccekaklg8gtefyfw.jpeg"><br><br>  3) DPAPIck-Entschl√ºsselung mit Benutzer- und Systemhauptschl√ºsseln <br><br><img src="https://habrastorage.org/webt/ip/th/qm/ipthqmqacvzvixntzgk_n1vsgvs.jpeg"><br><br><h3>  Spickzettel </h3><br>  Damit Sie den Ort bestimmter Daten nicht vergessen, werden wir sie in einen separaten Abschnitt einf√ºgen: <br><br>  <b>Benutzerdefinierte Hauptschl√ºssel</b> <br><br><pre> <code class="bash hljs">%APPDATA%\Microsoft\Protect\&lt;SID&gt;\*</code> </pre> <br>  <b>Systemstammtasten</b> <br><br><pre> <code class="bash hljs">Windows\System32\Microsoft\Protect\*</code> </pre> <br>  <b>DPAPI_SYSTEM</b> <br><br><pre> <code class="bash hljs">LSASecrets ‚Äì online SYSTEM, SECURITY (reg save ‚Ä¶, system\backup, etc)</code> </pre> <br>  <b>Benutzerzertifikate</b> <br><br><pre> <code class="bash hljs">%APPDATA%\Microsoft\SystemCertificates\My\Certificates\ %APPDATA%\Microsoft\Crypto\RSA\&lt;SID&gt;\</code> </pre> <br>  <b>Systemzertifikate</b> <br><br><pre> <code class="bash hljs">HKLM:\SOFTWARE\Microsoft\SystemCertificates\MY\Certificates\* C:\Programdata\Microsoft\Crypto\RSA\MachineKeys\</code> </pre> <br>  <b>Chrome</b> <br><br><pre> <code class="bash hljs">%localappdata%\Google\Chrome\User Data\Default\Cookies %localappdata%\Google\Chrome\User Data\Default\Login Data</code> </pre> <br>  <b>Dropbox</b> <br><br><pre> <code class="bash hljs">HKCU\SOFTWARE\Dropbox\ks HKCU\SOFTWARE\Dropbox\ks1 %APPDATA%\Local\Dropbox\instance1\config.dbx %APPDATA%\Local\Dropbox\instance_db\instanse.dbx</code> </pre> <br>  <b>Rsa sicher</b> <br><br><pre> <code class="bash hljs">%LOCALAPPDATA%\RSA\SecurIDStorage</code> </pre> <br><h3>  Kleine Schlussfolgerung </h3><br>  DPAPI ist eine gro√üartige Sache - die Hauptsache ist zu verstehen, wie es bei der Durchf√ºhrung von Pentests und RedTeam-Studien verwendet werden kann. <br><br>  In diesem Artikel haben wir uns nur einige Beispiele angesehen, bei denen die DPAPI-Entschl√ºsselung angewendet werden kann.  In der Tat ist der Umfang viel breiter.  Beispielsweise haben wir RDP (* .rdg), Icloud (pList-Datei), Skype (*. Xml) und Schl√ºssel f√ºr die Verbindung mit Wi-Fi nicht ber√ºcksichtigt.  √úberall wird DPAPI angewendet und die entsprechenden Parser werden als Teil des dpapick-Frameworks implementiert. <br><br>  Eine modifizierte Version von dpapick ist auf unserem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">GitHub</a> verf√ºgbar.  Wir empfehlen Ihnen dringend, dieses Tool zum Entschl√ºsseln von DPAPI zu verwenden, und wir werden f√ºr die Weiterentwicklung von dpapick dankbar sein. <br><br>  Und einige interessante Informationen finden Sie in unserem Kanal in <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Telegrammen</a> .  Wir erz√§hlen von IB mit den Augen von RedTeam. <br><br>  PS Danke an die Organisatoren von OFFZONE-2018 f√ºr eine coole Konferenz! <br><br>  PPS Der zweite Teil des Artikels <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de434514/">https://habr.com/ru/post/de434514/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de434504/index.html">20 Jahre Fast Reports "Das Produkt wurde in einem Atemzug erstellt, nur hoch ..."</a></li>
<li><a href="../de434506/index.html">Erleben Sie die Ver√∂ffentlichung einer Videobearbeitungsanwendung im Microsoft Store</a></li>
<li><a href="../de434508/index.html">Die dunkle Seite des Suchmaschinenmarketings: Wie und warum Google unsere pers√∂nlichen Daten sammelt</a></li>
<li><a href="../de434510/index.html">Kurz √ºber die Arbeit mit RabbitMQ aus Python</a></li>
<li><a href="../de434512/index.html">Corporate Corporate</a></li>
<li><a href="../de434516/index.html">Eine einfache M√∂glichkeit, mit Ihren Karrierezielen umzugehen.</a></li>
<li><a href="../de434518/index.html">Applaus und Prost: sorgf√§ltig kontrolliertes Drama in Apple Stores</a></li>
<li><a href="../de434522/index.html">Aufgabenbegr√ºndungsmuster und Antimuster</a></li>
<li><a href="../de434524/index.html">Kubernetes Ingress mit den Augen eines Anf√§ngers</a></li>
<li><a href="../de434528/index.html">Raycard-Entschl√ºsselung im Postkartenformat</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>