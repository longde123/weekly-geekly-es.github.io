<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🈴 📙 👍🏼 Consumer Driven Contracts oder Gitlab CI-eyed QA-Testautomatisierung 👨‍🌾 🧑🏾‍🤝‍🧑🏽 📦</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Die Ziele dieser Veröffentlichung sind : 


- Eine kurze Einführung in verbraucherorientierte Verträge (CDC) 
- Konfigurieren Sie die CDI-basierte CI-...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Consumer Driven Contracts oder Gitlab CI-eyed QA-Testautomatisierung</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/451132/"><p>  <strong>Die Ziele dieser Veröffentlichung sind</strong> : </p><br><ul><li>  Eine kurze Einführung in verbraucherorientierte Verträge (CDC) </li><li>  Konfigurieren Sie die CDI-basierte CI-Pipeline </li></ul><br><p>  <strong><em>Verbrauchergesteuerte Verträge</em></strong> </p><br><p>  In diesem Teil werden wir die Hauptpunkte der CDC behandeln.  Dieser Artikel erhebt keinen Anspruch auf Vollständigkeit zum Thema Vertragstests.  Es gibt eine ausreichende Menge an Materialien zu diesem Thema auf demselben <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Habré</a> . </p><br><p>  Um fortzufahren, müssen wir uns mit den wichtigsten Bestimmungen der CDC vertraut machen: </p><br><ul><li>  Die Kontakttests befinden sich auf der Ebene der Service- / Integrationstests über den Unit-Tests gemäß der Mike Cohn- <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Pyramide.</a> </li><li>  Vertragstests können angewendet werden, wenn zwei (oder mehr) Dienste miteinander interagieren. </li><li>  Verbraucherorientierter Ansatz bedeutet, dass der erste Schritt bei der Implementierung darin besteht, einen Test auf der Verbraucherseite zu schreiben.  Das Testergebnis ist ein Pakt (Vertrag) im JSON-Format, der die Interaktion zwischen dem Verbraucher (z. B. Webschnittstelle / mobile Schnittstelle: ein Dienst, der einige Daten empfangen möchte) und dem Anbieter (z. B. Server-API: ein Dienst, der Daten bereitstellt) beschreibt. </li><li>  Der nächste Schritt besteht darin, den Vertrag mit dem Anbieter zu überprüfen.  Dies wird vom <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Pakt-</a> Rahmenwerk vollständig umgesetzt. <a name="habracut"></a></li></ul><br><p>  Beginnen wir also mit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">dem Verbraucherseitentest</a> .  Ich habe <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Pactman benutzt</a> .  So sieht der Test aus: </p><br><pre><code class="plaintext hljs">import pytest from pactman import Like from model.client import Client @pytest.fixture() def consumer(pact): return Client(pact.uri) def test_app(pact, consumer): expected = '123456789' (pact .given('provider in some state') .upon_receiving("request to get user's phone number") .with_request( method='GET', path=f'/phone/john', ) .will_respond_with(200, body=Like(expected)) .given('provider in some state') .upon_receiving("request to get non-existent user's phone number") .with_request( method='GET', path=f'/phone/micky' ) .will_respond_with(404) ) with pact: consumer.get_users_phone(user='john', host=pact.uri) consumer.get_users_phone(user='micky', host=pact.uri)</code> </pre> <br><p>  Mit Pact DSL beschreiben wir Request / Response-Interaktionen.  Nach dem Start des Tests erhalten wir eine neue Datei ({consumer} - {provider} -pact.json): </p><br><pre> <code class="plaintext hljs">{ "consumer": { "name": 'basic_client' }, "provider": { "name": 'basic_flask_app' }, "interactions": [ { "providerStates": [ { "name": "provider in some state", "params": {} } ], "description": "request to get user's phone number", "request": { "method": "GET", "path": "/phone/john" }, "response": { "status": 200, "body": "123456789", "matchingRules": { "body": { "$": { "matchers": [ { "match": "type" } ] } } } } }, { "providerStates": [ { "name": "provider in some state", "params": {} } ], "description": "request to get non-existent user's phone number", "request": { "method": "GET", "path": "/phone/micky" }, "response": { "status": 404 } } ], "metadata": { "pactSpecification": { "version": "3.0.0" } } }</code> </pre> <br><p>  Als nächstes müssen wir den Pakt zur Überprüfung an den Anbieter weitergeben.  Dies geschieht mit Pact Broker. </p><br><p>  Pact Broker ist ein Vertrags-Repository mit einigen zusätzlichen Funktionen, mit denen wir die Kompatibilität von Serviceversionen verfolgen und Netzwerkdiagramme erstellen können (Service-Interaktion). </p><br><p>  <em>Paktmakler</em> <br><img src="https://habrastorage.org/webt/db/zb/mk/dbzbmksspxdjir93qxyzqfdks54.png" alt="Bild"></p><br><p>  <em>Der Pakt</em> <br><img src="https://habrastorage.org/webt/ft/6c/m8/ft6cm8bdxcibi9_eeblom0nxvvo.png" alt="Bild"></p><br><p>  <em>Versionsmatrix</em> <br><img src="https://habrastorage.org/webt/dt/rx/ii/dtrxiixbbm0kfehk9nlxq1sliqu.png" alt="Bild"></p><br><p>  Anbieterüberprüfung </p><br><p>  Dieser Teil des Tests wird vollständig vom Framework durchgeführt.  Nach der Überprüfung werden die Ergebnisse an Pact Broker zurückgesendet. </p><br><pre> <code class="plaintext hljs">provider-verifier_1 | Verifying a pact between basic_client and basic_flask_app provider-verifier_1 | Given provider in some state provider-verifier_1 | request to get user's phone number provider-verifier_1 | with GET /phone/john provider-verifier_1 | returns a response which provider-verifier_1 | WARN: Skipping set up for provider state 'provider in some state' for consumer 'basic_client' as there is no --provider-states-setup-url specified. provider-verifier_1 | has status code 200 provider-verifier_1 | has a matching body provider-verifier_1 | Given provider in some state provider-verifier_1 | request to get non-existent user's phone number provider-verifier_1 | with GET /phone/micky provider-verifier_1 | returns a response which provider-verifier_1 | WARN: Skipping set up for provider state 'provider in some state' for consumer 'basic_client' as there is no --provider-states-setup-url specified. provider-verifier_1 | has status code 404 provider-verifier_1 | provider-verifier_1 | 2 interactions, 0 failures</code> </pre> <br><p>  <strong><em>Ausführen beider Teile des Tests in der Pipeline</em></strong> </p><br><p>  Nachdem beide Teile der Vertragstests zerlegt wurden, wäre es schön, sie bei jedem Commit auszuführen.  Hier kommt Gitlab CI zur Rettung.  Pipeline-Jobs werden in <code>.gitlab-ci.yml</code> .  Bevor wir zur Pipeline übergehen, müssen wir einige Worte zum GitLab Runner sagen, einem Open-Source-Projekt, mit dem Jobs ausgeführt und die Ergebnisse an GitLab zurückgesendet werden.  Jobs können lokal oder mithilfe von Docker-Containern ausgeführt werden.  In unserem Projekt verwenden wir Docker.  Die Testinfrastruktur ist in Containern implementiert und wird in <code>docker-compose.yml</code> , das sich im Stammverzeichnis des Projekts befindet. </p><br><pre> <code class="plaintext hljs">version: '2' services: basic-flask-app: image: registry.gitlab.com/tknino69/basic_flask_app:latest ports: - 5005:5005 postgres: image: postgres ports: - 5432:5432 env_file: - test-setup.env volumes: - db-data:/var/lib/postgresql/data/pgdata pactbroker: image: dius/pact-broker links: - postgres ports: - 80:80 env_file: - test-setup.env provider-states: image: registry.gitlab.com/tknino69/cdc/provider-states:latest build: provider-states ports: - 5000:5000 consumer-test: image: registry.gitlab.com/tknino69/cdc/consumer-test:latest command: ["sh", "-c", "find -name '*.pyc' -delete &amp;&amp; pytest $${TEST}"] links: - pactbroker environment: - CONSUMER_VERSION=$CI_COMMIT_SHA provider-verifier: image: registry.gitlab.com/tknino69/cdc/provider-verifier:latest build: provider-verifier ports: - 5001:5000 links: - pactbroker depends_on: - consumer-test - provider-states command: ['sh', '-c', 'find -name "*.pyc" -delete &amp;&amp; CONSUMER_VERSION=`curl --header "PRIVATE-TOKEN:$${API_TOKEN}" https://gitlab.com/api/v4/projects/$${BASIC_CLIENT}/repository/commits | jq ".[0] .id" | sed -e "s/\x22//g"` &amp;&amp; echo $${CONSUMER_VERSION} &amp;&amp; pact-provider-verifier $${PACT_BROKER}/pacts/provider/$${PROVIDER}/consumer/$${CONSUMER}/version/$${CONSUMER_VERSION} --provider-base-url=$${BASE_URL} --pact-broker-base-url=$${PACT_BROKER} --provider=$${PROVIDER} --consumer-version-tag=$${CONSUMER_VERSION} --provider-app-version=$${PROVIDER_VERSION} -v --publish-verification-results=PUBLISH_VERIFICATION_RESULTS'] environment: - PROVIDER_VERSION=$CI_COMMIT_SHA - API_TOKEN=$API_TOKEN env_file: - test-setup.env volumes: db-data:</code> </pre> <br><p>  Wir haben also Services, die nach Bedarf in Containern ausgeführt werden. </p><br><p>  Dienstleister: </p><br><pre> <code class="plaintext hljs">basic-flask-app: image: registry.gitlab.com/tknino69/basic_flask_app:latest ports: - 5005:5005</code> </pre> <br><p>  Pact Broker und seine Datenbank.  Volumes ermöglichen es uns, ein permanentes Repository für Pakte und Ergebnisse der Anbieterüberprüfung zu haben: </p><br><pre> <code class="plaintext hljs">postgres: image: postgres ports: - 5432:5432 env_file: - test-setup.env volumes: - db-data:/var/lib/postgresql/data/pgdata pactbroker: image: dius/pact-broker links: - postgres ports: - 80:80 env_file: - test-setup.env</code> </pre> <br><p>  Dienstleisterstaaten.  In der Praxis sollte der Anbieter in einen bestimmten Zustand versetzt werden (z. B. den Benutzer in die Datenbank aufnehmen).  In unserem Beispiel wird jedoch einfach eine Dummy-Funktion ausgeführt. </p><br><pre> <code class="plaintext hljs">provider-states: image: registry.gitlab.com/tknino69/cdc/provider-states:latest build: provider-states ports: - 5000:5000</code> </pre> <br><p>  Ein Dienst, der den Verbrauchertest ausführt.  <code>find -name '* .pyc' -delete &amp;&amp; pytest $$ {TEST}</code> den Befehl, der im Container ausgeführt wird. <code>find -name '* .pyc' -delete &amp;&amp; pytest $$ {TEST}</code> </p><br><pre> <code class="plaintext hljs">consumer-test: image: registry.gitlab.com/tknino69/cdc/consumer-test:latest command: ["sh", "-c", "find -name '*.pyc' -delete &amp;&amp; pytest $${TEST}"] links: - pactbroker environment: - CONSUMER_VERSION=$CI_COMMIT_SHA</code> </pre> <br><p>  Dienstanbieter-Verifizierer: </p><br><pre> <code class="plaintext hljs">provider-verifier: image: registry.gitlab.com/tknino69/cdc/provider-verifier:latest build: provider-verifier ports: - 5001:5000 links: - pactbroker depends_on: - consumer-test - provider-states command: ['sh', '-c', 'find -name "*.pyc" -delete &amp;&amp; CONSUMER_VERSION=`curl --header "PRIVATE-TOKEN:$${API_TOKEN}" https://gitlab.com/api/v4/projects/$${BASIC_CLIENT}/repository/commits | jq ".[0] .id" | sed -e "s/\x22//g"` &amp;&amp; echo $${CONSUMER_VERSION} &amp;&amp; pact-provider-verifier $${PACT_BROKER}/pacts/provider/$${PROVIDER}/consumer/$${CONSUMER}/version/$${CONSUMER_VERSION} --provider-base-url=$${BASE_URL} --pact-broker-base-url=$${PACT_BROKER} --provider=$${PROVIDER} --consumer-version-tag=$${CONSUMER_VERSION} --provider-app-version=$${PROVIDER_VERSION} -v --publish-verification-results=PUBLISH_VERIFICATION_RESULTS'] environment: - PROVIDER_VERSION=$CI_COMMIT_SHA - API_TOKEN=$API_TOKEN env_file: - test-setup.env</code> </pre> <br><p>  <em>Verbraucher-Pipeline</em> <br>  <code>.gitlab-ci.yml</code> im Stammverzeichnis des Consumer-Projekts beschreibt die Prozesse, die auf der Consumer-Seite ausgeführt werden: </p><br><pre> <code class="plaintext hljs">image: gitlab/dind:latest variables: TEST: 'tests/docker-compose.app.yml' CONSUMER_VERSION: $CI_COMMIT_SHA BASIC_APP: '11993024' services: - gitlab/gitlab-runner:latest before_script: - docker login -u $GIT_USER -p $GIT_PASS registry.gitlab.com stages: - clone_test - get_broker_up - test - verify_provider - clean_up clone test: tags: - cdc stage: clone_test script: - git clone https://$GIT_USER:$GIT_PASS@gitlab.com/tknino69/cdc.git &amp;&amp; ls -ali artifacts: paths: - cdc/ broker: tags: - cdc stage: get_broker_up script: - cd cdc &amp;&amp; docker-compose -f docker-compose.yml up -d pactbroker dependencies: - clone test test: tags: - cdc stage: test script: - cd cdc &amp;&amp; CONSUMER_VERSION=$CONSUMER_VERSION docker-compose -f docker-compose.yml -f $TEST up consumer-test dependencies: - clone test provider verification: tags: - cdc stage: verify_provider script: - curl -X POST -F token=$CI_JOB_TOKEN -F ref=master https://gitlab.com/api/v4/projects/$BASIC_APP/trigger/pipeline when: on_success clean up: tags: - cdc stage: clean_up script: - cd cdc &amp;&amp; docker-compose stop consumer-test dependencies: - clone test</code> </pre> <br><p>  Hier passiert folgendes: </p><br><p>  In <code>before_script</code> wir uns mit den Variablen $ GIT_USER und $ GIT_PASS, die wir unter Einstellungen&gt; CI / CD festgelegt haben, bei unserer gitlab-Registrierung an <br><img src="https://habrastorage.org/webt/oc/9t/kt/oc9tktbhk-kfy01ficfvk42ykzc.png" alt="Bild"></p><br><ul><li>  Als nächstes klonen wir ein Testprojekt </li><li>  Im nächsten Schritt erhöhen wir Pact Broker </li><li>  Dann beginnt der Verbrauchertest. </li><li>  Verwenden Sie danach die Gitlab-API, um die Anbieterüberprüfung zu starten. </li><li>  Und schließlich reinigen wir uns </li></ul><br><p>  <em>Provider-Pipeline</em> <br>  Die Provider-Pipeline-Konfiguration wird in <code>.gitlab-ci.yml</code> im Stammverzeichnis des Provider-Projekts gespeichert. </p><br><pre> <code class="plaintext hljs">image: gitlab/dind:latest variables: TEST: 'tests/docker-compose.app.yml' PROVIDER_VERSION: $CI_COMMIT_SHA services: - gitlab/gitlab-runner:latest stages: - clone_test - provider_verification - clean_up clone test: tags: - cdc stage: clone_test script: - git clone https://$GIT_USER:$GIT_PASS@gitlab.com/tknino69/cdc.git artifacts: paths: - cdc/ verify provider: tags: - cdc stage: provider_verification before_script: - cd cdc - docker login -u $GIT_USER -p $GIT_PASS registry.gitlab.com &amp;&amp; docker-compose -f docker-compose.yml up -d basic-flask-app script: - PROVIDER_VERSION=$PROVIDER_VERSION docker-compose -f docker-compose.yml -f $TEST up provider-verifier dependencies: - clone test .clean up: tags: - cdc stage: clean_up script: - cd cdc &amp;&amp; docker-compose down --rmi local</code> </pre> <br><p>  Wie in der Consumer Pipeline haben wir mehrere Jobs: </p><br><ul><li>  Klonen Sie ein Testprojekt </li><li>  Überprüfen Sie den Anbieter </li><li>  Wir reinigen uns </li></ul><br><p>  <em>Fassen Sie zusammen</em> : </p><br><ul><li>  Schrieb einen Vertragstest in Python </li><li>  Richten Sie eine Testumgebung in Docker-Containern ein </li><li>  Konfiguriertes CI basierend auf Vertragstests, d.h.  Beim Festschreiben für das Verbraucherprojekt wird die CI-Pipeline gestartet ( <u>auf der Verbraucherseite</u> : Klonen der Testumgebung -&gt; Starten von Pact Broker -&gt; Testen des Verbrauchers -&gt; Starten der Anbieterüberprüfung -&gt; Bereinigen; <u>auf der Anbieterseite</u> : Klonen der Testumgebung -&gt; Anbieterüberprüfung -&gt; Bereinigen ) <br>  Durch die Verpflichtung zum Anbieterprojekt wird die Überprüfung des Anbieters eingeleitet, um sicherzustellen, dass der Anbieter den Pakt einhält </li></ul><br><p>  Vielen Dank für Ihre Aufmerksamkeit. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de451132/">https://habr.com/ru/post/de451132/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de451118/index.html">Testen ist nichts für Anfänger</a></li>
<li><a href="../de451120/index.html">Über die Herausforderungen bei der Portierung von Dead Cells auf mobile Plattformen</a></li>
<li><a href="../de451124/index.html">Entwicklung von Proteinen in der Cloud mit Python und Transcriptic oder Wie man ein Protein für 360 US-Dollar erstellt</a></li>
<li><a href="../de451126/index.html">Toolbox für Forscher - Ausgabe 1: Selbstorganisation und Datenvisualisierung</a></li>
<li><a href="../de451130/index.html">Swift: ARC- und Speicherverwaltung</a></li>
<li><a href="../de451136/index.html">Eingeführt von .NET 5</a></li>
<li><a href="../de451138/index.html">Symfony CLI - Neues lokales Entwicklungstool</a></li>
<li><a href="../de451144/index.html">Antiquitäten: Technik in der Fernsehwerbung</a></li>
<li><a href="../de451146/index.html">Beschleunigung der Erstellung von Webanwendungen mit Webpack</a></li>
<li><a href="../de451148/index.html">Objektorientierte Programmierung in Grafiksprachen</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>