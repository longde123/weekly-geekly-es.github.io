<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-143967986-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-143967986-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèª‚Äçüé® ü¶é üõ§Ô∏è Take care of your dongles: Logitech keyboard receiver security study ü§≥üèæ üõÄüèæ üì∏</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Historically, most employees use Logitech wireless keyboards and mice. Once again entering our passwords, we, the Raccoon Security team, wondered: how...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Take care of your dongles: Logitech keyboard receiver security study</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ntc-vulkan/blog/479374/"><img src="https://habrastorage.org/webt/ny/e8/br/nye8brz9dcrxabamezjupofstzo.png"><br><p>  Historically, most employees use Logitech wireless keyboards and mice.  Once again entering our passwords, we, the Raccoon Security team, wondered: how difficult is it to bypass the security mechanisms of wireless keyboards?  The study revealed architectural flaws and software errors that allow access to the input data.  Under the cut - what we did. </p><a name="habracut"></a><br><p>  <strong>Why Logitech?</strong> </p><br><p> In our opinion, Logitech input devices are among the highest quality and most convenient.  Most of the devices we have are based on the Logitech <a href="https://www.logitech.com/en-us/product/unifying-receiver-usb">Unifying</a> solution - this is a universal dongle receiver that allows you to connect up to 6 devices.  All Logitech Unifying compatible devices are labeled with the corresponding logo.  An easy-to-use <a href="https://support.logi.com/hc/en-us/articles/360025297913">application</a> allows you to control the connection of wireless keyboards to your computer.  The process of connecting the keyboard to the Logitech dongle-receiver in detail, as well as the technology itself, is covered, for example, <a href="https://fuflometr.ru/logitech-unifying-kak-podklyuchit-shest-ustrojstv-k-odnomu-priemniku/">here</a> . </p><br><img src="https://habrastorage.org/webt/vj/dy/do/vjdydoxcwqaj1luhlm7a_rs877c.jpeg"><br><p>  <em>Logitech Unifying Dongle Receiver</em> </p><br><p>  The keyboard can be a source of information for attackers.  Logitech, taking into account a possible threat, took care of security - it used the AES128 encryption algorithm in the radio channel of the wireless keyboard.  The first thought that an attacker can visit in this situation is to intercept key information when it is transmitted over the air during the linking process.  After all, if you have a key, you can intercept keyboard radio signals and decrypt them.  However, the user very rarely (or even never) has to associate the keyboard with a Unifying procedure, and a hacker with a scanning radio will have to wait a long time.  In addition, not everything is so simple with the interception process itself.  In a recent study in June 2019, security expert Marcus Mengs posted a <a href="https://twitter.com/mame82/status/1143093313924452353">message</a> on the network about the discovery of vulnerabilities in older firmware for Logitech USB dongles.  It allows attackers with physical access to devices to obtain radio channel encryption keys and to inject keystrokes (CVE-2019-13054). </p><br><p>  We‚Äôll talk about our Logitech SoC NRF24 dongle safety study from Nordic Semiconductor.  And let's start with the radio channel itself. </p><br><p>  <strong>How to "fly" data in the radio channel</strong> </p><br><p>  For the time-frequency analysis of the radio signal, we used an SDR receiver based on the Blade-RF device in the spectrum analyzer mode (this can also be read about <a href="https://habr.com/ru/company/dsec/blog/193618">here</a> ). </p><br><img src="https://habrastorage.org/webt/zn/tu/mo/zntumoj2fmtcgjlg4p2spnjmnvg.jpeg"><br><p>  <em>SDR Blade-RF Device</em> </p><br><p>  We also considered the possibility of recording quadratures of the radio signal at an intermediate frequency, and then analyzing them using digital signal processing methods. </p><br><p>  The State Commission on Radio Frequencies in the Russian Federation <a href="https://digital.gov.ru/uploaded/files/prilozhenie-1-k-resheniyu-gkrch-16-36-03.pdf">allowed</a> the use of short-range devices in the frequency range 2400‚Äì2483.5 MHz.  This is a very ‚Äúpopulated‚Äù range in which you can‚Äôt meet anything: Wi-Fi, Bluetooth, various remote controls, security systems, wireless detectors, mouse with keyboards and other wireless digital devices. </p><br><img src="https://habrastorage.org/webt/et/hd/ax/ethdaxxjkysh1bmbehmrtfqhmwi.jpeg"><br><p>  <em>2.4 GHz Band Spectrum</em> </p><br><p>  The interference environment in the range is quite complicated.  Despite this, Logitech was able to provide reliable and stable reception by using the Enhanced ShockBurst protocol in the NRF24 transceiver in combination with frequency adaptation algorithms. </p><br><p>  The channels in the range are located at integer MHz positions, as defined in <a href="https://infocenter.nordicsemi.com/pdf/nRF24LE1_PS_v1.6.pdf">the</a> NRF24 Nordic Semiconductor <a href="https://infocenter.nordicsemi.com/pdf/nRF24LE1_PS_v1.6.pdf">specification</a> - a total of 84 channels in the frequency grid.  The number of frequency channels simultaneously used by Logitech, of course, is less.  We have identified the use of at least four.  Due to the limited field of view of the signal spectrum analyzer used, it was not possible to determine the exact list of used frequency positions, but this was not necessary.  Information from the keyboard to the dongle receiver is transmitted in Burst mode (by short switching on the transmitter) using the two-position frequency modulation GFSK at a symbol speed of 1 Mbaud: </p><br><img src="https://habrastorage.org/webt/ua/93/q8/ua93q8sc0cd53uzs9qnjnirlvc4.jpeg"><br><p>  <em>Keyboard radio signal in temporary representation</em> </p><br><p>  The receiver uses the correlation principle of reception, so the preamble and the address part are present in the transmitted packet.  No interference coding is applied; the data body is encrypted with the AES128 algorithm. </p><br><p>  In general, the radio interface of the Logitech wireless keyboard can be characterized as completely asynchronous with statistical multiplexing and frequency adaptation.  This means that the keyboard transmitter switches the channel to transmit each new packet.  Neither the transmission time nor the frequency channel are known in advance to the receiver, and only their list is known.  The receiver and the transmitter meet in the channel thanks to the agreed algorithms for bypassing and listening to frequencies, as well as Enhanced ShockBurst confirmation mechanisms.  We did not investigate whether the channel list is static.  Probably, its change is due to the frequency adaptation algorithm.  Something close to the frequency hopping method (pseudo-random tuning of the operating frequency) is guessed in the use of the frequency resource of the range. </p><br><p>  Thus, in the conditions of time-frequency uncertainty, to ensure the receipt of all keyboard signals, an attacker will need to constantly monitor the entire frequency grid of a range of 84 positions, which requires considerable time.  Here it becomes clear why the vulnerability of key extraction via USB (CVE-2019-13054) <a href="https://support.logi.com/hc/en-001/community/posts/360033207154-Logitech-Unifying-Receiver-Update">in the sources is</a> positioned as the ability to inject keystrokes, rather than gaining an attacker access to the data entered from the keyboard.  Obviously, the radio interface of the wireless keyboard is quite complicated and provides reliable radio communication between Logitech devices in difficult interference conditions in the 2.4 GHz band. </p><br><p>  <strong>A look at the problem from the inside</strong> </p><br><p>  For research, we chose one of our Logitech K330 keyboards and Logitech Unifying dongle. </p><br><img src="https://habrastorage.org/webt/je/d3/qh/jed3qhby5961hhflyuqstcyuehm.jpeg"><br><p>  <em>Logitech K330</em> </p><br><p>  Let's look inside the keyboard.  An interesting element to study on the board is the SoR NRF24 chip from Nordic Semiconductor. </p><br><img src="https://habrastorage.org/webt/xs/cp/9l/xscp9l7avxwh0ylf2rmc_2budsa.jpeg"><br><p>  <em>SoC NRF24 on Logitech K330 Wireless Keyboard</em> </p><br><p>  The firmware is located in the internal memory, the reading and debugging mechanisms are turned off.  Unfortunately, the firmware has not been published in open sources.  Therefore, we decided to approach the problem from the other side - to study the internal content of the Logitech dongle receiver. </p><br><p>  The ‚Äúinner world‚Äù of the dongle receiver is quite interesting.  The dongle is easily disassembled, carries on board the familiar NRF24 in a release with a built-in USB controller and can be reprogrammed both from the USB side and directly by the programmer. </p><br><img src="https://habrastorage.org/webt/2c/yc/ll/2cycllt09np1jxzpaol1d6sz9uc.jpeg"><br><p>  <em>Logitech dongle without housing</em> </p><br><p>  Since there is a regular firmware update mechanism using <a href="https://support.logi.com/hc/en-001/articles/360035037273">the Firmware Update Tool application</a> (from which you can extract the updated firmware version), there is no need to search for firmware inside the dongle. </p><br><p>  What was done: firmware RQR_012_005_00028.bin was extracted from the body of the Firmware Update Tool application.  To check its integrity, the dongle controller was connected by a loop <a href="https://www.phyton.ru/programmers/ChipProg-48">to the ChipProg-48 programmer</a> : </p><br><img src="https://habrastorage.org/webt/2l/4t/fh/2l4tfhuxvz7bbb9speeyoyd-dk4.jpeg"><br><p>  <em>Logitech dongle cable to ChipProg 48 programmer</em> </p><br><p>  To control the integrity of the firmware, it was successfully placed in the controller memory and worked correctly, the keyboard and mouse were connected to the dongle through Logitech Unifying.  It is possible to fill in the modified firmware using the standard update mechanism, since there are no cryptographic protection mechanisms for the firmware.  For research purposes, we used a physical connection to the programmer, since debugging is much faster this way. </p><br><p>  <strong>Researching firmware and attacking user input</strong> </p><br><p>  The NRF24 chip is designed based on the Intel 8051 computing core in traditional Harvard architecture.  For the core, the transceiver acts as a peripheral device and is located in the address space as a set of registers.  The chip documentation and source code examples can be found on the Internet, so disassembling the firmware is not difficult.  During reverse engineering, we localized the functions of receiving data on keystrokes from the radio channel and converting them to the HID format for transmission to the host via the USB interface.  In free memory addresses, an injection code was placed, which included tools for intercepting control, saving and restoring the original execution context, as well as a functional code. </p><br><p>  A packet for pressing or releasing a key received from a radio channel is decrypted, converted to a standard HID report and sent to the USB interface as from a regular keyboard.  As part of the study, the most interesting part for us is the part of the HID report containing the byte of the modifier flags and an array of 6 bytes with keypress codes (for reference, information about the HID is <a href="https://codeandlife.com/2012/06/18/usb-hid-keyboard-with-v-usb/">here</a> ). </p><br><p>  HID Report Structure: </p><br><pre><code class="plaintext hljs">// Keyboard HID report structure. // See https://flylib.com/books/en/4.168.1.83/1/ (last access 2018 december) // "Reports and Report Descriptors", "Programming the Microsoft Windows Driver Model" typedef struct{ uint8_t Modifiers; uint8_t Reserved; uint8_t KeyCode[6]; }HidKbdReport_t;</code> </pre> <br><p>  Just before the HID structure is transferred to the host, the injected code takes control, copies 8 bytes of native HID data in memory, and sends it to the side radio channel in clear form.  In code, it looks like this: </p><br><pre> <code class="plaintext hljs">//~~~~~~~~~ Send data via radio ~~~~~~~~~~~~~~~~~~~~~~~~~&gt; // Profiling have shown time execution ~1.88 mSec this block of code SaveRfState(); // save transceiver state RfInitForTransmition(TransmitRfAddress); // configure for special trnsmition hal_nrf_write_tx_payload_noack(pDataToSend,sizeof(HidKbdReport_t)); // Write payload to radio TX FIFO CE_PULSE(); // Toggle radio CE signal to start transmission RestoreRfState(); // restore original transceiver state //~~~~~~~~~ Send data via radio ~~~~~~~~~~~~~~~~~~~~~~~~~&lt;</code> </pre> <br><p>  The side channel is organized at a frequency set by us with certain characteristics of the manipulation speed and packet structure. </p><br><p>  The operation of the transceiver in the <a href="https://infocenter.nordicsemi.com/pdf/nRF24LE1_PS_v1.6.pdf">NRF24</a> chip <a href="https://infocenter.nordicsemi.com/pdf/nRF24LE1_PS_v1.6.pdf">is</a> based on a state graph, into which the Enhanced ShockBurst protocol is organically entered.  We found out that immediately before the HID data was transferred to the host USB interface, the transceiver was in IDLE state.  This makes it possible to safely reconfigure to work in the side channel.  The injected code intercepts the control, saves the original transceiver configuration in full, and transfers it to the new transmission mode on the side channel.  The Enhanced ShockBurst acknowledgment mechanism is turned off in this mode, HID data in the clear is transmitted to the air.  The structure of the packet in the side channel is shown in the figure below, the waveform diagrams were obtained after demodulation and before restoration of the clock data synchronization.  The address value is selected for the convenience of visual identification of the packet. </p><br><img src="https://habrastorage.org/webt/id/dn/uf/iddnufyui08i2kkvaom5fgyvyfe.jpeg"><br><p>  <em>Burst Burst Demodulated Signal</em> </p><br><p>  After the transmission of the packet to the side channel is completed, the injected code restores the state of the transceiver.  Now he is again ready to work in normal mode in the context of the original firmware. </p><br><p>  In the frequency and time-frequency regions, the side channel looks as shown in the figure: </p><br><img src="https://habrastorage.org/webt/lp/3y/qb/lp3yqbllvbmqmdjauphlxgfimyi.jpeg"><br><p>  <em>Spectral and time-frequency representation of the side channel</em> </p><br><p>  To test the operation of the NRF24 chip with modified firmware, we assembled a stand that included a Logitech dongle with modified firmware, a wireless keyboard and a receiver assembled on the basis of the Chinese module with the NRF24 chip. </p><br><img src="https://habrastorage.org/webt/zt/j1/fw/ztj1fwupsmjvvgaww5wyjfzwyuu.jpeg"><br><p>  <em>Logitech Wireless Keyboard Radio Interception Diagram</em> </p><br><img src="https://habrastorage.org/webt/f1/v-/tj/f1v-tjbnnzo3lmrowctori-jw4q.jpeg"><br><p>  <em>NRF24 based module</em> </p><br><p>  On the stand during normal keyboard operation after connecting it to the Logitech dongle, we observed the transmission of open data on keystrokes in the secondary radio channel and the normal transmission of encrypted data in the main radio interface.  Thus, we were able to provide a direct interception of the user's keyboard input: </p><br><img src="https://habrastorage.org/webt/gc/_o/r1/gc_or1g-dxo-ovsrusyrbz34rfm.png"><br><p>  <em>Keyboard Interception Result</em> </p><br><p>  The injected code introduces slight delays in the operation of the dongle firmware.  However, they are too small for the user to notice. </p><br><p>  As you can imagine, any Logitech keyboard compatible with Unifying technology can be used for such an attack vector.  Since the attack is aimed at the Unifying receiver, which is included with most Logitech keyboards, it does not depend on the specific keyboard model. </p><br><p>  <strong>Conclusion</strong> </p><br><p>  The results of the study suggest that the attackers could use the considered scenario: if the hacker replaces the victim with a dongle receiver for the Logitech wireless keyboard, he will be able to find out the passwords for the victim's accounts with all the ensuing consequences.  Do not forget that injecting keystrokes is also possible, which means that it is not difficult to execute arbitrary code on the victim‚Äôs computer. </p><br><p>  What if an attacker can remotely modify the firmware of any Logitech dongle via USB?  Then from nearby dongles you can add a network of repeaters and increase the creepage distance.  Although the ‚Äúfinancially secure‚Äù attacker has modern radio reception with highly selective systems, sensitive radios with a short frequency tuning time and narrowly oriented antennas, they will allow you to ‚Äúlisten‚Äù to keyboard input and press keys even from a neighboring building. </p><br><img src="https://habrastorage.org/webt/sb/qg/m-/sbqgm-hr2sp7ai4a1ywzlvihgca.jpeg"><br><p>  <em>Professional radio equipment</em> </p><br><p>  Since the Logitech keyboard wireless data channel is fairly well protected, the attack vector found requires physical access to the receiver, which greatly limits the attacker.  The only protection option in this case could be the use of cryptographic protection mechanisms for the receiver firmware, for example, checking the signature of the downloaded firmware on the receiver side.  But, unfortunately, NRF24 does not support this and it is impossible to implement protection within the current device architecture.  So take care of your dongles, because the described version of the attack requires physical access to them. </p><br><img src="https://habrastorage.org/webt/6d/ts/lv/6dtslv2uikkshhl7tmsi7fgjp0y.png"><br><p>  Raccoon Security is a special team of experts at the Volcano Scientific and Technical Center in the field of practical information security, cryptography, circuitry, reverse engineering and the creation of low-level software. </p><cut></cut></div></div><p>Source: <a href="https://habr.com/ru/post/479374/">https://habr.com/ru/post/479374/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../479360/index.html">Create an open source project for Angels in a couple of clicks</a></li>
<li><a href="../479364/index.html">Rating of the best CPUs for gaming PCs in 2019</a></li>
<li><a href="../479366/index.html">Friday Mobile Survey Results</a></li>
<li><a href="../479368/index.html">How to achieve CMM Level 5 QA and Testing</a></li>
<li><a href="../479370/index.html">DIY capture of Mifare crypto keys and do-it-yourself copying of IronLogic doorphone keys</a></li>
<li><a href="../479376/index.html">Secured by Knox - Samsung Mobile Security Mechanisms</a></li>
<li><a href="../479378/index.html">Think SRE: look at projects through the eyes of an SRE engineer</a></li>
<li><a href="../479382/index.html">Accelerated Development with Spring Boot DevTools</a></li>
<li><a href="../479384/index.html">What does Big Data do in MegaFon and how to get there?</a></li>
<li><a href="../479388/index.html">Features of the construction of national data centers, Mikhalych</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter54458986 = new Ya.Metrika({
                  id:54458986,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/54458986" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-143967986-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=IU0EG0jaqnehka2lu5TyzAcchrZXI4Yb1QXKQvJxpqE&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>