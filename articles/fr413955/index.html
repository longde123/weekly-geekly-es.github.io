<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üö£üèæ üôãüèΩ üà≤ Cycle de d√©veloppement complet du dispositif IoT pour le contr√¥le du chauffage de piscine sur l'ESP8266 dans un environnement Arduino üíâ üéµ üõ¢Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans cette publication, je partagerai mon exp√©rience sur la cr√©ation d'un appareil IoT √† partir de z√©ro: de l'√©mergence d'une id√©e et de sa mise en ≈ìu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Cycle de d√©veloppement complet du dispositif IoT pour le contr√¥le du chauffage de piscine sur l'ESP8266 dans un environnement Arduino</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/413955/"><p>  Dans cette publication, je partagerai mon exp√©rience sur la cr√©ation d'un appareil IoT √† partir de z√©ro: de l'√©mergence d'une id√©e et de sa mise en ≈ìuvre mat√©rielle √† la cr√©ation de firmware pour un contr√¥leur et d'une interface web pour g√©rer un appareil cr√©√© via Internet. </p><br><p>  Avant de cr√©er cet appareil, je: </p><br><ul><li>  Presque ne comprenait pas les circuits.  Seulement au niveau des principes de travail <br>  r√©sistance / transistor ... Je n'avais aucune exp√©rience dans la cr√©ation de circuits compliqu√©s. </li><li>  Cartes de circuits imprim√©s jamais con√ßues. </li><li>  Composant CMS jamais soud√©.  Le niveau du fer √† souder √©tait au niveau des fils √† souder et d'une sorte de relais. </li><li>  Je n'ai jamais √©crit de programmes aussi complexes pour un microcontr√¥leur.  Toute l'exp√©rience √©tait au niveau ¬´allumer la LED en Arduino¬ª, et j'ai rencontr√© pour la premi√®re fois le contr√¥leur ESP8266. </li><li>  J'ai √©crit pas mal de C ++ pour le "grand fr√®re", mais c'√©tait il y a plus d'une douzaine d'ann√©es et tout a √©t√© oubli√© il y a longtemps. </li></ul><br><p>  Bien s√ªr, l'exp√©rience de travailler en tant que programmeur (principalement Microsoft .NET) et la pens√©e syst√©mique m'ont aid√© √† comprendre le sujet.  Je pense que le lecteur pourra.  Liens et articles utiles sur la mer Internet.  Le plus, √† mon avis, int√©ressant et aidant √† comprendre le sujet, j'apporte l'article. </p><a name="habracut"></a><br><h2>  √ânonc√© du probl√®me </h2><br><p>  Je vis dans une maison priv√©e pr√®s de Minsk, et ma propre piscine, bien que la plus simple, fait partie int√©grante de l'ensemble des ¬´avantages¬ª que de nombreuses personnes vivant dans une maison de campagne obtiennent.  Dans notre climat instable, il s'est av√©r√© que la baignade dans la piscine est inconfortable si elle est √† l'ext√©rieur: l'eau se refroidit la nuit et le temps venteux pendant la journ√©e ne rend pas la natation confortable.  L'ann√©e derni√®re, de mes propres mains, j'ai construit un d√¥me g√©od√©sique d'un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">foulon</a> au-dessus de la piscine, mis une colline et accroch√© un √©lastique - les enfants sont heureux. </p><br><img src="https://habrastorage.org/webt/hh/ec/xp/hhecxpolfqsqevq41tmn-84npsg.jpeg"><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><em>Reportage photo de la</em> construction du d√¥me sur Flickr.</a> </p><br><p>  Cette ann√©e, je suis all√© encore plus loin et j'ai d√©cid√© d'organiser un chauffe-piscine √† partir d'une chaudi√®re √† gaz, <br>  qui sert au chauffage de la maison en hiver et au chauffage de l'eau chaude en √©t√©. </p><br><p>  En √©t√©, le circuit "chauffage" de la chaudi√®re √† l'aide de vannes passe en chauffage <br>  piscine.  L'eau de la piscine est chauff√©e √† l'aide d'un √©changeur de chaleur en titane, dont le circuit primaire fait passer le liquide de refroidissement (eau chaude sans impuret√©s) du circuit de chauffage, et le secondaire - l'eau de la piscine, pomp√©e par une pompe de recirculation du syst√®me de filtration.  Puisque j'utilise la piscine avec un √©lectrolyseur (beaucoup de sujets int√©ressants sont <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">d√©crits</a> sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ForumHouse</a> ), l'eau contient un peu de sel et un √©changeur de chaleur en titane est n√©cessaire.  Vous ne pouvez pas simplement prendre et laisser l'eau directement √† travers la chaudi√®re - sinon vous corroderez tous les tuyaux avec du sel. </p><br><img src="https://habrastorage.org/webt/d6/_k/pz/d6_kpzjpyzyvy2-vzk9aukvstko.png"><br><p>  En passant √† travers l'√©changeur de chaleur, le caloporteur chauff√© par la chaudi√®re √† une temp√©rature d'environ 70-90 ¬∞ C d√©gage de la chaleur √† l'eau de la piscine, la chauffant de quelques degr√©s.  Le liquide de refroidissement lui-m√™me refroidit de quelques dizaines de degr√©s et retourne √† la chaudi√®re pour √™tre √† nouveau <br>  r√©chauff√©.  Le rapport du refroidissement de l'eau de la chaudi√®re au chauffage de l'eau de la piscine d√©pend de nombreux facteurs: la capacit√© de l'√©changeur de chaleur et la vitesse de circulation de l'eau dans les circuits primaire et secondaire. </p><br><p>  Les tuyaux reli√©s de la piscine √† l'√©changeur de chaleur sont des tuyaux en poly√©thyl√®ne ordinaires, ceux qui <br>  actuellement utilis√© pour fournir de l'eau froide aux maisons priv√©es.  Bon march√©, la capacit√© de r√©sister √† une pression d√©cente, l'absence de corrosion - ce sont les principaux avantages de ces tuyaux.  Pour tous, sans exception, les tuyaux en poly√©thyl√®ne, la temp√©rature de fonctionnement est limit√©e √† 40 degr√©s Celsius.  En principe, c'est plus que suffisant pour la piscine. </p><br><p>  Cependant, il y a une forte probabilit√© d'urgence en cas de pompe <br>  la recirculation de l'eau de l'eau de la piscine s'arr√™tera pour une raison quelconque, et la chaudi√®re continuera √† chauffer l'√©changeur de chaleur: dans ce cas, l'eau dans le circuit secondaire de l'√©changeur de chaleur augmentera rapidement √† la temp√©rature du circuit primaire, ce qui signifie que les sections de tuyaux en poly√©thyl√®ne adjacentes √† l'√©changeur de chaleur fondront et l'eau de la piscine sera inond√©e tout l'espace autour. </p><br><p>  Il doit √™tre possible de prot√©ger la surchauffe de l'√©changeur de chaleur. </p><br><h2>  Solution rapide </h2><br><p>  Pour r√©soudre ce probl√®me, un capteur de d√©bit fonctionnant sur le principe de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">l'effet hall a</a> √©t√© int√©gr√© au circuit du circuit de recirculation de l'eau de la piscine.  De plus, des capteurs de temp√©rature situ√©s sur le circuit secondaire <br>  √©changeur de chaleur, fournir un deuxi√®me niveau de d√©fense, suivi de la surchauffe possible. </p><br><p>  Il est impossible de contr√¥ler la surchauffe uniquement par des capteurs de temp√©rature: le syst√®me a une grande inertie: apr√®s un arr√™t brutal de l'eau dans le circuit de la piscine, √† <br>  l'arr√™t de la chaudi√®re, la temp√©rature continue d'augmenter pendant un certain temps, comme  la chaudi√®re entra√Æne toujours l'eau chauff√©e le long du circuit par inertie, emp√™chant la surchauffe de ¬´moi, mon bien-aim√©¬ª. </p><br><p>  Par cons√©quent, il est important de r√©pondre le plus t√¥t possible: √† savoir, d'arr√™ter le d√©bit d'eau dans le circuit <br>  piscine. </p><br><p>  Un capteur de d√©bit a √©t√© utilis√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">tel</a> .  Le bo√Ætier en plastique et le manque de contact du capteur avec l'eau lui permettent d'√™tre utilis√© dans l'eau sal√©e. </p><br><p>  Capteurs de temp√©rature, il a √©t√© d√©cid√© d'utiliser le Dallas DS18B20, ils sont faciles √† connecter plusieurs pi√®ces √† la fois sur un bus <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">1-Wire</a> . </p><br><img src="https://habrastorage.org/webt/nd/pj/d5/ndpjd5v3_0lbaklr-ogjnaxribi.jpeg"><br><p>  Il a √©t√© d√©cid√© de suspendre une paire de capteurs √† l'entr√©e et √† la sortie du secondaire et du primaire <br>  circuit: 4 capteurs au total.  Un avantage suppl√©mentaire de cette approche est <br>  la possibilit√© de surveiller les param√®tres du syst√®me: vous pouvez surveiller la quantit√© de liquide de refroidissement dans le circuit primaire et la quantit√© d'eau de la piscine qui est chauff√©e dans le circuit secondaire.  Donc - pour surveiller l'optimalit√© du chauffage et pour pr√©dire le temps de chauffage. </p><br><div class="spoiler">  <b class="spoiler_title">Emplacements des capteurs sur l'√©changeur de chaleur et les tuyaux d'entr√©e</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/en/vw/mi/envwmicj0l1hc76r23a_uvyjd3w.jpeg"></div></div><br><h2>  Param√®tres de l'appareil </h2><br><p>  Le premier prototype de l'appareil a √©t√© construit sur la base d'Arduino Uno et lanc√© avec succ√®s. </p><br><img src="https://habrastorage.org/webt/ol/xh/rg/olxhrgxw-w4qqnjpzxkuhj7mc7u.png"><br><p>  Mais il est devenu clair que j'aimerais plus.  Chauff√© 16 m√®tres cubes d'eau, m√™me juste <br>  quelques degr√©s n'est pas rapide.  Et je voudrais surveiller directement les param√®tres de chauffage du travail, allumer / √©teindre.  Mais en m√™me temps, il serait int√©ressant de prendre des plans de chauffage, par exemple, par jour. </p><br><p>  Eh bien, puisque nous avons d√©j√† un appareil IoT, alors pourquoi ne contr√¥lons-nous pas en m√™me temps l'activation √† distance du chlorateur de piscine et de la pompe pour cela? </p><br><h2>  Mandat </h2><br><p>  Il a donc √©t√© d√©cid√© de d√©velopper un appareil - un contr√¥leur de piscine multifonctionnel.  Il doit pouvoir: </p><br><ul><li>  Pour contr√¥ler le chauffage de la piscine √† travers l'√©changeur de chaleur, allumer / √©teindre la chaudi√®re √† gaz pour chauffer l'eau. </li><li>  Emp√™cher la surchauffe de l'√©changeur de chaleur en surveillant la pr√©sence d'un d√©bit d'eau de piscine dans le circuit secondaire et une surchauffe du circuit secondaire. <br></li><li>  Affichage des statistiques de chauffage en temps r√©el (temp√©rature √† l'entr√©e et √† la sortie des deux circuits). </li><li>  Enregistrer (enregistrer) les valeurs de temp√©rature dans la m√©moire flash.  Afficher les donn√©es pour <br>  une certaine p√©riode sous forme de graphique. </li><li>  √Ä l'aide d'un relais, pouvoir allumer / √©teindre les pompes de la piscine et le chlorateur. </li><li>  G√©rez tous les param√®tres de l'appareil √† distance via le serveur micro-Web int√©gr√©. </li></ul><br><p>  Il y avait aussi la tentation de visser Blink, MQTT.  Mais √† partir de ces "cloches et sifflets" dans la premi√®re √©tape <br>  Il a √©t√© d√©cid√© de refuser.  Et plus encore, je ne voudrais pas prendre la possibilit√© d'un contr√¥le quelque part vers l'ext√©rieur.  Le serveur Web int√©gr√© √† mes fins est tout √† fait suffisant.  Et la s√©curit√© est assur√©e par le fait que vous ne pouvez acc√©der au r√©seau domestique depuis le monde ext√©rieur que via un VPN. </p><br><h2>  Mat√©riel informatique </h2><br><p>  En tant que contr√¥leur, il a √©t√© d√©cid√© d'utiliser l'ESP8266, bon march√© et populaire.  C'√©tait parfait pour mes besoins, sauf pour une chose: faire correspondre les niveaux de signal des capteurs 5 volts avec la logique du contr√¥leur 3,3 volts.  En principe, les capteurs de Dallas semblent fonctionner √† 3 volts, mais j'ai une ligne assez longue entre le contr√¥leur et les capteurs, environ 7 m√®tres.  Par cons√©quent, il est pr√©f√©rable d'augmenter la tension. </p><br><p>  Il a √©t√© d√©termin√© qu'il est n√©cessaire d'avoir le mat√©riel: </p><br><ul><li>  Contr√¥leur ESP8266 ou son fr√®re a√Æn√© ESP32 (en tant que module <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">DevKit</a> ). <br></li><li>  Alignement des niveaux de signal pour les capteurs. </li><li>  Le r√©gulateur de puissance est une partie de 5 volts du circuit. </li><li>  Module de commande de relais. </li><li>  Horloge RTC + m√©moire flash pour la journalisation. </li><li>  L'√©cran LCD 2 lignes le plus simple pour afficher les valeurs actuelles des capteurs et l'√©tat de l'appareil et du relais. </li><li>  Plusieurs boutons physiques pour contr√¥ler l'√©tat de l'appareil sans acc√®s via le web. </li></ul><br><p>  De nombreux composants de la liste sont vendus comme modules pour Arduino et de nombreux modules sont compatibles avec la logique 3.3v.  Cependant, je ne voulais pas "coincer" tout cela sur la planche √† pain avec des faisceaux de fils, parce que je veux avoir un bel "appareil" soign√©.  Oui, et pour l'argent donn√© aux Chinois pour les modules, vous pouvez compl√®tement dessiner et commander votre carte de circuit imprim√© individuelle, et l'attente de son arriv√©e sera compens√©e par une installation relativement rapide et fiable. </p><br><p>  Encore une fois, je note que c'est ma premi√®re exp√©rience dans les circuits et dans la conception du mat√©riel de ces choses.  J'ai d√ª beaucoup √©tudier.  En effet, dans ma sp√©cialit√©, je suis un peu √† l'√©cart des microcontr√¥leurs.  Mais tout faire "√† genoux" ne permettait pas √† l'esprit de perfectionnisme qui habite en moi. </p><br><h2>  Sch√©ma du circuit </h2><br><p>  Il existe un grand nombre de programmes sur le march√© qui vous permettent de dessiner un circuit et une carte de circuit imprim√©.  Sans exp√©rience dans ce domaine, j'ai imm√©diatement aim√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">EasyEDA</a> - un √©diteur en ligne gratuit qui vous permet de peindre magnifiquement un sch√©ma de circuit, de v√©rifier que rien n'a √©t√© oubli√© et que tous les composants ont des connexions, de dessiner une carte de circuit imprim√©, puis de commander imm√©diatement sa production. </p><br><p>  La premi√®re difficult√© que j'ai rencontr√©e: il existe de nombreuses options pour le contr√¥leur DevKit ESP8266 ou ESP32, certaines diff√®rent par l'emplacement des broches et leur fonction, et certaines m√™me par leur largeur.  Il a √©t√© d√©cid√© de dessiner le circuit de sorte qu'il soit possible de placer DevKit de n'importe quelle largeur et √† n'importe quel emplacement des bornes, et sur les c√¥t√©s de celui-ci - 2 rang√©es de paires de cavaliers, puis le c√¢blage pour connecter les bornes n√©cessaires, par rapport au contr√¥leur sp√©cifiquement achet√©. </p><br><p>  Placer sous le contr√¥leur et 2 rang√©es de cavaliers jumel√©s: JH1 et JH2 dans le sch√©ma: </p><br><img src="https://habrastorage.org/webt/mz/a0/nl/mza0nlxbzvfaqjqcti7vc32ikbe.png"><br><p>  L'emplacement des broches d'entr√©e 5v et de sortie 3.3v de l'alimentation du stabilisateur int√©gr√©, ainsi que de GND, me semblait le m√™me pour diff√©rents DevKit, mais j'ai quand m√™me d√©cid√© de le jouer en toute s√©curit√© et de les faire des cavaliers: JP1, JP2, JP3 dans le diagramme. </p><br><p>  J'ai d√©cid√© de signer les cavaliers en les connectant aux composants du circuit avec des fonctions qu'ils vont probablement remplir. </p><br><div class="spoiler">  <b class="spoiler_title">Et voici √† quoi √ßa ressemble avec le DevKit ESP8266, que j'ai finalement achet√© et install√©</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/cg/3p/b5/cg3pb5pg7clju7haw77dah1udhs.png"></div></div><br><p>  Ici, D1 (GPIO5) et D2 (GPIO4) sont responsables du bus I2C, D5 (GPIO14) pour 1-Wire, D6 (GPIO12) - pour recevoir les impulsions du capteur de d√©bit. </p><br><p>  Sch√©ma du circuit: </p><br><p> <a href=""><img src="https://habrastorage.org/webt/ar/jj/n3/arjjn3bgb-ffz_yjofhjy72q_cq.png"></a> <br>  (image cliquable) </p><br><p>  Malgr√© la pr√©sence √† bord de l'ESP8266 d'un r√©gulateur de puissance int√©gr√© pour 3,3 V, nous avons encore besoin d'avoir 5 volts pour alimenter les capteurs et l'√©cran LCD, et 12 volts pour alimenter le relais.  Il a √©t√© d√©cid√© de rendre la carte d'alimentation 12 volts, et de mettre le r√©gulateur de tension AMS1117-5.0 √† l'entr√©e, donnant les 5 volts souhait√©s √† la sortie. </p><br><p>  Pour faire correspondre les niveaux de signal sur le bus √† 1 fil, j'ai utilis√© un transistor √† effet de champ BSS138 c avec des ¬´tractions¬ª de tension des deux c√¥t√©s. </p><br><img src="https://habrastorage.org/webt/y_/sx/st/y_sxstfcgm3kys4hntq5beb5xby.png"><br><p>  Tr√®s bien sur la correspondance de niveau est √©crit dans l'article <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Correspondance des niveaux logiques des appareils 5V et 3,3V</a> . </p><br><p>  Pour faire correspondre les niveaux de signal du capteur de d√©bit, je viens d'utiliser un diviseur de tension entre les r√©sistances.  Le capteur de d√©bit est simplement un dispositif √† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">collecteur ouvert</a> .  Certains capteurs peuvent d√©j√† avoir une r√©sistance de rappel int√©gr√©e, cela doit √™tre pris en compte: </p><br><img src="https://habrastorage.org/webt/9v/8e/br/9v8ebrvm_bsfzounu3kamf4grc8.png"><br><p>  Le bleu dans le diagramme est une d√©signation sch√©matique de l'ensemble capteur de d√©bit.  √Ä droite du connecteur se trouvent des diviseurs de tension s√©lectionn√©s par moi afin d'avoir un niveau maximum de 3,3 volts en sortie. </p><br><p>  Sur le bus I2C, j'ai accroch√© une horloge en temps r√©el DS3231SN et une m√©moire flash AT24C256C pour stocker les journaux.  La m√©moire flash int√©gr√©e √† l'ESP8266 ne convient pas, car elle a un petit nombre de cycles de r√©√©criture (10 000 contre 1 million pour AT24Cxxx, selon les fiches techniques). </p><br><p>  Le contr√¥le des relais est organis√© sur un tas de puces PCF8574AT et ULN2803A. </p><br><img src="https://habrastorage.org/webt/9v/8e/br/9v8ebrvm_bsfzounu3kamf4grc8.png"><br><p>  La premi√®re puce est un extenseur de port de microcontr√¥leur I2C.  L'√©tat de la sortie ou de l'entr√©e active PCF8574AT est s√©lectionn√© en s√©lectionnant une adresse sur le bus I2C. <br>  La puce poss√®de des fonctionnalit√©s int√©ressantes, bien d√©crites dans l'article d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">extension de port I2C PCF8574</a> . </p><br><p>  La puce ne peut pas contr√¥ler directement la charge (relais).  Pour cela, une matrice de transistor ULN2803A est utilis√©e.  Il y a une caract√©ristique: la matrice peut facilement tirer ses sorties avec une charge au sol, ce qui signifie que si une tension d'alimentation est appliqu√©e au deuxi√®me p√¥le du relais, le courant traversera l'enroulement du relais et les contacts du relais se fermeront.  Malheureusement, avec cette inclusion, nous obtenons un effet secondaire: la valeur du signal du contr√¥leur est invers√©e, et tous les relais "cliquent" lorsque le circuit est allum√©.  Je n'ai pas encore compris comment supprimer cette fonctionnalit√©. </p><br><p>  Plus d'informations sur la puce sont d√©crites <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . </p><br><p>  L'extenseur de port PCF8574AT peut √©galement √™tre utilis√© comme entr√©e: des boutons mat√©riels peuvent √™tre accroch√©s √† certaines entr√©es, lisant leurs valeurs sur le bus I2C.  Dans le diagramme, les broches 4-7 peuvent √™tre utilis√©es pour lire l'√©tat des boutons.  L'essentiel est de ne pas oublier de permettre par programme le serrage int√©gr√© des jambes correspondantes √† la nutrition. </p><br><p>  En m√™me temps, j'ai laiss√© le c√¢blage √† la matrice du transistor, au cas o√π vous voudriez brusquement connecter des relais suppl√©mentaires.  Pour d'√©ventuelles connexions, j'ai apport√© tous les fils aux connecteurs (plus pr√©cis√©ment, aux trous sous eux o√π les fils peuvent √™tre soud√©s ou le connecteur DIP standard de 2,54 mm peut √™tre soud√©). </p><br><p>  La broche de l'extenseur de port INT peut √™tre utilis√©e pour r√©pondre rapidement √† la pression d'un bouton.  Il peut √™tre connect√© √† un port libre sur le contr√¥leur et d√©finir le d√©clencheur d'interruption pour changer l'√©tat de cette broche. </p><br><p>  L'√©cran LCD √† deux lignes est √©galement contr√¥l√© via le module d'extension PCF8574AT.  Le point principal: l'affichage est aliment√© par 5 volts, tandis que l'affichage lui-m√™me est contr√¥l√© par une logique 3 volts.  Soit dit en passant, les adaptateurs Arduino standard pour I2C ne sont pas con√ßus pour la double tension.  J'ai trouv√© l'id√©e d'une telle connexion quelque part sur Internet, malheureusement, j'ai perdu le lien, donc je ne cite pas la source. </p><br><h2>  Circuit imprim√© </h2><br><p>  Lors de la conception de la carte, il s'est av√©r√© que les pi√®ces ordinaires avec pieds prennent trop de place et que de nombreuses puces dans la conception DIP ne sont pas faciles √† trouver.  Apr√®s avoir lu sur Internet que l'installation SMD n'est pas si compliqu√©e, et avec les comp√©tences appropri√©es, elle prend encore moins de temps, j'ai d√©cid√© de concevoir la carte pour les pi√®ces SMD.  Et je ne me suis pas tromp√©.  Il s'est av√©r√© une belle carte m√®re compacte, o√π j'ai facilement plac√© tout ce dont j'ai besoin.  Les pi√®ces SMD, avec un bon fer √† souder, un flux et une soudure, se sont av√©r√©es vraiment tr√®s faciles √† monter. </p><br><p>  Sur la carte, j'ai ajout√© quelques marges carr√©es de trous pour le prototypage, si je veux soudainement souder autre chose. </p><br><p>  J'ai fait un circuit imprim√© mesurant 97x97 mm.  Il s'int√®gre facilement dans une bo√Æte √©lectrique de coupe standard.  De plus, les planches de dimensions inf√©rieures √† 100x100 sont peu co√ªteuses √† fabriquer.  La production d'un lot minimum de 5 planches selon la disposition d√©velopp√©e a co√ªt√© 5 USD, leur livraison au B√©larus a co√ªt√© 9 USD suppl√©mentaires. </p><br><img src="https://habrastorage.org/webt/u9/ov/ou/u9ovouhbfeuadqoixu_je1zjd54.png"><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">La conception de la carte</a> se trouve sur le site Web d'EasyEDA et est accessible √† tous. </p><br><p>  Je note que sur la photo du contr√¥leur ci-dessous appara√Æt le premier √©chantillon de la carte, sur lequel j'ai "tordu" beaucoup de choses inutiles et inutiles (dans l'espoir d'utiliser ce lot minimal de 5 cartes dans d'autres projets).  Ici et sur EasyEDA, j'ai post√© une version ¬´nettoy√©e¬ª de toutes ces choses inutiles. </p><br><img src="https://habrastorage.org/webt/vb/jn/p9/vbjnp97xoyff3jde4oeyh2hkvpg.jpeg"><br><div class="spoiler">  <b class="spoiler_title">Photos des deux c√¥t√©s de la planche</b> <div class="spoiler_text"><p>  Face avant: </p><br><img src="https://habrastorage.org/webt/fs/8_/it/fs8_itdlmt1qredzy8b2h0prk4k.jpeg"><br><p>  Face arri√®re: </p><br><img src="https://habrastorage.org/webt/l8/tc/bo/l8tcboqf53vonco7zla9koydq2s.jpeg"></div></div><br><h2>  Partie logiciel </h2><br>  Pour programmer le microcontr√¥leur, √©tant donn√© l'arri√©r√© sous la forme d'un prototype sur Arduino Uno, il a √©t√© d√©cid√© d'utiliser l'environnement Arduino avec le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">noyau Arduino ESP8266</a> install√©.  Oui, vous pouvez utiliser <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Lua</a> sur l'ESP8266, mais ils disent qu'il y a des blocages.  Compte tenu de la fonction critique exerc√©e, je ne voudrais pas du tout. <br>  L'environnement Arduino lui-m√™me me semble un peu d√©pass√©, mais, heureusement, il existe une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">extension</a> pour Visual Studio de Visual Micro.  L'environnement vous permet d'utiliser des astuces de code IntelliSence, de passer rapidement aux d√©clarations de fonctions, de refactoriser le code: en g√©n√©ral, tout ce que l'environnement des ordinateurs ¬´adultes¬ª se permet d'√™tre.  La version payante de Visual Micro vous permet √©galement de d√©boguer facilement le code, mais je me contentais de l'option gratuite. <br><h2>  Structure du projet </h2><br>  Le projet se compose des fichiers suivants: <br><div class="spoiler">  <b class="spoiler_title">Structure du projet dans Visual Studio</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/4i/dn/hu/4idnhu7toeunqk727_fnhcmpl34.png"></div></div><br><table><tbody><tr><th>  Fichier </th><th>  Rendez-vous </th></tr><tr><td>  WaterpoolManager.ino <br></td><td>  D√©claration des variables et constantes de base.  Initialisation.  Boucle principale. <br></td></tr><tr><td>  HeaterMainLogic.ino <br></td><td>  La logique de base du contr√¥le du relais de la chaudi√®re (en fonction de la temp√©rature) et des relais auxiliaires. <br></td></tr><tr><td>  Sensors.ino <br></td><td>  Lire les donn√©es du capteur <br></td></tr><tr><td>  Settings.ino <br></td><td>  Param√®tres de l'appareil, les enregistrer dans la m√©moire flash du contr√¥leur <br></td></tr><tr><td>  LCD.ino <br></td><td>  Sortie d'informations sur LCD <br></td></tr><tr><td>  ClockTimer.ino <br></td><td>  Lecture d'horloge RTC ou simulation d'horloge <br></td></tr><tr><td>  Relays.ino <br></td><td>  Contr√¥le marche / arr√™t du relais <br></td></tr><tr><td>  ButtonLogic.ino <br></td><td>  Logique de r√©action √† l'√©tat des boutons mat√©riels <br></td></tr><tr><td>  ReadButtonStates.ino <br></td><td>  Lire les √©tats des boutons mat√©riels <br></td></tr><tr><td>  EEPROM_Logging.ino <br></td><td>  Enregistrement des donn√©es du capteur dans l'EEPROM <br></td></tr><tr><td>  WebServer.ino <br></td><td>  Serveur Web int√©gr√© pour la gestion des appareils et l'affichage de l'√©tat <br></td></tr><tr><td>  <b>Pages Web</b> <br></td><td>  Les pages du serveur Web sont stock√©es dans ce dossier. <br></td></tr><tr><td>  index.h <br></td><td>  La page principale pour afficher l'√©tat de l'appareil.  Lecture de l'√©tat actuel avec appel ajax.  Actualisez toutes les 5 secondes. <br></td></tr><tr><td>  loggraph.h <br></td><td>  Affiche un journal des donn√©es des capteurs et des √©tats des relais dans un graphique.  La biblioth√®que jqPlot est utilis√©e - toute la construction a lieu c√¥t√© client.  La demande adress√©e au contr√¥leur ne concerne qu'un fichier binaire - des copies des donn√©es de l'EEPROM. <br></td></tr><tr><td>  logtable.h <br></td><td>  aussi, mais sous forme de tableau <br></td></tr><tr><td>  settings.h <br></td><td>  Gestion des param√®tres de l'appareil: d√©finition des limites de temp√©rature, de d√©bit d'eau, de fr√©quence d'enregistrement des donn√©es <br></td></tr><tr><td>  time.h <br></td><td>  R√©glage de l'heure actuelle <br></td></tr><tr><td><br></td><td>  <b>Biblioth√®ques</b> <br></td></tr><tr><td>  EepromLogger.cpp <br></td><td>  Biblioth√®que de journaux Flash <br></td></tr><tr><td>  EepromLogger.h <br></td></tr><tr><td>  crc8.cpp <br></td><td>  8- CRC   <br></td></tr><tr><td> crc8.h <br></td></tr><tr><td> TimeSpan.cpp <br></td><td>      <br></td></tr><tr><td> TimeSpan.h <br></td></tr></tbody></table><br><h2>   </h2><br><p>          OneWire       tempSensAddr.              .       (    4    ): </p><br><pre><code class="hljs powershell"><span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (ds.search(tempSensAddr[<span class="hljs-type"><span class="hljs-type">lastSensorIndex</span></span>]) &amp;&amp; lastSensorIndex &lt; <span class="hljs-number"><span class="hljs-number">4</span></span>) { Serial.print(<span class="hljs-string"><span class="hljs-string">"ROM ="</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (byte i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">8</span></span>; i++) { Serial.print(<span class="hljs-string"><span class="hljs-string">' '</span></span>); Serial.print(tempSensAddr[<span class="hljs-type"><span class="hljs-type">lastSensorIndex</span></span>][<span class="hljs-type"><span class="hljs-type">i</span></span>], HEX); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (OneWire::crc8(tempSensAddr[<span class="hljs-type"><span class="hljs-type">lastSensorIndex</span></span>], <span class="hljs-number"><span class="hljs-number">7</span></span>) != tempSensAddr[<span class="hljs-type"><span class="hljs-type">lastSensorIndex</span></span>][<span class="hljs-number"><span class="hljs-number">7</span></span>]) { Serial.print(<span class="hljs-string"><span class="hljs-string">" CRC is not valid!"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> lastSensorIndex++; Serial.println(); } ds.reset_search(); lastSensorIndex--; Serial.print(<span class="hljs-string"><span class="hljs-string">"\r\nTemperature sensor count: "</span></span>); Serial.print(lastSensorIndex + <span class="hljs-number"><span class="hljs-number">1</span></span>, DEC);  ,       ().       Serial   LCD  : // Read sensor values and print temperatures ds.reset(); ds.write(<span class="hljs-number"><span class="hljs-number">0</span></span>xCC, TEMP_SENSOR_POWER_MODE); // Request all sensors at the one time ds.write(<span class="hljs-number"><span class="hljs-number">0</span></span>x44, TEMP_SENSOR_POWER_MODE); // Acquire temperatures delay(<span class="hljs-number"><span class="hljs-number">1000</span></span>); // Delay is required by temp. sensors char tempString[<span class="hljs-number"><span class="hljs-number">10</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (byte addr = <span class="hljs-number"><span class="hljs-number">0</span></span>; addr &lt;= lastSensorIndex; addr++) { ds.reset(); ds.select(tempSensAddr[<span class="hljs-type"><span class="hljs-type">addr</span></span>]); ds.write(<span class="hljs-number"><span class="hljs-number">0</span></span>xBE, TEMP_SENSOR_POWER_MODE); // Read Scratchpad tempData[<span class="hljs-type"><span class="hljs-type">addr</span></span>] = ds.read() | (ds.read() &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span>); // Read first <span class="hljs-number"><span class="hljs-number">2</span></span> bytes which carry temperature <span class="hljs-keyword"><span class="hljs-keyword">data</span></span> int tempInCelsius = (tempData[<span class="hljs-type"><span class="hljs-type">addr</span></span>] + <span class="hljs-number"><span class="hljs-number">8</span></span>) &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>; // <span class="hljs-keyword"><span class="hljs-keyword">In</span></span> celsius, with math rounding Serial.print(tempInCelsius, DEC); // Print temperature Serial.println(<span class="hljs-string"><span class="hljs-string">" C"</span></span>); }</code> </pre> <br><p>  Selon la fiche technique, les capteurs n√©cessitent au moins 750 ms de d√©lai entre la demande d'une valeur de temp√©rature et la r√©ception d'une r√©ponse du capteur.  Par cons√©quent, le code a introduit un retard avec une petite marge. </p><br><p>  Cependant, ce d√©lai, lorsque l'ensemble du p√©riph√©rique attend simplement une r√©ponse, est acceptable au d√©but, mais il est absolument inappropri√© d'attendre √† chaque fois avec une interrogation r√©guli√®re des capteurs.  Par cons√©quent, le code d√©licat suivant a √©t√© √©crit, appel√© toutes les 50 ms par minuterie: </p><br><pre> <code class="hljs lua">#define TEMP_MEASURE_PERIOD <span class="hljs-number"><span class="hljs-number">20</span></span> // Time of measuring, * TEMP_TIMER_PERIODICITY ms #define TEMP_TIMER_PERIODICITY <span class="hljs-number"><span class="hljs-number">50</span></span> // Periodicity of timer calling, ms timer.attach_ms(TEMP_TIMER_PERIODICITY, tempReadTimer); int tempMeasureCycleCount = <span class="hljs-number"><span class="hljs-number">0</span></span>; void tempReadTimer() // Called many times <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> second, perform only one small operation per call { tempMeasureCycleCount++; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tempMeasureCycleCount &gt;= TEMP_MEASURE_PERIOD) { tempMeasureCycleCount = <span class="hljs-number"><span class="hljs-number">0</span></span>; // Start cycle again } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tempMeasureCycleCount == <span class="hljs-number"><span class="hljs-number">0</span></span>) { ds.reset(); ds.<span class="hljs-built_in"><span class="hljs-built_in">write</span></span>(<span class="hljs-number"><span class="hljs-number">0xCC</span></span>, TEMP_SENSOR_POWER_MODE); // Request all sensors at the one <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> ds.<span class="hljs-built_in"><span class="hljs-built_in">write</span></span>(<span class="hljs-number"><span class="hljs-number">0x44</span></span>, TEMP_SENSOR_POWER_MODE); // Acquire temperatures } // Between phases above <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> below should be &gt; <span class="hljs-number"><span class="hljs-number">750</span></span> ms int addr = TEMP_MEASURE_PERIOD - tempMeasureCycleCount - <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (addr &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; addr &lt;= lastSensorIndex) { ds.reset(); ds.<span class="hljs-built_in"><span class="hljs-built_in">select</span></span>(tempSensAddr[addr]); ds.<span class="hljs-built_in"><span class="hljs-built_in">write</span></span>(<span class="hljs-number"><span class="hljs-number">0xBE</span></span>, TEMP_SENSOR_POWER_MODE); // Read Scratchpad tempData[addr] = ds.<span class="hljs-built_in"><span class="hljs-built_in">read</span></span>() | (ds.<span class="hljs-built_in"><span class="hljs-built_in">read</span></span>() &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span>); // Read first <span class="hljs-number"><span class="hljs-number">2</span></span> bytes which carry temperature data } }</code> </pre> <br><p>  Au d√©but de chaque cycle tempMeasureCycleCount, les capteurs sont invit√©s √† lire leurs valeurs.  Apr√®s environ 50 cycles de ce type (et au total c'est 50 * 20 = 1000 ms = 1 sec), la valeur de chaque capteur est lue, une √† la fois.  Tout le travail est divis√© en morceaux afin que le code qui s'ex√©cute dans l'interruption du minuteur ne prenne pas beaucoup de temps du contr√¥leur. </p><br><p>  La valeur du capteur de d√©bit est calcul√©e comme suit.  Par interruption sur la broche sur laquelle le capteur est accroch√©, on augmente la valeur du compteur de ticks provenant du capteur de d√©bit: </p><br><pre> <code class="hljs pgsql">pinMode(FLOW_SENSOR_PIN, <span class="hljs-keyword"><span class="hljs-keyword">INPUT</span></span>); attachInterrupt(digitalPinToInterrupt(FLOW_SENSOR_PIN), flow, RISING); // Setup Interrupt <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> <span class="hljs-type"><span class="hljs-type">int</span></span> flow_frequency; // Flow sensor pulses <span class="hljs-type"><span class="hljs-type">int</span></span> flowMeasureCycleCount = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-type"><span class="hljs-type">void</span></span> flow() // Flow sensor interrupt <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> { flow_frequency++; }</code> </pre> <br><p>  Dans le m√™me temporisateur o√π les capteurs de temp√©rature sont interrog√©s, nous prenons une fois par seconde cette valeur de tick et la traduisons en litres en utilisant la constante FLOW_SENSOR_CONST, dont la valeur peut √™tre trouv√©e dans les caract√©ristiques du capteur: </p><br><pre> <code class="hljs pgsql">flowMeasureCycleCount++; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (flowMeasureCycleCount &gt;= <span class="hljs-number"><span class="hljs-number">1000</span></span> / TEMP_TIMER_PERIODICITY) { flowMeasureCycleCount = <span class="hljs-number"><span class="hljs-number">0</span></span>; litersInMinute = (flow_frequency / FLOW_SENSOR_CONST); // Pulse frequency (Hz) = FLOW_SENSOR_CONST*Q, Q <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> flow rate <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> L/min. flow_frequency = <span class="hljs-number"><span class="hljs-number">0</span></span>; // <span class="hljs-keyword"><span class="hljs-keyword">Reset</span></span> Counter }</code> </pre> <br><h2>  Enregistrement des donn√©es des capteurs et de l'√©tat de l'appareil </h2><br><p>  Lors du d√©veloppement du m√©canisme de journalisation, le fait que l'appareil puisse √™tre soudainement √©teint, c'est-√†-dire  √† presque tout moment.  Lorsque vous arr√™tez l'enregistrement, nous devons √™tre en mesure de restaurer tout ce qui a √©t√© enregistr√© au tout dernier moment.  Dans le m√™me temps, nous ne pouvons pas constamment r√©√©crire la m√™me zone de m√©moire flash (par exemple, un certain titre √† un certain endroit, en se souvenant de la derni√®re adresse d'enregistrement), afin d'√©viter un "effacement" acc√©l√©r√© du lecteur flash √† cet endroit. </p><br><p>  Apr√®s un certain ¬´cumul¬ª, le mod√®le d'enregistrement suivant a √©t√© invent√© et mis en ≈ìuvre: </p><br><img src="https://habrastorage.org/webt/ue/zv/vg/uezvvgglwxhvsvn5uhdmkiic8ju.png"><br><p>  Chaque enregistrement est un enregistrement contenant des informations sur la valeur actuelle du d√©bit d'eau, les temp√©ratures des capteurs, ainsi que l'√©tat de l'appareil cod√© dans l'octet (les bits individuels indiquent si le relais est activ√© ou non, si le chauffage est activ√© ou non): </p><br><pre> <code class="hljs cpp"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LogEvent</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> litersInMinute = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> tempCelsius[<span class="hljs-number"><span class="hljs-number">4</span></span>]{ <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> deviceStatus = <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br><p>  Apr√®s chaque enregistrement, il y a un octet de somme de contr√¥le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">CRC</a> , indiquant si l'enregistrement a √©t√© correctement √©crit et en g√©n√©ral, si au moins quelque chose a √©t√© √©crit dans cet emplacement de m√©moire. </p><br><p>  Comme il serait trop co√ªteux d'enregistrer des donn√©es sur l'heure actuelle ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">horodatage</a> ) pour chaque enregistrement en termes de volume, les donn√©es sont organis√©es en grands blocs, avec N enregistrements dans chacun.  L'horodatage de chaque bloc n'est enregistr√© qu'une seule fois, pour le reste - il est calcul√© en fonction des informations sur la fr√©quence de journalisation. </p><br><pre> <code class="hljs vhdl"><span class="hljs-built_in"><span class="hljs-built_in">unsigned</span></span> int logRecordsInBlock = <span class="hljs-number"><span class="hljs-number">60</span></span> * <span class="hljs-number"><span class="hljs-number">60</span></span> / loggingPeriodSeconds; // <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">block</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> hour <span class="hljs-built_in"><span class="hljs-built_in">unsigned</span></span> int block_size = sizeof(Block_Header) + logRecordsInBlock * (record_size + crcSize); <span class="hljs-built_in"><span class="hljs-built_in">unsigned</span></span> int block_count = total_storage_size / block_size;</code> </pre> <br><p>  Par exemple, avec une fr√©quence d'enregistrement d'une fois toutes les 30 secondes, nous aurons 120 entr√©es dans un bloc, et la taille du bloc sera d'environ 840 octets.  Au total, nous pouvons ins√©rer 39 blocs dans la m√©moire d'un lecteur flash de 32 kilo-octets.  Avec une telle organisation, il s'av√®re que chaque bloc commence √† une adresse strictement d√©finie en m√©moire, et ¬´parcourir¬ª tous les blocs n'est pas un probl√®me. </p><br><p>  En cons√©quence, avec une rupture soudaine du record lors du dernier arr√™t de l'appareil, nous aurons un bloc inachev√© (c'est-√†-dire dans lequel certains des enregistrements sont manquants).  Lorsque l'appareil est allum√©, l'algorithme recherche le dernier en-t√™te de bloc valide (horodatage + crc).  Et continue l'enregistrement, en commen√ßant par le bloc suivant.  L'enregistrement s'effectue cycliquement: le dernier bloc √©crase les donn√©es du bloc le plus ancien. </p><br><p>  Lors de la lecture, tous les blocs sont lus s√©quentiellement.  Les blocs non valides (ceux qui ne passent pas le CRC pour l'horodatage) sont enti√®rement ignor√©s.  Les enregistrements de chaque bloc sont lus jusqu'√† la r√©union du premier enregistrement invalide (c'est-√†-dire celui sur lequel l'enregistrement a √©t√© interrompu la derni√®re fois si le bloc n'a pas √©t√© enti√®rement enregistr√©).  Les autres sont ignor√©s. <br>  Pour chaque enregistrement, l'heure actuelle est calcul√©e en fonction de l'horodatage du bloc et du num√©ro de s√©rie de l'enregistrement dans le bloc. </p><br><h2>  LCD </h2><br><p>  L'appareil utilise un √©cran QC1602A, capable d'afficher 2 lignes de 16 caract√®res.  La premi√®re ligne affiche les informations actuelles sur les valeurs actuelles des capteurs: d√©bit et temp√©ratures.  Si la limite sp√©cifi√©e est d√©pass√©e, un point d'exclamation appara√Æt pr√®s de la valeur.  La deuxi√®me ligne indique l'√©tat du relais de chauffage et de la pompe, ainsi que le temps √©coul√© depuis la mise en marche ou l'arr√™t du chauffage.  Toutes les 5 secondes, l'affichage de la deuxi√®me ligne indique bri√®vement les limites actuelles.  Des photos de l'affichage dans diff√©rents modes sont pr√©sent√©es √† la fin de la publication. </p><br><h2>  Graphiques </h2><br><p>  Lorsqu'elles sont demand√©es via le serveur Web int√©gr√©, les donn√©es de journalisation sont lues sous forme binaire √† l'aide de JavaScript: </p><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> xhttp = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XMLHttpRequest(); xhttp.open(<span class="hljs-string"><span class="hljs-string">"GET"</span></span>, <span class="hljs-string"><span class="hljs-string">"logs.bin"</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); xhttp.responseType = <span class="hljs-string"><span class="hljs-string">"arraybuffer"</span></span>; xhttp.onprogress = updateProgress; xhttp.onload = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">oEvent</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> arrayBuffer = xhttp.response; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (arrayBuffer) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> byteArray = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Uint8Array</span></span>(arrayBuffer); ‚Ä¶ }}; xhttp.send(<span class="hljs-literal"><span class="hljs-literal">null</span></span>);</code> </pre> <br><p>  Les lire dans un format non binaire populaire, comme ajax, serait un luxe inadmissible pour le contr√¥leur, principalement en raison de la grande quantit√© que le serveur http int√©gr√© devrait retourner. </p><br><p>  Pour la m√™me raison, la biblioth√®que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">jqPlot</a> JavaScript est utilis√©e pour cr√©er des graphiques et les fichiers de la biblioth√®que JS eux-m√™mes sont charg√©s √† partir de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">CDN</a> populaires. </p><br><p>  Un exemple de la planification de l'appareil: </p><br><img src="https://habrastorage.org/webt/uh/kr/bc/uhkrbccsl1k8l6w_3am6tunwe5a.png"><br><p>  On voit clairement qu'√† environ 9h35 l'appareil √©tait allum√© pour le chauffage, la chaudi√®re a commenc√© √† chauffer progressivement le circuit de chauffage (capteurs T3, T4), apr√®s quoi la temp√©rature du circuit de la piscine a commenc√© √† augmenter (capteurs T1, T2).  Vers 10 h 20, la chaudi√®re est pass√©e au chauffage de l'eau chaude dans la maison, la temp√©rature du circuit de chauffage a baiss√©.  Puis, apr√®s 10 minutes suppl√©mentaires, la chaudi√®re s'est remise √† chauffer l'eau de la piscine.  √Ä 10 h 50, un accident s'est produit: la pompe pour faire circuler l'eau dans la piscine s'est soudainement √©teinte.  Le d√©bit d'eau a fortement chut√© √† z√©ro, le relais de chauffage s'est √©teint (ligne pointill√©e rouge sur le 2√®me graphique), emp√™chant une surchauffe.  Mais l'appareil restait toujours dans un √©tat de chauffe (ligne rouge sur le 2√®me graphique).  C'est-√†-dire  si la pompe √©tait √† nouveau allum√©e et que les temp√©ratures √©taient normales, l'appareil retournerait au chauffage.  Je note qu'apr√®s un arr√™t d'urgence de la pompe, les temp√©ratures dans le circuit d'eau de la piscine (T1, T2) ont commenc√© √† augmenter fortement en raison d'une surchauffe de l'√©changeur de chaleur.  Et sinon pour un arr√™t brutal de la chaudi√®re, il y aurait des ennuis. </p><br><h2>  Serveur Web int√©gr√© </h2><br><p>  Pour communiquer avec le monde ext√©rieur, la classe standard <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ESP8266WebServer est utilis√©e</a> .  Lorsque l'appareil d√©marre, il est initialis√© en tant que point d'acc√®s avec le mot de passe par d√©faut sp√©cifi√© dans #define AP_PASS.  Une page Web s'ouvre automatiquement pour s√©lectionner un r√©seau Wi-Fi disponible et entrer un mot de passe.  Apr√®s avoir entr√© le mot de passe, l'appareil red√©marre et se connecte au point d'acc√®s sp√©cifi√©. </p><br><h2>  Appareil fini </h2><br><p>  Le dispositif fini a √©t√© plac√© dans une bo√Æte de coupe standard pour le c√¢blage.  Un trou pour l'√©cran LCD a √©t√© d√©coup√©, et des trous pour les connecteurs. </p><br><img src="https://habrastorage.org/webt/dz/si/tx/dzsitx4tim2kcxqnticd7ln2vho.jpeg"><br><div class="spoiler">  <b class="spoiler_title">Photos de la fa√ßade de l'appareil dans diff√©rents modes</b> <div class="spoiler_text"><p>  Avec l'affichage du temps √©coul√© apr√®s la mise en marche: </p><br><img src="https://habrastorage.org/webt/fh/gn/fn/fhgnfnf-emu1rl31w7bm4fbmmvs.jpeg"><br><p>  Avec des limites affich√©es: </p><br><img src="https://habrastorage.org/webt/qi/8c/r2/qi8cr2ex8uwr3e9xgzs5ms__vou.jpeg"></div></div><br><h2>  Conclusion </h2><br><p>  En conclusion, je tiens √† dire que, en d√©veloppant un tel appareil, j'ai acquis une grande exp√©rience des circuits, de la conception de circuits imprim√©s, des comp√©tences d'installation pour les composants SMD, dans l'architecture et la programmation des microcontr√¥leurs, je me suis souvenu du C ++ presque oubli√© et de la manipulation soigneuse de la m√©moire et des autres ressources de contr√¥leur limit√©es.  La connaissance de HTML5, JavaScript et les comp√©tences de d√©bogage des scripts dans le navigateur ont √©galement √©t√© utiles dans une certaine mesure. </p><br><p>  Ces comp√©tences et le plaisir re√ßu lors du d√©veloppement de l'appareil sont les principaux avantages obtenus.  Et les codes source de l'appareil, le sch√©ma de circuit, les cartes de circuits imprim√©s - veuillez utiliser, modifier.  Tous les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">codes source du projet</a> sont sur GitHab.  Mat√©riel dans un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">projet public</a> sur EasyEDA.  J'ai collect√© des donn√©es sur les puces utilis√©es dans le projet sur un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">lecteur r√©seau</a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr413955/">https://habr.com/ru/post/fr413955/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr413945/index.html">Plus simple qu'il n'y para√Æt. Chapitres 4-5</a></li>
<li><a href="../fr413947/index.html">Impl√©mentation du travail avec le serveur Long Poll dans le client VKontakte pour Sailfish OS</a></li>
<li><a href="../fr413949/index.html">Pourquoi lisons-nous encore des livres papier?</a></li>
<li><a href="../fr413951/index.html">Apprenez aux autres √† devenir un meilleur programmeur</a></li>
<li><a href="../fr413953/index.html">Quand et pourquoi cela vaut la peine d'utiliser les fonctions fl√©ch√©es ES6, et quand ce n'est pas le cas</a></li>
<li><a href="../fr413957/index.html">Un exemple de cr√©ation d'une application sportive en temps r√©el sur Node.js</a></li>
<li><a href="../fr413959/index.html">Plus petite image Docker - moins de 1 000 octets</a></li>
<li><a href="../fr413963/index.html">Mini CRM pour les petites entreprises</a></li>
<li><a href="../fr413965/index.html">Revue de code: vous vous trompez</a></li>
<li><a href="../fr413967/index.html">R√©tro-ing√©nierie du mode d√©veloppeur Animal Crossing</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>