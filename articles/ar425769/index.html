<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>๐ง๐ผโ๐คโ๐ง๐ป ๐๐ป ๐ ููููุฉ ุชุนููู MySQL ูููุธุฑ ูู ุงููุงุถู ๐จ๐ฟโ๐ผ ๐ธ ๐จ๐ฟโ๐ง</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ุณุชุฑูุฒ ุงูููุงูุฉ ุนูู ุชุณุฌูู ุงูุชุบููุฑุงุช ูู MySQL . ุฃุฑูุฏ ุฃู ุฃุนุฑุถ ุชูููุฐ ุชุณุฌูู ุงูุฏุฎูู ุนูู ุงููุดุบูุงุช ููุง ุงูุฃุดูุงุก ุงููุฏูุดุฉ ุงูุชู ููููู ุงูููุงู ุจูุง. 

 ููุงุฐุง ุนูู ุงููุญ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ููููุฉ ุชุนููู MySQL ูููุธุฑ ูู ุงููุงุถู</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/425769/" style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/x9/bj/aw/x9bjawmhknb_05dfsfvowswt798.jpeg" alt="ููููุฉ ุชุนููู MySQL ูููุธุฑ ูู ุงููุงุถู"><br><br>  ุณุชุฑูุฒ ุงูููุงูุฉ ุนูู ุชุณุฌูู ุงูุชุบููุฑุงุช ูู <b>MySQL</b> .  ุฃุฑูุฏ ุฃู ุฃุนุฑุถ ุชูููุฐ ุชุณุฌูู ุงูุฏุฎูู ุนูู ุงููุดุบูุงุช ููุง ุงูุฃุดูุงุก ุงููุฏูุดุฉ ุงูุชู ููููู ุงูููุงู ุจูุง. <br><br>  ููุงุฐุง ุนูู ุงููุญูุฒุงุชุ  ูุฃูู ูุง ููุฌุฏ ูุตูู ุฅูู ุงูุณุฌู ุงูุซูุงุฆู.  ูู ุงููุญุชูู ุฃู ูููู ุงูุชูููุฐ ุจุงุณุชุฎุฏุงู ุงูุณุฌู ุงูุซูุงุฆู ุฃูุซุฑ ุฅูุชุงุฌูุฉ ุ ุนูู ุงูุฑุบู ูู ุตุนูุจุฉ ุชุทููุฑู ุ ูุฃูู  ูุทููุจ ูุชุญููู ุงูุณุฌู. <br><br>  ุฃุฑูุฏ ุฃู ุฃุญุฐุฑู ุนูู ุงูููุฑ ูู ุฃู ูุฐู ุงูุทุฑููุฉ ุณุชุคุฏู ุฅูู ุชุญููู ุฅุถุงูู ุนูู ุงูุฎุงุฏู.  ูุฅุฐุง ููุช ูุฏ ููุช ุจุชุบููุฑ ุงูุจูุงูุงุช ุจุดูู ูุดุท ุ ููุฏ ูุง ูููู ูุฐุง ุงูุญู ููุงุณุจูุง ูู ุฃู ุณูุชุทูุจ ุจุนุถ ุงูุชุนุฏููุงุช ูุงูุชุญุณููุงุช. <br><br>  ุจุดูู ุนุงู ุ ุงูุญู ูุงูู ููุนูุฏ.  ูููู ุชูููุฐู "ููุง ูู" ูุงูุชุนุงูู ุจุดูู ูุซุงูู ูุน ูููุชู. <br><a name="habracut"></a><br>  ูุชู ุชูููุฐ ูู ุดูุก ุฃุฏูุงู ุนูู <b>MariaDB</b> ุงูุฅุตุฏุงุฑ <b>10.0.32</b> <br>  ูุชู ุชุณุฌูู ุงูุฃุนูุฏุฉ ุจุฃููุงุนูุง: ุฃุฑูุงู ุ ุณูุงุณู ุ ุชูุงุฑูุฎ.  ูุฌุจ ุฃู ูุญุชูู ุงูุฌุฏูู <b>ุงููุณุฌู ุนูู</b> ุญูู <b>ูุนุฑู</b> ุฑููู <b>NOT NULL</b> ูุฑูุฏ. <br><br>  ุฃููุงู ุ ูู ุจุฅูุดุงุก ุฌุฏูู ุจุงุณุชุฎุฏุงู ุชูููู ุงูุชุณุฌูู: <br><br><pre style=";text-align:right;direction:rtl"><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> protocol_config; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> protocol_config ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> auto_increment , command <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">50</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-comment"><span class="hljs-comment">--  , table_name VARCHAR(50) --   , column_name VARCHAR(50) --   , denormalize_column VARCHAR(50) --     protocol , UNIQUE (command, table_name, column_name, denormalize_column) ) DEFAULT CHARSET=utf8 COMMENT=' ';</span></span></code> </pre> <br>  ูุชู ุชุทุจูู ุฌููุน ุงูุฎูุงุฑุงุช ุฃุซูุงุก ุฅูุดุงุก ูุดุบู ููุชุณุฌูู.  ุนูู ุณุจูู ุงููุซุงู  ุนูุฏ ุชุบููุฑ ุงูุฅุนุฏุงุฏุงุช ุ ุชุญุชุงุฌ ุฅูู ุชุฌุฏูุฏ ุงููุดุบูุงุช. <br><br>  ุญูู <b>ุงูุฃูุฑ</b> - ุฎูุงุฑ ุชูููู ุงูุจุฑูุชูููู: <br><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  <b>disable_protocol</b> - ุชุนุทูู ุงูุชุณุฌูู. </li><li style=";text-align:right;direction:rtl">  <b>exclude_table</b> - ูุดูุฑ ุฅูู ุงูุฌุฏูู ุงูุฐู ุณูุชู ุงุณุชุจุนุงุฏู ูู ุงูุชุณุฌูู.  ุจุดูู ุงูุชุฑุงุถู ุ ุชุดุงุฑู ุฌููุน <b>BASE TABLE ENGINE = InnoDB</b> ูู ุงูุชุณุฌูู. <br>  ุนูู ุณุจูู ุงููุซุงู <br>  <b>ุจุฑูุชูููู ุงุณุชุจุนุงุฏ</b> <b><br></b>  <b>ุจุฑูุชูููู ุงุณุชุจุนุงุฏ</b> </li><li style=";text-align:right;direction:rtl">  <b>exclude_column</b> - ูุดูุฑ ุฅูู ุงูุญูู ุงูุฐู ุณูุชู ุงุณุชุจุนุงุฏู ูู ุงูุชุณุฌูู.  ุนูู ุณุจูู ุงููุซุงู ุ ุญูู ุบูุฑ ูููุณู ูุฏุนูู ุงููุดุบูุงุช. <br><br>  ุนูู ุณุจูู ุงููุซุงู <br>  <b>sume_column ูุฌููุน ูุณุชูุฏุงุช</b> </li><li style=";text-align:right;direction:rtl">  <b>denormalize_column</b> - ูุดูุฑ ุฅูู ุงูุนููุฏ ุงูุฐู ูุฌุจ ุฅูุบุงุก ุชุทุจูุนู ุจุดูู ุฅุถุงูู ูู ุงูุจุฑูุชูููู (ุฌุฏูู <b>ุงูุจุฑูุชูููู</b> ).  ุจุดูู ุงูุชุฑุงุถู ุ ูุชู ุชุณุฌูู ุฌููุน ุงูุญููู ูู ุฌุฏูู <b>protocol_pos</b> . <br><br>  ุนูู ุณุจูู ุงููุซุงู <br>  <b>ูุนุฑู ูุณุชูุฏุงุช denormalize_column doc_id</b> <br>  ูู ุฌุฏูู <b>ุงููุณุชูุฏุงุช</b> ุ ุณูุชู ุชุณุฌูู ุญูู <b>ุงููุนุฑู</b> ูู ุฌุฏูู <b>ุงูุจุฑูุชูููู</b> ูู ุนููุฏ <b>doc_id</b> .  ูุฌุจ <b>ุฅูุดุงุก</b> ุญูู <b>doc_id</b> ูู ุฌุฏูู <b>ุงูุจุฑูุชูููู</b> ูุฏูููุง. <br>  <b>denormalize_column doc_pos doc_id doc_id</b> <br>  ุณูุชู ุชุณุฌูู ุญูู <b>doc_id</b> ูู ุฌุฏูู <b>doc_pos</b> ุฅูู ุฌุฏูู <b>ุงูุจุฑูุชูููู</b> ูู ุนููุฏ <b>doc_id</b> . </li></ol><br>  ุฌุฏูู ุงูุจุฑูุชูููู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> protocol_pos; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> protocol; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> protocol ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> auto_increment , <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIMESTAMP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CURRENT_TIMESTAMP</span></span> <span class="hljs-comment"><span class="hljs-comment">--    , oper VARCHAR(1) NOT NULL --  I, U, D , table_name VARCHAR(50) NOT NULL --   , table_id BIGINT NOT NULL --   id    , username VARCHAR(50) NOT NULL --      , ip varchar(45) -- IP   , user_agent varchar(256) --  , KEY (table_name, date) ) DEFAULT CHARSET=utf8 COMMENT=' ';</span></span></code> </pre><br>  ุฌุฏูู Protocol_pos: <br><br><pre style=";text-align:right;direction:rtl"> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> protocol_pos; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> protocol_pos ( prot_id <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-comment"><span class="hljs-comment">--   protocol.id , column_name VARCHAR(50) NOT NULL --      , old_val VARCHAR(2000) --    , new_val VARCHAR(2000) --    , PRIMARY KEY (prot_id, column_name) , FOREIGN KEY (prot_id) REFERENCES protocol(id) ) DEFAULT CHARSET=utf8 COMMENT='  ';</span></span></code> </pre><br>  ูู ุฌุฏูู <b>ุงูุจุฑูุชูููู</b> ุ ููุชุฒู ุจุงูุนูููุฉ ุ ููู ุฌุฏูู <b>Protocol_pos</b> ูุฏุฎู ุงูุญููู ุงููุชุบูุฑุฉ. <br><br>  ุงูุขู ุฏุนูุง ูุฃุฎุฐ ูููุฏ ุงูุฒูุงุฏ ูู ููุงูุชู ุงูุณุงุจูุฉ <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">"ุชูููุฐ ููุทู ุงูุฃุนูุงู ูู MySQL"</a></b> ูุฃุณุงุณ ูููุชุจ ูููุฏูุง ููุชุณุฌูู ุจูุงุกู ุนููู. <br><br>  <b>ุชุจุญุซ</b> ูุธููุฉ <b>ุฅูุดุงุก</b> ูุดุบูู ููุทู ุงูุฃุนูุงู <b>gen_bl_trigger</b> ูู ูุฌูุฏ ุงูุฅุฌุฑุงุก <b>&lt;ุงุณู ุงูุฌุฏูู&gt; _trg_proc</b> <br><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">gen_bl_trigger</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="sql hljs">DELIMITER $ <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> gen_bl_trigger$ <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> gen_bl_trigger(table_name <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">200</span></span>), trigger_time <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">200</span></span>), trigger_type <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">200</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> f_proc <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> group_concat_max_len = <span class="hljs-number"><span class="hljs-number">9000000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> f_proc := (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> INFORMATION_SCHEMA.ROUTINES <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> ROUTINE_NAME = <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(table_name, <span class="hljs-string"><span class="hljs-string">'_trg_proc'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ROUTINE_TYPE = <span class="hljs-string"><span class="hljs-string">'PROCEDURE'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ROUTINE_SCHEMA = <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span>() ); IF IFNULL(f_proc, 0) = 0 THEN RETURN ''; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> := <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-string"><span class="hljs-string">'\nbl_proc: BEGIN IF @disable_'</span></span>, table_name, <span class="hljs-string"><span class="hljs-string">'_bl_trg = 1 OR @disable_all_bl_trg = 1 THEN LEAVE bl_proc; END IF;'</span></span>); IF trigger_time = 'BEFORE' THEN <span class="hljs-comment"><span class="hljs-comment">--    SET text := CONCAT(text, '\nCREATE TEMPORARY TABLE '); --        INSERT INTO ... ON DUPLICATE KEY UPDATE   IF NOT EXISTS --  INSERT IGNORE   AFTER TRIGGER,    IF trigger_type IN ('INSERT', 'UPDATE') THEN SET text := CONCAT(text, 'IF NOT EXISTS '); END IF; SET text := CONCAT(text, table_name, '_tmp_trg ('); SET text := CONCAT(text, '\ntime VARCHAR(1)'); SET text := CONCAT(text, '\n, type VARCHAR(1)'); SET text := CONCAT(text, '\n, col_changed VARCHAR(1000)'); SET text := CONCAT(text, (SELECT GROUP_CONCAT('\n, new_', COLUMN_NAME, ' ', COLUMN_TYPE , '\n, old_', COLUMN_NAME, ' ', COLUMN_TYPE SEPARATOR '') text FROM INFORMATION_SCHEMA.COLUMNS C WHERE C.TABLE_NAME = table_name AND C.TABLE_SCHEMA = DATABASE() AND C.COLUMN_TYPE != 'text' )); SET text := CONCAT(text, ') ENGINE=MEMORY;'); --   SET text := CONCAT(text, (SELECT GROUP_CONCAT('\nSET @new_', COLUMN_NAME, ' := ' , IF(trigger_type = 'DELETE', 'NULL', CONCAT('NEW.', COLUMN_NAME)), ';' , '\nSET @old_', COLUMN_NAME, ' := ' , IF(trigger_type = 'INSERT', 'NULL', CONCAT('OLD.', COLUMN_NAME)), ';' SEPARATOR '') text FROM INFORMATION_SCHEMA.COLUMNS C WHERE C.TABLE_NAME = table_name AND C.TABLE_SCHEMA = DATABASE() AND C.COLUMN_TYPE != 'text' )); END IF; SET text := CONCAT(text, '\nINSERT INTO ', table_name, '_tmp_trg VALUES ("', SUBSTR(trigger_time, 1, 1), '", "', SUBSTR(trigger_type, 1, 1), '", '); --  col_changed  UPDATE IF trigger_type = 'UPDATE' THEN SET text := CONCAT(text, 'CONCAT(' , (SELECT GROUP_CONCAT(CONCAT('IF(IFNULL(NEW.' , COLUMN_NAME, ', "-") != IFNULL(OLD.', COLUMN_NAME, ', "-"), "|', COLUMN_NAME, '|", "")' ) SEPARATOR ', ') text FROM INFORMATION_SCHEMA.COLUMNS C WHERE C.TABLE_NAME = table_name AND C.TABLE_SCHEMA = DATABASE() AND C.COLUMN_TYPE != 'text' ) , '), '); ELSE SET text := CONCAT(text, 'NULL, '); END IF; --   SET text := CONCAT(text, (SELECT GROUP_CONCAT( CASE WHEN trigger_time = 'BEFORE' THEN CONCAT('@new_', COLUMN_NAME) WHEN trigger_type = 'DELETE' THEN 'NULL' ELSE CONCAT('NEW.', COLUMN_NAME) END , ', ' , CASE WHEN trigger_time = 'BEFORE' THEN CONCAT('@old_', COLUMN_NAME) WHEN trigger_type = 'INSERT' THEN 'NULL' ELSE CONCAT('OLD.', COLUMN_NAME) END SEPARATOR ', ') text FROM INFORMATION_SCHEMA.COLUMNS C WHERE C.TABLE_NAME = table_name AND C.TABLE_SCHEMA = DATABASE() AND C.COLUMN_TYPE != 'text' )); SET text := CONCAT(text, ');'); SET text := CONCAT(text, '\nCALL ', table_name, '_trg_proc;'); IF trigger_time = 'BEFORE' THEN SET text := CONCAT(text , IF(trigger_type = 'DELETE' , '' , (SELECT CONCAT('\nSELECT ' , GROUP_CONCAT('new_', COLUMN_NAME SEPARATOR ', ') , '\nINTO ', GROUP_CONCAT('@new_', COLUMN_NAME SEPARATOR ', ') , '\nFROM ', table_name, '_tmp_trg;' , GROUP_CONCAT('\nSET NEW.', COLUMN_NAME, ' := @new_', COLUMN_NAME, ';' SEPARATOR '') ) text FROM INFORMATION_SCHEMA.COLUMNS C WHERE C.TABLE_NAME = table_name AND C.TABLE_SCHEMA = DATABASE() AND C.COLUMN_TYPE != 'text' ) ) ); SET text := CONCAT(text, '\nDELETE FROM ', table_name, '_tmp_trg;'); ELSE SET text := CONCAT(text, '\nDROP TEMPORARY TABLE ', table_name, '_tmp_trg;'); END IF; SET text := CONCAT(text, '\nEND;'); RETURN text; END$</span></span></code> </pre><br></div></div><br>  ูุธููุฉ <b>ุฅูุดุงุก ูุดุบู</b> ุงูุชุณุฌูู <b>gen_prot_trigger</b> : <br><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">gen_prot_trigger</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="sql hljs">DELIMITER $ <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> gen_prot_trigger$ <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> gen_prot_trigger(table_name <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">200</span></span>), trigger_time <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">200</span></span>), trigger_type <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">200</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> denormalize_columns <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> denormalize_values <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> f_exclude_table <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> group_concat_max_len = <span class="hljs-number"><span class="hljs-number">9000000</span></span>; <span class="hljs-comment"><span class="hljs-comment">--       ,     id    SET f_exclude_table := ( SELECT CASE WHEN pd.id IS NOT NULL THEN 1 WHEN pc.id IS NOT NULL THEN 1 WHEN C.COLUMN_NAME IS NULL THEN 1 END FROM (SELECT NULL FROM dual) d LEFT JOIN protocol_config pd ON pd.command = 'disable_protocol' LEFT JOIN protocol_config pc ON pc.command = 'exclude_table' AND pc.table_name = table_name LEFT JOIN INFORMATION_SCHEMA.COLUMNS C ON C.TABLE_SCHEMA = DATABASE() AND C.TABLE_NAME = table_name AND C.COLUMN_NAME = 'id' ); IF trigger_time = 'BEFORE' OR f_exclude_table = 1 OR table_name IN ('protocol', 'protocol_pos') THEN RETURN ''; END IF; SET text := CONCAT('\nprot_proc: BEGIN DECLARE prot_id INT; IF @disable_', table_name, '_prot_trg = 1 OR @disable_all_prot_trg = 1 THEN LEAVE prot_proc; END IF;'); --     1 ,     IF trigger_type = 'UPDATE' THEN SET text := CONCAT(text , '\nIF ' , (SELECT GROUP_CONCAT('IFNULL(NEW.' , C.COLUMN_NAME, ', "-") = IFNULL(OLD.', C.COLUMN_NAME, ', "-")' SEPARATOR ' AND ' ) text FROM INFORMATION_SCHEMA.COLUMNS C LEFT JOIN protocol_config ec ON ec.command = 'exclude_column' AND ec.table_name = C.TABLE_NAME AND ec.column_name = C.COLUMN_NAME WHERE C.TABLE_NAME = table_name AND C.TABLE_SCHEMA = DATABASE() AND C.COLUMN_TYPE != 'text' AND ec.id IS NULL) , ' THEN LEAVE prot_proc; END IF;' ); END IF; --     protocol SELECT IFNULL(GROUP_CONCAT(', ', dc.denormalize_column ORDER BY dc.id SEPARATOR ''), '') denormalize_columns , IFNULL(GROUP_CONCAT(', ' , CASE trigger_type WHEN 'DELETE' THEN 'OLD' ELSE 'NEW' END , dc.column_name ORDER BY dc.id SEPARATOR ', ' ) , '') denormalize_values INTO denormalize_columns, denormalize_values FROM INFORMATION_SCHEMA.COLUMNS C INNER JOIN protocol_config dc ON dc.command = 'denormalize_column' AND dc.table_name = C.TABLE_NAME AND dc.column_name = C.COLUMN_NAME WHERE C.TABLE_NAME = table_name AND C.TABLE_SCHEMA = DATABASE() ; --     SET text := CONCAT(text, '\nINSERT INTO protocol (username, oper, table_name, table_id, ip, user_agent' , denormalize_columns, ') SELECT IFNULL(u.email, USER()) username, "', SUBSTR(trigger_type, 1, 1), '", "', table_name, '"' , ', ', CASE trigger_type WHEN 'DELETE' THEN 'OLD' ELSE 'NEW' END, '.id' , ', au.ip, au.user_agent' , denormalize_values, ' FROM (SELECT NULL FROM dual) d LEFT JOIN auth_users au ON au.conn_id = CONNECTION_ID() LEFT JOIN users u ON u.id = au.user_id; SET prot_id := LAST_INSERT_ID();'); --         SET text := CONCAT(text , '\nINSERT INTO protocol_pos (prot_id, column_name, ' , CASE trigger_type WHEN 'INSERT' THEN 'new_val' WHEN 'UPDATE' THEN 'old_val, new_val' WHEN 'DELETE' THEN 'old_val' END , ')\n' , (SELECT GROUP_CONCAT('SELECT prot_id, "', C.COLUMN_NAME, '", ' , CASE WHEN trigger_type = 'UPDATE' THEN CONCAT('OLD.', C.COLUMN_NAME, ', NEW.', C.COLUMN_NAME, ' FROM dual WHERE IFNULL(NEW.', C.COLUMN_NAME, ', "-") != IFNULL(OLD.', C.COLUMN_NAME, ', "-")') WHEN trigger_type = 'INSERT' THEN CONCAT('NEW.', C.COLUMN_NAME) WHEN trigger_type = 'DELETE' THEN CONCAT('OLD.', C.COLUMN_NAME) END SEPARATOR '\nUNION ALL ' ) text FROM INFORMATION_SCHEMA.COLUMNS C LEFT JOIN protocol_config ec ON ec.command = 'exclude_column' AND ec.table_name = C.TABLE_NAME AND ec.column_name = C.COLUMN_NAME WHERE C.TABLE_NAME = table_name AND C.TABLE_SCHEMA = DATABASE() AND C.COLUMN_TYPE != 'text' AND ec.id IS NULL ) , ';\nEND;' ); RETURN text; END$</span></span></code> </pre><br></div></div><br>  ุฏุงูุฉ <b>Generate_trigger</b> - ููุทู ุงูุฃุนูุงู + ุงูุชุณุฌูู: <br><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ุชููุฏ ุงูุฒูุงุฏ</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="sql hljs">DELIMITER $ <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> generate_trigger$ <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> generate_trigger(table_name <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">200</span></span>), trigger_time <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">200</span></span>), trigger_type <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">200</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> bl_text <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> prot_text <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> trigger_time_short <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">3</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> trigger_type_short <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">3</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> group_concat_max_len = <span class="hljs-number"><span class="hljs-number">9000000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> trigger_time_short := <span class="hljs-keyword"><span class="hljs-keyword">LOWER</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">SUBSTR</span></span>(trigger_time, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> trigger_type_short := <span class="hljs-keyword"><span class="hljs-keyword">LOWER</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">SUBSTR</span></span>(trigger_type, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> := <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> := <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, <span class="hljs-string"><span class="hljs-string">'DROP TRIGGER IF EXISTS '</span></span>, table_name, <span class="hljs-string"><span class="hljs-string">'_'</span></span>, trigger_time_short, <span class="hljs-string"><span class="hljs-string">'_'</span></span>, trigger_type_short, <span class="hljs-string"><span class="hljs-string">'_trg$'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> bl_text := gen_bl_trigger(table_name, trigger_time, trigger_type); <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> prot_text := gen_prot_trigger(table_name, trigger_time, trigger_type); IF bl_text = '' AND prot_text = '' THEN RETURN text; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> := <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, <span class="hljs-string"><span class="hljs-string">'\nCREATE TRIGGER '</span></span>, table_name, <span class="hljs-string"><span class="hljs-string">'_'</span></span>, trigger_time_short, <span class="hljs-string"><span class="hljs-string">'_'</span></span>, trigger_type_short, <span class="hljs-string"><span class="hljs-string">'_trg '</span></span>, trigger_time, <span class="hljs-string"><span class="hljs-string">' '</span></span>, trigger_type, <span class="hljs-string"><span class="hljs-string">' ON '</span></span>, table_name,<span class="hljs-string"><span class="hljs-string">' FOR EACH ROW trg_proc:BEGIN IF @disable_'</span></span>, table_name, <span class="hljs-string"><span class="hljs-string">'_trg = 1 OR @disable_all_trg = 1 THEN LEAVE trg_proc; END IF;'</span></span> , bl_text , prot_text , <span class="hljs-string"><span class="hljs-string">'\nEND$\n'</span></span> ); RETURN text; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>$</code> </pre><br></div></div><br>  ูุธููุฉ gener_triggers ูุชูููุฏ ูุต ูู ุงููุดุบูุงุช ุนูู ุงูุฌุฏูู: <br><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ูููุฏุงุช</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="sql hljs">DELIMITER $ <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> generate_triggers$ <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> generate_triggers(p_table_name <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">200</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> table_name <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">200</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> group_concat_max_len = <span class="hljs-number"><span class="hljs-number">9000000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> table_name := p_table_name; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> := <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> := (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GROUP_CONCAT</span></span>(generate_trigger(table_name, trigger_time, trigger_type) SEPARATOR <span class="hljs-string"><span class="hljs-string">'\n'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'BEFORE'</span></span> trigger_time <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'AFTER'</span></span> trigger_time) trigger_time , (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'INSERT'</span></span> trigger_type <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'UPDATE'</span></span> trigger_type <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'DELETE'</span></span> trigger_type ) trigger_type); RETURN text; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>$</code> </pre><br></div></div><br>  ูุชู ูุตู ุงูุชูููุถ ูู ุงูููุงูุฉ <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">"ุชุทุจูู ุฃูุงู ูุณุชูู ุงูุตู ุนูู MySQL"</a></b> <br><br><pre style=";text-align:right;direction:rtl"> <code class="sql hljs">DELIMITER ; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">users</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`users`</span></span> ( <span class="hljs-string"><span class="hljs-string">`id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> AUTO_INCREMENT, <span class="hljs-string"><span class="hljs-string">`email`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`pass`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">`id`</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">UNIQUE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> <span class="hljs-string"><span class="hljs-string">`email`</span></span> (<span class="hljs-string"><span class="hljs-string">`email`</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHARSET</span></span>=utf8 <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span>=<span class="hljs-string"><span class="hljs-string">' '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> auth_users; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`auth_users`</span></span> ( <span class="hljs-string"><span class="hljs-string">`conn_id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`user_id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`login_time`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">timestamp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CURRENT_TIMESTAMP</span></span>, <span class="hljs-string"><span class="hljs-string">`ip`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">45</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`user_agent`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">256</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">`conn_id`</span></span>) <span class="hljs-comment"><span class="hljs-comment">-- , FOREIGN KEY (user_id) REFERENCES users(id) ) ENGINE=MEMORY DEFAULT CHARSET=utf8 COMMENT=' ';</span></span></code> </pre><br>  ุงูุขู ูู ุจุฅูุดุงุก ุงุซููู ูู ุฃููุงุท ุงูุงุฎุชุจุงุฑ: <br><br><pre style=";text-align:right;direction:rtl"> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> doc_pos; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> docs; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`docs`</span></span> ( <span class="hljs-string"><span class="hljs-string">`id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> AUTO_INCREMENT, <span class="hljs-string"><span class="hljs-string">`num`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`date`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">DATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`warehouse`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`partner`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">`id`</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHARSET</span></span>=utf8 <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span>=<span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> doc_pos; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`doc_pos`</span></span> ( <span class="hljs-string"><span class="hljs-string">`id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> AUTO_INCREMENT, <span class="hljs-string"><span class="hljs-string">`doc_id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`material`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`amount`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`price`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">`id`</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (doc_id) <span class="hljs-keyword"><span class="hljs-keyword">REFERENCES</span></span> docs(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHARSET</span></span>=utf8 <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span>=<span class="hljs-string"><span class="hljs-string">' '</span></span>;</code> </pre><br>  ุฏุนูุง ูููุฐ ุทูุจูุง ููุชุญูู ูู ุตุญุฉ ุงููุดุบูุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช: <br><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ุทูุจ ููุชุญูู ูู ุตุญุฉ ุงููุดุบูุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> table_name, <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>, rows_cn, data_len_mb , <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(need_bl_trg) need_bl_trg , <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(exclude_prot) exclude_prot , <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> action_statement != gen_trg <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-string"><span class="hljs-string">'SELECT generate_triggers("'</span></span>, table_name, <span class="hljs-string"><span class="hljs-string">'")'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> gen_trg <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> (exclude_prot <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> need_bl_trg = <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-string"><span class="hljs-string">'SELECT generate_triggers("'</span></span>, table_name, <span class="hljs-string"><span class="hljs-string">'")'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> ) create_trg <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> table_name, <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>, rows_cn, data_len_mb, need_bl_trg, exclude_prot, action_statement, gen_trg <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> table_name, <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>, rows_cn, data_len_mb, need_bl_trg, exclude_prot , <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(SUBSTRING_INDEX(gen_trg, <span class="hljs-string"><span class="hljs-string">'\n'</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>), <span class="hljs-string"><span class="hljs-string">'\n'</span></span>, action_statement, <span class="hljs-string"><span class="hljs-string">'$'</span></span>, <span class="hljs-string"><span class="hljs-string">'\n'</span></span>) action_statement , gen_trg <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> t.TABLE_NAME table_name , t.TABLE_COMMENT <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span> , t.TABLE_ROWS rows_cn , <span class="hljs-keyword"><span class="hljs-keyword">ROUND</span></span>(t.DATA_LENGTH / <span class="hljs-number"><span class="hljs-number">1024</span></span> / <span class="hljs-number"><span class="hljs-number">1024</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>) data_len_mb , <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> r.ROUTINE_NAME <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> need_bl_trg , <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> pd.id <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> pc.id <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> t.TABLE_NAME <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-string"><span class="hljs-string">'protocol'</span></span>, <span class="hljs-string"><span class="hljs-string">'protocol_pos'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> C.COLUMN_NAME <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'  id'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> exclude_prot , tr.ACTION_STATEMENT action_statement , generate_trigger(tr.EVENT_OBJECT_TABLE, tr.ACTION_TIMING, tr.EVENT_MANIPULATION) gen_trg <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> INFORMATION_SCHEMA.TABLES t <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> INFORMATION_SCHEMA.ROUTINES r <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> r.ROUTINE_NAME = <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(t.TABLE_NAME, <span class="hljs-string"><span class="hljs-string">'_trg_proc'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> r.ROUTINE_TYPE = <span class="hljs-string"><span class="hljs-string">'PROCEDURE'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> r.ROUTINE_SCHEMA = t.TABLE_SCHEMA <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> protocol_config pd <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> pd.command = <span class="hljs-string"><span class="hljs-string">'disable_protocol'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> protocol_config pc <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> pc.command = <span class="hljs-string"><span class="hljs-string">'exclude_table'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> pc.table_name = t.TABLE_NAME <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> INFORMATION_SCHEMA.COLUMNS C <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> C.TABLE_SCHEMA = t.TABLE_SCHEMA <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> C.TABLE_NAME = t.TABLE_NAME <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> C.COLUMN_NAME = <span class="hljs-string"><span class="hljs-string">'id'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> INFORMATION_SCHEMA.TRIGGERS tr <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> tr.TRIGGER_SCHEMA = t.TABLE_SCHEMA <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> tr.EVENT_OBJECT_TABLE = t.TABLE_NAME <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> t.TABLE_SCHEMA = <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t.TABLE_TYPE = <span class="hljs-string"><span class="hljs-string">'BASE TABLE'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t.ENGINE = <span class="hljs-string"><span class="hljs-string">'InnoDB'</span></span> ) d) d) d <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> table_name, <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>, rows_cn, data_len_mb <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> table_name ;</code> </pre><br></div></div><br><pre style=";text-align:right;direction:rtl"> + --------------- + -------------------------- + ------ - + ----------- + ----------- + ------------------ + ----- -------------------------------------- +
 | table_name | ุชุนููู | rows_cn | data_len_mb | need_bl_trg | exclude_prot | create_trg |
 + --------------- + -------------------------- + ------ - + ----------- + ----------- + ------------------ + ----- -------------------------------------- +
 | ูุณุชูุฏุงุช | ูุณุชูุฏุงุช |  0 |  0.02 |  NULL | NULL | SELECT ุชูููุฏ_ุงููุณุจุจุงุช ("ูุณุชูุฏุงุช") |
 | doc_pos | ููุงุถุน ุงููุณุชูุฏุงุช |  0 |  0.02 |  NULL | NULL | SELECT ุชูููุฏ_ุงููุณุจุจุงุช ("doc_pos") |
 | ุจุฑูุชูููู | ุจุฑูุชูููู ุงูุชุบููุฑุงุช |  0 |  0.02 |  NULL | ุบูุฑ ูุณุฌู | NULL |
 | protocol_config | ุชูููู ุงูุชุณุฌูู |  0 |  0.02 |  NULL | NULL | SELECT ุชูููุฏ_ุงููุณุจุจุงุช ("protocol_config") |
 | protocol_pos | ุชุบููุฑ ุญููู ุงูุจุฑูุชูููู |  0 |  0.02 |  NULL | ุบูุฑ ูุณุฌู | NULL |
 | ุงููุณุชุฎุฏููู | ูุณุชุฎุฏูู ุงููุธุงู |  0 |  0.02 |  NULL | NULL | SELECT ุชูููุฏ_ุงููุณุจุจุงุช ("ุงููุณุชุฎุฏููู") |
 + --------------- + -------------------------- + ------ - + ----------- + ----------- + ------------------ + ----- -------------------------------------- +
</pre><br>  ููุฏู ููุง ุงููุธุงู ุฅูุดุงุก ูุดุบูุงุช ุชุณุฌูู ุนูู <b>ุฌุฏุงูู ุงููุณุชูุฏุงุช ุ doc_pos ุ protocol_config ูุงููุณุชุฎุฏููู</b> <br><br>  ูู ุจูู ุงูุงุณุชุนูุงู ุงูุณุงุจู ุจุงุณุชุฎุฏุงู SELECT ูููุฐ ูุฑุฉ ุฃุฎุฑู: <br><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ุทูุจ ููุชุญูู ูู ุตุญุฉ ุงููุดุบูุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GROUP_CONCAT</span></span>(create_trg SEPARATOR <span class="hljs-string"><span class="hljs-string">'\nUNION ALL '</span></span>) sql_text <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> table_name, <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>, rows_cn, data_len_mb , <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(need_bl_trg) need_bl_trg , <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(exclude_prot) exclude_prot , <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> action_statement != gen_trg <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-string"><span class="hljs-string">'SELECT generate_triggers("'</span></span>, table_name, <span class="hljs-string"><span class="hljs-string">'")'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> gen_trg <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> (exclude_prot <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> need_bl_trg = <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-string"><span class="hljs-string">'SELECT generate_triggers("'</span></span>, table_name, <span class="hljs-string"><span class="hljs-string">'")'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> ) create_trg <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> table_name, <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>, rows_cn, data_len_mb, need_bl_trg, exclude_prot, action_statement, gen_trg <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> table_name, <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>, rows_cn, data_len_mb, need_bl_trg, exclude_prot , <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(SUBSTRING_INDEX(gen_trg, <span class="hljs-string"><span class="hljs-string">'\n'</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>), <span class="hljs-string"><span class="hljs-string">'\n'</span></span>, action_statement, <span class="hljs-string"><span class="hljs-string">'$'</span></span>, <span class="hljs-string"><span class="hljs-string">'\n'</span></span>) action_statement , gen_trg <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> t.TABLE_NAME table_name , t.TABLE_COMMENT <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span> , t.TABLE_ROWS rows_cn , <span class="hljs-keyword"><span class="hljs-keyword">ROUND</span></span>(t.DATA_LENGTH / <span class="hljs-number"><span class="hljs-number">1024</span></span> / <span class="hljs-number"><span class="hljs-number">1024</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>) data_len_mb , <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> r.ROUTINE_NAME <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> need_bl_trg , <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> pd.id <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> pc.id <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> t.TABLE_NAME <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-string"><span class="hljs-string">'protocol'</span></span>, <span class="hljs-string"><span class="hljs-string">'protocol_pos'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> C.COLUMN_NAME <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'  id'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> exclude_prot , tr.ACTION_STATEMENT action_statement , generate_trigger(tr.EVENT_OBJECT_TABLE, tr.ACTION_TIMING, tr.EVENT_MANIPULATION) gen_trg <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> INFORMATION_SCHEMA.TABLES t <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> INFORMATION_SCHEMA.ROUTINES r <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> r.ROUTINE_NAME = <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(t.TABLE_NAME, <span class="hljs-string"><span class="hljs-string">'_trg_proc'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> r.ROUTINE_TYPE = <span class="hljs-string"><span class="hljs-string">'PROCEDURE'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> r.ROUTINE_SCHEMA = t.TABLE_SCHEMA <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> protocol_config pd <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> pd.command = <span class="hljs-string"><span class="hljs-string">'disable_protocol'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> protocol_config pc <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> pc.command = <span class="hljs-string"><span class="hljs-string">'exclude_table'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> pc.table_name = t.TABLE_NAME <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> INFORMATION_SCHEMA.COLUMNS C <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> C.TABLE_SCHEMA = t.TABLE_SCHEMA <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> C.TABLE_NAME = t.TABLE_NAME <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> C.COLUMN_NAME = <span class="hljs-string"><span class="hljs-string">'id'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> INFORMATION_SCHEMA.TRIGGERS tr <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> tr.TRIGGER_SCHEMA = t.TABLE_SCHEMA <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> tr.EVENT_OBJECT_TABLE = t.TABLE_NAME <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> t.TABLE_SCHEMA = <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t.TABLE_TYPE = <span class="hljs-string"><span class="hljs-string">'BASE TABLE'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t.ENGINE = <span class="hljs-string"><span class="hljs-string">'InnoDB'</span></span> ) d) d) d <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> table_name, <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>, rows_cn, data_len_mb <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> table_name ) d ;</code> </pre></div></div><br>  ุงููุชูุฌุฉ: <br><pre style=";text-align:right;direction:rtl"> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> generate_triggers(<span class="hljs-string"><span class="hljs-string">"docs"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> generate_triggers(<span class="hljs-string"><span class="hljs-string">"doc_pos"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> generate_triggers(<span class="hljs-string"><span class="hljs-string">"protocol_config"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> generate_triggers(<span class="hljs-string"><span class="hljs-string">"users"</span></span>) ;</code> </pre><br>  ุฏุนูุง ูููุฐ ูุฐุง ุงูุทูุจ ุงูุขู: <br><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">SELECT gener_triggers (ูุณุชูุฏุงุช) SELECT ALL SELECT ....</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> docs_bef_ins_trg$ <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> docs_aft_ins_trg$ <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> docs_aft_ins_trg <span class="hljs-keyword"><span class="hljs-keyword">AFTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> docs <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EACH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROW</span></span> trg_proc:<span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @disable_docs_trg = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> @disable_all_trg = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> LEAVE trg_proc; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; prot_proc: <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> prot_id <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>; IF @disable_docs_prot_trg = 1 OR @disable_all_prot_trg = 1 THEN LEAVE prot_proc; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> protocol (username, oper, table_name, table_id, ip, user_agent) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(u.email, <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span>()) username, <span class="hljs-string"><span class="hljs-string">"I"</span></span>, <span class="hljs-string"><span class="hljs-string">"docs"</span></span>, NEW.id, au.ip, au.user_agent <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dual) d <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> auth_users au <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> au.conn_id = CONNECTION_ID() <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">users</span></span> u <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> u.id = au.user_id; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> prot_id := <span class="hljs-keyword"><span class="hljs-keyword">LAST_INSERT_ID</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> protocol_pos (prot_id, column_name, new_val) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> prot_id, <span class="hljs-string"><span class="hljs-string">"id"</span></span>, NEW.id <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> prot_id, <span class="hljs-string"><span class="hljs-string">"num"</span></span>, NEW.num <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> prot_id, <span class="hljs-string"><span class="hljs-string">"date"</span></span>, NEW.date <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> prot_id, <span class="hljs-string"><span class="hljs-string">"warehouse"</span></span>, NEW.warehouse <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> prot_id, <span class="hljs-string"><span class="hljs-string">"partner"</span></span>, NEW.partner; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> docs_bef_upd_trg$ <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> docs_aft_upd_trg$ <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> docs_aft_upd_trg <span class="hljs-keyword"><span class="hljs-keyword">AFTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> docs <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EACH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROW</span></span> trg_proc:<span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @disable_docs_trg = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> @disable_all_trg = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> LEAVE trg_proc; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; prot_proc: <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> prot_id <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>; IF @disable_docs_prot_trg = 1 OR @disable_all_prot_trg = 1 THEN LEAVE prot_proc; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; IF IFNULL(NEW.id, "-") = IFNULL(OLD.id, "-") AND IFNULL(NEW.num, "-") = IFNULL(OLD.num, "-") AND IFNULL(NEW.date, "-") = IFNULL(OLD.date, "-") AND IFNULL(NEW.warehouse, "-") = IFNULL(OLD.warehouse, "-") AND IFNULL(NEW.partner, "-") = IFNULL(OLD.partner, "-") THEN LEAVE prot_proc; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> protocol (username, oper, table_name, table_id, ip, user_agent) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(u.email, <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span>()) username, <span class="hljs-string"><span class="hljs-string">"U"</span></span>, <span class="hljs-string"><span class="hljs-string">"docs"</span></span>, NEW.id, au.ip, au.user_agent <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dual) d <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> auth_users au <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> au.conn_id = CONNECTION_ID() <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">users</span></span> u <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> u.id = au.user_id; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> prot_id := <span class="hljs-keyword"><span class="hljs-keyword">LAST_INSERT_ID</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> protocol_pos (prot_id, column_name, old_val, new_val) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> prot_id, <span class="hljs-string"><span class="hljs-string">"id"</span></span>, OLD.id, NEW.id <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dual <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(NEW.id, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) != <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(OLD.id, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> prot_id, <span class="hljs-string"><span class="hljs-string">"num"</span></span>, OLD.num, NEW.num <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dual <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(NEW.num, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) != <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(OLD.num, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> prot_id, <span class="hljs-string"><span class="hljs-string">"date"</span></span>, OLD.date, NEW.date <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dual <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(NEW.date, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) != <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(OLD.date, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> prot_id, <span class="hljs-string"><span class="hljs-string">"warehouse"</span></span>, OLD.warehouse, NEW.warehouse <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dual <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(NEW.warehouse, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) != <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(OLD.warehouse, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> prot_id, <span class="hljs-string"><span class="hljs-string">"partner"</span></span>, OLD.partner, NEW.partner <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dual <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(NEW.partner, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) != <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(OLD.partner, <span class="hljs-string"><span class="hljs-string">"-"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> docs_bef_del_trg$ <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> docs_aft_del_trg$ <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> docs_aft_del_trg <span class="hljs-keyword"><span class="hljs-keyword">AFTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> docs <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EACH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROW</span></span> trg_proc:<span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @disable_docs_trg = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> @disable_all_trg = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> LEAVE trg_proc; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; prot_proc: <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> prot_id <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>; IF @disable_docs_prot_trg = 1 OR @disable_all_prot_trg = 1 THEN LEAVE prot_proc; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> protocol (username, oper, table_name, table_id, ip, user_agent) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(u.email, <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span>()) username, <span class="hljs-string"><span class="hljs-string">"D"</span></span>, <span class="hljs-string"><span class="hljs-string">"docs"</span></span>, OLD.id, au.ip, au.user_agent <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dual) d <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> auth_users au <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> au.conn_id = CONNECTION_ID() <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">users</span></span> u <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> u.id = au.user_id; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> prot_id := <span class="hljs-keyword"><span class="hljs-keyword">LAST_INSERT_ID</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> protocol_pos (prot_id, column_name, old_val) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> prot_id, <span class="hljs-string"><span class="hljs-string">"id"</span></span>, OLD.id <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> prot_id, <span class="hljs-string"><span class="hljs-string">"num"</span></span>, OLD.num <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> prot_id, <span class="hljs-string"><span class="hljs-string">"date"</span></span>, OLD.date <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> prot_id, <span class="hljs-string"><span class="hljs-string">"warehouse"</span></span>, OLD.warehouse <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> prot_id, <span class="hljs-string"><span class="hljs-string">"partner"</span></span>, OLD.partner; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> users_bef_ins_trg$ <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> users_aft_ins_trg$ <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> users_aft_ins_trg <span class="hljs-keyword"><span class="hljs-keyword">AFTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">users</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EACH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROW</span></span> trg_proc:<span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @disable_users_trg = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> @disable_all_trg = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> LEAVE trg_proc; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; prot_proc: <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> prot_id <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>; IF @disable_users_prot_trg = 1 OR @disable_all_prot_trg = 1 THEN LEAVE prot_proc; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> protocol (username, oper, table_name, table_id, ip, user_agent) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(u.email, <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span>()) username, <span class="hljs-string"><span class="hljs-string">"I"</span></span>, <span class="hljs-string"><span class="hljs-string">"users"</span></span>, NEW.id, au.ip, au.user_agent <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dual) d <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> auth_users au <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> au.conn_id = CONNECTION_ID() <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">users</span></span> u <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> u.id = au.user_id; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> prot_id := <span class="hljs-keyword"><span class="hljs-keyword">LAST_INSERT_ID</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> protocol_pos (prot_id, column_name, new_val) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> prot_id, <span class="hljs-string"><span class="hljs-string">"id"</span></span>, NEW.id <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> prot_id, <span class="hljs-string"><span class="hljs-string">"email"</span></span>, NEW.email <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> prot_id, <span class="hljs-string"><span class="hljs-string">"pass"</span></span>, NEW.pass; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> users_bef_upd_trg$ <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> users_aft_upd_trg$ <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> users_aft_upd_trg <span class="hljs-keyword"><span class="hljs-keyword">AFTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">users</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EACH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROW</span></span> trg_proc:<span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @disable_users_trg = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> @disable_all_trg = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> LEAVE trg_proc; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; prot_proc: <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> prot_id <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>; IF @disable_users_prot_trg = 1 OR @disable_all_prot_trg = 1 THEN LEAVE prot_proc; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; IF IFNULL(NEW.id, "-") = IFNULL(OLD.id, "-") AND IFNULL(NEW.email, "-") = IFNULL(OLD.email, "-") AND IFNULL(NEW.pass, "-") = IFNULL(OLD.pass, "-") THEN LEAVE prot_proc; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> protocol (username, oper, table_name, table_id, ip, user_agent) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(u.email, <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span>()) username, <span class="hljs-string"><span class="hljs-string">"U"</span></span>, <span class="hljs-string"><span class="hljs-string">"users"</span></span>, NEW.id, au.ip, au.user_agent <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dual) d <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> auth_users au <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> au.conn_id = CONNECTION_ID() <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">users</span></span> u <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> u.id = au.user_id; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> prot_id := <span class="hljs-keyword"><span class="hljs-keyword">LAST_INSERT_ID</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> protocol_pos (prot_id, column_name, old_val, new_val) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> prot_id, <span class="hljs-string"><span class="hljs-string">"id"</span></span>, OLD.id, NEW.id <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dual <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(NEW.id, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) != <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(OLD.id, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> prot_id, <span class="hljs-string"><span class="hljs-string">"email"</span></span>, OLD.email, NEW.email <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dual <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(NEW.email, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) != <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(OLD.email, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> prot_id, <span class="hljs-string"><span class="hljs-string">"pass"</span></span>, OLD.pass, NEW.pass <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dual <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(NEW.pass, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) != <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(OLD.pass, <span class="hljs-string"><span class="hljs-string">"-"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> users_bef_del_trg$ <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> users_aft_del_trg$ <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> users_aft_del_trg <span class="hljs-keyword"><span class="hljs-keyword">AFTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">users</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EACH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROW</span></span> trg_proc:<span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @disable_users_trg = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> @disable_all_trg = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> LEAVE trg_proc; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; prot_proc: <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> prot_id <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>; IF @disable_users_prot_trg = 1 OR @disable_all_prot_trg = 1 THEN LEAVE prot_proc; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> protocol (username, oper, table_name, table_id, ip, user_agent) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(u.email, <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span>()) username, <span class="hljs-string"><span class="hljs-string">"D"</span></span>, <span class="hljs-string"><span class="hljs-string">"users"</span></span>, OLD.id, au.ip, au.user_agent <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dual) d <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> auth_users au <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> au.conn_id = CONNECTION_ID() <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">users</span></span> u <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> u.id = au.user_id; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> prot_id := <span class="hljs-keyword"><span class="hljs-keyword">LAST_INSERT_ID</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> protocol_pos (prot_id, column_name, old_val) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> prot_id, <span class="hljs-string"><span class="hljs-string">"id"</span></span>, OLD.id <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> prot_id, <span class="hljs-string"><span class="hljs-string">"email"</span></span>, OLD.email <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> prot_id, <span class="hljs-string"><span class="hljs-string">"pass"</span></span>, OLD.pass; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> doc_pos_bef_ins_trg$ <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> doc_pos_aft_ins_trg$ <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> doc_pos_aft_ins_trg <span class="hljs-keyword"><span class="hljs-keyword">AFTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> doc_pos <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EACH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROW</span></span> trg_proc:<span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @disable_doc_pos_trg = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> @disable_all_trg = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> LEAVE trg_proc; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; prot_proc: <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> prot_id <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>; IF @disable_doc_pos_prot_trg = 1 OR @disable_all_prot_trg = 1 THEN LEAVE prot_proc; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> protocol (username, oper, table_name, table_id, ip, user_agent) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(u.email, <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span>()) username, <span class="hljs-string"><span class="hljs-string">"I"</span></span>, <span class="hljs-string"><span class="hljs-string">"doc_pos"</span></span>, NEW.id, au.ip, au.user_agent <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dual) d <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> auth_users au <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> au.conn_id = CONNECTION_ID() <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">users</span></span> u <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> u.id = au.user_id; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> prot_id := <span class="hljs-keyword"><span class="hljs-keyword">LAST_INSERT_ID</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> protocol_pos (prot_id, column_name, new_val) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> prot_id, <span class="hljs-string"><span class="hljs-string">"id"</span></span>, NEW.id <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> prot_id, <span class="hljs-string"><span class="hljs-string">"doc_id"</span></span>, NEW.doc_id <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> prot_id, <span class="hljs-string"><span class="hljs-string">"material"</span></span>, NEW.material <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> prot_id, <span class="hljs-string"><span class="hljs-string">"amount"</span></span>, NEW.amount <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> prot_id, <span class="hljs-string"><span class="hljs-string">"price"</span></span>, NEW.price; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> doc_pos_bef_upd_trg$ <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> doc_pos_aft_upd_trg$ <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> doc_pos_aft_upd_trg <span class="hljs-keyword"><span class="hljs-keyword">AFTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> doc_pos <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EACH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROW</span></span> trg_proc:<span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @disable_doc_pos_trg = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> @disable_all_trg = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> LEAVE trg_proc; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; prot_proc: <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> prot_id <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>; IF @disable_doc_pos_prot_trg = 1 OR @disable_all_prot_trg = 1 THEN LEAVE prot_proc; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; IF IFNULL(NEW.id, "-") = IFNULL(OLD.id, "-") AND IFNULL(NEW.doc_id, "-") = IFNULL(OLD.doc_id, "-") AND IFNULL(NEW.material, "-") = IFNULL(OLD.material, "-") AND IFNULL(NEW.amount, "-") = IFNULL(OLD.amount, "-") AND IFNULL(NEW.price, "-") = IFNULL(OLD.price, "-") THEN LEAVE prot_proc; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> protocol (username, oper, table_name, table_id, ip, user_agent) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(u.email, <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span>()) username, <span class="hljs-string"><span class="hljs-string">"U"</span></span>, <span class="hljs-string"><span class="hljs-string">"doc_pos"</span></span>, NEW.id, au.ip, au.user_agent <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dual) d <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> auth_users au <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> au.conn_id = CONNECTION_ID() <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">users</span></span> u <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> u.id = au.user_id; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> prot_id := <span class="hljs-keyword"><span class="hljs-keyword">LAST_INSERT_ID</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> protocol_pos (prot_id, column_name, old_val, new_val) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> prot_id, <span class="hljs-string"><span class="hljs-string">"id"</span></span>, OLD.id, NEW.id <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dual <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(NEW.id, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) != <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(OLD.id, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> prot_id, <span class="hljs-string"><span class="hljs-string">"doc_id"</span></span>, OLD.doc_id, NEW.doc_id <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dual <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(NEW.doc_id, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) != <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(OLD.doc_id, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> prot_id, <span class="hljs-string"><span class="hljs-string">"material"</span></span>, OLD.material, NEW.material <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dual <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(NEW.material, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) != <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(OLD.material, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> prot_id, <span class="hljs-string"><span class="hljs-string">"amount"</span></span>, OLD.amount, NEW.amount <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dual <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(NEW.amount, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) != <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(OLD.amount, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> prot_id, <span class="hljs-string"><span class="hljs-string">"price"</span></span>, OLD.price, NEW.price <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dual <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(NEW.price, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) != <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(OLD.price, <span class="hljs-string"><span class="hljs-string">"-"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> doc_pos_bef_del_trg$ <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> doc_pos_aft_del_trg$ <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> doc_pos_aft_del_trg <span class="hljs-keyword"><span class="hljs-keyword">AFTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> doc_pos <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EACH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROW</span></span> trg_proc:<span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @disable_doc_pos_trg = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> @disable_all_trg = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> LEAVE trg_proc; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; prot_proc: <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> prot_id <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>; IF @disable_doc_pos_prot_trg = 1 OR @disable_all_prot_trg = 1 THEN LEAVE prot_proc; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> protocol (username, oper, table_name, table_id, ip, user_agent) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(u.email, <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span>()) username, <span class="hljs-string"><span class="hljs-string">"D"</span></span>, <span class="hljs-string"><span class="hljs-string">"doc_pos"</span></span>, OLD.id, au.ip, au.user_agent <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dual) d <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> auth_users au <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> au.conn_id = CONNECTION_ID() <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">users</span></span> u <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> u.id = au.user_id; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> prot_id := <span class="hljs-keyword"><span class="hljs-keyword">LAST_INSERT_ID</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> protocol_pos (prot_id, column_name, old_val) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> prot_id, <span class="hljs-string"><span class="hljs-string">"id"</span></span>, OLD.id <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> prot_id, <span class="hljs-string"><span class="hljs-string">"doc_id"</span></span>, OLD.doc_id <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> prot_id, <span class="hljs-string"><span class="hljs-string">"material"</span></span>, OLD.material <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> prot_id, <span class="hljs-string"><span class="hljs-string">"amount"</span></span>, OLD.amount <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> prot_id, <span class="hljs-string"><span class="hljs-string">"price"</span></span>, OLD.price; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> protocol_config_bef_ins_trg$ <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> protocol_config_aft_ins_trg$ <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> protocol_config_aft_ins_trg <span class="hljs-keyword"><span class="hljs-keyword">AFTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> protocol_config <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EACH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROW</span></span> trg_proc:<span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @disable_protocol_config_trg = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> @disable_all_trg = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> LEAVE trg_proc; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; prot_proc: <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> prot_id <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>; IF @disable_protocol_config_prot_trg = 1 OR @disable_all_prot_trg = 1 THEN LEAVE prot_proc; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> protocol (username, oper, table_name, table_id, ip, user_agent) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(u.email, <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span>()) username, <span class="hljs-string"><span class="hljs-string">"I"</span></span>, <span class="hljs-string"><span class="hljs-string">"protocol_config"</span></span>, NEW.id, au.ip, au.user_agent <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dual) d <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> auth_users au <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> au.conn_id = CONNECTION_ID() <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">users</span></span> u <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> u.id = au.user_id; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> prot_id := <span class="hljs-keyword"><span class="hljs-keyword">LAST_INSERT_ID</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> protocol_pos (prot_id, column_name, new_val) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> prot_id, <span class="hljs-string"><span class="hljs-string">"id"</span></span>, NEW.id <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> prot_id, <span class="hljs-string"><span class="hljs-string">"command"</span></span>, NEW.command <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> prot_id, <span class="hljs-string"><span class="hljs-string">"table_name"</span></span>, NEW.table_name <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> prot_id, <span class="hljs-string"><span class="hljs-string">"column_name"</span></span>, NEW.column_name <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> prot_id, <span class="hljs-string"><span class="hljs-string">"denormalize_column"</span></span>, NEW.denormalize_column; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> protocol_config_bef_upd_trg$ <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> protocol_config_aft_upd_trg$ <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> protocol_config_aft_upd_trg <span class="hljs-keyword"><span class="hljs-keyword">AFTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> protocol_config <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EACH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROW</span></span> trg_proc:<span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @disable_protocol_config_trg = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> @disable_all_trg = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> LEAVE trg_proc; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; prot_proc: <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> prot_id <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>; IF @disable_protocol_config_prot_trg = 1 OR @disable_all_prot_trg = 1 THEN LEAVE prot_proc; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; IF IFNULL(NEW.id, "-") = IFNULL(OLD.id, "-") AND IFNULL(NEW.command, "-") = IFNULL(OLD.command, "-") AND IFNULL(NEW.table_name, "-") = IFNULL(OLD.table_name, "-") AND IFNULL(NEW.column_name, "-") = IFNULL(OLD.column_name, "-") AND IFNULL(NEW.denormalize_column, "-") = IFNULL(OLD.denormalize_column, "-") THEN LEAVE prot_proc; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> protocol (username, oper, table_name, table_id, ip, user_agent) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(u.email, <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span>()) username, <span class="hljs-string"><span class="hljs-string">"U"</span></span>, <span class="hljs-string"><span class="hljs-string">"protocol_config"</span></span>, NEW.id, au.ip, au.user_agent <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dual) d <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> auth_users au <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> au.conn_id = CONNECTION_ID() <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">users</span></span> u <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> u.id = au.user_id; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> prot_id := <span class="hljs-keyword"><span class="hljs-keyword">LAST_INSERT_ID</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> protocol_pos (prot_id, column_name, old_val, new_val) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> prot_id, <span class="hljs-string"><span class="hljs-string">"id"</span></span>, OLD.id, NEW.id <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dual <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(NEW.id, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) != <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(OLD.id, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> prot_id, <span class="hljs-string"><span class="hljs-string">"command"</span></span>, OLD.command, NEW.command <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dual <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(NEW.command, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) != <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(OLD.command, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> prot_id, <span class="hljs-string"><span class="hljs-string">"table_name"</span></span>, OLD.table_name, NEW.table_name <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dual <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(NEW.table_name, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) != <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(OLD.table_name, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> prot_id, <span class="hljs-string"><span class="hljs-string">"column_name"</span></span>, OLD.column_name, NEW.column_name <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dual <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(NEW.column_name, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) != <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(OLD.column_name, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> prot_id, <span class="hljs-string"><span class="hljs-string">"denormalize_column"</span></span>, OLD.denormalize_column, NEW.denormalize_column <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dual <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(NEW.denormalize_column, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) != <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(OLD.denormalize_column, <span class="hljs-string"><span class="hljs-string">"-"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> protocol_config_bef_del_trg$ <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> protocol_config_aft_del_trg$ <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> protocol_config_aft_del_trg <span class="hljs-keyword"><span class="hljs-keyword">AFTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> protocol_config <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EACH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROW</span></span> trg_proc:<span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @disable_protocol_config_trg = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> @disable_all_trg = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> LEAVE trg_proc; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; prot_proc: <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> prot_id <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>; IF @disable_protocol_config_prot_trg = 1 OR @disable_all_prot_trg = 1 THEN LEAVE prot_proc; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> protocol (username, oper, table_name, table_id, ip, user_agent) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(u.email, <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span>()) username, <span class="hljs-string"><span class="hljs-string">"D"</span></span>, <span class="hljs-string"><span class="hljs-string">"protocol_config"</span></span>, OLD.id, au.ip, au.user_agent <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dual) d <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> auth_users au <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> au.conn_id = CONNECTION_ID() <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">users</span></span> u <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> u.id = au.user_id; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> prot_id := <span class="hljs-keyword"><span class="hljs-keyword">LAST_INSERT_ID</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> protocol_pos (prot_id, column_name, old_val) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> prot_id, <span class="hljs-string"><span class="hljs-string">"id"</span></span>, OLD.id <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> prot_id, <span class="hljs-string"><span class="hljs-string">"command"</span></span>, OLD.command <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> prot_id, <span class="hljs-string"><span class="hljs-string">"table_name"</span></span>, OLD.table_name <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> prot_id, <span class="hljs-string"><span class="hljs-string">"column_name"</span></span>, OLD.column_name <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> prot_id, <span class="hljs-string"><span class="hljs-string">"denormalize_column"</span></span>, OLD.denormalize_column; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>$</code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ููุฏ ุญุตููุง ุนูู ูุต ุงููุดุบูุงุช ุ ููููุฐู (ูุน </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DELIMITER $</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุงูุขู ูุชู ุชุณุฌูู ุฌุฏุงูููุง ููุชู ูุชุงุจุฉ ุฌููุน ุชุบููุฑุงุช ุงูุจูุงูุงุช ูู ุงูุจุฑูุชูููู. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุชุญูู ูู ุฅุนุฏุงุฏุงุช ุงูุชุณุฌูู ูุน ุงูุทูุจ ุงูุฃูู:</font></font><br><div class="spoiler" style=";text-align:right;direction:rtl"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุทูุจ ููุชุญูู ูู ุตุญุฉ ุงููุดุบูุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช</font></font></b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="sql hljs">DELIMITER ; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> table_name, <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>, rows_cn, data_len_mb , <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(need_bl_trg) need_bl_trg , <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(exclude_prot) exclude_prot , <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> action_statement != gen_trg <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-string"><span class="hljs-string">'SELECT generate_triggers("'</span></span>, table_name, <span class="hljs-string"><span class="hljs-string">'")'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> gen_trg <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> (exclude_prot <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> need_bl_trg = <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-string"><span class="hljs-string">'SELECT generate_triggers("'</span></span>, table_name, <span class="hljs-string"><span class="hljs-string">'")'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> ) create_trg <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> table_name, <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>, rows_cn, data_len_mb, need_bl_trg, exclude_prot, action_statement, gen_trg <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> table_name, <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>, rows_cn, data_len_mb, need_bl_trg, exclude_prot , <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(SUBSTRING_INDEX(gen_trg, <span class="hljs-string"><span class="hljs-string">'\n'</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>), <span class="hljs-string"><span class="hljs-string">'\n'</span></span>, action_statement, <span class="hljs-string"><span class="hljs-string">'$'</span></span>, <span class="hljs-string"><span class="hljs-string">'\n'</span></span>) action_statement , gen_trg <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> t.TABLE_NAME table_name , t.TABLE_COMMENT <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span> , t.TABLE_ROWS rows_cn , <span class="hljs-keyword"><span class="hljs-keyword">ROUND</span></span>(t.DATA_LENGTH / <span class="hljs-number"><span class="hljs-number">1024</span></span> / <span class="hljs-number"><span class="hljs-number">1024</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>) data_len_mb , <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> r.ROUTINE_NAME <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> need_bl_trg , <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> pd.id <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> pc.id <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> t.TABLE_NAME <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-string"><span class="hljs-string">'protocol'</span></span>, <span class="hljs-string"><span class="hljs-string">'protocol_pos'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> C.COLUMN_NAME <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'  id'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> exclude_prot , tr.ACTION_STATEMENT action_statement , generate_trigger(tr.EVENT_OBJECT_TABLE, tr.ACTION_TIMING, tr.EVENT_MANIPULATION) gen_trg <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> INFORMATION_SCHEMA.TABLES t <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> INFORMATION_SCHEMA.ROUTINES r <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> r.ROUTINE_NAME = <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(t.TABLE_NAME, <span class="hljs-string"><span class="hljs-string">'_trg_proc'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> r.ROUTINE_TYPE = <span class="hljs-string"><span class="hljs-string">'PROCEDURE'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> r.ROUTINE_SCHEMA = t.TABLE_SCHEMA <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> protocol_config pd <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> pd.command = <span class="hljs-string"><span class="hljs-string">'disable_protocol'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> protocol_config pc <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> pc.command = <span class="hljs-string"><span class="hljs-string">'exclude_table'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> pc.table_name = t.TABLE_NAME <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> INFORMATION_SCHEMA.COLUMNS C <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> C.TABLE_SCHEMA = t.TABLE_SCHEMA <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> C.TABLE_NAME = t.TABLE_NAME <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> C.COLUMN_NAME = <span class="hljs-string"><span class="hljs-string">'id'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> INFORMATION_SCHEMA.TRIGGERS tr <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> tr.TRIGGER_SCHEMA = t.TABLE_SCHEMA <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> tr.EVENT_OBJECT_TABLE = t.TABLE_NAME <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> t.TABLE_SCHEMA = <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t.TABLE_TYPE = <span class="hljs-string"><span class="hljs-string">'BASE TABLE'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t.ENGINE = <span class="hljs-string"><span class="hljs-string">'InnoDB'</span></span> ) d) d) d <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> table_name, <span class="hljs-keyword"><span class="hljs-keyword">comment</span></span>, rows_cn, data_len_mb <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> table_name ;</code> </pre><br></div></div><br><pre style=";text-align:right;direction:rtl"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">+ --------------- + -------------------------- + ------ - + ----------- + ----------- + ------------------ + ----- ----- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| table_name | ุชุนููู | rows_cn | data_len_mb | need_bl_trg | exclude_prot | create_trg |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ --------------- + -------------------------- + ------ - + ----------- + ----------- + ------------------ + ----- ----- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| ูุณุชูุฏุงุช | ูุณุชูุฏุงุช | </font><font style="vertical-align: inherit;">0 | </font><font style="vertical-align: inherit;">0.02 | </font><font style="vertical-align: inherit;">NULL | NULL | NULL |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| doc_pos | ููุงุถุน ุงููุณุชูุฏุงุช | </font><font style="vertical-align: inherit;">0 | </font><font style="vertical-align: inherit;">0.02 | </font><font style="vertical-align: inherit;">NULL | NULL | NULL |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| ุจุฑูุชูููู | ุจุฑูุชูููู ุงูุชุบููุฑุงุช | </font><font style="vertical-align: inherit;">0 | </font><font style="vertical-align: inherit;">0.02 | </font><font style="vertical-align: inherit;">NULL | ุบูุฑ ูุณุฌู | NULL |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| protocol_config | ุชูููู ุงูุชุณุฌูู | </font><font style="vertical-align: inherit;">0 | </font><font style="vertical-align: inherit;">0.02 | </font><font style="vertical-align: inherit;">NULL | NULL | NULL |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| protocol_pos | ุชุบููุฑ ุญููู ุงูุจุฑูุชูููู | </font><font style="vertical-align: inherit;">0 | </font><font style="vertical-align: inherit;">0.02 | </font><font style="vertical-align: inherit;">NULL | ุบูุฑ ูุณุฌู | NULL |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| ุงููุณุชุฎุฏููู | ูุณุชุฎุฏูู ุงููุธุงู | </font><font style="vertical-align: inherit;">0 | </font><font style="vertical-align: inherit;">0.02 | </font><font style="vertical-align: inherit;">NULL | NULL | NULL |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ --------------- + -------------------------- + ------ - + ----------- + ----------- + ------------------ + ----- ----- +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
6 ุตููู ูู ุงููุฌููุนุฉ ุ 0 ุชุญุฐูุฑุงุช (5.33 ุซุงููุฉ)</font></font><font></font>
</pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ุฅุถุงูุฉ ูุณุชุฎุฏู ูุชุณุฌูู ุงูุฏุฎูู: </font></font><br><pre style=";text-align:right;direction:rtl"> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">/* DELETE FROM doc_pos; DELETE FROM docs; DELETE FROM auth_users; DELETE FROM users; DELETE FROM protocol_pos; DELETE FROM protocol; */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">users</span></span> (email, pass) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'test@test.ru'</span></span>, <span class="hljs-string"><span class="hljs-string">'12345'</span></span>); Query OK, 1 row affected (0.01 sec) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> auth_users (conn_id, user_id) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> CONNECTION_ID() conn_id , (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> u.id <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-keyword"><span class="hljs-keyword">users</span></span> u <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> u.email = <span class="hljs-string"><span class="hljs-string">'test@test.ru'</span></span>) user_id ; Query OK, 1 row affected (0.00 sec)</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ุฃุฏุฎู ูุณุชูุฏ ุงุฎุชุจุงุฑ: </font></font><br><br><pre style=";text-align:right;direction:rtl"> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> docs (<span class="hljs-keyword"><span class="hljs-keyword">num</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">date</span></span>, warehouse, partner) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'1'</span></span>, <span class="hljs-string"><span class="hljs-string">'2018-07-17'</span></span>, <span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-string"><span class="hljs-string">', '</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @doc_id := <span class="hljs-keyword"><span class="hljs-keyword">LAST_INSERT_ID</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> doc_pos (doc_id, material, amount, price) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (@doc_id, <span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">52</span></span>) , (@doc_id, <span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">165</span></span>) , (@doc_id, <span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">COMMIT</span></span>;</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ุฏุนููุง ูุฑู ูุง ุญุฏุซ ูู ุงูุจุฑูุชูููู: </font></font><br><br><pre style=";text-align:right;direction:rtl"> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">date</span></span>, oper, table_name, table_id , (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GROUP_CONCAT</span></span>(pp.column_name, <span class="hljs-string"><span class="hljs-string">': ('</span></span> , <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(pp.old_val, <span class="hljs-string"><span class="hljs-string">'NULL'</span></span>) , <span class="hljs-string"><span class="hljs-string">', '</span></span> , <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(pp.new_val, <span class="hljs-string"><span class="hljs-string">'NULL'</span></span>) , <span class="hljs-string"><span class="hljs-string">')'</span></span> SEPARATOR <span class="hljs-string"><span class="hljs-string">', '</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> protocol_pos pp <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> pp.prot_id = p.id ) vals , p.username <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> protocol p;</code> </pre><br><div class="spoiler" style=";text-align:right;direction:rtl"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุทูุจ ุฃุชุด ุชู ุฃู ุฃู</font></font></b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">date</span></span>, oper, table_name, table_id , (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-string"><span class="hljs-string">'&lt;table class="table table-bordered" style="width: 100%; margin: -9px;"&gt;'</span></span> , <span class="hljs-keyword"><span class="hljs-keyword">GROUP_CONCAT</span></span>(<span class="hljs-string"><span class="hljs-string">'&lt;tr&gt;&lt;td style="font-weight: bold; width: 20%;"&gt;'</span></span>, pp.column_name, <span class="hljs-string"><span class="hljs-string">'&lt;/td&gt;'</span></span> , <span class="hljs-string"><span class="hljs-string">'&lt;td style="width: 40%;"&gt;'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(pp.old_val, <span class="hljs-string"><span class="hljs-string">"&lt;span style='color: #FF0000; font-style: italic;'&gt;NULL&lt;/span&gt;"</span></span>), <span class="hljs-string"><span class="hljs-string">'&lt;/td&gt;'</span></span> , <span class="hljs-string"><span class="hljs-string">'&lt;td style="width: 40%;"&gt;'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(pp.new_val, <span class="hljs-string"><span class="hljs-string">"&lt;span style='color: #FF0000; font-style: italic;'&gt;NULL&lt;/span&gt;"</span></span>), <span class="hljs-string"><span class="hljs-string">'&lt;/td&gt;&lt;/tr&gt;'</span></span> SEPARATOR <span class="hljs-string"><span class="hljs-string">''</span></span> ) , <span class="hljs-string"><span class="hljs-string">'&lt;/table&gt;'</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> protocol_pos pp <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> pp.prot_id = p.id ) vals , p.username <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> protocol p;</code> </pre><br></div></div><br><pre style=";text-align:right;direction:rtl"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">+ ---- + --------------------- + ------ + ------------ + - -------- + ----------------------------------------- -------------------------------------------------- ------------------------------ + ------------------- +
</font></font> |<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ูุนุฑู | </font><font style="vertical-align: inherit;">ุงูุชุงุฑูุฎ | </font><font style="vertical-align: inherit;">ุงูุฃูุจุฑุง | </font><font style="vertical-align: inherit;">table_name | </font><font style="vertical-align: inherit;">table_id | </font><font style="vertical-align: inherit;">ูุงูุณ | </font><font style="vertical-align: inherit;">ุงุณู ุงููุณุชุฎุฏู |</font></font><font></font>
+----+---------------------+------+------------+----------+-------------------------------------------------------------------------------------------------------------------------+-------------------+<font></font>
 | 1 | 2018-10-09 17:21:27 | I | users | 1 | email: (NULL, test@test.ru), id: (NULL, 1), pass: (NULL, 12345) | admin@myhosting.ru|
 | 2 | 2018-10-09 17:21:51 | I | docs | 1 | date: (NULL, 2018-07-17), id: (NULL, 1), num: (NULL, 1), partner: (NULL, , ), warehouse: (NULL,  )| test@test.ru |
 | 3 | 2018-10-09 17:21:51 | I | doc_pos | 1 | amount: (NULL, 10), doc_id: (NULL, 1), id: (NULL, 1), material: (NULL,  ), price: (NULL, 52) | test@test.ru |
 | 4 | 2018-10-09 17:21:51 | I | doc_pos | 2 | amount: (NULL, 20), doc_id: (NULL, 1), id: (NULL, 2), material: (NULL,  ), price: (NULL, 165) | test@test.ru |
 |<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5 | </font><font style="vertical-align: inherit;">2018-10-09 17:21:51 | </font><font style="vertical-align: inherit;">ุฃูุง | </font><font style="vertical-align: inherit;">doc_pos | </font><font style="vertical-align: inherit;">3 | </font><font style="vertical-align: inherit;">ุงููุจูุบ: (NULLุ 7)ุ doc_id: (NULLุ 1)ุ id: (NULLุ 3)ุ material: (NULLุ Ballpoint pen)ุ price: (NULLุ 30) | </font><font style="vertical-align: inherit;">test@test.ru |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ ---- + --------------------- + ------ + ------------ + - -------- + ----------------------------------------- -------------------------------------------------- ------------------------------ + ------------------- +</font></font><font></font>
</pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ููุง ุชุฑู ุ ูุชู ุชุณุฌูู ุฌููุน ุชุบููุฑุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช ุ ุจุฏุกูุง ูู ุฅุฏุฎุงู ุงููุณุชุฎุฏู. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุณูู ูุชููู ุชูุฑูุฑ ุงููุจูุนุงุช:</font></font><br><br><pre style=";text-align:right;direction:rtl"> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOW</span></span>() report_time, d.date, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(p.amount * p.price) <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> docs d <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> doc_pos p <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> d.id = p.doc_id <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> d.date;</code> </pre><br><pre style=";text-align:right;direction:rtl"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">+ --------------------- + ------------ + ------ +
</font></font> |<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">report_time | </font><font style="vertical-align: inherit;">ุงูุชุงุฑูุฎ | </font><font style="vertical-align: inherit;">ุงููุฌููุน |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ --------------------- + ------------ + ------ +</font></font><font></font>
 |<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2018-10-09 17:23:47 | </font><font style="vertical-align: inherit;">2018-07-17 | </font><font style="vertical-align: inherit;">4030 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ --------------------- + ------------ + ------ +</font></font><font></font>
</pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ุงูุขู ูู ุจุชุบููุฑ ุงููุณุชูุฏ ุงูุญุงูู ูุฅุถุงูุฉ ูุณุชูุฏ ุขุฎุฑ: </font></font><br><pre style=";text-align:right;direction:rtl"> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @doc_id := (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> docs <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">num</span></span> = <span class="hljs-string"><span class="hljs-string">'1'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> docs <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> = <span class="hljs-string"><span class="hljs-string">'2018-07-16'</span></span>, warehouse = warehouse <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = @doc_id; <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> doc_pos <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> doc_id = @doc_id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> material = <span class="hljs-string"><span class="hljs-string">' '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> doc_pos p <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> p.price = <span class="hljs-number"><span class="hljs-number">105</span></span>, p.material = <span class="hljs-string"><span class="hljs-string">' '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> p.doc_id = @doc_id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> p.material = <span class="hljs-string"><span class="hljs-string">' '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> docs (<span class="hljs-keyword"><span class="hljs-keyword">num</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">date</span></span>, warehouse, partner) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'2'</span></span>, <span class="hljs-string"><span class="hljs-string">'2018-07-18'</span></span>, <span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-string"><span class="hljs-string">', '</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @doc_id := <span class="hljs-keyword"><span class="hljs-keyword">LAST_INSERT_ID</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> doc_pos (doc_id, material, amount, price) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (@doc_id, <span class="hljs-string"><span class="hljs-string">' 10*15'</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">102</span></span>) , (@doc_id, <span class="hljs-string"><span class="hljs-string">' 4'</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">165</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">COMMIT</span></span>;</code> </pre><br><div class="spoiler" style=";text-align:right;direction:rtl"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุณูุจุฏู ูุฐุง ูุจุฑูุชูููู ุฌุฏูุฏ</font></font></b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">date</span></span>, oper, table_name, table_id , (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GROUP_CONCAT</span></span>(pp.column_name, <span class="hljs-string"><span class="hljs-string">': ('</span></span> , <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(pp.old_val, <span class="hljs-string"><span class="hljs-string">'NULL'</span></span>) , <span class="hljs-string"><span class="hljs-string">', '</span></span> , <span class="hljs-keyword"><span class="hljs-keyword">IFNULL</span></span>(pp.new_val, <span class="hljs-string"><span class="hljs-string">'NULL'</span></span>) , <span class="hljs-string"><span class="hljs-string">')'</span></span> SEPARATOR <span class="hljs-string"><span class="hljs-string">', '</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> protocol_pos pp <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> pp.prot_id = p.id ) vals , p.username <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> protocol p;</code> </pre><br><pre style=";text-align:right;direction:rtl"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">+ ---- + --------------------- + ------ + ------------ + - -------- + ----------------------------------------- -------------------------------------------------- --------------------------------- + ---------------- --- +
</font></font> | id | date | oper | table_name | table_id | vals | username |<font></font>
+----+---------------------+------+------------+----------+----------------------------------------------------------------------------------------------------------------------------+-------------------+<font></font>
 | 1 | 2018-10-09 17:21:27 | I | users | 1 | email: (NULL, test@test.ru), id: (NULL, 1), pass: (NULL, 12345) | admin@myhosting.ru|
 | 2 | 2018-10-09 17:21:51 | I | docs | 1 | date: (NULL, 2018-07-17), id: (NULL, 1), num: (NULL, 1), partner: (NULL, , ), warehouse: (NULL,  ) | test@test.ru |
 | 3 | 2018-10-09 17:21:51 | I | doc_pos | 1 | amount: (NULL, 10), doc_id: (NULL, 1), id: (NULL, 1), material: (NULL,  ), price: (NULL, 52) | test@test.ru |
 | 4 | 2018-10-09 17:21:51 | I | doc_pos | 2 | amount: (NULL, 20), doc_id: (NULL, 1), id: (NULL, 2), material: (NULL,  ), price: (NULL, 165) | test@test.ru |
 | 5 | 2018-10-09 17:21:51 | I | doc_pos | 3 | amount: (NULL, 7), doc_id: (NULL, 1), id: (NULL, 3), material: (NULL,  ), price: (NULL, 30) | test@test.ru |
 | 6 | 2018-10-09 17:24:27 | U | docs | 1 | date: (2018-07-17, 2018-07-16) | test@test.ru |
 | 7 | 2018-10-09 17:24:27 | D | doc_pos | 3 | amount: (7, NULL), doc_id: (1, NULL), id: (3, NULL), material: ( , NULL), price: (30, NULL) | test@test.ru |
 | 8 | 2018-10-09 17:24:27 | U | doc_pos | 2 | material: ( ,  ), price: (165, 105) | test@test.ru |
 | 9 | 2018-10-09 17:24:27 | I | docs | 2 | date: (NULL, 2018-07-18), id: (NULL, 2), num: (NULL, 2), partner: (NULL, , ), warehouse: (NULL,  )| test@test.ru |
 | 10 | 2018-10-09 17:24:27 | I | doc_pos | 4 | amount: (NULL, 5), doc_id: (NULL, 2), id: (NULL, 4), material: (NULL,  10*15), price: (NULL, 102) | test@test.ru |
 | 11 | 2018-10-09 17:24:27 | I | doc_pos | 5 | amount: (NULL, 2), doc_id: (NULL, 2), id: (NULL, 5), material: (NULL,  4), price: (NULL, 165) | test@test.ru |<font></font>
+----+---------------------+------+------------+----------+----------------------------------------------------------------------------------------------------------------------------+-------------------+<font></font>
</pre></div></div><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ุงุญุตู ุนูู ุชูุฑูุฑ ุฌุฏูุฏ: </font></font><br><pre style=";text-align:right;direction:rtl"> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOW</span></span>() report_time, d.date, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(p.amount * p.price) <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> docs d <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> doc_pos p <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> d.id = p.doc_id <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> d.date;</code> </pre><br><pre style=";text-align:right;direction:rtl"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">+ --------------------- + ------------ + ------ +
</font></font> |<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">report_time | </font><font style="vertical-align: inherit;">ุงูุชุงุฑูุฎ | </font><font style="vertical-align: inherit;">ุงููุฌููุน |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ --------------------- + ------------ + ------ +</font></font><font></font>
 |<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2018-10-09 17:26:18 | </font><font style="vertical-align: inherit;">2018-07-16 | </font><font style="vertical-align: inherit;">2620 |
</font></font> |<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2018-10-09 17:26:18 | </font><font style="vertical-align: inherit;">2018-07-18 | </font><font style="vertical-align: inherit;">840 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ --------------------- + ------------ + ------ +</font></font><font></font>
</pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ููุญู ููุธุฑ ูู ุงูุชูุฑูุฑ ููุง ูููู ุงูุนุซูุฑ ุนูู ุจูุงูุงุช </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2018/07/17</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ุงูุนุฏุฏุ ุนูู ุงูุฑุบู ูู ุฃู ุฃุชุฐูุฑ ุจุงูุถุจุท ูุง ูุงูุช ุนูููุ ูุฏููุง ุญุชู ุชูุฑูุฑ ูุทุจูุน ูู </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2018/9/10 17:23:47</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ุชุนููู </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุงูุฎููุฉ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ุฅูู ูุธุฑุฉ ุฅูู ุงููุงุถู! </font><font style="vertical-align: inherit;">ููููุงู ุจุฐูู ุ ุณููุชุจ ุงูุฅุฌุฑุงุกุงุช ุงูุชู ุ ููููุง ููุจุฑูุชูููู ุ ุณุชููู ูุงุฏุฑุฉ ุนูู ุงูุชุฑุงุฌุน ุนู ุงูุชุบููุฑุงุช. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุฅุฌุฑุงุก </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exec_protocol</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ูููุฐ ุชุบููุฑุงุช ุนูู ุฎุท ุงูุจุฑูุชูููู (p_prot_id)</font></font><br><div class="spoiler" style=";text-align:right;direction:rtl"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exec_protocol</font></font></b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="sql hljs">DELIMITER $ <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> exec_protocol$ <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> exec_protocol(p_prot_id <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span>, direction <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> p_sql_text <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> done <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">FALSE</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> cur <span class="hljs-keyword"><span class="hljs-keyword">CURSOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> p.oper = <span class="hljs-string"><span class="hljs-string">'I'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> direction = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> p.oper = <span class="hljs-string"><span class="hljs-string">'D'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> direction = <span class="hljs-number"><span class="hljs-number">-1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'INSERT INTO'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> p.oper = <span class="hljs-string"><span class="hljs-string">'U'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'UPDATE'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> p.oper = <span class="hljs-string"><span class="hljs-string">'D'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> direction = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> p.oper = <span class="hljs-string"><span class="hljs-string">'I'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> direction = <span class="hljs-number"><span class="hljs-number">-1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'DELETE FROM'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> , <span class="hljs-string"><span class="hljs-string">' '</span></span>, p.table_name, <span class="hljs-string"><span class="hljs-string">' '</span></span> , <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> p.oper = <span class="hljs-string"><span class="hljs-string">'I'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> direction = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> p.oper = <span class="hljs-string"><span class="hljs-string">'D'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> direction = <span class="hljs-number"><span class="hljs-number">-1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-string"><span class="hljs-string">'('</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">GROUP_CONCAT</span></span>(pos.column_name <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> pos.column_name SEPARATOR <span class="hljs-string"><span class="hljs-string">', '</span></span>), <span class="hljs-string"><span class="hljs-string">')'</span></span> , <span class="hljs-string"><span class="hljs-string">' VALUES ('</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">GROUP_CONCAT</span></span>(QUOTE(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> direction <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> pos.new_val <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> pos.old_val <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> pos.column_name SEPARATOR <span class="hljs-string"><span class="hljs-string">', '</span></span> ) , <span class="hljs-string"><span class="hljs-string">')'</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> p.oper = <span class="hljs-string"><span class="hljs-string">'U'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-string"><span class="hljs-string">'SET '</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">GROUP_CONCAT</span></span>(pos.column_name , <span class="hljs-string"><span class="hljs-string">' = '</span></span>, QUOTE(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> direction <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> pos.new_val <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> pos.old_val <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> pos.column_name SEPARATOR <span class="hljs-string"><span class="hljs-string">', '</span></span> ) , <span class="hljs-string"><span class="hljs-string">' WHERE id = '</span></span>, p.table_id ) <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> p.oper = <span class="hljs-string"><span class="hljs-string">'D'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> direction = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> p.oper = <span class="hljs-string"><span class="hljs-string">'I'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> direction = <span class="hljs-number"><span class="hljs-number">-1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-string"><span class="hljs-string">'WHERE id = '</span></span>, p.table_id) <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> ) sql_text <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> protocol p <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> protocol_pos pos <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> p.id = pos.prot_id <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> p.id = p_prot_id ; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> CONTINUE <span class="hljs-keyword"><span class="hljs-keyword">HANDLER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOUND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> done = <span class="hljs-literal"><span class="hljs-literal">TRUE</span></span>; OPEN cur; read_loop: LOOP FETCH cur INTO p_sql_text; IF done THEN LEAVE read_loop; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @exec_protocol_sql_text := p_sql_text; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @disable_all_prot_trg = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-comment"><span class="hljs-comment">-- SELECT @exec_protocol_sql_text; PREPARE c_sql FROM @exec_protocol_sql_text; EXECUTE c_sql; DEALLOCATE PREPARE c_sql; SET @disable_all_prot_trg = NULL; END LOOP; CLOSE cur; END$</span></span></code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ูููู ุงูุฅุฌุฑุงุก </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">set_prot_snapshot_id ุจุชุฏููุฑ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ุชุบููุฑุงุช ุงูุจุฑูุชูููู ููุฎูู / ูู ุนุจุฑ ูุทุงู ุงููุนุฑู</font></font><br><div class="spoiler" style=";text-align:right;direction:rtl"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">set_prot_snapshot_id</font></font></b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="sql hljs">DELIMITER $ <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> set_prot_snapshot_id$ <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> set_prot_snapshot_id(p_beg_prot_id <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span>, p_end_prot_id <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span>, direction <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> p_prot_id <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> done <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">FALSE</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> cur <span class="hljs-keyword"><span class="hljs-keyword">CURSOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> p.id <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> protocol p <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> p.id &gt;= p_beg_prot_id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> (p.id &lt;= p_end_prot_id <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> p_end_prot_id <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> p.id * direction ; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> CONTINUE <span class="hljs-keyword"><span class="hljs-keyword">HANDLER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOUND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> done = <span class="hljs-literal"><span class="hljs-literal">TRUE</span></span>; OPEN cur; read_loop: LOOP FETCH cur INTO p_prot_id; IF done THEN LEAVE read_loop; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CALL</span></span> exec_protocol(p_prot_id, <span class="hljs-keyword"><span class="hljs-keyword">SIGN</span></span>(direction)); <span class="hljs-comment"><span class="hljs-comment">--  direction = -2,       IF direction = -2 THEN DELETE FROM protocol WHERE id = p_prot_id; END IF; END LOOP; CLOSE cur; END$</span></span></code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ูููู ุงูุฅุฌุฑุงุก </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">set_prot_snapshot_date ุจุฅุฑุฌุงุน</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ุงูุชุบููุฑุงุช / ููุงุช ุจุฑูุชูููู ุฎูุงู ูุชุฑุฉ</font></font><br><br><div class="spoiler" style=";text-align:right;direction:rtl"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">set_prot_snapshot_date</font></font></b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="sql hljs">DELIMITER $ <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> set_prot_snapshot_date$ <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> set_prot_snapshot_date(p_beg_date <span class="hljs-built_in"><span class="hljs-built_in">TIMESTAMP</span></span>, p_end_date <span class="hljs-built_in"><span class="hljs-built_in">TIMESTAMP</span></span>, direction <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> beg_prot_id <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> end_prot_id <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> beg_prot_id := (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> protocol <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> &gt;= p_beg_date <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> end_prot_id := (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> protocol <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> &lt;= p_end_date <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">CALL</span></span> set_prot_snapshot_id(beg_prot_id, end_prot_id, direction); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>$</code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ุงูุขู ูููููุง ุจุณูููุฉ ุงูุญุตูู ุนูู ุชูุฑูุฑ ูุจูุนุงุช ูุขุฎุฑ ููุนุฏ: </font></font><br><br><pre style=";text-align:right;direction:rtl"> <code class="sql hljs">DELIMITER ; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CALL</span></span> set_prot_snapshot_date(<span class="hljs-string"><span class="hljs-string">'2018-10-09 17:23:47'</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-number"><span class="hljs-number">-1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOW</span></span>() report_time, d.date, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(p.amount * p.price) <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> docs d <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> doc_pos p <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> d.id = p.doc_id <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> d.date; <span class="hljs-keyword"><span class="hljs-keyword">ROLLBACK</span></span>;</code> </pre><br><pre style=";text-align:right;direction:rtl"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">+ --------------------- + ------------ + ------ +
</font></font> |<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">report_time | </font><font style="vertical-align: inherit;">ุงูุชุงุฑูุฎ | </font><font style="vertical-align: inherit;">ุงููุฌููุน |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ --------------------- + ------------ + ------ +</font></font><font></font>
 |<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2018-10-09 17:28:30 | </font><font style="vertical-align: inherit;">2018-07-17 | </font><font style="vertical-align: inherit;">4030 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ --------------------- + ------------ + ------ +</font></font><font></font>
</pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ููุง ุชุฑูู ุ ุชุญูู ุงูุชูุฑูุฑ ุชูุงููุง ููุง ูุงู ูู ุงููุงุถู. </font></font><br>  ูููุฐ ุฐูู ุงูุญูู<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ููุฏ ูุนููุง </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ROLLBACK</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ุ ุฃุตุจุญ ูู ุงูุณูู ุงูุขู ุงูุญุตูู ุนูู ุชูุฑูุฑ ุฌุฏูุฏ:</font></font><br><br><pre style=";text-align:right;direction:rtl"> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOW</span></span>() report_time, d.date, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(p.amount * p.price) <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> docs d <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> doc_pos p <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> d.id = p.doc_id <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> d.date;</code> </pre><br><pre style=";text-align:right;direction:rtl"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">+ --------------------- + ------------ + ------ +
</font></font> |<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">report_time | </font><font style="vertical-align: inherit;">ุงูุชุงุฑูุฎ | </font><font style="vertical-align: inherit;">ุงููุฌููุน |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ --------------------- + ------------ + ------ +</font></font><font></font>
 |<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2018-10-09 17:29:18 | </font><font style="vertical-align: inherit;">2018-07-16 | </font><font style="vertical-align: inherit;">2620 |
</font></font> |<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2018-10-09 17:29:18 | </font><font style="vertical-align: inherit;">2018-07-18 | </font><font style="vertical-align: inherit;">840 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ --------------------- + ------------ + ------ +</font></font><font></font>
</pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ูุง ุงููุธุงุฆู ุงูุชู ูููู ุฃู ูููุฑูุง ุงูุชุณุฌูู: </font></font><br><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ุงููุฏุฑุฉ ุนูู ุชููู ุงูุชูุงุฑูุฑ ูู ุฃู ุชุงุฑูุฎ ูู ุงููุงุถู ุ ุชูุงููุง ููุง ูุงูุช ูู ุฐูู ุงูููุช. </font></font></li><li style=";text-align:right;direction:rtl"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ุงุจุญุซ ุนู ุงููุณุชุฎุฏู ุงูุฐู "ุฃูุณุฏ" ุงูุจูุงูุงุช ุงูููุฌูุฏุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช. </font></font></li><li style=";text-align:right;direction:rtl"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ูุญููุธุงุช ุชุบููุฑ ุจูุงูุงุช Analytics. </font><font style="vertical-align: inherit;">ุนูู ุณุจูู ุงููุซุงู ุ ุณุฑุนุฉ ุชูุฑูุฑ ุงููุณุชูุฏุงุช ูู ุงููุธุงู ุ ูุชุบููุฑ ุงูุญุงูุงุช.</font></font></li><li style=";text-align:right;direction:rtl"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุชุฌุงูู ุงูุชุบููุฑุงุช. </font><font style="vertical-align: inherit;">ุนูู ุณุจูู ุงููุซุงู ุ ุนูุฏ ุญุฐู ูุณุชูุฏ ุจุฏูุงู ูู ุฃุณุฆูุฉ ุฅุถุงููุฉ: "ูู ุชุฑูุฏ ุญููุง ุงูุญุฐูุ" ุ ููููู ุฅุฏุฑุงู ุงููุฏุฑุฉ ุนูู ุฅูุบุงุก ุงูุชุบููุฑ.</font></font></li><li style=";text-align:right;direction:rtl"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ููุญู ุต 4 ุ ุณูุฉ ุ ุฅูุบุงุก ุงูุชุบููุฑุงุช ุ ุงูุชุฑุงุฌุน ุญุณุจ ุชุงุฑูุฎ ุงูุชุบููุฑุงุช ุนูู ุงููุซููุฉ. </font></font></li></ol><br><br><h4 style=";text-align:right;direction:rtl"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> UPD1: ุงุฎุชุจุงุฑ ุงูุฃุฏุงุก </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุฅุฏุฑุงุฌ 10000 ุณุทุฑ ุ 4 ุญููู ููู ุณุทุฑ </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. ูุน ุงููุดุบูุงุช ูุชุณุฌูู ุงูุฏุฎูู - 6.89c </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. ูุน ุงููุดุบูุงุช ุ ูุชู ุชุนุทูู ุงูุชุณุฌูู ุจุฑูุฌููุง - 2.17 ุซุงููุฉ </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3. ุจุฏูู ูุดุบูุงุช - 1.37c</font></font><br><div class="spoiler" style=";text-align:right;direction:rtl"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุงุณุชุนูุงูุงุช SQL</font></font></b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="sql hljs">DELIMITER $ <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> speed_test$ <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> speed_test(n <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> i <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; WHILE i &lt; n <span class="hljs-keyword"><span class="hljs-keyword">DO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> docs (<span class="hljs-keyword"><span class="hljs-keyword">num</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">date</span></span>, warehouse, partner) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">CONCAT</span></span>(<span class="hljs-string"><span class="hljs-string">''</span></span>, i), <span class="hljs-built_in"><span class="hljs-built_in">DATE</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">NOW</span></span>()), <span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-string"><span class="hljs-string">', '</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> i := i + <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHILE</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>$ <span class="hljs-comment"><span class="hljs-comment">-- 1.     DELIMITER ; BEGIN; CALL speed_test(10000); ROLLBACK; MariaDB [test-habr]&gt; DELIMITER ; MariaDB [test-habr]&gt; BEGIN; Query OK, 0 rows affected (0.00 sec) MariaDB [test-habr]&gt; CALL speed_test(10000); Query OK, 1 row affected (6.89 sec) MariaDB [test-habr]&gt; ROLLBACK; Query OK, 0 rows affected (0.88 sec) -- 2.  ,    DELIMITER ; BEGIN; SET @disable_all_prot_trg = 1; CALL speed_test(10000); SET @disable_all_prot_trg = NULL; ROLLBACK; MariaDB [test-habr]&gt; DELIMITER ; MariaDB [test-habr]&gt; BEGIN; Query OK, 0 rows affected (0.00 sec) MariaDB [test-habr]&gt; SET @disable_all_prot_trg = 1; Query OK, 0 rows affected (0.00 sec) MariaDB [test-habr]&gt; CALL speed_test(10000); Query OK, 1 row affected (2.17 sec) MariaDB [test-habr]&gt; SET @disable_all_prot_trg = NULL; Query OK, 0 rows affected (0.00 sec) MariaDB [test-habr]&gt; ROLLBACK; Query OK, 0 rows affected (0.12 sec) -- 3.   DELIMITER ; DROP TRIGGER IF EXISTS docs_aft_ins_trg; BEGIN; CALL speed_test(10000); ROLLBACK; MariaDB [test-habr]&gt; DELIMITER ; MariaDB [test-habr]&gt; DROP TRIGGER IF EXISTS docs_aft_ins_trg; Query OK, 0 rows affected (0.00 sec) MariaDB [test-habr]&gt; BEGIN; Query OK, 0 rows affected (0.00 sec) MariaDB [test-habr]&gt; CALL speed_test(10000); Query OK, 1 row affected (1.37 sec) MariaDB [test-habr]&gt; ROLLBACK; Query OK, 0 rows affected (0.12 sec)</span></span></code> </pre><br></div></div><br><br><h4 style=";text-align:right;direction:rtl"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> UPD2: ุฃูุธูุฉ ุจุฏููุฉ </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. </font><font style="vertical-align: inherit;">ุธูุฑุช </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุฌุฏุงูู ุฅุตุฏุงุฑ ุงููุธุงู</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ูู MariaDB 10.3.4 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ูู ุงููุญุชุฑููู: ุงูุญู ุงูุฃุตูู ุงูููุถุญ ูู ูุนูุงุฑ SQL: 2011 ูุนูู ุจุงูุชุฃููุฏ ุจุดูู ุฃูุซุฑ ููุงุกุฉ </font><font style="vertical-align: inherit;">ูู </font><font style="vertical-align: inherit;">ุงูุญู ูู ุงููุดุบูุงุช ุ </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ูุงูุต ูุจูุฑ - ูุง ููููู ูุนุฑูุฉ ูู ุฃุฌุฑู ุชุบููุฑุงุช ุนูู ูุงุนุฏุฉ ุงูุจูุงูุงุช </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">php-Audit</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ุ ุญู ูุดุงุจู ูู ูู ุงููุดุบูุงุช ุ ูุชู ุฅูุดุงุก ุงููุดุบูุงุช ุจูุงุณุทุฉ php </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ูู ุงููุญุชุฑููู: ุชู ุชุตููู ุงูุญู ุจุดูู ุฌููู ุนูู github </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ูู ุงูุณูุจูุงุช: ูุง ูุณูุญ ูุฌูุฏ ุฌุฏูู ุจุฑูุชูููู ูููุตู ููู ูุฏู ุ ุฃููุงู ุ ูู ุงูุณูู ุชุชุจุน ุฌููุน ุฅุฌุฑุงุกุงุช ุงููุณุชุฎุฏู ูููุชุฑุฉ ุ ูุซุงูููุง ุ ูุง ูุฌุนู ูู ุงูุณูู ูุชุงุจุฉ ุงูุจุฑุงูุฌ ุงููุตูุฉ ููุชุฑุงุฌุน DB ูู ูุนููุฉ </font><font style="vertical-align: inherit;">ุงูุฏููุฉ ุงู</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar425769/">https://habr.com/ru/post/ar425769/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar425759/index.html">ูุบุงูุฑุงุช ุณุงูุจูุฑุบ ุงูุฌุฏูุฏุฉ ูู ุฃููุงููุง</a></li>
<li><a href="../ar425761/index.html">ุงุฎุชุจุงุฑ DevDay Pro: ุชุณุฌูู ุงูุชูุงุฑูุฑ</a></li>
<li><a href="../ar425763/index.html">PHP Excel Templator (ูุญุฑู ููุงูุจ PHP ูู Excel) ุฃู ููู ูููุง ุจูุชุงุจุฉ ููุฏ ุซุงุจุช ูู Excel ูู ูุจู</a></li>
<li><a href="../ar425765/index.html">ุขููุฉ ุงูุชูุฏูู - ุงูุณุญุฑ ุงูููุจู ุงูุฎุงุต</a></li>
<li><a href="../ar425767/index.html">Splunk 7.2 ูุง ุงูุฌุฏูุฏุ SmartStore ูุฅุฏุงุฑุฉ ุงูุชุญููู ูุงููุฒูุฏ ...</a></li>
<li><a href="../ar425771/index.html">ูุจุฏุฃ ุงูุนูู ุงูุฃูู ูู ุงููููุงูููุง ุงูุชุญููููุฉ</a></li>
<li><a href="../ar425773/index.html">ููู ูุชุญูู ูู ุงูููุธููู ุงูุจุนูุฏูู</a></li>
<li><a href="../ar425775/index.html">ุฃุชูุชุฉ ุตูุงุนุฉ ุงูุฌูุณ ุฃู ุงูุฎุฏูุงุช ุงูุนุงูุฉ ุจุงููุบุฉ ุงูุฃููุงููุฉ</a></li>
<li><a href="../ar425777/index.html">ุงูุฌูู Z: ููููุฉ ุงูุนูู ูุน ุงูุฃุทูุงู ุจุนูุฑ 20 ุนุงููุง</a></li>
<li><a href="../ar425779/index.html">ููุง ุฃุฎุจุฑุช captcha ุนู ุซุบุฑุฉ Yandex</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>