<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤳🏿 ♣️ 🤩 Nous économisons sur un contrôleur RAID, ou comment nourrir Varia avec Iops 👩🏿‍🤝‍👩🏽 🌸 👌🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="À notre époque des services cloud, AWS Lambda et autres hébergements partagés de ressources informatiques absolument intangibles, je veux parfois un p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Nous économisons sur un contrôleur RAID, ou comment nourrir Varia avec Iops</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/423513/"><img align="right" src="https://habrastorage.org/webt/tk/12/jd/tk12jdebhacj1uexhpnwt0bbzo0.jpeg">  À notre époque des services cloud, AWS Lambda et autres <s>hébergements partagés de</s> ressources informatiques absolument intangibles, je veux parfois un peu de moi-même.  En plus du désir, il est parfois nécessaire de tordre judicieusement l'un ou l'autre produit logiciel avec des coûts de plate-forme minimes.  Vous pouvez presque toujours trouver un équipement en excès, parfois il s'avère même de tout assembler et de l'allumer.  Si ces surplus représentent un processeur avec au moins 4 à 6 cœurs et une mémoire de 64 Go - généralement excellente, vous pouvez utiliser ESXi et travailler avec n'importe quoi.  Un problème: avec une capacité de disque sur le matériel domestique de VMWare - absolument rien.  Les performances des disques durs locaux uniques sont faibles, et perdre le contenu d'une seule vis dans le vide au 21e siècle est comme bonjour.  Essayons de connecter quelque chose sur le réseau. <br><br>  TL; DR&gt; association, équilibrage, limite rr, c'est tout. <br><a name="habracut"></a><br>  En fait, le texte ci-dessous ne concerne pas le fait que cela est généralement possible ou une sorte de savoir-faire.  Internet regorge d'articles pour les nuls (cochez ici, puis Suivant, Suivant, Terminé) sur la façon de soumettre une capacité de disque iSCSI.  J'écris juste pour exclure les «erreurs des survivants» et partager les moments où «tout ira mal» (et ça ira, Murphy avait raison), et quand vous essayez de charger la solution, elle plante tout simplement. <br><br>  Nous allons donc essayer d'étouffer notre "hyperviseur domestique" avec une baie de disques externe connectée sur le réseau.  Étant donné que tout tourne autour de nous «à peu de frais», que ce soit FreeNAS et 4 disques SATA, qui sont desservis par un médiocre 3 GHz à 45 nm pour cent.  Nous regardons Ebay, et pour de l'argent comparable à un contrôleur RAID utilisé, ils en tirent quelques cartes réseau i350-T4.  Ce sont des adaptateurs gigabit à quatre ports d'Intel.  Selon eux, nous associerons le stockage à l'hyperviseur. <br><br>  Comptez un peu.  La vitesse de transfert de données moyenne d'un disque SATA moyen est de 160 à 180 Mo / s avec une largeur d'interface de 6 Go / s.  En fait, le taux de transfert de données réel depuis le disque dur ne dépasse pas 2 Gb / s.  Ce n'est pas un si gros chiffre, étant donné que nous prévoyons des ports 4 gigabits (comment transformer 4x1Gbps en 4Gbps - nous en discuterons plus loin).  Tout avec des vitesses d'accès aléatoire est bien pire - ici, tout tombe presque au niveau des disquettes. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/7y/cn/re/7ycnrez1dwgdr_nsgkti4zjdsjw.png"></div><br>  Étant donné que le profil de charge de disque de nombreux systèmes d'exploitation invités est loin d'être linéaire, j'aimerais voir des chiffres plus amusants.  Pour corriger la situation dans le système de fichiers de l'hyperviseur (VMFS v6), la taille du bloc est de 1 Mo, ce qui permet de compacter de nombreuses opérations aléatoires et accélère l'accès aux données sur les disques virtuels.  Mais même avec cela, un disque physique ne sera pas suffisant pour gérer les opérations d'E / S de tous les "invités". <br><br>  Je ferai une réservation tout de suite - tout est plus logique si vous avez plus de deux adaptateurs pour le "réseau de stockage".  ESXi avec une licence uniprocesseur gratuite peut se connecter, en plus des disques locaux, à deux types de stockage - NFS et iSCSI.  NFS implique un accès au niveau du fichier et est également bon à sa manière.  Sur celui-ci, vous pouvez déployer des invités peu exigeants sur les performances du disque.  C’est un plaisir de les sauvegarder.  vous pouvez ouvrir la même boule NFS ailleurs et copier des instantanés vm.  En général, avec une interface réseau (si ce n'est pas 10GE, bien sûr) - NFS est votre choix. <br><br>  ISCSI présente plusieurs avantages par rapport à NFS.  Afin de les réaliser pleinement, nous avons déjà préparé - ayant déjà prévu 4 ports gigabits pour le réseau de stockage.  Comment l'extension de la bande passante du réseau se produit-elle généralement à une vitesse d'interface connue?  C'est vrai, l'agrégation.  Mais pour l'utilisation complète du canal agrégé, un certain nombre de conditions sont nécessaires, et cela est plus approprié pour la communication entre les commutateurs ou pour une liaison montante réseau d'un hyperviseur.  L'implémentation du protocole iSCSI fournit une fonction telle que le multichemin (littéralement, de nombreux chemins) - la possibilité de connecter le même volume via différentes interfaces réseau.  Bien sûr, sur la possibilité d'équilibrage de charge là aussi, bien que l'objectif principal soit la tolérance aux pannes du réseau de stockage.  (En toute honnêteté, NFSv4.1 prend en charge la jonction de session basée sur la magie la plus avancée telle que RDMA et MPTCP, mais c'est une tentative de déplacer les problèmes d'accès aux fichiers <s>d'une tête douloureuse à une tête saine</s> à des niveaux inférieurs.) <br><br>  Donc, pour commencer, nous publierons notre objectif.  Nous pensons que FreeNAS est installé, l'adresse IP de la direction nous envoie régulièrement l'interface Web, nous coupons le tableau et zvolons dessus en totale conformité avec nos convictions internes.  Dans notre cas, il s'agit d'un lecteur 4 x 500 Go combiné en raidz1 (qui ne donne que 1,3 TiB de capacité effective), et zvol est exactement de 1 To.  Nous allons configurer les interfaces réseau i350, pour plus de simplicité, nous acceptons que tout le monde appartienne à des sous-réseaux différents. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/3f/ci/-b/3fci-bzni4siodupm_admdf8nfe.png"></div><br>  Ensuite, nous configurons la balle iSCSI en utilisant la méthode «Next, Next, Done».  Lors de la configuration du portail, n'oubliez pas d'y ajouter toutes les interfaces réseau dédiées à iSCSI.  Cela devrait ressembler à quelque chose sur les photos. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/uk/4w/hu/uk4whuf8w2gxvts-vxu-3oupyn8.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/yq/pp/wg/yqppwgzsqzxkxkffbatxbgxiiy0.png"></div><br>  Un peu plus d'attention devra être accordée à la définition de l'étendue - lors de la présentation d'un volume, il est nécessaire de forcer une taille de bloc de 512 octets.  Sans cela, l'initiateur ESXi a refusé d'identifier les volumes présentés.  Pour des raisons de fidélité, il est préférable de désactiver les tailles de probros du bloc physique (qui sur zvol n'est pas et ne peut pas l'être) et d'activer le mode de support Xen. <br>  Avec FreeNAS pour l'instant. <br><br>  Côté ESXi, il est un peu plus difficile de configurer un réseau.  Encore une fois, nous pensons que l'hyperviseur lui-même est installé et également géré sur un port séparé.  Vous devrez sélectionner 4 interfaces VM Kernel appartenant à 4 groupes de ports différents dans 4 commutateurs virtuels différents.  Chacun de ces commutateurs possède son propre port physique de liaison montante.  Nous prenons les adresses vmk #, bien sûr, dans les sous-réseaux correspondants, de manière similaire à la configuration des ports de stockage.  L'ordre de définition des adresses est, en général, important - soit nous connectons des cartes de port à port sans commutateur, soit nous donnons des liens différents à différents réseaux (enfin, c'est à la manière d'un adulte), donc la correspondance physique des ports est importante. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/qe/hq/ox/qehqoxnpinkpxs1fy2ajiamu7om.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/cn/vr/q1/cnvrq1slbat9sqajuqy0wvudadi.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/3x/ml/1b/3xml1bfwyrzwqqkzmin3pwz4ltw.png"></div><br>  Lors de la configuration d'un réseau pour iSCSI, nous accordons une attention particulière au paramètre MTU.  C'est exactement le cas lorsque «la taille compte» - nous prenons le maximum que tous les composants réseau peuvent installer.  Si les cartes sont connectées directement, vous pouvez pointer le mtu 9000 des deux côtés, sur ESXi et FreeNAS.  Cependant, les commutateurs normaux prendront en charge cette valeur.  On fait un ping, on voit que le réseau est normal, et les paquets de la taille requise passent.  Super.  Nous avons mis le feu à l'initiateur. <br><br>  Activez iSCSI, ajoutez des adresses IP à la section de configuration dynamique (Stockage -&gt; Adaptateurs -&gt; Configurer iSCSI -&gt; Cibles dynamiques).  Après l'enregistrement, les portails iSCSI seront interrogés à ces adresses, l'initiateur déterminera que chacun d'eux a le même volume et s'y connectera à toutes les adresses disponibles (le même chemin d'accès multiple).  Ensuite, nous devons créer une banque de données sur l'appareil qui apparaît. <br><br>  Après cela, vous pouvez déployer la machine virtuelle et mesurer ce que nous avons obtenu. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/4t/hf/bd/4thfbd-txhgteetxgb6zs3gggjo.png"></div><br>  Des résultats pas si impressionnants.  Ouvrez la console de stockage, affichez l'état actuel du réseau et exécutez les tests. <br><br> <code>root@freenas:~ # systat -ifstat</code> <br> <div class="spoiler">  <b class="spoiler_title">Que voyons-nous?</b> <div class="spoiler_text"><pre> <code class="hljs sql"> /0 /1 /2 /3 /4 /5 /6 /7 /8 /9 /10 <span class="hljs-keyword"><span class="hljs-keyword">Load</span></span> Average <span class="hljs-keyword"><span class="hljs-keyword">Interface</span></span> Traffic Peak Total lo0 <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">0.319</span></span> KB/s <span class="hljs-number"><span class="hljs-number">0.893</span></span> KB/s <span class="hljs-number"><span class="hljs-number">3.041</span></span> MB <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-number"><span class="hljs-number">0.319</span></span> KB/s <span class="hljs-number"><span class="hljs-number">0.893</span></span> KB/s <span class="hljs-number"><span class="hljs-number">3.041</span></span> MB alc0 <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">0.478</span></span> KB/s <span class="hljs-number"><span class="hljs-number">1.233</span></span> KB/s <span class="hljs-number"><span class="hljs-number">3.934</span></span> MB <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-number"><span class="hljs-number">0.412</span></span> KB/s <span class="hljs-number"><span class="hljs-number">1.083</span></span> KB/s <span class="hljs-number"><span class="hljs-number">2.207</span></span> MB igb3 <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">0.046</span></span> KB/s <span class="hljs-number"><span class="hljs-number">0.105</span></span> KB/s <span class="hljs-number"><span class="hljs-number">181.434</span></span> KB <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-number"><span class="hljs-number">0.073</span></span> KB/s <span class="hljs-number"><span class="hljs-number">0.196</span></span> KB/s <span class="hljs-number"><span class="hljs-number">578.396</span></span> KB igb2 <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">0.046</span></span> KB/s <span class="hljs-number"><span class="hljs-number">0.105</span></span> KB/s <span class="hljs-number"><span class="hljs-number">120.963</span></span> KB <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-number"><span class="hljs-number">0.096</span></span> KB/s <span class="hljs-number"><span class="hljs-number">0.174</span></span> KB/s <span class="hljs-number"><span class="hljs-number">517.221</span></span> KB igb1 <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">4.964</span></span> MB/s <span class="hljs-number"><span class="hljs-number">121.255</span></span> MB/s <span class="hljs-number"><span class="hljs-number">10.837</span></span> GB <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-number"><span class="hljs-number">6.426</span></span> MB/s <span class="hljs-number"><span class="hljs-number">120.881</span></span> MB/s <span class="hljs-number"><span class="hljs-number">3.003</span></span> GB igb0 <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">0.046</span></span> KB/s <span class="hljs-number"><span class="hljs-number">0.105</span></span> KB/s <span class="hljs-number"><span class="hljs-number">139.123</span></span> KB <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-number"><span class="hljs-number">0.073</span></span> KB/s <span class="hljs-number"><span class="hljs-number">0.210</span></span> KB/s <span class="hljs-number"><span class="hljs-number">869.938</span></span> KB</code> </pre><br></div></div><br>  Un seul des quatre ports réseau (igb1) a été utilisé.  Cela se produit car le mécanisme d'équilibrage fourni par défaut pour les trajets multiples sélectionne le même adaptateur avec chaque paquet de données.  Nous devons utiliser de tout. <br>  Nous sommes connectés à l'hyperviseur via SSH et commande. <br>  Voyons d'abord quel ID la lune a avec les trajets multiples et comment cela fonctionne: <br><br> <code>[root@localhost:~] esxcfg-mpath -b <br> naa.6589cfc000000b478db42ca922bb9308 : FreeNAS iSCSI Disk (naa.6589cfc000000b478db42ca922bb9308) <br> <br> [root@localhost:~] esxcli storage nmp device list -d naa.6589cfc000000b478db42ca922bb9308 | grep PSP <br> Path Selection Policy: VMW_PSP_MRU</code> <br> <br>  La politique de sélection de chemin est MRU, c'est-à-dire la plus récemment utilisée.  Toutes les données vont au même port, la resélection du chemin ne se produit que lorsque la connexion réseau n'est pas disponible.  On passe au round-robin, dans lequel toutes les interfaces changent tour à tour après un certain nombre d'opérations: <br><br> <code>[root@localhost:~] esxcli storage nmp device set -d naa.6589cfc000000b478db42ca922bb9308 -P VMW_PSP_RR</code> <br> <br>  Nous redémarrons ESXi, ouvrons la surveillance, exécutons des tests.  Nous voyons que la charge est répartie uniformément sur les adaptateurs réseau (au moins les valeurs de pointe, trop grattées), les résultats des tests sont également plus amusants. <br><br><img align="right" src="https://habrastorage.org/webt/pg/au/ov/pgauovsykzwhnis_ustnqqp-d_y.png"><pre> <code class="hljs delphi"> <span class="hljs-keyword"><span class="hljs-keyword">Interface</span></span> Peak igb3 <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">43.233</span></span> MB/s <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-number"><span class="hljs-number">46.170</span></span> MB/s igb2 <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">42.806</span></span> MB/s <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-number"><span class="hljs-number">45.773</span></span> MB/s igb1 <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">43.495</span></span> MB/s <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-number"><span class="hljs-number">45.489</span></span> MB/s igb0 <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">43.208</span></span> MB/s <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-number"><span class="hljs-number">46.079</span></span> MB/s</code> </pre> <br>  Il y a quelques écarts sur les ports, cela est dû aux limites de la stratégie de sélection de chemin - le nombre d'opérations ou d'octets, après quoi le passage à un autre port a lieu.  Par défaut, 1000 IOPS, c'est-à-dire que si l'échange de données est dans les 999 opérations, il passera par un port réseau.  Vous pouvez modifier, comparer et sélectionner la valeur appropriée.  Vous ne pouvez pas changer, la valeur par défaut est suffisante pour la plupart des tâches. <br><br>  Nous prenons des mesures, testons, travaillons.  Les résultats sont nettement supérieurs aux capacités d'un seul disque, de sorte que nos machines virtuelles ne peuvent plus être coudées lors d'opérations d'E / S.  Les vitesses et la tolérance aux pannes résultantes de la baie dépendent du matériel et de la configuration du volume. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr423513/">https://habr.com/ru/post/fr423513/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr423501/index.html">Recherche et création de style visuel pour un projet de design</a></li>
<li><a href="../fr423503/index.html">Mon expérience de déménagement, de vie et d'études en Allemagne</a></li>
<li><a href="../fr423505/index.html">Zuckerberg vend des actions Facebook pour 13 milliards de dollars afin que «nos enfants ne tombent jamais malades»</a></li>
<li><a href="../fr423507/index.html">Comment économiser de la mémoire sur les onglets du navigateur, mais ne pas perdre leur contenu. L'expérience de l'équipe Yandex.Browser</a></li>
<li><a href="../fr423511/index.html">Interception de l'installation de Firefox et Chrome sur Windows 10</a></li>
<li><a href="../fr423515/index.html">Est-ce que DRY est bon ou peut-il casser O de SOLID</a></li>
<li><a href="../fr423519/index.html">Monstre errant: comment se débarrasser des problèmes sur la carte</a></li>
<li><a href="../fr423521/index.html">Sept règles de base pour expérimenter avec des sites Web</a></li>
<li><a href="../fr423523/index.html">Capteur combiné, avec préférence et poètes</a></li>
<li><a href="../fr423527/index.html">Les applications pour enfants collectent massivement des données personnelles et les transmettent à des tiers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>