<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üí• üö£üèº üîê H√©bergement du serveur https Node.js avec SSL mis √† jour automatiquement dans le cloud et comment configurer le cycle de d√©veloppement (+ git, react) üé™ üåê üíÉüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pr√©face 
 Pour commencer, j'ai un jour voulu cr√©er une application. Ce d√©sir est n√© parce que j'aime lire, mais il n'y a tout simplement pas d'agr√©gat...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>H√©bergement du serveur https Node.js avec SSL mis √† jour automatiquement dans le cloud et comment configurer le cycle de d√©veloppement (+ git, react)</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/439952/"><h2>  Pr√©face </h2><br>  Pour commencer, j'ai un jour voulu cr√©er une application.  Ce d√©sir est n√© parce que j'aime lire, mais il n'y a tout simplement pas d'agr√©gateurs de livres normaux dans le vaste Internet russe.  En fait, de la douleur de chercher quelque chose √† lire et d'essayer de rappeler le nom du livre que j'ai lu r√©cemment et dans quel chapitre je me suis arr√™t√©, le d√©sir est n√© de cr√©er une application web dans laquelle tout cela serait possible et pratique.  Il est √† noter qu'aucune exp√©rience en d√©veloppement, programmation, etc.  Je n‚Äôen avais pas, mon travail n‚Äôy est pas du tout li√©.  N√©anmoins, le d√©sir a surmont√© la paresse et s'est transform√© en actions concr√®tes, une sorte de passe-temps. <br><br>  Je ne dirai pas comment j'ai √©tudi√© javascript, node.js, react, html, css, etc., nous allons passer √† ce √† quoi je suis arriv√© en ce moment, ce que je voudrais partager avec vous et, bien s√ªr, √©couter les critiques constructives des sp√©cialistes. <br><br>  Comme beaucoup, je me suis entra√Æn√© sur mon propre PC sur localhost: 3000, cr√©√© des front-end / back-end, typographi√©, travaill√© avec des api, etc., mais j'√©tais toujours inquiet par la pens√©e de comment transf√©rer tout cela vers l'h√©bergement plus tard?  Cela fonctionnera-t-il?  Sera-t-il n√©cessaire de r√©√©crire le code √† cause de cela?  <b>Et surtout, est-il possible de tout configurer pour que je puisse travailler sur l'application depuis n'importe quel PC et tout transf√©rer facilement vers l'h√©bergement en production?</b>  <b>Je vais en parler.</b> <br><a name="habracut"></a><br><h2>  Choix d'h√©bergement </h2><br>  Pour mon hobby, j'√©tais pr√™t √† d√©penser 10 $ par mois, j'ai donc choisi l'h√©bergement avec lequel je comptais rester √† l'avenir.  Comme je l'ai dit, avant cela, je n'avais aucune exp√©rience, y compris avec l'h√©bergement de sites.  J'ai essay√© et refus√© ce qui suit: <br><br>  <b>Jelastic</b> : <b>interface</b> belle et conviviale, tout semble intuitif, √©volutif et compr√©hensible.  N√©anmoins, j'ai rencontr√© des difficult√©s pour configurer (nginx pour une raison quelconque ne voulait pas travailler √† partir de vps, uniquement avec leur module s√©par√©) et connecter SSL (et la mise √† jour automatique) au domaine russophone par des moyens standard (ils ont promis de corriger le bogue, mais je ne veux pas attendre) <br><br>  <b>H√©bergement cloud REG.RU</b> : J'ai √©galement un domaine l√†-bas, donc la solution semblait logique, mais ils n'avaient pas PostgreSQL configur√© s√©par√©ment, et comme je ne voulais pas contacter l'administration de la base de donn√©es, j'ai commenc√© √† chercher plus loin. <br><br>  <b>AWS et Google Clouds</b> : j'ai essay√©, tout semble aller bien, mais je me suis souvenu de nos ¬´merveilleuses¬ª lois et de l'obligation de mettre les donn√©es des utilisateurs sur des serveurs en F√©d√©ration de Russie.  Malheureusement, ces gars-l√† n'avaient pas de serveurs en F√©d√©ration de Russie.  Pas un avocat, mais du p√©ch√© a d√©cid√© de rechercher des nuages ‚Äã‚Äãavec des serveurs dans la F√©d√©ration de Russie.  <b>S'il est peu probable que votre demande rencontre des probl√®mes avec la loi, alors un bon choix.</b> <br><br>  Bien qu'il y ait des nuages ‚Äã‚Äãavec des serveurs dans la F√©d√©ration de Russie, je voulais toujours quelque chose qui m'√©viterait de devoir plonger dans l'administration PostgreSQL.  L'impulsion est <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">tomb√©e</a> il y a peu sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Yandex.Clouds</a> qui sont devenus disponibles, j'ai essay√©, il semble que tout soit simple et pratique, alors je me suis arr√™t√© sur eux pour l'instant.  Il convient de noter que l'h√©bergement PostgreSQL est imm√©diatement livr√© avec 1core et 4 Go de RAM, ce qui co√ªte environ 2k roubles par mois, donc pour le temps de d√©veloppement et de faible charge, je pr√©vois d'ex√©cuter PostgreSQL sur VPS pendant ~ 300r, et de transf√©rer la base de donn√©es avec une charge accrue et de laisser Yandex s'occupe de l'administration et de la mise √† jour. <br><br><h2>  Configuration de Yandex.Cloud </h2><br><h3>  Cloud priv√© virtuel </h3><br>  1) Cr√©ez un annuaire pour votre site: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/35e/3de/581/35e3de5819d0344d34cc9a03251cbf65.png" alt="image"><br><br>  2) Cr√©ez un cloud priv√© virtuel: <br><br>  La principale chose qu'il me donne au stade actuel est l'IP pour acc√©der √† la ressource cr√©√©e de l'ext√©rieur.  Je me suis familiaris√© superficiellement avec les sous-r√©seaux, les zones, l'isolement et la tol√©rance aux pannes, si n√©cessaire je rattraperai mon retard. <br><br>  3) Cr√©ez un sous-r√©seau et attribuez-lui une adresse IP interne (si je comprends bien, c'est comme un r√©seau local) <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f25/42d/f6c/f2542df6c7141d6e96738f6f1d3e6cf1.png" alt="image"><br><br>  4) Allez dans l'onglet IP et r√©servez-vous une IP statique. <br><br>  Sur celui-ci, nous nous connecterons depuis la maison et d'autres endroits.  Vous pouvez probablement travailler avec dynamique, mais je n'ai pas compris dans quels cas cela change. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/47c/ef6/265/47cef626515785d83ba86cb6f5f8c185.png" alt="image"><br><br><h3>  Nuage de calcul </h3><br>  Ici, nous aurons des calculs :) Autrement dit, nous allons cr√©er une machine virtuelle avec Linux (j'ai choisi ubuntu 18.04), installer les applications node.js et postgreSQL. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/265/293/e0c/265293e0c462dd9dd2452874799c2157.png" alt="image"><br><br>  Nous cliquons pour cr√©er une VM, d√©visser tous les param√®tres au minimum, car il n'y aura pas de charge pendant le d√©veloppement (lorsque notre application sera publi√©e, puis tourner un peu plus, eh bien, nous surveillerons par les graphiques). <br><br><h4>  Ssh </h4><br>  Le probl√®me que j'ai rencontr√© √† ce stade est SSH: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/687/476/389/68747638934544e751f6a0b21f43e683.png" alt="image"><br><br>  Ce que c'√©tait et pourquoi je n'en avais aucune id√©e, alors je suis all√© √©tudier.  Il s'est av√©r√© - ce n'est qu'une m√©thode d'acc√®s, mais pas par mot de passe, mais par la cl√© SSH g√©n√©r√©e.  Pour le g√©n√©rer, t√©l√©chargez et installez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Putty</a> comme il nous est conseill√©. <br><br>  Ex√©cutez C: \ Program Files \ PuTTY \ puttygen.exe <br><br><img src="https://habrastorage.org/getpro/habr/post_images/333/03a/e02/33303ae02d9b14983cf0627087dfd8ee.png" alt="image"><br><br>  Nous appuyons sur le bouton G√©n√©rer et d√©pla√ßons la souris pour donner un caract√®re al√©atoire √† la cl√© g√©n√©r√©e (si je comprends bien).  Ensuite, copiez la ligne qui appara√Æt en commen√ßant par ssh-rsa quelque part dans le fichier texte et cliquez sur Enregistrer la cl√© priv√©e, Enregistrer la cl√© publique.  La cl√© copi√©e dans le fichier texte est ins√©r√©e dans le champ SSH de la cl√© de la page Yandex Yandex.  Nous sp√©cifions root comme identifiant de connexion, sinon vous n'aurez pas acc√®s lorsque vous travaillerez avec le syst√®me de fichiers graphiques de l'application par laquelle vous vous connecterez au cloud depuis votre domicile / travail (il y a peut-√™tre un moyen, mais je n'ai pas compris). <br>  <b>Comme l'a not√© andreymal, il vaut mieux ne pas utiliser root pour que les bots chinois ne r√©cup√®rent pas le mot de passe pour votre cloud, mais comme dans Yandex.cloud l'acc√®s se fait uniquement via SSH, vous pouvez vivre comme √ßa.</b> <b><br><br></b>  <b>Une application sur un h√©bergement doit √™tre lanc√©e exclusivement par un utilisateur non root, afin de ne pas permettre aux attaquants d'ex√©cuter du code malveillant √† travers d'√©ventuelles vuln√©rabilit√©s de votre application.</b> <b><br></b> <br><br><h3>  Nous nous connectons au cloud depuis un PC et s√©lectionnons un client SSH gratuit </h3><br>  Le Putty standard vous permet de travailler uniquement sur la ligne de commande, et comme je ne connais pas bien l'utilisateur Windows, j'ai commenc√© √† chercher un client avec un pseudo-explorateur.  Au d√©but, j'ai essay√© Mobaxterm, mais apr√®s un certain temps d'inactivit√©, il s'arr√™te, l'explorateur se bloque compl√®tement, alors maintenant je travaille avec <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">bitvise ssh</a> et jusqu'√† pr√©sent, je ne vois pas de probl√®mes comme Mobaxterm. <br><br><h3>  Configurer bitvise ssh </h3><br><img src="https://habrastorage.org/getpro/habr/post_images/8a2/019/f4c/8a2019f4cafa7b44ef72286664175010.png" alt="image"><br><br>  Ici, dans le champ Serveur&gt; H√¥te, indiquez notre cloud IP externe.  Port 22. Cliquez sur Gestionnaire de cl√©s client&gt; Importer et sp√©cifiez la cl√© priv√©e pr√©c√©demment g√©n√©r√©e dans celui-ci.  Vous aurez peut-√™tre encore besoin d'une phrase cl√©, choisissez quelque chose que vous n'oublierez pas.  Fermez cette fen√™tre et sp√©cifiez le nom d'utilisateur dans le champ d'authentification: racine, cl√© publick de m√©thode, cl√© client - s√©lectionnez celle pr√©c√©demment import√©e.  Cliquez sur connexion et si nous avons tout fait correctement, puis connectez-vous au cloud: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b4b/e6a/a9d/b4be6aa9df15651829c0b23749f18b41.png" alt="image"><br><br><h2>  Installez Node.js </h2><br>  Ici, je recommande d'utiliser les instructions de digitalocean.com, elles sont tr√®s d√©taill√©es et beaucoup sont en russe.  Habituellement, je google "digitalocean ubuntu 18.04 node.js" ou tout ce que vous voulez y installer ou configurer. <br><br>  Comment installer Node.js peut √™tre lu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . <br><br>  En bref, nous allons √† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">nodeource</a> (ici les derni√®res versions de node.js peuvent √™tre install√©es), feuilletez ici: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3ad/aa7/0c9/3adaa70c90a1466c1a55b71eb25f2105.png" alt="image"><br><br>  Copiez et ex√©cutez les commandes tour √† tour: <br><br><pre><code class="javascript hljs">curl -sL https:<span class="hljs-comment"><span class="hljs-comment">//deb.nodesource.com/setup_11.x | sudo -E bash - sudo apt-get install -y nodejs</span></span></code> </pre> <br>  Nous v√©rifions comment il a √©t√© √©tabli par l'√©quipe <br><br><pre> <code class="javascript hljs">nodejs -v</code> </pre> <br>  Nous verrons la version de node.js <br><br><pre> <code class="javascript hljs">npm -v</code> </pre> <br>  Nous verrons la version du gestionnaire de paquets pour node.js. <br><br>  Ensuite, allez dans le dossier / opt / mysuperapp (my_super_app_name - vous devez cr√©er ce dossier).  Le r√©pertoire opt a √©t√© choisi comme emplacement de l'application apr√®s une longue recherche sur ¬´o√π il convient de placer les fichiers node.js de l'application dans ubuntu¬ª. <br><br>  Enfin, cr√©ez le fichier server.js, qui sera le point d'entr√©e de l'application, et collez-y le code serveur simple sur node.js: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> http = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'http'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> hostname = <span class="hljs-string"><span class="hljs-string">'localhost'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> port = <span class="hljs-number"><span class="hljs-number">80</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> server = http.createServer(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res</span></span></span><span class="hljs-function">) =&gt;</span></span> { res.statusCode = <span class="hljs-number"><span class="hljs-number">200</span></span>; res.setHeader(<span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>, <span class="hljs-string"><span class="hljs-string">'text/plain'</span></span>); res.end(<span class="hljs-string"><span class="hljs-string">'Hello World!\n'</span></span>); }); server.listen(port, hostname, () =&gt; { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">`Server running at http://</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${hostname}</span></span></span><span class="hljs-string">:</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${port}</span></span></span><span class="hljs-string">/`</span></span>); });</code> </pre> <br>  Le port 80 est pour les requ√™tes http, 443 est pour https.  Alors que nous avons un serveur sur http. <br><br>  Nous enregistrons tout et ex√©cutons la commande: <br><br><pre> <code class="plaintext hljs">node server.js</code> </pre> <br>  La console doit afficher la ligne ¬´Serveur en cours d'ex√©cution sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">localhost</a> : 80 /¬ª <br><br>  Vous pouvez maintenant ouvrir un navigateur, saisir une IP externe (celle dans le cloud Yandex de votre machine virtuelle ubuntu) et nous verrons "Bonjour tout le monde!" <br><br><h2>  Nous faisons tout facilement ou le cycle de d√©veloppement avec git </h2><br>  Tout semble fonctionner, mais nous ne travaillerons pas tout le temps √† nous connecter au cloud.  De plus, tout d'un coup, nous ne travaillerons plus seuls √† l'avenir. <br><br><h2>  Github </h2><br>  Github est l'endroit o√π se trouve le code de notre application.  En bref, le principe du travail pour une personne est le suivant: <br><br><ul><li>  Nous d√©veloppons notre application sur un PC domestique. </li><li>  Nous enregistrons et d√©chargeons le code sur Github en un clic. </li><li>  Sur l'h√©bergement ou sur un autre PC, t√©l√©chargez notre application depuis github, red√©marrez le serveur (s'il h√©berge) et la nouvelle version de notre application web est disponible sur le World Wide Web. </li></ul><br>  Tout est rapide, simple et pratique. <br><br>  Inscrivez-vous sur Github et cr√©ez un r√©f√©rentiel priv√© pour notre application (il ne sera disponible que pour nous): <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a10/e93/4b3/a10e934b3516444c1c8aad1b45035494.png" alt="image"><br><br>  Copiez la ligne <a href="">github.com/ReTWi/mysuperapp.git</a> pour t√©l√©charger l'application. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/465/959/824/4659598241a27171fbbaa8e61c3a66c2.png" alt="image"><br><br><ol><li>  Nous revenons √† la ligne de commande bitvise, arr√™tons l'application en appuyant sur ctrl + c (si cela fonctionne toujours). </li><li>  Acc√©dez au r√©pertoire / opt et supprimez le dossier avec l'application que nous avons cr√©√©e </li></ol><br>  Git est ce que nous utiliserons pour t√©l√©charger notre application sur github, et de l√† vers un h√©bergement ou un autre PC.  Git est un sujet de discussion distinct, alors nous allons nous attarder sur cela pour l'instant. <br>  Installez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">git sur l'h√©bergement</a> avec les commandes suivantes: <br><br><pre> <code class="javascript hljs">sudo apt update sudo apt install git</code> </pre> <br>  V√©rifiez si tout est bien √©tabli: <br><br><pre> <code class="javascript hljs">git --version</code> </pre> <br>  La version git devrait appara√Ætre. <br><br>  Nous remplissons les donn√©es git (je n'ai pas compris pourquoi, mais apparemment il peut y avoir des avertissements ennuyeux). <br><br><pre> <code class="javascript hljs">git config --global user.name <span class="hljs-string"><span class="hljs-string">"Your Name"</span></span> git config --global user.email <span class="hljs-string"><span class="hljs-string">"youremail@domain.com"</span></span></code> </pre> <br>  Enfin, nous t√©l√©chargeons notre application sur l'h√©bergement avec la commande: <br>  (il devrait y avoir un lien vers votre candidature) <br><br><pre> <code class="javascript hljs">git clone https:<span class="hljs-comment"><span class="hljs-comment">//github.com/ReTWi/mysuperapp.git</span></span></code> </pre> <br>  Un nouveau mysuperapp appara√Ætra dans le r√©pertoire / opt, o√π se trouveront nos fichiers d'application t√©l√©charg√©s depuis github. <br><br>  Il est maintenant temps de r√©p√©ter la m√™me chose pour PC et de fermer la cha√Æne PC (diff√©rente) -&gt; Github -&gt; H√©bergement <br><br>  Installez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">node.js sur le PC</a> . <br><br><h2>  Code Visual Studio </h2><br>  Pour commencer, s√©lectionnez l'√©diteur de code source o√π nous travaillerons.  J'ai choisi le code Visual studio, il est donc simple, pratique, il a beaucoup de plugins et vous pouvez configurer la synchronisation des param√®tres si vous travaillez avec plusieurs appareils.  En fait, nous t√©l√©chargeons, installons, lan√ßons, s√©lectionnons le dossier d'application partag√©, car git clone cr√©era le sien pour nous. <br><br>  Les plugins que j'utilise sont les suivants: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7e5/5c2/17f/7e55c217f685490573a70f44970e0780.png" alt="image"><br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Installez git pour PC</a> . <br>  Ouvrez une console dans VScode en utilisant ctrl + shift + `ou terminal&gt; nouveau terminal <br><br>  <i>Retraite:</i> <i><br><br></i>  <i>Dans la console Windows, c'est mauvais avec les caract√®res russes, pour qu'il n'y ait pas de fissures dont vous avez besoin pour ouvrir le fichier&gt; pr√©f√©rences&gt; param√®tres, entrez terminal.integrated.shellArgs.windows dans le champ, cliquez sur</i> <i><br><br><img src="https://habrastorage.org/getpro/habr/post_images/a70/787/6a5/a707876a56e4c0a2b601358d4aa7caf1.png" alt="image"><br><br></i>  <i>Et ajoutez la ligne "terminal.integrated.shellArgs.windows": ["-NoExit", "/ c", "chcp 65001"],</i> <i><br><br><img src="https://habrastorage.org/getpro/habr/post_images/57d/217/da6/57d217da62d4189b8640eb854f07a8a0.png" alt="image"></i> <br><br>  R√©p√©tez la commande pour t√©l√©charger des fichiers depuis github: <br><br><pre> <code class="javascript hljs">git clone https:<span class="hljs-comment"><span class="hljs-comment">//github.com/ReTWi/mysuperapp.git</span></span></code> </pre> <br>  Dans VScode, cliquez sur Fichier&gt; Ouvrir un dossier et ouvrez le dossier de notre application. <br><br>  Cr√©ez le fichier server.js avec le m√™me code de serveur simple: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> http = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'http'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> hostname = <span class="hljs-string"><span class="hljs-string">'localhost'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> port = <span class="hljs-number"><span class="hljs-number">80</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> server = http.createServer(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res</span></span></span><span class="hljs-function">) =&gt;</span></span> { res.statusCode = <span class="hljs-number"><span class="hljs-number">200</span></span>; res.setHeader(<span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>, <span class="hljs-string"><span class="hljs-string">'text/plain'</span></span>); res.end(<span class="hljs-string"><span class="hljs-string">'Hello World!\n'</span></span>); }); server.listen(port, hostname, () =&gt; { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">`Server running at http://</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${hostname}</span></span></span><span class="hljs-string">:</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${port}</span></span></span><span class="hljs-string">/`</span></span>); });</code> </pre> <br>  Installez nodemon pour red√©marrer automatiquement le serveur lorsque des modifications sont apport√©es au code: <br><br><pre> <code class="javascript hljs">npm i nodemon -g</code> </pre> <br>  i - court pour installer <br>  g - installation globale (disponible dans la console), et pas seulement pour notre application. <br><br>  Ex√©cutez la commande: <br><br><pre> <code class="javascript hljs">nodemon server.js</code> </pre> <br>  Ouvrez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">localhost</a> : 80 / dans le navigateur ou simplement localhost: 80 et voyez Hello World. <br><br>  Il est maintenant temps de consulter notre cha√Æne PC&gt; Github&gt; H√©bergement. <br><br>  T√©l√©chargez le bureau Github pour plus de commodit√©, connectez votre compte Github, puis cliquez sur le fichier d'ajout de r√©f√©rentiel local et sp√©cifiez le r√©pertoire de notre application. <br><br>  Dans l'application, nous voyons les modifications que nous avons apport√©es par rapport √† la version t√©l√©charg√©e depuis Github (nous avons ajout√© server.js): <br><br><img src="https://habrastorage.org/getpro/habr/post_images/568/3d0/52b/5683d052b9fbba8fe609035fd8ba253f.png" alt="image"><br><br>  Cliquez sur "commit to master"&gt; "push origin", t√©l√©chargeant ainsi les fichiers du PC vers Github. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/eeb/234/bf6/eeb234bf61a0ed5b2708b196e32da7d8.png" alt="image"><br><br>  Nous allons sur notre compte github dans le navigateur et voyons le fichier server.js t√©l√©charg√©: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1e6/cf8/e1b/1e6cf8e1b08c5a15d596193dd8b0efb3.png" alt="image"><br><br>  Pratiquons un peu plus, dans VScode nous rempla√ßons la ligne ¬´res.end ('Hello World! \ N');"  √† "res.end ('OmNomNom');".  Nous verrons que le serveur lui-m√™me a red√©marr√©: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8c8/8cc/a53/8c88cca53e4d8d15632cc49e183817e7.png" alt="image"><br><br>  Nous v√©rifierons dans le navigateur et y verrons les modifications que nous avons apport√©es "OmNomNom". <br><br>  Desktop github nous montrera √©galement que nous avons chang√© la ligne: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/020/39b/7a0/02039b7a00fabe3c07037f6a356c1919.png" alt="image"><br><br>  Encore une fois, cliquez sur commit to master&gt; push origin pour envoyer des fichiers √† github. <br><br>  Basculez vers la ligne de commande d'h√©bergement. <br><br>  Nous arr√™tons notre application si elle est toujours en cours d'ex√©cution (ctrl + c). <br><br>  T√©l√©chargez notre application mise √† jour avec les commandes suivantes: <br><br><pre> <code class="javascript hljs">git config credential.helper store git pull</code> </pre><br>  Le premier enregistrera nos donn√©es afin que vous n'ayez pas √† saisir constamment votre nom d'utilisateur et votre mot de passe.  √Ä l'avenir, git pull nous suffira. <br><br>  Installez pm2 - quelque chose de similaire √† nodemon, uniquement pour l'h√©bergement: <br><br><pre> <code class="javascript hljs">npm i pm2 -g</code> </pre> <br>  Commen√ßons l'application en utilisant pm2, qui red√©marrera notre serveur au prochain pull git sur l'h√©bergement: <br><br><pre> <code class="javascript hljs">pm2 start server.js --watch</code> </pre> <br>  Ouvrez le navigateur sur notre cloud IP externe et consultez notre ¬´OmNomNom¬ª. <br><br>  Ainsi, nous avons ferm√© la cha√Æne de travail avec l'application et son d√©ploiement rapide sur l'h√©bergement. <br><br><h2>  Nous cr√©ons des certificats SSL temporaires pour HTTPS sur l'h√¥te local et l'h√©bergement </h2><br>  Nous allons sur le site <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">zerossl.com</a> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/151/be3/00c/151be300c4226e87b30b7f4735e09c83.png" alt="image"><br><br>  Dans le champ domaines, ip ..., entrez d'abord localhost, cliquez sur g√©n√©rer et t√©l√©charger 2 fichiers par bouton: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8a1/b4d/24a/8a1b4d24a65f44c3ba5a604a569e1811.png" alt="image"><br><br>  Nous les enregistrons dans notre projet dans le dossier ssl / localhost. <br><br>  R√©p√©tez la proc√©dure pour le cloud IP externe et enregistrez-le dans ssl / myapp. <br><br><h2>  Lancer un serveur https plus complexe node.js </h2><br>  Structure d'application: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/330/6da/e58/3306dae5836d651136b030b2cc64041e.png" alt="image"><br><br><ul><li>  client - ici notre front-end mentira.  J'ai r√©agi. </li><li>  logs - les logs sur l'h√©bergement seront d√©pos√©s ici </li><li>  node_modules - modules node.js </li><li>  priv√© - vos fichiers priv√©s, j'y stocke l'acc√®s SSH au cloud </li><li>  le serveur est votre backend </li><li>  ssl - certificats SSL pour travailler https sur localhost et h√©bergement </li><li>  .babelrc - param√®tres de construction de l'application webpack'om react (vous permet d'utiliser un JS plus moderne lors du d√©veloppement du frontend) </li><li>  .gitignore - fichiers qui ne seront pas d√©plac√©s vers github (git ne semble pas les voir) </li><li>  client.js - point d'entr√©e pour g√©n√©rer l'assembly React </li><li>  package.json - les node_modeles que vous utilisez et divers extraits de commande. </li><li>  package-lock.json - changements dans les modules (si je comprends bien, le fichier v√©rifiera si les m√™mes modules sont install√©s sur votre h√©bergement et sur votre PC). </li><li>  pm2-watch.json - Param√®tres de d√©marrage de pm2 pour l'h√©bergement </li><li>  README.md - couverture pour github </li><li>  server.js - le point de d√©part de notre serveur backend Node.js </li><li>  webpack.config.js - r√©agit √† la configuration de build </li></ul><br><h3>  .gitignore </h3><br>  Ici, nous indiquons les fichiers / dossiers que nous ne voulons pas t√©l√©charger sur github.  Ils ne seront que sur cet appareil et git ne suivra / affichera pas leurs modifications.  Ouvrez et ins√©rez: <br><br><pre> <code class="javascript hljs">/node_modules/ <span class="hljs-regexp"><span class="hljs-regexp">/logs/</span></span>* # exception to the rule !logs/.gitkeep /public/react_bundle.js /public/isProd.js</code> </pre> <br>  Puisque github ne d√©charge pas les dossiers vides, vous pouvez mettre quelque chose √† l'int√©rieur, par exemple, un fichier .gitkeep vide.  Enregistrez le fichier et fermez. <br><br><h3>  package.json </h3><br>  Ouvrez et collez ce qui suit (apr√®s // ajout de commentaires) <br><br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"myapp"</span></span>, <span class="hljs-comment"><span class="hljs-comment">//    "version": "1.0.0", "description": "OmNomNom", "main": "server.js", "scripts": { "server": "pm2 start pm2-watch.json", //  npm run server     "client": "webpack -w --mode development", //  npm client    .        ,   . "client-prod": "webpack --mode production", //     production "client-analyze": "webpack --mode production --analyze true" //     production       .    }, "repository": { "type": "git", "url": "git+https://github.com/myapp/knigam.git" //     github }, "author": "rtw", "license": "UNLICENSED", //     ( ) "bugs": { "url": https://github.com/myapp/knigam.git" }, "homepage": "https://github.com/myapp/knigam.git#readme", "dependencies": { "@babel/core": "^7.2.2", //  js  frontend "@babel/plugin-transform-runtime": "^7.2.0", //  js  frontend "@babel/preset-env": "^7.3.1", //  js  frontend "@babel/preset-react": "^7.0.0", //  js  frontend "ajv": "^6.8.1", //    "babel-loader": "^8.0.5", //  js  frontend "babel-plugin-styled-components": "^1.10.0", //   styled-components "css-loader": "^2.1.0", //   webpack'om css "fastify": "^2.0.0-rc.6", //  express,      "fastify-cookie": "^2.1.6", //    "fastify-static": "^2.2.0", //     "moment": "^2.24.0", //    "pg": "^7.8.0", //    "pino": "^5.11.1", //   postgreSQL  node.js "pino-pretty": "^2.5.0", //     "react": "^16.8.1", // Frontend .      Vue.js,    .      ,     "react-dom": "^16.8.1", // React     "style-loader": "^0.23.1", //   webpack'om ,    "styled-components": "^4.1.3", // CSS in JS,           "webpack": "^4.29.3", //    "webpack-bundle-analyzer": "^3.0.3", //       "webpack-cli": "^3.2.3" //    ,     } }</span></span></code> </pre><br>  Je me concentrerai sur deux principaux frameworks / biblioth√®ques s√©lectionn√©s pour l'application: <br>  Fastify a √©t√© choisi comme alternative √† express.js, puisque le premier a d√©j√† un support exp√©rimental pour htpp2, il se d√©veloppe activement et il me semble qu'il a plus d'avenir que express.js, qui est devenu tr√®s lent et en quelque sorte en d√©veloppement.  D'un autre c√¥t√©, express.js fonctionne depuis longtemps et il vous sera plus facile de trouver des informations √† ce sujet. <br><br>  React a √©t√© choisi parce qu'il √©tait plus facile pour moi de travailler avec, de comprendre et d'essayer tout de mes propres mains.  Vue - cela semblait quelque chose avec ses propres r√®gles, direction.  Bien que dans Vue, il puisse √™tre n√©cessaire d'√©crire quelque chose de moins de vos propres mains, mais comme la priorit√© est accord√©e √† la formation et √† une personne qui n'a pas programm√© auparavant, la r√©action est devenue plus facile. <br><br>  Nous enregistrons le fichier package.json et installons tous les modules sp√©cifi√©s dans les d√©pendances avec la commande: <br><br><pre> <code class="javascript hljs">npm i</code> </pre> <br>  Nous aurons un dossier node_modules, dans lequel il y aura tous les modules pour notre application. <br><br>  client - tandis que le dossier vide <br>  logs - √† l'int√©rieur du fichier .gitkeep se trouve, de sorte que le dossier migre vers l'h√©bergement et que les journaux y parviennent avec succ√®s.  Pendant le d√©veloppement, nous afficherons tout sur la console. <br><br><h3>  public </h3><br>  Ici se trouvent les fichiers statiques de notre site, des images, des favicons, etc. <br>  Arr√™tons-nous sur deux dossiers: <br>  index.html: <br><br><pre> <code class="javascript hljs">&lt;!DOCTYPE html&gt; &lt;html&gt; &lt;head&gt; &lt;base href="/" /&gt; &lt;meta charset="UTF-8" /&gt; &lt;title&gt;MyApp&lt;/title&gt; &lt;/head&gt; &lt;body&gt; &lt;div id="cookies"&gt;    react_bundle   &lt;/div&gt; &lt;noscript &gt;:       Javscript&lt;/noscript &gt; &lt;script src="react_bundle.js"&gt;&lt;/script&gt; &lt;/body&gt; &lt;/html&gt;</code> </pre> <br>  - ici, nous avons un front-end r√©actif charg√© et rendu dans une balise par son id. <br><br>  isProd.js contient une seule ligne "module.exports = false" <br>  Comme il fait partie des exceptions .gitignore, il n'est pas portable.  En cons√©quence, nous l'avons d√©fini sur false sur le PC et vrai sur l'h√©bergement.  Ensuite, nous utilisons ce fichier pour comprendre dans quel environnement nous sommes actuellement (d√©veloppement / production).  Il m'a sembl√© le plus pratique, en plus, vous pouvez modifier partiellement le code lors du d√©veloppement et v√©rifier le fonctionnement des modules en production. <br><br>  ssl - il existe des certificats pr√©c√©demment enregistr√©s dans les dossiers localhost et myapp <br><br><h3>  .babelrc </h3><br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"presets"</span></span>: [ [ <span class="hljs-string"><span class="hljs-string">"@babel/preset-env"</span></span>, { <span class="hljs-string"><span class="hljs-string">"targets"</span></span>: { <span class="hljs-string"><span class="hljs-string">"browsers"</span></span>: [<span class="hljs-string"><span class="hljs-string">"&gt;0.25%"</span></span>, <span class="hljs-string"><span class="hljs-string">"not ie 11"</span></span>, <span class="hljs-string"><span class="hljs-string">"not op_mini all"</span></span>] } } ], <span class="hljs-string"><span class="hljs-string">"@babel/preset-react"</span></span> ], <span class="hljs-string"><span class="hljs-string">"plugins"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"babel-plugin-styled-components"</span></span>, <span class="hljs-string"><span class="hljs-string">"@babel/plugin-transform-runtime"</span></span> ] }</code> </pre><br>  Param√®tres de cr√©ation de notre react_bundle avec prise en charge du navigateur utilis√© par plus de 0,25% des utilisateurs. <br><br><h3>  client.js </h3><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> React <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { render } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react-dom'</span></span> render(<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">!!</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span>, <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">'cookies'</span></span>))</code> </pre> <br><br>  Rend notre frontend dans un div avec une √©tiquette de cookie. <br><br>  pm2-watch.json - vous permet d'ex√©cuter le serveur avec la commande "npm run server" sur l'h√©bergement avec le suivi des modifications du code et le red√©marrage automatique. <br><br><h3>  webpack.config.js </h3><br>  Constructeur d'application de r√©acteur: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> webpack = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'webpack'</span></span>), path = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'path'</span></span>), BundleAnalyzerPlugin = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'webpack-bundle-analyzer'</span></span>).BundleAnalyzerPlugin <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">env, argv</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> prod = argv.mode == <span class="hljs-string"><span class="hljs-string">'production'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> config = { <span class="hljs-attr"><span class="hljs-attr">entry</span></span>: <span class="hljs-string"><span class="hljs-string">'./client.js'</span></span>, <span class="hljs-attr"><span class="hljs-attr">output</span></span>: { <span class="hljs-attr"><span class="hljs-attr">path</span></span>: path.resolve(<span class="hljs-string"><span class="hljs-string">'./public'</span></span>), <span class="hljs-attr"><span class="hljs-attr">filename</span></span>: <span class="hljs-string"><span class="hljs-string">'react_bundle.js'</span></span> }, <span class="hljs-attr"><span class="hljs-attr">module</span></span>: { <span class="hljs-attr"><span class="hljs-attr">rules</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">test</span></span>: <span class="hljs-regexp"><span class="hljs-regexp">/\.(js|jsx)$/</span></span>, <span class="hljs-attr"><span class="hljs-attr">exclude</span></span>: <span class="hljs-regexp"><span class="hljs-regexp">/node_modules/</span></span>, <span class="hljs-attr"><span class="hljs-attr">loader</span></span>: <span class="hljs-string"><span class="hljs-string">'babel-loader'</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">test</span></span>: <span class="hljs-regexp"><span class="hljs-regexp">/\.css$/</span></span>, <span class="hljs-attr"><span class="hljs-attr">use</span></span>: [<span class="hljs-string"><span class="hljs-string">'style-loader'</span></span>, <span class="hljs-string"><span class="hljs-string">'css-loader'</span></span>] } ] }, <span class="hljs-attr"><span class="hljs-attr">resolve</span></span>: { <span class="hljs-attr"><span class="hljs-attr">alias</span></span>: { <span class="hljs-attr"><span class="hljs-attr">client</span></span>: path.resolve(<span class="hljs-string"><span class="hljs-string">'./client/shared'</span></span>), <span class="hljs-attr"><span class="hljs-attr">public</span></span>: path.resolve(<span class="hljs-string"><span class="hljs-string">'./public'</span></span>) } }, <span class="hljs-attr"><span class="hljs-attr">plugins</span></span>: [ argv.analyze ? <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BundleAnalyzerPlugin() : <span class="hljs-literal"><span class="hljs-literal">false</span></span>, prod ? <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> webpack.optimize.AggressiveMergingPlugin() : <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> webpack.ContextReplacementPlugin(<span class="hljs-regexp"><span class="hljs-regexp">/moment[\/\\]locale$/</span></span>, /ru/) ].filter(<span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>), <span class="hljs-attr"><span class="hljs-attr">optimization</span></span>: { <span class="hljs-attr"><span class="hljs-attr">minimize</span></span>: prod ? <span class="hljs-literal"><span class="hljs-literal">true</span></span> : <span class="hljs-literal"><span class="hljs-literal">false</span></span> }, <span class="hljs-attr"><span class="hljs-attr">performance</span></span>: { <span class="hljs-attr"><span class="hljs-attr">hints</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span> } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> config }</code> </pre><br>  En bref, il ouvre le fichier client.js et tout ce qu'il contient, collectant react_bundle et le pla√ßant dans le dossier public, d'o√π il sera charg√© via le fichier ouvert index.html. <br><br><h3>  server.js </h3><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> isProd = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./public/isProd'</span></span>), fs = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'fs'</span></span>), log = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./server/logger'</span></span>), path = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'path'</span></span>) <span class="hljs-comment"><span class="hljs-comment">//   node.js,      process.on('unhandledRejection', (reason, promise) =&gt; { log.error({ reason, promise }, '  unhandledRejection') }) process.on('uncaughtException', err =&gt; { log.error({ err }, '  uncaughtException') }) // Redirect server from http port 80 to https 443 const fastifyHttp = require('fastify')({ logger: log, ignoreTrailingSlash: true }) fastifyHttp.listen(80, '::', (err, address) =&gt; { if (err) { log.error({ err, address }, '   HTTP ') } else { log.warn('Http c ') } }) // Let's Encrypt challenge fastifyHttp.get('/.well-known/acme-challenge/:file', (req, res) =&gt; { let stream = fs.createReadStream( path.join(__dirname + '/ssl/.well-known/acme-challenge/' + req.params.file) ) res.type('text/html').send(stream) }) fastifyHttp.get('/*', (req, res) =&gt; { res.redirect(301, 'https://' + req.headers.host + req.raw.url) }) fastifyHttp.get('/', (req, res) =&gt; { res.redirect(301, 'https://' + req.headers.host + req.raw.url) }) //  let fastifyOptions = { logger: log, ignoreTrailingSlash: true, http2: true } fastifyOptions.https = isProd ? { allowHTTP1: true, key: fs.readFileSync('./ssl/myapp/key.txt'), cert: fs.readFileSync('./ssl/myapp/crt.txt') } : { allowHTTP1: true, key: fs.readFileSync('./ssl/localhost/cert.key'), cert: fs.readFileSync('./ssl/localhost/cert.pem') } const fastify = require('fastify')(fastifyOptions) fastify.listen(443, '::', (err, address) =&gt; { if (err) { log.error({ err, address }, '   ') } else { log.warn( `   ${ isProd ? '' : ' ' }` ) } }) //  fastify.setSchemaCompiler(schema =&gt; { return ajv.compile(schema) }) //  fastify fastify.setErrorHandler((err, req, res) =&gt; { log.error({ err, req }, 'fastify errorHandler') //     if (err.validation) { return res.send({ error: '   ' }) } else { return res.send({ error: ' errorHandler' }) } }) //   fastify.register(require('fastify-static'), { root: path.join(__dirname, './public') }) //  fastify.register(require('fastify-cookie'), err =&gt; { if (err) log.error({ err }, 'fastify-cookie') }) //       /   //       index.html,     //        api,   GET /api/userdata fastify.setNotFoundHandler((req, res) =&gt; { res.sendFile('index.html') }) // Routes fastify.register( async openRoutes =&gt; { //    openRoutes.register(require('./server/api/open')) openRoutes.register(async withSession =&gt; { //         //    , : ///withSession.addHook('preHandler', async (req, res) =&gt; { // if (!(await sessionManagerIsOk(req, res))) return // }) withSession.register(require('./server/api/with_session')) }) }, { prefix: '/api' } //    )</span></span></code> </pre><br><h3>  Dossier du serveur </h3><br>  Ici se trouve le backend et toutes les voies. <br>  logger.js - en fonction de l'environnement, isProd se connecte √† la console ou √† errors.log <br><br><pre> <code class="javascript hljs"><span class="hljs-meta"><span class="hljs-meta">'use strict'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> pino = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'pino'</span></span>), isProd = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../public/isProd'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> logOptions = isProd ? { <span class="hljs-attr"><span class="hljs-attr">level</span></span>: <span class="hljs-string"><span class="hljs-string">'warn'</span></span>, <span class="hljs-comment"><span class="hljs-comment">//   timestamp: () =&gt; { return ',"time":"' + new Date() + '"' } } : { level: 'warn', prettifier: require('pino-pretty'), prettyPrint: { levelFirst: true, translateTime: true } } let dest = isProd ? pino.destination('./logs/errors.log') : pino.destination(1) let log = pino(logOptions, dest) module.exports = log</span></span></code> </pre><br>  serveur / api / <br>  open.js - ajoutez nos chemins ici. <br><br><pre> <code class="javascript hljs"><span class="hljs-meta"><span class="hljs-meta">'use strict'</span></span> <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">fastify, options, next</span></span></span><span class="hljs-function">) </span></span>{ fastify.route({ <span class="hljs-attr"><span class="hljs-attr">method</span></span>: <span class="hljs-string"><span class="hljs-string">'GET'</span></span>, <span class="hljs-attr"><span class="hljs-attr">url</span></span>: <span class="hljs-string"><span class="hljs-string">'/'</span></span>, <span class="hljs-attr"><span class="hljs-attr">handler</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> (req, res) =&gt; { res.send(<span class="hljs-string"><span class="hljs-string">'api / route'</span></span>) } }) fastify.route({ <span class="hljs-attr"><span class="hljs-attr">method</span></span>: <span class="hljs-string"><span class="hljs-string">'GET'</span></span>, <span class="hljs-attr"><span class="hljs-attr">url</span></span>: <span class="hljs-string"><span class="hljs-string">'/hi'</span></span>, <span class="hljs-attr"><span class="hljs-attr">handler</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> (req, res) =&gt; { res.send(<span class="hljs-string"><span class="hljs-string">'api / route hi'</span></span>) } }) next() }</code> </pre> <br>  Apr√®s avoir configur√© et v√©rifi√© tout sur Localhost, nous t√©l√©chargeons simplement tout sur github, et √† partir de l√†, git pull vers l'h√©bergement.  Tout ce qui doit √™tre fait sur l'h√©bergement est d'installer les modules node.js avec la commande "npm i" et de cr√©er le fichier isProd.js <br><br><h2>  SSL mis √† jour automatiquement </h2><br>  Lorsque vous achetez un domaine et le liez au cloud IP, un exemple d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">instructions pour REG.RU</a> , vous pouvez installer sur le serveur SSL mis √† jour automatiquement et gratuitement pour que le site fonctionne via https. <br><br>  Notre serveur fonctionne sans nginx.  Nous en aurons peut-√™tre besoin √† l'avenir en tant qu'√©quilibreur de charge ou serveur HTTP plus rapide pour la distribution de fichiers statiques, mais jusqu'√† pr√©sent, je n'en vois pas la n√©cessit√©.  Nous n'avons pas encore besoin d'√©quilibrage de charge, mais je n'ai pas trouv√© de comparaison concernant la vitesse de distribution de la statique. <br><br>  Avant d'installer dans le dossier ssl, cr√©ez le dossier .well-known, et dans celui-ci acme-challenge.  Il s'av√®re que /opt/myapp/ssl/.well-known/acme-challenge <br><br>  Pour installer SSL mis √† jour automatiquement sur un serveur avec node.js sans nginx <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">, cliquez sur le lien</a> .  √Ä son tour, ex√©cutez les commandes dans la console d'h√©bergement: <br><br><pre> <code class="javascript hljs">sudo apt-get update sudo apt-get install software-properties-common sudo add-apt-repository universe sudo add-apt-repository ppa:certbot/certbot sudo apt-get update sudo apt-get install certbot sudo certbot certonly</code> </pre><br>  Nous s√©lectionnons la deuxi√®me m√©thode de v√©rification, qui placera un fichier sp√©cifique dans le dossier /opt/myapp/ssl/.well-known/acme-challenge, et apr√®s confirmation du propri√©taire du serveur, il sera supprim√©. <br><br>  Nous indiquons notre domaine sur demande, par exemple: "example.com" et le chemin vers le dossier ssl de notre application (le serveur est configur√© pour donner le fichier cr√©√© par le bot) "/ opt / myapp / ssl". <br><br>  Le bot configurera lui-m√™me la t√¢che cron pour renouveler le certificat avant son expiration dans les 90 jours. <br><br>  Je ne pensais pas qu'il faudrait autant de temps pour tout √©crire, √† 4 heures du matin, j'aurais d√©j√† pu manquer quelque chose: / <br><br>  Int√©ressant est l'opinion des Habrachiens et des sp√©cialistes qui ont ma√Ætris√© cette toile ou lu certains points individuels.  Comment est organis√© votre cycle de d√©veloppement?  Y a-t-il des points sur lesquels je me trompe ou fais la mauvaise chose? </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr439952/">https://habr.com/ru/post/fr439952/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr439942/index.html">Docker: ce que tout d√©veloppeur .Net doit savoir</a></li>
<li><a href="../fr439944/index.html">SAPUI5 for dummies part 5: Un exercice complet √©tape par √©tape</a></li>
<li><a href="../fr439946/index.html">Pourquoi avons-nous choisi Electron</a></li>
<li><a href="../fr439948/index.html">Intel SVT-AV1: Encodeur Open Source AV1 pour usage intensif</a></li>
<li><a href="../fr439950/index.html">3e test de Turing: conditions de participation et prix aux gagnants</a></li>
<li><a href="../fr439958/index.html">CodeFest X 30-31 mars. Section future</a></li>
<li><a href="../fr439962/index.html">Nous travaillons avec Atlassian Service Desk, nous tirons le meilleur parti du plug-in Riada Insight - un rapport de la r√©union du groupe d'utilisateurs Atlassian</a></li>
<li><a href="../fr439964/index.html">Vuln√©rabilit√© Runc CVE-2019-5736 dans un h√¥te</a></li>
<li><a href="../fr439966/index.html">Analyseur simple pour les op√©rations arithm√©tiques</a></li>
<li><a href="../fr439968/index.html">Espace de g√©n√©ration et espace d'opportunit√©</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>