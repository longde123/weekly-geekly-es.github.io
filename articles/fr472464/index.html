<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§ûüèæ üêÖ ‚≠êÔ∏è 5 fa√ßons de cr√©er un serveur Python sur un Raspberry Pi 2e partie ‚úÖ üìõ ü§üüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Salut, Habr. 

 Aujourd'hui, nous allons continuer √† √©tudier les capacit√©s r√©seau du Raspberry Pi, ou plut√¥t leur impl√©mentation en Python. Dans la pr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>5 fa√ßons de cr√©er un serveur Python sur un Raspberry Pi 2e partie</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/472464/">  Salut, Habr. <br><br>  Aujourd'hui, nous allons continuer √† √©tudier les capacit√©s r√©seau du Raspberry Pi, ou plut√¥t leur impl√©mentation en Python.  Dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">premi√®re partie,</a> nous avons examin√© les fonctions de base du serveur Web le plus simple fonctionnant sur le Raspberry Pi.  Nous allons maintenant aller plus loin et envisager plusieurs fa√ßons de rendre notre serveur interactif. <br><br><img src="https://habrastorage.org/webt/el/mj/q2/elmjq2v_pe9vuinjagdxacuz2u0.png"><br><br>  L'article est con√ßu pour les d√©butants. <a name="habracut"></a><br><br>  Avant de commencer quelques notes. <br><br>  Premi√®rement, je doutais moi-m√™me de continuer et je m'attendais √† <i>un</i> plus grand flux de critiques et √† de faibles notes, mais comme l'enqu√™te l'a montr√© dans la premi√®re partie, 85% des lecteurs ont trouv√© les informations fournies utiles.  Je comprends que certains articles professionnels pour les "nuls" sont ennuyeux, mais ils ont tous commenc√© une fois, vous devez donc attendre. <br><br>  Deuxi√®mement, j'√©crirai sur la programmation, pas sur l'administration.  Les probl√®mes de configuration de Raspbian, des configurations, du VPN, de la s√©curit√© et d'autres choses ne seront donc pas pris en compte ici.  Bien que cela soit √©galement important, on ne peut pas embrasser l'immense.  Il ne s'agira que de Python et de la fa√ßon de cr√©er un serveur dessus. <br><br>  Ceux qui ne sont pas int√©ress√©s peuvent cliquer sur le bouton de retour dans le navigateur d√®s maintenant et ne pas perdre leur temps pr√©cieux;) <br><br>  Et nous allons commencer. <br><br>  Permettez-moi de vous rappeler que dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">partie pr√©c√©dente,</a> nous avons fini par lancer un simple serveur Web sur le Raspberry Pi, affichant une page statique: <br><br><img src="https://habrastorage.org/webt/9y/ur/j9/9yurj9o1c452hvs930r3kdlpyng.png" alt="image"><br><br>  Nous allons maintenant aller plus loin et rendre notre serveur interactif, ajouter un contr√¥le LED √† la page Web.  Bien s√ªr, au lieu de la LED, il peut y avoir tout autre appareil qui peut √™tre contr√¥l√© par GPIO, mais avec la LED, il est le plus facile de mener une exp√©rience. <br><br><h2>  La pr√©paration </h2><br>  Je ne d√©crirai pas comment connecter la LED au Raspberry Pi, tout le monde peut le trouver dans Google en 5 minutes.  Nous allons √©crire plusieurs fonctions pour utiliser GPIO √† la fois, que nous ins√©rerons ensuite dans notre serveur. <br><br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> RPi.GPIO <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> GPIO <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> ModuleNotFoundError: <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> led_pin = <span class="hljs-number"><span class="hljs-number">21</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">raspberrypi_init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: GPIO.setmode(GPIO.BCM) GPIO.setup(led_pin, GPIO.OUT) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rasperrypi_pinout</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pin: int, value: bool)</span></span></span><span class="hljs-function">:</span></span> print(<span class="hljs-string"><span class="hljs-string">"LED ON"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> value <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-string"><span class="hljs-string">"LED OFF"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: GPIO.output(pin, value) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rasperrypi_cleanup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: GPIO.cleanup() <span class="hljs-keyword"><span class="hljs-keyword">except</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span></code> </pre> <br>  Comme vous pouvez le voir, chaque fonction d'appel GPIO est ¬´envelopp√©e¬ª dans un bloc try-catch.  Pourquoi est-ce fait?  Cela vous permet de d√©boguer le serveur sur n'importe quel PC, y compris Windows, ce qui est assez pratique.  Nous pouvons maintenant ins√©rer ces fonctions dans le code du serveur Web. <br><br>  Notre t√¢che consiste √† ajouter des boutons √† la page Web qui nous permettent de contr√¥ler la LED √† partir du navigateur.  3 voies de mise en ≈ìuvre seront envisag√©es. <br><br><h2>  M√©thode 1: faux </h2><br>  Cette m√©thode ne peut pas √™tre qualifi√©e de belle, mais elle est courte et la plus facile √† comprendre. <br><br>  Cr√©ez une ligne avec une page HTML. <br><br><pre> <code class="python hljs">html = <span class="hljs-string"><span class="hljs-string">'''&lt;html&gt; &lt;style&gt;html{font-family: Helvetica; display:inline-block; margin: 0px auto; text-align: center;} .button_led {display: inline-block; background-color: #e7bd3b; border: none; border-radius: 4px; color: white; padding: 16px 40px; text-decoration: none; font-size: 30px; margin: 2px; cursor: pointer;} &lt;/style&gt; &lt;body&gt; &lt;h2&gt;Hello from the Raspberry Pi!&lt;/h2&gt; &lt;p&gt;&lt;a href="/led/on"&gt;&lt;button class="button button_led"&gt;Led ON&lt;/button&gt;&lt;/a&gt;&lt;/p&gt; &lt;p&gt;&lt;a href="/led/off"&gt;&lt;button class="button button_led"&gt;Led OFF&lt;/button&gt;&lt;/a&gt;&lt;/p&gt; &lt;/body&gt; &lt;/html&gt;'''</span></span></code> </pre> <br>  Il y a 3 points √† noter ici: <br><br><ul><li>  Nous utilisons CSS pour sp√©cifier le style des boutons.  Vous ne pourriez pas faire cela et vous contenter de seulement 4 lignes de code HTML, mais notre page ressemblerait alors √† des "salutations des ann√©es 90": <br><br><img src="https://habrastorage.org/webt/cc/fc/qu/ccfcquo-kundjijwwobgpqpea_c.png"></li><li>  Pour chaque bouton, nous cr√©ons un lien local comme / led / on et / led / off </li><li>  M√©langer les ressources et le code est un mauvais style de programmation, et id√©alement, le HTML est mieux gard√© s√©par√© du code Python.  Mais mon objectif est de montrer un code fonctionnant au minimum dans lequel il y a un minimum de superflu, donc certaines choses sont omises pour plus de simplicit√©.  De plus, il est pratique lorsque le code peut √™tre simplement copi√© √† partir d'un article, sans aucun probl√®me avec des fichiers suppl√©mentaires. </li></ul><br>  Nous avons d√©j√† examin√© le serveur dans la partie pr√©c√©dente, il reste √† lui ajouter le traitement des lignes '/ led / on' et '/ led / off'.  Code entier mis √† jour: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> http.server <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> BaseHTTPRequestHandler, HTTPServer <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ServerHandler</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(BaseHTTPRequestHandler)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">do_GET</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> print(<span class="hljs-string"><span class="hljs-string">"GET request, Path:"</span></span>, self.path) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self.path == <span class="hljs-string"><span class="hljs-string">"/"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> self.path.endswith(<span class="hljs-string"><span class="hljs-string">"/led/on"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> self.path.endswith(<span class="hljs-string"><span class="hljs-string">"/led/off"</span></span>): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self.path.endswith(<span class="hljs-string"><span class="hljs-string">"/led/on"</span></span>): rasperrypi_pinout(led_pin, <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self.path.endswith(<span class="hljs-string"><span class="hljs-string">"/led/off"</span></span>): rasperrypi_pinout(led_pin, <span class="hljs-keyword"><span class="hljs-keyword">False</span></span>) self.send_response(<span class="hljs-number"><span class="hljs-number">200</span></span>) self.send_header(<span class="hljs-string"><span class="hljs-string">'Content-type'</span></span>, <span class="hljs-string"><span class="hljs-string">'text/html'</span></span>) self.end_headers() self.wfile.write(html.encode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: self.send_error(<span class="hljs-number"><span class="hljs-number">404</span></span>, <span class="hljs-string"><span class="hljs-string">"Page Not Found {}"</span></span>.format(self.path)) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">server_thread</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(port)</span></span></span><span class="hljs-function">:</span></span> server_address = (<span class="hljs-string"><span class="hljs-string">''</span></span>, port) httpd = HTTPServer(server_address, ServerHandler) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: httpd.serve_forever() <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> KeyboardInterrupt: <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> httpd.server_close() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> __name__ == <span class="hljs-string"><span class="hljs-string">'__main__'</span></span>: port = <span class="hljs-number"><span class="hljs-number">8000</span></span> print(<span class="hljs-string"><span class="hljs-string">"Starting server at port %d"</span></span> % port) raspberrypi_init() server_thread(port) rasperrypi_cleanup()</code> </pre><br>  Nous le d√©marrons, et si tout a √©t√© fait correctement, nous pouvons contr√¥ler la LED via notre serveur web: <br><br><img src="https://habrastorage.org/webt/np/f3/ip/npf3ipmqfd-movc084uxpgibhxa.png"><br><br>  Vous pouvez tester le serveur non seulement sur Raspberry Pi, mais aussi sur Windows ou OSX, dans la console il y aura des messages LED ON, LED OFF lorsque vous cliquez sur le bouton correspondant: <br><br><img src="https://habrastorage.org/webt/bf/a1/hn/bfa1hne52ewrqpimi76d4bqyzxq.png"><br><br>  Nous d√©couvrons maintenant pourquoi cette m√©thode est mauvaise et pourquoi elle est "fausse".  Cet exemple fonctionne assez bien et est souvent copi√© dans diff√©rents didacticiels.  Mais il y a deux probl√®mes - tout d'abord, il est faux de recharger toute la page lorsque nous voulons simplement allumer la LED.  Mais c'est toujours la moiti√© du probl√®me.  Le deuxi√®me probl√®me, et plus grave, est que lorsque nous appuyons sur le bouton pour allumer la LED, l'adresse de la page devient <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">http://192.168.1.106:8000/led/on</a> .  Les navigateurs se souviennent g√©n√©ralement de la derni√®re page ouverte, et la prochaine fois que vous ouvrirez le navigateur, la commande pour allumer la LED fonctionnera √† nouveau, m√™me si nous ne le voulions pas.  Par cons√©quent, nous allons passer √† la m√©thode suivante, plus correcte. <br><br><h2>  M√©thode 2: √† droite </h2><br>  Pour tout faire correctement, nous avons mis les fonctions marche / arr√™t de la LED dans des demandes distinctes, et nous les appellerons de mani√®re asynchrone en utilisant Javascript.  Le code HTML de la page ressemblera maintenant √† ceci: <br><br><pre> <code class="python hljs">html = <span class="hljs-string"><span class="hljs-string">'''&lt;html&gt; &lt;style&gt;html{font-family: Helvetica; display:inline-block; margin: 0px auto; text-align: center;} .button_led {display: inline-block; background-color: #e7bd3b; border: none; border-radius: 4px; color: white; padding: 16px 40px; text-decoration: none; font-size: 30px; margin: 2px; cursor: pointer;} &lt;/style&gt; &lt;script type="text/javascript" charset="utf-8"&gt; function httpGetAsync(method, callback) { var xmlHttp = new XMLHttpRequest(); xmlHttp.onreadystatechange = function() { if (xmlHttp.readyState == 4 &amp;&amp; xmlHttp.status == 200) callback(xmlHttp.responseText); } xmlHttp.open("GET", window.location.href + method, true); xmlHttp.send(null); } function ledOn() { console.log("Led ON..."); httpGetAsync("led/on", function(){ console.log("Done"); }); } function ledOff() { console.log("Led OFF..."); httpGetAsync("led/off", function(){ console.log("Done"); }); } &lt;/script&gt; &lt;body&gt; &lt;h2&gt;Hello from the Raspberry Pi!&lt;/h2&gt; &lt;p&gt;&lt;button class="button button_led" onclick="ledOn();"&gt;Led ON&lt;/button&gt;&lt;/p&gt; &lt;p&gt;&lt;button class="button button_led" onclick="ledOff();"&gt;Led OFF&lt;/button&gt;&lt;/p&gt; &lt;/body&gt; &lt;/html&gt;'''</span></span></code> </pre> <br>  Comme vous pouvez le voir, nous avons abandonn√© href, et nous appelons les fonctions ledOn et ledOff, qui √† leur tour appellent les m√©thodes serveur correspondantes de mani√®re asynchrone (des m√©thodes asynchrones sont n√©cessaires pour que la page ne se bloque pas jusqu'√† ce que la r√©ponse du serveur arrive). <br><br>  Reste maintenant √† ajouter le traitement des requ√™tes get au serveur: <br><br><pre> <code class="python hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">do_GET</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> print(<span class="hljs-string"><span class="hljs-string">"GET request, path:"</span></span>, self.path) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self.path == <span class="hljs-string"><span class="hljs-string">"/"</span></span>: self.send_response(<span class="hljs-number"><span class="hljs-number">200</span></span>) self.send_header(<span class="hljs-string"><span class="hljs-string">'Content-type'</span></span>, <span class="hljs-string"><span class="hljs-string">'text/html'</span></span>) self.end_headers() self.wfile.write(html.encode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> self.path == <span class="hljs-string"><span class="hljs-string">"/led/on"</span></span>: self.send_response(<span class="hljs-number"><span class="hljs-number">200</span></span>) self.send_header(<span class="hljs-string"><span class="hljs-string">'Content-type'</span></span>, <span class="hljs-string"><span class="hljs-string">'text/plain'</span></span>) self.end_headers() rasperrypi_pinout(led_pin, <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) self.wfile.write(<span class="hljs-string"><span class="hljs-string">b"OK"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> self.path == <span class="hljs-string"><span class="hljs-string">"/led/off"</span></span>: self.send_response(<span class="hljs-number"><span class="hljs-number">200</span></span>) self.send_header(<span class="hljs-string"><span class="hljs-string">'Content-type'</span></span>, <span class="hljs-string"><span class="hljs-string">'text/plain'</span></span>) self.end_headers() rasperrypi_pinout(led_pin, <span class="hljs-keyword"><span class="hljs-keyword">False</span></span>) self.wfile.write(<span class="hljs-string"><span class="hljs-string">b"OK"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: self.send_error(<span class="hljs-number"><span class="hljs-number">404</span></span>, <span class="hljs-string"><span class="hljs-string">"Page Not Found {}"</span></span>.format(self.path))</code> </pre> <br>  Maintenant, comme vous pouvez le voir, la page ne se recharge plus lorsque vous essayez d'allumer la LED, chaque m√©thode ne fait que ce qu'elle doit faire. <br><br><h2>  M√©thode 3: plus correcte </h2><br>  Tout semble d√©j√† fonctionner.  Mais bien s√ªr, le code ci-dessus peut (et devrait) √™tre am√©lior√©.  Le fait est que nous utilisons les requ√™tes GET pour contr√¥ler la LED.  Cela nous permet d'√©conomiser de l'espace dans le code, mais m√©thodologiquement, ce n'est pas tout √† fait correct - les demandes GET sont con√ßues pour <i>lire les donn√©es</i> du serveur, elles peuvent √™tre mises en cache par le navigateur et ne doivent g√©n√©ralement pas √™tre utilis√©es pour <i>modifier les</i> donn√©es.  La bonne fa√ßon est d'utiliser POST (pour ceux qui sont int√©ress√©s par les d√©tails, plus de d√©tails <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://www.w3schools.com/tags/ref_">ici</a> ). <br><br>  Nous allons modifier les appels en HTML de get √† post, mais en m√™me temps, puisque notre code est asynchrone, nous afficherons l'√©tat d'attente de la r√©ponse du serveur et les r√©sultats du travail.  Pour un r√©seau local, cela ne sera pas visible, mais pour une connexion lente, c'est tr√®s pratique.  Pour le rendre plus int√©ressant, nous utiliserons JSON pour passer des param√®tres. <br><br>  La version finale ressemble √† ceci: <br><br><pre> <code class="python hljs">html = <span class="hljs-string"><span class="hljs-string">'''&lt;html&gt; &lt;style&gt;html{font-family: Helvetica; display:inline-block; margin: 0px auto; text-align: center;} .button_led {display: inline-block; background-color: #e7bd3b; border: none; border-radius: 4px; color: white; padding: 16px 40px; text-decoration: none; font-size: 30px; margin: 2px; cursor: pointer;} &lt;/style&gt; &lt;script type="text/javascript" charset="utf-8"&gt; function httpPostAsync(method, params, callback) { var xmlHttp = new XMLHttpRequest(); xmlHttp.onreadystatechange = function() { if (xmlHttp.readyState == 4 &amp;&amp; xmlHttp.status == 200) callback(xmlHttp.responseText); else callback(`Error ${xmlHttp.status}`) } xmlHttp.open("POST", window.location.href + method, true); xmlHttp.setRequestHeader("Content-Type", "application/json"); xmlHttp.send(params); } function ledOn() { document.getElementById("textstatus").textContent = "Making LED on..."; httpPostAsync("led", JSON.stringify({ "on": true }), function(resp) { document.getElementById("textstatus").textContent = `Led ON: ${resp}`; }); } function ledOff() { document.getElementById("textstatus").textContent = "Making LED off..."; httpPostAsync("led", JSON.stringify({ "on": false }), function(resp) { document.getElementById("textstatus").textContent = `Led OFF: ${resp}`; }); } &lt;/script&gt; &lt;body&gt; &lt;h2&gt;Hello from the Raspberry Pi!&lt;/h2&gt; &lt;p&gt;&lt;button class="button button_led" onclick="ledOn();"&gt;Led ON&lt;/button&gt;&lt;/p&gt; &lt;p&gt;&lt;button class="button button_led" onclick="ledOff();"&gt;Led OFF&lt;/button&gt;&lt;/p&gt; &lt;span id="textstatus"&gt;Status: Ready&lt;/span&gt; &lt;/body&gt; &lt;/html&gt;'''</span></span></code> </pre> <br>  Ajoutez la prise en charge des requ√™tes GET et POST au serveur: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ServerHandler</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(BaseHTTPRequestHandler)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">do_GET</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> print(<span class="hljs-string"><span class="hljs-string">"GET request, path:"</span></span>, self.path) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self.path == <span class="hljs-string"><span class="hljs-string">"/"</span></span>: self.send_response(<span class="hljs-number"><span class="hljs-number">200</span></span>) self.send_header(<span class="hljs-string"><span class="hljs-string">'Content-type'</span></span>, <span class="hljs-string"><span class="hljs-string">'text/html'</span></span>) self.end_headers() self.wfile.write(html.encode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: self.send_error(<span class="hljs-number"><span class="hljs-number">404</span></span>, <span class="hljs-string"><span class="hljs-string">"Page Not Found {}"</span></span>.format(self.path)) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">do_POST</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> content_length = int(self.headers[<span class="hljs-string"><span class="hljs-string">'Content-Length'</span></span>]) body = self.rfile.read(content_length) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: print(<span class="hljs-string"><span class="hljs-string">"POST request, path:"</span></span>, self.path, <span class="hljs-string"><span class="hljs-string">"body:"</span></span>, body.decode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self.path == <span class="hljs-string"><span class="hljs-string">"/led"</span></span>: data_dict = json.loads(body.decode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'on'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> data_dict: rasperrypi_pinout(led_pin, data_dict[<span class="hljs-string"><span class="hljs-string">'on'</span></span>]) self.send_response(<span class="hljs-number"><span class="hljs-number">200</span></span>) self.send_header(<span class="hljs-string"><span class="hljs-string">'Content-type'</span></span>, <span class="hljs-string"><span class="hljs-string">'text/plain'</span></span>) self.end_headers() self.wfile.write(<span class="hljs-string"><span class="hljs-string">b"OK"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: self.send_response(<span class="hljs-number"><span class="hljs-number">400</span></span>, <span class="hljs-string"><span class="hljs-string">'Bad Request: Method does not exist'</span></span>) self.send_header(<span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>, <span class="hljs-string"><span class="hljs-string">'application/json'</span></span>) self.end_headers() <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> Exception <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> err: print(<span class="hljs-string"><span class="hljs-string">"do_POST exception: %s"</span></span> % str(err))</code> </pre> <br>  Comme vous pouvez le voir, nous utilisons maintenant une fonction led, dans laquelle le param√®tre "on" est pass√© en utilisant json, qui accepte True ou False (lorsqu'il est appel√© en HTML, une cha√Æne json de la forme {"on": true} est transmise, respectivement).  Il vaut √©galement la peine de faire attention √† try-catch - cela emp√™che le serveur de tomber, par exemple, si quelqu'un envoie une cha√Æne avec json invalide au serveur. <br><br>  Si tout a √©t√© fait correctement, nous obtenons un serveur avec des commentaires, qui devrait ressembler √† ceci: <br><br><img src="https://habrastorage.org/webt/2b/tz/nv/2btznv4uxbfp8hhu4yxljcbfztc.png"><br><br>  Le feedback, dans notre cas, le message ¬´OK¬ª, vous permet de voir la confirmation du serveur que le code a bien √©t√© trait√©. <br><br>  Ce serveur peut-il encore √™tre am√©lior√©?  Vous pouvez, par exemple, avoir un sens pour remplacer l'utilisation de la fonction d'impression par l'utilisation de la journalisation, c'est plus correct, et vous permet d'afficher les journaux du serveur non seulement √† l'√©cran, mais aussi si vous souhaitez les √©crire dans un fichier avec rotation automatique.  Ceux qui le souhaitent peuvent le faire par eux-m√™mes. <br><br><h2>  Conclusion </h2><br>  Si tout a √©t√© fait correctement, nous aurons un mini-serveur qui vous permettra de contr√¥ler la LED ou tout autre appareil via un navigateur depuis n'importe quel appareil r√©seau. <br><br>  <b>Important: Pr√©cautions de s√©curit√©</b> <br><br>  Encore une fois, je note qu'il n'y a pas de protection ou d'authentification ici, vous ne devez donc pas ¬´publier¬ª une telle page sur Internet si vous pr√©voyez de g√©rer une charge plus ou moins responsable.  Bien que les cas d'attaques contre de tels serveurs ne me soient pas connus, cela ne vaut toujours pas la peine de donner √† quiconque veut pouvoir ouvrir √† distance la porte du garage ou allumer le chauffe-eau.  Si vous souhaitez contr√¥ler √† distance via une telle page, cela vaut la peine de configurer un VPN ou quelque chose de similaire. <br><br>  En conclusion, je r√©p√®te que le mat√©riel est con√ßu pour les d√©butants, et j'esp√®re que cela a √©t√© plus ou moins utile.  Il est clair que tout le monde sur Khabr n'est pas satisfait de la disponibilit√© d'articles "pour les nuls", donc si la prochaine partie d√©pendra ou non des notes finales.  Si tel est le cas, il consid√©rera les frameworks Flask et WSGI, ainsi que les m√©thodes d'authentification de base. <br><br>  Toutes les exp√©riences r√©ussies. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr472464/">https://habr.com/ru/post/fr472464/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr472446/index.html">Comment faire la bonne coloration du code sur "Habr√©" et pourquoi c'est si difficile</a></li>
<li><a href="../fr472448/index.html">Th√®mes de la section Frontend de DUMP Kazan: ML pour un d√©veloppeur front-end, pixel magic, SvelteJS, rires, sueurs et larmes</a></li>
<li><a href="../fr472452/index.html">Comment ajouter la prise en charge de la p√©riode de gr√¢ce (p√©riode de gr√¢ce de facturation) dans l'application iOS?</a></li>
<li><a href="../fr472454/index.html">Pr√©sentation des serveurs VPS bon march√©</a></li>
<li><a href="../fr472462/index.html">iFest √† Nizhny Novgorod: l'informatique est impressionnante</a></li>
<li><a href="../fr472466/index.html">Trier par distribution</a></li>
<li><a href="../fr472468/index.html">ClusterJ - travailler avec MySQL NDB Cluster de Java</a></li>
<li><a href="../fr472470/index.html">Souris transg√©niques et anti-√¢ge</a></li>
<li><a href="../fr472472/index.html">Chalet en hiver: √™tre ou ne pas √™tre?</a></li>
<li><a href="../fr472474/index.html">Bug cosm√©tique dr√¥le dans Google Chrome</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>