<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤘🏼 🤹🏾 👨🏻‍🍳 Remplacement des palettes dans le jeu à l'aide de shaders 🤸🏾 👴🏾 😙</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans ce blog, je vais vous montrer ma technique préférée que j'utilise activement dans mon jeu Vagabond: remplacer les palettes. 

 L'échange de palet...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Remplacement des palettes dans le jeu à l'aide de shaders</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/480836/">  Dans ce blog, je vais vous montrer ma technique préférée que j'utilise activement dans mon jeu Vagabond: remplacer les palettes. <br><br>  L'échange de palette est une modification de la palette de textures.  Dans l'article, nous l'implémentons à l'aide de shaders.  Autrefois, c'était une technique utile, vous permettant d'ajouter de la variabilité aux ressources sans perte inutile de mémoire.  Aujourd'hui, il est utilisé dans la génération procédurale pour créer de nouvelles ressources. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4df/418/f29/4df418f29faf4d4af1e0b2e9583a0be8.gif"></div><br><br><h1>  Préparation d'image </h1><br>  La première étape consiste à préparer les images pour remplacer les palettes.  Dans un <a href="https://en.wikipedia.org/wiki/Raster_graphics">bitmap,</a> chaque pixel contient une couleur, mais nous devons plutôt contenir son index de couleur dans la palette.  Pour cette raison, nous séparerons la structure de l'image (zones de la même couleur) des vraies couleurs. <br><a name="habracut"></a><br>  En fait, certains formats d'image prennent en charge cette méthode de stockage.  Par exemple, <a href="https://en.wikipedia.org/wiki/Portable_Network_Graphics">le format PNG</a> a la possibilité d'enregistrer les couleurs indexées.  Malheureusement, de nombreuses bibliothèques de chargement d'images créent un tableau de couleurs, même si l'image a été enregistrée en mode indexé.  Cela s'applique également à la bibliothèque SFML que j'utilise.  À l'intérieur, il utilise <a href="https://github.com/nothings/stb">stb_image</a> , qui "supprime automatiquement la palette" des images, c'est-à-dire  remplace les index par la couleur de palette correspondante. <br><br>  Par conséquent, pour éviter ce problème, vous devez stocker l'image et la palette séparément.  L'image est enregistrée en nuances de gris et le niveau de gris de chaque pixel correspond à son indice de couleur dans la palette. <br><br>  Voici un exemple de ce que nous espérons recevoir: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/86b/a42/dc5/86ba42dc507bb665992a19724ced1cf1.png"></div><br>  Pour ce faire, j'utilise une petite fonction Python qui utilise la bibliothèque <a href="https://github.com/python-pillow/Pillow">Pillow</a> : <br><br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> numpy <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> np <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> PIL <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Image <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">convert_to_indexed_image</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(image, palette_size)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># Convert to an indexed image indexed_image = image.convert('RGBA').convert(mode='P', dither='NONE', colors=palette_size) # Be careful it can remove colors # Save and load the image to update the info (transparency field in particular) f = io.BytesIO() indexed_image.save(f, 'png') indexed_image = Image.open(f) # Reinterpret the indexed image as a grayscale image grayscale_image = Image.fromarray(np.asarray(indexed_image), 'L') # Create the palette palette = indexed_image.getpalette() transparency = list(indexed_image.info['transparency']) palette_colors = np.asarray([[palette[3*i:3*i+3] + [transparency[i]] \ for i in range(palette_size)]]).astype('uint8') palette_image = Image.fromarray(palette_colors, mode='RGBA') return grayscale_image, palette_image</span></span></code> </pre> <br>  Tout d'abord, la fonction convertit l'image en mode palette.  Elle la réinterprète ensuite comme une image en niveaux de gris.  Récupère ensuite la palette.  Rien de compliqué, le travail principal est effectué par la bibliothèque Pillow. <br><br><h1>  Shader </h1><br>  Après avoir préparé les images, nous sommes prêts à écrire un shader pour remplacer les palettes.  Il existe deux stratégies pour transférer une palette vers un shader: vous pouvez utiliser une texture ou un tableau homogène.  J'ai découvert qu'il est plus facile d'utiliser un tableau homogène, donc je l'ai utilisé. <br><br>  Voici mon shader, je l'ai écrit en GLSL, mais je pense qu'il peut être facilement transféré dans une autre langue pour créer des shaders: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#version 330 core in vec2 TexCoords; uniform sampler2D Texture; uniform vec4 Palette[32]; out vec4 Color; void main() { Color = Palette[int(texture(Texture, TexCoords).r * 255)]; }</span></span></code> </pre> <br>  Nous utilisons simplement une texture pour lire le canal rouge du pixel actuel.  Le canal rouge est une valeur à virgule flottante dans la plage de 0 à 1, nous la multiplions donc par 255 et la convertissons en <code>int</code> pour obtenir le niveau de gris d'origine de 0 à 255, qui est stocké dans l'image.  Ensuite, nous l'utilisons pour obtenir la couleur de la palette. <br><br>  L'animation au début de l'article est tirée de captures d'écran dans le jeu dans lesquelles j'utilise les palettes suivantes pour changer la couleur du corps du personnage: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ac5/15a/ddc/ac515addc2eff6a8b810e0150718de54.png"></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr480836/">https://habr.com/ru/post/fr480836/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr480822/index.html">Comment démarrer avec Bug Bounty</a></li>
<li><a href="../fr480824/index.html">GHIDRA vs. IDA Pro</a></li>
<li><a href="../fr480828/index.html">Framework de microservice PHP</a></li>
<li><a href="../fr480832/index.html">Le travail n'est pas un loup, partie 5. Licenciement: est-ce que je pars magnifiquement?</a></li>
<li><a href="../fr480834/index.html">Serveur VPS avec 1C: un peu élevé?</a></li>
<li><a href="../fr480838/index.html">Les requêtes SQL sont rapides. Partie 1</a></li>
<li><a href="../fr480840/index.html">Cyberattaques contre les systèmes hydroacoustiques: mythes et réalité</a></li>
<li><a href="../fr480844/index.html">Habr Quest {concept}</a></li>
<li><a href="../fr480848/index.html">Kits et constructeurs pour les ingénieurs électroniques débutants âgés de 6 à 10 ans. Ce qui est disponible en magasin</a></li>
<li><a href="../fr480852/index.html">Développement rapide d'applications Web sur Vaadin et Spring Boot</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>