<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ò¢Ô∏è üôÅ üë©üèø‚Äç‚öñÔ∏è Dubai Mall en un tel√©fono inteligente, o c√≥mo agregar un plano de un edificio a su aplicaci√≥n üôã üíü ü§¢</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En un art√≠culo anterior, habl√© sobre c√≥mo hacer una aplicaci√≥n m√≥vil con un mapa. En la continuaci√≥n de la serie "sobre la rodilla", compartir√© con us...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Dubai Mall en un tel√©fono inteligente, o c√≥mo agregar un plano de un edificio a su aplicaci√≥n</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/2gis/blog/476816/"><img src="https://habrastorage.org/webt/lq/cz/8s/lqcz8slsffexqi-rc0n0bovyyju.jpeg"><br><br>  En un <a href="https://habr.com/ru/company/2gis/blog/453182/">art√≠culo anterior,</a> habl√© sobre c√≥mo hacer una aplicaci√≥n m√≥vil con un mapa.  En la continuaci√≥n de la serie "sobre la rodilla", compartir√© con ustedes las herramientas para implementar los planos de planta. <br><br>  La declaraci√≥n inicial del problema en una forma simplificada: quiero poder visualizar el plano de planta en su aplicaci√≥n m√≥vil y poder mostrar la ubicaci√≥n de una organizaci√≥n espec√≠fica en √©l.  Tambi√©n me gustar√≠a ver la ubicaci√≥n del usuario, pero aqu√≠ el problema est√° en el plano t√©cnico: necesita un equipo que le permita obtener las coordenadas del dispositivo en interiores.  As√≠ que dejamos este aspecto fuera del alcance del art√≠culo y nos enfocamos en la parte del software. <br><br>  A continuaci√≥n, le mostrar√© varias opciones con las que puede implementar los requisitos descritos anteriormente.  Todo depende de qu√© datos tiene y qu√© debe poder hacer exactamente la aplicaci√≥n.  Y comenzaremos con lo m√°s simple. <br><a name="habracut"></a><br><h3>  La primera opci√≥n  API lista con datos </h3><br>  La primera opci√≥n que consideraremos es el uso de un widget listo para usar de 2GIS.  La descripci√≥n de la API se puede ver en <a href="https://api.2gis.ru/">api.2gis.ru.</a>  Le conviene si el edificio que le interesa ya se presenta en 2GIS, y los pisos ya se han dibujado en el edificio.  Es decir, en t√©rminos de datos, todo ya se ha hecho.  Y lo m√°s importante, est√° listo para conectarse en l√≠nea, ya que esta opci√≥n funcionar√° exclusivamente con Internet. <br><br>  Para mostrar los pisos en este caso, pr√°cticamente no se requiere nada de usted.  Implementaci√≥n de la ejecuci√≥n como un widget web, que solo necesita poner en WebView. <br><br><pre><code class="java hljs">&lt;WebView android:layout_width=<span class="hljs-string"><span class="hljs-string">"match_parent"</span></span> android:layout_height=<span class="hljs-string"><span class="hljs-string">"match_parent"</span></span> android:id=<span class="hljs-string"><span class="hljs-string">"@+id/am_webview"</span></span> android:layout_marginTop=<span class="hljs-string"><span class="hljs-string">"160dp"</span></span> /&gt;</code> </pre> <br>  Este es el contenedor en el que colocaremos nuestro widget.  Lo inicializamos de la siguiente manera: <br><br><pre> <code class="kotlin hljs">webView = findViewById(R.id.am_webview) webView.settings.javaScriptEnabled = <span class="hljs-literal"><span class="hljs-literal">true</span></span> webView.settings.useWideViewPort = <span class="hljs-literal"><span class="hljs-literal">true</span></span> webView.settings.loadWithOverviewMode = <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-comment"><span class="hljs-comment">//webView.settings.setSupportZoom(true) //webView.settings.displayZoomControls = true //webView.settings.builtInZoomControls = true webView.loadUrl("file:///android_asset/map_api.html") webView.webViewClient = object : WebViewClient() { override fun onPageFinished(view: WebView, url: String) { super.onPageFinished(view, url) val js = "initMap('13933647002593772');" // The Dubai Mall webView.evaluateJavascript(js, ValueCallback { }) } }</span></span></code> </pre><br>  Configuramos el propio webView, aseg√∫rese de habilitar JavaScript, javaScriptEnabled = true, ya que interactuaremos con el widget a trav√©s de √©l.  Si es necesario, puede activar las barras de desplazamiento y los botones de zoom (vea el c√≥digo comentado), pero no funciona muy bien, por lo que no lo recomiendo. <br><br>  Lo m√°s importante es cargar HTML con nuestro widget <i>webView.loadUrl ("file: ///android_asset/map_api.html")</i> y suscribirse a eventos, si es necesario.  En el ejemplo anterior, despu√©s de cargar el mapa, llamamos al m√©todo <i>initMap</i> definido en map_api.html, pasando el identificador del edificio para el que queremos mostrar los pisos. <br><br>  HTML es un c√≥digo bastante simple.  Se <i>llama al</i> m√©todo <i>DG.FloorsWidget.init</i> , en el que se pasa el objeto json que contiene los datos para inicializar.  Como contenedor, especifique la identificaci√≥n con la que hemos declarado un div en el marcado HTML anterior.  Ajusta el ancho, la altura.  Y en <i>initData pasamos</i> el edificio en la etiqueta <i>complexId</i> y par√°metros de visualizaci√≥n de widgets adicionales, que se pueden encontrar en la documentaci√≥n de la API.  Por cierto, el identificador se puede ver en respuesta a la consulta de b√∫squeda, que 2GIS env√≠a cuando hace clic en el edificio que le interesa en <a href="http://2gis.ru/">2gis.ru.</a>  En mi ejemplo, us√© el Dubai Mall.  Pero nadie se molesta en indicar ning√∫n otro edificio con pisos. <br><br>  El toque final.  Para pasar a una compa√±√≠a espec√≠fica, llame al m√©todo showFirm, pasando el identificador de la compa√±√≠a <br><br><pre> <code class="kotlin hljs">webView.loadUrl(<span class="hljs-string"><span class="hljs-string">"javascript:showFirm('</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$firmId</span></span></span><span class="hljs-string">')"</span></span>)</code> </pre> <br><br>  Es muy simple  Se puede ver un ejemplo de implementaci√≥n listo para usar en <a href="https://github.com/viloboda/android-2gis-tiles">Github</a> . <br><br><img src="https://habrastorage.org/webt/dj/wr/kt/djwrkts1gbnmjcatdunldu_hoam.gif"><br><br>  Ventajas de la opci√≥n considerada: <br><br><ul><li>  datos listos con planos de planta y datos de la empresa; </li><li>  implementaci√≥n ligera ya hecha en webview; </li><li>  B√∫squeda lista seg√∫n 2GIS. </li></ul><br>  Contras: <br><br><ul><li>  Internet requerido; </li><li>  se requieren conocimientos b√°sicos de HTML y JavaScript; </li><li>  solo datos de 2GIS y solo aquellos edificios que ya tienen pisos. </li></ul><br><h3>  La segunda opci√≥n.  Plano de planta como una imagen </h3><br>  Si la opci√≥n con datos listos y API no es adecuada para usted, puede usar lo siguiente. <br><br>  En este caso, necesitar√° un plano de planta en forma de imagen, por ejemplo, jpeg o png.  Si se requiere interactividad del tipo "metido en la imagen - abri√≥ la tarjeta de objeto", entonces tambi√©n ser√° necesaria la geocodificaci√≥n, que deber√° implementarse de forma independiente.  Si ajusta a las coordenadas globales, la imagen debe ajustarse correctamente y una de las esquinas debe desplazarse a las coordenadas reales para que pueda calcular los desplazamientos a partir de ella.  No nos detendremos en este tema en detalle, espero que todo est√© claro aqu√≠. <br><br>  Lo m√°s importante es mostrar esta imagen en la aplicaci√≥n.  Y para esto, la biblioteca <a href="https://github.com/moagrius/TileView">TileView</a> es ideal para nosotros.  De hecho, esta biblioteca permite, en principio, mostrar mosaicos de mapas.  Pero tambi√©n es adecuado para nosotros, ya que proporciona la capacidad de moverse y hacer zoom, centrarse en una posici√≥n espec√≠fica, mostrar marcadores, transformar las coordenadas y la capacidad de suscribirse a varios eventos. <br><br>  Para que la biblioteca funcione de la manera m√°s eficiente posible, la imagen original debe prepararse cort√°ndola en mosaicos.  Hay una <a href="https://github.com/moagrius/TileView/wiki/Creating-Tiles">instrucci√≥n</a> bastante simple <a href="https://github.com/moagrius/TileView/wiki/Creating-Tiles">para esto</a> .  Recomiendo un script al final de la p√°gina especificada que crear√° 4 mosaicos.  Agregamos el resultado obtenido a los activos y mostramos nuestra imagen en la actividad con un c√≥digo simple: <br><br><pre> <code class="kotlin hljs">tileView.setSize(floorWidth, floorHeight) tileView.setShouldRenderWhilePanning(<span class="hljs-literal"><span class="hljs-literal">true</span></span>) tileView.addDetailLevel(<span class="hljs-number"><span class="hljs-number">1f</span></span>, <span class="hljs-string"><span class="hljs-string">"tiles/floors1/1000/%d_%d.jpg"</span></span>) tileView.addDetailLevel(<span class="hljs-number"><span class="hljs-number">0.500f</span></span>, <span class="hljs-string"><span class="hljs-string">"tiles/floors1/500/%d_%d.jpg"</span></span>) tileView.addDetailLevel(<span class="hljs-number"><span class="hljs-number">0.250f</span></span>, <span class="hljs-string"><span class="hljs-string">"tiles/floors1/250/%d_%d.jpg"</span></span>) tileView.addDetailLevel(<span class="hljs-number"><span class="hljs-number">0.125f</span></span>, <span class="hljs-string"><span class="hljs-string">"tiles/floors1/125/%d_%d.jpg"</span></span>) tileView.defineBounds(<span class="hljs-number"><span class="hljs-number">0.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.0</span></span>, floorWidth.toDouble(), floorHeight.toDouble()) tileView.setScaleLimits(<span class="hljs-number"><span class="hljs-number">0f</span></span>, <span class="hljs-number"><span class="hljs-number">5f</span></span>) tileView.setMinimumScaleMode(ZoomPanLayout.MinimumScaleMode.FIT)</code> </pre><br>  Todo, la pantalla est√° lista.  Puede suscribirse a eventos y agregar la l√≥gica necesaria.  Por ejemplo, un marcador se puede mostrar as√≠: <br><br><pre> <code class="kotlin hljs">tileView.setMarkerAnchorPoints(-<span class="hljs-number"><span class="hljs-number">0.5f</span></span>, -<span class="hljs-number"><span class="hljs-number">0.5f</span></span>) tileView.addMarker(imageView, x, floorHeight - y, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>)</code> </pre><br>  Un ejemplo completo est√° disponible en <a href="https://github.com/viloboda/TileViewExample">Github</a> . <br><br><img src="https://habrastorage.org/webt/tb/29/bn/tb29bnjnkmnbvm5qwyjx5zztutw.gif"><br><br>  Pros: <br><br><ul><li>  la capacidad de hacer completamente fuera de l√≠nea; </li><li>  preparaci√≥n de datos relativamente simple, plano de planta en forma de imagen. </li></ul><br>  Contras: <br><br><ul><li>  falta de estilo din√°mico </li></ul><br><h3>  La tercera opci√≥n.  Datos vectoriales </h3><br>  Esta opci√≥n es la m√°s avanzada y la m√°s dif√≠cil.  Se supone que ha preparado datos vectoriales, es decir, pisos completamente dibujados en el vector.  Necesitar√°s varios tipos de objetos.  √Åreas de organizaciones, estacionamientos, patios de comidas, escenarios, pistas de patinaje, etc.  Objetos lineales: principalmente paredes, direcciones de flujo.  Objetos puntuales: entradas / salidas, ascensores, cajeros autom√°ticos y similares. <br><br>  As√≠ es como se ve un plano de planta en Fiji, sistema interno 2GIS: <br><br><img src="https://habrastorage.org/webt/dz/kg/uc/dzkguc7hmkwyjw2ymcaqufvkwbs.png"><br><br>  Bueno, para su visualizaci√≥n, el motor de vectores, del que habl√© en el <a href="https://habr.com/ru/company/2gis/blog/453182/">art√≠culo anterior</a> , mapsforge-vtm es adecuado para nosotros. <br><br>  Para demostrar el enfoque, prepar√© datos de prueba: un conjunto de cuadrados y l√≠neas para varios pisos usando el ejemplo de un edificio en la soleada isla de Chipre.  Para la preparaci√≥n, tom√© la geometr√≠a original del edificio y la cort√© en piezas correspondientes a los componentes de la geometr√≠a, solo por simplicidad.  Como saben, la parte m√°s dif√≠cil es la preparaci√≥n de datos de calidad.  El resto es cuesti√≥n de tecnolog√≠a.  Necesitar√° botones para cambiar pisos, estilos preparados para representar diferentes cuadrados y l√≠neas, y una superposici√≥n para representarlos. <br><br>  Vea el c√≥digo completo <a href="http://github.com/viloboda/MapMobileApp">aqu√≠</a> . <br><br>  La clase <i>FloorData</i> contiene el c√≥digo de prueba de geodatos para nuestros pisos, y la clase <i>FloorsManager est√°</i> dise√±ada para representarlos. <br><br>  En el constructor, definimos estilos para cuadrados y muros: <br><br><pre> <code class="kotlin hljs">styles.put(ObjectType.Floor, org.oscim.layers.vector.geometries.Style.builder() .fillColor(Color.GRAY) .build());</code> </pre><br>  Y en el m√©todo <i>drawFloor</i> , determinamos la l√≥gica de agregar objetos a capas en el mapa: <br><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void drawFloor(int floorId) { hideFloors(); indoorLayer = new CustomVectorLayer(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.map); List&lt;GeoData&gt; geoObjects = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.floorData.getFloorData(floorId); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (GeoData geo: geoObjects) { indoorLayer.add(geo.getGeometry(), styles.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(geo.getObjectType())); } <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.map.layers().add(indoorLayer); indoorLayer.update(); }</code> </pre><br>  Todo es elemental aqu√≠.  Cree una nueva capa <i>indoorLayer</i> , agregue datos de piso previamente preparados con los estilos necesarios y agregue la capa al mapa <i>this.map.layers (). Add (indoorLayer)</i> . <br><br>  Queda por agregar botones para cambiar de piso.  Para hacer esto, hay un <i>FloorPickerControl</i> basado en <i>RecyclerView</i> , que hace justo lo que necesita.  No perdamos el tiempo, vea la fuente. <br><br>  Y aqu√≠ est√° el Dubai Mall en nuestra aplicaci√≥n.  Tambi√©n implement√≥ la edici√≥n de geo objetos. <br><br><img src="https://habrastorage.org/webt/bt/nn/ah/btnnahpkbpactvr2ywt4tflwh-w.png"><br><br>  Pros: <br><br><ul><li>  de nuevo, la capacidad de hacer completamente fuera de l√≠nea; </li><li>  imagen de alta calidad; </li><li>  la posibilidad de una variedad de estilizaci√≥n din√°mica; </li><li>  La capacidad de implementar un editor de datos. </li></ul><br>  Contras: <br><br><ul><li>  preparaci√≥n de datos complejos </li></ul><br>  Al final del art√≠culo, quiero decir que la tarea de mostrar planos en la aplicaci√≥n no es tan terrible como podr√≠a parecer a primera vista.  Tiene varias opciones con sus ventajas y desventajas, entre las cuales puede elegir la m√°s adecuada para resolver su problema. <br><br>  Todas las referencias en un solo lugar: <br><br>  <a href="https://habr.com/ru/company/2gis/blog/453182/">Art√≠culo sobre el mapa en el m√≥vil</a> <br>  <a href="https://api.2gis.ru/">API 2GIS</a> <br>  <a href="https://github.com/viloboda/android-2gis-tiles">Ejemplo de API 2GIS</a> <br>  <a href="https://github.com/moagrius/TileView">Biblioteca TileView</a> <br>  <a href="https://github.com/viloboda/TileViewExample">Ejemplo de TileView</a> <br>  <a href="http://github.com/viloboda/MapMobileApp">Un ejemplo en mapsforge-vtm</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/476816/">https://habr.com/ru/post/476816/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../476792/index.html">Swift.assert - vida despu√©s del lanzamiento</a></li>
<li><a href="../476796/index.html">Reflexiones sobre el cuerpo perfecto.</a></li>
<li><a href="../476798/index.html">Estudiamos el ensamblaje del chip RAM en el ejemplo de Hynix GDDR3 SDRAM</a></li>
<li><a href="../476806/index.html">MPS 2019.2: tipos de datos enumerados, personalizaci√≥n de mensajes de error, transici√≥n a JDK 11 y mucho m√°s</a></li>
<li><a href="../476812/index.html">Notas sobre todo. Fuentes de alimentaci√≥n simples y peligrosas</a></li>
<li><a href="../476824/index.html">McKinsey: repensar la arquitectura de software y electr√≥nica en automoci√≥n</a></li>
<li><a href="../476826/index.html">Experimentos m√∫ltiples: teor√≠a y pr√°ctica</a></li>
<li><a href="../476828/index.html">Operaci√≥n "Migraci√≥n": c√≥mo se mueve a la nube de DataLine</a></li>
<li><a href="../476830/index.html">¬øC√≥mo implementar las funciones de la utilidad de JavaScript usando Reducir?</a></li>
<li><a href="../476834/index.html">Red Hat OpenShift 4.2: Nuevas herramientas</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>