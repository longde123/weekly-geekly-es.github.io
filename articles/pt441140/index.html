<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèø‚Äçü§ù‚Äçüë®üèΩ üìç ü§° Desenvolvimento WebAssembly: rake real e exemplos üëãüèΩ üë©üèª‚Äçüöí üàØÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O an√∫ncio do WebAssembly ocorreu em 2015 - mas agora, depois de anos, ainda h√° poucos que podem se orgulhar dele na produ√ß√£o. Os materiais dessa exper...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Desenvolvimento WebAssembly: rake real e exemplos</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/jugru/blog/441140/"><img src="https://habrastorage.org/webt/e5/pu/-s/e5pu-s7yjpdm8dddc42_nxa1uve.jpeg"><br><br>  O an√∫ncio do WebAssembly ocorreu em 2015 - mas agora, depois de anos, ainda h√° poucos que podem se orgulhar dele na produ√ß√£o.  Os materiais dessa experi√™ncia s√£o ainda mais valiosos: as informa√ß√µes em primeira m√£o sobre como conviver com ela na pr√°tica ainda s√£o escassas. <br><br>  Na confer√™ncia do HolyJS, um relat√≥rio sobre a experi√™ncia do uso do WebAssembly recebeu notas altas da plat√©ia e agora uma vers√£o em texto deste relat√≥rio foi preparada especialmente para Habr (um v√≠deo tamb√©m √© anexado). <br><a name="habracut"></a><br><iframe width="560" height="315" src="https://www.youtube.com/embed/uqG9DiT80UE" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  Meu nome √© Andrey, vou falar sobre o WebAssembly.  Podemos dizer que comecei a me envolver na web no s√©culo passado, mas sou modesto, ent√£o n√£o digo isso.  Durante esse per√≠odo, consegui trabalhar tanto no backend quanto no frontend, e at√© desenhei um pouco de design.  Hoje estou interessado em coisas como WebAssembly, C ++ e outras coisas nativas.  Tamb√©m gosto muito de tipografia e coleciono tecnologia antiga. <br><br>  Primeiro, falarei sobre como a equipe e eu implementamos o WebAssembly em nosso projeto, depois discutiremos se voc√™ precisa de algo do WebAssembly e terminamos com algumas dicas, caso voc√™ queira implement√°-lo por conta pr√≥pria. <br><br><h2>  Como implementamos o WebAssembly </h2><br>  Trabalho na Inetra, estamos localizados em Novosibirsk e estamos realizando alguns de nossos pr√≥prios projetos.  Um deles √© o ByteFog.  Essa √© a tecnologia ponto a ponto para fornecer v√≠deo aos usu√°rios.  Nossos clientes s√£o servi√ßos que distribuem uma enorme quantidade de v√≠deo.  Eles t√™m um problema: quando algum evento popular acontece, por exemplo, a confer√™ncia de imprensa de algu√©m ou algum evento esportivo, como n√£o se preparar para isso, v√°rios clientes v√™m, apoiando-se no servidor e o servidor fica triste.  Os clientes recebem uma qualidade de v√≠deo muito ruim no momento. <br><br>  Mas todo mundo est√° assistindo o mesmo conte√∫do.  Vamos pedir aos dispositivos vizinhos dos usu√°rios que compartilhem partes de v√≠deo e, em seguida, descarregaremos o servidor, economizaremos largura de banda e os usu√°rios receber√£o v√≠deo com melhor qualidade.  Essas nuvens s√£o nossa tecnologia, nosso servidor proxy ByteFog. <br><br><img src="https://habrastorage.org/webt/ir/yw/xl/irywxlozwzz4kbedspsf14lx4ie.png"><br><br>  Devemos estar instalados em todos os dispositivos que possam exibir v√≠deo, portanto, oferecemos suporte a uma ampla variedade de plataformas: Windows, Linux, Android, iOS, Web, Tizen.  Qual idioma escolher para ter uma √∫nica base de c√≥digo em todas essas plataformas?  Escolhemos o C ++ porque ele apresenta as maiores vantagens :-D Mais seriamente, temos uma boa experi√™ncia em C ++, √© realmente uma linguagem r√°pida e, em portabilidade, provavelmente perde apenas para C. <br><br>  Temos uma aplica√ß√£o bastante grande (900 classes), mas funciona bem.  No Windows e Linux, compilamos em c√≥digo nativo.  Para Android e iOS, criamos uma biblioteca que conectamos ao aplicativo.  Falaremos sobre Tizen outra vez, mas na Web costum√°vamos trabalhar como um plug-in de navegador. <br><br>  Esta √© a tecnologia da API do Netscape Plugin.  Como o nome indica, √© bastante antigo e tamb√©m tem uma desvantagem: fornece acesso muito amplo ao sistema, portanto o c√≥digo do usu√°rio pode causar um problema de seguran√ßa.  √â provavelmente por isso que o Chrome desativou o suporte para essa tecnologia em 2015 e, em seguida, todos os navegadores se juntaram a esse flash mob.  Por isso, ficamos sem uma vers√£o da web por quase dois anos. <br><br>  Em 2017, uma nova esperan√ßa veio.  Como voc√™ pode imaginar, este √© o WebAssembly.  Como resultado, nos propusemos a tarefa de portar nosso aplicativo para um navegador.  Desde que o suporte ao Firefox e Chrome j√° apareceu na primavera, e no outono de 2017, o Edge e o Safari se destacaram. <br><br>  Era importante usarmos o c√≥digo pronto, pois temos muita l√≥gica de neg√≥cios que n√£o queremos duplicar, para n√£o duplicar o n√∫mero de bugs.  Pegue o compilador Emscripten.  Ele faz o que precisamos - compila o aplicativo positivo no navegador e recria o ambiente familiar ao aplicativo nativo no navegador.  Podemos dizer que o Emscripten √© um c√≥digo Browserify for C ++.  Tamb√©m permite encaminhar objetos de C ++ para JavaScript e vice-versa.  Nosso primeiro pensamento foi: agora vamos usar o Emscripten, apenas compilar, e tudo funcionar√°.  Claro que n√£o.  A partir da√≠ come√ßou nossa jornada ao longo do ancinho. <br><br>  A primeira coisa que encontramos foi o v√≠cio.  Havia v√°rias bibliotecas em nossa base de c√≥digo.  Agora n√£o faz sentido list√°-las, mas para quem entende, temos o Boost.  Essa √© uma grande biblioteca que permite escrever c√≥digo de plataforma cruzada, mas √© muito dif√≠cil configurar a compila√ß√£o com ele.  Eu queria arrastar o m√≠nimo de c√≥digo poss√≠vel para o navegador. <br><br><h3>  Arquitetura Bytefog </h3><br>  Como resultado, identificamos o n√∫cleo: podemos dizer que este √© um servidor proxy que cont√©m a principal l√≥gica de neg√≥cios.  Este servidor proxy obt√©m dados de duas fontes.  O primeiro e principal √© o HTTP, ou seja, o canal para o servidor de distribui√ß√£o de v√≠deo, o segundo √© a nossa rede P2P, ou seja, um canal para outro mesmo proxy de outro usu√°rio.  Fornecemos os dados principalmente ao player, pois nossa tarefa √© mostrar conte√∫do de alta qualidade ao usu√°rio.  Se houver recursos, distribu√≠mos o conte√∫do para a rede P2P para que outros usu√°rios possam baix√°-lo.  Dentro, h√° um cache inteligente que faz toda a m√°gica. <br><br><img src="https://habrastorage.org/webt/vi/id/zt/viidzt9cctzun2_em3ka8jfm8pu.png"><br><br>  Depois de compilar tudo isso, somos confrontados com o fato de o WebAssembly ser executado na caixa de prote√ß√£o do navegador.  Isso significa que ele n√£o pode fazer mais do que o JavaScript oferece.  Enquanto os aplicativos nativos usam muitas coisas espec√≠ficas da plataforma, como um sistema de arquivos, uma rede ou n√∫meros aleat√≥rios.  Todos esses recursos ter√£o que ser implementados em JavaScript usando o que o navegador nos fornece.  Esta placa lista as substitui√ß√µes bastante √≥bvias listadas. <br><br><img src="https://habrastorage.org/webt/ii/uv/bf/iiuvbfvwjvul6pbnkuptqku8amo.png"><br><br>  Para tornar isso poss√≠vel, √© necess√°rio interromper a implementa√ß√£o de recursos nativos em um aplicativo nativo e inserir uma interface l√°, ou seja, desenhar uma certa borda.  Em seguida, voc√™ implementa isso em JavaScript e deixa a implementa√ß√£o nativa e, j√° durante a montagem, a necess√°ria √© selecionada.  Ent√£o, examinamos nossa arquitetura e encontramos todos os lugares onde essa borda pode ser desenhada.  Coincidentemente, este √© um subsistema de transporte. <br><br><img src="https://habrastorage.org/webt/ok/eq/w-/okeqw-dc-weuwlqxed4iy2x5nn4.png"><br><br>  Para cada um desses locais, definimos uma especifica√ß√£o, ou seja, fixamos um contrato: quais m√©todos ser√£o, quais par√¢metros eles ter√£o, que tipos de dados.  Depois de fazer isso, voc√™ pode trabalhar em paralelo, cada desenvolvedor ao seu lado. <br><br>  Qual √© o resultado?  Substitu√≠mos o principal canal de entrega de v√≠deo do provedor pelo AJAX usual.  Emitimos dados para o player por meio da popular biblioteca HLS.js., mas h√° uma possibilidade fundamental de integra√ß√£o com outros players, se necess√°rio.  Substitu√≠mos toda a camada P2P pelo WebRTC. <br><br><img src="https://habrastorage.org/webt/g8/dc/mt/g8dcmtbxfugjxpycyzpabtb6nto.png"><br><br>  Como resultado da compila√ß√£o, v√°rios arquivos s√£o obtidos.  O mais importante √© o bin√°rio .wasm.  Ele cont√©m o c√≥digo de c√≥digo compilado que o navegador executar√° e que cont√©m todo o seu legado em C ++.  Mas, por si s√≥, n√£o funciona, o chamado "c√≥digo de cola" √© necess√°rio, tamb√©m √© gerado pelo compilador.  O c√≥digo da cola est√° baixando um arquivo bin√°rio e voc√™ carrega esses dois arquivos para produ√ß√£o.  Para fins de depura√ß√£o, voc√™ pode gerar uma representa√ß√£o textual do assembler - um arquivo .wast e um mapa de origem.  Voc√™ precisa entender que eles podem ser muito grandes.  No nosso caso, eles atingiram 100 megabytes ou mais. <br><br><h3>  Coletando o Pacote Configur√°vel </h3><br>  Vamos dar uma olhada no c√≥digo da cola.  Este √© o bom e velho ES5 usual, reunido em um √∫nico arquivo.  Quando o conectamos a uma p√°gina da web, temos uma vari√°vel global que cont√©m todo o nosso m√≥dulo wasm instanciado, pronto para aceitar solicita√ß√µes √† sua API. <br><br>  Mas incluir um arquivo separado √© uma complica√ß√£o bastante s√©ria para a biblioteca que os usu√°rios usar√£o.  Gostar√≠amos de colocar tudo em um √∫nico pacote.  Para isso, usamos o Webpack e uma op√ß√£o de compila√ß√£o especial MODULARIZE. <br><br>  Ele agrupa o c√≥digo adesivo no padr√£o ‚ÄúM√≥dulo‚Äù e podemos busc√°-lo: importar ou usar o require se escrevermos no ES5 - o Webpack entende calmamente essa depend√™ncia.  Houve um problema com Babel - ele n√£o gostou da grande quantidade de c√≥digo, mas este √© um c√≥digo ES5, n√£o precisa ser transposto, apenas o adicionamos para ignorar. <br><br>  Em busca do n√∫mero de arquivos, decidi usar a op√ß√£o SINGLE_FILE.  Ele converte todos os bin√°rios resultantes da compila√ß√£o no formato Base64 e o envia para o c√≥digo adesivo como uma sequ√™ncia.  Parece uma √≥tima id√©ia, mas depois disso o pacote ficou com 100 megabytes de tamanho.  Nem o Webpack, nem o Babel, nem o navegador funcionam nesse volume.  De qualquer forma, n√£o for√ßaremos o usu√°rio a carregar 100 megabytes ?! <br><br>  Se voc√™ pensar bem, essa op√ß√£o n√£o √© necess√°ria.  O c√≥digo adesivo baixa arquivos bin√°rios por conta pr√≥pria.  Ele faz isso via HTTP, para obter o armazenamento em cache imediato, podemos definir os cabe√ßalhos que desejamos, por exemplo, ativar a compacta√ß√£o e os arquivos WebAssembly s√£o perfeitamente compactados. <br><br>  Mas a tecnologia mais legal √© a compila√ß√£o de streaming.  Ou seja, o arquivo WebAssembly, durante o download do servidor, j√° pode ser compilado no navegador √† medida que os dados chegam, e isso acelera bastante o carregamento do seu aplicativo.  Em geral, toda a tecnologia WebAssembly se concentra no in√≠cio r√°pido de uma grande base de c√≥digos. <br><br><h3>  Thenable </h3><br>  Outro problema com o m√≥dulo √© que ele √© um objeto Thenable, ou seja, possui um m√©todo .then ().  Esta fun√ß√£o permite suspender um retorno de chamada no momento em que o m√≥dulo √© iniciado, e √© muito conveniente.  Mas eu gostaria que a interface correspondesse ao Promise.  Ent√£o n√£o √© Promessa, mas tudo bem, vamos encerrar.  Vamos escrever um c√≥digo t√£o simples: <br><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">resolve, reject</span></span></span><span class="hljs-function">) =&gt;</span></span> { Module(config).then(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">module</span></span></span></span></span><span class="hljs-function">) =&gt;</span></span> { resolve(<span class="hljs-built_in"><span class="hljs-built_in">module</span></span>); }); });</code> </pre> <br>  Criamos Promise, iniciamos nosso m√≥dulo e, como retorno de chamada, chamamos a fun√ß√£o de resolu√ß√£o e passamos o m√≥dulo que instalamos l√°.  Tudo parece √≥bvio, est√° tudo bem, estamos lan√ßando - algo est√° errado, nosso navegador est√° congelado, nosso DevTools est√° travando e o processador est√° esquentando no computador.  N√£o entendemos nada - algum tipo de recurs√£o ou um loop infinito.  A depura√ß√£o √© bastante dif√≠cil e, quando interrompemos o JavaScript, acabamos na fun√ß√£o Then no m√≥dulo Emscripten. <br><br><pre> <code class="javascript hljs">Module[<span class="hljs-string"><span class="hljs-string">'then'</span></span>] = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">func</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Module[<span class="hljs-string"><span class="hljs-string">'calledRun'</span></span>]) { func(Module); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Module[<span class="hljs-string"><span class="hljs-string">'onRuntimeInitialized'</span></span>] = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ func(Module); }; }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Module; };</code> </pre><br>  Vamos dar uma olhada em mais detalhes.  Tra√ßar <br><br><pre> <code class="javascript hljs">Module[<span class="hljs-string"><span class="hljs-string">'onRuntimeInitialized'</span></span>] = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ func(Module); };</code> </pre><br>  respons√°vel por suspender um retorno de chamada.  Tudo est√° claro aqui: uma fun√ß√£o ass√≠ncrona que chama nosso retorno de chamada.  Tudo como queremos.  H√° outra parte desse recurso. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Module[<span class="hljs-string"><span class="hljs-string">'calledRun'</span></span>]) { func(Module);</code> </pre><br>  √â chamado quando o m√≥dulo j√° foi iniciado.  Em seguida, o retorno de chamada √© chamado de forma s√≠ncrona imediatamente e o m√≥dulo √© passado a ele no par√¢metro  Isso imita o comportamento da Promessa, e parece ser o que esperamos.  Mas ent√£o o que est√° errado? <br><br>  Se voc√™ ler atentamente a documenta√ß√£o, verifica-se que h√° um ponto muito sutil sobre o Promise.  Quando resolvermos a Promessa usando um Thenable, o navegador desempacotar√° os valores desse Thenable e, para fazer isso, chamar√° o m√©todo .then ().  Como resultado, resolvemos a promessa, passamos o m√≥dulo para ela.  O navegador pergunta: Ent√£o isso √© um objeto?  Sim, este √© um Thenable.  Em seguida, a fun√ß√£o .then () √© chamada no m√≥dulo e a pr√≥pria fun√ß√£o de resolu√ß√£o √© passada como retorno de chamada. <br><br>  O m√≥dulo verifica se est√° em execu√ß√£o.  Ele j√° est√° em execu√ß√£o, portanto, o retorno de chamada √© chamado imediatamente e o mesmo m√≥dulo √© passado a ele novamente.  Como retorno de chamada, temos a fun√ß√£o de resolu√ß√£o, e o navegador pergunta: este √© um objeto Thenable?  Sim, este √© um Thenable.  E tudo come√ßa de novo.  Como resultado, ca√≠mos em um ciclo intermin√°vel, do qual o navegador nunca retorna. <br><br><img src="https://habrastorage.org/webt/ks/rr/c-/ksrrc-zeix0ffh_uott4ahpt3qc.png"><br><br>  N√£o encontrei uma solu√ß√£o elegante para esse problema.  Como resultado, simplesmente excluo o m√©todo .then () antes de resolver, e isso funciona. <br><br><h3>  Emscripten </h3><br>  Ent√£o, compilamos o m√≥dulo, montamos o JS, mas algo est√° faltando.  Provavelmente precisamos fazer algum trabalho √∫til.  Para fazer isso, transfira dados e conecte os dois mundos - JS e C ++.  Como fazer isso?  O Emscripten fornece tr√™s op√ß√µes: <br><br><ul><li>  A primeira s√£o as fun√ß√µes ccall e cwrap.  Na maioria das vezes, voc√™ os encontrar√° em alguns tutoriais no WebAssembly, mas eles n√£o s√£o adequados para o trabalho real, porque n√£o suportam os recursos do C ++. </li><li>  O segundo √© o WebIDL Binder.  Ele j√° suporta fun√ß√µes C ++, voc√™ j√° pode trabalhar com ele.  Essa √© uma linguagem s√©ria de descri√ß√£o de interface usada, por exemplo, pelo W3C para sua documenta√ß√£o.  Mas n√£o quer√≠amos carreg√°-lo em nosso projeto e usamos a terceira op√ß√£o </li><li>  Incorporar.  Podemos dizer que essa √© uma maneira nativa de conectar objetos ao Emscripten, que √© baseada em modelos C ++ e permite que voc√™ fa√ßa muitas coisas encaminhando diferentes entidades de C ++ para JS e vice-versa. </li></ul><br><br>  Incorporar permite que voc√™: <br><br><ul><li>  Chamar fun√ß√µes C ++ do c√≥digo JavaScript </li><li>  Criar objetos JS a partir de uma classe C ++ </li><li>  No c√≥digo C ++, v√° para a API do navegador (se, por algum motivo, voc√™ desejar, voc√™ pode, por exemplo, escrever toda a estrutura front-end em C ++). </li><li>  O principal para n√≥s: implementar a interface JavaScript descrita em C ++. </li></ul><br><br><h3>  Troca de dados </h3><br>  O √∫ltimo ponto √© importante, pois essa √© exatamente a a√ß√£o que voc√™ executar√° constantemente ao portar o aplicativo.  Portanto, gostaria de me debru√ßar sobre isso com mais detalhes.  Agora haver√° c√≥digo C ++, mas n√£o se assuste, √© quase como o TypeScript :-D <br><br>  O esquema √© o seguinte: <br><br><img src="https://habrastorage.org/webt/y8/b9/w7/y8b9w7ztnudrlcv5p0zzsezuzkm.png"><br><br>  No lado do C ++, existe um kernel ao qual queremos dar acesso, por exemplo, a uma rede externa - para carregar v√≠deo.  Isso costumava ser feito com soquetes nativos, havia algum tipo de cliente HTTP que fazia isso, mas n√£o h√° soquetes nativos no WebAssembly.  N√≥s precisamos sair de alguma forma, ent√£o cortamos o cliente HTTP antigo, inserimos a interface nesse local e implementamos essa interface no JavaScript usando AJAX comum, de qualquer forma.  Depois disso, passaremos o objeto resultante de volta ao C ++, onde o kernel o usar√°. <br><br>  Vamos criar o cliente HTTP mais simples que s√≥ pode fazer solicita√ß√µes de obten√ß√£o: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HTTPClient</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-function"><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> url)</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-number"><span class="hljs-number">0</span></span>; };</code> </pre><br>  Para a entrada, ele recebe uma string com o URL a ser baixado e a sa√≠da <br>  string com o resultado da solicita√ß√£o.  No C ++, as strings podem ter dados bin√°rios, portanto, isso √© adequado para v√≠deo.  Emscripten nos faz escrever aqui <br>  um inv√≥lucro t√£o assustador: <br><br><img src="https://habrastorage.org/webt/m_/dz/hg/m_dzhg7a0xrywq8rirnyeh1rswa.png"><br><br>  Nele, o principal √© duas coisas - o nome da fun√ß√£o no lado C ++ (marquei-os em verde) e os nomes correspondentes no lado JavaScript (marquei-os em azul).  Como resultado, escrevemos uma declara√ß√£o de comunica√ß√£o: <br><br><img src="https://habrastorage.org/webt/am/ob/qz/amobqzp-sx-3w12rnljcxlfh-fk.png"><br><br>  Funciona como blocos de Lego, dos quais montamos.  N√≥s temos uma classe, essa classe tem um m√©todo e queremos herdar dessa classe para implementar a interface.  Isso √© tudo.  Vamos ao JavaScript e herdamos.  Isso pode ser feito de duas maneiras.  O primeiro √© estender.  Isso √© muito semelhante ao bom e velho estendido do Backbone. <br><br><img src="https://habrastorage.org/webt/rt/6p/fi/rt6pfi7s3sfipms3y8lfusrqgy8.png"><br><br>  O m√≥dulo cont√©m tudo o que o Emscripten compilou e possui uma propriedade com uma interface exportada.  Chamamos o m√©todo extend e passamos um objeto para l√° com a implementa√ß√£o desse m√©todo, ou seja, algum m√©todo ser√° implementado na fun√ß√£o get <br>  Obtenha informa√ß√µes usando o AJAX. <br><br>  Na sa√≠da, extend nos fornece um construtor JavaScript regular.  Podemos cham√°-lo quantas vezes for necess√°rio e gerar objetos na quantidade necess√°ria.  Mas h√° uma situa√ß√£o em que temos um objeto e queremos apenas pass√°-lo para o lado do C ++. <br><br><img src="https://habrastorage.org/webt/ky/ct/es/kycteslqo9rkbq5nyj1ilflq7g0.png"><br><br>  Para fazer isso, de alguma forma, vincule esse objeto a um tipo que o C ++ entender√°.  √â isso que a fun√ß√£o de implemento faz.  Na sa√≠da, ele n√£o fornece um construtor, mas um objeto pronto para uso, nosso cliente, que podemos devolver ao C ++.  Voc√™ pode fazer isso, por exemplo, assim: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> app = Module.makeApp(client, ‚Ä¶)</code> </pre><br>  Suponha que tenhamos uma f√°brica que crie nosso aplicativo e leve suas depend√™ncias para par√¢metros, por exemplo, cliente e algo mais.  Quando essa fun√ß√£o funciona, obtemos o objeto de nosso aplicativo, que j√° cont√©m a API necess√°ria.  Voc√™ pode fazer o oposto: <br><br><pre> <code class="cpp hljs">val client = val::global(‚Ä≥client‚Ä≥); client.call&lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt;(‚Ä≥get‚Ä≥, val(...) );</code> </pre><br>  Diretamente do C ++, leve nosso cliente do escopo global do navegador.  Al√©m disso, no lugar do cliente, pode haver qualquer API do navegador, iniciando no console, terminando com a API DOM, WebRTC - o que voc√™ quiser.  Em seguida, chamamos os m√©todos que esse objeto possui e agrupamos todos os valores na classe m√°gica val, que Emscripten nos fornece. <br><br><h3>  Erros de liga√ß√£o </h3><br>  Em geral, √© tudo, mas quando voc√™ inicia o desenvolvimento, erros de liga√ß√£o esperam por voc√™.  Eles se parecem com isso: <br><br><img src="https://habrastorage.org/webt/bi/jy/uj/bijyujpafhw1vljtsptpvuzxztw.png"><br><br>  Emscripten tenta nos ajudar e explicar o que est√° acontecendo de errado.  Se tudo estiver resumido, √© necess√°rio garantir que coincidam (√© f√°cil selar e obter um erro de liga√ß√£o): <br><br><ul><li>  Nomes </li><li>  Tipos </li><li>  N√∫mero de par√¢metros </li></ul><br>  A sintaxe de incorpora√ß√£o √© incomum n√£o apenas para fornecedores de front-end, mas tamb√©m para pessoas que lidam com C ++.  Esse √© um tipo de DSL no qual √© f√°cil cometer um erro, voc√™ precisa seguir isso.  Falando sobre interfaces, quando voc√™ implementa algum tipo de interface em JavaScript, √© necess√°rio que ele corresponda exatamente ao que voc√™ descreveu em seu contrato. <br><br>  Tivemos um caso interessante.  Meu colega Jura, envolvido no projeto no lado do C ++, usou o Extend para testar seus m√≥dulos.  Eles funcionaram perfeitamente para ele, ent√£o ele os comprometeu e os passou para mim.  Eu usei implementar para integrar esses m√≥dulos em um projeto JS.  E eles pararam de trabalhar para mim.  Quando descobrimos, descobrimos que, ao vincular os nomes das fun√ß√µes, recebemos um erro de digita√ß√£o. <br><br>  Como podemos ver pelo nome, o Extend √© uma extens√£o da interface; portanto, se voc√™ cometer algum erro, o Extend n√£o emitir√° um erro, decidir√° que voc√™ acabou de adicionar um novo m√©todo, e tudo bem. <br><br>  Ou seja, oculta os erros de liga√ß√£o at√© que o pr√≥prio m√©todo seja chamado.  Eu sugiro usar o Implement em todos os casos em que for melhor para voc√™, pois ele verifica imediatamente a exatid√£o da interface encaminhada.  Mas se voc√™ precisar do Extend, dever√° cobrir com testes a chamada de cada m√©todo para n√£o estragar tudo. <br><br><h3>  Estender e ES6 </h3><br>  Outro problema com o Extend √© que ele n√£o suporta as classes ES6.  Quando voc√™ herda um objeto derivado de uma classe ES6, o Extend espera que todas as propriedades sejam enumer√°veis, mas com o ES6 n√£o √©.  Os m√©todos est√£o no prot√≥tipo e possuem enumer√°veis: false.  Eu uso uma muleta como esta, na qual reviso o prot√≥tipo e ligo o enumer√°vel: true: <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">enumerateProto</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">obj</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.getOwnPropertyNames(obj.prototype) .forEach(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">prop</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.defineProperty(obj.prototype, prop, {<span class="hljs-attr"><span class="hljs-attr">enumerable</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>}) ) }</code> </pre><br>  Espero que um dia eu possa me livrar disso, pois h√° discuss√µes na comunidade Emscripten sobre como melhorar o suporte ao ES6. <br><br><h3>  RAM </h3><br>  Falando sobre C ++, n√£o se pode deixar de mencionar mem√≥ria.  Quando verificamos tudo em v√≠deo com qualidade SD, tudo estava bem conosco, funcionou perfeitamente!  Assim que fizemos o teste FullHD, houve uma falta de erro de mem√≥ria.  N√£o importa, existe a op√ß√£o TOTAL_MEMORY, que define o valor da mem√≥ria inicial para o m√≥dulo.  Fizemos meio gigabyte, est√° tudo bem, mas de alguma forma √© desumano para os usu√°rios, porque reservamos a mem√≥ria para todos, mas nem todos t√™m uma assinatura do conte√∫do FullHD. <br><br>  H√° outra op√ß√£o - ALLOW_MEMORY_GROWTH.  Permite aumentar a mem√≥ria <br>  gradualmente conforme necess√°rio.  Funciona assim: Emscripten, por padr√£o, fornece ao m√≥dulo 16 megabytes para opera√ß√£o.  Quando voc√™ os usou, um novo peda√ßo de mem√≥ria √© alocado.  Todos os dados antigos s√£o copiados para l√° e voc√™ ainda tem a mesma quantidade de espa√ßo para novos.  Isso acontece at√© voc√™ atingir 4 GB. <br><br>  Suponha que voc√™ alocou 256 megabytes de mem√≥ria, mas sabe com certeza que pensou que seu aplicativo tivesse 192. O suficiente. O restante da mem√≥ria ser√° usado ineficientemente.  Voc√™ o destacou, tirou do usu√°rio, mas n√£o fez nada com ele.  Eu gostaria de, de alguma forma, evitar isso.  H√° um pequeno truque: come√ßamos a trabalhar com a mem√≥ria aumentada uma vez e meia.  Na terceira etapa, atingimos 192 megabytes, e √© exatamente disso que precisamos.  Reduzimos o consumo de mem√≥ria nesse restante e salvamos uma aloca√ß√£o de mem√≥ria desnecess√°ria e, quanto mais, mais tempo eles demoram.  Portanto, recomendo usar essas duas op√ß√µes juntas. <br><br><h3>  Inje√ß√£o de depend√™ncia </h3><br>  Parece que foi tudo, mas o rake foi um pouco mais.  H√° um problema com a inje√ß√£o de depend√™ncia.  Escrevemos a classe mais simples na qual √© necess√°ria uma depend√™ncia. <br><br><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">App</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(httpClient) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.httpClient = httpClient } }</code> </pre><br>  Por exemplo, passamos nosso cliente HTTP para nosso aplicativo.  Economizamos na propriedade de classe.  Parece que tudo vai funcionar bem. <br><br><pre> <code class="javascript hljs">Module.App.extend( ‚Ä≥App‚Ä≥, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> App(client) )</code> </pre><br>  Herdamos da interface C ++, primeiro criamos nosso objeto, passamos a depend√™ncia a ele e depois herdamos.  No momento da heran√ßa, Emscripten faz algo incr√≠vel com o objeto.  √â mais f√°cil pensar que ele mata um objeto antigo, cria um novo com base em seu modelo e arrasta todos os m√©todos p√∫blicos para l√°.  Mas, ao mesmo tempo, o estado do objeto √© perdido e voc√™ obt√©m um objeto que n√£o √© formado e n√£o funciona corretamente.  Resolver esse problema √© bastante simples.  √â necess√°rio usar um construtor que funcione ap√≥s o est√°gio de heran√ßa. <br><br><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">App</span></span></span><span class="hljs-class"> </span></span>{ _construct(httpClient) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.httpClient = httpClient <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._parent._construct.call(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>) } }</code> </pre><br>  Fazemos quase a mesma coisa: armazenamos a depend√™ncia no campo do objeto, mas esse √© o objeto que resultou ap√≥s a heran√ßa.  N√£o devemos esquecer de encaminhar a chamada do construtor para o objeto pai, localizado no lado do C ++.  A √∫ltima linha √© um an√°logo do m√©todo super () no ES6.  √â assim que a heran√ßa acontece neste caso: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> appConstr = Module.App.extend( ‚Ä≥App‚Ä≥, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> App() ) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> app = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> appConstr(client)</code> </pre><br>  Primeiro, herdamos e, em seguida, criamos um novo objeto no qual a depend√™ncia j√° foi passada, e isso funciona. <br><br><h3>  Truque do ponteiro </h3><br>  Outro problema √© passar objetos por ponteiro de C ++ para JavaScript.  J√° fizemos um cliente HTTP.  Por simplicidade, perdemos um detalhe importante. <br><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-function"><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> url)</span></span></span></span></code> </pre><br>  O m√©todo retorna o valor imediatamente, ou seja, acontece que a solicita√ß√£o deve ser s√≠ncrona.  Afinal, o AJAX solicita o AJAX e √© ass√≠ncrono; portanto, na vida real, o m√©todo n√£o retornar√° nada ou podemos retornar o ID do pedido.  Mas, para que algu√©m retorne a resposta, passamos o ouvinte como o segundo par√¢metro, no qual haver√° retornos de chamada do C ++. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> url, Listener listener)</span></span></span></span></code> </pre><br>  Em JS, fica assim: <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">url, listener</span></span></span><span class="hljs-function">) </span></span>{ fetch(url).then(result) =&gt; { listener.onResult(result) }) }</code> </pre><br>  Temos uma fun√ß√£o get que leva esse objeto de ouvinte.  Iniciamos o download do arquivo e desligamos o retorno de chamada.  Quando o arquivo √© baixado, extra√≠mos a fun√ß√£o desejada do ouvinte e passamos o resultado para ele. <br><br>  Parece que o plano √© bom, mas quando a fun√ß√£o get for conclu√≠da, todas as vari√°veis ‚Äã‚Äãlocais ser√£o destru√≠das e, juntamente com eles, os par√¢metros da fun√ß√£o, ou seja, o ponteiro ser√° destru√≠do e o emscripten de tempo de execu√ß√£o destruir√° o objeto no lado do C ++. <br><br>  Como resultado, quando se trata de chamar a linha listener.onResult (result), o ouvinte n√£o existe mais e, ao acess√°-lo, ocorrer√° um erro de acesso √† mem√≥ria que levar√° √† falha do aplicativo. <br><br>  Gostaria de evitar isso e existe uma solu√ß√£o, mas demorou v√°rias semanas para encontr√°-la. <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">url, listener</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> listenerCopy = listener.clone() fetch(url).then(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">result</span></span></span><span class="hljs-function">) =&gt;</span></span> { listenerCopy.onResult(result) listenerCopy.delete() }) }</code> </pre><br>  Acontece que existe um m√©todo para clonar um ponteiro.  Por alguma raz√£o, ele n√£o est√° documentado, mas funciona bem e permite aumentar a contagem de refer√™ncias no ponteiro Emscripten.  Isso nos permite suspend√™-lo em um fechamento e, quando iniciarmos nosso retorno de chamada, nosso ouvinte estar√° acess√≠vel por esse ponteiro e podemos trabalhar conforme necess√°rio. <br><br>  O mais importante √© n√£o esquecer de excluir esse ponteiro, caso contr√°rio, isso causar√° um erro de vazamento de mem√≥ria, o que √© muito ruim. <br><br><h3>  Grava√ß√£o r√°pida na mem√≥ria </h3><br>  Quando baixamos v√≠deos, essas s√£o quantidades relativamente grandes de informa√ß√µes, e eu gostaria de reduzir a quantidade de dados de c√≥pia para frente e para tr√°s, a fim de economizar mem√≥ria e tempo.  H√° um truque sobre como gravar uma grande quantidade de informa√ß√µes diretamente na mem√≥ria do WebAssembly a partir do JavaScript. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> newData = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Uint8Array</span></span>(‚Ä¶); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> size = newData.byteLength; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ptr = Module._malloc(size); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> memory = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Uint8Array</span></span>( Module.buffer, ptr, size ); memory.set(newData);</code> </pre><br>  newData s√£o nossos dados como uma matriz digitada.  Podemos tomar seu comprimento e solicitar a aloca√ß√£o de mem√≥ria do tamanho que precisamos do m√≥dulo WebAssembly.  A fun√ß√£o malloc retornar√° um ponteiro para n√≥s, que √© apenas o √≠ndice da matriz que cont√©m toda a mem√≥ria no WebAssembly.  Do lado do JavaScript, ele se parece com um ArrayBuffer. <br><br>  Na pr√≥xima etapa, abriremos uma janela nesse ArrayBuffer do tamanho certo de um determinado local e copiaremos nossos dados l√°.  Apesar do fato de a opera√ß√£o set ter sem√¢ntica de c√≥pia, quando observei esta se√ß√£o no criador de perfil, n√£o vi um processo longo.  Eu acho que o navegador otimiza essa opera√ß√£o com a ajuda da sem√¢ntica de movimento, ou seja, transfere a propriedade da mem√≥ria de um objeto para outro. <br><br>  E em nosso aplicativo, tamb√©m contamos com a sem√¢ntica de movimenta√ß√£o para economizar c√≥pias de mem√≥ria. <br><br><h3>  Adblock </h3><br>  Um problema interessante, em vez disso, com o Adblock.  Acontece que na R√∫ssia todos os bloqueadores populares recebem uma assinatura do RU Adlist, e tem uma regra t√£o maravilhosa que pro√≠be o download do WebAssembly de sites de terceiros.  Por exemplo, com uma CDN. <br><br><img src="https://habrastorage.org/webt/os/wt/kg/oswtkgtaeovfuk9r4d-gehdwdwe.png"><br><br>  A sa√≠da √© n√£o usar a CDN, mas armazenar tudo no seu dom√≠nio (isso n√£o nos conv√©m).  Ou renomeie o arquivo .wasm para que ele n√£o se encaixe nessa regra.  Voc√™ ainda pode ir ao f√≥rum desses camaradas e tentar convenc√™-los a remover esta regra.  Eu acho que eles se justificam lutando contra os mineiros dessa maneira, embora eu n√£o saiba por que eles n√£o conseguem adivinhar o nome do arquivo. <br><br><h2>  Produ√ß√£o </h2><br>  Como resultado, entramos em produ√ß√£o.  Sim, n√£o foi f√°cil, demorou 8 meses e quero me perguntar se valeu a pena.  Na minha opini√£o - valeu a pena: <br><br><h3>  N√£o √© necess√°rio instalar </h3><br>  Conclu√≠mos que nosso c√≥digo √© entregue ao usu√°rio sem instalar nenhum programa.  Quando t√≠nhamos um plug-in de navegador, o usu√°rio precisava fazer o download e instal√°-lo, e esse √© um filtro enorme para a distribui√ß√£o de tecnologia.  Agora, o usu√°rio apenas assiste o v√≠deo no site e nem entende que todo um maquin√°rio funciona sob o cap√¥ e que tudo √© complicado por l√°.  O navegador apenas baixa um arquivo adicional com o c√≥digo, como uma imagem ou .css. <br><br><h3>  Base de c√≥digo unificada e depura√ß√£o em diferentes plataformas </h3><br>  Ao mesmo tempo, conseguimos manter nossa base de c√≥digos √∫nica.  Podemos distorcer o mesmo c√≥digo em plataformas diferentes e aconteceu repetidamente que erros que eram invis√≠veis em uma das plataformas apareciam na outra.  E assim, podemos detectar erros ocultos com diferentes ferramentas em diferentes plataformas. <br><br><h3>  Libera√ß√£o r√°pida </h3><br>  Temos um lan√ßamento r√°pido, pois podemos ser lan√ßados como um aplicativo Web simples e atualizar o c√≥digo C ++ a cada novo lan√ßamento.  Ele n√£o se compara com o lan√ßamento de novos plugins, aplicativos m√≥veis ou aplicativos SmartTV.  O lan√ßamento depende apenas de n√≥s: quando queremos, ent√£o ele ser√° lan√ßado. <br><br><h3>  Feedback r√°pido </h3><br>  E isso significa feedback r√°pido: se algo der errado, podemos descobrir durante o dia que h√° um problema e responder a ele. <br><br>  Acredito que todos esses problemas valeram essas vantagens.  Nem todo mundo tem um aplicativo C ++, mas se voc√™ tem um e deseja que ele esteja no navegador - o WebAssembly √© um caso de uso 100% para voc√™. <br><br><h2>  Onde aplicar </h2><br>  Nem todo mundo escreve em C ++.  Mas n√£o apenas o C ++ est√° dispon√≠vel para o WebAssembly.  Sim, essa √© historicamente a primeira plataforma que ainda estava dispon√≠vel no asm.js, uma tecnologia antiga do Mozilla.  A prop√≥sito, portanto, ele tem boas ferramentas, como  eles s√£o mais antigos que a pr√≥pria tecnologia. <br><br><h3>  Ferrugem </h3><br>  A nova linguagem Rust, que tamb√©m est√° sendo desenvolvida pela Mozilla, agora est√° alcan√ßando e ultrapassando o C ++ em termos de ferramentas.  Tudo vai ao ponto de tornar o processo de desenvolvimento mais interessante para o WebAssembly. <br><br><h3>  Lua, Perl, Python, PHP, etc. </h3><br>  Quase todas as linguagens interpretadas tamb√©m est√£o dispon√≠veis no WebAssembly, uma vez que seus int√©rpretes s√£o escritos em C ++, eles foram simplesmente compilados no WebAssembly e agora voc√™ pode alterar o PHP em um navegador. <br><br><h3>  Go </h3><br>  Na vers√£o 1.11, eles fizeram uma vers√£o beta da compila√ß√£o no WebAssembly, na 2.0 eles prometem suporte √† libera√ß√£o.  Seu suporte apareceu mais tarde, porque o WebAssembly n√£o suporta coletor de lixo e o Go √© um idioma de mem√≥ria gerenciada.  Ent√£o eles tiveram que arrastar seu coletor de lixo para o WebAssembly. <br><br><h3>  Kotlin / Nativo </h3><br>  Sobre a mesma hist√≥ria com Kotlin.  O compilador deles tem suporte experimental, mas eles tamb√©m ter√£o que fazer algo com o coletor de lixo.  N√£o sei qual √© o status. <br><br><h3> 3D- </h3><br>    ? ,     ‚Äî 3D-. , ,  asm.js  WebAssembly      .  ,         WebAssembly. <br><br><img src="https://habrastorage.org/webt/lt/u2/7q/ltu27qaab_yjbryhnm_ayf-edsa.png"><br><br><h3>    </h3><br>           ,   :      ,  ,  .    ,             . <br><br><h3>   </h3><br><br><img src="https://habrastorage.org/webt/2u/mi/dz/2umidzjddihmiikdgktwjdk4hpe.png"><br><br>         . , ,      ,     ,         . , ,        ;   ‚Äî   . <br><br><img src="https://habrastorage.org/webt/0q/-e/0s/0q-e0sqshcd_t-p4ioyhtoe0z-k.png"><br><br> ,  Google Chrome,      ,    WebAssembly-.     npm-  ,   Wasm,     JS.      , ++  -  ‚Äî    . <br><br>      HunSpell ‚Äî      Wasm . <br><br><h3>  </h3><br>      ‚Äî ¬´   ¬ª.     , -        ,       ‚Äî  OpenSSL.       WebAssembly. OpenSSL ‚Äî   ,   ,    . <br><br><h3>     </h3><br>  use case    wotinspector.com.     World of Tanks.     ,  ,    ,   ,  ,      . <br><br>   ‚Äî      .      ,       ,   .    ,  ,  -  ++,    WebAssembly,            (   ,        ). <br><br>        .  ,     ,     .       .     ,     ,      ,   ,      .        .    . <br><br><h3>  </h3><br>      ,      , ++. ,  FFmpeg,      .      ,   ffmpeg.          .     , ,     ,      ,     . <br><br><img src="https://habrastorage.org/webt/aa/tu/u8/aatuu8b5uzbxmnhv_8mjb93jcxa.png"><br><br>     ‚Äî            .   OpenCV ‚Äî    ,   WebAssembly,        .    PDF.      SQLite,    SQL.  SQLite  WebAssembly   Emscripten,      . <br><br><h3> Node.js </h3><br><br><img src="https://habrastorage.org/webt/dl/mf/tn/dlmftnxe8bjvt-ys-jyyy-aunde.png"><br><br>       WebAssembly,    Node.js. ,   Sass ‚Äî  css.     Ruby,       ++ ( libsass).          ,       Webpack',       Node.js.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">node-sass</a>   ,  JS-   . <br><br>  ,         ,      .       .    : <br><br><img src="https://habrastorage.org/webt/bv/s0/rp/bvs0rpy6naa9-dhac6zingbv-cw.png"><br><br>    ,     node-sass    100      .     ,        ( ) .  WebAssembly   :       ,     WebAssembly    . <br><br>                    Node.    ,   WebAssembly     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">libsass-asm</a> .   ,       .      WebAssembly   ‚Ä¶ <br><br><h3>   </h3><br>    Figma ‚Äî    web-.   -   Sketch,     ,     .    ++ (    ),     asm.js.   ,    . <br><br><img src="https://habrastorage.org/webt/ht/ad/2t/htad2t3hmsfx_txwjfhk-_qlh2w.png"><br><br>   WebAssembly,    ,      3 .     ,         . <br><br>     Visual Studio Code,   ,    Electron,        ,          ,   Node-sass. ,     Node,            . ,  ,     ,      WebAssembly. <br><br><h3>     </h3><br><br><img src="https://habrastorage.org/webt/tz/qg/2a/tzqg2a7sw01qlqnvwjcjzkxqkyw.png"><br><br>        ‚Äî AutoCAD.   30 ,    ++,     .      ,    ,              -  JavaScript,    ,      .    WebAssembly <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">AutoCAD   -</a> ,     5      . <br><br>   ,    , ,   , ,       ,    , ,    .   FFMpeg ‚Äî   ,     ‚Äî QEMU. ,     ,       KVM,        . <br><br><img src="https://habrastorage.org/webt/zq/3c/aj/zq3cajq6z-ftdftt0a1bnveqj1m.png"><br><br>   2011   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> QEMU  </a> .  ,             .  , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://bellard.org/jslinux/vm.html%3Furl%3D">Linux  </a> ,  Linux-,     , -  . <br><br>   ,    .   bash,    ,     Linux.   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://bellard.org/jslinux/vm.html%3Furl%3D">  ‚Äî  GUI</a> .       .  ,    ,        ‚Ä¶ <br><br><img src="https://habrastorage.org/webt/jf/zc/bo/jfzcbori9ee4oah-1nmumj8ebqk.png"><br><br> ,     ,  - . <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://bellard.org/jslinux/vm.html%3Furl%3D"> Windows 2000</a> ,  ,   18  ,       .     ,     Chrome ( FireFox). <br><br>   ,  WebAssembly ,    ,   ,      ,     . <br><br><h2>      </h2><br>       ,       WebAssembly. ,     ‚Äî  ,  .   ‚Äî  ,       . <br><br><img src="https://habrastorage.org/webt/ea/ls/ak/ealsak2klb2rgvobxmirs1rn0_s.png"><br><br>  ,     C++      web-.   ,  ,       ‚Äî      .    ‚Äî  ,      ,      ,     . <br><br>  ,      .   ,    C++,      JavaScript,        .     ,         C++.              ,       JS  C++,      . <br><br>         ‚Äî   . <br><br><img src="https://habrastorage.org/webt/fx/nj/wb/fxnjwbotpkneisrtmlze8-0afdy.png"><br><br><h2> CI Pipeline </h2><br>      ?    JS-   ,        Webpack.      ,   ,  (     ),       JS.    webpack   watch,  ,          . <br><br><img src="https://habrastorage.org/webt/zv/s_/r4/zvs_r45efsroktebku2lrdmuv9e.png"><br><br><h2>  </h2><br>  ,     .  ,  ,    . <br><br>   Chrome   DevTools,      Sources   wasm-.     (    - ), ,  ,      . <br><br><img src="https://habrastorage.org/webt/ea/ir/8u/eair8uahusoyylejgtccro0g1-a.png"><br><br>    ,        ,      : ¬´,     , ,    ,  ,   !¬ª.  ,     embedded-,    ,    -     . <br><br>   :     -g4  wast-   ,     . <br><br><img src="https://habrastorage.org/webt/0k/6w/af/0k6wafnm3pp62o-a5t8dcoxivxy.png"><br><br>   ,      100  (  FAR).  ‚Äî  ,       Chrome. E:/_work/bfg/bytefrog/‚Ä¶ ‚Äî    .    ,      ++     .   ,    SourceMap! <br><br><h2> SourceMap </h2><br>  ,     . <br><ul><li>    Firefox. </li><li> --sourcemap-base=http://localhost  ,    SourceMap   -,    . </li><li>     HTTP. </li><li>       . </li><li>  Windows    ¬´:¬ª  .     . </li></ul><br><br>     . CMake        ,        URL  -.    :  wast-       ,    . ,     . <br><br>  ,    : <br><br><img src="https://habrastorage.org/webt/ev/hn/fo/evhnfovmbp4hdynewi_r6buhx_a.png"><br><br>  ++   .    !   ,   ,  stack trace,      .  ,     wasm-  stack trace,   ,   , , ,  . <br><br><img src="https://habrastorage.org/webt/ql/zi/x8/qlzix8vqcrbdziehrmmrmq4uz0a.png"><br><br>  ,      ‚Äî SourceMap     .  ,        ,    .           ,      . <br><br><img src="https://habrastorage.org/webt/vk/e4/vk/vke4vkmnpcbp9gm8tuac-92xany.png"><br><br>             ¬´var0¬ª. <br><br><img src="https://habrastorage.org/webt/yh/rc/xx/yhrcxxqcvj0upcy6negdcw0b9c0.png"><br><br> ,           . ,      SourceMap,       ,   . <br><br><h2>  </h2><br>     .     Chrome,   Firefox.  Firefox  ‚Äî  ¬´¬ª ,    ,      . <br><br><img src="https://habrastorage.org/webt/bv/va/x1/bvvax1w0kvo4gsmx7ry0bgbekhe.png"><br><br> Chrome    ( ,  ,  Mangled  ), ,  ,  ,    . <br><br><img src="https://habrastorage.org/webt/gv/jh/rp/gvjhrpyqjxyvsyq4xjigmdmwxa8.png"><br><br><h2>  </h2><br>   .     ,   : <br><br><ul><li> .     runtime,   .   ++      Rust  Go. </li><li>    JS ‚Äî Wasm.     ,         JS  Wasm.      -,    ,    .      ,    . </li><li>  .  ,   ,     ,       . </li><li> Wasm   . Wasm  ,       JS.  WebAssembly   ,       . </li><li>        JS. </li></ul><br><br>    :    . <br><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">wasp_cpp_bench</a> </li><li> Chrome 65.0.3325.181 (64-bit) </li><li> Core i5-4690 </li><li> 24gb ram </li><li> 5 ;  max  min;  </li></ul><br><br>   .         JS ‚Äî  ,     . <br><br><img src="https://habrastorage.org/webt/sg/e7/to/sge7toujmxycrhznogviscz94dy.png"><br><br> ++,   ,   -  .      Grayscale.   C++    ,   .     ( ),   ,    JS. ,  ,       ,   ++,   . <br><h2>     </h2><br>   Sentry,      ‚Äî     wasm. ,   traceKit,    Sentry ‚Äî Raven, ‚Äî    ,    ,  wasm .   , , ,    pull request,     npm install  JS-. <br><br><img src="https://habrastorage.org/webt/rd/vm/-z/rdvm-zijheakjsktoubausmmyc8.png"><br><br>    .   production,     ,   .    debug-,     ,    : <br><br><img src="https://habrastorage.org/webt/gn/e_/_t/gne__tfliahfwe1sfndiid2tmyq.png"><br><br><h2>  </h2><br><ul><li> WebAssembly     ,     . </li><li>     ‚Äî .     8 ,           C++,   ,    . </li><li>   ,      ,   WebAssembly ‚Äî     . </li><li>  ‚Äî   JS.  JS-      ,    ¬´¬ª   ,     ,     . </li></ul><br><br>    , : <br><ul><li>  Emscripten  Embind.     . </li><li>   -   Emscripten ‚Äî   .  ,    ,     3000      Emscripten. </li><li>     Sentry. </li><li>   Firefox. </li></ul><br><br>  Obrigado pela aten√ß√£o!      . <br><br><img src="https://habrastorage.org/webt/2h/qu/au/2hquauawvppoc-iu5un4wgevnvo.png"><br><br><blockquote>        HolyJS,  : <b>24-25   </b>   <b>HolyJS</b> .  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> </a>      (,   Node.js Ryan Dahl!),      ‚Äî   1   . </blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt441140/">https://habr.com/ru/post/pt441140/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt441130/index.html">Desempenho equilibrado do site. Parte 1: Estrat√©gia</a></li>
<li><a href="../pt441132/index.html">Para que Roskomnadzor n√£o venha de repente</a></li>
<li><a href="../pt441134/index.html">Emo√ß√µes, trabalho independente</a></li>
<li><a href="../pt441136/index.html">Armazenamento de longo prazo das m√©tricas do Prometheus (Alexey Palazhchenko, Percona)</a></li>
<li><a href="../pt441138/index.html">Solu√ß√µes de bate-papo em tempo real versus plataformas de bate-papo - fa√ßa sua escolha</a></li>
<li><a href="../pt441142/index.html">12 pontos de crescimento de convers√µes ou conte√∫do que realmente vende</a></li>
<li><a href="../pt441146/index.html">Redes sem fio industriais: qual escolher?</a></li>
<li><a href="../pt441148/index.html">Como lidar com os erros corretamente: o sil√™ncio nem sempre √© bom</a></li>
<li><a href="../pt441150/index.html">Primeira introdu√ß√£o ao protocolo HTTP, escrevendo o servidor Java Web mais simples</a></li>
<li><a href="../pt441152/index.html">Como minimizar erros ao integrar com servi√ßos externos: a experi√™ncia de um corretor online</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>