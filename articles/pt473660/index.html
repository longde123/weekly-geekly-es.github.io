<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèì üçù üëã Arcade Reverse Engineering: Record Michael Jordan no NBA Jam üë®‚Äçüë®‚Äçüë¶‚Äçüë¶ ü§≥üèæ üï∫üèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="No ver√£o passado, fui convidado para uma festa em Sunnyvale. Acontece que os propriet√°rios da garagem t√™m uma m√°quina de arcade NBA JAM Tournament Edi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Arcade Reverse Engineering: Record Michael Jordan no NBA Jam</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/473660/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7e1/f90/849/7e1f90849dee7927ad904dca4f68bf2d.png" width="150%"></div><br>  No ver√£o passado, fui convidado para uma festa em Sunnyvale.  Acontece que os propriet√°rios da garagem t√™m uma m√°quina de arcade NBA JAM Tournament Edition para quatro jogadores.  Apesar do jogo j√° ter mais de 25 anos (lan√ßado em 1993), ainda √© muito interessante jog√°-lo, principalmente para f√£s entusiasmados. <br><br>  Fiquei surpreso com a lista de jogadores do Chicago Bulls que n√£o inclu√≠a Michael Jordan.  Segundo fontes <sup>[1]</sup> , o MJ recebeu sua pr√≥pria licen√ßa e n√£o fazia parte do acordo que a Midway fez com a NBA. <br><br>  Depois de perguntar ao propriet√°rio da m√°quina, aprendi que os hackers lan√ßaram um mod para o SNES "NBA Jam 2K17", que permite que novos jogadores e MJ joguem, mas ningu√©m estava analisando como a vers√£o arcade funcionava.  Portanto, eu definitivamente tive que olhar para dentro. <br><a name="habracut"></a><br><h2>  Antecedentes </h2><br>  A hist√≥ria do NBA Jam come√ßa n√£o com basquete, mas com Jean-Claude Van Damme.  Na mesma √©poca em que o Universal Soldier foi lan√ßado, a Midway Games desenvolveu tecnologia para manipular sprites grandes, digitalizados e fotorrealistas, que mant√™m uma semelhan√ßa com atores reais.  Foi um grande avan√ßo tecnol√≥gico: anima√ß√µes com 60 quadros por segundo, sprites in√©ditos de tamanho de 100x100 pixels, cada um com sua pr√≥pria paleta de 256 cores. <br><br>  A empresa usou essa tecnologia com grande sucesso no popular jogo de tiro "Terminator 2: Judgement Day" <sup>[2]</sup> , mas n√£o conseguiu adquirir uma licen√ßa para "Universal Soldier" (as condi√ß√µes financeiras da JCVD ‚Äã‚Äãeram inaceit√°veis ‚Äã‚Äãpara Midway <sup>[3]</sup> ).  Quando as negocia√ß√µes terminaram em fracasso, a Midway mudou de rumo e come√ßou a desenvolver um jogo de luta de sucesso da Capcom de 1991 chamado Street Fighter II: The World Warrior. <br><br>  Uma equipe de quatro foi montada (Ed Boone escreveu o c√≥digo, John Tobias estava envolvido em arte e scripts, John Vogel desenhou gr√°ficos e Dan Forden era um engenheiro de som).  Ap√≥s um ano de muito trabalho <sup>[4], a</sup> Midway lan√ßou o Mortal Kombat em 1992. <br><br>  O estilo visual era muito diferente do pixel art usual, e o design do jogo era, para dizer o m√≠nimo, "controverso".  O jogo com litros de sangue na tela e empurr√µes insanamente cru√©is - ‚Äúfatalidade‚Äù instantaneamente se tornou um sucesso mundial e ganhou quase 1 bilh√£o de d√≥lares em um ano <sup>[5]</sup> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b3b/39e/38c/b3b39e38c2dc236966ea48153bd2c9fc.png"></div><br>  <i>SF2: 384 √ó 224 com 4.096 cores.</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8fa/ecc/af5/8faeccaf515916b68f8b63e8a08357e9.png"></div><br>  <i>MK: 400 √ó 254 com 32.768 cores.</i> <br><br>  <u><b>Fato interessante:</b></u> como no modo VGA 0x13 no PC, nesses jogos os pixels n√£o eram quadrados.  Embora o buffer de quadro do Mortal Kombat tenha um tamanho de 400 √ó 254, ele √© esticado para uma propor√ß√£o de 4: 3 de uma tela CRT, fornecendo uma resolu√ß√£o de 400 √ó 300 <sup>[6]</sup> <br><br><h2>  Midway T-Unit Equipment </h2><br>  O hardware desenvolvido pela Midway para Mortal Kombat acabou por ser muito bom.  T√£o bom que ele recebeu seu pr√≥prio nome T-Unit e foi reutilizado em outros jogos. <br><br><ul><li>  Mortal Kombat. </li><li>  Mortal Kombat II. </li><li>  NBA Jam. </li><li>  Edi√ß√£o da NBA Jam Tournament. </li><li>  Juiz Dredd (n√£o foi libertado). </li></ul><br>  A unidade T consiste em duas placas.  A maioria deles lida com l√≥gica e gr√°ficos de jogos. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/753/893/a37/753893a376a67cef13cef49846d2ae82.png" width="100%"></div><br>  <i>Placa processadora NBA JAM TE Edition (aproximadamente 40x40 cm ou 15 polegadas).</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/300/f9c/fb4/300f9cfb461f4833a340ad1028f9f389.png" width="55%"></div><br>  A outra diretoria √© menos complicada, mas tamb√©m capaz de muito.  Ele √© projetado para √°udio, mas pode tocar n√£o apenas m√∫sica usando a s√≠ntese FM, mas tamb√©m som digital. <br><br>  A placa de som est√° conectada a uma fonte de energia e a uma placa gr√°fica instalada na parte traseira.  Preste aten√ß√£o ao enorme radiador localizado no canto superior esquerdo. <br><br>  Juntas, essas duas placas cont√™m mais de duzentos chips, resistores e EPROM.  Entender tudo isso apenas com base em n√∫meros de s√©rie seria muito demorado.  Mas, surpreendentemente, √†s vezes em dispositivos da documenta√ß√£o dos anos 90 √© descoberto acidentalmente.  E no caso da NBA Jam, ela era √≥tima. <br><br><h2>  Arquitetura de unidade T intermedi√°ria </h2><br>  Procurando dados, me deparei com um Kit de Jam da NBA.  O n√≠vel de detalhe deste documento √© incr√≠vel <sup>[7]</sup> .  Entre outras coisas, consegui encontrar uma descri√ß√£o detalhada das conex√µes de fia√ß√£o, incluindo EPROMs e chips. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3e2/f43/ef7/3e2f43ef76224de29c2376514fdfea3b.jpg" width="100%"></div><br>  As informa√ß√µes do documento nos permitiram desenhar um diagrama das placas e determinar a fun√ß√£o de cada parte.  Para auxiliar na busca de componentes, a placa possui coordenadas com um come√ßo no canto inferior direito (UA0), aumentando para o canto superior esquerdo (UJ26). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/552/c6d/525/552c6d5257527f5a7c8655eb51acfdd9.svg" width="100%"></div><br>  O cora√ß√£o da placa principal √© o Texas Instrument TMS34010 (UB21) com uma frequ√™ncia de 50 MHz e com 1 c√≥digo de mebibyte em EPROMs e DRAM de 512 kibibytes <sup>[8]</sup> .  34010 √© um chip de 32 bits com um barramento de 16 bits, que possui instru√ß√µes gr√°ficas not√°veis ‚Äã‚Äãcomo PIXT e PIXBLT <sup>[9]</sup> .  No in√≠cio dos anos 90, esse chip foi usado em v√°rias placas de acelera√ß√£o de hardware <sup>[10]</sup> , e eu pensei que ele lida com uma quantidade consider√°vel de efeitos gr√°ficos.  Surpreendentemente, ele lida apenas com a l√≥gica do jogo e n√£o desenha nada. <br><br>  De fato, o chip UE13 chamado ‚ÄúDMA2‚Äù acabou sendo um monstro gr√°fico.  De acordo com os diagramas da documenta√ß√£o, ele possui um impressionante (naquele tempo) barramento de dados de 32 bits e um barramento de endere√ßos de 32 bits, raz√£o pela qual se tornou o maior chip da placa.  Este circuito integrado especializado (ASIC) √© capaz de muitas opera√ß√µes gr√°ficas, as quais discutirei abaixo. <br><br>  Todos os chips (RAM do sistema, GFX EPROM, SDRAM da paleta, c√≥digo, bancos de v√≠deo) s√£o mapeados para um espa√ßo de endere√ßo de 32 bits e conectados ao mesmo barramento.  N√£o encontrei nenhuma informa√ß√£o sobre o protocolo de barramento; portanto, se voc√™ souber algo sobre isso, escreva para o e-mail. <br><br>  Preste aten√ß√£o a um truque: um componente EPROM (marcado em azul) √© usado para criar outro sistema de armazenamento (e economizar dinheiro).  Essas EPROMs de 512 kb t√™m pinos de endere√ßo de 32 bits e pinos de dados de 8 bits.  Para o 34010, que requer um barramento de dados de 16 bits, duas EPROMs (J12 e G12) s√£o conectadas com uma dupla altern√¢ncia de endere√ßos, criando mem√≥ria em 1 mebibyte.  Da mesma forma, os recursos gr√°ficos s√£o conectados a uma altern√¢ncia de endere√ßos quadruplicada para formar um endere√ßo de 32 bits com um sistema de armazenamento de 32 bits contendo 8 mebibytes. <br><br>  Embora neste artigo eu considere principalmente o pipeline de gr√°ficos, n√£o resisto √† tenta√ß√£o e, portanto, falarei brevemente sobre o sistema de √°udio. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/26b/07c/c13/26b07cc13020639a04bc7f25b5ef0117.svg" width="55%"></div><br>  O diagrama da placa de som mostra o Motorola 6809 (U4 com uma frequ√™ncia de 2 MHz), que recebe instru√ß√µes de uma EPROM (U3) para controlar a m√∫sica e os efeitos sonoros. <br><br>  O chip de s√≠ntese FM da Yamaha 2151 (3,5 MHz) gera m√∫sica diretamente das instru√ß√µes recebidas do 6809 (a m√∫sica usa uma largura de banda bastante pequena). <br><br>  O OKI6295 (1 MHz) √© respons√°vel por reproduzir √°udio digital no formato ADPCM (por exemplo, o lend√°rio "Boomshakalaka" <sup>[11]</sup> Tim Kittsrow). <br><br>  Observe que na placa principal, o mesmo EPROM azul de 512 kbytes de 32a / 8d √© usado em um sistema de 16 bits com intercala√ß√£o dupla de endere√ßos para armazenar vozes digitalizadas, mas para instru√ß√µes de 8 bits, os dados / endere√ßos do Motorola 6809 n√£o s√£o intercalados. <br><br><h2>  Vida do quadro </h2><br>  A tela inteira do NBA Jam √© indexada em uma paleta de 16 bits.  As cores s√£o armazenadas no formato xRGB 1555 em uma paleta de 64 kbytes.  A paleta √© dividida em 128 blocos (256 * 16 bits) de 512 bytes.  Sprites armazenados na EPROM est√£o marcados como "GFX".  Cada sprite tem sua pr√≥pria paleta de cores de at√© 256x16 bits.  Um sprite geralmente usa um bloco de paleta inteiro, mas nunca mais que um.  Um sinal CRT √© transmitido ao monitor usando RAMDAC, que para cada pixel l√™ o √≠ndice dos bancos de DRAM de v√≠deo e realiza uma pesquisa de cores na paleta. <br><br>  A vida de cada quadro de um v√≠deo da NBA Jam √© a seguinte: <br><br><ol><li>  A l√≥gica do jogo consiste em um fluxo de instru√ß√µes de 16 bits transmitidas de J12 / G12 a 34010. </li><li>  34010 l√™ a entrada do jogador, calcula o status do jogo e desenha uma tela. </li><li>  Para desenhar na tela, o 34010 primeiro encontra um bloco n√£o utilizado na paleta e grava a paleta sprite (as paletas sprite s√£o armazenadas juntamente com as instru√ß√µes 34010 em J12 / G12). </li><li>  34010 faz uma solicita√ß√£o ao DMA2, que inclui o endere√ßo e o tamanho do sprite, o bloco de paleta de 8 bits usado, truncamento, dimensionamento, o m√©todo de processamento de pixels transparentes e assim por diante. </li><li>  O DMA2 l√™ √≠ndices de sprite de 8 bits do chip ROM J14-G23 GFX, combina esse valor com o √≠ndice de um bloco de paleta de 8 bits e grava um √≠ndice de 16 bits nos bancos de v√≠deo.  A DRAM2 pode ser considerada um blitter que l√™ valores de 8 bits da GFX EPROM e grava valores de 16 bits em bancos de v√≠deo </li><li>  As etapas 3 a 5 s√£o repetidas at√© que todas as solicita√ß√µes de desenho de sprites sejam conclu√≠das. </li><li>  Quando se trata de atualiza√ß√£o de tela, o RAMDAC converte os dados nos bancos de v√≠deo em um sinal que um monitor CRT pode entender.  Para que a largura de banda seja suficiente para converter o √≠ndice de 16 bits em RGB de 16 bits, a paleta √© armazenada em uma SRAM extremamente cara e extremamente r√°pida. </li></ol><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f95/cca/564/f95cca564f1eb585bce4cf20470590b1.jpg" width="30%"></div><br>  <u><b>Um fato interessante: o</b></u> firmware flash da EPROM n√£o √© um processo t√£o simples.  Antes de escrever no chip, voc√™ deve apagar completamente todo o seu conte√∫do. <br><br>  Para fazer isso, o chip deve ser irradiado com luz UV.  Primeiro, voc√™ precisa soltar o adesivo da parte superior da EPROM para abrir seu diagrama.  Em seguida, a EPROM √© colocada em um dispositivo apagador especial no qual h√° uma l√¢mpada UV. <br><br>  Ap√≥s 20 minutos, a EPROM ser√° preenchida com zeros e pronta para grava√ß√£o. <br><br><h2>  Documenta√ß√£o MAME </h2><br>  Tendo descoberto o equipamento, percebi que conjunto de EPROM voc√™ poderia escrever para Michael Jordan (a paleta √© armazenada nas EPROMs de c√≥digo e os √≠ndices nas EPROMs GFX).  No entanto, eu ainda n√£o sabia a localiza√ß√£o exata ou o formato usado. <br><br>  Documenta√ß√£o ausente encontrada em MAME. <br><br>  Caso voc√™ n√£o saiba como esse incr√≠vel emulador funciona, explicarei brevemente.  O MAME √© baseado no conceito de "drivers", que s√£o uma imita√ß√£o do conselho.  Cada driver √© composto de componentes que imitam (geralmente) cada chip.  No caso da Midway T-Unit, estamos interessados ‚Äã‚Äãnos seguintes arquivos: <br><br><pre>  mame / includes / midtunit.h
 mame / src / mame / video / midtunit.cpp
 mame / src / mame / drivers / midtunit.cpp
 mame / src / mame / machine / midtunit.cpp
 cpu / tms34010 / tms34010.h </pre><br>  Se voc√™ olhar para drivers / midtunit.cpp, veremos que cada chip de mem√≥ria faz parte de um √∫nico espa√ßo de endere√ßo de 32 bits.  Pode ser visto no c√≥digo-fonte do driver que a paleta come√ßa em 0x01800000, gfxrom come√ßa em 0x02000000 e o chip DMA2 come√ßa em 0x01a80000.  Para seguir o caminho dos dados, precisamos seguir as fun√ß√µes C ++ executadas quando o objeto da opera√ß√£o de leitura ou grava√ß√£o √© o endere√ßo da mem√≥ria. <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> midtunit_state::main_map(address_map &amp;<span class="hljs-built_in"><span class="hljs-built_in">map</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">map</span></span>.unmap_value_high(); <span class="hljs-built_in"><span class="hljs-built_in">map</span></span>(<span class="hljs-number"><span class="hljs-number">0x00000000</span></span>, <span class="hljs-number"><span class="hljs-number">0x003fffff</span></span>).rw(m_video, FUNC(midtunit_vram_r), FUNC(midtunit_vram_w)); <span class="hljs-built_in"><span class="hljs-built_in">map</span></span>(<span class="hljs-number"><span class="hljs-number">0x01000000</span></span>, <span class="hljs-number"><span class="hljs-number">0x013fffff</span></span>).ram(); <span class="hljs-built_in"><span class="hljs-built_in">map</span></span>(<span class="hljs-number"><span class="hljs-number">0x01400000</span></span>, <span class="hljs-number"><span class="hljs-number">0x0141ffff</span></span>).rw(FUNC(midtunit_cmos_r), FUNC(midtunit_cmos_w)).share(<span class="hljs-string"><span class="hljs-string">"nvram"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">map</span></span>(<span class="hljs-number"><span class="hljs-number">0x01480000</span></span>, <span class="hljs-number"><span class="hljs-number">0x014fffff</span></span>).w(FUNC(midtunit_cmos_enable_w)); <span class="hljs-built_in"><span class="hljs-built_in">map</span></span>(<span class="hljs-number"><span class="hljs-number">0x01600000</span></span>, <span class="hljs-number"><span class="hljs-number">0x0160000f</span></span>).portr(<span class="hljs-string"><span class="hljs-string">"IN0"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">map</span></span>(<span class="hljs-number"><span class="hljs-number">0x01600010</span></span>, <span class="hljs-number"><span class="hljs-number">0x0160001f</span></span>).portr(<span class="hljs-string"><span class="hljs-string">"IN1"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">map</span></span>(<span class="hljs-number"><span class="hljs-number">0x01600020</span></span>, <span class="hljs-number"><span class="hljs-number">0x0160002f</span></span>).portr(<span class="hljs-string"><span class="hljs-string">"IN2"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">map</span></span>(<span class="hljs-number"><span class="hljs-number">0x01600030</span></span>, <span class="hljs-number"><span class="hljs-number">0x0160003f</span></span>).portr(<span class="hljs-string"><span class="hljs-string">"DSW"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">map</span></span>(<span class="hljs-number"><span class="hljs-number">0x01800000</span></span>, <span class="hljs-number"><span class="hljs-number">0x0187ffff</span></span>).ram().w(m_palette, FUNC(write16)).share(<span class="hljs-string"><span class="hljs-string">"palette"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">map</span></span>(<span class="hljs-number"><span class="hljs-number">0x01a80000</span></span>, <span class="hljs-number"><span class="hljs-number">0x01a800ff</span></span>).rw(m_video, FUNC(midtunit_dma_r), FUNC(midtunit_dma_w)); <span class="hljs-built_in"><span class="hljs-built_in">map</span></span>(<span class="hljs-number"><span class="hljs-number">0x01b00000</span></span>, <span class="hljs-number"><span class="hljs-number">0x01b0001f</span></span>).w(m_video, FUNC(midtunit_control_w)); <span class="hljs-built_in"><span class="hljs-built_in">map</span></span>(<span class="hljs-number"><span class="hljs-number">0x01d00000</span></span>, <span class="hljs-number"><span class="hljs-number">0x01d0001f</span></span>).r(FUNC(midtunit_sound_state_r)); <span class="hljs-built_in"><span class="hljs-built_in">map</span></span>(<span class="hljs-number"><span class="hljs-number">0x01d01020</span></span>, <span class="hljs-number"><span class="hljs-number">0x01d0103f</span></span>).rw(FUNC(midtunit_sound_r), FUNC(midtunit_sound_w)); <span class="hljs-built_in"><span class="hljs-built_in">map</span></span>(<span class="hljs-number"><span class="hljs-number">0x01d81060</span></span>, <span class="hljs-number"><span class="hljs-number">0x01d8107f</span></span>).w(<span class="hljs-string"><span class="hljs-string">"watchdog"</span></span>, FUNC(watchdog_timer_device::reset16_w)); <span class="hljs-built_in"><span class="hljs-built_in">map</span></span>(<span class="hljs-number"><span class="hljs-number">0x01f00000</span></span>, <span class="hljs-number"><span class="hljs-number">0x01f0001f</span></span>).w(m_video, FUNC(midtunit_control_w)); <span class="hljs-built_in"><span class="hljs-built_in">map</span></span>(<span class="hljs-number"><span class="hljs-number">0x02000000</span></span>, <span class="hljs-number"><span class="hljs-number">0x07ffffff</span></span>).r(m_video, FUNC(midtunit_gfxrom_r)).share(<span class="hljs-string"><span class="hljs-string">"gfxrom"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">map</span></span>(<span class="hljs-number"><span class="hljs-number">0x1f800000</span></span>, <span class="hljs-number"><span class="hljs-number">0x1fffffff</span></span>).rom().region(<span class="hljs-string"><span class="hljs-string">"maincpu"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-comment"><span class="hljs-comment">/* mirror used by MK*/</span></span> <span class="hljs-built_in"><span class="hljs-built_in">map</span></span>(<span class="hljs-number"><span class="hljs-number">0xff800000</span></span>, <span class="hljs-number"><span class="hljs-number">0xffffffff</span></span>).rom().region(<span class="hljs-string"><span class="hljs-string">"maincpu"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); }</code> </pre> <br>  No final do mesmo arquivo ‚Äúdrivers / midtunit.cpp‚Äù, vemos como o conte√∫do das EPROMs √© carregado na RAM.  No caso dos recursos gr√°ficos ‚Äúgfxrom‚Äù (associados ao endere√ßo 0x02000000), podemos ver que eles ocupavam 8 mebibytes de espa√ßo de endere√ßo em blocos de chips com altern√¢ncia de endere√ßos quatro vezes maior.  Observe que os nomes dos arquivos correspondem ao local dos chips (por exemplo, UJ12 / UG12).  O conjunto desses arquivos EPROM no mundo dos emuladores √© mais conhecido como "ROM". <br><br><pre> <code class="cpp hljs">ROM_START( nbajamte ) ROM_REGION( <span class="hljs-number"><span class="hljs-number">0x50000</span></span>, <span class="hljs-string"><span class="hljs-string">"adpcm:cpu"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span> ) <span class="hljs-comment"><span class="hljs-comment">/* sound CPU*/</span></span> ROM_LOAD( <span class="hljs-string"><span class="hljs-string">"l1_nba_jam_tournament_u3_sound_rom.u3"</span></span>, <span class="hljs-number"><span class="hljs-number">0x010000</span></span>, <span class="hljs-number"><span class="hljs-number">0x20000</span></span>, NO_DUMP) ROM_RELOAD( <span class="hljs-number"><span class="hljs-number">0x030000</span></span>, <span class="hljs-number"><span class="hljs-number">0x20000</span></span> ) ROM_REGION( <span class="hljs-number"><span class="hljs-number">0x100000</span></span>, <span class="hljs-string"><span class="hljs-string">"adpcm:oki"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span> ) <span class="hljs-comment"><span class="hljs-comment">/* ADPCM*/</span></span> ROM_LOAD( <span class="hljs-string"><span class="hljs-string">"l1_nba_jam_tournament_u12_sound_rom.u12"</span></span>, <span class="hljs-number"><span class="hljs-number">0x000000</span></span>, <span class="hljs-number"><span class="hljs-number">0x80000</span></span>, NO_DUMP) ROM_LOAD( <span class="hljs-string"><span class="hljs-string">"l1_nba_jam_tournament_u13_sound_rom.u13"</span></span>, <span class="hljs-number"><span class="hljs-number">0x080000</span></span>, <span class="hljs-number"><span class="hljs-number">0x80000</span></span>, NO_DUMP) ROM_REGION16_LE( <span class="hljs-number"><span class="hljs-number">0x100000</span></span>, <span class="hljs-string"><span class="hljs-string">"maincpu"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span> ) <span class="hljs-comment"><span class="hljs-comment">/* 34010 code*/</span></span> ROM_LOAD16_BYTE( <span class="hljs-string"><span class="hljs-string">"l4_nba_jam_tournament_game_rom_uj12.uj12"</span></span>, <span class="hljs-number"><span class="hljs-number">0x00000</span></span>, <span class="hljs-number"><span class="hljs-number">0x80000</span></span>, NO_DUMP) ROM_LOAD16_BYTE( <span class="hljs-string"><span class="hljs-string">"l4_nba_jam_tournament_game_rom_ug12.ug12"</span></span>, <span class="hljs-number"><span class="hljs-number">0x00001</span></span>, <span class="hljs-number"><span class="hljs-number">0x80000</span></span>, NO_DUMP) ROM_REGION( <span class="hljs-number"><span class="hljs-number">0xc00000</span></span>, <span class="hljs-string"><span class="hljs-string">"gfxrom"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span> ) ROM_LOAD32_BYTE( <span class="hljs-string"><span class="hljs-string">"l1_nba_jam_tournament_game_rom_ug14.ug14"</span></span>, <span class="hljs-number"><span class="hljs-number">0x000000</span></span>, <span class="hljs-number"><span class="hljs-number">0x80000</span></span>, NO_DUMP) ROM_LOAD32_BYTE( <span class="hljs-string"><span class="hljs-string">"l1_nba_jam_tournament_game_rom_uj14.uj14"</span></span>, <span class="hljs-number"><span class="hljs-number">0x000001</span></span>, <span class="hljs-number"><span class="hljs-number">0x80000</span></span>, NO_DUMP) ROM_LOAD32_BYTE( <span class="hljs-string"><span class="hljs-string">"l1_nba_jam_tournament_game_rom_ug19.ug19"</span></span>, <span class="hljs-number"><span class="hljs-number">0x000002</span></span>, <span class="hljs-number"><span class="hljs-number">0x80000</span></span>, NO_DUMP) ROM_LOAD32_BYTE( <span class="hljs-string"><span class="hljs-string">"l1_nba_jam_tournament_game_rom_uj19.uj19"</span></span>, <span class="hljs-number"><span class="hljs-number">0x000003</span></span>, <span class="hljs-number"><span class="hljs-number">0x80000</span></span>, NO_DUMP) ROM_LOAD32_BYTE( <span class="hljs-string"><span class="hljs-string">"l1_nba_jam_tournament_game_rom_ug16.ug16"</span></span>, <span class="hljs-number"><span class="hljs-number">0x200000</span></span>, <span class="hljs-number"><span class="hljs-number">0x80000</span></span>, NO_DUMP) ROM_LOAD32_BYTE( <span class="hljs-string"><span class="hljs-string">"l1_nba_jam_tournament_game_rom_uj16.uj16"</span></span>, <span class="hljs-number"><span class="hljs-number">0x200001</span></span>, <span class="hljs-number"><span class="hljs-number">0x80000</span></span>, NO_DUMP) ROM_LOAD32_BYTE( <span class="hljs-string"><span class="hljs-string">"l1_nba_jam_tournament_game_rom_ug20.ug20"</span></span>, <span class="hljs-number"><span class="hljs-number">0x200002</span></span>, <span class="hljs-number"><span class="hljs-number">0x80000</span></span>, NO_DUMP) ROM_LOAD32_BYTE( <span class="hljs-string"><span class="hljs-string">"l1_nba_jam_tournament_game_rom_uj20.uj20"</span></span>, <span class="hljs-number"><span class="hljs-number">0x200003</span></span>, <span class="hljs-number"><span class="hljs-number">0x80000</span></span>, NO_DUMP) ROM_LOAD32_BYTE( <span class="hljs-string"><span class="hljs-string">"l1_nba_jam_tournament_game_rom_ug17.ug17"</span></span>, <span class="hljs-number"><span class="hljs-number">0x400000</span></span>, <span class="hljs-number"><span class="hljs-number">0x80000</span></span>, NO_DUMP) ROM_LOAD32_BYTE( <span class="hljs-string"><span class="hljs-string">"l1_nba_jam_tournament_game_rom_uj17.uj17"</span></span>, <span class="hljs-number"><span class="hljs-number">0x400001</span></span>, <span class="hljs-number"><span class="hljs-number">0x80000</span></span>, NO_DUMP) ROM_LOAD32_BYTE( <span class="hljs-string"><span class="hljs-string">"l1_nba_jam_tournament_game_rom_ug22.ug22"</span></span>, <span class="hljs-number"><span class="hljs-number">0x400002</span></span>, <span class="hljs-number"><span class="hljs-number">0x80000</span></span>, NO_DUMP) ROM_LOAD32_BYTE( <span class="hljs-string"><span class="hljs-string">"l1_nba_jam_tournament_game_rom_uj22.uj22"</span></span>, <span class="hljs-number"><span class="hljs-number">0x400003</span></span>, <span class="hljs-number"><span class="hljs-number">0x80000</span></span>, NO_DUMP) ROM_LOAD32_BYTE( <span class="hljs-string"><span class="hljs-string">"l1_nba_jam_tournament_game_rom_ug18.ug18"</span></span>, <span class="hljs-number"><span class="hljs-number">0x600000</span></span>, <span class="hljs-number"><span class="hljs-number">0x80000</span></span>, NO_DUMP) ROM_LOAD32_BYTE( <span class="hljs-string"><span class="hljs-string">"l1_nba_jam_tournament_game_rom_uj18.uj18"</span></span>, <span class="hljs-number"><span class="hljs-number">0x600001</span></span>, <span class="hljs-number"><span class="hljs-number">0x80000</span></span>, NO_DUMP) ROM_LOAD32_BYTE( <span class="hljs-string"><span class="hljs-string">"l1_nba_jam_tournament_game_rom_ug23.ug23"</span></span>, <span class="hljs-number"><span class="hljs-number">0x600002</span></span>, <span class="hljs-number"><span class="hljs-number">0x80000</span></span>, NO_DUMP) ROM_LOAD32_BYTE( <span class="hljs-string"><span class="hljs-string">"l1_nba_jam_tournament_game_rom_uj23.uj23"</span></span>, <span class="hljs-number"><span class="hljs-number">0x600003</span></span>, <span class="hljs-number"><span class="hljs-number">0x80000</span></span>, NO_DUMP) ROM_END</code> </pre> <br>  <b><u>Um fato interessante:</u></b> no exemplo de c√≥digo acima, o √∫ltimo par√¢metro da fun√ß√£o foi substitu√≠do por "NO_DUMP" para que as EPROMs modificadas pudessem ser carregadas.  Esses campos s√£o geralmente <sup>[12]</sup> um hash CRC / SHA1 do conte√∫do da EPROM.  √â assim que o MAME determina qual jogo pertence √† ROM e permite que voc√™ saiba que uma das ROMs do conjunto est√° ausente ou danificada. <br><br><h2>  Mecanismo de v√≠deo do cora√ß√£o: DMA2 </h2><br>  A chave para entender o formato gr√°fico √© a fun√ß√£o que processa a grava√ß√£o / leitura de DMA em 256 registros DMA2 localizados em endere√ßos de 0x01a80000 a 0x01a800ff.  Todo o trabalho √°rduo da engenharia reversa j√° foi realizado pelos desenvolvedores do MAME.  Eles ainda tiveram tempo para documentar excelentemente o formato do comando. <br><br><pre>  Registros DMA
  ------------------

   Registar |  Bit  Aplica√ß√£o
  ---------- + - FEDCBA9876543210 - + ------------
      0  xxxxxxxx -------- |  pixels descartados no in√≠cio de cada linha
            |  -------- xxxxxxxx |  pixels descartados no final de cada linha
      1 |  x --------------- |  ativar a grava√ß√£o (ou limpar se zero)
            |  -421 ------------ |  imagens bpp (0 = 8)
            |  ---- 84 ---------- |  tamanho do passe ap√≥s = (1 &lt;&lt; x)
            |  ------ 21 -------- |  tamanho do passe at√© = (1 &lt;&lt; x)
            |  -------- 8 ------- |  ativar pular antes / depois
            |  --------- 4 ------ |  ativar truncamento
            |  ---------- 2 ----- |  y espelhamento
            |  ----------- 1 ---- |  x espelhamento
            |  ------------ 8 --- |  transferir pixels diferentes de zero como cores
            |  ------------- 4-- |  transmitindo zero pixels como cores
            |  -------------- 2- |  transmiss√£o de pixels diferente de zero
            |  --------------- 1 |  transmiss√£o de pixel zero
      2  xxxxxxxxxxxxxxxx |  palavra baixa do endere√ßo de origem
      3  xxxxxxxxxxxxxxxx |  endere√ßo de origem de palavras altas
      4  ------- xxxxxxxxx |  x destinat√°rio
      5  ------- xxxxxxxxx |  y destinat√°rio
      6  ------ xxxxxxxxxx |  colunas de imagem
      7  ------ xxxxxxxxxx |  linhas de imagem
      8  xxxxxxxxxxxxxxxx |  paleta
      9  xxxxxxxxxxxxxxxx |  cor
     10  --- xxxxxxxxxxxxx |  escala x
     11  --- xxxxxxxxxxxxx |  escala y
     12  ------- xxxxxxxxx |  aparar superior / esquerdo
     13  ------- xxxxxxxxx |  aparar inferior / direita
     14  ---------------- |  o teste
     15  xxxxxxxx -------- |  byte de detec√ß√£o zero
            |  -------- 8 ------- |  p√°gina adicional
            |  --------- 4 ------ |  tamanho do destinat√°rio
            |  ---------- 2 ----- |  sele√ß√£o da borda superior / inferior ou esquerda / direita para o registro 12/13 </pre><br>  Existe at√© uma fun√ß√£o de depura√ß√£o que permite salvar os sprites originais no processo de transfer√™ncia para o DMA2 (a fun√ß√£o foi escrita por um participante de longa data do projeto MAME, Ryan Holtz <sup>[13]</sup> ).  Foi o suficiente para eu simplesmente jogar o jogo, para que todos os arquivos com metadados fossem salvos no disco. <br><br>  Acontece que os sprites s√£o compostos de elementos simples de uma paleta de 16 bits sem compacta√ß√£o.  No entanto, nem todos os sprites t√™m o mesmo n√∫mero de cores.  Alguns sprites usam apenas 16 cores com √≠ndices de cores de 4 bits, enquanto outros usam 256 cores e requerem √≠ndices de cores de 8 bits. <br><br><h2>  Patch </h2><br>  Agora eu sei a localiza√ß√£o e o formato dos sprites, ent√£o resta executar a quantidade m√≠nima de engenharia reversa.  Eu escrevi um pequeno programa no Golang para eliminar a altern√¢ncia de EPROMs "code" e "gfx".  Ao eliminar a distribui√ß√£o, √© f√°cil procurar valores ASCII ou conhecidos, porque trabalhei exatamente com a apar√™ncia da RAM durante a execu√ß√£o do programa. <br><br>  Depois disso, voc√™ pode encontrar facilmente as caracter√≠sticas do jogador.  Aconteceu que todos eles foram armazenados um ap√≥s o outro no formato big endian n√£o assinado de 16 bits (o que √© muito l√≥gico, porque 34010 funciona com big endian).  Eu adicionei um patcher para modificar os atributos do jogador.  N√£o gosto muito de basquete, entrei em SPEED = 9, 3 PTS = 9, DUNKS = 9, PASS = 9, POWER = 9, STEAL = 9, BLOCK = 9 e CLTCH = 9. <br><br>  Tamb√©m escrevi o c√≥digo para consertar o jogo com novos sprites com a √∫nica restri√ß√£o - novos sprites devem ter o mesmo tamanho dos substitu√≠veis.  Para a foto do MJ, criei um PNG indexado de 256 cores (voc√™ pode v√™-lo <a href="">aqui</a> ). <br><br>  Por fim, adicionei c√≥digo para converter o formato intermedi√°rio no formato intercalado para gravar em arquivos EPROM individuais. <br><br><h2>  Comece o jogo </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ca2/427/e60/ca2427e606192878c8c2a116b73e821e.png" width="49%"></div><br>  Depois de corrigir o conte√∫do da EPROM, a ferramenta de diagn√≥stico NBAJam mostrou que o conte√∫do de alguns chips est√° marcado como "RUIM".  Eu esperava isso porque apenas corrigi o conte√∫do das EPROMs, mas n√£o me preocupei em procurar o formato CRC e at√© mesmo o local de armazenamento. <br><br>  As EPROMs GFX est√£o marcadas em vermelho (UG16 / UJ16, UG17 / UJ17, UG18 / UJ18, UG20 / UJ20, UG22 / UJ22 e UG23 / UJ23), porque cont√™m imagens que eu alterei.  As duas EPROMs nas quais as instru√ß√µes (UG12 e UJ12) est√£o armazenadas tamb√©m s√£o vermelhas, porque existem paletas. <br><br>  Felizmente, aqui os CRCs n√£o s√£o usados ‚Äã‚Äãpara proteger contra conte√∫do modificado e s√£o necess√°rios apenas para verificar a integridade dos chips.  O jogo come√ßou.  E ganhou! <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e0e/341/ad0/e0e341ad08eaace26ce47cae7a7758cb.png" width="100%"></div><br><h2>  Hasta La Vista, beb√™! </h2><hr><br>  Tendo terminado com dificuldades t√©cnicas, perdi rapidamente o interesse pela ferramenta e parei de desenvolv√™-la.  Ideias para quem quer brincar com o c√≥digo: <br><br><ul><li>  Acrescente ao Eastern Conference Toronto Raptors. </li><li>  Adicione a capacidade de alterar os nomes dos jogadores.  Infelizmente, eles n√£o consistem em ASCII, mas s√£o imagens pr√©-geradas. </li></ul><br><h2>  Livro sobre NBA Jam </h2><br>  Se voc√™ √© f√£ do NBA Jam, ent√£o Reyan Ali escreveu um livro inteiro sobre ela <sup>[14]</sup> .  Voc√™ pode compr√°-lo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . <br><br><h2>  C√≥digo fonte </h2><br>  Se voc√™ deseja contribuir ou apenas ver como tudo funciona, a fonte completa √© carregada no github <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . <br><br><h2>  Refer√™ncias </h2><br>  [1] Fonte: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">'NJA Jam' de Reyan Ali</a> <br><br>  [2] Fonte: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">'NJA Jam' de Reyan Ali</a> <br><br>  [3] Fonte: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">'NJA Jam' de Reyan Ali</a> <br><br>  [4] Fonte: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Mortal Kombat 1 nos bastidores</a> <br><br>  [5] Fonte: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">'NJA Jam' de Reyan Ali</a> <br><br>  [6] Fonte: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">4: 3 versus pixels quadrados</a> <br><br>  [7] Coment√°rio: Infelizmente, a era dessa documenta√ß√£o excelente j√° passou h√° muito tempo. <br><br>  [8] Fonte: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Tela de inicializa√ß√£o do Mame NBA Jam</a> <br><br>  [9] Fonte: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Conjunto de instru√ß√µes TMS34010</a> <br><br>  [10] Fonte: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Guia do usu√°rio do T34010</a> <br><br>  [11] Fonte: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">NBA Jam - v√≠deo do BoomShakaLaka.</a> <br><br>  [12] Fonte: <a href="">MAME T-Unit driver.cpp</a> <br><br>  [13] Fonte: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Commit 'midtunit.cpp: adicionado um visualizador DMA-blitter opcional'</a> <br><br>  [14] Fonte: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">'NBA JAM Book' de Reyan Ali</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt473660/">https://habr.com/ru/post/pt473660/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt473648/index.html">O cavalo est√° morto - cry: transi√ß√£o de tslint para eslint</a></li>
<li><a href="../pt473652/index.html">Criando uma API REST com Node.js e um Banco de Dados Oracle. Parte 5</a></li>
<li><a href="../pt473654/index.html">PHP Composer: Corrija depend√™ncias sem dor</a></li>
<li><a href="../pt473656/index.html">Experi√™ncia com o Hugo Static Site Generator</a></li>
<li><a href="../pt473658/index.html">Lidando com bugs no Go 1.13</a></li>
<li><a href="../pt473664/index.html">Experi√™ncia de aprendizado em primeira m√£o. Yandex.Practicum - Analista de dados</a></li>
<li><a href="../pt473666/index.html">Como escritor de fic√ß√£o cient√≠fica, Arthur Clark quase fechou a revista Tech - Youth</a></li>
<li><a href="../pt473668/index.html">Por que Bitrix - Bitrix</a></li>
<li><a href="../pt473670/index.html">Stoloto: como introduzir um celular na loteria</a></li>
<li><a href="../pt473672/index.html">Por que, Bitrix? Ou o mundo das fadas 1C</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>