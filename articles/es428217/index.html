<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèª‚Äç‚öïÔ∏è ‚ú≥Ô∏è üôå Millones de videollamadas por d√≠a o "¬°Llama a mam√°!" üßëüèø‚Äçü§ù‚Äçüßëüèº üì∫ üíú</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Desde el punto de vista del usuario, los servicios de llamadas se ven bastante simples: vas a la p√°gina a otro usuario, llamas, √©l levanta el tel√©fono...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Millones de videollamadas por d√≠a o "¬°Llama a mam√°!"</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/odnoklassniki/blog/428217/">  Desde el punto de vista del usuario, los servicios de llamadas se ven bastante simples: vas a la p√°gina a otro usuario, llamas, √©l levanta el tel√©fono y hablas con √©l.  Afuera parece que todo es simple, pero pocos saben c√≥mo hacer ese servicio.  Pero Alexander Tobol ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">alatobol</a> ) no solo lo sabe, sino que tambi√©n comparte de buena gana su experiencia. <br><br><img src="https://habrastorage.org/webt/rq/un/cx/rquncxhtqvyydpdbneoatkwfvke.jpeg"><br><br>  Adem√°s, la versi√≥n de texto del informe sobre HighLoad ++ Siberia, del cual aprender√°: <br><br><ul><li>  c√≥mo funcionan los servicios de videollamadas bajo el cap√≥; </li><li>  lo hermoso que es romper NAT; esto ser√° interesante para los especialistas en juegos que necesitan una conexi√≥n de igual a igual; </li><li>  c√≥mo funciona WebRTC, qu√© protocolos incluye; </li><li>  ¬øC√≥mo puedo sintonizar WebRTC a trav√©s de BigData? </li></ul><br><iframe width="560" height="315" src="https://www.youtube.com/embed/MnEXuKHjIOU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  <strong>Sobre el orador:</strong> Alexander Tobol lidera el desarrollo de las plataformas Video y Tape en ok.ru. <br><a name="habracut"></a><br><h2>  Historial de videollamadas <br></h2><br>  El primer dispositivo de videollamada apareci√≥ en 1960, se llamaba picherphone, utilizaba redes dedicadas y era extremadamente costoso.  En 2006, Skype agreg√≥ videollamadas a su aplicaci√≥n.  En 2010, Flash admiti√≥ el protocolo RTMFP, y nosotros en Odnoklassniki lanzamos videollamadas Flash.  En 2016, Chrome dej√≥ de admitir Flash, y en agosto de 2017 reiniciamos las llamadas con la nueva tecnolog√≠a, de la que hablar√© hoy.  Una vez finalizado el servicio, durante otros seis meses recibimos un aumento significativo en las llamadas completadas con √©xito.  Recientemente, tambi√©n tenemos m√°scaras en llamadas. <br><img src="https://habrastorage.org/webt/kn/9u/uy/kn9uuyg18yggcfabvmzgs-cfygg.jpeg"><br><br><h2>  Arquitectura y conocimientos tradicionales <br></h2><br>  Dado que trabajamos en una red social, no tenemos tareas t√©cnicas y no sabemos qu√© es TK.  Por lo general, toda la idea cabe en una p√°gina y se ve as√≠. <br><img src="https://habrastorage.org/webt/qf/9x/ju/qf9xjum4vvjczd3-momvzhht9cw.jpeg"><br><br>  El usuario quiere llamar a otros usuarios usando una aplicaci√≥n web o iOS / Android.  Otro usuario puede tener m√∫ltiples dispositivos.  La llamada llega a todos los dispositivos, el usuario levanta el tel√©fono de uno de ellos y habla.  Todo es simple <br><br><h2>  Especificaciones t√©cnicas <br></h2><br>  Para realizar un servicio de llamadas de calidad, debemos comprender qu√© caracter√≠sticas queremos rastrear.  Decidimos comenzar buscando qu√© es lo que m√°s molesta al usuario. <br><br>  El usuario definitivamente se molesta si levanta el tel√©fono y se ve obligado a esperar hasta que se establezca la conexi√≥n. <br><img src="https://habrastorage.org/webt/8g/kk/qb/8gkkqbq6ioqxnn0ro6dcq9kwhno.jpeg"><br><br>  El usuario se molesta si la calidad de la llamada es deficiente: algo se interrumpe, el video se dispersa y el sonido burbujea. <br><img src="https://habrastorage.org/webt/2l/rt/ud/2lrtudpp-tw5cjsknhzamgj--pi.jpeg"><br><br>  Pero, sobre todo, el usuario est√° molesto por la demora en las llamadas.  La latencia es una de las caracter√≠sticas importantes de las llamadas.  Con una latencia en una conversaci√≥n del orden de 5 segundos, es absolutamente imposible mantener un di√°logo. <br><img src="https://habrastorage.org/webt/z-/tn/lf/z-tnlfghw6laz3j25e3kbwob9mi.jpeg"><br><br>  Hemos determinado por nosotros mismos las caracter√≠sticas aceptables: <br><br><ul><li>  <strong>Inicio</strong> : decidimos que era bueno comenzar la llamada en un segundo.  Es decir  conectarse despu√©s de que el usuario haya respondido, no deber√≠a tomar m√°s de 1 segundo. </li><li>  <strong>La calidad</strong> es un indicador muy subjetivo.  Puede medir, por ejemplo, la relaci√≥n se√±al-ruido (SNR), pero todav√≠a faltan cuadros y otros artefactos.  Medimos la calidad de manera bastante subjetiva y luego evaluamos la felicidad de los usuarios. </li><li>  <strong>La latencia</strong> debe ser inferior a 0,5 segundos.  Si la latencia es m√°s de 0.5 segundos, entonces ya escucha demoras y comienza a interrumpirse entre s√≠. </li></ul><br><img src="https://habrastorage.org/webt/cl/yx/j0/clyxj0ajsqq5coamt5orttz-kxc.jpeg"><br><br>  Polycom es un sistema de conferencia instalado en nuestras oficinas.  Tenemos latencias promedio de Polycom del orden de 1.3 segundos.  Con tal retraso, no siempre se entienden entre s√≠.  Si el retraso aumenta a 2 segundos, entonces el di√°logo no ser√° posible. <br><img src="https://habrastorage.org/webt/3_/yy/qq/3_yyqqbvvq5zoavfa5q9tzvqhiq.jpeg"><br><br>  Como ya hab√≠amos lanzado la plataforma, esper√°bamos que tuvi√©ramos un mill√≥n de llamadas por d√≠a.  Esto es mil llamadas en paralelo.  Si todas las llamadas se inician a trav√©s del servidor, habr√° mil megabits por llamada.  Esto es solo 1 gigabit / seg. Un servidor de hierro ser√° suficiente. <br><br><h2>  Internet vs TTX <br></h2><br>  ¬øQu√© puede evitar que consigas caracter√≠sticas tan geniales?  El internet! <br><img src="https://habrastorage.org/webt/qb/aq/sy/qbaqsyfaf6vln4e882armfugx1g.jpeg"><br><br>  En Internet, hay cosas como el tiempo de ida y vuelta (RTT), que no se pueden superar, hay un ancho de banda variable, hay NAT. <br><br>  Anteriormente, medimos la velocidad de transmisi√≥n en las redes de nuestros usuarios. <br><img src="https://habrastorage.org/webt/bm/ge/z6/bmgez6efih7z_lqwidcknso8edw.jpeg"><br><br>  Lo desglosamos por tipo de conexi√≥n, observamos el RTT promedio, la p√©rdida de paquetes, la velocidad y decidimos probar las llamadas en los valores promedio de cada una de estas redes. <br><img src="https://habrastorage.org/webt/ui/o4/k8/uio4k8pmxmyxyclfwwawehqijes.jpeg"><br><br>  Hay otros problemas en Internet: <br><br><ul><li>  <strong>P√©rdida de paquetes</strong> : medimos una p√©rdida de paquetes aleatoria del 0,6% (no tenemos en cuenta la p√©rdida de paquetes de congesti√≥n con un n√∫mero excesivo de paquetes). </li><li>  <strong>Reordenamiento</strong> : env√≠a paquetes en el mismo orden y la red los vuelve a ordenar. </li><li>  <strong>Jitter</strong> : env√≠e una transmisi√≥n de video o audio a un cierto intervalo, y los paquetes se unen en el lado del cliente en paquetes, por ejemplo, debido al almacenamiento en b√∫fer en los dispositivos de red. </li><li>  <strong>NAT</strong> : result√≥ que m√°s del 97% de los usuarios est√°n detr√°s de NAT.  Hablaremos sobre por qu√©, qu√© y c√≥mo. </li></ul><br><img src="https://habrastorage.org/webt/z_/uo/mc/z_uomck64smc12_beaupdnutgp4.jpeg"><br><br>  Considere la configuraci√≥n de red enumerada anteriormente con un ejemplo simple. <br><br>  Busqu√© el sitio web de la Universidad Estatal de Novosibirsk desde mi oficina y recib√≠ un ping tan extra√±o. <br><img src="https://habrastorage.org/webt/wi/am/at/wiamatloo1eviw58g3zgzbrsc2e.jpeg"><br><br>  El jitter promedio en este ejemplo es de 30 ms, es decir, el intervalo promedio entre tiempos de ping adyacentes es de aproximadamente 30 ms, y el ping promedio es de 105 ms. <br><br>  ¬øQu√© es importante en las llamadas, por qu√© lucharemos por p2p? <br><img src="https://habrastorage.org/webt/gb/ny/yx/gbnyyxij20hrfo96scwubxdzovu.jpeg"><br><br>  Obviamente, si logramos establecer una conexi√≥n p2p entre nuestros usuarios que intentan hablar entre ellos en San Petersburgo, y no a trav√©s de un servidor ubicado en Novosibirsk, ahorraremos aproximadamente 100 ms de ida y vuelta y tr√°fico a este servicio. <br><br>  Por lo tanto, la mayor parte del art√≠culo est√° dedicado a c√≥mo hacer un buen p2p. <br><br><h2>  Historia o legado <br></h2><br>  Como dije, hemos tenido un servicio de llamadas desde 2010, y ahora lo hemos reiniciado. <br><img src="https://habrastorage.org/webt/si/ru/lu/sirulur_jaalnldpkmvbjx7ct-q.jpeg"><br><br>  En 2006, cuando Skype comenz√≥, Flash compr√≥ Amicima, que fabric√≥ RTMFP.  Flash ya ten√≠a RTMP, que en principio se puede usar para llamadas, y a menudo se usa para transmisi√≥n.  Flash luego abri√≥ la especificaci√≥n RTMP.  Me pregunto por qu√© necesitaban RTMFP?  En 2010, utilizamos RTMFP. <br><br>  Compare los requisitos para los protocolos de llamadas y los protocolos de transmisi√≥n real y vea d√≥nde est√° este l√≠mite. <br><img src="https://habrastorage.org/webt/ih/j9/xi/ihj9xiris6praclbyxpxelwc1i4.jpeg"><br><br>  <strong>RTMP</strong> es m√°s un protocolo de transmisi√≥n de video.  Utiliza TCP, tiene retraso acumulativo.  Si tiene una buena conexi√≥n a Internet, las llamadas a RTMP funcionar√°n. <br><br>  <strong>El protocolo RTMFP</strong> , a pesar de la diferencia en una sola letra, es el protocolo UDP.  Est√° libre de problemas de almacenamiento en b√∫fer, aquellos que est√°n en TCP;  Est√° privado de bloqueo de cabecera de l√≠nea: esto es cuando pierde un paquete y TCP no devuelve los siguientes paquetes hasta que es hora de enviar el perdido nuevamente.  RTMFP pudo manejar NAT y estaba experimentando un cambio en la direcci√≥n IP de los clientes.  Por lo tanto, lanzamos la web en RTMFP en 2010. <br><img src="https://habrastorage.org/webt/pv/rx/16/pvrx163tvieetirsg8nkfrov7qm.jpeg"><br><br>  Entonces, solo en 2011 apareci√≥ el borrador inicial de WebRTC, que a√∫n no estaba completamente operativo.  En 2012, comenzamos a admitir llamadas en iOS / Android, luego sucedi√≥ algo m√°s y en 2016 Chrome dej√≥ de admitir Flash.  Ten√≠amos que hacer algo. <br><img src="https://habrastorage.org/webt/uu/ub/cs/uuubcssxa_w9-ost03_y6dqq6ic.jpeg"><br><br>  Analizamos todos los protocolos de VoIP: como siempre, para hacer algo, comenzamos mirando a los competidores. <br><br><h2>  Competidores o por d√≥nde empezar <br></h2><br>  Elegimos los competidores m√°s populares: Skype, WhatsApp, Google Duo (similar a Hangouts) e ICQ. <br><br>  Para empezar, medimos el retraso. <br><img src="https://habrastorage.org/webt/yv/br/d2/yvbrd2tluf9yzf-xqqibngdooh8.jpeg"><br><br>  Es facil de hacer.  Arriba hay una fotograf√≠a en la que: <br><br><ul><li>  Cron√≥metro (vea el tel√©fono en la esquina superior izquierda), que muestra la hora (03:08). </li><li>  El tel√©fono cercano hace una llamada y toma el primer tel√©fono como video.  Desde el momento en que la imagen entr√≥ en la c√°mara del tel√©fono, y lo viste, tom√≥ alrededor de 100 ms. </li><li>  Una llamada a otro tel√©fono (blanco) y una vez m√°s.  Aqu√≠ el retraso es de aproximadamente 310 ms con Google Duo. </li></ul><br>  Todav√≠a no revelar√© todas las tarjetas, pero nos aseguramos de que estos dispositivos no pudieran establecer conexiones p2p.  Por supuesto, las mediciones se llevaron a cabo en diferentes redes, y esto es solo un ejemplo. <br><img src="https://habrastorage.org/webt/rn/xz/ee/rnxzee4grukafmg0gu3cunpemsi.jpeg"><br><br>  Skype todav√≠a interrumpe un poco.  Result√≥ que con Skype, en caso de que no se conecte p2p, el retraso es de 1.1 s. <br><br>  Nuestro entorno de prueba fue complicado.  Probamos en diferentes condiciones (EDGE, 3G, LTE, WiFi), tomamos en cuenta que los canales son asim√©tricos, y doy los valores promedio de todas las mediciones. <br><img src="https://habrastorage.org/webt/gb/pp/6s/gbpp6sc5jugssoov8nmzvajlifo.jpeg"><br><br>  Para estimar el consumo de bater√≠a, la carga en el procesador y todo lo dem√°s, decidimos que simplemente puede medir la temperatura del tel√©fono con un pir√≥metro y asumir que esta es una carga promedio en la GPU del tel√©fono en el procesador, en la bater√≠a.  En principio, es muy desagradable llevar un tel√©fono caliente a su o√≠do e incluso sostenerlo en sus manos.  Al usuario le parece que ahora la aplicaci√≥n usar√° toda su bater√≠a. <br><img src="https://habrastorage.org/webt/dl/ck/vd/dlckvdbr8we75haadv9qkgk1jxk.jpeg"><br><br>  El resultado es: <br><br><ul><li>  Los m√°s lentos <strong>en el retraso</strong> fueron ICQ y Skype, y los m√°s r√°pidos: Telegram.  Esta no es una comparaci√≥n completamente correcta, ya que Telegram no tiene videollamadas, pero tienen una latencia m√≠nima en audio.  WhatsApp (aproximadamente 200 ms) y Hangouts: 390 ms funcionan muy bien. </li><li>  <strong>Por temperatura,</strong> Telegram come menos sin video y Skype m√°s. </li><li>  En t√©rminos de tiempo de <strong>respuesta</strong> , Telegram establece la conexi√≥n <strong>por el</strong> tiempo m√°s largo y el WhatsApp y Google Duo m√°s r√°pidos. </li></ul><br>  ¬°Genial, tenemos algunas m√©tricas! <br><img src="https://habrastorage.org/webt/t8/mb/n0/t8mbn0vv_g1utslspeeevk8g5ie.jpeg"><br><br>  Probamos la calidad de video y voz en diferentes redes, con diferentes ca√≠das y todo lo dem√°s.  Como resultado, llegamos a la conclusi√≥n de que el <strong>video de mayor calidad est√° en Google Duo, y la voz est√° en Skype</strong> , pero esto est√° en redes "malas" cuando ya hay distorsi√≥n.  En general, todos trabajan aproximadamente mediocre.  WhatsApp tiene la imagen m√°s borrosa. <br><br>  Veamos en qu√© se implementa todo. <br><img src="https://habrastorage.org/webt/ih/ap/1i/ihap1infndlvdjllso8eszhjnla.jpeg"><br><br>  Skype tiene su propio protocolo propietario, y todos los dem√°s usan una modificaci√≥n de WebRTC o, en general, directamente WebRTC.  Hangouts, Google Duo, WhatsApp, Facebook Messenger pueden funcionar con la web, y todos tienen WebRTC bajo el cap√≥.  ¬°Todos son muy diferentes, con diferentes caracter√≠sticas, y todos tienen un WebRTC!  Por lo tanto, debe poder cocinarlo correctamente.  Adem√°s, est√° Telegram, del cual algunas partes de WebRTC son responsables de la parte de audio, est√° ICQ, que bifurc√≥ WebRTC durante mucho tiempo y sigui√≥ desarroll√°ndose a su manera. <br><br><h2>  WebRTC  Arquitectura <br></h2><br><img src="https://habrastorage.org/webt/3q/0x/-c/3q0x-cy-45bblq5lgoayq2awd5u.jpeg"><br><br>  WebRTC implica la presencia de un servidor de se√±alizaci√≥n, un intermediario entre clientes, que se utiliza para intercambiar mensajes durante el establecimiento de una conexi√≥n p2p entre ellos.  Despu√©s de establecer una conexi√≥n directa, los clientes comienzan a intercambiar datos multimedia entre ellos. <br><br><h2>  WebRTC  Demo <br></h2><br>  Comencemos con una demostraci√≥n simple.  Hay 5 pasos simples para establecer una conexi√≥n WebRTC. <br><br><div class="spoiler">  <b class="spoiler_title">C√≥digo de ejemplo detallado</b> <div class="spoiler_text"><pre><code class="javascript hljs"><span class="hljs-number"><span class="hljs-number">1.</span></span> <span class="hljs-comment"><span class="hljs-comment">// Step #1: Getting local video stream and initializing a peer connection with it (both caller and callee) 2. 3. var localStream = null; 4. var localVideo = document.getElementById('localVideo'); 5. 6. navigator 7. .mediaDevices 8. .getUserMedia({ audio: true, video: true }) 9. .then(stream =&gt; { 10. localVideo.srcObject = stream; 11. localStream = stream; 12. }); 13. 14. var pc = new RTCPeerConnection({ iceServers: [...] }); 15. 16. localStream 17. .getTracks() 18. .forEach(track =&gt; pc.addTrack(track, localStream)); 19. 20. // Step #2: Creating SDP offer (caller) 21. 22. pc.createOffer({ offerToReceiveAudio: true, offerToReceiveVideo: true }) 23. .then(offer =&gt; signaling.send('offer', offer)); 24. 25. // Step #3: Handling SDP offer and sending SDP answer (callee) 26. 27. signaling.on('offer', offer =&gt; { 28. pc.setRemoteDescription(offer) 29. .then(() =&gt; pc.createAnswer()) 30. .then(answer =&gt; signaling.send('answer', answer)) 31. }); 32. 33. // Step #4: Handling SDP answer (calleer) 34. 35. signaling.on('answer', answer =&gt; pc.setRemoteDescription(answer)); 36. 37. // Step #5: Exchanging ICE candidates 38. 39. pc.onicecandidate = event =&gt; signaling.send('candidate', event.candidate); 40. 41. signaling.on('candidate', candidate =&gt; pc.addIceCandidate(candidate)); 42. 43. // Step #6: Getting remote video stream (both caller and callee) 44. 45. var remoteVideo = document.getElementById('remoteVideo'); 46. 47. pc.onaddstream = event =&gt; remoteVideo.srcObject = event.streams[0];</span></span></code> </pre> <br></div></div><br>  Dice lo siguiente: <br><br><ol><li>  Grabe un video y establezca una conexi√≥n entre pares, transfiera alg√∫n tipo de iceServers (no est√° claro de inmediato qu√© es). <br></li><li>  Cree una oferta de SDP y env√≠ela a se√±alizaci√≥n, y la se√±alizaci√≥n WebRTC no se implementar√° de ninguna manera. <br></li><li>  Luego debe hacer un contenedor para el que proviene de la se√±alizaci√≥n, y esto tampoco forma parte de WebRTC. <br></li><li>  Adem√°s intercambiar algunos candidatos. <br></li><li>  Finalmente obtenga la transmisi√≥n de video remota. <br></li></ol><br>  Veamos qu√© est√° sucediendo all√≠ y qu√© necesitamos implementar nosotros mismos. <br><img src="https://habrastorage.org/webt/wx/fz/fn/wxfzfnkuw7smjite-bdpmadb_ro.jpeg"><br><br>  Nos fijamos en la imagen de abajo hacia arriba.  Hay una biblioteca WebRTC que ya est√° integrada en el navegador, compatible con Chrome, Firefox, etc. Puede crearla en Android / iOS y comunicarse con ella a trav√©s de la API y SDP (Protocolo de descripci√≥n de sesi√≥n), que describe la sesi√≥n misma.  A continuaci√≥n te dir√© lo que est√° incluido en √©l.  Para usar esta biblioteca en su aplicaci√≥n, debe establecer una conexi√≥n entre suscriptores a trav√©s de la se√±alizaci√≥n.  La se√±alizaci√≥n tambi√©n es su servicio que debe escribir usted mismo, WebRTC no lo proporciona. <br><br>  M√°s adelante en el art√≠culo discutiremos la red en orden, luego video / audio, y al final escribiremos nuestra se√±alizaci√≥n. <br><br><h2>  Red WebRTC o p2p (en realidad c2s2c) <br></h2><br>  Configurar una conexi√≥n p2p parece ser bastante simple. <br><img src="https://habrastorage.org/webt/he/7h/so/he7hsoyzqklbzj715slypgychgc.jpeg"><br><br>  Tenemos a Alice y Bob que quieren establecer una conexi√≥n p2p.  Toman sus direcciones IP, tienen un servidor de se√±alizaci√≥n al que ambos est√°n conectados y a trav√©s del cual pueden intercambiar estas direcciones.  Intercambian direcciones, y ¬°oh!  Tienen las mismas direcciones, ¬°algo sali√≥ mal! <br><img src="https://habrastorage.org/webt/rn/hc/uj/rnhcujxoa5k0tni2oquj-tx3hfi.jpeg"><br><br>  De hecho, es muy probable que ambos usuarios est√©n sentados detr√°s de enrutadores Wi-Fi y estas son sus direcciones IP grises locales.  El enrutador les proporciona una funci√≥n como la traducci√≥n de direcciones de red (NAT).  Como trabaja ella? <br><img src="https://habrastorage.org/webt/yr/xu/r0/yrxur0s_xhoye3i36zod4ropbec.jpeg"><br><br>  Tiene una subred gris y una direcci√≥n IP externa.  Usted env√≠a un paquete a Internet desde su direcci√≥n gris, NAT reemplaza su direcci√≥n gris con blanco y recuerda la asignaci√≥n: desde qu√© puerto envi√≥, a qu√© usuario y con qu√© puerto coincide.  Cuando llega el paquete de devoluci√≥n, se resuelve mediante esta asignaci√≥n y lo env√≠a al remitente.  Todo es simple <br><br>  A continuaci√≥n se muestra una ilustraci√≥n de c√≥mo se ve en mi lugar. <br><img src="https://habrastorage.org/webt/ud/ar/da/udardacyxvmzt5mq0modbosd-mc.jpeg"><br><br>  Esta es mi direcci√≥n IP interna y la direcci√≥n del enrutador (por cierto, tambi√©n gris).  Si traza y ve la ruta, veremos mi enrutador Wi-Fi: un paquete de direcciones de proveedores grises y una IP blanca externa.  Por lo tanto, de hecho, tendr√© dos NAT: uno en el que estoy conectado a Wi-Fi y otro en el proveedor, a menos que, por supuesto, haya comprado una direcci√≥n IP externa dedicada. <br><br>  <strong>NAT es muy popular porque:</strong> <br><br><ul><li>  todav√≠a faltan muchos IPv4 y no hay suficientes direcciones; </li><li>  NAT parece proteger la red; </li><li>  Esta es una funci√≥n est√°ndar del enrutador: conectarse a Wi-Fi, hay NAT all√≠ mismo, funciona. </li></ul><br>  Por lo tanto, solo el 3% de los usuarios se sientan con una IP externa, mientras que el resto pasa por NAT. <br><br>  NAT le permite ir de forma segura a cualquier direcci√≥n blanca.  Pero si no fuiste a ninguna parte, entonces nadie puede venir a ti. <br><img src="https://habrastorage.org/webt/j7/cl/j2/j7clj2pypnpwv_p-odndgflgzpk.jpeg"><br><br>  Establecer una conexi√≥n p2p es un problema.  De hecho, Alice y Bob no pueden enviarse paquetes entre s√≠ si ambos est√°n detr√°s de NAT. <br><br>  WebRTC tiene <strong>un protocolo STUN</strong> para resolver este problema.  Se propone implementar un servidor STUN.  Luego, Alice se conecta al servidor STUN, obtiene su direcci√≥n IP y se la env√≠a a Bob a trav√©s de la se√±alizaci√≥n.  Bob tambi√©n obtiene su direcci√≥n IP y se la env√≠a a Alice.  Se env√≠an paquetes entre s√≠ y, por lo tanto, rompen a trav√©s de NAT. <br><img src="https://habrastorage.org/webt/1m/mq/iz/1mmqiz57zbyzzahdgng_y_3hywo.jpeg"><br><br>  <strong>Pregunta</strong> : Alice tiene un puerto espec√≠fico abierto, NAT / Firewall ya se ha roto a este puerto y Bob est√° abierto.  Se conocen las direcciones del otro.  Alice intenta enviar el paquete a Bob; √©l env√≠a el paquete a Alice.  ¬øCrees que pueden hablar o no? <br><br>  De hecho, tiene raz√≥n en cualquier caso, el resultado depende del tipo de par NAT que tengan los usuarios. <br><img src="https://habrastorage.org/webt/te/hd/hj/tehdhjdvyvfv9dcrxng950n98h8.jpeg"><br><br><h3>  Traducci√≥n de direcciones de red <br></h3><br>  Hay 4 tipos de NAT: <br><br><ol><li>  Cono completo NAT; <br></li><li>  Cono restringido NAT; <br></li><li>  Puerto restringido cono NAT; <br></li><li>  NAT sim√©trico <br></li></ol><br>  En la versi√≥n b√°sica, Alice env√≠a un paquete al servidor STUN, abre un puerto.  Bob de alguna manera se entera de su puerto y env√≠a un paquete de devoluci√≥n.  Si se trata de <strong>NAT de cono completo</strong> , el m√°s f√°cil que simplemente asigna el puerto externo al puerto interno, entonces Bob podr√° enviar inmediatamente un paquete a Alice, establecer una conexi√≥n y hablar√°n. <br><img src="https://habrastorage.org/webt/ph/kp/zr/phkpzrkuy3k2uzqsl4sub-sla7o.jpeg"><br><br>  A continuaci√≥n se muestra el esquema de interacci√≥n: Alice desde alg√∫n puerto env√≠a un paquete al puerto STUN, STUN le responde con su direcci√≥n externa.  STUN puede responder desde cualquier direcci√≥n, si es NAT de cono completo, seguir√° atravesando NAT, y Bob puede responder a la misma direcci√≥n. <br><img src="https://habrastorage.org/webt/dl/pp/3a/dlpp3anl2az479kengmx5easix4.jpeg"><br><br>  En el caso de <strong>NAT de cono restringido, las</strong> cosas son un poco m√°s complicadas.  Recuerda no solo el puerto desde el que debe asignar a la direcci√≥n interna, sino tambi√©n la direcci√≥n externa a la que fue.  Es decir, si ha establecido una conexi√≥n solo con el servidor IP STUN, nadie m√°s en la red podr√° responderle, y entonces el paquete de Bob no llegar√°. <br><img src="https://habrastorage.org/webt/yt/-g/sg/yt-gsg5yyrf99ywt77j2ydntyzy.jpeg"><br><br>  ¬øC√≥mo se resuelve este problema?  En un esquema simple (vea la ilustraci√≥n a continuaci√≥n) como este: Alice env√≠a un paquete a STUN, √©l le responde con su IP.  STUN puede responder desde cualquier puerto siempre que sea NAT de cono restringido.  Bob no puede responder a Alice porque tiene una direcci√≥n diferente.  Alice responde con un paquete, sabiendo la direcci√≥n IP de Bob.  Ella abre NAT a Bob, Bob le responde.  Hurra, hablaron. <br><img src="https://habrastorage.org/webt/iz/ji/ar/izjiare3mege16iftxwal3haqye.jpeg"><br><br>  Una opci√≥n un poco m√°s complicada es el <strong>puerto NAT de cono restringido</strong> .  De todos modos, solo STUN debe responder exactamente desde el puerto al que se accedi√≥.  Todo funcionar√° tambi√©n. <br><br>  Lo m√°s da√±ino es <strong>NAT sim√©trica</strong> . <br><img src="https://habrastorage.org/webt/p-/se/fu/p-sefuxnvpapxpuf8-wqavqkd0u.jpeg"><br><br>  Al principio, todo funciona exactamente de la misma manera: Alice env√≠a el paquete al servidor STUN y responde desde el mismo puerto.  Bob no puede responder a Alice, pero ella le env√≠a el paquete a Bob.  Y aqu√≠, a pesar de que Alice env√≠a un paquete al puerto 4444, el mapeo le asigna un nuevo puerto.  La NAT sim√©trica difiere en que cuando se establece cada nueva conexi√≥n, cada vez que emite un nuevo puerto en el enrutador.  En consecuencia, Bob est√° golpeando en el puerto desde el cual Alice fue a STUN, y no pueden conectarse. <br><br>  En la direcci√≥n opuesta, si Bob tiene una direcci√≥n IP abierta, Alice puede acercarse a √©l y establecer√°n una conexi√≥n. <br><br>  Todas las opciones se recopilan en una tabla a continuaci√≥n. <br><img src="https://habrastorage.org/webt/-c/jf/o9/-cjfo9dclflwku9qz-2p4wl_hre.jpeg"><br><br>  Muestra que casi todo es posible excepto cuando intentamos establecer conexiones a trav√©s de NAT sim√©trica con NAT de cono restringido de puerto o NAT sim√©trica en el otro extremo. <br><img src="https://habrastorage.org/webt/gp/lk/_d/gplk_darehdjbaxktic84liuwto.jpeg"><br><br>  Como descubrimos, p2p no tiene precio para nosotros en t√©rminos de latencia, pero si no fue posible instalarlo, WebRTC nos ofrece un servidor TURN.  Cuando nos dimos cuenta de que p2p no se instalar√°, solo podemos conectarnos a TURN, que representar√° todo el tr√°fico.  Sin embargo, al mismo tiempo pagar√° por el tr√°fico, y los usuarios pueden tener algunos retrasos adicionales. <br><br><h2>  Practica <br></h2><br>  Google tiene servidores STUN gratuitos.  Puedes ponerlos en la biblioteca, funcionar√°. <br><br>  Los servidores TURN tienen credenciales (inicio de sesi√≥n y contrase√±a).  Lo m√°s probable es que tengas que criar la tuya, es bastante dif√≠cil de encontrar gratis. <br><br>  Ejemplos de servidores STUN gratuitos de Google: <br><br><ul><li>  aturdimiento: stun.l.google.com: 19302 </li><li>  aturdimiento: stun1.l.google.com: 19302 </li><li>  aturdimiento: stun2.l.google.com: 19302 </li><li>  aturdimiento: stun3.l.google.com: 19302 </li></ul><br>  Y un servidor TURN gratuito con contrase√±as: url: 'turn: 192.158.29.39: 3478? Transport = udp', credencial: 'JZEOEt2V3Qb0y27GRntt2u2PAYA =', nombre de usuario: '28224511: 1379330808'. <br><br>  Usamos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">coturn</a> . <br><img src="https://habrastorage.org/webt/yj/_d/zv/yj_dzvkvpkhmol2a8ryscucgoli.jpeg"><br><br>  Como resultado, el 34% del tr√°fico pasa a trav√©s de la conexi√≥n p2p, todo lo dem√°s se representa a trav√©s del servidor TURN. <br><br><h4>  ¬øQu√© m√°s es interesante en el protocolo STUN? <br></h4><br>  STUN le permite determinar el tipo de NAT. <br><img src="https://habrastorage.org/webt/nj/lo/7h/njlo7h_sounawjxlwk-pxsiejy0.jpeg"><br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><em>Enlace de</em></a> <em>diapositivas</em> <br><br>  Al enviar un paquete, puede indicar que desea recibir una respuesta desde el mismo puerto o pedirle a STUN que responda desde un puerto diferente, desde una IP diferente o incluso desde una IP y puerto diferentes.  Por lo tanto, <strong>para 4 consultas al servidor STUN, puede determinar el tipo de NAT</strong> . <br><img src="https://habrastorage.org/webt/og/0m/2h/og0m2hawerjjdabsr43zwygz_cy.jpeg"><br><br>  Contamos los tipos de NAT y obtuvimos que casi todos los usuarios tienen NAT sim√©trica o NAT de cono restringido a puertos.  Por lo tanto, resulta que solo un tercio de los usuarios pueden establecer una conexi√≥n p2p. <br><br>  Puede preguntar por qu√© le estoy contando todo esto si solo pudiera tomar el STUN de Google, ponerlo en WebRTC, y parece que todo funcionar√°. <br><br>  Porque puedes determinar el tipo de NAT t√∫ mismo. <br><img src="https://habrastorage.org/webt/ih/qn/8j/ihqn8j2nm2dumsstvyopem7ljxk.jpeg"><br><br>  Este es un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">enlace</a> a una aplicaci√≥n Java que no hace nada complicado: solo hace sonar diferentes puertos y diferentes servidores STUN, y mira qu√© puerto ve al final.  Si tiene Open Full cone NAT, el servidor STUN tendr√° el mismo puerto.  Con NAT de cono restringido, tendr√° diferentes puertos para cada solicitud STUN. <br><img src="https://habrastorage.org/webt/ve/qf/t1/veqft1dee6wstziwrkrbemxj5da.jpeg"><br><br>  Con NAT sim√©trica, resulta as√≠ en mi oficina.  Hay puertos completamente diferentes. <br><br>  Pero a veces hay un patr√≥n interesante que para cada conexi√≥n, el n√∫mero de puerto aumenta en uno. <br><img src="https://habrastorage.org/webt/2n/7e/ro/2n7ero_besx7rzunsjuzfjplfpy.jpeg"><br><br>  Es decir, muchos NAT est√°n configurados para que aumenten o disminuyan el puerto de forma constante.  Esta constante se puede encontrar y as√≠ romper a trav√©s de NAT sim√©trica. <br><img src="https://habrastorage.org/webt/te/6n/bf/te6nbfknmebcz7zmrtk35jqwfpk.jpeg"><br><br>  Por lo tanto, rompemos a trav√©s de NAT: vamos a un servidor STUN, a otro, observamos la diferencia, comparamos e intentamos nuevamente dar nuestro puerto con este incremento o decremento.  Es decir, Alice est√° tratando de darle a Bob su puerto, ya ajustado para una constante, sabiendo que la pr√≥xima vez ser√° solo eso. <br><img src="https://habrastorage.org/webt/l1/re/-m/l1re-mp1om6zkjqm0j1n5rfh004.jpeg"><br><br>  As√≠ que logramos soldar <strong>otro 12% de igual a igual</strong> . <br><br>  De hecho, a veces los enrutadores externos con la misma IP se comportan igual.  Por lo tanto, si recopila estad√≠sticas y si Symmetric NAT es una funci√≥n del proveedor y no una funci√≥n del enrutador Wi-Fi del usuario, entonces se puede predecir el delta, env√≠elo inmediatamente al usuario para que lo use y no pase demasiado tiempo determin√°ndolo. <br><br><h2>  CDN Relay o qu√© hacer si no puede establecer una conexi√≥n P2P <br></h2><br>  Si todav√≠a utilizamos el servidor TURN y no trabajamos en p2p, sino en modo real, pasando todo el tr√°fico a trav√©s del servidor, a√∫n podemos agregar un CDN.  A menos, por supuesto, que tenga un parque infantil.  Tenemos nuestros propios sitios de CDN, por lo que para nosotros fue bastante simple.  Pero era necesario determinar d√≥nde es mejor enviar a una persona: a un sitio de CDN o, por ejemplo, a un canal a Mosc√∫.  Esta no es una tarea muy trivial, as√≠ que hicimos esto: <br><br><ol><li>  Emitido accidentalmente a algunos usuarios del sitio de Mosc√∫, algunos remotos. <br></li><li>  Recopilamos estad√≠sticas sobre la IP del usuario, los servidores y las caracter√≠sticas de la red. <br></li><li>  Por maxMind, agrupamos las subredes, miramos las estad√≠sticas y pudimos entender por IP qu√© usuario ten√≠a el servidor TURN m√°s cercano para la conexi√≥n. <br></li></ol><br><img src="https://habrastorage.org/webt/ql/dg/sy/qldgsyqtvaeqqdvyctilcipatau.jpeg"><br><br>  Hay un CDN en Novosibirsk.  Si todo funciona para usted en Mosc√∫, entonces el percentil 99 de RTT es 1.3 segundos.  A trav√©s de CDN, todo funciona mucho m√°s r√°pido (0,4 segundos). <br><br>  ¬øSiempre es mejor usar una conexi√≥n p2p y no usar un servidor?  Un ejemplo interesante son los dos proveedores de Krasnoyarsk, Optibyte y Mobra (los nombres pueden haber cambiado).  Por alguna raz√≥n, la conexi√≥n entre ellos en p2p es mucho peor que a trav√©s de MSK.  Probablemente no son amigos entre s√≠. <br><img src="https://habrastorage.org/webt/yq/en/dm/yqendmksjs7vila8zpra1xu_2uc.jpeg"><br><br>  Analizamos todos estos casos, enviando aleatoriamente a los usuarios a p2p o v√≠a MSK, recopilamos estad√≠sticas y construimos predicciones.  Sabemos que las estad√≠sticas deben actualizarse, por lo que para algunos usuarios establecemos especialmente conexiones diferentes para verificar si algo ha cambiado en las redes. <br><br>  Medimos caracter√≠sticas tan simples como el tiempo de ronda, la p√©rdida de paquetes, el ancho de banda: queda por aprender c√≥mo compararlos correctamente. <br><img src="https://habrastorage.org/webt/yu/l-/nb/yul-nbvpnw5za6ixc80wlgumrse.jpeg"><br><br>  ¬øC√≥mo entender cu√°l es mejor: 2 Mbit / s de Internet, 400 ms RTT y 5% de p√©rdida de paquetes o 100 Kbit / s, 100 ms de retraso y escasa p√©rdida de paquetes? <br><br>  No hay una respuesta exacta, la evaluaci√≥n de la calidad de las videollamadas es muy subjetiva.  Por lo tanto, despu√©s del final de la llamada, pedimos a los usuarios que evaluaran la calidad de los asteriscos y establecieran las constantes de acuerdo con los resultados.  Result√≥ que, por ejemplo, RTT es inferior a 300 ms: ya no importa, la tasa de bits es m√°s importante. <br><br>  Mayores calificaciones de usuario en Android e iOS.  Se ve que los usuarios de iOS tienen m√°s probabilidades de poner una unidad y m√°s a menudo cinco.  No s√© por qu√©, probablemente, los detalles de la plataforma.  Pero arrastramos las constantes a lo largo de ellas, de modo que tuvimos, como nos parece, bueno. <br><br>  Volviendo a nuestro esquema para el art√≠culo, todav√≠a estamos discutiendo la red. <br><br>  <strong>¬øC√≥mo se ve la configuraci√≥n de la conexi√≥n?</strong> <br><img src="https://habrastorage.org/webt/-o/0b/zz/-o0bzzfolvd5rhfysec57ebndda.jpeg"><br><br>  Enviamos servidores STUN y TURN a PeerConnection (), se establece una conexi√≥n.  Alice descubre su IP, la env√≠a a se√±alizaci√≥n;  Bob se entera de la IP de Alice.  Alice obtiene la IP de Bob.  Intercambian paquetes, tal vez rompen a trav√©s de NAT, tal vez establecen TURN y se comunican. <br><img src="https://habrastorage.org/webt/yz/oa/rv/yzoarv064wp3s6zwwjpy0ec68hk.jpeg"><br><br>  En los 5 pasos para establecer la conexi√≥n que discutimos anteriormente, descubrimos los servidores, descubrimos d√≥nde obtenerlos y que los candidatos de ICE son direcciones IP externas que intercambiamos a trav√©s de la se√±alizaci√≥n.  Las direcciones IP internas de los clientes, si est√°n dentro del alcance de un Wi-Fi, tambi√©n se pueden intentar para romper. <br><br>  Pasemos a la parte del video. <br><br><h2>  Video y audio <br></h2><br>  WebRTC admite un cierto conjunto de c√≥decs de video y audio, pero puede agregar su propio c√≥dec all√≠.  B√°sicamente compatible con <strong>H.264 y VP8 para video</strong> .  VP8 es un c√≥dec de software, por lo tanto, consume mucha bater√≠a.  H.264 no est√° disponible en todos los dispositivos (generalmente es nativo), por lo que la prioridad predeterminada es VP8. <br><br>  Dentro del SDP (Protocolo de descripci√≥n de sesi√≥n), existe una negociaci√≥n de c√≥dec: cuando un cliente env√≠a una lista de sus c√≥decs, el otro env√≠a los suyos con prioridad, y acuerdan qu√© c√≥decs utilizar√°n para la comunicaci√≥n.  Si lo desea, puede cambiar la prioridad de los c√≥decs VP8 y H.264, y debido a esto, puede ahorrar bater√≠a en algunos dispositivos, donde 264 es nativo.  Aqu√≠ hay <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">un ejemplo</a> de c√≥mo se puede hacer esto.  Hicimos esto, nos pareci√≥ que los usuarios no se quejaron de la calidad, pero al mismo tiempo la carga de la bater√≠a se consumi√≥ mucho menos. <br><br>  Para el audio, WebRTC tiene <strong>OPUS o G711</strong> , generalmente todos los OPUS siempre funcionan, no es necesario hacer nada con √©l. <br><br>  A continuaci√≥n se muestran las mediciones de temperatura despu√©s de 10 minutos de uso. <br><img src="https://habrastorage.org/webt/pf/-q/pj/pf-qpjvwi8myzm7_q1zlmpe2zbs.jpeg"><br><br>  Est√° claro que probamos diferentes dispositivos.  Este es un ejemplo de un iPhone, y en √©l, la aplicaci√≥n OK utiliza menos la bater√≠a, porque la temperatura del dispositivo es la menor. <br><br>  La segunda cosa que puede habilitar si usa WebRTC es <strong>apagar autom√°ticamente el video cuando la conexi√≥n es muy deficiente</strong> . <br><img src="https://habrastorage.org/webt/xg/kx/ab/xgkxab9ccijdbomfmja0rtrhfpg.jpeg"><br><br>  Si tiene menos de 40 Kbps, el video se apagar√°.  Solo necesita marcar la casilla al crear la conexi√≥n, el valor umbral se puede configurar a trav√©s de la interfaz.  Tambi√©n puede establecer la tasa de bits de arranque actual m√≠nima y m√°xima. <br><img src="https://habrastorage.org/webt/xw/7d/ts/xw7dtsmnuz7pe0ujabtjapnnkxg.jpeg"><br><br>  Esto es algo muy √∫til.  Si cuando establece una conexi√≥n, sabe de antemano qu√© tasa de bits espera, puede transferirla, la llamada comenzar√° desde ella y no necesitar√° adaptar la tasa de bits.  Adem√°s, si sabe que a menudo tiene p√©rdida de paquetes o reducci√≥n de ancho de banda en su canal, entonces el valor m√°ximo tambi√©n puede ser limitado. <br><br>  WhatsApp funciona con videos muy jabonosos, pero con peque√±os retrasos, ya que comprime agresivamente la tasa de bits desde arriba. <br><br>  Recopilamos estad√≠sticas usando MaxMind y lo mapeamos. <br><img src="https://habrastorage.org/webt/la/1b/kq/la1bkqswv6zqpbqdd7zrjarq0xu.jpeg"><br><br>  Esta es una calidad inicial aproximada que utilizamos para llamadas en diferentes regiones de Rusia. <br><br><h2>  Se√±alizaci√≥n <br></h2><br>  Lo m√°s probable es que tenga que escribir esta parte si desea hacer llamadas.  Hay todo tipo de trampas.  Recordemos c√≥mo se ve. <br><img src="https://habrastorage.org/webt/ip/iv/er/ipiverlo5evjhsixis-obij86vs.jpeg"><br><br>  Hay una aplicaci√≥n con se√±alizaci√≥n que se conecta e intercambia con SDP, y el SDP a continuaci√≥n es la interfaz para WebRTC. <br><br>  As√≠ es como se ve la se√±alizaci√≥n simple: <br><img src="https://habrastorage.org/webt/y3/zl/ih/y3zlihhnt8w32ukv-ms7sbelbgm.jpeg"><br><br>  Alice llama a Bob.  Se conecta, por ejemplo, a trav√©s de una conexi√≥n de socket web.  Bob recibe un impulso en su tel√©fono m√≥vil o navegador, o en alguna conexi√≥n abierta, se conecta a trav√©s de un enchufe web y luego el tel√©fono comienza a sonar en su bolsillo.  Bob levanta el tel√©fono, Alice le env√≠a sus c√≥decs y otras caracter√≠sticas de WebRTC que admite.  Bob le responde lo mismo, y despu√©s de eso intercambian los candidatos que vieron.  ¬°Hurra, llama! <br><br>  Todo parece bastante largo.  Primero, hasta que establezca una conexi√≥n de socket web, hasta que llegue el empuje y todo lo dem√°s, el tel√©fono de Bob no sonar√° en su bolsillo.  Alice esperar√° todo el tiempo, pensar√° d√≥nde est√° Bob, por qu√© no levanta el tel√©fono.  Despu√©s de la confirmaci√≥n, todo lleva segundos, e incluso en buenas conexiones puede ser de 3 a 5 segundos, y en malas conexiones, todos los 10. <br><br>  ¬°Debemos hacer algo al respecto!  Me dir√°s que todo se puede hacer de manera muy simple. <br><br><img src="https://habrastorage.org/webt/kz/q0/ym/kzq0ymgejzqqpmlyso5ri8mvz-k.jpeg"><br><br>  Si ya tiene una conexi√≥n abierta para su aplicaci√≥n, puede enviar inmediatamente un impulso para establecer una conexi√≥n, conectarse al servidor de se√±alizaci√≥n deseado e inmediatamente comenzar a hacer llamadas. <br><br>  Luego otra optimizaci√≥n.  Incluso si el tel√©fono sigue sonando en su bolsillo y no lo ha recogido, puede intercambiar informaci√≥n sobre los c√≥decs compatibles, las direcciones IP externas, comenzar a enviar paquetes de video vac√≠os y, en general, todo se calentar√°.  Una vez que levante el tel√©fono, todo ser√° genial. <br><br>  Lo hicimos, y parec√≠a que todo estaba bien.  Pero no <br><img src="https://habrastorage.org/webt/hh/m5/t6/hhm5t6dtihar96isxhtsm92pums.jpeg"><br><br>  El primer problema es que los usuarios a menudo cancelan la llamada.  Hacen clic en "Llamar" e inmediatamente se cancelan.  En consecuencia, el impulso se dirige a la llamada y el usuario desaparece (ha perdido Internet u otra cosa).  Mientras tanto, suena el tel√©fono de alguien, levanta el tel√©fono y no se lo espera all√≠.  Por lo tanto, nuestra optimizaci√≥n primitiva para comenzar a llamar lo m√°s r√°pido posible realmente no funciona. <br><img src="https://habrastorage.org/webt/xy/we/gy/xywegygpnsrlns4osq7nn4i71f0.jpeg"><br><br>  Con una cancelaci√≥n de llamada r√°pida, hay una segunda cosa da√±ina.  Si genera la ID de su conversaci√≥n en el servidor, entonces debe esperar una respuesta.  Es decir, crea una llamada, obtiene una identificaci√≥n y solo despu√©s de eso puede hacer lo que quiera: enviar paquetes, intercambiar, incluso cancelar la llamada.  Esta es una historia muy mala, porque resulta que hasta que llegue la respuesta, en realidad no puede cancelar nada del cliente.  Por lo tanto, es mejor generar alg√∫n tipo de ID en el cliente, como un GUID y decir que inici√≥ la llamada.  La gente a menudo hace esto: llamaron, cancelaron e inmediatamente volvieron a llamar.  Para evitar que esto se estropee, haga un GUID y env√≠elo. <br><img src="https://habrastorage.org/webt/1e/he/ob/1eheobd8oyf6z-je6j0puuj7psy.jpeg"><br><br>  Parece no ser nada, pero hay otro problema.  Si Bob tiene dos tel√©fonos, o en alg√∫n otro lugar el navegador permanece abierto, entonces todo nuestro esquema m√°gico para intercambiar paquetes, establecer una conexi√≥n no funciona si de repente responde desde otro dispositivo. <br><br>  Que hacer  Volvamos a nuestro esquema b√°sico simple de se√±alizaci√≥n lenta y optim√≠celo, env√≠e el empuje un poco antes.  El usuario comenzar√° a conectarse m√°s r√°pido, pero esto ahorrar√° algunos centavos. <br><img src="https://habrastorage.org/webt/ap/k3/kx/apk3kx9qq3nsrzmrervqa548e-g.jpeg"><br><br>  ¬øQu√© hacer con la parte m√°s larga despu√©s de que levant√≥ el tel√©fono y comenz√≥ el intercambio? <br><img src="https://habrastorage.org/webt/ff/bj/qv/ffbjqvge9liirsi6spjc7ttlyby.jpeg"><br><br>  Puedes hacer lo siguiente.  Est√° claro que Alice ya conoce todos sus c√≥decs y puede enviarlos a los dos tel√©fonos de Bob.  Puede resolver todas sus direcciones IP y tambi√©n enviarlas a la se√±alizaci√≥n, lo que las mantendr√° en su cola, pero no enviar√° a ninguno de los clientes para que puedan comenzar a conectarse con ella con anticipaci√≥n. <br><br>   ?  offer,   ,    ,   , ,    ,   .     ,    codec negotiation,  signaling             ,   ,     . Candidates         signaling. <br><br>   ,   signaling               .    ,          ,       . <br><br>    .           Google Duo  WhatsApp. <br><img src="https://habrastorage.org/webt/qr/gs/ry/qrgsry_mx3ahy48v6gvw1l49uau.jpeg"><br><br> ,   -  . ,      signaling,     ,   ,  , ,  ,    .     . <br><br> <strong>    ?</strong> <br><img src="https://habrastorage.org/webt/tp/fn/p3/tpfnp3a3cqrv_pdv31x7m4tirxi.jpeg"><br><br>      :   ,    .   ,      , ‚Äî   signaling  ,  ,   -  ,     ,     ,     . <br><img src="https://habrastorage.org/webt/so/mv/go/somvgopdt0c3zi5kksffvtpogz4.jpeg"><br><br>  ,   ,  ,      .          . ,     ,       ,   ,    .       ,    . <br><br>          ,     24/7,      -,      . <br><img src="https://habrastorage.org/webt/3a/uh/au/3auhaued9dsrfuwyhffcubvuqpy.jpeg"><br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><em></em></a> <em>       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="> </a></em> <br><br>    web-socket  - load balancer,    signaling-   -,       .  Zookeeper   Leader Election,     signaling,     conversation.       conversation,      . <br><br>      ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">NewSQL  Cassandra</a> .     ,  .       ,    signaling,   ,    signaling,     - ,  Leader Election  Zookeeper,   ,   ,         . <br><br>   : <br><br><ul><li>   - , ,   IP  signaling </li><li> Signaling ,   . </li><li>  ,  ,   , ,     . </li><li>       . </li></ul><br>     ,   . <br><br>           Cassandra,       ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="></a>    ). <br><br> <strong>,  :</strong> <br><br><ul><li>   iceServers    ; </li><li>   Session Description Protocol; </li><li>         ; </li><li>      signaling    WebRTC   ,   IP ; </li><li>    ! </li></ul><br><img src="https://habrastorage.org/webt/6j/hp/6k/6jhp6kn6luheqat6jepleauq1me.jpeg"><br><br> <strong> :</strong> <br><br><ul><li>   delay    ; </li><li>     ; </li><li>        . </li></ul><br>  Wow! <br><img src="https://habrastorage.org/webt/97/ru/zy/97ruzyu7gams8pyk2ktcoqb9yim.jpeg"><br><br><h2> Security. Man in the middle attack for WebRTC <br></h2><br>   man in the middle attack for WebRTC.   , WebRTC      ,     RTP,   1996 ,  SDP   1998  SIP. <br><img src="https://habrastorage.org/webt/yi/zm/7k/yizm7kvtjfnpnphvmuwiduk6yua.jpeg"><br><br>    ‚Äî   RFC     RTP,    RTP WebRTC. <br><br>      RFC ‚Äî       audio level,   ,     audio level  ,   . ,    SDP,   ,     .      congestion,       -. <br><br>  WebRTC  .  2011     ,  2013    Firefox,      iOS/Android,  2014 Opera.  , -   ,         . <br><img src="https://habrastorage.org/webt/53/s2/31/53s231p3esxh8vt9ls8dn8szgqi.jpeg"><br><br>       signaling,      ,  DTLS Handshake   .  ,       signaling,         ¬´¬ª   ,   ,      ,   . <br><img src="https://habrastorage.org/webt/i-/lq/uh/i-lquhbrd0eltgcqorvk1bu2gjs.jpeg"><br><br>       , , ,    HTTPS, WSS  ..     ‚Äî ZRTP,  , , Telegram. <br><br>    Telegram ,   ,     .       ,    ,  ,     ,       p2p . <br><br>  Como funciona <br><img src="https://habrastorage.org/webt/rx/0-/ws/rx0-wsjwmt6y8fboqtzsgyzpqos.jpeg"><br><br>          ‚Äî .    ,    ,  .          .              K,    ,     ,        . <br><br>       ,       ,     K <sub>1</sub>  K <sub>2</sub> .       .    .   K <sub>1</sub>  K <sub>2</sub>     ,         .       K <sub>1</sub>  K <sub>2</sub>     :  ,   ‚Äî  ,   ‚Äî       ,  .        ,     ,  -    , ,   . <br><br><h2> <strong></strong> <br></h2><br><ul><li>  ¬´¬ª NAT type   symmetric NAT. </li><li>  ,  : 2  relay, , CDN;         . </li><li>   ,   . </li><li>    signaling. </li></ul><br><img src="https://habrastorage.org/webt/xr/h6/2i/xrh62iyyd4cb5ynwfa66atogljm.jpeg"><br><br>   ,       RTMFP, ,     WebRTC,   ,    .    !           4 . <br><br><h2> <strong> </strong> <br></h2><br>      ,    : <br><br><ul><li>   WebRTC  ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://webrtc.org/native-code/development/</a> ),    iOS/Android,      ; </li><li>    coturn ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://github.com/coturn/coturn</a> ); </li><li>  signaling. </li></ul><br>   ,    . <br><br><div class="spoiler"> <b class="spoiler_title">     </b> <div class="spoiler_text"><iframe width="560" height="315" src="https://www.youtube.com/embed/MnEXuKHjIOU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br></div></div><br><blockquote>        HighLoad++  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="></a>      4-. <br><br>     ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="></a> .    ,  19  (10    9    -)  ,   -    .  ,       ,   . <br></blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es428217/">https://habr.com/ru/post/es428217/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es428203/index.html">Observamos los gr√°ficos: estimaciones y pron√≥sticos para el mercado de computaci√≥n en la nube, datos en 2018</a></li>
<li><a href="../es428205/index.html">Lifehacks NaviHaka</a></li>
<li><a href="../es428209/index.html">Libro de cocina del desarrollador: recetas de dise√±o impulsado por dominio (Parte 2, estructura e interacci√≥n)</a></li>
<li><a href="../es428211/index.html">El libro "Arquitectura evolutiva. Apoyo al cambio continuo "</a></li>
<li><a href="../es428213/index.html">C√≥mo interpretar predicciones de modelos en SHAP</a></li>
<li><a href="../es428219/index.html">¬øDe d√≥nde viene la pr√°ctica de la reubicaci√≥n masiva de personal calificado?</a></li>
<li><a href="../es428221/index.html">Generaci√≥n AI de caras realistas</a></li>
<li><a href="../es428223/index.html">Ciudades y sus Big Data</a></li>
<li><a href="../es428225/index.html">C√≥mo hacer an√°lisis web para SaaS a trav√©s de Google Analytics: introducci√≥n y seguimiento de un embudo</a></li>
<li><a href="../es428227/index.html">Aprendizaje autom√°tico: predicci√≥n de precios de acciones en el mercado de valores</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>