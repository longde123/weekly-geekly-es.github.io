<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üòÑ ‚òÉÔ∏è üòî Enregistreur multifonctionnel de bricolage. Partie 1 üëãüèø ü§∏ üåÄ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Je suis le propri√©taire d'un merveilleux appareil - enregistreur GPS Holux M-241. La chose est tr√®s pratique et utile en voyage. Avec l'aide d'un enre...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Enregistreur multifonctionnel de bricolage. Partie 1</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/401899/"><img src="https://habrastorage.org/getpro/geektimes/post_images/65a/f4c/1c8/65af4c1c8bd4dd394b6a6d2939c6d211.jpg" alt="image"><br><br>  Je suis le propri√©taire d'un merveilleux appareil - enregistreur GPS Holux M-241.  La chose est tr√®s pratique et utile en voyage.  Avec l'aide d'un enregistreur, j'√©cris une trace GPS d'un voyage, le long de laquelle vous pouvez ensuite voir votre chemin en d√©tail, et attacher √©galement les photos que vous prenez aux coordonn√©es GPS.  Il a √©galement un petit √©cran qui affiche des informations suppl√©mentaires - heures, vitesse actuelle, altitude et direction, odom√®tre et bien plus encore.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Ici,</a> j'ai √©crit une fois une courte critique. <br><br>  Avec tous les avantages d'un morceau de fer, j'ai commenc√© √† en sortir.  Il me manque quelques petites mais utiles: quelques odom√®tres, montrant la vitesse verticale, mesurant les param√®tres d'une section de piste.  Cela semble √™tre de petites choses, mais la soci√©t√© Holux a trouv√© cela pas assez utile pour la mise en ≈ìuvre dans le firmware.  De plus, je n'aime pas certains param√®tres du mat√©riel, et certaines choses sont devenues obsol√®tes en 10 ans ... <br><br>  √Ä un moment donn√©, j'ai r√©alis√© que je peux moi-m√™me cr√©er un enregistreur avec les fonctionnalit√©s dont j'ai besoin.  Heureusement, tous les composants n√©cessaires sont assez bon march√© et abordables.  J'ai commenc√© √† faire mon impl√©mentation bas√©e sur Arduino.  Sous la coupe, un journal de construction o√π j'ai essay√© de peindre mes solutions techniques. <br><a name="habracut"></a><br><h1>  D√©finition des fonctionnalit√©s </h1><br>  Beaucoup demanderont pourquoi j'ai besoin de construire mon propre enregistreur, s'il est certain qu'il y a quelque chose de pr√™t pour d'√©minents fabricants.  C'est possible.  Pour √™tre honn√™te, je ne l'ai pas vraiment cherch√©.  Mais c'est s√ªr qu'il manquera quelque chose.  En tout cas, ce projet est un fan pour moi.  Pourquoi ne commen√ßons-nous pas √† construire notre appareil de r√™ve? <br><br>  Donc, pour ce que j'appr√©cie mon Holux M-241. <br><br><ul><li>  <b>L'√©cran</b> fait une ¬´bo√Æte noire¬ª, dont les r√©sultats ne sont disponibles qu'apr√®s le voyage, un outil tr√®s pratique, dont les lectures sont disponibles ici et maintenant.  Avoir un √©cran rend possible presque toutes les fonctionnalit√©s de cette liste. </li><li>  <b>Une montre</b> est utile en soi.  Lors de voyages GPS, l'enregistreur suspendu √† une ficelle autour de son cou se r√©v√®le souvent √™tre plus proche qu'un t√©l√©phone portable dans sa poche ou dans un sac √† dos.  La montre prend en charge tous les fuseaux horaires (mais avec commutation manuelle) </li><li>  <b>Le bouton POI</b> vous permet de marquer les coordonn√©es actuelles sur la piste.  Par exemple, pour noter un point de rep√®re qui s'est gliss√© √† l'ext√©rieur de la fen√™tre du bus, √† propos duquel je veux google plus tard. </li><li>  √Ä l'aide de l' <b>odom√®tre,</b> vous pouvez mesurer la distance parcourue √† partir d'un certain point.  Par exemple, la distance parcourue par jour ou la longueur d'une piste. </li><li>  <b>La vitesse, l'altitude et la direction actuelles</b> vous aident √† vous retrouver dans l'espace </li><li>  <b>La capacit√© de survie de 12 √† 14 heures</b> d'une pile AA dans la plupart des cas vous permet de ne pas penser aux probl√®mes d'alimentation.  C'est-√†-dire  charge presque toujours suffisante pour une journ√©e compl√®te de voyage. </li><li>  <b>Compact et facile √† utiliser</b> - les choses dans le monde moderne sont tr√®s belles </li></ul><br>  Cependant, certaines choses pourraient √™tre l√©g√®rement am√©lior√©es: <br><br><ul><li>  Le sous-syst√®me d'alimentation des <b>piles AA est</b> consid√©r√© par beaucoup comme un avantage certain - une batterie dure longtemps et vous pouvez reconstituer l'alimentation dans n'importe quel d√©sert.  Vous pouvez vous approvisionner pendant au moins un mois de camping autonome. <br><br>  Mais pour moi, la dur√©e de vie de la batterie est pure h√©morro√Ødes.  Vous devez transporter une poign√©e de piles et qui sait √† quel point elles sont de haute qualit√© (soudain, elles √©taient allong√©es sur une √©tag√®re pendant 5 ans et d√©j√† auto-d√©charg√©es).  Avec les batteries, l'h√©morragie est encore plus importante.  Mon chargeur ne peut se charger que par paire.  Nous devons d√©charger les batteries afin qu'elles soient du m√™me degr√© de d√©charge.  Par cons√©quent, vous ne vous souvenez jamais o√π vous avez d√©j√† √©t√© lib√©r√©, et o√π pas encore. <br><br>  Pendant 6 ans d'utilisation de l'enregistreur, je ne me suis retrouv√© dans le d√©sert sans √©lectricit√© qu'√† quelques reprises.  En r√®gle g√©n√©rale, j'ai acc√®s au point de vente au moins une fois par jour.  Dans ce cas, la batterie au lithium int√©gr√©e serait beaucoup plus pratique.  Eh bien, dans les cas extr√™mes, j'ai une banque de pav√©s. <br><br></li><li>  <b>L'indication du degr√© de d√©charge est</b> faite tr√®s stupidement - l'indicateur commence √† clignoter lorsque la batterie est sur le point de se d√©charger.  De plus, il peut mourir en 5 minutes et peut-√™tre travailler encore une heure.  Il est tr√®s facile de manquer ce moment et de perdre une partie du journal. <br><br></li><li>  En tant que personne int√©ress√©e par l'aviation, il serait tr√®s int√©ressant pour moi d'observer la <b>vitesse verticale actuelle</b> . <br><br></li><li>  <b>Quelques odom√®tres</b> - il est souvent int√©ressant de mesurer plus d'une distance.  Par exemple, la distance parcourue par jour et pour tout le trajet. <br><br></li><li>  L'odom√®tre se r√©initialise lorsque vous √©teignez l'appareil ou lorsque vous remplacez la batterie.  C'est terriblement inconfortable.  Si vous vous √™tes arr√™t√© pour un repas dans un caf√©, l'enregistreur GPS ne peut pas √™tre √©teint car la valeur sera r√©initialis√©e.  Il doit le laisser allum√© et il continue √† parcourir des kilom√®tres et √† manger la batterie.  Il serait beaucoup plus pratique de pouvoir mettre l'odom√®tre en <b>pause</b> et de <b>sauvegarder les valeurs</b> entre les inclusions. <br><br></li><li>  <b>Mesure des param√®tres du site</b> .  En ski par exemple, je m'int√©resse √† la dur√©e de la descente, √† l'altitude, √† la vitesse moyenne et maximale sur le site, au temps pass√©.  Ce que vous voulez savoir, c'est tout de suite, et pas √† la maison lorsque vous t√©l√©chargez la piste. <br><br></li><li>  <b>La pr√©cision</b> est m√©diocre.  Lorsque vous vous d√©placez rapidement - rien d'autre.  Mais lorsque la vitesse est faible sur la piste, des ¬´bruits¬ª + - 50m sont clairement visibles.  Et pendant une heure de repos, vous pouvez ¬´insister¬ª sur pr√®s d'un kilom√®tre.  L'avantage de la technologie depuis 10 ans est all√© de l'avant et les r√©cepteurs modernes offrent une pr√©cision beaucoup plus grande. <br><br></li><li>  <b>La vitesse de fusion des</b> pistes n'est que de 38 400. Non, eh bien, ce n'est pas grave en 2017 d'utiliser le port COM pour transf√©rer de grandes quantit√©s de donn√©es.  La fusion de 2 m√©gaoctets de flash interne prend plus de 20 minutes. <br><br>  De plus, tous les programmes ne peuvent pas dig√©rer le format des pistes fusionn√©es.  L'utilitaire natif est tr√®s mis√©rable.  Heureusement, il existe le BT747, qui peut fusionner correctement la piste et la convertir en une sorte de format digestible. <br><br></li><li>  <b>La taille du lecteur flash n'est</b> que de 2 Mo.  D'une part, cela suffit pour un voyage de deux semaines avec des points d'√©conomie toutes les 5 secondes.  Mais d'abord, le format interne emball√© <br>  n√©cessite une conversion, et d'autre part ne permet pas d'augmenter le volume </li><li>  <b>Le p√©riph√©rique de stockage de masse</b> pour une raison quelconque n'est plus √† la mode.  Les interfaces modernes tentent de masquer le fait de la pr√©sence de fichiers.  Je travaille avec les ordinateurs depuis 25 ans, et travailler directement avec des fichiers est beaucoup plus pratique pour moi que de toute autre mani√®re. </li></ul><br>  Il n'y a rien ici qui ne pourrait √™tre r√©alis√© sans efforts importants. <br><br>  Rien de diff√©rent.  Je ne l'utilise pas moi-m√™me, mais soudain, quelqu'un est utile: <br><br><ul><li>  Affiche les coordonn√©es actuelles (latitude, longitude) </li><li>  Diff√©rentes ic√¥nes sont dessin√©es sur le c√¥t√© gauche de l'√©cran, dont je ne me souviens m√™me pas de l'essence sans manuel. </li><li>  Il y a des changements de m√®tres / km - pieds / miles. </li><li>  Bluetooth - l'enregistreur peut √™tre connect√© √† des t√©l√©phones mobiles sans GPS. </li><li>  La distance absolue au point. </li><li>  Enregistrement par temps (toutes les N secondes) ou par distance (tous les X m√®tres). </li><li>  Prise en charge de diff√©rentes langues. </li></ul><br><h1>  Choisissez le fer </h1><br>  Les exigences sont plus ou moins d√©finies.  Il est temps de comprendre comment tout cela peut √™tre mis en ≈ìuvre.  Les principaux composants que j'aurai seront: <br><br><ul><li>  <b>Microcontr√¥leur</b> - Je n'ai aucun plan pour des algorithmes de calcul sophistiqu√©s, donc la puissance de traitement du noyau n'est pas particuli√®rement importante.  Je n'ai pas non plus d'exigences particuli√®res pour le remplissage - un ensemble de p√©riph√©riques standard fera l'affaire. <br><br>  √Ä port√©e de main √©tait juste une dispersion de divers arduinoes, ainsi que quelques stm32f103c8t6.  J'ai d√©cid√© de commencer par AVR, que je connais bien au niveau du contr√¥leur / registres / p√©riph√©riques.  Si je rencontre des restrictions - il y aura une raison de ressentir le STM32. <br><br></li><li>  <b>Le r√©cepteur GPS a √©t√©</b> s√©lectionn√© parmi les modules NEO6MV2, Beitan BN-800 et Beitan BN-880.  Forums googl√© pendant un certain temps.  Des gens exp√©riment√©s ont dit que le premier r√©cepteur est le si√®cle dernier.  Les deux autres ne diff√®rent que par l'emplacement de l'antenne - dans le BN-800, il est suspendu au fil, et dans le BN-880, il est coll√© avec un sandwich au module principal.  A pris un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">BN-880</a> . <br><br></li><li>  <b>√âcran</b> - l'original utilise un √©cran LCD 128 x 32 avec r√©tro-√©clairage.  Je n'ai pas trouv√© exactement la m√™me chose.  J'ai achet√© un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">OLED 0,91 "sur le contr√¥leur SSD1306</a> et un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">√©cran LCD 1,2" sur le contr√¥leur ST7565R</a> .  J'ai d√©cid√© de partir du premier, car  il est plus facile de se connecter avec un peigne standard selon I2C ou SPI.  Mais il est l√©g√®rement plus petit par rapport √† l'original, et il ne fonctionnera pas non plus pour afficher constamment l'image pour des raisons d'efficacit√© √©nerg√©tique.  Le deuxi√®me √©cran devrait √™tre moins gourmand, mais vous devez lui souder un connecteur d√©licat et comprendre comment alimenter le r√©tro-√©clairage. </li></ul><br>  Des petites choses: <br><br><ul><li>  Les boutons ont une fois achet√© un sac entier; </li><li>  Bouclier avec pour carte SD - √©galement √† port√©e de main; </li><li>  J'ai achet√© une paire de contr√¥leurs de charge diff√©rents pour les batteries au lithium, mais je ne le comprenais toujours pas. </li></ul><br>  J'ai d√©cid√© de concevoir la carte √† la toute fin, lorsque le firmware est pr√™t.  √Ä ce moment, je d√©ciderai enfin des principaux composants et du sch√©ma de leur inclusion.  √Ä la premi√®re √©tape, j'ai d√©cid√© de faire le d√©bogage sur la maquette en connectant les composants √† l'aide de cordons de brassage. <br><br>  Mais vous devez d'abord d√©cider d'une question tr√®s importante - la nutrition des composants.  Il m'a sembl√© raisonnable d'alimenter tout √† partir de 3,3 V: le GPS et l'√©cran uniquement dessus et de savoir comment travailler.  Il s'agit √©galement de la tension native pour USB et SD.  De plus, le circuit peut √™tre aliment√© √† partir d'une bo√Æte de lithium. <br><br>  Le choix s'est port√© sur l'Arduino Pro Mini, que l'on retrouve dans la version 8MHz / 3,3V.  Mais elle n'avait pas d'USB √† bord - j'ai d√ª utiliser un adaptateur USB-UART. <br><br><h1>  Premiers pas </h1><br>  Initialement, le projet a √©t√© cr√©√© dans Arduino IDE.  Mais pour √™tre honn√™te, ma langue n'ose pas l'appeler un IDE - comme un √©diteur de texte avec un compilateur.  En tout cas, apr√®s Visual Studio, dans lequel je travaille depuis 13 ans, je ne peux rien faire de s√©rieux dans l'IDE Arduino sans larmes et matyuk. <br><br>  Heureusement, il existe un Atmel Studio gratuit, dans lequel m√™me Visual Assist est int√©gr√© d√®s la sortie de la bo√Æte !!!  Le programme sait tout ce qui est n√©cessaire, tout est familier et √† sa place.  Eh bien, presque tout (je n'ai pas trouv√© comment compiler un seul fichier, par exemple, pour v√©rifier la syntaxe) <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/bfc/b08/98f/bfcb0898f136628896be3b6769eda34f.png" alt="image"><br><br>  Commenc√© √† partir de l'√©cran - cela est n√©cessaire pour d√©boguer le squelette du firmware, puis le remplir de fonctionnalit√©s.  Il s'est arr√™t√© √† la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">premi√®re biblioth√®que disponible pour Adafruit SSD1306</a> .  Elle sait tout ce qui est n√©cessaire et fournit une interface tr√®s simple. <br><br>  Jou√© avec des polices.  Il s‚Äôest av√©r√© qu‚Äôune police peut prendre jusqu‚Äô√† 8 Ko (la taille des lettres est de 24 pt) - vous ne pouvez surtout pas vous d√©placer dans un contr√¥leur de 32 Ko.  De grandes polices sont n√©cessaires, par exemple, pour afficher l'heure. <br><br><div class="spoiler">  <b class="spoiler_title">Exemple de code de police</b> <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;Adafruit_GFX.h&gt; #include &lt;Adafruit_SSD1306.h&gt; #include &lt;gfxfont.h&gt; #include &lt;fonts/FreeMono12pt7b.h&gt; #include &lt;fonts/FreeMono18pt7b.h&gt; ... #include &lt;fonts/FreeSerifItalic24pt7b.h&gt; #include &lt;fonts/FreeSerifItalic9pt7b.h&gt; #include &lt;fonts/TomThumb.h&gt; struct font_and_name { const char * PROGMEM name; GFXfont * font; }; #define FONT(name) {#name, &amp;name} const font_and_name fonts[] = { // FONT(FreeMono12pt7b), FONT(FreeMono18pt7b), /* FONT(FreeMono24pt7b), FONT(FreeMono9pt7b), FONT(FreeMonoBold12pt7b), ... FONT(FreeSerifItalic9pt7b), FONT(TomThumb)*/ }; const unsigned int fonts_count = sizeof(fonts) / sizeof(font_and_name); unsigned int current_font = 0; extern Adafruit_SSD1306 display; void RunFontTest() { display.clearDisplay(); display.setCursor(0,30); display.setFont(fonts[current_font].font); display.print("12:34:56"); display.setCursor(0,6); display.setFont(&amp;TomThumb); display.print(fonts[current_font].name); display.display(); } void SwitchToNextFont() { current_font = ++current_font % fonts_count; }</span></span></span></span></code> </pre> <br></div></div><br>  Les polices compl√®tes avec la biblioth√®que sont tr√®s maladroites.  La police monospace s'est av√©r√©e tr√®s large - la ligne ¬´12:34:56¬ª ne convient pas, Serif - tous les nombres sont de poids diff√©rents.  √Ä moins que la police standard 5x7 de la biblioth√®que ne semble comestible. <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/b7a/67f/676/b7a67f676d061bdb4920985b0c46692a.jpg" alt="image"><br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/9de/e19/69f/9dee1969f16ad50138756b9dab906d4d.jpg" alt="image"><br><br>  Il s'est av√©r√© que ces polices ont √©t√© converties √† partir de certaines polices ttf open source qui ne sont tout simplement pas optimis√©es pour les petites r√©solutions. <br><br>  J'ai d√ª dessiner mes polices.  Plus pr√©cis√©ment, commencez par d√©terrer les symboles individuels des symboles finis.  Le symbole ¬´:¬ª dans le tableau ASCII est tr√®s utile juste apr√®s les chiffres et peut √™tre achet√© en un seul bloc.  Il est √©galement pratique de cr√©er une police non pas pour tous les caract√®res, mais uniquement pour une plage, par exemple, de 0x30 ('0') √† 0x3a (':').  T.O.  de FreeSans18pt7b, il s'est av√©r√© faire une police tr√®s compacte uniquement pour les caract√®res n√©cessaires.  Certes, j'ai d√ª ajuster l√©g√®rement la largeur pour que le texte tienne dans la largeur de l'√©cran. <br><br><div class="spoiler">  <b class="spoiler_title">Sous-police FreeSans18pt7b</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// This font consists only of digits and ':' to display current time. // The font is very based on FreeSans18pt7b.h //</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment"> 25 pixel height is too much for displaying time. Create another 22px font const uint8_t TimeFontBitmaps[] PROGMEM = { /* 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xE9, 0x20, 0x3F, 0xFC, 0xE3, 0xF1, 0xF8, 0xFC, 0x7E, 0x3F, 0x1F, 0x8E, 0x82, 0x41, 0x00, 0x01, 0xC3, 0x80, ... 0x03, 0x00, 0xC0, 0x60, 0x18, 0x06, 0x03, 0x00, 0xC0, 0x30, 0x18, 0x06, 0x01, 0x80, 0xC0, 0x30, 0x00, */0x07, 0xE0, 0x0F, 0xF8, 0x1F, 0xFC, 0x3C, 0x3C, 0x78, 0x1E, 0x70, 0x0E, 0x70, 0x0E, 0xE0, 0x07, 0xE0, 0x07, 0xE0, 0x07, 0xE0, 0x07, 0xE0, 0x07, 0xE0, 0x07, 0xE0, 0x07, 0xE0, 0x07, 0xE0, 0x07, 0xE0, 0x07, 0xE0, 0x0F, 0x70, 0x0E, 0x70, 0x0E, 0x78, 0x1E, 0x3C, 0x3C, 0x1F, 0xF8, 0x1F, 0xF0, 0x07, 0xE0, 0x03, 0x03, 0x07, 0x0F, 0x3F, 0xFF, 0xFF, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0xE0, 0x1F, 0xF8, 0x3F, 0xFC, 0x7C, 0x3E, 0x70, 0x0F, 0xF0, 0x0F, 0xE0, 0x07, 0xE0, 0x07, 0x00, 0x07, 0x00, 0x07, 0x00, 0x0F, 0x00, 0x1E, 0x00, 0x3C, 0x00, 0xF8, 0x03, 0xF0, 0x07, 0xC0, 0x1F, 0x00, 0x3C, 0x00, 0x38, 0x00, 0x70, 0x00, 0x60, 0x00, 0xE0, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x07, 0xF0, 0x07, 0xFE, 0x07, 0xFF, 0x87, 0x83, 0xC3, 0x80, 0xF3, 0x80, 0x39, 0xC0, 0x1C, 0xE0, 0x0E, 0x00, 0x07, 0x00, 0x0F, 0x00, 0x7F, 0x00, 0x3F, 0x00, 0x1F, 0xE0, 0x00, 0x78, 0x00, 0x1E, 0x00, 0x07, 0x00, 0x03, 0xF0, 0x01, 0xF8, 0x00, 0xFE, 0x00, 0x77, 0x00, 0x73, 0xE0, 0xF8, 0xFF, 0xF8, 0x3F, 0xF8, 0x07, 0xF0, 0x00, 0x00, 0x38, 0x00, 0x38, 0x00, 0x78, 0x00, 0xF8, 0x00, 0xF8, 0x01, 0xF8, 0x03, 0xB8, 0x03, 0x38, 0x07, 0x38, 0x0E, 0x38, 0x1C, 0x38, 0x18, 0x38, 0x38, 0x38, 0x70, 0x38, 0x60, 0x38, 0xE0, 0x38, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x38, 0x00, 0x38, 0x00, 0x38, 0x00, 0x38, 0x00, 0x38, 0x00, 0x38, 0x1F, 0xFF, 0x0F, 0xFF, 0x8F, 0xFF, 0xC7, 0x00, 0x03, 0x80, 0x01, 0xC0, 0x00, 0xE0, 0x00, 0x70, 0x00, 0x39, 0xF0, 0x3F, 0xFE, 0x1F, 0xFF, 0x8F, 0x83, 0xE7, 0x00, 0xF0, 0x00, 0x3C, 0x00, 0x0E, 0x00, 0x07, 0x00, 0x03, 0x80, 0x01, 0xC0, 0x00, 0xFC, 0x00, 0xEF, 0x00, 0x73, 0xC0, 0xF0, 0xFF, 0xF8, 0x3F, 0xF8, 0x07, 0xE0, 0x00, 0x03, 0xE0, 0x0F, 0xF8, 0x1F, 0xFC, 0x3C, 0x1E, 0x38, 0x0E, 0x70, 0x0E, 0x70, 0x00, 0x60, 0x00, 0xE0, 0x00, 0xE3, 0xE0, 0xEF, 0xF8, 0xFF, 0xFC, 0xFC, 0x3E, 0xF0, 0x0E, 0xF0, 0x0F, 0xE0, 0x07, 0xE0, 0x07, 0xE0, 0x07, 0x60, 0x07, 0x70, 0x0F, 0x70, 0x0E, 0x3C, 0x3E, 0x3F, 0xFC, 0x1F, 0xF8, 0x07, 0xE0, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x06, 0x00, 0x0E, 0x00, 0x1C, 0x00, 0x18, 0x00, 0x38, 0x00, 0x70, 0x00, 0x60, 0x00, 0xE0, 0x00, 0xC0, 0x01, 0xC0, 0x01, 0x80, 0x03, 0x80, 0x03, 0x80, 0x07, 0x00, 0x07, 0x00, 0x07, 0x00, 0x0E, 0x00, 0x0E, 0x00, 0x0E, 0x00, 0x0C, 0x00, 0x1C, 0x00, 0x1C, 0x00, 0x07, 0xF0, 0x0F, 0xFE, 0x0F, 0xFF, 0x87, 0x83, 0xC7, 0x80, 0xF3, 0x80, 0x39, 0xC0, 0x1C, 0xE0, 0x0E, 0x78, 0x0F, 0x1E, 0x0F, 0x07, 0xFF, 0x01, 0xFF, 0x03, 0xFF, 0xE3, 0xE0, 0xF9, 0xC0, 0x1D, 0xC0, 0x0F, 0xE0, 0x03, 0xF0, 0x01, 0xF8, 0x00, 0xFC, 0x00, 0xF7, 0x00, 0x73, 0xE0, 0xF8, 0xFF, 0xF8, 0x3F, 0xF8, 0x07, 0xF0, 0x00, 0x07, 0xE0, 0x1F, 0xF8, 0x3F, 0xFC, 0x7C, 0x3C, 0x70, 0x0E, 0xF0, 0x0E, 0xE0, 0x06, 0xE0, 0x07, 0xE0, 0x07, 0xE0, 0x07, 0xE0, 0x0F, 0x70, 0x0F, 0x78, 0x3F, 0x3F, 0xFF, 0x1F, 0xF7, 0x07, 0xC7, 0x00, 0x07, 0x00, 0x06, 0x00, 0x0E, 0x70, 0x0E, 0x70, 0x1C, 0x78, 0x3C, 0x3F, 0xF8, 0x1F, 0xF0, 0x07, 0xC0, 0xFF, 0xF0, 0x00, 0x00, 0x00, 0x07, 0xFF, 0x80 /*, 0xFF, 0xF0, 0x00, 0x00, 0x00, 0x07, 0xFF, 0xB6, 0xD6, 0x00, 0x00, 0x80, 0x03, 0xC0, 0x07, 0xE0, 0x0F, 0xC0, 0x3F, 0x80, 0x7E, 0x00, 0xFC, 0x01, 0xF0, 0x00, 0xE0, 0x00, ... 0x38, 0x38, 0xF8, 0xF0, 0xE0, 0x38, 0x00, 0xFC, 0x03, 0xFC, 0x1F, 0x3E, 0x3C, 0x1F, 0xE0, 0x1F, 0x80, 0x1E, 0x00 */ }; //TODO Recalc offset numbers const GFXglyph TimeFontGlyphs[] PROGMEM = { { 449-449, 16, 25, 19, 2, -24 }, // 0x30 '0' { 499-449, 8, 25, 19, 4, -24 }, // 0x31 '1' { 524-449, 16, 25, 19, 2, -24 }, // 0x32 '2' { 574-449, 17, 25, 19, 1, -24 }, // 0x33 '3' { 628-449, 16, 25, 19, 1, -24 }, // 0x34 '4' { 678-449, 17, 25, 19, 1, -24 }, // 0x35 '5' { 732-449, 16, 25, 19, 2, -24 }, // 0x36 '6' { 782-449, 16, 25, 19, 2, -24 }, // 0x37 '7' { 832-449, 17, 25, 19, 1, -24 }, // 0x38 '8' { 886-449, 16, 25, 19, 1, -24 }, // 0x39 '9' { 936-449, 3, 19, 7, 2, -20 }, // 0x3A ':' }; const GFXfont TimeFont PROGMEM = { (uint8_t *)TimeFontBitmaps, (GFXglyph *)TimeFontGlyphs, 0x30, 0x3A, 20 };</span></span></code> </pre> </div></div><br>  Il s'est av√©r√© que la police 18pt avait en fait 25 pixels de haut.  Pour cette raison, il tient l√©g√®rement sur une autre inscription <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/543/aee/2e5/543aee2e5c6515307a4c969a3bfff374.jpg" alt="image"><br><br>  L'affichage invers√©, soit dit en passant, aide √† comprendre o√π se trouvent r√©ellement les limites de la zone de dessin et comment se situe la ligne par rapport √† cette bordure - l'affichage a de tr√®s grands cadres. <br><br>  Googl√© pendant longtemps les polices pr√™tes √† l'emploi, mais elles ne correspondaient ni √† la taille, ni √† la forme, ni au contenu.  Par exemple, sur Internet, un arbre de polices 8x12 (vidages de g√©n√©rateurs de caract√®res de carte VGA).  Mais en fait, ces polices sont 6x8, c'est-√†-dire  beaucoup de promenades dans l'espace - dans le cas d'une r√©solution et d'une taille aussi petites que la mienne, elles sont essentielles. <br><br>  J'ai d√ª dessiner mes propres polices, car le format de police de la biblioth√®que Adafruit est tr√®s simple.  J'ai pr√©par√© l'image dans Paint.net - j'ai simplement dessin√© les lettres dans la bonne police, puis je les ai corrig√©es un peu avec un crayon.  J'ai enregistr√© l'image au format png, puis je l'ai envoy√©e rapidement au script python √©crit sur mon genou.  Ce script a g√©n√©r√© un code semi-fini qui r√®gle d√©j√† point par point dans l'EDI directement dans les codes hexad√©cimaux. <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/618/78f/f7e/61878ff7eff21be033fdbc56183a4f5e.png" alt="image"><br><br>  Par exemple, voici √† quoi ressemble le processus de cr√©ation d'une police √† espacement fixe 8x12 avec de petites lettres et un interligne.  √Ä la fin, chaque caract√®re s'est av√©r√© √™tre d'environ 7 x 10 et, par d√©faut, il occupait 10 octets.  Il serait possible d'emballer chaque caract√®re dans 8-9 octets (la biblioth√®que le permet), mais je n'ai pas pris la peine.  De plus, dans ce formulaire, vous pouvez modifier des pixels individuels directement dans le code. <br><br><div class="spoiler">  <b class="spoiler_title">Police 8 x 12</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// A simple 8x12 font (slightly modifier Courier New) const uint8_t Monospace8x12Bitmaps[] PROGMEM = { 0x1e, 0x21, 0x21, 0x21, 0x21, 0x21, 0x21, 0x21, 0x21, 0x1e, //0 0x18, 0x68, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x7f, //1 0x3e, 0x41, 0x41, 0x01, 0x02, 0x0c, 0x10, 0x20, 0x41, 0x7f, //2 0x3e, 0x41, 0x01, 0x01, 0x0e, 0x02, 0x01, 0x01, 0x41, 0x3e, //3 0x02, 0x06, 0x0a, 0x12, 0x12, 0x22, 0x3f, 0x02, 0x02, 0x0f, //4 0x7f, 0x41, 0x40, 0x40, 0x7e, 0x01, 0x01, 0x01, 0x41, 0x3e, //5 0x1e, 0x21, 0x40, 0x40, 0x5e, 0x61, 0x41, 0x41, 0x41, 0x3e, //6 0x7f, 0x41, 0x01, 0x02, 0x02, 0x04, 0x04, 0x04, 0x08, 0x08, //7 0x1e, 0x21, 0x21, 0x21, 0x1e, 0x21, 0x21, 0x21, 0x21, 0x1e, //8 0x1e, 0x21, 0x21, 0x21, 0x23, 0x1d, 0x01, 0x01, 0x22, 0x1c, //9 0x00, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00, //: }; const GFXglyph Monospace8x12Glyphs[] PROGMEM = { { 0, 8, 10, 8, 0, -11 }, // 0x30 '0' { 10, 8, 10, 8, 0, -11 }, // 0x31 '1' { 20, 8, 10, 8, 0, -11 }, // 0x32 '2' { 30, 8, 10, 8, 0, -11 }, // 0x33 '3' { 40, 8, 10, 8, 0, -11 }, // 0x34 '4' { 50, 8, 10, 8, 0, -11 }, // 0x35 '5' { 60, 8, 10, 8, 0, -11 }, // 0x36 '6' { 70, 8, 10, 8, 0, -11 }, // 0x37 '7' { 80, 8, 10, 8, 0, -11 }, // 0x38 '8' { 90, 8, 10, 8, 0, -11 }, // 0x39 '9' { 100, 8, 10, 8, 0, -11 }, // 0x3A ':' }; const GFXfont Monospace8x12Font PROGMEM = { (uint8_t *)Monospace8x12Bitmaps, (GFXglyph *)Monospace8x12Glyphs, 0x30, 0x3A, 12 };</span></span></code> </pre><br></div></div><br><h1>  Cadre </h1><br>  L'appareil d'origine fournit une interface tr√®s simple et pratique.  Les informations sont regroup√©es en cat√©gories qui sont affich√©es √† partir de pages individuelles (√©crans).  √Ä l'aide du bouton, vous pouvez parcourir les pages et utiliser le deuxi√®me bouton pour s√©lectionner l'√©l√©ment en cours ou effectuer l'action indiqu√©e dans la signature sous le bouton.  Cette approche me semble tr√®s pratique et il n'y a rien √† changer. <br><br>  J'aime la beaut√© de la POO, car j'ai imm√©diatement √©bloui une petite interface, chaque page impl√©mente l'interface comme elle l'exige.  La page sait se dessiner et met en ≈ìuvre la r√©action aux boutons. <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Screen</span></span></span><span class="hljs-class"> {</span></span> Screen * nextScreen; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: Screen(); <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> ~Screen() {} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">drawScreen</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">drawHeader</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onSelButton</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onOkButton</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> PROGMEM </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">char</span></span></span><span class="hljs-function"> * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getSelButtonText</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> PROGMEM </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">char</span></span></span><span class="hljs-function"> * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getOkButtonText</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">Screen * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addScreen</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Screen * screen)</span></span></span></span>; };</code> </pre> <br>  Les boutons peuvent effectuer diverses actions en fonction de l'√©cran actuel.  Par cons√©quent, le haut de l'√©cran avec une hauteur de 8 pixels, j'ai attribu√© aux √©tiquettes pour les boutons.  Le texte des signatures d√©pend de l'√©cran actuel et est retourn√© par les fonctions virtuelles getSelButtonText () et getOkButtonText ().  √âgalement dans l'en-t√™te, les √©l√©ments de service tels que la force du signal GPS et la charge de la batterie seront toujours affich√©s.  Les √©crans remaining restants sont disponibles pour des informations utiles. <br><br>  Comme je l'ai dit, les √©crans peuvent √™tre retourn√©s, ce qui signifie qu'il devrait y avoir quelque part une liste d'objets pour diff√©rentes pages.  √Ä quoi plusieurs √©crans peuvent √™tre imbriqu√©s, comme un sous-menu.  J'ai m√™me commenc√© la classe ScreenManager, qui √©tait cens√©e g√©rer ces listes, mais j'ai ensuite trouv√© la solution plus facile. <br><br>  Ainsi, chaque √©cran a simplement un pointeur sur le suivant.  Si l'√©cran vous permet d'acc√©der au sous-menu, il ajoute un pointeur de plus √† l'√©cran de ce sous-menu <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Screen</span></span></span><span class="hljs-class"> {</span></span> Screen * nextScreen; ‚Ä¶ }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ParentScreen</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Screen { Screen * childScreen; ‚Ä¶ };</code> </pre> <br>  Par d√©faut, le gestionnaire de boutons appelle simplement la fonction de changement d'√©cran, en lui passant le pointeur souhait√©.  La fonction s'est av√©r√©e √™tre triviale - elle vient de basculer le pointeur sur l'√©cran actuel.  Pour assurer l'imbrication des √©crans, j'ai fait une petite pile.  Ainsi, l'ensemble du gestionnaire d'√©cran tient dans 25 lignes et 4 petites fonctions. <br><br><pre> <code class="cpp hljs">Screen * screenStack[<span class="hljs-number"><span class="hljs-number">3</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> screenIdx = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setCurrentScreen</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Screen * screen)</span></span></span><span class="hljs-function"> </span></span>{ screenStack[screenIdx] = screen; } <span class="hljs-function"><span class="hljs-function">Screen * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCurrentScreen</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> screenStack[screenIdx]; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">enterChildScreen</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Screen * screen)</span></span></span><span class="hljs-function"> </span></span>{ screenIdx++; <span class="hljs-comment"><span class="hljs-comment">//TODO limit this screenStack[screenIdx] = screen; } void backToParentScreen() { if(screenIdx) screenIdx--; }</span></span></code> </pre> <br>  Certes, le code pour remplir ces structures n'est pas tr√®s joli, mais jusqu'√† pr√©sent, il n'a pas √©t√© mieux invent√©. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">Screen * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createCurrentTimeScreen</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ TimeZoneScreen * tzScreen = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TimeZoneScreen(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>); tzScreen = tzScreen-&gt;addScreen(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TimeZoneScreen(<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">45</span></span>)); tzScreen = tzScreen-&gt;addScreen(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TimeZoneScreen(<span class="hljs-number"><span class="hljs-number">-3</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>)); <span class="hljs-comment"><span class="hljs-comment">// TODO Add real timezones here CurrentTimeScreen * screen = new CurrentTimeScreen(); screen-&gt;addChildScreen(tzScreen); return screen; }</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">La pens√©e</b> <div class="spoiler_text">  La structuration, bien s√ªr, s'est av√©r√©e belle, mais je crains qu'elle ne mange beaucoup de m√©moire.  Vous devez aller contre vous-m√™me et zafigachit une grande table statique avec des pointeurs. <br></div></div><br>  Allez-y.  Dans mon impl√©mentation de l'interface, je voulais faire quelque chose comme une bo√Æte de message, un court message qui appara√Ætrait pendant une seconde ou deux, puis dispara√Ætrait.  Par exemple, si vous appuyez sur le bouton POI (Point Of Interest) sur l'√©cran avec les coordonn√©es actuelles, puis en plus d'√©crire le point sur la piste, il serait bien de montrer √† l'utilisateur le message ¬´Waypoint Saved¬ª (dans l'appareil d'origine, une ic√¥ne suppl√©mentaire ne s'affiche que pendant une seconde).  Ou, lorsque la batterie est faible, ¬´remontez le moral¬ª de l'utilisateur avec un message. <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/aa5/dec/17b/aa5dec17b1b4b298b764fce33b8441db.jpg" alt="image"><br><br>  √âtant donn√© que les donn√©es du GPS viendront constamment, il ne peut √™tre question d'aucune fonction de blocage.  Par cons√©quent, j'ai d√ª inventer une machine √† √©tats simple (machine √† √©tats), qui dans la fonction loop () choisirait quoi faire - afficher l'√©cran ou la bo√Æte de message actuelle. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> State { IDLE_DISPLAY_OFF, IDLE, MESSAGE_BOX, BUTTON_PRESSED, };</code> </pre> <br>  Il est √©galement pratique de g√©rer les pressions de bouton √† l'aide de la machine d'√©tat.  Peut-√™tre que ce serait correct √† travers des interruptions, mais √ßa s'est bien pass√© aussi.  Cela fonctionne comme ceci: si un bouton a √©t√© enfonc√© √† l'√©tat IDLE, rappelez-vous l'heure √† laquelle il a √©t√© enfonc√© et passez √† l'√©tat BUTTON_PRESSED.  Dans cet √©tat, nous attendons que l'utilisateur rel√¢che le bouton.  Ici, nous pouvons calculer la dur√©e lorsque le bouton a √©t√© enfonc√©.  Les r√©ponses courtes (&lt;30 ms) sont simplement ignor√©es - il s'agit tr√®s probablement d'un rebond de contacts.  Les longs trajets peuvent d√©j√† √™tre interpr√©t√©s comme une pression sur un bouton. <br><br>  Je pr√©vois d'utiliser √† la fois des pressions courtes sur les boutons pour les actions ordinaires et des pressions longues (&gt; 1c) pour les fonctions sp√©ciales.  Par exemple, une pression courte d√©marre / met en pause le compteur kilom√©trique, une pression longue r√©initialise le compteur √† 0. <br><br>  Peut-√™tre que d'autres √âtats seront ajout√©s.  Ainsi, par exemple, dans l'enregistreur d'origine apr√®s le passage √† la page suivante, les valeurs √† l'√©cran changent souvent, et moins souvent apr√®s quelques secondes - une fois par seconde.  Cela peut √™tre fait en ajoutant un autre √©tat. <br><br>  Lorsque le cadre √©tait pr√™t, j'ai d√©j√† commenc√© √† connecter le GPS.  Mais ici, il y avait des nuances qui m'ont fait reporter cette t√¢che. <br><br><h1>  Optimisation du firmware </h1><br>  Avant de continuer, je dois me laisser distraire par certains d√©tails techniques.  Le fait est qu'√† peu pr√®s √† cet endroit, je commen√ßai √† augmenter ma consommation de m√©moire.  Il s'est av√©r√© que la ligne d√©clar√©e imprudemment sans le modificateur PROGMEM au d√©but du firmware est copi√©e dans la RAM et y occupe de l'espace tout au long de l'ex√©cution. <br><br><div class="spoiler">  <b class="spoiler_title">Architectures diverses</b> <div class="spoiler_text">  En un mot.  Sur les gros ordinateurs, l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">architecture Von Neumann est utilis√©e</a> lorsque le code et les donn√©es sont situ√©s dans le m√™me espace d'adressage.  C'est-√†-dire  les donn√©es de la RAM et de la ROM seront lues de la m√™me mani√®re. <br><br>  Les microcontr√¥leurs utilisent g√©n√©ralement <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">l'architecture Harvard</a> , o√π le code et les donn√©es sont s√©par√©s.  T.O.  vous devez utiliser diverses fonctions pour lire la m√©moire et le flash.  Du point de vue du langage C / C ++, les pointeurs se ressemblent, mais lors de l'√©criture d'un programme, nous devons savoir exactement o√π exactement vers quelle m√©moire pointe notre pointeur et appeler les fonctions correspondantes. </div></div><br>  Heureusement, les d√©veloppeurs de biblioth√®ques se sont d√©j√† partiellement occup√©s de cela.  La classe principale de la biblioth√®que d'affichage - Adafruit_SSD1306 est h√©rit√©e de la classe Print de la biblioth√®que standard Arduino. <br><br>  Cela nous fournit toute une s√©rie de diff√©rentes modifications de la m√©thode d'impression - pour imprimer des cha√Ænes, des caract√®res uniques, des chiffres et autre chose.  Il a donc 2 fonctions distinctes pour l'impression des lignes: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> print(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> __FlashStringHelper *); <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> print(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>[]);</code> </pre><br>  Le premier sait que vous devez imprimer une ligne √† partir d'un lecteur flash et la charge caract√®re par caract√®re.  Le second imprime des caract√®res √† partir de la RAM.  En fait, ces deux fonctions prennent un pointeur sur une cha√Æne, uniquement √† partir d'espaces d'adressage diff√©rents. <br><br>  Pendant longtemps, j'ai cherch√© dans le code arduino ce tr√®s __FlashStringHelper pour apprendre √† appeler la fonction print () souhait√©e.  Il s'est av√©r√© que les gars ont fait l'affaire: ils ont simplement d√©clar√© ce type avec la d√©claration directe (sans d√©clarer le type lui-m√™me) et ont √©crit une macro qui a cast√© des pointeurs vers des lignes en un √©clair vers le type __FlashStringHelper.  Juste pour que le compilateur s√©lectionne la fonction surcharg√©e n√©cessaire <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> __</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FlashStringHelper</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> F(string_literal) (reinterpret_cast</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;const __FlashStringHelper *&gt;(PSTR(string_literal)))</span></span></span></span></code> </pre><br>  Cela vous permet d'√©crire comme ceci: <br><br><pre> <code class="cpp hljs">display.print(F(‚ÄúString in flash memory‚Äù));</code> </pre> <br><br>  Mais ne vous laisse pas √©crire comme √ßa <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> text[] PROGMEM = <span class="hljs-string"><span class="hljs-string">"String in flash memory"</span></span>; display.print(F(text));</code> </pre> <br>  Et, apparemment, la biblioth√®que ne fournit rien de ce qui pourrait √™tre fait de cette fa√ßon.  Je sais qu'il n'est pas bon d'utiliser des √©l√©ments de biblioth√®que priv√©e dans mon code, mais que dois-je faire?  J'ai dessin√© ma macro, qui a fait ce dont j'avais besoin. <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> USE_PGM_STRING(x) reinterpret_cast</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;const __FlashStringHelper *&gt;(x)</span></span></span></span></code> </pre><br>  La fonction de dessin du chapeau a donc commenc√© √† ressembler √† ceci: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Screen::drawHeader() { display.setFont(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); display.setCursor(<span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); display.print(<span class="hljs-string"><span class="hljs-string">'\x1e'</span></span>); display.print(USE_PGM_STRING(getSelButtonText())); display.setCursor(<span class="hljs-number"><span class="hljs-number">80</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); display.print(<span class="hljs-string"><span class="hljs-string">'\x1e'</span></span>); display.print(USE_PGM_STRING(getOkButtonText())); }</code> </pre> <br>  Eh bien, depuis que je suis entr√© dans les √©l√©ments de bas niveau du firmware, j'ai d√©cid√© d'√©tudier plus en d√©tail comment tout cela fonctionne √† l'int√©rieur. <br><br>  En g√©n√©ral, les gars qui ont cr√©√© Arduino doivent √©riger un monument.  Ils ont cr√©√© une plate-forme simple et pratique pour le prototypage et l'artisanat.  Un grand nombre de personnes ayant une connaissance minimale de l'√©lectronique et de la programmation ont pu entrer dans le monde d'Arduino.  Mais tout cela est lisse et beau tout en faisant des ordures comme des oeill√®res avec des LED ou en lisant le thermom√®tre.  D√®s que vous vous penchez sur quelque chose de s√©rieux, vous devez imm√©diatement comprendre plus profond√©ment que vous ne le vouliez depuis le d√©but. <br><br>  Ainsi, apr√®s chaque biblioth√®que ou m√™me classe ajout√©e, j'ai not√© la vitesse √† laquelle la consommation de m√©moire augmente.  √Ä ce stade, j'√©tais occup√© avec plus de 14 Ko de 32 Ko de m√©moire flash et 1 300 octets de RAM (sur 2 Ko).  Chaque mouvement imprudent a ajout√© 10% de plus √† celui d√©j√† utilis√©.  Mais je n'ai toujours pas vraiment connect√© les biblioth√®ques GPS et SD / FAT32, et le chat lui-m√™me pleurait.  J'ai d√ª prendre le <s>v√©rificateur de</s> d√©sassembleur et √©tudier ce que le compilateur a fait. <br><br>  J'esp√©rais secr√®tement que l'√©diteur de liens supprimait les fonctions inutilis√©es.  Mais il s'est av√©r√© que certains d'entre eux √©taient ins√©r√©s presque enti√®rement.  Dans le firmware, j'ai trouv√© les fonctions de dessin au trait et quelques autres de la biblioth√®que de travailler avec l'√©cran, bien que dans le code, je ne les appelais √©videmment pas √† ce moment-l√†.  Implicitement, ils ne devraient pas √™tre appel√©s non plus - pourquoi ai-je besoin d'une fonction de dessin au trait si je ne dessine que des lettres √† partir de bitmaps?  Plus de 5,2 Ko √† l'improviste (et c'est sans compter les polices). <br><br>  En plus de la biblioth√®que de contr√¥le d'affichage, j'ai √©galement trouv√©: <br><br><ul><li>  2,6 ko - sur SoftwareSerial (je l'ai int√©gr√© dans le projet √† un moment donn√©) </li><li>  1,6 ko - I2C </li><li>  1,3 ko - HardwareSerial </li><li>  2 ko - TinyGPS </li><li>  2,5 ko sur l'arduino r√©el (initialisation, pins, toutes sortes de tableaux, le timer principal pour les fonctions millis () et delay ()), </li></ul><br>  Les chiffres sont tr√®s indicatifs, comme  l'optimiseur m√©lange s√©rieusement le code.  Certaines fonctions peuvent d√©marrer √† un endroit, puis une autre √† partir d'une autre biblioth√®que, appel√©e depuis la premi√®re, peut imm√©diatement la suivre.  De plus, des branches distinctes de ces fonctions peuvent √™tre situ√©es √† l'autre extr√©mit√© du flash. <br><br>  Aussi dans le code que j'ai trouv√©: <br><br><ul><li>  Contr√¥le d'√©cran par SPI (bien que je l'ai connect√© via I2C) </li><li>  M√©thodes de classes de base qui elles-m√™mes ne sont pas appel√©es, car  red√©fini dans les h√©ritiers </li><li>  Des destructeurs qui ne sont jamais appel√©s par conception </li><li>  Fonctions de dessin (et pas toutes - une partie des fonctions que l'√©diteur de liens lan√ßait toujours) </li><li>  malloc / free alors que dans mon code tous les objets sont essentiellement statiques </li></ul><br>  Mais non seulement la consommation de m√©moire flash, mais aussi la SRAM cro√Æt √† pas de g√©ant: <br><br><ul><li>  130 octets - I2C </li><li>  100 octets - SoftwareSerial </li><li>  157 octets - S√©rie </li><li>  558 octets - Affichage (dont 512 est le tampon de trame) </li></ul><br>  La section .data n'√©tait pas moins divertissante.  Il y a environ 700 octets et cette chose est charg√©e √† partir d'un flash dans la RAM au d√©but.  Il s'est av√©r√© qu'il existe des emplacements r√©serv√©s pour les variables en m√©moire, ainsi que les valeurs d'initialisation.  Ici vivent les variables et les constantes que vous avez oubli√© de d√©clarer comme const PROGMEM. <br><br>  Parmi cela, il y avait un tableau lourd avec un ¬´√©cran de d√©marrage¬ª de l'√©cran - les valeurs initiales du tampon de trame.  Th√©oriquement, si vous faites l'√©cran display () imm√©diatement apr√®s le d√©but, vous pouvez voir la fleur et l'inscription Adafruit, mais dans mon cas, il est inutile de d√©penser de la m√©moire flash √† ce sujet. <br><br>  La section .data contient √©galement des vtables.  Ils sont copi√©s en m√©moire √† partir d'un lecteur flash, apparemment pour des raisons d'efficacit√© lors de l'ex√©cution.  Mais vous devez sacrifier un assez gros morceau de RAM - plus d'une douzaine de classes plus de 150 octets.  De plus, il semble qu'il n'y ait pas de cl√© de compilation qui, sacrifiant les performances, laisse les tables virtuelles dans la m√©moire flash. <br><br>  Que faire √† ce sujet?  Je ne sais pas encore.  Cela d√©pendra de la fa√ßon dont la consommation continuera de cro√Ætre.  Pour de bons montants trouv√©s doivent √™tre r√©par√©s sans piti√©.  Selon toute vraisemblance, je devrai attirer toutes les biblioth√®ques dans mon projet de mani√®re explicite, puis les couvrir compl√®tement.  Et vous devrez peut-√™tre √©galement r√©√©crire certaines des pi√®ces diff√©remment afin d'optimiser la m√©moire.  Ou passez √† un mat√©riel plus puissant.  En tout cas, maintenant je connais le probl√®me et il existe une strat√©gie pour le r√©soudre. <br><br>  <b>MISE √Ä JOUR:</b> <br>  Peu de progr√®s dans l'utilisation efficace des ressources.  Je fais une mise √† jour de cette partie, car  dans le prochain je veux me concentrer sur des choses compl√®tement diff√©rentes. <br><br>  Dans les commentaires, il y a une certaine confusion quant √† l'utilisation de C ++.  En particulier, pourquoi est-il si mauvais et conserve-t-il sa table dans une pr√©cieuse RAM?  En g√©n√©ral, les fonctions, constructeurs et destructeurs virtuels sont des frais g√©n√©raux.  Pourquoi?  Voyons √ßa! <br><br>  Voici des statistiques sur la m√©moire √† une √©tape du projet <br>  Taille du programme: 15 458 octets (utilis√© 50% d'un maximum de 30 720 octets) (2,45 secondes) <br>  Utilisation minimale de la m√©moire: 1258 octets (61% d'un maximum de 2048 octets) <br><br>  Exp√©rience n ¬∞ 1 - r√©√©criture en C. <br><br>  J'ai organis√© des cours, tout r√©√©crit sur des tables avec des pointeurs vers des fonctions.         ,        . <br><br>    <br> Program size: 14 568 bytes (used 47% of a 30 720 byte maximum) (2,35 secs) <br> Minimum Memory Usage: 1176 bytes (57% of a 2048 byte maximum) <br><br> .  900    80  .       . 80       vtable'.    ( )    . <br><br>  ,      ‚Äî      ,      .    ‚Äú‚Äù  .       . <br><br>       ,   ,     .        .       ¬´ ¬ª,       .     . <br><br>  ‚Ññ2 ‚Äî    ++ <br><br>     ,    .          .      .         new/delete. <br><br> Program size: 15 408 bytes (used 50% of a 30 720 byte maximum) (2,60 secs) <br> Minimum Memory Usage: 1273 bytes (62% of a 2048 byte maximum) <br><br>    .  ,   ,  .             .  C'est-√†-dire      ,      .      . <br><br>        .       ,      .  C'est-√†-dire     ‚Äú‚Äù         .        ,    ,      . <br><br>            ,        .    ,        vtable.     : <br><br> Program size: 14 704 bytes (used 48% of a 30 720 byte maximum) (2,94 secs) <br> Minimum Memory Usage: 1211 bytes (59% of a 2048 byte maximum) <br><br>   vtable'     ,    2.     .     (    ),     free,      (-12  ).        (8 )   ,      (Screen, ParentScreen ‚Äî 40 ) <br><br>     ‚Äî  700 .     ,    malloc/free/new/delete. 700     ! 700 , ! <br><br>     -,       <br><br><div class="scrollable-table"><table><tbody><tr><th></th><th>  </th><th>  C </th><th>  C ++ </th></tr><tr><td> Flash </td><td> 15 458 </td><td> 14 568 </td><td> 14 704 </td></tr><tr><td> RAM </td><td> 1258 </td><td> 1176 </td><td> 1211 </td></tr></tbody></table></div><br><br> :   ++        .    ,     .        .         ,  ,       ++? <br><br><h1>  Postface </h1><br>           .          ,      .         .        :      ,  ,   . <br><br>            ‚Äî   GPS.       ,     . <br><br>   10      . ,              ATMega32.      ,             .           ‚Äî ATMega64      STM32. <br><br>     -   .       ‚Äî      .      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">  </a> . <br><br>   . <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> </a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr401899/">https://habr.com/ru/post/fr401899/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr401889/index.html">Amplificateurs l√©gendaires des ann√©es 80-90: paradoxes Lamm, monstre de Johnson, tueur int√©gral de "lampes chaudes"</a></li>
<li><a href="../fr401891/index.html">Num√©risation 3D et impression 3D en action (d√©di√©es aux motards)</a></li>
<li><a href="../fr401893/index.html">D'o√π proviennent l'eau et l'oxyg√®ne sur l'ISS?</a></li>
<li><a href="../fr401895/index.html">Les attaquants deviennent plus inventifs pour cr√©er des skimmers</a></li>
<li><a href="../fr401897/index.html">Pack de nouvelles pour SLS et Orion</a></li>
<li><a href="../fr401901/index.html">Fen√™tre au clair de lune sur l'Univers</a></li>
<li><a href="../fr401903/index.html">Comment les sons affectent notre sommeil et notre productivit√©</a></li>
<li><a href="../fr401905/index.html">Apple Power Mac G4 Cube et ses contemporains dans une petite revue de photo</a></li>
<li><a href="../fr401907/index.html">Les voitures robotis√©es doivent apprendre √† comprendre les gens.</a></li>
<li><a href="../fr401909/index.html">Syst√®me de s√©curit√© fait maison bas√© sur des produits pour une maison intelligente de Nootekhnika</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>