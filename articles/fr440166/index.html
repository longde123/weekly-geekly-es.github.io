<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üçí ü§∂ üíπ Compression du pointeur Java üï† üõèÔ∏è üë©üèæ‚Äçüé®</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="L'article se concentrera sur l'impl√©mentation de la compression du pointeur dans la machine virtuelle Java 64 bits , qui est contr√¥l√©e par l'option Us...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Compression du pointeur Java</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/440166/"><img src="https://habrastorage.org/webt/co/jr/rf/cojrrf-lekmifni81uch0imua1m.png"><br><p>  L'article se concentrera sur l'impl√©mentation de la compression du pointeur dans la <strong>machine virtuelle Java 64 bits</strong> , qui est contr√¥l√©e par l'option <strong>UseCompressedOops</strong> et est activ√©e par d√©faut pour les syst√®mes 64 bits commen√ßant par Java SE 6u23. </p><a name="habracut"></a><br><h1>  Description du probl√®me </h1><br><p>  Dans une machine virtuelle Java 64 bits, les pointeurs prennent 2 fois plus d'espace m√©moire (surprise-surprise) que dans une m√©moire 32 bits.  Cela peut augmenter la taille des donn√©es de 1,5 fois par rapport au m√™me code pour l'architecture 32 bits.  Dans le m√™me temps, dans une architecture 32 bits, seuls 2 ^ 32 octets (4 Go) peuvent √™tre adress√©s, ce qui est assez petit dans le monde moderne. </p><br><p>  √âcrivons un petit programme et regardons combien d'octets les objets entiers occupent: </p><br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.stream.IntStream; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.stream.Stream; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HeapTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String ... args)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ Integer[] x = IntStream.range(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1_000_000</span></span>).boxed().toArray(Integer[]::<span class="hljs-keyword"><span class="hljs-keyword">new</span></span>); Thread.sleep(<span class="hljs-number"><span class="hljs-number">6000000</span></span>); Stream.of(x).forEach(System.out::println); } }</code> </pre> <br><p>  Ici, nous mettons en √©vidence un million d'objets de la classe Integer et nous endormons pendant longtemps.  La derni√®re ligne est n√©cessaire pour que le compilateur n'ignore pas soudainement la cr√©ation du tableau (bien que sur ma machine, les objets soient cr√©√©s normalement sans cette ligne). </p><br><p>  Nous compilons et ex√©cutons le programme avec la compression de pointeur d√©sactiv√©e: </p><br><pre> <code class="plaintext hljs">&gt; javac HeapTest.java &gt; java -XX:-UseCompressedOops HeapTest</code> </pre> <br><p>  En utilisant l'utilitaire <strong>jcmd</strong> , <strong>nous</strong> regardons l'allocation de m√©moire: </p><br><pre> <code class="plaintext hljs">&gt; jps 45236 HeapTest ... &gt; jcmd 45236 GC.class_histogram</code> </pre> <br><img src="https://habrastorage.org/webt/he/yd/y7/heydy7fyiamklkvz2ff9umu7fak.png"><br><p><br>  L'image montre que le nombre total d'objets est de <strong>1000128</strong> et que la taille de la m√©moire <strong>occup√©e par</strong> ces objets <strong>est de 24003072 octets</strong> .  C'est-√†-dire  <strong>24</strong> octets par objet (pourquoi exactement 24 seront √©crits ci-dessous). </p><br><p>  Et voici la m√©moire du m√™me programme, mais avec le drapeau <strong>UseCompressedOops activ√©</strong> : </p><br><img src="https://habrastorage.org/webt/su/dj/5g/sudj5gdfm0i-apwneqfbskmgqc8.png"><br><p><br>  D√©sormais, chaque objet occupe <strong>16 octets</strong> . <br>  Les avantages de la compression sont √©vidents =) </p><br><h1>  Solution </h1><br><p>  Comment la JVM compresse-t-elle les pointeurs?  Cette technique est appel√©e <strong>Oups compress√©s</strong> .  Oop signifie <em>pointeur d'objet ordinaire</em> ou <em>pointeur d'objet ordinaire</em> . </p><br><p>  L'astuce est que dans un syst√®me 64 bits, les donn√©es en m√©moire sont align√©es avec le mot machine, c'est-√†-dire  8 octets chacun.  Et l'adresse a toujours trois bits z√©ro √† la fin. </p><br><p>  Si vous enregistrez le pointeur en d√©calant l'adresse de 3 bits vers la droite (l'op√©ration est appel√©e <strong>encoder</strong> ), et avant d'utiliser, d√©caler de 3 bits vers la gauche (respectivement, <strong>d√©coder</strong> ), vous pouvez adapter des pointeurs 32 bits d'une taille de <strong>35 bits</strong> , c'est-√†-dire  Adresse jusqu'√† <strong>32 Go</strong> (2 ^ 35 octets). </p><br><p>  Si la taille du segment de m√©moire de votre programme d√©passe 32 Go, la compression cesse de fonctionner et tous les pointeurs deviennent 8 octets. </p><br><p>  Lorsque l'option <strong>UseCompressedOops est</strong> activ√©e, les types de pointeurs suivants sont compress√©s: </p><br><ul><li>  Champ de classe pour chaque objet </li><li>  Objets de champ de classe </li><li>  √âl√©ments d'un tableau d'objets. </li></ul><br><p>  Les objets de la JVM elle-m√™me ne sont jamais compress√©s.  Dans ce cas, la compression se produit au niveau de la machine virtuelle, et non au bytecode. </p><br><h1>  En savoir plus sur la mise en m√©moire d'objets </h1><br><p>  Maintenant, utilisons l'utilitaire <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">jol (Java Object Layout) pour</a> voir de plus pr√®s combien de m√©moire notre Integer prend dans diff√©rentes JVM: </p><br><pre> <code class="plaintext hljs">&gt; java -jar jol-cli-0.9-full.jar estimates java.lang.Integer ***** 32-bit VM: ********************************************************** java.lang.Integer object internals: OFFSET SIZE TYPE DESCRIPTION VALUE 0 8 (object header) N/A 8 4 int Integer.value N/A 12 4 (loss due to the next object alignment) Instance size: 16 bytes Space losses: 0 bytes internal + 4 bytes external = 4 bytes total ***** 64-bit VM: ********************************************************** java.lang.Integer object internals: OFFSET SIZE TYPE DESCRIPTION VALUE 0 16 (object header) N/A 16 4 int Integer.value N/A 20 4 (loss due to the next object alignment) Instance size: 24 bytes Space losses: 0 bytes internal + 4 bytes external = 4 bytes total ***** 64-bit VM, compressed references enabled: *************************** java.lang.Integer object internals: OFFSET SIZE TYPE DESCRIPTION VALUE 0 12 (object header) N/A 12 4 int Integer.value N/A Instance size: 16 bytes Space losses: 0 bytes internal + 0 bytes external = 0 bytes total ***** 64-bit VM, compressed references enabled, 16-byte align: ************ java.lang.Integer object internals: OFFSET SIZE TYPE DESCRIPTION VALUE 0 12 (object header) N/A 12 4 int Integer.value N/A Instance size: 16 bytes Space losses: 0 bytes internal + 0 bytes external = 0 bytes total</code> </pre><br><p>  La diff√©rence entre ¬´VM 64 bits¬ª et ¬´VM 64 bits, r√©f√©rences compress√©es activ√©es¬ª est de r√©duire l'en- <strong>t√™te d'objet</strong> de 4 octets.  De plus, dans le cas sans compression, il devient n√©cessaire d'ajouter 4 octets suppl√©mentaires pour <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">aligner les donn√©es</a> en m√©moire. </p><br><p>  Qu'est-ce que cet en-t√™te d'objet?  Pourquoi at-il diminu√© de 4 octets? </p><br><img src="https://habrastorage.org/web/e2d/a4b/301/e2da4b30184a495c8e02dd1912539409.png"><br><p>  L'image montre un en-t√™te d'objet de 12 octets, c'est-√†-dire  avec l'option UseCompressedOops activ√©e.  L'en-t√™te se compose de quelques indicateurs JVM internes, ainsi que d'un pointeur vers la classe de cet objet.  On peut voir que le pointeur vers la classe prend 32 bits.  Sans compression, il occuperait 64 bits et la taille de l'en-t√™te d'objet serait d√©j√† de 16 octets. </p><br><p>  Au fait, vous pouvez voir qu'il existe une autre option pour l'alignement sur 16 octets.  Dans ce cas, vous pouvez augmenter la m√©moire jusqu'√† 64 Go. </p><br><h1>  Contre Compression des pointeurs </h1><br><p>  La compression des pointeurs, bien s√ªr, a un inconv√©nient √©vident - le co√ªt des op√©rations de <strong>codage</strong> et de <strong>d√©codage</strong> chaque fois que le pointeur est acc√©d√©.  Les nombres exacts varieront selon l'application. </p><br><p>  Par exemple, voici un graphique des pauses du ramasse-miettes pour les pointeurs compress√©s et non compress√©s, tir√©es d'ici <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Java GC en chiffres - POO compress√©s</a> </p><br><img src="https://habrastorage.org/webt/gp/ki/2k/gpki2k7rbztm2xpycy_26nzt-1e.png"><br><p>  On peut voir qu'avec la compression activ√©e, les pauses GC durent plus longtemps.  Vous pouvez en savoir plus √† ce sujet dans l'article lui-m√™me (l'article est assez ancien - 2013). </p><br><p>  R√©f√©rences: </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Oups compress√©s dans la JVM Hotspot</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Comment JVM alloue-t-il les objets</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">CompressedOops: Introduction aux r√©f√©rences compress√©es en Java</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Astuce derri√®re les Oops compress√©s de JVM</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Am√©liorations des performances des machines virtuelles Java HotSpot</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr440166/">https://habr.com/ru/post/fr440166/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr440154/index.html">Comment Spore a √©t√© cr√©√©: entretiens avec les d√©veloppeurs</a></li>
<li><a href="../fr440156/index.html">Comment organiser le d√©veloppement distribu√©, si cela n'est pas possible</a></li>
<li><a href="../fr440158/index.html">Statistiques de ventes de v√©hicules √©lectriques et hybrides rechargeables en 2018 (aux √âtats-Unis et dans le monde)</a></li>
<li><a href="../fr440162/index.html">Un exemple de r√©seau neuronal simple en C / C ++</a></li>
<li><a href="../fr440164/index.html">La mon√©tisation des donn√©es des utilisateurs deviendra-t-elle une tendance en 2019?</a></li>
<li><a href="../fr440168/index.html">Reportages vid√©o de FunTech ML-meetup</a></li>
<li><a href="../fr440170/index.html">Analyse des incidents li√©s aux cyberattaques sur les projets de blockchain</a></li>
<li><a href="../fr440172/index.html">CQRS: le principe du ¬´diviser pour mieux r√©gner¬ª au service d'un programmeur</a></li>
<li><a href="../fr440174/index.html">Concours de codage Microsoft Q # - Hiver 2019</a></li>
<li><a href="../fr440176/index.html">Sept tendances de cybers√©curit√© pour 2019</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>