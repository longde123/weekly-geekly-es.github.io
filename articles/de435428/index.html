<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôÄ ‚õµÔ∏è üòû Fernsteuerung des Fceux-Emulators mit Python üê® üë∞üèΩ üõë</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In diesem Artikel werde ich beschreiben, wie der NES-Emulator ferngesteuert und ein Server zum Senden von Befehlen an ihn ferngesteuert wird. 



 War...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Fernsteuerung des Fceux-Emulators mit Python</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/435428/">  In diesem Artikel werde ich beschreiben, wie der NES-Emulator ferngesteuert und ein Server zum Senden von Befehlen an ihn ferngesteuert wird. <br><br><img src="https://habrastorage.org/webt/fb/4n/te/fb4ntevb-6j5knunjyr3jq0wec0.png"><br><br><h2>  Warum wird das ben√∂tigt? </h2><br>  Mit einigen Emulatoren verschiedener Spielekonsolen, einschlie√ülich <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Fceux</a> , k√∂nnen Sie benutzerdefinierte Skripte auf Lua schreiben und ausf√ºhren.  Aber Lua ist eine schlechte Sprache, um ernsthafte Programme zu schreiben.  Es ist eher eine Sprache zum Aufrufen von Funktionen, die in C geschrieben sind.  Die Autoren von Emulatoren verwenden es nur wegen der Leichtigkeit und einfachen Einbettung.  Eine genaue Emulation erfordert viele Prozessorressourcen, und die fr√ºhere Emulationsgeschwindigkeit war eines der Hauptziele der Autoren, und wenn sie sich an die M√∂glichkeit von Skriptaktionen erinnerten, war dies nicht an erster Stelle. <br><br>  Jetzt reicht die Leistung eines durchschnittlichen Prozessors f√ºr die Emulation von NES aus. Warum nicht leistungsstarke Skriptsprachen wie Python oder JavaScript in Emulatoren verwenden? <br><br>  Leider kann keiner der beliebten NES-Emulatoren diese oder andere Sprachen verwenden.  Ich habe nur ein wenig bekanntes <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Nintaco-</a> Projekt gefunden, das ebenfalls auf dem Fceux-Kernel basiert und aus irgendeinem Grund in Java neu geschrieben wurde.  Dann habe ich beschlossen, die M√∂glichkeit hinzuzuf√ºgen, Skripte in Python zu schreiben, um den Emulator selbst zu steuern. <br><br>  Mein Ergebnis ist der Proof-of-Concept der F√§higkeit, den Emulator zu steuern. Er gibt nicht vor, schnell oder zuverl√§ssig zu sein, aber er funktioniert.  Ich habe es selbst gemacht, aber da die Frage, wie der Emulator mithilfe von Skripten gesteuert werden kann, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">h√§ufig</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">genug ist</a> , habe ich den Quellcode auf den <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Github gestellt</a> . <br><a name="habracut"></a><br><h2>  Wie funktioniert es? </h2><br><h3>  Auf der Seite des Emulators </h3><br>  Der Fceux-Emulator enth√§lt <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">bereits</a> mehrere Lua-Bibliotheken <a href="">in Form von kompiliertem Code</a> .  Einer von ihnen ist <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">LuaSocket</a> .  Es ist schlecht dokumentiert, aber ich habe es geschafft, ein Beispiel <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">f√ºr</a> <i><b>Arbeitscode in</b></i> der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Sammlung von</a> <i><b>Xkeeper0-</b></i> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Skripten zu finden</a> .  Er benutzte Sockel, um den Emulator √ºber Mirc zu steuern.  Der Code, der den TCP-Socket √∂ffnet, lautet: <br><br><pre><code class="lua hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">connect</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(address, port, laddress, lport)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> sock, err = socket.tcp() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> sock <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, err <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> laddress <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> res, err = sock:bind(laddress, lport, <span class="hljs-number"><span class="hljs-number">-1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> res <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, err <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> res, err = sock:connect(address, port) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> res <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, err <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sock <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> sock2, err2 = connect(<span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>, <span class="hljs-number"><span class="hljs-number">81</span></span>) sock2:settimeout(<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-comment"><span class="hljs-comment">--it's our socket object print("Connected", sock2, err2)</span></span></code> </pre> <br>  Dies ist ein Low-Level-Socket, der Daten mit 1 Byte empf√§ngt und sendet. <br><br>  Im Fceux-Emulator sieht die Hauptschleife des Lua-Skripts folgenderma√üen aus: <br><br><pre> <code class="lua hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-comment"><span class="hljs-comment">--  passiveUpdate() --,        emu.frameadvance() --       end end</span></span></code> </pre><br>  Eine √úberpr√ºfung der Daten aus dem Socket: <br><br><pre> <code class="lua hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">passiveUpdate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> message, err, part = sock2:receive(<span class="hljs-string"><span class="hljs-string">"*all"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> message <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> message = part <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> message <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">len</span></span>(message)&gt;<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-comment"><span class="hljs-comment">--print(message) local recCommand = json.decode(message) table.insert(commandsQueue, recCommand) coroutine.resume(parseCommandCoroutine) end end</span></span></code> </pre><br>  Der Code ist recht einfach: Daten werden aus dem Socket gelesen, und wenn der n√§chste Befehl erkannt wird, werden sie analysiert und ausgef√ºhrt.  Das Parsen und Ausf√ºhren wird mithilfe von <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Coroutine</a> (Coroutinen) organisiert - dies ist ein leistungsstarkes Konzept der Lua-Sprache zum Anhalten und Fortsetzen der Codeausf√ºhrung. <br><br>  Und noch etwas Wichtiges an Lua-Skripten in Fceux - die Emulation kann vor√ºbergehend aus dem Skript gestoppt werden.  Wie organisiere ich die fortgesetzte Ausf√ºhrung von Lua-Code und f√ºhre ihn mit einem vom Socket empfangenen Befehl erneut aus?  Dies w√§re nicht m√∂glich, aber es gibt eine schlecht dokumentierte M√∂glichkeit, Lua-Code aufzurufen, selbst wenn die Emulation gestoppt ist (danke <b><i>feos</i></b> f√ºr das <b><i>Zeigen</i></b> darauf): <br><br><pre> <code class="lua hljs">gui.register(passiveUpdate) <span class="hljs-comment"><span class="hljs-comment">--undocumented. this function will call even if emulator paused</span></span></code> </pre><br>  Mit dieser Funktion k√∂nnen Sie die Emulation in <b>passiveUpdate</b> stoppen und fortsetzen. <b>Auf</b> diese Weise k√∂nnen Sie die Installation von Haltepunkten des Emulators √ºber einen Socket organisieren. <br><br><h3>  Serverseitiger Befehl </h3><br>  Ich verwende ein sehr einfaches JSON-basiertes RPC-Textprotokoll.  Der Server serialisiert den Funktionsnamen und die Argumente in eine JSON-Zeichenfolge und sendet sie √ºber den Socket.  Ferner wird die Ausf√ºhrung des Codes gestoppt, bis der Emulator mit einer Zeile antwortet, um den Befehl abzuschlie√üen.  Die Antwort enth√§lt die Felder " <b>FUNCTIONNAME_finished</b> " und das Ergebnis der Funktion. <br><br>  Die Idee ist in der <b>syncCall-</b> Klasse implementiert: <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">syncCall</span></span></span><span class="hljs-class">:</span></span> @classmethod <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">waitUntil</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cls, messageName)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""cycle for reading data from socket until needed message was read from it. All other messages will added in message queue"""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: cmd = messages.parseMessages(asyncCall.waitAnswer(), [messageName]) <span class="hljs-comment"><span class="hljs-comment">#print(cmd) if cmd != None: if len(cmd)&gt;1: return cmd[1] return @classmethod def call(cls, *params): """wrapper for sending [functionName, [param1, param2, ...]] to socket and wait until client return [functionName_finished, [result1,...]] answer""" sender.send(*params) funcName = params[0] return syncCall.waitUntil(funcName + "_finished")</span></span></code> </pre><br>  Mit dieser Klasse k√∂nnen Fceux-Emulator-Lua-Methoden in Python-Klassen eingeschlossen werden: <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">emu</span></span></span><span class="hljs-class">:</span></span> @classmethod <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">poweron</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cls)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> syncCall.call(<span class="hljs-string"><span class="hljs-string">"emu.poweron"</span></span>) @classmethod <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pause</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cls)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> syncCall.call(<span class="hljs-string"><span class="hljs-string">"emu.pause"</span></span>) @classmethod <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">unpause</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cls)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> syncCall.call(<span class="hljs-string"><span class="hljs-string">"emu.unpause"</span></span>) @classmethod <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">message</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cls, str)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> syncCall.call(<span class="hljs-string"><span class="hljs-string">"emu.message"</span></span>, str) @classmethod <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">softreset</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cls)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> syncCall.call(<span class="hljs-string"><span class="hljs-string">"emu.softreset"</span></span>) @classmethod <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">speedmode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cls, str)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> syncCall.call(<span class="hljs-string"><span class="hljs-string">"emu.speedmode"</span></span>, str)</code> </pre><br>  Und dann w√∂rtlich genannt wie von Lua: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># : emu.poweron()</span></span></code> </pre><br><h3>  R√ºckrufmethoden </h3><br>  In Lua k√∂nnen Sie R√ºckrufe registrieren - Funktionen, die aufgerufen werden, wenn eine bestimmte Bedingung erf√ºllt ist.  Wir k√∂nnen dieses Verhalten mit dem folgenden Trick auf den Server in Python portieren.  Zuerst speichern wir die Kennung der in Python geschriebenen R√ºckruffunktion und √ºbergeben sie an den Lua-Code: <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">callbacks</span></span></span><span class="hljs-class">:</span></span> functions = {} callbackList = [ <span class="hljs-string"><span class="hljs-string">"emu.registerbefore_callback"</span></span>, <span class="hljs-string"><span class="hljs-string">"emu.registerafter_callback"</span></span>, <span class="hljs-string"><span class="hljs-string">"memory.registerexecute_callback"</span></span>, <span class="hljs-string"><span class="hljs-string">"memory.registerwrite_callback"</span></span>, ] @classmethod <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">registerfunction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cls, func)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> func == <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> hfunc = hash(func) callbacks.functions[hfunc] = func <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> hfunc @classmethod <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">error</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cls, e)</span></span></span><span class="hljs-function">:</span></span> emu.message(<span class="hljs-string"><span class="hljs-string">"Python error: "</span></span> + str(e)) @classmethod <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkAllCallbacks</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cls, cmd)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment">#print("check:", cmd) for callbackName in callbacks.callbackList: if cmd[0] == callbackName: hfunc = cmd[1] #print("hfunc:", hfunc) func = callbacks.functions.get(hfunc) #print("func:", func) if func: try: func(*cmd[2:]) #skip function name and function hash and save others arguments except Exception as e: callbacks.error(e) pass #</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment"> thread locking sender.send(callbackName + "_finished")</span></span></code> </pre><br>  Lua-Code speichert auch diese Kennung und registriert einen regul√§ren Lua-R√ºckruf, der die Kontrolle auf Python-Code √ºbertr√§gt.  Als N√§chstes wird im Python-Code ein separater Thread erstellt, der nur √ºberpr√ºft, ob der R√ºckrufbefehl von Lua nicht akzeptiert wurde: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">callbacksThread</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> cycle = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: cycle += <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: cmd = messages.parseMessages(asyncCall.waitAnswer(), callbacks.callbackList) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> cmd: <span class="hljs-comment"><span class="hljs-comment">#print("Callback received:", cmd) callbacks.checkAllCallbacks(cmd) pass except socket.timeout: pass time.sleep(0.001)</span></span></code> </pre><br>  Der letzte Schritt besteht darin, dass nach Ausf√ºhrung des Python-R√ºckrufs die Steuerung mit dem <b>Befehl</b> " <b>CALLBACKNAME_finished</b> " an Lua zur√ºckgegeben wird, um den Emulator dar√ºber zu informieren, dass der R√ºckruf beendet ist. <br><br><h2>  So f√ºhren Sie ein Beispiel aus </h2><br><ul><li>  Auf dem System muss <b>Python 3</b> und <b>Jupyter Notebook</b> ausgef√ºhrt sein.  Sie m√ºssen Jupyter mit dem Befehl ausf√ºhren <br><br><pre> <code class="plaintext hljs">jupyter notebook</code> </pre><br></li><li>  √ñffnen Sie den Laptop <b>FceuxPythonServer.py.ipynb</b> und f√ºhren Sie die erste Zeile aus <br><img src="https://habrastorage.org/webt/ns/7k/_i/ns7k_i60y_7kscct2pmyqz1_fi8.png"><br></li><li>  Jetzt m√ºssen Sie den Fceux-Emulator ausf√ºhren, die darin enthaltene ROM-Datei √∂ffnen (ich verwende das Spiel <b>Castlevania (U) (PRG0) [!]. Nes</b> in meinem Beispiel) und das Lua-Skript mit dem Namen <i>fceux_listener.lua ausf√ºhren</i> .  Es sollte eine Verbindung zu einem Server herstellen, der auf einem Jupyter-Laptop ausgef√ºhrt wird. <br><br>  Diese Aktionen k√∂nnen √ºber die Befehlszeile ausgef√ºhrt werden: <br><br><pre> <code class="plaintext hljs">fceux.exe -lua fceux_listener.lua "Castlevania (U) (PRG0) [!].nes"</code> </pre><br></li><li>  Wechseln Sie nun zur√ºck zum Jupyter Notebook.  Sie sollten eine Meldung √ºber eine erfolgreiche Verbindung zum Emulator sehen: <br><br><img src="https://habrastorage.org/webt/41/on/es/41onesw9o66jmtyfexid7wpipbq.png"><br></li></ul><br>  Das ist alles, Sie k√∂nnen Befehle vom Jupyter-Laptop im Browser direkt an den Fceux-Emulator senden. <br><br>  Sie k√∂nnen alle Zeilen des Beispiel-Laptops nacheinander ausf√ºhren und das Ergebnis der Ausf√ºhrung im Emulator beobachten. <br><br>  Vollst√§ndiges Beispiel: <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">https://github.com/spiiin/fceux_luaserver/blob/master/FceuxPythonServer.py.ipynb</a> <br><br>  Es enth√§lt einfache Funktionen wie das Lesen des Speichers: <br><br><img src="https://habrastorage.org/webt/sg/ut/du/sgutduhqvx6wqzgczn9seozyl08.png"><br><br>  Komplexere R√ºckrufbeispiele: <br><br><img src="https://habrastorage.org/webt/ul/qq/1q/ulqq1qufdcbol1zbw_6za2mtfdi.png"><br><br>  Und ein Skript f√ºr ein bestimmtes Spiel, mit dem Sie Feinde von <b>Super Mario Bros.</b> bewegen k√∂nnen <b>.</b>  mit der Maus: <br><br><img src="https://habrastorage.org/webt/ie/iw/fa/ieiwfa__-dg4sck64cmekmbcy7y.png"><br><br>  Laptop Run Video: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/c3D5gljbkO0" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><h3>  Einschr√§nkungen und Anwendungen </h3><br>  Das Skript hat keinen Schutz vor Narren und ist nicht f√ºr die Ausf√ºhrungsgeschwindigkeit optimiert. Es ist besser, ein bin√§res RPC-Protokoll anstelle eines Textprotokolls und von Gruppennachrichten zu verwenden, aber meine Implementierung erfordert keine Kompilierung.  Das Skript kann auf meinem Laptop 500-1000 Mal pro Sekunde Ausf√ºhrungskontexte von Lua zu Python und zur√ºck wechseln.  Dies ist f√ºr fast jede Anwendung ausreichend, au√üer f√ºr bestimmte F√§lle des pixelweisen oder zeilenweisen Debuggens des Videoprozessors. Fceux l√§sst solche Vorg√§nge von Lua jedoch immer noch nicht zu, sodass dies keine Rolle spielt. <br><br>  M√∂gliche Anwendungsideen: <br><br><ul><li>  Als Beispiel f√ºr die Implementierung einer solchen Steuerung f√ºr andere Emulatoren und Sprachen </li><li>  Spielforschung </li><li>  Hinzuf√ºgen von Cheats oder Funktionen zum Organisieren von TAS-Passagen </li><li>  F√ºgen Sie Daten und Code in Spiele ein oder extrahieren Sie sie </li><li>  Verbesserung der Funktionen von Emulatoren - Schreiben von Debuggern, Skripten zum Aufzeichnen und Anzeigen von exemplarischen Vorgehensweisen, Skriptbibliotheken und Spieleditoren </li><li>  Netzwerkspiel, Spielsteuerung √ºber mobile Ger√§te, Remote-Dienste, Joypads oder andere Steuerger√§te, Speichern und Patches in Cloud-Diensten </li><li>  Emulator√ºbergreifende Funktionen </li><li>  Verwendung von Python oder anderen Sprachbibliotheken zur Datenanalyse und Spielsteuerung (Erstellen von Bots) </li></ul><br><h3>  Technologie-Stack </h3><br>  Ich habe verwendet: <br><br>  <b>Fceux</b> - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">www.fceux.com/web/home.html</a> <br>  Dies ist ein klassischer NES-Emulator, den die meisten Leute verwenden.  Es wurde lange Zeit nicht aktualisiert und bietet nicht die besten Funktionen, bleibt jedoch der Standardemulator f√ºr viele Romhacker.  Ich habe mich auch daf√ºr entschieden, weil die Lua-Sockelunterst√ºtzung integriert ist und es nicht erforderlich ist, sie selbst anzuschlie√üen. <br><br>  <b>Json.lua</b> - <a href="">github.com/spiiin/json.lua</a> <br>  Dies ist eine JSON-Implementierung in reinem Lua.  Ich habe es gew√§hlt, weil ich ein Beispiel erstellen wollte, f√ºr das keine Codekompilierung erforderlich ist.  Aber ich musste die Bibliothek immer noch teilen, da einige der in Fceux integrierten Bibliotheken die Bibliotheksfunktion <i><b>√ºberlasteten</b></i> und die Serialisierung brachen (meine abgelehnte <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Pool-Anfrage</a> an den Autor der urspr√ºnglichen Bibliothek). <br><br>  <b>Python 3</b> - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">www.python.org</a> <br>  Der Fceux Lua-Server √∂ffnet den TCP-Socket und wartet auf die von ihm empfangenen Befehle.  Ein Server, der Befehle an den Emulator sendet, kann in einer beliebigen Sprache implementiert werden.  Ich habe Python wegen seiner Philosophie ‚ÄûBatterie enthalten‚Äú ausgew√§hlt - die meisten Module sind in der Standardbibliothek enthalten (einschlie√ülich der Arbeit mit Sockets und JSON).  Python kennt auch die Bibliothek f√ºr die Arbeit mit neuronalen Netzen, und ich m√∂chte versuchen, sie zum Erstellen von Bots in NES-Spielen zu verwenden. <br><br>  <b>Jupyter Notebook</b> - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">jupyter.org</a> <br>  Jupyter Notebook ist eine sehr coole Umgebung f√ºr die interaktive Ausf√ºhrung von Python-Code.  Damit k√∂nnen Sie Befehle in einem Tabellenkalkulationseditor im Browser schreiben und ausf√ºhren.  Es ist auch gut, um vorzeigbare Beispiele zu erstellen. <br><br>  <b>Dexpot</b> - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">www.dexpot.de</a> <br>  Ich habe diesen virtuellen Desktop-Manager verwendet, um das Emulatorfenster √ºber andere zu andocken.  Dies ist sehr praktisch, wenn Sie den Server im Vollbildmodus bereitstellen, um √Ñnderungen im Emulatorfenster sofort zu verfolgen.  Mit nativen Windows-Tools k√∂nnen Sie das Andocken von Fenstern nicht √ºber anderen organisieren. <br><br><h2>  Referenzen </h2><br>  Eigentlich <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">das Projekt-Repository</a> . <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Nintaco</a> - Java NES Emulator mit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Fernverwaltung</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Xkeeper0 Emu-Lua-Sammlung</a> - eine Sammlung verschiedener Lua-Skripte <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Mesen</a> ist ein moderner NES-Emulator in C # mit leistungsstarken Lua-Skriptfunktionen.  Bisher ohne Sockelunterst√ºtzung und Fernbedienung. <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">CadEditor</a> ist mein Projekt eines universellen Level-Editors f√ºr NES und andere Plattformen sowie leistungsstarker Tools f√ºr die Erforschung von Spielen.  Ich benutze das im Beitrag beschriebene Skript und den Server, um die Spiele zu erkunden und sie dem Editor hinzuzuf√ºgen. <br><br>  Ich w√ºrde mich √ºber Feedback, Tests und Versuche freuen, das Skript zu verwenden. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de435428/">https://habr.com/ru/post/de435428/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de435418/index.html">Verwenden von SQLite in Flutter</a></li>
<li><a href="../de435420/index.html">Die Zukunft der Verbrechensbek√§mpfung ist das Studium der Stammb√§ume</a></li>
<li><a href="../de435422/index.html">Wie erfahrene Leute im Silicon Valley</a></li>
<li><a href="../de435424/index.html">Parse & Android: Empfehlungen f√ºr Anf√§nger</a></li>
<li><a href="../de435426/index.html">So funktioniert Microsoft Excel mit Zeilenh√∂hen</a></li>
<li><a href="../de435430/index.html">Die coolsten Nachrichten CES 2019</a></li>
<li><a href="../de435432/index.html">Neues Jahr, neuer GitHub: Unbegrenzte kostenlose private Repositories</a></li>
<li><a href="../de435436/index.html">5 Trends in der IT-Infrastruktur: Prognose f√ºr 2019</a></li>
<li><a href="../de435438/index.html">PHP: √Ñnderung der Datenbankstruktur in der Teamentwicklung</a></li>
<li><a href="../de435442/index.html">Trichter der Ver√§nderung</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>