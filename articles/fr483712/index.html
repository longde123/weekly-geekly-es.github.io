<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏍️ 🚆 🎿 HighLoad ++, Yuri Nasretdinov (VK): comment VK insère des données dans ClickHouse à partir de dizaines de milliers de serveurs 🍿 🏉 🤚🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="HighLoad ++ Moscou 2018, salle des congrès. 9 novembre, 15h00 

 Résumés et présentation: http://www.highload.ru/moscow/2018/abstracts/4066 

 Yuri Na...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>HighLoad ++, Yuri Nasretdinov (VK): comment VK insère des données dans ClickHouse à partir de dizaines de milliers de serveurs</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ua-hosting/blog/483712/">  HighLoad ++ Moscou 2018, salle des congrès.  9 novembre, 15h00 <br><br>  Résumés et présentation: <a href="http://www.highload.ru/moscow/2018/abstracts/4066">http://www.highload.ru/moscow/2018/abstracts/4066</a> <br><br>  Yuri Nasretdinov (VKontakte): le rapport parlera de l'expérience de la mise en œuvre de ClickHouse dans notre entreprise - pourquoi nous en avons besoin, combien de données nous stockons, comment nous les écrivons, etc. <br><br><img src="https://habrastorage.org/webt/82/hn/hb/82hnhbxzvzseq8_viregjypt_ms.jpeg"><br><br>  Ressources supplémentaires: <a href="https://habr.com/ru/company/ua-hosting/blog/483112/">utilisation de Clickhouse comme substitut pour ELK, Big Query et TimescaleDB</a> <a name="habracut"></a><br><br>  <b>Yuri Nasretdinov:</b> - Bonjour à tous!  Je m'appelle Yuri Nasretdinov, car ils m'ont déjà présenté.  Je travaille chez VKontakte.  Je vais parler de la façon dont nous insérons des données dans «ClickHouse» à partir de notre flotte de serveurs (des dizaines de milliers). <br><br><h3>  Que sont les journaux et pourquoi les collecter? </h3><br>  Ce dont nous allons parler: ce que nous avons fait, pourquoi nous avions besoin de "ClickHouse", respectivement - pourquoi nous l'avons choisi, quel genre de performances vous pouvez obtenir à peu près sans rien configurer spécifiquement.  Je vais vous en dire plus sur les tables tampons, sur les problèmes que nous avons rencontrés avec elles et sur nos solutions que nous avons développées à partir de l'open source - KittenHouse and Lighthouse. <br><br><img src="https://habrastorage.org/webt/j8/gj/qv/j8gjqvhcihgkbedpsmonpxznjto.jpeg"><br><br>  Pourquoi avons-nous dû faire quoi que ce soit (sur VKontakte, tout va toujours bien, non?).  Nous voulions collecter des journaux de débogage (et il y avait des centaines de téraoctets de données là-bas), peut-être, en quelque sorte, il est plus pratique de lire les statistiques;  et nous avons des dizaines de milliers de serveurs à partir desquels tout cela doit être fait. <br><br><img src="https://habrastorage.org/webt/pc/og/3w/pcog3wkh42pnfsdpwshhnu-1xqa.jpeg"><br><br>  Pourquoi avons-nous décidé?  Nous avions probablement des solutions pour stocker les journaux.  Ici - il y a un tel "Backend VK" public.  Je recommande fortement d'y souscrire. <br><br><img src="https://habrastorage.org/webt/15/xd/b3/15xdb3ma4wv43trpduxyujyo1w0.jpeg"><br><br>  Que sont les journaux?  Il s'agit d'un moteur qui renvoie des tableaux vides.  Les moteurs en «VK» sont ce que d'autres appellent des microservices.  Et un tel autocollant sourit (pas mal de likes).  Comment ça?  Eh bien, écoutez! <br><br><img src="https://habrastorage.org/webt/xm/xr/rf/xmxrrfccutg7p6ylcy9-zoyi8ba.jpeg"><br><br>  Que peut-on utiliser pour stocker les journaux en général?  Il est impossible de ne pas mentionner le Khadup.  Ensuite, par exemple, Rsyslog (stockage dans les fichiers de ces journaux).  LSD  Qui sait ce qu'est le LSD?  Non, pas ce LSD.  Les fichiers sont également stockés, respectivement.  Eh bien, ClickHouse est une étrange version en quelque sorte. <br><br><h3>  Clickhouse et concurrents: exigences et opportunités </h3><br>  Que voulons-nous?  Nous voulons que nous n'ayons pas eu besoin de prendre un bain de vapeur spécial avec l'opération, afin que cela fonctionne de préférence, avec une configuration minimale.  Nous voulons écrire beaucoup et écrire rapidement.  Et nous voulons le garder tous les mois, années, c'est-à-dire pendant longtemps.  Nous pouvons vouloir régler une sorte de problème avec lequel ils sont venus, ils ont dit - "Quelque chose ne fonctionne pas ici pour nous", - c'était il y a 3 mois), et nous voulons pouvoir le voir il y a 3 mois ".  Compression des données - on comprend pourquoi ce sera un plus - car la quantité d'espace occupé est réduite. <br><br><img src="https://habrastorage.org/webt/ho/f7/bs/hof7bsmyf40jzgxireygut6jpks.jpeg"><br><br>  Et nous avons une exigence tellement intéressante: nous écrivons parfois la sortie de certaines commandes (par exemple, les journaux), cela peut être plus de 4 kilo-octets assez calmement.  Et si cette chose fonctionne sur UDP, alors elle n'a pas besoin de dépenser ... elle n'aura pas de "surcharge" pour la connexion, et pour un grand nombre de serveurs ce sera un plus. <br><br><img src="https://habrastorage.org/webt/jh/pj/3i/jhpj3iedzogld0galjmia2npwe4.jpeg"><br><br>  Voyons ce que l'open source nous offre.  Premièrement, nous avons un moteur de journaux - c'est notre moteur;  il sait tout, même les longues lignes peuvent écrire.  Eh bien, il ne compresse pas les données de manière transparente - nous pouvons compresser nous-mêmes de grandes colonnes si nous le voulons ... nous, bien sûr, ne le voulons pas (si possible).  Le seul problème est qu'il ne peut donner que ce qui est placé dans sa mémoire;  le reste, pour lire, vous devez obtenir le binlog de ce moteur et, en conséquence, cela prend un certain temps. <br><br><img src="https://habrastorage.org/webt/ps/uk/f5/psukf5cng6yokwi5cbtvvrfry30.jpeg"><br><br>  Quelles sont les autres options?  Par exemple, Khadup.  Facilité d'utilisation ... Qui pense que le Hadoup est facile à configurer?  Avec l'enregistrement, bien sûr, il n'y a aucun problème.  Avec la lecture, des questions se posent parfois.  En principe, je dirais que très probablement pas, en particulier pour les journaux.  Stockage à long terme - bien sûr, oui, compression des données - oui, longues lignes - il est clair que vous pouvez écrire.  Mais pour enregistrer à partir d'un grand nombre de serveurs ... Quoi qu'il en soit, nous devons faire quelque chose nous-mêmes! <br><br>  Rsyslog.  En fait, nous l'avons utilisé comme solution de rechange, de sorte qu'il serait possible de lire un binlog sans vidage, mais il ne pouvait pas écrire sur de longues lignes, en principe, il ne pouvait pas écrire plus de 4 kilo-octets.  La compression des données doit être effectuée de la même manière.  La lecture ira des fichiers. <br><br><img src="https://habrastorage.org/webt/nt/xo/k3/ntxok3kz6sqyggmdlctpxrokprs.jpeg"><br><br>  Ensuite, il y a le "mauvais" développement du LSD.  La même chose est essentiellement la même chose que "Rsyslog": il prend en charge les longues lignes, mais il ne sait pas comment utiliser UDP et, en fait, à cause de cela, malheureusement, il y a beaucoup de choses à réécrire.  Le LSD doit être refait pour que vous puissiez enregistrer à partir de dizaines de milliers de serveurs. <br><br><img src="https://habrastorage.org/webt/2s/xr/fw/2sxrfwyzgj72wfqblvhlu8fphf0.jpeg"><br><br>  Oh, ici!  Une option amusante est ElasticSearch.  Eh bien, comment dire?  Tout va bien avec la lecture, c'est-à-dire qu'il lit rapidement, mais pas très bien avec l'écriture.  Premièrement, s'il compresse les données, il est très faible.  Très probablement, une recherche à part entière nécessite des structures de données plus volumineuses que le volume d'origine.  Il est difficile à exploiter, souvent des problèmes surviennent.  Et, encore une fois, une entrée dans le "Elastic" - nous devons tous le faire nous-mêmes. <br><br><img src="https://habrastorage.org/webt/wb/uv/ik/wbuvikg6tm42r0pjhkrtdrcye08.jpeg"><br><br>  Ici ClickHouse - l'option idéale, bien sûr.  La seule chose est que l'enregistrement à partir de dizaines de milliers de serveurs est un problème.  Mais elle est au moins une, nous pouvons essayer de le résoudre d'une manière ou d'une autre.  Et le reste du rapport traite de ce problème.  À quelle performance globale de ClickHouse pouvez-vous vous attendre? <br><br><h3>  Comment allons-nous intégrer?  MergeTree </h3><br>  Combien d'entre vous n'ont pas entendu parler de ClickHouse, ne sais pas?  Besoin de dire, pas nécessaire?  Très vite.  L'insert contient 1 à 2 gigabits par seconde, des rafales allant jusqu'à 10 gigabits par seconde peuvent réellement résister à cette configuration - il y a deux Xeons à 6 cœurs (ce n'est même pas les plus puissants), 256 gigaoctets de RAM, 20 téraoctets par RAID (personne configuré, paramètres par défaut).  Alexey Milovidov, le développeur de ClickHouse, pleure probablement, que nous n'avons rien configuré (tout fonctionnait comme ça pour nous).  Par conséquent, une vitesse de balayage d'environ 6 milliards de lignes par seconde peut être obtenue si les données sont bien compressées.  Si vous aimez% sur une ligne de texte, faites - 100 millions de lignes par seconde, c'est-à-dire que cela semble très rapidement. <br><br><img src="https://habrastorage.org/webt/mu/m0/ih/mum0ihdgejlxldsd9id8ijjytx8.jpeg"><br><br>  Comment allons-nous intégrer?  Eh bien, vous savez que dans "VK" - en PHP.  Nous, de chaque travailleur PHP, allons coller HTTP dans «ClickHouse», dans la plaque MergeTree pour chaque entrée.  Qui voit le problème dans ce circuit?  Pour une raison quelconque, tout le monde n'a pas levé la main.  Disons-le. <br><br>  Premièrement, il existe de nombreux serveurs - en conséquence, il y aura de nombreuses connexions (mauvaises).  Ensuite, dans MergeTree, il est préférable d'insérer les données pas plus d'une fois par seconde.  Et qui sait pourquoi?  D'accord.  Je vais vous en dire un peu plus à ce sujet.  Une autre question intéressante est que, pour ainsi dire, nous ne faisons pas d'analyse, nous n'avons pas besoin d'enrichir les données, nous n'avons pas besoin de serveurs intermédiaires, nous voulons intégrer directement dans «ClickHouse» (de préférence - le plus droit, le mieux). <br><br><img src="https://habrastorage.org/webt/2r/im/hz/2rimhzqo0cxkonc8paf7pi2qae0.jpeg"><br><br>  En conséquence, comment l'insertion est-elle implémentée dans MergeTree?  Pourquoi vaut-il mieux ne pas l'insérer plus d'une fois par seconde ou moins?  Le fait est que "ClickHouse" est une base de données en colonnes et trie les données dans l'ordre croissant de la clé primaire, et lorsque vous insérez, le nombre de fichiers est créé par au moins le nombre de colonnes dans lesquelles les données sont triées dans l'ordre croissant de la clé primaire (un répertoire séparé est créé, un ensemble de fichiers sur disque pour chaque insert).  Ensuite, l'insertion suivante va, et en arrière-plan, ils fusionnent dans une plus grande "partition".  Étant donné que les données sont triées, vous pouvez «jongler» avec deux fichiers triés sans consommer beaucoup de mémoire. <br><br>  Mais, comme vous pouvez l'imaginer, si vous écrivez 10 fichiers pour chaque insertion, «ClickHouse» se terminera rapidement (ou votre serveur), il est donc recommandé d'insérer en gros lots.  En conséquence, nous n'avons jamais lancé le premier schéma en production.  Nous en avons immédiatement lancé un qui a le numéro 2 ici: <br><br><img src="https://habrastorage.org/webt/7z/0d/yt/7z0dytuytercg92yrt1nu3tpczw.jpeg"><br><br>  Imaginez ici qu'il y a environ un millier de serveurs sur lesquels nous avons lancé, il n'y a que PHP.  Et sur chaque serveur, il y a notre agent local, que nous avons appelé «Kittenhouse», qui détient une connexion à «ClickHouse» et insère des données toutes les quelques secondes.  Il n'insère pas de données dans MergeTree, mais dans la table du spouleur, qui ne sert pas à insérer directement dans MergeTree immédiatement. <br><br><img src="https://habrastorage.org/webt/zu/ok/g1/zuokg1unbbwdege3mpsckf8npme.jpeg"><br><br><h3>  Travailler avec des tables tampons </h3><br>  Qu'est ce que c'est  Les tables tampons sont un morceau de mémoire mélangé (c'est-à-dire que vous pouvez souvent les insérer dedans).  Ils sont constitués de plusieurs pièces et chacune fonctionne comme une mémoire tampon indépendante, et elles sont vidées indépendamment (si vous avez plusieurs pièces dans la mémoire tampon, il y aura de nombreux insertions par seconde).  Vous pouvez lire à partir de ces tables - puis vous lisez l'union du contenu du tampon et de la table parent, mais à ce moment, l'enregistrement est bloqué, il est donc préférable de ne pas lire à partir de là.  Et un très bon QPS est montré par les tables de tampons, c'est-à-dire que jusqu'à 3 000 QPS, vous n'aurez aucun problème avec l'insertion.  Il est clair que si l'alimentation a été perdue sur le serveur, les données peuvent être perdues, car elles n'ont été stockées qu'en mémoire. <br><br><img src="https://habrastorage.org/webt/4p/rg/l1/4prgl1wcijnrxs6zcgz2gmybvec.jpeg"><br><br>  Dans le même temps, le schéma avec le tampon est compliqué par ALTER, car vous devez d'abord supprimer l'ancienne table de tampon avec l'ancien schéma (les données ne seront pas perdues en même temps, car elles seront vidées avant la suppression de la table).  Ensuite, vous "modifiez" la table dont vous avez besoin et créez à nouveau la table tampon.  Par conséquent, bien qu'il n'y ait pas de table tampon, vos données ne circulent nulle part, mais vous pouvez même localement sur disque. <br><br><img src="https://habrastorage.org/webt/nv/vx/ek/nvvxekkpy2bcezjpuylifhcworq.jpeg"><br><br><h3>  Qu'est-ce que Kittenhouse et comment ça marche? </h3><br>  Qu'est-ce que KittenHouse?  Ceci est un proxy.  Devinez quelle langue?  J'ai rassemblé les sujets les plus hype dans mon rapport - c'est «Clickhouse», allez, je me souviens peut-être d'autre chose.  Oui, c'est écrit en Go, parce que je ne sais pas vraiment écrire en C, je ne veux pas. <br><br><img src="https://habrastorage.org/webt/6r/1w/th/6r1wthqhe4flw_7t7ww01s5arug.jpeg"><br><br>  En conséquence, il conserve une connexion avec chaque serveur, peut écrire en mémoire.  Par exemple, si nous écrivons des journaux d'erreurs dans «Clickhouse», puis si «Clickhouse» n'a pas le temps d'insérer des données (après tout, si trop sont écrites), alors nous ne gonflons pas de mémoire - nous jetons simplement le reste.  Parce que, si nous écrivons plusieurs gigabits par seconde d'erreurs, nous pouvons probablement en lancer.  Kittenhouse sait comment.  De plus, il sait comment livrer de manière fiable, c'est-à-dire qu'il écrit sur un disque sur la machine locale et de temps en temps (là, une fois en quelques secondes), il essaie de fournir des données à partir de ce fichier.  Et au début, nous avons utilisé le format Values ​​habituel - pas un format binaire, un format texte (comme dans le SQL standard). <br><br><img src="https://habrastorage.org/webt/rj/2q/z3/rj2qz3hcwcur_lvha_tc2mxjpwq.jpeg"><br><br>  Mais c'est arrivé.  Nous avons utilisé une livraison fiable, écrit des journaux, puis décidé (c'était un cluster de test conditionnel) ... Pendant plusieurs heures, ils l'ont éteint et retiré, et il y avait un insert de milliers de serveurs - il s'est avéré que le Clickhouse avait toujours un «Thread on connexion »- en conséquence, sur mille connexions, l'insert actif entraîne une charge moyenne sur le serveur d'environ mille et demi.  Étonnamment, le serveur a accepté les demandes, mais ces données ont néanmoins été insérées après un certain temps;  mais il était très difficile pour le serveur de le réparer ... <br><br><h3>  Ajouter nginx </h3><br>  Une telle solution pour le modèle Thread per connection est nginx.  Nous avons mis nginx devant le Clickhouse, en même temps réglé l'équilibrage à deux répliques (nous avons augmenté la vitesse d'insertion de 2 fois, mais pas le fait qu'il devrait en être ainsi), et limité le nombre de connexions à Clickhouse, à l'amont et, par conséquent, plus que dans 50 composés, il semble inutile d'insérer. <br><br><img src="https://habrastorage.org/webt/7i/ib/9b/7iib9bduvmhr6taouopwj20zzsu.jpeg"><br><br>  Ensuite, nous avons réalisé qu'en général, ce schéma présente des inconvénients, car nous avons un nginx ici.  En conséquence, si ce nginx se couche, malgré la présence de répliques, nous perdons des données ou, du moins, n'écrivons nulle part.  Par conséquent, nous avons fait notre répartition de charge.  Nous avons également compris que «Clickhouse» est toujours adapté aux journaux, et le «démon» a également commencé à écrire ses propres journaux dans «Clickhouse» - très pratique, pour être honnête.  Nous l'utilisons toujours pour d'autres "démons". <br><br><img src="https://habrastorage.org/webt/px/o4/v3/pxo4v3tnrrxwye_tjavgb2p3kgu.jpeg"><br><br>  Ensuite, ils ont découvert un problème si intéressant: si vous utilisez une méthode pas tout à fait standard pour insérer en mode SQL, alors un analyseur à part entière AST SQL est forcé, ce qui est plutôt lent.  En conséquence, nous avons ajouté des paramètres pour que cela ne se produise jamais.  Nous avons fait l'équilibrage de charge, des bilans de santé, de sorte que si l'on décède, nous laissons toujours des données.  Nous avons obtenu suffisamment de tables pour que nous ayons besoin de différents clusters «Clickhouse».  Et nous avons commencé à penser à d'autres utilisations - par exemple, nous voulions écrire des journaux à partir de modules nginx, et ils ne peuvent pas communiquer à l'aide de notre RPC.  Eh bien, je voudrais leur apprendre en quelque sorte comment envoyer - par exemple, via UDP pour recevoir des événements sur localhost, puis les envoyer au «Clickhouse». <br><br><h3>  Un pas de la décision </h3><br>  Le schéma final a commencé à ressembler à ceci (la quatrième version de ce schéma): sur chaque serveur devant le Clickhouse, il y a nginx (sur le même serveur, en plus) et il envoie simplement des requêtes par proxy à l'hôte local avec une limite sur le nombre de connexions de 50 pièces.  Et maintenant, ce schéma fonctionnait déjà, il était assez bon avec lui. <br><br><img src="https://habrastorage.org/webt/co/ea/sw/coeaswk1ttzg--hk_nz-exq19l0.jpeg"><br><br>  Nous avons vécu comme ça pendant environ un mois.  Tout le monde était content, ajouter des tables, ajouter, ajouter ... En général, il s'est avéré que la façon dont nous avons ajouté des tables tampons n'était pas très optimale (disons-le).  Nous avons fait 16 pièces dans chaque table et un intervalle flash pendant quelques secondes;  nous avions 20 tables et 8 insertions par seconde sont allées à chaque table - et à ce moment le «Clickhouse» a commencé ... les enregistrements ont commencé à devenir vierges.  Ils n'ont même pas réussi ... Nginx avait une chose si intéressante par défaut que si les connexions se terminaient en amont, cela donne simplement "502" à toutes les nouvelles demandes. <br><br><img src="https://habrastorage.org/webt/wd/b-/ih/wdb-ihhsype-ykkjymstxzlq27q.jpeg"><br><br>  Et ici chez nous (je viens de regarder les journaux dans le très «Clickhouse» que j'ai regardé) quelque part environ un demi pour cent des demandes échoue.  En conséquence, l'utilisation du disque était élevée, il y avait de nombreuses fusions.  Eh bien, qu'ai-je fait?  Naturellement, je n'ai pas commencé à comprendre pourquoi la connexion et l'amont se terminent. <br><br><h3>  Remplacement de nginx par un proxy inverse </h3><br>  J'ai décidé que nous devons gérer cela nous-mêmes, ne le donnez pas à nginx - nginx ne sait pas quelles tables sont dans le "Clickhouse", et j'ai remplacé nginx par un proxy inverse, que j'ai également écrit. <br><br><img src="https://habrastorage.org/webt/7u/pv/ve/7upvvezqfizgs73uazcnuqz8edm.jpeg"><br><br>  Que fait-il?  Il fonctionne sur la base de la bibliothèque fasthttp "goosh", c'est-à-dire rapide, presque aussi rapide que nginx.  Désolé, Igor, si vous êtes ici (note: Igor Sysoev est un programmeur russe qui a créé le serveur Web nginx).  Il peut comprendre de quel type de requêtes il s'agit - INSERT ou SELECT - respectivement, il conserve différents pools de connexions pour différents types de requêtes. <br><br><img src="https://habrastorage.org/webt/ub/q1/43/ubq143ugu8fsrxicwobmwn8veni.jpeg"><br><br>  Par conséquent, même si nous n'avons pas le temps de répondre aux demandes, les "sélections" passeront, et vice versa.  Et il regroupe les données dans des tables tampons - avec un petit tampon: s'il y avait des erreurs, des erreurs de syntaxe, etc. - afin qu'elles influencent légèrement le reste des données, parce que lorsque nous insérions simplement dans les tables tampons, nous avions de petites « bachi ”, et toutes les erreurs de syntaxe n'ont affecté que ce petit morceau;  et ici, ils affecteront déjà le grand tampon.  Petit est 1 mégaoctet, c'est-à-dire pas si petit. <br><br><img src="https://habrastorage.org/webt/16/zx/hh/16zxhh_8qun8kzdyjd3i3ysnxzs.jpeg"><br><br>  L'insertion d'une synchronisation et le remplacement de nginx font essentiellement la même chose que nginx auparavant - le Kittenhouse n'a pas besoin d'être changé localement pour cela.  Et comme il utilise fasthttp, il est très rapide - vous pouvez effectuer plus de 100 000 requêtes par seconde d'insertions simples via des proxy inverses.  Théoriquement, vous pouvez insérer une ligne dans un proxy inverse kittenhouse, mais ce n'est certainement pas le cas. <br><br><img src="https://habrastorage.org/webt/dv/u5/w8/dvu5w8totg6sa3wexahrky4xcsu.jpeg"><br><br>  Le schéma a commencé à ressembler à ceci: Kittenhouse, un proxy inverse regroupe de nombreuses demandes dans des tables, et à son tour, les tables tampons les insèrent dans les principales. <br><br><h3>  Killer - solution temporaire, Chaton - permanent </h3><br>  Il y avait un problème si intéressant ... Avez-vous utilisé fasthttp?  Qui a utilisé fasthttp avec les requêtes POST?  Probablement, cela ne valait pas la peine en fait, car il met en mémoire tampon le corps de la demande par défaut, et nous avons défini la taille de la mémoire tampon de 16 mégaoctets.  L'insert a cessé d'être à temps à un moment donné, et de tous les dizaines de milliers de serveurs, des morceaux de 16 mégaoctets ont commencé à entrer, et ils ont tous été mis en mémoire tampon avant d'être envoyés au Clickhouse.  En conséquence, la mémoire s'est épuisée, le tueur hors mémoire est venu, a tué le proxy inverse (ou «Clickhouse», qui pourrait théoriquement «manger» plus que le proxy inverse).  Le cycle a été répété.  Pas un très beau problème.  Bien que nous ne soyons tombés sur cela qu'après quelques mois de fonctionnement. <br><br>  Qu'ai-je fait?  Encore une fois, je n'aime pas vraiment comprendre ce qui s'est exactement passé.  Il me semble assez évident qu'il n'est pas nécessaire de mettre en mémoire tampon.  Je n'ai pas pu patcher fasthttp, bien que j'aie essayé.  Mais j'ai trouvé un moyen de faire en sorte qu'il n'y ait pas besoin de patcher quoi que ce soit, et j'ai trouvé ma propre méthode dans HTTP - appelée KITTEN.  Eh bien, c'est logique - "VK", "Kitten" ... Comment sinon? .. <br><br><img src="https://habrastorage.org/webt/o9/r5/cu/o9r5cugeck0dm4gc_macqqzymgg.jpeg"><br><br>  Si une demande arrive au serveur avec la méthode Kitten, alors le serveur doit répondre «miaou» - logiquement.  S'il répond à cela, alors on pense qu'il comprend ce protocole, puis j'intercepte la connexion (il existe une telle méthode dans fasthttp), et la connexion passe en mode "brut".  Pourquoi ai-je besoin de ça?  Je veux contrôler la façon dont la lecture des connexions TCP se produit.  TCP a une propriété merveilleuse: si personne ne lit de ce côté, l'enregistrement commence à attendre et la mémoire n'est pas spécialement dépensée pour cela. <br><br>  Et donc j'ai lu quelque part à partir de 50 clients à la fois (de cinquante car cinquante devrait certainement suffire, même si ça vient d'un autre DC) ... La consommation a diminué avec cette approche au moins 20 fois, mais honnêtement je , Je n'ai pas pu mesurer exactement combien, car il est déjà inutile (il est déjà devenu au niveau d'erreur).  Le protocole est binaire, c'est-à-dire qu'il y a un nom de table et des données;  il n'y a pas d'en-tête http, donc je n'ai pas utilisé de socket web (je n'ai pas besoin de communiquer avec les navigateurs - j'ai fait un protocole qui correspond à nos besoins).  Et avec lui, tout allait bien. <br><br><h3>  La table tampon est triste </h3><br>  Récemment, nous sommes tombés sur une autre caractéristique intéressante des tables tampons.  Et ce problème est déjà beaucoup plus douloureux que les autres.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Imaginez cette situation: vous utilisez déjà activement «Clickhouse», vous avez des dizaines de serveurs «Clickhouse» et vous avez des requêtes qui se lisent depuis très longtemps (par exemple, plus de 60 secondes); </font><font style="vertical-align: inherit;">et vous venez et faites Alter en ce moment ... Et tant que les "sélections" qui ont commencé avant "Alter" ne sont pas incluses dans ce tableau, "Alter" ne démarre pas - probablement certaines caractéristiques du fonctionnement de "Clickhouse" cet endroit. </font><font style="vertical-align: inherit;">Peut-être que cela peut être corrigé? </font><font style="vertical-align: inherit;">Ou pas?</font></font><br><br><img src="https://habrastorage.org/webt/8w/zp/su/8wzpsufzkqmzafrt9vom83joq2i.jpeg"><br><br>  , ,          ,       .  , , ,   «»  (      –   ,   , ), …     ,    «» ( -  «» ) –  ,  -   :      (   ,     ),  «» , - ,         .    ,    «»,          –   . <br><br><img src="https://habrastorage.org/webt/po/om/z0/poomz0as89k3aqxh3pa9xpvrr-4.jpeg"><br><br>     (,   ) –     «» query_thread_log.  ,  -   .    840      (100 ).    ,    (, , ,   ) «» (inserts).    ,   «»  –     «»    . ,    –     ,       .  Pourquoi?      ,    !   . <br><br><img src="https://habrastorage.org/webt/vg/gm/fl/vggmfl00f3pku7iix3k7dfj_-am.jpeg"><br><br>   ,     ?    «».  . <br><br><h3>   «KitttenHouse» </h3><br>    , ?               .   !    :  ,   ,  -      .          ,       . <br><br><img src="https://habrastorage.org/webt/pd/e0/rd/pde0rdcd8h4mquk684qhfkvmpvq.jpeg"><br><br> ,   «»,      –       ,      (, - )     ,   ,  – . <br><br><img src="https://habrastorage.org/webt/k_/f3/ev/k_f3ev78dpgabrqjogevuzmykvw.jpeg"><br><br>     ?    .   , ,    10  ,    –         -,      ,  .  ,    , ,    ,        – ,     «»,    100         - –        ,   ,          ,     .          ,   .     ,    . <br><br>  ,       ,    .    :    ,    - ,  , ,    read only    .   ?   .         –  -  , -      … (   , «»,  ClickHouse)  ? ?   ,    .       .   :      ,        .        ,      .  . <br><br><h3>    </h3><br>      .      .  ,   -   ?..    «»? -    …     «»?  ,   ,        .     ,        .    ,  . <br><br><img src="https://habrastorage.org/webt/qy/ko/ud/qykoudjbl76cbexrko1zcmr_wmy.jpeg"><br><br>    –     .     ,   .    ,   : ,     ,     (   ),      – ,   . <br><br><img src="https://habrastorage.org/webt/gp/xa/1f/gpxa1fqutqdl4zr_ngqko2yjpom.jpeg"><br><br>       Sequel Pro,      «»,   .  : «,     -?»  ? 2018-?  ,       «» (MySQL)        ,      «»,    !       «»,     –  ,  . <br><br><img src="https://habrastorage.org/webt/bj/ei/vf/bjeivfj1rem72hvgi50jemwlwkc.jpeg"><br><br> ,    ,   ,  ,  ,   ,  ,    , affected rows (  ),       .  . <br><br><img src="https://habrastorage.org/webt/gu/qb/d7/guqbd74jb1bppis3vv_nbokkiaq.jpeg"><br><br>   .        «»,   .  - -  .     . <br><br><h3> «»    </h3><br>    ,  «»,     ,     . ,  ,    –         .          ,      … ,    ,     . <br><br><img src="https://habrastorage.org/webt/ty/tn/97/tytn97odgbvky_khyj7abanlhqg.jpeg"><br><br> TCP? ,  «»   UDP.     TCP… , ,   : «,   ! ,  UDP». ,  TCP     . ,       ,     –  -   ;  ,   . <br><br> «»  «»     HighLoad Siberia,       « »…  ,   …    , ,       .  -  , -   ,    – ,  (     ,   , ).   <a href="https://vk.com/vkbackend">   </a> .  ! Github  <a href="https://github.com/VKCOM/"> </a> .  «»      . <br><br><img src="https://habrastorage.org/webt/ai/nd/eu/aindeupigrlmumartzyvealbyj4.jpeg"><br><br> <b>:</b> – ,   .   ,          VHS. <br><br> <b>  ( – ):</b> –         VHS,     ? <br><br><img src="https://habrastorage.org/webt/w0/b6/zx/w0b6zxe9lcu_9gtaoimopvg8eyy.jpeg"><br><br> <b>:</b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Vous aussi, vous ne pouvez pas déterminer complètement comment le Clickhouse fonctionnera ou ne fonctionnera pas!" </font><font style="vertical-align: inherit;">Amis, 5 minutes pour les questions!</font></font><br><br><h3>  Des questions </h3><br>  <b>Question du public (ci-après - H):</b> - Bonjour.  Merci beaucoup pour le rapport.  J'ai deux questions.  Je vais commencer par une frivole: le nombre de lettres t du nom «Kittenhouse» sur les schémas (3, 4, 7 ...) affecte-t-il la satisfaction des chats? <br><br>  <b>UN:</b> - La quantité de quoi? <br><br>  <b>Z:</b> - Les lettres t.  Il y en a trois t, quelque part trois t. <br><br>  <b>UN:</b> - Ai-je vraiment corrigé cela?  Bien sûr que oui!  Ce sont des produits différents - je vous ai menti tout le temps.  D'accord, je plaisante - ce n'est pas le cas.  Ah, ici!  Non, c'est la même chose, je suis scellé. <br><br><img src="https://habrastorage.org/webt/fm/4c/ju/fm4cju6vnwwqvpm2o0exqllhsra.jpeg"><br><br>  <b>Z:</b> - Merci.  La deuxième question est sérieuse.  Pour autant que je sache, dans «Clickhouse», les tables tampons vivent exclusivement en mémoire, elles ne sont pas mises en mémoire tampon sur le disque et, par conséquent, ne sont pas persistantes. <br><br>  <b>UN:</b> - Oui. <br><br>  <b>Z:</b> - Et en même temps, sur votre client, une mise en mémoire tampon sur le disque est effectuée, ce qui implique une certaine garantie de livraison de ces mêmes journaux.  Mais au Clickhouse, ce n'est pas garanti.  Expliquez comment la garantie est exécutée, pour quelle raison? .. Ce mécanisme est plus détaillé <br><br>  <b>UN:</b> - Oui, théoriquement, il n'y a pas de contradictions, car vous pouvez détecter un million de façons différentes en réalité lorsque le «Clickhouse» tombe.  Si le «Clickhouse» plante (s'il n'est pas correctement complété), vous pouvez, en gros, rembobiner votre journal que vous avez noté un peu et recommencer à partir du moment où tout allait bien.  Rembobinons il y a une minute, c'est-à-dire, on pense qu'il a tout flashé en une minute. <br><br>  <b>Z:</b> - Autrement dit, le Kittenhouse garde la fenêtre plus longue et en cas de chute peut-elle la reconnaître et la dérouler? <br><br>  <b>UN:</b> - Mais c'est en théorie.  En pratique, nous ne le faisons pas et la livraison fiable est de zéro à l'infini.  Mais en moyenne.  Nous sommes convaincus que si le «Clickhouse» plante pour une raison quelconque ou que les serveurs «redémarrent», nous perdons un peu.  Dans tous les autres cas, rien ne se passera. <br><br>  <b>Z:</b> - Bonjour.  Dès le début, il m'a semblé que vous utiliseriez vraiment UDP dès le début du rapport.  Vous avez http, tout ça ... Et la plupart des problèmes que vous avez décrits, si je comprends bien, ont été causés par cette solution particulière ... <br><br>  <b>UN:</b> - Qu'utilisons-nous TCP? <br><br>  <b>Z:</b> - En fait, oui. <br><br>  <b>ONU:</b> - Non. <br><br>  <b>Z:</b> - C'est avec fasthttp que vous avez eu des problèmes, avec la connexion vous avez eu des problèmes.  Si vous venez d'utiliser UDP, vous gagneriez du temps.  Eh bien, il y aurait des problèmes avec les longs messages ou autre chose ... <br><br>  <b>UN:</b> - Avec quoi? <br><br><img src="https://habrastorage.org/webt/zl/pe/qj/zlpeqjirfmjnmnfkz-tmzmpnbia.jpeg"><br><br>  <b>Z:</b> - Avec de longs messages, car il peut ne pas rentrer dans le MTU, autre chose ... Eh bien, là, vos problèmes peuvent survenir.  La question est: pourquoi n'est-ce pas UDP? <br><br>  <b>UN:</b> - Je pense que les auteurs qui ont développé TCP / IP sont beaucoup plus intelligents que moi et savent mieux sérialiser les paquets (pour qu'ils aillent), en même temps ajuster la fenêtre d'envoi, ne pas surcharger le réseau et donner des commentaires sur ce lit, sans compter de l'autre côté ... Tous ces problèmes, à mon avis, seraient également dans UDP, seulement je devrais écrire encore plus de code que je l'ai déjà écrit afin d'implémenter la même chose moi-même et très probablement ce serait mauvais.  Je n'aime même pas écrire en C, pas comme ça ... <br><br>  <b>Z:</b> - Tout simplement pratique!  Envoyé ok et n'attendez rien - vous avez absolument asynchrone.  Un avis est revenu que tout va bien - cela signifie qu'il est venu;  n'est pas venu - cela signifie mauvais. <br><br>  <b>UN:</b> - J'ai besoin de cela et d'un autre - Je dois pouvoir envoyer les deux avec une garantie de livraison et sans garantie de livraison.  Ce sont deux scénarios différents.  Certains journaux que je n'ai pas besoin de perdre ou de ne pas perdre dans des limites raisonnables. <br><br>  <b>Z:</b> - Je ne prendrai pas de temps.  Cela devrait être discuté plus longtemps.  Je vous remercie <br><br>  <b>Présentateur:</b> - Qui a des questions - des stylos dans le ciel! <br><br><img src="https://habrastorage.org/webt/ip/mz/l7/ipmzl72i77pluuukxeyuxpqeob0.jpeg"><br><br>  <b>Z:</b> - Salut, je suis Sasha.  Quelque part au milieu du rapport, il y avait le sentiment qu'il était possible, outre TCP, d'utiliser une solution toute faite - une sorte de Kafka. <br><br>  <b>UN:</b> "Eh bien ... je vous ai dit que je ne voulais pas utiliser de serveurs intermédiaires, parce que ... pour Kafka - il se trouve que nous avons dix mille hôtes;  en fait, nous avons plus - des dizaines de milliers d'hôtes.  Avec Kafka, sans procuration, cela peut aussi faire mal.  De plus, plus important encore, il donne toujours une "latence", donne les hôtes supplémentaires dont vous avez besoin.  Et je ne veux pas les avoir - je veux ... <br><br>  <b>Z:</b> - Mais finalement ça s'est avéré quand même. <br><br>  <b>UN:</b> - Non, il n'y a pas d'hôtes!  Tout fonctionne sur les hôtes Clickhouse. <br><br>  <b>Z:</b> - Mais qu'en est-il du Kittenhouse, dont l'inverse est - où vit-il? <br><br><img src="https://habrastorage.org/webt/bn/ew/lk/bnewlk0ozew0rhhlgtdwhkhjfcu.jpeg"><br><br>  <b>UN:</b> - Chez l'hôte de Klickhouse, il n'écrit rien sur le disque. <br><br>  <b>Z:</b> - Eh bien, disons. <br><br>  <b>Présentateur:</b> - Vous satisfait?  Pouvons-nous donner un salaire? <br><br>  <b>Z:</b> - Oui, oui.  En fait, il y a beaucoup de béquilles pour obtenir la même chose, et maintenant - la réponse précédente sur le sujet du TCP contredit, à mon avis, cette situation.  C'est comme si vous pouviez tout faire sur votre genou en beaucoup moins de temps. <br><br>  <b>ONU:</b> - Et pourquoi n'ai-je pas voulu utiliser "Kafka", car il y avait beaucoup de plaintes dans le télégramme "Clickhouse" dans Telegram, par exemple, des messages de "Kafka" ont été perdus.  Pas de Kafka elle-même, mais dans l'intégration de Kafka et Klikhaus;  ou quelque chose ne s'y connectait pas.  En gros, il faudrait alors que le client écrive alors à Kafka.  Je ne pense pas qu'une solution plus simple et plus fiable serait obtenue. <br><br>  <b>Z:</b> - Dites-moi, pourquoi n'avez-vous pas essayé des lignes ou un bus commun?  Puisque vous dites qu'il était possible avec vous de manière asynchrone de parcourir la file d'attente les journaux eux-mêmes et également d'obtenir de manière asynchrone la file d'attente en réponse? <br><br><img src="https://habrastorage.org/webt/pn/4q/sz/pn4qszihp9ejs5aoua8swthjrqk.jpeg"><br><br>  <b>UN:</b> - Veuillez suggérer quelles files d'attente pourraient être utilisées? <br><br>  <b>Z:</b> - Tout, même sans garantie qu'ils vont dans l'ordre.  Tout Redis, RMQ ... <br><br>  <b>UN:</b> - J'ai le sentiment que Redis ne sera probablement pas en mesure de tirer un tel volume d'insertion même sur un hôte (dans le sens de plusieurs serveurs) qui sort le Clickhouse.  Je ne peux pas le confirmer avec des preuves (je ne l'ai pas comparé), mais il me semble que Redis n'est pas la meilleure solution ici.  En principe, vous pouvez considérer ce système comme une file d'attente de messages impromptue, mais uniquement pour «Clickhouse» <br><br>  <b>Présentateur:</b> - Yuri, merci beaucoup.  Je propose de terminer les questions et réponses à ce sujet et de dire laquelle des personnes qui ont posé la question nous donnera un livre. <br><br>  <b>ONU:</b> - Je voudrais donner un livre à la première personne qui a posé une question. <br><br>  <b>Présentateur:</b> - Super!  Super!  Super!  Merci beaucoup! <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/pbbcMcrQoXw" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><h3>  Un peu de publicité :) </h3><br>  Merci de rester avec nous.  Aimez-vous nos articles?  Vous voulez voir des matériaux plus intéressants?  Soutenez-nous en passant une commande ou en recommandant à vos amis <a href="https://ua-hosting.company/cloudvps/nl">des VPS basés sur le cloud pour les développeurs à partir de 4,99 $</a> , un <b>analogue unique de serveurs d'entrée de gamme que nous avons inventés pour vous:</b> <a href="https://habr.com/company/ua-hosting/blog/347386/">Toute la vérité sur les VPS (KVM) E5-2697 v3 (6 cœurs) 10 Go DDR4 480 Go SSD 1 Gbit / s à partir de 19 $ ou comment diviser le serveur?</a>  (les options sont disponibles avec RAID1 et RAID10, jusqu'à 24 cœurs et jusqu'à 40 Go de DDR4). <br><br>  <b>Dell R730xd 2 fois moins cher au centre de données Equinix Tier IV à Amsterdam?</b>  Nous avons seulement <b><a href="https://ua-hosting.company/serversnl">2 x Intel TetraDeca-Core Xeon 2x E5-2697v3 2.6GHz 14C 64GB DDR4 4x960GB SSD 1Gbps 100 TV à partir de 199 $</a> aux Pays-Bas!</b>  <b><b>Dell R420 - 2x E5-2430 2.2Ghz 6C 128GB DDR3 2x960GB SSD 1Gbps 100TB - à partir de 99 $!</b></b>  Pour en savoir plus sur la <a href="https://habr.com/company/ua-hosting/blog/329618/">création d'un bâtiment d'infrastructure</a>  <a href="https://habr.com/company/ua-hosting/blog/329618/">classe utilisant des serveurs Dell R730xd E5-2650 v4 coûtant 9 000 euros pour un sou?</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr483712/">https://habr.com/ru/post/fr483712/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr483688/index.html">Environ 30 fois plus de concurrence dans Node.js</a></li>
<li><a href="../fr483698/index.html">Comment LoRaWAN aide à construire un Internet des objets moderne</a></li>
<li><a href="../fr483700/index.html">Résultats physiques de l'année - 2019</a></li>
<li><a href="../fr483704/index.html">Événements numériques à Moscou du 13 au 19 janvier</a></li>
<li><a href="../fr483706/index.html">Idées d'applications pour générer des revenus pour les startups en 2019 et au-delà</a></li>
<li><a href="../fr483714/index.html">Prix ​​et concours pour des projets innovants. Expérience des vendeurs mondiaux</a></li>
<li><a href="../fr483716/index.html">Utilisation de Vulnerability Scanner dans les bibliothèques de vérification des dépendances utilisées dans GitlabCI</a></li>
<li><a href="../fr483718/index.html">Comment VDI transforme l'environnement de bureau</a></li>
<li><a href="../fr483720/index.html">Ce qui nous a apporté Pandas 1.0</a></li>
<li><a href="../fr483722/index.html">Géoanalytique dans le commerce de détail, partie 1: nous automatisons le processus de choix d'un lieu pour une entreprise. 2GIS + MS Azure + ML</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>