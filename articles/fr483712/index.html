<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸï¸ ğŸš† ğŸ¿ HighLoad ++, Yuri Nasretdinov (VK): comment VK insÃ¨re des donnÃ©es dans ClickHouse Ã  partir de dizaines de milliers de serveurs ğŸ¿ ğŸ‰ ğŸ¤šğŸ¾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="HighLoad ++ Moscou 2018, salle des congrÃ¨s. 9 novembre, 15h00 

 RÃ©sumÃ©s et prÃ©sentation: http://www.highload.ru/moscow/2018/abstracts/4066 

 Yuri Na...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>HighLoad ++, Yuri Nasretdinov (VK): comment VK insÃ¨re des donnÃ©es dans ClickHouse Ã  partir de dizaines de milliers de serveurs</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ua-hosting/blog/483712/">  HighLoad ++ Moscou 2018, salle des congrÃ¨s.  9 novembre, 15h00 <br><br>  RÃ©sumÃ©s et prÃ©sentation: <a href="http://www.highload.ru/moscow/2018/abstracts/4066">http://www.highload.ru/moscow/2018/abstracts/4066</a> <br><br>  Yuri Nasretdinov (VKontakte): le rapport parlera de l'expÃ©rience de la mise en Å“uvre de ClickHouse dans notre entreprise - pourquoi nous en avons besoin, combien de donnÃ©es nous stockons, comment nous les Ã©crivons, etc. <br><br><img src="https://habrastorage.org/webt/82/hn/hb/82hnhbxzvzseq8_viregjypt_ms.jpeg"><br><br>  Ressources supplÃ©mentaires: <a href="https://habr.com/ru/company/ua-hosting/blog/483112/">utilisation de Clickhouse comme substitut pour ELK, Big Query et TimescaleDB</a> <a name="habracut"></a><br><br>  <b>Yuri Nasretdinov:</b> - Bonjour Ã  tous!  Je m'appelle Yuri Nasretdinov, car ils m'ont dÃ©jÃ  prÃ©sentÃ©.  Je travaille chez VKontakte.  Je vais parler de la faÃ§on dont nous insÃ©rons des donnÃ©es dans Â«ClickHouseÂ» Ã  partir de notre flotte de serveurs (des dizaines de milliers). <br><br><h3>  Que sont les journaux et pourquoi les collecter? </h3><br>  Ce dont nous allons parler: ce que nous avons fait, pourquoi nous avions besoin de "ClickHouse", respectivement - pourquoi nous l'avons choisi, quel genre de performances vous pouvez obtenir Ã  peu prÃ¨s sans rien configurer spÃ©cifiquement.  Je vais vous en dire plus sur les tables tampons, sur les problÃ¨mes que nous avons rencontrÃ©s avec elles et sur nos solutions que nous avons dÃ©veloppÃ©es Ã  partir de l'open source - KittenHouse and Lighthouse. <br><br><img src="https://habrastorage.org/webt/j8/gj/qv/j8gjqvhcihgkbedpsmonpxznjto.jpeg"><br><br>  Pourquoi avons-nous dÃ» faire quoi que ce soit (sur VKontakte, tout va toujours bien, non?).  Nous voulions collecter des journaux de dÃ©bogage (et il y avait des centaines de tÃ©raoctets de donnÃ©es lÃ -bas), peut-Ãªtre, en quelque sorte, il est plus pratique de lire les statistiques;  et nous avons des dizaines de milliers de serveurs Ã  partir desquels tout cela doit Ãªtre fait. <br><br><img src="https://habrastorage.org/webt/pc/og/3w/pcog3wkh42pnfsdpwshhnu-1xqa.jpeg"><br><br>  Pourquoi avons-nous dÃ©cidÃ©?  Nous avions probablement des solutions pour stocker les journaux.  Ici - il y a un tel "Backend VK" public.  Je recommande fortement d'y souscrire. <br><br><img src="https://habrastorage.org/webt/15/xd/b3/15xdb3ma4wv43trpduxyujyo1w0.jpeg"><br><br>  Que sont les journaux?  Il s'agit d'un moteur qui renvoie des tableaux vides.  Les moteurs en Â«VKÂ» sont ce que d'autres appellent des microservices.  Et un tel autocollant sourit (pas mal de likes).  Comment Ã§a?  Eh bien, Ã©coutez! <br><br><img src="https://habrastorage.org/webt/xm/xr/rf/xmxrrfccutg7p6ylcy9-zoyi8ba.jpeg"><br><br>  Que peut-on utiliser pour stocker les journaux en gÃ©nÃ©ral?  Il est impossible de ne pas mentionner le Khadup.  Ensuite, par exemple, Rsyslog (stockage dans les fichiers de ces journaux).  LSD  Qui sait ce qu'est le LSD?  Non, pas ce LSD.  Les fichiers sont Ã©galement stockÃ©s, respectivement.  Eh bien, ClickHouse est une Ã©trange version en quelque sorte. <br><br><h3>  Clickhouse et concurrents: exigences et opportunitÃ©s </h3><br>  Que voulons-nous?  Nous voulons que nous n'ayons pas eu besoin de prendre un bain de vapeur spÃ©cial avec l'opÃ©ration, afin que cela fonctionne de prÃ©fÃ©rence, avec une configuration minimale.  Nous voulons Ã©crire beaucoup et Ã©crire rapidement.  Et nous voulons le garder tous les mois, annÃ©es, c'est-Ã -dire pendant longtemps.  Nous pouvons vouloir rÃ©gler une sorte de problÃ¨me avec lequel ils sont venus, ils ont dit - "Quelque chose ne fonctionne pas ici pour nous", - c'Ã©tait il y a 3 mois), et nous voulons pouvoir le voir il y a 3 mois ".  Compression des donnÃ©es - on comprend pourquoi ce sera un plus - car la quantitÃ© d'espace occupÃ© est rÃ©duite. <br><br><img src="https://habrastorage.org/webt/ho/f7/bs/hof7bsmyf40jzgxireygut6jpks.jpeg"><br><br>  Et nous avons une exigence tellement intÃ©ressante: nous Ã©crivons parfois la sortie de certaines commandes (par exemple, les journaux), cela peut Ãªtre plus de 4 kilo-octets assez calmement.  Et si cette chose fonctionne sur UDP, alors elle n'a pas besoin de dÃ©penser ... elle n'aura pas de "surcharge" pour la connexion, et pour un grand nombre de serveurs ce sera un plus. <br><br><img src="https://habrastorage.org/webt/jh/pj/3i/jhpj3iedzogld0galjmia2npwe4.jpeg"><br><br>  Voyons ce que l'open source nous offre.  PremiÃ¨rement, nous avons un moteur de journaux - c'est notre moteur;  il sait tout, mÃªme les longues lignes peuvent Ã©crire.  Eh bien, il ne compresse pas les donnÃ©es de maniÃ¨re transparente - nous pouvons compresser nous-mÃªmes de grandes colonnes si nous le voulons ... nous, bien sÃ»r, ne le voulons pas (si possible).  Le seul problÃ¨me est qu'il ne peut donner que ce qui est placÃ© dans sa mÃ©moire;  le reste, pour lire, vous devez obtenir le binlog de ce moteur et, en consÃ©quence, cela prend un certain temps. <br><br><img src="https://habrastorage.org/webt/ps/uk/f5/psukf5cng6yokwi5cbtvvrfry30.jpeg"><br><br>  Quelles sont les autres options?  Par exemple, Khadup.  FacilitÃ© d'utilisation ... Qui pense que le Hadoup est facile Ã  configurer?  Avec l'enregistrement, bien sÃ»r, il n'y a aucun problÃ¨me.  Avec la lecture, des questions se posent parfois.  En principe, je dirais que trÃ¨s probablement pas, en particulier pour les journaux.  Stockage Ã  long terme - bien sÃ»r, oui, compression des donnÃ©es - oui, longues lignes - il est clair que vous pouvez Ã©crire.  Mais pour enregistrer Ã  partir d'un grand nombre de serveurs ... Quoi qu'il en soit, nous devons faire quelque chose nous-mÃªmes! <br><br>  Rsyslog.  En fait, nous l'avons utilisÃ© comme solution de rechange, de sorte qu'il serait possible de lire un binlog sans vidage, mais il ne pouvait pas Ã©crire sur de longues lignes, en principe, il ne pouvait pas Ã©crire plus de 4 kilo-octets.  La compression des donnÃ©es doit Ãªtre effectuÃ©e de la mÃªme maniÃ¨re.  La lecture ira des fichiers. <br><br><img src="https://habrastorage.org/webt/nt/xo/k3/ntxok3kz6sqyggmdlctpxrokprs.jpeg"><br><br>  Ensuite, il y a le "mauvais" dÃ©veloppement du LSD.  La mÃªme chose est essentiellement la mÃªme chose que "Rsyslog": il prend en charge les longues lignes, mais il ne sait pas comment utiliser UDP et, en fait, Ã  cause de cela, malheureusement, il y a beaucoup de choses Ã  rÃ©Ã©crire.  Le LSD doit Ãªtre refait pour que vous puissiez enregistrer Ã  partir de dizaines de milliers de serveurs. <br><br><img src="https://habrastorage.org/webt/2s/xr/fw/2sxrfwyzgj72wfqblvhlu8fphf0.jpeg"><br><br>  Oh, ici!  Une option amusante est ElasticSearch.  Eh bien, comment dire?  Tout va bien avec la lecture, c'est-Ã -dire qu'il lit rapidement, mais pas trÃ¨s bien avec l'Ã©criture.  PremiÃ¨rement, s'il compresse les donnÃ©es, il est trÃ¨s faible.  TrÃ¨s probablement, une recherche Ã  part entiÃ¨re nÃ©cessite des structures de donnÃ©es plus volumineuses que le volume d'origine.  Il est difficile Ã  exploiter, souvent des problÃ¨mes surviennent.  Et, encore une fois, une entrÃ©e dans le "Elastic" - nous devons tous le faire nous-mÃªmes. <br><br><img src="https://habrastorage.org/webt/wb/uv/ik/wbuvikg6tm42r0pjhkrtdrcye08.jpeg"><br><br>  Ici ClickHouse - l'option idÃ©ale, bien sÃ»r.  La seule chose est que l'enregistrement Ã  partir de dizaines de milliers de serveurs est un problÃ¨me.  Mais elle est au moins une, nous pouvons essayer de le rÃ©soudre d'une maniÃ¨re ou d'une autre.  Et le reste du rapport traite de ce problÃ¨me.  Ã€ quelle performance globale de ClickHouse pouvez-vous vous attendre? <br><br><h3>  Comment allons-nous intÃ©grer?  MergeTree </h3><br>  Combien d'entre vous n'ont pas entendu parler de ClickHouse, ne sais pas?  Besoin de dire, pas nÃ©cessaire?  TrÃ¨s vite.  L'insert contient 1 Ã  2 gigabits par seconde, des rafales allant jusqu'Ã  10 gigabits par seconde peuvent rÃ©ellement rÃ©sister Ã  cette configuration - il y a deux Xeons Ã  6 cÅ“urs (ce n'est mÃªme pas les plus puissants), 256 gigaoctets de RAM, 20 tÃ©raoctets par RAID (personne configurÃ©, paramÃ¨tres par dÃ©faut).  Alexey Milovidov, le dÃ©veloppeur de ClickHouse, pleure probablement, que nous n'avons rien configurÃ© (tout fonctionnait comme Ã§a pour nous).  Par consÃ©quent, une vitesse de balayage d'environ 6 milliards de lignes par seconde peut Ãªtre obtenue si les donnÃ©es sont bien compressÃ©es.  Si vous aimez% sur une ligne de texte, faites - 100 millions de lignes par seconde, c'est-Ã -dire que cela semble trÃ¨s rapidement. <br><br><img src="https://habrastorage.org/webt/mu/m0/ih/mum0ihdgejlxldsd9id8ijjytx8.jpeg"><br><br>  Comment allons-nous intÃ©grer?  Eh bien, vous savez que dans "VK" - en PHP.  Nous, de chaque travailleur PHP, allons coller HTTP dans Â«ClickHouseÂ», dans la plaque MergeTree pour chaque entrÃ©e.  Qui voit le problÃ¨me dans ce circuit?  Pour une raison quelconque, tout le monde n'a pas levÃ© la main.  Disons-le. <br><br>  PremiÃ¨rement, il existe de nombreux serveurs - en consÃ©quence, il y aura de nombreuses connexions (mauvaises).  Ensuite, dans MergeTree, il est prÃ©fÃ©rable d'insÃ©rer les donnÃ©es pas plus d'une fois par seconde.  Et qui sait pourquoi?  D'accord.  Je vais vous en dire un peu plus Ã  ce sujet.  Une autre question intÃ©ressante est que, pour ainsi dire, nous ne faisons pas d'analyse, nous n'avons pas besoin d'enrichir les donnÃ©es, nous n'avons pas besoin de serveurs intermÃ©diaires, nous voulons intÃ©grer directement dans Â«ClickHouseÂ» (de prÃ©fÃ©rence - le plus droit, le mieux). <br><br><img src="https://habrastorage.org/webt/2r/im/hz/2rimhzqo0cxkonc8paf7pi2qae0.jpeg"><br><br>  En consÃ©quence, comment l'insertion est-elle implÃ©mentÃ©e dans MergeTree?  Pourquoi vaut-il mieux ne pas l'insÃ©rer plus d'une fois par seconde ou moins?  Le fait est que "ClickHouse" est une base de donnÃ©es en colonnes et trie les donnÃ©es dans l'ordre croissant de la clÃ© primaire, et lorsque vous insÃ©rez, le nombre de fichiers est crÃ©Ã© par au moins le nombre de colonnes dans lesquelles les donnÃ©es sont triÃ©es dans l'ordre croissant de la clÃ© primaire (un rÃ©pertoire sÃ©parÃ© est crÃ©Ã©, un ensemble de fichiers sur disque pour chaque insert).  Ensuite, l'insertion suivante va, et en arriÃ¨re-plan, ils fusionnent dans une plus grande "partition".  Ã‰tant donnÃ© que les donnÃ©es sont triÃ©es, vous pouvez Â«jonglerÂ» avec deux fichiers triÃ©s sans consommer beaucoup de mÃ©moire. <br><br>  Mais, comme vous pouvez l'imaginer, si vous Ã©crivez 10 fichiers pour chaque insertion, Â«ClickHouseÂ» se terminera rapidement (ou votre serveur), il est donc recommandÃ© d'insÃ©rer en gros lots.  En consÃ©quence, nous n'avons jamais lancÃ© le premier schÃ©ma en production.  Nous en avons immÃ©diatement lancÃ© un qui a le numÃ©ro 2 ici: <br><br><img src="https://habrastorage.org/webt/7z/0d/yt/7z0dytuytercg92yrt1nu3tpczw.jpeg"><br><br>  Imaginez ici qu'il y a environ un millier de serveurs sur lesquels nous avons lancÃ©, il n'y a que PHP.  Et sur chaque serveur, il y a notre agent local, que nous avons appelÃ© Â«KittenhouseÂ», qui dÃ©tient une connexion Ã  Â«ClickHouseÂ» et insÃ¨re des donnÃ©es toutes les quelques secondes.  Il n'insÃ¨re pas de donnÃ©es dans MergeTree, mais dans la table du spouleur, qui ne sert pas Ã  insÃ©rer directement dans MergeTree immÃ©diatement. <br><br><img src="https://habrastorage.org/webt/zu/ok/g1/zuokg1unbbwdege3mpsckf8npme.jpeg"><br><br><h3>  Travailler avec des tables tampons </h3><br>  Qu'est ce que c'est  Les tables tampons sont un morceau de mÃ©moire mÃ©langÃ© (c'est-Ã -dire que vous pouvez souvent les insÃ©rer dedans).  Ils sont constituÃ©s de plusieurs piÃ¨ces et chacune fonctionne comme une mÃ©moire tampon indÃ©pendante, et elles sont vidÃ©es indÃ©pendamment (si vous avez plusieurs piÃ¨ces dans la mÃ©moire tampon, il y aura de nombreux insertions par seconde).  Vous pouvez lire Ã  partir de ces tables - puis vous lisez l'union du contenu du tampon et de la table parent, mais Ã  ce moment, l'enregistrement est bloquÃ©, il est donc prÃ©fÃ©rable de ne pas lire Ã  partir de lÃ .  Et un trÃ¨s bon QPS est montrÃ© par les tables de tampons, c'est-Ã -dire que jusqu'Ã  3 000 QPS, vous n'aurez aucun problÃ¨me avec l'insertion.  Il est clair que si l'alimentation a Ã©tÃ© perdue sur le serveur, les donnÃ©es peuvent Ãªtre perdues, car elles n'ont Ã©tÃ© stockÃ©es qu'en mÃ©moire. <br><br><img src="https://habrastorage.org/webt/4p/rg/l1/4prgl1wcijnrxs6zcgz2gmybvec.jpeg"><br><br>  Dans le mÃªme temps, le schÃ©ma avec le tampon est compliquÃ© par ALTER, car vous devez d'abord supprimer l'ancienne table de tampon avec l'ancien schÃ©ma (les donnÃ©es ne seront pas perdues en mÃªme temps, car elles seront vidÃ©es avant la suppression de la table).  Ensuite, vous "modifiez" la table dont vous avez besoin et crÃ©ez Ã  nouveau la table tampon.  Par consÃ©quent, bien qu'il n'y ait pas de table tampon, vos donnÃ©es ne circulent nulle part, mais vous pouvez mÃªme localement sur disque. <br><br><img src="https://habrastorage.org/webt/nv/vx/ek/nvvxekkpy2bcezjpuylifhcworq.jpeg"><br><br><h3>  Qu'est-ce que Kittenhouse et comment Ã§a marche? </h3><br>  Qu'est-ce que KittenHouse?  Ceci est un proxy.  Devinez quelle langue?  J'ai rassemblÃ© les sujets les plus hype dans mon rapport - c'est Â«ClickhouseÂ», allez, je me souviens peut-Ãªtre d'autre chose.  Oui, c'est Ã©crit en Go, parce que je ne sais pas vraiment Ã©crire en C, je ne veux pas. <br><br><img src="https://habrastorage.org/webt/6r/1w/th/6r1wthqhe4flw_7t7ww01s5arug.jpeg"><br><br>  En consÃ©quence, il conserve une connexion avec chaque serveur, peut Ã©crire en mÃ©moire.  Par exemple, si nous Ã©crivons des journaux d'erreurs dans Â«ClickhouseÂ», puis si Â«ClickhouseÂ» n'a pas le temps d'insÃ©rer des donnÃ©es (aprÃ¨s tout, si trop sont Ã©crites), alors nous ne gonflons pas de mÃ©moire - nous jetons simplement le reste.  Parce que, si nous Ã©crivons plusieurs gigabits par seconde d'erreurs, nous pouvons probablement en lancer.  Kittenhouse sait comment.  De plus, il sait comment livrer de maniÃ¨re fiable, c'est-Ã -dire qu'il Ã©crit sur un disque sur la machine locale et de temps en temps (lÃ , une fois en quelques secondes), il essaie de fournir des donnÃ©es Ã  partir de ce fichier.  Et au dÃ©but, nous avons utilisÃ© le format Values â€‹â€‹habituel - pas un format binaire, un format texte (comme dans le SQL standard). <br><br><img src="https://habrastorage.org/webt/rj/2q/z3/rj2qz3hcwcur_lvha_tc2mxjpwq.jpeg"><br><br>  Mais c'est arrivÃ©.  Nous avons utilisÃ© une livraison fiable, Ã©crit des journaux, puis dÃ©cidÃ© (c'Ã©tait un cluster de test conditionnel) ... Pendant plusieurs heures, ils l'ont Ã©teint et retirÃ©, et il y avait un insert de milliers de serveurs - il s'est avÃ©rÃ© que le Clickhouse avait toujours un Â«Thread on connexion Â»- en consÃ©quence, sur mille connexions, l'insert actif entraÃ®ne une charge moyenne sur le serveur d'environ mille et demi.  Ã‰tonnamment, le serveur a acceptÃ© les demandes, mais ces donnÃ©es ont nÃ©anmoins Ã©tÃ© insÃ©rÃ©es aprÃ¨s un certain temps;  mais il Ã©tait trÃ¨s difficile pour le serveur de le rÃ©parer ... <br><br><h3>  Ajouter nginx </h3><br>  Une telle solution pour le modÃ¨le Thread per connection est nginx.  Nous avons mis nginx devant le Clickhouse, en mÃªme temps rÃ©glÃ© l'Ã©quilibrage Ã  deux rÃ©pliques (nous avons augmentÃ© la vitesse d'insertion de 2 fois, mais pas le fait qu'il devrait en Ãªtre ainsi), et limitÃ© le nombre de connexions Ã  Clickhouse, Ã  l'amont et, par consÃ©quent, plus que dans 50 composÃ©s, il semble inutile d'insÃ©rer. <br><br><img src="https://habrastorage.org/webt/7i/ib/9b/7iib9bduvmhr6taouopwj20zzsu.jpeg"><br><br>  Ensuite, nous avons rÃ©alisÃ© qu'en gÃ©nÃ©ral, ce schÃ©ma prÃ©sente des inconvÃ©nients, car nous avons un nginx ici.  En consÃ©quence, si ce nginx se couche, malgrÃ© la prÃ©sence de rÃ©pliques, nous perdons des donnÃ©es ou, du moins, n'Ã©crivons nulle part.  Par consÃ©quent, nous avons fait notre rÃ©partition de charge.  Nous avons Ã©galement compris que Â«ClickhouseÂ» est toujours adaptÃ© aux journaux, et le Â«dÃ©monÂ» a Ã©galement commencÃ© Ã  Ã©crire ses propres journaux dans Â«ClickhouseÂ» - trÃ¨s pratique, pour Ãªtre honnÃªte.  Nous l'utilisons toujours pour d'autres "dÃ©mons". <br><br><img src="https://habrastorage.org/webt/px/o4/v3/pxo4v3tnrrxwye_tjavgb2p3kgu.jpeg"><br><br>  Ensuite, ils ont dÃ©couvert un problÃ¨me si intÃ©ressant: si vous utilisez une mÃ©thode pas tout Ã  fait standard pour insÃ©rer en mode SQL, alors un analyseur Ã  part entiÃ¨re AST SQL est forcÃ©, ce qui est plutÃ´t lent.  En consÃ©quence, nous avons ajoutÃ© des paramÃ¨tres pour que cela ne se produise jamais.  Nous avons fait l'Ã©quilibrage de charge, des bilans de santÃ©, de sorte que si l'on dÃ©cÃ¨de, nous laissons toujours des donnÃ©es.  Nous avons obtenu suffisamment de tables pour que nous ayons besoin de diffÃ©rents clusters Â«ClickhouseÂ».  Et nous avons commencÃ© Ã  penser Ã  d'autres utilisations - par exemple, nous voulions Ã©crire des journaux Ã  partir de modules nginx, et ils ne peuvent pas communiquer Ã  l'aide de notre RPC.  Eh bien, je voudrais leur apprendre en quelque sorte comment envoyer - par exemple, via UDP pour recevoir des Ã©vÃ©nements sur localhost, puis les envoyer au Â«ClickhouseÂ». <br><br><h3>  Un pas de la dÃ©cision </h3><br>  Le schÃ©ma final a commencÃ© Ã  ressembler Ã  ceci (la quatriÃ¨me version de ce schÃ©ma): sur chaque serveur devant le Clickhouse, il y a nginx (sur le mÃªme serveur, en plus) et il envoie simplement des requÃªtes par proxy Ã  l'hÃ´te local avec une limite sur le nombre de connexions de 50 piÃ¨ces.  Et maintenant, ce schÃ©ma fonctionnait dÃ©jÃ , il Ã©tait assez bon avec lui. <br><br><img src="https://habrastorage.org/webt/co/ea/sw/coeaswk1ttzg--hk_nz-exq19l0.jpeg"><br><br>  Nous avons vÃ©cu comme Ã§a pendant environ un mois.  Tout le monde Ã©tait content, ajouter des tables, ajouter, ajouter ... En gÃ©nÃ©ral, il s'est avÃ©rÃ© que la faÃ§on dont nous avons ajoutÃ© des tables tampons n'Ã©tait pas trÃ¨s optimale (disons-le).  Nous avons fait 16 piÃ¨ces dans chaque table et un intervalle flash pendant quelques secondes;  nous avions 20 tables et 8 insertions par seconde sont allÃ©es Ã  chaque table - et Ã  ce moment le Â«ClickhouseÂ» a commencÃ© ... les enregistrements ont commencÃ© Ã  devenir vierges.  Ils n'ont mÃªme pas rÃ©ussi ... Nginx avait une chose si intÃ©ressante par dÃ©faut que si les connexions se terminaient en amont, cela donne simplement "502" Ã  toutes les nouvelles demandes. <br><br><img src="https://habrastorage.org/webt/wd/b-/ih/wdb-ihhsype-ykkjymstxzlq27q.jpeg"><br><br>  Et ici chez nous (je viens de regarder les journaux dans le trÃ¨s Â«ClickhouseÂ» que j'ai regardÃ©) quelque part environ un demi pour cent des demandes Ã©choue.  En consÃ©quence, l'utilisation du disque Ã©tait Ã©levÃ©e, il y avait de nombreuses fusions.  Eh bien, qu'ai-je fait?  Naturellement, je n'ai pas commencÃ© Ã  comprendre pourquoi la connexion et l'amont se terminent. <br><br><h3>  Remplacement de nginx par un proxy inverse </h3><br>  J'ai dÃ©cidÃ© que nous devons gÃ©rer cela nous-mÃªmes, ne le donnez pas Ã  nginx - nginx ne sait pas quelles tables sont dans le "Clickhouse", et j'ai remplacÃ© nginx par un proxy inverse, que j'ai Ã©galement Ã©crit. <br><br><img src="https://habrastorage.org/webt/7u/pv/ve/7upvvezqfizgs73uazcnuqz8edm.jpeg"><br><br>  Que fait-il?  Il fonctionne sur la base de la bibliothÃ¨que fasthttp "goosh", c'est-Ã -dire rapide, presque aussi rapide que nginx.  DÃ©solÃ©, Igor, si vous Ãªtes ici (note: Igor Sysoev est un programmeur russe qui a crÃ©Ã© le serveur Web nginx).  Il peut comprendre de quel type de requÃªtes il s'agit - INSERT ou SELECT - respectivement, il conserve diffÃ©rents pools de connexions pour diffÃ©rents types de requÃªtes. <br><br><img src="https://habrastorage.org/webt/ub/q1/43/ubq143ugu8fsrxicwobmwn8veni.jpeg"><br><br>  Par consÃ©quent, mÃªme si nous n'avons pas le temps de rÃ©pondre aux demandes, les "sÃ©lections" passeront, et vice versa.  Et il regroupe les donnÃ©es dans des tables tampons - avec un petit tampon: s'il y avait des erreurs, des erreurs de syntaxe, etc. - afin qu'elles influencent lÃ©gÃ¨rement le reste des donnÃ©es, parce que lorsque nous insÃ©rions simplement dans les tables tampons, nous avions de petites Â« bachi â€, et toutes les erreurs de syntaxe n'ont affectÃ© que ce petit morceau;  et ici, ils affecteront dÃ©jÃ  le grand tampon.  Petit est 1 mÃ©gaoctet, c'est-Ã -dire pas si petit. <br><br><img src="https://habrastorage.org/webt/16/zx/hh/16zxhh_8qun8kzdyjd3i3ysnxzs.jpeg"><br><br>  L'insertion d'une synchronisation et le remplacement de nginx font essentiellement la mÃªme chose que nginx auparavant - le Kittenhouse n'a pas besoin d'Ãªtre changÃ© localement pour cela.  Et comme il utilise fasthttp, il est trÃ¨s rapide - vous pouvez effectuer plus de 100 000 requÃªtes par seconde d'insertions simples via des proxy inverses.  ThÃ©oriquement, vous pouvez insÃ©rer une ligne dans un proxy inverse kittenhouse, mais ce n'est certainement pas le cas. <br><br><img src="https://habrastorage.org/webt/dv/u5/w8/dvu5w8totg6sa3wexahrky4xcsu.jpeg"><br><br>  Le schÃ©ma a commencÃ© Ã  ressembler Ã  ceci: Kittenhouse, un proxy inverse regroupe de nombreuses demandes dans des tables, et Ã  son tour, les tables tampons les insÃ¨rent dans les principales. <br><br><h3>  Killer - solution temporaire, Chaton - permanent </h3><br>  Il y avait un problÃ¨me si intÃ©ressant ... Avez-vous utilisÃ© fasthttp?  Qui a utilisÃ© fasthttp avec les requÃªtes POST?  Probablement, cela ne valait pas la peine en fait, car il met en mÃ©moire tampon le corps de la demande par dÃ©faut, et nous avons dÃ©fini la taille de la mÃ©moire tampon de 16 mÃ©gaoctets.  L'insert a cessÃ© d'Ãªtre Ã  temps Ã  un moment donnÃ©, et de tous les dizaines de milliers de serveurs, des morceaux de 16 mÃ©gaoctets ont commencÃ© Ã  entrer, et ils ont tous Ã©tÃ© mis en mÃ©moire tampon avant d'Ãªtre envoyÃ©s au Clickhouse.  En consÃ©quence, la mÃ©moire s'est Ã©puisÃ©e, le tueur hors mÃ©moire est venu, a tuÃ© le proxy inverse (ou Â«ClickhouseÂ», qui pourrait thÃ©oriquement Â«mangerÂ» plus que le proxy inverse).  Le cycle a Ã©tÃ© rÃ©pÃ©tÃ©.  Pas un trÃ¨s beau problÃ¨me.  Bien que nous ne soyons tombÃ©s sur cela qu'aprÃ¨s quelques mois de fonctionnement. <br><br>  Qu'ai-je fait?  Encore une fois, je n'aime pas vraiment comprendre ce qui s'est exactement passÃ©.  Il me semble assez Ã©vident qu'il n'est pas nÃ©cessaire de mettre en mÃ©moire tampon.  Je n'ai pas pu patcher fasthttp, bien que j'aie essayÃ©.  Mais j'ai trouvÃ© un moyen de faire en sorte qu'il n'y ait pas besoin de patcher quoi que ce soit, et j'ai trouvÃ© ma propre mÃ©thode dans HTTP - appelÃ©e KITTEN.  Eh bien, c'est logique - "VK", "Kitten" ... Comment sinon? .. <br><br><img src="https://habrastorage.org/webt/o9/r5/cu/o9r5cugeck0dm4gc_macqqzymgg.jpeg"><br><br>  Si une demande arrive au serveur avec la mÃ©thode Kitten, alors le serveur doit rÃ©pondre Â«miaouÂ» - logiquement.  S'il rÃ©pond Ã  cela, alors on pense qu'il comprend ce protocole, puis j'intercepte la connexion (il existe une telle mÃ©thode dans fasthttp), et la connexion passe en mode "brut".  Pourquoi ai-je besoin de Ã§a?  Je veux contrÃ´ler la faÃ§on dont la lecture des connexions TCP se produit.  TCP a une propriÃ©tÃ© merveilleuse: si personne ne lit de ce cÃ´tÃ©, l'enregistrement commence Ã  attendre et la mÃ©moire n'est pas spÃ©cialement dÃ©pensÃ©e pour cela. <br><br>  Et donc j'ai lu quelque part Ã  partir de 50 clients Ã  la fois (de cinquante car cinquante devrait certainement suffire, mÃªme si Ã§a vient d'un autre DC) ... La consommation a diminuÃ© avec cette approche au moins 20 fois, mais honnÃªtement je , Je n'ai pas pu mesurer exactement combien, car il est dÃ©jÃ  inutile (il est dÃ©jÃ  devenu au niveau d'erreur).  Le protocole est binaire, c'est-Ã -dire qu'il y a un nom de table et des donnÃ©es;  il n'y a pas d'en-tÃªte http, donc je n'ai pas utilisÃ© de socket web (je n'ai pas besoin de communiquer avec les navigateurs - j'ai fait un protocole qui correspond Ã  nos besoins).  Et avec lui, tout allait bien. <br><br><h3>  La table tampon est triste </h3><br>  RÃ©cemment, nous sommes tombÃ©s sur une autre caractÃ©ristique intÃ©ressante des tables tampons.  Et ce problÃ¨me est dÃ©jÃ  beaucoup plus douloureux que les autres.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Imaginez cette situation: vous utilisez dÃ©jÃ  activement Â«ClickhouseÂ», vous avez des dizaines de serveurs Â«ClickhouseÂ» et vous avez des requÃªtes qui se lisent depuis trÃ¨s longtemps (par exemple, plus de 60 secondes); </font><font style="vertical-align: inherit;">et vous venez et faites Alter en ce moment ... Et tant que les "sÃ©lections" qui ont commencÃ© avant "Alter" ne sont pas incluses dans ce tableau, "Alter" ne dÃ©marre pas - probablement certaines caractÃ©ristiques du fonctionnement de "Clickhouse" cet endroit. </font><font style="vertical-align: inherit;">Peut-Ãªtre que cela peut Ãªtre corrigÃ©? </font><font style="vertical-align: inherit;">Ou pas?</font></font><br><br><img src="https://habrastorage.org/webt/8w/zp/su/8wzpsufzkqmzafrt9vom83joq2i.jpeg"><br><br>  , ,          ,       .  , , ,   Â«Â»  (      â€“   ,   , ), â€¦     ,    Â«Â» ( -  Â«Â» ) â€“  ,  -   :      (   ,     ),  Â«Â» , - ,         .    ,    Â«Â»,          â€“   . <br><br><img src="https://habrastorage.org/webt/po/om/z0/poomz0as89k3aqxh3pa9xpvrr-4.jpeg"><br><br>     (,   ) â€“     Â«Â» query_thread_log.  ,  -   .    840      (100 ).    ,    (, , ,   ) Â«Â» (inserts).    ,   Â«Â»  â€“     Â«Â»    . ,    â€“     ,       .  Pourquoi?      ,    !   . <br><br><img src="https://habrastorage.org/webt/vg/gm/fl/vggmfl00f3pku7iix3k7dfj_-am.jpeg"><br><br>   ,     ?    Â«Â».  . <br><br><h3>   Â«KitttenHouseÂ» </h3><br>    , ?               .   !    :  ,   ,  -      .          ,       . <br><br><img src="https://habrastorage.org/webt/pd/e0/rd/pde0rdcd8h4mquk684qhfkvmpvq.jpeg"><br><br> ,   Â«Â»,      â€“       ,      (, - )     ,   ,  â€“ . <br><br><img src="https://habrastorage.org/webt/k_/f3/ev/k_f3ev78dpgabrqjogevuzmykvw.jpeg"><br><br>     ?    .   , ,    10  ,    â€“         -,      ,  .  ,    , ,    ,        â€“ ,     Â«Â»,    100         - â€“        ,   ,          ,     .          ,   .     ,    . <br><br>  ,       ,    .    :    ,    - ,  , ,    read only    .   ?   .         â€“  -  , -      â€¦ (   , Â«Â»,  ClickHouse)  ? ?   ,    .       .   :      ,        .        ,      .  . <br><br><h3>    </h3><br>      .      .  ,   -   ?..    Â«Â»? -    â€¦     Â«Â»?  ,   ,        .     ,        .    ,  . <br><br><img src="https://habrastorage.org/webt/qy/ko/ud/qykoudjbl76cbexrko1zcmr_wmy.jpeg"><br><br>    â€“     .     ,   .    ,   : ,     ,     (   ),      â€“ ,   . <br><br><img src="https://habrastorage.org/webt/gp/xa/1f/gpxa1fqutqdl4zr_ngqko2yjpom.jpeg"><br><br>       Sequel Pro,      Â«Â»,   .  : Â«,     -?Â»  ? 2018-?  ,       Â«Â» (MySQL)        ,      Â«Â»,    !       Â«Â»,     â€“  ,  . <br><br><img src="https://habrastorage.org/webt/bj/ei/vf/bjeivfj1rem72hvgi50jemwlwkc.jpeg"><br><br> ,    ,   ,  ,  ,   ,  ,    , affected rows (  ),       .  . <br><br><img src="https://habrastorage.org/webt/gu/qb/d7/guqbd74jb1bppis3vv_nbokkiaq.jpeg"><br><br>   .        Â«Â»,   .  - -  .     . <br><br><h3> Â«Â»    </h3><br>    ,  Â«Â»,     ,     . ,  ,    â€“         .          ,      â€¦ ,    ,     . <br><br><img src="https://habrastorage.org/webt/ty/tn/97/tytn97odgbvky_khyj7abanlhqg.jpeg"><br><br> TCP? ,  Â«Â»   UDP.     TCPâ€¦ , ,   : Â«,   ! ,  UDPÂ». ,  TCP     . ,       ,     â€“  -   ;  ,   . <br><br> Â«Â»  Â«Â»     HighLoad Siberia,       Â« Â»â€¦  ,   â€¦    , ,       .  -  , -   ,    â€“ ,  (     ,   , ).   <a href="https://vk.com/vkbackend">   </a> .  ! Github  <a href="https://github.com/VKCOM/"> </a> .  Â«Â»      . <br><br><img src="https://habrastorage.org/webt/ai/nd/eu/aindeupigrlmumartzyvealbyj4.jpeg"><br><br> <b>:</b> â€“ ,   .   ,          VHS. <br><br> <b>  ( â€“ ):</b> â€“         VHS,     ? <br><br><img src="https://habrastorage.org/webt/w0/b6/zx/w0b6zxe9lcu_9gtaoimopvg8eyy.jpeg"><br><br> <b>:</b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Vous aussi, vous ne pouvez pas dÃ©terminer complÃ¨tement comment le Clickhouse fonctionnera ou ne fonctionnera pas!" </font><font style="vertical-align: inherit;">Amis, 5 minutes pour les questions!</font></font><br><br><h3>  Des questions </h3><br>  <b>Question du public (ci-aprÃ¨s - H):</b> - Bonjour.  Merci beaucoup pour le rapport.  J'ai deux questions.  Je vais commencer par une frivole: le nombre de lettres t du nom Â«KittenhouseÂ» sur les schÃ©mas (3, 4, 7 ...) affecte-t-il la satisfaction des chats? <br><br>  <b>UN:</b> - La quantitÃ© de quoi? <br><br>  <b>Z:</b> - Les lettres t.  Il y en a trois t, quelque part trois t. <br><br>  <b>UN:</b> - Ai-je vraiment corrigÃ© cela?  Bien sÃ»r que oui!  Ce sont des produits diffÃ©rents - je vous ai menti tout le temps.  D'accord, je plaisante - ce n'est pas le cas.  Ah, ici!  Non, c'est la mÃªme chose, je suis scellÃ©. <br><br><img src="https://habrastorage.org/webt/fm/4c/ju/fm4cju6vnwwqvpm2o0exqllhsra.jpeg"><br><br>  <b>Z:</b> - Merci.  La deuxiÃ¨me question est sÃ©rieuse.  Pour autant que je sache, dans Â«ClickhouseÂ», les tables tampons vivent exclusivement en mÃ©moire, elles ne sont pas mises en mÃ©moire tampon sur le disque et, par consÃ©quent, ne sont pas persistantes. <br><br>  <b>UN:</b> - Oui. <br><br>  <b>Z:</b> - Et en mÃªme temps, sur votre client, une mise en mÃ©moire tampon sur le disque est effectuÃ©e, ce qui implique une certaine garantie de livraison de ces mÃªmes journaux.  Mais au Clickhouse, ce n'est pas garanti.  Expliquez comment la garantie est exÃ©cutÃ©e, pour quelle raison? .. Ce mÃ©canisme est plus dÃ©taillÃ© <br><br>  <b>UN:</b> - Oui, thÃ©oriquement, il n'y a pas de contradictions, car vous pouvez dÃ©tecter un million de faÃ§ons diffÃ©rentes en rÃ©alitÃ© lorsque le Â«ClickhouseÂ» tombe.  Si le Â«ClickhouseÂ» plante (s'il n'est pas correctement complÃ©tÃ©), vous pouvez, en gros, rembobiner votre journal que vous avez notÃ© un peu et recommencer Ã  partir du moment oÃ¹ tout allait bien.  Rembobinons il y a une minute, c'est-Ã -dire, on pense qu'il a tout flashÃ© en une minute. <br><br>  <b>Z:</b> - Autrement dit, le Kittenhouse garde la fenÃªtre plus longue et en cas de chute peut-elle la reconnaÃ®tre et la dÃ©rouler? <br><br>  <b>UN:</b> - Mais c'est en thÃ©orie.  En pratique, nous ne le faisons pas et la livraison fiable est de zÃ©ro Ã  l'infini.  Mais en moyenne.  Nous sommes convaincus que si le Â«ClickhouseÂ» plante pour une raison quelconque ou que les serveurs Â«redÃ©marrentÂ», nous perdons un peu.  Dans tous les autres cas, rien ne se passera. <br><br>  <b>Z:</b> - Bonjour.  DÃ¨s le dÃ©but, il m'a semblÃ© que vous utiliseriez vraiment UDP dÃ¨s le dÃ©but du rapport.  Vous avez http, tout Ã§a ... Et la plupart des problÃ¨mes que vous avez dÃ©crits, si je comprends bien, ont Ã©tÃ© causÃ©s par cette solution particuliÃ¨re ... <br><br>  <b>UN:</b> - Qu'utilisons-nous TCP? <br><br>  <b>Z:</b> - En fait, oui. <br><br>  <b>ONU:</b> - Non. <br><br>  <b>Z:</b> - C'est avec fasthttp que vous avez eu des problÃ¨mes, avec la connexion vous avez eu des problÃ¨mes.  Si vous venez d'utiliser UDP, vous gagneriez du temps.  Eh bien, il y aurait des problÃ¨mes avec les longs messages ou autre chose ... <br><br>  <b>UN:</b> - Avec quoi? <br><br><img src="https://habrastorage.org/webt/zl/pe/qj/zlpeqjirfmjnmnfkz-tmzmpnbia.jpeg"><br><br>  <b>Z:</b> - Avec de longs messages, car il peut ne pas rentrer dans le MTU, autre chose ... Eh bien, lÃ , vos problÃ¨mes peuvent survenir.  La question est: pourquoi n'est-ce pas UDP? <br><br>  <b>UN:</b> - Je pense que les auteurs qui ont dÃ©veloppÃ© TCP / IP sont beaucoup plus intelligents que moi et savent mieux sÃ©rialiser les paquets (pour qu'ils aillent), en mÃªme temps ajuster la fenÃªtre d'envoi, ne pas surcharger le rÃ©seau et donner des commentaires sur ce lit, sans compter de l'autre cÃ´tÃ© ... Tous ces problÃ¨mes, Ã  mon avis, seraient Ã©galement dans UDP, seulement je devrais Ã©crire encore plus de code que je l'ai dÃ©jÃ  Ã©crit afin d'implÃ©menter la mÃªme chose moi-mÃªme et trÃ¨s probablement ce serait mauvais.  Je n'aime mÃªme pas Ã©crire en C, pas comme Ã§a ... <br><br>  <b>Z:</b> - Tout simplement pratique!  EnvoyÃ© ok et n'attendez rien - vous avez absolument asynchrone.  Un avis est revenu que tout va bien - cela signifie qu'il est venu;  n'est pas venu - cela signifie mauvais. <br><br>  <b>UN:</b> - J'ai besoin de cela et d'un autre - Je dois pouvoir envoyer les deux avec une garantie de livraison et sans garantie de livraison.  Ce sont deux scÃ©narios diffÃ©rents.  Certains journaux que je n'ai pas besoin de perdre ou de ne pas perdre dans des limites raisonnables. <br><br>  <b>Z:</b> - Je ne prendrai pas de temps.  Cela devrait Ãªtre discutÃ© plus longtemps.  Je vous remercie <br><br>  <b>PrÃ©sentateur:</b> - Qui a des questions - des stylos dans le ciel! <br><br><img src="https://habrastorage.org/webt/ip/mz/l7/ipmzl72i77pluuukxeyuxpqeob0.jpeg"><br><br>  <b>Z:</b> - Salut, je suis Sasha.  Quelque part au milieu du rapport, il y avait le sentiment qu'il Ã©tait possible, outre TCP, d'utiliser une solution toute faite - une sorte de Kafka. <br><br>  <b>UN:</b> "Eh bien ... je vous ai dit que je ne voulais pas utiliser de serveurs intermÃ©diaires, parce que ... pour Kafka - il se trouve que nous avons dix mille hÃ´tes;  en fait, nous avons plus - des dizaines de milliers d'hÃ´tes.  Avec Kafka, sans procuration, cela peut aussi faire mal.  De plus, plus important encore, il donne toujours une "latence", donne les hÃ´tes supplÃ©mentaires dont vous avez besoin.  Et je ne veux pas les avoir - je veux ... <br><br>  <b>Z:</b> - Mais finalement Ã§a s'est avÃ©rÃ© quand mÃªme. <br><br>  <b>UN:</b> - Non, il n'y a pas d'hÃ´tes!  Tout fonctionne sur les hÃ´tes Clickhouse. <br><br>  <b>Z:</b> - Mais qu'en est-il du Kittenhouse, dont l'inverse est - oÃ¹ vit-il? <br><br><img src="https://habrastorage.org/webt/bn/ew/lk/bnewlk0ozew0rhhlgtdwhkhjfcu.jpeg"><br><br>  <b>UN:</b> - Chez l'hÃ´te de Klickhouse, il n'Ã©crit rien sur le disque. <br><br>  <b>Z:</b> - Eh bien, disons. <br><br>  <b>PrÃ©sentateur:</b> - Vous satisfait?  Pouvons-nous donner un salaire? <br><br>  <b>Z:</b> - Oui, oui.  En fait, il y a beaucoup de bÃ©quilles pour obtenir la mÃªme chose, et maintenant - la rÃ©ponse prÃ©cÃ©dente sur le sujet du TCP contredit, Ã  mon avis, cette situation.  C'est comme si vous pouviez tout faire sur votre genou en beaucoup moins de temps. <br><br>  <b>ONU:</b> - Et pourquoi n'ai-je pas voulu utiliser "Kafka", car il y avait beaucoup de plaintes dans le tÃ©lÃ©gramme "Clickhouse" dans Telegram, par exemple, des messages de "Kafka" ont Ã©tÃ© perdus.  Pas de Kafka elle-mÃªme, mais dans l'intÃ©gration de Kafka et Klikhaus;  ou quelque chose ne s'y connectait pas.  En gros, il faudrait alors que le client Ã©crive alors Ã  Kafka.  Je ne pense pas qu'une solution plus simple et plus fiable serait obtenue. <br><br>  <b>Z:</b> - Dites-moi, pourquoi n'avez-vous pas essayÃ© des lignes ou un bus commun?  Puisque vous dites qu'il Ã©tait possible avec vous de maniÃ¨re asynchrone de parcourir la file d'attente les journaux eux-mÃªmes et Ã©galement d'obtenir de maniÃ¨re asynchrone la file d'attente en rÃ©ponse? <br><br><img src="https://habrastorage.org/webt/pn/4q/sz/pn4qszihp9ejs5aoua8swthjrqk.jpeg"><br><br>  <b>UN:</b> - Veuillez suggÃ©rer quelles files d'attente pourraient Ãªtre utilisÃ©es? <br><br>  <b>Z:</b> - Tout, mÃªme sans garantie qu'ils vont dans l'ordre.  Tout Redis, RMQ ... <br><br>  <b>UN:</b> - J'ai le sentiment que Redis ne sera probablement pas en mesure de tirer un tel volume d'insertion mÃªme sur un hÃ´te (dans le sens de plusieurs serveurs) qui sort le Clickhouse.  Je ne peux pas le confirmer avec des preuves (je ne l'ai pas comparÃ©), mais il me semble que Redis n'est pas la meilleure solution ici.  En principe, vous pouvez considÃ©rer ce systÃ¨me comme une file d'attente de messages impromptue, mais uniquement pour Â«ClickhouseÂ» <br><br>  <b>PrÃ©sentateur:</b> - Yuri, merci beaucoup.  Je propose de terminer les questions et rÃ©ponses Ã  ce sujet et de dire laquelle des personnes qui ont posÃ© la question nous donnera un livre. <br><br>  <b>ONU:</b> - Je voudrais donner un livre Ã  la premiÃ¨re personne qui a posÃ© une question. <br><br>  <b>PrÃ©sentateur:</b> - Super!  Super!  Super!  Merci beaucoup! <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/pbbcMcrQoXw" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><h3>  Un peu de publicitÃ© :) </h3><br>  Merci de rester avec nous.  Aimez-vous nos articles?  Vous voulez voir des matÃ©riaux plus intÃ©ressants?  Soutenez-nous en passant une commande ou en recommandant Ã  vos amis <a href="https://ua-hosting.company/cloudvps/nl">des VPS basÃ©s sur le cloud pour les dÃ©veloppeurs Ã  partir de 4,99 $</a> , un <b>analogue unique de serveurs d'entrÃ©e de gamme que nous avons inventÃ©s pour vous:</b> <a href="https://habr.com/company/ua-hosting/blog/347386/">Toute la vÃ©ritÃ© sur les VPS (KVM) E5-2697 v3 (6 cÅ“urs) 10 Go DDR4 480 Go SSD 1 Gbit / s Ã  partir de 19 $ ou comment diviser le serveur?</a>  (les options sont disponibles avec RAID1 et RAID10, jusqu'Ã  24 cÅ“urs et jusqu'Ã  40 Go de DDR4). <br><br>  <b>Dell R730xd 2 fois moins cher au centre de donnÃ©es Equinix Tier IV Ã  Amsterdam?</b>  Nous avons seulement <b><a href="https://ua-hosting.company/serversnl">2 x Intel TetraDeca-Core Xeon 2x E5-2697v3 2.6GHz 14C 64GB DDR4 4x960GB SSD 1Gbps 100 TV Ã  partir de 199 $</a> aux Pays-Bas!</b>  <b><b>Dell R420 - 2x E5-2430 2.2Ghz 6C 128GB DDR3 2x960GB SSD 1Gbps 100TB - Ã  partir de 99 $!</b></b>  Pour en savoir plus sur la <a href="https://habr.com/company/ua-hosting/blog/329618/">crÃ©ation d'un bÃ¢timent d'infrastructure</a>  <a href="https://habr.com/company/ua-hosting/blog/329618/">classe utilisant des serveurs Dell R730xd E5-2650 v4 coÃ»tant 9 000 euros pour un sou?</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr483712/">https://habr.com/ru/post/fr483712/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr483688/index.html">Environ 30 fois plus de concurrence dans Node.js</a></li>
<li><a href="../fr483698/index.html">Comment LoRaWAN aide Ã  construire un Internet des objets moderne</a></li>
<li><a href="../fr483700/index.html">RÃ©sultats physiques de l'annÃ©e - 2019</a></li>
<li><a href="../fr483704/index.html">Ã‰vÃ©nements numÃ©riques Ã  Moscou du 13 au 19 janvier</a></li>
<li><a href="../fr483706/index.html">IdÃ©es d'applications pour gÃ©nÃ©rer des revenus pour les startups en 2019 et au-delÃ </a></li>
<li><a href="../fr483714/index.html">Prix â€‹â€‹et concours pour des projets innovants. ExpÃ©rience des vendeurs mondiaux</a></li>
<li><a href="../fr483716/index.html">Utilisation de Vulnerability Scanner dans les bibliothÃ¨ques de vÃ©rification des dÃ©pendances utilisÃ©es dans GitlabCI</a></li>
<li><a href="../fr483718/index.html">Comment VDI transforme l'environnement de bureau</a></li>
<li><a href="../fr483720/index.html">Ce qui nous a apportÃ© Pandas 1.0</a></li>
<li><a href="../fr483722/index.html">GÃ©oanalytique dans le commerce de dÃ©tail, partie 1: nous automatisons le processus de choix d'un lieu pour une entreprise. 2GIS + MS Azure + ML</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>