<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëºüèæ üñêüèø üë¶üèΩ Implementaci√≥n del sistema de componentes de entidad m√°s simple üë©üèæ‚Äç‚úàÔ∏è üâê üêÑ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hola a todos! 

 Aqu√≠ comienza la cuarta transmisi√≥n "C ++ Developer" , uno de los cursos m√°s activos en nuestro pa√≠s, a juzgar por reuniones reales, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Implementaci√≥n del sistema de componentes de entidad m√°s simple</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/422981/">  Hola a todos! <br><br>  Aqu√≠ comienza la cuarta transmisi√≥n <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">"C ++ Developer"</a> , uno de los cursos m√°s activos en nuestro pa√≠s, a juzgar por reuniones reales, donde no solo los "cruzados" vienen a hablar con <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Dima Shebordaev</a> :) En general, el curso ya ha crecido uno de los m√°s grandes en nuestro pa√≠s, se ha mantenido sin cambios que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Dima</a> conduce lecciones abiertas y seleccionamos materiales interesantes antes del comienzo del curso. <br><br>  Vamos! <br><br><h3>  Entrada </h3><br>  El Sistema de componentes de la entidad (ECS, "sistema de componentes de la entidad") est√° ahora en la cima de la popularidad como una alternativa arquitect√≥nica que enfatiza el principio de Composici√≥n sobre la herencia.  En este art√≠culo, no entrar√© en los detalles del concepto, ya que ya hay suficientes recursos sobre este tema.  Hay muchas formas de implementar ECS, y, con mucha frecuencia, elijo otras bastante complejas que pueden confundir a los principiantes y tomar mucho tiempo. <br><br>  En esta publicaci√≥n, describir√© una forma muy simple de implementar ECS, cuya versi√≥n funcional casi no requiere c√≥digo, pero sigue completamente el concepto. <br><br><img src="https://habrastorage.org/webt/6s/g8/jk/6sg8jksoaekqfccdwlnma-rbz0w.png"><a name="habracut"></a><br><br><h3>  ECS </h3><br>  Hablando de ECS, las personas a menudo quieren decir cosas diferentes.  Cuando hablo de ECS, me refiero a un sistema que le permite definir entidades que tienen cero o m√°s componentes de datos puros.  Estos componentes son procesados ‚Äã‚Äãselectivamente por sistemas l√≥gicos puros.  Por ejemplo, la posici√≥n, la velocidad, el hitbox y la salud de un componente est√°n vinculados a la entidad E.  Simplemente almacenan datos en s√≠ mismos.  Por ejemplo, un componente de salud puede almacenar dos enteros: uno para el estado actual y otro para el m√°ximo.  Un sistema puede ser un sistema de regeneraci√≥n de salud que encuentra todas las instancias de un componente de salud y las aumenta en 1 cada 120 cuadros. <br><br><h3>  Implementaci√≥n t√≠pica de C ++ </h3><br>  Hay muchas bibliotecas que ofrecen implementaciones de ECS.  Por lo general, incluyen uno o m√°s elementos de la lista: <br><br><ul><li> Herencia del componente / sistema base de la clase <code>GravitySystem : public ecs::System</code> ; </li><li>  Uso activo de plantillas; </li><li>  Tanto eso como otro en un aspecto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">CRTP</a> ; </li><li>  La clase <code>EntityManager</code> , que controla la creaci√≥n / almacenamiento de entidades de manera impl√≠cita. </li></ul><br>  Algunos ejemplos r√°pidos de google: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">entidadx de alecthomas</a> ; </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ECS de redxdev</a> ; </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Google Corgi</a> (as√≠ que descubr√≠ que Google tiene una implementaci√≥n de ECS). </li></ul><br>  Todos estos m√©todos tienen derecho a la vida, pero hay algunos inconvenientes en ellos.  La forma en que procesan los datos de manera opaca significa que ser√° dif√≠cil entender lo que est√° sucediendo dentro y si se ha producido una desaceleraci√≥n del rendimiento.  Tambi√©n significa que debe estudiar toda la capa de abstracci√≥n y asegurarse de que se ajuste bien al c√≥digo existente.  No se olvide de los errores ocultos, que probablemente est√°n ocultos mucho en la cantidad de c√≥digo que debe depurar. <br><br>  Un enfoque basado en plantillas puede afectar en gran medida el tiempo de compilaci√≥n y la frecuencia con la que tendr√° que reconstruir la compilaci√≥n.  Si bien los conceptos basados ‚Äã‚Äãen la herencia pueden degradar el rendimiento. <br><br>  La raz√≥n principal por la que creo que estos enfoques son excesivos es que el problema que resuelven es demasiado simple.  Al final, estos son solo componentes de datos adicionales asociados con la entidad y su procesamiento selectivo.  A continuaci√≥n, mostrar√© una forma muy simple de c√≥mo se puede implementar esto. <br><br><h3>  Mi enfoque simple </h3><br>  <i>Esencia</i> <br><br>  En algunos enfoques, la clase Entity est√° definida, en otros, trabajan con entidades como ID / handle.  En un enfoque por componentes, una entidad no es m√°s que los componentes asociados con ella, y para esto no se necesita una clase.  Una entidad existir√° expl√≠citamente en funci√≥n de sus componentes relacionados.  Para hacer esto, defina: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> EntityID = <span class="hljs-keyword"><span class="hljs-keyword">int64_t</span></span>; <span class="hljs-comment"><span class="hljs-comment">//    , int64_t -  </span></span></code> </pre> <br>  <i>Componentes de entidad</i> <br><br>  Los componentes son diferentes tipos de datos asociados con entidades existentes.  Podemos decir que para cada entidad e, e tendr√° cero y m√°s tipos de componentes accesibles.  En esencia, esta es una relaci√≥n clave-valor explotada y, afortunadamente, existen herramientas de biblioteca est√°ndar en forma de tarjetas para esto. <br><br>  Entonces, defino los componentes de la siguiente manera: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Position</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> x; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> y; }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Velocity</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> x; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> y; }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Health</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> max; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> current; }; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Type&gt; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> ComponentMap = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">unordered_map</span></span>&lt;EntityID, Type&gt;; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Positions = ComponentMap&lt;Position&gt;; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Velocities = ComponentMap&lt;Velocity&gt;; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Healths = ComponentMap&lt;Health&gt;; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Components</span></span></span><span class="hljs-class"> {</span></span> Positions positions; Velocities velocities; Healths healths; };</code> </pre> <br>  Esto es suficiente para indicar entidades a trav√©s de componentes, como se esperaba de ECS.  Por ejemplo, para crear una entidad con una posici√≥n y salud, pero sin velocidad, necesita: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//given a Components instance c EntityID newID = /*obtain new entity ID*/; c.positions[newID] = Position{0.0f, 0.0f}; c.healths[newID] = Health{100, 100};</span></span></code> </pre><br>  Para destruir una entidad con una ID dada, simplemente <code>.erase()</code> de cada tarjeta. <br><br>  <i>Sistemas</i> <br><br>  El √∫ltimo componente que necesitamos son los sistemas.  Esta es la l√≥gica que funciona con componentes para lograr un comportamiento espec√≠fico.  Como me gusta simplificar las cosas, uso funciones normales.  El sistema de regeneraci√≥n de salud mencionado anteriormente puede ser simplemente la siguiente funci√≥n. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updateHealthRegeneration</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int64_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> currentFrame, Healths&amp; healths)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(currentFrame % <span class="hljs-number"><span class="hljs-number">120</span></span> == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">auto</span></span>&amp; [id, health] : healths) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(health.current &lt; health.max) ++health.current; } } }</code> </pre><br>  Podemos poner la llamada a esta funci√≥n en un lugar apropiado en el bucle principal y transferirla al almacenamiento del componente de salud.  Dado que el repositorio de salud contiene solo registros de entidades que tienen salud, puede procesarlos de forma aislada.  Tambi√©n significa que la funci√≥n toma solo los datos necesarios y no toca lo irrelevante. <br><br>  Pero, ¬øqu√© pasa si el sistema funciona con m√°s de un componente?  Digamos un sistema f√≠sico que cambia de posici√≥n seg√∫n la velocidad.  Para hacer esto, necesitamos intersectar todas las claves de todos los tipos de componentes involucrados e iterar sobre sus valores.  En este punto, la biblioteca est√°ndar ya no es suficiente, pero escribir ayudantes no es tan dif√≠cil.  Por ejemplo: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updatePhysics</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Positions&amp; positions, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Velocities&amp; velocities)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//   ,   N   //   ID,    . std::unordered_set&lt;EntityID&gt; targets = mapIntersection(positions, velocities); // target'     ,   //  ,       . for(EntityID id : targets) { Position&amp; pos = positions.at(id); const Velocity&amp; vel = velocities.at(id); pos.x += vel.x; pos.y += vel.y; } }</span></span></code> </pre> <br>  O puede escribir un ayudante m√°s compacto que permita un acceso m√°s eficiente a trav√©s de la iteraci√≥n en lugar de buscar. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updatePhysics</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Positions&amp; positions, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Velocities&amp; velocities)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//   ,    //  .        //    . intersectionInvoke&lt;Position, Velocity&gt;(positions, velocities, [] (EntityID id, Position&amp; pos, const Velocity&amp; vel) { pos.x += vel.x; pos.y += vel.y; } ); }</span></span></code> </pre> <br>  Por lo tanto, nos familiarizamos con la funcionalidad b√°sica de un ECS regular. <br><br><h3>  Los beneficios </h3><br>  Este enfoque es muy efectivo, ya que est√° construido desde cero sin restringir la abstracci√≥n.  No tiene que integrar bibliotecas externas o adaptar la base del c√≥digo a las ideas predefinidas de lo que deber√≠an ser las Entidades / Componentes / Sistemas. <br>  Y dado que este enfoque es completamente transparente, sobre la base puede crear cualquier utilidad y ayuda.  Esta implementaci√≥n crece con las necesidades de su proyecto.  Lo m√°s probable es que para prototipos simples o juegos para el juego jam'ov, tenga suficiente de la funcionalidad descrita anteriormente. <br><br>  Por lo tanto, si es nuevo en todo este campo de ECS, un enfoque tan sencillo ayudar√° a comprender las ideas principales. <br><br><h3>  Limitaciones </h3><br>  Pero, como con cualquier otro m√©todo, hay algunas limitaciones.  En mi experiencia, es precisamente una implementaci√≥n de este tipo que utiliza <code>unordered_map</code> en cualquier juego no trivial lo que provocar√° problemas de rendimiento. <br><br>  La iteraci√≥n de intersecciones clave en varias instancias de <code>unordered_map</code> con m√∫ltiples entidades no se escala bien porque en realidad est√° haciendo b√∫squedas <code>N*M</code> , donde N es el n√∫mero de componentes superpuestos, M es el n√∫mero de entidades coincidentes y <code>unordered_map</code> no <code>unordered_map</code> muy bueno para el almacenamiento en cach√©.  Este problema se puede solucionar mediante el uso de un almac√©n de valores clave m√°s adecuado para la iteraci√≥n en lugar de <code>unordered_map</code> . <br><br>  Otra limitaci√≥n es la calderer√≠a.  Dependiendo de lo que haga, identificar nuevos componentes puede volverse tedioso.  Es posible que deba agregar un anuncio no solo en la estructura Componentes, sino tambi√©n en la funci√≥n de generaci√≥n, serializaci√≥n, la utilidad de depuraci√≥n, etc.  Me encontr√© con esto y resolv√≠ el problema generando c√≥digo: defin√≠ componentes en archivos json externos y luego gener√© componentes C ++ y funciones auxiliares en la etapa de construcci√≥n.  Estoy seguro de que puede encontrar otros m√©todos basados ‚Äã‚Äãen plantillas para solucionar cualquier problema repetitivo que encuentre. <br><br>  El fin <br><br>  Si tiene preguntas y comentarios, puede dejarlos aqu√≠ o ir a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">una lecci√≥n abierta</a> con <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Dima</a> , escucharlo y preguntar por ah√≠. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es422981/">https://habr.com/ru/post/es422981/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es422969/index.html">Anomal√≠a Frango, Comienzo</a></li>
<li><a href="../es422971/index.html">Sistema experto en rieles</a></li>
<li><a href="../es422973/index.html">Anatom√≠a de un incidente, o c√≥mo trabajar para reducir el tiempo de inactividad</a></li>
<li><a href="../es422977/index.html">Mikhail Bessmeltsev y su colega desarrollaron nuevos algoritmos para vectorizar gr√°ficos</a></li>
<li><a href="../es422979/index.html">An√°logo estadounidense de GDPR: lo que necesita saber sobre el CCPA</a></li>
<li><a href="../es422985/index.html">Inicio r√°pido de un proyecto web (BE - Java Spring, FE - React Redux, interacci√≥n - Rest, WebSocket)</a></li>
<li><a href="../es422987/index.html">Y de nuevo, el d√≠a 256 del a√±o.</a></li>
<li><a href="../es422989/index.html">Una base de datos no es solo un almac√©n de datos</a></li>
<li><a href="../es422993/index.html">Quemando televisores OLED en pruebas reales</a></li>
<li><a href="../es422995/index.html">QA mitap en Redmadrobot</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>