<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®‚Äç‚öïÔ∏è üï∫üèΩ üë®üèæ‚Äçü§ù‚Äçüë®üèº Testando seu aplicativo Go como uma caixa preta com Rspec üë¢ üßëüèø‚Äçü§ù‚Äçüßëüèª ‚òùüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Testes bem escritos reduzem significativamente o risco de "quebrar" o aplicativo ao adicionar um novo recurso ou corrigir um bug. Em sistemas complexo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Testando seu aplicativo Go como uma caixa preta com Rspec</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/427951/">  Testes bem escritos reduzem significativamente o risco de "quebrar" o aplicativo ao adicionar um novo recurso ou corrigir um bug.  Em sistemas complexos que consistem em v√°rios componentes interconectados, o mais dif√≠cil √© testar seu terreno comum. <br><br>  Neste artigo, falarei sobre como encontramos a dificuldade de escrever bons testes ao desenvolver um componente no Go e como resolvemos esse problema usando a biblioteca RSpec no Ruby on Rails. <br><a name="habracut"></a><br><h2>  Adicionando Go √† pilha de tecnologia do projeto </h2><br>  Um dos projetos que a eTeam est√° desenvolvendo, onde trabalho, pode ser dividido em: painel de administra√ß√£o, conta de usu√°rio, gerador de relat√≥rios e solicita√ß√µes de processamento de v√°rios servi√ßos aos quais estamos integrados. <br><br>  A parte respons√°vel pelo processamento de solicita√ß√µes √© a mais importante, ent√£o eu queria torn√°-la o mais confi√°vel e acess√≠vel poss√≠vel.  Como parte de um aplicativo monol√≠tico, ela se arriscava a receber um bug ao alterar se√ß√µes de c√≥digo n√£o relacionadas a ele.  Tamb√©m havia o risco de interromper o processamento ao carregar outros componentes do aplicativo.  O n√∫mero de trabalhadores do Ngnix por aplicativo √© limitado e, √† medida que a carga aumentou, por exemplo, abrindo muitas p√°ginas pesadas no painel de administra√ß√£o, os trabalhadores livres pararam e o processamento de solicita√ß√µes ficou mais lento ou at√© caiu. <br><br>  Esses riscos, bem como a maturidade desse sistema (durante meses n√£o foram necess√°rios altera√ß√µes), tornaram-no um candidato ideal para a separa√ß√£o em um servi√ßo separado. <br>  Foi decidido escrever este servi√ßo separado no Go.  Ele teve que compartilhar o acesso ao banco de dados com o aplicativo Rails.  A responsabilidade por poss√≠veis altera√ß√µes na estrutura da tabela permaneceu no Rails.  Em princ√≠pio, esse esquema com um banco de dados comum funciona bem, enquanto existem apenas dois aplicativos.  Parecia assim: <br><br><img src="https://habrastorage.org/webt/67/19/wy/6719wyo52lzxj3ofrjy4epnitjq.png" alt="imagem"><br><br>  O servi√ßo foi gravado e implantado em inst√¢ncias separadas do Rails.  Agora, ao implantar aplicativos Rails, voc√™ n√£o precisa se preocupar que isso afetaria o processamento de consultas.  O servi√ßo aceitou solicita√ß√µes HTTP diretamente, sem o Ngnix, usou um pouco de mem√≥ria e foi de alguma forma minimalista. <br><br><h2>  O problema com nossos testes de unidade no Go </h2><br>  Os testes de unidade foram implementados no aplicativo Go e todas as consultas ao banco de dados foram bloqueadas.  Entre outros argumentos a favor dessa solu√ß√£o, havia os seguintes: o aplicativo principal do Rails √© respons√°vel pela estrutura do banco de dados, portanto o aplicativo go n√£o ‚Äúpossui‚Äù as informa√ß√µes para a cria√ß√£o de um banco de dados de teste.  O processamento de solicita√ß√µes para metade consistiu em l√≥gica comercial e metade do trabalho com o banco de dados, e essa metade foi completamente bloqueada.  O Moki in Go parece menos "leg√≠vel" do que no Ruby.  Ao adicionar uma nova fun√ß√£o para ler dados do banco de dados, foi necess√°rio adicionar o moki para ele no conjunto de testes que j√° funcionaram anteriormente.  Como resultado, esses testes de unidade foram ineficazes e extremamente fr√°geis. <br><br><h2>  M√©todo de solu√ß√£o </h2><br>  Para eliminar essas defici√™ncias, foi decidido cobrir o servi√ßo com testes funcionais localizados no aplicativo Rails e testar o servi√ßo no Go como uma caixa preta.  Como uma caixa branca, ainda n√£o funcionaria, porque a partir do ruby, mesmo com todo o desejo, seria imposs√≠vel intervir no servi√ßo, por exemplo, obter algum tipo de m√©todo para verificar se √© chamado.  Isso tamb√©m significava que as solicita√ß√µes enviadas pelo servi√ßo testado tamb√©m eram imposs√≠veis de bloquear, portanto, era necess√°rio outro aplicativo para captur√°-las e registr√°-las.  Algo como RequestBin, mas local.  J√° escrevemos um utilit√°rio semelhante, ent√£o o usamos. <br><br>  O seguinte esquema acabou: <br><br><ol><li>  O rspec compila e inicia o servi√ßo em movimento, transmitindo-lhe uma configura√ß√£o, que cont√©m acesso √† base de teste e uma certa porta para receber solicita√ß√µes HTTP, por exemplo 8082 </li><li>  um utilit√°rio tamb√©m √© iniciado para registrar solicita√ß√µes HTTP recebidas nele, na porta 8083 </li><li>  escrevemos testes comuns no RSpec, ou seja,  crie os dados necess√°rios no banco de dados e envie uma solicita√ß√£o para localhost: 8082, como se fosse um servi√ßo externo, por exemplo, usando HTTParty </li><li>  resposta parsim;  verificar altera√ß√µes no banco de dados;  n√≥s obtemos a lista de solicita√ß√µes registradas no "RequestBin" e as verificamos. </li></ol><br><h2>  Detalhes da implementa√ß√£o: </h2><br>  Agora sobre como foi implementado.  Para fins de demonstra√ß√£o, vamos nomear o servi√ßo testado: "TheService" e criar um wrapper para ele: <br><br><pre><code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment">#/spec/support/the_service.rb #ensure that after all specs TheService will be stopped RSpec.configure do |config| config.after :suite do TheServiceControl.stop end end class TheServiceControl class &lt;&lt; self </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@pid</span></span></span><span class="hljs-comment"> = nil </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@config</span></span></span><span class="hljs-comment"> = nil def config puts "Please create file: #{config_path}" unless File.exist?(config_path) </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@config</span></span></span><span class="hljs-comment"> = YAML.load_file(config_path) end def host TheServiceControl.config['server']['addr'] end def config_path Rails.root.join('spec', 'support', 'the_service_config.yml') end def start # will be described below end def stop # will be described below end def post(params, headers) HTTParty.post("http://#{host}/request", body: params, headers: headers ) end end end</span></span></code> </pre> <br>  Por via das d√∫vidas, farei uma reserva de que no Rspec ele deve ser configurado para carregar automaticamente arquivos da pasta "support": <br><br><pre> <code class="ruby hljs">Dir[Rails.root.join(<span class="hljs-string"><span class="hljs-string">'spec/support/**/*.rb'</span></span>)].each {<span class="hljs-params"><span class="hljs-params">|f|</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> f}</code> </pre><br>  O m√©todo de in√≠cio: <br><br><ul><li>  l√™ de uma configura√ß√£o separada o caminho para as origens do TheService e as informa√ß√µes necess√°rias para executar.  Porque  essas informa√ß√µes podem diferir de diferentes desenvolvedores; essa configura√ß√£o √© exclu√≠da do Git.  A mesma configura√ß√£o cont√©m as configura√ß√µes necess√°rias para o lan√ßamento do programa.  Essas configura√ß√µes heterog√™neas est√£o localizadas em um √∫nico local para n√£o produzir arquivos extras. <br></li><li>  compila e executa o programa atrav√©s de "go run {path to main.go} {path to config}" </li><li>  a cada segundo, ele espera at√© que o programa em execu√ß√£o esteja pronto para aceitar solicita√ß√µes <br></li><li>  lembra o identificador do processo para n√£o reiniciar e poder par√°-lo. </li></ul><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment">#/spec/support/the_service.rb class TheServiceControl #.... def start return unless </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@pid</span></span></span><span class="hljs-comment">.nil? puts "TheService starting. " env = config['rails']['env'] cmd = "go run #{config['rails']['main_go']} --config.file=#{config_path}" puts cmd #useful for debug when need run project manually #compile and run Dir.chdir(File.dirname(config['rails']['main_go'])) { </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@pid</span></span></span><span class="hljs-comment"> = Process.spawn(env, cmd, pgroup: true) } #wait until it ready to accept connections VCR.configure { |c| c.allow_http_connections_when_no_cassette = true } 1.upto(10) do response = HTTParty.get("http://#{host}/monitor") rescue nil break if response.try(:code) == 200 sleep(1) end VCR.configure { |c| c.allow_http_connections_when_no_cassette = false } puts "TheService started. PID: #{</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@pid</span></span></span><span class="hljs-comment">}" end #.... end</span></span></code> </pre><br>  configura√ß√£o em si: <br><br><pre> <code class="hljs pgsql">#/spec/support/the_service_config.yml <span class="hljs-keyword"><span class="hljs-keyword">server</span></span>: addr: <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>:<span class="hljs-number"><span class="hljs-number">8082</span></span> db: dsn: dbname=project_test sslmode=<span class="hljs-keyword"><span class="hljs-keyword">disable</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>=postgres <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>=secret redis: url: redis://<span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>:<span class="hljs-number"><span class="hljs-number">6379</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span> rails: main_go: /home/me/go/src/github.com/company/theservice/main.go recorder_addr: <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>:<span class="hljs-number"><span class="hljs-number">8083</span></span> env: <span class="hljs-type"><span class="hljs-type">PATH</span></span>: <span class="hljs-string"><span class="hljs-string">'/home/me/.gvm/gos/go1.10.3/bin'</span></span> GOROOT: <span class="hljs-string"><span class="hljs-string">'/home/me/.gvm/gos/go1.10.3'</span></span> GOPATH: <span class="hljs-string"><span class="hljs-string">'/home/me/go'</span></span></code> </pre><br>  O m√©todo stop simplesmente interrompe o processo.  A novidade √© que o ruby ‚Äã‚Äãexecuta o comando "go run", que executa o bin√°rio compilado em um processo filho cujo ID √© desconhecido.  Se voc√™ simplesmente interromper o processo iniciado pelo ruby, o processo filho n√£o ser√° interrompido automaticamente e a porta permanecer√° ocupada.  Portanto, a parada ocorre pela identifica√ß√£o do grupo de processos: <br><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment">#/spec/support/the_service.rb class TheServiceControl #.... def stop return if </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@pid</span></span></span><span class="hljs-comment">.nil? print "Stopping TheService (PID: #{</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@pid</span></span></span><span class="hljs-comment">}). " Process.kill("KILL", -Process.getpgid(</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@pid</span></span></span><span class="hljs-comment">)) res = Process.wait </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@pid</span></span></span><span class="hljs-comment"> = nil puts "Stopped. #{res}" end #.... end</span></span></code> </pre><br>  Agora, prepararemos um contexto_compartilhado onde definiremos as vari√°veis ‚Äã‚Äãpadr√£o, iniciaremos o TheService se n√£o tiver sido iniciado e desativaremos temporariamente o videocassete (do ponto de vista dele, falamos com um servi√ßo externo, mas para n√≥s agora n√£o √© assim): <br><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment">#spec/support/shared_contexts/the_service_black_box.rb shared_context 'the_service_black_box' do let(:params) do { type: 'save', data: 1 } end let(:headers) { { 'HTTPS' =&gt; 'on', 'Content-Type' =&gt; 'application/json; charset=utf-8' } } subject(:response) { TheServiceControl.post(params, headers)} before(:all) { TheServiceControl.start } around(:each) do |example| VCR.configure { |c| c.allow_http_connections_when_no_cassette = true } example.run VCR.configure { |c| c.allow_http_connections_when_no_cassette = false } end end</span></span></code> </pre><br>  e agora voc√™ pode come√ßar a escrever as especifica√ß√µes: <br><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment">#spec/requests/the_service/ping_spec.rb require 'spec_helper' describe 'ping request' do include_context 'the_service_black_box' it 'returns response back' do params[:type] = 'ping' params[:data] = '123' parsed_response = JSON.parse(response.body) # make request and parse response expect(parsed_response['error']).to be nil expect(parsed_response['result']).to eq '123' expect(Log.count).to eq 1 #check something in DB end # more specs... end</span></span></code> </pre><br>  TheService pode fazer suas solicita√ß√µes HTTP para servi√ßos externos.  Usando a configura√ß√£o, redirecionamos para um utilit√°rio local que os escreve.  Tamb√©m existe um inv√≥lucro para iniciar e parar; √© semelhante √† classe "TheServiceControl", exceto que o utilit√°rio pode simplesmente ser iniciado sem compila√ß√£o. <br><br><h2>  P√£ezinhos extras </h2><br>  O aplicativo Go foi gravado para que todos os logs e informa√ß√µes de depura√ß√£o sejam exibidos em STDOUT.  Quando iniciada na produ√ß√£o, essa sa√≠da √© enviada para um arquivo.  E quando lan√ßado a partir do Rspec, √© exibido no console, o que ajuda bastante na depura√ß√£o. <br><br>  Se as especifica√ß√µes forem executadas seletivamente, para as quais o TheService n√£o √© necess√°rio, ele n√£o ser√° iniciado. <br><br>  Para evitar perder tempo desenvolvendo o servi√ßo sempre que voc√™ reiniciar as especifica√ß√µes durante o desenvolvimento, voc√™ pode iniciar o servi√ßo manualmente no terminal e n√£o deslig√°-lo.  Se necess√°rio, voc√™ pode at√© execut√°-lo no IDE no modo de depura√ß√£o, e as especifica√ß√µes preparam tudo o que voc√™ precisa, emitem uma solicita√ß√£o de servi√ßo, ele p√°ra e voc√™ pode se degradar sem problemas.  Isso torna a abordagem TDD muito conveniente. <br><br><h2>  Conclus√µes </h2><br>  Esse esquema trabalha h√° cerca de um ano e nunca falha.  As especifica√ß√µes s√£o muito mais leg√≠veis que os testes de unidade no Go e n√£o dependem do conhecimento da estrutura interna do servi√ßo.  Se, por algum motivo, precisarmos reescrever o servi√ßo em outro idioma, n√£o precisaremos alterar as especifica√ß√µes, exceto o wrapper, que s√≥ precisa iniciar o servi√ßo de teste com outro comando. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt427951/">https://habr.com/ru/post/pt427951/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt427941/index.html">Implantar o cluster HA do Kubernetes no Baremetal usando o Kubeadm e o Keepalived (guia simples)</a></li>
<li><a href="../pt427943/index.html">Estamos aguardando TVs LG OLED 8K seriais em junho de 2019, o lan√ßamento pode ser adiado</a></li>
<li><a href="../pt427945/index.html">Hipervisor para Leigos</a></li>
<li><a href="../pt427947/index.html">As redes neurais n√£o entendem o que s√£o ilus√µes de √≥tica.</a></li>
<li><a href="../pt427949/index.html">Nossa falta de vontade de mudar nos impede de entender as estat√≠sticas.</a></li>
<li><a href="../pt427953/index.html">Os microsservi√ßos tornam o mundo mais f√°cil (mas n√£o)</a></li>
<li><a href="../pt427955/index.html">Por que n√£o uso pontos de hist√≥ria para o planejamento de sprint</a></li>
<li><a href="../pt427957/index.html">DNS sobre TLS - Criptografe nossas consultas DNS usando Stunnel e Lua</a></li>
<li><a href="../pt427959/index.html">Confira: fez uma mesa</a></li>
<li><a href="../pt427961/index.html">Como o Yandex tentou copiar meu servi√ßo de mapa de calor</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>