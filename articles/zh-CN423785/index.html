<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏇🏽 🤰🏼 🤟 使用LTSP为Kubernetes构建网络就绪的服务器场 🤸 🎙️ ⛵️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="在本文中，我想向您展示一种很酷的技术，我成功地将其用于Kubernetes。 这对于构建大型集群非常有用。 


 从现在开始，您不再需要考虑为每个节点安装操作系统和单独的软件包。 怎么了 您可以通过Dockerfile自动完成所有这些操作！ 


您可以购买数百台新服务器，将它们添加到您的工作环境...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>使用LTSP为Kubernetes构建网络就绪的服务器场</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/423785/"><p><img src="https://habrastorage.org/getpro/habr/post_images/8bb/8a3/0c9/8bb8a30c990d198d478d1062f444b7a7.svg"></p><br><p> 在本文中，我想向您展示一种很酷的技术，我成功地将其用于Kubernetes。 这对于构建大型集群非常有用。 </p><br><p> 从现在开始，您不再需要考虑为每个节点安装操作系统和单独的软件包。 怎么了 您可以通过Dockerfile自动完成所有这些操作！ </p><br><p>您可以购买数百台新服务器，将它们添加到您的工作环境中，并几乎立即将它们准备好使用，这一事实的确令人惊奇！ </p><br><p> 感兴趣吗？ 现在让我们按顺序讨论一切。 </p><a name="habracut"></a><br><h1 id="rezyume"> 总结 </h1><br><p> 首先，我们需要确切了解该电路的工作原理。 </p><br><p> 简而言之，对于所有节点，我们正在使用OS，Docker，Kubelet和其他所有内容准备单个映像。 <br>  CI使用Dockerfile自动将该系统映像与内核一起构建。 <br> 终端节点直接通过网络从该映像加载OS和内核。 </p><br><p>节点使用overlayfs作为根文件系统，因此，在重新引导的情况下，所有更改都会丢失（以及docker容器）。 <br> 有一个主要的配置，您可以在其中描述安装点以及在加载节点时应执行的一些命令（例如，添加ssh键和<code>kubeadm join</code>的命令） </p><br><h2 id="process-podgotovki-obraza"> 图像准备过程 </h2><br><p> 我们将使用LTSP项目，因为它为我们提供了组织网络引导所需的一切。 <br> 通常，LTSP是一堆shell脚本，使我们的生活更加轻松。 </p><br><p> 它提供了一个initramfs模块，几个帮助程序脚本以及某种配置系统，该系统可以在加载的早期（甚至在调用init之前）为系统做准备。 </p><br><p>  <strong>这是图像准备过程的样子：</strong> </p><br><ul><li> 在chroot环境中部署基本系统。 </li><li> 我们进行必要的更改，安装软件。 </li><li> 运行<code>ltsp-build-image</code>命令 </li></ul><br><p> 之后，您将从此chroot获取压缩的映像，其中包含所有安装的软件。 <br> 每个节点都将在引导时下载该映像并将其用作rootfs。 <br> 要进行更新，只需重新启动节点，新映像将被下载并用于rootfs。 </p><br><h2 id="servernye-komponenty"> 服务器组件 </h2><br><p>  <strong>在我们的案例中，LTSP的服务器部分仅包含两个组件：</strong> </p><br><ul><li>  <strong>TFTP服务器</strong> -TFTP是初始化协议，用于加载内核，initramfs和主要配置-lts.conf。 </li><li>  <strong>NBD服务器</strong> -NBD协议用于将压缩的rootfs映像传递给客户端。 这是最快的方法，但是如果需要，可以将其替换为NFS或AoE。 </li></ul><br><p> 您还需要具备： </p><br><ul><li>  <strong>DHCP服务器</strong> -它将分发IP配置以及我们的客户端所需的其他几个选项，以便它们可以从我们的LTSP服务器启动。 </li></ul><br><h2 id="process-zagruzki-nody"> 节点加载过程 </h2><br><p>  <strong>节点加载过程说明</strong> </p><br><ul><li> 首先，该节点将为<code>next-server</code> <code>filename</code>请求DHCP IP地址和选项。 </li><li> 然后，该节点将应用设置并下载引导程序（pxelinux或grub） </li><li> 引导程序将下载并使用内核和initramfs加载配置。 </li><li> 然后，它将使用为内核指定的特定选项加载内核和initramfs。 </li><li> 在启动时，initramfs模块将处理来自cmdline的参数并执行一些操作，例如连接nbd设备，准备覆盖rootfs等。 </li><li> 之后，将调用特殊的ltsp-init，而不是通常的init。 </li><li>  ltsp-init脚本将在调用主init之前尽早准备系统。 基本上，这里使用lts.conf（主配置文件）中的选项：这是更新fstab和rc.local等中的记录。 </li><li> 然后将调用主init（systemd），它将照常加载已配置的系统，从fstab挂载共享资源，启动目标和服务，并从rc.local执行命令。 </li><li> 结果，我们得到了一个完整配置并已加载的系统，可以采取进一步的措施。 </li></ul><br><h1 id="podgotovka-servera"> 服务器准备 </h1><br><p> 如我所说，我使用Dockerfile自动为LTSP服务器准备了压缩的映像。 这种方法还不错，因为所有构建步骤都可以在git存储库中描述。 您可以控制版本，使用标签，应用CI以及用于准备常规Docker项目的所有功能。 </p><br><p> 另一方面，您可以通过手动执行所有步骤来手动部署LTSP服务器，这对于培训目的和理解基本原理很有用。 <br> 如果只想在没有Dockerfile的情况下尝试LTSP，请手动运行本文中列出的命令。 </p><br><h2 id="spisok-ispolzovannyh-patchey"> 使用的补丁列表 </h2><br><p> 目前，LTSP存在一些缺陷，该项目的作者不太愿意接受更正。 幸运的是，LTSP易于定制，因此我为自己准备了一些补丁，我将在此处提供。 <br> 如果社区热烈接受我的决定，也许有一天我会成熟起来。 </p><br><ul><li>  <a href="">Feature-grub.diff</a> <br> 默认情况下，LTSP不支持EFI，因此我准备了一个补丁，该补丁添加了具有EFI支持的GRUB2。 </li><li>  <a href="">feature_preinit.diff</a> <br> 此修补程序在lts.conf中添加了PREINIT选项，使您可以在调用主init之前运行任意命令。 这对于修改系统单元和网络设置很有用。 值得注意的是，引导环境中的所有变量都已保存，您可以在通过此选项调用的脚本中使用它们。 </li><li>  <a href="">feature_initramfs_params_from_lts_conf.diff</a> <br> 使用禁用的NBD_TO_RAM选项解决了该问题，在此修补程序之后，您可以在chroot中的lts.conf中指定它。  （不是tftp目录中的那个） </li><li>  <a href="">nbd-server-wrapper.sh</a> <br> 这不是补丁，而只是一个shell脚本，它允许您在前驱中运行nbd-server，如果您想在Docker容器中运行nbd-server，则将需要它。 </li></ul><br><h2 id="dockerfile-stages">  Dockerfile阶段 </h2><br><p> 我们将在Dockerfile中使用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">阶段构建</a>来仅保存Docker映像的必要部分，其余未使用的部分将从最终映像中排除。 </p><br><pre> <code class="hljs ruby">ltsp-base (    ltsp ) <span class="hljs-params"><span class="hljs-params">| |</span></span>---basesystem <span class="hljs-params"><span class="hljs-params">| ( chroot-     ) |</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-params"><span class="hljs-params">|---builder |</span></span> <span class="hljs-params"><span class="hljs-params">| (    ,  ) |</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-string"><span class="hljs-string">'---ltsp-image | (  , docker, kubelet   squashed ) | '</span></span>---final-stage ( squashed ,   initramfs   stage)</code> </pre> <br><h3 id="stage-1-ltsp-base"> 阶段1：以ltsp为基础 </h3><br><p> 好的，让我们开始吧，这是Dockerfile的第一部分： </p><br><pre> <code class="bash hljs">FROM ubuntu:16.04 as ltsp-base ADD nbd-server-wrapper.sh /bin/ ADD /patches/feature-grub.diff /patches/feature-grub.diff RUN apt-get -y update \ &amp;&amp; apt-get -y install \ ltsp-server \ tftpd-hpa \ nbd-server \ grub-common \ grub-pc-bin \ grub-efi-amd64-bin \ curl \ patch \ &amp;&amp; sed -i <span class="hljs-string"><span class="hljs-string">'s|in_target mount|in_target_nofail mount|'</span></span> \ /usr/share/debootstrap/<span class="hljs-built_in"><span class="hljs-built_in">functions</span></span> \ <span class="hljs-comment"><span class="hljs-comment">#   EFI   Grub (#1745251) &amp;&amp; patch -p2 -d /usr/sbin &lt; /patches/feature-grub.diff \ &amp;&amp; rm -rf /var/lib/apt/lists \ &amp;&amp; apt-get clean</span></span></code> </pre> <br><p> 目前，我们的docker映像已经安装了以下内容： </p><br><ul><li>  NBD服务器 </li><li>  TFTP服务器 </li><li> 具有grub引导加载程序支持的LTSP脚本（用于EFI） </li></ul><br><h3 id="stage-2-basesystem"> 阶段2：基本系统 </h3><br><p> 在这一阶段，我们将使用基本系统准备chroot环境，并使用内核安装主要软件。 <br> 我们将使用通常的<strong>debootstrap</strong>而不是<strong>ltsp-build-client</strong>来准备映像，因为<strong>ltsp-build-client将</strong>安装GUI和一些其他不必要的东西，这些显然对部署服务器没有用。 </p><br><pre> <code class="bash hljs">FROM ltsp-base as basesystem ARG DEBIAN_FRONTEND=noninteractive <span class="hljs-comment"><span class="hljs-comment">#    RUN mkdir -p /opt/ltsp/amd64/proc/self/fd \ &amp;&amp; touch /opt/ltsp/amd64/proc/self/fd/3 \ &amp;&amp; debootstrap --arch amd64 xenial /opt/ltsp/amd64 \ &amp;&amp; rm -rf /opt/ltsp/amd64/proc/* #   RUN echo "\ deb http://archive.ubuntu.com/ubuntu xenial main restricted universe multiverse\n\ deb http://archive.ubuntu.com/ubuntu xenial-updates main restricted universe multiverse\n\ deb http://archive.ubuntu.com/ubuntu xenial-security main restricted universe multiverse" \ &gt; /opt/ltsp/amd64/etc/apt/sources.list \ &amp;&amp; ltsp-chroot apt-get -y update \ &amp;&amp; ltsp-chroot apt-get -y upgrade #   LTSP RUN ltsp-chroot apt-get -y install ltsp-client-core #   initramfs # 1:    /etc/lts.conf    (#1680490) # 2:   PREINIT   lts.conf ADD /patches /patches RUN patch -p4 -d /opt/ltsp/amd64/usr/share &lt; /patches/feature_initramfs_params_from_lts_conf.diff \ &amp;&amp; patch -p3 -d /opt/ltsp/amd64/usr/share &lt; /patches/feature_preinit.diff #  LTSP_NBD_TO_RAM    ,     ram: RUN echo "[Default]\nLTSP_NBD_TO_RAM = true" \ &gt; /opt/ltsp/amd64/etc/lts.conf #   RUN echo 'APT::Install-Recommends "0";\nAPT::Install-Suggests "0";' \ &gt;&gt; /opt/ltsp/amd64/etc/apt/apt.conf.d/01norecommend \ &amp;&amp; ltsp-chroot apt-get -y install \ software-properties-common \ apt-transport-https \ ca-certificates \ ssh \ bridge-utils \ pv \ jq \ vlan \ bash-completion \ screen \ vim \ mc \ lm-sensors \ htop \ jnettop \ rsync \ curl \ wget \ tcpdump \ arping \ apparmor-utils \ nfs-common \ telnet \ sysstat \ ipvsadm \ ipset \ make #   RUN ltsp-chroot apt-get -y install linux-generic-hwe-16.04</span></span></code> </pre> <br><p> 请注意，某些软件包（例如lvm2）可能会遇到问题。 它们尚未完全优化，无法安装在无特权的chroot中。 他们的安装后脚本尝试调用特权命令，这些命令可能会失败并阻止整个软件包的安装。 </p><br><p> 解决方案： </p><br><ul><li> 如果在安装内核之前先安装它们，则可以成功安装其中的一些（例如，lvm2） </li><li> 但是对于其中一些，您将需要使用此<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">替代方法</a>来安装，而无需安装后脚本。 </li></ul><br><h3 id="stage-3-builder"> 第三阶段：建造者 </h3><br><p> 在这个阶段，我们可以从源头收集所有必要的软件和内核模块，这是很酷的事情，它可以在这个阶段以全自动模式进行。 <br> 如果您不需要从艺术家那里收集任何东西，请跳过此步骤。 </p><br><p> 我将举一个安装最新版本的MLNX_EN驱动程序的示例： </p><br><pre> <code class="bash hljs">FROM basesystem as builder <span class="hljs-comment"><span class="hljs-comment">#  cpuinfo (   ) RUN cp /proc/cpuinfo /opt/ltsp/amd64/proc/cpuinfo #    Mellanox driver RUN ltsp-chroot sh -cx \ ' VERSION=4.3-1.0.1.0-ubuntu16.04-x86_64 \ &amp;&amp; curl -L http://www.mellanox.com/downloads/ofed/MLNX_EN-${VERSION%%-ubuntu*}/mlnx-en-${VERSION}.tgz \ | tar xzf - \ &amp;&amp; export \ DRIVER_DIR="$(ls -1 | grep "MLNX_OFED_LINUX-\|mlnx-en-")" \ KERNEL="$(ls -1t /lib/modules/ | head -n1)" \ &amp;&amp; cd "$DRIVER_DIR" \ &amp;&amp; ./*install --kernel "$KERNEL" --without-dkms --add-kernel-support \ &amp;&amp; cd - \ &amp;&amp; rm -rf "$DRIVER_DIR" /tmp/mlnx-en* /tmp/ofed*' #    RUN ltsp-chroot sh -c \ ' export KERNEL="$(ls -1t /usr/src/ | grep -m1 "^linux-headers" | sed "s/^linux-headers-//g")" \ &amp;&amp; tar cpzf /modules.tar.gz /lib/modules/${KERNEL}/updates'</span></span></code> </pre><br><h3 id="stage-4-ltsp-image"> 阶段4：ltsp-image </h3><br><p> 在这一阶段，我们将确定上一步收集的内容： </p><br><pre> <code class="bash hljs">FROM basesystem as ltsp-image <span class="hljs-comment"><span class="hljs-comment">#    COPY --from=builder /opt/ltsp/amd64/modules.tar.gz /opt/ltsp/amd64/modules.tar.gz #    RUN ltsp-chroot sh -c \ ' export KERNEL="$(ls -1t /usr/src/ | grep -m1 "^linux-headers" | sed "s/^linux-headers-//g")" \ &amp;&amp; tar xpzf /modules.tar.gz \ &amp;&amp; depmod -a "${KERNEL}" \ &amp;&amp; rm -f /modules.tar.gz'</span></span></code> </pre> <br><p> 现在，我们将进行其他更改以完成LTSP映像： </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#  docker RUN ltsp-chroot sh -c \ ' curl -fsSL https://download.docker.com/linux/ubuntu/gpg | apt-key add - \ &amp;&amp; echo "deb https://download.docker.com/linux/ubuntu xenial stable" \ &gt; /etc/apt/sources.list.d/docker.list \ &amp;&amp; apt-get -y update \ &amp;&amp; apt-get -y install \ docker-ce=$(apt-cache madison docker-ce | grep 18.06 | head -1 | awk "{print $ 3}")' #    docker RUN DOCKER_OPTS="$(echo \ --storage-driver=overlay2 \ --iptables=false \ --ip-masq=false \ --log-driver=json-file \ --log-opt=max-size=10m \ --log-opt=max-file=5 \ )" \ &amp;&amp; sed "/^ExecStart=/ s|$| $DOCKER_OPTS|g" \ /opt/ltsp/amd64/lib/systemd/system/docker.service \ &gt; /opt/ltsp/amd64/etc/systemd/system/docker.service #  kubeadm, kubelet  kubectl RUN ltsp-chroot sh -c \ ' curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add - \ &amp;&amp; echo "deb http://apt.kubernetes.io/ kubernetes-xenial main" \ &gt; /etc/apt/sources.list.d/kubernetes.list \ &amp;&amp; apt-get -y update \ &amp;&amp; apt-get -y install kubelet kubeadm kubectl cri-tools' #    RUN rm -f /opt/ltsp/amd64/etc/apt/apt.conf.d/20auto-upgrades #   apparmor RUN ltsp-chroot find /etc/apparmor.d \ -maxdepth 1 \ -type f \ -name "sbin.*" \ -o -name "usr.*" \ -exec ln -sf "{}" /etc/apparmor.d/disable/ \; #    (cmdline) RUN KERNEL_OPTIONS="$(echo \ init=/sbin/init-ltsp \ forcepae \ console=tty1 \ console=ttyS0,9600n8 \ nvme_core.default_ps_max_latency_us=0 \ )" \ &amp;&amp; sed -i "/^CMDLINE_LINUX_DEFAULT=/ s|=.*|=\"${KERNEL_OPTIONS}\"|" \ "/opt/ltsp/amd64/etc/ltsp/update-kernels.conf"</span></span></code> </pre> <br><p> 现在，从我们的chroot制作一个压缩图像： </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   RUN rm -rf /opt/ltsp/amd64/var/lib/apt/lists \ &amp;&amp; ltsp-chroot apt-get clean #  squashed  RUN ltsp-update-image</span></span></code> </pre> <br><h3 id="stage-5-final-stage"> 阶段5：最后阶段 </h3><br><p> 在最后阶段，我们仅使用initramfs保存压缩的图像和内核 </p><br><pre> <code class="bash hljs">FROM ltsp-base COPY --from=ltsp-image /opt/ltsp/images /opt/ltsp/images COPY --from=ltsp-image /etc/nbd-server/conf.d /etc/nbd-server/conf.d COPY --from=ltsp-image /var/lib/tftpboot /var/lib/tftpboot</code> </pre> <br><p> 好的，现在我们有了一个docker映像，其中包括： </p><br><ul><li>  TFTP服务器 </li><li>  NBD服务器 </li><li> 配置的引导程序 </li><li>  initramfs的内核 </li><li> 压缩的rootfs图像 </li></ul><br><h1 id="ispolzovanie"> 使用方法 </h1><br><p> 好的，现在我们的带有LTSP服务器，内核，initramfs和压缩后的rootfs的Docker映像已完全准备就绪，我们可以使用它运行部署。 </p><br><p> 我们可以照常做，但是还有另一个问题需要解决。 <br> 不幸的是，我们无法在部署中使用常规的Kubernetes服务，因为在启动时节点不是Kubernetes集群的一部分，它们需要使用externalIP，但是Kubernetes始终将NAT用于externalIP，并且目前无法更改此行为。 </p><br><p> 我知道两种避免这种情况的方法：使用<code>hostNetwork: true</code>或使用<a href="">pipework</a> ，第二个选项还将为我们提供容错能力，因为 如果发生故障，该IP地址将与容器一起移至另一个节点。 不幸的是，管道工程不是一种本机且不太安全的方法。 <br> 如果您知道任何更合适的解决方案，请告诉我们。 </p><br><p> 这是使用hostNetwork进行部署的示例： </p><br><pre> <code class="hljs pgsql">apiVersion: extensions/v1beta1 kind: Deployment metadata: <span class="hljs-type"><span class="hljs-type">name</span></span>: ltsp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> labels: app: ltsp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> spec: selector: matchLabels: <span class="hljs-type"><span class="hljs-type">name</span></span>: ltsp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> replicas: <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>: metadata: labels: <span class="hljs-type"><span class="hljs-type">name</span></span>: ltsp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> spec: hostNetwork: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> containers: - <span class="hljs-type"><span class="hljs-type">name</span></span>: tftpd image: registry.example.org/example/ltsp:latest command: [ "/usr/sbin/in.tftpd", "-L", "-u", "tftp", "-a", ":69", "-s", "/var/lib/tftpboot" ] lifecycle: postStart: exec: command: ["/bin/sh", "-c", "cd /var/lib/tftpboot/ltsp/amd64; ln -sf config/lts.conf ." ] volumeMounts: - <span class="hljs-type"><span class="hljs-type">name</span></span>: config mountPath: "/var/lib/tftpboot/ltsp/amd64/config" - <span class="hljs-type"><span class="hljs-type">name</span></span>: nbd-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> image: registry.example.org/example/ltsp:latest command: [ "/bin/nbd-server-wrapper.sh" ] volumes: - <span class="hljs-type"><span class="hljs-type">name</span></span>: config configMap: <span class="hljs-type"><span class="hljs-type">name</span></span>: ltsp-config</code> </pre> <br><p> 您可能已经注意到，这里还使用了带有<strong>lts.conf</strong>文件的configmap。 <br> 例如，我将给出部分配置： </p><br><pre> <code class="hljs 1c">apiVersion: v1 kind: ConfigMap metadata: name: ltsp-config data: lts.conf: <span class="hljs-string"><span class="hljs-string">| [default] KEEP_SYSTEM_SERVICES = "</span></span>ssh ureadahead dbus-org.freedesktop.login1 systemd-logind polkitd cgmanager ufw rpcbind nfs-kernel-server<span class="hljs-string"><span class="hljs-string">" PREINIT_00_TIME = "</span></span>ln -sf /usr/share/zoneinfo/Europe/Prague /etc/localtime<span class="hljs-string"><span class="hljs-string">" PREINIT_01_FIX_HOSTNAME = "</span></span>sed -i '/^127.0.0.2/d' /etc/hosts<span class="hljs-string"><span class="hljs-string">" PREINIT_02_DOCKER_OPTIONS = "</span></span>sed -i 's|^ExecStart=.*|ExecStart=/usr/bin/dockerd -H fd:// --storage-driver overlay2 --iptables=false --ip-masq=false --log-driver=json-file --log-opt=max-size=10m --log-opt=max-file=5|' /etc/systemd/system/docker.service<span class="hljs-string"><span class="hljs-string">" FSTAB_01_SSH = "</span></span>/dev/data/ssh /etc/ssh ext4 nofail,noatime,nodiratime <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-string"><span class="hljs-string">" FSTAB_02_JOURNALD = "</span></span>/dev/data/journal /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/journal ext4 nofail,noatime,nodiratime <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-string"><span class="hljs-string">" FSTAB_03_DOCKER = "</span></span>/dev/data/docker /var/lib/docker ext4 nofail,noatime,nodiratime <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-string"><span class="hljs-string">" # Each command will stop script execution when fail RCFILE_01_SSH_SERVER = "</span></span>cp /rofs/etc/ssh/*_config /etc/ssh; ssh-keygen -A<span class="hljs-string"><span class="hljs-string">" RCFILE_02_SSH_CLIENT = "</span></span>mkdir -p /root/.ssh/; echo 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDBSLYRaORL2znr1V4a3rjDn3HDHn2CsvUNK1nv8+CctoICtJOPXl6zQycI9KXNhANfJpc6iQG1ZPZUR74IiNhNIKvOpnNRPyLZ5opm01MVIDIZgi9g0DUks1g5gLV5LKzED8xYKMBmAfXMxh/nsP9KEvxGvTJB3OD+/bBxpliTl5xY3Eu41+VmZqVOz3Yl98+X8cZTgqx2dmsHUk7VKN9OZuCjIZL9MtJCZyOSRbjuo4HFEssotR1mvANyz+BUXkjqv2pEa0I2vGQPk1VDul5TpzGaN3nOfu83URZLJgCrX+8whS1fzMepUYrbEuIWq95esjn0gR6G4J7qlxyguAb9 admin@kubernetes' &gt;&gt; /root/.ssh/authorized_keys<span class="hljs-string"><span class="hljs-string">" RCFILE_03_KERNEL_DEBUG = "</span></span>sysctl -w kernel.unknown_nmi_panic=<span class="hljs-number"><span class="hljs-number">1</span></span> kernel.softlockup_panic=<span class="hljs-number"><span class="hljs-number">1</span></span>; modprobe netconsole netconsole=@/vmbr0,@<span class="hljs-number"><span class="hljs-number">10.9</span></span>.<span class="hljs-number"><span class="hljs-number">0.15</span></span>/<span class="hljs-string"><span class="hljs-string">" RCFILE_04_SYSCTL = "</span></span>sysctl -w fs.file-max=<span class="hljs-number"><span class="hljs-number">20000000</span></span> fs.nr_open=<span class="hljs-number"><span class="hljs-number">20000000</span></span> net.ipv4.neigh.default.gc_thresh1=<span class="hljs-number"><span class="hljs-number">80000</span></span> net.ipv4.neigh.default.gc_thresh2=<span class="hljs-number"><span class="hljs-number">90000</span></span> net.ipv4.neigh.default.gc_thresh3=<span class="hljs-number"><span class="hljs-number">100000</span></span><span class="hljs-string"><span class="hljs-string">" RCFILE_05_FORWARD = "</span></span>echo <span class="hljs-number"><span class="hljs-number">1</span></span> &gt; /proc/sys/net/ipv4/ip_forward<span class="hljs-string"><span class="hljs-string">" RCFILE_06_MODULES = "</span></span>modprobe br_netfilter<span class="hljs-string"><span class="hljs-string">" RCFILE_07_JOIN_K8S = "</span></span>kubeadm join --token <span class="hljs-number"><span class="hljs-number">2</span></span>a4576.<span class="hljs-number"><span class="hljs-number">504356</span></span>e45fa3d365 <span class="hljs-number"><span class="hljs-number">10.9</span></span>.<span class="hljs-number"><span class="hljs-number">0.20</span></span>:<span class="hljs-number"><span class="hljs-number">6443</span></span> --discovery-token-ca-cert-hash sha256:e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855<span class="hljs-string"><span class="hljs-string">"</span></span></code> 'SSH-RSA AAAAB3NzaC1yc2EAAAADAQABAAABAQDBSLYRaORL2znr1V4a3rjDn3HDHn2CsvUNK1nv8 + CctoICtJOPXl6zQycI9KXNhANfJpc6iQG1ZPZUR74IiNhNIKvOpnNRPyLZ5opm01MVIDIZgi9g0DUks1g5gLV5LKzED8xYKMBmAfXMxh / nsP9KEvxGvTJB3OD + / + bBxpliTl5xY3Eu41 + VmZqVOz3Yl98 + X8cZTgqx2dmsHUk7VKN9OZuCjIZL9MtJCZyOSRbjuo4HFEssotR1mvANyz + BUXkjqv2pEa0I2vGQPk1VDul5TpzGaN3nOfu83URZLJgCrX管理员8whS1fzMepUYrbEuIWq95esjn0gR6G4J7qlxyguAb9 @ kubernetes' &gt;&gt; /root/.ssh/authorized_keys” <code class="hljs 1c">apiVersion: v1 kind: ConfigMap metadata: name: ltsp-config data: lts.conf: <span class="hljs-string"><span class="hljs-string">| [default] KEEP_SYSTEM_SERVICES = "</span></span>ssh ureadahead dbus-org.freedesktop.login1 systemd-logind polkitd cgmanager ufw rpcbind nfs-kernel-server<span class="hljs-string"><span class="hljs-string">" PREINIT_00_TIME = "</span></span>ln -sf /usr/share/zoneinfo/Europe/Prague /etc/localtime<span class="hljs-string"><span class="hljs-string">" PREINIT_01_FIX_HOSTNAME = "</span></span>sed -i '/^127.0.0.2/d' /etc/hosts<span class="hljs-string"><span class="hljs-string">" PREINIT_02_DOCKER_OPTIONS = "</span></span>sed -i 's|^ExecStart=.*|ExecStart=/usr/bin/dockerd -H fd:// --storage-driver overlay2 --iptables=false --ip-masq=false --log-driver=json-file --log-opt=max-size=10m --log-opt=max-file=5|' /etc/systemd/system/docker.service<span class="hljs-string"><span class="hljs-string">" FSTAB_01_SSH = "</span></span>/dev/data/ssh /etc/ssh ext4 nofail,noatime,nodiratime <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-string"><span class="hljs-string">" FSTAB_02_JOURNALD = "</span></span>/dev/data/journal /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/journal ext4 nofail,noatime,nodiratime <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-string"><span class="hljs-string">" FSTAB_03_DOCKER = "</span></span>/dev/data/docker /var/lib/docker ext4 nofail,noatime,nodiratime <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-string"><span class="hljs-string">" # Each command will stop script execution when fail RCFILE_01_SSH_SERVER = "</span></span>cp /rofs/etc/ssh/*_config /etc/ssh; ssh-keygen -A<span class="hljs-string"><span class="hljs-string">" RCFILE_02_SSH_CLIENT = "</span></span>mkdir -p /root/.ssh/; echo 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDBSLYRaORL2znr1V4a3rjDn3HDHn2CsvUNK1nv8+CctoICtJOPXl6zQycI9KXNhANfJpc6iQG1ZPZUR74IiNhNIKvOpnNRPyLZ5opm01MVIDIZgi9g0DUks1g5gLV5LKzED8xYKMBmAfXMxh/nsP9KEvxGvTJB3OD+/bBxpliTl5xY3Eu41+VmZqVOz3Yl98+X8cZTgqx2dmsHUk7VKN9OZuCjIZL9MtJCZyOSRbjuo4HFEssotR1mvANyz+BUXkjqv2pEa0I2vGQPk1VDul5TpzGaN3nOfu83URZLJgCrX+8whS1fzMepUYrbEuIWq95esjn0gR6G4J7qlxyguAb9 admin@kubernetes' &gt;&gt; /root/.ssh/authorized_keys<span class="hljs-string"><span class="hljs-string">" RCFILE_03_KERNEL_DEBUG = "</span></span>sysctl -w kernel.unknown_nmi_panic=<span class="hljs-number"><span class="hljs-number">1</span></span> kernel.softlockup_panic=<span class="hljs-number"><span class="hljs-number">1</span></span>; modprobe netconsole netconsole=@/vmbr0,@<span class="hljs-number"><span class="hljs-number">10.9</span></span>.<span class="hljs-number"><span class="hljs-number">0.15</span></span>/<span class="hljs-string"><span class="hljs-string">" RCFILE_04_SYSCTL = "</span></span>sysctl -w fs.file-max=<span class="hljs-number"><span class="hljs-number">20000000</span></span> fs.nr_open=<span class="hljs-number"><span class="hljs-number">20000000</span></span> net.ipv4.neigh.default.gc_thresh1=<span class="hljs-number"><span class="hljs-number">80000</span></span> net.ipv4.neigh.default.gc_thresh2=<span class="hljs-number"><span class="hljs-number">90000</span></span> net.ipv4.neigh.default.gc_thresh3=<span class="hljs-number"><span class="hljs-number">100000</span></span><span class="hljs-string"><span class="hljs-string">" RCFILE_05_FORWARD = "</span></span>echo <span class="hljs-number"><span class="hljs-number">1</span></span> &gt; /proc/sys/net/ipv4/ip_forward<span class="hljs-string"><span class="hljs-string">" RCFILE_06_MODULES = "</span></span>modprobe br_netfilter<span class="hljs-string"><span class="hljs-string">" RCFILE_07_JOIN_K8S = "</span></span>kubeadm join --token <span class="hljs-number"><span class="hljs-number">2</span></span>a4576.<span class="hljs-number"><span class="hljs-number">504356</span></span>e45fa3d365 <span class="hljs-number"><span class="hljs-number">10.9</span></span>.<span class="hljs-number"><span class="hljs-number">0.20</span></span>:<span class="hljs-number"><span class="hljs-number">6443</span></span> --discovery-token-ca-cert-hash sha256:e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855<span class="hljs-string"><span class="hljs-string">"</span></span></code> </pre> <br><ul><li>  <strong>KEEP_SYSTEM_SERVICES-</strong>引导<strong>LTSP</strong>期间会自动删除某些服务，需要此变量以防止此处列出的服务出现此行为。 </li><li>  <b>PREINIT_ *</b> -将在运行systemd之前执行此处列出的命令（此功能由<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">feature_preinit.diff</a>补丁添加） </li><li>  <b>FSTAB_ *</b> -此处列出的行将添加到<code>/etc/fstab</code>文件中。 <br> 您可能会注意到，我正在使用<code>nofail</code>选项，它具有以下行为：如果该部分不存在，则下载将继续而不会出现错误。 </li><li>  <b>RCFILE_ *</b> -这些命令将添加到<code>rc.local</code>文件，该文件将在引导时由systemd调用。 <br> 在这里，我加载必要的内核模块，运行一些sysctl设置，然后运行<code>kubeadm join</code>命令，该命令将节点添加到kubernetes集群中。 </li></ul><br><p> 您可以从<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">lts.conf手册页中</a>获取有关所有变量的更多详细信息。 </p><br><p> 现在，您可以配置DHCP。 本质上，您需要指定<code>next-server</code>和<code>filename</code>选项。 </p><br><p> 我使用的是ISC-DHCP服务器，下面以<code>dhcpd.conf</code>为例： </p><br><pre> <code class="hljs pgsql">shared-network ltsp-netowrk { subnet <span class="hljs-number"><span class="hljs-number">10.9</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> netmask <span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> { authoritative; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>-lease-<span class="hljs-type"><span class="hljs-type">time</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; max-lease-<span class="hljs-type"><span class="hljs-type">time</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> <span class="hljs-keyword"><span class="hljs-keyword">domain</span></span>-<span class="hljs-type"><span class="hljs-type">name</span></span> "example.org"; <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> <span class="hljs-keyword"><span class="hljs-keyword">domain</span></span>-<span class="hljs-type"><span class="hljs-type">name</span></span>-servers <span class="hljs-number"><span class="hljs-number">10.9</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> routers <span class="hljs-number"><span class="hljs-number">10.9</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>; next-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> ltsp<span class="hljs-number"><span class="hljs-number">-1</span></span>; # <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> ltsp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> hostname here <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> architecture = <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">07</span></span> { filename "/ltsp/amd64/grub/x86_64-efi/core.efi"; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { filename "/ltsp/amd64/grub/i386-pc/core.0"; } <span class="hljs-keyword"><span class="hljs-keyword">range</span></span> <span class="hljs-number"><span class="hljs-number">10.9</span></span><span class="hljs-number"><span class="hljs-number">.200</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-number"><span class="hljs-number">10.9</span></span><span class="hljs-number"><span class="hljs-number">.250</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span>; }</code> </pre> <br><p> 您可以从这里开始，但是就我而言，我有数台LTSP服务器，并且使用Ansible剧本为每个节点配置了单独的静态IP地址和必要的选项。 </p><br><p> 尝试启动第一个节点，如果一切都正确完成，则将在该节点上加载一个系统。 该节点也将添加到Kubernetes集群中。 </p><br><p> 现在，您可以尝试进行自己的更改。 </p><br><p> 如果您还需要其他东西，请注意，可以很容易地定制LTSP以满足您的需求。 随时查看源代码，您可以在其中找到很多答案。 </p><br><p> 加入我们的电报频道： <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">@ltsp_ru</a> 。 </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN423785/">https://habr.com/ru/post/zh-CN423785/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN423775/index.html">我想要一块漂亮的铁。 原来</a></li>
<li><a href="../zh-CN423777/index.html">重点项目：运行基于RISC-V的应用程序的受信任环境</a></li>
<li><a href="../zh-CN423779/index.html">云到云备份：它是什么以及为什么需要它</a></li>
<li><a href="../zh-CN423781/index.html">物联网提供商的说明。 案例：我们为车里雅宾斯克的加油机建立了LoRa网络</a></li>
<li><a href="../zh-CN423783/index.html">Splunk：将机器学习提升到新的水平</a></li>
<li><a href="../zh-CN423787/index.html">TEST Labs2018。面向测试人员的在线mitap。 9月28日至29日</a></li>
<li><a href="../zh-CN423791/index.html">我们无需编程和布局即可制作3D配置器。 第二部分</a></li>
<li><a href="../zh-CN423793/index.html">“我们按时做出了这个决定，该死！” -给程序员的10个问题，第5期</a></li>
<li><a href="../zh-CN423797/index.html">俏皮鸟结构：发展流程</a></li>
<li><a href="../zh-CN423799/index.html">简报是一项投资。 内网部署正确</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>