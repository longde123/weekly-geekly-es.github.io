<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‡ğŸ½ ğŸ¤°ğŸ¼ ğŸ¤Ÿ ä½¿ç”¨LTSPä¸ºKubernetesæ„å»ºç½‘ç»œå°±ç»ªçš„æœåŠ¡å™¨åœº ğŸ¤¸ ğŸ™ï¸ â›µï¸</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘æƒ³å‘æ‚¨å±•ç¤ºä¸€ç§å¾ˆé…·çš„æŠ€æœ¯ï¼Œæˆ‘æˆåŠŸåœ°å°†å…¶ç”¨äºKubernetesã€‚ è¿™å¯¹äºæ„å»ºå¤§å‹é›†ç¾¤éå¸¸æœ‰ç”¨ã€‚ 


 ä»ç°åœ¨å¼€å§‹ï¼Œæ‚¨ä¸å†éœ€è¦è€ƒè™‘ä¸ºæ¯ä¸ªèŠ‚ç‚¹å®‰è£…æ“ä½œç³»ç»Ÿå’Œå•ç‹¬çš„è½¯ä»¶åŒ…ã€‚ æ€ä¹ˆäº† æ‚¨å¯ä»¥é€šè¿‡Dockerfileè‡ªåŠ¨å®Œæˆæ‰€æœ‰è¿™äº›æ“ä½œï¼ 


æ‚¨å¯ä»¥è´­ä¹°æ•°ç™¾å°æ–°æœåŠ¡å™¨ï¼Œå°†å®ƒä»¬æ·»åŠ åˆ°æ‚¨çš„å·¥ä½œç¯å¢ƒ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ä½¿ç”¨LTSPä¸ºKubernetesæ„å»ºç½‘ç»œå°±ç»ªçš„æœåŠ¡å™¨åœº</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/423785/"><p><img src="https://habrastorage.org/getpro/habr/post_images/8bb/8a3/0c9/8bb8a30c990d198d478d1062f444b7a7.svg"></p><br><p> åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘æƒ³å‘æ‚¨å±•ç¤ºä¸€ç§å¾ˆé…·çš„æŠ€æœ¯ï¼Œæˆ‘æˆåŠŸåœ°å°†å…¶ç”¨äºKubernetesã€‚ è¿™å¯¹äºæ„å»ºå¤§å‹é›†ç¾¤éå¸¸æœ‰ç”¨ã€‚ </p><br><p> ä»ç°åœ¨å¼€å§‹ï¼Œæ‚¨ä¸å†éœ€è¦è€ƒè™‘ä¸ºæ¯ä¸ªèŠ‚ç‚¹å®‰è£…æ“ä½œç³»ç»Ÿå’Œå•ç‹¬çš„è½¯ä»¶åŒ…ã€‚ æ€ä¹ˆäº† æ‚¨å¯ä»¥é€šè¿‡Dockerfileè‡ªåŠ¨å®Œæˆæ‰€æœ‰è¿™äº›æ“ä½œï¼ </p><br><p>æ‚¨å¯ä»¥è´­ä¹°æ•°ç™¾å°æ–°æœåŠ¡å™¨ï¼Œå°†å®ƒä»¬æ·»åŠ åˆ°æ‚¨çš„å·¥ä½œç¯å¢ƒä¸­ï¼Œå¹¶å‡ ä¹ç«‹å³å°†å®ƒä»¬å‡†å¤‡å¥½ä½¿ç”¨ï¼Œè¿™ä¸€äº‹å®çš„ç¡®ä»¤äººæƒŠå¥‡ï¼ </p><br><p> æ„Ÿå…´è¶£å—ï¼Ÿ ç°åœ¨è®©æˆ‘ä»¬æŒ‰é¡ºåºè®¨è®ºä¸€åˆ‡ã€‚ </p><a name="habracut"></a><br><h1 id="rezyume"> æ€»ç»“ </h1><br><p> é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ç¡®åˆ‡äº†è§£è¯¥ç”µè·¯çš„å·¥ä½œåŸç†ã€‚ </p><br><p> ç®€è€Œè¨€ä¹‹ï¼Œå¯¹äºæ‰€æœ‰èŠ‚ç‚¹ï¼Œæˆ‘ä»¬æ­£åœ¨ä½¿ç”¨OSï¼ŒDockerï¼ŒKubeletå’Œå…¶ä»–æ‰€æœ‰å†…å®¹å‡†å¤‡å•ä¸ªæ˜ åƒã€‚ <br>  CIä½¿ç”¨Dockerfileè‡ªåŠ¨å°†è¯¥ç³»ç»Ÿæ˜ åƒä¸å†…æ ¸ä¸€èµ·æ„å»ºã€‚ <br> ç»ˆç«¯èŠ‚ç‚¹ç›´æ¥é€šè¿‡ç½‘ç»œä»è¯¥æ˜ åƒåŠ è½½OSå’Œå†…æ ¸ã€‚ </p><br><p>èŠ‚ç‚¹ä½¿ç”¨overlayfsä½œä¸ºæ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œå› æ­¤ï¼Œåœ¨é‡æ–°å¼•å¯¼çš„æƒ…å†µä¸‹ï¼Œæ‰€æœ‰æ›´æ”¹éƒ½ä¼šä¸¢å¤±ï¼ˆä»¥åŠdockerå®¹å™¨ï¼‰ã€‚ <br> æœ‰ä¸€ä¸ªä¸»è¦çš„é…ç½®ï¼Œæ‚¨å¯ä»¥åœ¨å…¶ä¸­æè¿°å®‰è£…ç‚¹ä»¥åŠåœ¨åŠ è½½èŠ‚ç‚¹æ—¶åº”æ‰§è¡Œçš„ä¸€äº›å‘½ä»¤ï¼ˆä¾‹å¦‚ï¼Œæ·»åŠ sshé”®å’Œ<code>kubeadm join</code>çš„å‘½ä»¤ï¼‰ </p><br><h2 id="process-podgotovki-obraza"> å›¾åƒå‡†å¤‡è¿‡ç¨‹ </h2><br><p> æˆ‘ä»¬å°†ä½¿ç”¨LTSPé¡¹ç›®ï¼Œå› ä¸ºå®ƒä¸ºæˆ‘ä»¬æä¾›äº†ç»„ç»‡ç½‘ç»œå¼•å¯¼æ‰€éœ€çš„ä¸€åˆ‡ã€‚ <br> é€šå¸¸ï¼ŒLTSPæ˜¯ä¸€å †shellè„šæœ¬ï¼Œä½¿æˆ‘ä»¬çš„ç”Ÿæ´»æ›´åŠ è½»æ¾ã€‚ </p><br><p> å®ƒæä¾›äº†ä¸€ä¸ªinitramfsæ¨¡å—ï¼Œå‡ ä¸ªå¸®åŠ©ç¨‹åºè„šæœ¬ä»¥åŠæŸç§é…ç½®ç³»ç»Ÿï¼Œè¯¥ç³»ç»Ÿå¯ä»¥åœ¨åŠ è½½çš„æ—©æœŸï¼ˆç”šè‡³åœ¨è°ƒç”¨initä¹‹å‰ï¼‰ä¸ºç³»ç»Ÿåšå‡†å¤‡ã€‚ </p><br><p>  <strong>è¿™æ˜¯å›¾åƒå‡†å¤‡è¿‡ç¨‹çš„æ ·å­ï¼š</strong> </p><br><ul><li> åœ¨chrootç¯å¢ƒä¸­éƒ¨ç½²åŸºæœ¬ç³»ç»Ÿã€‚ </li><li> æˆ‘ä»¬è¿›è¡Œå¿…è¦çš„æ›´æ”¹ï¼Œå®‰è£…è½¯ä»¶ã€‚ </li><li> è¿è¡Œ<code>ltsp-build-image</code>å‘½ä»¤ </li></ul><br><p> ä¹‹åï¼Œæ‚¨å°†ä»æ­¤chrootè·å–å‹ç¼©çš„æ˜ åƒï¼Œå…¶ä¸­åŒ…å«æ‰€æœ‰å®‰è£…çš„è½¯ä»¶ã€‚ <br> æ¯ä¸ªèŠ‚ç‚¹éƒ½å°†åœ¨å¼•å¯¼æ—¶ä¸‹è½½è¯¥æ˜ åƒå¹¶å°†å…¶ç”¨ä½œrootfsã€‚ <br> è¦è¿›è¡Œæ›´æ–°ï¼Œåªéœ€é‡æ–°å¯åŠ¨èŠ‚ç‚¹ï¼Œæ–°æ˜ åƒå°†è¢«ä¸‹è½½å¹¶ç”¨äºrootfsã€‚ </p><br><h2 id="servernye-komponenty"> æœåŠ¡å™¨ç»„ä»¶ </h2><br><p>  <strong>åœ¨æˆ‘ä»¬çš„æ¡ˆä¾‹ä¸­ï¼ŒLTSPçš„æœåŠ¡å™¨éƒ¨åˆ†ä»…åŒ…å«ä¸¤ä¸ªç»„ä»¶ï¼š</strong> </p><br><ul><li>  <strong>TFTPæœåŠ¡å™¨</strong> -TFTPæ˜¯åˆå§‹åŒ–åè®®ï¼Œç”¨äºåŠ è½½å†…æ ¸ï¼Œinitramfså’Œä¸»è¦é…ç½®-lts.confã€‚ </li><li>  <strong>NBDæœåŠ¡å™¨</strong> -NBDåè®®ç”¨äºå°†å‹ç¼©çš„rootfsæ˜ åƒä¼ é€’ç»™å®¢æˆ·ç«¯ã€‚ è¿™æ˜¯æœ€å¿«çš„æ–¹æ³•ï¼Œä½†æ˜¯å¦‚æœéœ€è¦ï¼Œå¯ä»¥å°†å…¶æ›¿æ¢ä¸ºNFSæˆ–AoEã€‚ </li></ul><br><p> æ‚¨è¿˜éœ€è¦å…·å¤‡ï¼š </p><br><ul><li>  <strong>DHCPæœåŠ¡å™¨</strong> -å®ƒå°†åˆ†å‘IPé…ç½®ä»¥åŠæˆ‘ä»¬çš„å®¢æˆ·ç«¯æ‰€éœ€çš„å…¶ä»–å‡ ä¸ªé€‰é¡¹ï¼Œä»¥ä¾¿å®ƒä»¬å¯ä»¥ä»æˆ‘ä»¬çš„LTSPæœåŠ¡å™¨å¯åŠ¨ã€‚ </li></ul><br><h2 id="process-zagruzki-nody"> èŠ‚ç‚¹åŠ è½½è¿‡ç¨‹ </h2><br><p>  <strong>èŠ‚ç‚¹åŠ è½½è¿‡ç¨‹è¯´æ˜</strong> </p><br><ul><li> é¦–å…ˆï¼Œè¯¥èŠ‚ç‚¹å°†ä¸º<code>next-server</code> <code>filename</code>è¯·æ±‚DHCP IPåœ°å€å’Œé€‰é¡¹ã€‚ </li><li> ç„¶åï¼Œè¯¥èŠ‚ç‚¹å°†åº”ç”¨è®¾ç½®å¹¶ä¸‹è½½å¼•å¯¼ç¨‹åºï¼ˆpxelinuxæˆ–grubï¼‰ </li><li> å¼•å¯¼ç¨‹åºå°†ä¸‹è½½å¹¶ä½¿ç”¨å†…æ ¸å’ŒinitramfsåŠ è½½é…ç½®ã€‚ </li><li> ç„¶åï¼Œå®ƒå°†ä½¿ç”¨ä¸ºå†…æ ¸æŒ‡å®šçš„ç‰¹å®šé€‰é¡¹åŠ è½½å†…æ ¸å’Œinitramfsã€‚ </li><li> åœ¨å¯åŠ¨æ—¶ï¼Œinitramfsæ¨¡å—å°†å¤„ç†æ¥è‡ªcmdlineçš„å‚æ•°å¹¶æ‰§è¡Œä¸€äº›æ“ä½œï¼Œä¾‹å¦‚è¿æ¥nbdè®¾å¤‡ï¼Œå‡†å¤‡è¦†ç›–rootfsç­‰ã€‚ </li><li> ä¹‹åï¼Œå°†è°ƒç”¨ç‰¹æ®Šçš„ltsp-initï¼Œè€Œä¸æ˜¯é€šå¸¸çš„initã€‚ </li><li>  ltsp-initè„šæœ¬å°†åœ¨è°ƒç”¨ä¸»initä¹‹å‰å°½æ—©å‡†å¤‡ç³»ç»Ÿã€‚ åŸºæœ¬ä¸Šï¼Œè¿™é‡Œä½¿ç”¨lts.confï¼ˆä¸»é…ç½®æ–‡ä»¶ï¼‰ä¸­çš„é€‰é¡¹ï¼šè¿™æ˜¯æ›´æ–°fstabå’Œrc.localç­‰ä¸­çš„è®°å½•ã€‚ </li><li> ç„¶åå°†è°ƒç”¨ä¸»initï¼ˆsystemdï¼‰ï¼Œå®ƒå°†ç…§å¸¸åŠ è½½å·²é…ç½®çš„ç³»ç»Ÿï¼Œä»fstabæŒ‚è½½å…±äº«èµ„æºï¼Œå¯åŠ¨ç›®æ ‡å’ŒæœåŠ¡ï¼Œå¹¶ä»rc.localæ‰§è¡Œå‘½ä»¤ã€‚ </li><li> ç»“æœï¼Œæˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ªå®Œæ•´é…ç½®å¹¶å·²åŠ è½½çš„ç³»ç»Ÿï¼Œå¯ä»¥é‡‡å–è¿›ä¸€æ­¥çš„æªæ–½ã€‚ </li></ul><br><h1 id="podgotovka-servera"> æœåŠ¡å™¨å‡†å¤‡ </h1><br><p> å¦‚æˆ‘æ‰€è¯´ï¼Œæˆ‘ä½¿ç”¨Dockerfileè‡ªåŠ¨ä¸ºLTSPæœåŠ¡å™¨å‡†å¤‡äº†å‹ç¼©çš„æ˜ åƒã€‚ è¿™ç§æ–¹æ³•è¿˜ä¸é”™ï¼Œå› ä¸ºæ‰€æœ‰æ„å»ºæ­¥éª¤éƒ½å¯ä»¥åœ¨gitå­˜å‚¨åº“ä¸­æè¿°ã€‚ æ‚¨å¯ä»¥æ§åˆ¶ç‰ˆæœ¬ï¼Œä½¿ç”¨æ ‡ç­¾ï¼Œåº”ç”¨CIä»¥åŠç”¨äºå‡†å¤‡å¸¸è§„Dockeré¡¹ç›®çš„æ‰€æœ‰åŠŸèƒ½ã€‚ </p><br><p> å¦ä¸€æ–¹é¢ï¼Œæ‚¨å¯ä»¥é€šè¿‡æ‰‹åŠ¨æ‰§è¡Œæ‰€æœ‰æ­¥éª¤æ¥æ‰‹åŠ¨éƒ¨ç½²LTSPæœåŠ¡å™¨ï¼Œè¿™å¯¹äºåŸ¹è®­ç›®çš„å’Œç†è§£åŸºæœ¬åŸç†å¾ˆæœ‰ç”¨ã€‚ <br> å¦‚æœåªæƒ³åœ¨æ²¡æœ‰Dockerfileçš„æƒ…å†µä¸‹å°è¯•LTSPï¼Œè¯·æ‰‹åŠ¨è¿è¡Œæœ¬æ–‡ä¸­åˆ—å‡ºçš„å‘½ä»¤ã€‚ </p><br><h2 id="spisok-ispolzovannyh-patchey"> ä½¿ç”¨çš„è¡¥ä¸åˆ—è¡¨ </h2><br><p> ç›®å‰ï¼ŒLTSPå­˜åœ¨ä¸€äº›ç¼ºé™·ï¼Œè¯¥é¡¹ç›®çš„ä½œè€…ä¸å¤ªæ„¿æ„æ¥å—æ›´æ­£ã€‚ å¹¸è¿çš„æ˜¯ï¼ŒLTSPæ˜“äºå®šåˆ¶ï¼Œå› æ­¤æˆ‘ä¸ºè‡ªå·±å‡†å¤‡äº†ä¸€äº›è¡¥ä¸ï¼Œæˆ‘å°†åœ¨æ­¤å¤„æä¾›ã€‚ <br> å¦‚æœç¤¾åŒºçƒ­çƒˆæ¥å—æˆ‘çš„å†³å®šï¼Œä¹Ÿè®¸æœ‰ä¸€å¤©æˆ‘ä¼šæˆç†Ÿèµ·æ¥ã€‚ </p><br><ul><li>  <a href="">Feature-grub.diff</a> <br> é»˜è®¤æƒ…å†µä¸‹ï¼ŒLTSPä¸æ”¯æŒEFIï¼Œå› æ­¤æˆ‘å‡†å¤‡äº†ä¸€ä¸ªè¡¥ä¸ï¼Œè¯¥è¡¥ä¸æ·»åŠ äº†å…·æœ‰EFIæ”¯æŒçš„GRUB2ã€‚ </li><li>  <a href="">feature_preinit.diff</a> <br> æ­¤ä¿®è¡¥ç¨‹åºåœ¨lts.confä¸­æ·»åŠ äº†PREINITé€‰é¡¹ï¼Œä½¿æ‚¨å¯ä»¥åœ¨è°ƒç”¨ä¸»initä¹‹å‰è¿è¡Œä»»æ„å‘½ä»¤ã€‚ è¿™å¯¹äºä¿®æ”¹ç³»ç»Ÿå•å…ƒå’Œç½‘ç»œè®¾ç½®å¾ˆæœ‰ç”¨ã€‚ å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå¼•å¯¼ç¯å¢ƒä¸­çš„æ‰€æœ‰å˜é‡éƒ½å·²ä¿å­˜ï¼Œæ‚¨å¯ä»¥åœ¨é€šè¿‡æ­¤é€‰é¡¹è°ƒç”¨çš„è„šæœ¬ä¸­ä½¿ç”¨å®ƒä»¬ã€‚ </li><li>  <a href="">feature_initramfs_params_from_lts_conf.diff</a> <br> ä½¿ç”¨ç¦ç”¨çš„NBD_TO_RAMé€‰é¡¹è§£å†³äº†è¯¥é—®é¢˜ï¼Œåœ¨æ­¤ä¿®è¡¥ç¨‹åºä¹‹åï¼Œæ‚¨å¯ä»¥åœ¨chrootä¸­çš„lts.confä¸­æŒ‡å®šå®ƒã€‚  ï¼ˆä¸æ˜¯tftpç›®å½•ä¸­çš„é‚£ä¸ªï¼‰ </li><li>  <a href="">nbd-server-wrapper.sh</a> <br> è¿™ä¸æ˜¯è¡¥ä¸ï¼Œè€Œåªæ˜¯ä¸€ä¸ªshellè„šæœ¬ï¼Œå®ƒå…è®¸æ‚¨åœ¨å‰é©±ä¸­è¿è¡Œnbd-serverï¼Œå¦‚æœæ‚¨æƒ³åœ¨Dockerå®¹å™¨ä¸­è¿è¡Œnbd-serverï¼Œåˆ™å°†éœ€è¦å®ƒã€‚ </li></ul><br><h2 id="dockerfile-stages">  Dockerfileé˜¶æ®µ </h2><br><p> æˆ‘ä»¬å°†åœ¨Dockerfileä¸­ä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">é˜¶æ®µæ„å»º</a>æ¥ä»…ä¿å­˜Dockeræ˜ åƒçš„å¿…è¦éƒ¨åˆ†ï¼Œå…¶ä½™æœªä½¿ç”¨çš„éƒ¨åˆ†å°†ä»æœ€ç»ˆæ˜ åƒä¸­æ’é™¤ã€‚ </p><br><pre> <code class="hljs ruby">ltsp-base (    ltsp ) <span class="hljs-params"><span class="hljs-params">| |</span></span>---basesystem <span class="hljs-params"><span class="hljs-params">| ( chroot-     ) |</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-params"><span class="hljs-params">|---builder |</span></span> <span class="hljs-params"><span class="hljs-params">| (    ,  ) |</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-string"><span class="hljs-string">'---ltsp-image | (  , docker, kubelet   squashed ) | '</span></span>---final-stage ( squashed ,   initramfs   stage)</code> </pre> <br><h3 id="stage-1-ltsp-base"> é˜¶æ®µ1ï¼šä»¥ltspä¸ºåŸºç¡€ </h3><br><p> å¥½çš„ï¼Œè®©æˆ‘ä»¬å¼€å§‹å§ï¼Œè¿™æ˜¯Dockerfileçš„ç¬¬ä¸€éƒ¨åˆ†ï¼š </p><br><pre> <code class="bash hljs">FROM ubuntu:16.04 as ltsp-base ADD nbd-server-wrapper.sh /bin/ ADD /patches/feature-grub.diff /patches/feature-grub.diff RUN apt-get -y update \ &amp;&amp; apt-get -y install \ ltsp-server \ tftpd-hpa \ nbd-server \ grub-common \ grub-pc-bin \ grub-efi-amd64-bin \ curl \ patch \ &amp;&amp; sed -i <span class="hljs-string"><span class="hljs-string">'s|in_target mount|in_target_nofail mount|'</span></span> \ /usr/share/debootstrap/<span class="hljs-built_in"><span class="hljs-built_in">functions</span></span> \ <span class="hljs-comment"><span class="hljs-comment">#   EFI   Grub (#1745251) &amp;&amp; patch -p2 -d /usr/sbin &lt; /patches/feature-grub.diff \ &amp;&amp; rm -rf /var/lib/apt/lists \ &amp;&amp; apt-get clean</span></span></code> </pre> <br><p> ç›®å‰ï¼Œæˆ‘ä»¬çš„dockeræ˜ åƒå·²ç»å®‰è£…äº†ä»¥ä¸‹å†…å®¹ï¼š </p><br><ul><li>  NBDæœåŠ¡å™¨ </li><li>  TFTPæœåŠ¡å™¨ </li><li> å…·æœ‰grubå¼•å¯¼åŠ è½½ç¨‹åºæ”¯æŒçš„LTSPè„šæœ¬ï¼ˆç”¨äºEFIï¼‰ </li></ul><br><h3 id="stage-2-basesystem"> é˜¶æ®µ2ï¼šåŸºæœ¬ç³»ç»Ÿ </h3><br><p> åœ¨è¿™ä¸€é˜¶æ®µï¼Œæˆ‘ä»¬å°†ä½¿ç”¨åŸºæœ¬ç³»ç»Ÿå‡†å¤‡chrootç¯å¢ƒï¼Œå¹¶ä½¿ç”¨å†…æ ¸å®‰è£…ä¸»è¦è½¯ä»¶ã€‚ <br> æˆ‘ä»¬å°†ä½¿ç”¨é€šå¸¸çš„<strong>debootstrap</strong>è€Œä¸æ˜¯<strong>ltsp-build-client</strong>æ¥å‡†å¤‡æ˜ åƒï¼Œå› ä¸º<strong>ltsp-build-clientå°†</strong>å®‰è£…GUIå’Œä¸€äº›å…¶ä»–ä¸å¿…è¦çš„ä¸œè¥¿ï¼Œè¿™äº›æ˜¾ç„¶å¯¹éƒ¨ç½²æœåŠ¡å™¨æ²¡æœ‰ç”¨ã€‚ </p><br><pre> <code class="bash hljs">FROM ltsp-base as basesystem ARG DEBIAN_FRONTEND=noninteractive <span class="hljs-comment"><span class="hljs-comment">#    RUN mkdir -p /opt/ltsp/amd64/proc/self/fd \ &amp;&amp; touch /opt/ltsp/amd64/proc/self/fd/3 \ &amp;&amp; debootstrap --arch amd64 xenial /opt/ltsp/amd64 \ &amp;&amp; rm -rf /opt/ltsp/amd64/proc/* #   RUN echo "\ deb http://archive.ubuntu.com/ubuntu xenial main restricted universe multiverse\n\ deb http://archive.ubuntu.com/ubuntu xenial-updates main restricted universe multiverse\n\ deb http://archive.ubuntu.com/ubuntu xenial-security main restricted universe multiverse" \ &gt; /opt/ltsp/amd64/etc/apt/sources.list \ &amp;&amp; ltsp-chroot apt-get -y update \ &amp;&amp; ltsp-chroot apt-get -y upgrade #   LTSP RUN ltsp-chroot apt-get -y install ltsp-client-core #   initramfs # 1:    /etc/lts.conf    (#1680490) # 2:   PREINIT   lts.conf ADD /patches /patches RUN patch -p4 -d /opt/ltsp/amd64/usr/share &lt; /patches/feature_initramfs_params_from_lts_conf.diff \ &amp;&amp; patch -p3 -d /opt/ltsp/amd64/usr/share &lt; /patches/feature_preinit.diff #  LTSP_NBD_TO_RAM    ,     ram: RUN echo "[Default]\nLTSP_NBD_TO_RAM = true" \ &gt; /opt/ltsp/amd64/etc/lts.conf #   RUN echo 'APT::Install-Recommends "0";\nAPT::Install-Suggests "0";' \ &gt;&gt; /opt/ltsp/amd64/etc/apt/apt.conf.d/01norecommend \ &amp;&amp; ltsp-chroot apt-get -y install \ software-properties-common \ apt-transport-https \ ca-certificates \ ssh \ bridge-utils \ pv \ jq \ vlan \ bash-completion \ screen \ vim \ mc \ lm-sensors \ htop \ jnettop \ rsync \ curl \ wget \ tcpdump \ arping \ apparmor-utils \ nfs-common \ telnet \ sysstat \ ipvsadm \ ipset \ make #   RUN ltsp-chroot apt-get -y install linux-generic-hwe-16.04</span></span></code> </pre> <br><p> è¯·æ³¨æ„ï¼ŒæŸäº›è½¯ä»¶åŒ…ï¼ˆä¾‹å¦‚lvm2ï¼‰å¯èƒ½ä¼šé‡åˆ°é—®é¢˜ã€‚ å®ƒä»¬å°šæœªå®Œå…¨ä¼˜åŒ–ï¼Œæ— æ³•å®‰è£…åœ¨æ— ç‰¹æƒçš„chrootä¸­ã€‚ ä»–ä»¬çš„å®‰è£…åè„šæœ¬å°è¯•è°ƒç”¨ç‰¹æƒå‘½ä»¤ï¼Œè¿™äº›å‘½ä»¤å¯èƒ½ä¼šå¤±è´¥å¹¶é˜»æ­¢æ•´ä¸ªè½¯ä»¶åŒ…çš„å®‰è£…ã€‚ </p><br><p> è§£å†³æ–¹æ¡ˆï¼š </p><br><ul><li> å¦‚æœåœ¨å®‰è£…å†…æ ¸ä¹‹å‰å…ˆå®‰è£…å®ƒä»¬ï¼Œåˆ™å¯ä»¥æˆåŠŸå®‰è£…å…¶ä¸­çš„ä¸€äº›ï¼ˆä¾‹å¦‚ï¼Œlvm2ï¼‰ </li><li> ä½†æ˜¯å¯¹äºå…¶ä¸­ä¸€äº›ï¼Œæ‚¨å°†éœ€è¦ä½¿ç”¨æ­¤<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ›¿ä»£æ–¹æ³•</a>æ¥å®‰è£…ï¼Œè€Œæ— éœ€å®‰è£…åè„šæœ¬ã€‚ </li></ul><br><h3 id="stage-3-builder"> ç¬¬ä¸‰é˜¶æ®µï¼šå»ºé€ è€… </h3><br><p> åœ¨è¿™ä¸ªé˜¶æ®µï¼Œæˆ‘ä»¬å¯ä»¥ä»æºå¤´æ”¶é›†æ‰€æœ‰å¿…è¦çš„è½¯ä»¶å’Œå†…æ ¸æ¨¡å—ï¼Œè¿™æ˜¯å¾ˆé…·çš„äº‹æƒ…ï¼Œå®ƒå¯ä»¥åœ¨è¿™ä¸ªé˜¶æ®µä»¥å…¨è‡ªåŠ¨æ¨¡å¼è¿›è¡Œã€‚ <br> å¦‚æœæ‚¨ä¸éœ€è¦ä»è‰ºæœ¯å®¶é‚£é‡Œæ”¶é›†ä»»ä½•ä¸œè¥¿ï¼Œè¯·è·³è¿‡æ­¤æ­¥éª¤ã€‚ </p><br><p> æˆ‘å°†ä¸¾ä¸€ä¸ªå®‰è£…æœ€æ–°ç‰ˆæœ¬çš„MLNX_ENé©±åŠ¨ç¨‹åºçš„ç¤ºä¾‹ï¼š </p><br><pre> <code class="bash hljs">FROM basesystem as builder <span class="hljs-comment"><span class="hljs-comment">#  cpuinfo (   ) RUN cp /proc/cpuinfo /opt/ltsp/amd64/proc/cpuinfo #    Mellanox driver RUN ltsp-chroot sh -cx \ ' VERSION=4.3-1.0.1.0-ubuntu16.04-x86_64 \ &amp;&amp; curl -L http://www.mellanox.com/downloads/ofed/MLNX_EN-${VERSION%%-ubuntu*}/mlnx-en-${VERSION}.tgz \ | tar xzf - \ &amp;&amp; export \ DRIVER_DIR="$(ls -1 | grep "MLNX_OFED_LINUX-\|mlnx-en-")" \ KERNEL="$(ls -1t /lib/modules/ | head -n1)" \ &amp;&amp; cd "$DRIVER_DIR" \ &amp;&amp; ./*install --kernel "$KERNEL" --without-dkms --add-kernel-support \ &amp;&amp; cd - \ &amp;&amp; rm -rf "$DRIVER_DIR" /tmp/mlnx-en* /tmp/ofed*' #    RUN ltsp-chroot sh -c \ ' export KERNEL="$(ls -1t /usr/src/ | grep -m1 "^linux-headers" | sed "s/^linux-headers-//g")" \ &amp;&amp; tar cpzf /modules.tar.gz /lib/modules/${KERNEL}/updates'</span></span></code> </pre><br><h3 id="stage-4-ltsp-image"> é˜¶æ®µ4ï¼šltsp-image </h3><br><p> åœ¨è¿™ä¸€é˜¶æ®µï¼Œæˆ‘ä»¬å°†ç¡®å®šä¸Šä¸€æ­¥æ”¶é›†çš„å†…å®¹ï¼š </p><br><pre> <code class="bash hljs">FROM basesystem as ltsp-image <span class="hljs-comment"><span class="hljs-comment">#    COPY --from=builder /opt/ltsp/amd64/modules.tar.gz /opt/ltsp/amd64/modules.tar.gz #    RUN ltsp-chroot sh -c \ ' export KERNEL="$(ls -1t /usr/src/ | grep -m1 "^linux-headers" | sed "s/^linux-headers-//g")" \ &amp;&amp; tar xpzf /modules.tar.gz \ &amp;&amp; depmod -a "${KERNEL}" \ &amp;&amp; rm -f /modules.tar.gz'</span></span></code> </pre> <br><p> ç°åœ¨ï¼Œæˆ‘ä»¬å°†è¿›è¡Œå…¶ä»–æ›´æ”¹ä»¥å®ŒæˆLTSPæ˜ åƒï¼š </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#  docker RUN ltsp-chroot sh -c \ ' curl -fsSL https://download.docker.com/linux/ubuntu/gpg | apt-key add - \ &amp;&amp; echo "deb https://download.docker.com/linux/ubuntu xenial stable" \ &gt; /etc/apt/sources.list.d/docker.list \ &amp;&amp; apt-get -y update \ &amp;&amp; apt-get -y install \ docker-ce=$(apt-cache madison docker-ce | grep 18.06 | head -1 | awk "{print $ 3}")' #    docker RUN DOCKER_OPTS="$(echo \ --storage-driver=overlay2 \ --iptables=false \ --ip-masq=false \ --log-driver=json-file \ --log-opt=max-size=10m \ --log-opt=max-file=5 \ )" \ &amp;&amp; sed "/^ExecStart=/ s|$| $DOCKER_OPTS|g" \ /opt/ltsp/amd64/lib/systemd/system/docker.service \ &gt; /opt/ltsp/amd64/etc/systemd/system/docker.service #  kubeadm, kubelet  kubectl RUN ltsp-chroot sh -c \ ' curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add - \ &amp;&amp; echo "deb http://apt.kubernetes.io/ kubernetes-xenial main" \ &gt; /etc/apt/sources.list.d/kubernetes.list \ &amp;&amp; apt-get -y update \ &amp;&amp; apt-get -y install kubelet kubeadm kubectl cri-tools' #    RUN rm -f /opt/ltsp/amd64/etc/apt/apt.conf.d/20auto-upgrades #   apparmor RUN ltsp-chroot find /etc/apparmor.d \ -maxdepth 1 \ -type f \ -name "sbin.*" \ -o -name "usr.*" \ -exec ln -sf "{}" /etc/apparmor.d/disable/ \; #    (cmdline) RUN KERNEL_OPTIONS="$(echo \ init=/sbin/init-ltsp \ forcepae \ console=tty1 \ console=ttyS0,9600n8 \ nvme_core.default_ps_max_latency_us=0 \ )" \ &amp;&amp; sed -i "/^CMDLINE_LINUX_DEFAULT=/ s|=.*|=\"${KERNEL_OPTIONS}\"|" \ "/opt/ltsp/amd64/etc/ltsp/update-kernels.conf"</span></span></code> </pre> <br><p> ç°åœ¨ï¼Œä»æˆ‘ä»¬çš„chrootåˆ¶ä½œä¸€ä¸ªå‹ç¼©å›¾åƒï¼š </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   RUN rm -rf /opt/ltsp/amd64/var/lib/apt/lists \ &amp;&amp; ltsp-chroot apt-get clean #  squashed  RUN ltsp-update-image</span></span></code> </pre> <br><h3 id="stage-5-final-stage"> é˜¶æ®µ5ï¼šæœ€åé˜¶æ®µ </h3><br><p> åœ¨æœ€åé˜¶æ®µï¼Œæˆ‘ä»¬ä»…ä½¿ç”¨initramfsä¿å­˜å‹ç¼©çš„å›¾åƒå’Œå†…æ ¸ </p><br><pre> <code class="bash hljs">FROM ltsp-base COPY --from=ltsp-image /opt/ltsp/images /opt/ltsp/images COPY --from=ltsp-image /etc/nbd-server/conf.d /etc/nbd-server/conf.d COPY --from=ltsp-image /var/lib/tftpboot /var/lib/tftpboot</code> </pre> <br><p> å¥½çš„ï¼Œç°åœ¨æˆ‘ä»¬æœ‰äº†ä¸€ä¸ªdockeræ˜ åƒï¼Œå…¶ä¸­åŒ…æ‹¬ï¼š </p><br><ul><li>  TFTPæœåŠ¡å™¨ </li><li>  NBDæœåŠ¡å™¨ </li><li> é…ç½®çš„å¼•å¯¼ç¨‹åº </li><li>  initramfsçš„å†…æ ¸ </li><li> å‹ç¼©çš„rootfså›¾åƒ </li></ul><br><h1 id="ispolzovanie"> ä½¿ç”¨æ–¹æ³• </h1><br><p> å¥½çš„ï¼Œç°åœ¨æˆ‘ä»¬çš„å¸¦æœ‰LTSPæœåŠ¡å™¨ï¼Œå†…æ ¸ï¼Œinitramfså’Œå‹ç¼©åçš„rootfsçš„Dockeræ˜ åƒå·²å®Œå…¨å‡†å¤‡å°±ç»ªï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒè¿è¡Œéƒ¨ç½²ã€‚ </p><br><p> æˆ‘ä»¬å¯ä»¥ç…§å¸¸åšï¼Œä½†æ˜¯è¿˜æœ‰å¦ä¸€ä¸ªé—®é¢˜éœ€è¦è§£å†³ã€‚ <br> ä¸å¹¸çš„æ˜¯ï¼Œæˆ‘ä»¬æ— æ³•åœ¨éƒ¨ç½²ä¸­ä½¿ç”¨å¸¸è§„çš„KubernetesæœåŠ¡ï¼Œå› ä¸ºåœ¨å¯åŠ¨æ—¶èŠ‚ç‚¹ä¸æ˜¯Kubernetesé›†ç¾¤çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒä»¬éœ€è¦ä½¿ç”¨externalIPï¼Œä½†æ˜¯Kuberneteså§‹ç»ˆå°†NATç”¨äºexternalIPï¼Œå¹¶ä¸”ç›®å‰æ— æ³•æ›´æ”¹æ­¤è¡Œä¸ºã€‚ </p><br><p> æˆ‘çŸ¥é“ä¸¤ç§é¿å…è¿™ç§æƒ…å†µçš„æ–¹æ³•ï¼šä½¿ç”¨<code>hostNetwork: true</code>æˆ–ä½¿ç”¨<a href="">pipework</a> ï¼Œç¬¬äºŒä¸ªé€‰é¡¹è¿˜å°†ä¸ºæˆ‘ä»¬æä¾›å®¹é”™èƒ½åŠ›ï¼Œå› ä¸º å¦‚æœå‘ç”Ÿæ•…éšœï¼Œè¯¥IPåœ°å€å°†ä¸å®¹å™¨ä¸€èµ·ç§»è‡³å¦ä¸€ä¸ªèŠ‚ç‚¹ã€‚ ä¸å¹¸çš„æ˜¯ï¼Œç®¡é“å·¥ç¨‹ä¸æ˜¯ä¸€ç§æœ¬æœºä¸”ä¸å¤ªå®‰å…¨çš„æ–¹æ³•ã€‚ <br> å¦‚æœæ‚¨çŸ¥é“ä»»ä½•æ›´åˆé€‚çš„è§£å†³æ–¹æ¡ˆï¼Œè¯·å‘Šè¯‰æˆ‘ä»¬ã€‚ </p><br><p> è¿™æ˜¯ä½¿ç”¨hostNetworkè¿›è¡Œéƒ¨ç½²çš„ç¤ºä¾‹ï¼š </p><br><pre> <code class="hljs pgsql">apiVersion: extensions/v1beta1 kind: Deployment metadata: <span class="hljs-type"><span class="hljs-type">name</span></span>: ltsp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> labels: app: ltsp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> spec: selector: matchLabels: <span class="hljs-type"><span class="hljs-type">name</span></span>: ltsp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> replicas: <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>: metadata: labels: <span class="hljs-type"><span class="hljs-type">name</span></span>: ltsp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> spec: hostNetwork: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> containers: - <span class="hljs-type"><span class="hljs-type">name</span></span>: tftpd image: registry.example.org/example/ltsp:latest command: [ "/usr/sbin/in.tftpd", "-L", "-u", "tftp", "-a", ":69", "-s", "/var/lib/tftpboot" ] lifecycle: postStart: exec: command: ["/bin/sh", "-c", "cd /var/lib/tftpboot/ltsp/amd64; ln -sf config/lts.conf ." ] volumeMounts: - <span class="hljs-type"><span class="hljs-type">name</span></span>: config mountPath: "/var/lib/tftpboot/ltsp/amd64/config" - <span class="hljs-type"><span class="hljs-type">name</span></span>: nbd-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> image: registry.example.org/example/ltsp:latest command: [ "/bin/nbd-server-wrapper.sh" ] volumes: - <span class="hljs-type"><span class="hljs-type">name</span></span>: config configMap: <span class="hljs-type"><span class="hljs-type">name</span></span>: ltsp-config</code> </pre> <br><p> æ‚¨å¯èƒ½å·²ç»æ³¨æ„åˆ°ï¼Œè¿™é‡Œè¿˜ä½¿ç”¨äº†å¸¦æœ‰<strong>lts.conf</strong>æ–‡ä»¶çš„configmapã€‚ <br> ä¾‹å¦‚ï¼Œæˆ‘å°†ç»™å‡ºéƒ¨åˆ†é…ç½®ï¼š </p><br><pre> <code class="hljs 1c">apiVersion: v1 kind: ConfigMap metadata: name: ltsp-config data: lts.conf: <span class="hljs-string"><span class="hljs-string">| [default] KEEP_SYSTEM_SERVICES = "</span></span>ssh ureadahead dbus-org.freedesktop.login1 systemd-logind polkitd cgmanager ufw rpcbind nfs-kernel-server<span class="hljs-string"><span class="hljs-string">" PREINIT_00_TIME = "</span></span>ln -sf /usr/share/zoneinfo/Europe/Prague /etc/localtime<span class="hljs-string"><span class="hljs-string">" PREINIT_01_FIX_HOSTNAME = "</span></span>sed -i '/^127.0.0.2/d' /etc/hosts<span class="hljs-string"><span class="hljs-string">" PREINIT_02_DOCKER_OPTIONS = "</span></span>sed -i 's|^ExecStart=.*|ExecStart=/usr/bin/dockerd -H fd:// --storage-driver overlay2 --iptables=false --ip-masq=false --log-driver=json-file --log-opt=max-size=10m --log-opt=max-file=5|' /etc/systemd/system/docker.service<span class="hljs-string"><span class="hljs-string">" FSTAB_01_SSH = "</span></span>/dev/data/ssh /etc/ssh ext4 nofail,noatime,nodiratime <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-string"><span class="hljs-string">" FSTAB_02_JOURNALD = "</span></span>/dev/data/journal /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/journal ext4 nofail,noatime,nodiratime <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-string"><span class="hljs-string">" FSTAB_03_DOCKER = "</span></span>/dev/data/docker /var/lib/docker ext4 nofail,noatime,nodiratime <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-string"><span class="hljs-string">" # Each command will stop script execution when fail RCFILE_01_SSH_SERVER = "</span></span>cp /rofs/etc/ssh/*_config /etc/ssh; ssh-keygen -A<span class="hljs-string"><span class="hljs-string">" RCFILE_02_SSH_CLIENT = "</span></span>mkdir -p /root/.ssh/; echo 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDBSLYRaORL2znr1V4a3rjDn3HDHn2CsvUNK1nv8+CctoICtJOPXl6zQycI9KXNhANfJpc6iQG1ZPZUR74IiNhNIKvOpnNRPyLZ5opm01MVIDIZgi9g0DUks1g5gLV5LKzED8xYKMBmAfXMxh/nsP9KEvxGvTJB3OD+/bBxpliTl5xY3Eu41+VmZqVOz3Yl98+X8cZTgqx2dmsHUk7VKN9OZuCjIZL9MtJCZyOSRbjuo4HFEssotR1mvANyz+BUXkjqv2pEa0I2vGQPk1VDul5TpzGaN3nOfu83URZLJgCrX+8whS1fzMepUYrbEuIWq95esjn0gR6G4J7qlxyguAb9 admin@kubernetes' &gt;&gt; /root/.ssh/authorized_keys<span class="hljs-string"><span class="hljs-string">" RCFILE_03_KERNEL_DEBUG = "</span></span>sysctl -w kernel.unknown_nmi_panic=<span class="hljs-number"><span class="hljs-number">1</span></span> kernel.softlockup_panic=<span class="hljs-number"><span class="hljs-number">1</span></span>; modprobe netconsole netconsole=@/vmbr0,@<span class="hljs-number"><span class="hljs-number">10.9</span></span>.<span class="hljs-number"><span class="hljs-number">0.15</span></span>/<span class="hljs-string"><span class="hljs-string">" RCFILE_04_SYSCTL = "</span></span>sysctl -w fs.file-max=<span class="hljs-number"><span class="hljs-number">20000000</span></span> fs.nr_open=<span class="hljs-number"><span class="hljs-number">20000000</span></span> net.ipv4.neigh.default.gc_thresh1=<span class="hljs-number"><span class="hljs-number">80000</span></span> net.ipv4.neigh.default.gc_thresh2=<span class="hljs-number"><span class="hljs-number">90000</span></span> net.ipv4.neigh.default.gc_thresh3=<span class="hljs-number"><span class="hljs-number">100000</span></span><span class="hljs-string"><span class="hljs-string">" RCFILE_05_FORWARD = "</span></span>echo <span class="hljs-number"><span class="hljs-number">1</span></span> &gt; /proc/sys/net/ipv4/ip_forward<span class="hljs-string"><span class="hljs-string">" RCFILE_06_MODULES = "</span></span>modprobe br_netfilter<span class="hljs-string"><span class="hljs-string">" RCFILE_07_JOIN_K8S = "</span></span>kubeadm join --token <span class="hljs-number"><span class="hljs-number">2</span></span>a4576.<span class="hljs-number"><span class="hljs-number">504356</span></span>e45fa3d365 <span class="hljs-number"><span class="hljs-number">10.9</span></span>.<span class="hljs-number"><span class="hljs-number">0.20</span></span>:<span class="hljs-number"><span class="hljs-number">6443</span></span> --discovery-token-ca-cert-hash sha256:e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855<span class="hljs-string"><span class="hljs-string">"</span></span></code> 'SSH-RSA AAAAB3NzaC1yc2EAAAADAQABAAABAQDBSLYRaORL2znr1V4a3rjDn3HDHn2CsvUNK1nv8 + CctoICtJOPXl6zQycI9KXNhANfJpc6iQG1ZPZUR74IiNhNIKvOpnNRPyLZ5opm01MVIDIZgi9g0DUks1g5gLV5LKzED8xYKMBmAfXMxh / nsP9KEvxGvTJB3OD + / + bBxpliTl5xY3Eu41 + VmZqVOz3Yl98 + X8cZTgqx2dmsHUk7VKN9OZuCjIZL9MtJCZyOSRbjuo4HFEssotR1mvANyz + BUXkjqv2pEa0I2vGQPk1VDul5TpzGaN3nOfu83URZLJgCrXç®¡ç†å‘˜8whS1fzMepUYrbEuIWq95esjn0gR6G4J7qlxyguAb9 @ kubernetes' &gt;&gt; /root/.ssh/authorized_keysâ€ <code class="hljs 1c">apiVersion: v1 kind: ConfigMap metadata: name: ltsp-config data: lts.conf: <span class="hljs-string"><span class="hljs-string">| [default] KEEP_SYSTEM_SERVICES = "</span></span>ssh ureadahead dbus-org.freedesktop.login1 systemd-logind polkitd cgmanager ufw rpcbind nfs-kernel-server<span class="hljs-string"><span class="hljs-string">" PREINIT_00_TIME = "</span></span>ln -sf /usr/share/zoneinfo/Europe/Prague /etc/localtime<span class="hljs-string"><span class="hljs-string">" PREINIT_01_FIX_HOSTNAME = "</span></span>sed -i '/^127.0.0.2/d' /etc/hosts<span class="hljs-string"><span class="hljs-string">" PREINIT_02_DOCKER_OPTIONS = "</span></span>sed -i 's|^ExecStart=.*|ExecStart=/usr/bin/dockerd -H fd:// --storage-driver overlay2 --iptables=false --ip-masq=false --log-driver=json-file --log-opt=max-size=10m --log-opt=max-file=5|' /etc/systemd/system/docker.service<span class="hljs-string"><span class="hljs-string">" FSTAB_01_SSH = "</span></span>/dev/data/ssh /etc/ssh ext4 nofail,noatime,nodiratime <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-string"><span class="hljs-string">" FSTAB_02_JOURNALD = "</span></span>/dev/data/journal /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/journal ext4 nofail,noatime,nodiratime <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-string"><span class="hljs-string">" FSTAB_03_DOCKER = "</span></span>/dev/data/docker /var/lib/docker ext4 nofail,noatime,nodiratime <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-string"><span class="hljs-string">" # Each command will stop script execution when fail RCFILE_01_SSH_SERVER = "</span></span>cp /rofs/etc/ssh/*_config /etc/ssh; ssh-keygen -A<span class="hljs-string"><span class="hljs-string">" RCFILE_02_SSH_CLIENT = "</span></span>mkdir -p /root/.ssh/; echo 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDBSLYRaORL2znr1V4a3rjDn3HDHn2CsvUNK1nv8+CctoICtJOPXl6zQycI9KXNhANfJpc6iQG1ZPZUR74IiNhNIKvOpnNRPyLZ5opm01MVIDIZgi9g0DUks1g5gLV5LKzED8xYKMBmAfXMxh/nsP9KEvxGvTJB3OD+/bBxpliTl5xY3Eu41+VmZqVOz3Yl98+X8cZTgqx2dmsHUk7VKN9OZuCjIZL9MtJCZyOSRbjuo4HFEssotR1mvANyz+BUXkjqv2pEa0I2vGQPk1VDul5TpzGaN3nOfu83URZLJgCrX+8whS1fzMepUYrbEuIWq95esjn0gR6G4J7qlxyguAb9 admin@kubernetes' &gt;&gt; /root/.ssh/authorized_keys<span class="hljs-string"><span class="hljs-string">" RCFILE_03_KERNEL_DEBUG = "</span></span>sysctl -w kernel.unknown_nmi_panic=<span class="hljs-number"><span class="hljs-number">1</span></span> kernel.softlockup_panic=<span class="hljs-number"><span class="hljs-number">1</span></span>; modprobe netconsole netconsole=@/vmbr0,@<span class="hljs-number"><span class="hljs-number">10.9</span></span>.<span class="hljs-number"><span class="hljs-number">0.15</span></span>/<span class="hljs-string"><span class="hljs-string">" RCFILE_04_SYSCTL = "</span></span>sysctl -w fs.file-max=<span class="hljs-number"><span class="hljs-number">20000000</span></span> fs.nr_open=<span class="hljs-number"><span class="hljs-number">20000000</span></span> net.ipv4.neigh.default.gc_thresh1=<span class="hljs-number"><span class="hljs-number">80000</span></span> net.ipv4.neigh.default.gc_thresh2=<span class="hljs-number"><span class="hljs-number">90000</span></span> net.ipv4.neigh.default.gc_thresh3=<span class="hljs-number"><span class="hljs-number">100000</span></span><span class="hljs-string"><span class="hljs-string">" RCFILE_05_FORWARD = "</span></span>echo <span class="hljs-number"><span class="hljs-number">1</span></span> &gt; /proc/sys/net/ipv4/ip_forward<span class="hljs-string"><span class="hljs-string">" RCFILE_06_MODULES = "</span></span>modprobe br_netfilter<span class="hljs-string"><span class="hljs-string">" RCFILE_07_JOIN_K8S = "</span></span>kubeadm join --token <span class="hljs-number"><span class="hljs-number">2</span></span>a4576.<span class="hljs-number"><span class="hljs-number">504356</span></span>e45fa3d365 <span class="hljs-number"><span class="hljs-number">10.9</span></span>.<span class="hljs-number"><span class="hljs-number">0.20</span></span>:<span class="hljs-number"><span class="hljs-number">6443</span></span> --discovery-token-ca-cert-hash sha256:e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855<span class="hljs-string"><span class="hljs-string">"</span></span></code> </pre> <br><ul><li>  <strong>KEEP_SYSTEM_SERVICES-</strong>å¼•å¯¼<strong>LTSP</strong>æœŸé—´ä¼šè‡ªåŠ¨åˆ é™¤æŸäº›æœåŠ¡ï¼Œéœ€è¦æ­¤å˜é‡ä»¥é˜²æ­¢æ­¤å¤„åˆ—å‡ºçš„æœåŠ¡å‡ºç°æ­¤è¡Œä¸ºã€‚ </li><li>  <b>PREINIT_ *</b> -å°†åœ¨è¿è¡Œsystemdä¹‹å‰æ‰§è¡Œæ­¤å¤„åˆ—å‡ºçš„å‘½ä»¤ï¼ˆæ­¤åŠŸèƒ½ç”±<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">feature_preinit.diff</a>è¡¥ä¸æ·»åŠ ï¼‰ </li><li>  <b>FSTAB_ *</b> -æ­¤å¤„åˆ—å‡ºçš„è¡Œå°†æ·»åŠ åˆ°<code>/etc/fstab</code>æ–‡ä»¶ä¸­ã€‚ <br> æ‚¨å¯èƒ½ä¼šæ³¨æ„åˆ°ï¼Œæˆ‘æ­£åœ¨ä½¿ç”¨<code>nofail</code>é€‰é¡¹ï¼Œå®ƒå…·æœ‰ä»¥ä¸‹è¡Œä¸ºï¼šå¦‚æœè¯¥éƒ¨åˆ†ä¸å­˜åœ¨ï¼Œåˆ™ä¸‹è½½å°†ç»§ç»­è€Œä¸ä¼šå‡ºç°é”™è¯¯ã€‚ </li><li>  <b>RCFILE_ *</b> -è¿™äº›å‘½ä»¤å°†æ·»åŠ åˆ°<code>rc.local</code>æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å°†åœ¨å¼•å¯¼æ—¶ç”±systemdè°ƒç”¨ã€‚ <br> åœ¨è¿™é‡Œï¼Œæˆ‘åŠ è½½å¿…è¦çš„å†…æ ¸æ¨¡å—ï¼Œè¿è¡Œä¸€äº›sysctlè®¾ç½®ï¼Œç„¶åè¿è¡Œ<code>kubeadm join</code>å‘½ä»¤ï¼Œè¯¥å‘½ä»¤å°†èŠ‚ç‚¹æ·»åŠ åˆ°kubernetesé›†ç¾¤ä¸­ã€‚ </li></ul><br><p> æ‚¨å¯ä»¥ä»<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">lts.confæ‰‹å†Œé¡µä¸­</a>è·å–æœ‰å…³æ‰€æœ‰å˜é‡çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ã€‚ </p><br><p> ç°åœ¨ï¼Œæ‚¨å¯ä»¥é…ç½®DHCPã€‚ æœ¬è´¨ä¸Šï¼Œæ‚¨éœ€è¦æŒ‡å®š<code>next-server</code>å’Œ<code>filename</code>é€‰é¡¹ã€‚ </p><br><p> æˆ‘ä½¿ç”¨çš„æ˜¯ISC-DHCPæœåŠ¡å™¨ï¼Œä¸‹é¢ä»¥<code>dhcpd.conf</code>ä¸ºä¾‹ï¼š </p><br><pre> <code class="hljs pgsql">shared-network ltsp-netowrk { subnet <span class="hljs-number"><span class="hljs-number">10.9</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> netmask <span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> { authoritative; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>-lease-<span class="hljs-type"><span class="hljs-type">time</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; max-lease-<span class="hljs-type"><span class="hljs-type">time</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> <span class="hljs-keyword"><span class="hljs-keyword">domain</span></span>-<span class="hljs-type"><span class="hljs-type">name</span></span> "example.org"; <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> <span class="hljs-keyword"><span class="hljs-keyword">domain</span></span>-<span class="hljs-type"><span class="hljs-type">name</span></span>-servers <span class="hljs-number"><span class="hljs-number">10.9</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> routers <span class="hljs-number"><span class="hljs-number">10.9</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>; next-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> ltsp<span class="hljs-number"><span class="hljs-number">-1</span></span>; # <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> ltsp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> hostname here <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> architecture = <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">07</span></span> { filename "/ltsp/amd64/grub/x86_64-efi/core.efi"; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { filename "/ltsp/amd64/grub/i386-pc/core.0"; } <span class="hljs-keyword"><span class="hljs-keyword">range</span></span> <span class="hljs-number"><span class="hljs-number">10.9</span></span><span class="hljs-number"><span class="hljs-number">.200</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-number"><span class="hljs-number">10.9</span></span><span class="hljs-number"><span class="hljs-number">.250</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span>; }</code> </pre> <br><p> æ‚¨å¯ä»¥ä»è¿™é‡Œå¼€å§‹ï¼Œä½†æ˜¯å°±æˆ‘è€Œè¨€ï¼Œæˆ‘æœ‰æ•°å°LTSPæœåŠ¡å™¨ï¼Œå¹¶ä¸”ä½¿ç”¨Ansibleå‰§æœ¬ä¸ºæ¯ä¸ªèŠ‚ç‚¹é…ç½®äº†å•ç‹¬çš„é™æ€IPåœ°å€å’Œå¿…è¦çš„é€‰é¡¹ã€‚ </p><br><p> å°è¯•å¯åŠ¨ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¦‚æœä¸€åˆ‡éƒ½æ­£ç¡®å®Œæˆï¼Œåˆ™å°†åœ¨è¯¥èŠ‚ç‚¹ä¸ŠåŠ è½½ä¸€ä¸ªç³»ç»Ÿã€‚ è¯¥èŠ‚ç‚¹ä¹Ÿå°†æ·»åŠ åˆ°Kubernetesé›†ç¾¤ä¸­ã€‚ </p><br><p> ç°åœ¨ï¼Œæ‚¨å¯ä»¥å°è¯•è¿›è¡Œè‡ªå·±çš„æ›´æ”¹ã€‚ </p><br><p> å¦‚æœæ‚¨è¿˜éœ€è¦å…¶ä»–ä¸œè¥¿ï¼Œè¯·æ³¨æ„ï¼Œå¯ä»¥å¾ˆå®¹æ˜“åœ°å®šåˆ¶LTSPä»¥æ»¡è¶³æ‚¨çš„éœ€æ±‚ã€‚ éšæ—¶æŸ¥çœ‹æºä»£ç ï¼Œæ‚¨å¯ä»¥åœ¨å…¶ä¸­æ‰¾åˆ°å¾ˆå¤šç­”æ¡ˆã€‚ </p><br><p> åŠ å…¥æˆ‘ä»¬çš„ç”µæŠ¥é¢‘é“ï¼š <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">@ltsp_ru</a> ã€‚ </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN423785/">https://habr.com/ru/post/zh-CN423785/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN423775/index.html">æˆ‘æƒ³è¦ä¸€å—æ¼‚äº®çš„é“ã€‚ åŸæ¥</a></li>
<li><a href="../zh-CN423777/index.html">é‡ç‚¹é¡¹ç›®ï¼šè¿è¡ŒåŸºäºRISC-Vçš„åº”ç”¨ç¨‹åºçš„å—ä¿¡ä»»ç¯å¢ƒ</a></li>
<li><a href="../zh-CN423779/index.html">äº‘åˆ°äº‘å¤‡ä»½ï¼šå®ƒæ˜¯ä»€ä¹ˆä»¥åŠä¸ºä»€ä¹ˆéœ€è¦å®ƒ</a></li>
<li><a href="../zh-CN423781/index.html">ç‰©è”ç½‘æä¾›å•†çš„è¯´æ˜ã€‚ æ¡ˆä¾‹ï¼šæˆ‘ä»¬ä¸ºè½¦é‡Œé›…å®¾æ–¯å…‹çš„åŠ æ²¹æœºå»ºç«‹äº†LoRaç½‘ç»œ</a></li>
<li><a href="../zh-CN423783/index.html">Splunkï¼šå°†æœºå™¨å­¦ä¹ æå‡åˆ°æ–°çš„æ°´å¹³</a></li>
<li><a href="../zh-CN423787/index.html">TEST Labs2018ã€‚é¢å‘æµ‹è¯•äººå‘˜çš„åœ¨çº¿mitapã€‚ 9æœˆ28æ—¥è‡³29æ—¥</a></li>
<li><a href="../zh-CN423791/index.html">æˆ‘ä»¬æ— éœ€ç¼–ç¨‹å’Œå¸ƒå±€å³å¯åˆ¶ä½œ3Dé…ç½®å™¨ã€‚ ç¬¬äºŒéƒ¨åˆ†</a></li>
<li><a href="../zh-CN423793/index.html">â€œæˆ‘ä»¬æŒ‰æ—¶åšå‡ºäº†è¿™ä¸ªå†³å®šï¼Œè¯¥æ­»ï¼â€ -ç»™ç¨‹åºå‘˜çš„10ä¸ªé—®é¢˜ï¼Œç¬¬5æœŸ</a></li>
<li><a href="../zh-CN423797/index.html">ä¿çš®é¸Ÿç»“æ„ï¼šå‘å±•æµç¨‹</a></li>
<li><a href="../zh-CN423799/index.html">ç®€æŠ¥æ˜¯ä¸€é¡¹æŠ•èµ„ã€‚ å†…ç½‘éƒ¨ç½²æ­£ç¡®</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>