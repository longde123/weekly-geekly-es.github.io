<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üî§ üßñ üôÜ Sonata: servidor de aprovisionamiento SIP üë©üèº‚Äçüöí üò∑ „Ä∞Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="No s√© con qu√© comparar el aprovisionamiento. Tal vez con un gato? Parece posible sin √©l, pero con √©l un poco mejor. Especialmente si funciona)) 


 De...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Sonata: servidor de aprovisionamiento SIP</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/445350/"><p>  No s√© con qu√© comparar el aprovisionamiento.  Tal vez con un gato?  Parece posible sin √©l, pero con √©l un poco mejor.  Especialmente si funciona)) </p><br><p>  Declaraci√≥n del problema: </p><br><ol><li>  Quiero configurar tel√©fonos SIP de forma r√°pida, sencilla y segura.  Al instalar el tel√©fono, y m√°s a√∫n al volver a configurarlo. </li><li>  Muchos proveedores tienen sus propios formatos de configuraci√≥n, sus utilidades para generar configuraciones, sus propias formas de proteger las configuraciones.  Pero realmente no quiero tratar con todos. </li><li>  Muchas soluciones de aprovisionamiento, a) se centran en un proveedor o un sistema telef√≥nico, b) son bastante engorrosos de implementar, un mont√≥n de scripts, par√°metros, br ... </li></ol><br><p> En el punto 3, har√© un comentario de que existen excelentes sistemas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">para FreePBX</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">FusionPBX</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Kazoo</a> , donde hay plantillas disponibles p√∫blicamente para tel√©fonos de varios proveedores.  Existen soluciones comerciales en las que tambi√©n es posible configurar en el m√≥dulo la operaci√≥n de tel√©fonos de diferentes fabricantes, por ejemplo, PBX Yeastar. </p><br><p>  En Habr√© tambi√©n est√° lleno de recetas c√≥mo configurar dispositivos de varios proveedores: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">uno</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">dos</a> .  Pero como dicen, todos los sistemas tienen un defecto fatal.  As√≠ que haz tu bicicleta. </p><a name="habracut"></a><br><h2 id="svoy-format">  formato propio </h2><br><p>  Como dicen en xkcd, no quiero lidiar con 14 formatos, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">piense en el 15</a> .  Por lo tanto, utilizamos la configuraci√≥n general para cualquier tel√©fono y hacemos nuestra propia configuraci√≥n en formato json. </p><br><p>  Algo como esto: </p><br><pre><code class="plaintext hljs">{ "key": "sdgjdeu9443908", "token": "590sfdsf8u984", "model": "gxp1620", "vendor": "grandstream", "mac": "001565113af8", "timezone_offset": "GMT+03", "ntp_server": "pool.ntp.org", "status": true, "accounts": [ { "name": "", "line": 1, "sip_register": "sip.mobilonsip.ru", "sip_name": "sip102", "sip_user": "sip102", "sip_password": "4321", "sip_auth": "sip102" } ] }</code> </pre> <br><p>  Entonces, en cualquier tel√©fono, debe configurar la hora local, l√≠neas de sorbos.  Todo es simple aqu√≠.  M√°s ejemplos se pueden encontrar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> . </p><br><h2 id="cvoy-server-provizhna">  servidor propio </h2><br><p>  En los manuales del fabricante, generalmente hay un punto en el que dice: tome csv, escriba all√≠ la direcci√≥n de acceso-contrase√±a-poppy, genere archivos con el script de nuestra compa√±√≠a, p√≥ngalos en el servidor web Apache y estar√° bien. </p><br><p>  El siguiente p√°rrafo del manual generalmente le dice qu√© m√°s puede cifrar el archivo de configuraci√≥n generado. </p><br><p>  Pero todo esto es un cl√°sico.  El enfoque moderno con smoothies y twitter dice que necesita hacer un servidor web listo que no sea tan poderoso como Apache, pero que solo haga una peque√±a cosa.  Forma y da configuraciones por referencia. </p><br><p>  Aqu√≠ nos detenemos y recordamos que casi todos los tel√©fonos SIP ahora pueden recibir configuraciones a trav√©s de http / https, por lo que no consideramos otras implementaciones (ftp, tftp, ftps).  Luego, cada tel√©fono conoce su propia direcci√≥n de amapola.  Por lo tanto, haremos dos enlaces: uno personal: en la clave del dispositivo, el segundo general, que funciona en un token com√∫n y una direcci√≥n de amapola. </p><br><p>  Adem√°s, no me detendr√© en la configuraci√≥n cero, es decir  configurar el tel√©fono desde cero, es decir  Lo metiste en la red y gan√≥ un salto.  No, en mi caso, lo atascaste en la red, hiciste una configuraci√≥n preliminar (la configuraste para recibir la configuraci√≥n del servidor), y luego bebiste un poco de chocolate y reconfiguraste el tel√©fono seg√∫n sea necesario a trav√©s del servicio.  La opci√≥n de distribuci√≥n 66 es asunto del servidor DHCP. </p><br><p>  Por cierto, estoy completamente torturado al decir "aprovisionamiento", por lo que la palabra se redujo a "aprovisionamiento", no patees, por favor, con los pies. </p><br><p>  Y una cosa m√°s: nuestro servidor no tiene interfaz de usuario, es decir  interfaz de usuario  Quiz√°s por ahora, pero no estoy seguro, porque  No necesito  Pero hay una API para guardar / eliminar configuraciones, obtener una lista de proveedores compatibles, modelos, todo se describe de acuerdo con los c√°nones de la especificaci√≥n de swagger. </p><br><p>  ¬øPor qu√© una API, no una interfaz de usuario?  Porque  Ya tengo mi propio sistema telef√≥nico, entonces, tengo una fuente de credenciales, donde solo necesito tomar esta informaci√≥n, componer el json necesario y publicarlo en el servidor.  Y ya el servidor es seguro de acuerdo con las reglas especificadas en el archivo json, entregar√° la configuraci√≥n al dispositivo necesario o no dar√° informaci√≥n si el dispositivo est√° equivocado, o no cumple con los criterios especificados en este json. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/0a3/d32/998/0a3d3299831402ac43dc63a3487c826f.png"></p><br><p>  Aqu√≠ est√° tal provisi√≥n de microservicio.  Se llama <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">sonata</a> , el c√≥digo fuente est√° disponible en el github, tambi√©n hay una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">imagen</a> acoplada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">lista para</a> usar, un ejemplo del uso de acoplador <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> . </p><br><h3 id="klyuchevye-fishki">  Caracter√≠sticas clave: </h3><br><ul><li><p>  en cualquier caso, acceso limitado a la configuraci√≥n a tiempo, por defecto 10 minutos.  Si desea que la configuraci√≥n vuelva a estar disponible, vuelva a publicar la configuraci√≥n nuevamente. </p><br></li><li><p>  un formato para todos los proveedores, todos los ajustes se eliminan en sonata, env√≠a json estandarizado, configura cualquier equipo disponible. </p><br></li><li><p>  todas las configuraciones emitidas para los dispositivos se registran, todas las √°reas problem√°ticas se pueden ver en el registro y ver errores </p><br></li><li><p>  es posible usar un enlace com√∫n con token, cada tel√©fono recibe su propia configuraci√≥n especificando la direcci√≥n mac.  O un enlace personal en clave. </p><br></li><li><p>  Las API para administraci√≥n y aprovisionamiento se dividen en puertos </p><br></li><li><p>  Pruebas  Fue muy importante para m√≠ arreglar el formato de la configuraci√≥n emitida y cubrir todas las situaciones habituales de emisi√≥n de la configuraci√≥n con pruebas.  Para que todo funcione con claridad. </p><br></li></ul><br><h3 id="minusy">  Contras: </h3><br><p>  Hasta ahora, el cifrado de sonata no se ha utilizado.  Es decir  Por supuesto, puede comenzar a usar https poniendo nginx, por ejemplo, antes de sonata.  Pero aqu√≠ est√°n los m√©todos patentados que a√∫n no est√°n involucrados.  Por qu√©  El proyecto a√∫n es joven, casi volc√≥ sus primeros cien dispositivos.  Y, por supuesto, colecciono ideas, comentarios.  Adem√°s, para que todo sea seguro de modo que las configuraciones no se puedan rastrear en la red, probablemente valga la pena molestarse con claves de cifrado, tls y un erizo con ellas, pero esto ser√° una continuaci√≥n. </p><br><p>  Falta de IU.  Quiz√°s este sea un inconveniente significativo para el usuario final, pero para el administrador del sistema, la utilidad de la consola es m√°s importante que una aplicaci√≥n completa.  ¬øHab√≠a planes para hacer una utilidad de consola, pero no estoy seguro de si es necesaria? </p><br><h3 id="chto-v-itoge">  Cual es el resultado? </h3><br><p>  Servidor web peque√±o y simple para aprovisionar varios modelos de tel√©fonos con API para administraci√≥n. </p><br><h3 id="esche-raz-kak-eto-dolzhno-rabotat">  Una vez m√°s, ¬øc√≥mo deber√≠a funcionar esto? </h3><br><ol><li>  Instala sonata. </li><li>  Formamos json-config y lo publicamos en sonata. </li><li>  Luego recibimos un enlace de sonata para el aprovisionamiento. </li><li>  Luego indicamos este enlace en el tel√©fono. </li><li>  El dispositivo ajusta la configuraci√≥n </li></ol><br><p>  solo hay dos pasos en la operaci√≥n posterior: </p><br><ol><li>  Formamos una configuraci√≥n json y la publicamos en sonata </li><li>  El dispositivo ajusta la configuraci√≥n </li></ol><br><h3 id="kakie-telefony-provizhnyatsya">  ¬øQu√© tipo de tel√©fonos se cargan? </h3><br><p>  Vendedores Grandstream, Fanvil, Yealink.  Las configuraciones dentro del proveedor son m√°s o menos iguales, pero pueden diferir seg√∫n el firmware; puede ser necesario realizar pruebas adicionales. </p><br><h3 id="kakie-pravila-mozhno-zadavat">  ¬øQu√© reglas se pueden establecer? </h3><br><p>  Por tiempo  Puede especificar el tiempo hasta el cual la configuraci√≥n estar√° disponible. <br>  Por direcci√≥n mac.  Cuando env√≠a la configuraci√≥n a trav√©s del enlace personal del dispositivo, tambi√©n se verificar√° la direcci√≥n mac. <br>  Por ip.  Por direcci√≥n IP, desde donde se realiz√≥ la solicitud. </p><br><h3 id="kak-vzaimodeystvovat-c-sonata">  ¬øC√≥mo interactuar con sonata? </h3><br><p>  A trav√©s de la API, realizando solicitudes http.  La API estar√° disponible en su instalaci√≥n.  Porque  Debido a que la API admite la especificaci√≥n de swagger, puede usar la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">utilidad en l√≠nea</a> para solicitudes de prueba a la API. </p><br><h3 id="ok-otlichno-vesch-prikolnaya-kak-poprobovat">  Ok, genial  Cosa genial, ¬øc√≥mo intentarlo? </h3><br><p>  La forma m√°s f√°cil es implementar una imagen acoplable basada en el repositorio de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">muestras sonata</a> .  El repositorio contiene instrucciones de instalaci√≥n. </p><br><h3 id="a-esli-znayu-nodejs">  ¬øY si conozco node.js? </h3><br><p>  Si tiene experiencia en el uso de JavaScript, descubrir√° r√°pidamente c√≥mo funciona todo aqu√≠. </p><br><h3 id="budet-li-razvitie-sonata">  ¬øSe desarrollar√° la sonata? </h3><br><p>  Logr√© parcialmente mis objetivos.  El desarrollo adicional es una cuesti√≥n de mis tareas sobre el tema de la automatizaci√≥n de la configuraci√≥n del tel√©fono.  Todav√≠a existe la oportunidad de expandir las configuraciones para personalizar los botones del tel√©fono, agregar las funciones de la libreta de direcciones, tal vez algo m√°s, escribir en los comentarios. </p><br><h3 id="rezyume-i-blagodarnosti">  Resumen y agradecimientos </h3><br><p>  Estar√© encantado de sugerencias constructivas / objeciones / comentarios y preguntas, como  bien puede ser algo incomprensiblemente descrito. </p><br><p>  Tambi√©n agradezco a todos los colegas que ayudaron, aconsejaron, evaluaron, proporcionaron / donaron tel√©fonos para las pruebas.  En realidad, muchas personas con las que habl√© en el trabajo, en salas de chat y correos electr√≥nicos participaron en el proyecto de manera diferente.  Gracias por las ideas y pensamientos. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/445350/">https://habr.com/ru/post/445350/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../445338/index.html">Servidor DHCP + Mysql en Python</a></li>
<li><a href="../445340/index.html">Aumente la seguridad de la red utilizando un analizador en la nube</a></li>
<li><a href="../445344/index.html">Plataforma de comunicaciones unificadas OpenVox</a></li>
<li><a href="../445346/index.html">C√≥mo escribir una API incorrecta</a></li>
<li><a href="../445348/index.html">SNA Hackathon 2019: Simplify Architecture - Simplify Features</a></li>
<li><a href="../445352/index.html">Spark Structured Streaming Applications en Kubernetes. Experimenta FASTEN RUS</a></li>
<li><a href="../445354/index.html">Encontrar objetos en im√°genes</a></li>
<li><a href="../445356/index.html">Descripci√≥n general de la secci√≥n M√≥vil en DUMP-2019: m√°xima aplicada y √∫til en el trabajo diario</a></li>
<li><a href="../445358/index.html">Organizaci√≥n del sistema de eventos en Unity - a trav√©s de los ojos de un dise√±ador de juegos.</a></li>
<li><a href="../445360/index.html">5 tareas t√≠picas para las entrevistas de JavaScript: an√°lisis y soluciones</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>