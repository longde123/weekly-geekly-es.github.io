<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèø ‚õ≥Ô∏è üêñ D√©veloppement d'un serveur TELNET bas√© sur W5500 et ATMEGA8 ‚úçüèø üôÜ üëô</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="R√©cemment, le complexe logiciel et mat√©riel Arduino est devenu tr√®s populaire, con√ßu pour d√©velopper diverses conceptions √©lectroniques int√©ressantes....">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>D√©veloppement d'un serveur TELNET bas√© sur W5500 et ATMEGA8</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/414211/">  R√©cemment, le complexe logiciel et mat√©riel Arduino est devenu tr√®s populaire, con√ßu pour d√©velopper diverses conceptions √©lectroniques int√©ressantes.  Les conceptions sont faites en connectant la carte de base Arduino avec des modules suppl√©mentaires requis.  Sur la carte de base Arduino, il y a un microcontr√¥leur, dont le micrologiciel est √©crit dans un environnement de d√©veloppement sp√©cial pour Arduino en utilisant, en r√®gle g√©n√©rale, des biblioth√®ques pr√™tes √† l'emploi pour l'un ou l'autre module. <br><br>  L'un des modules - W5500 - est destin√© √† la fabrication de structures √©lectroniques qui seront connect√©es √† Internet.  Dans ce cas, le plus souvent, cela implique un contr√¥le √† distance de sa structure.  Par exemple, il peut s'agir d'une ¬´maison intelligente¬ª, d'un robot, etc.  Le projet le plus trivial (sauf pour Hello world) est l'inclusion √† distance de LED via un navigateur Web (Fig. 1).  Si, au lieu de LED, des commutateurs √† transistors et des relais sont connect√©s, des charges plus puissantes peuvent √™tre commut√©es.  Ainsi, en substance, le programme (firmware) de cette conception est un serveur Web qui traite les requ√™tes http d'un utilisateur distant. <br><a name="habracut"></a><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/qj/xj/w5/qjxjw5zozlcgxty2zaxpld3tfow.jpeg"></div>  <i>Fig.</i>  <i>1. Gestion des LED via un navigateur.</i> <br><br>  Le module W5500 est bas√© sur la puce W5500 elle-m√™me avec son kit de carrosserie, ainsi qu'un connecteur BLS pour MK via SPI, un connecteur RJ-45 pour la connexion √† un r√©seau informatique et un r√©gulateur de tension lin√©aire pour 3,3 V (Fig.2). <br><br><img src="https://habrastorage.org/webt/ta/sd/nz/tasdnz169igf5gzmdd6geetdsc4.jpeg" width="375" height="375"><br><br>  <i>Fig.</i>  <i>2. Le module W5500.</i> <br><br>  La puce W5500 est un contr√¥leur √† part enti√®re avec un traitement int√©gr√© de toute une pile de protocoles r√©seau, d'Ethernet √† TCP (Fig. 3).  En mettant en ≈ìuvre une conception bas√©e sur cette puce, le programmeur n'a pas besoin d'√©crire le code de traitement du protocole TCP / IP, il suffit de mettre en ≈ìuvre uniquement le protocole de couche application, qui sera int√©gr√© dans TCP.  Dans l'exemple ci-dessus (sur Arduino), http est utilis√© comme protocole d'application. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/5n/a0/dx/5na0dx-_xgs06can1rxipmlul7y.jpeg"></div>  <i>Fig.</i>  <i>3. La structure de la puce W5500.</i> <br><br>  Sans faire d'Arduino, j'ai d√©cid√© d'√©tudier la documentation de la puce W5500 en d√©tail et de mettre en ≈ìuvre ind√©pendamment le programme bas√© sur le microcontr√¥leur Atmega8.  Ce programme n'inclura pas de gestionnaire http.  Il est n√©cessaire de mettre en ≈ìuvre l'√©change de donn√©es le plus simple (RAW) via le protocole TCP √† l'aide d'un terminal distant.  Il n'est pas tout √† fait exact de parler du protocole Telnet, comme le dit le titre de cet article.  Il poss√®de ses propres sp√©cificit√©s bas√©es sur l'√©change d'informations compl√©mentaires sur les param√®tres des terminaux.  Cependant, la plupart des clients Telnet prennent en charge RAW et ne n√©cessitent pas ce qui pr√©c√®de.  Ainsi, le programme Atmega8 MK n'inclura pas de gestionnaire de protocole au niveau de l'application.  Elle ne traitera que de l'initialisation du W5500, de la gestion des sockets, de la r√©ception et de la transmission des donn√©es. <br><br>  L'application principale de cette conception est la gestion des appareils via un terminal distant.  Dans ce cas, la conception est connect√©e √† l'appareil g√©r√© via l'interface UART (trois fils GND, TxD, RxD).  La gestion via le terminal est une approche professionnelle classique dans un domaine particulier en l'absence d'une interface graphique.  Par exemple, une ligne de commande Windows ou Linux, ou un moyen de configurer un routeur via un terminal √† l'aide du protocole Telnet.  Le dernier exemple est en fait √©quivalent √† l'id√©e discut√©e dans cet article. <br><br>  Lors du d√©veloppement de tel ou tel appareil, le cas √©ch√©ant, j'envisage de le contr√¥ler avec des commandes texte via un terminal connect√© via l'interface UART.  Il peut s'agir d'une connexion √† un PC standard au port COM RS-232 via la puce adaptateur MAX232, ou √† l'USB (port COM virtuel) via la puce PL2303.  Vous pouvez utiliser le programme HyperTerminal standard comme terminal.  Avec la propagation des smartphones Android, il est devenu pratique de se connecter via Bluetooth: un module Bluetooth (par exemple, HC-06) est connect√© √† l'interface UART de l'appareil, et un smartphone est connect√© sans fil au module.  Il existe de nombreuses applications sur Internet qui impl√©mentent le terminal via Bluetooth.  Ainsi, vous pouvez contr√¥ler l'appareil via le terminal √† partir d'un t√©l√©phone mobile via Bluetooth dans une courte port√©e.  La conception d√©crite dans cet article vous permet d'impl√©menter le contr√¥le via le terminal √† l'aide d'Internet.  Le terminal peut √™tre l'HyperTerminal standard, fourni avec Windows XP, ou vous pouvez ex√©cuter l'utilitaire telnet √† partir de la ligne de commande Windows et y travailler.  Si nous parlons d'un smartphone, vous pouvez choisir l'une des applications sur Android (il y en a aussi un grand nombre) (Fig.4). <br><br><img src="https://habrastorage.org/webt/4g/ia/x7/4giax7dezsah7q-pjb5eso6tftm.jpeg" width="400" height="640"><br><br>  <i>Fig.</i>  <i>4. Applications pour "terminal TCP" sur Google Play.</i> <br><br>  La puce W5500 dispose de 8 sockets ind√©pendants, chacun ayant une m√©moire pour recevoir et transmettre des informations sur 2 Ko.  Total, la m√©moire totale est de 16 Ko pour la r√©ception et de 16 Ko pour la transmission d'informations.  Ces param√®tres sont utilis√©s par d√©faut, mais si n√©cessaire, au stade de l'initialisation de la puce, la m√©moire peut √™tre r√©allou√©e sur les sockets.  L'application d√©crite ici utilisera les param√®tres de m√©moire par d√©faut et les 8 sockets sont impliqu√©s.  Chaque socket au stade de son initialisation se voit attribuer de nombreux param√®tres dont les principaux sont son mode de fonctionnement et son port TCP.  Le mode de fonctionnement des huit sockets dont nous avons besoin est le mode serveur TCP.  Vous devez affecter diff√©rents ports √† chaque socket.  J'ai pris huit ports cons√©cutifs, √† partir, par exemple, de 4000. √Ä l'√©tape d'initialisation du module W5500, il est affect√© des param√®tres r√©seau c√¢bl√©s dans le programme Atmega8 MK: adresse IP, masque de sous-r√©seau, adresse IP de la passerelle et m√™me l'adresse MAC physique.  Les param√®tres r√©seau du W5500 doivent correspondre aux param√®tres du r√©seau domestique auquel il se connecte.  Lorsque vous vous connectez √† distance √† notre appareil d√©crit, les param√®tres du terminal indiquent l'adresse d'h√¥te (adresse IP ou nom de domaine) et le port.  L'adresse d'h√¥te fait r√©f√©rence au p√©riph√©rique W5500 et le port fait r√©f√©rence au socket du p√©riph√©rique.  Une prise peut fonctionner avec une seule connexion.  Par cons√©quent, il est possible d'√©tablir huit connexions simultan√©es ind√©pendantes.  La figure 5 montre les param√®tres de connexion dans le programme HyperTerminal standard au W5500 avec l'adresse IP 192.168.0.111 au socket 0 (port 4000).  Pour vous connecter √† Internet mondial (de l'ext√©rieur), vous devez configurer correctement votre routeur domestique. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/gl/xf/dt/glxfdtxvfstq3pbj0_bguqpusm8.jpeg"></div>  <i>Fig.</i>  <i>5. Connexion via TCP / IP dans HyperTerminal.</i> <br><br>  J'ai essay√© de nombreuses applications de terminaux TCP diff√©rentes, chacune ayant ses propres avantages et inconv√©nients.  Tout d'abord, par la m√©thode d'emballage d'un paquet TCP, deux cas peuvent √™tre distingu√©s.  Dans le premier cas, un paquet TCP est g√©n√©r√© et envoy√© au serveur imm√©diatement lorsqu'un caract√®re est entr√© dans le terminal.  Ainsi, le champ de donn√©es de chaque paquet prend 1 octet et contient le caract√®re entr√© par l'utilisateur.  Le programme HyperTerminal fonctionne uniquement dans ce mode.  Dans le deuxi√®me cas, le jeu de caract√®res (commande) est entr√© dans un champ de texte s√©par√©, et lorsque vous cliquez sur le bouton "Envoyer", un seul paquet avec un champ de donn√©es est form√©, dont le contenu est un jeu de caract√®res entr√© par l'utilisateur.  La taille du champ de donn√©es d'un tel paquet en octets co√Øncide avec le nombre de caract√®res saisis.  Le deuxi√®me cas est le plus pr√©f√©rable et le plus pratique, tout en √©tant √©conomique en trafic.  Notre conception fonctionne avec les deux cas, transf√©rant √† la sortie (TxD) de l'UART MK Atmega8 tous les caract√®res saisis par l'utilisateur distant depuis n'importe quelle prise. <br><br>  Quant √† l'organisation du transfert d'informations du serveur au client, elles ont ici aussi leurs propres caract√©ristiques.  Il est possible de faire en sorte que le programme MK g√©n√®re un paquet TCP √† un octet √©galement directement, √† la r√©ception d'un octet (caract√®re) sur le tron√ßon RxD UART MK.  Vous pouvez cr√©er un paquet TCP √† partir d'un ensemble d'octets entrants vers le MK par la pr√©sence d'un signal suppl√©mentaire sp√©cial, qui n'est pr√©sent que lors de la transmission de la s√©quence depuis le p√©riph√©rique connect√© (signal d'empaquetage).  Soit dit en passant, ce signal est utilis√© pour commuter le MAX485 en transmission dans le cas de la conversion d'une interface RS-232 en interface RS-485 semi-duplex.  Cependant, comme j'√©tais convaincu, il est plus pratique d'utiliser une minuterie, c'est-√†-dire  un petit d√©lai pendant lequel la r√©ception des caract√®res et la formation du paquet TCP seront effectu√©es.  C'est la m√©thode que j'ai impl√©ment√©e dans la construction d√©crite.  Cela fonctionne comme suit.  La minuterie (la dur√©e est r√©gl√©e environ 0,3 s) d√©marre lorsque le premier personnage arrive et est r√©initialis√©e lorsque chaque personnage suivant arrive sur l'UART MK.  Si aucun caract√®re n'est arriv√© dans un d√©lai sp√©cifi√©, un paquet avec les caract√®res re√ßus est form√© et envoy√© au client, et le temporisateur s'arr√™te.  Dans mon cas particulier, il existe un mailing de masse sur toutes les sockets auxquelles les clients sont connect√©s. <br><br>  Maintenant, ce sera une question de confidentialit√©.  Le terminal distant d√©crit n'est pas prot√©g√© contre l'√©coute √† l'aide d'analyseurs de trafic.  M√™me le protocole Telnet lui-m√™me ne fournit pas d'authentification et de chiffrement par mot de passe.  Pour cela, il existe d'autres protocoles de terminaux distants modernes.  Et dans le cas de Telnet, ainsi que dans le cas de RAW (sans protocole d'application), vous pouvez impl√©menter une m√©thode indirecte d'authentification par mot de passe, qui ne sera inefficace qu'avec une intervention intentionnelle intentionnelle.  Cependant, cette m√©thode d'autorisation prot√©gera contre le trafic "gauche" incontr√¥l√©.  Il peut provenir de logiciels espions qui, en triant la plage d'adresses IP de fournisseurs connus et la plage de ports, peuvent se connecter soudainement √† notre appareil (s'il "√©coute" les connexions Internet).  Dans mon firmware, j'ai impl√©ment√© une page d'accueil client, si elle est connect√©e au serveur, c'est-√†-dire  √† la conception bas√©e sur le module W5500. <br><br>  La page d'accueil contient des informations sur l'adresse IP du client, le num√©ro de socket (pour la surveillance) et une demande de saisie d'un mot de passe (Fig. 6). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ea/nw/2q/eanw2qiq7wtm974w7brndgscqja.jpeg"></div>  <i>Fig.</i>  <i>6. Page d'accueil du serveur W5500.</i> <br><br>  Apr√®s la connexion √† l'int√©rieur du programme MK, une minuterie d√©marre (pendant environ 18 secondes), pendant laquelle l'utilisateur doit avoir le temps d'entrer un mot de passe sp√©cifique (le m√™me sur toutes les sockets).  Si le mot de passe n'est pas entr√© correctement, une fois la dur√©e d√©finie √©coul√©e, l'utilisateur informe le message correspondant et le serveur se d√©connecte (Fig. 7). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/qi/i5/rh/qii5rh4vsutckz8oyinxlurdsv8.jpeg"></div>  <i>Fig.</i>  <i>7. Signaler un mot de passe incorrect.</i> <br><br>  Dans le cas d'un mot de passe correctement entr√©, l'utilisateur re√ßoit √©galement le message correspondant (Fig. 8).  Apr√®s cela, un pont ¬´transparent¬ª est √©tabli entre le terminal distant et l'interface UART du MK, auquel le module W5500 est connect√© via SPI.  Le fonctionnement d'un tel pont n'a √©t√© test√© qu'au niveau des √©quipes d'utilisateurs.  Un √©change de donn√©es √† grande vitesse √† part enti√®re peut ne pas √™tre garanti si, dans certains cas, l'application client n'est pas un terminal utilisateur, mais un autre programme.  Et plus encore, la conception d√©crite ne garantit pas (plus pr√©cis√©ment, n'est pas pr√©vue) l'√©change de donn√©es en duplex int√©gral. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/9j/lx/4c/9jlx4c2o2sjavhkdq2gut43oo7m.jpeg"></div>  <i>Fig.</i>  <i>8. Message sur le mot de passe correct.</i> <br><br>  Lorsqu'un mot de passe est entr√©, l'utilisateur ne renvoie pas les caract√®res qu'il saisit au terminal, et aussi ¬´Retour arri√®re¬ª ne fonctionne pas (restauration avec un caract√®re entr√© incorrectement).  La longueur du mot de passe est de 8 caract√®res.  Le programme MK analyse les 8 premiers caract√®res re√ßus du client, quelle que soit leur distribution sur les paquets TCP.  Mais tout paquet ne doit pas d√©passer 10 octets.  Soit dit en passant, la fonction ¬´Envoyer un fichier texte¬ª dans HyperTerminal fonctionne de mani√®re tr√®s int√©ressante.  Comme il a √©t√© v√©rifi√© √† l'aide d'un analyseur de trafic, lorsque cette fonction est ex√©cut√©e, deux paquets TCP sont form√©s: le premier paquet avec des donn√©es de 1 octet contient le premier caract√®re du fichier texte transmis, et le deuxi√®me paquet contient le reste du contenu. <br><br>  Le serveur fournit deux mots de passe diff√©rents.  Un mot de passe est utilis√© pour √©tablir le pont TCP-UART (utilisation normale), comme d√©crit ci-dessus, et le deuxi√®me mot de passe est utilis√© pour contr√¥ler le module W5500 ou d'autres param√®tres de conception.  Si ce mot de passe est entr√©, l'utilisateur affiche une autre page d'accueil et passe en mode de contr√¥le.  J'ai intentionnellement pr√©vu que ce mode n'√©tait possible que sur l'une des sockets libres.  Si un socket avec ce mode est occup√© et qu'une tentative est effectu√©e pour se connecter √† ce mode sur un autre socket, la connexion sera imm√©diatement d√©connect√©e par le serveur.  Avant la pause, un message sera affich√© sur le num√©ro de socket qui fonctionne d√©j√† (occup√©) en mode de contr√¥le (Fig. 9). <br><br>  Le mode de contr√¥le pr√©voit les commandes que j'ai d√©finies, dont une liste peut √™tre vue en entrant la commande d'aide.  La commande doit se terminer par un caract√®re de nouvelle ligne (touche Entr√©e).  De plus, si le mode de contr√¥le est actif, le serveur W5500 envoie des messages de service au terminal, par exemple, sur la connexion des clients √† d'autres sockets avec leurs adresses IP ou sur un socket libre.  La figure 10 illustre ce qui pr√©c√®de.  La liste des √©quipes n'est pas encore compl√®te, elle sera reconstitu√©e au fil du temps. <br><br><img src="https://habrastorage.org/webt/mb/bu/v_/mbbuv_bfry1kuj83z8wgwzxwbqm.jpeg" width="400" height="340"><br><br>  <i>Fig.</i>  <i>9. Un message sur une prise occup√©e lors de la saisie du mot de passe du mode de contr√¥le.</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/es/dk/sn/esdksn_il5ajj_btzatrxlaxeb4.jpeg"></div>  <i>Fig.</i>  <i>10. Mode de contr√¥le W5500.</i> <br><br>  La commande echo d√©sactive ou active le retour du caract√®re imprim√© au terminal (auto-surveillance).  Les deux commandes suivantes permettent de lire et d'√©crire le registre d'adresses de la puce W5500.  Les valeurs des registres pour les adresses sont indiqu√©es dans la documentation de la puce W5500.  J'ai introduit ces commandes universelles, principalement pour le d√©bogage.  La commande rl red√©marre imm√©diatement le num√©ro de socket indiqu√© apr√®s.  De m√™me, la commande sr lit l'√©tat du socket, en donnant sa valeur sous forme de num√©ro HEX.  La commande "ens" donne un tableau des √©tats pour chaque socket: √©tat "0" - le socket est libre, en attente du client, √©tat "1" - le socket en utilisation normale, √©tat "2" - le socket en mode contr√¥le.  Vous pouvez saisir un nombre beaucoup plus important de commandes.  Il sera utile de modifier les param√®tres qui correspondent √† la puce au stade de l'initialisation lorsque l'appareil est allum√© (par exemple, les param√®tres r√©seau), en les stockant dans la m√©moire non volatile du MK.  Il peut √©galement √™tre utile d'entrer des commandes sp√©ciales qui contr√¥leront des broches MK libres suppl√©mentaires.  Par exemple, ¬´PC0 = 1¬ª, ¬´PC2 = 0¬ª, etc.  Assurez-vous d'avoir besoin de la commande de configuration UART interface MK. <br><br>  Consid√©rez les d√©tails les plus subtils du travail du programme MK.  En plus des minuteries susmentionn√©es, une minuterie est activ√©e, gr√¢ce √† laquelle, toutes les demi-minutes environ, ce que l'on appelle  Paquets de contr√¥le TCP "keep-alive".  Cela est n√©cessaire pour v√©rifier la connexion en l'absence d'√©change de donn√©es utilisateur.  Si, pour une raison quelconque, il n'y a pas de confirmation du client dans un certain d√©lai d√©fini √† l'int√©rieur du W5500, le soi-disant  timeout et le socket red√©marrera.  La connexion peut √™tre soudainement perdue, par exemple, en raison d'une rupture de la liaison de donn√©es ou de la couche physique: ils ont d√©branch√© un c√¢ble Ethernet, d√©connect√© Internet ou perdu une connexion Wi-Fi, etc. <br><br>  Sur la base de la documentation de la puce W5500 (fiche technique), les fonctions suivantes sont impl√©ment√©es dans le code du programme.  Premi√®rement, les fonctions de base de l'√©criture et de la lecture des registres du W5500 aux adresses.  Fonctions de haut niveau - r√©initialisation mat√©rielle, initialisation de la puce, initialisation du socket, ouverture d'un socket, √©coute du socket, d√©connexion et fermeture du socket, envoi de la commande ¬´keep_alive¬ª, red√©marrage du socket.  La derni√®re fonction est une composition des fonctions ci-dessus: fermeture, ouverture, √©coute.  La plupart des fonctions renvoient une valeur d'√©tat de socket apr√®s leur ex√©cution.  Enfin, les fonctions les plus √©l√©mentaires sont le traitement des informations re√ßues (lecture dans le tampon RX) et le traitement des informations envoy√©es (√©criture dans le tampon TX).  J'ai pris des recommandations sur la mise en ≈ìuvre de ces fonctions sur le site officiel du fabricant de puces W5500 ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">lien</a> ).  La fonction de r√©ception √©crase les donn√©es re√ßues du tampon RX dans son propre tampon non-ring de 128 octets.  Cette taille est suffisante pour des applications simples, et vous ne pouvez pas obtenir beaucoup du microcontr√¥leur Atmega8.  Le tampon TX du W5500 transf√®re √©galement les donn√©es du tampon interm√©diaire, qui est √©galement de petite taille.  Et √† son tour, les donn√©es du tampon en anneau UART y p√©n√®trent.  Ce dernier est impl√©ment√© automatiquement dans l'environnement de d√©veloppement CVAVR √† l'aide de l'utilitaire CodeWizardAVR au stade de la cr√©ation du projet. <br><br>  Le W5500 est connect√© √† l'interface MKI SPI (MOSI, MISO, SCK, SCLK).  De plus, la broche RST (r√©initialisation mat√©rielle) est connect√©e √† une sortie MK sp√©cifique et la broche INT correspondante est connect√©e √† l'entr√©e d'interruption externe INT0.  Ce dernier est utilis√© conform√©ment √† sa destination: lorsqu'un √©v√©nement se produit dans le module W5500, il g√©n√®re une impulsion au niveau de la broche INT, qui est trait√©e par le contr√¥leur dans le corps de l'interruption externe.  MK apprend sur quels sockets l'√©v√©nement s'est produit, puis r√©√©crit les codes d'√©v√©nement pour chaque socket dans un tableau sp√©cifique.  Un traitement suppl√©mentaire de l'interruption se produit √† l'int√©rieur de la boucle de programme principale.  Au total, cinq √©v√©nements ont √©t√© document√©s: le client connect√©, le client d√©connect√© (plus pr√©cis√©ment, a d√©pos√© une demande de d√©connexion), des donn√©es ont √©t√© re√ßues du client, un d√©lai d'attente a fonctionn√©, les donn√©es ont √©t√© envoy√©es avec succ√®s.  Dans la boucle principale, tous les √©v√©nements sauf le dernier sont trait√©s.  L'instruction switch-case est plac√©e dans ce traitement.  La plus grande partie du code C se trouve dans la section de traitement du troisi√®me √©v√©nement (r√©ception des donn√©es).  Dans celui-ci, apr√®s la fonction de traitement des informations re√ßues, l'op√©rateur de bo√Ætier de commutation est √©galement plac√©, mais dans ce cas, ce ¬´commutateur¬ª est associ√© √† une variable responsable de l'√©tat de la prise mentionn√©e ci-dessus (valeurs 0, 1, 2).  La premi√®re section est responsable de la proc√©dure de reconnaissance des mots de passe.  Les caract√®res re√ßus sont remplac√©s dans un tampon de mot de passe s√©par√©.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans certaines conditions, les fonctions de comparaison de la cha√Æne re√ßue avec des cha√Ænes constantes contenant des mots de passe fonctionnent. En cas de co√Øncidence, l'√©tat correspondant est attribu√©. La deuxi√®me section est la plus simple - le contenu de son propre tampon d'informations re√ßues est redirig√© vers l'UART du microcontr√¥leur. Il s'agit d'un mode d'utilisation normal. La troisi√®me section (la plus grande) est responsable du traitement des commandes - mode de contr√¥le de p√©riph√©rique.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En plus de la poursuite du gestionnaire d'interruption, la boucle principale du programme contient des gestionnaires de temporisation virtuelle - un d√©lai pour se d√©connecter lorsque le mot de passe √©choue, envoyer p√©riodiquement "keep-alive" et envoyer un paquet form√© par la temporisation TCP au client. La fonction de lecture de l'UART est √©galement plac√©e dans le corps de la boucle principale, √† l'int√©rieur de laquelle les caract√®res re√ßus par le contr√¥leur sont transf√©r√©s dans son propre tampon de transmission (interm√©diaire) et le temporisateur est r√©initialis√©, qui est responsable de la formation du paquet TCP.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Toutes les proc√©dures de socket sont plac√©es dans un cycle de 0 √† 7, dont l'it√©rateur est li√© au num√©ro de socket. Ainsi, le traitement s√©quentiel de toutes les sockets se produit. Au d√©part, je voulais dire que si vous attribuez le m√™me num√©ro de port √† chacune des huit sockets, vous pouvez connecter jusqu'√† huit utilisateurs sur le m√™me port. Cependant, cette configuration n'a pas fonctionn√© et ce probl√®me a √©t√© report√© √† l'avenir.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lors de la conception du circuit imprim√©, j'ai fourni une horloge en temps r√©el (RTC) sur la puce DS1307. L'Atmega8 MK, quartz pour la fr√©quence 11.0592 MHz (fr√©quence s√©lectionn√©e pour la pr√©cision UART), un connecteur pour le module W5500, les connecteurs de port MK (y compris SPI pour le firmware, UART), RTC avec son propre quartz et le compartiment de la pile CR2032 sont situ√©s sur une carte de circuit imprim√© bilat√©rale , R√©gulateur lin√©aire 5 V (7805), connecteur d'alimentation et plus encore. L'esquisse de la carte de circuit imprim√© dans le programme Sprint Layout est illustr√©e √† la figure 11. Le seul √©l√©ment affich√© en rouge est soud√© √† l'arri√®re, mais je l'ai soud√© √† l'avant.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/za/po/fd/zapofdoavvxgcamlagyghd_zkae.jpeg"></div> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. 11. Croquis du circuit imprim√©.</font></font></i> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Des photos de la construction termin√©e sont pr√©sent√©es √† la figure 12. Une horloge de cette construction sera utilis√©e pour marquer l'heure pendant divers √©v√©nements des prises W5500, et cette heure sera attribu√©e √† l'utilisateur dans le terminal √† c√¥t√© du message si l'utilisateur est connect√© en mode de contr√¥le. Et aussi, l'horloge sera utile pour l'avenir pour des exp√©riences avec le protocole de temps NTP ou √† toute autre fin.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/hf/fv/_r/hffv_rfjm1svqdgzmvmauahrmw0.jpeg"></div> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. 12. Photos de la structure finie.</font></font></i> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> En conclusion, il convient de noter que la conception interne justifie en grande partie des dispositifs de niveau industriel similaires. Le principal avantage est le prix. Il s'est av√©r√© √™tre beaucoup moins cher √† fabriquer que le prix d'un appareil similaire fini. Et un inconv√©nient tel qu'une fonctionnalit√© limit√©e est in√©vitable. Dans ce cas, un contr√¥leur Atmega8 simplifi√© a √©t√© utilis√©, car l'objectif simplifi√© correspondant a √©t√© d√©fini.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/hy/ko/fx/hykofxdictcvxijma6idea8hczq.jpeg"></div> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. 13. Convertisseur industriel TCP / IP - RS-232.</font></font></i> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> La figure 13 montre un exemple de convertisseur TCP / IP vers RS-232 industriel bas√© sur la puce W5100, tr√®s similaire au W5500. En plus de son interface de gestion flexible, il pr√©sente un avantage suppl√©mentaire. En plus de travailler avec un terminal TCP / IP, il est possible d'utiliser un pilote sp√©cial fourni avec le p√©riph√©rique pour installer un port COM virtuel c√¥t√© client. Gr√¢ce √† lui, vous pouvez vous connecter en utilisant un terminal ordinaire qui n'a pas de mode de connexion TCP / IP. De plus, l'appareil peut prendre en charge l'√©change de donn√©es RS-232 √† part enti√®re si un programme est connect√© √† la place du terminal via un port COM virtuel. Autrement dit, le dispositif illustr√© √† la figure 13 est un pont RS-232 √† part enti√®re √† travers l'infrastructure r√©seau.</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr414211/">https://habr.com/ru/post/fr414211/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr414199/index.html">Skynet, salut: l'intelligence artificielle a appris √† voir les gens √† travers les murs</a></li>
<li><a href="../fr414201/index.html">Code divin (code de DIEU)</a></li>
<li><a href="../fr414203/index.html">Arnaque ou non arnaque? Nous v√©rifions ICO par cinq m√©thodes</a></li>
<li><a href="../fr414207/index.html">Le probl√®me de l'innovateur, ou pourquoi vous devez vous tourner vers l'exp√©rience des autres</a></li>
<li><a href="../fr414209/index.html">IGNG - Algorithme incr√©mental incr√©mental de gaz neuronal</a></li>
<li><a href="../fr414213/index.html">Un, deux, trois! Chatbot de Google Sheets utilisant l'exemple d'un jeu PvP pour Alice</a></li>
<li><a href="../fr414215/index.html">Blocs personnalis√©s dans les puces (Silicon IP): comment cela fonctionne</a></li>
<li><a href="../fr414217/index.html">Smartphones locaux Vertex: premiers en qualit√©, premiers en puces, premiers en design</a></li>
<li><a href="../fr414219/index.html">L'exp√©rience de l'utilisation de l'√©nergie solaire dans la r√©gion de Moscou: pour, contre et qui en a besoin</a></li>
<li><a href="../fr414221/index.html">Analyser et travailler avec Codable dans Swift 4</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>