<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§úüèΩ üòÖ üëéüèæ IPSec VPN-Verbindung zwischen MikroTik und Kerio Control üì≥ üñïüèΩ üõÉ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Anfangsparameter: 



1. Der Hauptsitz des Unternehmens mit zwei Grenzproxys Kerio Control v.9.2.9 Build 3171 (hinter Kerio befindet sich ein Cisco 35...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>IPSec VPN-Verbindung zwischen MikroTik und Kerio Control</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/439736/"><img src="https://habrastorage.org/webt/zg/b9/cd/zgb9cd1ivkh83waulyxllysswwe.png"><br><br>  Anfangsparameter: <br><br><ol><li>  Der Hauptsitz des Unternehmens mit zwei Grenzproxys Kerio Control v.9.2.9 Build 3171 (hinter Kerio befindet sich ein Cisco 3550-Switch, der die Konfiguration des lokalen Netzwerks des B√ºros bestimmt). </li><li>  Jedes Kerio verf√ºgt √ºber zwei Kan√§le mit Lastausgleich bis zum ISP (im Diagramm - ISP Nr. 1 und ISP Nr. 2) mit statischen wei√üen IPs. </li><li>  Von der Seite des Remote-B√ºros wurde MikroTik 951G-2HnD (OS v.6.43.11) installiert. </li><li>  Zwei ISPs kommen zu MikroTik (im Diagramm sind ISP # 3 und ISP # 4). </li></ol><br>  Zum Zeitpunkt des Schreibens war die Verbindung zu den Anbietern sowohl in der Zentrale als auch in der Gegenstelle Twisted Pair. <br><br><h3>  Die Liste der Aufgaben: </h3><br><ol><li>  Stellen Sie eine IPSec-VPN-Verbindung zwischen MikroTik und Kerio Control her, wobei MikroTik der Initiator sein wird. </li><li> Stellen Sie die Fehlertoleranz der VPN-Verbindung sicher, d. H.  Zus√§tzlich zu der Tatsache, dass MikroTik die Leistung seiner ISPs √ºberwachen muss (Artikel <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a></b> ), muss es auch die Verf√ºgbarkeit jedes Kerio-Servers √ºberwachen und den Zugriff bestimmen, √ºber welchen Kanal (√ºber welchen ISP von Kerio) die Verbindung hergestellt wird. </li><li>  Bieten Sie die M√∂glichkeit, die Netzwerkadresse zu √§ndern, mit der MikroTik eine Verbindung zu Kerio herstellt.  Dies liegt an der Tatsache, dass sich Kerio und kein Router im Hauptquartier der "Grenze" befinden. </li></ol><a name="habracut"></a><br><br><h3>  Was bekommen wir am Ausgang? </h3><br><ol><li>  Wenn MikroTik (ScheduleStartup) gestartet wird, wird ein Kanal zum Unternehmensnetzwerk organisiert (der Kanal wird von MikroTik initiiert), sodass ein Remotebenutzer mit Unternehmensressourcen arbeiten kann, ohne Kerio Client zu starten und ohne eine zus√§tzliche VPN-Verbindung √ºber das Betriebssystem einzurichten. </li><li>  MikroTik implementiert Failover, das automatisch zu einem Live-ISP wechselt. </li><li>  Sie k√∂nnen Priorit√§ten f√ºr Verbindungspunkte zum Unternehmensnetzwerk festlegen, indem Sie die Zugeh√∂rigkeit von Peers √§ndern, die f√ºr die Verbindung mit Kerio Control zu der einen oder anderen Richtlinienvorlagengruppe in MikroTik konfiguriert sind. </li><li>  MikroTik kann die Leistung von Kerio Control-Servern automatisch √ºberwachen. Wenn die Verbindung zum Priorit√§tspunkt unterbrochen wird, wechseln Sie unabh√§ngig zum Live-Kanal. </li><li>  Wenn Ihre Kerio Control-Server auf externen DNS-Servern ver√∂ffentlicht werden, kann MikroTik √Ñnderungen an ihren IP-Adressen verfolgen (z. B. wenn sich Ihr Anbieter √§ndert) und unabh√§ngig √Ñnderungen an seiner Konfiguration vornehmen (scriptSetIPSecSADstAddrFromDNS). </li></ol><br><br>  Ich muss sofort sagen, dass dieser Artikel kein Tutorial ist (im Prinzip habe ich mich erst zwei Monate (Ende 2017) vor der Erstellung der Konfiguration mit Routern und insbesondere mit MikroTik vertraut gemacht) und die Fragen ‚ÄûWarum?‚Äú Nicht behandelt. Es wird hier sein Die Beschreibung der Arbeitskonfiguration von MikroTik, die in einem realen Unternehmen verwendet wird, wird gegeben. <br><br>  <b>Hinweis:</b> <br><ol><li>  Um Kommentare in russischer Sprache beim √úbertragen von Skriptcode an MikroTik beizubehalten, stellen Sie vor dem Kopieren von Text in den Puffer und vor dem Einf√ºgen aus dem Puffer sicher, dass das russische Tastaturlayout aktiviert ist. </li><li>  Wenn Sie feststellen, dass Protokollierungsskripte √ºberfl√ºssig sind, k√∂nnen Sie Zeilen mit "Protokollwarnung" und "Protokollfehler" auskommentieren oder l√∂schen. </li><li>  M√∂glicherweise bemerken Sie auch auskommentierte "Protokollwarnung" und "Protokollfehler" im Code. Dies ist ein Versuch, die M√∂glichkeit hinzuzuf√ºgen, die Protokollierung auf Englisch zu verwenden ... </li></ol><br><br>  Also fangen wir an: <br><br>  <b>Grundparameter:</b> <br><br><ol><li>  Das Netzwerk der √ºbergeordneten Organisation (hinter Kerio) ist 192.168.77.0/24 (hier verwenden wir die Adresse des Netzwerks, in dem sich Kerio im Unternehmensnetzwerk befindet). </li><li>  Filialnetz (hinter MikroTik) - 192.168.11.0/24 </li><li>  Das Netzwerk, dem das Zweigstellennetzwerk zugeordnet wird, wenn eine Verbindung zu Kerio Control Nr. 1 - 192.168.22.0/24 hergestellt wird </li><li>  Das Netzwerk, dem das Zweigstellennetzwerk zugeordnet wird, wenn eine Verbindung zu Kerio Control # 2 - 192.168.33.0/24 hergestellt wird </li><li>  IP-Adresse aus dem ISP # 1-Pool (Kerio # 1) - 11.11.11.111 </li><li>  IP-Adresse aus dem ISP # 2-Pool (Kerio # 1) - 22.22.22.111 </li><li>  IP-Adresse aus dem ISP # 1-Pool (Kerio # 2) - 11.11.11.222 </li><li>  Die IP-Adresse aus dem ISP # 2-Pool (Kerio # 2) lautet 22.22.22.222 </li><li>  IP-Adresse aus dem ISP # 3-Pool (MikroTik) - 33.33.33.111 </li><li>  IP-Adresse aus dem ISP # 4-Pool (MikroTik) - 44.44.44.111 </li></ol><br>  Als erstes m√ºssen Sie DDNS auf MikroTik aktivieren: <br><br><pre><code class="plaintext hljs">/ip cloud set ddns-enabled=yes</code> </pre> <br>  Aufgrund der Tatsache, dass MikroTik keine statische wei√üe IP-Adresse hat, basiert die weitere Arbeit der Konfiguration und der Skripte auf der Verwendung von DDNS. <br><br>  Auch IP ---&gt; Cloud wird verwendet, um die externe IP-Adresse von MikroTik zu bestimmen, von der aus im Internet gesucht wird. <br><br>  Konfigurieren wir nun Kerio Control # 1, damit wir sp√§ter nicht mehr darauf zur√ºckkommen: <br>  Wir gehen zum Abschnitt "Schnittstellen" und f√ºgen die neue "VPN-Tunnel" -Schnittstelle hinzu ... <br><br><div class="spoiler">  <b class="spoiler_title">Tunnelkonfiguration in Kerio Control</b> <div class="spoiler_text">  1. Weisen Sie der Schnittstelle im Feld Name einen Namen zu. <br>  2. Stellen Sie den Schalter auf "Passiv - akzeptiert nur eingehende Verbindungen"; <br>  3. Geben Sie Leave "IPSec" ein. <br>  4. Die Registerkarte "Authentifizierung": <br><br><ul><li>  4.1 Geben Sie im Feld "Vordefinierter Schl√ºssel:" die Schl√ºsselphrase ein, die f√ºr die Verbindung verwendet werden soll. </li><li>  <b>Hinweis:</b> <br><br>  Ich empfehle kategorisch, alle Schl√ºsselphrasen in allen VPN-Tunneln festzulegen, die auf einem bestimmten Kerio-Server erstellt wurden! <br><br>  Dies liegt an der Tatsache, dass Kerio einen schwebenden Fehler hat, der im Folgenden ausgedr√ºckt wird. <br><br>  Stellen Sie sich vor, dass in der Kerio-Konfiguration, wie in meinem Fall, mehrere "VPN-Tunnel" -Schnittstellen f√ºr die Verbindung mit MikroTik konfiguriert sind, die sich nur in den Einstellungen im Feld "Lokale ID:" voneinander unterscheiden (wird unten erl√§utert). <br><br>  Wenn Sie also einen eingehenden Tunnel erstellen (ich werde es so nennen), unabh√§ngig davon, welche externe IP-Adresse Kerio mit MikroTik in Verbindung setzt, aktiviert Kerio (aus irgendeinem Grund) die erste Schnittstelle, auf die gesto√üen wird, und ob die IP-Adresse in den Einstellungen angegeben ist Der Tunnel auf der Kerio-Seite unterscheidet sich von dem, auf den sich MikroTik bezieht. Der Tunnel ist nicht organisiert. <br><br>  Und wenn f√ºr alle Tunnel unterschiedliche Schl√ºsselphrasen angegeben sind, h√∂rt dieses Problem auf. </li><li>  4.2 Geben Sie im Feld "Lokale ID:" die IP-Adresse aus dem ISP # 1-Adresspool (im Beispiel 11.11.11.111) ein, der der Kerio Control # 1-WAN-Schnittstelle zugewiesen ist, auf die MikroTik zugreifen wird. </li><li>  4.3 Geben Sie im Feld ‚ÄûRemote ID:‚Äú den FQDN ein, den unser MikroTik von DDNS erhalten hat (IP ---&gt; Cloud ---&gt; DNS-Name).  Mit dieser Einstellung ist es uns egal, wie ISP MikroTik auf Kerio zugreift. </li><li>  4.4 W√§hlen Sie im Feld "Phase 1-Verschl√ºsselung (IKE):" aes128-sha1-modp2048 aus der Liste aus; </li><li>  4.5 W√§hlen Sie im Feld "Phase 2-Verschl√ºsselung (ESP):" 3des-sha1-modp2048 aus der Liste aus; </li><li>  <b>Hinweis:</b> <br>  Bearbeiten der Standardeinstellungen √ºber die Schaltfl√§che "√Ñndern ..."; <br>  Beide Chiffren werden nach der ‚Äûwissenschaftlichen Stochermethode‚Äú ausgew√§hlt. </li></ul><br>  5. Die Registerkarte "Remote-Netzwerke": <br><br>  Hier geben wir die IP-Adresse des lokalen Netzwerks ein, das MikroTik beim Herstellen einer Verbindung zu diesem bestimmten Kerio Control-Server verwendet (im Beispiel - 192.168.22.0/24). <br>  Wichtig!  In allen anderen (in meinem Fall wird es durch die Anzahl der ISPs von Kerio bestimmt) Tunneln auf MikroTik, auf diesem Kerio-Server muss dieselbe IP-Adresse angegeben werden! <br><br>  Ich m√∂chte Sie daran erinnern, dass dies auf die Notwendigkeit zur√ºckzuf√ºhren ist, die Route zu diesem Netzwerk vom Hauptsitznetzwerk aus zu konfigurieren. <br><br>  6. Die Registerkarte "Lokale Netzwerke": <br><br><ul><li>  6.1 Deaktivieren Sie das Kontrollk√§stchen "Automatisch erkannte lokale Netzwerke verwenden". </li><li>  6.2 Aktivieren Sie das Kontrollk√§stchen "Benutzerdefinierte Netzwerke verwenden:" und f√ºgen Sie der Liste der Netzwerke die Netzwerkadresse hinzu, die den gesamten Adressbereich abdeckt, der im lokalen Netzwerk hinter Kerio Control verwendet wird (im Beispiel - 192.168.0.0/16). </li></ul><br>  Wir wiederholen alle obigen Schritte f√ºr den zweiten Tunnel auf demselben Kerio-Server. <br><br>  Die zweite Tunneleinstellung unterscheidet sich nur durch die Verwendung einer anderen Passphrase (Abschnitt 4.1) und einer anderen externen IP-Adresse aus dem ISP # 2-Adresspool (Abschnitt 4.2) (im Beispiel 22.22.22.111). <br><br>  Die Einstellungen f√ºr Kerio Control Nr. 2 sind mit den oben beschriebenen identisch, mit Ausnahme der auf der Registerkarte Remote-Netzwerke (S. 5) (im Beispiel 192.168.33.0/24) angegebenen Netzwerkadresse und dementsprechend der IP-Adressen im Feld Lokale ID: ( Abschnitt 4.2), der aus den IP-Adressen ausgew√§hlt werden sollte, die den Kerio Control # 2-WAN-Schnittstellen zugewiesen sind (im Beispiel 11.11.11.222 und 22.22.22.222). <br></div></div><br>  Als N√§chstes erstellen wir eine Zulassungsregel zum Pingen unseres Kerio von MikroTik ... <br><br><div class="spoiler">  <b class="spoiler_title">Ping-Regel in Kerio Control</b> <div class="spoiler_text">  Wir gehen zum Abschnitt "Verkehrsregeln" und erstellen eine neue Regel mit den folgenden Parametern: <br><br><ul><li>  Quelle - Geben Sie den FQDN an, den unser MikroTik von DDNS erhalten hat. </li><li>  Ziel - Firewall </li><li>  Service - Ping; </li><li>  Sie k√∂nnen auch die IP-Version (IPv4) angeben, dies ist jedoch nicht erforderlich. </li></ul><br>  Wir speichern die Regel unter einem f√ºr Sie verst√§ndlichen Namen und ziehen sie ganz nach oben in die Liste der Regeln. <br><br>  Wir wiederholen das gleiche Verfahren auf dem zweiten Kerio-Server. <br></div></div><br>  Vergessen Sie nicht, die Routen im Netzwerk hinter MikroTik in Switches oder Routern an der Seite der Zentrale zu registrieren, damit das Netzwerk der Zentrale wei√ü, wohin der Verkehr geleitet werden soll (in meinem Fall sind dies zwei statische Routen in den Netzwerken 192.168.22.0/24 und 192.168.33.0/24). <br><br>  Von der Zentrale aus haben wir alles getan, jetzt wechseln wir zu MikroTik. <br><br>  Beginnen wir mit der Erstellung der grundlegenden Konfigurationsobjekte zum Organisieren und Testen des VPN-Tunnels. <br><br>  Der erste Schritt besteht darin, eine lokale Subnetz-Adressliste zu erstellen.  Wir werden es in Firewall-Regeln verwenden. <br><br><pre> <code class="plaintext hljs">/ip firewall address-list #      MikroTik, # IP-      DHCP add address=192.168.11.0/24 list="Local subnet" #  ,        MikroTik #   VPN-  Kerio Control #1 # (     VPN-  Kerio Control #1, #   " ") add address=192.168.22.0/24 list="Local subnet" #  ,        MikroTik #   VPN-  Kerio Control #2 # (     VPN-  Kerio Control #2, #   " ") add address=192.168.33.0/24 list="Local subnet"</code> </pre> <br>  Erstellen Sie als N√§chstes eine Zulassungsregel f√ºr IKE-Verkehr und platzieren Sie sie ganz oben in der Regelliste. <br><br><pre> <code class="plaintext hljs">add action=accept chain=input comment="VPN Allow IKE" dst-port=500 protocol=udp</code> </pre> <br>  F√ºgen Sie dann dem Firewall-Filter zwei Regeln f√ºr die Arbeit mit VPN-Verkehr hinzu ... <br><br><pre> <code class="plaintext hljs">/ip firewall filter add action=accept chain=forward comment="VPN In IpSec" dst-address-list=\ "Local subnet" ipsec-policy=in,ipsec src-address=192.168.0.0/16 \ src-address-list="!Local subnet" add action=accept chain=forward comment="VPN Out" dst-address=192.168.0.0/16 \ dst-address-list="!Local subnet" src-address-list="Local subnet"</code> </pre> <br>  ... und verschieben Sie sie an eine Position unmittelbar <b>√ºber der Drop-Regel</b> , die eingehenden Datenverkehr von au√üerhalb des LAN verhindert.  In meiner Standardkonfiguration war es mit dem Kommentar "defconf: alles l√∂schen, was nicht aus dem LAN kommt" <br><br>  Gehen Sie zur Firewall Mangle und erstellen Sie die folgenden Regeln: <br><br><pre> <code class="plaintext hljs">/ip firewall mangle #      , #  ... add action=mark-connection chain=prerouting comment="VPN In" \ new-connection-mark=VPN_conn_in passthrough=no src-address=192.168.0.0/16 \ src-address-list="!Local subnet" # ...   add action=mark-routing chain=output comment="VPN In" connection-mark=\ VPN_conn_in new-routing-mark=VPN_route_in passthrough=yes #     MikroTik      . #     NAT. add action=mark-connection chain=postrouting comment="VPN Out" dst-address=\ 192.168.0.0/16 dst-address-list="!Local subnet" new-connection-mark=\ VPN_conn_out passthrough=no</code> </pre> <br>  Als n√§chstes stellen wir in Firewall NAT fest: <br><br><pre> <code class="plaintext hljs">/ip firewall nat #     MikroTik     #      , #    Kerio- (:  Kerio Control #1 - 192.168.22.0/24,  Kerio Control #2 - 192.168.33.0/24) # ! # comment=KerioVpnNatOut   ! add action=netmap chain=srcnat comment=KerioVpnNatOut connection-mark=\ VPN_conn_out to-addresses=192.168.22.0/24 #     MikroTik     #          MikroTik add action=netmap chain=dstnat comment=KerioVpnNatIn connection-mark=\ VPN_conn_in to-addresses=192.168.11.0/24 #  MikroTik  Kerio- add action=accept chain=srcnat comment=KerioVpnNatPing out-interface-list=WAN protocol=icmp</code> </pre> <br>  <b>Wichtig!</b>  Diese Regeln sollten √ºber den Maskierungsregeln platziert werden. <br><br>  Jetzt gehen wir zum Abschnitt IP ---&gt; IPSec, wo wir eine Richtlinie, einen Peer, Richtlinienvorlagengruppen (ich werde ihren Zweck sp√§ter besprechen) und einen Vorschlag zum Einrichten der Phase-2-Verschl√ºsselung erstellen m√ºssen. <br><br><div class="spoiler">  <b class="spoiler_title">IP IPSec Vorschlag</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">/ip ipsec proposal add enc-algorithms=3des name=KerioVPNProposal#01 pfs-group=modp2048</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">ip ipsec-Richtliniengruppe</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">/ip ipsec policy group add name=1 add name=2 add name=3 add name=4</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">ip ipsec peer</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">/ip ipsec peer add address=11.11.11.111/32 comment=vs01-i01-01.domain.ru exchange-mode=\ main-l2tp local-address=33.33.33.111 my-id=\ fqdn:mikrotik.sn.mynetname.net policy-template-group=1 profile=\ profile_4 secret=pass1111</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">IP IPSec-Richtlinie</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">/ip ipsec policy add comment=KerioVPNPolicy dst-address=192.168.77.0/24 proposal=KerioVPNProposal#01 \ sa-dst-address=11.11.11.111 sa-src-address=33.33.33.111 src-address=\ 192.168.22.0/24 tunnel=yes</code> </pre> <br></div></div><br>  Kommentar: <br><br>  1. / ip ipsec-Vorschlag - Geben Sie im Feld "Phase 2-Verschl√ºsselung (ESP):" dieselben Verschl√ºsselungsparameter ein, die wir bei der Konfiguration von Kerio Control angegeben haben. <br><br>  <b>Hinweis:</b> <br><br>  Beachten Sie den Parameter "name = KerioVPNProposal # 01". <br><br>  Es ist nicht erforderlich, diesen Namen speziell zu verwenden. Wenn Sie sich jedoch f√ºr die Verwendung eines anderen Namens entscheiden, m√ºssen Sie nach dem √Ñndern die Einstellung der zugeh√∂rigen IPSec-Richtlinie √ºberpr√ºfen und gegebenenfalls √§ndern sowie den zugewiesenen Wert der Variablen DefKerioPropName im Skript scriptCheckActiveVpnServer √§ndern, der erl√§utert wird Rede weiter. <br><br>  (Tats√§chlich werden die meisten Namen und Kommentare von Objekten in der beschriebenen Konfiguration in Skripten verwendet. Das Umbenennen kann daher zu Unannehmlichkeiten f√ºhren, da √Ñnderungen am Skriptcode vorgenommen werden m√ºssen. Ich werde versuchen, im Text entsprechende Notizen zu machen, um die Suche nach solchen Objekten zu erleichtern.) <br><br>  2. / ip ipsec-Richtliniengruppe <br><br>  Die Erstellung von Gruppen beruht auf der Tatsache, dass wir in Zukunft ihre Namen (1, 2, ... n) in Skripten verarbeiten und sie verwenden, um die IP-Adressen der Kerio-Server zu priorisieren, auf die wir zugreifen werden. <br><br>  Ich erstelle vier Gruppen gleichzeitig.  Ich habe zwei ISPs mit jeweils zwei externen IPs von Kerio.  Derzeit verwenden wir nur eine Gruppe. <br><br>  3. / ip ipsec peer <br><br>  Geben Sie in Peer Folgendes an: <br><br><ul><li>  Adresse - IP-Adresse von Kerio, die mit MikroTik kontaktiert wird.  Die gleiche Adresse, die wir in die / ip ipsec-Richtlinie sa-dst-address eingegeben haben, sollte nur mit der Maske "/ 32" angegeben werden. </li><li>  Lokale Adresse - IP-Adresse von MikroTik, von der aus auf Kerio zugegriffen wird.  Die gleiche Adresse, die wir in der / ip ipsec-Richtlinie sa-src-address eingegeben haben, sollte angegeben werden. </li><li>  Auth.  Methode - W√§hlen Sie "Pre Shared Key" aus der Liste aus. </li><li>  Austauschmodus - W√§hlen Sie main-l2tp aus der Liste aus. </li><li>  Wenn diese Option aktiviert ist, deaktivieren Sie das Kontrollk√§stchen "Passiv". </li><li>  Geheimnis - Geben Sie die Passphrase, die wir bei der Konfiguration der VPN-Schnittstelle unter Kerio eingegeben haben, auf der Registerkarte "Authentifizierung" in das Feld "Vordefinierter Schl√ºssel:" ein. </li><li>  Richtlinienvorlagengruppe - W√§hlen Sie aus der Liste die Gruppe aus, die wir zuvor mit dem Namen "1" erstellt haben. </li><li>  Deaktivieren Sie NAT Traversal. </li><li>  Mein ID-Typ - W√§hlen Sie den Wert "fqdn" aus der Liste aus. </li><li>  Meine ID - Geben Sie den von MikroTik in DDNS zugewiesenen vollqualifizierten Dom√§nennamen ein. </li><li>  W√§hlen Sie auf der Registerkarte "Verschl√ºsselung" die Verschl√ºsselungsparameter aus, die wir bei der Konfiguration der VPN-Schnittstelle unter Kerio eingegeben haben, auf der Registerkarte "Authentifizierung" im Feld "Phase 1 (IKE) -Verschl√ºsselung:". </li><li>  Kommentar ( <b>Warnung! Wird in Skripten verwendet!</b> ). </li></ul><br>  In dem Kommentar gebe ich den vollst√§ndigen technischen vollqualifizierten Dom√§nennamen meiner Server an, die auf den DNS-Servern ver√∂ffentlicht sind, die meine √§u√üere Zone bedienen. <br><br>  Zus√§tzlich zur Verwendung dieser Konfiguration kann ich so die Informationen zu den externen IP-Adressen der verwendeten Kerio-Server auf dem neuesten Stand halten (ich muss nur die IP-Adresse auf dem externen DNS-Server √§ndern und sie wird automatisch in MikroTik ge√§ndert (Artikel <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a></b> )). <br><br>  F√ºr diejenigen, die zu faul sind, um zu verstehen, zitiere ich den Arbeitscode: <br><br><pre> <code class="plaintext hljs">/system script add dont-require-permissions=no name=scriptSetIPSecSADstAddrFromDNS owner=\ admin policy=read,write</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Skriptliste scriptSetIPSecSADstAddrFromDNS</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">:if ([:len [/system script job find script=SetIPSecSADstAddrFromDNS]]&gt;1) do={ :error } :local DnsNameFromComment :local ResolvedIpFromComment :local ResolvedIpWithMaskFromComment :local IpPeerAddr :foreach IpSecPeerCount in=[/ip ipsec peer find] do={ :set DnsNameFromComment [/ip ipsec peer get $IpSecPeerCount comment] :if ($DnsNameFromComment!="") do={ :do { :set ResolvedIpFromComment [:resolve $DnsNameFromComment] :set ResolvedIpWithMaskFromComment ($ResolvedIpFromComment . "/32") :set IpPeerAddr [/ip ipsec peer get $IpSecPeerCount address] :if ($ResolvedIpWithMaskFromComment!=$IpPeerAddr) do={ :log warning ("[SetIPSecSADstAddrFromDNS]     " . DnsNameFromComment . "  IP-  " . $IpPeerAddr . "  " . $ResolvedIpFromComment) #:log warning ("[SetIPSecSADstAddrFromDNS] In the peer to the server " . DnsNameFromComment . " changed IP address from " . $IpPeerAddr . " on " . $ResolvedIpFromComment) /ip ipsec peer set $IpSecPeerCount address=$ResolvedIpWithMaskFromComment } } on-error={ :set ResolvedIpFromComment "unknown" :log error ("[SetIPSecSADstAddrFromDNS]     " . $DnsNameFromComment) #:log error ("[SetIPSecSADstAddrFromDNS] Cant resolve name " . $DnsNameFromComment) } } } :log warning ("[SetIPSecSADstAddrFromDNS]  IP- VPN- ") #:log warning ("[SetIPSecSADstAddrFromDNS] The IP-addresses of the VPN-servers are checked")</code> </pre><br></div></div><br>  <b>Die Grundregel, die f√ºr den Kommentar in Peers</b> gilt, lautet, dass der Name mit Buchstaben und / oder Zahlen ohne Leerzeichen beginnen muss, gefolgt von einem <b>obligatorischen Bindestrich</b> ("-"), gefolgt von einer beliebigen Anzahl beliebiger Zeichen. <br><br>  Ich benutze folgendes Format: <br><br>  vsNN-pNN-NN.domain.ru <br><br>  Wo: <br><br>  vsNN - vpn-server #NN (Dieser Teil des Kommentars wird in Skripten verarbeitet und in IP ---&gt; Firewall ---&gt; Adresslisten verwendet (siehe unten)); <br>  pNN - ISP #NN; <br>  NN - Seriennummer der externen IP-Adresse im Adresspool, die mir vom Anbieter auf Kerio ausgestellt wurde; <br><br>  4. / ip ipsec-Richtlinie <br><br>  In der Politik definieren wir: <br><br><ul><li>  Dst.  Adresse - Netzwerkadresse hinter Kerio (dst-Adresse); </li><li>  Src.  Adresse - Die Netzwerkadresse, an die MikroTik sein lokales Netzwerk (src-Adresse) maskiert (siehe IP-Einstellungen ---&gt; Firewall ---&gt; NAT unten).  Diese Netzwerkadresse ist auf der Kerio-Seite sichtbar (wir haben sie bei der Konfiguration der VPN-Schnittstelle in Kerio auf der Registerkarte Remote-Netzwerke angegeben). </li><li>  Protokoll - 255 (alle); </li><li>  Aktion - verschl√ºsseln; </li><li>  Level - erfordern; </li><li>  IPSec-Protokolle - esp; </li><li>  setze den Parameter tunnel = yes; </li><li>  SA Src.  Adresse - Die externe IP-Adresse von MikroTik, von der aus auf Kerio zugegriffen wird (sa-src-Adresse); </li><li>  SA Dst.  Adresse - IP-Adresse von Kerio, an die MikroTik kontaktiert wird (sa-dst-Adresse); </li><li>  Vorschlag - Geben Sie den Wert ein, der dem Parameter name im Abschnitt / ip ipsec-Vorschlag zugewiesen wurde (in dieser Konfiguration - KerioVPNProposal # 01). </li><li>  Kommentar ( <b>Warnung! Wird in Skripten verwendet!</b> ) - KerioVPNPolicy. </li></ul><br>  Wenn alles richtig gemacht wurde, sollte nach dem Speichern der Richtlinie der Wert "Established" im Feld "PH2 State" angezeigt werden, der die Installation eines VPN-Kanals zwischen MikroTik und Kerio anzeigt. <br>  Sie k√∂nnen dies √ºberpr√ºfen, indem Sie den Status der VPN-Schnittstelle in Kerio Control √ºberpr√ºfen.  Dort sollte im Feld "Information" gegen√ºber der Schnittstelle, zu der die Verbindung hergestellt wird, die Aufschrift "Verbindung zu IP_Ihr_MikroTik wird hergestellt" angezeigt. <br><br>  Wir fahren fort ... <br><br>  Jetzt erstellen wir Peers f√ºr alle verbleibenden IP-Adressen von Kerio-Servern (in meiner Konfiguration m√ºssen drei weitere Peers erstellt werden). <br><br>  Dazu m√ºssen wir alle in Absatz 3 angegebenen Schritte wiederholen (/ ip ipsec peer), aber die folgenden √Ñnderungen beachten: <br><br><ul><li>  Adresse - √Ñndern Sie die IP-Adresse von Kerio. </li><li>  Geheimnis - Geben Sie die Passphrase ein, die sich auf die zu erstellende Verbindung bezieht (pass2222, pass3333, ... passNNNN). </li><li>  Richtlinienvorlagengruppe - W√§hlen Sie die n√§chste Gruppe in der Liste aus der Liste aus (2, 3, ... n). </li></ul><br>  <b>Hinweis:</b> <br><br>  Anschlie√üend k√∂nnen Sie die Priorit√§t Ihrer Server jederzeit √§ndern, indem Sie die Gruppe in den Peer-Einstellungen √§ndern. <br><br><ul><li>  Kommentar - In meinem Fall wird der FQDN eines anderen Kerio-Servers ge√§ndert. </li></ul><br>  Alle anderen Parameter werden wie beim ersten Fest eingegeben.  Diejenigen, die ge√§ndert werden m√ºssen, werden von Skripten verarbeitet und k√∂nnen vorerst unver√§ndert kopiert werden. <br><br>  Der letzte Schritt der Konfiguration vor dem Verbinden von Skripten mit der Arbeit besteht darin, MikroTik als Repository f√ºr Konstanten zu verwenden, die wir in Skripten verwenden werden ... <br>  F√ºgen Sie den Firewall-Adresslisten zwei Listen hinzu ( <b>Warnung! Wird in Skripten verwendet!</b> ): <br><br><pre> <code class="plaintext hljs">/ip firewall address-list add address=192.168.22.0/24 list=vs01 add address=192.168.33.0/24 list=vs02</code> </pre> <br>  In ihnen geben wir die Adressen von Netzwerken unter Bezugnahme auf Kerio-Server-Namenspr√§fixe an, in die wir ausgehenden VPN-Verkehr abbilden. <br><br>  Um die Arbeit all dieser Schande zu automatisieren, f√ºgen wir zwei Skripte und drei Zeitpl√§ne hinzu <b>(wenn Sie sich entscheiden, die Skripte umzubenennen, vergessen Sie nicht, die entsprechenden √Ñnderungen am Code vorzunehmen)</b> . <br><br><pre> <code class="plaintext hljs">/system script add dont-require-permissions=no name=scriptFunctionsList owner=admin policy=ftp,reboot,read,write,policy,test,password,sniff,sensitive,romon</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Skriptliste scriptFunctionsList</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">#   IP --&gt; Cloud   DNS- #  : # # $start (true/false); # #  ""  "updated" :global subUpdateCloudDns do={ put ($start); :if ($start=false) do={ set $CloudDnsStatus; #     set $m 1; log warning ("[subUpdateCloudDns] ---&gt; DDNS  ---&gt;  "); #log warning ("[subUpdateCloudDns] ---&gt; DDNS status ---&gt; CHECK STARTED"); do { log warning ("[subUpdateCloudDns] ---&gt; DDNS ,  ---&gt; " . $m); [/ip cloud force-update]; delay 30000ms; set $CloudDnsStatus ([/ip cloud get status]); set $m ($m+1); :if ($CloudDnsStatus="updated") do={ log warning ("[subUpdateCloudDns] ---&gt; DDNS  ---&gt; " . $CloudDnsStatus); #log warning ("[subUpdateCloudDns] ---&gt; DDNS status ---&gt; " . $CloudDnsStatus); } else={ log error ("[subUpdateCloudDns] ---&gt; DDNS  ---&gt; " . $CloudDnsStatus); #log error ("[subUpdateCloudDns] ---&gt; DDNS status ---&gt; " . $CloudDnsStatus); } } while=(($CloudDnsStatus!="updated") and ($m&lt;10)); return ($CloudDnsStatus); } } #    IP --&gt; Cloud #   : # # 0 - ; # 1 - ,   ; # 2 -    :global subCheckCloudDDNS do={ set $CloudDnsActive ([/ip cloud get ddns-enabled]); #  - ( $m=0 ) set $m 0; :if ($CloudDnsActive=yes) do { #  IP---&gt;Cloud  ( $m=1 ) set $m ($m+1); set $CloudDnsStatus ([/ip cloud get status]); #    IP- (  IP---&gt;Cloud    DNS) set $CloudDnsIP ([/ip cloud get public-address]); set $CheckIpAddr ([resolve [/ip cloud get dns-name]]); :if ($CloudDnsIP!=$CheckIpAddr) do={ #  IP  (  MikroTik  )... set $CloudDnsStatus "updating..."; } :if ($CloudDnsStatus="updated") do { #  IP---&gt;Cloud    ( $m=2 ) set $m ($m+1); } } return ($m); } #       #  : # # $ScriptName ( ) :global subRepeatScript do={ put ($ScriptName); :if ($ScriptName!="") do { [/system script run $ScriptName]; } } #     VPN-   # #   IP- VPN-     :global subGetVpnServers do={ #    IP- VPN-        :foreach IpSecPeerId in=[/ip ipsec peer find passive!=yes] do={ set $CheckIpAddr [/ip ipsec peer get $IpSecPeerId address]; :if ($CheckIpAddr!="") do={ set $MaskPos [find $CheckIpAddr "/"]; set $GroupFromPeer ([/ip ipsec peer get $IpSecPeerId policy-template-group]); set $IpFromPeer ([pick $CheckIpAddr 0 $MaskPos]); set $VpnServersList ($VpnServersList, {{$GroupFromPeer; $IpFromPeer}}); } } return ($VpnServersList); } #        # #    ID   :global subDisableIpSecPeers do={ # ...  ,  (passive=false) ... :foreach IpSecPeerId in=[/ip ipsec peer find passive!=yes] do={ log warning ("[IP IPSec Peer] ---&gt;    ---&gt; " . [/ip ipsec peer get $IpSecPeerId comment]); #log warning ("[IP IPSec Peer] ---&gt; processed peer on ---&gt; " . [/ip ipsec peer get $IpSecPeerId comment]); #  address   ... set $CheckIpAddr [/ip ipsec peer get $IpSecPeerId address]; :if ($CheckIpAddr!="") do={ #  address  ,  IP-  ... set $MaskPos ([find $CheckIpAddr "/"]); set $CheckIpAddr ([pick $CheckIpAddr 0 $MaskPos]); # ...   IPSec- :foreach IpSecPolicyId in=[/ip ipsec policy find sa-dst-address=$CheckIpAddr] do={ :if ($IpSecPolicyId!="") do={ :if ([/ip ipsec policy get $IpSecPolicyId disabled]!=yes) do={ [/ip ipsec policy disable $IpSecPolicyId]; log warning ("[IP IPSec Policy] ---&gt;  " . [/ip ipsec policy get $IpSecPolicyId comment] . " "); #log warning ("[IP IPSec Policy] ---&gt; policy " . [/ip ipsec policy get $IpSecPolicyId comment] . " deactivated"); } #    ID     set $IdList ($IdList, $IpSecPolicyId); } } } # :     ,      :if ([/ip ipsec peer get $IpSecPeerId disabled]!=yes) do={ [/ip ipsec peer disable $IpSecPeerId]; log warning ("[IP IPSec Peer] ---&gt; " . [/ip ipsec peer get $IpSecPeerId comment] . " ---&gt; "); #log warning ("[IP IPSec Peer] ---&gt; " . [/ip ipsec peer get $IpSecPeerId comment] . " ---&gt; deactivated"); } } return ($IdList); } #        #  : # # $PeerID (ID   VPN-); # $PolIdList ( ID  $subDisableIpSecPeers); # $CloudIP (IP MikroTik  DDNS); # $SrcIP (src-address    VPN-) :global subEnableIpSecPeers do={ put ($PeerID); put ($PolIdList); put ($CloudIP); :if (($PeerID!="")&amp;&amp;($PeerID!=nil)&amp;&amp;($PolIdList!="")&amp;&amp;($PolIdList!=nil)&amp;&amp;($CloudIP!="")&amp;&amp;($CloudIP!=nil)) do={ #   VPN- set $ActiveVPN [/ip ipsec peer get $PeerID address]; :if ($ActiveVPN!="") do={ #  ,  IP-   set $MaskPos [find $ActiveVPN "/"]; set $ActiveVPN ([pick $ActiveVPN 0 $MaskPos]); } #   ,      :if ([/ip ipsec peer get $PeerID disabled]=yes) do={ delay 5000ms; [/ip ipsec peer enable $PeerID]; log warning ("[IP IPSec Peer] ---&gt;  peer  ---&gt; " . [/ip ipsec peer get $PeerID address]); #log warning ("[IP IPSec Peer] ---&gt; activated peer on ---&gt; " . [/ip ipsec peer get $PeerID address]); } #    ID   PolIdList, ,    Src. Address, SA Src. Address  SA Dst. Address,   :foreach IpSecPolicyId in=$PolIdList do={ :if ($IpSecPolicyId!="") do={ :if ([/ip ipsec policy get $IpSecPolicyId src-address]!=$SrcIP) do={ [/ip ipsec policy set $IpSecPolicyId src-address=$SrcIP]; log warning ("[IP IPSec Policy] ---&gt;  src-address"); #log warning ("[IP IPSec Policy] ---&gt; src-address changed"); } :if ([/ip ipsec policy get $IpSecPolicyId sa-src-address]!=$CloudIP) do={ [/ip ipsec policy set $IpSecPolicyId sa-src-address=$CloudIP]; log warning ("[IP IPSec Policy] ---&gt;  sa-src-address"); #log warning ("[IP IPSec Policy] ---&gt; sa-src-address changed"); } :if ([/ip ipsec policy get $IpSecPolicyId sa-dst-address]!=$ActiveVPN) do={ [/ip ipsec policy set $IpSecPolicyId sa-dst-address=$ActiveVPN]; log warning ("[IP IPSec Policy] ---&gt;  sa-dst-address"); #log warning ("[IP IPSec Policy] ---&gt; sa-dst-address changed"); } :if ([/ip ipsec policy get $IpSecPolicyId disabled]=yes) do={ delay 3000ms; [/ip ipsec policy enable $IpSecPolicyId]; log warning ("[IP IPSec Policy] ---&gt;  "); #log warning ("[IP IPSec Policy] ---&gt; policy activated"); #  DNS- [/ip dns cache flush] } } } } } #      ID  #  : # # $PeerIP (IP    ); # $CloudIP (IP MikroTik  DDNS); # $action (enable/disable/skip) # #    ID,   ,  :global subGetPoliciesByPeer do={ put ($PeerIP); put ($CloudIP); put ($action); :if (($action="")||($action=nil)) do={ set $action "skip"; } :foreach IpSecPolicyId in=[/ip ipsec policy find sa-dst-address=$PeerIP] do={ :if ($IpSecPolicyId!="") do={ #     $action=disable,   :if (([/ip ipsec policy get $IpSecPolicyId disabled]!=yes)&amp;&amp;($action="disable")) do={ [/ip ipsec policy disable $IpSecPolicyId]; log warning ("[IP IPSec Policy] ---&gt;  "); #log warning ("[IP IPSec Policy] ---&gt; policy deactivated"); } #     $CloudIP  sa-src-address!=$CloudIP ( ISP),     sa-src-address :if (($CloudIP!="")&amp;&amp;($CloudIP!=nil)&amp;&amp;([/ip ipsec policy get $IpSecPolicyId sa-src-address]!=$CloudIP)) do={ [/ip ipsec policy disable $IpSecPolicyId]; [/ip ipsec policy set $IpSecPolicyId sa-src-address=$CloudIP]; log warning ("[IP IPSec Policy] ---&gt;   ---&gt;  sa-src-address ---&gt; " . $CloudIP); #log warning ("[IP IPSec Policy] ---&gt; policy deactivated ---&gt; new sa-src-address ---&gt; " . $CloudIP); #   ,  Kerio   delay 30000ms; } #     $action=enable,   :if (([/ip ipsec policy get $IpSecPolicyId disabled]=yes)&amp;&amp;($action="enable")) do={ [/ip ipsec policy enable $IpSecPolicyId]; log warning ("[IP IPSec Policy] ---&gt;  "); #log warning ("[IP IPSec Policy] ---&gt; policy activated"); #  DNS- [/ip dns cache flush] } #    ID     set $IdList ($IdList, $IpSecPolicyId); } } return ($IdList); } #   local-address  #  : # # $PeerID (ID   VPN-); # $CloudIP (IP MikroTik  DDNS) :global subCheckPeerLocalIp do={ put ($PeerID); put ($CloudIP); :if (($PeerID!="")&amp;&amp;($PeerID!=nil)&amp;&amp;($CloudIP!="")&amp;&amp;($CloudIP!=nil)) do={ #   DDNS-IP :if ([/ip ipsec peer get $PeerID local-address]!=$CloudIP) do={ [/ip ipsec peer set $PeerID local-address=$CloudIP]; log warning ("[IP IPSec Peer] ---&gt;  local-address"); #log warning ("[IP IPSec Peer] ---&gt; local-address changed"); } } }</code> </pre> <br></div></div><br><pre> <code class="plaintext hljs">/system script add dont-require-permissions=no name=scriptCheckActiveVpnServer owner=admin policy=ftp,reboot,read,write,policy,test,password,sniff,sensitive,romon</code> </pre><br><div class="spoiler"> <b class="spoiler_title">  scriptCheckActiveVpnServer</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">:if ([:len [/system script job find script=scriptCheckActiveVpnServer]]&gt;1) do={ :error } #      scheduleStartup #   ,       :global subCheckCloudDDNS :global subCheckPeerLocalIp :global subDisableIpSecPeers :global subEnableIpSecPeers :global subGetPoliciesByPeer :global subGetVpnServers :global subUpdateCloudDns :local CheckIP :local CheckPeer #     DDNS ( ) :local CloudDnsStatus ([:put [$subCheckCloudDDNS]]) :local Exit false :local DefMikroTikSrcNet 192.168.11.0/24 :local DefKerioDstNet 192.168.77.0/24 :local DefKerioPropName KerioVPNProposal#01 :local DefKerioPolName KerioVPNPolicy :local IpSecPolicyId :local KerioName :local KerioVpnNatRuleName KerioVpnNatOut :local m :local n 1 :local PeerCount 0 :local PeerDisabled :local PingCount 3 :local PingResult :local PoliciesList :local PublicIp :local VpnServersList #   DDNS ,  ,    IP- MikroTik :if ($CloudDnsStatus=0) do={ #  Cloud DDNS  ,         :log error ("[schedule CheckActiveVpnServer] ---&gt;    VPN-   Cloud DDNS! (IP -&gt; Cloud)") # :log error ("[schedule CheckActiveVpnServer] ---&gt; to connect to the VPN server, you need to activate Cloud DDNS! (IP -&gt; Cloud)") :error } :if ($CloudDnsStatus=1) do={ #  Cloud DDNS ,   ,   ( ) :set CloudDnsStatus [:put [$subUpdateCloudDns start=false]] :if ($CloudDnsStatus="updated") do={ :set CloudDnsStatus 2 } } :if ($CloudDnsStatus=2) do { #  Cloud DDNS    ... #  IP  DDNS :set PublicIp [/ip cloud get public-address] #   VPN-  ,    ( ) :set VpnServersList ([:put [$subGetVpnServers]]) #     :foreach VpnIpId in=$VpnServersList do={ :set PeerCount ($PeerCount+1) } #   VPN-    DDNS-IP ( ,   VPN-    ) :while (($Exit!=true)&amp;&amp;$n&lt;=$PeerCount) do={ :foreach VpnIpId in=$VpnServersList do={ #  IP- VPN-    :if (($VpnIpId-&gt;0)=$n) do={ :set CheckIP ($VpnIpId-&gt;1) :if ($CheckIP!="") do={ #    IP :set PingResult ([:put [/ping address=$CheckIP count=$PingCount src-address=$PublicIp]]) :if ($PingResult=$PingCount) do={ :log warning ("[schedule CheckActiveVpnServer] ---&gt; DDNS-IP ---&gt; " . $PublicIp . " ---&gt; VPN-IP ---&gt; " . $CheckIP . " ---&gt; Ping Result ---&gt; " . $PingResult) #  IP ,     IP- :set CheckPeer (:put [/ip ipsec peer find address=($CheckIP . "/32")]) :if ($CheckPeer!="") do={ #   ,     src- (IP ---&gt; Firewall ---&gt; Address Lists),     Kerio #    Kerio    :set KerioName [/ip ipsec peer get $CheckPeer comment] #    (  ,  FQDN  Kerio   KerioName-Parameter1-...-Parameter_n :if ($KerioName!="") do={ #    :set m ([find $KerioName "-"]) #  KerioName    :set KerioName ([pick $KerioName 0 $m]) #    Firewall -&gt; Address List (       : # Name ---&gt; KerioName (eg srv1) # Address ---&gt; DefMikroTikSrcNet (eg 192.168.99.0/24)) :set m [/ip firewall address-list find list=$KerioName] :set DefMikroTikSrcNet ([/ip firewall address-list get $m address]) } # ...          Kerio :set IpSecPolicyId (:put [/ip ipsec policy find comment="$DefKerioPolName"]) #      ,       # (    )         :if ($IpSecPolicyId="") do={ [/ip ipsec policy add disabled=yes dst-address=$DefKerioDstNet proposal=$DefKerioPropName sa-dst-address=$CheckIP sa-src-address=$PublicIp src-address=$DefMikroTikSrcNet tunnel=yes comment=$DefKerioPolName place-before=0] :log warning ("[schedule CheckActiveVpnServer] ---&gt;   " . $DefKerioPolName . " ---&gt;    ") #:log warning ("[schedule CheckActiveVpnServer] ---&gt; created policy " . $DefKerioPolName . " ---&gt; default parameters used") } else={ #   ,     src-address,   . :if ($DefMikroTikSrcNet!=[/ip ipsec policy get $IpSecPolicyId src-address]) do={ [/ip ipsec policy set $IpSecPolicyId src-address=$DefMikroTikSrcNet]; :log warning ("[schedule CheckActiveVpnServer] ---&gt;  " . $DefKerioPolName . "  ---&gt; src-address   ---&gt; " . $DefMikroTikSrcNet) #:log warning ("[schedule CheckActiveVpnServer] ---&gt; policy " . $DefKerioPolName . " changed ---&gt; src-address changed to ---&gt; " . $DefMikroTikSrcNet) } } #   :set m #  NAT-      Kerio  :set m [/ip firewall nat find comment=$KerioVpnNatRuleName] :if ($m!="") do={ #   src-address   ipsec,       Kerio  :if ([/ip firewall nat get $m to-addresses]!=$DefMikroTikSrcNet) do={ [/ip firewall nat set $m to-addresses $DefMikroTikSrcNet] :log warning ("[IP Firewall NAT] ---&gt;    ---&gt; " . $KerioVpnNatRuleName) #:log warning ("[IP Firewall NAT] ---&gt; netmap rule changed ---&gt; " . $KerioVpnNatRuleName) } } # ... local-address      IP MikroTik,    ( ) :put [$subCheckPeerLocalIp PeerID=$CheckPeer CloudIP=$PublicIp] # ...    :set PeerDisabled ([/ip ipsec peer get $CheckPeer disabled]) :if ($PeerDisabled=true) do={ #   ... #       ( ) :set PoliciesList ([:put [$subDisableIpSecPeers]]) #     VPN-   ( ) :put [$subEnableIpSecPeers PeerID=$CheckPeer PolIdList=$PoliciesList CloudIP=$PublicIp SrcIP=$DefMikroTikSrcNet] } else={ #   ... #      ,    ( ) :set PoliciesList ([:put [$subGetPoliciesByPeer PeerIP=$CheckIP CloudIP=$PublicIp SrcIP=$DefMikroTikSrcNet action="enable"]]) } :set Exit true } } else={ :log error ("[schedule CheckActiveVpnServer] ---&gt; DDNS-IP ---&gt; " . $PublicIp . " ---&gt; VPN-IP ---&gt; " . $CheckIP . " ---&gt; Ping Result ---&gt; " . $PingResult) } } } } :set n ($n+1) } }</code> </pre><br></div></div><br><pre> <code class="plaintext hljs">/system scheduler add interval=1h name=scheduleCheckIPSecSADstAddrFromDNS on-event=\ "/system script run scriptSetIPSecSADstAddrFromDNS" policy=read,write \ start-date=oct/30/2017 start-time=00:10:00 add name=scheduleStartup on-event=":global StartupScript true :global RepeatRun false /system script run scriptFunctionsList" policy=\ ftp,reboot,read,write,policy,test,password,sniff,sensitive,romon \ start-time=startup add interval=5m name=scheduleCheckActiveVpnServer on-event=\ "/system script run scriptCheckActiveVpnServer" policy=\ ftp,reboot,read,write,policy,test,password,sniff,sensitive,romon \ start-date=nov/29/2017 start-time=00:00:00</code> </pre><br><div class="spoiler"> <b class="spoiler_title">  scheduleStartup</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">:global StartupScript true :global RepeatRun false /system script run scriptFunctionsList</code> </pre><br></div></div><br><div class="spoiler"> <b class="spoiler_title">  scheduleCheckIPSecSADstAddrFromDNS</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">/system script run scriptSetIPSecSADstAddrFromDNS</code> </pre><br></div></div><br><div class="spoiler"> <b class="spoiler_title">  scheduleCheckActiveVpnServer</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">/system script run scriptCheckActiveVpnServer</code> </pre><br></div></div><br><br> <b> :</b> <br>    MikroTik  DNS- ,   Kerio Control,         MikroTik,   IP ---&gt; DNS ---&gt; Static‚Ä¶ <br><br>   - ! <br><br> ,       ‚Ä¶ <br><br>  Vielen Dank f√ºr Ihre Aufmerksamkeit! <br><br>  ps <br> <b>   :</b> <br><ol><li>   ¬´   ?:¬ª; </li><li>       ; </li><li>  IP- ,   ISP,    ; </li><li>   ¬´ :¬ª; </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de439736/">https://habr.com/ru/post/de439736/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de439726/index.html">Lock-in: wahr oder fiktiv?</a></li>
<li><a href="../de439728/index.html">Konfigurieren Sie die vollst√§ndige und separate Sicherung und Wiederherstellung von Zimbra OSE ohne Verwendung von Zextras</a></li>
<li><a href="../de439730/index.html">Organisation des Reduzierers durch eine Standardklasse</a></li>
<li><a href="../de439732/index.html">Lazarus - einfache Animation mit der TImageFragment-Komponente</a></li>
<li><a href="../de439734/index.html">Bereitstellung von Kubernetes auf dem Desktop in wenigen Minuten mit MicroK8s</a></li>
<li><a href="../de439738/index.html">Auf der Suche nach der Schaltfl√§che "Gut machen". Zyxel im Netzwerk kleiner und mittlerer Unternehmen</a></li>
<li><a href="../de439742/index.html">Zulassung zum Masterstudiengang JetBrains an der ITMO University</a></li>
<li><a href="../de439744/index.html">Forscher vom MIT entwickelten eine ‚ÄûRectenna‚Äú, die Wi-Fi-Signale in Elektrizit√§t umwandelt</a></li>
<li><a href="../de439746/index.html">Grundlegendes zu JavaScript-Versprechen</a></li>
<li><a href="../de439748/index.html">Die Zusammenfassung interessanter Materialien f√ºr den mobilen Entwickler # 285 (vom 4. bis 10. Februar)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>