<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üåà üëâüèæ üôçüèø Disjoncteur Istio: d√©connectez les conteneurs cass√©s üà∑Ô∏è üêøÔ∏è üë∂</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Les vacances sont termin√©es et nous revenons avec notre deuxi√®me article de la s√©rie Istio Service Mesh. 



 Le sujet d'aujourd'hui est Circuit Break...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Disjoncteur Istio: d√©connectez les conteneurs cass√©s</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/redhatrussia/blog/483262/">  Les vacances sont termin√©es et nous revenons avec notre deuxi√®me article de la s√©rie Istio Service Mesh. <br><br><img src="https://habrastorage.org/webt/vb/9o/rl/vb9orlnb9lwiilx0aknfy1ikqs0.png" width="100%"><br><br>  Le sujet d'aujourd'hui est Circuit Breaker, qui, traduit en russe par √©lectrotechnique, signifie ¬´disjoncteur¬ª, famili√®rement - ¬´disjoncteur¬ª.  Ce n'est qu'√† Istio que cette machine d√©connecte non pas les circuits court-circuit√©s ou surcharg√©s, mais les conteneurs d√©fectueux. <br><a name="habracut"></a><br><h3>  Comment cela devrait fonctionner id√©alement </h3><br>  Lorsque les microservices sont g√©r√©s par Kubernetes, par exemple, dans le cadre de la plate-forme OpenShift, ils √©voluent automatiquement vers le haut et vers le bas en fonction de la charge.  √âtant donn√© que les microservices fonctionnent dans des modules, il peut y avoir plusieurs instances de microservices conteneuris√©s √† un point de terminaison, et Kubernetes acheminera les demandes et √©quilibrera la charge entre elles.  Et - id√©alement - tout cela devrait fonctionner parfaitement. <br><br>  Nous nous souvenons que les microservices sont petits et √©ph√©m√®res.  L'√©ph√©m√©ralit√©, qui signifie ici la simplicit√© d'√©mergence et de disparition, est souvent sous-estim√©e.  La naissance et la mort de la prochaine instance de microservice dans pod sont tr√®s attendues, OpenShift et Kubernetes le font bien, et tout fonctionne tr√®s bien - mais encore une fois en th√©orie. <br><br><h3>  Comment √ßa marche vraiment </h3><br>  Imaginons maintenant qu'une instance particuli√®re du microservice, c'est-√†-dire le conteneur, soit devenue inutilisable: soit elle ne r√©pond pas (erreur 503) ou, ce qui est plus d√©sagr√©able, elle r√©agit, mais trop lentement.  En d'autres termes, il coupe le son ou ne r√©pond pas aux demandes, mais il ne le supprime pas automatiquement du pool.  Que faut-il faire dans ce cas?  Essayez encore?  Le supprimer du sch√©ma de routage?  Et que signifie ¬´trop lent¬ª - combien est-ce en nombre et qui les d√©termine?  Peut-√™tre juste lui donner une pause et essayer plus tard?  Si oui, combien plus tard? <br><br><h3>  Qu'est-ce que l'√©jection de piscine √† Istio </h3><br>  Et ici, Istio vient √† la rescousse avec ses disjoncteurs, qui √©liminent temporairement les conteneurs d√©fectueux du pool de ressources de routage et d'√©quilibrage de charge, mettant en ≈ìuvre la proc√©dure d'√©jection du pool. <br><br>  √Ä l'aide d'une strat√©gie de d√©tection des valeurs aberrantes, Istio d√©tecte les courbes de pod qui sont √©limin√©es de la ligne g√©n√©rale et les supprime du pool de ressources pendant un temps donn√©, appel√© ¬´fen√™tre de sommeil¬ª. <br><br>  Pour montrer comment cela fonctionne dans Kubernetes sur la plate-forme OpenShift, nous commen√ßons par une capture d'√©cran des microservices fonctionnant normalement √† partir de l'exemple dans le r√©f√©rentiel de <a href="https://github.com/redhat-developer-demos/istio-tutorial">d√©mos de d√©veloppeurs Red Hat</a> .  Ici, nous avons deux pods, v1 et v2, dans chacun desquels un conteneur fonctionne.  Lorsque les r√®gles de routage d'Istio ne sont pas utilis√©es, Kubernetes applique par d√©faut un routage √† tour de r√¥le uniform√©ment √©quilibr√©: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/bh/b0/dr/bhb0drqlbvo9j0ataogejcgpwue.png"></div><br><h3>  Se pr√©parer pour un crash </h3><br>  Avant de proc√©der √† l'√©jection de pool, vous devez cr√©er une r√®gle de routage Istio.  Supposons que nous voulons r√©partir les demandes entre les pods par rapport √† 50/50.  De plus, nous augmenterons le nombre de conteneurs v2 de un √† deux, comme ceci: <br><br><pre><code class="plaintext hljs">oc scale deployment recommendation-v2 --replicas=2 -n tutorial</code> </pre> <br>  Nous d√©finissons maintenant une r√®gle de routage pour que le trafic soit r√©parti entre les pods dans un rapport 50/50. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/w2/51/pz/w251pzvoaokm49bpul5ehfwsewm.png"></div><br>  Et voici le r√©sultat de cette r√®gle: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/wy/22/ww/wy22wwbkg2vync-id4jbhv22ftk.png"></div><br>  Il est possible de se plaindre que sur cet √©cran ce n'est pas 50/50, mais 14: 9, mais avec le temps la situation s'am√©liorera. <br><br><h3>  Nous organisons un √©chec </h3><br>  Et maintenant, nous allons d√©sactiver l'un des deux conteneurs v2 afin d'avoir un conteneur sain v1, un conteneur sain v2 et un conteneur d√©fectueux v2: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/or/0x/w1/or0xw1jvinlrjkmz3lnttvdh0zo.png"></div><br><h3>  R√©soudre le crash </h3><br>  Nous avons donc un conteneur d√©fectueux, et il est temps pour Pool Ejection.  En utilisant une configuration tr√®s simple, nous exclurons ce conteneur d√©faillant de tout sch√©ma de routage pendant 15 secondes dans l'espoir qu'il reviendra √† un √©tat sain (soit il red√©marrera, soit il restaurera les performances).  Voici √† quoi ressemble cette config et les r√©sultats de son travail: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/xz/6u/7e/xz6u7emeucpeqn6ozq7rnsibtxy.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/yk/m6/3t/ykm63tdppq-qphkyhikilfcwkai.png"></div><br>  Comme vous pouvez le voir, le conteneur d√©fectueux v2 n'est plus utilis√© lors du routage des demandes, car il a √©t√© supprim√© du pool.  Mais apr√®s 15 secondes, il retournera automatiquement √† la piscine.  En fait, nous venons de montrer comment fonctionne Pool Ejection. <br><br><h3>  Commencez √† construire l'architecture </h3><br>  Pool Ejection, combin√© aux capacit√©s de surveillance d'Istio, vous permet de commencer √† cr√©er un cadre pour remplacer automatiquement les conteneurs d√©fectueux afin de r√©duire, voire d'√©liminer les temps d'arr√™t et les plantages. <br><br>  La NASA a une devise de haut niveau - l'√©chec n'est pas une option, √©crit par le directeur de vol <a href="https://ru.wikipedia.org/wiki/%25D0%259A%25D1%2580%25D0%25B0%25D0%25BD%25D1%2586,_%25D0%2594%25D0%25B6%25D0%25B8%25D0%25BD">Gene Krantz</a> .  Il peut √™tre traduit en russe par ¬´la d√©faite n'est pas une option¬ª, et le fait est que tout peut √™tre fait pour fonctionner avec suffisamment de volont√©.  Cependant, dans la vraie vie, les √©checs ne se produisent pas simplement, ils sont in√©vitables, partout et en tout.  Et comment y faire face dans le cas des microservices?  √Ä notre avis, il vaut mieux ne pas compter sur la volont√©, mais sur les capacit√©s des conteneurs, <a href="https://developers.redhat.com/topics/kubernetes/">Kubernetes</a> , <a href="https://developers.redhat.com/products/openshift/overview/">Red Hat OpenShift</a> et <a href="https://developers.redhat.com/topics/service-mesh/">Istio</a> . <br><br>  Istio, comme nous l'avons √©crit ci-dessus, met en ≈ìuvre le concept de disjoncteurs, qui a fait ses preuves dans le monde physique.  Et tout comme une machine automatique d√©connecte une partie probl√©matique d'un circuit, le logiciel Circuit Breaker dans Istio d√©connecte la connexion entre le flux de demandes et le conteneur de probl√®mes lorsque quelque chose ne va pas avec le point de terminaison, par exemple, lorsque le serveur tombe en panne ou commence √† ralentir. <br><br>  De plus, dans le deuxi√®me cas, il n'y a que plus de probl√®mes, car les freins d'un conteneur non seulement provoquent une cascade de retards dans les services qui y acc√®dent et, par cons√©quent, r√©duisent les performances du syst√®me dans son ensemble, mais provoquent √©galement des demandes r√©p√©t√©es au service d√©j√† lent, ce qui ne fait qu'exacerber la situation. . <br><br><h3>  Disjoncteur en th√©orie </h3><br>  Le disjoncteur est un proxy qui contr√¥le le flux des demandes vers le point de terminaison.  Lorsque ce point cesse de fonctionner ou, selon les param√®tres, il commence √† ralentir, le proxy se d√©connecte du conteneur.  Le trafic est ensuite redirig√© vers d'autres conteneurs, juste √† cause de l'√©quilibrage de charge.  La connexion reste ouverte (ouverte) pendant une fen√™tre de sommeil donn√©e, disons deux minutes, puis est consid√©r√©e comme semi-ouverte (semi-ouverte).  Tenter d'envoyer la demande suivante d√©termine l'√©tat de communication suppl√©mentaire.  Si tout va bien avec le service, la connexion revient √† l'√©tat op√©rationnel et se ferme √† nouveau.  S'il y a toujours un probl√®me avec le service, la connexion s'ouvre et la fen√™tre de veille est r√©activ√©e.  Voici √† quoi ressemble le diagramme d'√©tat simplifi√© du disjoncteur: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/qg/0g/z4/qg0gz47wjymiayq4bgshfsrceyy.png"></div><br>  Il est important de noter ici que tout cela se passe au niveau, pour ainsi dire, de l'architecture syst√®me.  Par cons√©quent, √† un moment donn√©, vous devrez apprendre √† vos applications √† travailler avec le disjoncteur, par exemple, fournir une valeur par d√©faut en r√©ponse ou, si possible, ignorer l'existence du service.  Un mod√®le de cloison est utilis√© pour cela, mais il d√©passe le cadre de cet article. <br><br><h3>  Disjoncteur en pratique </h3><br>  Par exemple, nous lancerons sur OpenShift deux versions de notre microservice de recommandations.  La version 1 fonctionnera bien, mais dans la v2, nous int√©grerons un d√©lai pour simuler les freins sur le serveur.  Pour afficher les r√©sultats, utilisez l'outil de <a href="https://github.com/JoeDog/siege">si√®ge</a> : <br><br><pre> <code class="plaintext hljs">siege -r 2 -c 20 -v customer-tutorial.$(minishift ip).nip.io</code> </pre><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/kn/qa/e_/knqae_n13cpibc7tc9lk7fc5lqq.png"></div><br>  Tout semble fonctionner, mais √† quel prix?  √Ä premi√®re vue, nous avons une disponibilit√© √† 100%, mais regardons de plus pr√®s - la dur√©e maximale des transactions peut atteindre 12 secondes.  Il s'agit clairement d'un goulot d'√©tranglement et doit √™tre brod√©. <br><br>  Pour ce faire, nous utiliserons Istio pour √©liminer l'acc√®s aux conteneurs lents.  Voici √† quoi ressemble la configuration correspondante en utilisant le disjoncteur: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/eh/ld/f4/ehldf4gh5qxkwqckn3naufhfs2a.png"></div><br>  La derni√®re ligne avec le param√®tre httpMaxRequestsPerConnection signale que la connexion avec doit s'ouvrir lorsque vous essayez de cr√©er une connexion de plus - la seconde - en plus de la connexion existante.  √âtant donn√© que notre conteneur imite un service de freinage, de telles situations se produisent p√©riodiquement, puis Istio retournera une erreur 503, et voici ce que le si√®ge montrera: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/vv/9h/g5/vv9hg56bzoliqjb6tay19as6mn0.png"></div><br><h3>  OK, nous avons un disjoncteur, quelle est la prochaine √©tape? </h3><br>  Nous avons donc impl√©ment√© un arr√™t automatique, sans toucher au code source des services eux-m√™mes.  En utilisant le disjoncteur et la proc√©dure d'√©jection de piscine d√©crits ci-dessus, nous pouvons retirer les conteneurs de frein du pool de ressources jusqu'√† ce qu'ils reviennent √† la normale et v√©rifier leur √©tat √† une fr√©quence donn√©e - dans notre exemple, cela fait deux minutes (param√®tre sleepWindow). <br><br>  Veuillez noter que la capacit√© de l'application √† r√©pondre √† l'erreur 503 est toujours d√©finie au niveau de son code source.  Il existe de nombreuses strat√©gies pour travailler avec un disjoncteur, qui sont appliqu√©es en fonction de la situation. <br><br>  <b>Dans le prochain article: nous</b> parlerons du tra√ßage et de la surveillance, qui sont d√©j√† int√©gr√©s ou facilement ajout√©s √† Istio, ainsi que de la mani√®re d'introduire intentionnellement des erreurs dans le syst√®me. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr483262/">https://habr.com/ru/post/fr483262/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr483252/index.html">Maximalisme juv√©nile et esprit de contradiction chez les adolescents du point de vue de la neurologie</a></li>
<li><a href="../fr483254/index.html">Dans les coulisses de la vie d'un mod√©rateur de d√©bordement de pile</a></li>
<li><a href="../fr483256/index.html">Une compilation de faits statistiques amusants # 3</a></li>
<li><a href="../fr483258/index.html">Les plateformes low-code: une panac√©e ou un pari risqu√©?</a></li>
<li><a href="../fr483260/index.html">Comment prendre des d√©cisions et hi√©rarchiser les t√¢ches lors de la cr√©ation d'un produit</a></li>
<li><a href="../fr483264/index.html">Dijkstra: La plus grande victoire de l'Occident dans la guerre froide sur l'URSS a √©t√© la transition vers IBM - le mythe √©clat√©</a></li>
<li><a href="../fr483266/index.html">Ind√©pendance financi√®re. Ce qui a chang√© au cours de l'ann√©e</a></li>
<li><a href="../fr483268/index.html">Le livre "Fashion, Faith, Fantasy and the New Physics of the Universe"</a></li>
<li><a href="../fr483270/index.html">L'√©volution des applications HighLoad sur l'exemple d'un portail r√©gional de services publics</a></li>
<li><a href="../fr483272/index.html">Le chemin de la restauration √† l'entreprise informatique</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>