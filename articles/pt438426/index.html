<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üõåüèæ üê∫ üé¥ Voltar aos microsservi√ßos com Istio. Parte 1 ‚õé üíï ü§∞üèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nota perev. : Malhas de servi√ßo definitivamente se tornaram uma solu√ß√£o relevante na infraestrutura moderna para aplicativos que seguem a arquitetura ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Voltar aos microsservi√ßos com Istio. Parte 1</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/438426/"><img src="https://habrastorage.org/webt/bj/j4/oy/bjj4oyjxqshrbjf5eks9sgsvbeg.png"><br><br>  <i><b>Nota</b></i>  <i><b>perev.</b></i>  <i>: Malhas de servi√ßo definitivamente se tornaram uma solu√ß√£o relevante na infraestrutura moderna para aplicativos que seguem a arquitetura de microsservi√ßo.</i>  <i>Embora o Istio possa ser ouvido por muitos engenheiros do DevOps, √© um produto relativamente novo, que, sendo abrangente em termos dos recursos fornecidos, pode exigir um tempo consider√°vel para se conhecer.</i>  <i>O engenheiro alem√£o Rinor Maloku, respons√°vel pela computa√ß√£o em nuvem para grandes clientes da empresa de telecomunica√ß√µes Orange Networks, escreveu uma maravilhosa s√©rie de materiais que permitem que voc√™ mergulhe r√°pida e profundamente no Istio.</i>  <i>Ele come√ßa sua hist√≥ria com o que Istio pode fazer e como voc√™ pode v√™-la rapidamente com seus pr√≥prios olhos.</i> <br><br>  <b>Istio</b> √© um projeto de c√≥digo aberto desenvolvido em colabora√ß√£o com equipes do Google, IBM e Lyft.  Ele resolve as dificuldades que surgem em aplicativos baseados em microsservi√ßos, por exemplo, como: <a name="habracut"></a><br><br><ul><li>  <b>Gerenciamento de tr√°fego</b> : tempos limite, novas tentativas, balanceamento de carga; </li><li>  <b>Seguran√ßa</b> : autentica√ß√£o e autoriza√ß√£o do usu√°rio final; </li><li>  <b>Observabilidade</b> : rastreamento, monitoramento, registro. </li></ul><br>  Todos eles podem ser resolvidos no n√≠vel do aplicativo, mas depois disso seus servi√ßos deixar√£o de ser "micro".  Todos os esfor√ßos adicionais para resolver esses problemas s√£o um desperd√≠cio extra de recursos da empresa que podem ser usados ‚Äã‚Äãdiretamente para os valores de neg√≥cios.  Considere um exemplo: <br><blockquote> Gerente de projeto: quanto tempo adicionar feedback? <br>  Desenvolvedor: Dois sprints. <br><br>  MP: O qu√™? .. √â apenas CRUD! <br>  R: Criar CRUD √© uma parte simples da tarefa, mas ainda precisamos autenticar e autorizar usu√°rios e servi√ßos.  Como a rede n√£o √© confi√°vel, voc√™ precisar√° implementar solicita√ß√µes repetidas, bem como o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">padr√£o do disjuntor</a> nos clientes.  Ainda assim, para garantir que todo o sistema n√£o caia, voc√™ precisar√° de tempos limites e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">anteparas</a> <i>(para obter mais detalhes sobre os dois padr√µes mencionados, veja mais no artigo - aprox. Transl.)</i> E para detectar problemas, ser√° necess√°rio monitorar, rastrear, [...] <br><br>  MP: Ah, ent√£o vamos apenas inserir esse recurso no servi√ßo do produto. </blockquote>  Penso que a ideia √© clara: o volume de etapas e esfor√ßos necess√°rios para adicionar um servi√ßo √© enorme.  Neste artigo, veremos como o Istio remove todas as dificuldades mencionadas acima (que n√£o s√£o direcionadas para a l√≥gica de neg√≥cios) dos servi√ßos. <br><br><img src="https://habrastorage.org/webt/l4/js/7o/l4js7omne2rslxitn0zr_lgusee.png"><br><br>  <b>Nota</b> : Este artigo pressup√µe que voc√™ tenha conhecimento pr√°tico do Kubernetes.  Caso contr√°rio, recomendo a leitura da <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">minha introdu√ß√£o ao Kubernetes</a> e s√≥ depois continuarei a ler este material. <br><br><h2>  Idea Istio </h2><br>  Em um mundo sem o Istio, um servi√ßo faz solicita√ß√µes diretas a outro e, em caso de falha, o servi√ßo deve process√°-lo: fa√ßa uma nova tentativa, forne√ßa um tempo limite, abra um disjuntor, etc. <br><br><img src="https://habrastorage.org/webt/ov/uv/g5/ovuvg5sepxqvj7wduhnl3uiixyi.png"><br>  <i>Tr√°fego de rede em Kubernetes</i> <br><br>  O Istio tamb√©m oferece uma solu√ß√£o especializada, completamente separada dos servi√ßos e funcionando, interferindo na intera√ß√£o da rede.  E assim implementa: <br><br><ul><li>  <b>Toler√¢ncia a falhas</b> : com base no c√≥digo de status na resposta, ele entende se a solicita√ß√£o falhou e a executa novamente. </li><li>  <b>Lan√ßamentos das Can√°rias</b> : redireciona para a nova vers√£o do servi√ßo apenas uma porcentagem fixa do n√∫mero de solicita√ß√µes. </li><li>  <b>Monitoramento e m√©tricas</b> : por quanto tempo o servi√ßo respondeu? </li><li>  <b>Rastreamento e observabilidade</b> : adiciona cabe√ßalhos especiais a cada solicita√ß√£o e os rastreia no cluster. </li><li>  <b>Seguran√ßa</b> : extrai o token JWT, autentica e autoriza usu√°rios. </li></ul><br>  Estas s√£o apenas algumas das possibilidades (realmente apenas algumas!) Para intrig√°-lo.  Agora vamos mergulhar nos detalhes t√©cnicos! <br><br><h2>  Arquitetura Istio </h2><br>  O Istio intercepta todo o tr√°fego de rede e aplica um conjunto de regras, inserindo um proxy inteligente em cada pod na forma de um cont√™iner lateral.  Os proxies que ativam todos os recursos formam um <b>Data Plane</b> e podem ser configurados dinamicamente usando o <b>Control Plane</b> . <br><br><h2>  Plano de dados </h2><br>  Os proxies inseridos nos pods permitem que o Istio atenda facilmente aos requisitos de que precisamos.  Por exemplo, verifique as fun√ß√µes de repeti√ß√£o e disjuntor. <br><br><img src="https://habrastorage.org/webt/8t/7x/xn/8t7xxntkiuakkk5sbn41b4rualg.gif"><br>  <i>Como tentativas e interrup√ß√£o de circuito s√£o implementadas no Envoy</i> <br><br>  Para resumir: <br><br><ol><li>  Enviado <i>(falando sobre um proxy em um cont√™iner lateral que √© distribu√≠do como um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">produto separado</a> - aprox. Transl.)</i> Envia uma solicita√ß√£o para a primeira inst√¢ncia do servi√ßo B e ocorre uma falha. </li><li>  O enviado Sidecar <i>tenta novamente</i> .  <i>(1)</i> </li><li>  A solicita√ß√£o com falha √© retornada ao proxy que a chamou. </li><li>  Isso abre o disjuntor e chama o pr√≥ximo servi√ßo para solicita√ß√µes subsequentes.  <i>2)</i> </li></ol><br>  Isso significa que voc√™ n√£o precisa usar a pr√≥xima biblioteca Repetir, n√£o precisa executar sua pr√≥pria implementa√ß√£o de Descoberta de circuitos e descoberta de servi√ßos na linguagem de programa√ß√£o X, Y ou Z. Tudo isso e muito mais est√° dispon√≠vel imediatamente no Istio e n√£o requer altera√ß√µes no c√≥digo. <br><br>  √ìtimo!  Agora voc√™ pode querer fazer uma viagem com o Istio, mas ainda h√° algumas d√∫vidas, perguntas em aberto.  Se essa √© uma solu√ß√£o universal para todas as ocasi√µes da vida, voc√™ tem uma suspeita leg√≠tima: afinal, todas essas decis√µes na realidade acabam sendo inadequadas para qualquer ocasi√£o. <br><br>  E, finalmente, voc√™ pergunta: "√â personaliz√°vel?" <br><br>  Agora voc√™ est√° pronto para uma viagem mar√≠tima - e vamos nos familiarizar com o Plano de Controle. <br><br><h2>  Plano de controle </h2><br>  Ele consiste em tr√™s componentes: <b>Pilot</b> , <b>Mixer</b> e <b>Citadel</b> , que trabalham juntos para configurar Envoys para rotear tr√°fego, aplicar pol√≠ticas e coletar dados de telemetria.  Esquematicamente, tudo se parece com isso: <br><br><img src="https://habrastorage.org/webt/dw/p6/hh/dwp6hh6y5g41oinfxccixuutkyo.png"><br>  <i>Intera√ß√£o do plano de controle com o plano de dados</i> <br><br>  Os enviados (ou seja, plano de dados) s√£o configurados usando o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Kubernetes CRD</a> (Defini√ß√µes de Recursos Personalizados) definido pelo Istio e projetado especificamente para essa finalidade.  Para voc√™, isso significa que eles parecem ser o pr√≥ximo recurso no Kubernetes com sintaxe familiar.  Ap√≥s a cria√ß√£o, esse recurso ser√° capturado pelo plano de controle e aplicado aos enviados. <br><br><h2>  Rela√ß√£o de servi√ßo para Istio </h2><br>  Descrevemos a atitude do Istio em rela√ß√£o aos servi√ßos, mas n√£o o oposto: como os servi√ßos se relacionam com o Istio? <br><br>  Honestamente, o Istio conhece a presen√ßa de servi√ßos e peixes - sobre a √°gua, quando se perguntam: ‚ÄúO que √© a √°gua em geral?‚Äù. <br><br><img src="https://habrastorage.org/webt/re/oi/ff/reoiffespub6tknffwssilkgu7c.jpeg"><br>  <i>Ilustra√ß√£o de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Victoria Dimitrakopoulos</a> : - Como voc√™ gosta da √°gua?</i>  <i>- O que √© √°gua em geral?</i> <br><br>  Assim, voc√™ pode pegar o cluster de trabalho e, ap√≥s a implanta√ß√£o dos componentes do Istio, os servi√ßos localizados nele continuar√£o funcionando e, ap√≥s a remo√ß√£o desses componentes, tudo ficar√° bem novamente.  √â claro que, ao fazer isso, voc√™ perder√° as oportunidades oferecidas pelo Istio. <br><br>  Teoria suficiente - vamos colocar esse conhecimento em pr√°tica! <br><br><h2>  Istio na pr√°tica </h2><br>  O Istio requer um cluster Kubernetes no qual est√£o dispon√≠veis pelo menos 4 vCPUs e 8 GB de RAM.  Para aumentar rapidamente o cluster e seguir as instru√ß√µes do artigo, recomendo usar o Google Cloud Platform, que oferece aos novos usu√°rios <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">US $ 300 gr√°tis</a> . <br><br>  Depois de criar um cluster e configurar o acesso ao Kubernetes atrav√©s do utilit√°rio do console, voc√™ pode instalar o Istio atrav√©s do gerenciador de pacotes Helm. <br><br><h2>  Instala√ß√£o do leme </h2><br>  Instale o cliente Helm no seu computador, como eles dizem na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documenta√ß√£o oficial</a> .  N√≥s o usaremos para gerar modelos para instalar o Istio na pr√≥xima se√ß√£o. <br><br><h2>  Instale o Istio </h2><br>  Fa√ßa o download dos recursos do Istio da <a href="">vers√£o mais recente</a> <i>(o link do autor original para a vers√£o 1.0.5 √© alterado para o atual, ou seja, 1.0.6 - aprox. Transl.)</i> , Extraia o conte√∫do para um diret√≥rio, que chamarei no futuro <code>[istio-resources]</code> . <br><br>  Para facilitar a identifica√ß√£o dos recursos do Istio, crie o namespace <code>istio-system</code> no cluster K8s: <br><br><pre> <code class="bash hljs">$ kubectl create namespace istio-system</code> </pre> <br>  Conclua a instala√ß√£o indo para o <code>[istio-resources]</code> e executando o comando: <br><br><pre> <code class="bash hljs">$ helm template install/kubernetes/helm/istio \ --<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> global.mtls.enabled=<span class="hljs-literal"><span class="hljs-literal">false</span></span> \ --<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> tracing.enabled=<span class="hljs-literal"><span class="hljs-literal">true</span></span> \ --<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> kiali.enabled=<span class="hljs-literal"><span class="hljs-literal">true</span></span> \ --<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> grafana.enabled=<span class="hljs-literal"><span class="hljs-literal">true</span></span> \ --namespace istio-system &gt; istio.yaml</code> </pre> <br>  Este comando produzir√° os principais componentes do Istio no arquivo <code>istio.yaml</code> .  Alteramos o modelo padr√£o para n√≥s mesmos, especificando os seguintes par√¢metros: <br><br><ul><li>  <code>global.mtls.enabled</code> definido como <code>false</code> <i>(ou seja, a autentica√ß√£o mTLS est√° desativada - aprox. transl.)</i> para simplificar nosso processo de namoro; </li><li>  <code>tracing.enabled</code> ativa o rastreamento de consultas usando o Jaeger; </li><li>  <code>kiali.enabled</code> instala o Kiali em um cluster para visualizar servi√ßos e tr√°fego; </li><li>  <code>grafana.enabled</code> define o Grafana para visualizar as m√©tricas coletadas. </li></ul><br>  Aplicamos os recursos gerados com o comando: <br><br><pre> <code class="bash hljs">$ kubectl apply -f istio.yaml</code> </pre> <br>  A instala√ß√£o do Istio no cluster est√° conclu√≠da!  Aguarde at√© que todos os pods no espa√ßo de nomes <code>istio-system</code> estejam em <code>Running</code> ou <code>Completed</code> executando o comando abaixo: <br><br><pre> <code class="bash hljs">$ kubectl get pods -n istio-system</code> </pre> <br>  Agora estamos prontos para continuar na pr√≥xima se√ß√£o, onde criaremos e iniciaremos o aplicativo. <br><br><h2>  Arquitetura de aplicativos de an√°lise de sentimentos </h2><br>  Vamos dar um exemplo do aplicativo de microsservi√ßo Sentiment Analysis usado no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">artigo de introdu√ß√£o</a> j√° mencionado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">no Kubernetes</a> .  √â sofisticado o suficiente para mostrar as capacidades do Istio na pr√°tica. <br><br>  O aplicativo consiste em quatro microsservi√ßos: <br><br><ol><li>  Servi√ßo <b>SA-Frontend</b> , que atende a aplicativos front-end no Reactjs; </li><li>  Um servi√ßo <b>SA-WebApp</b> que atende solicita√ß√µes de an√°lise de sentimentos; </li><li>  Servi√ßo <b>SA-Logic</b> , que realiza <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">an√°lise sentimental</a> ; </li><li>  Servi√ßo <b>SA-Feedback</b> , que recebe feedback dos usu√°rios sobre a precis√£o da an√°lise. </li></ol><br><img src="https://habrastorage.org/webt/hi/jv/oc/hijvoc4y7ercttsbopo4jzbo4w4.png"><br><br>  Neste diagrama, al√©m dos servi√ßos, tamb√©m vemos o Controlador de ingresso, que no Kubernetes roteia solicita√ß√µes de entrada para os servi√ßos correspondentes.  O Istio usa um conceito semelhante no Ingress Gateway, cujos detalhes ser√£o apresentados a seguir. <br><br><h2>  Iniciando um aplicativo com um proxy do Istio </h2><br>  Para as opera√ß√µes adicionais mencionadas no artigo, clone o reposit√≥rio <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">istio-mastery</a> .  Ele cont√©m o aplicativo e se manifesta para Kubernetes e Istio. <br><br><h3>  Inser√ß√£o lateral </h3><br>  A inser√ß√£o pode ser feita <b>autom√°tica</b> ou <b>manualmente</b> .  Para inserir automaticamente cont√™ineres laterais, √© necess√°rio definir o <code>istio-injection=enabled</code> para o <code>istio-injection=enabled</code> , o que √© feito pelo seguinte comando: <br><br><pre> <code class="bash hljs">$ kubectl label namespace default istio-injection=enabled namespace/default labeled</code> </pre> <br>  Agora, cada pod que ser√° implantado no espa√ßo para nome padr√£o receber√° seu cont√™iner lateral.  Para verificar isso, vamos instalar um aplicativo de teste acessando o diret√≥rio raiz do <code>[istio-mastery]</code> e executando o seguinte comando: <br><br><pre> <code class="bash hljs">$ kubectl apply -f resource-manifests/kube persistentvolumeclaim/sqlite-pvc created deployment.extensions/sa-feedback created service/sa-feedback created deployment.extensions/sa-frontend created service/sa-frontend created deployment.extensions/sa-logic created service/sa-logic created deployment.extensions/sa-web-app created service/sa-web-app created</code> </pre> <br>  Ap√≥s a expans√£o dos servi√ßos, verificaremos se os pods t√™m dois cont√™ineres (com o pr√≥prio servi√ßo e seu side-car), executando o comando <code>kubectl get pods</code> e certificando-se de que o valor <code>2/2</code> indicado na coluna <code>READY</code> , simbolizando que os dois cont√™ineres est√£o em execu√ß√£o: <br><br><pre> <code class="bash hljs">$ kubectl get pods NAME READY STATUS RESTARTS AGE sa-feedback-55f5dc4d9c-c9wfv 2/2 Running 0 12m sa-frontend-558f8986-hhkj9 2/2 Running 0 12m sa-logic-568498cb4d-2sjwj 2/2 Running 0 12m sa-logic-568498cb4d-p4f8c 2/2 Running 0 12m sa-web-app-599cf47c7c-s7cvd 2/2 Running 0 12m</code> </pre> <br>  Visualmente, fica assim: <br><br><img src="https://habrastorage.org/webt/x9/kt/lu/x9ktluxxjopen7rn9tchuyvvioi.png"><br>  <i>Enviar proxies em um dos pods</i> <br><br>  Agora que o aplicativo est√° em funcionamento, precisamos permitir que o tr√°fego recebido entre no aplicativo. <br><br><h2>  Gateway de ingresso </h2><br>  A melhor pr√°tica para conseguir isso (para permitir tr√°fego no cluster) √© por meio do <b>Gateway de ingresso</b> no Istio, localizado na "borda" do cluster e permite ativar os recursos do Istio, como roteamento, balanceamento de carga, seguran√ßa e monitoramento do tr√°fego recebido. <br><br>  O componente Ingress Gateway e o servi√ßo que o encaminha para fora foram instalados no cluster durante a instala√ß√£o do Istio.  Para descobrir o endere√ßo IP externo de um servi√ßo, fa√ßa: <br><br><pre> <code class="bash hljs">$ kubectl get svc -n istio-system -l istio=ingressgateway NAME TYPE CLUSTER-IP EXTERNAL-IP istio-ingressgateway LoadBalancer 10.0.132.127 13.93.30.120</code> </pre> <br>  Continuaremos a acessar o aplicativo por esse IP (vou me referir a ele como IP EXTERNO); portanto, por conveni√™ncia, escreveremos o valor em uma vari√°vel: <br><br><pre> <code class="bash hljs">$ EXTERNAL_IP=$(kubectl get svc -n istio-system \ -l app=istio-ingressgateway \ -o jsonpath=<span class="hljs-string"><span class="hljs-string">'{.items[0].status.loadBalancer.ingress[0].ip}'</span></span>)</code> </pre> <br>  Se voc√™ tentar acessar esse IP atrav√©s de um navegador agora, receber√° um erro de Servi√ßo Indispon√≠vel, porque  <b>Por padr√£o, o Istio bloqueia todo o tr√°fego recebido</b> at√© que um Gateway seja definido. <br><br><h2>  Recurso de gateway </h2><br>  O Gateway √© um CRD (Custom Resource Definition) no Kubernetes, definido ap√≥s a instala√ß√£o do Istio em um cluster e ativar a capacidade de especificar as portas, protocolos e hosts para os quais queremos permitir o tr√°fego de entrada. <br><br>  No nosso caso, queremos permitir o tr√°fego HTTP na porta 80 para todos os hosts.  A tarefa √© implementada pela seguinte defini√ß√£o <i>( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://gist.github.com/rinormaloku/577d0e23590f7a8dfbe56fe2a1f853d7&amp;usg=ALkJrhg5TPHQ1m2F-WmfUf2hHHdsb7pyzA#file-">http-gateway.yaml</a> )</i> : <br><br><pre> <code class="plaintext hljs">apiVersion: networking.istio.io/v1alpha3 kind: Gateway metadata: name: http-gateway spec: selector: istio: ingressgateway servers: - port: number: 80 name: http protocol: HTTP hosts: - "*"</code> </pre> <br>  Essa configura√ß√£o n√£o precisa de explica√ß√£o, exceto pelo <code>istio: ingressgateway</code> .  Com esse seletor, podemos indicar a qual gateway de ingresso a configura√ß√£o √© aplicada.  No nosso caso, este √© o controlador do Ingress Gateway, que foi instalado por padr√£o no Istio. <br><br>  A configura√ß√£o √© aplicada chamando o seguinte comando: <br><br><pre> <code class="bash hljs">$ kubectl apply -f resource-manifests/istio/http-gateway.yaml gateway.networking.istio.io/http-gateway created</code> </pre> <br>  Agora, o gateway permite acesso √† porta 80, mas n√£o tem id√©ia de onde rotear solicita√ß√µes.  Isso exigir√° <b>servi√ßos virtuais</b> . <br><br><h2>  Recurso VirtualService </h2><br>  O VirtualService informa ao Ingress Gateway como rotear solicita√ß√µes permitidas no cluster. <br><br>  Solicita√ß√µes para nosso aplicativo enviadas via gateway http devem ser enviadas aos servi√ßos sa-frontend, sa-web-app e sa-feedback: <br><br><img src="https://habrastorage.org/webt/zi/il/7_/ziil7_-9gfy5ejkhkzzn1wpxkxe.png"><br>  <i>Rotas para configurar com o VirtualServices</i> <br><br>  Considere os pedidos que devem ser enviados ao SA-Frontend: <br><br><ul><li>  Uma correspond√™ncia exata no caminho <code>/</code> deve ser enviada ao SA-Frontend para obter o index.html; </li><li>  Os caminhos prefixados com <code>/static/*</code> devem ser enviados ao SA-Frontend para receber arquivos est√°ticos usados ‚Äã‚Äãno frontend, como CSS e JavaScript; </li><li>  Os caminhos que correspondem √† express√£o regular <code>'^.*\.(ico|png|jpg)$'</code> devem ser enviados ao SA-Frontend, como  Estas s√£o as imagens exibidas na p√°gina. </li></ul><br>  A implementa√ß√£o √© alcan√ßada pela seguinte configura√ß√£o <i>( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">sa-virtualservice-external.yaml</a> ):</i> <br><br><pre> <code class="plaintext hljs">kind: VirtualService metadata: name: sa-external-services spec: hosts: - "*" gateways: - http-gateway # 1 http: - match: - uri: exact: / - uri: exact: /callback - uri: prefix: /static - uri: regex: '^.*\.(ico|png|jpg)$' route: - destination: host: sa-frontend # 2 port: number: 80</code> </pre> <br>  Pontos importantes: <br><br><ol><li>  Este VirtualService refere-se a solicita√ß√µes provenientes <b>do gateway http</b> ; </li><li>  <code>destination</code> define o servi√ßo para o qual as solicita√ß√µes s√£o enviadas. </li></ol><br>  <b>Nota</b> : A configura√ß√£o acima √© armazenada no arquivo <code>sa-virtualservice-external.yaml</code> , que tamb√©m cont√©m as configura√ß√µes de roteamento no SA-WebApp e no SA-Feedback, mas foi abreviado aqui no artigo por quest√µes de brevidade. <br><br>  Aplique o VirtualService chamando: <br><br><pre> <code class="bash hljs">$ kubectl apply -f resource-manifests/istio/sa-virtualservice-external.yaml virtualservice.networking.istio.io/sa-external-services created</code> </pre> <br>  <b>Nota</b> : Quando usamos os recursos do Istio, o servidor da API do Kubernetes gera um evento que recebe o Istio Control Plane e, depois disso, a nova configura√ß√£o √© aplicada aos proxies Envoy de cada pod.  E o controlador do Ingress Gateway parece ser o pr√≥ximo enviado configurado no Control Plane.  Tudo isso no diagrama √© assim: <br><br><img src="https://habrastorage.org/webt/dz/nz/4b/dznz4bh_wpzcv7tx8jkykkiad9q.png"><br>  <i>Configura√ß√£o do Istio-IngressGateway para roteamento de consulta</i> <br><br>  A An√°lise de sentimentos ficou dispon√≠vel em <code>http://{EXTERNAL-IP}/</code> .  N√£o se preocupe se voc√™ receber o status N√£o encontrado: <i>√†s vezes leva um pouco mais para a configura√ß√£o entrar em vigor e os caches do Envoy serem atualizados</i> . <br><br>  Antes de prosseguir, trabalhe um pouco com o aplicativo para gerar tr√°fego <i>(sua presen√ßa √© necess√°ria para maior clareza nas pr√≥ximas etapas - aprox. Transl.)</i> . <br><br><h2>  Kiali: Observabilidade </h2><br>  Para acessar a interface administrativa do Kiali, execute o seguinte comando: <br><br><pre> <code class="bash hljs">$ kubectl port-forward \ $(kubectl get pod -n istio-system -l app=kiali \ -o jsonpath=<span class="hljs-string"><span class="hljs-string">'{.items[0].metadata.name}'</span></span>) \ -n istio-system 20001</code> </pre> <br>  ... e abra <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">http: // localhost: 20001 /</a> , efetuando login como admin / admin.  Aqui voc√™ encontrar√° muitos recursos √∫teis, por exemplo, para verificar a configura√ß√£o dos componentes do Istio, visualizar servi√ßos com base nas informa√ß√µes coletadas ao interceptar solicita√ß√µes de rede e receber respostas para as perguntas "Quem est√° entrando em contato com quem?", "Qual vers√£o do servi√ßo est√° travando?"  etc.  Em geral, explore as possibilidades do Kiali antes de visualizar m√©tricas com o Grafana. <br><br><img src="https://habrastorage.org/webt/ix/pd/wr/ixpdwrppiekv0dbk3xcbceasft8.png"><br><br><h2>  Grafana: visualiza√ß√£o de m√©tricas </h2><br>  As m√©tricas coletadas no Istio entram no Prometheus e visualizadas com Grafana.  Para acessar a interface de administra√ß√£o do Grafana, execute o comando abaixo e abra <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">http: // localhost: 3000 /</a> : <br><br><pre> <code class="bash hljs">$ kubectl -n istio-system port-forward \ $(kubectl -n istio-system get pod -l app=grafana \ -o jsonpath={.items[0].metadata.name}) 3000</code> </pre> <br>  Ao clicar no menu <b>inicial</b> no canto superior esquerdo e selecionar o <b>Istio Service Dashboard</b> no canto superior esquerdo, comece com o servi√ßo <b>sa-web-app</b> para examinar as m√©tricas coletadas: <br><br><img src="https://habrastorage.org/webt/wb/vz/4t/wbvz4tkgi3qgoitxhhwhppk9pu8.png"><br><br>  Aqui estamos aguardando um desempenho vazio e completamente chato - a ger√™ncia nunca aprovar√° isso.  Vamos criar uma pequena carga com o seguinte comando: <br><br><pre> <code class="bash hljs">$ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> \ curl -i http://<span class="hljs-variable"><span class="hljs-variable">$EXTERNAL_IP</span></span>/sentiment \ -H <span class="hljs-string"><span class="hljs-string">"Content-type: application/json"</span></span> \ -d <span class="hljs-string"><span class="hljs-string">'{"sentence": "I love yogobella"}'</span></span>; \ sleep .8; <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre> <br>  Agora, temos gr√°ficos muito mais agrad√°veis ‚Äã‚Äãe, al√©m deles, ferramentas maravilhosas do Prometheus para monitoramento e Grafana para visualiza√ß√£o de m√©tricas, o que nos permitir√° aprender sobre o desempenho, status de sa√∫de, melhorias / degrada√ß√£o dos servi√ßos ao longo do tempo. <br><br>  Por fim, vejamos o rastreamento de solicita√ß√µes nos servi√ßos. <br><br><h2>  Jaeger: trace </h2><br>  Precisamos rastrear, porque quanto mais servi√ßos tivermos, mais dif√≠cil ser√° chegar √† causa da falha.  Vejamos um caso simples da figura abaixo: <br><br><img src="https://habrastorage.org/webt/dv/8w/iv/dv8wivmvfn20fvmaebzk8wl6h68.png"><br>  <i>Um exemplo t√≠pico de uma solicita√ß√£o com falha aleat√≥ria</i> <br><br>  O pedido vem, cai - <i>qual √© o motivo?</i>  <i>Primeiro servi√ßo?</i>  <i>Ou o segundo?</i>  H√° exce√ß√µes em ambos - vamos examinar os logs de cada um.  Quantas vezes voc√™ se encontra fazendo isso?  Nosso trabalho √© mais como detetives de software do que desenvolvedores ... <br><br>  Esse √© um problema generalizado nos microsservi√ßos e √© resolvido por sistemas de rastreamento distribu√≠dos nos quais os servi√ßos passam um ao outro por um cabe√ßalho exclusivo, ap√≥s o qual essas informa√ß√µes s√£o redirecionadas para o sistema de rastreamento, onde s√£o mapeadas para os dados da solicita√ß√£o.  Aqui est√° uma ilustra√ß√£o: <br><br><img src="https://habrastorage.org/webt/an/_h/tz/an_htzqnc3b4xxhgkzdqi5my-ki.png"><br>  <i>TraceId √© usado para identificar a solicita√ß√£o.</i> <br><br>  O Istio usa o Jaeger Tracer, que implementa uma estrutura de API do OpenTracing independente do fornecedor.  Voc√™ pode acessar a interface do usu√°rio do Jaeger com o seguinte comando: <br><br><pre> <code class="bash hljs">$ kubectl port-forward -n istio-system \ $(kubectl get pod -n istio-system -l app=jaeger \ -o jsonpath=<span class="hljs-string"><span class="hljs-string">'{.items[0].metadata.name}'</span></span>) 16686</code> </pre> <br>  Agora v√° para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">http: // localhost: 16686 /</a> e selecione o servi√ßo <b>sa-web-app</b> .  Se o servi√ßo n√£o for mostrado no menu suspenso, mostre / gere atividade na p√°gina e atualize a interface.  Depois disso, clique no bot√£o <b>Localizar</b> rastreamentos, que mostrar√° os rastreamentos mais recentes - selecione qualquer - informa√ß√µes detalhadas sobre todos os rastreamentos ser√£o exibidas: <br><br><img src="https://habrastorage.org/webt/r8/zx/1q/r8zx1qjxc2a316-4a803l4vmzv4.png"><br><br>  Este rastreio mostra: <br><br><ol><li>  A solicita√ß√£o chega ao <b>istio-ingressgateway</b> (esta √© a primeira intera√ß√£o com um dos servi√ßos e o ID de rastreamento √© gerado para a solicita√ß√£o), ap√≥s o qual o gateway envia a solicita√ß√£o ao <b>servi√ßo de aplicativo da web sa</b> . </li><li>  No servi√ßo <b>sa-web-app, a</b> solicita√ß√£o √© atendida pelo envoy sidecar, um "filho" √© criado no per√≠odo (portanto, vemos nos rastreamentos) e redirecionado para o cont√™iner <b>sa-web-app</b> .  <i>( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Span</a> √© uma unidade l√≥gica de trabalho em Jaeger que possui um nome, o hor√°rio em que a opera√ß√£o foi iniciada e sua dura√ß√£o. Os per√≠odos podem ser aninhados e ordenados. Um gr√°fico ac√≠clico direcionado dos per√≠odos forma um tra√ßo. - aprox. Transl.)</i> </li><li>  Aqui, a solicita√ß√£o √© processada pelo m√©todo <b>sentimentAnalysis</b> .  Esses rastreamentos j√° s√£o gerados pelo aplicativo, ou seja,  eles exigiram altera√ß√µes no c√≥digo. </li><li>  A partir deste momento, uma solicita√ß√£o POST para <b>sa-logic √©</b> iniciada.  O ID de rastreamento deve ser encaminhado a partir do <b>sa-web-app</b> . </li><li>  ... </li></ol><br>  <b>Nota</b> : Na etapa 4, o aplicativo deve ver os cabe√ßalhos gerados pelo Istio e pass√°-los para solicita√ß√µes subsequentes, conforme mostrado na imagem abaixo: <br><br><img src="https://habrastorage.org/webt/qg/a9/ai/qga9aibwkynfogbcxfo2cnwqxfm.png"><br>  <i>(A) Istio √© respons√°vel por encaminhar os cabe√ßalhos;</i>  <i><b>(B) Os servi√ßos s√£o respons√°veis ‚Äã‚Äãpelos cabe√ßalhos.</b></i> <br><br>  Istio faz a maior parte do trabalho, como  gera cabe√ßalhos para solicita√ß√µes recebidas, cria novas extens√µes em cada cuidado lateral e as encaminha.  No entanto, sem trabalhar com os cabe√ßalhos dentro dos servi√ßos, o caminho completo de rastreamento da solicita√ß√£o ser√° perdido. <br><br>  Os seguintes t√≠tulos devem ser considerados (encaminhados): <br><br><pre> <code class="plaintext hljs">x-request-id x-b3-traceid x-b3-spanid x-b3-parentspanid x-b3-sampled x-b3-flags x-ot-span-context</code> </pre> <br>  Entretanto, para simplificar sua implementa√ß√£o, √© uma tarefa simples, j√° existem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">muitas bibliotecas</a> - por exemplo, no servi√ßo sa-web-app, o cliente RestTemplate encaminha esses cabe√ßalhos se voc√™ adicionar as bibliotecas Jaeger e OpenTracing, dependendo <a href="">dele</a> . <br><br>  <i>Observe que o aplicativo Sentiment Analysis demonstra implementa√ß√µes no Flask, Spring e ASP.NET Core.</i> <br><br>  Agora que ficou claro o que estamos obtendo da caixa (ou quase ‚Äúpronto para uso‚Äù), consideraremos quest√µes de roteamento bem ajustado, gerenciamento de tr√°fego de rede, seguran√ßa, etc.! <br><br>  <i><b>Nota</b></i>  <i><b>perev.</b></i>  <i>: Leia sobre isso na pr√≥xima edi√ß√£o do Istio de Rinor Maloku, que estar√° dispon√≠vel em nosso blog em um futuro pr√≥ximo.</i>  <i><b>ATUALIZA√á√ÉO</b> (14 de mar√ßo): <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">A segunda parte</a> j√° foi publicada.</i> <br><br><h2>  PS do tradutor </h2><br>  Leia tamb√©m em nosso blog: <br><br><ul><li>  ‚ÄúVoltar aos microsservi√ßos com Istio‚Äù: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">parte 2 (roteamento, controle de tr√°fego)</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">parte 3 (autentica√ß√£o e autoriza√ß√£o)</a> ; </li><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Condu√≠te - uma malha de servi√ßo leve para o Kubernetes</a> "; </li><li>  ‚Äú <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O que √© uma malha de servi√ßo e por que preciso dela [para um aplicativo em nuvem com microsservi√ßos]?</a>  "; </li><li>  ‚Äú <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Um guia ilustrado para redes no Kubernetes.‚Äù</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Partes 1 e 2</a> "; </li><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Como esse cont√™iner lateral chegou aqui [em Kubernetes]?"</a>  " </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt438426/">https://habr.com/ru/post/pt438426/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt438412/index.html">An√°lise de 112654 tarefas de teste e tend√™ncias no mercado de trabalho de programadores em 2019</a></li>
<li><a href="../pt438414/index.html">Civiliza√ß√£o da Primavera, 3/5</a></li>
<li><a href="../pt438416/index.html">Sobre horm√¥nios</a></li>
<li><a href="../pt438420/index.html">IA em 2019: o estado atual das coisas</a></li>
<li><a href="../pt438422/index.html">Um programa de les√µes eletivas (parte dois): Longride nos primeiros socorros e reanima√ß√£o</a></li>
<li><a href="../pt438428/index.html">Ag√™ncias governamentais encontraram uma maneira de sabotar software dom√©stico</a></li>
<li><a href="../pt438430/index.html">Estou preso! Ou como superar o efeito plat√¥ no aprendizado de ingl√™s</a></li>
<li><a href="../pt438434/index.html">Laborat√≥rio Hacker: P1. Libssh auth bypass</a></li>
<li><a href="../pt438436/index.html">A id√©ia de como fornecer aos funcion√°rios acesso tempor√°rio aos recursos do cliente sem trocar as senhas novamente</a></li>
<li><a href="../pt438438/index.html">Alimento para papagaios Bitrix. Testamos o desempenho, selecionamos o ferro</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>