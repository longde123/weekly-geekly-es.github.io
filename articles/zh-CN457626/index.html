<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>◼️ 🏴󠁧󠁢󠁷󠁬󠁳󠁿 📣 使用Bitrix CMS（BUS）的示例使用Power BI修改用户访问级别 🈲 👩‍🎨 👨‍👨‍👦‍👦</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="本文显示了使用Power BI分析运行1C-Bitrix的站点上的用户访问权限的示例。 

 问题 
 随着时间的流逝，越来越多的用户以一种或另一种方式连接到Internet资源的开发，并且具有比站点普通用户更高的权限。 

 在这方面，控制对机密功能的访问变得越来越困难。 好吧，如果编写了有助于在...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>使用Bitrix CMS（BUS）的示例使用Power BI修改用户访问级别</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/457626/"><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.21-7683.png" alt="图片"><br><br> 本文显示了使用Power BI分析运行1C-Bitrix的站点上的用户访问权限的示例。 <br><a name="habracut"></a><br><h2> 问题 </h2><br> 随着时间的流逝，越来越多的用户以一种或另一种方式连接到Internet资源的开发，并且具有比站点普通用户更高的权限。 <br><br> 在这方面，控制对机密功能的访问变得越来越困难。 好吧，如果编写了有助于在或多或少安全级别上控制访问的规则。 但是，经常会发生同事搬到其他部门，按法令:)或离开而仍然存在的情况。 <br><br> 当然，这会带来不同的威胁：客户群的泄漏，破坏，破坏等等。 <br> 我从事的项目的年龄已经有10年了。 该数据库有成千上万的用户，其中包括数百个具有特权的用户。 <br><br> 本文显示了一个示例，该示例说明如何在Bitrix CMS（BUS）的控制下简化用户对各种站点对象的审核。 <br><br> 问题在于Bitrix管理面板无法提供获得具有访问权限的完整图片的机会。 单击一堆链接并等待管理页面加载也是不愉快的。 <br><br>  Power BI将用作此的主要工具（略有超出其主要目的：） <br><br> 假定读者已经在基本级别上熟悉Power BI，知道SQL的基础知识，并且也知道如何使用Bitrix管理面板。 将考虑Bitrix的标准可访问性功能。 <br><br><h2>  Bitrix管理面板的缺点 </h2><br> 由于缺少与访问相关的画面-所有模块/节/信息块的摘要数据，已被授予访问权限，因此不可能在可接受的时间内在标准管理面板中进行审核。 <br><br> 管理员绩效： <br><br><ol><li> 在Bitrix管理面板的“用户组”部分中，有一项功能可以生成SQL查询，以选择所有具有用户数的组。 当基数较小时，一切都很好。 但是对于拥有数十万用户的数据库，以及在具有128 GB RAM的专用服务器上的数百个用户组，只需打开此部分就需要8秒钟。 </li><li> 组卡中还有一个请求，由于某种原因，它会选择所有用户组，而不是仅接收所选组的数据。 搁置损失3秒。 </li></ol><br><h2> 解决方案 </h2><br> 通常，有几种解决方案。 <br><br><ol><li> 编写提供访问网站的规则，并清楚地遵循它们。 </li><li> 定期进行访问审核。 </li><li> 希望获得最好的，而不是浪费有限的公司资源。 </li></ol><br> 本文将只考虑第二种方法。 <br><br><h2> 任务 </h2><br><ol><li> 选择工具，使您可以快速获取具有扩展权限的每个用户的访问级别的数据。 </li><li> 设置工具，使它们可以清晰显示图片，并具有必要的细节和交互性的整体访问权限。 </li><li> 进行访问审核。 </li></ol><br><h2> 在Bitrix中访问存储 </h2><br>  Bitrix允许您通过用户组灵活地配置权限。 <br> 访问设置主要存储在MySQL表中。 某些设置存储在文件中。 例如，文件和文件夹访问权限存储在.access.php文件中。 <br><br> 分析用户和用户组访问： <br><br><ul><li> 信息块 </li><li> 具有访问级别的Web表单 </li><li> 具有访问级别的Web表单状态 </li><li> 网站的各个部分 </li><li> 具有访问级别的Bitrix模块 </li></ul><br><h2> 工具 </h2><br><ol><li>  Power BI Desktop，使您可以很好地可视化数据，并从大量（几乎）源中获取数据。 实际上，可以用普通的Excel 2016及更高版本替换Power BI-PowerQuery已包含在其交付中，您可以通过它选择所有数据进行分析。 但是，Power BI允许您基于它们之间的关系以交互方式显示数据，这使您可以快速找到隐藏的依赖关系。 </li><li>  MySQL连接器必须能够通过Power BI向MySQL Web服务器创建查询。 </li><li> 如果仅通过SSH打开对数据库的访问，则可以通过Kitty或Putty隧道传输到MySql。 </li></ol><br> 获得以下访问方案：Power BI→MySQL连接器→Kitty→MySQL。 <br><br><h3>  Power BI </h3><br>  Power BI Desktop-使您可以很好地可视化数据，从大量（几乎）源中获取数据。 实际上，可以用普通的Excel 2016及更高版本替换Power BI-PowerQuery已包含在其交付中，您可以通过它选择所有数据进行分析。 但是，Power BI允许您基于它们之间的关系以交互方式显示数据，这使您可以快速找到隐藏的依赖关系，这是我们进行访问修订所需要的。 <br><br> 您可以在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">官方页面</a>上下载它。 <br><br><h3>  MySQL连接器 </h3><br> 转到<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">页面</a> 。 下载并安装。 有时，安装后您将不得不重新启动PC。 <br><br><h3> 小猫/腻子 </h3><br> 要对Bitrix数据库执行SQL查询，您将需要配置隧道。 <br><br><ol><li> 输入服务器IP和端口 <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.21-24929.png" alt="图片"></li><li> 我们在SSH上锤击用户名和密码 <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.11-29155.png" alt="图片"></li><li> 我们进行端口转发： <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.11-29289.png" alt="图片"></li><li> 我们将所做的设置保存在配置文件中以备将来使用： <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.21-24400.png" alt="图片"></li><li> 我们开始。 </li></ol><br> 您还可以下载Putty并使用以下命令运行它： <br><br><pre><code class="bash hljs">putty.exe -ssh <span class="hljs-string"><span class="hljs-string">"USER@HOST"</span></span> -pw <span class="hljs-string"><span class="hljs-string">"PASSWORD"</span></span> -2 -v -P 22 -L 3306:127.0.0.1:3306</code> </pre> <br> 自然，在更新Power BI中的数据之前，必须先运行Kitty / Putty。 <br><br><h2> 用户和用户组 </h2><br> 与许多CMS一样，Bitrix实现了一种通过用户组定界访问权限的机制。 <br><br> 将数据库中的实体卸载到Power BI数据模型中： <br><br><ul><li> 团体 </li><li> 用户数 </li></ul><br> 以及组与用户之间的关系。 <br><br><h3> 团体 </h3><br> 我们仅将自己限制在活跃的群体中。 <br><br> 组列表存储在b_group表中。 <br><br><ol><li> 创建一个连接： <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.21-22207.png" alt="图片"></li><li> 输入： <br><br><ol><li> 在“服务器：本地主机：3306”字段中 </li><li> 在“数据库：bitrix_db”字段中（Bitrix使用的数据库名称） </li><li>  SQL查询： <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, timestamp_x, active, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, description, anonymous <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> b_group <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> active = <span class="hljs-string"><span class="hljs-string">'Y'</span></span>;</code> </pre> <br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.11-32597.png" alt="图片"><br></li></ol><br></li><li> 输入数据库的登录名和密码并发送请求： <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.11-224.png" alt="图片"><br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.11-355.png" alt="图片"><br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.11-812.png" alt="图片"><br></li><li> 立即给请求起一个友好的名字： <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.21-18432.png" alt="图片"></li><li> 我们以表格形式在单独的工作表上列出组： <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.12-2562.png" alt="图片"><br></li></ol><br> 对于与Bitrix数据库有关的其他查询，这种提取和呈现数据的方法将类似。 <br><br><h3> 用户数 </h3><br> 现在，卸载所有具有高级权限的用户。 但是，您不应该卸载仅包含在不授予用户任何其他权限的组中的用户，例如“所有用户，包括未注册的用户”（值得注意的是，此组与用户的连接是为版本12之前注册的所有用户存储的。版本，则该组被认为是系统性的，并且不存储与数据库用户进行通信时的数据。 <br><br> 我们仅将自己限制为激活的用户。 <br><br> 为此，您需要： <br><br><ol><li> 选择授予扩展权限的组的所有ID。 这是节省流量的必要步骤，因为  b_user_group中的条目数可以达到数百万，具体取决于项目的复杂性。 </li><li> 创建用于卸载链接的动态请求用户-组 </li><li> 卸载具有从子句2链接的用户。 </li></ol><br> 让我们开始： <br><br><ol><li> 调用查询编辑器：主页→编辑查询 </li><li> 让我们创建一个指向“组”初始请求的链接： <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.21-18742.png" alt="图片"></li><li> 将新请求重命名为“ Group ID”，并从安全角度仅选择那些有趣的组。 <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.12-5782.png" alt="图片"></li><li> 现在我们得到一行，其中包含用逗号分隔的组ID： <br><ul><li> 添加自定义列：AddColumn→常规→自定义列 <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.12-6399.png" alt="图片"></li><li> 删除除ID和分组以外的所有列： <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.12-6647.png" alt="图片"></li><li> 按“分组”列分组： <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.12-6804.png" alt="图片"><br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.12-6987.png" alt="图片"></li><li> 添加另一列，如下所示： <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.12-7947.png" alt="图片"></li><li> 让我们展开列表，以便用逗号分隔值： <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.12-7601.png" alt="图片"></li><li> 并进入结果单元格： <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.12-8091.png" alt="图片"></li><li> 然后，Power BI将查询转换为可在动态SQL查询中使用的变量： <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.12-8306.png" alt="图片"></li></ul></li><li> 让我们创建一个包含用户与组之间关系的“用户组”请求，类似于“组”部分中的操作。 <br><br>  SQL查询： <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> ug.user_id, ug.group_id <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> b_user_group ug <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> b_group g <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> g.id = ug.group_id <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> b_user u <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> u.id = ug.user_id <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> g.ACTIVE = <span class="hljs-string"><span class="hljs-string">'Y'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> u.ACTIVE = <span class="hljs-string"><span class="hljs-string">'Y'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ug.group_id <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> ();</code> </pre> <br>  XXX将需要替换为组ID，并用逗号分隔。 <br></li><li> 我们将调用编辑请求的源并将其替换为以下内容： <br><br><pre> <code class="plaintext hljs">let sql = "SELECT ug.user_id, ug.group_id #(lf)FROM b_user_group ug #(lf)JOIN b_group g ON g.id = ug.group_id #(lf)JOIN b_user u ON u.id = ug.user_id #(lf)WHERE g.ACTIVE = 'Y' #(lf) AND u.ACTIVE = 'Y' #(lf) AND ug.group_id IN ("&amp;#"ID "&amp;");", Source = MySQL.Database("localhost:3306", "bitrix_db", [ReturnSingleDatabase=true, Query=sql, CreateNavigationProperties=false]) in Source</code> </pre> <br></li><li> 之后，您会收到以下警告： <br><br><pre> <code class="plaintext hljs">Formula.Firewall: Query '-' (step 'Source') references other queries or steps, so it may not directly access a data source. Please rebuild this data combination.</code> </pre> <br> 要摆脱它，您需要更改隐私级别： <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.12-11330.png" alt="图片"><br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.21-19190.png" alt="图片"><br><br> 之后，更新查询。 </li><li> 我们使用与“组ID”相同的方式来创建变量“用户ID”（也就是说，我们根据“用户”请求进行链接等）。 使用它，我们将生成一个SQL查询，该查询允许我们仅选择分析所需的用户。 首先删除重复的user_id： <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.12-12072.png" alt="图片"></li><li> 我们创建一个选择用户的请求，类似于对“用户组”的请求。 <br><br><pre> <code class="sql hljs">SQL: <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, last_name, <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>, email, date_register, last_login <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> b_user <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> active = <span class="hljs-string"><span class="hljs-string">'Y'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> ( );</code> </pre> <br>  XXX将需要替换用户ID。 <br></li></ol><br><h3> 建立请求之间的关系 </h3><br> 为了使Power BI以交互方式筛选不同视图中的数据，您需要定义查询之间的关系。 在我们的例子中，我们需要连接字段： <br><br><ul><li>  “用户组” [group_id]→“组” [id] </li><li>  “用户组” [user_id]→“用户” [id] </li></ul><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.12-14028.png" alt="图片"><br><br> 同样，我们将绑定其他查询。 <br><br><h3> 用户和用户组报告 </h3><br> 在“报告”选项卡上，我们使用“表”作为可视化元素来显示用户和组的列表。 <br><br> 从“用户”请求中，选择字段：last_name，名称，last_login，电子邮件。 <br> 从“用户组”请求中，选择group_id字段。 <br> 因为 由于我们在请求之间分配了连接，因此Power BI将能够正确使用聚合功能Count来计数每个用户所属的组数。 <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.16-23646.png" alt="图片"><br><br> 接下来，添加另一个表，然后从“组”请求中选择“名称”字段，并从“用户组”请求中选择“ user_id”字段-为其设置“计数（不同）”聚合以查看该组中的用户数。 <br><br> 因为  “组”和“用户”请求通过关联的“用户组”请求连接，然后，在具有组列表的表中单击用户时，将仅显示包含所选用户的那些组。 反之亦然。 <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.16-24194.png" alt="图片"><br><br> 这样，您可以单击每个用户并查看其所属的组，也可以单击组并查看哪些用户是组的一部分。 好吧，然后做出有关更改用户访问权限的决定。 <br><br> 下面介绍如何将其余表放置在Power BI常规报告中，因为 这是通过类似的方式完成的。 <br><br><h2>  .access.php </h2><br> 在Bitrix中，您可以通过在.access.php文件中指定组号和所需的访问级别来设置对文件夹和文件的访问。 <br><br> 我们的任务是将分散在项目服务器周围的所有.access.php文件中的数据减少到表格视图中。 <br><br> 为此： <br><br><ol><li> 我们从服务器搜索并存档所有.access.php文件，并保存这些文件的路径。 <br> 我使用terminalka搜索，复制和存档找到的文件。 命令示例： <br><br><pre> <code class="bash hljs">find “BITRIX_PROJECT_DIR” -name <span class="hljs-string"><span class="hljs-string">'.access.php'</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> f &gt; “OUTPUT_DIR/.access.php.files.txt”&amp;&amp;tar cvfpz “OUTPUT_DIR/.access.php.files.tar” -T “OUTPUT_DIR/.access.php.files.txt”&amp;&amp;find “OUTPUT_DIR” -<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> d -<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> chmod 775 {} \; &amp;&amp; find “OUTPUT_DIR” -<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> f -<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> chmod 775 {} \;&amp;&amp;find “OUTPUT_DIR” -<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> d -<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> chown bitrix:bitrix {} \; &amp;&amp; find “OUTPUT_DIR”/ -<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> f -<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> chown bitrix:bitrix {} \;</code> </pre> <br> 在这里： <br><br><ul><li>  BITRIX_PROJECT_DIR-Bitrix上项目所在的文件夹。 </li><li>  OUTPUT_DIR-将放置找到包含.access.php列表的.access.php.files.txt文件以及包含所有找到的.access.php副本的.access.php.files.tar存档的文件夹的路径。 </li></ul><br> 自然，如果有许多项目（使用了多站点），则我们选择一个包含所有项目的文件夹。 </li><li> 在Power BI项目旁边的某个位置下载并解压缩.access.php存档。 <br> 我编写了一个自动执行此操作的批处理文件：下载是通过wget实现的； 通过7zip-解压缩。 <br><br> 批处理文件示例： <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.16-27936.png" alt="图片"><br><br> 包含批处理文件设置的文件： <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.16-28309.png" alt="图片"><br></li></ol><br> 现在创建一个查询，该查询将以表格形式汇总所有.access.php的内容。 <br><br><ol><li> 为了方便起见，创建一个参数，该参数将包含我们要从其中提取所有.access.php内容的文件夹的路径。 <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.16-29768.png" alt="图片"></li><li> 我们将选择“文件夹”类型的请求，然后选择我们的参数作为路径： <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.16-30043.png" alt="图片"></li><li> 展开内容字段： <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.16-3956.png" alt="图片"><br><br>  XXXXXXX是列分隔符；从所有文件导入数据后，您需要一个列。 </li><li> 之后，Power BI将删除我们需要的列，其中包含.access.php的路径。 因此，我们需要编辑“删除其他列1”步骤，在其中选择“文件夹路径”： <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.16-2519.png" alt="图片"></li><li> 保留以下列：Folder Path和Column1。 </li><li> 要从文件夹路径中删除本地文件的绝对路径，请使用替换： <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.16-32195.png" alt="图片"></li><li>  .access.php文件包含以下格式的访问设置： <br><br><pre> <code class="php hljs">$PERM[<span class="hljs-string"><span class="hljs-string">""</span></span>][<span class="hljs-string"><span class="hljs-string">"ID "</span></span>] = <span class="hljs-string"><span class="hljs-string">"&lt; &gt;"</span></span>;</code> </pre> <br> 我们的任务是分散以下列：路径，组ID，访问级别。 这是通过使用过滤器，列分隔（拆分列）和自定义列（自定义列）完成的。 </li><li> 结果应为下表： <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.16-7888.png" alt="图片"><br><br> 正如您在组ID字段中看到的那样，有“ *”（所有人均可访问）。 为了能够指定与其他请求的连接，我们需要将此字段设置为整数，而不会丢失有关“ *”的信息（对于所有组而言）。 让我们发出两个请求，例如到原始DotAccessPhp请求的“链接”： <br><br><ul><li> 第一个DotAccessPhpForRels将仅包含整数组ID（我们通过删除组ID列中的*来使用过滤器）-我们将其与其余请求连接： <br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.16-10824.png" alt="图片"></li><li> 第二个-DotAccessPhpForAll-仅*（使用过滤器）。 </li></ul></li></ol><br> 接线图： <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.16-11242.png" alt="图片"><br><br> 要在其他视图中从DotAccessForRels选择文件时仅显示相关数据，请将“交叉过滤器方向”参数更改为“双向”： <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.16-13400.png" alt="图片"><br><br> 对于将在下面添加的其他请求，这也需要完成。 <br><br><h2> 信息块 </h2><br> 您需要卸载信息块列表和信息块链接组表。 <br><br> 我们将仅上传有关活动信息块的信息。 <br><br><ol><li> 我们创建请求“ Infoblocks”。  SQL查询： <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> i.id, i.NAME <span class="hljs-string"><span class="hljs-string">''</span></span>, i.TIMESTAMP_X <span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">GROUP_CONCAT</span></span>(ist.SITE_ID SEPARATOR <span class="hljs-string"><span class="hljs-string">', '</span></span>) <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> b_iblock i <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> b_iblock_site ist <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> ist.IBLOCK_ID = i.id <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>;   “-”: <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> ig.iblock_id, ig.group_id, ig.permission <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> b_iblock_group ig <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> b_group g <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> g.id = ig.group_id <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> b_iblock i <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> i.ID = ig.IBLOCK_ID <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> g.ACTIVE = <span class="hljs-string"><span class="hljs-string">'Y'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> i.ACTIVE = <span class="hljs-string"><span class="hljs-string">'Y'</span></span>;</code> </pre> </li><li> 我们更新了通信方案，不要忘记将“交叉滤波器方向”参数更改为“两者”： <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.16-31351.png" alt="图片"></li></ol><br><h2> 表格 </h2><br> 对于表单，用户组的权限既授予表单本身，也授予表单填写结果所处的状态。 <br><br><ol><li> 创建“表格”请求： <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> f.ID, f.name <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">GROUP_CONCAT</span></span>(f2s.SITE_ID SEPARATOR <span class="hljs-string"><span class="hljs-string">', '</span></span>) <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> b_form f <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> b_form_2_site f2s <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> f2s.FORM_ID = f.ID <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>;</code> </pre> </li><li> 创建一个请求“表单组”： <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DISTINCT</span></span> f2g.group_id, f2g.form_id, f2g.PERMISSION <span class="hljs-string"><span class="hljs-string">' '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> b_form_2_site f2s <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> b_form_2_group f2g <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> f2g.FORM_ID = f2s.FORM_ID <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> b_group g <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> g.ID = f2g.group_ID <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> g.ACTIVE = <span class="hljs-string"><span class="hljs-string">'Y'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>;</code> </pre> </li><li> 我们创建请求“表单状态”。 <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> fs.ID, fs.TITLE <span class="hljs-string"><span class="hljs-string">''</span></span>, fs.form_id <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> b_form_status fs <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> b_form f <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> f.ID = fs.FORM_ID <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> fs.ACTIVE = <span class="hljs-string"><span class="hljs-string">'Y'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> f2s.FORM_ID <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> b_form_2_site f2s <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> f2s.FORM_ID = f.ID <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>;</code> </pre> </li><li> 创建请求“表单组状态” <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> fs2g.status_id, fs2g.group_id, fs2g.PERMISSION <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> b_form_status_2_group fs2g <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> b_form_status fs <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> fs.ID = fs2g.STATUS_ID <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> b_group g <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> g.ID = fs2g.group_ID <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> b_form f <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> f.ID = fs2g.GROUP_ID <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> b_form_2_site f2s <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> f2s.FORM_ID = f.ID <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> fs.ACTIVE = <span class="hljs-string"><span class="hljs-string">'Y'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> (g.ACTIVE = <span class="hljs-string"><span class="hljs-string">'Y'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>;</code> </pre> </li><li> 更新连接方案： <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.18-25734.png" alt="图片"></li></ol><br><h2> 模组 </h2><br><ol><li> 我们创建一个请求“模块组”。 <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> mg.MODULE_ID <span class="hljs-string"><span class="hljs-string">''</span></span>, mg.group_id, mg.G_ACCESS <span class="hljs-string"><span class="hljs-string">''</span></span>, t.LETTER, t.NAME <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> b_module_group mg <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> b_group g <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> g.id = mg.GROUP_ID <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> b_task t <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> t.MODULE_ID = mg.MODULE_ID <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t.BINDING = <span class="hljs-string"><span class="hljs-string">'module'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> g.active = <span class="hljs-string"><span class="hljs-string">'Y'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> mg.G_ACCESS = t.LETTER;</code> </pre> </li><li> 更新通讯： <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.20-998.png" alt="图片"></li></ol><br><h2> 计分板 </h2><br> 我们自定义表格样式，最大限度地利用可用空间。 <br><br> 结果应该类似于以下内容： <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.18-28241.png" alt="图片"><br><br> 稍作修改的记分板（表中的元素数）： <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.20-1923.png" alt="图片"><br><br> 顺便说一句，首先配置一个表的外观，然后使用Home→Format Painter简单地将其视图应用于其他表是很方便的。 此功能的作用方式与Word和Excel（按样本设置格式）中的作用相同。 <br><br><h2> 管理员连结 </h2><br> 为了可以快速访问网站并在管理面板中进行设置，可以使用DAX语言添加自定义列并将其设置为“ Web URL”。 为此，选择创建的列并分配适当的类型（建模→属性→数据类别→Web URL）。 <br><br> 组请求的示例： <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.19-196.png" alt="图片"><br><br> 在视图中添加一列： <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.19-866.png" alt="图片"><br> 现在，您只需单击表格单元格，然后转到Bitrix管理面板中的组卡。 <br><br><h2> 文件报告 </h2><br> 为了方便起见，您可以通过在表上放置有关访问Internet资源的文件和部分的表格来制作单独的报告： <br><br><img src="https://www.uchitel-izd.ru/upload/files/clip2net/ol/2019/06.20-30194.png" alt="图片"><br><br> 该报告还添加了直接通过Bitrix管理面板编辑所有.access.php的链接。 <br><br><h2> 总结 </h2><br>  Bitrix在具有明显优点和缺点的cms怪兽中是冠军，其外表美丽而内表可怕。 它没有便捷的访问管理工具。 但是这个问题是在免费工具的帮助下解决的，而没有吸引宝贵的程序员时间。 <br><br> 这种方法的优点还包括能够使用Bitrix的其他信息快速补充Power BI中的模型，例如，某人想知道何时创建或更改.access.php以及其他文件。 <br><br> 现在，在构建访问权限模型并在Power BI中将其可视化之后，就足够了： <br><br><ol><li> 持续单击用户，组，表单，文件，并实时查看有关访问的所有连接； </li><li> 快速进入必要的管理页面进行编辑； </li><li> 直接在Power BI中使用最新的Bitrix数据更新数据模型。 </li></ol><br> 结果，进行了审核，并调整了用户访问权限。 <br><br>  PS在市场上有一个免费的模块“访问控制中心”，但是它非常有限，对它的最后评论是5年多了。 也许有人会喜欢在Bitrix中构建这样的仪表板的想法，然后将其实现为模块... <br><br>  PS2。 如果有人对使用Power BI解决在各种会计系统中查找隐藏的依赖关系的问题感兴趣，请在注释中编写。 然后，我将针对该主题再写几篇文章。 <br><br>  PS3 感谢我的同事帮助我撰写本文：Alexander Voronkov，Evgeny Shapochkin，Alexei Titov。 </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN457626/">https://habr.com/ru/post/zh-CN457626/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN457614/index.html">从猎头公司到国外找工作的秘密</a></li>
<li><a href="../zh-CN457616/index.html">我的“哇，我不知道！” 开玩笑的时刻</a></li>
<li><a href="../zh-CN457618/index.html">成为现代全栈开发人员</a></li>
<li><a href="../zh-CN457622/index.html">测量Qt性能</a></li>
<li><a href="../zh-CN457624/index.html">我们如何打破旧小屋并在其位置建造摩天大楼</a></li>
<li><a href="../zh-CN457628/index.html">有效的P2M计划和项目管理</a></li>
<li><a href="../zh-CN457630/index.html">经验对专业素质数据科学家的开发要求</a></li>
<li><a href="../zh-CN457632/index.html">单元测试多少钱？</a></li>
<li><a href="../zh-CN457634/index.html">Verilog上的DDS合成器</a></li>
<li><a href="../zh-CN457638/index.html">如果可以的话，赶上我。 先知版本</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>