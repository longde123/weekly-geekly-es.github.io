<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🌗 🖖🏿 👩🏿‍🤝‍👨🏼 Boîte pour stocker des données dans des applications go 🥥 🐕 🧦</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Une brève note sur une base de données clé-valeur intégrée appelée Coffer écrite en Golang. Si très brièvement: lorsque la base de données est dans un...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Boîte pour stocker des données dans des applications go</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/477154/"><img width="300" align="left" src="https://habrastorage.org/getpro/habr/post_images/9b9/999/30c/9b999930c1f34ce97f4991d0c8500ea1.jpg" alt="image"><p> Une brève note sur une base de données clé-valeur intégrée appelée <code>Coffer</code> écrite en Golang.  Si très brièvement: lorsque la base de données est dans un état arrêté, les données sont sur le disque, au démarrage, les données sont copiées en mémoire.  La lecture vient de la mémoire.  Pendant l'enregistrement, les données de la mémoire sont modifiées et les modifications sont enregistrées dans le journal du disque.  La taille maximale des données stockées est limitée par la taille de la RAM.  L'API vous permet de créer des en-têtes pour les enregistrements de base de données et de les utiliser dans les transactions, tout en maintenant la cohérence des données. <br><a name="habracut"></a><br>  Mais d'abord, une petite introduction lyrique.  Il était une fois, lorsque l'herbe était plus verte, il m'a fallu intégrer une base de données de valeurs-clés pour l'application go.  En regardant autour et en tombant sur différents packages, je n'ai pas trouvé ce que j'aimerais (subjectivement) et j'ai simplement appliqué la solution avec une base de données relationnelle externe.  Excellente solution de travail.  Mais comme on dit, une cuillère a été trouvée, mais les sédiments sont restés.  Tout d'abord, je voulais exactement la base de données native, écrite sur Go, directement native native.  Et il y en a, regardez simplement génial.  Cependant, il n'y en a pas un million.  C'est même surprenant quand on considère qu'un programmeur est rare dans le monde qui n'a pas écrit de base de données, de framework ou de jeu casual dans sa vie. </p><br><p>  Eh bien, vous pouvez essayer d'empiler votre vélo sur vos genoux, avec du blackjack et d'autres goodies.  Dans le même temps, tout le monde sait, ou du moins devine, que l'écriture même d'une simple base de données de valeurs-clés ne semble simple qu'à première vue.  Mais en fait, tout est beaucoup plus amusant (et c'est arrivé).  Et j'étais curieux au sujet de l'ACID et inquiet au sujet des transactions.  Les vraies transactions sont plus probables au sens financier, car  J'étais alors occupé à la fintech. </p><br><h3>  Sécurité des données </h3><br><p>  Prenons le cas où, lors du fonctionnement d'une application avec enregistrement actif, l'alimentation électrique de l'ordinateur était recouverte d'un bassin en cuivre et le disque ne se cassait pas.  Si à ce moment l'application a <code>ok</code> reçue de la base de données, les données de cette opération ne seront pas perdues.  Si la demande a reçu une réponse négative, alors bien sûr, l'opération n'a pas été terminée.  Eh bien, le cas où l'application a envoyé une demande, mais n'a pas reçu de réponse: cette opération n'a probablement pas été terminée, mais il y a une petite chance que l'opération tombe dans le journal, mais exactement au moment où la réponse a été envoyée, une panne de courant s'est produite. </p><br><p>  Comment au dernier cas savoir ce qui s'est passé avec les dernières opérations?  C'est une question intéressante.  Indirectement, vous pouvez le deviner (tirer des conclusions) en examinant la valeur de l'enregistrement qui vous intéresse après le lancement d'une nouvelle application à partir de la base de données.  Cependant, si les opérations sont assez fréquentes, je crains que cela n'aidera pas.  Vous pouvez voir le fichier du dernier journal (ce sera avec le plus grand nombre), mais manuellement, cela n'est pas pratique.  Je pense qu'à l'avenir, vous pouvez ajouter la possibilité d'afficher les journaux dans l'API (naturellement, les journaux dans ce cas ne devraient pas être supprimés). </p><br><p>  Franchement, je n'ai pas moi-même tiré le cordon de la prise, car  Je ne veux pas risquer le fer pour vérifier la base de données.  Dans les tests, je gâche simplement les fichiers journaux normaux, et dans ce cas, tout se passe comme prévu.  Cependant, il n'y a aucune expérience dans l'utilisation pratique de la base de données, elle n'a pas fonctionné au niveau du prod et il y a des risques.  Cependant, pour les projets pour animaux de compagnie, je pense que la base de données peut être utilisée sans crainte.  En général, l'avertissement habituel, aucune garantie. </p><br><p>  La base de données n'est actuellement pas protégée contre l'utilisation dans deux applications différentes (ou les mêmes, cela n'a pas d'importance ici) configurées pour fonctionner avec le même répertoire.  Tenez compte de ce moment!  Et pourtant, puisque la base de données est intégrée, puis en lui passant une sorte de type de référence dans les arguments, cela ne vaut vraiment pas la peine de la changer quelque part dans goroutine parallèle. </p><br><br><h3>  La configuration </h3><br><p>  La base de données a plusieurs paramètres qui peuvent être configurés, cependant, presque tous ont des valeurs par défaut, donc tout peut être ajusté dans une seule ligne courte <code>cof, err, wrn := Db(dirPath).Create()</code> erreur est renvoyée (si une erreur se produit, continuez à travailler avec la base de données interdit) et d'avertissement, que vous pouvez connaître, mais cela n'interfère pas avec le fonctionnement de la base de données. </p><br><p>  Je n'encombrerai pas le texte avec des descriptions encombrantes, si nécessaire, veuillez les regarder dans le fichier <a href="">Lisezmoi</a> du référentiel - <a href="">github.com/claygod/coffer/blob/master/README_RU.md#config</a> Notez la méthode du gestionnaire qui connecte le gestionnaire de la transaction, j'écrirai quelques lignes à ce sujet plus bas, je les énumère ici: </p><br><ul><li>  Db (dirPath) </li><li>  BatchSize (batchSize) </li><li>  LimitRecordsPerLogfile (limitRecordsPerLogfile) </li><li>  FollowPause (100 * fois seconde) </li><li>  LogsByCheckpoint (1000) </li><li>  AllowStartupErrLoadLogs (true) </li><li>  MaxKeyLength (maxKeyLength) </li><li>  MaxValueLength (maxValueLength) </li><li>  MaxRecsPerOperation (1 000 000) </li><li>  RemoveUnlessLogs (true) </li><li>  LimitMemory (100 * 1000000) </li><li>  LimitDisk (1000 * 1000000) </li><li>  Handler ("handler1" et handler1) </li><li>  Handler ("handler2", &amp; handler2) </li><li>  Handlers (map [string] * handler) </li><li>  Créer () </li></ul><br><h3>  API </h3><br><p>  Dans la mesure du possible, j'ai rendu l'API simple, et pour une base valeur-clé, ne soyez pas trop intelligent: </p><br><ul><li>  Démarrer - démarrer la base de données </li><li>  Arrêter - arrêter la base de données </li><li>  StopHard - un arrêt quelles que soient les opérations en cours (je vais peut-être le supprimer) </li><li>  Enregistrer - enregistrer un instantané de l'état actuel de la base de données </li><li>  Écrire - ajouter un enregistrement à la base de données </li><li>  WriteList - ajoute plusieurs enregistrements à la base de données (modes stricts et facultatifs) </li><li>  WriteListUnsafe - ajoutez plusieurs enregistrements à la base de données sans égard à la sécurité des données </li><li>  Lire - obtenir un enregistrement par clé </li><li>  ReadList - obtenir une liste d'enregistrements </li><li>  ReadListUnsafe - obtenez une liste d'enregistrements sans égard à la sécurité des données </li><li>  Supprimer - supprimer un enregistrement </li><li>  DeleteList - supprime plusieurs enregistrements en mode strict / facultatif </li><li>  Transaction - exécuter une transaction </li><li>  Count - combien d'enregistrements dans la base de données </li><li>  CountUnsafe - combien d'enregistrements dans la base de données (un peu plus rapide, mais dangereux) </li><li>  RecordsList - une liste de toutes les clés de base de données </li><li>  RecordsListUnsafe - une liste de toutes les clés de base de données (un peu plus rapide, mais peu sûr) </li><li>  RecordsListWithPrefix - une liste de clés avec le préfixe spécifié </li><li>  RecordsListWithSuffix - une liste de clés avec la fin spécifiée </li></ul><br><p>  Brève explications sur l'API: </p><br><ul><li>  Mode strict - faites tout ou rien. </li><li>  Mode optionnel - faites tout ce qui fonctionne. </li><li>  StopHard - cette méthode devrait peut-être être supprimée de l'API jusqu'à ce qu'elle soit décidée. </li><li>  Toutes les méthodes RecordsList ne sont pas rapides, car  Il n'y a pas d'index dans le magasin en ce moment, alors qu'il s'agit d'un balayage complet. </li><li>  Toutes les méthodes dangereuses sont plus rapides, mais la cohérence n'est pas implicite lors de leur utilisation.  Il est logique de les utiliser sur une base de données arrêtée pour son remplissage rapide ou autre chose dans la même veine. </li><li>  Le suiveur surveille la mise à jour régulière de l'instantané de la base de données, donc la méthode Save est très probablement pour certains cas spéciaux lorsque vous voulez vraiment créer un nouvel instantané (jusqu'à ce qu'un tel cas me vienne à l'esprit, mais c'est peut-être le cas). </li></ul><br>  Un cas d'utilisation simple: <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> main <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ( <span class="hljs-string"><span class="hljs-string">"fmt"</span></span> <span class="hljs-string"><span class="hljs-string">"github.com/claygod/coffer"</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> curDir = <span class="hljs-string"><span class="hljs-string">"./"</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-comment"><span class="hljs-comment">// STEP init db, err, wrn := coffer.Db(curDir).Create() switch { case err != nil: fmt.Println("Error:", err) return case wrn != nil: fmt.Println("Warning:", err) return } if !db.Start() { fmt.Println("Error: not start") return } defer db.Stop() // STEP write if rep := db.Write("foo", []byte("bar")); rep.IsCodeError() { fmt.Sprintf("Write error: code `%d` msg `%s`", rep.Code, rep.Error) return } // STEP read rep := db.Read("foo") rep.IsCodeError() if rep.IsCodeError() { fmt.Sprintf("Read error: code `%v` msg `%v`", rep.Code, rep.Error) return } fmt.Println(string(rep.Data)) }</span></span></code> </pre><br><h3>  Les transactions </h3><br><p>  Comme mentionné ci-dessus, ma définition des transactions peut ne pas coïncider avec celle généralement acceptée dans la construction DB, peut-être qu'elles ne sont unies que par une idée.  Dans une implémentation spécifique, une transaction est un certain en-tête spécifié à l'étape de configuration de la base de données (méthode du <code>Handler</code> ).  Lorsque nous appelons une transaction avec cet en-tête, la base de données bloque les enregistrements avec lesquels l'en-tête fonctionnera et transfère leurs valeurs actuelles à l'en-tête.  L'en-tête manipule ces données selon ses besoins et renvoie les nouvelles valeurs de la base de données, ce qui les enregistre dans une centaine.  Après cela, les enregistrements sont déverrouillés et deviennent disponibles pour d'autres opérations. </p><br><p>  Il y a des exemples dans le référentiel qui révèlent très bien l'essence de l'utilisation des transactions.  Par curiosité, j'ai fait un petit exemple financier, dans lequel il y a des opérations de débit et de crédit, de transfert, d'achat et de vente.  Il était très facile d'écrire cet exemple, et en même temps, cette mise en œuvre à hauteur de genou est assez cohérente et adaptée à une utilisation dans diverses solutions financières, ou par exemple dans la logistique. </p><br><p>  Un point important: le code du gestionnaire n'est pas stocké dans la base de données.  J'ai eu une idée de le stocker dans un journal, mais cela m'a semblé trop inutile, donc je ne l'ai pas compliqué, et en conséquence la responsabilité de la cohérence des gestionnaires entre les différents démarrages de base de données incombe au développeur du code qui utilise la base de données.  Les gestionnaires ne peuvent définitivement pas être modifiés si l'application et la base de données cessent de planter.  Dans ce cas, vous devez d'abord démarrer la base de données, puis l'arrêter régulièrement - un nouvel instantané de données sera créé.  Afin de ne pas vous tromper, je vous conseille d'utiliser le numéro de version au nom des gestionnaires. </p><br><br><h3>  Recevoir et traiter les réponses </h3><br><p>  La base de données renvoie des rapports indiquant l'état de la réponse et les données.  Puisqu'il existe de nombreux codes et que l'écriture d'un commutateur avec le traitement de chacun d'eux est gênante, vous pouvez vérifier env.  Cela ne devrait pas être fait.  Le fait est que le code peut avoir le statut Ok, Erreur, Panique.  Avec Ok, tout est clair, mais qu'en est-il des deux autres?  Si l'état est Erreur, une opération spécifique est terminée ou n'est pas terminée.  Cette erreur doit être gérée de manière appropriée dans l'application.  Cependant, des travaux supplémentaires avec la base de données sont possibles (et nécessaires).  Une autre chose Panic - le travail avec la base de données doit être interrompu. </p><br><p>  La vérification de <code>IsCodeError</code> simplifie le travail avec toutes les erreurs, donc si vous n'êtes pas intéressé par les détails, continuez à travailler. <br>  La vérification <code>IsCodePanic</code> couvre tous les cas dans lesquels le travail avec la base de données doit être arrêté. </p><br><p>  Dans le cas simple, un triple interrupteur suffit pour traiter la réponse: </p><br><ul><li>  <code>IsCodeOk</code> - continuer à fonctionner comme d' <code>IsCodeOk</code> </li><li>  <code>IsCodeError</code> - enregistrez l'erreur à partir du rapport et travaillez plus loin </li><li>  <code>IsCodePanic</code> - enregistre l'erreur du rapport et arrête de travailler avec la base de données </li></ul><br><h3>  Offtop </h3><br><p>  Pour le nom, une des options pour traduire la <code></code> mots en anglais a été choisie, je préférerais la <code>box</code> , bien sûr, mais c'est un mot trop populaire, j'espère que le <code>coffer</code> fera l'affaire. <br>  Le sujet avec l'ACID me semble plutôt holistique, donc je dirais que Coffer est attaché à cela, mais pas un fait, et je ne prétends pas qu'il a réussi. </p><br><br><h3>  Performances </h3><br><p>  J'ai immédiatement écrit une base de données tenant compte de la concurrence et de la concurrence.  C'est dans ce mode qu'il montre son efficacité (bien que cela soit probablement dit trop fort).  Dans les résultats ci-dessous, le benchmark montre une bande passante de 200k rps.  C'est bien sûr un banc artificiel, et la réalité sera complètement différente, car  cela dépend beaucoup de la taille des données enregistrées, de la quantité de données déjà enregistrées, des performances du fer et de la phase de la lune.  Mais la tendance est au moins compréhensible.  Si la base de données est utilisée en mode monothread, chaque requête n'est exécutée qu'après avoir reçu la réponse à la précédente, la vitesse sera lente, et je vous conseille de regarder d'autres bases de données, mais pas Coffer. </p><br><ul><li>  BenchmarkCofferTransactionSequence-4 2000 227928 ns / op </li><li>  BenchmarkCofferTransactionPar32HalfConcurent-4 100000 4199 ns / op </li></ul><br><p>  Soit dit en passant, si quelqu'un passe du temps et s'incline vers un référentiel avec Coffer, si possible, exécutez le banc allongé dedans.  Je suis très intéressé par les machines dont les performances afficheront la base de données.  Tout d'abord, bien sûr, tout dépend du disque.  Cela est devenu particulièrement clair pour moi après avoir récemment acheté un nouveau Samsung EVO.  Mais ne vous inquiétez pas, ce n'est pas un substitut pour un disque mort.  L'ancien Toshiba continue de fonctionner correctement et stocke maintenant mes archives vidéo. </p><br><p>  La montre intégrée en mémoire est toujours une carte simple, pas même divisée en sections.  Bien sûr, il peut être utile de l'améliorer, par exemple, pour accélérer la sélection de clés par préfixes et suffixes.  Bien que je ne l'ai pas fait, tk.  la fonctionnalité principale, comme je le dis la puce DB, je vois dans les transactions, et le goulot d'étranglement dans les performances pour les transactions fonctionnera avec le disque, et alors seulement, avec la mémoire. </p><br><br><h3>  Licence </h3><br><p>  Maintenant, la licence vous permet de stocker jusqu'à dix millions d'enregistrements dans la base de données, il me semble que c'est un nombre suffisant.  D'autres projets de développement de la base de données sont en cours de constitution. <br>  En général, il est intéressant pour moi d'utiliser la base de données en tant que package et de me concentrer principalement sur son API. </p><br><br><h3>  Conclusions </h3><br><p>  Récemment, j'ai souvent rencontré la tâche d'écrire des services avec la caractéristique de la haute disponibilité.  Malheureusement, étant donné que cela implique presque toujours la présence de plusieurs instances, cela ne vaut pas la peine d'utiliser la base de données intégrée avec un tel cas.  Il reste l'option d'une application ou d'un service régulier qui existe dans une seule instance.  Cela me semble un cas plus rare, mais néanmoins il l'est, et dans un tel cas, c'est bien d'avoir une base de données qui essaie, autant que possible, de sauvegarder les données qui y sont stockées.  Le coffre que j'ai créé essaie de résoudre un tel problème.  Voyons comment il le fait. </p><br><br><h3>  Remerciements </h3><br><ul><li>  À tous ceux qui ont lu l'article jusqu'au bout </li><li>  Des commentateurs souhaitant partager leurs opinions </li><li>  Envoyé dans une information personnelle sur les fautes de frappe et les erreurs dans le texte </li><li>  Voisin tournant de la musique la nuit </li></ul><br><h3>  Les références </h3><br><p>  <a href="https://github.com/claygod/coffer">Référentiel DB</a> <br>  <a href="">Description en russe</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr477154/">https://habr.com/ru/post/fr477154/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr477138/index.html">Si Richard Hendricks était stupide, ou recherche linéaire contre binaire</a></li>
<li><a href="../fr477142/index.html">Comment les modificateurs d'accès freinent le développement des jeunes professionnels</a></li>
<li><a href="../fr477144/index.html">Comment rendre votre HTML réactif en ajoutant une ligne de code CSS</a></li>
<li><a href="../fr477146/index.html">Parlez de la mort</a></li>
<li><a href="../fr477148/index.html">IntelliSense basé sur l'IA pour votre code</a></li>
<li><a href="../fr477156/index.html">«Où aller pour la connaissance»: conférences scientifiques et conférences technologiques à l'Université ITMO</a></li>
<li><a href="../fr477158/index.html">Heures épigénétiques de vieillissement - mais quand même, elles tournent! ...</a></li>
<li><a href="../fr477160/index.html">Un petit manuel pour les étudiants d'une langue étrangère</a></li>
<li><a href="../fr477164/index.html">"Jeux de rythme à connaître": quels projets ont mis du son et l'ont intégré au genre</a></li>
<li><a href="../fr477166/index.html">Nouvelles du monde d'OpenStreetMap n ° 486 (11/05/2019 - 11/11/2019)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>