<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèΩ‚Äçüé§ üí™üèº üèÅ R√©trospective de l'automatisation et de l'√©volution des processus de d√©veloppement Timeweb üôÖ ü§¶üèæ üíπ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Le 1er novembre 2017, je suis devenu le chef de l'√©quipe de d√©veloppement au sein du d√©partement de d√©veloppement logiciel Timeweb. Et le 12 novembre ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>R√©trospective de l'automatisation et de l'√©volution des processus de d√©veloppement Timeweb</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/timeweb/blog/432150/"> Le 1er novembre 2017, je suis devenu le chef de l'√©quipe de d√©veloppement au sein du d√©partement de d√©veloppement logiciel Timeweb.  Et le 12 novembre 2018, le chef du d√©partement a demand√© quand l'article pour Habrahabr serait pr√™t, parce que le d√©partement marketing a demand√©, les volontaires √©taient termin√©s et le plan de contenu exigeait autre chose) <br><br>  Par cons√©quent, je veux donner une r√©trospective de la fa√ßon dont les processus de d√©veloppement, de test et de livraison de nos produits ont chang√© au cours de la derni√®re ann√©e.  √Ä propos des processus et outils h√©rit√©s, docker, gitlab et comment nous nous d√©veloppons. <br><a name="habracut"></a><br>  Timeweb Hoster existe depuis 2006.  Pendant tout ce temps, l'entreprise investit beaucoup d'efforts pour fournir aux clients un service unique et pratique qui le distinguerait de ses concurrents.  Timeweb a ses propres applications mobiles, une interface de messagerie Web, des panneaux de contr√¥le d'h√©bergement virtuel, VDS, un programme d'affiliation, ses outils de support et bien plus encore. <br><br>  <b>Il y a environ 250 projets dans notre gitlab:</b> ce sont des applications clientes, des outils internes, des biblioth√®ques, des r√©f√©rentiels de configuration.  Des dizaines d'entre eux sont activement d√©velopp√©s et soutenus: ils s'engagent pendant la semaine de travail, les testent, les collectent et les publient. <br><br>  Outre la grande quantit√© de code h√©rit√©, tout cela s'accompagne d'un nombre appropri√© de processus h√©rit√©s et d'outils associ√©s.  Comme tout h√©ritage, ils doivent √©galement √™tre maintenus, optimis√©s, refactoris√©s et parfois remplac√©s. <br><br>  De toute cette abondance de projets, les panneaux de contr√¥le sont les plus proches des clients d'h√©bergement.  Et c'est pr√©cis√©ment dans le projet ¬´Panneau de configuration¬ª que nous effectuons le plus souvent diverses am√©liorations d'infrastructure et d√©ployons beaucoup d'efforts pour maintenir l'infrastructure connect√©e en forme.  Diffuser l'exp√©rience acquise et les pratiques appr√©ci√©es aux autres produits et √† leurs √©quipes. <br><br>  √Ä propos des diff√©rents changements d'outils et de processus au cours de la derni√®re ann√©e, je vais vous le dire. <br><br><h2>  Vagrant ‚Üí docker-compose </h2><br><h3>  Le probl√®me </h3><br>  Le premier jour ouvrable, j'ai essay√© de relever les panneaux de contr√¥le localement.  √Ä cette √©poque, il y avait cinq applications Web dans un r√©f√©rentiel: <br><br>  - H√©bergement virtuel PU 3.0, <br>  - PU VDS 2.0, <br>  - Webmasters PU, <br>  - PERSONNEL (supports d'outils), <br>  - Lignes directrices (d√©monstration des composants frontaux standardis√©s). <br><br>  Pour ex√©cuter, Vagrant utilis√© localement.  Vagrant a lanc√© ansible.  Pour d√©marrer et configurer, il a fallu l'aide de coll√®gues et environ une journ√©e de temps de nettoyage.  J'ai d√ª installer une version sp√©ciale de Virtual Box (il y avait des probl√®mes sur la version stable actuelle), le travail √† partir de la console √† l'int√©rieur de la machine virtuelle √©tait tr√®s √©nervant: les commandes triviales comme l'installation de npm / composer ont consid√©rablement ralenti. <br><br>  Les performances des applications elles-m√™mes dans la machine virtuelle √©taient loin d'√™tre possibles, compte tenu de la pile technologique utilis√©e et de la puissance de la machine.  Sans oublier qu'une machine virtuelle est une machine virtuelle, et par d√©finition elle occupe une part importante des ressources de votre PC. <br><br><h3>  Solution </h3><br>  L'environnement de d√©veloppement local a √©t√© r√©√©crit pour s'ex√©cuter dans des conteneurs Docker.  La conteneurisation bas√©e sur Docker est la solution la plus courante pour isoler l'environnement d'application √† toutes les √©tapes de son cycle de vie.  Par cons√©quent, il n'y a pas d'alternatives sp√©ciales. <br><br><h3>  Conclusions </h3><br>  Des pros: <br><br>  - localement, l'application est devenue plus r√©active, les conteneurs n√©cessitent moins que les VMs, <br>  - le lancement d'une nouvelle instance, comme la pratique l'a montr√©, prend quelques minutes et ne n√©cessite que docker (-compose) pas inf√©rieur √† certaines versions.  Apr√®s le clonage, faites simplement: <br><br><pre><code class="bash hljs">make install-dev make run-dev</code> </pre> <br>  Il y avait quelques compromis: <br><br>  - J'ai d√ª √©crire des liaisons shell pour les commandes dock√©es (compositeur, npm, etc.).  Comme docker-compose.yml, ils ne sont pas enti√®rement multiplateformes par rapport √† Vagrant.  Par exemple, le lancement sous Mac n√©cessite des efforts suppl√©mentaires et sous Windows, il sera probablement plus facile d'ex√©cuter une distribution avec docker dans la machine virtuelle Linux.  Mais c'est un compromis acceptable,  l'√©quipe utilise uniquement des distributions bas√©es sur Debian, ceci est une limitation acceptable pour le d√©veloppement commercial, <br>  - pour prendre en charge les h√¥tes virtuels, un conteneur bas√© sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">github.com/jwilder/nginx-proxy est</a> lanc√© localement.  Ce n'est pas une b√©quille, mais un logiciel suppl√©mentaire, dont il faut parfois se souvenir, bien qu'il ne pose pas de probl√®me. <br><br>  Oui, tout le monde dans l'√©quipe devait comprendre un peu ce qu'est le docker.  Bien que gr√¢ce aux scripts shell et Makefile mentionn√©s, les d√©veloppeurs effectuent 95% de leurs t√¢ches sans penser aux conteneurs, mais dans un environnement identique garanti. <br><br><h2>  newcp-dev ‚Üí cp-stands </h2><br>  Ces expressions √©tranges sont les noms de machines avec des bancs d'essai de panneaux de contr√¥le, nouveaux et anciens, respectivement. <br><br><h3>  Le probl√®me </h3><br>  Les recettes Ansible ont √©t√© utilis√©es exclusivement √† l'int√©rieur de Vagrant, donc le principal avantage n'a pas √©t√© obtenu: les versions des packages dans la prod et sur les stands √©taient diff√©rentes de celles sur lesquelles les d√©veloppeurs ont travaill√©. <br><br>  La non-concordance des versions des progiciels de serveur sur les anciens stands avec ce que les d√©veloppeurs avaient, a conduit √† des probl√®mes.  La synchronisation a √©t√© compliqu√©e par le fait que les administrateurs syst√®me utilisent un syst√®me de gestion de configuration diff√©rent et qu'il n'est pas possible de l'int√©grer au r√©f√©rentiel des d√©veloppeurs. <br><br><h3>  Solution </h3><br>  Apr√®s la conteneurisation, il n'a pas √©t√© difficile d'√©tendre la configuration docker-compose pour une utilisation sur des bancs de test.  Une nouvelle machine a √©t√© cr√©√©e pour d√©ployer les stands sur DOCKER_HOST. <br><br><h3>  Conclusions </h3><br>  Les d√©veloppeurs sont d√©sormais convaincus de la pertinence des environnements locaux et de test. <br><br><h2>  TeamCity ‚Üí gitlab-ci </h2><br><h3>  Les probl√®mes </h3><br>  La configuration de projet dans TeamCity est un processus laborieux et ingrat.  La configuration CI a √©t√© stock√©e s√©par√©ment du code, en xml, auquel le contr√¥le de version normal n'est pas applicable, et un aper√ßu des modifications.  Nous avons √©galement rencontr√© des probl√®mes avec la stabilit√© du processus de g√©n√©ration sur les agents TeamCity. <br><br><h3>  Solution </h3><br>  √âtant donn√© que gitlab √©tait d√©j√† utilis√© comme r√©f√©rentiel pour les r√©f√©rentiels, commencer √† utiliser son CI √©tait non seulement logique, mais aussi facile et agr√©able.  Maintenant, toute la configuration CI / CD est directement dans le r√©f√©rentiel. <br><br><h3>  R√©sultat </h3><br>  Au cours de l'ann√©e, presque tous les projets assembl√©s par TeamCity ont √©t√© transf√©r√©s en toute s√©curit√© vers gitlab-ci.  Nous avons eu l'occasion d'impl√©menter rapidement une vari√©t√© de fonctionnalit√©s pour automatiser les processus CI / CD. <br>  Les captures d'√©cran des pipelines seront les plus √©videntes: <br><br><img src="https://habrastorage.org/webt/st/v2/il/stv2ileqimz3apyuvtkowk2gad8.png" alt="Fig. 1. fonctionnalit√©-branche: tous les contr√¥les et tests automatiques disponibles sont inclus. Une fois termin√©, envoie un commentaire avec un lien vers le pipeline vers la t√¢che redmine. T√¢ches manuelles pour assembler et lancer un stand avec cette branche."><br>  <i>Fig.</i>  <i>1. fonctionnalit√©-branche: tous les contr√¥les et tests automatiques disponibles sont inclus.</i>  <i>Une fois termin√©, envoie un commentaire avec un lien vers le pipeline vers la t√¢che redmine.</i>  <i>T√¢ches manuelles pour assembler et lancer un stand avec cette branche.</i> <br><br><img src="https://habrastorage.org/webt/yz/tp/ud/yztpudorntvx4ffl3es47l5ihti.png" alt="Fig. 2. d√©velopper la construction planifi√©e avec le gel de code (checkout: rc): construire d√©velopper selon le calendrier avec le gel de code. L'assemblage d'images pour les stands des panneaux de commande individuels se d√©roule en parall√®le."><br>  <i>Fig.</i>  <i>2. d√©velopper la construction planifi√©e avec le gel de code (checkout: rc): construire d√©velopper selon le calendrier avec le gel de code.</i>  <i>L'assemblage d'images pour les stands des panneaux de commande individuels se d√©roule en parall√®le.</i> <br><br><img src="https://habrastorage.org/webt/d4/-t/wt/d4-twtogb-re2pl9gl0i6j4qzz8.png" alt="Fig. 3. pipeline de tags: lib√©ration d'un des panneaux de contr√¥le. T√¢che manuelle pour la lib√©ration de la restauration."><br>  <i>Fig.</i>  <i>3. pipeline de tags: lib√©ration d'un des panneaux de contr√¥le.</i>  <i>T√¢che manuelle pour la lib√©ration de la restauration.</i> <br><br>  De plus, √† partir de gitlab-ci, il y a un changement de statut et la nomination d'une personne en redmine aux √©tapes En cours ‚Üí R√©vision ‚Üí Contr√¥le qualit√©, notification dans Slack sur les versions et mises √† jour, staging et rollbacks. <br><br>  C'est pratique, mais nous n'avons pas pris en compte un point m√©thodologique.  Apr√®s avoir impl√©ment√© une telle automatisation dans un projet, les gens s'y habituent rapidement.  Et dans le cas de basculer vers un autre projet o√π cela n'existe pas encore, ou le processus est diff√©rent, vous pouvez oublier de d√©placer et de r√©affecter la t√¢che dans redmine ou de laisser un commentaire avec un lien vers la demande de fusion (ce que gitlab-ci fait √©galement), for√ßant le spectateur √† rechercher celui souhait√© MR vous-m√™me.  En m√™me temps, vous ne voulez tout simplement pas copier les pi√®ces .gitlab-ci.yml et le code shell qui l'accompagne entre les projets, car vous devez prendre en charge le copier-coller. <br><br>  <b>Conclusion: l'</b> automatisation c'est bien, mais quand c'est la m√™me chose au niveau de toutes les √©quipes et projets - c'est encore mieux.  Je serais reconnaissant au distingu√© public pour ses id√©es sur la fa√ßon d'organiser magnifiquement la r√©utilisation d'une telle configuration. <br><br><h3>  Dur√©e du pipeline: 80 min ‚Üí 8 min </h3><br>  Progressivement, notre CI a commenc√© √† prendre ind√©cemment beaucoup de temps.  Les testeurs en ont beaucoup souffert: chaque correction dans master a d√ª attendre une heure avant d'√™tre publi√©e.  Cela ressemblait √† ceci: <br><br><img src="https://habrastorage.org/webt/zg/pc/xf/zgpcxfwroial8l7dkg2gikodlms.png" alt="Fig. 4. dur√©e du pipeline de 80 lvl min."><br>  <i>Fig.</i>  <i>4. dur√©e du pipeline de 80 <s>lvl</s> min.</i> <br><br>  J'ai d√ª plonger dans l'analyse des lieux lents pendant plusieurs jours et chercher des moyens d'acc√©l√©rer tout en conservant la fonctionnalit√©. <br><br>  Les √©tapes les plus longues du processus ont √©t√© l'installation de packages npm.  Sans aucun probl√®me, ils l'ont remplac√© par du fil et enregistr√© en plusieurs endroits jusqu'√† 7 minutes. <br><br>  Ils ont refus√© les mises √† jour automatiques de la mise en sc√®ne, ont pr√©f√©r√© le contr√¥le manuel de l'√©tat de ce stand. <br><br>  Nous avons √©galement ajout√© plusieurs coureurs et divis√© en t√¢ches parall√®les l'assemblage d'images d'application et tous les contr√¥les.  Apr√®s ces optimisations, le pipeline de la branche principale avec la mise √† jour de tous les stands a commenc√© dans la plupart des cas 7 √† 8 minutes. <br><br><h2>  Capistrano ‚Üí d√©ployeur </h2><br>  Pour le d√©ploiement en production et sur le stand qa, Capistrano a √©t√© utilis√© (et continue d'√™tre utilis√© au moment de la r√©daction).  Le sc√©nario principal de cet outil est le suivant: clonage du r√©f√©rentiel sur le serveur cible et ex√©cution de toutes les t√¢ches sur celui-ci. <br><br>  Auparavant, le d√©ploiement √©tait d√©clench√© par les mains d'un ing√©nieur QA avec les cl√©s ssh n√©cessaires de Vagrant.  Puis, alors que Vagrant abandonnait, Capistrano a emm√©nag√© dans un conteneur s√©par√©.  Maintenant, le d√©ploiement est fait √† partir du conteneur avec Capistrano avec des coureurs gitlab, marqu√©s avec des balises sp√©ciales et ayant les cl√©s n√©cessaires, automatiquement lorsque les balises n√©cessaires apparaissent. <br><br>  Le probl√®me ici est que tout le processus de construction: <br><br>  a) consomme significativement les ressources du serveur de combat (notamment node / gulp), <br>  b) il n'y a aucun moyen de tenir √† jour les versions de npm du compositeur.  n≈ìud, etc. <br><br>  Il est plus logique de construire sur un serveur de build (dans notre cas, il s'agit de gitlab-runner) et de t√©l√©charger des artefacts pr√™ts sur le serveur cible.  Cela sauvera le serveur de combat des utilitaires d'assemblage et de la responsabilit√© √©trang√®re. <br><br>  Nous consid√©rons maintenant le d√©ployeur comme un remplacement pour capistrano (puisque nous n'avons pas de rubistes, nous n'avons pas non plus le d√©sir de travailler avec sa DSL) et pr√©voyons de transf√©rer l'assemblage du c√¥t√© gitlab.  Dans certains projets non critiques, nous avons d√©j√† r√©ussi √† l'essayer et jusqu'√† pr√©sent, nous sommes satisfaits: cela semble plus facile, nous n'avons rencontr√© aucune restriction. <br><br><h2>  Gitflow: rc-branches ‚Üí tags </h2><br>  Le d√©veloppement s'effectue en cycles hebdomadaires.  Au cours des cinq jours, une nouvelle version est en cours de d√©veloppement: le d√©veloppeur accepte les am√©liorations et les correctifs pr√©vus pour la semaine prochaine.  Vendredi soir, le gel du code se produit automatiquement.  Lundi, les tests de la nouvelle version commencent, des am√©liorations sont apport√©es et √† la mi-fin de la semaine de travail, une version est disponible. <br><br>  Auparavant, nous utilisions des branches avec des noms de la forme rc18-47, ce qui signifie que la version candidate est la 47e semaine de 2018.  Le gel du code consistait √† extraire la branche rc de develop.  Mais en octobre de cette ann√©e, nous sommes pass√©s aux balises.  Les tags ont √©t√© d√©finis avant, mais apr√®s coup, apr√®s la sortie et la fusion de rc avec master.  Maintenant, l'apparence de la balise conduit √† un d√©ploiement automatique, et le gel est une fusion de d√©velopper en ma√Ætre. <br><br>  Nous nous sommes donc d√©barrass√©s des entit√©s suppl√©mentaires dans git et des variables dans le processus. <br>  Maintenant, nous ¬´tirons¬ª les projets en retard dans le processus vers un flux de travail similaire. <br><br><h2>  Conclusion </h2><br>  L'automatisation des processus, leur optimisation, ainsi que le d√©veloppement, est une question constante: tant que le produit √©volue activement et que l'√©quipe travaille, il y aura des t√¢ches correspondantes.  De nouvelles id√©es apparaissent sur la fa√ßon de se d√©barrasser des actions de routine: les fonctionnalit√©s sont impl√©ment√©es dans gitlab-ci. <br><br>  √Ä mesure que les applications se d√©veloppent, les processus CI commencent √† prendre un temps inacceptable - il est temps de travailler sur leurs performances.  √âtant donn√© que les approches et les outils deviennent obsol√®tes, vous devez prendre le temps de les refactoriser, de les r√©viser et de les mettre √† jour. <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img src="https://habrastorage.org/webt/7s/ep/wa/7sepwab6lc2aunuzcyjfcothxeu.png" alt="image"></a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr432150/">https://habr.com/ru/post/fr432150/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr432138/index.html">Parlons des m√©triques comme moyen d'√©valuer le travail d'un programmeur</a></li>
<li><a href="../fr432142/index.html">Surveillance des ruches et projet ouvert</a></li>
<li><a href="../fr432144/index.html">Comment nous nous sommes int√©gr√©s pour les magasins SAP en Europe avec des caisses en Russie via 1C</a></li>
<li><a href="../fr432146/index.html">Zimbra Collaboration Suite en remplacement digne de Microsoft Exchange</a></li>
<li><a href="../fr432148/index.html">Caract√©ristiques des tests de pr√™ts: comment un bug affecte des milliers de dollars de revenus</a></li>
<li><a href="../fr432152/index.html">Conclusions sur l'avenir du commerce de d√©tail apr√®s le Black Friday</a></li>
<li><a href="../fr432154/index.html">L'acc√®s conditionnel comme m√©canisme de contr√¥le d'acc√®s</a></li>
<li><a href="../fr432156/index.html">Nouveau 2GIS - connectez-vous aux tests publics</a></li>
<li><a href="../fr432158/index.html">Utiliser JIRA et Confluence dans un grand projet</a></li>
<li><a href="../fr432160/index.html">Vid√©o d'Android Kolesa Mobile: sur le d√©veloppement modulaire, l'interface utilisateur pilot√©e par le backend et l'int√©gration continue</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>