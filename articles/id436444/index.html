<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏾‍🎨 🕉️ 👈🏻 Penyebaran aplikasi monolitik yang tak terlihat dalam produksi di AWS. Pengalaman pribadi 😴 🔌 🏥</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Saya seorang Lead DevOps Engineer di Miro (ex-RealtimeBoard). Saya akan membagikan bagaimana tim DevOps kami memecahkan masalah rilis server harian da...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Penyebaran aplikasi monolitik yang tak terlihat dalam produksi di AWS. Pengalaman pribadi</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/miro/blog/436444/">  Saya seorang Lead DevOps Engineer di Miro (ex-RealtimeBoard).  Saya akan membagikan bagaimana tim DevOps kami memecahkan masalah rilis server harian dari aplikasi stateful monolitik dan membuatnya otomatis, tidak terlihat oleh pengguna dan nyaman bagi pengembang mereka sendiri. <br><br><h2>  Infrastruktur kami </h2><br>  Tim pengembangan kami adalah 60 orang yang dibagi menjadi tim Scrum, di antaranya ada juga tim DevOps.  Sebagian besar perintah Scrum mendukung fungsionalitas produk saat ini dan menghadirkan fitur baru.  Tugas DevOps adalah membuat dan memelihara infrastruktur yang membantu aplikasi bekerja dengan cepat dan andal serta memungkinkan tim untuk dengan cepat memberikan fungsionalitas baru kepada pengguna. <br><img src="https://habrastorage.org/webt/sh/f-/qy/shf-qy6dzbfvuzonf4h5yf5iupk.png"><br><a name="habracut"></a><br><br>  Aplikasi kami adalah papan online tanpa akhir.  Ini terdiri dari tiga lapisan: situs, klien, dan server di Jawa, yang merupakan aplikasi stateful monolitik.  Aplikasi ini membuat koneksi web-socket yang konstan dengan klien, dan setiap server menyimpan dalam cache cache yang terbuka. <br><br>  Seluruh infrastruktur - lebih dari 70 server - terletak di Amazon: lebih dari 30 server dengan aplikasi Java, server web, server database kami, broker, dan banyak lagi.  Dengan pertumbuhan fungsionalitas, semua ini harus diperbarui secara teratur, tanpa mengganggu pekerjaan pengguna. <br>  Memperbarui situs dan klien itu sederhana: kami mengganti versi yang lama dengan yang baru, dan saat berikutnya pengguna mengakses situs baru dan klien baru.  Tetapi jika kita melakukan ini ketika server dilepaskan, kita mengalami downtime.  Bagi kami, ini tidak dapat diterima, karena nilai utama dari produk kami adalah kerja bersama pengguna secara real time. <br><br><h2>  Bagaimana proses CI / CD kami terlihat </h2><br>  Proses CI / CD bersama kami adalah git commit, git push, kemudian perakitan otomatis, pengujian otomatis, penyebaran, rilis dan pemantauan. <br><br><img src="https://habrastorage.org/webt/ok/se/rv/okservy5e1ai7rboli8mvgvrvh4.png"><br><br>  Untuk integrasi berkelanjutan, kami menggunakan Bamboo dan Bitbucket.  Untuk pengujian otomatis - Java dan Python, dan Allure - untuk menampilkan hasil pengujian otomatis.  Untuk pengiriman kontinu - Packer, Ansible, dan Python.  Semua pemantauan dilakukan menggunakan ELK Stack, Prometheus dan Sentry. <br><br>  Pengembang menulis kode, menambahkannya ke repositori, setelah itu perakitan otomatis dan pengujian otomatis diluncurkan.  Pada saat yang sama di dalam tim mengumpulkan dari pengembang lain dan melakukan Peninjauan Kode.  Ketika semua proses yang diperlukan, termasuk autotest, telah selesai, tim memegang bangunan di cabang utama, dan membangun cabang utama dimulai dan dikirim untuk pengujian otomatis.  Seluruh proses debugged dan dilakukan oleh tim sendiri. <br><br><h2>  Gambar AMI </h2><br>  Sejalan dengan build build dan testing, build image AMI untuk Amazon dimulai.  Untuk melakukan ini, kami menggunakan Packer dari HashiCorp, alat opensource yang hebat yang memungkinkan Anda membuat gambar mesin virtual.  Semua parameter diteruskan ke JSON dengan satu set kunci konfigurasi.  Parameter utama adalah pembangun, yang menunjukkan untuk penyedia mana kami membuat gambar (dalam kasus kami, untuk Amazon). <br><br><pre><code class="plaintext hljs">"builders": [{ "type": "amazon-ebs", "access_key": "{{user `aws_access_key`}}", "secret_key": "{{user `aws_secret_key`}}", "region": "{{user `aws_region`}}", "vpc_id": "{{user `aws_vpc`}}", "subnet_id": "{{user `aws_subnet`}}", "tags": { "releaseVersion": "{{user `release_version`}}" }, "instance_type": "t2.micro", "ssh_username": "ubuntu", "ami_name": "packer-board-ami_{{isotime \"2006-01-02_15-04\"}}" }],</code> </pre> <br>  Adalah penting bahwa kita tidak hanya membuat gambar dari mesin virtual, tetapi mengkonfigurasinya terlebih dahulu menggunakan Ansible: menginstal paket yang diperlukan dan membuat pengaturan konfigurasi untuk menjalankan aplikasi Java. <br><br><pre> <code class="plaintext hljs"> "provisioners": [{ "type": "ansible", "playbook_file": "./playbook.yml", "user": "ubuntu", "host_alias": "default", "extra_arguments": ["--extra_vars=vars"], "ansible_env_vars": ["ANSIBLE_HOST_KEY_CHECKING=False", "ANSIBLE_NOCOLOR=True"] }]</code> </pre><br><h2>  Peran yang dimungkinkan </h2><br>  Kami dulu menggunakan buku pedoman Ansible biasa, tetapi ini menyebabkan banyak kode berulang, yang menjadi sulit untuk tetap up to date.  Kami mengubah sesuatu di satu buku pedoman, lupa melakukannya di yang lain, dan akibatnya kami mengalami masalah.  Jadi kami mulai menggunakan Ansible-role.  Kami menjadikannya serbaguna mungkin sehingga kami dapat menggunakannya kembali di berbagai bagian proyek dan tidak membebani kode dalam potongan berulang besar.  Misalnya, kami menggunakan peran Pemantauan untuk semua jenis server. <br><br><pre> <code class="plaintext hljs">- name: Install all board dependencies hosts: all user: ubuntu become: yes roles: - java - nginx - board-application - ssl-certificates - monitoring</code> </pre><br>  Dari sisi Scrum-tim proses ini terlihat sesederhana mungkin: tim menerima notifikasi di Slack bahwa build dan AMI-image telah dirakit. <br><br><h2>  Pra-rilis </h2><br>  Kami memperkenalkan pra-rilis untuk mengirimkan perubahan produk kepada pengguna secepat mungkin.  Sebenarnya, ini adalah rilis kenari yang memungkinkan Anda untuk menguji fungsionalitas baru dengan aman pada sebagian kecil pengguna. <br><br>  Mengapa rilis disebut kenari?  Sebelumnya, para penambang, ketika mereka turun ke tambang, membawa kenari.  Jika ada gas di tambang, kenari mati, dan para penambang dengan cepat naik ke permukaan.  Begitu pula dengan kami: jika ada masalah dengan server, maka rilisnya tidak siap dan kami dapat dengan cepat memutar kembali dan sebagian besar pengguna tidak akan melihat apa-apa. <br><br>  <strong>Bagaimana rilis kenari dimulai:</strong> <br><ol><li>  Tim pengembang di Bamboo mengklik tombol -&gt; aplikasi Python disebut yang meluncurkan pra-rilis. </li><li>  Itu menciptakan contoh baru di Amazon dari gambar AMI yang sudah disiapkan sebelumnya dengan versi baru aplikasi. </li><li>  Mesin virtual ditambahkan ke grup target yang diperlukan dan load balancers. </li><li>  Dengan Ansible, konfigurasi individual dikonfigurasikan untuk setiap instance. </li><li>  Pengguna bekerja dengan versi baru aplikasi Java. </li></ol><br>  Di samping perintah Scrum, proses peluncuran pra-rilis sekali lagi terlihat sesederhana mungkin: tim menerima pemberitahuan di Slack bahwa proses telah dimulai, dan setelah 7 menit server baru sudah beroperasi.  Selain itu, aplikasi mengirim ke Slack seluruh changelog perubahan dalam rilis. <br><br>  Agar penghalang perlindungan dan keandalan ini berfungsi, tim Scrum memantau kesalahan baru di Sentry.  Ini adalah aplikasi pelacakan bug sumber terbuka secara real time.  Sentry terintegrasi dengan Java dan memiliki konektor dengan logback dan log2j.  Ketika aplikasi dimulai, kami mentransfer ke Sentry versi yang menjalankannya, dan ketika kesalahan terjadi, kami melihat di versi mana aplikasi itu terjadi.  Ini membantu tim Scrum merespons kesalahan dengan cepat dan memperbaikinya dengan cepat. <br><br>  Pra-rilis harus bekerja setidaknya selama 4 jam.  Selama waktu ini, tim memantau pekerjaannya dan memutuskan apakah akan merilis rilis ke semua pengguna. <br><br>  <strong>Beberapa tim dapat secara bersamaan merilis rilis mereka</strong> .  Untuk melakukan ini, mereka sepakat di antara mereka sendiri apa yang masuk ke dalam pra-rilis dan siapa yang bertanggung jawab untuk rilis final.  Setelah itu, tim menggabungkan semua perubahan menjadi satu pra-rilis, atau meluncurkan beberapa pra-rilis pada saat yang sama.  Jika semua pra-rilis sudah benar, mereka akan dirilis sebagai satu rilis di hari berikutnya. <br><br><h2>  Rilis </h2><br>  Kami melakukan rilis harian: <br><br><ol><li>  Kami memperkenalkan server baru agar berfungsi. </li><li>  Kami memantau aktivitas pengguna di server baru menggunakan Prometheus. </li><li>  Tutup akses untuk pengguna baru ke server lama. </li><li>  Kami mentransfer pengguna dari server lama ke yang baru. </li><li>  Matikan server lama. </li></ol><br>  Semuanya dibangun menggunakan aplikasi Bamboo dan Python.  Aplikasi memeriksa jumlah server yang berjalan dan bersiap untuk meluncurkan jumlah yang sama dengan yang baru.  Jika tidak ada cukup server, mereka dibuat dari gambar AMI.  Versi baru dikerahkan pada mereka, aplikasi Java diluncurkan, dan server dioperasikan. <br><br>  Saat memantau, aplikasi Python menggunakan API Prometheus memeriksa jumlah papan terbuka di server baru.  Ketika mengerti bahwa semuanya berfungsi dengan baik, ia menutup akses ke server lama dan mentransfer pengguna ke yang baru. <br><br><pre> <code class="plaintext hljs">import requests PROMETHEUS_URL = 'https://prometheus' def get_spaces_count(): boards = {} try: params = { 'query': 'rtb_spaces_count{instance=~"board.*"}' } response = requests.get(PROMETHEUS_URL, params=params) for metric in response.json()['data']['result']: boards[metric['metric']['instance']] = metric['value'][1] except requests.exceptions.RequestException as e: print('requests.exceptions.RequestException: {}'.format(e)) finally: return boards</code> </pre><br>  Proses mentransfer pengguna antar server ditampilkan di Grafana.  Di bagian kiri grafik, server yang menjalankan versi lama ditampilkan, di sebelah kanan - yang baru.  Persimpangan grafik adalah momen transfer pengguna. <br><br><img src="https://habrastorage.org/webt/zt/8l/df/zt8ldf8hmk39a7tzho9a_dt0gnq.png"><br><br>  Tim mengawasi pelepasan Slack.  Setelah rilis, seluruh changelog perubahan dipublikasikan di saluran terpisah di Slack, dan di Jira semua tugas yang terkait dengan rilis ini ditutup secara otomatis. <br><br><h3>  Apa itu migrasi pengguna </h3><br>  Kami menyimpan status papan tulis tempat pengguna bekerja, dalam memori aplikasi dan terus-menerus menyimpan semua perubahan ke database.  Untuk mentransfer papan di tingkat interaksi cluster, kami memuatnya ke dalam memori di server baru dan mengirimkan klien perintah untuk menyambung kembali.  Pada titik ini, klien terputus dari server lama dan terhubung ke yang baru.  Setelah beberapa detik, pengguna melihat tulisan - Koneksi dipulihkan.  Namun, mereka terus bekerja dan tidak melihat ketidaknyamanan. <br><br><img src="https://habrastorage.org/webt/8m/ie/ae/8mieaew94xjibv9emwf0gkrq1l8.png"><br><br><h2>  Apa yang kami pelajari saat membuat penyebaran tidak terlihat </h2><br>  Apa yang kita dapatkan setelah selusin iterasi: <br><br><ul><li>  Tim scrum memeriksa kodenya sendiri. </li><li>  Tim scrum memutuskan kapan untuk meluncurkan pra-rilis dan membawa beberapa perubahan kepada pengguna baru. </li><li>  Scrum-team memutuskan apakah rilisnya siap untuk digunakan oleh semua pengguna. </li><li>  Pengguna terus bekerja dan tidak memperhatikan apa pun. </li></ul><br>  Ini tidak mungkin segera, kami menginjak menyapu yang sama berkali-kali dan mengisi banyak kerucut.  Saya ingin membagikan pelajaran yang telah kami terima. <br><br>  <strong>Pertama, proses manual, dan baru setelah itu otomatisasi.</strong>  Langkah-langkah pertama tidak perlu masuk lebih jauh ke dalam otomatisasi, karena Anda dapat mengotomatisasi apa yang pada akhirnya tidak berguna. <br><br>  <strong>Kemungkinan adalah baik, tetapi peran yang mungkin lebih baik.</strong>  Kami membuat peran kami seuniversal mungkin: kami menyingkirkan kode berulang, jadi mereka hanya membawa fungsionalitas yang harus mereka bawa.  Ini memungkinkan Anda menghemat waktu secara signifikan dengan menggunakan kembali peran, yang sudah kami miliki lebih dari 50. <br><br>  <strong>Gunakan kembali kode dengan Python dan pecah menjadi perpustakaan dan modul yang terpisah.</strong>  Ini membantu Anda menavigasi proyek yang kompleks dan dengan cepat membenamkan orang-orang baru di dalamnya. <br><br><h2>  Langkah selanjutnya </h2><br>  Proses penyebaran yang tak terlihat belum berakhir.  Berikut ini beberapa langkah berikut: <br><br><ol><li>  Izinkan tim untuk menyelesaikan tidak hanya pra-rilis, tetapi semua rilis. </li><li>  Buat rollback otomatis jika terjadi kesalahan.  Misalnya, pra-rilis harus secara otomatis memutar kembali jika kesalahan kritis terdeteksi di Sentry. </li><li>  Mengotomatisasi sepenuhnya rilis tanpa adanya kesalahan.  Jika tidak ada kesalahan pada pra-rilis, itu berarti dapat secara otomatis diluncurkan lebih lanjut. </li><li>  Tambahkan pemindaian kode otomatis untuk kemungkinan kesalahan keamanan. </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id436444/">https://habr.com/ru/post/id436444/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id436434/index.html">PVS-Studio untuk Java</a></li>
<li><a href="../id436436/index.html">CERN berencana untuk membangun akselerator baru dengan panjang terowongan 100 km</a></li>
<li><a href="../id436438/index.html">Roscosmos menyebut kemungkinan alasan hilangnya komunikasi dengan observatorium orbital Spektr-R</a></li>
<li><a href="../id436440/index.html">Gotta Go Fast: Membangun untuk Kecepatan di iOS. Bagian 2</a></li>
<li><a href="../id436442/index.html">Satu kepala baik, dan dua lebih baik, atau memasangkan pemrograman dalam aksi</a></li>
<li><a href="../id436448/index.html">Tinjau 27 "monitor IPS Acer HA270bid: untuk perbaikan diri</a></li>
<li><a href="../id436450/index.html">Terpencil dan terkendali, kebebasan dan pemerintahan. Percakapan dengan Staply</a></li>
<li><a href="../id436452/index.html">7 area pengembangan Linux pada 2019</a></li>
<li><a href="../id436454/index.html">Tanya Jawab JavaScript</a></li>
<li><a href="../id436456/index.html">Buat efek distribusi warna di Unity</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>