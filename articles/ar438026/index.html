<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>๐ ๐ธ ๐ง๐ฟ RedisPipe - ุฃูุซุฑ ูุชุนุฉ ูุนุง ๐ ๐ ๐ฎ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ุนูุฏูุง ุฃููุฑ ูู ููููุฉ ุนูู ุนููุงุก RPC ุงูุณุงุฐุฌูู ุ ุฃุชุฐูุฑ ูุฒุญุฉ: 
 ุงููุญููุฉ. 
 "ุงููุชูู ุ ููุงุฐุง ูุชูุช ุงูุฑุฃุฉุ" 
 - ุฃูุง ูู ุงูุญุงููุฉ ุ ุงูููุตู ููุชุฑุจ ูู ุงููุฑุฃุฉ ุ ูุทุงูุจ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>RedisPipe - ุฃูุซุฑ ูุชุนุฉ ูุนุง</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/joom/blog/438026/" style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl">  ุนูุฏูุง ุฃููุฑ ูู ููููุฉ ุนูู ุนููุงุก RPC ุงูุณุงุฐุฌูู ุ ุฃุชุฐูุฑ ูุฒุญุฉ: </p><br><blockquote style=";text-align:right;direction:rtl">  ุงููุญููุฉ. <br>  "ุงููุชูู ุ ููุงุฐุง ูุชูุช ุงูุฑุฃุฉุ" <br>  - ุฃูุง ูู ุงูุญุงููุฉ ุ ุงูููุตู ููุชุฑุจ ูู ุงููุฑุฃุฉ ุ ูุทุงูุจูุง ุจุดุฑุงุก ุชุฐูุฑุฉ.  ุงููุฑุฃุฉ ูุชุญุช ุญููุจุชูุง ุ ุฃุฎุฑุฌุช ุญููุจุชูุง ุ ุฃุบููุช ุญููุจุชูุง ุ ูุชุญุช ุญููุจุชูุง ุ ุฃุบููุช ุญููุจุชูุง ุ ูุชุญุช ุญููุจุชูุง ุ ูุถุนุช ุญููุจุชูุง ููุงู ุ ุฃุบููุช ุญููุจุชูุง ุ ูุชุญุช ุญููุจุชูุง ุ ุฃุฎุฐุช ูุงูุชูุง ุ ูุชุญุช ุญููุจุชูุง ุ ูุชุญุช ุญููุจุชูุง ุ ูุชุญุช ุญููุจุชูุง ุ ุฃุบููุช ูุญูุธุชูุง ุ ูุชุญุช ูุญูุธุชูุง ุ ูุถุนุช ูุญูุธุชูุง ููุงู. <br>  - ููุงุฐุงุ <br>  - ุฃุนุทุงูุง ุงููุฑุงูุจ ุงููุงูู ุชุฐูุฑุฉ.  ุงูุฑุฃุฉ ูุชุญุช ุญููุจุชูุง ุ ุฃุฎุฑุฌุช ุญููุจุชูุง ุ ุฃุบููุช ุญููุจุชูุง ุ ูุชุญุช ุญููุจุชูุง ุ ุฃุบููุช ุญููุจุชูุง ุ ูุชุญุช ุญููุจุชูุง ุ ูุถุนุช ุญููุจุชูุง ููุงู ุ ุฃุบููุช ุญููุจุชูุง ุ ูุชุญุช ุญููุจุชูุง ุ ูุถุนุช ุชุฐูุฑุชูุง ููุงู ุ ุฃุบููุช ุญููุจุชูุง ุ ูุชุญุช ุญููุจุชูุง ุ ูุชุญุช ุญููุจุชูุง ุ ูุชุญุช ุญููุจุชูุง ุ ุถุน ุงููุญูุธู ููุงู ุ ุฃุบูู ุงููุญูุธู ุ ูุชุญ ุงููุญูุธู ุ ูุถุน ุงููุญูุธู ููู ุ ุฃุบูู ุงููุญูุธู. <br>  "ุฎุฐ ุงูุชุบููุฑ" ุ ุฌุงุก ุตูุช ูุญุฏุฉ ุงูุชุญูู.  ุงููุฑุฃุฉ ... ูุชุญุช ุญููุจุชูุง ... <br>  "ูุนู ุ ูุง ูููู ูุชููุง" ุงููุฏุนู ุงูุนุงู ูุง ููู. <br>  "ููุฏ ูุนูุช ุฐูู." <br>  ยฉ S. Altov </blockquote><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/qx/ne/-b/qxne-bocftxvmk99ouizmn3iqyo.jpeg"></p><a name="habracut"></a><br><p style=";text-align:right;direction:rtl">  ูุญุฏุซ ููุณ ุงูุดูุก ุชูุฑูุจูุง ูู ุนูููุฉ ุงูุงุณุชุฌุงุจุฉ ููุทูุจ ุ ุฅุฐุง ูุง ุงูุชุฑุจุช ูู ุฐูู ุจุทุฑููุฉ ุชุงููุฉ: </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุชูุชุจ ุนูููุฉ ุงููุณุชุฎุฏู ุทูุจูุง ูุณูุณูุงู ุฅูู ุงูููุจุณ ุ ูุชููู ุจูุณุฎู ูุนูููุง ุฅูู ุงููุฎุฒู ุงููุคูุช ููููุจุณ ุนูู ูุณุชูู ูุธุงู ุงูุชุดุบูู ุ <br>  ูุฐู ุนูููุฉ ุตุนุจุฉ ุฅูู ุญุฏ ูุง ุ ูุฃู  ูู ุงูุถุฑูุฑู ุฅุฌุฑุงุก ุชุจุฏูู ููุณูุงู (ุญุชู ูู ูุงู "ุณูููุง") ุ </li><li style=";text-align:right;direction:rtl">  ุนูุฏูุง ูุจุฏู ููุธุงู ุงูุชุดุบูู ุฃูู ูููู ูุชุงุจุฉ ุดูุก ูุง ุนูู ุงูุดุจูุฉ ุ ูุชู ุชูููู ุญุฒูุฉ (ูุชู ูุณุฎ ุงูุทูุจ ูุฑุฉ ุฃุฎุฑู) ูุฅุฑุณุงููุง ุฅูู ุจุทุงูุฉ ุงูุดุจูุฉ ุ </li><li style=";text-align:right;direction:rtl">  ุจุทุงูุฉ ุงูุดุจูุฉ ููุชุจ ุงูุญุฒูุฉ ุฅูู ุงูุดุจูุฉ (ุฑุจูุง ุจุนุฏ ุงูุชุฎุฒูู ุงููุคูุช) ุ </li><li style=";text-align:right;direction:rtl">  (ุนูู ุทูู ุงูุทุฑูู ุ ูููู ุชุฎุฒูู ุญุฒูุฉ ุนุฏุฉ ูุฑุงุช ูู ุฃุฌูุฒุฉ ุงูุชูุฌูู) ุ </li><li style=";text-align:right;direction:rtl">  ุฃุฎูุฑูุง ุ ุชุตู ุงูุญุฒูุฉ ุฅูู ุงููุถูู ุงููุฌูุฉ ููุชู ุชุฎุฒูููุง ูุคูุชูุง ุนูู ุจุทุงูุฉ ุงูุดุจูุฉ ุ </li><li style=";text-align:right;direction:rtl">  ุชุฑุณู ุจุทุงูุฉ ุงูุดุจูุฉ ุฅุฎุทุงุฑูุง ุฅูู ูุธุงู ุงูุชุดุบูู ุ ูุนูุฏูุง ูุฌุฏ ูุธุงู ุงูุชุดุบูู ุงูููุช ุ ุชููู ุจูุณุฎ ุงูุญุฒูุฉ ุฅูู ุงููุฎุฒู ุงููุคูุช ุงูุฎุงุต ุจูุง ูุชุนููู ุฅุดุงุฑุฉ ุฌุงูุฒุฉ ุนูู ูุงุตู ุงูููู ุ </li><li style=";text-align:right;direction:rtl">  (ูุง ูุฒุงู ูุชุนูู ุนููู ุชุฐูุฑ ุฅุฑุณุงู ACK ุฑุฏูุง) ุ </li><li style=";text-align:right;direction:rtl">  ุจุนุฏ ูุฑูุฑ ุจุนุถ ุงูููุช ุ ูุฏุฑู ุชุทุจูู ุงูุฎุงุฏู ุฃู ุงููุงุตู ุฌุงูุฒ (ุจุงุณุชุฎุฏุงู epoll) ุ ูููุณุฎ ุงูุทูุจ ูู ููู ูุง ูู ุงููุฎุฒู ุงููุคูุช ููุชุทุจูู ุ </li><li style=";text-align:right;direction:rtl">  ูุฃุฎูุฑูุง ุ ูุนุงูุฌ ุชุทุจูู ุงูุฎุงุฏู ุงูุทูุจ. </li></ul><br><p style=";text-align:right;direction:rtl">  ููุง ุชุนูู ุ ูุชู ุฅุฑุณุงู ุงูุงุณุชุฌุงุจุฉ ุจููุณ ุงูุทุฑููุฉ ุชูุงููุง ููุท ูู ุงูุงุชุฌุงู ุงููุนุงูุณ.  ูุจุงูุชุงูู ุ ููุถู ูู ุทูุจ ููุชูุง ููุญูุธูุง ุนูู ูุธุงู ุงูุชุดุบูู ูุตูุงูุชู ุ ูููุถู ูู ุงุณุชุฌุงุจุฉ ููุณ ุงูููุช ูุฑุฉ ุฃุฎุฑู. </p><br><p style=";text-align:right;direction:rtl">  ุฃุตุจุญ ูุฐุง ููุญูุธูุง ุจุดูู ุฎุงุต ุจุนุฏ Meltdown / Specter ุ ูุธุฑูุง ูุฃู ุงูุชุตุญูุญุงุช ุงูุชู ุชู ุฅุตุฏุงุฑูุง ุฃุฏุช ุฅูู ุฒูุงุฏุฉ ูุจูุฑุฉ ูู ุชูููุฉ ููุงููุงุช ุงููุธุงู.  ูู ุฃูุงุฆู ูุงููู ุงูุซุงูู (ููุงูุฑ) 2018 ุ ุจุฏุฃุช ูุฌููุนุฉ Redis ูุฏููุง ูุฌุฃุฉ ูู ุงุณุชููุงู ูุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉ ูุฑุฉ ูุงุญุฏุฉ ููุตู ุฅูู ูุฑุชูู ุ ูุฃู  ุทุจูุช ุฃูุงุฒูู ุชุตุญูุญุงุช kernel ุงูููุงุณุจุฉ ูุชุบุทูุฉ ูุฐู ุงูุซุบุฑุงุช ุงูุฃูููุฉ.  (ุตุญูุญ ุ ุทุจูุช ุฃูุงุฒูู ุฅุตุฏุงุฑูุง ุฌุฏูุฏูุง ูู ุงูุชุตุญูุญ ุจุนุฏ ุฐูู ุจูููู ุ ูุงูุฎูุถ ุงุณุชููุงู ูุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉ ุฅูู ุงููุณุชููุงุช ุงูุณุงุจูุฉ ุชูุฑูุจูุง. ูููู ุงูููุตู ุจุฏุฃ ุจุงููุนู ูู ุงูุชููุฏ.) </p><br><p style=";text-align:right;direction:rtl"> ูุณูุก ุงูุญุธ ุ ุชุนูู ุฌููุน ููุตูุงุช Go ุงููุนุฑููุฉ ุฅูู Redis ู Memcached ุชูุงููุง ูุซู ูุฐุง: ุงูููุตู ููุดุฆ ุชุฌูุน ุงุชุตุงู ุ ูุนูุฏูุง ูุญุชุงุฌ ุฅูู ุฅุฑุณุงู ุทูุจ ุ ูุฅูู ูุณุชุฎุฑุฌ ุงุชุตุงููุง ูู ุงูุชุฌูุน ุ ูููุชุจ ุทูุจูุง ูุงุญุฏูุง ุซู ููุชุธุฑ ุงุณุชุฌุงุจุฉ.  (ูู ุงููุญุฒู ุจุดูู ุฎุงุต ุฃู ุงูุฑุงุจุท ูู Memcached ูุชุจู ุจุฑุงุฏ ููุชุฒุจุงุชุฑูู ููุณู.) ูุจุนุถ ุงูููุตูุงุช ูุฏููุง ูุซู ูุฐุง ุงูุชูููุฐ ุบูุฑ ุงููุงุฌุญ ููุฐุง ุงูุชุฌูุน ุจุญูุซ ุชุตุจุญ ุนูููุฉ ุฅุฒุงูุฉ ุงูุงุชุตุงู ูู ุงูุจูุชุงุช ุนุจุงุฑุฉ ุนู ุฑูุจูุชุงุช ูู ุญุฏ ุฐุงุชูุง. </p><br><p style=";text-align:right;direction:rtl">  ููุงู ุทุฑููุชุงู ูุชุฎููู ูุฐุง ุงูุนูู ุงูุดุงู ุงูุฎุงุต ุจุฅุนุงุฏุฉ ุชูุฌูู ุงูุทูุจ / ุงูุงุณุชุฌุงุจุฉ: </p><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุงุณุชุฎุฏู ุงููุตูู ุงููุจุงุดุฑ ุฅูู ุจุทุงูุฉ ุงูุดุจูุฉ: DPDK ุ netmap ุ PF_RING ุ ุฅูุฎ. </li><li style=";text-align:right;direction:rtl">  ูุง ุชุฑุณู ูู ุทูุจ / ุงุณุชุฌุงุจุฉ ูุญุฒูุฉ ูููุตูุฉ ุ ูููู ูู ุจุฏูุฌูุง ุ ุฅู ุฃููู ุ ูู ุญุฒู ุฃูุจุฑ ุ ุฃู ูุดุฑ ุงููููุงุช ุงูุนุงูุฉ ููุนูู ูุน ุงูุดุจูุฉ ูุนุฏุฉ ุทูุจุงุช.  ูุนุง ุฃูุซุฑ ูุชุนุฉ! </li></ol><br><p style=";text-align:right;direction:rtl">  ุงูุฎูุงุฑ ุงูุฃูู ุ ุจุงูุทุจุน ุ ูููู.  ูููู ุ ุฃููุงู ุ ูุฐุง ุฎุงุต ุจุงูุดุฌุงุนุฉ ุ ุญูุซ ูุชุนูู ุนููู ูุชุงุจุฉ ุชุทุจูู TCP / IP ุจููุณู (ุนูู ุณุจูู ุงููุซุงู ุ ููุง ูู ุงูุญุงู ูู ScyllaDB).  ูุซุงููุงู ุ ุจูุฐู ุงูุทุฑููุฉ ูุณูู ุงููููู ููุท ุนูู ุฌุงูุจ ูุงุญุฏ - ุนูู ุงูุฌุงูุจ ุงูุฐู ููุชุจู ูุฃููุณูุง.  ูุง ุฃุฑูุฏ ุฅุนุงุฏุฉ ูุชุงุจุฉ Redis (ุญุชู ุงูุขู) ุ ูุฐูู ุณุชุณุชููู ุงูุฎูุงุฏู ููุณ ุงููุจูุบ ุ ุญุชู ูู ูุงู ุงูุนููู ูุณุชุฎุฏู DPDK ุงูุฑุงุฆุน. </p><br><p style=";text-align:right;direction:rtl">  ุงูุฎูุงุฑ ุงูุซุงูู ุฃุจุณุท ุจูุซูุฑ ุ ูุงูุฃูู ูู ุฐูู ุ ูุณูู ุงููููู ุนูู ุงูุนููู ูุงูุฎุงุฏู ุนูู ุงูููุฑ.  ุนูู ุณุจูู ุงููุซุงู ุ ุชูุชุฎุฑ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ูุงุนุฏุฉ ุจูุงูุงุช ูุงุญุฏุฉ ูู ุงูุฐุงูุฑุฉ</a> ุฃููุง ูููู ุฃู ุชุฎุฏู ููุงููู RPS ุ ูู ุญูู ุฃู Redis ูุง ูููููุง ุฎุฏูุฉ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุจุถุน ูุฆุงุช ูู ุงูุขูุงู</a> .  ููุน ุฐูู ุ ูุฅู ูุฐุง ุงููุฌุงุญ ููุณ ูู ุชุทุจูู ุงููุงุนุฏุฉ ุงูููุฌูุฏุฉ ูู ุงูุฐุงูุฑุฉ ุจูุฏุฑ ูุง ูู ุงููุฑุงุฑ ุงูุฐู ุชู ูุจููู ูู ูุจู ุจุฃู ุงูุจุฑูุชูููู ุณูููู ุบูุฑ ูุชุฒุงูู ุชูุงููุง ุ ููุฌุจ ุนูู ุงูุนููุงุก ุงุณุชุฎุฏุงู ูุฐุง ุงูุชุฒุงูู ูููุง ูุงู ุฐูู ูููููุง.  ูุง ุงูุฐู ูููุฐู ุงูุนุฏูุฏ ูู ุงูุนููุงุก (ุฎุงุตุฉู ุชูู ุงููุณุชุฎุฏูุฉ ูู ุงููุนุงููุฑ) ุจูุฌุงุญ ุนู ุทุฑูู ุฅุฑุณุงู ุงูุทูุจุงุช ุนุจุฑ ุงุชุตุงู TCP ูุงุญุฏ ุ ูุฅุฐุง ุฃููู ุ ุฅุฑุณุงููู ุฅูู ุงูุดุจูุฉ ูุนูุง. </p><br><p style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุชูุถุญ ููุงูุฉ ูุนุฑููุฉ</a> ุฃู Redis ููููู ุฃูุถูุง ุชูุฏูู ููููู ุฑุฏ ูู ุงูุซุงููุฉ ูู ุญุงูุฉ ุงุณุชุฎุฏุงู ุฎุทูุท ุงูุฃูุงุจูุจ.  ุชุดูุฑ ุงูุฎุจุฑุฉ ุงูุดุฎุตูุฉ ูู ุชุทููุฑ ูุตุต ุงูุฐุงูุฑุฉ ุฃูุถูุง ุฅูู ุฃู ุชูุตูู ุงูุฃูุงุจูุจ ูููู ุจุดูู ูุจูุฑ ูู ุงุณุชููุงู ูุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉ SYS ููุณูุญ ูู ุจุงุณุชุฎุฏุงู ุงููุนุงูุฌ ูุงูุดุจูุฉ ุจุดูู ุฃูุซุฑ ููุงุกุฉ. </p><br><p style=";text-align:right;direction:rtl">  ูุงูุณุคุงู ุงููุญูุฏ ูู ููููุฉ ุงุณุชุฎุฏุงู ุฎุทูุท ุงูุฃูุงุจูุจ ุ ุฅุฐุง ูุงูุช ุทูุจุงุช ุงูุชุทุจูู ูู Redis ุชุฃุชู ุบุงูุจูุง ูู ููุช ูุงุญุฏุ  ูุฅุฐุง ูุงู ููุงู ุฎุงุฏู ูุงุญุฏ ููููุฏูุง ููุณุชุฎุฏู Redis Cluster ูุน ุนุฏุฏ ูุจูุฑ ูู ุงููุทุน ุ ูุฅูู ุญุชู ุนูุฏ ููุงุฌูุฉ ุญุฒูุฉ ูู ุงูุทูุจุงุช ุ ูุชู ุชูุณูููุง ุฅูู ุทูุจุงุช ูุฑุฏูุฉ ููู ูุดุฑุฉ. </p><br><p style=";text-align:right;direction:rtl">  ุงูุฌูุงุจ ุ ุจุงูุทุจุน ุ "ูุงุถุญ": ูู ุจุฌูุน ุงูุฃูุงุจูุจ ุงูุถููู ูู ุฎูุงู ุฌูุน ุงูุทูุจุงุช ูู ุฌููุน goroutines ุงูุชู ุชุนูู ุจุงูุชูุงุฒู ูุน ุฎุงุฏู Redis ูุงุญุฏ ูุฅุฑุณุงููุง ุนุจุฑ ุงุชุตุงู ูุงุญุฏ. </p><br><p style=";text-align:right;direction:rtl">  ุจุงูููุงุณุจุฉ ุ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ูุถุน</a> ุงูุฃูุงุจูุจ ุงูุถูููุฉ ููุณ ูุงุฏุฑูุง ุฌุฏูุง ูู ุงูููุตูุงุช ุจูุบุงุช ุฃุฎุฑู: nodejs <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">node_redis</a> ู C # <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">RedisBoost</a> ู python <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">aioredis</a> ูุบูุฑูุง ุงููุซูุฑ.  ุชุชู ูุชุงุจุฉ ุงูุนุฏูุฏ ูู ูุฐู ุงูููุตูุงุช ุฃุนูู ุญููุงุช ุงูุฃุญุฏุงุซ ุ ูุจุงูุชุงูู ูุจุฏู ุฃู ุชุฌููุน ุงูุทูุจุงุช ูู "ุชุฏููุงุช ุงูุญุณุงุจ" ุงููุชูุงุฒูุฉ ุฃูุฑ ุทุจูุนู.  ูู Go ุ ูุชู ุงูุชุฑููุฌ ูุงุณุชุฎุฏุงู ูุงุฌูุงุช ูุชุฒุงููุฉ ุ ูุนูู ูุง ูุจุฏู ุ ูุฃู ููุฉ ูู ุงููุงุณ ููุฑุฑูู ุชูุธูู "ุญููุฉ" ุฎุงุตุฉ ุจูู. </p><br><p style=";text-align:right;direction:rtl">  ุฃุฑุฏูุง ุงุณุชุฎุฏุงู Redis ุจุฃูุจุฑ ูุฏุฑ ูููู ูู ุงูููุงุกุฉ ุ ูุจุงูุชุงูู ูุฑุฑูุง ูุชุงุจุฉ ููุตู "ุฃูุถู" (tm) ุฌุฏูุฏ: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">RedisPipe</a> . </p><br><h2 id="kak-sdelat-neyavnyy-payplayning" style=";text-align:right;direction:rtl">  ููููุฉ ุฌุนู ุงูุฃูุงุจูุจ ุงูุถูููุฉุ </h2><br><p style=";text-align:right;direction:rtl">  ุงููุฎุทุท ุงูุฃุณุงุณู: </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ูุง ูููู Goroutines ุจููุทู ุงูุชุทุจูู ุจูุชุงุจุฉ ุงูุทูุจุงุช ูุจุงุดุฑุฉ ุฅูู ุงูุดุจูุฉ ุ ูููู ูุชู ุชูุฑูุฑูุง ุฅูู ุฌุงูุน goroutine ุ </li><li style=";text-align:right;direction:rtl">  ุฅุฐุง ุฃููู ุ ูุฌูุน ุงููุฌูุน ูุฌููุนุฉ ูู ุงูุทูุจุงุช ูููุชุจูุง ุนูู ุงูุดุจูุฉ ูููุฑุฑูุง ุฅูู ูุงุฑุฆ goroutine ุ </li><li style=";text-align:right;direction:rtl">  ูููู ูุงุฑุฆ Goroutine ุจูุฑุงุกุฉ ุงูุฑุฏูุฏ ุงููุงุฑุฏุฉ ูู ุงูุดุจูุฉ ูููุงุฑูุชูุง ุจุงูุทูุจุงุช ุงูููุงุจูุฉ ูุฅุฎุทุงุฑ goroutines ุจุงูููุทู ุญูู ุงูุฅุฌุงุจุฉ ุงูุชู ูุตูุช. </li></ul><br><p style=";text-align:right;direction:rtl"> ููุงู ุญุงุฌุฉ ุฅูู ุฅุฎุทุงุฑ ุญูู ุงูุงุณุชุฌุงุจุฉ.  ุณูููู ูุจุฑูุฌ Go ุงููุงูุฑุฉ ุจุงูุชุฃููุฏ: "ูู ุฎูุงู ุงูููุงุฉ!" <br>  ูููู ูุฐุง ููุณ ูู ุงูุชุฒุงูู ุงููููู ุงููุญูุฏ ุงูุจุฏุงุฆู ูููุณ ุงูุฃูุซุฑ ููุงุกุฉ ุญุชู ูู ุจูุฆุฉ ุงูุชุดุบูู.  ููุธุฑูุง ูุฃู ุงูุฃุดุฎุงุต ุงููุฎุชูููู ูุฏููู ุงุญุชูุงุฌุงุช ูุฎุชููุฉ ุ ูุณูู ูุฌุนู ุงูุขููุฉ ูุงุจูุฉ ููุชูุณุนุฉ ุ ููุง ูุณูุญ ูููุณุชุฎุฏู ุจุชูููุฐ ุงููุงุฌูุฉ (ุฏุนูุง ูุณูููุง <code>Future</code> ): </p><br><pre style=";text-align:right;direction:rtl"> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Future <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> { Resolve(val <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span>{}) }</code> </pre> <br><p style=";text-align:right;direction:rtl">  ูุจุนุฏ ุฐูู ุณูุจุฏู ุงููุฎุทุท ุงูุฃุณุงุณู ููุง ููู: </p><br><pre style=";text-align:right;direction:rtl"> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> future <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { req Request fut Future } <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Conn <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { c net.Conn futmtx sync.Mutex wfutures []future futtimer *time.Timer rfutures <span class="hljs-keyword"><span class="hljs-keyword">chan</span></span> []future } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(c *Conn)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Send</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(r Request, f Future)</span></span></span></span> { c.futmtx.Lock() <span class="hljs-keyword"><span class="hljs-keyword">defer</span></span> c.futmtx.Unlock() c.wfutures = <span class="hljs-built_in"><span class="hljs-built_in">append</span></span>(c.wfutures, future{req: r, fut: f}) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-built_in"><span class="hljs-built_in">len</span></span>(c.wfutures) == <span class="hljs-number"><span class="hljs-number">1</span></span> { futtimer.Reset(<span class="hljs-number"><span class="hljs-number">100</span></span>*time.Microsecond) } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(c *Conn)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">writer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">range</span></span> c.futtimer.C { c.futmtx.Lock() futures, c.wfutures = c.wfutures, <span class="hljs-literal"><span class="hljs-literal">nil</span></span> c.futmtx.Unlock() <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> b []<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> _, ft := <span class="hljs-keyword"><span class="hljs-keyword">range</span></span> futures { b = AppendRequest(b, ft.req) } _, _err := ccWrite(b) c.rfutures &lt;- futures } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(c *Conn)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reader</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { rd := bufio.NewReader(cc) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> futures []future <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> { response, _err := ParseResponse(rd) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-built_in"><span class="hljs-built_in">len</span></span>(futures) == <span class="hljs-number"><span class="hljs-number">0</span></span> { futures = &lt;- c.rfutures } futures[<span class="hljs-number"><span class="hljs-number">0</span></span>].fut.Resolve(response) futures = futures[<span class="hljs-number"><span class="hljs-number">1</span></span>:] } }</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุจุงูุทุจุน ุ ูุฐุง ุฑูุฒ ูุจุณุท ููุบุงูุฉ.  ุชู ุงูุญุฐู: </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุฅูุดุงุก ุงุชุตุงู ุ </li><li style=";text-align:right;direction:rtl">  ุฃูุง / ุณ ูููุงุช </li><li style=";text-align:right;direction:rtl">  ูุฑุงุกุฉ / ูุชุงุจุฉ ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก ุ </li><li style=";text-align:right;direction:rtl">  ุฅุนุงุฏุฉ ุชุฃุณูุณ ุงูุงุชุตุงู ุ </li><li style=";text-align:right;direction:rtl">  ุงููุฏุฑุฉ ุนูู ุฅูุบุงุก ุงูุทูุจ ูุจู ุฅุฑุณุงูู ุฅูู ุงูุดุจูุฉ ุ </li><li style=";text-align:right;direction:rtl">  ุชุญุณูู ุชุฎุตูุต ุงูุฐุงูุฑุฉ (ุฅุนุงุฏุฉ ุงุณุชุฎุฏุงู ุตููู ุงููุฎุฒู ุงููุคูุช ูุงูุนููุฏ ุงููุณุชูุจููุฉ). </li></ul><br><p style=";text-align:right;direction:rtl">  ุฃู ุฎุทุฃ ุฅุฏุฎุงู / ุฅุฎุฑุงุฌ (ุจูุง ูู ุฐูู ูููุฉ) ูู ุงูููุฏ ุงูุญูููู ูุคุฏู ุฅูู ุญู ุฌููุน ุงูุฃุฎุทุงุก ุงููุณุชูุจููุฉ ุงููุทุงุจูุฉ ููุทูุจุงุช ุงููุฑุณูุฉ ูุงูุงูุชุธุงุฑ ูุฅุฑุณุงููุง. <br>  ุทุจูุฉ ุงูุงุชุตุงู ุบูุฑ ูุชูุฑุทุฉ ูู ุฅุนุงุฏุฉ ูุญุงููุฉ ุงูุทูุจ ุ ูุฅุฐุง ูุงู ุฐูู ุถุฑูุฑููุง (ููููู) ูุฅุนุงุฏุฉ ูุญุงููุฉ ุงูุทูุจ ุ ููููู ุงูููุงู ุจุฐูู ุจูุณุชูู ุฃุนูู ูู ุงูุชุฌุฑูุฏ (ุนูู ุณุจูู ุงููุซุงู ุ ูู ุชูููุฐ ุฏุนู Redis Cluster ุงูููุถุญ ุฃุฏูุงู). </p><br><p style=";text-align:right;direction:rtl">  ููุงุญุธุฉ.  ูู ุงูุจุฏุงูุฉ ุ ุจุฏุช ุงูุฏุงุฆุฑุฉ ุฃูุซุฑ ุชุนููุฏูุง ููููุงู.  ูููู ูู ุนูููุฉ ุงูุชุฌุงุฑุจ ุงููุจุณุทุฉ ููุฐุง ุงูุฎูุงุฑ. </p><br><p style=";text-align:right;direction:rtl">  ููุงุญุธุฉ 2. ูุชู ูุฑุถ ูุชุทูุจุงุช ุตุงุฑูุฉ ููุบุงูุฉ ุนูู ุทุฑููุฉ Future.Resolve: ูุฌุจ ุฃู ุชููู ูู ุฃุณุฑุน ููุช ูููู ุ ูู ุงููุงุญูุฉ ุงูุนูููุฉ ุบูุฑ ูุญุธูุฑุฉ ููู ุฃู ุญุงู ูู ุงูุฃุญูุงู ุงูุฐุนุฑ.  ูุฐุง ูุฑุฌุน ุฅูู ุญูููุฉ ุฃูู ูุชู ุงุณุชุฏุนุงุก ูุชุฒุงูู ูู ุฏูุฑุฉ ุงููุงุฑุฆ ุ ูุฃู "ุงููุฑุงูู" ุณูุคุฏู ุญุชูุง ุฅูู ุงูุชุฏููุฑ.  ุชูููุฐ Future.Resolve ูุฌุจ ุงูููุงู ุงูุญุฏ ุงูุฃุฏูู ุงูุถุฑูุฑู ูู ุงูุฅุฌุฑุงุกุงุช ุงูุฎุทูุฉ: ูุฅููุงุธ ุชููุน ุ  ุฑุจูุง ูุนุงูุฌุฉ ุงูุฎุทุฃ ูุฅุฑุณุงู ุฅุนุงุฏุฉ ูุญุงููุฉ ุบูุฑ ูุชุฒุงูู (ุงููุณุชุฎุฏูุฉ ูู ุชุทุจูู ุฏุนู ูุธุงู ุงููุฌููุนุฉ). </p><br><h2 id="effekt" style=";text-align:right;direction:rtl">  ุชุฃุซูุฑ </h2><br><p style=";text-align:right;direction:rtl">  ูุนูุงุฑ ุฌูุฏ ูู ูุตู ุงูููุงู! </p><br><p style=";text-align:right;direction:rtl">  ูุนูุงุฑ ุฌูุฏ ูู ุฃูุฑุจ ูุง ูููู ูููุงูุญุฉ ุงูุงุณุชุฎุฏุงู ูู ุญูุซ ุงูุขุซุงุฑ ุงูููุงุญุธุฉ.  ููุฐุง ููุณ ุจุงูุฃูุฑ ุงูุณูู. </p><br><p style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุฎูุงุฑ ุงูููุงุณ</a> ุ ุงูุฐู ูุจุฏู ูู ุ ูุดุจู ุฅูู ุญุฏ ูุจูุฑ ุงูุฎูุงุฑ ุงูุญูููู: </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  "ุงูุจุฑูุงูุฌ ุงููุตู" ุงูุฑุฆูุณู ูุญุงูู 5 ุนููุงุก ูุชูุงุฒููู ุ </li><li style=";text-align:right;direction:rtl">  ูู ูู "ุนููู" ุ ููุงุจู 300-1000 rps "ูุทููุจ" ุ ูุชู ุชุดุบูู goroutine (ูุชู ุชุดุบูู 3 gorutins ููุงุจู 1000 rps ุ ูุชู ุชุดุบูู 124 gorutins ููุงุจู 128000 rps) ุ </li><li style=";text-align:right;direction:rtl">  ูุณุชุฎุฏู gorutin ูุณุฎุฉ ูููุตูุฉ ูู ูุญุฏุฏุงุช ุงูุฃุณุนุงุฑ ููุฑุณู ุงูุทูุจุงุช ูู ุณูุณูุฉ ุนุดูุงุฆูุฉ - ูู 5 ุฅูู 15 ุทูุจูุง. </li></ul><br><p style=";text-align:right;direction:rtl">  ุชุชูุญ ููุง ุนุดูุงุฆูุฉ ุณูุณูุฉ ุงูุงุณุชุนูุงูุงุช ุชุญููู ุชูุฒูุน ุนุดูุงุฆู ููุณูุณูุฉ ูู ุงูุฌุฏูู ุงูุฒููู ุ ููู ูุง ูุนูุณ ุจุดูู ุตุญูุญ ุงูุญูู ุงูุญูููู. </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ุงููุต ุงููุฎูู</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl">  ุงูุฎูุงุฑุงุช ุงูุฎุงุทุฆุฉ ูุงูุช: <br>  ุฃ) ุงุณุชุฎุฏู ูุญุฏุฏ ูุนุฏู ูุงุญุฏ ูุฌููุน gorutins ูู "ุงูุนููู" ูุงูุชูู ุฅููู ููู ุทูุจ - ููุฐุง ูุคุฏู ุฅูู ุงุณุชููุงู ููุฑุท ููุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉ ุจูุงุณุทุฉ ูุญุฏุฏ ุงูุณุนุฑ ููุณู ุ ุจุงูุฅุถุงูุฉ ุฅูู ุฒูุงุฏุฉ ููุช ุฏูุฑุงู goroutin ุ ููุง ูููู ูู ุฃุฏุงุก RedisPipe ุจูุนุฏู rps ูุชูุณุท โโ(ูููู ุจุดูู ุบูุฑ ููููู) ูุญุณู ูู ุงุฑุชูุงุน) ุ <br>  ุจ) ุงุณุชุฎุฏุงู ูุญุฏุฏ ูุนุฏู ูุงุญุฏ ูุฌููุน gorutins ูู "ุงูุนููู" ูุฅุฑุณุงู ุงูุทูุจุงุช ูู ุณูุณูุฉ - ูุญุฏุฏ ูุนุฏู ูู ุจุงููุนู ูุง ูุฃูู ูุซูุฑุง ูุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉ ุ ูููู ุงูุชูุงูุจ goroutines ูู ุงูููุช ุงูููุงุณุจ ูุฒูุฏ ููุท ุ <br>  ุฌ) ุงุณุชุฎุฏู ูุญุฏุฏ ูุนุฏู ููู goroutine ุ ููู ุฃุฑุณู ููุณ ุงูุณูุณูุฉ ูู 10 ุทูุจุงุช - ูู ูุฐุง ุงูุณููุงุฑูู ุ ุชุณุชููุธ goroutines ูู ููุช ูุงุญุฏ ุฌุฏูุง ุ ููุง ูุญุณู ูุชุงุฆุฌ RedisPipe ุจุดูู ุบูุฑ ุนุงุฏู. </p></div></div><br><p style=";text-align:right;direction:rtl">  ุชู ุฅุฌุฑุงุก ุงูุงุฎุชุจุงุฑ ุนูู ูุซูู AWS c5-2xlarge ุฑุจุงุนู ุงูููุงุฉ.  ุฅุตุฏุงุฑ Redis ูู 5.0. </p><br><p style=";text-align:right;direction:rtl">  ูุณุจุฉ ูุซุงูุฉ ุงูุงุณุชุนูุงู ุงููุทููุจุฉ ุ ูุงููุซุงูุฉ ุงููุงุชุฌุฉ ุงููุงุชุฌุฉ ูุงููุณุชูููุฉ ุจูุงุณุทุฉ ูุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉ ุงููุฌู: </p><br><table style=";text-align:right;direction:rtl"><thead><tr><th>  rps ุงูููุตูุฏ </th><th>  ุฑูุฏูุฌู <br>  rps /ูช cpu </th><th>  redispipe ูุง ุชูุชุธุฑ <br>  rps /ูช cpu </th><th>  redispipe 50ยตs <br>  rps /ูช cpu </th><th>  redispipe 150ยตs <br>  rps /ูช cpu </th></tr></thead><tbody><tr><td>  1000 * 5 </td><td>  5015/7ูช </td><td>  5015/6ูช </td><td>  5015/6ูช </td><td>  5015/6ูช </td></tr><tr><td>  2000 * 5 </td><td>  10022/11 ูช </td><td>  10022/10 ูช </td><td>  10022/10 ูช </td><td>  10022/10 ูช </td></tr><tr><td>  4000 * 5 </td><td>  20036/21 ูช </td><td>  20036/18 ูช </td><td>  20035/17 ูช </td><td>  20035/15 ูช </td></tr><tr><td>  8000 * 5 </td><td>  40020/45 ูช </td><td>  40062/37 ูช </td><td>  40060/26 ูช </td><td>  40056/19 ูช </td></tr><tr><td>  16000 * 5 </td><td>  79994/71 ูช </td><td>  80102/58 ูช </td><td>  80096/33 ูช </td><td>  80090/23 ูช </td></tr><tr><td>  32000 * 5 </td><td>  159590/96 ูช </td><td>  160 180/80 ูช </td><td>  160167/39 ูช </td><td>  160 150/29 ูช </td></tr><tr><td>  64000 * 5 </td><td>  187774/99 ูช </td><td>  320 313/98 ูช </td><td>  320283/47 ูช </td><td>  320258/37 ูช </td></tr><tr><td>  92000 * 5 </td><td>  183206/99 ูช </td><td>  480ุ443 / 97ูช </td><td>  480407/52 ูช </td><td>  480 366/42 ูช </td></tr><tr><td>  128000 * 5 </td><td>  179744/99 ูช </td><td>  640484/97 ูช </td><td>  640488/55 ูช </td><td>  640428/46 ูช </td></tr></tbody></table><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/g-/d7/7k/g-d77kznsmwmgejiyplpipwv7t4.png" alt="ุณุนุฑ ุงูุทูุจ"><img src="https://habrastorage.org/webt/cs/xf/lz/csxflztfjbnmzc0kuhpnqddeokq.png" alt="Redis ูุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉ"></p><br><p style=";text-align:right;direction:rtl">  ููููู ููุงุญุธุฉ ุฃูู ูุน ูุฌูุฏ ููุตู ูุนูู ููููุง ูููุฎุทุท ุงูููุงุณููู (ุทูุจ / ุงุณุชุฌุงุจุฉ + ุชุฌูุน ุงุชุตุงู) ุ ูุฅู Redis ุณุฑูุนูุง ูุณุชููู ูุจ ุงููุนุงูุฌ ุ ูุจุนุฏ ุฐูู ูุตุจุญ ูู ุงููุณุชุญูู ุงูุญุตูู ุนูู ุฃูุซุฑ ูู 190 ูููู ุจุช ูู ุงูุซุงููุฉ. </p><br><p style=";text-align:right;direction:rtl">  ูุณูุญ ูู RedisPipe ุจุงูุถุบุท ุนูู ูู ุงูุทุงูุฉ ุงููุทููุจุฉ ูู Redis.  ููููุง ุชููููุง ูุคูุชูุง ูุฌูุน ุงูุทูุจุงุช ุงููุชูุงุฒูุฉ ุ ูู ุงุณุชููุงู Redis ููุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉ.  ูุชู ุงูุญุตูู ุนูู ูุงุฆุฏุฉ ููููุณุฉ ุจุงููุนู ูู 4krps ูู ุงูุนููู (20krps ูู ุงููุฌููุน) ุฅุฐุง ุชู ุงุณุชุฎุฏุงู ูููุฉ ูู 150 ูููุฑูุซุงููุฉ. </p><br><p style=";text-align:right;direction:rtl">  ุญุชู ุฅุฐุง ูู ูุชู ุงุณุชุฎุฏุงู ุงูุฅููุงู ุงููุคูุช ุจุดูู ุตุฑูุญ ุนูุฏูุง ููุน Redis ุนูู ูุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉ ุ ูุฅู ุงูุชุฃุฎูุฑ ูุธูุฑ ุจููุฑุฏู.  ุจุงูุฅุถุงูุฉ ุฅูู ุฐูู ุ ุชุจุฏุฃ ุงูุทูุจุงุช ูู ุงูุชุฎุฒูู ุงููุคูุช ุจูุงุณุทุฉ ูุธุงู ุงูุชุดุบูู.  ูุฐุง ูุณูุญ ูู RedisPipe ุจุฒูุงุฏุฉ ุนุฏุฏ ุงูุทูุจุงุช ุงูุชู ุชู ุชูููุฐูุง ุจูุฌุงุญ ุนูุฏูุง ูููู ุงูููุตู ุงูููุงุณููู ุจุฎูุถ ุฃูุฏุงูู ุจุงููุนู. </p><br><p style=";text-align:right;direction:rtl">  ูุฐู ูู ุงููุชูุฌุฉ ุงูุฑุฆูุณูุฉ ุ ูุงูุชู ูุงูุช ูุทููุจุฉ ูุฅูุดุงุก ุฑุงุจุท ุฌุฏูุฏ. </p><br><p style=";text-align:right;direction:rtl">  ูุงุฐุง ุ ุฅุฐู ุ ูุญุฏุซ ูุน ุงุณุชููุงู ูุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉ ุนูู ุงูุนููู ููุน ุงูุทูุจุงุช ุงููุชุฃุฎุฑุฉุ </p><br><table style=";text-align:right;direction:rtl"><thead><tr><th>  rps ุงูููุตูุฏ </th><th>  ุฑูุฏูุฌู <br>  ูช cpu / ms </th><th>  redispipe nowait <br>  ูช cpu / ms </th><th>  redispipe 50ms <br>  ูช cpu / ms </th><th>  redispipe 150ms <br>  ูช cpu / ms </th></tr></thead><tbody><tr><td>  1000 * 5 </td><td>  13 / 0.03 </td><td>  20 / 0.04 </td><td>  46 / 0.16 </td><td>  44 / 0.26 </td></tr><tr><td>  2000 * 5 </td><td>  25 / 0.03 </td><td>  33 / 0.04 </td><td>  77 / 0.16 </td><td>  71 / 0.26 </td></tr><tr><td>  4000 * 5 </td><td>  48 / 0.03 </td><td>  60 / 0.04 </td><td>  124 / 0.16 </td><td>  107 / 0.26 </td></tr><tr><td>  8000 * 5 </td><td>  94 / 0.03 </td><td>  119 / 0.04 </td><td>  178 / 0.15 </td><td>  141 / 0.26 </td></tr><tr><td>  16000 * 5 </td><td>  184 / 0.04 </td><td>  206 / 0.04 </td><td>  228 / 0.15 </td><td>  177 / 0.25 </td></tr><tr><td>  32000 * 5 </td><td>  341 / 0.08 </td><td>  322 / 0.05 </td><td>  280 / 0.15 </td><td>  226 / 0.26 </td></tr><tr><td>  64000 * 5 </td><td>  316 / 1.88 </td><td>  469 / 0.08 </td><td>  345 / 0.16 </td><td>  307 / 0.26 </td></tr><tr><td>  92000 * 5 </td><td>  313 / 2.88 </td><td>  511 / 0.16 </td><td>  398 / 0.17 </td><td>  366 / 0.27 </td></tr><tr><td>  128000 * 5 </td><td>  312 / 3.54 </td><td>  509 / 0.37 </td><td>  441 / 0.19 </td><td>  418 / 0.29 </td></tr></tbody></table><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/fp/ws/ra/fpwsra-pgtexl6ua7crpc4vt5fa.png" alt="ูุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉ ุงูุนููู"><img src="https://habrastorage.org/webt/kw/kl/lk/kwkllkjyf-vfpv77miu4jnnlrqm.png" alt="ุงููููู"></p><br><p style=";text-align:right;direction:rtl">  ูุฏ ุชูุงุญุธ ุฃูู ูู rps ุงูุตุบูุฑุฉ ูุณุชููู RedisPipe ููุณู ูุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉ ุฃูุซุฑ ูู "ุงูููุงูุณ" ุ ุฎุงุตุฉ ุฅุฐุง ุชู ุงุณุชุฎุฏุงู ูููุฉ ุตุบูุฑุฉ.  ููุฑุฌุน ุฐูู ุฃุณุงุณูุง ุฅูู ุชุทุจูู ุฃุฌูุฒุฉ ุถุจุท ุงูููุช ูู Go ูุชูููุฐ ููุงููุงุช ุงููุธุงู ุงููุณุชุฎุฏูุฉ ูู ูุธุงู ุงูุชุดุบูู (ุนูู ูุธุงู Linux ุ ููู futexsleep) ุ ุญูุซ ุฃู ุงูุงุฎุชูุงู ูู ูุถุน "no pause" ุฃูู ุจูุซูุฑ. </p><br><p style=";text-align:right;direction:rtl">  ูุน ููู rps ุ ูุชู ุชุนููุถ ููุฏุงุฑ ุงูุญูู ูุฃุฌูุฒุฉ ุถุจุท ุงูููุช ุนู ุทุฑูู ุงูุฎูุงุถ ุงูุญูู ููุงุชุตุงู ุจุงูุดุจูุฉ ุ ูุจุนุฏ 16 ููููุจุช ูู ุงูุซุงููุฉ ููู ุนููู ุ ุจุงุณุชุฎุฏุงู RedisPipe ูุน ุฅููุงู ูุคูุช ูุฏุฑู 150 ูููุฑูุซุงููุฉ ูุจุฏุฃ ูู ุชุญููู ููุงุฆุฏ ููููุณุฉ. </p><br><p style=";text-align:right;direction:rtl">  ุจุงูุทุจุน ุ ุจุนุฏ ุฃู ุงุณุชูุฑ Redis ุนูู ูุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉ (CPU) ุ ูุจุฏุฃ ุฒูู ุงููุตูู ุงููุชุฃุฎุฑ ููุทูุจุงุช ุจุงุณุชุฎุฏุงู ุงูููุตู ุงูููุงุณููู.  ููุน ุฐูู ุ ูุณุช ูุชุฃูุฏูุง ูู ุฃูู ูู ุงูุนุงุฏุฉ ุชุญูู 180 ููููุจุช ูู ุงูุซุงููุฉ ูู ูุซูู Redis.  ูููู ุฅุฐุง ูุงู ุงูุฃูุฑ ูุฐูู ุ ุถุน ูู ุงุนุชุจุงุฑู ุฃูู ูุฏ ุชูุงุฌู ูุดููุงุช. </p><br><p style=";text-align:right;direction:rtl">  ุทุงููุง ุฃู Redis ูุง ูุนูู ูู ูุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉ ุ ูุฅู ุฒูู ุงูุงุณุชุฌุงุจุฉ ุ ุจุงูุทุจุน ุ ูุนุงูู ูู ุงุณุชุฎุฏุงู ุชููู ูุคูุช.  ูุถุนุช ูุฐู ุงูุชุณููุฉ ุนูุฏุง ูู ุงูููุตู.  ููุน ุฐูู ุ ูุฅู ูุฐู ุงูููุงูุถุฉ ุชููู ููุญูุธุฉ ููุท ุฅุฐุง ูุงู Redis ูุงูุนููู ุนูู ููุณ ุงููุถูู ุงููุนูู.  ููููุง ูุทูุจูููุฌูุง ุงูุดุจูุฉ ุ ูููู ุฃู ุชููู ุฑุญูุฉ ุฐูุงุจูุง ูุฅูุงุจูุง ุฅูู ูุถูู ูุฌุงูุฑ ูู ูุงุฆุฉ ุซุงููุฉ ุฅูู ูููู ุซุงููุฉ ูุงุญุฏุฉ.  ููููุง ูุฐูู ุ ูุตุจุญ ุงููุฑู ูู ุงูุชุฃุฎูุฑ ุจุงููุนู ุจุฏูุงู ูู ุชุณุน ูุฑุงุช (0.26 / 0.03) ุซูุงุซ ูุฑุงุช (0.36 / 0.13) ุฃู ูุชู ููุงุณู ููุท ุจุนุดุฑุงุช ูู ุงููุฆุฉ (1.26 / 1.03). </p><br><p style=";text-align:right;direction:rtl">  ูู ุนุจุก ุงูุนูู ุงูุฎุงุต ุจูุง ุ ุนูุฏูุง ูุชู ุงุณุชุฎุฏุงู Redis ูุฐุงูุฑุฉ ุชุฎุฒูู ูุคูุช ุ ูููู ุงูุชููุน ุงูููู ููุฑุฏูุฏ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุน ุชูุฑูุบ ุฐุงูุฑุฉ ุงูุชุฎุฒูู ุงููุคูุช ุฃูุจุฑ ูู ุงูุชููุน ุงูุฅุฌูุงูู ูุงุณุชุฌุงุจุงุช Redis ุ ูุฃูู ููุนุชูุฏ ุฃู ุงูุฒูุงุฏุฉ ูู ุงูุชุฃุฎูุฑ ููุณุช ูุจูุฑุฉ. </p><br><p style=";text-align:right;direction:rtl">  ูุงููุชูุฌุฉ ุงูุฅูุฌุงุจูุฉ ุงูุฑุฆูุณูุฉ ูู ุงูุชุณุงูุญ ูุน ุชุญููู ุงูููู: ุฅุฐุง ุฒุงุฏ ุงูุญูู ุนูู ุงูุฎุฏูุฉ ูุฌุฃุฉ ูุฑุงุช N ุ ูู ุชุณุชููู Redis ูุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉ ูู ููุณ ูุฑุงุช N ุฃูุซุฑ.  ูุชุญูู ุฃุฑุจุนุฉ ุฃุถุนุงู ุงูุญูู ูู 160 ูููู ุจุช ูู ุงูุซุงููุฉ ุฅูู 640 ูููู ุจุช ูู ุงูุซุงููุฉ ุ ุฃููู Redis ููุท 1.6 ุถุนู ูุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉ ุ ูุฒูุงุฏุฉ ุงูุงุณุชููุงู ูู 29 ุฅูู 46 ูช.  ูุฐุง ูุณูุญ ููุง ุฃูุง ูุฎุงู ุฃู ููุญูู ุฑูุฏูุณ ูุฌุฃุฉ.  ูู ูุชู ุชุญุฏูุฏ ูุงุจููุฉ ุงูุชูุณุน ููุชุทุจูู ูู ุฎูุงู ุชุดุบูู ุงูููุตู ูุชูููุฉ ุงุชุตุงู ุงูุดุจูุฉ (ุงูุฑุฃ: ุชูุงููู ูุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉ SYS). </p><br><p style=";text-align:right;direction:rtl">  ููุงุญุธุฉ.  ุฑูุฒ ุงููุคุดุฑ ูุนูู ุจููู ุตุบูุฑุฉ.  ููุณุญ ุถููุฑู ุ ูุฑุฑุช ุงูุงุฎุชุจุงุฑ ุจููู ุจุญุฌู 768 ุจุงูุช.  ุฒุงุฏ ุงุณุชููุงู ูุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉ ุจูุงุณุทุฉ ุงููุฌู ุฒูุงุฏุฉ ููุญูุธุฉ (ุชุตู ุฅูู 66ูช ูู ุชููู ูุคูุช ูุฏุฑู 150 150s) ุ ูููุฎูุถ โโุณูู ุงูููุตู ุงูููุงุณููู ุฅูู 170 ูููู ุจุช ูู ุงูุซุงููุฉ.  ููู ูู ุงููุณุจ ุงููุฑุตูุฏุฉ ุธูุช ููุง ูู ุ ูุจุงูุชุงูู ุงูุงุณุชูุชุงุฌุงุช. </p><br><h2 id="klaster" style=";text-align:right;direction:rtl">  ุงููุชูุฉ </h2><br><p style=";text-align:right;direction:rtl">  ููุชุญุฌูู ูุณุชุฎุฏู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">Redis Cluster</a> .  ูุฐุง ูุชูุญ ููุง ุงุณุชุฎุฏุงู Redis ููุณ ููุท ูุฐุงูุฑุฉ ุชุฎุฒูู ูุคูุช ุ ูููู ุฃูุถูุง ูุฎุฒู ูุชููุจ ููู ููุณ ุงูููุช ูุง ูููุฏ ุงูุจูุงูุงุช ุนูุฏ ุชูุณูุน / โโุถุบุท ูุฌููุนุฉ. </p><br><p style=";text-align:right;direction:rtl">  ูุณุชุฎุฏู Redis Cluster ูุจุฏุฃ ุงูุนููู ุงูุฐูู ุ ุฃู  ูุฌุจ ุนูู ุงูุนููู ูุฑุงูุจุฉ ุญุงูุฉ ุงููุชูุฉ ููุณูุง ุ ูุงูุงุณุชุฌุงุจุฉ ููุฃุฎุทุงุก ุงูุฅุถุงููุฉ ุงูุชู ูุชู ุฅุฑุฌุงุนูุง ุจูุงุณุทุฉ "ุงููุฌู" ุนูุฏูุง ุชูุชูู "ุงูุจุงูุฉ" ูู ูุซูู ุฅูู ุขุฎุฑ. </p><br><p style=";text-align:right;direction:rtl">  ููููุง ูุฐูู ุ ูุฌุจ ุนูู ุงูุนููู ุงูุงุญุชูุงุธ ุจุงุชุตุงูุงุช ุจุฌููุน ูุซููุงุช Redis ูู ุงููุชูุฉ ูุฅุตุฏุงุฑ ุงุชุตุงู ุจุงููุทูุจ ุงููุทููุจ ููู ุทูุจ.  ููุงู ูู ูุฐุง ุงูููุงู ุฃู ุงูุนููู ุงููุณุชุฎุฏู ูู ูุจู (ูู ูุดูุฑ ุงูุฅุตุจุน) ูุฏ ุชู ุดุฏู ูุซูุฑุงู.  ูุงู ุงููุคูู ุ ุงูุฐู ุจุงูุบ ูู ุชูุฏูุฑ ุชุณููู Go (CSP ุ ุงููููุงุช ุ goroutines) ุ ุจุชูููุฐ ุชุฒุงูู ุงูุนูู ูุน ุญุงูุฉ ุงููุชูุฉ ูู ุฎูุงู ุฅุฑุณุงู ุนูููุงุช ุงูุงุณุชุฑุฌุงุนุงุช ุฅูู goroutine ุงููุฑูุฒูุฉ.  ููุฏ ุฃุตุจุญ ูุฐุง botnek ุฎุทูุฑุฉ ุจุงููุณุจุฉ ููุง.  ูุชุตุญูุญ ูุคูุช ุ ุงุถุทุฑุฑูุง ุฅูู ุชุดุบูู ุฃุฑุจุนุฉ ุนููุงุก ุฅูู ูุฌููุนุฉ ูุงุญุฏุฉ ุ ูู ูููู ุจุฏูุฑู ุ ุฌูุน ูุง ูุตู ุฅูู ูุฆุงุช ุงูุงุชุตุงูุงุช ูู ุงูุชุฌูุน ููู ูุซูู ูู Redis. </p><br><p style=";text-align:right;direction:rtl">  ูููุง ูุฐูู ุ ุชู ุชูููู ุงูููุตู ุงูุฌุฏูุฏ ูููุน ูุฐุง ุงูุฎุทุฃ.  ูุชู ุฅุฌุฑุงุก ูู ุงูุชูุงุนู ูุน ุญุงูุฉ ุงููุชูุฉ ุนูู ูุณุงุฑ ุชูููุฐ ุงูุงุณุชุนูุงู ุจุฃูุงู ูุฏุฑ ุงูุฅููุงู: </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุงูุญุงูุฉ ุงูุนูููุฏูุฉ ุบูุฑ ูุงุจูุฉ ููุชุทุจูู ุนูููุงู ุ ูููุณ ุงูุทูุฑุงุช ุงูุนุฏูุฏุฉ ุงูุชู ุชููู ุงูุฐุฑุงุช </li><li style=";text-align:right;direction:rtl">  ูุญุฏุซ ุงููุตูู ุฅูู ุงูุญุงูุฉ ุจุงุณุชุฎุฏุงู atomic.StorePointer / atomic.LoadPointer ุ ูุจุงูุชุงูู ูููู ุงูุญุตูู ุนููู ุฏูู ุญุธุฑ. </li></ul><br><p style=";text-align:right;direction:rtl">  ูุจุงูุชุงูู ุ ุญุชู ุฃุซูุงุก ุชุญุฏูุซ ุญุงูุฉ ุงููุชูุฉ ุ ูููู ุฃู ุชุณุชุฎุฏู ุงูุทูุจุงุช ุงูุญุงูุฉ ุงูุณุงุจูุฉ ุฏูู ุฎูู ูู ุงูุงูุชุธุงุฑ ุนูู ุงูููู. </p><br><pre style=";text-align:right;direction:rtl"> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// storeConfig atomically stores config func (c *Cluster) storeConfig(cfg *clusterConfig) { p := (*unsafe.Pointer)(unsafe.Pointer(&amp;c.config)) atomic.StorePointer(p, unsafe.Pointer(cfg)) } // getConfig loads config atomically func (c *Cluster) getConfig() *clusterConfig { p := (*unsafe.Pointer)(unsafe.Pointer(&amp;c.config)) return (*clusterConfig)(atomic.LoadPointer(p)) } func (cfg *clusterConfig) slot2shardno(slot uint16) uint16 { return uint16(atomic.LoadUint32(&amp;cfg.slots[slot])) } func (cfg *clusterConfig) slotSetShard(slot, shard uint16) { atomic.StoreUint32(&amp;cfg.slots[slot], shard) }</span></span></code> </pre> <br><p style=";text-align:right;direction:rtl">  ูุชู ุชุญุฏูุซ ุญุงูุฉ ุงููุชูุฉ ูู 5 ุซูุงู.  ูููู ุฅุฐุง ูุงู ููุงู ุดู ูู ุนุฏู ุงุณุชูุฑุงุฑ ูุธุงู ุงููุฌููุนุฉ ุ ูุณูุชู ูุฑุถ ุงูุชุญุฏูุซ: </p><br><pre style=";text-align:right;direction:rtl"> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(c *Cluster)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">control</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { t := time.NewTicker(c.opts.CheckInterval) <span class="hljs-keyword"><span class="hljs-keyword">defer</span></span> t.Stop() <span class="hljs-comment"><span class="hljs-comment">// main control loop for { select { case &lt;-c.ctx.Done(): // cluster closed, exit control loop c.report(LogContextClosed{Error: c.ctx.Err()}) return case cmd := &lt;-c.commands: // execute some asynchronous "cluster-wide" actions c.execCommand(cmd) continue case &lt;-forceReload: // forced mapping reload c.reloadMapping() case &lt;-tC: // regular mapping reload c.reloadMapping() } } } func (c *Cluster) ForceReloading() { select { case c.forceReload &lt;- struct{}{}: default: } }</span></span></code> </pre> <br><p style=";text-align:right;direction:rtl">  ุฅุฐุง ูุงูุช ุงุณุชุฌุงุจุฉ MOVED ุฃู ASK ุงููุณุชููุฉ ูู ุงููุฌู ุชุญุชูู ุนูู ุนููุงู ุบูุฑ ูุนุฑูู ุ ูุณูุชู ุจุฏุก ุงูุฅุถุงูุฉ ุบูุฑ ุงููุชุฒุงููุฉ ุฅูู ุงูุชูููู.  (ุฃูุง ุขุณู ุ ูู ุฃูู ูุฏ ุงูุชุดูุช ููููุฉ ุชุจุณูุท ุงูููุฏ ุ ูุฃูู <a href="">ููุง ุงูุฑุงุจุท</a> .) ูู ููู ุงูุฃูุฑ ุจุฏูู ุงุณุชุฎุฏุงู ุงูุฃููุงู ุ ููู ุชู ุฃุฎุฐูุง ููุชุฑุฉ ูุตูุฑุฉ ูู ุงูุฒูู.  ููุชุญูู ุงูุชููุน ุงูุฑุฆูุณู ุนู ุทุฑูู ุญูุธ ุฑุฏ ุงูุงุชุตุงู ูู ุงูุตููู - ูู ุงููุณุชูุจู ุ ูุฌูุฉ ูุธุฑ ุฌุงูุจูุฉ. </p><br><p style=";text-align:right;direction:rtl">  ูุชู ุชุฃุณูุณ ุงูุงุชุตุงูุงุช ูุฌููุน ูุซููุงุช Redis ุ ูููุฃุณูุงุฏ ุ ูููุนุจูุฏ.  ุจูุงุกู ุนูู ุงูุณูุงุณุฉ ุงูููุถูุฉ ูููุน ุงูุทูุจ (ุงููุฑุงุกุฉ ุฃู ุงููุชุงุจุฉ) ุ ูููู ุฅุฑุณุงู ุงูุทูุจ ุฅูู ุงูุณูุฏ ูุงูุนุจุฏ.  ูุฃุฎุฐ ูุฐุง ูู ุงูุงุนุชุจุงุฑ "ุญูููุฉ" ุงููุซูู ุ ูุงูุฐู ูุชููู ูู ูู ูู ุงููุนูููุงุช ุงูุชู ุชู ุงูุญุตูู ุนูููุง ุนูุฏ ุชุญุฏูุซ ุญุงูุฉ ุงููุชูุฉ ูุงูุญุงูุฉ ุงูุญุงููุฉ ููุงุชุตุงู. </p><br><pre style=";text-align:right;direction:rtl"> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(c *Cluster)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">connForSlot</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(slot </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16</span></span></span></span><span class="hljs-function"><span class="hljs-params">, policy ReplicaPolicyEnum)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*redisconn.Connection, *errorx.Error)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> conn *redisconn.Connection cfg := c.getConfig() shard := cfg.slot2shard(slot) nodes := cfg.nodes <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> addr <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> policy { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MasterOnly: addr = shard.addr[<span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-comment"><span class="hljs-comment">// master is always first node := nodes[addr] if conn = node.getConn(c.opts.ConnHostPolicy, needConnected); conn == nil { conn = node.getConn(c.opts.ConnHostPolicy, mayBeConnected) } case MasterAndSlaves: n := uint32(len(shard.addr)) off := c.opts.RoundRobinSeed.Current() for _, needState := range []int{needConnected, mayBeConnected} { mask := atomic.LoadUint32(&amp;shard.good) // load health information for ; mask != 0; off++ { bit := 1 &lt;&lt; (off % n) if mask&amp;bit == 0 { // replica isn't healthy, or already viewed continue } mask &amp;^= bit addr = shard.addr[k] if conn = nodes[addr].getConn(c.opts.ConnHostPolicy, needState); conn != nil { return conn, nil } } } } if conn == nil { c.ForceReloading() return nil, c.err(ErrNoAliveConnection) } return conn, nil } func (n *node) getConn(policy ConnHostPolicyEnum, liveness int) *redisconn.Connection { for _, conn := range n.conns { switch liveness { case needConnected: if c.ConnectedNow() { return conn } case mayBeConnected: if c.MayBeConnected() { return conn } } } return nil }</span></span></code> </pre> <br><p style=";text-align:right;direction:rtl">  ููุงู <code>RoundRobinSeed.Current()</code> ุฎูู. <code>RoundRobinSeed.Current()</code> .  ูุฐุง ุ ูู ูุงุญูุฉ ุ ูู ูุตุฏุฑ ุงูุนุดูุงุฆูุฉ ุ ููู ูุงุญูุฉ ุฃุฎุฑู ุ ุงูุนุดูุงุฆูุฉ ุงูุชู ูุง ุชุชุบูุฑ ุจุดูู ูุชูุฑุฑ.  ุฅุฐุง ููุช ุจุชุญุฏูุฏ ุงุชุตุงู ุฌุฏูุฏ ููู ุทูุจ ุ ูุฅู ูุฐุง ูููู ูู ููุงุกุฉ ุฎุทูุท ุงูุฃูุงุจูุจ.  ูุฐุง ูู ุงูุณุจุจ ูู ุฃู ุงูุชุทุจูู ุงูุงูุชุฑุงุถู ูุบูุฑ ูููุฉ ุงูุญุงูู ูู ุจุถุน ุนุดุฑุงุช ูู ุงููููู ุซุงููุฉ.  ูู ุฃุฌู ุงูุญุตูู ุนูู ุชุฑุงูุจุงุช ุฃูู ูู ุงูููุช ุงููุญุฏุฏ ุ ูุฎุชุงุฑ ูู ูุถูู ุงููุงุตู ุงูุฒููู ุงูุฎุงุต ุจู. </p><br><p style=";text-align:right;direction:rtl">  ููุง ุชุชุฐูุฑ ุ ูุณุชุฎุฏู ุงูุงุชุตุงู ููููู Future ููุทูุจุงุช ุบูุฑ ุงููุชุฒุงููุฉ.  ูุณุชุฎุฏู ูุธุงู ุงููุฌููุนุฉ ููุณ ุงูููููู: ููุชู ูุณุชูุจู ูุฎุตุต ุจููููู ูุชูุงูุช ุงููุณุงูุงุช ุ ููุชู ุชุบุฐูุฉ ุฐูู ุงูุงุชุตุงู. </p><br><p style=";text-align:right;direction:rtl">  ููุงุฐุง ุงูุชูุงู ุงููุณุชูุจู ูุฎุตุตุ  ุฃููุงู ุ ูู ูุถุน ุงููุชูุฉ ุ ุชูุฑุฌุน ูููุฉ "ุงููุฌู" "ุฃุฎุทุงุก" ุฑุงุฆุนุฉ MOVED ูุฃุณุฃู ุจูุนูููุงุช ุฃูู ุชุฐูุจ ููููุชุงุญ ุงูุฐู ุชุญุชุงุฌู ุ ูุจุนุฏ ุชููู ูุฐุง ุงูุฎุทุฃ ุ ุชุญุชุงุฌ ุฅูู ุชูุฑุงุฑ ุงูุทูุจ ุฅูู ูุถูู ุขุฎุฑ.  ุซุงููุงู ุ ูุธุฑูุง ูุฃููุง ูุง ุฒููุง ุจุญุงุฌุฉ ุฅูู ุชุทุจูู ููุทู ุฅุนุงุฏุฉ ุงูุชูุฌูู ุ ูููุงุฐุง ูุง ูุชู ุชุถููู ูุญุงููุฉ ุฅุนุงุฏุฉ ุงูุทูุจ ูุน ูุฌูุฏ ุฎุทุฃ ูู ุงูุฅุฏุฎุงู / ุงูุฅุฎุฑุงุฌ (ุจุงูุทุจุน ุ ููุท ุฅุฐุง ูุงู ุทูุจ ุงููุฑุงุกุฉ): </p><br><pre style=";text-align:right;direction:rtl"> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> request <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { c *Cluster req Request cb Future slot <span class="hljs-keyword"><span class="hljs-keyword">uint16</span></span> policy ReplicaPolicyEnum mayRetry <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(c *Cluster)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SendWithPolicy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(policy ReplicaPolicyEnum, req Request, cb Future)</span></span></span></span> { slot := redisclusterutil.ReqSlot(req) policy = c.fixPolicy(slot, req, policy) conn, err := c.connForSlot(slot, policy, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { cb.Resolve(err) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> } r := &amp;request{ c: c, req: req, cb: cb, slot: slot, policy: policy, mayRetry: policy != MasterOnly || redis.ReplicaSafe(req.Cmd), } conn.Send(req, r, <span class="hljs-number"><span class="hljs-number">0</span></span>) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(r *request)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Resolve</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(res </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">interface</span></span></span></span><span class="hljs-function"><span class="hljs-params">{}, _ </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint64</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { err := redis.AsErrorx(res) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err == <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { r.resolve(res) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> err.IsOfType(redis.ErrIO): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> !r.mayRetry { <span class="hljs-comment"><span class="hljs-comment">// It is not safe to retry read-write operation r.resolve(err) return } fallthrough case err.HasTrait(redis.ErrTraitNotSent): // It is request were not sent at all, it is safe to retry both readonly and write requests. conn, err := rcconnForSlot(r.slot, r.policy, r.seen) if err != nil { r.resolve(err) return } conn.Send(r.req, r) return case err.HasTrait(redis.ErrTraitClusterMove): addr := movedTo(err) ask := err.IsOfType(redis.ErrAsk) rcensureConnForAddress(addr, func(conn *redisconn.Connection, cerr error) { if cerr != nil { r.resolve(cerr) } else { r.lastconn = conn conn.SendAsk(r.req, r, ask) } }) return default: // All other errors: just resolve. r.resolve(err) } }</span></span></code> </pre> <br><p style=";text-align:right;direction:rtl">  ูุฐุง ูู ุฃูุถุง ุฑูุฒ ูุจุณุท.  ุชู ุญุฐู ุงููููุฏ ุงูููุฑูุถุฉ ุนูู ุนุฏุฏ ูุฑุงุช ุฅุนุงุฏุฉ ุงููุญุงููุฉ ุ ูุญูุธ ุงูุงุชุตุงูุงุช ุงูุชู ุชูุทูู ุนูู ูุดุงูู ุ ููุง ุฅูู ุฐูู. </p><br><h2 id="komfort" style=";text-align:right;direction:rtl">  ุงูุฑุงุญุฉ </h2><br><p style=";text-align:right;direction:rtl">  ุทูุจุงุช ุบูุฑ ูุชุฒุงููุฉ ุ ุงููุณุชูุจู ูู superkule!  ููู ุบูุฑ ูุฑูุญ ุจุดูู ุฑููุจ. </p><br><p style=";text-align:right;direction:rtl">  ุงููุงุฌูุฉ ูู ุฃูู ุดูุก.  ููููู ุจูุน ุฃู ุดูุก ุฅุฐุง ูุงู ูุฏูู ูุงุฌูุฉ ูุทููุฉ.  ูุฐุง ูู ุงูุณุจุจ ูู ุงูุชุณุงุจ Redis ู MongoDB ุดุนุจูุชููุง. </p><br><p style=";text-align:right;direction:rtl">  ูุฐูู ุ ูุฌุจ ุชุญููู ุทูุจุงุชูุง ุบูุฑ ุงููุชุฒุงููุฉ ุฅูู ูุชุฒุงูู. </p><br><pre style=";text-align:right;direction:rtl"> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// Sync provides convenient synchronous interface over asynchronous Sender. type Sync struct { S Sender } // Do is convenient method to construct and send request. // Returns value that could be either result or error. func (s Sync) Do(cmd string, args ...interface{}) interface{} { return s.Send(Request{cmd, args}) } // Send sends request to redis. // Returns value that could be either result or error. func (s Sync) Send(r Request) interface{} { var res syncRes res.Add(1) sSSend(r, &amp;res) res.Wait() return res.r } type syncRes struct { r interface{} sync.WaitGroup } // Resolve implements Future.Resolve func (s *syncRes) Resolve(res interface{}) { sr = res s.Done() } // Usage func get(s redis.Sender, key string) (interface{}, error) { res := redis.Sync{s}.Do("GET", key) if err := redis.AsError(res); err != nil { return nil, err } return res, nil }</span></span></code> </pre> <br><p style=";text-align:right;direction:rtl">  ูุง ูุจุฏู <code>AsError</code> ุฃุตููุฉ ููุญุตูู ุนูู ุฎุทุฃ.  ูููู ุฃูุง ุฃุญุจ ุฐูู ุ ู  ูู ุฑุฃูู ุ ุชููู ุงููุชูุฌุฉ ูู <code>Result&lt;T,Error&gt;</code> ุ ู <code>AsError</code> ูู ููุท ูุทุงุจูุฉ ersatz. </p><br><h2 id="nedostatki" style=";text-align:right;direction:rtl">  ุงูุนููุจ </h2><br><p style=";text-align:right;direction:rtl">  ูููู ุ ูุณูุก ุงูุญุธ ุ ููุงู ุฐุจุงุจุฉ ูู ูุฑูู ูู ูุฐุง ุงูุฑูุงู. </p><br><p style=";text-align:right;direction:rtl">  ูุง ูุชุถูู ุจุฑูุชูููู Redis ุทูุจุงุช ุฅุนุงุฏุฉ ุชุฑุชูุจ.  ููู ุงูููุช ููุณู ุ ูุฏูู ุทูุจุงุช ุญุธุฑ ูุซู BLPOP ุ BRPOP. </p><br><p style=";text-align:right;direction:rtl">  ูุฐุง ูู ุงููุดู. </p><br><p style=";text-align:right;direction:rtl">  ููุง ุชุนูู ุ ุฅุฐุง ุชู ุญุธุฑ ูุฐุง ุงูุทูุจ ุ ูุณูุชู ุญุธุฑ ุฌููุน ุงูุทูุจุงุช ุงูุชู ุชุชุจุนู.  ูููุณ ููุงู ูุง ูุฌุจ ุงูููุงู ุจู ุญูุงู ุฐูู. </p><br><p style=";text-align:right;direction:rtl">  ุจุนุฏ ููุงุด ุทููู ุ ุชูุฑุฑ ุญุธุฑ ุงุณุชุฎุฏุงู ูุฐู ุงูุทูุจุงุช ูู RedisPipe. </p><br><p style=";text-align:right;direction:rtl">  ุจุงูุทุจุน ุ ุฅุฐุง ููุช ุจุญุงุฌุฉ ุฅูููุง ุญููุง ุ ูููููู: ูุถุญ ุงููุนููุฉ <code>ScriptMode: true</code> ุ ููุฐุง ูู ุดูุก ุนูู ุถููุฑู. </p><br><h2 id="alternativy" style=";text-align:right;direction:rtl">  ุงูุจุฏุงุฆู </h2><br><p style=";text-align:right;direction:rtl">  ูู ุงููุงูุน ุ ูุง ูุฒุงู ููุงู ุจุฏูู ูู ุฃุฐูุฑู ุ ูููู ูุง ููุฑ ุจู ุงููุฑุงุก ุนูู ุฏุฑุงูุฉ ุจู ุ ูู ููู ูุธุงู ุฐุงูุฑุฉ ุงูุชุฎุฒูู ุงููุคูุช ุงูุนูููุฏูุฉ twemproxy. </p><br><p style=";text-align:right;direction:rtl">  ููุนู ูู Redis ูุง ููุนูู ุงูููุตู ูุฏููุง: ุฅูู ูุญูู "ุทูุจ / ุงุณุชุฌุงุจุฉ" ุฎุงู ูุจุฏูู ุฑูุฉ ุฅูู "ูุฏ ุงูุฃูุงุจูุจ" ุงููุทูู. </p><br><p style=";text-align:right;direction:rtl">  ููู twemproxy ููุณูุง ุณุชุนุงูู ูู ุญูููุฉ ุฃูู ุณูุชุนูู ุนููู ุงูุนูู ุนูู ูุธุงู "ุทูุจ / ุงุณุชุฌุงุจุฉ".  ูุฐู ุงููุฑุฉ.  ูุซุงููุงู ุ ูุณุชุฎุฏู "ุงููุฌู" ููุฐูู "ุงูุชุฎุฒูู ุบูุฑ ุงูููุซูู" ูุฃุญูุงููุง ูููู ุจุชุบููุฑ ุญุฌู ุงููุชูุฉ.  ู twemproxy ูุง ูุณูู ูููุฉ ุฅุนุงุฏุฉ ุงูุชูุงุฒู ุจุฃู ุทุฑููุฉ ููุชุทูุจ ุ ุจุงูุฅุถุงูุฉ ุฅูู ุฐูู ุ ุฅุนุงุฏุฉ ุชุดุบูู ุนูุฏ ุชุบููุฑ ุชูููู ุงููุชูุฉ. </p><br><h2 id="vliyanie" style=";text-align:right;direction:rtl">  ุงูุชุฃุซูุฑ </h2><br><p style=";text-align:right;direction:rtl">  ูู ููู ูุฏู ููุช ููุชุงุจุฉ ููุงู ุ ููุฏ ุงูุชูุช ุจุงููุนู ููุฌุงุช RedisPipe.  ุชู ุงุนุชูุงุฏ ุชุตุญูุญ ูู Radix.v3 ูุถูู ุฎุทูุท ุงูุฃูุงุจูุจ ุฅูู ุญูุงู ุงูุณุจุงุญุฉ ุงูุฎุงุต ุจูู: </p><br><p style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุชุญูู ูู RedisPipe ููุนุฑูุฉ ูุง ุฅุฐุง ูุงู ูููู ุฏูุฌ ุงุณุชุฑุงุชูุฌูุชูุง ุงููุชูุซูุฉ ูู ุฎุทูุท ุงูุฃูุงุจูุจ / ุงูุฎูุท ุงูุถููู</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุฎุทูุท ุงูุฃูุงุจูุจ ุงูุชููุงุฆู ููุฃูุงูุฑ ูู ุจุฑูุฉ</a> </p><br><p style=";text-align:right;direction:rtl">  ุฅููู ุฃูู ุดุฏุฉ ูู ุญูุซ ุงูุณุฑุนุฉ (ููููุง ููุนุงููุฑูู ุ ููููู ูู ุฃููู ุฐูู ุจุงูุชุฃููุฏ).  ููู ูุตูุญุชูู ูู ุฃูู ูููููู ุฅุฑุณุงู ุฃูุงูุฑ ุงูุญุธุฑ ุฅูู ุงูุงุชุตุงูุงุช ุงูุฃุฎุฑู ูู ุงูุชุฌูุน. </p><br><h2 id="zaklyuchenie" style=";text-align:right;direction:rtl">  ุงูุฎุงุชูุฉ </h2><br><p style=";text-align:right;direction:rtl">  ููุฏ ูุฑ ุนุงููุง ูุฑูุจูุง ุนูู ุฐูู ุ ุชุณุงูู RedisPipe ูู ูุนุงููุฉ ุฎุฏูุชูุง. <br>  ูุชุญุณุจูุง ูุฃู "ุฃูุงู ุญุงุฑุฉ" ุ ูุฅู ุฃุญุฏ ุงูููุงุฑุฏ ุงูุชู ูุง ุชุณุจุจ ุณุนุงุชูุง ุงูููู ูู ูุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉ ุนูู ุฎูุงุฏู Redis. </p><br><p style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ูุณุชูุฏุน</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุงููุนูุงุฑ</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar438026/">https://habr.com/ru/post/ar438026/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar438016/index.html">ุชุณุชุซูุฑ ูู ูู ูุงุณุฏุงู ูุณูุชู ููุงููู ุงูุฏููุงุฑุงุช ูู ุจุฏุก ุงูุชุดุบูู ูุฅุฏุฎุงู blockchain ูู ุงูุฃุณูุงู ุงููุงููุฉ</a></li>
<li><a href="../ar438018/index.html">ุงูุชุตููุน ุจุงุณุชุฎุฏุงู ุงูุญุงุณุจ ุงูุขูู ูู ูุฑุดุฉ ููุงูุฉ (ุฌุฒุก 2)</a></li>
<li><a href="../ar438020/index.html">ูุงุชุฑุจููุฑ ุชูุฏู ุญูุงุฑ ููุฑุจุงุฆู 26 ุทู ูุน ุจุทุงุฑูุฉ ุนููุงูุฉ 300 ูููู ูุงุท ุณุงุนุฉ</a></li>
<li><a href="../ar438022/index.html">ููู ูุนุชูุฏ ุญุฌู ุงูููุฏ ุนูู ุงููุตุบูุฑ ูุงููุฌูุน ูุงููุบุฉ. ุชุญุฏูุซ webpack ุบูุฑ ูุชููุน</a></li>
<li><a href="../ar438024/index.html">ุงููุฏููุนุงุช ุงูุณุฑูุนุฉ: ูุง ุชุญุชุงุฌ ุงูุจููู ููููู</a></li>
<li><a href="../ar438028/index.html">ูุง ุชุญุชุงุฌ ุฅูู blockchain: 8 ุญุงูุงุช ูุณุชุฎุฏู ุดููุฑุฉ ูููุงุฐุง ูุง ุชุนูู</a></li>
<li><a href="../ar438034/index.html">Android ู Rx ู Kotlin ุ ุฃู ููููุฉ ุฌุนู ูุฎูุจ Lego ูุชููุต. ุงูุฌุฒุก 1</a></li>
<li><a href="../ar438036/index.html">3blue1brown ู MIT ุจุงููุบุฉ ุงูุฑูุณูุฉ</a></li>
<li><a href="../ar438044/index.html">ูุฑุญุจุง ุงูุนุงูู ุงูุชุญููู</a></li>
<li><a href="../ar438046/index.html">ููููุฉ ุงูุชุฑููุฒ ุงูุฌุบุฑุงูู ููููู ููุทุฉ ุนูู ุณุจุงุฑู ุจุทุฑููุฉ ุณุฑูุนุฉุ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>