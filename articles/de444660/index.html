<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§• ‚õëÔ∏è üë®üèΩ‚Äç‚öïÔ∏è Protokollieren aller Datenbankabfragen in Asp.Net Boilerplate 4.3 .Net Core 2.1 üë®üèº‚Äçüíª üî∂ üë©üèª‚Äç‚úàÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Oft gibt es im Projekt einen unverst√§ndlichen Fehler, f√ºr den eine maximale Protokollierung aller Abfragen in der Datenbank erforderlich ist . Der Art...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Protokollieren aller Datenbankabfragen in Asp.Net Boilerplate 4.3 .Net Core 2.1</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/444660/"> Oft gibt es im Projekt einen unverst√§ndlichen Fehler, f√ºr den eine <b>maximale Protokollierung aller Abfragen in der Datenbank</b> erforderlich ist <b>.</b>  Der Artikel hilft denjenigen, die eines ihrer ersten Projekte auf dem <b>Asp.Net Boilerplate</b> schreiben (auf dem Server <b>bereitstellen)</b> . <br><a name="habracut"></a><br>  Dieser Artikel richtet sich an Personen, die neu in der Asp.Net Boilerplate-Technologie sind und auf einen seltsamen Fehler im Zusammenhang mit der Datenbank gesto√üen sind.  Bei Verwendung von PostgreSQL kann dies beispielsweise das erste Projekt sein.  Die Motivation f√ºr das Schreiben des Artikels war, dass die L√∂sung f√ºr dieses Problem im Internet nicht so einfach zu finden ist, selbst auf Englisch, ganz zu schweigen von der Tatsache, dass die gefundenen L√∂sungen nicht alle Fragen zu diesem Problem vollst√§ndig beantworten. <br><br>  Produktversion: Asp.Net Boilerplate 4.3, .NET Core 2.1 <br><br>  <u>Wenn Sie die folgenden Schritte ausf√ºhren</u> : In Ihrer Hauptprotokolldatei werden alle Anforderungen an die angemeldete Datenbank angezeigt. <br><br><h2>  Schritt 1 </h2><br>  Sie m√ºssen einen Logger erstellen.  Auf der Boilerplate-Plattform ist bereits ein interner Logger konfiguriert.  Es kann standardm√§√üig Log4Net sein.  Es besteht keine Notwendigkeit, Manipulationen mit ihm vorzunehmen.  Stattdessen reicht es aus, eine Logger-Klasse zu erstellen, die Sie als Handler aller Protokollnachrichten aus der Datenbank registrieren. <br><br><h3>  Schritt 1.1 </h3><br>  Projekt * .EntityFrameworkCore.  Hier m√ºssen wir 2 Klassen erstellen.  Ein Logger, der nur eines tut, gibt zum einen alle Nachrichten aus der Datenbank in das Systemprotokoll aus.  Nennen wir es <b>MyLogger.</b>  Und der Anbieter dieses Loggers, der MyLogger erstellt.  Der Anbieter hei√üt <b>MyLoggerProvider.</b> <br><br>  Wir erstellen eine Datei mit dem folgenden Code (eine Datei zur Vereinfachung, obwohl nat√ºrlich jede Datei eine Klasse haben sollte): <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MyLoggerProvider</span></span> : <span class="hljs-title"><span class="hljs-title">ILoggerProvider</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Castle.Core.Logging.ILogger _logger; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MyLoggerProvider</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Castle.Core.Logging.ILogger logger</span></span></span><span class="hljs-function">)</span></span> { _logger = logger; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ILogger </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateLogger</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> categoryName</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MyLogger(_logger); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Dispose</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MyLogger</span></span> : <span class="hljs-title"><span class="hljs-title">ILogger</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Castle.Core.Logging.ILogger _logger; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MyLogger</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Castle.Core.Logging.ILogger logger</span></span></span><span class="hljs-function">)</span></span> { _logger = logger; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IDisposable BeginScope&lt;TState&gt;(TState state) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsEnabled</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">LogLevel logLevel</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Log&lt;TState&gt;(LogLevel logLevel, EventId eventId, TState state, Exception exception, Func&lt;TState, Exception, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; formatter) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (IsEnabled(logLevel)) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> msg = formatter(state, exception); _logger.Info(<span class="hljs-string"><span class="hljs-string">"DB-REQUEST: "</span></span> + msg); } } }</code> </pre> <br>  Wenn Sie genau hinschauen, k√∂nnen Sie sehen, wie ein anderer Logger an MyLoggerProvider und dann an MyLogger weitergeleitet wird.  Es stellt sich schon der dritte heraus!  Das Fazit ist, dass dieses dritte die Klasse der Ebene der Protokollierungsinfrastruktur ist, die aus den Eingeweiden der Boilerplate bezogen werden muss, mit deren Hilfe die Nachrichten im Protokoll gespeichert werden.  Siehe unten. <br><br><h2>  Schritt 2 </h2><br>  Wechseln Sie im Rahmen desselben * .EntityFrameworkCore-Projekts zur Datei * DbContextConfigurer.cs und nehmen Sie in beiden Configure () -Methoden die folgenden √Ñnderungen vor: <br><br>  2.1) F√ºgen Sie einen loggerfactory-Parameter vom Typ LoggerFactory hinzu <br><br>  2.2) F√ºgen Sie dem Methodenk√∂rper zwei Zeilen hinzu: <br><br><pre> <code class="cs hljs">builder.UseLoggerFactory(loggerFactory); builder.EnableSensitiveDataLogging(<span class="hljs-literal"><span class="hljs-literal">true</span></span>);</code> </pre><br>  Die Bedeutung von <b>UseLoggerFactory</b> besteht darin, die Verwendung von loggerFactory zu aktivieren, die in den Parametern f√ºr die Protokollierung der Datenbank √ºbergeben wird.  Es ist sehr wichtig, sich daran zu erinnern, dass wir hier die Datenbankprotokollierung aktivieren. <br><br>  Die Bedeutung von <b>EnableSensitiveDataLogging</b> besteht darin, die Protokollierung nicht nur von Datenbankabfragen zu erm√∂glichen, sondern auch alle Daten in diesen Abfragen aufzuzeichnen.  Ohne diese Einstellung k√∂nnen Sie die Daten in den Abfragen nicht sehen - sie werden durch Fragezeichen ersetzt. <br><br><h2>  Schritt 3 </h2><br>  Im Rahmen desselben * .EntityFrameworkCore-Projekts wechseln wir zur Datei * DbContextFactory.cs. <br><br>  3.1) F√ºgen Sie eine neue Methode hinzu: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> LoggerFactory </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetDbLoggerFactory</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LoggerFactory(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span>[] { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MyLoggerProvider(NullLogger.Instance) }); }</code> </pre> <br>  3.2) In der CreateDbContext () -Methode: <br>  Weil  Da wir zuvor beiden Configure () - Implementierungen einen neuen Parameter hinzugef√ºgt haben, sollte hier ein Fehler angezeigt werden.  Es ist Zeit, diesen neuen Parameter anzugeben - wir registrieren GetDbLoggerFactory () mit einem Komma.  Das hei√üt,  Der Wert des neuen loggerFactory-Parameters wird von der neuen Methode aus Abschnitt 3.1 zur√ºckgegeben. <br><br><h2>  Schritt 4 </h2><br>  Im Rahmen desselben * .EntityFrameworkCore-Projekts wechseln wir zur Datei * EntityFrameworkModule.cs. <br><br>  4.1) F√ºgen Sie eine neue Methode hinzu: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> LoggerFactory </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetDbLoggerFactory</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LoggerFactory(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span>[] { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MyLoggerProvider(Logger) }); }</code> </pre> <br>  4.2) In der PreInitialize () -Methode: <br><br>  Weil  Da wir zuvor beiden Configure () - Implementierungen einen neuen Parameter hinzugef√ºgt haben, sollte hier auch ein Fehler angezeigt werden.  Wir geben einen neuen Parameter √§hnlich wie in Abschnitt 3.2 an - wir registrieren GetDbLoggerFactory () mit einem Komma.  Das hei√üt,  Der Wert des neuen loggerFactory-Parameters wird von der neuen Methode aus Abschnitt 4.1 zur√ºckgegeben. <br><br><h2>  Ergebnis </h2><br>  In der Hauptprotokolldatei (standardm√§√üig Logs.txt) sehen Sie alle Abfragen, denen die DB-REQUEST-Zeichenfolge vorangestellt ist (von hier aus k√∂nnen Sie nach Daten im Protokoll suchen). <br><br><h2>  Allgemeines Verst√§ndnis der L√∂sung </h2><br>  Jetzt werde ich erkl√§ren, was wir getan haben.  Eine Erkl√§rung finden Sie am Ende des Artikels, weil  Oft sind die Leser daran interessiert, bereits etwas Bestimmtes zu tun. <br><br>  In der Klasse * DbContextFactory sowie * EntityFrameworkModule erstellen wir unsere LoggerFactory, in deren Parametern wir den erstellten MyLoggerProvider angeben.  Als Infrastrukturklasse, die sich im ersten Fall direkt anmeldet (* DbContextFactory), √ºbergeben wir den NullLogger.Instance-Stub, sodass keine Eintr√§ge vorhanden sind.  Im zweiten Fall (* EntityFrameworkModule) √ºbergeben wir den Logger, der sich bereits im Abp-Modul befindet.  Dies ist das Logger-Feld.  Es ist bereits initialisiert und kann damit protokolliert werden.  Dementsprechend kann unser MyLogger mit dieser Klasse in die Datei Logs.txt schreiben. <br><br>  Die gesamte Logik besteht darin, dass diese loggerFactory-Factory als Log Factory f√ºr die Arbeit mit der Datenbank installiert wird.  Sobald ein Logger ben√∂tigt wird, wird er vom Werk erstellt.  Und dies ist unser MyLogger, der seinerseits alles protokolliert, was zu Logs.txt kommt (oder die Quelle, f√ºr die die Ausgabe Ihrer Hauptprotokolle konfiguriert ist). <br><br>  Wie Sie sehen, ist nicht alles so einfach und die Abstraktionsebenen frieren manchmal ein, besonders f√ºr Anf√§nger!  Stellen Sie Ihre Fragen in den Kommentaren. <br><br>  <u>Hinweis:</u> <br><br>  - Die L√∂sung wurde erstellt, um den Logger einzuschalten, den Fehler zu verstehen und ihn auszuschalten.  Es ist nicht f√ºr den Langzeitgebrauch ausgelegt. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de444660/">https://habr.com/ru/post/de444660/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de444646/index.html">Rutoken, OpenSSL und eine lokale Zertifizierungsstelle zum Signieren von Nachrichten</a></li>
<li><a href="../de444650/index.html">Bakterielles Deodorant: eine symbiotische Beziehung zwischen Laubfr√∂schen und Pseudomonas-Bakterien</a></li>
<li><a href="../de444652/index.html">‚ÄûEs ist Zeit, aus dem Frontend auszusteigen‚Äú: Andrey Sitnik √ºber die Stagnation der Community, Open Source und nicht nur</a></li>
<li><a href="../de444654/index.html">Die Wirtschaft der Freude. Mentoring als Sonderfall. Das Gesetz von drei Prozent</a></li>
<li><a href="../de444658/index.html">Video von Badoo PHP Meetup # 2: √úber Tests und Codequalit√§t</a></li>
<li><a href="../de444662/index.html">Benutzerdefinierte Elemente im Kampf</a></li>
<li><a href="../de444664/index.html">Die Linux Foundation wird sich mit Open Source-Chips befassen</a></li>
<li><a href="../de444668/index.html">5 h√§ufigste Probleme Arbeitgeber bei der Auswahl von IT-Spezialisten aus Sicht eines Recruiter-Outsourcers</a></li>
<li><a href="../de444670/index.html">Forschung: Musik schadet kreativem Denken - alternative Meinungen verstehen und diskutieren</a></li>
<li><a href="../de444672/index.html">Roskachestvo pr√§sentierte eine Bewertung der in Russland erh√§ltlichen kabelgebundenen und kabellosen Kopfh√∂rer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>