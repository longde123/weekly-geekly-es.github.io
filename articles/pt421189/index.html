<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>😙 👨 🈚️ Migrando um banco de dados para uma versão mais antiga do MS SQL Server 🤙🏾 👈🏾 👨🏼‍🏫</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Você tem um banco de dados do MS SQL Server que precisa transferir para outro computador físico. Você já fez um backup e está felizmente iniciando uma...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Migrando um banco de dados para uma versão mais antiga do MS SQL Server</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/421189/"><img src="https://habrastorage.org/webt/vb/mr/b7/vbmrb7iwta0o9wizyk6lt4ei-ys.png"><br><br>  Você tem um banco de dados do MS SQL Server que precisa transferir para outro computador físico.  Você já fez um backup e está felizmente iniciando uma recuperação.  Porém, no computador em que você deseja transferir o banco de dados, uma versão mais antiga do MS SQL Server está instalada.  O estouro de pilha garante que tudo está ruim.  Mas é mesmo assim? <br><a name="habracut"></a><br><br>  Obviamente, transferir um banco de dados de uma versão mais recente para uma antiga não é um cenário clássico nem o mais correto.  Porém, geralmente os bancos de dados são criados de forma a oferecer suporte a mais e mais novas versões do SQL, começando com algumas, por exemplo, 2008 R2, porque  A compatibilidade direta com o MS SQL é mais do que excelente.  E, por exemplo, seu cliente já instalou o MS SQL 2016 e o ​​MS SQL 2014 foi instalado no servidor de teste para desenvolvimento.E você deseja expandir sua base de clientes para descobrir onde há confusão de dados. <br><br>  A Microsoft negou o problema - eles dizem que não têm compatibilidade com versões anteriores e que não há buscas.  O backup criado no servidor mais recente não pode ser restaurado no servidor mais antigo.  Sim, eles possuem ferramentas como DTS, cópia de banco de dados, importação e exportação, etc.  Mas eles são tão inconvenientes e complicados que a transferência normal de um banco de dados grande com muitas tabelas para usá-los não é particularmente conveniente.  De qualquer forma, eu pessoalmente não tive sucesso. <br><br>  Sim, você pode gerar scripts SQL para todo o banco de dados, incluindo dados.  Mas imagine, você tem vários campos de blob com grande volume de dados no banco de dados e, em geral, o tamanho de todo o banco de dados é de mais de 500 GB.  Imagine quanto tempo esse script levará, quanto tempo será gerado e executado. <br><br>  Portanto, a tarefa é recriar com precisão o banco de dados (estrutura e dados) da nova versão do MS SQL Server na versão anterior.  Eu vim com uma solução bastante simples que quero compartilhar.  Obviamente, esta solução tem um número significativo de limitações, mas ainda na minha opinião é melhor que DTS e scripts. <br><br>  A limitação número um é que você precisa acessar, através do MS SQL Management Studio, os dois servidores - antigos e novos.  Se isso não for possível, deve ser possível na máquina de onde você deseja transferir o banco de dados, instale a versão do SQL na qual você deseja transferir o banco de dados para transferir o banco de dados primeiro para esta versão localmente e arraste-o pelo backup ou diretamente por * df arquivos de banco de dados (via Desanexar / Anexar) à nova máquina (a versão do SQL Server nesse caso já corresponderá). <br><br>  Outra limitação é que você precisará de um script de esquema de banco de dados (todos os objetos, incluindo tabelas, índices, constantes, procedimentos armazenados, gatilhos, etc.) sem dados, e as instruções para criar restrições de chave estrangeira devem ir para esse script no final, separe do script para criar as próprias tabelas. <br><br>  Descreverei brevemente o próprio algoritmo de transferência de dados.  Todas as ações são executadas em uma sessão do Management Studio conectada ao servidor <b>para o qual</b> você deseja transferir o banco de dados. <br><br>  1) No novo servidor, crie um banco de dados vazio com os mesmos arquivos e grupos de arquivos que o banco de dados portátil. <br><br>  2) Usando o script de esquema do banco de dados, criamos todos os objetos do banco de dados (tabelas, índices, visualizações, gatilhos, procedimentos e funções armazenados), mas sem criar restrições de chave estrangeira.  Você não pode criar FK nesta fase, porque  eles irão interferir na inserção de dados. <br><br>  3) Conectamos o banco de dados do qual transferiremos os dados como um servidor vinculado para que você possa usar o banco de dados antigo em consultas ao novo banco de dados. <br><br><pre><code class="sql hljs">EXEC sp_addlinkedserver @server=N'LinkedServerAlias', @srvproduct=N'', @provider=N'SQLNCLI', @datasrc=N'LinkedServerHost\LinkedServerName'; EXEC sp_addlinkedsrvlogin 'LinkedServerUser', 'false', null, 'RealUser', 'RealUserPassword';</code> </pre> <br>  4) porque  Se as estruturas do banco de dados forem as mesmas, usaremos o procedimento armazenado interno sp_msforeachtable, que permite executar uma consulta em cada tabela do banco de dados para gerar um script para transferir dados do banco de dados antigo para o novo por meio de uma consulta do formulário <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> ? <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ?</code> </pre> <br>  Em vez de um ponto de interrogação, sp_msforeachtable substitui o nome de cada tabela e executa a consulta várias vezes (uma vez para cada tabela). <br><br>  Aqui me deparei com o maior número de ancinhos. <br><br>  a) O problema número um é que, para tabelas com campos IDENTITY, você deve chamar: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> IDENTITY_INSERT <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>; <span class="hljs-comment"><span class="hljs-comment">--INSERT INTO ... ( ); SET IDENTITY_INSERT OFF;</span></span></code> </pre><br>  b) O problema número dois é que, nas tabelas que não possuem campos de IDENTIDADE, você não pode fazer essa chamada, portanto, é necessário determinar dinamicamente se a tabela possui ou não uma coluna de IDENIDADE. <br><br>  Isso pode ser feito com esta consulta: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> INFORMATION_SCHEMA.COLUMNS <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> (TABLE_NAME=<span class="hljs-string"><span class="hljs-string">'SomeTable'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> (COLUMNPROPERTY(object_id(<span class="hljs-string"><span class="hljs-string">'dbo.SomeTable'</span></span>), COLUMN_NAME, <span class="hljs-string"><span class="hljs-string">'IsIdentity'</span></span>) = <span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre><br>  c) O problema número três é que, como se viu, no modo IDENITY_INSERT ON, você não pode <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ...</code> </pre><br>  , mas você precisa listar campos específicos. <br><br>  Você pode listar os campos da tabela em uma linha com esta consulta: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SUBSTRING</span></span>( (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">', '</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">QUOTENAME</span></span>(COLUMN_NAME) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> INFORMATION_SCHEMA.COLUMNS <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> TABLE_NAME = <span class="hljs-string"><span class="hljs-string">'SomeTable'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> ORDINAL_POSITION <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">XML</span></span> <span class="hljs-keyword"><span class="hljs-keyword">path</span></span>(<span class="hljs-string"><span class="hljs-string">''</span></span>)), <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">200000</span></span>);</code> </pre><br>  4) Geramos um script de inserção para todas as tabelas: <br><br><div class="spoiler">  <b class="spoiler_title">Procedimento de geração de script</b> <div class="spoiler_text"><pre> <code class="sql hljs">EXEC sp_msforeachtable N' <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @command <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">200</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>=<span class="hljs-string"><span class="hljs-string">''</span></span>?<span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">SUBSTRING</span></span>(@<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">LEN</span></span>(@<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>)<span class="hljs-number"><span class="hljs-number">-8</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @command = <span class="hljs-string"><span class="hljs-string">''''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @command= <span class="hljs-keyword"><span class="hljs-keyword">SUBSTRING</span></span>( (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">QUOTENAME</span></span>(COLUMN_NAME) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> INFORMATION_SCHEMA.COLUMNS <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> TABLE_NAME = <span class="hljs-string"><span class="hljs-string">''''</span></span> + @<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> + <span class="hljs-string"><span class="hljs-string">''''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> ORDINAL_POSITION <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">XML</span></span> <span class="hljs-keyword"><span class="hljs-keyword">path</span></span>(<span class="hljs-string"><span class="hljs-string">''''</span></span>)), <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">200000</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @command = <span class="hljs-string"><span class="hljs-string">''</span></span><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span>+ @<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> +<span class="hljs-string"><span class="hljs-string">''</span></span> (<span class="hljs-string"><span class="hljs-string">''</span></span>+ @command + <span class="hljs-string"><span class="hljs-string">''</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span> + @command + <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span> + <span class="hljs-string"><span class="hljs-string">''</span></span>LinkedServerAlias.SourceDatabase.<span class="hljs-string"><span class="hljs-string">''</span></span> + <span class="hljs-string"><span class="hljs-string">''</span></span>?<span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @command= <span class="hljs-string"><span class="hljs-string">''</span></span><span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> INFORMATION_SCHEMA.COLUMNS <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> (TABLE_NAME=<span class="hljs-string"><span class="hljs-string">''''''</span></span> + @<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span> + <span class="hljs-string"><span class="hljs-string">''''''</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> (COLUMNPROPERTY(object_id(<span class="hljs-string"><span class="hljs-string">''''</span></span>dbo.<span class="hljs-string"><span class="hljs-string">''</span></span>+@<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>+<span class="hljs-string"><span class="hljs-string">''''''</span></span>), COLUMN_NAME, <span class="hljs-string"><span class="hljs-string">''''</span></span>IsIdentity<span class="hljs-string"><span class="hljs-string">''''</span></span>) = <span class="hljs-number"><span class="hljs-number">1</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> IDENTITY_INSERT <span class="hljs-string"><span class="hljs-string">''</span></span> + @<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> + <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>; '' +@command; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @command=@command+<span class="hljs-string"><span class="hljs-string">''</span></span>;'' + ''IF EXISTS (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> INFORMATION_SCHEMA.COLUMNS <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> (TABLE_NAME=<span class="hljs-string"><span class="hljs-string">''''''</span></span> + @<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span> + <span class="hljs-string"><span class="hljs-string">''''''</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> (COLUMNPROPERTY(object_id(<span class="hljs-string"><span class="hljs-string">''''</span></span>dbo.<span class="hljs-string"><span class="hljs-string">''</span></span>+@<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>+<span class="hljs-string"><span class="hljs-string">''''''</span></span>), COLUMN_NAME, <span class="hljs-string"><span class="hljs-string">''''</span></span>IsIdentity<span class="hljs-string"><span class="hljs-string">''''</span></span>) = <span class="hljs-number"><span class="hljs-number">1</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> IDENTITY_INSERT <span class="hljs-string"><span class="hljs-string">''</span></span> + @<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> + <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>;''; PRINT (@command); <span class="hljs-comment"><span class="hljs-comment">--EXEC(@command); //  ,    ,       '</span></span></code> </pre><br></div></div><br>  5) Executamos o script de transferência de dados gerado <br><br>  6) Executamos um script para criar todas as restrições de chave estrangeira (agora já é possível). <br><br>  7) Feito!  Você transferiu o banco de dados do novo servidor SQL para o antigo, embora isso fosse considerado impossível.  Além disso, a transferência é realizada apenas uma vez e meia mais lenta que a taxa de transferência de dados na rede, ou seja,  bem rápido. <br><br>  8) Nós limpamos depois de nós mesmos (desconectamos o Servidor Vinculado): <br><br><pre> <code class="sql hljs">EXEC sp_droplinkedsrvlogin 'LinkedServerUser', null; sp_dropserver 'LinkedServerAlias';</code> </pre><br>  Limitações do método. <br><br>  1) Usando um método semelhante, não será possível transferir tabelas nas quais existem colunas do tipo XML. <br>  Certamente existem muitas outras restrições, como  o banco de dados que transferi dessa maneira não utilizou muitos dos recursos do servidor SQL.  Você pode escrever sobre restrições nos comentários e adicionarei um artigo a elas. <br><br>  Obrigado pela atenção!  Espero que ajude alguém. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt421189/">https://habr.com/ru/post/pt421189/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt421175/index.html">Monitorando o cluster Kubernetes com o Prometheus</a></li>
<li><a href="../pt421177/index.html">Como atrair um especialista em análise de dados quando sua empresa nem sequer tem um site</a></li>
<li><a href="../pt421179/index.html">HashMap interno em Java</a></li>
<li><a href="../pt421183/index.html">A IBM patenteia drones que distinguem emoções e trazem café às pessoas. E sobre o que mais escrever na sexta-feira?</a></li>
<li><a href="../pt421187/index.html">Aprendizado profundo para identificar pinturas</a></li>
<li><a href="../pt421191/index.html">Como é fácil para um artesão sonhar com um núcleo 3D</a></li>
<li><a href="../pt421193/index.html">Audi PB18 e-tron</a></li>
<li><a href="../pt421195/index.html">Inteligência Artificial</a></li>
<li><a href="../pt421197/index.html">Na Rússia, um neuro-fone de ouvido está sendo desenvolvido para pessoas com problemas de fala e motores</a></li>
<li><a href="../pt421199/index.html">Fintech Digest: As tecnologias de IA estão mudando o mercado de serviços bancários, o email como ferramenta de pagamento, a criptomoeda na Austrália</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>