<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤛 👩🏽 🏽 Phantom OS: sous-système de fenêtre - faire des contrôles 🧘🏿 🔈 👅</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Aujourd'hui, nous allons parler de la façon dont l'interface graphique Phantom est organisée. 

 (Quel est Phantom OS, vous pouvez le découvrir en lis...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Phantom OS: sous-système de fenêtre - faire des contrôles</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/472160/"> Aujourd'hui, nous allons parler de la façon dont l'interface graphique Phantom est organisée. <br><br>  (Quel est Phantom OS, vous pouvez le découvrir en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">lisant ces articles</a> .) <br><br>  Plus précisément - comment est née cette interface graphique.  Pendant longtemps, le Phantom n'a eu qu'une conclusion graphique - il était presque impossible de transmettre quoi que ce soit au système avec la souris. <br><br>  Maintenant, le moment est venu de rendre au moins simple - mais les applications, ce qui signifie - vous avez besoin d'une interface utilisateur.  Quoi qu'il en soit - le système, nous serons honnêtes, il avait l'air effrayant.  Et ce n'est pas à la mode maintenant. <br><br>  Qu'est-ce qui était disponible au début du projet UI?  En principe - beaucoup. <br><br>  Il y avait, en fait, des graphiques - un pilote vidéo, un sous-système de fenêtre en mode affichage uniquement, des polices bitmap, un sous-système d'événements de fenêtre (événements), un contrôle de focus de fenêtre et des primitives associées. <br><br>  Maintenant, les étapes et un peu plus. <br><a name="habracut"></a><br>  Le sous-système de pilote vidéo peut exécuter la fonction probe () de plusieurs pilotes tour à tour, recevoir de leur part des demandes de résolution maximale et de couleur, ainsi que la possibilité de travailler en mode accélérateur 2D.  Le système nécessite un minimum de couleurs 24 bits.  À ce niveau, nous avons un framebuffer (un écran en mémoire), une souris et plusieurs types de primitives bitblt. <br><br>  Primitives Bitblt - trois types de base ont été implémentés - copie complète des graphiques (avec des rectangles découpés), copie en tenant compte de la transparence binaire (un pixel est soit complètement transparent ou complètement opaque) et z-buffer.  C'est-à-dire, la possibilité de copier à l'écran uniquement les pixels qui ont une coordonnée z supérieure à la coordonnée z d'un pixel existant - pour calculer un chevauchement partiel des fenêtres. <br><br>  La couche de fonctions suivante est le sous-système de fenêtre.  Il y a ici le concept d'une fenêtre, la décoration de fenêtre (cadre, fenêtre de titre avec boutons), les coordonnées x / y / z des fenêtres et un ensemble de fonctions qui sont chargées de dessiner les fenêtres à l'écran et de contrôler leur mouvement sur tous les axes. <br><br><div class="spoiler">  <b class="spoiler_title">La documentation</b> <div class="spoiler_text">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Responsable de la documentation</a> <br></div></div><br>  Les événements suivants suivent - la file d'attente de microtâches, qui est traitée par le pilote de niveau inférieur pour le rendu et la gestion de l'état des fenêtres. <br><br>  Il convient de noter que les meilleurs esprits de l'humanité prétendent qu'un système de fenêtre graphique qui fonctionnerait de manière stable et sans problème dans un environnement mutithread ne peut pas être écrit sans une file d'attente d'événements.  Mes modestes tentatives d'ignorer cette déclaration l'ont jusqu'à présent confirmée.  Il est très difficile de se passer de la file d'attente de messages et de faire tous les threads demandant des événements de fenêtre pour le programme et conduit parfois à une guerre à l'écran. <br><br>  Par conséquent, la plupart des primitives du système de fenêtres concernant tout ce qui est plus grand que l'image à l'intérieur de la fenêtre sont implémentées via une file d'attente de messages.  La demande envoie à la file d'attente le message «dessinez cette zone sur l'écran» ou «réorganisez la fenêtre au-dessus des autres», et un fil séparé ci-dessous les exécute de manière ordonnée et réfléchie. <br><br>  Il obtient simplement le flux d'événements de la souris (pressé, glissé), du clavier (pressé, relâché) et du système de fenêtre lui-même (événements secondaires - après avoir déplacé la fenêtre vers le haut, redessinez la zone d'écran). <br><br>  Une tâche distincte au niveau du flux d'événements est ce que l'on appelle la concentration.  Une fenêtre focalisée reçoit un flux d'événements du clavier, et en effet, il est clairement mis en évidence sur l'écran comme un point d'adressage de l'activité de l'utilisateur.  En plus de la tâche évidente de choisir une fenêtre pour diriger l'événement, ce système informe également la fenêtre de la perte de concentration, ce qui est parfois important. <br><br><div class="spoiler">  <b class="spoiler_title">La documentation</b> <div class="spoiler_text">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Responsable de la documentation</a> <br></div></div><br>  Le niveau suivant est celui des primitives graphiques pour dessiner sur la fenêtre. <br><br>  Il existe deux options principales pour la mise en œuvre.  Ancien, économique - lorsqu'une fenêtre ne stocke pas de copie de ce qui y est dessiné.  Si une telle fenêtre est effacée et que vous devez dessiner à nouveau l'effacé (par exemple, la fenêtre a été renvoyée à l'écran depuis le bord), la fenêtre appelle la fonction à partir de son programme et cette fonction doit dessiner tout ce qui est nécessaire.  Il s'agit d'un modèle typique et terriblement gênant pour diverses raisons.  La seconde est sélectionnée dans Phantom - chaque fenêtre a un bitmap dans lequel le contenu de la fenêtre est actuellement dessiné.  Le système graphique peut toujours se référer à cette copie et la mettre à jour à l'écran sans tirer le programme utilisateur. <br><br>  Notez que la fenêtre appartenant au programme utilisateur (et non au noyau) dans Phantom, bien sûr, est persistante, est stockée dans la mémoire persistante et après le redémarrage, le système d'exploitation enregistre tout ce qui y est dessiné.  Ceci, soit dit en passant, est étonnamment utile et simplifie le code d'application dans certains endroits à l'indécence. <br><br>  Un ensemble de primitives de dessin permet au code d'application, comme d'habitude, de dessiner un point, une ligne, un bitmap, une ligne de texte dans une police bitmap et d'autres petites choses dans la fenêtre. <br><br>  Sur cette richesse du sous-système graphique au début du projet "New Phantom UI" et terminé.  En principe, ce kit gentleman était suffisant pour beaucoup, mais uniquement pour l'utilisateur.  Aucune entrée. <br><br>  Plus précisément, il y avait un support rudimentaire pour le concept de «bouton», mais uniquement avec la souris, uniquement dans la barre d'outils et uniquement pour fermer la fenêtre.  :) <br><br>  La tâche de développement était la suivante: <br><br><ul><li>  TrueType  Sans cela, c'est dommage. </li><li>  Événements clavier et commandes clavier.  Au moins basique. </li><li>  Penser à la localisation des mises en page - au moins l'alphabet cyrillique, mais jeter les bases d'un changement de mise en page. </li><li>  Commandes - boutons, boutons radio, champs de texte, étiquettes, menus, etc. </li><li>  Le focus du contrôle est le choix d'un point de contrôle à l'intérieur de la fenêtre. </li><li>  Une sorte de composant d'écran pour gérer les fenêtres à l'écran.  Barre des tâches? </li><li>  En fait, les images des contrôles et en général une sorte de conception d'interface utilisateur - ne devraient pas être aussi fermes collectives qu'elles l'étaient. </li></ul><br>  C'était comme ça: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/cb2/88b/7a8/cb288b7a8fa56dffa45b3aed20fc6eba.png" alt="image" width="600"><br><br>  En cours de route, il s'est avéré que le mélange alpha était également nécessaire, c'est-à-dire une transparence partielle des pixels lors de la superposition d'images.  Eh bien, il est devenu clair qu'il était temps de toucher Unicode pour le pis. <br><br>  L'approche de ce poids est divisée en trois grandes parties: Design, Trump, le reste. <br><br>  À propos de la conception, en bref: il existe des conceptions d'interface utilisateur gratuites sur Internet sans exigences d'utilisation malveillantes.  Trois jours pour rechercher et sélectionner, un temps infini pour la découpe artistique des éléments graphiques. <br><br><h4>  Type d'atout </h4><br>  J'avais peur de cela, mais, en fin de compte, en vain.  Il y a libfreetype, il y a des exemples d'application, après deux jours le rendu des polices vectorielles fonctionnait assez bien en mode test. <br><br>  Cependant, il y a des subtilités, et tout le chemin n'a pas été couvert.  À savoir.  Travailler avec les polices du noyau - est.  Les polices sont ensuite pilotées par le code dur dans le binaire du noyau.  Cela est inévitable pour une police système, mais le code utilisateur doit avoir ses propres mécanismes de chargement.  Et bien que certains FS du Phantom, bien sûr, le soient et le seront, ce modèle n'est pas naturel pour lui.  Vous devez pouvoir stocker des polices dans des objets persistants et les faire passer sur le réseau. <br><br>  La seconde est plus simple - les rookeries de polices gratuites sont abondantes et leur organisation ne sera pas longue. <br><br>  Mais le premier ... <br><br>  Vous ne le savez probablement pas, mais les variables de chaîne dans le fantôme possèdent des propriétés inattendues pour les programmeurs qui ne sont pas habitués à la persistance.  Ils peuvent remplacer des fichiers.  Un flux d'octets est un flux d'octets.  Non seulement cela, c'est aussi, par définition, mappé en mémoire - c'est une variable.  C'est, en principe, ce que nous stockons dans un système d'exploitation normal dans un fichier, dans Phantom, vous pouvez simplement le mettre dans une variable de chaîne.  J'agis si souvent - et le compilateur Phantom a même un design - pour aspirer un fichier dans une constante de chaîne.  Ainsi, dans les pays utilisateurs, les fantômes pénètrent, par exemple, les bitmaps.  Mais c'est aussi une méthode honteuse, car alors au moment de l'exécution, cette variable doit être analysée pour obtenir une représentation opérationnelle de l'objet.  Cependant, en ce qui concerne les bitmaps, à l'honneur du concept Phantom, tout va bien ici.  Nous compilons le fichier graphique dans une chaîne lors de la compilation, lorsque Phantom est lancé pour la première fois, il est converti en un objet binaire persistant de type bitmep, et il est déjà utilisé plus tard après un certain nombre de redémarrages du système d'exploitation et ne nécessite pas la source d'origine.  Cela devrait également être fait avec des polices, mais c'est un peu moins courant.  Lorsque vous travaillez, la police vectorielle est rendue dans un raster, et il serait nécessaire de stocker uniquement ces rasters rendus.  Ce n'est pas une astuce ou un problème - ils peuvent à nouveau être pliés en objets Phantom tels que le bitmap, mais il existe déjà une sorte d'infrastructure nécessaire - un bitmap de glyphe de style de style de style de style de style de police (UTF). <br><br>  Ce n'est pas si difficile, mais, apparemment, la tâche de la prochaine étape.  Alors que les polices sont tramées en appel. <br><br><div class="spoiler">  <b class="spoiler_title">La documentation</b> <div class="spoiler_text">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Responsable de la documentation</a> <br></div></div><br><h4>  Unicode </h4><br>  Le rendu des polices par définition implique de travailler avec Unicode.  Bien sûr, c'est bien, car il fallait commencer quelque temps.  En fait, il suffisait d'équiper le moteur de rendu d'un convertisseur UTF-8 en UTF-32 (et c'est le numéro de glyphe dans la police), de télécharger des polices avec l'alphabet cyrillique et cette partie de la localisation a fonctionné.  De plus, si nous voulons d'autres langues, il est nécessaire et suffisant de remplacer la police.  Cependant, la police de base sélectionnée contient beaucoup - pour l'Europe, certainement assez.  La Chine aura besoin d'un remplacement de police, oui. <br><br><h4>  Travailler avec le clavier </h4><br>  Il n'y avait aucun signe d'action militaire du tout, mais, plus que des espoirs, j'ai dû me battre.  Il s'est avéré que l'ancien pilote de clavier est toujours ... en espérant voir le matériel de l'IBM PC XT.  Oui, au siècle dernier.  Le fait est que le contrôleur de clavier est capable (était capable!) De convertir les codes de numérisation des claviers modernes (le soi-disant deuxième ensemble de codes) en celui ancien. <br><br>  Cela s'est avéré à cause de la fin du QEMU, une telle conversion, apparemment, a finalement été rejetée.  Ou accidentellement cassé.  Mais le fait est que le conducteur a refusé de travailler.  Avec chagrin, pendant une heure, avec l'aide d'une mère, j'ai transféré le chauffeur d'un uOS amical dans Phantom.  Juste pour découvrir qu'il a le même problème.  Le premier set.  J'ai dû réécrire le tableau des codes de numérisation et l'analyseur.  Je ne suis pas retourné à l'ancien chauffeur, et c'est pourquoi.  Il s'est avéré que le pilote de uOS a une interface plus élégante avec le système.  À savoir, il n'y revient pas, comme c'était la coutume, une paire (code de caractère, code de balayage des boutons), mais un caractère UTF-32 32 bits.  Il s'avère qu'en UTF, il existe une gamme spéciale de codes alloués pour une utilisation locale, et ils sont plus que suffisants pour toutes les touches de fonction possibles.  Travailler avec un tel flux d'événements dans le code de l'interface utilisateur est beaucoup plus simple. <br><br>  De plus, la localisation tombait parfaitement sur un tel modèle.  Il suffit de superposer le tableau ASCII-&gt; UTF32 pour la langue souhaitée (jeu de caractères), et bravo - nous avons le cyrillique.  Eh bien - presque là.  Il faudrait maintenant soit le transcoder en UTF-8, soit refaire les abats de certaines parties de l'interface utilisateur en UTF-32.  Moi aussi, j'ai accordé à ce moment une faible priorité. <br><br><h4>  Contrôles </h4><br><div class="spoiler">  <b class="spoiler_title">La documentation</b> <div class="spoiler_text">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Chapitre dans la documentation</a> <br></div></div><br>  Boutons, radio, cases à cocher et autres éléments d'interface utilisateur spécifiques. <br><br>  L'infrastructure commune comprend: <br><br><ul><li>  Le mécanisme de stockage des contrôles par rapport à la fenêtre </li><li>  Éléments de visualisation de contrôle typiques - cadre, arrière-plan, texte, icône, etc. </li><li>  Transmission au contrôle des événements et aux schémas de réaction typiques (pousser / basculer) </li><li>  Suivi des événements de la souris et de l'état de vol stationnaire </li><li>  Rappels et génération d'événements secondaires pour informer des changements d'état </li></ul><br><h4>  Contrôle de la mise au point </h4><br>  Pour que le contrôle (bouton, par exemple) puisse être utilisé sans souris, plusieurs choses sont nécessaires. <br><br><ul><li>  La possibilité de le sélectionner depuis le clavier </li><li>  Afficher cette sélection </li><li>  Réponse du clavier </li><li>  Détection de perte de mise au point. </li></ul><br>  Ce dernier est le plus difficile. <br><br>  En fait, le contrôle se concentre à la fois avec le clavier et la souris, et il s'agit d'une seule et même entité - si nous sélectionnons un champ de texte avec la souris, il répondra également aux touches.  Si après cela, vous appuyez sur TAB, le droit de travailler avec le clavier passera à un autre. <br><br>  Une tâche distincte consiste à regrouper certains contrôles et à mettre à jour leur statut de manière connexe.  Presser un radiobathorn «serre» ses voisins de groupe. <br><br>  Encore une fois, revenons au fait que nous écrivons un OS persistant.  Cela signifie que potentiellement le contrôle peut être stocké dans la RAM persistante et survivre au redémarrage du noyau du système. <br><br>  Autrement dit, sa connexion avec le noyau serait bonne à minimiser.  Chaque pointeur vers une mémoire non persistante (en fait vers le noyau) après un redémarrage sera invalide et devra être restauré.  Cela signifie qu'un tel pointeur n'a pas le droit de stocker des informations sur l'état du contrôle.  La position du curseur sous forme d'entier - oui.  Un pointeur vers un tampon dans le noyau dont la position est déterminée par la position du curseur ne l'est pas.  Eh bien ou oui, seul un entier est toujours là et c'est plus important.  En pratique, cela n'est pas très lourd, mais nous devons nous en souvenir. <br><br>  Enfin, la barre des tâches.  C'est une telle chose en bas (côté, haut) de l'écran où l'utilisateur pique s'il a perdu la fenêtre. <br><br>  En principe, cela devrait déjà faire partie de l'espace utilisateur, mais ... le noyau utilise déjà activement l'interface graphique, donc pour l'instant cette partie sera également en bas.  J'espère temporairement. <br><br><h4>  Total </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/3f8/44b/5b4/3f844b5b46e9f0b52b782d891465246a.png" alt="image"><br><br>  À mon avis, les tâches qui ont été définies dans ce sens ont été généralement résolues.  Bien sûr, il n'y a pas de limite à la perfection, mais, comme il me semble, l'interface a fait un pas tangible du hacker à l'universel. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr472160/">https://habr.com/ru/post/fr472160/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr472148/index.html">Retrogaming: PAL vs NTSC. Ou pourquoi PAL n'est pas nécessaire</a></li>
<li><a href="../fr472152/index.html">Test de code multithread et asynchrone</a></li>
<li><a href="../fr472154/index.html">Comment ne pas rater le budget de la production en série des bâtiments-2: prix du moulage plastique à petite échelle</a></li>
<li><a href="../fr472156/index.html">Implémentation du modèle d'objet de page en Python + pytest</a></li>
<li><a href="../fr472158/index.html">"Le processus éducatif en informatique et pas seulement": concours et événements technologiques de l'Université ITMO</a></li>
<li><a href="../fr472162/index.html">Marketing par e-mail externalisé: comment construire et à quoi s'attendre</a></li>
<li><a href="../fr472168/index.html">Une pratique divertissante pour le développeur</a></li>
<li><a href="../fr472170/index.html">Qui a suggéré de décentraliser la zone racine DNS</a></li>
<li><a href="../fr472172/index.html">Refonte appropriée du site Web - algorithme étape par étape, questions de base et nuances</a></li>
<li><a href="../fr472174/index.html">Personnalité et son: Paul Voight - «Sennheiser 30s», le père du haut débit, d'un crossover mécanique et des lignes de transmission</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>