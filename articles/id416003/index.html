<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🈴 🦌 🤵🏽 Rendering file HTML: bab dari buku ReactPHP for Beginners by Skyeng 🚋 🙍🏽 🤛🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pengembang backend aplikasi seluler Skyeng, Sergey Zhuk, terus menulis buku-buku bagus. Kali ini ia merilis buku teks dalam bahasa Rusia untuk pemirsa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Rendering file HTML: bab dari buku ReactPHP for Beginners by Skyeng</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/skyeng/blog/416003/"><p><img src="https://habrastorage.org/webt/6v/oi/xx/6voixx5vd9au0asabvgmnckfj90.png"></p><br><p>  Pengembang backend aplikasi seluler Skyeng, Sergey Zhuk, terus menulis buku-buku bagus.  Kali ini ia merilis buku teks dalam bahasa Rusia untuk pemirsa yang menguasai PHP.  Saya meminta Sergey untuk membagikan bab swadaya yang berguna dari bukunya, dan untuk memberi pembaca Habra kode diskon.  Di bawah ini keduanya. </p><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">Pertama, mari kita beri tahu Anda apa yang kami berhenti di bab-bab sebelumnya.</b> <div class="spoiler_text"><p> Kami telah menulis server HTTP sederhana kami dalam PHP.  Kami memiliki file <code>index.php</code> utama - skrip yang memulai server.  Berikut adalah kode level tertinggi: kami membuat loop acara, mengkonfigurasi perilaku server HTTP dan memulai loop: </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">React</span></span>\<span class="hljs-title"><span class="hljs-title">Http</span></span>\<span class="hljs-title"><span class="hljs-title">Server</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Psr</span></span>\<span class="hljs-title"><span class="hljs-title">Http</span></span>\<span class="hljs-title"><span class="hljs-title">Message</span></span>\<span class="hljs-title"><span class="hljs-title">ServerRequestInterface</span></span>; $loop = React\EventLoop\Factory::create(); $router = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Router(); $router-&gt;load(<span class="hljs-string"><span class="hljs-string">'routes.php'</span></span>); $server = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Server( <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ServerRequestInterface $request)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($router)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $router($request); } ); $socket = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> React\Socket\Server(<span class="hljs-number"><span class="hljs-number">8080</span></span>, $loop); $server-&gt;listen($socket); $loop-&gt;run();</code> </pre> <br><p>  Untuk merutekan permintaan, server menggunakan router: </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// src/Router.php use Psr\Http\Message\ServerRequestInterface; use React\Http\Response; class Router { private $routes = []; public function __invoke(ServerRequestInterface $request) { $path = $request-&gt;getUri()-&gt;getPath(); echo "Request for: $path\n"; $handler = $this-&gt;routes[$path] ?? $this-&gt;notFound($path); return $handler($request); } public function load($filename) { $routes = require $filename; foreach ($routes as $path =&gt; $handler) { $this-&gt;add($path, $handler); } } public function add($path, callable $handler) { $this-&gt;routes[$path] = $handler; } private function notFound($path) { return function () use ($path) { return new Response( 404, ['Content-Type' =&gt; 'text/html; charset=UTF-8'], "No request handler found for $path" ); }; } }</span></span></code> </pre> <br><p>  Rute dari file <code>routes.php</code> dimuat ke <code>routes.php</code> .  Sekarang hanya dua rute yang telah diumumkan di sini: </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">React</span></span>\<span class="hljs-title"><span class="hljs-title">Http</span></span>\<span class="hljs-title"><span class="hljs-title">Response</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Psr</span></span>\<span class="hljs-title"><span class="hljs-title">Http</span></span>\<span class="hljs-title"><span class="hljs-title">Message</span></span>\<span class="hljs-title"><span class="hljs-title">ServerRequestInterface</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ <span class="hljs-string"><span class="hljs-string">'/'</span></span> =&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ServerRequestInterface $request)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Response( <span class="hljs-number"><span class="hljs-number">200</span></span>, [<span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'text/plain'</span></span>], <span class="hljs-string"><span class="hljs-string">'Main page'</span></span> ); }, <span class="hljs-string"><span class="hljs-string">'/upload'</span></span> =&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ServerRequestInterface $request)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Response( <span class="hljs-number"><span class="hljs-number">200</span></span>, [<span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'text/plain'</span></span>], <span class="hljs-string"><span class="hljs-string">'Upload page'</span></span> ); }, ];</code> </pre> <br><p>  Sejauh ini, semuanya sederhana, dan aplikasi asinkron kami cocok dengan beberapa file. </p></div></div><br><p>  Kita beralih ke hal-hal yang lebih "berguna".  Jawaban dari beberapa kata dari teks biasa yang kami pelajari berasal dari bab-bab sebelumnya tidak terlihat sangat menarik.  Kita perlu mengembalikan sesuatu yang nyata, seperti halaman HTML. </p><br><p>  Jadi, di mana kita meletakkan HTML ini?  Tentu saja, Anda dapat meng-hardcode konten halaman web tepat di dalam file rute: </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// routes.php return [ '/' =&gt; function (ServerRequestInterface $request) { $html = &lt;&lt;&lt;HTML &lt;!DOCTYPE html&gt; &lt;html lang=”en”&gt; &lt;head&gt; &lt;meta charset=”UTF-8”&gt; &lt;title&gt;ReactPHP App&lt;/title&gt; &lt;/head&gt; &lt;body&gt; Hello, world &lt;/body&gt; &lt;/html&gt; HTML; return new Response( 200, ['Content-Type' =&gt; 'text/html'], $html ); }, '/upload' =&gt; function (ServerRequestInterface $request) { return new Response( 200, ['Content-Type' =&gt; 'text/plain'], 'Upload page' ); }, ];</span></span></code> </pre> <br><p>  Tapi jangan lakukan itu!  Anda tidak dapat mencampur logika bisnis (perutean) dengan presentasi (halaman HTML).  Mengapa  Bayangkan Anda perlu mengubah sesuatu dalam kode HTML, misalnya, warna tombol.  Dan file mana yang perlu diubah?  File dengan rute <code>router.php</code> ?  Kedengarannya aneh, kan?  Buat perubahan pada perutean untuk mengubah warna tombol ... </p><br><p>  Oleh karena itu, kami akan meninggalkan rute sendirian, dan untuk halaman HTML kami akan membuat direktori terpisah.  Di root proyek, tambahkan direktori baru yang disebut halaman.  Kemudian di dalamnya kita buat file <code>index.html</code> .  Ini akan menjadi halaman utama kami.  Berikut isinya: </p><br><pre> <code class="php hljs">&lt;!DOCTYPE html&gt; &lt;html lang=<span class="hljs-string"><span class="hljs-string">"en"</span></span>&gt; &lt;head&gt; &lt;meta charset=<span class="hljs-string"><span class="hljs-string">"UTF-8"</span></span>&gt; &lt;title&gt;ReactPHP App&lt;/title&gt; &lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css"</span></span> &gt; &lt;/head&gt; &lt;body&gt; &lt;div <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">container</span></span></span><span class="hljs-class">"&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">div</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">row</span></span></span><span class="hljs-class">"&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">form</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">action</span></span></span><span class="hljs-class">="/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">upload</span></span></span><span class="hljs-class">" </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">method</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">POST</span></span></span><span class="hljs-class">" </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">justify</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">content</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">center</span></span></span><span class="hljs-class">"&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">div</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">form</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">group</span></span></span><span class="hljs-class">"&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">label</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">text</span></span></span><span class="hljs-class">"&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Text</span></span></span><span class="hljs-class">&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">label</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">textarea</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">text</span></span></span><span class="hljs-class">" </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">text</span></span></span><span class="hljs-class">" </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">form</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">control</span></span></span><span class="hljs-class">"&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">div</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">button</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">submit</span></span></span><span class="hljs-class">" </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">btn</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">btn</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">primary</span></span></span><span class="hljs-class">"&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Submit</span></span></span><span class="hljs-class">&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">button</span></span></span><span class="hljs-class">&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">form</span></span></span><span class="hljs-class">&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">div</span></span></span><span class="hljs-class">&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">div</span></span></span><span class="hljs-class">&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">body</span></span></span><span class="hljs-class">&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">html</span></span></span><span class="hljs-class">&gt;</span></span></code> </pre> <br><p>  Halaman ini cukup sederhana, hanya berisi satu elemen - formulir.  Formulir di dalam memiliki kotak teks dan tombol untuk mengirimkan.  Saya juga menambahkan gaya Bootstrap untuk membuat halaman kami terlihat lebih bagus. </p><br><h4 id="chtenie-faylov-kak-ne-nado-delat">  Membaca file.  Bagaimana TIDAK </h4><br><p>  Pendekatan yang paling mudah adalah membaca konten file di dalam penangan permintaan dan mengembalikan konten itu sebagai badan respons.  Sesuatu seperti ini: </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// routes.php return [ '/' =&gt; function (ServerRequestInterface $request) { return new Response( 200, ['Content-Type' =&gt; 'text/html'], file_get_contents('pages/index.html') ); }, // ... ];</span></span></code> </pre> <br><p>  Dan omong-omong, itu akan berhasil.  Anda dapat mencobanya sendiri: restart server dan memuat kembali halaman <code>http://127.0.0.1:8080/</code> di browser Anda. </p><br><p><img src="https://habrastorage.org/webt/zq/dc/91/zqdc91cvy7a971jkniyw8hpxgzi.png"></p><br><p>  Jadi apa yang salah di sini?  Dan mengapa tidak melakukan itu?  Singkatnya, karena akan ada masalah jika sistem file mulai melambat. </p><br><h4 id="blokiruyuschie-i-neblokiruyuschie-vyzovy">  Memblokir dan tidak memblokir panggilan </h4><br><p>  Biarkan saya menunjukkan kepada Anda apa yang saya maksud dengan "memblokir" panggilan, dan apa yang bisa terjadi ketika salah satu penangan permintaan berisi kode pemblokiran.  Sebelum mengembalikan objek respons, tambahkan fungsi panggilan ke fungsi <code>sleep()</code> : </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// routes.php return [ '/' =&gt; function (ServerRequestInterface $request) { sleep(10); return new Response( 200, ['Content-Type' =&gt; 'text/html'], file_get_contents('pages/index.html') ); }, '/upload' =&gt; function (ServerRequestInterface $request) { return new Response( 200, ['Content-Type' =&gt; 'text/plain'], 'Upload page' ); }, ];</span></span></code> </pre> <br><p>  Ini akan membuat penangan permintaan dibekukan selama 10 detik sebelum dapat mengembalikan respons dengan konten halaman HTML.  Harap perhatikan bahwa kami tidak menyentuh penangan untuk alamat <code>/upload</code> .  Dengan memanggil fungsi <code>sleep(10)</code> , saya meniru pelaksanaan semacam operasi pemblokiran. </p><br><p>  Jadi apa yang kita miliki?  Ketika browser meminta halaman <code>/</code> , pawang menunggu 10 detik dan kemudian mengembalikan halaman HTML.  Saat kami membuka <code>/upload</code> alamat, penangannya harus segera mengembalikan respons dengan string 'Unggah halaman'. </p><br><p>  Sekarang mari kita lihat apa yang terjadi dalam kenyataan.  Seperti biasa, kami me-restart server.  Sekarang, silakan buka jendela lain di browser Anda.  Di bilah alamat, masukkan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">http://127.0.0.1:8080/upload</a> , tetapi jangan langsung membuka halaman ini.  Biarkan saja alamat ini di bilah alamat untuk saat ini.  Lalu pergi ke jendela browser pertama dan buka halaman <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">http://127.0.0.1:8080/</a> di dalamnya.  Saat halaman ini dimuat (ingat bahwa ini akan memakan waktu 10 detik untuk melakukan ini), cepat pergi ke jendela kedua dan tekan "Enter" untuk memuat alamat yang tersisa di bilah alamat ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">http://127.0.0.1:8080/upload</a> ) . </p><br><p>  Apa yang kita dapatkan?  Ya, alamat /, seperti yang diharapkan, membutuhkan 10 detik untuk memuat.  Namun, yang mengejutkan, halaman kedua mengambil jumlah waktu yang sama untuk memuat, meskipun kami tidak menambahkan panggilan <code>sleep()</code> ke dalamnya.  Adakah yang tahu mengapa ini terjadi? </p><br><p>  ReactPHP berjalan dalam satu utas.  Tampaknya dalam aplikasi asinkron, tugas dieksekusi secara paralel, tetapi dalam kenyataannya tidak demikian.  Ilusi paralelisme diciptakan oleh suatu siklus peristiwa yang secara konstan beralih di antara berbagai tugas dan melaksanakannya.  Tetapi pada titik waktu tertentu, hanya satu tugas yang selalu dilakukan.  Ini berarti bahwa jika salah satu dari tugas-tugas ini memakan waktu terlalu lama, itu akan memblokir loop acara, yang tidak akan dapat mendaftarkan acara baru dan memanggil penangan untuk mereka.  Dan itu pada akhirnya mengarah pada "pembekuan" seluruh aplikasi, itu hanya akan kehilangan sinkronisasi. </p><br><p>  OK, tapi apa hubungannya dengan memanggil <code>file_get_contents('pages/index.h')</code> ?  Masalahnya di sini adalah kita mengakses sistem file secara langsung.  Dibandingkan dengan operasi lain, seperti bekerja dengan memori atau komputasi, bekerja dengan sistem file bisa sangat lambat.  Misalnya, jika file tersebut ternyata terlalu besar, atau disk itu sendiri lambat, maka membaca file mungkin memakan waktu dan, sebagai akibatnya, memblokir event loop. </p><br><p>  Dalam model sinkron standar, permintaan-respons tidak menjadi masalah.  Jika klien meminta file yang terlalu berat, ia akan menunggu sampai file ini diunduh.  Permintaan berat seperti itu tidak memengaruhi pelanggan lain.  Tetapi dalam kasus kami, kami berhadapan dengan model berorientasi peristiwa asinkron.  Kami telah meluncurkan server HTTP yang harus terus memproses permintaan masuk.  Jika satu permintaan membutuhkan terlalu banyak waktu untuk diselesaikan, maka ini akan memengaruhi semua klien server lainnya. </p><br><p>  Sebagai aturan, ingat: </p><br><ul><li>  Anda tidak pernah dapat memblokir acara loop. </li></ul><br><p>  Jadi, bagaimana kita kemudian membaca file secara tidak sinkron?  Dan di sini kita sampai pada aturan kedua: </p><br><ul><li>  Ketika operasi pemblokiran tidak dapat dihindari, itu harus dimasukkan ke dalam proses anak dan melanjutkan eksekusi asinkron di utas utama. </li></ul><br><p>  Jadi, setelah kita belajar bagaimana tidak melakukannya, mari kita bahas solusi non-blocking yang benar. </p><br><h4 id="docherniy-process">  Proses anak </h4><br><p>  Semua komunikasi dengan sistem file dalam aplikasi asinkron harus dilakukan dalam proses anak.  Untuk mengelola proses anak dalam aplikasi ReactPHP, kita perlu menginstal komponen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">"Proses Anak" lainnya</a> .  Komponen ini memungkinkan Anda untuk mengakses fungsi sistem operasi untuk menjalankan perintah sistem apa pun di dalam proses anak.  Untuk menginstal komponen ini, buka terminal di root proyek dan jalankan perintah berikut: </p><br><p> <code>composer require react/child-process</code> </p> <br><h4 id="sovmestimost-s-windows">  <em>Kompatibilitas Windows</em> </h4><br><p>  <em>Dalam sistem operasi Windows, utas STDIN, STDOUT, dan STDERR diblokir, yang berarti bahwa komponen Proses Anak tidak akan dapat bekerja dengan benar.</em>  <em>Oleh karena itu, komponen ini terutama dirancang untuk bekerja hanya pada sistem nix.</em>  <em>Jika Anda mencoba membuat objek kelas Proses pada sistem Windows, pengecualian akan dilempar.</em>  <em>Tetapi komponen dapat bekerja di bawah <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Windows Subsystem untuk Linux (WSL)</a> .</em>  <em>Jika Anda ingin menggunakan komponen ini di Windows, Anda harus menginstal WSL.</em> </p><br><p>  Sekarang kita dapat menjalankan perintah shell di dalam proses anak.  Buka file <code>routes.php</code> , dan kemudian mari kita ubah handler untuk rute <code>/</code> .  Buat objek dari kelas <code>React\ChildProcess\Process</code> , dan sebagai perintah, berikan <code>ls</code> kepadanya untuk mendapatkan isi direktori saat ini: </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// routes.php use Psr\Http\Message\ServerRequestInterface; use React\ChildProcess\Process; use React\Http\Response; return [ '/' =&gt; function (ServerRequestInterface $request) { $childProcess = new Process('ls'); return new Response( 200, ['Content-Type' =&gt; 'text/html'], file_get_contents('pages/index.html') ); }, // ... ];</span></span></code> </pre> <br><p>  Maka kita perlu memulai proses dengan memanggil metode <code>start()</code> .  Tangkapannya adalah bahwa metode <code>start()</code> membutuhkan objek event loop.  Tetapi dalam file <code>routes.php</code> kita tidak memiliki objek ini.  Bagaimana kami melewati loop acara dari <code>index.php</code> ke rute langsung ke penangan permintaan?  Solusi untuk masalah ini adalah "injeksi ketergantungan". </p><br><h4 id="inekciya-zavisimostey">  Injeksi Ketergantungan </h4><br><p>  Jadi, salah satu rute kami membutuhkan loop acara agar berfungsi.  Dalam aplikasi kami, hanya satu komponen yang tahu tentang keberadaan rute - kelas <code>Router</code> .  Ternyata itu adalah tanggung jawabnya untuk menyediakan acara loop untuk rute.  Dengan kata lain, router membutuhkan loop acara, atau tergantung pada loop acara.  Bagaimana kita secara eksplisit menyatakan ketergantungan ini dalam kode?  Bagaimana membuatnya mustahil untuk bahkan membuat router tanpa melewatkan perulangan event ke sana?  Tentu saja, melalui konstruktor kelas <code>Router</code> .  Buka <code>Router.php</code> dan tambahkan konstruktor ke kelas <code>Router</code> : </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Psr</span></span>\<span class="hljs-title"><span class="hljs-title">Http</span></span>\<span class="hljs-title"><span class="hljs-title">Message</span></span>\<span class="hljs-title"><span class="hljs-title">ServerRequestInterface</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">React</span></span>\<span class="hljs-title"><span class="hljs-title">EventLoop</span></span>\<span class="hljs-title"><span class="hljs-title">LoopInterface</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">React</span></span>\<span class="hljs-title"><span class="hljs-title">Http</span></span>\<span class="hljs-title"><span class="hljs-title">Response</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Router</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $routes = []; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> LoopInterface */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $loop; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(LoopInterface $loop)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;loop = $loop; } <span class="hljs-comment"><span class="hljs-comment">// ... }</span></span></code> </pre> <br><p>  Di dalam konstruktor, simpan loop peristiwa yang lewat di properti <code>$loop</code> pribadi.  Ini adalah injeksi ketergantungan ketika kami menyediakan kelas dengan objek yang dibutuhkannya untuk bekerja di luar. </p><br><p>  Sekarang kita memiliki konstruktor baru ini, kita perlu memperbarui pembuatan router.  Buka file <code>index.php</code> dan perbaiki baris tempat kita membuat objek kelas <code>Router</code> : </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// index.php $loop = React\EventLoop\Factory::create(); $router = new Router($loop); $router-&gt;load('routes.php');</span></span></code> </pre> <br><p>  Selesai  Kembali ke <code>routes.php</code> .  Seperti yang mungkin sudah Anda tebak, di sini kita dapat menggunakan ide yang sama dengan <strong>injeksi dependensi</strong> dan menambahkan loop peristiwa sebagai parameter kedua ke penangan kueri kami.  Ubah panggilan balik pertama dan tambahkan argumen kedua: objek yang mengimplementasikan <code>LoopInterface</code> : </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// routes.php use Psr\Http\Message\ServerRequestInterface; use React\EventLoop\LoopInterface; use React\ChildProcess\Process; use React\Http\Response; return [ '/' =&gt; function (ServerRequestInterface $request, LoopInterface $loop) { $childProcess = new Process('ls'); $childProcess-&gt;start($loop); return new Response( 200, ['Content-Type' =&gt; 'text/html'], file_get_contents('pages/index.html') ); }, '/upload' =&gt; function (ServerRequestInterface $request) { return new Response( 200, ['Content-Type' =&gt; 'text/plain'], 'Upload page' ); }, ];</span></span></code> </pre> <br><p>  Selanjutnya, kita perlu meneruskan event loop ke metode <code>start()</code> dari proses anak.  Dan di mana pawang mendapatkan loop acara?  Dan itu sudah disimpan di dalam router di properti <code>$loop</code> pribadi.  Kita hanya perlu melewatinya ketika pawang dipanggil. </p><br><p>  <code>__invoke()</code> buka kelas <code>Router</code> dan memperbarui metode <code>__invoke()</code> , menambahkan argumen kedua ke panggilan pemanggil permintaan: </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__invoke</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ServerRequestInterface $request)</span></span></span><span class="hljs-function"> </span></span>{ $path = $request-&gt;getUri()-&gt;getPath(); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"Request for: $path\n"</span></span>; $handler = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;routes[$path] ?? <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;notFound($path); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $handler($request, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;loop); }</code> </pre> <br><p>  Itu saja!  Ini mungkin <strong>injeksi ketergantungan yang</strong> cukup.  Perjalanan yang agak besar dari siklus peristiwa terjadi, bukan?  Dari file <code>index.php</code> ke kelas <code>Router</code> , dan kemudian dari kelas <code>Router</code> ke file <code>routes.php</code> tepat di dalam callback. </p><br><p>  Jadi, untuk mengonfirmasi bahwa proses anak akan melakukan sihir non-pemblokirannya, mari kita ganti <code>ls</code> sederhana dengan <code>ping 8.8.8.8</code> lebih berat <code>ping 8.8.8.8</code> .  Mulai ulang server dan coba lagi untuk membuka dua halaman di dua jendela yang berbeda.  Pertama, <code>http://127.0.0.1:8080/</code> , dan kemudian <code>/upload</code> .  Kedua halaman terbuka dengan cepat, tanpa penundaan, meskipun perintah <code>ping</code> dijalankan di penangan pertama di latar belakang.  Ngomong-ngomong, ini berarti bahwa kita dapat memotong operasi yang mahal (misalnya, memproses file besar), tanpa memblokir aplikasi utama. </p><br><h4 id="svyazyvaem-docherniy-process-i-otvet-s-pomoschyu-potokov">  Ikat proses anak dan respons menggunakan utas </h4><br><p>  Mari kita kembali ke aplikasi kita.  Jadi, kami membuat proses anak, memulainya, tetapi browser kami tidak menampilkan hasil operasi bercabang dua arah dengan cara apa pun.  Mari kita perbaiki. </p><br><p>  Bagaimana kita dapat berkomunikasi dengan proses anak?  Dalam kasus kami, kami memiliki <code>ls</code> menjalankan yang menampilkan konten direktori saat ini.  Bagaimana kita mendapatkan kesimpulan ini, dan kemudian mengirimkannya ke jawaban?  Jawaban singkatnya adalah: utas. </p><br><p>  Mari kita bicara sedikit tentang proses.  Perintah shell apa pun yang Anda jalankan memiliki tiga aliran data: STDIN, STDOUT, dan STDERR.  Streaming ke output dan input standar, plus stream untuk kesalahan.  Sebagai contoh, ketika kita menjalankan <code>ls</code> , hasil dari perintah ini dikirim langsung ke STDOUT (pada layar terminal).  Jadi, jika kita perlu mendapatkan output dari suatu proses, akses ke aliran output diperlukan.  Dan ini sesederhana itu.  Dalam membuat objek respons, ganti panggilan <code>file_get_contents()</code> dengan <code>$childProcess-&gt;stdout</code> : </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Response( <span class="hljs-number"><span class="hljs-number">200</span></span>, [<span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'text/plain'</span></span>], $childProcess-&gt;stdout );</code> </pre> <br><p>  Semua proses anak memiliki tiga properti yang berhubungan dengan <code>stdio</code> stream: <code>stdout</code> , <code>stdin</code> , dan <code>stderr</code> .  Dalam kasus kami, kami ingin menampilkan output dari proses pada halaman web.  Alih-alih string dalam konstruktor dari kelas <code>Response</code> , kami melewatkan aliran sebagai argumen ketiga.  Kelas <code>Response</code> cukup pintar untuk menyadari bahwa ia menerima aliran dan memprosesnya. </p><br><p>  Jadi, seperti biasa, kita me-reboot server dan melihat apa yang telah kita lakukan.  Mari kita buka halaman <code>http://127.0.0.1:8080/</code> di browser: Anda akan melihat daftar file dari folder root proyek. </p><br><p><img src="https://habrastorage.org/webt/mm/ui/za/mmuizadmcw-fzg1cekm0d1jpz3e.png"></p><br><p>  Langkah terakhir adalah mengganti <code>ls</code> dengan sesuatu yang lebih berguna.  Kami memulai bab ini dengan merender file <code>pages/index.html</code> menggunakan fungsi <code>file_get_contents()</code> .  Sekarang, kita dapat membaca file ini dengan sangat tidak sinkron, tanpa khawatir itu akan memblokir aplikasi kita.  Ganti <code>ls</code> dengan <code>cat pages/index.html</code> . </p><br><p>  Jika Anda tidak terbiasa dengan <code>cat</code> , maka <code>cat</code> ini digunakan untuk menyatukan dan menampilkan file.  Paling sering, perintah ini digunakan untuk membaca file dan menampilkan isinya ke output standar.  Perintah <code>cat pages/index.html</code> membaca file <code>cat pages/index.html</code> dan mencetak isinya ke STDOUT.  Dan kami sudah mengirimkan <code>stdout</code> sebagai badan tanggapan.  Ini adalah versi final file <code>routes.php</code> : </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// routes.php use Psr\Http\Message\ServerRequestInterface; use React\EventLoop\LoopInterface; use React\ChildProcess\Process; use React\Http\Response; return [ '/' =&gt; function (ServerRequestInterface $request, LoopInterface $loop) { $childProcess = new Process('cat pages/index.html'); $childProcess-&gt;start($loop); return new Response( 200, ['Content-Type' =&gt; 'text/html'], $childProcess-&gt;stdout ); }, '/upload' =&gt; function (ServerRequestInterface $request) { return new Response( 200, ['Content-Type' =&gt; 'text/plain'], 'Upload page' ); }, ];</span></span></code> </pre> <br><p>  Akibatnya, semua kode ini hanya diperlukan untuk mengganti satu panggilan ke fungsi <code>file_get_contents()</code> .  Ketergantungan injeksi, melewati objek peristiwa loop, menambahkan proses anak, dan bekerja dengan utas.  Semua ini hanya untuk menggantikan satu panggilan fungsi.  Apakah itu sepadan?  Jawaban: ya, itu sepadan.  Ketika sesuatu dapat memblokir event loop, dan sistem file pasti bisa, pastikan itu pada akhirnya akan memblokir, dan pada saat yang paling tidak tepat. </p><br><p>  Membuat proses anak setiap kali kita perlu mengakses sistem file mungkin terlihat seperti overhead tambahan yang akan mempengaruhi kecepatan dan kinerja aplikasi kita.  Sayangnya, dalam PHP tidak ada cara lain untuk bekerja dengan sistem file secara tidak sinkron.  Semua pustaka PHP asinkron menggunakan proses anak (atau ekstensi yang abstrak). </p><br><p>  Pembaca Habra dapat membeli seluruh buku dengan diskon <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">di tautan ini</a> . </p><br><p>  Dan kami mengingatkan Anda bahwa kami selalu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">mencari pengembang keren</a> !  Ayo, kita bersenang-senang! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id416003/">https://habr.com/ru/post/id416003/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id415993/index.html">Remot, dasar tepung tanpa ampun</a></li>
<li><a href="../id415995/index.html">Pengembangan CROC dari dalam: manusia, bebek, dan banyak pekerjaan</a></li>
<li><a href="../id415997/index.html">Perangkat lunak pembelajaran mesin python</a></li>
<li><a href="../id415999/index.html">Apa itu Beasiswa Apple dan mengapa lebih dari sekadar tiket WWDC</a></li>
<li><a href="../id416001/index.html">Pesan dari situs dalam VK - sederhana dan efektif - PHP + CUrl</a></li>
<li><a href="../id416005/index.html">16 Alat Bereaksi untuk Pengembang Antarmuka</a></li>
<li><a href="../id416007/index.html">Hampir rumit. Awal dari penciptaan "rumah pintar" nirkabel. Berbasis pada teknologi Linux, perangkat lunak Z-Wave dan MajorDoMo</a></li>
<li><a href="../id416009/index.html">Coba kotoran kelinci, itu kuat, ia akan menangkap - ekstrak dalam farmakologi</a></li>
<li><a href="../id416011/index.html">Pola BIF: membersihkan kode front-end dan pekerjaan yang mudah dengan data server</a></li>
<li><a href="../id416013/index.html">Cara mulai berinvestasi dan menghemat uang: Pakar Dow Jones menyebutkan lima kesalahan utama pedagang pemula</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>