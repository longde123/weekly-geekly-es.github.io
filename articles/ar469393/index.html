<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧝🏿 🕢 👍 Flare-On 2019 كتابة ⁉️ 👇🏼 🏴󠁧󠁢󠁥󠁮󠁧󠁿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="-0x01 - مقدمة 


 هذا المقال مخصص لتحليل جميع مهام Flare-On 2019 - المسابقة السنوية للهندسة العكسية من FireEye. في هذه المسابقات ، أشارك للمرة الثانية...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Flare-On 2019 كتابة</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dsec/blog/469393/" style=";text-align:right;direction:rtl"><div style="text-align:center;;text-align:right;direction:rtl"><img width="500" src="https://habrastorage.org/webt/bz/4g/sb/bz4gsbxbvka4sjtartbqmxccw6q.png"></div><br><a name="intro"></a><br><h2 id="-0x01---intro" style=";text-align:right;direction:rtl">  -0x01 - مقدمة </h2><br><p style=";text-align:right;direction:rtl">  هذا المقال مخصص لتحليل جميع مهام <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">Flare-On 2019</a> - المسابقة السنوية للهندسة العكسية من FireEye.  في هذه المسابقات ، أشارك للمرة الثانية.  في العام السابق ، تمكنت من الحصول على المركز الحادي عشر من حيث وقت الانتهاء ، بعد أن حل جميع المشاكل في حوالي 13 يومًا.  كانت مجموعة المهام هذا العام أسهل ، والتقيت في 54 ساعة ، مع الأخذ في نفس الوقت 3 مكان من حيث التسليم. </p><br><p style=";text-align:right;direction:rtl"> حاولت في هذه المقالة وصف تلك اللحظات التي أثارت اهتمامي الكبير ، وبالتالي ، فإن التحليل لن يصف روتين العمل في المؤسسة الدولية للتنمية ، وفهم خوارزميات كل وظيفة وغيرها من النقاط غير المثيرة للاهتمام.  آمل أنه بعد قراءة هذا ، ستجد شيء جديد ومفيد لنفسك.  يمكنك العثور على تحليل المشكلات من المؤلفين ، وكذلك بعض الإحصاءات والجوائز للفائزين <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">هنا</a> . </p><br><p style=";text-align:right;direction:rtl">  إذا كنت مهتما ، ثم مرحبا بكم في القط! </p><a name="habracut"></a><br><h2 id="0x00---soderzhanie" style=";text-align:right;direction:rtl">  0x00 - المحتويات </h2><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">0x01 - Memecat Battlestation [إصدار تجريبي لبرنامج كومبيوتري]</a> </li><li style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">0x02 - طويل</a> </li><li style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">0x03 - Flarebear</a> </li><li style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">0x04 - Dnschess</a> </li><li style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">0x05 - التجريبي</a> </li><li style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">0x06 - bmphide</a> </li><li style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">0x07 - wopr</a> </li><li style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">0x08 - ثعبان</a> </li><li style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">0x09 - إعادة تحميل</a> </li><li style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">0x0A - موغاتو</a> </li><li style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">0x0B - vv_max</a> </li><li style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">0x0C - مساعدة</a> </li><li style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">0x0D - ملخص</a> </li></ol><br><a name="task01"></a><br><h2 id="0x01---memecat-battlestation-shareware-demo-edition" style=";text-align:right;direction:rtl">  0x01 - Memecat Battlestation [إصدار تجريبي لبرنامج كومبيوتري] </h2><br><blockquote style=";text-align:right;direction:rtl">  مرحبًا بك في تحدي التوهج السادس! <br><br>  هذه هي لعبة بسيطة.  عكس ذلك هندسياً لمعرفة "رموز الأسلحة" التي تحتاج إلى إدخالها لهزيمة كل من العدوين وستكشف شاشة النصر العلم.  أدخل العلم هنا على هذا الموقع للتسجيل والانتقال إلى المستوى التالي. <br><br>  * هذا التحدي مكتوب في. NET.  إذا لم يكن لديك بالفعل أداة هندسية عكسية مفضلة. أوصي dnSpy <br><br>  ** إذا كنت قد قمت بالفعل بحل النسخة الكاملة من هذه اللعبة في جناحنا في BlackHat أو الإصدار اللاحق على twitter ، تهانينا ، أدخل العلم من شاشة النصر الآن لتجاوز هذا المستوى. </blockquote><p style=";text-align:right;direction:rtl">  وضعت هذه المهمة مسبقًا كجزء من Black Hat USA 2019 ، في نفس الوقت الذي قررت فيه ذلك. <del>  لا أتذكر كيف حلها </del>  المهمة بسيطة للغاية ، لذلك لن نفكر في حلها. </p><br><a name="task02"></a><br><h2 id="0x02---overlong" style=";text-align:right;direction:rtl">  0x02 - طويل </h2><br><blockquote style=";text-align:right;direction:rtl">  سر هذا التحدي المقبل مخفي بذكاء.  ومع ذلك ، مع النهج الصحيح ، لن يستغرق إيجاد الحل وقتًا طويلاً. </blockquote><p style=";text-align:right;direction:rtl">  بالنظر إلى x86. exe الملف.  عند محاولة البدء ، يتم عرض رسالة بالمحتويات التالية: </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/gb/0q/ee/gb0qeertq_z-3wk0jyry5tuyjts.png"></p><br><p style=";text-align:right;direction:rtl">  عند تحليل التطبيق ، قد تجد أن الرسالة مخزنة في بعض الترميز بطول حرف متغير (من 1 إلى 4 بايت).  عندما يتم استدعاء وظيفة فك التشفير ، فإنها تتلقى طول النتيجة المتوقعة ، وهي أقصر من الرسالة نفسها ، وهذا هو السبب في أن العلم غير مرئي.  يمكنك إصلاح قيمة الطول التي تم تمريرها إلى الوظيفة في وضع التصحيح والحصول على الرسالة كاملة مع العلم: </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/5q/lp/be/5qlpbeezlg3hmwbr8-bqnmd-50o.png"></p><br><p style=";text-align:right;direction:rtl">  يمكنك أيضًا إعادة كتابة خوارزمية فك التشفير في Python والحصول على العلم: </p><br><pre style=";text-align:right;direction:rtl"><code class="python hljs">msg = [ ... ] <span class="hljs-comment"><span class="hljs-comment">#      output = [] i = 0 while i &lt; len(msg): if (msg[i] &gt;&gt; 3) == 0x1e: out_char = ( ((msg[i + 3] &amp; 0x3F) &lt;&lt; 0 ) | ((msg[i + 2] &amp; 0x3F) &lt;&lt; 6 ) | ((msg[i + 1] &amp; 0x3F) &lt;&lt; 12) | ((msg[i + 0] &amp; 7) &lt;&lt; 18) ) output.append(out_char) i += 4 elif (msg[i] &gt;&gt; 4) == 0x0e: out_char = ( ((msg[i + 2] &amp; 0x3F) &lt;&lt; 0 ) | ((msg[i + 1] &amp; 0x3F) &lt;&lt; 6 ) | ((msg[i + 0] &amp; 0xF) &lt;&lt; 12) ) output.append(out_char) i += 3 elif (msg[i] &gt;&gt; 5) == 6: out_char = ( ((msg[i + 1] &amp; 0x3F) &lt;&lt; 0 ) | ((msg[i + 0] &amp; 0xF) &lt;&lt; 6 ) ) output.append(out_char) i += 2 else: output.append(msg[i]) i += 1 print(bytes([i for i in output])) # b'I never broke the encoding: I_a_M_t_h_e_e_n_C_o_D_i_n_g@flare-on.com'</span></span></code> </pre> <br><a name="task03"></a><br><h2 id="0x03---flarebear" style=";text-align:right;direction:rtl">  0x03 - Flarebear </h2><br><blockquote style=";text-align:right;direction:rtl">  لقد أنشأنا في Flare حيواننا الأليف Tamagotchi ، وهو flarebear.  إنه صعب للغاية.  أبقيه على قيد الحياة وسعيد وسيعطيك العلم. </blockquote><p style=";text-align:right;direction:rtl">  في هذه المهمة ، يتم تقديم ملف <code>apk</code> لنظام <code>Android</code> .  النظر في طريقة الحل دون بدء التطبيق نفسه. </p><br><p style=";text-align:right;direction:rtl">  الخطوة الأولى هي الحصول على الكود المصدري للتطبيق.  للقيام بذلك ، باستخدام مجموعة <code>dex2jar</code> المساعدة <code>dex2jar</code> بتحويل <code>apk</code> إلى <code>jar</code> ، ثم احصل على شفرة مصدر <code>Java</code> باستخدام أداة فك الترميز ، والتي أفضل استخدام <code>cfr</code> . </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">~/retools/d2j/d2j-dex2jar.sh flarebear.apk java -jar ~/retools/cfr/cfr-0.146.jar --outputdir src flarebear-dex2jar.jar</code> </pre> <br><p style=";text-align:right;direction:rtl">  من خلال تحليل التعليمات البرمجية المصدر للتطبيق ، يمكنك العثور على طريقة مثيرة للاهتمام <code>.danceWithFlag()</code> ، والتي توجد في ملف <code>FlareBearActivity.java</code> .  داخل <code>.danceWithFlag()</code> ، يتم فك تشفير موارد التطبيق <code>raw</code> باستخدام طريقة <code>.decrypt(String, byte[])</code> ، الوسيطة الأولى هي السلسلة التي تم الحصول عليها باستخدام طريقة <code>.getPassword()</code> .  بالتأكيد العلم في موارد مشفرة ، لذلك دعونا نحاول فك تشفيرها.  للقيام بذلك ، قررت إعادة كتابة الكود الذي تم فك تشفيره قليلاً ، والتخلص من تبعيات <code>Android</code> وترك فقط الطرق الضرورية لفك التشفير ، بحيث يمكن تجميع الشفرة الناتجة.  علاوة على ذلك ، أثناء التحليل ، وجد أن طريقة <code>.getPassword()</code> تعتمد على ثلاث قيم لحالة عدد صحيح.  تكمن كل قيمة في فاصل زمني صغير من <code>0</code> إلى <code>N</code> ، بحيث يمكنك استعراض جميع القيم الممكنة في البحث عن كلمة المرور المطلوبة. </p><br><p style=";text-align:right;direction:rtl">  والنتيجة هي الكود التالي: </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">Main.java</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.InputStream; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.nio.charset.Charset; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.security.Key; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.security.spec.AlgorithmParameterSpec; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.security.spec.KeySpec; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.ArrayList; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Collection; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.HashMap; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.List; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.stream.Collectors; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Collections; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.*; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.crypto.Cipher; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.crypto.SecretKey; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.crypto.SecretKeyFactory; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.crypto.spec.IvParameterSpec; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.crypto.spec.PBEKeySpec; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.crypto.spec.SecretKeySpec; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Main</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String args [])</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ Main a = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Main(); InputStream inputStream = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileInputStream(<span class="hljs-string"><span class="hljs-string">"ecstatic"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> fileSize = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> File(<span class="hljs-string"><span class="hljs-string">"ecstatic"</span></span>).length(); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] file1 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) fileSize]; inputStream.read(file1); inputStream = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileInputStream(<span class="hljs-string"><span class="hljs-string">"ecstatic2"</span></span>); fileSize = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> File(<span class="hljs-string"><span class="hljs-string">"ecstatic2"</span></span>).length(); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] file2 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) fileSize]; inputStream.read(file2); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">9</span></span>; i++) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> j = <span class="hljs-number"><span class="hljs-number">0</span></span>; j &lt; <span class="hljs-number"><span class="hljs-number">7</span></span>; j++) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> k = <span class="hljs-number"><span class="hljs-number">1</span></span>; k &lt; <span class="hljs-number"><span class="hljs-number">16</span></span>; k++) { String pass = a.getPassword(i, j, k); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] out1 = a.decrypt(pass, file1); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] out2 = a.decrypt(pass, file2); OutputStream outputStream = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileOutputStream(<span class="hljs-string"><span class="hljs-string">"out1"</span></span>); outputStream.write(out1); outputStream = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileOutputStream(<span class="hljs-string"><span class="hljs-string">"out2"</span></span>); outputStream.write(out2); System.out.println(<span class="hljs-string"><span class="hljs-string">"yep!"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (javax.crypto.BadPaddingException ex) { } } } } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] decrypt(Object object, <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] arrby) <span class="hljs-keyword"><span class="hljs-keyword">throws</span></span> Exception { Object object2 = Charset.forName(<span class="hljs-string"><span class="hljs-string">"UTF-8"</span></span>); object2 = <span class="hljs-string"><span class="hljs-string">"pawsitive_vibes!"</span></span>.getBytes((Charset)object2); object2 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IvParameterSpec((<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[])object2); object = ((String)object).toCharArray(); Object object3 = Charset.forName(<span class="hljs-string"><span class="hljs-string">"UTF-8"</span></span>); object3 = <span class="hljs-string"><span class="hljs-string">"NaClNaClNaCl"</span></span>.getBytes((Charset)object3); object = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PBEKeySpec((<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>[])object, (<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[])object3, <span class="hljs-number"><span class="hljs-number">1234</span></span>, <span class="hljs-number"><span class="hljs-number">256</span></span>); object = SecretKeyFactory.getInstance(<span class="hljs-string"><span class="hljs-string">"PBKDF2WithHmacSHA1"</span></span>).generateSecret((KeySpec)object); object3 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SecretKeySpec(((SecretKey)object).getEncoded(), <span class="hljs-string"><span class="hljs-string">"AES"</span></span>); object = Cipher.getInstance(<span class="hljs-string"><span class="hljs-string">"AES/CBC/PKCS5Padding"</span></span>); ((Cipher)object).init(<span class="hljs-number"><span class="hljs-number">2</span></span>, (Key)object3, (AlgorithmParameterSpec)object2); object = ((Cipher)object).doFinal(arrby); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> [])object; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">final</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getPassword</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> n, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> n2, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> n3)</span></span></span><span class="hljs-function"> </span></span>{ String string2 = <span class="hljs-string"><span class="hljs-string">"*"</span></span>; String string3 = <span class="hljs-string"><span class="hljs-string">"*"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (n % <span class="hljs-number"><span class="hljs-number">9</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>: { string2 = <span class="hljs-string"><span class="hljs-string">"*"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span>: { string2 = <span class="hljs-string"><span class="hljs-string">"&amp;"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>: { string2 = <span class="hljs-string"><span class="hljs-string">"@"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>: { string2 = <span class="hljs-string"><span class="hljs-string">"#"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>: { string2 = <span class="hljs-string"><span class="hljs-string">"!"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>: { string2 = <span class="hljs-string"><span class="hljs-string">"+"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>: { string2 = <span class="hljs-string"><span class="hljs-string">"$"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>: { string2 = <span class="hljs-string"><span class="hljs-string">"-"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>: { string2 = <span class="hljs-string"><span class="hljs-string">"_"</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (n3 % <span class="hljs-number"><span class="hljs-number">7</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>: { string3 = <span class="hljs-string"><span class="hljs-string">"@"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>: { string3 = <span class="hljs-string"><span class="hljs-string">"&amp;"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>: { string3 = <span class="hljs-string"><span class="hljs-string">"#"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>: { string3 = <span class="hljs-string"><span class="hljs-string">"+"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>: { string3 = <span class="hljs-string"><span class="hljs-string">"_"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>: { string3 = <span class="hljs-string"><span class="hljs-string">"$"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>: } String string4 = String.join(<span class="hljs-string"><span class="hljs-string">""</span></span>, Collections.nCopies(n / n3, <span class="hljs-string"><span class="hljs-string">"flare"</span></span>)); String string5 = String.join(<span class="hljs-string"><span class="hljs-string">""</span></span>, Collections.nCopies(n2 * <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.rotN(<span class="hljs-string"><span class="hljs-string">"bear"</span></span>, n * n2))); String string6 = String.join(<span class="hljs-string"><span class="hljs-string">""</span></span>, Collections.nCopies(n3, <span class="hljs-string"><span class="hljs-string">"yeah"</span></span>)); StringBuilder stringBuilder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(); stringBuilder.append(string4); stringBuilder.append(string2); stringBuilder.append(string5); stringBuilder.append(string3); stringBuilder.append(string6); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> stringBuilder.toString(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">final</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rotN</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String charSequence, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> n)</span></span></span><span class="hljs-function"> </span></span>{ Collection&lt;String&gt; collection = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList(charSequence.length()); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; charSequence.length(); ++i) { <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> c; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> c2 = c = charSequence.charAt(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Character.isLowerCase(c)) { <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> c3; c2 = c3 = (<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>)(c + n); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (c3 &gt; <span class="hljs-string"><span class="hljs-string">'z'</span></span>) { c2 = c3 = (<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>)(c3 - n * <span class="hljs-number"><span class="hljs-number">2</span></span>); } } collection.add(Character.valueOf(c2).toString()); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> collection.stream().collect(Collectors.joining()); <span class="hljs-comment"><span class="hljs-comment">// return ArraysKt.joinToString$default(CollectionsKt.toCharArray((List)collection), (CharSequence)FLARE_BEAR_NAME, null, null, 0, null, null, 62, null); } }</span></span></code> </pre> </div></div><br><p style=";text-align:right;direction:rtl">  سنقوم باستخراج الموارد المشفرة وتجميع وتشغيل الملف الناتج: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">$ ~/retools/apktool/apktool d flarebear.apk $ cp flarebear/res/raw/* . $ javac Main.java $ java Main</code> </pre> <br><p style=";text-align:right;direction:rtl">  لحسن الحظ ، واحد فقط من خيارات كلمة المرور التي تحددها مناسب.  نتيجة لذلك ، نحصل على صورتين مع العلم: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">~/flareon2019/3 - Flarebear$ file out* out1: PNG image data, 2100 x 2310, 8-bit/color RGB, non-interlaced out2: PNG image data, 2100 x 2310, 8-bit/color RGB, non-interlaced</code> </pre> <br><img width="400" src="https://habrastorage.org/webt/eo/sp/wv/eospwvjutdz_76f4qrwzqqzstie.png"><br><img width="400" src="https://habrastorage.org/webt/mr/cf/wk/mrcfwklfuon1ebo1ctqafdzicti.png"><br><a name="task04"></a><br><h2 id="0x04---dnschess" style=";text-align:right;direction:rtl">  0x04 - Dnschess </h2><br><blockquote style=";text-align:right;direction:rtl">  قادنا بعض زيارات الشبكة المشبوهة إلى برنامج الشطرنج غير المصرح به الذي يعمل على سطح مكتب أوبونتو.  يبدو أن هذا هو عمل قراصنة الكمبيوتر عبر الإنترنت.  ستحتاج إلى اتخاذ الخطوات الصحيحة لحل هذه الخطوة.  حظا سعيدا </blockquote><p style=";text-align:right;direction:rtl">  تحتوي هذه المهمة على تفريغ حركة المرور وملف قابل للتنفيذ <code>ELF</code> <code>ChessUI</code> ومكتبة <code>ChessAI.so</code> .  من خلال تشغيل الملف القابل للتنفيذ ، يمكنك رؤية رقعة الشطرنج. </p><br><img width="500" src="https://habrastorage.org/webt/5t/7m/gn/5t7mgn6jyrc2zndnuwliuiuzovc.png"><br><p style=";text-align:right;direction:rtl">  لنبدأ التحليل مع تفريغ حركة المرور. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/br/00/-5/br00-59yyrbti3rrdxgvizcfkdk.png"></p><br><p style=";text-align:right;direction:rtl">  تتكون كل حركة المرور من استعلامات إلى خادم <code>DNS</code> النوع <code>A</code>  تتكون الاستعلامات نفسها من أسماء القطع ووصف الحركة في لعبة الشطرنج والجزء الثابت <code>.game-of-thrones.flare-on.com</code> ، على سبيل المثال <code>rook-c3-c6.game-of-thrones.flare-on.com</code> .  في الجزء الثابت ، يمكنك بسهولة العثور على المكان المناسب في مكتبة <code>ChessAI.so</code> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">signed</span></span> __int64 __<span class="hljs-function"><span class="hljs-function">fastcall </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getNextMove</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> idx, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *chess_name, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pos_from, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pos_to, \__int64 a5)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hostent</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">v9</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-comment"><span class="hljs-comment">// [rsp+20h] [rbp-60h] char *ip_addr; // [rsp+28h] [rbp-58h] char dns_name; // [rsp+30h] [rbp-50h] unsigned __int64 v12; // [rsp+78h] [rbp-8h] v12 = __readfsqword(0x28u); strcpy(&amp;dns_name, chess_name); pos_to_str(&amp;dns_name, pos_from); pos_to_str(&amp;dns_name, pos_to); strcat(&amp;dns_name, ".game-of-thrones.flare-on.com"); v9 = gethostbyname(&amp;dns_name); if ( !v9 ) return 2LL; ip_addr = *v9-&gt;h_addr_list; if ( *ip_addr != 127 || ip_addr[3] &amp; 1 || idx != (ip_addr[2] &amp; 0xF) ) return 2LL; sleep(1u); flag[2 * idx] = ip_addr[1] ^ key[2 * idx]; flag[2 * idx + 1] = ip_addr[1] ^ key[2 * idx + 1]; *(_DWORD *)a5 = (unsigned __int8)ip_addr[2] &gt;&gt; 4; *(_DWORD *)(a5 + 4) = (unsigned __int8)ip_addr[3] &gt;&gt; 1; strcpy((char *)(a5 + 8), off_4120[idx]); return (unsigned __int8)ip_addr[3] &gt;&gt; 7; }</span></span></code> </pre> <br><p style=";text-align:right;direction:rtl">  يمكن ملاحظة ذلك من الكود الذي يستند إلى عناوين <code>ip</code> المستلمة ، يتم فك تشفير سلسلة بايت معينة ، والتي يتم تخزينها في منطقة ذاكرة أخرى ، والتي اتصلت بها. </p><br><p style=";text-align:right;direction:rtl">  لحل هذه المهمة ، أول ما عليك فعله هو الحصول على جميع عناوين <code>ip</code> من تفريغ حركة المرور.  يمكنك القيام بذلك باستخدام الأمر التالي: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">tshark -r capture.pcap | grep -P -o '127.(\d+).(\d+).(\d+)' | grep -v '127.0.0.1'</code> </pre> <br><p style=";text-align:right;direction:rtl">  <code>ips</code> حفظ جميع عناوين <code>ip</code> في ملف <code>ips</code> ، <code>ips</code> استخدام رمز <code>Python</code> التالي للحصول على العلامة: </p><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">'ips'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: ips = f.read().split() flag = bytearray(<span class="hljs-number"><span class="hljs-number">64</span></span>) key = <span class="hljs-string"><span class="hljs-string">b'yZ\xb8\xbc\xec\xd3\xdf\xdd\x99\xa5\xb6\xac\x156\x85\x8d\t\x08wRMqT}\xa7\xa7\x08\x16\xfd\xd7'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ip <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ips: a, b, c, d = map(int, ip.split(<span class="hljs-string"><span class="hljs-string">'.'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> d &amp; <span class="hljs-number"><span class="hljs-number">1</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span> idx = c &amp; <span class="hljs-number"><span class="hljs-number">0xf</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> idx &gt; <span class="hljs-number"><span class="hljs-number">14</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span> flag[<span class="hljs-number"><span class="hljs-number">2</span></span>*idx] = b ^ key[<span class="hljs-number"><span class="hljs-number">2</span></span>*idx] flag[<span class="hljs-number"><span class="hljs-number">2</span></span>*idx + <span class="hljs-number"><span class="hljs-number">1</span></span>] = b ^ key[<span class="hljs-number"><span class="hljs-number">2</span></span>*idx + <span class="hljs-number"><span class="hljs-number">1</span></span>] print(flag.decode() + <span class="hljs-string"><span class="hljs-string">'@flare-on.com'</span></span>) <span class="hljs-comment"><span class="hljs-comment"># LooksLikeYouLockedUpTheLookupZ@flare-on.com</span></span></code> </pre> <br><a name="task05"></a><br><h2 id="0x05---demo" style=";text-align:right;direction:rtl">  0x05 - التجريبي </h2><br><blockquote style=";text-align:right;direction:rtl">  حاول شخص ما في فريق Flare إقناعنا بمهاراتهم الديموغرافية.  يبدو فارغا.  معرفة ما إذا كان يمكنك معرفة ذلك أو ربما سيكون علينا لاطلاق النار عليهم.  لا ضغط. </blockquote><p style=";text-align:right;direction:rtl">  <code>4k.exe</code> الملف القابل للتنفيذ <code>4k.exe</code> ، والذي يستخدم <code>DirectX</code> .  عند بدء التشغيل ، يتم عرض شعار <code>FlareOn</code> الدوار في النافذة الرئيسية. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/db/cw/ll/dbcwllgkqhasqqyvcmjv0iugwoc.png"></p><br><p style=";text-align:right;direction:rtl">  يكشف التحليل الثابت للبرنامج عن وظيفة واحدة ، وهي نقطة الدخول.  في المحتوى ، تشبه الدالة تنفيذ فك تشفير التعليمات البرمجية.  لن نضيع الوقت في تحليل خوارزمية هذه الوظيفة ، فقط ضع نقطة توقف على تعليمات <code>ret</code> ونرى أين يتم نقل التحكم.  بعد العودة ، نجد <code>0x00420000</code> على العنوان <code>0x00420000</code> ، وهو الرمز الذي يتم تفكيكه على أنه شيء مناسب: </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/ba/ns/cb/banscbeyqmgqabaf6nbg5khebgk.png"></p><br><p style=";text-align:right;direction:rtl">  ثم تقرر نقل هذا الرمز من وضع التصحيح إلى قاعدة بيانات <code>IDA</code> باستخدام <code>API</code> ومتابعة التحليل الثابت. </p><br><p style=";text-align:right;direction:rtl">  يستورد الكود الجديد في البداية الوظائف الضرورية من المكتبات المختلفة.  يمكن أيضًا استعادة جدول هذه الوظائف في الديناميات.  والنتيجة هي مجموعة الوظائف التالية: </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/hj/em/xv/hjemxvwadjd5f6z-paauo9vh4by.png"></p><br><p style=";text-align:right;direction:rtl">  نقطة الدخول "الحقيقية" للبرنامج هي: </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/5l/gl/-4/5lgl-4g3pzgrxf0gigfh5m99uqe.png"></p><br><p style=";text-align:right;direction:rtl">  لاحظ إنشاء <code>DeviceInterface</code> نوع <code>IDirect3DDevice9 **</code> .  في المستقبل ، يتم استخدام هذه الواجهة بشكل نشط ، ولتبسيط الاتجاه المعاكس ، من الضروري تحديد جدول بأساليبه.  كان من الممكن العثور بسرعة على تعريف الواجهة ، على سبيل المثال ، <a href="">هنا</a> .  قمت بتحليل هذا الجدول وقمت بتحويله إلى بنية <code>IDA</code> .  يمكن لتطبيق النوع الناتج على <code>DeviceInterface</code> تبسيط تحليل الرمز الإضافي بشكل ملحوظ.  توضح اللقطات التالية نتيجة أداة فك التشفير للوظيفة الرئيسية لدورة عرض المشهد قبل وبعد الكتابة. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/gh/yc/35/ghyc35pxpo9mhyi8dx-louqlcsy.png"></p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/wg/sk/ql/wgskqlsgkdxsul3hqll8m-ohv8c.png"></p><br><p style=";text-align:right;direction:rtl">  بناءً على مزيد من التحليل ، تم العثور على شبكتين مضلعتين (mesh ، polygon mesh) في البرنامج ، على الرغم من أنه عندما يتم تشغيل البرنامج ، فإننا نرى كائنًا واحدًا فقط.  أيضًا ، عند إنشاء شبكات ، يتم تشفير رؤوسها باستخدام <code>XOR</code> ، مما يثير الشكوك أيضًا.  دعونا فك وتصور القمم.  الشبكة الثانية هي الأكثر أهمية ، منذ ذلك الحين  لديها أكثر بكثير القمم.  <code>matplotlib</code> أن قمت <code>matplotlib</code> كل القمم ، وجدت أن إحداثي <code>Z</code> لكل منهما يساوي 0 ، لذلك من أجل التصور ، تم رسم رسومات بيانية ثنائية الأبعاد باستخدام <code>matplotlib</code> .  تم إيقاف تشغيل التعليمات البرمجية والنتيجة التالية مع إشارة: </p><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> struct <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> matplotlib.pyplot <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> plt <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">'vertexes'</span></span>, <span class="hljs-string"><span class="hljs-string">'rb'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: data = f.read() n = len(data) // <span class="hljs-number"><span class="hljs-number">4</span></span> data = list(struct.unpack(<span class="hljs-string"><span class="hljs-string">'{}I'</span></span>.format(n), data)) key = [<span class="hljs-number"><span class="hljs-number">0xCB343C8</span></span>, <span class="hljs-number"><span class="hljs-number">0x867B81F0</span></span>, <span class="hljs-number"><span class="hljs-number">0x84AF72C3</span></span>] data = [data[i] ^ key[i % <span class="hljs-number"><span class="hljs-number">3</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(len(data))] data = struct.pack(<span class="hljs-string"><span class="hljs-string">'{}I'</span></span>.format(n), *data) data = list(struct.unpack(<span class="hljs-string"><span class="hljs-string">'{}f'</span></span>.format(n), data)) x = data[<span class="hljs-number"><span class="hljs-number">0</span></span>::<span class="hljs-number"><span class="hljs-number">3</span></span>] y = data[<span class="hljs-number"><span class="hljs-number">1</span></span>::<span class="hljs-number"><span class="hljs-number">3</span></span>] z = data[<span class="hljs-number"><span class="hljs-number">2</span></span>::<span class="hljs-number"><span class="hljs-number">3</span></span>] print(z) plt.plot(x, y) plt.show()</code> </pre> <br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/ke/5w/z5/ke5wz52y1nkpe3jpgxsrl9vcg4c.png"></p><br><a name="task06"></a><br><h2 id="0x06---bmphide" style=";text-align:right;direction:rtl">  0x06 - bmphide </h2><br><blockquote style=";text-align:right;direction:rtl">  تايلر دين ارتفع جبل.  Elbert (أطول جبل في كولورادو) في الثانية صباحًا لالتقاط هذه الصورة في الوقت المثالي.  لا تخطي يوم الساق.  وجدنا هذه الصورة وقابلة للتنفيذ على محرك الإبهام غادر على رأس درب.  هل يمكن الوثوق به؟ </blockquote><p style=";text-align:right;direction:rtl">  في المهمة ، يتم <code>image.bmp</code> الملف القابل للتنفيذ <code>image.bmp</code> والصورة <code>image.bmp</code> .  يمكن افتراض أن بعض الرسائل مخفية في الصورة باستخدام طرق إخفاء المعلومات. </p><br><p style=";text-align:right;direction:rtl">  تتم كتابة الثنائية في <code>C#</code> ، لذلك استخدمت الأداة المساعدة <code>dnSpy</code> للتحليل.  يمكنك أن تلاحظ على الفور أن معظم أسماء الطرق مبهمة.  إذا نظرت إلى طريقة <code>Program.Main</code> ، فيمكنك فهم منطق البرنامج ووضع افتراضات حول الغرض من بعضها: </p><br><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// BMPHIDE.Program // Token: 0x06000018 RID: 24 RVA: 0x00002C18 File Offset: 0x00002C18 private static void Main(string[] args) { Program.Init(); Program.yy += 18; string filename = args[2]; string fullPath = Path.GetFullPath(args[0]); string fullPath2 = Path.GetFullPath(args[1]); byte[] data = File.ReadAllBytes(fullPath2); Bitmap bitmap = new Bitmap(fullPath); byte[] data2 = Program.h(data); Program.i(bitmap, data2); bitmap.Save(filename); }</span></span></code> </pre><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  تتم تهيئة التطبيق باستخدام الأسلوب <code>Program.Init()</code> </li><li style=";text-align:right;direction:rtl">  قراءة ملف البيانات وملف الصور </li><li style=";text-align:right;direction:rtl">  باستخدام طريقة <code>byte [] Program.h(byte [])</code> ، يتم تنفيذ بعض تحويل البيانات </li><li style=";text-align:right;direction:rtl">  باستخدام الأسلوب <code>Program.i(Bitmap, byte[])</code> ، يتم إدراج البيانات المحولة في الصورة </li><li style=";text-align:right;direction:rtl">  يتم حفظ الصورة الناتجة باسم جديد. </li></ul><br><p style=";text-align:right;direction:rtl">  عند تهيئة التطبيق ، <code>A</code> استدعاء الأساليب المختلفة للفئة <code>A</code>  أظهر تحليل سطحي للفصل تشابه بعض طرقه مع أساليب obfuscator <code>AntiTamper.JIT.cs</code> (ملف <code>AntiTamper.JIT.cs</code> ).  التطبيق محمي حقًا من تصحيح الأخطاء.  في الوقت نفسه ، لم يكن من الممكن إزالة آليات الحماية باستخدام الأداة المساعدة <code>de4dot</code> ، لذلك تقرر مواصلة التحليل. </p><br><p style=";text-align:right;direction:rtl">  ضع في اعتبارك طريقة <code>Program.i</code> ، والتي تُستخدم لإدخال البيانات في صورة ما. </p><br><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">i</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Bitmap bm, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] data</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> num = Program.j(<span class="hljs-number"><span class="hljs-number">103</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = Program.j(<span class="hljs-number"><span class="hljs-number">103</span></span>); i &lt; bm.Width; i++) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> j = Program.j(<span class="hljs-number"><span class="hljs-number">103</span></span>); j &lt; bm.Height; j++) { <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> flag = num &gt; data.Length - Program.j(<span class="hljs-number"><span class="hljs-number">231</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (flag) { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } Color pixel = bm.GetPixel(i, j); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> red = ((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)pixel.R &amp; Program.j(<span class="hljs-number"><span class="hljs-number">27</span></span>)) | ((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)data[num] &amp; Program.j(<span class="hljs-number"><span class="hljs-number">228</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> green = ((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)pixel.G &amp; Program.j(<span class="hljs-number"><span class="hljs-number">27</span></span>)) | (data[num] &gt;&gt; Program.j(<span class="hljs-number"><span class="hljs-number">230</span></span>) &amp; Program.j(<span class="hljs-number"><span class="hljs-number">228</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> blue = ((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)pixel.B &amp; Program.j(<span class="hljs-number"><span class="hljs-number">25</span></span>)) | (data[num] &gt;&gt; Program.j(<span class="hljs-number"><span class="hljs-number">100</span></span>) &amp; Program.j(<span class="hljs-number"><span class="hljs-number">230</span></span>)); Color color = Color.FromArgb(Program.j(<span class="hljs-number"><span class="hljs-number">103</span></span>), red, green, blue); bm.SetPixel(i, j, color); num += Program.j(<span class="hljs-number"><span class="hljs-number">231</span></span>); } } }</code> </pre> <br><p style=";text-align:right;direction:rtl">  تشبه إلى حد كبير <code>LSB</code> الكلاسيكية ، ومع ذلك ، في الأماكن التي يتوقع فيها ثوابت ، يتم استخدام أسلوب <code>int Program.j(byte)</code> .  تعتمد نتيجة عملها على القيم العالمية المختلفة التي تم الحصول عليها ، بما في ذلك أثناء التهيئة في أسلوب <code>Program.Init()</code> .  وقد تقرر عدم عكس عمله ، ولكن للحصول على جميع القيم الممكنة في وقت التشغيل.  يسمح <code>dnSpy</code> بتحرير كود التطبيق <code>dnSpy</code> وحفظ الوحدات المعدلة.  نستفيد من هذا ونعيد كتابة <code>Program.Main</code> الطريقة كما يلي: </p><br><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { Program.Init(); Program.yy += <span class="hljs-number"><span class="hljs-number">18</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">256</span></span>; i++) { Console.WriteLine(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Format(<span class="hljs-string"><span class="hljs-string">"j({0}) = {1}"</span></span>, i, Program.j((<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>)i))); } }</code> </pre> <br><p style=";text-align:right;direction:rtl">  عند بدء التشغيل ، نحصل على القيم التالية: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">E:\&gt;bmphide_j.exe j(0) = 206 j(1) = 204 j(2) = 202 j(3) = 200 j(4) = 198 j(5) = 196 j(6) = 194 j(7) = 192 j(8) = 222 j(9) = 220 j(10) = 218 j(11) = 216 j(12) = 214 j(13) = 212 j(14) = 210 j(15) = 208 j(16) = 238 j(17) = 236 j(18) = 234 j(19) = 232 j(20) = 230 ...</code> </pre> <br><p style=";text-align:right;direction:rtl">  استبدال المكالمات إلى <code>Program.j</code> في الأسلوب <code>Program.j</code> مع الثوابت الناتجة: </p><br><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">i</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Bitmap bm, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] data</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> num = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; bm.Width; i++) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> j = <span class="hljs-number"><span class="hljs-number">0</span></span>; j &lt; bm.Height; j++) { <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> flag = num &gt; data.Length - <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (flag) { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } Color pixel = bm.GetPixel(i, j); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> red = ((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)pixel.R &amp; <span class="hljs-number"><span class="hljs-number">0xf8</span></span>) | ((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)data[num] &amp; <span class="hljs-number"><span class="hljs-number">0x7</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> green = ((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)pixel.G &amp; <span class="hljs-number"><span class="hljs-number">0xf8</span></span>) | (data[num] &gt;&gt; <span class="hljs-number"><span class="hljs-number">3</span></span> &amp; <span class="hljs-number"><span class="hljs-number">0x7</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> blue = ((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)pixel.B &amp; <span class="hljs-number"><span class="hljs-number">0xfc</span></span>) | (data[num] &gt;&gt; <span class="hljs-number"><span class="hljs-number">6</span></span> &amp; <span class="hljs-number"><span class="hljs-number">0x3</span></span>); Color color = Color.FromArgb(<span class="hljs-number"><span class="hljs-number">0</span></span>, red, green, blue); bm.SetPixel(i, j, color); num += <span class="hljs-number"><span class="hljs-number">1</span></span>; } } }</code> </pre> <br><p style=";text-align:right;direction:rtl">  أصبح من الواضح الآن كيفية إدراج كل بايت من الرسالة في الصورة: </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  يتم وضع البتات من 0 إلى 2 في 3 LSBs للقناة الحمراء للنقطة </li><li style=";text-align:right;direction:rtl">  يتم وضع البتات من 3 إلى 5 في 3 LSBs للقناة الخضراء للنقطة </li><li style=";text-align:right;direction:rtl">  يتم وضع البتات من 6 إلى 7 في LSBs 2 من القناة الزرقاء للنقطة </li></ul><br><p style=";text-align:right;direction:rtl">  بعد ذلك ، حاولت تكرار خوارزمية طريقة تحويل البيانات ، لكن نتيجة الحساب لم تتطابق مع مخرجات البرنامج.  كما اتضح فيما بعد ، فإن الفئة <code>A</code> لها أيضًا وظيفة لاستبدال الطرق (في <code>A.VerifySignature(MethodInfo m1, MethodInfo m2)</code> ) وتعديل <code>IL</code> لرمز بايت الطريقة (في <code>A.IncrementMaxStack</code> ). </p><br><p style=";text-align:right;direction:rtl">  لتحديد الأساليب التي يجب استبدالها في <code>Program</code> ، في <code>Program.Init</code> ، يتم تجزئة شفرة bytecode <code>IL</code> للطرق ومقارنتها بالقيم المحسوبة مسبقًا.  في المجموع ، يتم استبدال طريقتين.  لمعرفة أي منها ، سنقوم بتشغيل التطبيق تحت مصحح الأخطاء عن طريق تعيين نقاط التوقف على مكالمات <code>A.VerifySignature</code> ، ويجب تخطي المكالمة <code>A.CalculateStack()</code> في <code>Program.Init</code> ، بسبب  يمنع تصحيح الأخطاء. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/v7/2o/l4/v72ol4f8pcefzyg7lnmkywe4tyw.png"></p><br><p style=";text-align:right;direction:rtl">  نتيجة لذلك ، يمكنك أن ترى أن يتم استبدال الأسلوب <code>Program.b</code> بواسطة <code>Program.b</code> ، ويتم استبدال <code>Program.d</code> بواسطة <code>Program.d</code> . </p><br><p style=";text-align:right;direction:rtl">  أنت الآن بحاجة إلى التعامل مع تعديل الرمز البريدي: </p><br><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">unsafe</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">uint</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IncrementMaxStack</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr self, A.ICorJitInfo* comp, A.CORINFO_METHOD_INFO* info, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> flags, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">** nativeEntry, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params">* nativeSizeOfCode</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> flag = info != <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (flag) { MethodBase methodBase = Ac(info-&gt;ftn); <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> flag2 = methodBase != <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (flag2) { <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> flag3 = methodBase.MetadataToken == <span class="hljs-number"><span class="hljs-number">100663317</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (flag3) { <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> flNewProtect; A.VirtualProtect((IntPtr)((<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>*)info-&gt;ILCode), info-&gt;ILCodeSize, <span class="hljs-number"><span class="hljs-number">4u</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> flNewProtect); Marshal.WriteByte((IntPtr)((<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>*)info-&gt;ILCode), <span class="hljs-number"><span class="hljs-number">23</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>); Marshal.WriteByte((IntPtr)((<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>*)info-&gt;ILCode), <span class="hljs-number"><span class="hljs-number">62</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>); A.VirtualProtect((IntPtr)((<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>*)info-&gt;ILCode), info-&gt;ILCodeSize, flNewProtect, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> flNewProtect); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> flag4 = methodBase.MetadataToken == <span class="hljs-number"><span class="hljs-number">100663316</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (flag4) { <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> flNewProtect2; A.VirtualProtect((IntPtr)((<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>*)info-&gt;ILCode), info-&gt;ILCodeSize, <span class="hljs-number"><span class="hljs-number">4u</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> flNewProtect2); Marshal.WriteInt32((IntPtr)((<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>*)info-&gt;ILCode), <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-number"><span class="hljs-number">309030853</span></span>); Marshal.WriteInt32((IntPtr)((<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>*)info-&gt;ILCode), <span class="hljs-number"><span class="hljs-number">18</span></span>, <span class="hljs-number"><span class="hljs-number">209897853</span></span>); A.VirtualProtect((IntPtr)((<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>*)info-&gt;ILCode), info-&gt;ILCodeSize, flNewProtect2, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> flNewProtect2); } } } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> A.originalDelegate(self, comp, info, flags, nativeEntry, nativeSizeOfCode); }</code> </pre> <br><p style=";text-align:right;direction:rtl">  من الواضح أنه سيتم تعديل الأساليب التي تحتوي على قيم <code>MetadataToken</code> محددة ، وهي <code>0x6000015</code> و <code>0x6000014</code> .  تتوافق هذه الرموز مع أساليب <code>Program.h</code> و <code>Program.g</code> .  يحتوي <code>dnSpy</code> على محرر <code>hex</code> مدمج ، يتم فيه تمييز بيانات الطريقة عند <code>dnSpy</code> (مظلل باللون الأرجواني) ورمز البايت (مظلل باللون الأحمر) ، كما هو موضح في لقطة الشاشة.  يمكنك الانتقال إلى الطريقة المطلوبة في محرر <code>hex</code> بالنقر فوق العنوان المقابل في التعليق قبل الأسلوب الذي تم إلغاء ترجمته (على سبيل المثال ، <code>File Offset: 0x00002924</code> ). </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/xt/i6/e6/xti6e6knsrkyrapcutnkypgfeau.png"></p><br><p style=";text-align:right;direction:rtl">  دعونا نحاول تطبيق جميع التعديلات الموضحة: <code>dnSpy</code> نسخة من الملف ، في أي محرر سداسي عشرية ، سنقوم بتغيير القيم في الإزاحات اللازمة ، التي تعلمناها من <code>dnSpy</code> محل الأساليب <code>a -&gt; b</code> and <code>c -&gt; d</code> في <code>Program.h</code> .  نحن أيضا إزالة من <code>Program.Init</code> جميع المكالمات إلى الوحدة النمطية <code>A</code>  إذا تم تنفيذ كل شيء بشكل صحيح ، فعندما نحاول إدراج بعض الرسائل في الصورة باستخدام التطبيق المعدل ، فسوف نحصل على نفس النتيجة عند تشغيل التطبيق الأصلي.  توضح لقطات الشاشة أدناه الشفرة التي تم فك تشفيرها عن طرق التطبيقات الأصلية والمعدلة. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/lq/wo/em/lqwoemy3gsysvsptxholl6ioyey.png"></p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/le/tw/j6/letwj6p_uzdmlglrgsky2gifwuy.png"></p><br><p style=";text-align:right;direction:rtl">  يبقى إنشاء خوارزمية تحويل عكسي.  الأمر بسيط للغاية ، لذا سأقدم فقط نص <code>Python</code> الناتج: </p><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> PIL <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Image <span class="hljs-comment"><span class="hljs-comment"># Rotate left: 0b1001 --&gt; 0b0011 rol = lambda val, r_bits, max_bits: \ (val &lt;&lt; r_bits%max_bits) &amp; (2**max_bits-1) | \ ((val &amp; (2**max_bits-1)) &gt;&gt; (max_bits-(r_bits%max_bits))) # Rotate right: 0b1001 --&gt; 0b1100 ror = lambda val, r_bits, max_bits: \ ((val &amp; (2**max_bits-1)) &gt;&gt; r_bits%max_bits) | \ (val &lt;&lt; (max_bits-(r_bits%max_bits)) &amp; (2**max_bits-1)) rol8 = lambda a, b: rol(a, b, 8) ror8 = lambda a, b: ror(a, b, 8) def extract(fname): img = Image.open(fname) w, h = img.size result = bytearray() for i in range(w): for j in range(h): r, g, b = img.getpixel((i, j)) # print('{:02x} {:02x} {:02x}'.format(r, g, b)) byte = (r &amp; 0b111) | ((g &amp; 0b111) &lt;&lt; 3) | ((b &amp; 0b11) &lt;&lt; 6) result.append(byte) return result enc = extract('image.bmp') n = len(enc) dec = bytearray() def g(idx): b = ((idx + 1) * 309030853) &amp; 0xff k = ((idx + 2) * 209897853) &amp; 0xff return b ^ k j = 0 for i in range(n): x = enc[i] x = rol8(x, 3) x ^= g(2*i + 1) x = ror8(x, 7) x ^= g(2*i + 0) dec.append(x) with open('output', 'wb') as f: f.write(dec)</span></span></code> </pre> <br><p style=";text-align:right;direction:rtl">  عن طريق تشغيل هذا البرنامج النصي ، نحصل على صورة <code>bmp</code> أخرى بدون علم.  تكرار الإجراء على ذلك ، نحصل على الصورة النهائية مع العلم. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/jj/ba/yq/jjbayqp9cpownsuf1wlrwar-rem.png"></p><br><a name="task07"></a><br><h2 id="0x07---wopr" style=";text-align:right;direction:rtl">  0x07 - wopr </h2><br><blockquote style=";text-align:right;direction:rtl">  استخدمنا مهارات القرصنة على الكمبيوتر الخاص بنا "للعثور" على الذكاء الاصطناعي على حاسوب عملاق عسكري.  إنها تشبه بشدة فيلم 1983 WarGames الكلاسيكي.  ربما الحياة يقلد الفن؟  إذا تمكنت من العثور على رموز الإطلاق بالنسبة لنا ، فسنسمح لك بالمرور إلى التحدي التالي.  نحن نعد بعدم بدء حرب نووية حرارية. </blockquote><p style=";text-align:right;direction:rtl">  في المهمة ، <code>worp.exe</code> تطبيق وحدة التحكم <code>worp.exe</code> .  على ما يبدو ، لحلها ، تحتاج إلى التقاط بعض التعليمات البرمجية. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/ji/1p/2w/ji1p2w_9cpkv8vsaxbezvicozjc.png"></p><br><p style=";text-align:right;direction:rtl">  يوضح تحليل نقطة الدخول أن هذا أرشيف يعتمد الاستخراج الذاتي.  عند بدء التشغيل ، <code>_MEIPASS2</code> متغير البيئة <code>_MEIPASS2</code> .  في حالة عدم وجود هذا المتغير ، يتم إنشاء دليل مؤقت يتم فيه <code>_MEIPASS2</code> محتويات الأرشيف ، ويبدأ التطبيق مرة أخرى مع متغير البيئة المحدد <code>_MEIPASS2</code> .  محتوى الأرشيف: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">. ├── api-ms-win-core-console-l1-1-0.dll ├── ... ├── ... ├── api-ms-win-crt-utility-l1-1-0.dll ├── base_library.zip ├── _bz2.pyd ├── _ctypes.pyd ├── _hashlib.pyd ├── libcrypto-1_1.dll ├── libssl-1_1.dll ├── _lzma.pyd ├── pyexpat.pyd ├── python37.dll ├── select.pyd ├── _socket.pyd ├── _ssl.pyd ├── this │  ├── __init__.py │  └── key ├── ucrtbase.dll ├── unicodedata.pyd ├── VCRUNTIME140.dll └── wopr.exe.manifest 1 directory, 56 files</code> </pre> <br><p style=";text-align:right;direction:rtl">  اذا حكمنا من خلال المحتوى ، نحن نتعامل مع تطبيق <code>Python</code> معبأ في <code>exe</code> .  دعماً لهذا ، في الثنائية الرئيسية ، يمكنك العثور على استيراد ديناميكي للوظائف المقابلة لمكتبة <code>Python</code> : <code>PyMarshal_ReadObjectFromString</code> و <code>PyEval_EvalCode</code> وغيرها.  لمزيد من التحليل ، تحتاج إلى استخراج شفرة <code>Python</code> .  للقيام بذلك ، احفظ محتويات الأرشيف من الدليل المؤقت <code>_MEIPASS2</code> المسار إليه في متغير البيئة <code>_MEIPASS2</code> .  قم بتشغيل الثنائي الرئيسي في وضع التصحيح عن طريق تعيين نقطة توقف على وظيفة <code>PyMarshal_ReadObjectFromString</code> .  هذه الوظيفة تأخذ كوسيطات مؤشر إلى مخزن مؤقت برمز <code>Python</code> التسلسلي وطولها.  تفريغ محتويات المخزن المؤقت بطول معروف لكل من المكالمات.  تلقيت مكالمتين فقط ، بينما في الثانية ، يكون الكائن التسلسلي أكبر بكثير ، وسوف نقوم بتحليله. </p><br><p style=";text-align:right;direction:rtl">  إحدى الطرق البسيطة إلى حد ما لتحليل البيانات المستلمة هي تحويلها إلى تنسيق ملفات <code>.pyc</code> ( <code>Python</code> bytecode المترجمة) <code>uncompyle6</code> باستخدام <code>uncompyle6</code> .  للقيام بذلك ، يكفي إضافة رأس 16 بايت إلى البيانات المستلمة.  نتيجة لذلك ، حصلت على الملف التالي: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">00000000: 42 0d 0d 0a 00 00 00 00 de cd 57 5d 00 00 00 00 B.........W].... 00000010: e3 00 00 00 00 00 00 00 00 00 00 00 00 09 00 00 ................ 00000020: 00 40 00 00 00 73 3c 01 00 00 64 00 5a 00 64 01 .@...s&lt;...dZd 00000030: 64 02 6c 01 5a 01 64 01 64 02 6c 02 5a 02 64 01 dlZddlZd</code> </pre> <br><p style=";text-align:right;direction:rtl">  بعد ذلك ، نقوم <code>uncompyle6</code> الملف الناتج باستخدام <code>uncompyle6</code> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">uncompyle6 task.pyc &gt; task.py</code> </pre> <br><p style=";text-align:right;direction:rtl">  إذا حاولنا تشغيل الملف <code>BOUNCE = pkgutil.get_data('this', 'key')</code> على استثناء في السطر <code>BOUNCE = pkgutil.get_data('this', 'key')</code> .  تم إصلاح ذلك بسهولة عن طريق تعيين محتويات ملف <code>key</code> من الأرشيف إلى متغير <code>BOUNCE</code> .  إعادة تشغيل البرنامج النصي ، سنرى فقط نقش <code>LOADING...</code>  على ما يبدو ، يتم استخدام بعض التقنيات في المهمة التي تمنع إزالة التجميع.  ننتقل إلى تحليل شفرة <code>Python</code> الناتجة.  في النهاية ، نرى الدورة التالية: </p><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">256</span></span>): <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: print(lzma.decompress(fire(eye(__doc__.encode()), bytes([i]) + BOUNCE))) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> Exception: <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span></code> </pre> <br><p style=";text-align:right;direction:rtl">  يمكنك أن تفهم أن وظيفة <code>print</code> قد تم تجاوزها بالفعل على أنها <code>exec</code> ، وأن <code>__doc__.encode()</code> تعتمد فقط على <code>__doc__.encode()</code> - النص في بداية الملف.       <code>print</code>       <code>print</code>   <code>try-except</code> .         . ,   <code>__doc__</code>   .    <code>__doc__</code>      : </p><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> marshal <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">'pycode1'</span></span>, <span class="hljs-string"><span class="hljs-string">'rb'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> inp: data = inp.read() code = marshal.loads(data) doc = code.co_consts[<span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">'doc.txt'</span></span>, <span class="hljs-string"><span class="hljs-string">'w'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> outp: outp.write(doc)</code> </pre> <br><p style=";text-align:right;direction:rtl">    ,   <code>__doc__</code> .  ,    <code>i</code> ,     .       .   <code>wrong</code>    : </p><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs">trust = windll.kernel32.GetModuleHandleW(<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>)</code> </pre> <br><p style=";text-align:right;direction:rtl">          ,         .      <code>0x100000</code>            <code>wrong</code> ,        .          ,     . </p><br><p style=";text-align:right;direction:rtl">         .    <code>z3</code> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> z3 <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> stage2 <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> wrong xor = [<span class="hljs-number"><span class="hljs-number">212</span></span>, <span class="hljs-number"><span class="hljs-number">162</span></span>, <span class="hljs-number"><span class="hljs-number">242</span></span>, <span class="hljs-number"><span class="hljs-number">218</span></span>, <span class="hljs-number"><span class="hljs-number">101</span></span>, <span class="hljs-number"><span class="hljs-number">109</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-number"><span class="hljs-number">31</span></span>, <span class="hljs-number"><span class="hljs-number">125</span></span>, <span class="hljs-number"><span class="hljs-number">112</span></span>, <span class="hljs-number"><span class="hljs-number">249</span></span>, <span class="hljs-number"><span class="hljs-number">83</span></span>, <span class="hljs-number"><span class="hljs-number">55</span></span>, <span class="hljs-number"><span class="hljs-number">187</span></span>, <span class="hljs-number"><span class="hljs-number">131</span></span>, <span class="hljs-number"><span class="hljs-number">206</span></span>] h = list(wrong()) h = [h[i] ^ xor[i] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">16</span></span>)] b = <span class="hljs-number"><span class="hljs-number">16</span></span> * [<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>] x = [] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">16</span></span>): x.append(BitVec(<span class="hljs-string"><span class="hljs-string">'x'</span></span> + str(i), <span class="hljs-number"><span class="hljs-number">32</span></span>)) b[<span class="hljs-number"><span class="hljs-number">0</span></span>] = x[<span class="hljs-number"><span class="hljs-number">2</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">3</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">4</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">8</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">11</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">14</span></span>] b[<span class="hljs-number"><span class="hljs-number">1</span></span>] = x[<span class="hljs-number"><span class="hljs-number">0</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">1</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">8</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">11</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">13</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">14</span></span>] b[<span class="hljs-number"><span class="hljs-number">2</span></span>] = x[<span class="hljs-number"><span class="hljs-number">0</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">1</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">2</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">4</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">5</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">8</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">9</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">10</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">13</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">14</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">15</span></span>] b[<span class="hljs-number"><span class="hljs-number">3</span></span>] = x[<span class="hljs-number"><span class="hljs-number">5</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">6</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">8</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">9</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">10</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">12</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">15</span></span>] b[<span class="hljs-number"><span class="hljs-number">4</span></span>] = x[<span class="hljs-number"><span class="hljs-number">1</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">6</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">7</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">8</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">12</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">13</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">14</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">15</span></span>] b[<span class="hljs-number"><span class="hljs-number">5</span></span>] = x[<span class="hljs-number"><span class="hljs-number">0</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">4</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">7</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">8</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">9</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">10</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">12</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">13</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">14</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">15</span></span>] b[<span class="hljs-number"><span class="hljs-number">6</span></span>] = x[<span class="hljs-number"><span class="hljs-number">1</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">3</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">7</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">9</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">10</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">11</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">12</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">13</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">15</span></span>] b[<span class="hljs-number"><span class="hljs-number">7</span></span>] = x[<span class="hljs-number"><span class="hljs-number">0</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">1</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">2</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">3</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">4</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">8</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">10</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">11</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">14</span></span>] b[<span class="hljs-number"><span class="hljs-number">8</span></span>] = x[<span class="hljs-number"><span class="hljs-number">1</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">2</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">3</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">5</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">9</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">10</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">11</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">12</span></span>] b[<span class="hljs-number"><span class="hljs-number">9</span></span>] = x[<span class="hljs-number"><span class="hljs-number">6</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">7</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">8</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">10</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">11</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">12</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">15</span></span>] b[<span class="hljs-number"><span class="hljs-number">10</span></span>] = x[<span class="hljs-number"><span class="hljs-number">0</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">3</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">4</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">7</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">8</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">10</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">11</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">12</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">13</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">14</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">15</span></span>] b[<span class="hljs-number"><span class="hljs-number">11</span></span>] = x[<span class="hljs-number"><span class="hljs-number">0</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">2</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">4</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">6</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">13</span></span>] b[<span class="hljs-number"><span class="hljs-number">12</span></span>] = x[<span class="hljs-number"><span class="hljs-number">0</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">3</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">6</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">7</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">10</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">12</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">15</span></span>] b[<span class="hljs-number"><span class="hljs-number">13</span></span>] = x[<span class="hljs-number"><span class="hljs-number">2</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">3</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">4</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">5</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">6</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">7</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">11</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">12</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">13</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">14</span></span>] b[<span class="hljs-number"><span class="hljs-number">14</span></span>] = x[<span class="hljs-number"><span class="hljs-number">1</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">2</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">3</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">5</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">7</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">11</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">13</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">14</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">15</span></span>] b[<span class="hljs-number"><span class="hljs-number">15</span></span>] = x[<span class="hljs-number"><span class="hljs-number">1</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">3</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">5</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">9</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">10</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">11</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">13</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">15</span></span>] solver = Solver() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">16</span></span>): solver.add(x[i] &lt; <span class="hljs-number"><span class="hljs-number">128</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">16</span></span>): solver.add(b[i] == h[i]) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> solver.check() == sat: m = solver.model() print(bytes([m[i].as_long() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> x])) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: print(<span class="hljs-string"><span class="hljs-string">'unsat'</span></span>)</code> </pre> <br><p style=";text-align:right;direction:rtl">   ,    : <code>5C0G7TY2LWI2YXMB</code> </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/yp/ox/jh/ypoxjh3rafci2a5-ukpy2uvbgu0.png"></p><br><a name="task08"></a><br><h2 id="0x08---snake" style=";text-align:right;direction:rtl"> 0x08 — snake </h2><br><blockquote style=";text-align:right;direction:rtl"> The Flare team is attempting to pivot to full-time twitch streaming video games instead of reverse engineering computer software all day. We wrote our own classic NES game to stream content that nobody else has seen and watch those subscribers flow in. It turned out to be too hard for us to beat so we gave up. See if you can beat it and capture the internet points that we failed to collect. </blockquote><p style=";text-align:right;direction:rtl">    <code>NES</code> - .       <code>FCEUX</code> , ..      .  ,   . </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/tk/fx/sq/tkfxsqug4puqwqs893v5zceereg.png"></p><br><p style=";text-align:right;direction:rtl">  ,  ,     <code>0x25</code>    .    ,   .     <code>NES</code> -  <code>IDA</code> .      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">inesldr</a> .     <code>0x25</code> .   <code>C82A</code>    ,           .      <code>0x33</code> . </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/uo/2b/h8/uo2bh8iawskqdff-153-964ljwq.png"></p><br><p style=";text-align:right;direction:rtl"> ,     —   <code>0x32</code>   <code>0x25</code>       .     ,    .  , <code>FCEUX</code>    .          . </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/jn/nu/jh/jnnujhs5-fugmpqugrp1z9m7p0o.png"></p><br><a name="task09"></a><br><h2 id="0x09---reloadered" style=";text-align:right;direction:rtl"> 0x09 — reloadered </h2><br><blockquote style=";text-align:right;direction:rtl"> This is a simple challenge, enter the password, receive the key. I hear that it caused problems when trying to analyze it with ghidra. Remember that valid flare-on flags will always end with @flare-on.com </blockquote><p style=";text-align:right;direction:rtl">      <code>reloaderd.exe</code> ,     .    ,     ,     .     ,       ,         <code>XOR</code>    ,     <code>@FLAG.com</code> ,     . </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/ki/ug/mv/kiugmvs_ouxbeziqmqnzjhxgqmu.png"></p><br><p style=";text-align:right;direction:rtl">         ,   <code>NOP</code> .          ,     ,   .          .   ,     .    ,      ,       .   ,      ,     <code>NOP</code> ,      . </p><br><p style=";text-align:right;direction:rtl">        ,      ,      <code>XOR</code>  ,  .      <code>@flare-on.com</code> ,    .            : </p><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs">flag = bytearray(<span class="hljs-string"><span class="hljs-string">b'D)6\n)\x0f\x05\x1be&amp;\x10\x04+h0/\x003/\x05\x1a\x1f\x0f8\x02\x18B\x023\x1a(\x04*G?\x04&amp;dfM\x107&gt;(&gt;w\x1c?~64*\x00'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">0x539</span></span>): <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> j <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">0x34</span></span>): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (i % <span class="hljs-number"><span class="hljs-number">3</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> (i % <span class="hljs-number"><span class="hljs-number">7</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span>: flag[j] ^= (i &amp; <span class="hljs-number"><span class="hljs-number">0xff</span></span>) end = <span class="hljs-string"><span class="hljs-string">b'@flare-on.com'</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">xor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(a, b)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bytes([i^j <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i, j <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> zip(a, b)]) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(len(flag)): print(i, xor(end, flag[i:])) print(xor(flag, <span class="hljs-string"><span class="hljs-string">b'3HeadedMonkey'</span></span>*<span class="hljs-number"><span class="hljs-number">4</span></span>))</code> </pre> <br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/th/qz/9b/thqz9bwdjdkt-a7smd_tb8uncxs.png"></p><br><a name="task10"></a><br><h2 id="0x0a---mugatu" style=";text-align:right;direction:rtl"> 0x0A — Mugatu </h2><br><blockquote style=";text-align:right;direction:rtl"> Hello, <br><br> I'm working an incident response case for Derek Zoolander. He clicked a link and was infected with MugatuWare! As a result, his new headshot compilation GIF was encrypted. <br><br> To secure an upcoming runway show, Derek needs this GIF decrypted; however, he refuses to pay the ransom. <br><br> We received an additional encrypted GIF from an anonymous informant. The informant told us the GIF should help in our decryption efforts, but we were unable to figure it out. <br><br> We're reaching out to you, our best malware analyst, in hopes that you can reverse engineer this malware and decrypt Derek's GIF. <br><br> I've included a directory full of files containing: <br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl"> MugatuWare malware </li><li style=";text-align:right;direction:rtl"> Ransom note (GIFtToDerek.txt) </li><li style=";text-align:right;direction:rtl"> Encrypted headshot GIF (best.gif.Mugatu) </li><li style=";text-align:right;direction:rtl"> Encrypted informant GIF (the_key_to_success_0000.gif.Mugatu) </li></ul><br><br>  شكرا، <br> Roy </blockquote><p style=";text-align:right;direction:rtl">     : </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl"> best.gif.Mugatu </li><li style=";text-align:right;direction:rtl"> GIFtToDerek.txt </li><li style=";text-align:right;direction:rtl"> Mugatuware.exe </li><li style=";text-align:right;direction:rtl"> the_key_to_success_0000.gif.Mugatu </li></ul><br><p style=";text-align:right;direction:rtl">   ,    ,   <code>GIF</code> -. ,      <code>.Mugatu</code> .      <code>Mugatuware.exe</code> . ,     —           .    ,      ,   . </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/no/au/se/noauseew8d2jezeoaqj9kd-pp9e.png"></p><br><p style=";text-align:right;direction:rtl">        <code>IDA</code> ,     : </p><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ida_segment <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ida_name <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ida_bytes <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ida_typeinf idata = ida_segment.get_segm_by_name(<span class="hljs-string"><span class="hljs-string">'.idata'</span></span>) type_map = {} <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> addr <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(idata.start_ea, idata.end_ea, <span class="hljs-number"><span class="hljs-number">4</span></span>): name = ida_name.get_name(addr) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> name: tp = ida_typeinf.idc_get_type(addr) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> tp: type_map[name] = tp <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> addr <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(idata.start_ea, idata.end_ea, <span class="hljs-number"><span class="hljs-number">4</span></span>): imp = ida_bytes.get_dword(addr) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> imp != <span class="hljs-number"><span class="hljs-number">0</span></span>: imp_name = ida_name.get_name(imp) name_part = imp_name.split(<span class="hljs-string"><span class="hljs-string">'_'</span></span>)[<span class="hljs-number"><span class="hljs-number">-1</span></span>] ida_name.set_name(addr, name_part + <span class="hljs-string"><span class="hljs-string">'_imp'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> name_part <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> type_map: tp = type_map[name_part] ida_typeinf.apply_decl(addr, tp.replace(<span class="hljs-string"><span class="hljs-string">'('</span></span>, <span class="hljs-string"><span class="hljs-string">'func('</span></span>) + <span class="hljs-string"><span class="hljs-string">';'</span></span>)</code> </pre> <br><p style=";text-align:right;direction:rtl">        : </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/f-/cl/ad/f-cladmcmadtfx1v9bdhjhobt28.png"></p><br><p style=";text-align:right;direction:rtl">   ,        ,     <code>in-memory</code>  <code>PE</code> -.           ,        <code>CrazyPills!!!</code>  .     ,      .       <code>Sleep</code> ,      <code>http</code> -.    ,     ,      ,        .   ,          ,    ,     .    . </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/np/pq/5q/nppq5qbcpyirk9xgamtl0wh89h0.png"></p><br><p style=";text-align:right;direction:rtl">  -         : </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">         ; </li><li style=";text-align:right;direction:rtl">   ; </li><li style=";text-align:right;direction:rtl">           <code>Mailslots</code> ; </li><li style=";text-align:right;direction:rtl">        <code>really, really, really, ridiculously good looking gifs</code> ; </li><li style=";text-align:right;direction:rtl">         <code>.gif</code> .      <code>.Mugatu</code> .      <code>GIFtToDerek.txt</code>   . </li></ul><br><p style=";text-align:right;direction:rtl">  ,   — 8 .          <code>XOR</code>     <code>CrazyPills!!!</code> ,        .  ,        : </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/bm/em/6u/bmem6uqdty4xdugfaxuz0j9efuw.png"></p><br><p style=";text-align:right;direction:rtl">     <code>XTEA</code> ,    —     <code>BYTE</code> ,    <code>DWORD</code> .           .         <code>Python</code> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">crypt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(a, b, key)</span></span></span><span class="hljs-function">:</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> _ <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">32</span></span>): t = (i + key[i &amp; <span class="hljs-number"><span class="hljs-number">3</span></span>]) &amp; <span class="hljs-number"><span class="hljs-number">0xffffffff</span></span> a = (a + (t ^ (b + ((b &gt;&gt; <span class="hljs-number"><span class="hljs-number">5</span></span>) ^ (b &lt;&lt; <span class="hljs-number"><span class="hljs-number">4</span></span>))))) &amp; <span class="hljs-number"><span class="hljs-number">0xffffffff</span></span> i = (<span class="hljs-number"><span class="hljs-number">0x100000000</span></span> + i - <span class="hljs-number"><span class="hljs-number">0x61C88647</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0xffffffff</span></span> t = (i + key[(i &gt;&gt; <span class="hljs-number"><span class="hljs-number">11</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">3</span></span>]) &amp; <span class="hljs-number"><span class="hljs-number">0xffffffff</span></span> b = (b + (t ^ (a + ((a &gt;&gt; <span class="hljs-number"><span class="hljs-number">5</span></span>) ^ (a &lt;&lt; <span class="hljs-number"><span class="hljs-number">4</span></span>))))) &amp; <span class="hljs-number"><span class="hljs-number">0xffffffff</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a, b <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">decrypt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(a, b, key)</span></span></span><span class="hljs-function">:</span></span> i = <span class="hljs-number"><span class="hljs-number">0xc6ef3720</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> _ <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">32</span></span>): t = (i + key[(i &gt;&gt; <span class="hljs-number"><span class="hljs-number">11</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">3</span></span>]) &amp; <span class="hljs-number"><span class="hljs-number">0xffffffff</span></span> b = (<span class="hljs-number"><span class="hljs-number">0x100000000</span></span> + b - (t ^ (a + ((a &gt;&gt; <span class="hljs-number"><span class="hljs-number">5</span></span>) ^ (a &lt;&lt; <span class="hljs-number"><span class="hljs-number">4</span></span>))))) &amp; <span class="hljs-number"><span class="hljs-number">0xffffffff</span></span> i = (i + <span class="hljs-number"><span class="hljs-number">0x61C88647</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0xffffffff</span></span> t = (i + key[i &amp; <span class="hljs-number"><span class="hljs-number">3</span></span>]) &amp; <span class="hljs-number"><span class="hljs-number">0xffffffff</span></span> a = (<span class="hljs-number"><span class="hljs-number">0x100000000</span></span> + a - (t ^ (b + ((b &gt;&gt; <span class="hljs-number"><span class="hljs-number">5</span></span>) ^ (b &lt;&lt; <span class="hljs-number"><span class="hljs-number">4</span></span>))))) &amp; <span class="hljs-number"><span class="hljs-number">0xffffffff</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a, b</code> </pre><br><p style=";text-align:right;direction:rtl">  ,  <code>the_key_to_success_0000.gif.Mugatu</code>     .        ,     .     : </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/lm/bb/jl/lmbbjl90qtlexwxwtywt6wbh09i.gif"></p><br><p style=";text-align:right;direction:rtl">  ,        ,        .        <code>C</code> .     <code>GIF</code> -. </p><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; #include &lt;unistd.h&gt; void decrypt(unsigned int * inp, unsigned int * outp, unsigned char * key) { unsigned int i = 0xc6ef3720; unsigned int a = inp[0]; unsigned int b = inp[1]; unsigned int t; for(int j = 0; j &lt; 32; j++) { t = i + key[(i &gt;&gt; 11) &amp; 3]; b -= t ^ (a + ((a &gt;&gt; 5) ^ (a &lt;&lt; 4))); i += 0x61C88647; t = i + key[i &amp; 3]; a -= t ^ (b + ((b &gt;&gt; 5) ^ (b &lt;&lt; 4))); } outp[0] = a; outp[1] = b; } int main() { int fd = open("best.gif.Mugatu", 0); unsigned int inp[2]; unsigned int outp[2]; unsigned int key = 0; read(fd, inp, 8); close(fd); for(unsigned long long key = 0; key &lt; 0x100000000; key++) { if((key &amp; 0xffffff) == 0) { printf("%lf\n", ((double)key) / ((double)0x100000000) * 100.0); } decrypt(inp, outp, &amp;key); if( ((char *)outp)[0] == 'G' &amp;&amp; ((char *)outp)[1] == 'I' &amp;&amp; ((char *)outp)[2] == 'F' &amp;&amp; ((char *)outp)[5] == 'a') { printf("%#llx\n", key); } } }</span></span></span></span></code> </pre> <br><p style=";text-align:right;direction:rtl">        <code>0xb1357331</code>      : </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/cw/s5/fz/cws5fzu68wbv5mf-myteh-o8uqk.gif"></p><br><a name="task11"></a><br><h2 id="0x0b---vv_max" style=";text-align:right;direction:rtl"> 0x0B — vv_max </h2><br><blockquote style=";text-align:right;direction:rtl"> Hey, at least its not subleq. </blockquote><p style=";text-align:right;direction:rtl">     <code>vv_max.exe</code> ,      .          256-     .       <code>AVX2</code> ,   <code>vpermd</code> , <code>vpslld</code>  .    -    : </p><br><div class="spoiler" style=";text-align:right;direction:rtl"> <b class="spoiler_title">  </b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">0000 clear_regs 0001 r0 = 393130324552414c46 0023 r1 = 3030303030303030303030303030303030303030303030303030303030303030 0045 r3 = 1a1b1b1b1a13111111111111111111151a1b1b1b1a1311111111111111111115 0067 r4 = 1010101010101010080408040201101010101010101010100804080402011010 0089 r5 = b9b9bfbf041310000000000000000000b9b9bfbf04131000 00ab r6 = 2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f 00cd r10 = 140014001400140014001400140014001400140014001400140014001400140 00ef r11 = 1100000011000000110000001100000011000000110000001100000011000 0111 r12 = ffffffff0c0d0e08090a040506000102ffffffff0c0d0e08090a040506000102 0133 r13 = ffffffffffffffff000000060000000500000004000000020000000100000000 0155 r16 = ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff 0177 r17 = 6a09e667bb67ae853c6ef372a54ff53a510e527f9b05688c1f83d9ab5be0cd19 0199 r18 = 428a2f9871374491b5c0fbcfe9b5dba53956c25b59f111f1923f82a4ab1c5ed5 01bb r19 = 300000002000000010000000000000007000000060000000500000004 01dd r20 = 0 01ff r21 = 100000001000000010000000100000001000000010000000100000001 0221 r22 = 200000002000000020000000200000002000000020000000200000002 0243 r23 = 300000003000000030000000300000003000000030000000300000003 0265 r24 = 400000004000000040000000400000004000000040000000400000004 0287 r25 = 500000005000000050000000500000005000000050000000500000005 02a9 r26 = 600000006000000060000000600000006000000060000000600000006 02cb r27 = 700000007000000070000000700000007000000070000000700000007 02ed r20 = vpermd(r0, r20) 02f1 r21 = vpermd(r0, r21) 02f5 r22 = vpermd(r0, r22) 02f9 r23 = vpermd(r0, r23) 02fd r24 = vpermd(r0, r24) 0301 r25 = vpermd(r0, r25) 0305 r26 = vpermd(r0, r26) 0309 r27 = vpermd(r0, r27) 030d r7 = vpsrld(r1, 4) 0311 r28 = r20 ^ r21 0315 r28 = r28 ^ r22 0319 r28 = r28 ^ r23 031d r28 = r28 ^ r24 0321 r28 = r28 ^ r25 0325 r28 = r28 ^ r26 0329 r28 = r28 ^ r27 032d r7 = r7 &amp; r6 0331 r29 = vpslld(r17, 7) 0335 r30 = vpsrld(r17, 25) 0339 r15 = r29 | r30 033d r8 = vpcmpeqb(r1, r6) 0341 r29 = vpslld(r17, 21) 0345 r30 = vpsrld(r17, 11) 0349 r29 = r29 | r30 034d r15 = r15 ^ r29 0351 r8 = vpcmpeqb(r1, r6) 0355 r29 = vpslld(r17, 26) 0359 r30 = vpsrld(r17, 6) 035d r29 = r29 | r30 0361 r15 = r15 ^ r29 0365 r29 = r20 ^ r16 0369 r30 = r20 &amp; r18 036d r29 = r29 ^ r30 0371 r15 = add_d(r29, r15) 0375 r20 = add_d(r15, r0) 0379 r7 = add_b(r8, r7) 037d r29 = r20 ^ r28 0381 r17 = vpermd(r29, r19) 0385 r7 = vpshufb(r5, r7) 0389 r29 = vpslld(r17, 7) 038d r30 = vpsrld(r17, 25) 0391 r15 = r29 | r30 0395 r29 = vpslld(r17, 21) 0399 r30 = vpsrld(r17, 11) 039d r29 = r29 | r30 03a1 r15 = r15 ^ r29 03a5 r29 = vpslld(r17, 26) 03a9 r30 = vpsrld(r17, 6) 03ad r29 = r29 | r30 03b1 r15 = r15 ^ r29 03b5 r2 = add_b(r1, r7) 03b9 r29 = r21 ^ r16 03bd r30 = r21 &amp; r18 03c1 r29 = r29 ^ r30 03c5 r15 = add_d(r29, r15) 03c9 r21 = add_d(r15, r0) 03cd r29 = r21 ^ r28 03d1 r17 = vpermd(r29, r19) 03d5 r20 = r20 ^ r21 03d9 r29 = vpslld(r17, 7) 03dd r30 = vpsrld(r17, 25) 03e1 r15 = r29 | r30 03e5 r29 = vpslld(r17, 21) 03e9 r30 = vpsrld(r17, 11) 03ed r29 = r29 | r30 03f1 r15 = r15 ^ r29 03f5 r29 = vpslld(r17, 26) 03f9 r30 = vpsrld(r17, 6) 03fd r29 = r29 | r30 0401 r15 = r15 ^ r29 0405 r7 = vpmaddubsw(r2, r10) 0409 r29 = r22 ^ r16 040d r30 = r22 &amp; r18 0411 r29 = r29 ^ r30 0415 r15 = add_d(r29, r15) 0419 r22 = add_d(r15, r0) 041d r29 = r22 ^ r28 0421 r17 = vpermd(r29, r19) 0425 r20 = r20 ^ r22 0429 r29 = vpslld(r17, 7) 042d r30 = vpsrld(r17, 25) 0431 r15 = r29 | r30 0435 r29 = vpslld(r17, 21) 0439 r30 = vpsrld(r17, 11) 043d r29 = r29 | r30 0441 r15 = r15 ^ r29 0445 r29 = vpslld(r17, 26) 0449 r30 = vpsrld(r17, 6) 044d r29 = r29 | r30 0451 r15 = r15 ^ r29 0455 r2 = vpmaddwd(r7, r11) 0459 r29 = r23 ^ r16 045d r30 = r23 &amp; r18 0461 r29 = r29 ^ r30 0465 r15 = add_d(r29, r15) 0469 r23 = add_d(r15, r0) 046d r29 = r23 ^ r28 0471 r17 = vpermd(r29, r19) 0475 r20 = r20 ^ r23 0479 r29 = vpslld(r17, 7) 047d r30 = vpsrld(r17, 25) 0481 r15 = r29 | r30 0485 r29 = vpslld(r17, 21) 0489 r30 = vpsrld(r17, 11) 048d r29 = r29 | r30 0491 r15 = r15 ^ r29 0495 r29 = vpslld(r17, 26) 0499 r30 = vpsrld(r17, 6) 049d r29 = r29 | r30 04a1 r15 = r15 ^ r29 04a5 r29 = r24 ^ r16 04a9 r30 = r24 &amp; r18 04ad r29 = r29 ^ r30 04b1 r15 = add_d(r29, r15) 04b5 r24 = add_d(r15, r0) 04b9 r29 = r24 ^ r28 04bd r17 = vpermd(r29, r19) 04c1 r20 = r20 ^ r24 04c5 r29 = vpslld(r17, 7) 04c9 r30 = vpsrld(r17, 25) 04cd r15 = r29 | r30 04d1 r29 = vpslld(r17, 21) 04d5 r30 = vpsrld(r17, 11) 04d9 r29 = r29 | r30 04dd r15 = r15 ^ r29 04e1 r29 = vpslld(r17, 26) 04e5 r30 = vpsrld(r17, 6) 04e9 r29 = r29 | r30 04ed r15 = r15 ^ r29 04f1 r29 = r25 ^ r16 04f5 r30 = r25 &amp; r18 04f9 r29 = r29 ^ r30 04fd r15 = add_d(r29, r15) 0501 r25 = add_d(r15, r0) 0505 r29 = r25 ^ r28 0509 r17 = vpermd(r29, r19) 050d r20 = r20 ^ r25 0511 r2 = vpshufb(r2, r12) 0515 r29 = vpslld(r17, 7) 0519 r30 = vpsrld(r17, 25) 051d r15 = r29 | r30 0521 r29 = vpslld(r17, 21) 0525 r30 = vpsrld(r17, 11) 0529 r29 = r29 | r30 052d r15 = r15 ^ r29 0531 r29 = vpslld(r17, 26) 0535 r30 = vpsrld(r17, 6) 0539 r29 = r29 | r30 053d r15 = r15 ^ r29 0541 r29 = r26 ^ r16 0545 r30 = r26 &amp; r18 0549 r29 = r29 ^ r30 054d r15 = add_d(r29, r15) 0551 r26 = add_d(r15, r0) 0555 r29 = r26 ^ r28 0559 r17 = vpermd(r29, r19) 055d r20 = r20 ^ r26 0561 r29 = vpslld(r17, 7) 0565 r30 = vpsrld(r17, 25) 0569 r15 = r29 | r30 056d r29 = vpslld(r17, 21) 0571 r30 = vpsrld(r17, 11) 0575 r29 = r29 | r30 0579 r15 = r15 ^ r29 057d r29 = vpslld(r17, 26) 0581 r30 = vpsrld(r17, 6) 0585 r29 = r29 | r30 0589 r15 = r15 ^ r29 058d r2 = vpermd(r2, r13) 0591 r29 = r27 ^ r16 0595 r30 = r27 &amp; r18 0599 r29 = r29 ^ r30 059d r15 = add_d(r29, r15) 05a1 r27 = add_d(r15, r0) 05a5 r29 = r27 ^ r28 05a9 r17 = vpermd(r29, r19) 05ad r20 = r20 ^ r27 05b1 r19 = ffffffffffffffffffffffffffffffffffffffffffffffff 05d3 r20 = r20 &amp; r19 05d7 r31 = 2176620c3a5c0f290b583618734f07102e332623780e59150c05172d4b1b1e22</code> </pre> </div></div><br><p style=";text-align:right;direction:rtl">             <code>FLARE2019</code> .        ,     ,    .  ,      <code>FLARE2019</code> .    <code>r2</code>  <code>r20</code> .     ,   <code>r20</code>      .     <code>r2</code>  —      6  <code>r2</code> .           ,   6       .     <code>Frida</code> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># vvmax.py from __future__ import print_function import frida import string import hexdump def check(val): global gdata with open('vvmax.js', 'r') as f: script_src = f.read() pid = frida.spawn(['vv_max.exe', 'FLARE2019', val.ljust(32, 'a')]) session = frida.attach(pid) script = session.create_script(script_src) def handler(message, data): handler.data = data script.on('message', handler) script.load() frida.resume(pid) while not hasattr(handler, 'data'): pass session.detach() return handler.data alph = string.printable def to_bits(x): return ''.join(bin(ord(i))[2:].zfill(8) for i in x) target = to_bits('pp\xb2\xac\x01\xd2^a\n\xa7*\xa8\x08\x1c\x86\x1a\xe8E\xc8)\xb2\xf3\xa1\x1e\x00\x00\x00\x00\x00\x00\x00\x00') password = '' while len(password) != 32: for c in alph: data = to_bits(check(password + c)) i = 6*len(password + c) if data[:i] == target[:i]: password += c i += 1 break print() print('-----&gt;', `password`) print()</span></span></code> </pre> <br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">// vvmax.js var modules = Process.enumerateModules(); var base = modules[0].base; Interceptor.attach(base.add(0x1665), function() { var p = this.context.rdx.add(0x840); var res = p.readByteArray(32); send(null, res); });</code> </pre> <br><p style=";text-align:right;direction:rtl">        : </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/wo/d7/xp/wod7xpefz_k328dmgnuvnmy7ifi.png"></p><br><a name="task12"></a><br><h2 id="0x0c---help" style=";text-align:right;direction:rtl"> 0x0C — help </h2><br><blockquote style=";text-align:right;direction:rtl"> You're my only hope FLARE-On player! One of our developers was hacked and we're not sure what they took. We managed to set up a packet capture on the network once we found out but they were definitely already on the system. I think whatever they installed must be buggy — it looks like they crashed our developer box. We saved off the dump file but I can't make heads or tails of it — PLEASE HELP!!!!!! </blockquote><p style=";text-align:right;direction:rtl">       .      <code>RAM</code> -    .       <code>4444</code> , <code>6666</code> , <code>7777</code>  <code>8888</code> .   ,   , ,    <code>RAM</code> -.      <code>volatility</code> .           <code>volatility</code>   <code>Win10x64_15063</code> ,    ,     <code>Win7SP1x64</code> ,        . </p><br><p style=";text-align:right;direction:rtl">      <code>volatility</code>       : </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">$ volatility --profile Win7SP1x64 -f help.dmp modules Volatility Foundation Volatility Framework 2.6 Offset(V) Name Base Size File ------------------ -------------------- ------------------ ------------------ ---- 0xfffffa800183e890 ntoskrnl.exe 0xfffff80002a49000 0x5e7000 \SystemRoot\system32\ntoskrnl.exe ... 0xfffffa800428ff30 man.sys 0xfffff880033bc000 0xf000 \??\C:\Users\FLARE ON 2019\Desktop\man.sys</code> </pre> <br><p style=";text-align:right;direction:rtl">     : </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">$ volatility --profile Win7SP1x64 -f help.dmp moddump --base 0xfffff880033bc000 -D drivers Volatility Foundation Volatility Framework 2.6 Module Base Module Name Result ------------------ -------------------- ------ 0xfffff880033bc000 man.sys Error: e_magic 0000 is not a valid DOS signature.</code> </pre> <br><p style=";text-align:right;direction:rtl"> ,   .       <code>volshell</code>    . </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">$ volatility --profile Win7SP1x64 -f help.dmp volshell In [1]: db(0xfffff880033bc000) 0xfffff880033bc000 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 0xfffff880033bc010 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 0xfffff880033bc020 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 0xfffff880033bc030 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 0xfffff880033bc040 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 0xfffff880033bc050 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 0xfffff880033bc060 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 0xfffff880033bc070 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ In [2]: db(0xfffff880033bc000 + 0x1100) 0xfffff880033bd100 01 48 8b 4c 24 20 48 8b 44 24 28 48 89 41 08 48 .HL$.HD$(HAH 0xfffff880033bd110 83 c4 18 c3 cc cc cc cc cc cc cc cc cc cc cc cc ................ 0xfffff880033bd120 48 89 4c 24 08 48 83 ec 38 48 8b 44 24 40 0f be HL$.H..8H.D$@.. 0xfffff880033bd130 48 43 48 8b 44 24 40 0f be 40 42 83 c0 01 3b c8 HCH.D$@..@B...;. 0xfffff880033bd140 7e 27 45 33 c9 41 b8 15 5b 00 00 48 8d 15 de 44 ~'E3.A..[..H...D 0xfffff880033bd150 00 00 48 8d 0d 07 45 00 00 ff 15 71 4f 00 00 c7 ..H...E....qO... 0xfffff880033bd160 44 24 20 00 00 00 00 eb 08 c7 44 24 20 01 00 00 D$........D$.... 0xfffff880033bd170 00 48 8b 44 24 40 48 8b 80 b8 00 00 00 48 83 c4 .HD$@H......H.. In [4]: man = addrspace().read(0xfffff880033bc000, 0xf000) In [5]: with open('man_writeup.sys', 'wb') as f: ...: f.write(man) ...:</code> </pre> <br><p style=";text-align:right;direction:rtl"> ,    ,   <code>moddump</code>  .   .      .  -    ,   ,      . </p><br><p style=";text-align:right;direction:rtl">           <code>RC4</code>   .          ,        . </p><br><p style=";text-align:right;direction:rtl">             <code>user-space</code> .      <code>DLL</code> -   .          <code>DLL</code> - ( <code>m.dll</code> ),    .         ,                 .          : </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">      ( <code>+0x8</code> ) </li><li style=";text-align:right;direction:rtl">   <code>_EPROCESS</code>   ( <code>+0x68</code> ) </li><li style=";text-align:right;direction:rtl">     ( <code>+0x48</code> ) </li><li style=";text-align:right;direction:rtl">   ( <code>+0x58</code> ) </li></ul><br><p style=";text-align:right;direction:rtl">  <code>DLL</code> -           <code>RC4</code> ,       <code>0x2c</code> -   ,    <code>0x48</code> . </p><br><p style=";text-align:right;direction:rtl">      <code>volatility</code>      <code>volshell</code> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> struct <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> Crypto.Cipher <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ARC4 head = <span class="hljs-number"><span class="hljs-number">0xfffff880033c8158</span></span> krnl = addrspace() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">u64</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(x)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> struct.unpack(<span class="hljs-string"><span class="hljs-string">'Q'</span></span>, x)[<span class="hljs-number"><span class="hljs-number">0</span></span>] fd = u64(krnl.read(head, <span class="hljs-number"><span class="hljs-number">8</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: proc_addr = u64(krnl.read(fd + <span class="hljs-number"><span class="hljs-number">0x68</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>)) base = u64(krnl.read(fd + <span class="hljs-number"><span class="hljs-number">0x48</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>)) key = krnl.read(fd + <span class="hljs-number"><span class="hljs-number">0x48</span></span>, <span class="hljs-number"><span class="hljs-number">0x2c</span></span>) sz = u64(krnl.read(fd + <span class="hljs-number"><span class="hljs-number">0x58</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>)) fd = u64(krnl.read(fd, <span class="hljs-number"><span class="hljs-number">8</span></span>)) p = obj.Object(<span class="hljs-string"><span class="hljs-string">'_EPROCESS'</span></span>, proc_addr, krnl) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> p.ImageFileName.v(), hex(proc_addr), hex(base), hex(sz) proc_space = p.get_process_address_space() dump = proc_space.read(base, sz) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> dump[:<span class="hljs-number"><span class="hljs-number">0x100</span></span>] == <span class="hljs-string"><span class="hljs-string">'\x00'</span></span> * <span class="hljs-number"><span class="hljs-number">0x100</span></span>: dump = ARC4.new(key).decrypt(dump) <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">'proc_{:016x}'</span></span>.format(base), <span class="hljs-string"><span class="hljs-string">'wb'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: f.write(dump) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> fd == head: <span class="hljs-keyword"><span class="hljs-keyword">break</span></span></code> </pre> <br><p style=";text-align:right;direction:rtl">   ,  ,            <code>RC4</code> .         <code>IDA</code> ,   ,         : </p><br><div class="spoiler" style=";text-align:right;direction:rtl"> <b class="spoiler_title">  IDA</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> __future__ <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> print_function <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sys <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> re <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> idaapi <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> get_func, decompile, get_name_ea, auto_wait, BADADDR <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> idaapi <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> cot_call, cot_obj, init_hexrays_plugin, qexit <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ida_typeinf <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ida_lines <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rc4</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(key, data)</span></span></span><span class="hljs-function">:</span></span> S = list(range(<span class="hljs-number"><span class="hljs-number">256</span></span>)) j = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> list(range(<span class="hljs-number"><span class="hljs-number">256</span></span>)): j = (j + S[i] + ord(key[i % len(key)])) % <span class="hljs-number"><span class="hljs-number">256</span></span> S[i], S[j] = S[j], S[i] j = <span class="hljs-number"><span class="hljs-number">0</span></span> y = <span class="hljs-number"><span class="hljs-number">0</span></span> out = [] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> char <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> data: j = (j + <span class="hljs-number"><span class="hljs-number">1</span></span>) % <span class="hljs-number"><span class="hljs-number">256</span></span> y = (y + S[j]) % <span class="hljs-number"><span class="hljs-number">256</span></span> S[j], S[y] = S[y], S[j] out.append(chr(ord(char) ^ S[(S[j] + S[y]) % <span class="hljs-number"><span class="hljs-number">256</span></span>])) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span>.join(out) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">decrypt_stack_str_args</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ea)</span></span></span><span class="hljs-function">:</span></span> func = get_func(ea) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> func <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: c_func = decompile(func) c_func.pseudocode <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> Exception <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ex: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> citem <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> c_func.treeitems: citem = citem.to_specific_type <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> citem.is_expr() <span class="hljs-keyword"><span class="hljs-keyword">and</span></span>\ citem.op == cot_call <span class="hljs-keyword"><span class="hljs-keyword">and</span></span>\ citem.ea == ea: args = [] key = citem.a[<span class="hljs-number"><span class="hljs-number">0</span></span>] key_len = citem.a[<span class="hljs-number"><span class="hljs-number">1</span></span>] s = citem.a[<span class="hljs-number"><span class="hljs-number">2</span></span>] s_len = citem.a[<span class="hljs-number"><span class="hljs-number">3</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_var_idx</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(obj)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> obj.opname != <span class="hljs-string"><span class="hljs-string">'var'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> obj.opname <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> (<span class="hljs-string"><span class="hljs-string">'ref'</span></span>, <span class="hljs-string"><span class="hljs-string">'cast'</span></span>): obj = obj.x <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> Exception(<span class="hljs-string"><span class="hljs-string">'can\'t find type'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> obj.v.idx <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> key_len.opname != <span class="hljs-string"><span class="hljs-string">'num'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> s_len.opname != <span class="hljs-string"><span class="hljs-string">'num'</span></span>: print(<span class="hljs-string"><span class="hljs-string">'[!] can\'t get length: 0x{:08x}'</span></span>.format(ea)) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: key_len_val = key_len.n._value s_len_val = s_len.n._value print(<span class="hljs-string"><span class="hljs-string">'0x{:08x}'</span></span>.format(ea), <span class="hljs-string"><span class="hljs-string">'key_len ='</span></span>, key_len_val, <span class="hljs-string"><span class="hljs-string">', s_len ='</span></span>, s_len_val) hx_view = idaapi.open_pseudocode(ea, <span class="hljs-number"><span class="hljs-number">-1</span></span>) key_var_stkoff = hx_view.cfunc.get_lvars()[get_var_idx(key)].location.stkoff() s_var_stkoff = hx_view.cfunc.get_lvars()[get_var_idx(s)].location.stkoff() key_var = [v <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> v <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> hx_view.cfunc.get_lvars() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> v.location.stkoff() == key_var_stkoff][<span class="hljs-number"><span class="hljs-number">0</span></span>] tif = ida_typeinf.tinfo_t() ida_typeinf.parse_decl(tif, <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, <span class="hljs-string"><span class="hljs-string">'unsigned __int8 [{}];'</span></span>.format(key_len_val), <span class="hljs-number"><span class="hljs-number">0</span></span>) hx_view.set_lvar_type(key_var, tif) s_var = [v <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> v <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> hx_view.cfunc.get_lvars() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> v.location.stkoff() == s_var_stkoff][<span class="hljs-number"><span class="hljs-number">0</span></span>] tif = ida_typeinf.tinfo_t() ida_typeinf.parse_decl(tif, <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, <span class="hljs-string"><span class="hljs-string">'unsigned __int8 [{}];'</span></span>.format(s_len_val + <span class="hljs-number"><span class="hljs-number">1</span></span>), <span class="hljs-number"><span class="hljs-number">0</span></span>) hx_view.set_lvar_type(s_var, tif) key_var = [v <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> v <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> hx_view.cfunc.get_lvars() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> v.location.stkoff() == key_var_stkoff][<span class="hljs-number"><span class="hljs-number">0</span></span>] s_var = [v <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> v <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> hx_view.cfunc.get_lvars() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> v.location.stkoff() == s_var_stkoff][<span class="hljs-number"><span class="hljs-number">0</span></span>] key_regex = re.compile(<span class="hljs-string"><span class="hljs-string">'{}\[(.+)\] = (.+);'</span></span>.format(key_var.name)) s_regex = re.compile(<span class="hljs-string"><span class="hljs-string">'{}\[(.+)\] = (.+);'</span></span>.format(s_var.name)) key = bytearray(key_len_val) s = bytearray(s_len_val + <span class="hljs-number"><span class="hljs-number">1</span></span>) src = <span class="hljs-string"><span class="hljs-string">'\n'</span></span>.join([ida_lines.tag_remove(i.line) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> hx_view.cfunc.pseudocode]) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i, j <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> s_regex.findall(src): s[int(i)] = (<span class="hljs-number"><span class="hljs-number">0x100</span></span> + int(j)) &amp; <span class="hljs-number"><span class="hljs-number">0xff</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i, j <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> key_regex.findall(src): key[int(i)] = (<span class="hljs-number"><span class="hljs-number">0x100</span></span> + int(j)) &amp; <span class="hljs-number"><span class="hljs-number">0xff</span></span> key = <span class="hljs-string"><span class="hljs-string">''</span></span>.join(chr(i) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> key) s = <span class="hljs-string"><span class="hljs-string">''</span></span>.join(chr(i) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> s) result = rc4(key, s[:<span class="hljs-number"><span class="hljs-number">-1</span></span>]) <span class="hljs-comment"><span class="hljs-comment"># unicode to ascii if set(ord(i) for i in result[1::2]) == {0}: result = 'wide_' + ''.join(result[0::2]) hx_view.rename_lvar(s_var, 's_' + result, True) except Exception as ex: print('[!] error: {}'.format(ex)) print('#### decryption helper script ####') xref_to = get_name_ea(BADADDR, 'decrypt_stack_str') xref_from = get_first_cref_to(xref_to) while xref_from != BADADDR: print('### 0x{:08x}'.format(xref_from)) decrypt_stack_str_args(xref_from) xref_from = get_next_cref_to(xref_to, xref_from)</span></span></code> </pre> </div></div><br><p style=";text-align:right;direction:rtl">    : </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/v9/xx/cg/v9xxcgdktosjrdfyg8ohucbha6g.png"></p><br><p style=";text-align:right;direction:rtl">      .       : </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl"> <code>m.dll</code> — ,    .   <code>4444</code>   .   —           ; </li><li style=";text-align:right;direction:rtl"> <code>n.dll</code> —         <code>192.168.1.243</code> ; </li><li style=";text-align:right;direction:rtl"> <code>c.dll</code> —          <code>RC4</code> .       ; </li><li style=";text-align:right;direction:rtl"> <code>k.dll</code> —            (keylogger); </li><li style=";text-align:right;direction:rtl"> <code>s.dll</code> —       ; </li><li style=";text-align:right;direction:rtl"> <code>f.dll</code> —       . </li></ul><br><p style=";text-align:right;direction:rtl">      ,       <code>XOR</code>    8.      <code>4444</code>       , ..       .       :    ,       —      . ,   -   . </p><br><p style=";text-align:right;direction:rtl">    ( <code>4444</code> )     . ,     -   .       ,      .            : </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl"> keys.kdb </li><li style=";text-align:right;direction:rtl"> C:\ </li><li style=";text-align:right;direction:rtl"> C:\keypass\keys.kdb </li></ul><br><p style=";text-align:right;direction:rtl"> ,        <code>f.dll</code> :       <code>keys.kdb</code> ,      . </p><br><p style=";text-align:right;direction:rtl">     <code>6666</code>     .      <code>LZNT1</code>     <code>RC4</code>  <code>XOR</code> .   ,  <code>XOR</code> -  , ..       .   <code>RC4</code>    ,     <code>RAM</code> -: <code>FLARE ON 2019</code> .  ,   <code>GetUserNameA</code> ,        ,            -   ,      <code>RC4</code> .      <code>LZNT1</code>     : </p><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ctypes <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * nt = windll.ntdll <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> fname <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> [<span class="hljs-string"><span class="hljs-string">'input'</span></span>]: <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(fname, <span class="hljs-string"><span class="hljs-string">'rb'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: buf = f.read() dec_data = create_string_buffer(<span class="hljs-number"><span class="hljs-number">0x10000</span></span>) final_size = c_ulong(<span class="hljs-number"><span class="hljs-number">0</span></span>) status = nt.RtlDecompressBuffer( <span class="hljs-number"><span class="hljs-number">0x102</span></span>, <span class="hljs-comment"><span class="hljs-comment"># COMPRESSION_FORMAT_LZNT1 dec_data, # UncompressedBuffer 0x10000, # UncompressedBufferSize c_char_p(buf), # CompressedBuffer 0xFFFFFF, # CompressedBufferSize byref(final_size) # FinalUncompressedSize ) with open(fname + '.uncompressed', 'wb') as f: f.write(dec_data.raw[:final_size.value])</span></span></code> </pre> <br><p style=";text-align:right;direction:rtl">         <code>6666</code> .    : </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">00000000: CC 69 94 FA 6A 37 18 29 CB 8D 87 EF 11 63 8E 73 .i..j7.).....cs 00000010: FE AB 43 3B B3 94 28 4B 4D 19 00 00 00 4F DB C7 ..C;..(KM....O.. 00000020: F3 1E E4 13 15 34 8F 51 A9 2B C2 D7 C1 96 78 F7 .....4.Q.+....x. 00000030: 91 98</code> </pre> <br><p style=";text-align:right;direction:rtl">     ,  : </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">00000000: 19 00 00 00 4F DB C7 F3 1E E4 13 15 34 8F 51 A9 ....O.......4.Q. 00000010: 2B C2 D7 C1 96 78 F7 91 98 +....x...</code> </pre> <br><p style=";text-align:right;direction:rtl">  4   —    ,     25.   : </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">00000000: 12 B0 00 43 3A 5C 6B 65 79 70 61 04 73 73 01 70 ...C:\keypa.ss.p 00000010: 73 2E 6B 64 62 s.kdb</code> </pre> <br><p style=";text-align:right;direction:rtl">        <code>C:\keypass\keys.kdb</code> .   ,      ,     .      <code>6666</code>     —      <code>KeePass</code> . </p><br><p style=";text-align:right;direction:rtl">     <code>7777</code>        <code>BMP</code> .       <code>XOR</code> ,   ,     , ..          .       ,   ,    <code>KeePass</code> . </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/3h/wg/ud/3hwgud3zz5s77zqiv2siwqjexve.png"></p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/su/u2/dl/suu2dlwj1a8sqd5nq0vt2oqqkg8.png"></p><br><p style=";text-align:right;direction:rtl">     <code>8888</code>     <code>k.dll</code> —      . </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">C:\Windows\system32\cmd.exe nslookup googlecom ping 1722173110 nslookup soeblogcom nslookup fiosquatumgatefiosrouterhome C:\Windows\system32\cmd.exe Start Start menu Start menu chrome www.flare-on.com - Google Chrome tis encrypting something twice better than once Is encrypting something twice better than once? - Google Search - Google Chrome Start Start menu Start menu keeKeePass &lt;DYN_TITLE&gt; th1sisth33nd111 KeePass keys.kdb - KeePass Is encrypting something twice better than once? - Google Search - Google Chrome Start Start menu Start menu KeePass &lt;DYN_TITLE&gt; th1sisth33nd111 Open Database - keys.kdb KeePass Start Start menu Start menu KeePass Start menu Start menu Start menu KeePass &lt;DYN_TITLE&gt; th1sisth33nd111</code> </pre> <br><p style=";text-align:right;direction:rtl">       <code>th1sisth33nd111</code>     ,    .    ,     .   ,  keylogger          . ,   ,    <code>ping</code>    .      <code>hashcat</code>      <code>KeePass</code>   ,    .              : </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">$ strings help.dmp | grep -i '3nd!' !s_iS_th3_3Nd!!!</code> </pre> <br><p style=";text-align:right;direction:rtl">  <code>Th</code>        . </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/xb/9g/yb/xb9gyb5mnp6evacpllttaz1czco.png"></p><br><p style=";text-align:right;direction:rtl">     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="></a>     .      ,   -. </p><br><a name="outro"></a><br><h2 id="0x0d---itog" style=";text-align:right;direction:rtl"> 0x0D —  </h2><br><p style=";text-align:right;direction:rtl"> ,  .   ,       ,        .      ,        <code>volatility</code> ,      .            (  UTC+3:00): </p><br><div style="text-align:center;;text-align:right;direction:rtl"><img width="500" src="https://habrastorage.org/webt/am/yq/ul/amyquljwc2ieb2qzb4ct9nemtnm.png"></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar469393/">https://habr.com/ru/post/ar469393/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar469381/index.html">مع مرور الوقت ، قم بإنشاء خادم ألعاب متعدد المستخدمين. العمارة والتركيب</a></li>
<li><a href="../ar469383/index.html">حل Hyperconverged AERODISK vAIR. أساس - نظام الملفات ARDFS</a></li>
<li><a href="../ar469387/index.html">قصة "مطور" واحد أو كيف يقوم الوافد الجديد بكتابة تطبيق iOS</a></li>
<li><a href="../ar469389/index.html">المعلمة بواسطة شبكة عصبية من نموذج مادي لحل مشكلة التحسين الطوبولوجي</a></li>
<li><a href="../ar469391/index.html">واجهات الصوت: الصوت كمصدر للمعلومات على الطريق ، في المكتب وفي السماء</a></li>
<li><a href="../ar469395/index.html">أين وكيف يمكنك استخدام الأعمدة المتعددة (أعمدة CSS)</a></li>
<li><a href="../ar469399/index.html">واي فاي في Arkhangelskoye Museum-Estate</a></li>
<li><a href="../ar469401/index.html">3CX WebMeeting Service Update و Elastix Online Converter و دروس الفيديو الجديدة</a></li>
<li><a href="../ar469403/index.html">نحن نجري مقابلات مع مرشح لمنصب كبير مطوري البرامج</a></li>
<li><a href="../ar469405/index.html">التعلم العميق هو الآن في جاوة</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>