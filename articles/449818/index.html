<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üåè üç≠ ü§≥üèº Estad√≠sticas y monitoreo de scripts PHP en tiempo real. ClickHouse y Grafana van a Pinba para obtener ayuda üåßÔ∏è üë®üèª‚Äçüî¨ üîÉ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En este art√≠culo explicar√© c√≥mo usar pinba con clickhouse y grafana en lugar de pinba_engine y pinboard. 

 En el proyecto php, pinba es probablemente...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Estad√≠sticas y monitoreo de scripts PHP en tiempo real. ClickHouse y Grafana van a Pinba para obtener ayuda</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/449818/">  En este art√≠culo explicar√© c√≥mo usar pinba con clickhouse y grafana en lugar de pinba_engine y pinboard. <br><br>  En el proyecto php, pinba es probablemente la √∫nica forma confiable de entender lo que est√° sucediendo con el rendimiento.  Pero por lo general, las personas comienzan a usar pinba solo cuando ya se observan problemas y no est√° claro d√≥nde mirar. <br><br>  A menudo, los desarrolladores no tienen idea de cu√°ntas RPS tiene cada script.  Entonces comienzan a optimizar a partir de lugares que parecen tener problemas. <br><br>  Alguien est√° analizando los registros de nginx, y alguien realiza consultas lentas en la base de datos. <br><br>  Por supuesto, pinba no ser√≠a superfluo, pero hay varias razones por las que no est√° en todos los proyectos. <br><br> <a href=""><img src="https://habrastorage.org/webt/br/zm/qz/brzmqzc8itwc2lt3gjp0q2p-kse.png"></a> <br><a name="habracut"></a><br>  Y la primera raz√≥n es la instalaci√≥n. <br><br>  Para obtener m√°s o menos alg√∫n tipo de beneficio del uso de pinba, es muy conveniente ver las m√©tricas no solo en los √∫ltimos minutos, sino tambi√©n durante un largo per√≠odo de tiempo (de d√≠as a meses). <br><br>  Para eso necesitas: <br><br><ul><li>  instalar la extensi√≥n para php (y es posible que desee tener un m√≥dulo para nginx) </li><li>  compilar extensiones para mysql </li><li>  instalar pinboard y configurar cron </li></ul><br>  Debido a que tenemos un poco de informaci√≥n sobre pinba recientemente, muchas personas piensan que solo funcion√≥ en php5 y desapareci√≥, pero como veremos m√°s adelante, no es cierto. <br><br>  El primer paso es el m√°s f√°cil, todo lo que necesita hacer es ejecutar el comando: <br><br><pre><code class="bash hljs">apt install php-pinba</code> </pre> <br>  En los repositorios, esta extensi√≥n existe hasta php 7.3 inclusive y no necesita compilar nada. <br><br>  Despu√©s de ejecutar el comando de instalaci√≥n, obtenemos inmediatamente una extensi√≥n que ya funciona que recopila y env√≠a las m√©tricas de cada script (duraci√≥n, memoria, etc.) por udp a 127.0.0.1:370002 en el formato <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">protobuf</a> . <br><br>  Todav√≠a no tenemos una aplicaci√≥n para capturar y procesar estos paquetes udp, pero esto no afecta gravemente la velocidad o la estabilidad de sus scripts php. <br><br>  Hasta hace poco, solo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">pinba_engine</a> pod√≠a capturar y procesar estos paquetes udp.  La descripci√≥n de la instalaci√≥n " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">simple</a> " desaconseja volver a leerla.  En largas listas de dependencias hay nombres de paquetes y nombres de programas y enlaces a otras p√°ginas con otras dependencias.  Nadie tiene el tiempo o el deseo de lidiar con esta basura. <br><br>  El proceso de instalaci√≥n de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">pinba2</a> no es <a href="">especialmente f√°cil</a> . <br><br>  Tal vez en la funci√≥n pinba10 se puede instalar con uno o dos comandos y sin leer un mont√≥n de cosas para descubrir c√≥mo hacerlo, pero por ahora no es as√≠. <br><br>  La instalaci√≥n de pinba_engine es solo la mitad de la historia.  Despu√©s de todo, sin <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">pinboard</a> tendr√°s datos limitados solo durante los √∫ltimos minutos.  Es bueno que pinboard sea bastante simple en una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">instalaci√≥n</a> . <br><br>  Pero todas las m√©tricas de php ya van al puerto udp en el formato protobuf y todo lo que se necesita es escribir una aplicaci√≥n que pueda capturar paquetes udp y ponerla en alg√∫n tipo de almacenamiento.  Aparentemente, aquellos desarrolladores que lo pensaron crearon sus propias aplicaciones y algunas de las cuales publicaron su en el githab. <br><br>  A continuaci√≥n se muestra una revisi√≥n de cuatro proyectos de c√≥digo abierto que almacenan m√©tricas en el almacenamiento, de los cuales la grafana obtiene y visualiza f√°cilmente estos datos. <br><br><h4>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">olegfedoseev / pinba-influxdb</a> (noviembre de 2017) </h4><br>  servidor udp en golang, que guarda m√©tricas en OpenTSDB.  Quiz√°s si ya usa OpenTSDB en su proyecto, tal soluci√≥n ser√≠a adecuada para usted. <br><br><h4>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">olegfedoseev / pinba-influxdb</a> (junio de 2018) </h4><br>  servidor udp en golang, del mismo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">usuario de github</a> , que esta vez guarda m√©tricas en InfluxDB.  Muchos proyectos ya usan InfluxDB para el monitoreo, por lo que esta soluci√≥n puede ser buena para ellos. <br><br>  pros: <br><br><ul><li>  Influx <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">permite</a> agregar las m√©tricas resultantes y eliminar el original despu√©s de un tiempo especificado. </li></ul><br>  contras: <br><br><ul><li>  Esta soluci√≥n no guarda informaci√≥n para temporizadores. </li><li>  InfluxDB guardar√° las direcciones de las p√°ginas como etiquetas y si tiene muchas direcciones √∫nicas de p√°ginas, aumentar√° el consumo de RAM.  Desde cierto punto, " <a href="">comenzar√° a usar mucha memoria</a> ".  ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">fuente</a> ) </li></ul><br><h4>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ClickHouse-Ninja / Proton</a> (enero de 2019) </h4><br>  servidor udp en golang, que guarda las m√©tricas en ClickHouse.  Esta es la aplicaci√≥n de mi amigo.  Despu√©s de usar, comenc√© a trabajar en mi propia aplicaci√≥n para pinba con clickhouse. <br><br>  pros: <br><br><ul><li>  Clickhouse es ideal para tales tareas, le permite comprimir los datos para que pueda almacenar todos los datos sin procesar, incluso sin agregaciones </li><li>  si lo necesita, puede agregar f√°cilmente las m√©tricas resultantes </li><li>  plantilla lista para grafana </li><li>  guarda informaci√≥n para temporizadores </li></ul><br>  contras: <br><br><ul><li>  <s><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">No inventado aqu√≠</a></s> </li><li>  no hay configuraci√≥n para el nombre de la base de datos y las tablas, para la direcci√≥n y el puerto del <br>  servidor </li><li>  otras peque√±as cosas que fluyen desde el primer menos </li></ul><br><h4>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">pinba-server / pinba-server</a> (abril de 2019) </h4><br>  servidor udp en php, que guarda m√©tricas en ClickHouse.  Esta es mi aplicaci√≥n, que es el resultado de mi RND de pinba, ClickHouse y protobuf.  Escrib√≠ "prueba de concepto", que inesperadamente para m√≠ no consumi√≥ recursos significativos (30 MB de RAM y menos del 1% de uno de los ocho n√∫cleos de procesador), as√≠ que decid√≠ compartirlo con la gente. <br><br>  Las ventajas son las mismas que en la soluci√≥n anterior, tambi√©n utilic√© los nombres habituales del pinba_engine original.  Tambi√©n agregu√© una configuraci√≥n que le permite ejecutar varias instancias de pinbasver para guardar m√©tricas en diferentes tablas; esto es √∫til si desea recopilar mediciones no solo de php, sino tambi√©n de nginx. <br><br>  Contras: "No inventado aqu√≠" y esas peque√±as cosas que no le convienen personalmente, pero mi soluci√≥n es muy simple y consta de solo alrededor de 100 l√≠neas de c√≥digo, por lo que cualquier desarrollador de php puede cambiar cualquier cosa en un par de minutos. no me gusta <br><br>  <b>Como funciona</b> <br><br>  Est√° escuchando udp-port 30002. Todos los paquetes entrantes se decodifican de acuerdo con el esquema protobuf y se agregan.  Una vez por minuto, el lote de paquetes se inserta en el clickhouse en la tabla pinba.requests.  (todos los ajustes est√°n configurados en la <a href="">configuraci√≥n</a> ) <br><br>  <b>Sobre ClickHouse</b> <br><br>  Clickhouse admite diferentes motores de almacenamiento de datos.  El m√°s utilizado es MergeTree. <br><br>  Si en alg√∫n momento decide almacenar datos agregados para todo el tiempo, y datos sin procesar solo para este √∫ltimo, puede crear una vista materializada con agrupaci√≥n y limpiar peri√≥dicamente la tabla principal pinba.requests, mientras que todos los datos permanecen en la vista materializada.  Adem√°s, puede especificar "engine = Null" para la tabla pinba.requests, por lo que los datos sin procesar no se guardar√°n en el disco y, al mismo tiempo, se incluir√°n en la vista materializada.  Utilizo este esquema para las m√©tricas nginx, porque en nginx tengo 50 veces m√°s solicitudes que en php. <br><br>  Ha recorrido un largo camino, por lo que habr√° una descripci√≥n detallada de la instalaci√≥n y configuraci√≥n de mi soluci√≥n y todo lo que necesita.  Todo el proceso de instalaci√≥n se describe para Ubuntu 18.04 LTS y Centos 7, en otras distribuciones y versiones, el proceso puede diferir ligeramente. <br><br><h4>  Instalaci√≥n </h4><br>  Puse todos los comandos necesarios en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Dockerfile</a> para reproducir las instrucciones.  Solo los problemas se describir√°n a continuaci√≥n. <br><br>  <b>php pinba</b> <br><br>  Despu√©s de la instalaci√≥n, aseg√∫rese de haber descomentado todas las opciones en el archivo /etc/php/7.2/fpm/conf.d/20-pinba.ini.  En algunas distribuciones (por ejemplo, centos) se puede comentar. <br><br><pre> <code class="plaintext hljs">extension = pinba.so pinba.enabled = 1 pinba.server = 127.0.0.1:30002</code> </pre> <br>  <b>clickhouse</b> <br><br>  Durante la instalaci√≥n, clickhouse le pedir√° que establezca una contrase√±a para el usuario predeterminado.  Por defecto, este usuario est√° disponible desde todas las ip.  Entonces, si no tiene un firewall en su servidor, configure una contrase√±a.  Esto tambi√©n se puede hacer despu√©s de la instalaci√≥n en el archivo /etc/clickhouse-server/users.xml. <br><br>  Tambi√©n tenga en cuenta que clickhouse usa varios puertos, incluido 9000. Este puerto tambi√©n se usa para php-fpm en algunas distribuciones (por ejemplo, centos).  Si ya usa este puerto, puede cambiarlo a otro en el archivo /etc/clickhouse-server/config.xml. <br><br>  <b>grafana con complemento de clickhouse</b> <br><br>  Despu√©s de instalar la grafana, use el nombre de usuario "admin" y la contrase√±a "admin".  Cuando inicie sesi√≥n por primera vez, el grafana le pedir√° que establezca una nueva contrase√±a. <br><br>  A continuaci√≥n, vaya al men√∫ "+" -&gt; importar y especifique el n√∫mero de paneles para importar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">10011</a> .  He preparado este panel para que no tenga que volver a hacerlo usted mismo. <br><br>  Grafana admite ClickHouse por complementos de terceros, pero grafana no admite alertas para complementos de terceros (el ticket ya existe varios a√±os). <br><br>  <b>servidor pinba</b> <br><br>  Instalar protobuf y libevent es opcional, pero mejora el rendimiento del servidor pinba.  Si instala un servidor pinba en una carpeta que no sea / opt, tambi√©n deber√° cambiar el archivo de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">script systemd</a> . <br><br>  <b>pinba-module bajo nginx</b> <br><br>  Para compilar el m√≥dulo, necesita el c√≥digo fuente de la misma versi√≥n de nginx que ya est√° instalada en su servidor, as√≠ como las mismas opciones de compilaci√≥n, de lo contrario, el ensamblaje ser√° exitoso, pero cuando el m√≥dulo est√© conectado, se producir√° un error " el m√≥dulo es binario incompatible ".  Las opciones de compilaci√≥n se pueden ver usando el comando "nginx -V". <br><br>  <b>Lifehacks</b> <br><br>  Todos mis sitios funcionan solo en https.  Entonces uso el campo "esquema" para separar la web / consola. <br>  En los scripts web que uso: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ini_get(<span class="hljs-string"><span class="hljs-string">'pinba.enabled'</span></span>)) {    pinba_schema_set(<span class="hljs-string"><span class="hljs-string">'web'</span></span>); }</code> </pre> <br>  y en la consola (por ejemplo, cron-scripts): <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ini_get (<span class="hljs-string"><span class="hljs-string">'pinba.enabled'</span></span>)) {    pinba_schema_set(<span class="hljs-string"><span class="hljs-string">'console'</span></span>); }</code> </pre> <br>  En mi panel de control en grafana hay un conmutador web / consola para ver las estad√≠sticas por separado. <br>  Tambi√©n puede enviar sus etiquetas a la pinba, por ejemplo: <br><br><pre> <code class="php hljs">pinba_tag_set(<span class="hljs-string"><span class="hljs-string">'country'</span></span>, $countryCode);</code> </pre> <br>  <b>Eso es todo</b> <br><br>  Tambi√©n puedes leer la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">versi√≥n rusa</a> . <br><br>  Responda para las encuestas en virtud del art√≠culo y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ap√≥yeme en Reddit</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/449818/">https://habr.com/ru/post/449818/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../449802/index.html">Programador de carrera. Parte 1. El primer programa</a></li>
<li><a href="../449804/index.html">Descripci√≥n general de la terapia antienvejecimiento para biohackers</a></li>
<li><a href="../449806/index.html">Programador de carrera. Parte 2. Escuela o autoeducaci√≥n</a></li>
<li><a href="../449808/index.html">Experimento Positivo Hack Days 9: c√≥mo el pensamiento cr√≠tico ayuda en la vida y el trabajo</a></li>
<li><a href="../449814/index.html">Windows XP est√° oficialmente muerto, ahora finalmente</a></li>
<li><a href="../449820/index.html">Personalice al instante asociaciones de archivos familiares</a></li>
<li><a href="../449824/index.html">Las aventuras de la startup de hierro en Rusia: Team Building</a></li>
<li><a href="../449826/index.html">[Traducci√≥n] Enviado modelo de subprocesos</a></li>
<li><a href="../449828/index.html">"Los ratones lloraron y pincharon ..." Sustituci√≥n de importaciones en la pr√°ctica. Parte 4 (te√≥rica, final). Sistemas y servicios</a></li>
<li><a href="../449830/index.html">Control de l√≠nea de potencia HD44780</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>