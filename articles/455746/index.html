<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üêä ‚úã üçà Celesta 7.x: ORM, migraci√≥n y pruebas "en un paquete" üåì üîá üèáüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Quiz√°s ya sepa algo sobre la biblioteca de c√≥digo abierto Celesta . Si no, no importa, ahora te contaremos todo. Pas√≥ otro a√±o, se lanz√≥ la versi√≥n 7....">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Celesta 7.x: ORM, migraci√≥n y pruebas "en un paquete"</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/455746/"><p>  Quiz√°s ya sepa algo sobre la biblioteca de c√≥digo abierto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Celesta</a> .  Si no, no importa, ahora te contaremos todo.  Pas√≥ otro a√±o, se lanz√≥ la versi√≥n 7.x, muchas cosas hab√≠an cambiado, y era hora de resumir los cambios y, al mismo tiempo, recordar qu√© es Celesta en general. </p><br><div style="text-align:center;"><img width="350" src="https://habrastorage.org/webt/jj/7z/jt/jj7zjthmrh2dhdo4v0ueefqj6uq.png"></div><a name="habracut"></a><br><p> Si a√∫n no ha escuchado nada sobre Celesta, y al leer este art√≠culo desea saber para qu√© tareas comerciales es m√°s efectiva su aplicaci√≥n, puedo recomendar la primera parte de la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">publicaci√≥n anterior</a> o este <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">video de media hora</a> (excepto las palabras sobre el uso del lenguaje Python).  Pero mejor a√∫n, lea este art√≠culo primero.  Comenzar√© con los cambios que ocurrieron en la versi√≥n 7, y luego repasar√© un ejemplo t√©cnico completo del uso de la versi√≥n moderna de Celesta para escribir un peque√±o servicio de back-end para una aplicaci√≥n Java usando Spring Boot. </p><br><h2 id="chto-izmenilos-v-versii-7x">  ¬øQu√© ha cambiado en la versi√≥n 7.x? </h2><br><ol><li>  Nos negamos a usar Jython como un lenguaje integrado en Celesta.  Si antes comenzamos a hablar de Celesta con el hecho de que la l√≥gica de negocios est√° escrita en Python, ahora ... cualquier lenguaje Java puede servir como lenguaje de l√≥gica de negocios: Java, Groovy, JRuby o el mismo Jython.  Ahora Celesta no llama al c√≥digo de l√≥gica de negocios, pero el c√≥digo de l√≥gica de negocios usa a Celesta y sus clases de acceso a datos como la biblioteca Java m√°s com√∫n.  S√≠, debido a esto se viol√≥ la compatibilidad con versiones anteriores, pero este es el precio que est√°bamos dispuestos a pagar.  Desafortunadamente, nuestra apuesta por Jython perdi√≥.  Cuando comenzamos a usar Jython hace unos a√±os, era un proyecto animado y prometedor, pero a lo largo de los a√±os su desarrollo se ralentiz√≥, la acumulaci√≥n de la especificaci√≥n del lenguaje se acumul√≥, los problemas de compatibilidad para la mayor√≠a de las bibliotecas de pip no se resolvieron.  La gota que colm√≥ el vaso fue la aparici√≥n de nuevos errores en los √∫ltimos lanzamientos de idiomas, que se manifestaron al trabajar en una carga de producci√≥n.  Nosotros mismos no tenemos los recursos para apoyar el proyecto Jython, y decidimos separarnos de √©l.  Celesta ya no depende de Jython. </li><li>  Las clases de acceso a datos ahora se generan en c√≥digo en Java (y no en Python, como antes) utilizando el complemento Maven.  Y debido a que pasamos de la escritura din√°mica a la escritura est√°tica debido a esto, hubo m√°s oportunidades para refactorizar y se hizo m√°s f√°cil escribir c√≥digo subjetivamente correcto. </li><li>  Apareci√≥ la extensi√≥n para JUnit5, por lo que se volvi√≥ muy conveniente escribir pruebas de l√≥gica que funcionen con la base de datos en JUnit5 (que se discutir√° m√°s adelante). </li><li>  Ha aparecido un proyecto separado: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">spring-boot-starter-celesta</a> , que, como su nombre lo indica, es el iniciador Celesta en Spring Boot.  La capacidad de empaquetar aplicaciones Celesta en servicios Spring Boot f√°cilmente implementables compens√≥ la p√©rdida de la capacidad de actualizar la aplicaci√≥n en el servidor simplemente cambiando la carpeta con scripts Python. </li><li>  Transferimos toda la documentaci√≥n de la Wiki al formato <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">AsciiDoctor</a> , la colocamos en el control de versiones junto con el c√≥digo, y ahora tenemos documentaci√≥n actualizada para cada versi√≥n de Celesta.  Para la √∫ltima versi√≥n, la documentaci√≥n en l√≠nea est√° disponible aqu√≠: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://courseorchestra.github.io/celesta/</a> </li><li>  A menudo se nos pregunt√≥ si es posible utilizar la migraci√≥n de la base de datos a trav√©s de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">DDL idempotente</a> por separado de Celesta.  Ahora existe esa oportunidad usando la herramienta <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">2bass</a> . </li></ol><br><h2 id="chto-takoe-selesta-i-chto-ona-umeet">  ¬øQu√© es Celesta y qu√© puede hacer ella? </h2><br><p>  En pocas palabras, Celesta es: </p><br><ul><li>  una capa intermedia entre la base de datos relacional y el c√≥digo de l√≥gica de negocios, basada en el enfoque de dise√±o de la <em>primera base de datos</em> , </li><li>  mecanismo de migraci√≥n de estructura de base de datos, </li><li>  marco para probar c√≥digo que funciona con datos. </li></ul><br><p>  Admitimos cuatro tipos de bases de datos relacionales: PostgreSQL, MS SQL Server, Oracle y H2. </p><br><p>  Caracter√≠sticas clave de Celesta: </p><br><ol><li>  Un principio muy similar al principio b√°sico de Java: "Escribir una vez, ejecutar en todos los RDBMS compatibles".  El c√≥digo de l√≥gica de negocios no sabe en qu√© tipo de base de datos se ejecutar√°.  Puede escribir el c√≥digo de l√≥gica de negocios y ejecutarlo en MS SQL Server, luego cambiar a PostgreSQL, y esto suceder√° sin complicaciones (bueno, casi :) </li><li>  Reestructuraci√≥n autom√°tica en una base de datos en vivo.  La mayor parte del ciclo de vida de los proyectos de Celesta ocurre cuando la base de datos de trabajo ya est√° all√≠ y est√° llena de datos que deben guardarse, pero tambi√©n es necesario cambiar constantemente su estructura.  Una de las caracter√≠sticas clave de Celesta es la capacidad de "ajustar" autom√°ticamente la estructura de la base de datos a su modelo de datos. </li><li>  Pruebas  Se presta mucha atenci√≥n para garantizar que el c√≥digo de Celesta sea comprobable, de modo que podamos probar autom√°ticamente los m√©todos que modifican los datos en la base de datos, haciendo esto de manera f√°cil, r√°pida y elegante, sin usar herramientas externas como DbUnit y contenedores. </li></ol><br><h2 id="dlya-chego-nuzhna-nezavisimost-ot-tipa-subd">  ¬øPor qu√© necesita independencia del tipo de DBMS? </h2><br><p>  La independencia del c√≥digo de l√≥gica de negocios del tipo de DBMS no fue el primer punto que pusimos: el c√≥digo escrito para Celesta no sabe en absoluto en qu√© DBMS se est√° ejecutando.  Por qu√© </p><br><p>  En primer lugar, debido a que la elecci√≥n de un tipo de DBMS no es un problema tecnol√≥gico, sino pol√≠tico.  Al llegar a un nuevo cliente comercial, a menudo descubrimos que √©l ya tiene un tipo favorito de DBMS en el que se invierten los fondos, y el cliente quiere ver otras soluciones en la infraestructura existente.  El panorama tecnol√≥gico est√° cambiando: PostgreSQL se encuentra cada vez m√°s en agencias gubernamentales y empresas privadas, aunque MS SQL Server prevaleci√≥ en nuestra pr√°ctica hace unos a√±os.  Celesta admite los DBMS m√°s comunes, y no estamos preocupados por estos cambios. </p><br><p>  En segundo lugar, me gustar√≠a transferir el c√≥digo ya creado para resolver problemas est√°ndar de un proyecto a otro, para crear una biblioteca reutilizable.  Cosas como directorios jer√°rquicos o m√≥dulos de distribuci√≥n de notificaciones por correo electr√≥nico son inherentemente est√°ndar, y ¬øpor qu√© necesitamos admitir m√∫ltiples versiones para clientes con diferentes relaciones? </p><br><p>  En tercer lugar, por √∫ltimo, pero no menos importante, la capacidad de ejecutar pruebas unitarias sin usar DbUnit y contenedores utilizando una base de datos H2 en memoria.  En este modo, la base H2 comienza instant√°neamente.  Celesta crea muy r√°pidamente un esquema de datos en √©l, despu√©s de lo cual puede realizar las pruebas necesarias y "olvidar" la base de datos.  Dado que el c√≥digo de l√≥gica empresarial realmente no sabe sobre qu√© base se ejecuta, entonces, si funciona sin errores en H2, sin errores funcionar√° en PostgreSQL.  Por supuesto, la tarea de los desarrolladores del sistema Celesta es hacer todas las pruebas utilizando DBMS reales para asegurarse de que nuestra plataforma realice su API por igual en diferentes relaciones.  Y lo hacemos  Pero el desarrollador de l√≥gica de negocios ya no es necesario. </p><br><h2 id="celestasql">  CelestaSQL </h2><br><p>  ¬øC√≥mo se logra el cross-basamentism?  Por supuesto, a costa de trabajar con datos solo a trav√©s de una API especial que a√≠sla la l√≥gica de cualquier informaci√≥n espec√≠fica de la base de datos.  Celesta genera clases Java para acceder a datos, por un lado, y c√≥digo SQL y algunos objetos auxiliares dentro de la base de datos, por otro lado. </p><br><p>  Celesta no proporciona mapeo relacional de objetos en su forma m√°s pura, porque al dise√±ar un modelo de datos, no venimos de clases, sino de la estructura de la base de datos.  Es decir, primero construimos un modelo ER de tablas, y luego, en base a este modelo, Celesta genera clases de cursor para acceder a los datos. </p><br><p>  Es posible lograr el mismo trabajo en todos los DBMS compatibles solo para la funcionalidad que se implementa aproximadamente de manera equitativa en cada uno de ellos.  Si representamos condicionalmente el conjunto de capacidades funcionales de cada una de las bases que apoyamos en forma de "c√≠rculos de Euler", obtenemos la siguiente imagen: </p><br><div style="text-align:center;"><img width="300" src="https://habrastorage.org/getpro/habr/post_images/7d9/2ad/1e1/7d92ad1e1a3bc0bb83b5c4bcc511ec66.png"></div><br><p>  Si brindamos total independencia del tipo de base de datos, entonces la funcionalidad que abrimos para los programadores de l√≥gica de negocios deber√≠a estar dentro de la intersecci√≥n de todas las bases.  A primera vista, parece que esta es una limitaci√≥n significativa.  S√≠: algunas caracter√≠sticas espec√≠ficas, por ejemplo, no podemos usar SQL Server.  Pero sin excepci√≥n, las bases de datos relacionales admiten tablas, claves externas, vistas, secuencias, consultas SQL con JOIN y GROUP BY.  En consecuencia, podemos dar estas oportunidades a los desarrolladores.  Proporcionamos a los desarrolladores "SQL despersonalizado", que llamamos "CelestaSQL", y en el proceso generamos consultas SQL para dialectos de las bases de datos correspondientes. </p><br><p>  El lenguaje CelestaSQL incluye DDL para definir objetos de base de datos y consultas SELECT para vistas y filtros, pero no contiene comandos DML: los cursores se utilizan para modificar los datos, que a√∫n deben discutirse. </p><br><p>  Cada base de datos tiene su propio conjunto de tipos de datos.  CelestaSQL tambi√©n tiene su propio conjunto de tipos.  Al momento de escribir, hay nueve de ellos, y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">esta tabla los</a> compara con tipos reales en varias bases de datos y tipos de datos Java. </p><br><p>  Puede parecer que nueve tipos no son suficientes (en comparaci√≥n con lo que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">admite</a> PostgreSQL, por ejemplo), pero en realidad estos son los tipos que son suficientes para almacenar informaci√≥n financiera, comercial y log√≠stica: cadenas, enteros, fraccionales , fechas, valores booleanos y blobs son siempre suficientes para representar dichos datos. </p><br><p>  El lenguaje CelestaSQL en s√≠ mismo se describe en la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">documentaci√≥n</a> con una gran cantidad de diagramas de sintaxis. </p><br><h2 id="modifikaciya-struktury-bazy-dannyh-idempotentnyy-ddl">  Modificaci√≥n de la estructura de la base de datos.  DDL idempotente </h2><br><p>  Otra caracter√≠stica clave de Celesta es su enfoque para migrar la estructura de la base de datos de trabajo a medida que se desarrolla el proyecto.  Para hacer esto, se utiliza el enfoque integrado en Celesta usando DDL idempotente. </p><br><p>  En pocas palabras, cuando escribimos en CelestaSQL el siguiente texto: </p><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> OrderLine( order_id <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, line_no <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, item_id <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, item_name <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>), qty <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">cost</span></span> <span class="hljs-built_in"><span class="hljs-built_in">REAL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-number"><span class="hljs-number">0.0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> Idx_OrderLine PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (order_id, line_no) );</code> </pre> <br><p>  - este texto no es interpretado por Celesta como "crear una tabla, pero si ya hay una tabla, entonces dar un error", sino "llevar la tabla a la estructura deseada".  Es decir: "si no hay una tabla, cr√©ela, si hay una tabla, vea qu√© campos hay en ella, con qu√© tipos, qu√© √≠ndices, qu√© claves externas, qu√© valores predeterminados, etc., y si es necesario cambiar algo en esta tabla para llevarlo al tipo correcto ". </p><br><p>  Con este enfoque, implementamos la capacidad de refactorizar y guiones de control de versiones para determinar la estructura de la base de datos: </p><br><ul><li>  vemos en el script la "imagen deseada" actual de la estructura, </li><li>  qu√©, por qui√©n y por qu√© en la estructura ha cambiado con el tiempo, podemos mirar a trav√©s del sistema de control de versiones, </li><li>  En cuanto a los comandos ALTER, Celesta los genera y ejecuta autom√°ticamente "bajo el cap√≥" seg√∫n sea necesario. </li></ul><br><p>  Por supuesto, este enfoque tiene sus limitaciones.  Celesta hace todo lo posible para garantizar que la migraci√≥n autom√°tica sea sencilla y sin problemas, pero esto no es posible en todos los casos.  La motivaci√≥n, las posibilidades y las limitaciones de este enfoque se describieron <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">en esta publicaci√≥n</a> (su <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">versi√≥n en ingl√©s</a> tambi√©n est√° disponible). </p><br><p>  Para acelerar el proceso de verificaci√≥n / actualizaci√≥n de la estructura de la base de datos, Celesta aplica el almacenamiento de las sumas de verificaci√≥n del script DDL en la base de datos (hasta que se cambie la suma de verificaci√≥n, el proceso de verificaci√≥n y actualizaci√≥n de la estructura de la base de datos no se inicia).  Para que el proceso de actualizaci√≥n contin√∫e sin problemas relacionados con el orden de cambio de los objetos que dependen uno del otro, se aplica la clasificaci√≥n topol√≥gica de dependencias entre esquemas por claves externas.  El proceso de migraci√≥n autom√°tica se describe con m√°s detalle en la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">documentaci√≥n</a> . </p><br><h2 id="sozdanie-proekta-celesta-i-modeli-dannyh">  Crear un proyecto de Celesta y un modelo de datos </h2><br><p>  El proyecto de demostraci√≥n, que consideraremos, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">est√° disponible en el github</a> .  Veamos c√≥mo puede usar Celesta al escribir una aplicaci√≥n Spring Boot.  Estas son las dependencias de Maven que necesita: </p><br><ul><li>  <code>org.springframework.boot:spring-boot-starter-web</code> y <code>ru.curs:spring-boot-starter-celesta</code> (para m√°s detalles, <code>ru.curs:spring-boot-starter-celesta</code> documentaci√≥n). </li><li>  Si no est√° utilizando Spring Boot, puede conectar la <code>ru.curs:celesta-system-services</code> directamente. </li><li>  Para la generaci√≥n de c√≥digo de clases de acceso a datos basadas en scripts Celesta-SQL, <code>ru.curs:celesta-maven-plugin</code> necesita <code>ru.curs:celesta-maven-plugin</code> : el c√≥digo fuente para un ejemplo de demostraci√≥n o documentaci√≥n describe c√≥mo conectarlo. </li><li>  Para aprovechar la capacidad de escribir pruebas unitarias JUnit5 para m√©todos que modifican datos, debe conectar <code>ru.curs:celesta-unit</code> en el alcance de la prueba. </li></ul><br><p>  Ahora cree un modelo de datos y compile clases de acceso a datos. </p><br><p>  Digamos que estamos haciendo un proyecto para una empresa de comercio electr√≥nico que recientemente se fusion√≥ con otra empresa.  Cada uno tiene su propia base de datos.  Recopilan pedidos, pero hasta que fusionen sus bases de datos, necesitan un √∫nico punto de entrada para recopilar pedidos desde el exterior. </p><br><p>  La implementaci√≥n de este "punto de entrada" deber√≠a ser bastante tradicional: un servicio HTTP con operaciones CRUD que almacena datos en una base de datos relacional. </p><br><p>  Debido al hecho de que Celesta implementa el enfoque de dise√±o de la base de datos primero, primero necesitamos crear una estructura de tabla que almacene los pedidos.  Un pedido, como sabe, es una entidad compuesta: consiste en un encabezado donde se almacena la informaci√≥n sobre el cliente, la fecha del pedido y otros atributos del pedido, as√≠ como muchas l√≠neas (art√≠culos b√°sicos). </p><br><p>  Entonces, para el trabajo: crear </p><br><ul><li>  <code>src/main/celestasql</code> : de forma predeterminada, esta es la ruta a los scripts del proyecto CelestaSQL </li><li>  Contiene subcarpetas que repiten la estructura de carpetas de los paquetes de Java ( <code>ru/curs/demo</code> en nuestro caso). </li><li>  en la carpeta del paquete, cree un archivo <code>.sql</code> con el siguiente contenido: </li></ul><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SCHEMA</span></span> demo <span class="hljs-keyword"><span class="hljs-keyword">VERSION</span></span> <span class="hljs-string"><span class="hljs-string">'1.0'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> OrderHeader( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> DATETIME, customer_id <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">30</span></span>), <span class="hljs-comment"><span class="hljs-comment">/**  */</span></span> customer_name <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">50</span></span>), manager_id <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">30</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> Pk_OrderHeader PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) ); <span class="hljs-comment"><span class="hljs-comment">/** */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> OrderLine( order_id <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, line_no <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, item_id <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, item_name <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>), qty <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">cost</span></span> <span class="hljs-built_in"><span class="hljs-built_in">REAL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-number"><span class="hljs-number">0.0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> Idx_OrderLine PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (order_id, line_no) ); <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> OrderLine <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> fk_OrderLine <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (order_id) <span class="hljs-keyword"><span class="hljs-keyword">REFERENCES</span></span> OrderHeader(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VIEW</span></span> OrderedQty <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> item_id, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(qty) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> qty <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> OrderLine <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> item_id;</code> </pre> <br><p>  Aqu√≠ describimos dos tablas conectadas por una clave externa, y una vista que devolver√° una cantidad de resumen para los productos presentes en todos los pedidos.  Como puede ver, esto no es diferente del SQL normal, con la excepci√≥n del comando <code>CREATE SCHEMA</code> , en el que <code>CREATE SCHEMA</code> la <code>demo</code> esquema de <code>demo</code> (para ver c√≥mo el n√∫mero de versi√≥n afecta la migraci√≥n autom√°tica, consulte la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">documentaci√≥n</a> ).  Pero tambi√©n hay caracter√≠sticas.  Por ejemplo, todos los nombres de las tablas y campos que usamos solo pueden ser de tal manera que se puedan convertir en nombres v√°lidos de clase y variable en el lenguaje Java.  Por lo tanto, espacios, caracteres especiales est√°n excluidos.  Tambi√©n puede observar que en los comentarios que colocamos sobre los nombres de las tablas y algunos de los campos, no comenzamos con / *, como de costumbre, sino con / **, c√≥mo comienzan los comentarios JavaDoc, ¬°y esto no es accidental!  Un comentario definido sobre una entidad que comience con / ** estar√° disponible en tiempo de ejecuci√≥n en la propiedad <code>.getCelestaDoc()</code> de esa entidad.  Esto es √∫til cuando queremos proporcionar elementos de la base de datos con metainformaci√≥n adicional: por ejemplo, nombres de campos legibles por humanos, informaci√≥n sobre c√≥mo representar campos en la interfaz de usuario, etc. </p><br><p>  El script CelestaSQL sirve dos tareas igualmente importantes: en primer lugar, para el despliegue / modificaci√≥n de la estructura de una base de datos relacional, y en segundo lugar, para la generaci√≥n de c√≥digo de clases de acceso a datos. </p><br><p>  Ahora podemos generar clases de acceso a datos, simplemente ejecute el <code>mvn generate-sources</code> o, si est√° trabajando en IDEA, haga clic en el bot√≥n 'Generar fuentes y actualizar carpetas' en el panel de control de Maven.  En el segundo caso, IDEA " <code>target/generated-sources/celesta</code> carpeta creada en <code>target/generated-sources/celesta</code> y hace que su contenido est√© disponible para su importaci√≥n en los c√≥digos fuente del proyecto.  El resultado de la generaci√≥n de c√≥digo ser√° el siguiente: una clase para cada objeto en la base de datos: </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/2x/3q/cs/2x3qcsydsu3y5vplbyh7oz15z-s.png"></div><br><p>  La conexi√≥n a la base de datos se especifica en la configuraci√≥n de la aplicaci√≥n, en nuestro caso, en el archivo <code>src/main/resources/application.yml</code> .  Al usar spring-boot-starter-celesta, IDEA le indicar√° las opciones de c√≥digo disponibles en la finalizaci√≥n del c√≥digo. </p><br><p>  Si no queremos molestarnos con el RDBMS "real" con fines de demostraci√≥n, podemos hacer que Celesta trabaje con la base de datos H2 incorporada en modo memoria utilizando la siguiente configuraci√≥n: </p><br><pre> <code class="plaintext hljs">celesta: h2: inMemory: true</code> </pre> <br><p>  Para conectar una base de datos "real", cambie la configuraci√≥n a algo como </p><br><pre> <code class="plaintext hljs">celesta: jdbc: url: jdbc:postgresql://127.0.0.1:5432/celesta username: &lt;your_username&gt; password: &lt;your_password&gt;</code> </pre> <br><p>  (en este caso, tambi√©n deber√° agregar un controlador JDBC PostgreSQL a su aplicaci√≥n a trav√©s de la dependencia de Maven). </p><br><p>  Cuando inicia una aplicaci√≥n Celesta con una conexi√≥n a un servidor de base de datos, puede observar que las tablas, vistas, √≠ndices, etc. necesarios se crean para una base de datos vac√≠a, y para una no vac√≠a, se actualizan a las estructuras especificadas en el DDL. </p><br><h2 id="sozdanie-metodov-rabotayuschih-s-dannymi">  Crear m√©todos de manipulaci√≥n de datos. </h2><br><p>  Una vez que haya descubierto c√≥mo crear una estructura de base de datos, puede comenzar a escribir la l√≥gica empresarial. </p><br><p>  Para poder implementar los requisitos para distribuir los derechos de acceso y las acciones de registro, cualquier operaci√≥n de datos en Celesta se realiza en nombre de un usuario, no hay operaciones "an√≥nimas".  Por lo tanto, cualquier c√≥digo Celesta se ejecuta en el <em>contexto de la llamada</em> descrita en la clase <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">CallContext</a> . </p><br><ul><li>  Antes de comenzar una operaci√≥n que puede modificar datos en la base de datos, <code>CallContext</code> activa <code>CallContext</code> . </li><li>  En el momento de la activaci√≥n, se toma una conexi√≥n a la base de datos del grupo de conexiones y comienza la transacci√≥n. </li><li>  Una vez <code>CallContext</code> la operaci√≥n <code>CallContext</code> ejecuta <code>commit()</code> si la operaci√≥n fue exitosa o <code>rollback()</code> si se produjo una excepci√≥n no controlada durante la ejecuci√≥n, <code>CallContext</code> cierra y la conexi√≥n de la base de datos se devuelve al grupo. </li></ul><br><p>  Si usamos spring-boot-starter-celesta, estas acciones se realizan autom√°ticamente para todos los m√©todos anotados por <code>@CelestaTransaction</code> . </p><br><p>  Supongamos que queremos escribir un controlador que guarde el documento en la base de datos.  Su c√≥digo de nivel de controlador podr√≠a verse as√≠: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RestController</span></span> <span class="hljs-meta"><span class="hljs-meta">@RequestMapping</span></span>(<span class="hljs-string"><span class="hljs-string">"/api"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DocumentController</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> DocumentService srv; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DocumentController</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DocumentService srv)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.srv = srv; } <span class="hljs-meta"><span class="hljs-meta">@PutMapping</span></span>(<span class="hljs-string"><span class="hljs-string">"/save"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">saveOrder</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@RequestBody OrderDto order)</span></span></span><span class="hljs-function"> </span></span>{ CallContext ctx = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CallContext(<span class="hljs-string"><span class="hljs-string">"user1"</span></span>); <span class="hljs-comment"><span class="hljs-comment">//new SystemCallContext(); srv.postOrder(ctx, order); }</span></span></code> </pre> <br><p>  Como regla general, en el nivel del m√©todo del controlador (es decir, cuando la autenticaci√≥n ya ha pasado), conocemos la ID de usuario y podemos usarla al crear el <code>CallContext</code> .  La vinculaci√≥n de un usuario a un contexto determina los permisos para acceder a las tablas y tambi√©n proporciona la capacidad de registrar los cambios realizados en su nombre.  Es cierto, en este caso, para la operatividad del c√≥digo que interact√∫a con la base de datos, los derechos para el usuario "usuario1" deben indicarse en las <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">tablas del sistema</a> .  Si no desea utilizar el sistema de distribuci√≥n de acceso Celesta y otorgar al contexto de la sesi√≥n todos los derechos sobre cualquier tabla, puede crear un objeto <code>SystemCallContext</code> . </p><br><p>  El m√©todo para guardar la factura en el nivel de servicio puede verse as√≠: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DocumentService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@CelestaTransaction</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">postOrder</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CallContext context, OrderDto doc)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> (OrderHeaderCursor header = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OrderHeaderCursor(context); OrderLineCursor line = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OrderLineCursor(context)) { header.setId(doc.getId()); header.setDate(Date.from(doc.getDate().atStartOfDay(ZoneId.systemDefault()).toInstant())); header.setCustomer_id(doc.getCustomerId()); header.setCustomer_name(doc.getCustomerName()); header.insert(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> lineNo = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (OrderLineDto docLine : doc.getLines()) { lineNo++; line.setLine_no(lineNo); line.setOrder_id(doc.getId()); line.setItem_id(docLine.getItemId()); line.setQty(docLine.getQty()); line.insert(); } } }</code> </pre> <br><p>  Tenga en cuenta la anotaci√≥n <code>@CelestaTransaction</code> .  Gracias a √©l, el objeto proxy <code>DocumentService</code> realizar√° todas esas acciones de servicio con el par√°metro <code>CallContext ctx</code> descrito anteriormente.  Es decir, al comienzo de la ejecuci√≥n del m√©todo, ya estar√° vinculado a la conexi√≥n de la base de datos y la transacci√≥n estar√° lista para comenzar.  Podemos centrarnos en escribir l√≥gica de negocios.  En nuestro caso, leer el objeto <code>OrderDto</code> y guardarlo en la base de datos. </p><br><p>  Para hacer esto, usamos los llamados cursores, clases generadas usando el <code>celesta-maven-plugin</code> .  Ya hemos visto lo que son.  Se crea una clase para cada uno de los objetos de esquema: dos tablas y una vista.  Y ahora podemos usar estas clases para acceder a los objetos de la base de datos en nuestra l√≥gica de negocios. </p><br><p>  Para crear un cursor en la tabla de pedidos y seleccionar el primer registro, debe escribir el siguiente c√≥digo: </p><br><pre> <code class="java hljs">OrderHeaderCursor header = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OrderHeaderCursor(context); header.tryFirst();</code> </pre> <br><p>  Despu√©s de crear el objeto de encabezado, podemos acceder a los campos de la entrada de la tabla a trav√©s de getters y setters: </p><br><div style="text-align:center;"><img width="450" src="https://habrastorage.org/webt/_8/gl/9i/_8gl9ikjbprpjano2dbvj0reme8.png"></div><br><p>  Al crear un cursor, debemos usar el contexto de llamada activa; esta es la √∫nica forma de crear un cursor.  El contexto de la llamada lleva informaci√≥n sobre el usuario actual y sus derechos de acceso. </p><br><p>  Con el objeto cursor, podemos hacer diferentes cosas: filtrar, revisar los registros y, naturalmente, insertar, eliminar y actualizar registros.  Toda la API del cursor se describe en detalle en la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">documentaci√≥n</a> . </p><br><p>  Por ejemplo, el c√≥digo de nuestro ejemplo podr√≠a desarrollarse de la siguiente manera: </p><br><pre> <code class="java hljs">OrderHeaderCursor header = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OrderHeaderCursor(context); header.setRange(<span class="hljs-string"><span class="hljs-string">"manager_id"</span></span>, <span class="hljs-string"><span class="hljs-string">"manager1"</span></span>); header.tryFirst(); header.setCounter(header.getCounter() + <span class="hljs-number"><span class="hljs-number">1</span></span>); header.update();</code> </pre> <br><p>  En este ejemplo, establecemos el filtro por el campo manager_id, luego encontramos el primer registro usando el m√©todo tryFirst. </p><br><div class="spoiler">  <b class="spoiler_title">(por qu√© "intentar")</b> <div class="spoiler_text"><p>  Los m√©todos <code>get</code> , <code>first</code> , <code>insert</code> , <code>update</code> tienen dos opciones: sin el prefijo try (solo <code>get(...)</code> , etc.) y con el prefijo try ( <code>tryGet(...)</code> , <code>tryFirst()</code> , etc.) .  Los m√©todos sin el prefijo try arrojan una excepci√≥n si la base de datos no tiene los datos apropiados para realizar la acci√≥n.  Por ejemplo, first () arrojar√° una excepci√≥n si ning√∫n registro ingresa al conjunto de filtros en el cursor.  Al mismo tiempo, los m√©todos con el prefijo try no arrojan una excepci√≥n, sino que devuelven un valor booleano que indica el √©xito o el fracaso de la operaci√≥n correspondiente.  La pr√°ctica recomendada es utilizar m√©todos sin el prefijo try siempre que sea posible.  De esta manera, se crea un c√≥digo de "autocomprobaci√≥n", que se√±ala errores a tiempo en la l√≥gica y / o los datos de la base de datos. </p></div></div><br><p>  Cuando <code>tryFirst</code> activa <code>tryFirst</code> , las variables del <code>tryFirst</code> se llenan con los datos de un registro, podemos leer y asignarles valores.  Y cuando los datos en el cursor est√°n completamente preparados, ejecutamos <code>update()</code> , y almacena el contenido del cursor en la base de datos. </p><br><p>  ¬øQu√© problema podr√≠a verse afectado este c√≥digo?  Por supuesto, la aparici√≥n de condici√≥n de carrera / actualizaci√≥n perdida.  Porque entre el momento en que recibimos los datos en la l√≠nea con "tryFirst" y el momento en que intentamos actualizar estos datos en el punto de "actualizaci√≥n", alguien m√°s ya puede recibir, modificar y actualizar estos datos en la base de datos.  Despu√©s de leer los datos, el cursor no bloquea su uso por otros usuarios.  Para protegerse contra las actualizaciones perdidas, Celesta utiliza el principio de bloqueo optimista.  En cada tabla, por defecto, Celesta crea un campo de <code>recversion</code> , y en el nivel ON del activador UPDATE incrementa el n√∫mero de versi√≥n y verifica que los datos actualizados tengan la misma versi√≥n que la tabla.  Si ocurre un problema, lanza una excepci√≥n.  Puede leer m√°s sobre esto en el art√≠culo del art√≠culo " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Protecci√≥n contra actualizaciones perdidas</a> ". </p><br><p>  Recuerde nuevamente que una transacci√≥n est√° asociada con el objeto CallContext.  Si el procedimiento Celesta tiene √©xito, se produce una confirmaci√≥n.  Si el m√©todo Celesta termina con una excepci√≥n no controlada, se produce la reversi√≥n.  Por lo tanto, si se produce un error en alg√∫n procedimiento complicado, la transacci√≥n completa relacionada con el contexto de la llamada se revierte, como si no hubi√©ramos comenzado a hacer nada con los datos, los datos no est√°n da√±ados.  Si por alguna raz√≥n necesita una confirmaci√≥n en medio de, digamos, alg√∫n tipo de procedimiento grande, entonces se puede ejecutar una confirmaci√≥n expl√≠cita llamando a <code>context.commit()</code> . </p><br><h2 id="testirovanie-metodov-rabotayuschih-s-dannymi">  M√©todos de prueba de datos </h2><br><p>  <code>OrderDto</code> una prueba unitaria que verifique la correcci√≥n del m√©todo de servicio que almacena <code>OrderDto</code> en la base de datos. </p><br><p>  Cuando se usa JUnit5 y la extensi√≥n para JUnit5 disponible en el m√≥dulo de <code>celesta-unit</code> , esto es muy f√°cil.  La estructura de la prueba es la siguiente: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@CelestaTest</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DocumentServiceTest</span></span></span><span class="hljs-class"> </span></span>{ DocumentService srv = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DocumentService(); <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">documentIsPutToDb</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CallContext context)</span></span></span><span class="hljs-function"> </span></span>{ OrderDto doc =... srv.postOrder(context, doc); <span class="hljs-comment"><span class="hljs-comment">//Check the fact that records are in the database OrderHeaderCursor header = new OrderHeaderCursor(context); header.tryFirst(); assertEquals(doc.getId(), header.getId()); OrderLineCursor line = new OrderLineCursor(context); line.setRange("order_id", doc.getId()); assertEquals(2, line.count()); } }</span></span></code> </pre> <br><p>  Gracias a la anotaci√≥n <code>@CelestaTest</code> , que es una extensi√≥n para JUnit5, podemos declarar el par√°metro de <code>CallContext context</code> en los m√©todos de prueba.  Este contexto ya est√° activado y vinculado a la base de datos (en memoria H2) y, por lo tanto, no necesitamos envolver la clase de servicio en un proxy; lo creamos usando <code>new</code> y no usando Spring.  Sin embargo, si es necesario, inyecte el servicio en la prueba usando las herramientas Spring, no hay obst√°culos para esto. </p><br><p>  Creamos pruebas unitarias bajo el supuesto de que en el momento de su ejecuci√≥n la base de datos estar√° completamente vac√≠a, pero con la estructura que necesitamos, y despu√©s de su ejecuci√≥n no podemos preocuparnos por el hecho de que dejamos "basura" en la base de datos.  Estas pruebas se realizan a una velocidad muy alta. </p><br><p>  Creemos un segundo procedimiento que devuelva JSON con valores agregados que muestren cu√°ntos productos pedimos. </p><br><p>  La prueba escribe dos √≥rdenes en la base de datos, despu√©s de lo cual verifica el valor total devuelto por el nuevo m√©todo <code>getAggregateReport</code> : </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reportReturnsAggregatedQuantities</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CallContext context)</span></span></span><span class="hljs-function"> </span></span>{ srv.postOrder(context, . . .); srv.postOrder(context, . . .); Map&lt;String, Integer&gt; result = srv.getAggregateReport(context); assertEquals(<span class="hljs-number"><span class="hljs-number">5</span></span>, result.get(<span class="hljs-string"><span class="hljs-string">"A"</span></span>).intValue()); assertEquals(<span class="hljs-number"><span class="hljs-number">7</span></span>, result.get(<span class="hljs-string"><span class="hljs-string">"B"</span></span>).intValue()); }</code> </pre> <br><p>  Para implementar el m√©todo <code>getAggregateReport</code> usaremos la vista OrderedQty, que, recuerdo, en el archivo CelestaSQL se ve as√≠: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> OrderedQty <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> item_id, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(qty) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> qty <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> OrderLine <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> item_id;</code> </pre> <br><p>  La solicitud es est√°ndar: resumimos las l√≠neas de pedido por cantidad y las agrupamos por c√≥digo de producto.  Ya se ha creado un cursor OrderedQtyCursor para la vista, que podemos usar.  Declaramos este cursor, iteramos sobre √©l y recogemos el <code>Map&lt;String, Integer&gt;</code> deseado: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@CelestaTransaction</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Map&lt;String, Integer&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAggregateReport</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CallContext context)</span></span></span><span class="hljs-function"> </span></span>{ Map&lt;String, Integer&gt; result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap&lt;&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> (OrderedQtyCursor ordered_qty = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OrderedQtyCursor(context)) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (OrderedQtyCursor line : ordered_qty) { result.put(ordered_qty.getItem_id(), ordered_qty.getQty()); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre> <br><h2 id="materializovannye-predstavleniya-celesta">  Vistas materializadas de Celesta </h2><br><p>  ¬øPor qu√© es malo usar una vista para obtener datos agregados?  Este enfoque es bastante viable, pero en realidad pone una bomba de tiempo en todo nuestro sistema: despu√©s de todo, una vista, que es una consulta SQL, se ejecuta m√°s y m√°s lentamente a medida que los datos se acumulan en el sistema.  Tendr√° que resumir y agrupar m√°s y m√°s l√≠neas.  ¬øC√≥mo evitar esto? </p><br><p>  Celesta intenta implementar todas las tareas est√°ndar que los programadores de l√≥gica de negocios enfrentan constantemente a nivel de plataforma. </p><br><p>  MS SQL Server tiene el concepto de vistas materializadas (indexadas), que se almacenan como tablas y se actualizan r√°pidamente a medida que cambian los datos en las tablas de origen.  Si estuvi√©ramos trabajando en un servidor MS SQL "limpio", entonces para nuestro caso, el reemplazo de la vista con una vista indizada ser√≠a justo lo que necesit√°bamos: recuperar el informe agregado no se ralentizar√≠a a medida que se acumularan los datos, y el trabajo para actualizar el informe agregado se realizar√≠a en ese momento insertando datos en la tabla de l√≠neas de orden y tampoco aumentar√≠a mucho con un aumento en el n√∫mero de filas. </p><br><p>  Pero en caso de que trabajemos con PostgreSQL a trav√©s de Celesta, ¬øqu√© podemos hacer?  Redefina la vista agregando la palabra materializada: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">materialized</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> OrderedQty <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> item_id, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(qty) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> qty <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> OrderLine <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> item_id;</code> </pre> <br><p>  Comencemos el sistema y veamos qu√© pas√≥ con la base de datos. </p><br><p>  <code>OrderedQty</code> que la <code>OrderedQty</code> ha desaparecido y la tabla <code>OrderedQty</code> ha aparecido en su <code>OrderedQty</code> .  Adem√°s, como la tabla OrderLine est√° llena de datos, la informaci√≥n en la tabla OrderedQty se actualizar√° "m√°gicamente", como si OrderedQty fuera una vista. </p><br><p>  No hay magia aqu√≠ si miramos los desencadenantes creados en la tabla <code>OrderLine</code> .  Celesta, habiendo recibido la tarea de crear una "vista materializada", analiz√≥ la consulta y cre√≥ desencadenantes en la tabla <code>OrderLine</code> que actualizan <code>OrderedQty</code> .  Al insertar una sola palabra clave, <code>materialized</code> , en el archivo CelestaSQL, resolvimos el problema de la degradaci√≥n del rendimiento, ¬°y el c√≥digo de l√≥gica de negocios ni siquiera necesit√≥ ser cambiado! </p><br><p> ,    ,   , . ¬´¬ª  Celesta    ,    ,  JOIN-,    GROUP BY.     ,  , ,     ,      . .     . </p><br><h2 id="zaklyuchenie">  Conclusi√≥n </h2><br><p>       Celesta.     ‚Äî    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="></a>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="></a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/455746/">https://habr.com/ru/post/455746/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../455736/index.html">Consenso en criptomonedas con miner√≠a h√≠brida y Multi-PoW</a></li>
<li><a href="../455738/index.html">¬øC√≥mo ganar mil millones monetizando sus datos?</a></li>
<li><a href="../455740/index.html">Aprendizaje autom√°tico en una empresa de inversi√≥n: clasificamos las llamadas de asistencia t√©cnica</a></li>
<li><a href="../455742/index.html">Hacer m√∫sica: cuando las soluciones simples superan el aprendizaje profundo</a></li>
<li><a href="../455744/index.html">Sistema de generaci√≥n de paisajes de laberintos con realismo visual mejorado [traducci√≥n del art√≠culo de Jinmo Kim]</a></li>
<li><a href="../455754/index.html">Pruebas de un estratostato a la deriva. Lanzamiento de Rogozin y LoRa en la estratosfera.</a></li>
<li><a href="../455756/index.html">Es [favor] th</a></li>
<li><a href="../455758/index.html">Hacking de crecimiento en el cohete minorista: de la b√∫squeda de hip√≥tesis a las t√©cnicas de prueba</a></li>
<li><a href="../455760/index.html">La magia de SwiftUI o sobre los creadores de funciones</a></li>
<li><a href="../455762/index.html">Una breve introducci√≥n a las cadenas de Markov.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>