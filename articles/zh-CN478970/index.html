<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🐺 👩🏿‍💼 🔤 DIY呼叫按钮第2部分。RaspberryPi的可视电话 👏🏽 👩🏻‍🤝‍👨🏿 🍕</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="在这一部分中，我们将制造用于使用SIP协议进行视频通话的Raspberry Pi VoIP设备。 

 初始任务保持不变-通过外部影响进行呼叫（按一个按钮）。 但是这个想法的实现发生了变化。 与上一部分一样，我们将使用Linphonec终端SIP客户端，但是为了简化设置，我决定使用Zadarma.c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>DIY呼叫按钮第2部分。RaspberryPi的可视电话</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/478970/"> 在这一部分中，我们将制造用于使用SIP协议进行视频通话的Raspberry Pi VoIP设备。 <br><br> 初始任务保持不变-通过外部影响进行呼叫（按一个按钮）。 但是这个想法的实现发生了变化。 与上一部分一样，我们将使用Linphonec终端SIP客户端，但是为了简化设置，我决定使用Zadarma.com VoIP提供程序以及免费的网络电话，包括视频支持。 对于视频通话，我使用了廉价的USB摄像头。 <br><br> 详细信息以及切工下的分步说明。 <br><a name="habracut"></a><br>  <a href="https://habr.com/ru/post/464309/">第一部分</a> <br> 该系统<u><b>开箱即用地</b></u>部署在<u><b>RPI v3_40_int</b></u>的<u><b>基础映像上，</b></u>而无需安装任何其他组件。 <br><br>  <a href="https://connect.smartliving.ru/tasks/20.html" rel="nofollow">链接Raspberry的基本MajorDoMo图像</a> <br><br> 我使用的网络摄像头是预算（在明斯克约7 ye）-Ritmix RVC-015M。 能够手动调整焦点。 <br><br> 在测试和撰写帖子的过程中，我决定放弃使用VoIP服务器（Fresswitch）。 安装VoIP服务器会使设置过程复杂化，但可以提供更大的灵活性。 <br><br> 例如，我们将使用Habr VoIP上展示的运营商<a href="https://habr.com/ru/company/zadarma/profile/">Zadarma</a> 。 <br><br> 要拨打电话，我们需要在SIP服务器上有两个帐户。 在一种情况下，Raspberry Pi和控制台客户端可以工作，第二种用于智能手机（或PC）。 注册过程很直观，不需要描述。 <br><br> 我将简要重复Linphone软件包的安装和配置，在第一部分中将提供更多详细信息。 <br><br><h3> 安装和组装Linphone </h3><br><h4> 准备安装： </h4><br> 停止运行但未使用的服务： <br><br><div class="spoiler">  <b class="spoiler_title">停止服务</b> <div class="spoiler_text"><pre><code class="plaintext hljs">sudo systemctl stop freeswitch.service sudo systemctl stop majordomo.service sudo systemctl stop avahi-daemon.socket sudo systemctl stop avahi-daemon.service sudo systemctl stop mosquitto.service sudo systemctl stop mysql sudo systemctl stop mpd.service sudo systemctl stop mpd.socket sudo systemctl stop homebridge.service sudo systemctl stop nginx.service sudo systemctl stop bluetooth.target sudo systemctl stop bluetooth.service</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">创建一个临时交换交换文件</b> <div class="spoiler_text"> 为了以防万一，我们创建了一个临时（在重新启动系统之前）交换文件（硬盘空间），操作系统会在RAM不足的情况下使用该文件。 <br><br> 备用命令：检查交换文件是否包含在我们的Raspbian（Debian）安装中；如果输出为空，则表示系统上缺少交换文件。 <br> 添加1G交换并创建文件。 <br><br> 我们为此文件设置了正确的权限，只有root用户才能读取和写入页面文件。 <br><br> 我们使用mkswap工具在文件中配置Linux交换区域并激活它： <br><br><pre> <code class="plaintext hljs">sudo swapon --show sudo fallocate -l 1G /swapfile sudo chmod 600 /swapfile sudo mkswap /swapfile sudo swapon /swapfile</code> </pre> </div></div><br><h3> 安装Linphonec控制台SIP客户端和Linphonecsh管理实用程序 </h3><br> 为了从源代码构建软件包，我们安装了其他依赖项： <br><br><pre> <code class="plaintext hljs">sudo apt-get install cmake automake autoconf libtool intltool yasm libasound2-dev libpulse-dev libv4l-dev nasm git libglew-dev</code> </pre> <br> 我们转到主目录并下载Linphone软件包本身，下载大约花费了20分钟： <br><br><pre> <code class="plaintext hljs">cd /home/pi/ git clone git://git.linphone.org/linphone-desktop.git -recursive</code> </pre><br> 下载软件包时，我们进入创建的目录，准备安装没有图形界面的版本： <br><br><pre> <code class="plaintext hljs">cd linphone-desktop sudo ./prepare.py no-ui -DENABLE_OPENH264=ON -DENABLE_WEBRTC_AEC=OFF -DENABLE_UNIT_TESTS=OFF -DENABLE_MKV=OFF -DENABLE_FFMPEG=ON -DENABLE_CXX_WRAPPER=OFF -DENABLE_NON_FREE_CODECS=ON -DENABLE_VCARD=OFF -DENABLE_BV16=OFF -DENABLE_V4L=OFF</code> </pre> <br> 使用–j4属性进行构建（即，同时构建4个线程： <br><br><pre> <code class="plaintext hljs">sudo make -j4</code> </pre> <br> 组装需要30-40分钟。 <br><br> 编译的程序文件出现在OUTPUT / no-ui / bin目录中。 要运行该程序，请转到它，检查程序的版本： <br><br><pre> <code class="plaintext hljs">cd OUTPUT/no-ui/bin ./linphonec -v</code> </pre> <br>  <i>我们得到的结果是：版本：3.12.0</i> <br><br> 重载我们的Raspberry。 <br><br> 重新启动时，将还原启动时注册的所有服务，并删除页面文件。 <br><br><h2> 设置终端SIP客户端Linphonec </h2><br> 从当前的pi用户以自动应答模式运行Linphonec： <br><br><pre> <code class="plaintext hljs">/home/pi/linphone-desktop/OUTPUT/no-ui/bin/linphonec</code> </pre> <br> 首次启动时，Linphonec尝试创建数据库文件和设置文件。 但是，启动发生错误，程序停止。 <br><br> 在第一部分中如何从当前用户（pi）创建目录 <br><br><pre> <code class="plaintext hljs">mkdir /home/pi/.local mkdir /home/pi/.local/share mkdir /home/pi/.local/share/linphone</code> </pre> <br> 因为 在我们的情况下，我们不使用VoIP服务器，则使用IP电话5060的标准端口。 <br><br> 我们将通过在Linphonec中执行以下命令来注册其中一个帐户： <br><br><pre> <code class="plaintext hljs">register sip:XXXXXX@sip.zadarma.com sip.zadarma.com YYYYYYY</code> </pre> <br> 可以通过键入帮助注册来查看命令的格式。 <br><br> 在我们的情况下，XXXXXX是帐号（登录），YYYYY是注册期间发出的密码。 检查注册： <br><br><pre> <code class="plaintext hljs">status register</code> </pre> <br> 成功注册后的响应： <i>已注册，身份= sip：XXXXX@sip.zadarma.com持续时间= 3600</i> <br><br> 通过按ctrl + c或quit命令退出客户端。 <br><br> 在主目录/ home / pi中退出后，控制台客户端配置文件出现：.linphonerc。 <br><br><h3> 连接网络摄像机 </h3><br> 我们连接到Raspberry相机。 <br><br> 检查我的帐户是否包含在视频组中 <br><br><pre> <code class="plaintext hljs">cat /etc/group | grep video</code> </pre> <br> 答案： <i>视频：x：44：pi</i> <br><br> 让我们看看您的系统中的网络摄像头是否已确定： <br><br><pre> <code class="plaintext hljs">sudo ls -l /dev/ | grep video</code> </pre> <br> 检查是否确定了相机的麦克风： <br><br><pre> <code class="plaintext hljs">arecord -l</code> </pre> <br> 答案是： <br><br>  <i>CAPTURE硬件设备列表</i> <i><br></i>  <i>卡1：摄像机[USB2.0 PC摄像机]，设备0：USB音频[USB音频]</i> <i><br></i>  <i>子设备：1/1</i> <i><br></i>  <i>子设备0：子设备0</i> <br><br> 一切都井井有条，也有一个麦克风。 我们将在alsemikser中对其进行检查 <br><br><pre> <code class="plaintext hljs">alsamixer</code> </pre> <br> 我将立即澄清，我的麦克风默认情况下处于打开状态，它已被确定为主要麦克风，并且几乎完全扭曲，并且具有强大的过载能力。 <br><br> 按F6（选择卡），选择USB PC摄像机，然后按F4-Capture设备（摄像机上的麦克风），将其级别降低至几乎为零，同时按下光标键，同时我们将选中Capture。 <br><br><img src="https://habrastorage.org/webt/m1/t9/eb/m1t9ebbgvi01vbrtj4lb1vkysok.png">  ” <br><br> 在Android的应用程序市场中，我安装了Linphone应用程序（尝试了几次，只有它开始广播视频。在Windows上，我使用的所有SIP客户端都可以正常工作。它在我的SIP服务器上也可以正常工作（freeswitch，如果在本地使用，不仅是网络，最好的选择是服务器+来自本地网络的呼叫网关。 <br><br> 有关设置Linphone Android应用程序的说明，请访问Zadarma.com。 <br>  <a href="https://zadarma.com/ru/support/instructions/android/linphone/" rel="nofollow">来自SIP提供程序的说明</a> 。 <br><br> 我们在Zadarma上注册了手机，然后（可选）我们配置视频，音频等。 <br><br> 为了进行测试，我们在RPI中运行带有视频通话和自动应答功能的linphonec实用程序（添加-V -a键）： <br><br><pre> <code class="plaintext hljs">/home/pi/linphone-desktop/OUTPUT/no-ui/bin/linphonec -V -a</code> </pre> <br> 并通过键入以下内容在终端客户端中拨打电话： <br><br><pre> <code class="plaintext hljs">call 576935</code> </pre> <br>  VoIP服务器（域）替换是自动执行的，尽管您可以完全拨入SIP地址。 <br><br> 结果，我们得到： <br><br><img src="https://habrastorage.org/webt/ae/yb/k5/aeybk565vplirfecvbnfmylgyh8.jpeg"><br>  （在距镜头2-3米的距离内，此相机的质量或多或少）。 <br><br> 我们可以通过在智能手机上拨打RPI号码来检查自动应答模式。 <br><br> 要在守护程序模式下运行和控制Linphonec，请使用Linphonecsh实用程序。 <br><br> 最初，在启动时，需要初始化linphonecsh -init客户端。 执行此命令后，控制台客户端将启动，而不会加载配置文件。 <br> 为了在启动时读取配置文件，将使用标志-s-V -a启动进行视频通话和自动接听来电的功能： <br><br><pre> <code class="plaintext hljs">/home/pi/linphone-desktop/OUTPUT/no-ui/bin/linphonecsh init -c /home/pi/.linphonerc -V -a</code> </pre> <br> 现在，我们可以从OS和MajorDoMo的命令行管理控制台客户端。 <br><br> 从终端启动视频通话的命令： <br><br><pre> <code class="plaintext hljs">/home/pi/linphone-desktop/OUTPUT/no-ui/bin/linphonecsh dial XXXXX</code> </pre> <br> 可以采取第一步。 <br><br><h3> 连接按钮并使用GPIO </h3><br><img src="https://habrastorage.org/webt/ox/fd/z3/oxfdz3i_gcu-ga22wx6et4lqqya.jpeg"><br><br>  Raspberry Pi具有多个接口的GPIO端口（通用输入/输出）。 它包含可连接各种执行器的通用输入和输出，在我们的情况下是一个简单的按钮。 <br><br> 几乎所有的GPIO引脚（有几个保留）都可以设置为以下两种状态之一：“输出”（aka OUT或逻辑1）或“输入”（IN或逻辑0）。 输出电压为3.3V。 <br><br> 对于我的按钮，我将使用第一行中最右边的两个图钉。 将连接器＃38（GPIO20）设置为“输出”（OUT），将连接器＃40（GPIO21）设置为“输入”（IN）。 <br><br>  BBJ跳线用于连接到GPIO梳。 当树莓从网络断开时，建议连接。 <br><br> 让我们创建两个脚本。 第一个用于初始化GPIO端口，第二个用于Linphonecsh实用程序控制命令。 <br><br>  Bash脚本初始化GPIO端口： <br><br><pre> <code class="plaintext hljs">sudo nano /usr/local/bin/gpio21.sh</code> </pre> <br> 并粘贴内容 <br><br><div class="spoiler">  <b class="spoiler_title">gpio21.sh</b> <div class="spoiler_text">  ＃！  / bin / bash <br>  ＃设置GPIO20并设置为输出 <br> 回声20&gt; / SYS /类/ GPIO /出口 <br> 回显&gt; / sys / class / gpio / gpio20 /方向 <br> 回声1&gt; / sys / class / gpio / gpio20 /值 <br>  ＃设置GPIO21并设置为输入 <br> 回声21&gt; / SYS /类/ GPIO /出口 <br> 回显&gt; / sys / class / gpio / gpio21 /方向 <br></div></div><br> 我们使文件可执行： <br><br><pre> <code class="plaintext hljs">sudo chmod +x /usr/local/bin/gpio21.sh</code> </pre> <br> 我决定使用PHP来完成第二个用于单击按钮的脚本，以便随后与MajorDoMo家庭自动化系统集成。 只需按一下按钮，端口21的状态就会改变，系统会定期读取端口21的值，如果更改，则会向Linphonecsh发送拨号命令。 <br><br><pre> <code class="plaintext hljs">sudo nano /usr/local/bin/dial.php</code> </pre> <br> 并粘贴内容： <br><br><div class="spoiler">  <b class="spoiler_title">Dial.php</b> <div class="spoiler_text">  &lt;？PHP <br>  $ old_state = 0; <br> 而（真） <br>  { <br>  $ state = file_get_contents（'/ sys / class / gpio / gpio21 / value'）; <br> 如果（$ state！= $ old_state） <br>  { <br> 如果（$ state == 1） <br>  { <br>  //拨打新电话 <br> 回声“ make”； <br>  exec（“ sudo -u pi / home / pi / linphone-desktop / OUTPUT / no-ui / bin / linphonecsh拨号sip：XXXXX@sip.zadarma.com”）； <br> 休眠（200000）; <br>  } <br>  $ old_state = $ state; <br>  } <br> 睡着了（20000）; <br>  } <br>  ？&gt; <br></div></div><br> 我们使文件可执行。 <br><br> 接下来，我们在启动文件的最后写三行： <br><br><ol><li>  GPIO端口初始化脚本 </li><li> 在自动应答模式下启动管理实用程序并支持视频传输 </li><li>  PHP脚本拨号。 </li></ol><br><pre> <code class="plaintext hljs">crontab -e</code> </pre> <br><br><pre> <code class="plaintext hljs">@reboot sudo /usr/local/bin/gpio21.sh @reboot sudo -u pi /home/pi/linphone-desktop/OUTPUT/no-ui/bin/linphonecsh init -c /home/pi/.linphonerc -V -a @reboot sudo php /usr/local/bin/dial.php</code> </pre> <br> 重载我们的Raspberry，sudo重新启动。 重新启动后，我们的可视电话即可使用。 <br><br> 此外，如果需要并且可能的话-集成到家庭自动化系统中，连接到SIP服务器等。 <br><br><div class="spoiler">  <b class="spoiler_title">等待和进行视频通话时的RPI加载</b> <div class="spoiler_text"> 等待和进行视频通话时的RPI加载： <br><br><img src="https://habrastorage.org/webt/kg/gl/rv/kgglrvchkeffwsetw_lrhmzrili.png"><br><br><img src="https://habrastorage.org/webt/ex/rq/0n/exrq0nlihpbkpg_rg83cgokupmy.png"><br></div></div><br><h4> 一个小的题外话 </h4><br> 最初，我计划制造一种与生病后无法独自使用电话的人进行通讯的设备，此后这种需求消失了，但决定完成这项工作，并且我发现可以将家庭自动化的组件之一用于其他目的。 <br><br> 创建时，我希望满足以下条件，或者至少满足三分之二： <br><br><ol><li> 可用性（现在（在我所在的地区）购买组件的能力。 </li><li> 预算（出口处设备的低成本）。 </li><li> 执行的简单性，或者至少是分步说明的完整性（无需特殊知识和时间成本即可重复使用该设备的人制造设备并开始使用它的能力）。 </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN478970/">https://habr.com/ru/post/zh-CN478970/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN478956/index.html">通过Chrome VoIP客户端和适用于Android的视频应用程序引入3CX V16 Update 4 Beta</a></li>
<li><a href="../zh-CN478958/index.html">适用于任何规模企业的完整Windows 10升级指南</a></li>
<li><a href="../zh-CN478960/index.html">迷你光线和震动传感器| nRF52840</a></li>
<li><a href="../zh-CN478962/index.html">Ilya Yakyamsev：效率不起作用</a></li>
<li><a href="../zh-CN478968/index.html">SpaceX发射纳米机架创建空间碎片轨道站</a></li>
<li><a href="../zh-CN478972/index.html">Miro平台竞赛的获胜者</a></li>
<li><a href="../zh-CN478974/index.html">使用动态导入自动加载模块</a></li>
<li><a href="../zh-CN478984/index.html">TimTam-具有独特的尖端加热功能的新一代敲击按摩器</a></li>
<li><a href="../zh-CN478986/index.html">Yandex对复古游戏发起了广泛的投票。 复古游戏之战入围2019</a></li>
<li><a href="../zh-CN478988/index.html">威尼斯：一对裸石上的暴利</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>