<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üö° üôçüèø ‚§¥Ô∏è Hist√≥ria do conversor Ethernet-CAN ‚ôâÔ∏è üëãüèº üë©üèæ‚Äç‚öïÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Um dia claro e ensolarado para o trabalho precisava de um conversor de interface CAN para Ethernet de baixo custo. Naturalmente, a pesquisa come√ßou co...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Hist√≥ria do conversor Ethernet-CAN</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/464043/">  Um dia claro e ensolarado para o trabalho precisava de um conversor de interface CAN para Ethernet de baixo custo.  Naturalmente, a pesquisa come√ßou com solu√ß√µes prontas, mas, como acontece com frequ√™ncia, no final, decidiu-se desenvolver sua pr√≥pria amostra.  Naturalmente, o entusiasmo do autor n√£o p√¥de resistir e se limitou a uma funcionalidade t√£o "truncada".  O que aconteceu, como e por qu√™ - sob o corte. <br><br><img src="https://habrastorage.org/webt/9c/j9/x_/9cj9x_lrqkpkajyzd6irhhqkfmu.jpeg" alt="imagem"><br><a name="habracut"></a><br>  <b>Resumo geral.</b>  A foto acima mostra um modelo 3D da placa que desenvolvi usando o CAD Altium Designer.  Principais recursos e funcionalidades: <br><br><ul><li>  Ethernet de 10 \ 100 Mb </li><li>  Rtc </li><li>  MicroSD (FAT12, FAT16, FAT32) 4GB </li><li>  RS232 \ RS485 </li><li>  CAN </li><li>  Campainha </li><li>  3 LED do usu√°rio </li><li>  GPIO </li><li>  EEPROM 32 KB </li><li>  FLASH 2 MB </li><li>  I2C </li><li>  SPI </li><li>  UART </li><li>  SW \ JTAG </li><li>  Serial USB (porta COM) </li><li>  Pot√™ncia: miniUSB 5V \ Externo 9..24V </li></ul><br>  O custo da placa coletada √© de ~ 5000 R. O projeto √© de c√≥digo aberto por natureza, as fontes podem ser encontradas no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><b><u>github</u></b></a> .  O que resultou no final, al√©m da funcionalidade principal, pode ser considerado uma boa placa de depura√ß√£o para trabalhar com o microcontrolador STM32. <br><br>  E agora aos detalhes da cria√ß√£o. <br><br><h3>  <b>Hardware</b> </h3><br>  O estudo desse problema come√ßou com a busca e avalia√ß√£o de solu√ß√µes prontas.  Os principais requisitos foram: <br><br><ol><li>  convers√£o de quadros CAN2.0B recebidos em pacotes TCP \ IP e vice-versa; </li><li>  baixo custo, como resultado, a implementa√ß√£o de um dispositivo baseado em um microcontrolador. </li></ol><br>  Os colegas da China t√™m v√°rias solu√ß√µes industriais, mas n√£o baratas, ent√£o um representante do PIRS CAN-Ethernet Interface Converter da produ√ß√£o dom√©stica foi entregue em nosso escrit√≥rio para um teste.  De acordo com as capacidades e caracter√≠sticas descritas, o dispositivo satisfez o modesto T.Z., restava apenas verificar o desempenho na pr√°tica, o que eu fiz, armado com o Wireshark e o oscilosc√≥pio.  Por um motivo desconhecido, ao enviar pacotes para o dispositivo TCP na sa√≠da do dispositivo, onde os quadros CAN deveriam aparecer, sequ√™ncias com n√≠veis f√≠sicos de CAN (par diferencial), mas com protocolo l√≥gico da interface UART (com bits de in√≠cio e parada).  Abrindo o gabinete, abrindo a documenta√ß√£o dos microcircuitos e tocando os trilhos da placa, descobri que, de fato, os pinos RX e TX (UART) do microcontrolador est√£o conectados ao transceptor CAN e a um conector externo.  Portanto, n√£o era de esperar nenhum suporte de hardware para o padr√£o CAN2.0B. <br><br>  Aqui est√° o que eu vi na sa√≠da CANL do "PIRS CAN-Ethernet" ao enviar dois bytes de dados [ <b>0xF0</b> ] e [ <b>0x0A</b> ] atrav√©s de TCP \ IP: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6db/dca/c5a/6dbdcac5aec7d91503f4a5f86e28c42b.jpg" alt="imagem"><br><br>  A ordem dos bits est√° de cabe√ßa para baixo, mas voc√™ pode lidar com isso programaticamente, mas j√° √© mais dif√≠cil fazer algo no n√≠vel do aplicativo com os bits de in√≠cio e parada em cada byte, porque  eles s√£o inseridos no hardware. <br><br>  E aqui est√° como deve ser o quadro CAN2.0B "verdadeiro" com os mesmos dois bytes de dados: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/674/9b2/244/6749b2244e3b9aa0b7564701f285131a.jpg" alt="imagem"><br><br>  Como voc√™ pode ver no oscilograma, al√©m dos bytes de dados, o quadro cont√©m muitos bits de servi√ßo do protocolo, al√©m de bits de preenchimento, e o mais importante, eles passam continuamente sem nenhum bit de in√≠cio e parada!  (Para aqueles que est√£o interessados, no spoiler, uma descri√ß√£o detalhada deste pacote). <br><br><div class="spoiler">  <b class="spoiler_title">Spoiler</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/54b/834/618/54b8346189dcb5ecdd01f83bcaab0e1b.jpg" alt="imagem"><br><br>  Os primeiros 4 bytes s√£o o identificador de quadro.  Voc√™ pode aprender mais sobre o formato CAN em <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">[1]</a> <br></div></div><br>  Assim, n√£o foi poss√≠vel resolver o problema de incompatibilidade dos quadros CAN e UART com um m√©todo de software e, olhando os resultados intermedi√°rios da pesquisa com um olhar decepcionado, decidiu-se desenvolver nosso pr√≥prio prot√≥tipo do dispositivo necess√°rio. <br><br>  Devido ao fato de que agora era poss√≠vel controlar uma ampla variedade de caracter√≠sticas t√©cnicas do dispositivo, foram adicionados os seguintes requisitos: <br><br>  3. Capacidade de alimenta√ß√£o de 12 a 24 V em sistemas de transporte; <br>  4. A presen√ßa de mem√≥ria externa para armazenar logs; <br>  5. As dimens√µes da placa n√£o s√£o mais do que 86x80mm. <br>  6. Faixa de temperatura operacional -40..85 ¬∞ C <br><br>  A conhecida plataforma <b>STM32F407VET6</b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">[2]</a> foi selecionada como o c√©rebro do novo dispositivo, que possui suporte de hardware para todas as interfaces necess√°rias e um bom suprimento de mem√≥ria RAM e FLASH.  Tendo polido a Internet, o transceptor <b>DP83848IVV</b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">[3]</a> foi escolhido como PHY Ethernet, que possui, na minha opini√£o, boa documenta√ß√£o e exemplos suficientes de esquemas de conex√£o e roteamento.  Como mem√≥ria externa n√£o vol√°til para armazenar logs, escolhi o SPI FLASH 2 MB e o SPI EEPROM para armazenar uma variedade de configura√ß√µes.  Al√©m disso, prote√ß√£o de energia contra sobretens√£o, invers√£o de polaridade foi adicionada.  Ap√≥s N noites e M fins de semana, foram compilados um diagrama de circuito e um tra√ßo da placa de circuito impresso do dispositivo da primeira vers√£o.  Porque  havia espa√ßo suficiente na placa, mas eu n√£o queria deixar as pernas ociosas do MK, al√©m da funcionalidade principal, a placa foi adicionada: <br><br><ul><li>  ferramentas de depura√ß√£o SW, JTAG; </li><li>  Switch 8-DIP; </li><li>  micro-USB (USB Serial); </li><li>  RS-232; </li><li>  UART </li><li>  I2C; </li><li>  GPIO </li></ul><br>  A id√©ia era que, se necess√°rio, a placa estivesse pronta para expandir a funcionalidade instalando componentes adicionais.  Al√©m disso, os assentos sobressalentes n√£o afetam o custo de produ√ß√£o.  Por um lado, infelizmente, por isso, n√£o foi poss√≠vel encaixar tudo, ent√£o a placa acabou sendo 86x80mm bilateral, min.  largura da trilha 0,25 mm, di√¢metro m√≠nimo do furo 0,6 mm. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1da/700/38b/1da70038b98ca9c7019df4d0f984d5d2.jpg" alt="imagem"><br>  <i>A primeira vers√£o do design de PCB</i> <br><br>  Mais tarde, duas amostras de teste foram encomendadas e montadas com um conjunto completo de perif√©ricos para pesquisa.  Para economizar dinheiro, a prancha foi feita sem m√°scara e, portanto, possui uma cor t√£o incomum. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/db9/db1/5e4/db9db15e4cc7c7e0b2da0ed782d4a28b.jpg" alt="imagem"><br><br>  Com a ajuda do STM32CubeMX, esbocei um firmware de teste com um teste de operacionalidade dos principais m√≥dulos perif√©ricos do dispositivo e, como primeira aproxima√ß√£o, tudo funcionou, exceto para iniciar o MC a partir de um quartzo externo de 8 MHz.  Aconteceu que, devido ao meu erro na elabora√ß√£o da especifica√ß√£o, os capacitores de carga incorretos foram soldados.  Mas isso n√£o impediu o STM32F407 de trabalhar com um gerador RC interno.  Quando consegui executar ping no meu dispositivo, n√£o houve alegria restritiva.  Demorei mais tempo com o rastreamento PHY Ethernet.  Ent√£o, no navegador, vi minha p√°gina http de teste e me acalmei com o teste. <br><br>  A produ√ß√£o das primeiras amostras dos pain√©is foi encomendada em Zelenograd.  E, apesar do custo de ‚Äúcom‚Äù a m√°scara e ‚Äúsem‚Äù ser quase duas vezes diferente, n√£o recomendo fazer isso nem no est√°gio de prot√≥tipo, porque, como regra, √© nesse est√°gio que os erros de rastreamento aparecem e algo acontece solda.  Mas ficar b√™bado nas pistas "despojadas" √© extremamente desagrad√°vel, economize dinheiro, mas quase sem nervosismo.  Sim, e adivinhando se houve uma pequena pausa em algum lugar ou se o tra√ßo est√° incorreto - um prazer.  Devido √† minha inexperi√™ncia, soldando um ressonador de quartzo e capacitores de carga, matei uma amostra. <br><br>  Naquela √©poca, no trabalho, nas caixas havia um peda√ßo de ferro capaz de resolver a tarefa de convers√£o no projeto atual, mas, al√©m do grande tamanho e custo, tendo escrito o firmware, encontrei problemas relacionados ao tamanho da RAM e √† funcionalidade truncada da pilha TCP \ IP MK LPC2368.  Portanto, o desejo de tornar seu dispositivo apenas se intensificou. <br>  Tendo estudado cuidadosamente as defici√™ncias da primeira vers√£o, eu, sem pensar duas vezes, passei para a segunda.  E, novamente, eu queria adicionar um "backlog para o futuro", incorporando os seguintes componentes no fator de forma anterior: <br><br><ul><li>  Suporte RTC com bateria; </li><li>  RS-485; </li><li>  micro-SD; </li><li>  campainha tweeter; </li><li>  a capacidade de alimentar a partir do USB; </li><li>  SPI para conector externo; </li><li>  5V e 3.3V de energia para um conector externo. </li></ul><br>  Entre outras coisas, a prote√ß√£o de energia atual e os diodos TVS nos conectores do usu√°rio foram adicionados. <br><br>  O resultado √© um tipo de placa de desenvolvimento com a capacidade de conectar m√≥dulos externos.  Dessa vez, pedi uma placa na China.  A assembl√©ia foi realizada conosco. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/924/1b4/c09/9241b4c09c97f002b49cd58dab0ab45b.jpg" alt="imagem"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/bde/d6e/f48/bded6ef48b3f6910968a1ae26c7500f4.jpg" alt="imagem"><br>  <i>A segunda vers√£o do quadro</i> <br><br>  Na segunda vers√£o, descobri a modelagem 3D no Altium Designer, que ajudou muito a evitar erros no posicionamento relativo dos componentes nos dois lados (verificou-se que a Internet j√° est√° cheia de modelos prontos de componentes SMD <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">[4]</a> ).  Assim, todos os erros da primeira vers√£o foram corrigidos, as inova√ß√µes mostraram sua efici√™ncia, o que me deixou muito feliz. <br><br><h3>  Firmware </h3><br>  A descri√ß√£o do c√≥digo est√° al√©m do escopo desta parte, no entanto, gostaria de dizer algumas palavras sobre o componente de software.  No meu dispositivo, decidi usar a pilha FreeRTOS + LwIP.  H√° um n√∫mero suficiente de artigos sobre eles, por exemplo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">[5]</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">[6]</a> , portanto n√£o deve ser dif√≠cil vincul√°-los ao seu projeto.  Em resumo, o LwIP √© uma pilha TCP \ IP para sistemas embarcados, caracterizada pelo baixo consumo de RAM e uma API conveniente (existe at√© um shell de soquete BCD).  Eu usei a API netconn.  Por meio do FreeRTOS, todo o trabalho da pilha TCP \ IP √© colocado em um fluxo separado do aplicativo.  Al√©m do trabalho principal (conectar um servidor TCP externo ao barramento CAN), um servidor da Web separado est√° girando em um fluxo independente para acessar as configura√ß√µes do dispositivo.  Essa interface da Web destina-se a monitorar e definir as configura√ß√µes do dispositivo - definindo diferentes modos de opera√ß√£o, velocidades de transmiss√£o, endere√ßos etc.  Ainda n√£o sei se ser√° poss√≠vel fazer uma atualiza√ß√£o de firmware atrav√©s dele. <br><br><h3>  Conclus√£o </h3><br>  Esse foi o meu primeiro (e espero que n√£o seja o √∫ltimo) projeto de hardware com tanta complexidade e, apesar dos erros cometidos, a segunda vers√£o do conselho, eu acho, pode ser considerada bem-sucedida.  Em cada itera√ß√£o, havia muitas d√∫vidas, mas, no entanto, mais uma vez estou convencido de que, se voc√™ n√£o tentar, nada certamente resultar√°. <br><br><h3>  Fontes utilizadas </h3><br>  1. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Wikipedia / Controller_Area_Network</a> <br>  2. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Folha de dados do STM32F407VET6</a> <br>  3. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Folha de dados DP83848</a> <br>  4. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">modelos 3D</a> <br>  5. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Introdu√ß√£o ao FreeRTOS</a> <br>  6. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Introdu√ß√£o ao LwIP</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt464043/">https://habr.com/ru/post/pt464043/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt464027/index.html">Como sobreviver ao conte√∫do na era da explos√£o de informa√ß√µes</a></li>
<li><a href="../pt464031/index.html">‚ÄúAchados de um Audioman√≠aco‚Äù: placas de som como uma maneira de mergulhar na atmosfera de uma cidade desconhecida</a></li>
<li><a href="../pt464037/index.html">Not√≠cias do mundo do OpenStreetMap n¬∫ 472 (30/07/2019 - 05.08.2019)</a></li>
<li><a href="../pt464039/index.html">Redes neurais e aprendizado profundo: um tutorial on-line, cap√≠tulo 6, parte 2: progresso recente no reconhecimento de imagens</a></li>
<li><a href="../pt464041/index.html">Por que os melhores pilotos de ca√ßa costumam ter grandes problemas</a></li>
<li><a href="../pt464045/index.html">Como corri quase em tempo real em 1997</a></li>
<li><a href="../pt464053/index.html">Nota: algoritmo de sele√ß√£o e rota√ß√£o de trilhas</a></li>
<li><a href="../pt464055/index.html">Estudamos os dados coletados pelo Xiaomi Mi Band para o ano</a></li>
<li><a href="../pt464057/index.html">Hilbert, Lebesgue ... e o Vazio</a></li>
<li><a href="../pt464063/index.html">Cortando o cabo em 2019</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>