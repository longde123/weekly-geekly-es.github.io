<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíÉüèΩ ü§¥üèø üìØ Serveur client transparent üí≤ üë©üèº‚Äçü§ù‚Äçüë©üèª üë©üèø‚Äç‚öïÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Tout projet client-serveur implique une s√©paration claire de la base de code en 2 parties (parfois plus) - client et serveur. Souvent, chacune de ces ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Serveur client transparent</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/435494/"><img src="https://habrastorage.org/webt/rq/-9/mh/rq-9mhais2g6p5dd5tsfv8rllak.jpeg" align="left">  Tout projet client-serveur implique une s√©paration claire de la base de code en 2 parties (parfois plus) - client et serveur.  Souvent, chacune de ces parties est ex√©cut√©e sous la forme d'un projet ind√©pendant distinct, soutenu par sa propre √©quipe de d√©veloppeurs. <br><br>  Dans cet article, je propose un regard critique sur la division mat√©rielle standard du code en un backend et un frontend.  Et consid√©rez une alternative o√π le code n'a pas de ligne claire entre le client et le serveur. <br><br><a name="habracut"></a><br><br><h3>  Inconv√©nients de l'approche standard </h3><br>  Le principal inconv√©nient de la s√©paration standard du projet en 2 parties est l'√©rosion de la logique m√©tier entre le client et le serveur.  Nous modifions les donn√©es du formulaire dans le navigateur, les v√©rifions dans le code client et les envoyons au village du grand-p√®re (au serveur).  Le serveur est d√©j√† un autre projet.  L√†, vous devez √©galement v√©rifier l'exactitude des donn√©es re√ßues (c'est-√†-dire dupliquer les fonctionnalit√©s du client), effectuer des manipulations suppl√©mentaires (enregistrer dans la base de donn√©es, envoyer des e-mails, etc.). <br><br>  Ainsi, afin de tracer tout le chemin des informations depuis le formulaire dans le navigateur jusqu'√† la base de donn√©es sur le serveur, nous devons plonger dans deux syst√®mes diff√©rents.  Si les r√¥les sont divis√©s en √©quipe et que diff√©rents sp√©cialistes sont responsables du backend et du frontend, des probl√®mes d'organisation suppl√©mentaires surviennent li√©s √† leur synchronisation. <br><br><h3>  R√™vons </h3><br>  Supposons que nous puissions d√©crire le chemin de donn√©es entier du formulaire sur le client √† la base de donn√©es sur le serveur dans un mod√®le.  Dans le code, cela peut ressembler √† ceci (le code ne fonctionne pas): <br><br><pre><code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyDataModel</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//         verifyData(data) { //   .... return true; } //       client saveData(data) { if(this.verifyData(data)) this.writeDataToDb(data) else consol.log('error') } //  .     server writeDataToDb(data) { if(this.verifyData(data)) this.db.insert(data) else consol.log('error') } }</span></span></code> </pre> <br>  Ainsi, toute la logique m√©tier du mod√®le est sous nos yeux.  La gestion d'un tel code est plus facile.  Voici les avantages que la combinaison de m√©thodes client-serveur dans un mod√®le peut apporter: <br><br><ol><li>  La logique m√©tier est concentr√©e en un seul endroit, il n'est pas n√©cessaire de la partager entre le client et le serveur. </li><li>  Vous pouvez facilement transf√©rer des fonctionnalit√©s du serveur au client ou du client au serveur pendant le d√©veloppement du projet. </li><li>  Il n'est pas n√©cessaire de dupliquer les m√™mes m√©thodes pour le backend et le frontend. </li><li>  Un seul ensemble de tests pour toute la logique m√©tier du projet. </li><li>  Remplacement des lignes horizontales de d√©limitation des responsabilit√©s dans le projet par des lignes verticales. </li></ol><br>  Je vais r√©v√©ler le dernier point plus en d√©tail.  Imaginez une application client-serveur classique sous la forme d'un tel sch√©ma: <br><br><img src="https://habrastorage.org/webt/8x/c9/de/8xc9degimzw-w-ln5w2ihiybi6w.jpeg" width="400"><br><br>  Vasya est responsable du frontend, Fedya - du backend.  La ligne de d√©limitation des responsabilit√©s est horizontale.  Ce sch√©ma pr√©sente les inconv√©nients de toute structure verticale - il est difficile √† mettre √† l'√©chelle et a une faible tol√©rance aux pannes.  Si le projet prend de l'ampleur, vous devrez faire un choix assez difficile: qui renforcer Vasya ou Fedya?  Ou si Fedya est tomb√© malade ou a d√©missionn√©, Vasya ne pourra pas le remplacer. <br><br>  L'approche propos√©e ici vous permet d'√©largir la ligne de partage des responsabilit√©s de 90 degr√©s et de transformer l'architecture verticale en horizontale. <br><br><img src="https://habrastorage.org/webt/v6/4m/9f/v64m9fuv5sonujosvh4yc4v8vbw.jpeg" width="400"><br><br>  Une telle architecture est beaucoup plus facile √† mettre √† l'√©chelle et plus tol√©rante aux pannes.  Vasya et Fedya deviennent interchangeables. <br><br>  En th√©orie, cela semble bon, essayons d'impl√©menter tout cela dans la pratique, sans perdre tout ce qui nous donne l'existence s√©par√©e du client et du serveur en cours de route. <br><br><h3>  √ânonc√© du probl√®me </h3><br>  Nous n'avons absolument pas besoin d'avoir un serveur client int√©gr√© dans le produit.  Au contraire, une telle d√©cision serait extr√™mement pr√©judiciable √† tous points de vue.  La t√¢che est que dans le processus de d√©veloppement, nous aurions une base de code unique pour les mod√®les de donn√©es pour le backend et le frontend, mais la sortie serait un client et un serveur ind√©pendants.  Dans ce cas, nous b√©n√©ficierons de tous les avantages de l'approche standard et b√©n√©ficierons des √©quipements list√©s ci-dessus pour le d√©veloppement et l'accompagnement du projet. <br><br><h3>  Solution </h3><br>  J'exp√©rimente avec l'int√©gration du client et du serveur dans un fichier depuis un certain temps.  Jusqu'√† r√©cemment, le probl√®me principal √©tait que dans JS standard, la connexion des modules tiers sur le client et le serveur √©tait trop diff√©rente: n√©cessite (...) dans node.js, toute la magie AJAX sur le client.  Tout a chang√© avec l'av√®nement des modules ES.  Dans les navigateurs modernes, ¬´l'importation¬ª est prise en charge depuis longtemps.  Node.js est l√©g√®rement en retard √† cet √©gard et les modules ES ne sont pris en charge qu'avec le drapeau "--experimental-modules" activ√©.  On esp√®re que dans un avenir pr√©visible, les modules fonctionneront hors de la bo√Æte dans node.js.  En outre, il est peu probable que quelque chose change beaucoup, car  dans les navigateurs, cette fonctionnalit√© fonctionne depuis longtemps par d√©faut.  Je pense que maintenant vous pouvez utiliser les modules ES non seulement c√¥t√© client mais aussi c√¥t√© serveur (si vous avez des contre-arguments √† ce sujet, √©crivez dans les commentaires). <br><br>  Le sch√©ma de solution ressemble √† ceci: <br><br><img src="https://habrastorage.org/webt/xo/_a/vi/xo_avikvz1udp9-dwhxfe6ypt-q.png" width="600"><br><br>  Le projet contient trois catalogues principaux: <br><br>  <b>prot√©g√©</b> - backend; <br>  <b>public</b> - frontend; <br>  <b>shared</b> - mod√®les client-serveur partag√©s. <br><br>  Un processus d'observation distinct surveille les fichiers dans le r√©pertoire partag√© et, avec toutes les modifications, cr√©e des versions du fichier modifi√© s√©par√©ment pour le client et s√©par√©ment pour le serveur (dans les r√©pertoires prot√©g√© / partag√© et public / partag√©). <br><br><h3>  Impl√©mentation </h3><br>  Prenons l'exemple d'un simple messager en temps r√©el.  Nous aurons besoin de nouveaux node.js (j'ai la version 11.0.0) et Redis (les installer n'est pas couvert ici). <br><br>  Clonez un exemple: <br><br><pre> <code class="bash hljs">git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/Kolbaskin/both-example <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ./both-example npm i</code> </pre><br>  Installez et ex√©cutez le processus d'observation (observateur dans le diagramme): <br><br><pre> <code class="bash hljs">npm i both-js -g both ./index.mjs</code> </pre><br>  Si tout est en ordre, l'observateur lance le serveur Web et commence √† surveiller les modifications apport√©es aux fichiers dans les r√©pertoires partag√©s et prot√©g√©s.  Lorsque des modifications sont apport√©es au partage, les versions correspondantes des mod√®les de donn√©es pour le client et le serveur sont cr√©√©es.  En cas de modification de la protection, l'observateur red√©marre automatiquement le serveur Web. <br><br>  Vous pouvez voir les performances du messager dans le navigateur en cliquant sur le lien <br><br> <code>http://localhost:3000/index.html?token=123&amp;user=Vasya</code> <br> <br>  (le jeton et l'utilisateur sont arbitraires).  Pour √©muler plusieurs utilisateurs, ouvrez la m√™me page dans un autre navigateur en sp√©cifiant un jeton et un utilisateur diff√©rents. <br><br>  Maintenant un petit code. <br><br><h4>  Serveur Web </h4><br>  protected / server.mjs <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> express <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'express'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> bodyParser <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'body-parser'</span></span>; <span class="hljs-comment"><span class="hljs-comment">// -     //  -  import wsServer from './lib/wsServer.mjs'; const app = express(); //   - wsServer(app); //  mime  mjs express.static.mime.define({'application/javascript': ['js','mjs']}); app.use( bodyParser.json() ); app.use(bodyParser.urlencoded({ extended: true })); //      public app.use(express.static('public')); const server = app.listen(3000, () =&gt; { console.log('server is running at %s', server.address().port); });</span></span></code> </pre><br>  Il s'agit d'un serveur express r√©gulier, il n'y a rien d'int√©ressant ici.  L'extension mjs est n√©cessaire pour les modules ES dans node.js.  Par souci de coh√©rence, nous utiliserons cette extension pour le client. <br><br><h4>  Client </h4><br>  public / index.html <br><br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;!DOCTYPE html&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">lang</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"en"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://cdn.jsdelivr.net/npm/vue/dist/vue.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/main.mjs"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"module"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"users"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">v-for</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"user in users"</span></span></span><span class="hljs-tag">&gt;</span></span> {{ user.name }} ({{user.id}}) <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"messages"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">v-model</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"msg"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">v-on:click</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"sendMessage()"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">v-for</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"message in messages"</span></span></span><span class="hljs-tag">&gt;</span></span>[{{ message.date }}] <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">strong</span></span></span><span class="hljs-tag">&gt;</span></span>{{ message.text }}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">strong</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Par exemple, j'utilise Vue sur le client, mais cela ne change pas l'essence.  Au lieu de Vue, il peut y avoir n'importe quoi o√π vous pouvez s√©parer le mod√®le de donn√©es dans une classe distincte (knockout, angular). <br><br>  public / main.mjs <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//      - import ws from "/lib/Ws.mjs"; //       import Messages from "./shared/messages/model/dataModel.mjs"; //    import Users from "./shared/users/model/dataModel.mjs"; //  - (     ) window.WS = new ws({ token: new URLSearchParams(document.location.search).get("token"), user: new URLSearchParams(document.location.search).get("user") }); //       new Messages({ el: '#messages' }) //       new Users({ el: '#users' })</span></span></code> </pre><br>  main.mjs est un script qui associe les mod√®les de donn√©es aux vues correspondantes.  Pour simplifier le code, des exemples de repr√©sentations pour la liste des utilisateurs actifs et les flux de messages sont int√©gr√©s directement dans index.html <br><br><h4>  Mod√®le de donn√©es </h4><br>  partag√© / messages / model / dataModel.mjs <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//    //          , //    import Base from '@root/lib/Base.mjs'; export default class dataModel extends Base { //!#client constructor(attr) { attr.data = { msg: '', messages: [] } super(attr); //     this.on('newmessage', (data) =&gt; { this.messages.push(data) }) } //!#client async sendMessage(e) { //    await this.$sendMessage(this.msg); this.msg = ''; } //!#server async $sendMessage(text) { //   newmessage     this.fireEvent('newmessage', 'all', { date: new Date(), text }) return true; } }</span></span></code> </pre><br>  Ces diff√©rentes m√©thodes impl√©mentent toutes les fonctionnalit√©s d'envoi et de r√©ception de messages en temps r√©el.  Les directives! #Client et! #Server indiquent au processus d'observation quelle m√©thode pour quelle partie (client ou serveur) est destin√©e.  S'il n'y a pas ces directives avant de d√©finir une m√©thode, une telle m√©thode est disponible √† la fois sur le client et sur le serveur.  Les barres obliques de commentaire avant la directive sont facultatives et n'existent que pour emp√™cher l'IDE standard de jurer lors d'erreurs de syntaxe. <br><br>  La premi√®re ligne du chemin utilise la recherche &amp; root.  Lors de la g√©n√©ration des versions client et serveur, &amp; root sera remplac√© par le chemin relatif vers les r√©pertoires public et prot√©g√©, respectivement. <br><br>  Autre point important: √† partir de la m√©thode client, vous ne pouvez appeler que la m√©thode serveur, dont le nom commence par "$": <br><br><pre> <code class="javascript hljs">... <span class="hljs-comment"><span class="hljs-comment">//    async sendMessage(e) { await this.$sendMessage(this.msg); &lt;-    this.msg = ''; } ...</span></span></code> </pre><br>  Cela se fait pour des raisons de s√©curit√©: de l'ext√©rieur, vous ne pouvez vous tourner que vers des m√©thodes sp√©cialement con√ßues pour cela. <br><br>  Examinons les versions des mod√®les de donn√©es que l'observateur a g√©n√©r√©s pour le client et le serveur. <br><br>  <b>Client</b> (public / partag√© / messages / mod√®le / dataModel.mjs) <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Base <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'/lib/Base.mjs'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataModel</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Base</span></span></span><span class="hljs-class"> </span></span>{ __getFilePath__() {<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"messages/model/dataModel.mjs"</span></span>} <span class="hljs-comment"><span class="hljs-comment">// constructor(attr) { attr.data = { msg: '', messages: [] } super(attr); //     this.on('newmessage', (data) =&gt; { this.messages.push(data) }) } // async sendMessage(e) { //    await this.$sendMessage(this.msg); this.msg = ''; } // ... async $sendMessage() {return await this.__runSharedFunction("$sendMessage",arguments)} }</span></span></code> </pre><br>  C√¥t√© client, le mod√®le est un descendant de la classe Vue (via Base.mjs).  Ainsi, vous pouvez travailler avec lui comme avec un mod√®le de donn√©es Vue standard.  L'observateur a ajout√© la m√©thode __getFilePath__ √† la version client du mod√®le, qui renvoie le chemin d'acc√®s au fichier de classe et remplace le code de m√©thode du serveur $ sendMessage par une construction qui, par essence, appellera la m√©thode dont nous avons besoin sur le serveur via le m√©canisme rpc (__runSharedFunction est d√©fini dans la classe parente). <br><br>  <b>Serveur</b> (prot√©g√© / partag√© / messages / mod√®le / dataModel.mjs) <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Base <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../../lib/Base.mjs'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataModel</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Base</span></span></span><span class="hljs-class"> </span></span>{ __getFilePath__() {<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"messages/model/dataModel.mjs"</span></span>} ...       ... <span class="hljs-comment"><span class="hljs-comment">// async $sendMessage(text) { //   newmessage     this.fireEvent('newmessage', 'all', { date: new Date(), text }) return true; } }</span></span></code> </pre><br>  Dans la version serveur, la m√©thode __getFilePath__ a √©galement √©t√© ajout√©e et les m√©thodes client marqu√©es avec la directive ont √©t√© supprim√©es! #Client <br><br>  Dans les deux versions g√©n√©r√©es du mod√®le, toutes les lignes supprim√©es sont remplac√©es par des lignes vides.  Ceci est fait pour que le message d'erreur sur le d√©bogueur puisse facilement trouver la ligne probl√©matique dans le code source du mod√®le. <br><br><h4>  Interaction client-serveur </h4><br>  Lorsque nous devons appeler une m√©thode serveur sur le client, nous le faisons simplement. <br>  Si l'appel est dans le m√™me mod√®le, alors tout est simple: <br><br><pre> <code class="javascript hljs">... !#client <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> sendMessage(e) { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$sendMessage(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.msg); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.msg = <span class="hljs-string"><span class="hljs-string">''</span></span>; } !#server <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> $sendMessage(msg) { <span class="hljs-comment"><span class="hljs-comment">// -    } ...</span></span></code> </pre><br>  Vous pouvez ¬´tirer¬ª un autre mod√®le: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> dataModel <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"/shared/messages/model/dataModel.mjs"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> msg = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> dataModel(); msg.$sendMessage(<span class="hljs-string"><span class="hljs-string">'blah-blah-blah'</span></span>);</code> </pre><br>  Dans la direction oppos√©e, c'est-√†-dire  L'appel d'une m√©thode client sur le serveur ne fonctionne pas.  Techniquement, c'est faisable, mais d'un point de vue pratique, cela n'a aucun sens, car  le serveur est un, mais il y a beaucoup de clients.  Si nous devons lancer certaines actions sur le serveur sur le client, nous utilisons le m√©canisme d'√©v√©nement: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//    ... //!#client constructor(attr) { .... //       "newmessage" this.on('newmessage', (data) =&gt; { this.messages.push(data) }) } //!#server async $sendMessage(text) { //     newmessage     this.fireEvent('newmessage', 'all', { date: new Date(), text }) return true; } ...</span></span></code> </pre><br>  La m√©thode fireEvent prend 3 param√®tres: le nom de l'√©v√©nement, √† qui il est adress√© et les donn√©es.  Vous pouvez d√©finir le destinataire de plusieurs mani√®res: mot-cl√© ¬´tous¬ª - l'√©v√©nement sera envoy√© √† tous les utilisateurs ou dans le tableau pour r√©pertorier les jetons de session des clients auxquels l'√©v√©nement est adress√©. <br><br>  L'√©v√©nement n'est pas li√© √† une instance sp√©cifique de la classe de mod√®le de donn√©es et les gestionnaires se d√©clencheront dans toutes les instances de la classe dans laquelle fireEvent a √©t√© appel√©. <br><br><h4>  Mise √† l'√©chelle horizontale du backend </h4><br>  La monolithicit√© des mod√®les client-serveur dans l'impl√©mentation propos√©e, √† premi√®re vue, devrait imposer des restrictions importantes sur la possibilit√© d'une mise √† l'√©chelle horizontale de la partie serveur.  Mais ce n'est pas le cas: techniquement, le serveur est ind√©pendant du client.  Vous pouvez copier le r√©pertoire ¬´public¬ª n'importe o√π et donner son contenu via n'importe quel autre serveur Web (nginx, apache, etc.). <br><br>  Le c√¥t√© serveur peut √™tre facilement √©tendu en lan√ßant de nouvelles instances backend.  Redis et le syst√®me de file d'attente Kue sont utilis√©s pour interagir avec des instances individuelles. <br><br><h4>  API et diff√©rents clients sur un seul backend </h4><br>  Dans les projets r√©els, divers clients serveurs peuvent utiliser une API serveur - sites Web, applications mobiles, services tiers.  Dans la solution propos√©e, tout cela est disponible sans aucune danse suppl√©mentaire.  Sous le capot des m√©thodes de serveur d'appel se trouve le bon vieux rpc.  Le serveur Web lui-m√™me est une application express classique.  Il suffit d'y ajouter un wrapper pour les routes avec appel des m√©thodes n√©cessaires des m√™mes mod√®les de donn√©es. <br><br><h4>  Post scriptum </h4><br>  L'approche propos√©e dans l'article ne pr√©tend aucun changement r√©volutionnaire dans les applications client-serveur.  Il ajoute seulement un peu de confort au processus de d√©veloppement, vous permettant de vous concentrer sur une logique m√©tier assembl√©e en un seul endroit. <br><br>  Ce projet est exp√©rimental, √©crivez dans les commentaires si, √† votre avis, cela vaut la peine de poursuivre cette exp√©rience. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr435494/">https://habr.com/ru/post/fr435494/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr435480/index.html">Microsoft et Kroger vont combattre Amazon dans le domaine ... le commerce des aliments</a></li>
<li><a href="../fr435482/index.html">Zircon Highlight: vDSO (Virtual Dynamic Shared Object)</a></li>
<li><a href="../fr435484/index.html">Style de fuzz 1989</a></li>
<li><a href="../fr435488/index.html">Mocks, stubs and spies in the Spock Framework</a></li>
<li><a href="../fr435490/index.html">Modifications fiscales de Google en 2019</a></li>
<li><a href="../fr435496/index.html">Tesla poursuivi pour un accident dans lequel le conducteur et le passager de la Model S sont morts</a></li>
<li><a href="../fr435498/index.html">vCloud Director Extender: Migration</a></li>
<li><a href="../fr435500/index.html">Gants biom√©triques en sport automobile</a></li>
<li><a href="../fr435502/index.html">L'√©tude a r√©v√©l√© les avantages et les inconv√©nients du perfectionnisme</a></li>
<li><a href="../fr435504/index.html">Des monstres √† la main dans la lutte pour la propret√©: s√©lection d'un aspirateur manuel Xiaomi</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>