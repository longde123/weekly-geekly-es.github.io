<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëèüèª üë©üèª‚Äçü§ù‚Äçüë®üèø üë®üèª‚Äçüîß Introdu√ß√£o √† programa√ß√£o reativa üå¶Ô∏è üå∞ üõéÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√°. Neste artigo, galoparei pela Europa, ou seja, direi o que eles querem dizer com programa√ß√£o reativa, apresentarei atores, fluxos reativos e, fina...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Introdu√ß√£o √† programa√ß√£o reativa</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/arcadia/blog/432004/">  Ol√°.  Neste artigo, galoparei pela Europa, ou seja, direi o que eles querem dizer com programa√ß√£o reativa, apresentarei atores, fluxos reativos e, finalmente, usando fluxos reativos, reconheceremos os gestos do mouse, como na antiga Opera e seu sucessor espiritual - Vivaldi . <br><br>  O objetivo √© introduzir os conceitos b√°sicos de programa√ß√£o reativa e mostrar que nem tudo √© t√£o complicado e assustador quanto parece √† primeira vista. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0c6/858/157/0c68581574002383d90367c3e6b996c9.jpg" alt="imagem"><br>  <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Fonte</a></i> <br><a name="habracut"></a><br><h2>  O que √© programa√ß√£o reativa? </h2><br>  Para responder a essa pergunta, nos voltamos para o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">site</a> .  Ele tem uma bela imagem que mostra quatro crit√©rios principais que os aplicativos reativos devem atender. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6e5/092/390/6e5092390fa27e7843b59d57da94b8b3.svg" alt="imagem"><br><br>  A aplica√ß√£o deve ser r√°pida, tolerante a falhas e dimensionar bem. <br>  Parece que ‚Äúsomos para todos os bons versus todos os ruins‚Äù, certo? <br><br>  O que se entende por estas palavras: <br><br><ol><li> <b>Responsividade</b> <br><br>  O aplicativo deve fornecer ao usu√°rio o resultado em meio segundo.  Isso tamb√©m inclui o princ√≠pio de falha r√°pida - ou seja, quando algo der errado, √© melhor retornar ao usu√°rio uma mensagem de erro como ‚ÄúDesculpe, houve um problema.  Tente novamente mais tarde para fazer o tempo esperar √† beira-mar.  Se a opera√ß√£o for longa, mostramos ao usu√°rio uma barra de progresso.  Se for muito longo - ‚Äúsua solicita√ß√£o ser√° atendida provisoriamente em 18 de mar√ßo de 2042.  Enviaremos uma notifica√ß√£o pelo correio ". </li><li>  <b>A escalabilidade</b> √© uma maneira de fornecer capacidade de resposta sob carga.  Imagine o ciclo de vida de um servi√ßo relativamente bem-sucedido: <br><ol><li>  Lan√ßamento - o fluxo de solicita√ß√µes √© pequeno, o servi√ßo √© executado em uma m√°quina virtual com um n√∫cleo. </li><li>  O fluxo de solicita√ß√µes aumenta - os kernels s√£o adicionados √† m√°quina virtual e os pedidos s√£o processados ‚Äã‚Äãem v√°rios threads. </li><li>  Ainda mais carga - conectamos lotes - solicita√ß√µes ao banco de dados e ao disco r√≠gido s√£o agrupados. </li><li>  Ainda mais carga - voc√™ precisa aumentar mais servidores e fornecer trabalho no cluster. <br>  Idealmente, o pr√≥prio sistema deve aumentar ou diminuir, dependendo da carga. </li></ol></li><li>  <b>Toler√¢ncia a falhas</b> <br><br>  Aceitamos que vivemos em um mundo imperfeito e tudo acontece.  Caso algo d√™ errado em nosso sistema, devemos fornecer m√©todos de tratamento e recupera√ß√£o de erros </li><li>  E, finalmente, somos convidados a conseguir tudo isso usando um sistema cuja arquitetura √© baseada em <b>mensagens orientadas a</b> mensagens </li></ol><br>  Antes de continuar, quero me concentrar em como os sistemas acionados por eventos diferem dos sistemas acionados por mensagens. <br><br>  <b>Orientado a eventos:</b> <br><br><ul><li>  Evento - o sistema relata que atingiu um determinado estado. </li><li>  Pode haver muitos inscritos no evento. </li><li>  A cadeia de eventos geralmente √© curta e os manipuladores de eventos est√£o pr√≥ximos (fisicamente e em c√≥digo) da fonte. </li><li>  A fonte de eventos e seus manipuladores geralmente t√™m um estado comum (fisicamente - eles usam a mesma pe√ßa de RAM para troca de informa√ß√µes). </li></ul><br>  <b>Ao contr√°rio do orientado a eventos, em um sistema orientado a mensagens:</b> <br><br><ul><li>  Cada mensagem tem apenas um destinat√°rio. </li><li>  As mensagens s√£o imut√°veis: voc√™ n√£o pode alterar nada na mensagem recebida para que o remetente saiba sobre ela e possa ler as informa√ß√µes. </li><li>  Os elementos do sistema respondem (ou n√£o respondem) ao recebimento de mensagens e podem enviar mensagens para outros elementos do sistema. </li></ul><br>  Tudo isso nos oferece <br><br><h1>  Modelo do ator </h1><br>  Marcos do desenvolvimento: <br><br><ul><li>  A primeira men√ß√£o aos atores est√° em um artigo cient√≠fico de 1973 - Carl Hewitt, Peter Bishop e Richard Steiger, "Um formalismo modular universal do ATOR para intelig√™ncia artificial". </li><li>  1986 - Erlang apareceu.  Ericson precisava de uma linguagem para equipamentos de telecomunica√ß√µes que proporcionasse toler√¢ncia a falhas e propaga√ß√£o sem erros.  No contexto deste artigo, seus principais recursos s√£o: <br><br><ul><li>  Tudo √© um processo </li><li>  As mensagens s√£o o √∫nico meio de comunica√ß√£o (Erlang √© uma linguagem funcional e as mensagens nela s√£o imut√°veis). </li></ul></li><li>  .. </li><li>  2004 - a primeira vers√£o da linguagem Scala.  Suas caracter√≠sticas: <ul><li>  Desenvolvido por JVM, </li><li>  Funcional </li><li>  Para multiencadeamento, um modelo de ator foi selecionado. </li></ul><br></li><li>  2009 - a implementa√ß√£o dos atores foi alocada em uma biblioteca separada - Akka </li><li>  2014 - Akka.net - foi portado para .Net. </li></ul><br><h1>  O que os atores podem fazer? </h1><br>  Atores s√£o os mesmos objetos, mas: <br><br><ul><li>  Diferentemente dos objetos comuns, os atores n√£o podem chamar os m√©todos um do outro. </li><li>  Os atores podem transmitir informa√ß√µes <b>apenas atrav√©s de mensagens imut√°veis</b> . </li><li>  Ap√≥s o recebimento da mensagem, o ator pode <br><ul><li>  Crie novos atores (eles ser√£o mais baixos na hierarquia), </li><li>  Envie mensagens para outros atores, </li><li>  Pare os atores abaixo na hierarquia e voc√™ mesmo. </li></ul></li></ul><br>  Vejamos um exemplo. <br><br><img src="https://habrastorage.org/webt/ql/wj/cj/qlwjcjyygaw5s7iub_mshc1rbry.jpeg" alt="imagem"><br><br>  O ator A deseja enviar uma mensagem para o ator B. Tudo o que ele tem √© o ActorRef (algum endere√ßo).  O ator B pode estar em qualquer lugar. <br>  O ator A envia uma letra B pelo sistema (ActorSystem).  O sistema coloca a letra na caixa de correio do ator B e "acorda" o ator B. O ator B pega a carta na caixa de correio e faz alguma coisa. <br><br>  Comparado a chamar m√©todos em outro objeto, parece desnecessariamente complicado, mas o modelo de atores se encaixa perfeitamente no mundo real, se voc√™ imaginar que os atores s√£o pessoas treinadas para fazer algo em resposta a determinados est√≠mulos. <br><br>  Imagine um pai e um filho: <br><br><img src="https://habrastorage.org/webt/gk/o9/s5/gko9s5syabkkpdkg0_v_aimwwis.jpeg"><br><br>  O pai envia seu filho SMSku "Clean in the room" e continua a fazer suas pr√≥prias coisas.  O filho l√™ SMSku e come√ßa a limpar.  Papai, enquanto isso, est√° jogando p√¥quer.  O filho termina a limpeza e envia o SMS "Concluir".  Parece simples, certo? <br><br>  Agora imagine que pai e filho n√£o s√£o atores, mas objetos comuns que podem puxar os m√©todos um do outro.  O pai puxa o filho para o m√©todo "limpar o quarto" e segue-o, esperando at√© que o filho termine a limpeza e transfira o controle de volta para o pai.  Pai n√£o pode jogar poker neste momento.  Nesse contexto, o modelo de ator est√° se tornando mais atraente. <br><br>  Agora vamos passar para <br><br><h1>  Akka.NET </h1><br>  Tudo o que est√° escrito abaixo √© verdadeiro para o Akka original para a JVM, mas, para mim, o C # √© mais pr√≥ximo que o Java, ent√£o usarei o Akka.NET como exemplo. <br><br><h3>  Ent√£o, quais s√£o os benef√≠cios da Akka? </h3><br><ul><li>  Multithreading atrav√©s de mensagens.  Voc√™ n√£o precisa mais sofrer com todos os tipos de bloqueios, sem√°foros, mutexes e outros encantos caracter√≠sticos do multithreading cl√°ssico com mem√≥ria compartilhada. </li><li>  Comunica√ß√£o transparente entre o sistema e seus componentes.  N√£o h√° necessidade de se preocupar com c√≥digos de rede complexos - o pr√≥prio sistema encontrar√° o destino da mensagem e garantir√° a entrega da mensagem (aqui voc√™ pode inserir uma piada sobre UDP x TCP). </li><li>  Arquitetura flex√≠vel que pode aumentar ou diminuir automaticamente.  Por exemplo, sob carga, o sistema pode aumentar n√≥s de cluster adicionais e distribuir uniformemente a carga. </li></ul><br>  Mas o t√≥pico sobre dimensionamento √© muito extenso e digno de uma publica√ß√£o separada.  Portanto, explicarei mais detalhadamente apenas sobre o recurso, que ser√° √∫til em todos os projetos: <br><br><h2>  Tratamento de erros </h2><br>  Os atores t√™m uma hierarquia - ela pode ser representada como uma √°rvore.  Cada ator tem um pai e pode ter "filhos". <br><br><img src="https://habrastorage.org/getpro/habr/post_images/99e/57e/919/99e57e919cbea8e6761b75537c3f507a.png" alt="imagem"><br>  <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Documenta√ß√£o do Akka.NET</a> Copyright 2013-2018 Projeto Akka.NET</i> <br><br>  Para cada ator, voc√™ pode definir uma estrat√©gia de supervis√£o - o que fazer se algo der errado para as "crian√ßas".  Por exemplo, ‚Äúbata‚Äù em um ator com problemas e, em seguida, crie um novo ator do mesmo tipo e confie a ele o mesmo trabalho. <br><br>  Por exemplo, fiz uma aplica√ß√£o no Akka.net CRUD, na qual a camada de "l√≥gica de neg√≥cios" √© implementada nos atores.  O objetivo deste projeto era descobrir se os atores devem ser usados ‚Äã‚Äãem sistemas n√£o escalon√°veis ‚Äã‚Äã- eles melhorar√£o a vida ou adicionar√£o mais sofrimento. <br><br>  Como o tratamento de erros interno da Akka pode ajudar: <br><br><div class="spoiler">  <b class="spoiler_title">Gif</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/1f/oz/ou/1fozoulh0ufwzuyufofz4n8pvbi.gif"><br></div></div><br><ol><li>  est√° tudo bem, o aplicativo funciona, </li><li>  algo aconteceu com o reposit√≥rio e agora ele fornece o resultado apenas 1 vez em 5, </li><li>  Defino a estrat√©gia de supervis√£o para "tentar 10 vezes por segundo", </li><li>  o aplicativo est√° funcionando novamente (embora mais lento) e tenho tempo para descobrir qual √© o problema. </li></ol><br>  H√° uma tenta√ß√£o de dizer: "Vamos l√°, eu vou escrever esse erro ao lidar comigo mesmo, por que alguns atores t√™m que cometer um erro?"  Observa√ß√£o justa, mas apenas se os pontos de falha forem poucos. <br><br>  E algum c√≥digo.  √â assim que a inicializa√ß√£o do sistema de ator no cont√™iner de IoC se parece: <br><br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Container</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { system = ActorSystem.Create(<span class="hljs-string"><span class="hljs-string">"MySystem"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> echo = system.ActorOf&lt;EchoActor&gt;(<span class="hljs-string"><span class="hljs-string">"Echo"</span></span>); <span class="hljs-comment"><span class="hljs-comment">//stop initialization if something is wrong with actor system var alive = echo.Ask&lt;bool&gt;(true, TimeSpan.FromMilliseconds(100)).Result; container = new WindsorContainer(); //search for dependencies //register controllers //register ActorSystem propsResolver = new WindsorDependencyResolver(container, (ActorSystem)system); system.AddDependencyResolver(propsResolver); actorSystemWrapper = new ActorSystemWrapper(system, propsResolver); container.Register(Component.For&lt;IActorRefFactory&gt;().Instance(actorSystemWrapper)); container.Register(Component.For&lt;IDependencyResolver&gt;().Instance(propsResolver)); }</span></span></code> </pre> <br>  O EchoActor √© o ator mais simples que retorna um valor ao remetente: <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">EchoActor</span></span> : <span class="hljs-title"><span class="hljs-title">ReceiveActor</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EchoActor</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Receive&lt;<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>&gt;(flag =&gt; { Sender.Tell(flag); }); } }</code> </pre><br>  Para conectar os atores ao c√≥digo "regular", o comando Ask √© usado: <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task&lt;ActionResult&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Index</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { ViewBag.Type = <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(Model); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> res = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> CrudActorRef.Ask&lt;IEnumerable&lt;Model&gt;&gt;(DataMessage.GetAll&lt;Model&gt;(), maxDelay); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(res); }</code> </pre> <br><h3>  Total </h3><br>  Rindo com os atores, posso dizer: <br><br><ul><li>  Olhe para eles se precisar de escalabilidade. </li><li>  Para l√≥gica de neg√≥cios complexa, √© melhor n√£o us√°-las por causa de <ul><li>  Inje√ß√£o de Depend√™ncia estranha.  Para inicializar um ator com as depend√™ncias necess√°rias, voc√™ deve primeiro criar um objeto Props e depois entreg√°-lo ao ActorSystem para criar um ator do tipo desejado.  Para criar adere√ßos usando cont√™ineres IoC (por exemplo, Castle Windsor ou Autofac), existem wrappers prontos - DependencyResolvers.  Mas me deparei com o fato de que o cont√™iner de IoC estava tentando controlar a vida √∫til da depend√™ncia e, depois de um tempo, o sistema caiu silenciosamente. <br><br>  * Talvez, em vez de injetar uma depend√™ncia em um objeto, voc√™ deva colocar essa depend√™ncia como ator-filho. </li><li>  problemas de digita√ß√£o.  ActorRef n√£o sabe nada sobre o tipo de ator a que se refere.  Ou seja, em tempo de compila√ß√£o, n√£o se sabe se um ator pode processar uma mensagem desse tipo ou n√£o. </li></ul></li></ul><br><h1>  Parte 2: Fluxos de jato </h1><br>  Agora vamos para um t√≥pico mais popular e √∫til - fluxos de jato.  Se voc√™ nunca conseguir encontrar atores no processo de trabalho, os fluxos Rx certamente ser√£o √∫teis tanto no front-end quanto no back-end.  Sua implementa√ß√£o est√° em quase todas as linguagens de programa√ß√£o modernas.  Vou dar exemplos de RxJs, porque hoje em dia at√© os programadores de back-end √†s vezes precisam fazer algo em JavaScript. <br><br><img src="https://habrastorage.org/webt/ru/yn/g9/ruyng9clvfa1gh8bd5ai3lpnc5m.jpeg"><br>  <i>Os fluxos Rx est√£o dispon√≠veis para todas as linguagens de programa√ß√£o populares.</i> <br><br>  <i>‚Äú <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Introdu√ß√£o √† programa√ß√£o reativa que voc√™ est√° perdendo</a> ‚Äù, de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Andre Staltz</a> , licenciado sob CC BY-NC 4.0</i> <br><br>  Para explicar o que √© o fluxo de jato, come√ßarei com as cole√ß√µes pull e push. <br><table><tbody><tr><th></th><th>  Valor de retorno √∫nico </th><th>  V√°rios valores de retorno </th></tr><tr><td>  Pull <br>  S√≠ncrona <br>  Interativo </td><td>  T </td><td>  IEnumerable &lt;T&gt; </td></tr><tr><td>  Push <br>  Ass√≠ncrono <br>  Reativo </td><td>  Tarefa &lt;T&gt; </td><td>  IObservable &lt;T&gt; </td></tr></tbody></table><br>  As cole√ß√µes pull s√£o o que estamos acostumados na programa√ß√£o.  O exemplo mais impressionante √© uma matriz. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> arr = [<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>,<span class="hljs-number"><span class="hljs-number">5</span></span>];</code> </pre> <br>  Ele j√° possui dados, ele pr√≥prio n√£o os altera, mas pode fornec√™-los mediante solicita√ß√£o. <br><br><pre> <code class="javascript hljs">arr.forEach(<span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log);</code> </pre> <br>  Al√©m disso, antes de fazer algo com os dados, voc√™ pode process√°-los de alguma forma. <br><br><pre> <code class="javascript hljs">arr.map(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">i</span></span></span><span class="hljs-function"> =&gt;</span></span> i+<span class="hljs-number"><span class="hljs-number">1</span></span>).map(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">I</span></span></span><span class="hljs-function"> =&gt;</span></span> ‚Äúmy number is ‚Äù+i).forEach(<span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log);</code> </pre> <br>  Agora vamos imaginar que, inicialmente, n√£o haja dados na cole√ß√£o, mas com certeza ele informar√° que eles apareceram (Push).  E, ao mesmo tempo, ainda podemos aplicar as transforma√ß√µes necess√°rias a essa cole√ß√£o. <br><br>  Por exemplo: <br><br><pre> <code class="javascript hljs">source.map(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">i</span></span></span><span class="hljs-function"> =&gt;</span></span> i+<span class="hljs-number"><span class="hljs-number">1</span></span>).map(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">I</span></span></span><span class="hljs-function"> =&gt;</span></span> ‚Äúmy number is ‚Äù+i).forEach(<span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log);</code> </pre> <br>  Quando um valor como 1 aparece na fonte, o console.log exibe "meu n√∫mero √© 1". <br><br>  Como funciona: <br><br>  Uma nova entidade aparece - Assunto (ou Observ√°vel): <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> observable = Rx.Observable.create(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">observer</span></span></span><span class="hljs-function">) </span></span>{ observer.next(<span class="hljs-number"><span class="hljs-number">1</span></span>); observer.next(<span class="hljs-number"><span class="hljs-number">2</span></span>); observer.next(<span class="hljs-number"><span class="hljs-number">3</span></span>); setTimeout(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { observer.next(<span class="hljs-number"><span class="hljs-number">4</span></span>); observer.complete(); }, <span class="hljs-number"><span class="hljs-number">1000</span></span>); });</code> </pre> <br>  Esta √© uma cole√ß√£o de envio que envia notifica√ß√µes sobre altera√ß√µes em seu estado. <br><br>  Nesse caso, os n√∫meros 1, 2 e 3 aparecer√£o imediatamente nele, em um segundo 4, e a cole√ß√£o "terminar√°".  Este √© um tipo t√£o especial de evento. <br><br>  A segunda entidade √© Observer.  Ele pode se inscrever nos eventos do Assunto e fazer alguma coisa com os dados recebidos.  Por exemplo: <br><br><pre> <code class="javascript hljs">observable.subscribe(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">x</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(x)); observable.subscribe({ <span class="hljs-attr"><span class="hljs-attr">next</span></span>: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">x</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'got value '</span></span> + x), <span class="hljs-attr"><span class="hljs-attr">error</span></span>: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.error(<span class="hljs-string"><span class="hljs-string">'something wrong occurred: '</span></span> + err), <span class="hljs-attr"><span class="hljs-attr">complete</span></span>: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'done'</span></span>), }); observable .map(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">x</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">'This is '</span></span> + x) .subscribe(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">x</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(x));</code> </pre> <br>  Pode-se ver que um Assunto pode ter muitos assinantes. <br><br>  Parece f√°cil, mas ainda n√£o est√° claro por que isso √© necess√°rio.  Darei mais duas defini√ß√µes que voc√™ precisa saber ao trabalhar com fluxos reativos e mostrarei na pr√°tica como eles funcionam e em quais situa√ß√µes todo o seu potencial √© revelado. <br><br><h4>  Observ√°veis ‚Äã‚Äãfrios </h4><br><ul><li>  Notificar sobre eventos quando algu√©m os assinar. </li><li>  Todo o fluxo de dados √© enviado novamente para cada assinante, independentemente do hor√°rio da assinatura. </li><li>  Os dados s√£o copiados para cada assinante. </li></ul><br>  O que isso significa: digamos que a empresa (Assunto) decidiu organizar a distribui√ß√£o de presentes.  Cada funcion√°rio (Observador) vem trabalhar e recebe sua c√≥pia do presente.  Ningu√©m permanece privado. <br><br><h4>  Observ√°veis ‚Äã‚Äãquentes </h4><br><ul><li>  Eles tentam notificar o evento, independentemente da presen√ßa de assinantes.  Se no momento do evento n√£o houvesse assinantes, os dados ser√£o perdidos. </li></ul><br>  Exemplo: pela manh√£, bolos quentes para os funcion√°rios s√£o trazidos para a empresa.  Quando s√£o trazidas, todas as cotovias voam para o cheiro e separam as tortas no caf√© da manh√£.  Mas as corujas que vieram depois n√£o t√™m mais tortas. <br><br><h4>  Em que situa√ß√µes os fluxos de jato s√£o usados? </h4><br>  Quando h√° um fluxo de dados distribu√≠do ao longo do tempo.  Por exemplo, entrada do usu√°rio.  Ou logs de qualquer servi√ßo.  Em um dos projetos, vi um criador de logs auto-criado que coletava eventos em N segundos e depois gravava simultaneamente o pacote inteiro.  O c√≥digo da bateria ocupava a p√°gina.  Se os fluxos Rx fossem usados, seria muito mais simples: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b6e/b1a/396/b6eb1a3960bd8b422c01b6c0a5dd97f0.png" alt="imagem"><br>  <i>‚Äú <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Refer√™ncia / Observ√°vel RxJs</a> , documenta√ß√£o licenciada sob CC BY 4.0</i> . <br>  <i>(existem muitos exemplos e imagens explicando o que v√°rias opera√ß√µes com fluxos reativos fazem)</i> <br><br><pre> <code class="javascript hljs">source.bufferTime(<span class="hljs-number"><span class="hljs-number">2000</span></span>).subsribe(doThings);</code> </pre> <br>  E, finalmente, um exemplo de uso. <br><br><h2>  Reconhecendo gestos do mouse com fluxos Rx </h2><br>  Na antiga Opera ou em seu sucessor espiritual - Vivaldi - havia um controle de navegador usando gestos do mouse. <br><br><div class="spoiler">  <b class="spoiler_title">Gif - gestos do mouse em Vivaldi</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/xs/ok/eq/xsokeqelkjbtvgrcurbv-wffmog.gif"><br></div></div><br>  Ou seja, voc√™ precisa reconhecer os movimentos do mouse para cima / baixo, direita / esquerda e combina√ß√µes dos mesmos.  Ele pode ser escrito sem fluxos Rx, mas o c√≥digo ser√° complexo e dif√≠cil de manter. <br><br><h4>  E aqui est√° o que parece com os fluxos Rx: </h4><br>  Come√ßarei do final - definirei quais dados e em que formato procurarei na sequ√™ncia original: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//gestures to look for const gestures = Rx.Observable.from([ { name: "Left", sequence: Rx.Observable.from([{ x: -1, y: 0 }]) }, { name: "Right", sequence: Rx.Observable.from([{ x: 1, y: 0 }]) }, { name: "Up", sequence: Rx.Observable.from([{ x: 0, y: -1 }]) }, { name: "Down", sequence: Rx.Observable.from([{ x: 0, y: 1 }]) }, { name: "Down+Up", sequence: Rx.Observable.from([{ x: 0, y: 1 }, { x: 0, y: -1 }]) }, { name: "Up+Right", sequence: Rx.Observable.from([{ x: 0, y: -1 }, { x: 1, y: 0 }]) } ]);</span></span></code> </pre> <br>  Estes s√£o vetores unit√°rios e suas combina√ß√µes. <br><br>  Em seguida, voc√™ precisa converter os eventos do mouse em fluxos Rx.  Todas as bibliotecas Rx possuem ferramentas internas para transformar eventos padr√£o em Observables. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> mouseMoves = Rx.Observable.fromEvent(canvas, <span class="hljs-string"><span class="hljs-string">'mousemove'</span></span>), mouseDowns = Rx.Observable.fromEvent(canvas, <span class="hljs-string"><span class="hljs-string">'mousedown'</span></span>), mouseUps = Rx.Observable.fromEvent(canvas, <span class="hljs-string"><span class="hljs-string">'mouseup'</span></span>);</code> </pre> <br>  A seguir, agrupo as coordenadas do mouse por 2 e encontro a diferen√ßa, obtendo o deslocamento do mouse. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> mouseDiffs = mouseMoves .map(getOffset) .pairwise() .map(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">pair</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">x</span></span>: pair[<span class="hljs-number"><span class="hljs-number">1</span></span>].x-pair[<span class="hljs-number"><span class="hljs-number">0</span></span>].x, <span class="hljs-attr"><span class="hljs-attr">y</span></span>: pair[<span class="hljs-number"><span class="hljs-number">1</span></span>].y-pair[<span class="hljs-number"><span class="hljs-number">0</span></span>].y } });</code> </pre> <br>  E agrupe esses movimentos usando os eventos 'mousedown' e 'mouseup'. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> mouseGestures = mouseDiffs .bufferToggle(mouseDowns, x =&gt; mouseUps) .map(concat);</code> </pre> <br>  A fun√ß√£o concat corta movimentos muito curtos e agrupa movimentos aproximadamente alinhados na dire√ß√£o. <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">concat</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">values</span></span></span><span class="hljs-function">) </span></span>{<span class="hljs-comment"><span class="hljs-comment">//summarize move in same direction return values.reduce((a, v) =&gt; { if (!a.length) { a.push(v); } else { const last = a[a.length - 1]; const lastAngle = Math.atan2(last.x, last.y); const angle = Math.atan2(vx, vy); const angleDiff = normalizeAngle(angle - lastAngle); const dist = Math.hypot(vx, vy); if (dist &lt; 1) return a;//move is too short ‚Äì ignore //moving in same direction =&gt; adding vectors if (Math.abs(angleDiff) &lt;= maxAngleDiff) { last.x += vx; last.y += vy; } else { a.push(v); } } return a; }, []); }</span></span></code> </pre> <br>  Se o movimento no eixo X ou Y for muito curto, ele ser√° zerado.  E ent√£o apenas o sinal permanece das coordenadas de deslocamento obtidas.  Assim, os vetores unit√°rios que procur√°vamos s√£o obtidos. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> normalizedMouseGestures = mouseGestures.map(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">arr</span></span></span><span class="hljs-function"> =&gt;</span></span> arr.map(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">v</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> dist = <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.hypot(vx, vy);<span class="hljs-comment"><span class="hljs-comment">//length of vector vx = Math.abs(vx) &gt; minMove &amp;&amp; Math.abs(vx) * treshold &gt; dist ? vx : 0; vy = Math.abs(vy) &gt; minMove &amp;&amp; Math.abs(vy) * treshold &gt; dist ? vy : 0; return v; }) ).map(arr =&gt; arr .map(v =&gt; { return { x: Math.sign(vx), y: Math.sign(vy) }; }) .filter(v =&gt; Math.hypot(vx, vy) &gt; 0) );</span></span></code> </pre> <br>  Resultado: <br><br><pre> <code class="javascript hljs">gestures.map(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">gesture</span></span></span><span class="hljs-function"> =&gt;</span></span> normalizedMouseGestures.mergeMap( <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">moves</span></span></span><span class="hljs-function"> =&gt;</span></span> Rx.Observable.from(moves) .sequenceEqual(gesture.sequence, comparer) ).filter(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">x</span></span></span><span class="hljs-function"> =&gt;</span></span> x).mapTo(gesture.name) ).mergeAll().subscribe(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">gestureName</span></span></span><span class="hljs-function"> =&gt;</span></span> actions[gestureName]());</code> </pre> <br>  Usando sequenceEqual, voc√™ pode comparar os movimentos recebidos com os originais e, se houver uma correspond√™ncia, executar uma determinada a√ß√£o. <br><br><div class="spoiler">  <b class="spoiler_title">Gif</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/lp/bx/fe/lpbxfeq_bq-mdfybskn0v7wwen8.gif"><br></div></div><br>  ‚Üí <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Voc√™ pode brincar com gestos aqui</a> <br><br>  Observe que, al√©m do reconhecimento de gestos, tamb√©m h√° um desenho dos movimentos inicial e normalizado do mouse na tela HTML.  A legibilidade do c√≥digo n√£o sofre com isso. <br><br>  Das quais mais uma vantagem se segue - a funcionalidade escrita com a ajuda dos fluxos Rx pode ser facilmente complementada e expandida. <br><br><h2>  Sum√°rio </h2><br><ul><li>  Bibliotecas com fluxos Rx est√£o dispon√≠veis para quase todas as linguagens de programa√ß√£o. </li><li>  Os fluxos Rx devem ser usados ‚Äã‚Äãquando houver um fluxo de eventos estendido ao longo do tempo (por exemplo, entrada do usu√°rio). </li><li>  A funcionalidade escrita usando fluxos Rx pode ser facilmente complementada e expandida. </li><li>  N√£o encontrei falhas significativas. </li></ul><br><div class="spoiler">  <b class="spoiler_title">Links √∫teis</b> <div class="spoiler_text">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">www.introtorx.com</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">getakka.net/articles/intro/what-is-akka.html</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">reactivex.io/rxjs/class/es6/Observable.js~Observable.html</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">reactivex.io/languages.html</a> </div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt432004/">https://habr.com/ru/post/pt432004/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt431992/index.html">Biometria: como est√£o as coisas conosco e com eles</a></li>
<li><a href="../pt431994/index.html">Discuss√£o da licen√ßa gratuita do PVS-Studio para projetos hospedados no GitHub</a></li>
<li><a href="../pt431996/index.html">Smart Engines Science Corporate (ou como dirigimos para o ICMV 2018)</a></li>
<li><a href="../pt431998/index.html">Conhe√ßa Yandex.Phone - agora oficialmente</a></li>
<li><a href="../pt432002/index.html">A Microsoft est√° desenvolvendo um navegador baseado no Chromium, que ser√° enviado por padr√£o em vez do Edge</a></li>
<li><a href="../pt432006/index.html">A hist√≥ria de como entrei no t√≥pico da sa√∫de da mulher</a></li>
<li><a href="../pt432008/index.html">Perseguindo os padr√µes da Web</a></li>
<li><a href="../pt432012/index.html">Como testar contratos inteligentes</a></li>
<li><a href="../pt432014/index.html">Kali Linux para iniciantes</a></li>
<li><a href="../pt432016/index.html">Como a m√∫sica e o desenho me ensinaram a programar</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>