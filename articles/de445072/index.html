<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>☝🏾 👨🏽‍🎤 🏡 Telegraff: Kotlin DSL für Telegramm 🥅 🍿 👨‍👨‍👧‍👦</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Auf Habré Tausende von Artikeln darüber, wie man einen Telegramm-Bot für verschiedene Programmiersprachen und Plattformen erstellt. Das Thema ist alle...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Telegraff: Kotlin DSL für Telegramm</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/445072/"><p><img src="https://habrastorage.org/webt/3v/da/0z/3vda0ztz83mtq8efycve_gfyrqa.png" alt="Logo"></p><br><p>  Auf Habré Tausende von Artikeln darüber, wie man einen Telegramm-Bot für verschiedene Programmiersprachen und Plattformen erstellt.  Das Thema ist alles andere als neu. </p><br><p>  Aber Telegraff ist der beste Rahmen für die Implementierung von Telegramm-Bots, und ich werde es unter dem Strich beweisen. </p><a name="habracut"></a><br><h2 id="preambula">  Präambel </h2><br><p>  Im Jahr 2015 hatte der russische Rubel Fieber.  Ich hatte Einsparungen in Dollar und überprüfte den Kurs buchstäblich alle fünf Minuten, um die Währung zu dem Kurs zu verkaufen, den ich brauchte.  Das Fieber zog sich hin, ich wurde müde und schrieb an den Telegramm-Bot ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">@TinkoffRatesBot</a> ), der Sie benachrichtigt, wenn der Wechselkurs den (erwarteten) Schwellenwert erreicht. <br>  Diese Aufgabe hat mich sehr berührt.  Botha schrieb ziemlich schnell, aber er erhielt keine Befriedigung. </p><br><p> Die Integration mit Telegramm ist nicht und es gab keine Probleme.  Dieses Problem ist in wenigen Stunden behoben.  Und ich bin sogar überrascht, dass es in Java ganze Bibliotheken (subjektiv mit ekelhaftem Code) für die Integration in Telegramme gibt, die auf Github mehr als tausend Sterne verdient haben. </p><br><p>  Die größte Herausforderung für mich war das Skriptsystem: Der Benutzer ruft einen Befehl auf, zum Beispiel "/ Taxi", der Bot stellt ihm eine Reihe von Fragen, jede Antwort wird validiert und kann die Reihenfolge der nachfolgenden Fragen beeinflussen. Das übliche "Formular" wird gebildet, das der endgültigen Verarbeitungsmethode für das Formen gegeben wird Antwort. <br>  Ich habe das getan, aber die Struktur der Klassen, die Abstraktionsebenen, alles war so heterogen, dass es bitter anzusehen war.  Die Frage quälte mich: Wie kann dies prägnant und organisch auf ein objektorientiertes Modell übertragen werden? </p><br><p>  Ich wollte etwas Einfaches, Bequemes und vor allem - um das gesamte Skript in einer isolierten Datei beschreiben zu können, sodass ich nicht die Hälfte des Projekts anzeigen musste, um die Benutzerinteraktionskette zu verstehen. </p><br><p>  Um nicht zu sagen, dass das Problem sehr akut war, weil die Aufgabe bereits gelöst wurde.  Eher dachte ich manchmal an ihn.  Der Gedanke war Groovy DSL, aber als Kotlin ankam, wurde die Wahl offensichtlich.  Also erschien Telegraff. </p><br><p>  Ja, natürlich gab es keinen Wettbewerb, den Telegraff gewinnen würde.  Und die Behauptung, Telegraff sei das Beste, sollte nicht wörtlich genommen werden.  Aber Telegraff ist ein neuer, einzigartiger Ansatz für diese Herausforderung.  Es ist leicht, der Beste zu sein, der einzige zu sein. </p><br><h2 id="kak-etim-polzovatsya">  Wie benutzt man es? </h2><br><h3 id="zavisimosti">  Abhängigkeiten </h3><br><p>  Der erste Schritt besteht darin, ein zusätzliches Repository für Abhängigkeiten anzugeben.  Vielleicht werde ich irgendwann Telegraff in Maven Central oder im JCenter veröffentlichen, aber vorerst. </p><br><div class="spoiler">  <b class="spoiler_title">Gradle</b> <div class="spoiler_text"><pre><code class="kotlin hljs">repositories { maven { url <span class="hljs-string"><span class="hljs-string">"https://dl.bintray.com/ruslanys/maven"</span></span> } }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Maven</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">repositories</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">repository</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">snapshots</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">enabled</span></span></span><span class="hljs-tag">&gt;</span></span>false<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">enabled</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">snapshots</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">id</span></span></span><span class="hljs-tag">&gt;</span></span>bintray-ruslanys-maven<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">id</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span>bintray<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">url</span></span></span><span class="hljs-tag">&gt;</span></span>https://dl.bintray.com/ruslanys/maven<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">url</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">repository</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">repositories</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> </div></div><br><p>  Es bleibt der Fall für kleine.  Um Telegraff verwenden zu können, müssen Sie nur eine Spring-Boot-Starter-Abhängigkeit angeben: </p><br><div class="spoiler">  <b class="spoiler_title">Gradle</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">compile("me.ruslanys.telegraff:telegraff-starter:1.0.0")</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Maven</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>me.ruslanys.telegraff<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>telegraff-starter<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>1.0.0<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> </div></div><br><h3 id="konfiguraciya">  Konfiguration </h3><br><p>  Die Projektkonfiguration ist einfach und kann auf die ersten zwei oder drei Parameter beschränkt werden: </p><br><div class="spoiler">  <b class="spoiler_title">application.properties</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">telegram.access-key=123 # ① telegram.mode=webhook # ② telegram.webhook-base-url=https://ruslanys.me # ③ telegram.webhook-endpoint-url=/telegram # ④ telegram.handlers-path=handlers # ⑤ telegram.unresolved-filter.enabled=false # ⑥</code> </pre> </div></div><br><ol><li>  Ihr Schlüssel zur Telegramm-API. </li><li>  Der Modus zum Empfangen von Nachrichten (Aktualisierungen) vom Telegramm.  Es kann entweder Polling oder Webhook sein. </li><li>  Wenn die Methode zum Empfangen von Updates durch "Webhook" angegeben ist, müssen Sie den Pfad zu Ihrer Anwendung angeben. </li><li>  Wenn Sie möchten, können Sie Ihren eigenen Pfad zum Endpunkt angeben.  Wenn dieser Parameter nicht neu definiert wird, wird ein Pfad der folgenden Form generiert: <code>/telegram/${UUID}</code> .  Vor dem Starten der Anwendung wird die angegebene Adresse als Web-Hook-Adresse festgelegt.  Am Ende der Arbeit wird die Web-Hook-Adresse überschrieben, um beim nächsten Start zur Abfrage wechseln zu können. </li><li>  Bei Bedarf können Sie den Ordner ändern, in dem sich die Skripte der Handler befinden.  Standardmäßig ist dies der <code>handlers</code> . </li><li>  <code>UnresolvedFilter</code> ist in der "Lieferung" enthalten und standardmäßig aktiviert.  Für den Fall, dass in der Nachricht des Benutzers kein Handler gefunden wurde, antwortet <code>UnresolvedFilter</code> mit etwas wie "Entschuldigung, ich verstehe Sie nicht :(". </li></ol><br><p>  Es ist Zeit, Skripte zu schreiben! </p><br><h3 id="obrabotchiki">  Handler </h3><br><p>  Handler (Skripte) sind ein wichtiger Bestandteil von Telegraff.  Hier wird die Benutzerinteraktionskette festgelegt.  Unter dem Strich ist jeder Befehl wie "/ start", "/ Taxi", "/ help" ein separates Skript / script / handler / handler. </p><br><p>  Ein Skript kann eine Reihe von Schritten (Fragen) enthalten, die ein Benutzer ausführen muss, um einen Befehl auszuführen.  Mit anderen Worten, der Benutzer muss das Formular ausfüllen.  Und da der Messenger von der Benutzeroberfläche stammt, müssen Sie sprechen und den Benutzer fragen. </p><br><p>  Muss ich erklären, dass Benutzerantworten validiert werden müssen?  Das erste, was der Benutzer tun wird, ist, dass er anders reagiert als erwartet. </p><br><p>  Nun, am Ende kann das Skript verzweigen, d.h.  Jede Antwort auf eine Frage kann sich auf die Reihenfolge der nachfolgenden auswirken. </p><br><p>  Z.B! </p><br><p>  <code>.kts</code> die Datei mit der Erweiterung <code>.kts</code> in den Ordner mit den Ressourcenhandlern: <code>src/main/resources/handlers/ExampleHandler.kts</code> . </p><br><div class="spoiler">  <b class="spoiler_title">Taxi-Anrufszenario</b> <div class="spoiler_text"><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PaymentMethod</span></span></span><span class="hljs-class"> </span></span>{ CARD, CASH } handler(<span class="hljs-string"><span class="hljs-string">"/taxi"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// ① step&lt;String&gt;("locationFrom") { // ② question { // ③ MarkdownMessage(" ?") } } step&lt;String&gt;("locationTo") { question { MarkdownMessage(" ?") } } step&lt;PaymentMethod&gt;("paymentMethod") { question { state -&gt; MarkdownMessage("   ?", "", "") // ④ } validation { // ⑤ when (it.toLowerCase()) { "" -&gt; PaymentMethod.CARD "" -&gt; PaymentMethod.CASH else -&gt; throw ValidationException(",    ") // ⑥ } } next { state -&gt; null // ⑦ } } process { state, answers -&gt; // ⑧ val from = answers["locationFrom"] as String val to = answers["locationTo"] as String val paymentMethod = answers["paymentMethod"] as PaymentMethod // ⑨ // Business logic MarkdownMessage("""     #${state.chat.id}.   $from  $to.  $paymentMethod. """.trimIndent()) // ⑩ } }</span></span></code> </pre> </div></div><br><p>  Die Schlüssel der Steppen wurden bewusst nicht in Konstanten aufgenommen.  In der Produktion wird dies natürlich am besten vermieden. </p><br><p>  Lassen Sie es uns herausfinden: </p><br><ol><li>  Wir deklarieren das Skript.  Es ist mindestens ein Teamname erforderlich.  In diesem Fall gibt es zwei Teams: "/ Taxi", "Taxi".  Wenn die Nachricht des Benutzers mit diesen Wörtern beginnt, wird der entsprechende Handler aufgerufen. </li><li>  Wir bestimmen die Schritte (Fragen).  Da ist ein eindeutiger Schrittname erforderlich  Anschließend kann über diesen Schlüssel („locationFrom“) genau auf die Antwort des Benutzers zugegriffen werden. </li><li>  Jeder Schritt enthält drei Abschnitte, von denen der erste die Frage selbst ist.  Die Frage ist ein obligatorischer Abschnitt, der bei jedem Schritt vorhanden sein sollte.  Ein Schritt ohne Frage macht keinen Sinn. </li><li>  Sie können die Frage nach Belieben ausfüllen.  In diesem Fall wird der Benutzer über die Tastatur aufgefordert, eine der folgenden Optionen auszuwählen: "Karte" oder "Bargeld".  Als Ergebnis des Aufrufs dieses Blocks sollte ein Objekt vom Typ <code>TelegramSendRequest</code> .  Leider konnte ich mir nichts Besseres als das <code>SendRequest</code> Suffix <code>SendRequest</code> , das die Struktur als ausgehende Anforderung in Telegram beschreibt. <br><img src="https://habrastorage.org/webt/zc/fg/u0/zcfgu08yo--cn3bhnrnhawcfad0.png" alt="Klassenstruktur"></li><li>  Der zweitwichtigste Schrittabschnitt besteht darin, die Antwort des Benutzers zu überprüfen.  Der Typ jedes Schritts ist parametrisiert (generisch), und daher muss der Validierungsblock genau den Typ zurückgeben, mit dem sein Schritt parametrisiert wird. </li><li>  Wenn die Antwort des Benutzers nicht zufriedenstellend ist, können Sie eine <code>ValidationException</code> mit klarstellendem Text, aber derselben Tastatur auslösen, wenn dies in der Frage angegeben wurde. </li><li>  Der letzte Schrittabschnitt ist ein Block, der den nächsten Schritt angibt.  Standardmäßig werden Schritte in der Reihenfolge ihrer Deklaration von oben nach unten ausgeführt.  Dieser Prozess kann jedoch durch Überschreiben des entsprechenden Blocks beeinflusst werden.  Als Ergebnis der Ausführung dieses Blocks kann entweder der Schlüssel des nächsten Schritts ( <code>String</code> ) oder "null" zurückgegeben werden. Dies zeigt an, dass keine weiteren Schritte vorhanden sind und es Zeit ist, mit der Ausführung des Befehls fortzufahren. </li><li>  Wenn eine Benutzeranforderung generiert wird, ist deren Verarbeitung erforderlich.  Die Argumente im Lambda sind Status (dies ist so etwas wie eine Sitzung) und Benutzerantworten. </li><li>  Beachten Sie, dass die fehlgeschlagene Antwort nicht mehr die Antwortzeichenfolge des Benutzers ist, sondern ein bereits verarbeitetes Objekt des gewünschten Typs. </li><li>  Die Antwort auf den Befehl kann beliebig sein, ähnlich wie in Absatz 4. Wenn die Antwort auf den Befehl nicht erforderlich ist, können Sie "null" zurückgeben. </li></ol><br><p>  Ein Handler hat möglicherweise überhaupt keine Schritte.  In diesem Fall müssen Sie nur das Verhalten des Handlers bestimmen, um den Befehl aufzurufen. </p><br><div class="spoiler">  <b class="spoiler_title">Begrüßungsskript</b> <div class="spoiler_text"><pre> <code class="kotlin hljs">handler(<span class="hljs-string"><span class="hljs-string">"/start"</span></span>) { process { _, _ -&gt; MarkdownMessage(<span class="hljs-string"><span class="hljs-string">"!"</span></span>) } }</code> </pre> </div></div><br><h3 id="probuem">  Versuchen Sie es </h3><br><p>  Um dies zu versuchen, gabeln Sie das <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Repository</a> , klonen Sie es auf den lokalen Computer und wechseln Sie in den Ordner <code>telegraff-sample</code> .  Konfigurieren, starten, berühren! </p><br><p>  Im Allgemeinen ist <code>telegraff-sample</code> ein bewusst unabhängiges Projekt, das nicht mit dem Elternteil zusammenhängt und sogar einen eigenen Gradle Wrapper hat.  Sie können nur diesen Ordner verlassen.  Dies ist eine Art Archetyp. </p><br><h2 id="kak-eto-ustroeno">  Wie funktioniert es </h2><br><h3 id="telegram">  Telegramm </h3><br><p>  Die Integration mit Telegram ist sehr einfach und in <a href=""><code>TelegramApi</code></a> implementiert. </p><br><p>  Jede Methode wurde aufgrund einer Reihe von Umständen absichtlich einzeln implementiert: angefangen von der Verwendung von Spring's RestTemplate (und Tests dafür) bis hin zur Spezifität der Telegramm-API. </p><br><p>  Wie Sie der Konfiguration <a href="">entnehmen</a> können, gibt es in Telegraff zwei Arten von Clients dieser API: <a href="">PollingClient</a> , <a href="">WebhookClient</a> .  Abhängig von der Konfiguration wird ein bestimmter Behälter deklariert. </p><br><p>  Und obwohl sich die Methoden zum Empfangen von Updates (neue Nachrichten) von Telegramm unterscheiden, bleibt das Wesentliche unverändert und läuft auf eine Sache hinaus: das Veröffentlichen eines Ereignisses ( <a href=""><code>TelegramUpdateEvent</code></a> ) über neue Nachrichten über Spring's <code>EventPublisher</code> ("Observer" -Muster).  Wenn Sie möchten, können Sie Ihren eigenen Listener implementieren, indem Sie diese Art von Ereignis abonnieren.  Eine logische Abstraktionsebene, wie es mir scheint, denn es spielt absolut keine Rolle, wie die Nachricht empfangen wurde. </p><br><h3 id="filtry">  Filter </h3><br><p>  Sobald eine neue Nachricht empfangen wurde, muss sie verarbeitet und dem Benutzer geantwortet werden.  Dazu muss die Nachricht die Filterkette durchlaufen. </p><br><p>  Dies ähnelt Java EE-Filtern, die Java-Programmierern bekannt sind.  Der einzige Unterschied besteht darin, dass die sogenannten Handler (wenn wir eine Parallele zu Java EE ziehen, sind dies Servlets) nicht unabhängig von Filtern sind, sondern Teil davon sind. </p><br><p><img src="https://habrastorage.org/webt/uo/ok/y8/uooky82zpiurpncn-szq4bdejni.png" alt="Filterkette"></p><br><p>  Die Filter sind also optimiert und können Nachrichten weiter unten in der Kette erscheinen lassen, vielleicht auch nicht. </p><br><p>  <code>LoggingFilter</code> ist offensichtlich der Filter mit der höchsten Priorität (erster Filter), der im Rahmen der Verarbeitung einer neuen Nachricht aufgerufen wird.  Protokolliert Informationen zu einer eingehenden Nachricht und sendet sie weiter unten in der Kette.  Ich habe absichtlich <code>LoggingFilter</code> als Beispiel hinzugefügt.  In der Tat kann es nicht sinnvoll sein, weil  Eingehende Nachrichten werden auf Client-Ebene protokolliert. </p><br><p>  Der nächste Filter ist <code>CancelFilter</code> .  Es funktioniert im Wesentlichen in Verbindung mit <code>HandlersFilter</code> und ist eine Ergänzung dazu.  Die Aufgabe ist einfach: Wenn der Benutzer das aktuelle Skript verlassen möchte, kann er "/ cancel" oder "cancel" schreiben und sein Status (Sitzung) sollte gelöscht werden.  Er kann jedes neue Szenario starten, ohne das vorherige abzuschließen.  Aus diesem Grund " <code>CancelFilter</code> " höher (Priorität) <code>HandlersFilter</code> . </p><br><p>  <code>HandlersFilter</code> ist der Hauptfilter im aktuellen Prozess.  Dieser Filter speichert den Status von Benutzerchats, findet und ruft den gewünschten Handler (Skript) auf, wendet Validierungsblöcke an, bestimmt die Reihenfolge der Schritte und antwortet dem Benutzer. </p><br><p>  Wenn der <code>HandlersFilter</code> weder in der Sitzung noch im Inhalt geeignete Handler für die Benutzernachricht gefunden hat, wird die Nachricht weiter unten in der Kette gesendet.  Der extreme Filter ist <code>UnresolvedFilter</code> .  Dies ist ein Filter, der weiß, dass es der letzte ist, daher ist seine Funktionalität einfach: Wenn sie mich erreicht haben, ist es nicht klar, wie sie auf eine Nachricht reagieren sollen. Ich werde sagen, dass ich nichts verstanden habe.  Es scheint mir, dass es besser ist, zumindest einige Nachrichten vom Bot zu erhalten, wenn er nicht weiß, wie er antworten soll, als überhaupt nichts zu erhalten. </p><br><p>  Um Ihren Filter hinzuzufügen, müssen Sie eine Bean der <code>TelegramFilter</code> Klasse deklarieren und die Annotation <code>@TelegramFilterOrder(ORDER_NUMBER)</code> angeben. </p><br><div class="spoiler">  <b class="spoiler_title">Filterbeispiel</b> <div class="spoiler_text"><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@Component</span></span> <span class="hljs-meta"><span class="hljs-meta">@TelegramFilterOrder(Integer.MIN_VALUE)</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LoggingFilter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TelegramFilter { override fun handleMessage</span></span></span></span>(message: TelegramMessage, chain: TelegramFilterChain) { log.info(<span class="hljs-string"><span class="hljs-string">"New message from #{}: {}"</span></span>, message.chat.id, message.text) chain.doFilter(message) } <span class="hljs-keyword"><span class="hljs-keyword">companion</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> log = LoggerFactory.getLogger(LoggingFilter::<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">java</span></span></span><span class="hljs-class">) } }</span></span></code> </pre> </div></div><br><p>  So implementiert <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">@TinkoffRatesBot</a> einen „Taschenrechner“.  Ohne ein Skript oder einen Befehl aufzurufen, können Sie eine Nummer senden, z. B. "1000", oder sogar einen ganzen Ausdruck, z. B. "4500 * 3 - 12000".  Der Bot berechnet das Ergebnis des Ausdrucks, wendet die aktuellen Wechselkurse auf das Ergebnis an und zeigt Informationen dazu an.  Tatsächlich ist das Ergebnis solcher Aktionen die Ausführung des <code>CalculationFilter</code> , der sich in der Kette unter dem <code>HandlersFilter</code> , aber über dem <code>HandlersFilter</code> befindet. </p><br><h3 id="obrabotchiki-1">  Handler </h3><br><p>  Das Telegraff-Skriptsystem (Handler) basiert auf dem Kotlin DSL.  Kurz gesagt, es geht um Lambdas und um Bauherren. </p><br><p>  Ich sehe keinen Sinn darin, das Kotlin DSL separat zu betrachten, weil  Das ist ein ganz anderes Gespräch.  Es gibt eine großartige <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Dokumentation</a> von JetBrains und einen umfassenden <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Bericht</a> von <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link">i_osipov</a> . </p><br><h3 id="nyuansy">  Nuancen </h3><br><p>  Dieser Abschnitt ist den vorliegenden Funktionen gewidmet.  Alle sind meiner Meinung nach nicht kritisch, einige können repariert werden, andere nicht.  Aber Sie müssen über diese Aspekte Bescheid wissen. </p><br><p>  Wenn Sie den Wunsch haben, teilzunehmen, oder wissen, wie Sie den einen oder anderen Punkt in diesem Abschnitt korrigieren können, bin ich Ihnen sehr dankbar. </p><br><h4 id="telegram-1">  Telegramm </h4><br><p>  Die Integrationsschicht mit Telegramm ist wahrscheinlich nicht vollständig beschrieben.  Es wurden nur die Methoden implementiert, die ich brauchte.  Wenn Ihnen persönlich etwas fehlt, korrigieren Sie <a href=""><code>TelegramApi</code></a> und senden Sie PR! </p><br><p>  Im Moment ist der Mangel an Inline-Tastaturunterstützung wichtig (dies ist der Fall, wenn sich die Tastatur direkt unter der Meldung in der Multifunktionsleiste befindet).  Die Aufgabe wird durch die Tatsache erschwert, dass Inline-Tastaturen korrekt in die vorhandene Struktur „eingegeben“ werden müssen, damit sie einfach, bequem und isoliert bleibt.  Es gibt bereits eine gute Idee für die Implementierung dieser Funktionalität, sie wurde jedoch noch nicht in irgendeiner Form implementiert und getestet. </p><br><h4 id="fat-jar">  Fettglas </h4><br><p>  Leider können einige Bibliotheken wie <code>JRuby</code> und wahrscheinlich der <code>Kotlin Embedded Compiler</code> (der zum Kompilieren von Skripten benötigt wird) Probleme als Teil der <code>Fat JAR</code> .  <code>Fat JAR</code> ist, wenn Ihr Code und alle Ihre Abhängigkeiten in einer Datei ( <code>*.jar</code> ) gepackt sind. </p><br><p>  Um dieses Problem zu lösen, können Sie Abhängigkeiten zur Laufzeit entpacken.  Das heißt, wenn die Anwendung gestartet wird, wird die Abhängigkeits-JAR vom Hauptpaket irgendwo auf der Festplatte bereitgestellt und der Klassenpfad davor angegeben.  Dies ist über <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">die</a> <code>bootJar</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Konfiguration</a> ziemlich einfach: </p><br><div class="spoiler">  <b class="spoiler_title">Plugin Konfiguration</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">bootJar { requiresUnpack "**/**kotlin**.jar" requiresUnpack "**/**telegraff**.jar" }</code> </pre> </div></div><br><p>  Um jedoch von Handlern (Skripten) auf Ihre Beans (z. B. Dienste) verweisen zu können, müssen diese auch entpackt werden.  Dies eliminiert im Prinzip den Nutzen dieses Ansatzes. </p><br><p>  Aus meiner Sicht bleibt die Verwendung des Gradle- <code>application</code> Plugins die zuverlässigste, einfachste und bequemste Methode.  Wenn Sie Ihre Anwendung containerisieren, gibt es außerdem keinen Unterschied zum Ergebnis. </p><br><p>  Über all das habe ich <a href="">hier</a> ausführlich geschrieben. </p><br><h4 id="poryadok-inicializacii">  Initialisierungsreihenfolge </h4><br><p>  Hier möchte ich zwei Umstände erwähnen. </p><br><p>  Wenn Sie sich das Taxi- <code>enum</code> ansehen, sehen Sie zunächst, dass die <code>enum</code> über dem Aufruf an den <code>handler(...)</code> .  Diese Notwendigkeit wird durch die Tatsache auferlegt, dass der <code>handler</code> tatsächlich ein Funktionsaufruf ist.  Ein Funktionsaufruf, dessen Ergebnis eine Struktur sein sollte, die Telegraff später verwenden wird.  Wenn die Factory gemäß dem Ergebnis der Ausführung Ihres Skripts das Ergebnis nicht auf den gewünschten Typ bringen kann, tritt in der Initialisierungsphase ein Fehler auf. </p><br><p>  Zweitens müssen Sie bedenken, dass Ihre Skripte früher als Ihre gesamte Anwendung und Ihre Beans initialisiert werden können.  Wenn wir beispielsweise einen Link zum Kontext in eine statische Variable einfügen und versuchen, in der ersten Zeile der Skriptdatei einen Dienst abzurufen, stellt sich möglicherweise heraus, dass der Kontext diesen nicht hat, weil  es wurde noch nicht initialisiert.  Verwenden Sie <a href="">diese</a> Telegraff-Methode, um solche Probleme zu vermeiden.  Es stellt sicher, dass der Kontext initialisiert wird und alle erforderlichen Beans verfügbar sind.  Ein Beispiel ist hier zu sehen. </p><br><h2 id="zaklyuchenie">  Fazit </h2><br><p>  Ich wollte versuchen - Gabel, <br>  Ich wollte es reparieren - PR senden, <br>  Ich wollte mich bedanken - setzen Sie ein Sternchen in Github, wie die Post und sagen Sie es Ihren Freunden! </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Projekt-Repository</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de445072/">https://habr.com/ru/post/de445072/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de445060/index.html">Organisieren der Datensuche mithilfe von Spring Data Key-Value-Repositorys</a></li>
<li><a href="../de445062/index.html">Modernes Präsentationsformat?</a></li>
<li><a href="../de445064/index.html">Der Kampf um die Netzneutralität - eine Chance zurückzukehren</a></li>
<li><a href="../de445066/index.html">Wie ich Mathe-Notizen zu LaTeX in Vim schreibe</a></li>
<li><a href="../de445070/index.html">Die Zusammenfassung interessanter Materialien für den mobilen Entwickler # 291 (18. März - 24. März)</a></li>
<li><a href="../de445074/index.html">Programmieren von LibreOffice Base. Teil 1</a></li>
<li><a href="../de445076/index.html">Der IT-Riese führte eine service-definierte Firewall ein</a></li>
<li><a href="../de445078/index.html">Die Quantenphysik dürfte US-amerikanische Stromnetze vor Hackern schützen</a></li>
<li><a href="../de445080/index.html">In Russland wird eine "digitale Eisenbahn" entstehen</a></li>
<li><a href="../de445082/index.html">Letzten Monat haben wir Zuckerberg einen Busen genannt; korrigiert: Tatsächlich sind er und sein Facebook nur eine verdammte Schande</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>