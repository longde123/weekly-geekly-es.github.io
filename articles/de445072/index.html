<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚òùüèæ üë®üèΩ‚Äçüé§ üè° Telegraff: Kotlin DSL f√ºr Telegramm ü•Ö üçø üë®‚Äçüë®‚Äçüëß‚Äçüë¶</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Auf Habr√© Tausende von Artikeln dar√ºber, wie man einen Telegramm-Bot f√ºr verschiedene Programmiersprachen und Plattformen erstellt. Das Thema ist alle...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Telegraff: Kotlin DSL f√ºr Telegramm</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/445072/"><p><img src="https://habrastorage.org/webt/3v/da/0z/3vda0ztz83mtq8efycve_gfyrqa.png" alt="Logo"></p><br><p>  Auf Habr√© Tausende von Artikeln dar√ºber, wie man einen Telegramm-Bot f√ºr verschiedene Programmiersprachen und Plattformen erstellt.  Das Thema ist alles andere als neu. </p><br><p>  Aber Telegraff ist der beste Rahmen f√ºr die Implementierung von Telegramm-Bots, und ich werde es unter dem Strich beweisen. </p><a name="habracut"></a><br><h2 id="preambula">  Pr√§ambel </h2><br><p>  Im Jahr 2015 hatte der russische Rubel Fieber.  Ich hatte Einsparungen in Dollar und √ºberpr√ºfte den Kurs buchst√§blich alle f√ºnf Minuten, um die W√§hrung zu dem Kurs zu verkaufen, den ich brauchte.  Das Fieber zog sich hin, ich wurde m√ºde und schrieb an den Telegramm-Bot ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">@TinkoffRatesBot</a> ), der Sie benachrichtigt, wenn der Wechselkurs den (erwarteten) Schwellenwert erreicht. <br>  Diese Aufgabe hat mich sehr ber√ºhrt.  Botha schrieb ziemlich schnell, aber er erhielt keine Befriedigung. </p><br><p> Die Integration mit Telegramm ist nicht und es gab keine Probleme.  Dieses Problem ist in wenigen Stunden behoben.  Und ich bin sogar √ºberrascht, dass es in Java ganze Bibliotheken (subjektiv mit ekelhaftem Code) f√ºr die Integration in Telegramme gibt, die auf Github mehr als tausend Sterne verdient haben. </p><br><p>  Die gr√∂√üte Herausforderung f√ºr mich war das Skriptsystem: Der Benutzer ruft einen Befehl auf, zum Beispiel "/ Taxi", der Bot stellt ihm eine Reihe von Fragen, jede Antwort wird validiert und kann die Reihenfolge der nachfolgenden Fragen beeinflussen. Das √ºbliche "Formular" wird gebildet, das der endg√ºltigen Verarbeitungsmethode f√ºr das Formen gegeben wird Antwort. <br>  Ich habe das getan, aber die Struktur der Klassen, die Abstraktionsebenen, alles war so heterogen, dass es bitter anzusehen war.  Die Frage qu√§lte mich: Wie kann dies pr√§gnant und organisch auf ein objektorientiertes Modell √ºbertragen werden? </p><br><p>  Ich wollte etwas Einfaches, Bequemes und vor allem - um das gesamte Skript in einer isolierten Datei beschreiben zu k√∂nnen, sodass ich nicht die H√§lfte des Projekts anzeigen musste, um die Benutzerinteraktionskette zu verstehen. </p><br><p>  Um nicht zu sagen, dass das Problem sehr akut war, weil die Aufgabe bereits gel√∂st wurde.  Eher dachte ich manchmal an ihn.  Der Gedanke war Groovy DSL, aber als Kotlin ankam, wurde die Wahl offensichtlich.  Also erschien Telegraff. </p><br><p>  Ja, nat√ºrlich gab es keinen Wettbewerb, den Telegraff gewinnen w√ºrde.  Und die Behauptung, Telegraff sei das Beste, sollte nicht w√∂rtlich genommen werden.  Aber Telegraff ist ein neuer, einzigartiger Ansatz f√ºr diese Herausforderung.  Es ist leicht, der Beste zu sein, der einzige zu sein. </p><br><h2 id="kak-etim-polzovatsya">  Wie benutzt man es? </h2><br><h3 id="zavisimosti">  Abh√§ngigkeiten </h3><br><p>  Der erste Schritt besteht darin, ein zus√§tzliches Repository f√ºr Abh√§ngigkeiten anzugeben.  Vielleicht werde ich irgendwann Telegraff in Maven Central oder im JCenter ver√∂ffentlichen, aber vorerst. </p><br><div class="spoiler">  <b class="spoiler_title">Gradle</b> <div class="spoiler_text"><pre><code class="kotlin hljs">repositories { maven { url <span class="hljs-string"><span class="hljs-string">"https://dl.bintray.com/ruslanys/maven"</span></span> } }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Maven</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">repositories</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">repository</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">snapshots</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">enabled</span></span></span><span class="hljs-tag">&gt;</span></span>false<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">enabled</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">snapshots</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">id</span></span></span><span class="hljs-tag">&gt;</span></span>bintray-ruslanys-maven<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">id</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span>bintray<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">url</span></span></span><span class="hljs-tag">&gt;</span></span>https://dl.bintray.com/ruslanys/maven<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">url</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">repository</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">repositories</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> </div></div><br><p>  Es bleibt der Fall f√ºr kleine.  Um Telegraff verwenden zu k√∂nnen, m√ºssen Sie nur eine Spring-Boot-Starter-Abh√§ngigkeit angeben: </p><br><div class="spoiler">  <b class="spoiler_title">Gradle</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">compile("me.ruslanys.telegraff:telegraff-starter:1.0.0")</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Maven</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>me.ruslanys.telegraff<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>telegraff-starter<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>1.0.0<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> </div></div><br><h3 id="konfiguraciya">  Konfiguration </h3><br><p>  Die Projektkonfiguration ist einfach und kann auf die ersten zwei oder drei Parameter beschr√§nkt werden: </p><br><div class="spoiler">  <b class="spoiler_title">application.properties</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">telegram.access-key=123 # ‚ë† telegram.mode=webhook # ‚ë° telegram.webhook-base-url=https://ruslanys.me # ‚ë¢ telegram.webhook-endpoint-url=/telegram # ‚ë£ telegram.handlers-path=handlers # ‚ë§ telegram.unresolved-filter.enabled=false # ‚ë•</code> </pre> </div></div><br><ol><li>  Ihr Schl√ºssel zur Telegramm-API. </li><li>  Der Modus zum Empfangen von Nachrichten (Aktualisierungen) vom Telegramm.  Es kann entweder Polling oder Webhook sein. </li><li>  Wenn die Methode zum Empfangen von Updates durch "Webhook" angegeben ist, m√ºssen Sie den Pfad zu Ihrer Anwendung angeben. </li><li>  Wenn Sie m√∂chten, k√∂nnen Sie Ihren eigenen Pfad zum Endpunkt angeben.  Wenn dieser Parameter nicht neu definiert wird, wird ein Pfad der folgenden Form generiert: <code>/telegram/${UUID}</code> .  Vor dem Starten der Anwendung wird die angegebene Adresse als Web-Hook-Adresse festgelegt.  Am Ende der Arbeit wird die Web-Hook-Adresse √ºberschrieben, um beim n√§chsten Start zur Abfrage wechseln zu k√∂nnen. </li><li>  Bei Bedarf k√∂nnen Sie den Ordner √§ndern, in dem sich die Skripte der Handler befinden.  Standardm√§√üig ist dies der <code>handlers</code> . </li><li>  <code>UnresolvedFilter</code> ist in der "Lieferung" enthalten und standardm√§√üig aktiviert.  F√ºr den Fall, dass in der Nachricht des Benutzers kein Handler gefunden wurde, antwortet <code>UnresolvedFilter</code> mit etwas wie "Entschuldigung, ich verstehe Sie nicht :(". </li></ol><br><p>  Es ist Zeit, Skripte zu schreiben! </p><br><h3 id="obrabotchiki">  Handler </h3><br><p>  Handler (Skripte) sind ein wichtiger Bestandteil von Telegraff.  Hier wird die Benutzerinteraktionskette festgelegt.  Unter dem Strich ist jeder Befehl wie "/ start", "/ Taxi", "/ help" ein separates Skript / script / handler / handler. </p><br><p>  Ein Skript kann eine Reihe von Schritten (Fragen) enthalten, die ein Benutzer ausf√ºhren muss, um einen Befehl auszuf√ºhren.  Mit anderen Worten, der Benutzer muss das Formular ausf√ºllen.  Und da der Messenger von der Benutzeroberfl√§che stammt, m√ºssen Sie sprechen und den Benutzer fragen. </p><br><p>  Muss ich erkl√§ren, dass Benutzerantworten validiert werden m√ºssen?  Das erste, was der Benutzer tun wird, ist, dass er anders reagiert als erwartet. </p><br><p>  Nun, am Ende kann das Skript verzweigen, d.h.  Jede Antwort auf eine Frage kann sich auf die Reihenfolge der nachfolgenden auswirken. </p><br><p>  Z.B! </p><br><p>  <code>.kts</code> die Datei mit der Erweiterung <code>.kts</code> in den Ordner mit den Ressourcenhandlern: <code>src/main/resources/handlers/ExampleHandler.kts</code> . </p><br><div class="spoiler">  <b class="spoiler_title">Taxi-Anrufszenario</b> <div class="spoiler_text"><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PaymentMethod</span></span></span><span class="hljs-class"> </span></span>{ CARD, CASH } handler(<span class="hljs-string"><span class="hljs-string">"/taxi"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// ‚ë† step&lt;String&gt;("locationFrom") { // ‚ë° question { // ‚ë¢ MarkdownMessage(" ?") } } step&lt;String&gt;("locationTo") { question { MarkdownMessage(" ?") } } step&lt;PaymentMethod&gt;("paymentMethod") { question { state -&gt; MarkdownMessage("   ?", "", "") // ‚ë£ } validation { // ‚ë§ when (it.toLowerCase()) { "" -&gt; PaymentMethod.CARD "" -&gt; PaymentMethod.CASH else -&gt; throw ValidationException(",    ") // ‚ë• } } next { state -&gt; null // ‚ë¶ } } process { state, answers -&gt; // ‚ëß val from = answers["locationFrom"] as String val to = answers["locationTo"] as String val paymentMethod = answers["paymentMethod"] as PaymentMethod // ‚ë® // Business logic MarkdownMessage("""     #${state.chat.id}.   $from  $to.  $paymentMethod. """.trimIndent()) // ‚ë© } }</span></span></code> </pre> </div></div><br><p>  Die Schl√ºssel der Steppen wurden bewusst nicht in Konstanten aufgenommen.  In der Produktion wird dies nat√ºrlich am besten vermieden. </p><br><p>  Lassen Sie es uns herausfinden: </p><br><ol><li>  Wir deklarieren das Skript.  Es ist mindestens ein Teamname erforderlich.  In diesem Fall gibt es zwei Teams: "/ Taxi", "Taxi".  Wenn die Nachricht des Benutzers mit diesen W√∂rtern beginnt, wird der entsprechende Handler aufgerufen. </li><li>  Wir bestimmen die Schritte (Fragen).  Da ist ein eindeutiger Schrittname erforderlich  Anschlie√üend kann √ºber diesen Schl√ºssel (‚ÄûlocationFrom‚Äú) genau auf die Antwort des Benutzers zugegriffen werden. </li><li>  Jeder Schritt enth√§lt drei Abschnitte, von denen der erste die Frage selbst ist.  Die Frage ist ein obligatorischer Abschnitt, der bei jedem Schritt vorhanden sein sollte.  Ein Schritt ohne Frage macht keinen Sinn. </li><li>  Sie k√∂nnen die Frage nach Belieben ausf√ºllen.  In diesem Fall wird der Benutzer √ºber die Tastatur aufgefordert, eine der folgenden Optionen auszuw√§hlen: "Karte" oder "Bargeld".  Als Ergebnis des Aufrufs dieses Blocks sollte ein Objekt vom Typ <code>TelegramSendRequest</code> .  Leider konnte ich mir nichts Besseres als das <code>SendRequest</code> Suffix <code>SendRequest</code> , das die Struktur als ausgehende Anforderung in Telegram beschreibt. <br><img src="https://habrastorage.org/webt/zc/fg/u0/zcfgu08yo--cn3bhnrnhawcfad0.png" alt="Klassenstruktur"></li><li>  Der zweitwichtigste Schrittabschnitt besteht darin, die Antwort des Benutzers zu √ºberpr√ºfen.  Der Typ jedes Schritts ist parametrisiert (generisch), und daher muss der Validierungsblock genau den Typ zur√ºckgeben, mit dem sein Schritt parametrisiert wird. </li><li>  Wenn die Antwort des Benutzers nicht zufriedenstellend ist, k√∂nnen Sie eine <code>ValidationException</code> mit klarstellendem Text, aber derselben Tastatur ausl√∂sen, wenn dies in der Frage angegeben wurde. </li><li>  Der letzte Schrittabschnitt ist ein Block, der den n√§chsten Schritt angibt.  Standardm√§√üig werden Schritte in der Reihenfolge ihrer Deklaration von oben nach unten ausgef√ºhrt.  Dieser Prozess kann jedoch durch √úberschreiben des entsprechenden Blocks beeinflusst werden.  Als Ergebnis der Ausf√ºhrung dieses Blocks kann entweder der Schl√ºssel des n√§chsten Schritts ( <code>String</code> ) oder "null" zur√ºckgegeben werden. Dies zeigt an, dass keine weiteren Schritte vorhanden sind und es Zeit ist, mit der Ausf√ºhrung des Befehls fortzufahren. </li><li>  Wenn eine Benutzeranforderung generiert wird, ist deren Verarbeitung erforderlich.  Die Argumente im Lambda sind Status (dies ist so etwas wie eine Sitzung) und Benutzerantworten. </li><li>  Beachten Sie, dass die fehlgeschlagene Antwort nicht mehr die Antwortzeichenfolge des Benutzers ist, sondern ein bereits verarbeitetes Objekt des gew√ºnschten Typs. </li><li>  Die Antwort auf den Befehl kann beliebig sein, √§hnlich wie in Absatz 4. Wenn die Antwort auf den Befehl nicht erforderlich ist, k√∂nnen Sie "null" zur√ºckgeben. </li></ol><br><p>  Ein Handler hat m√∂glicherweise √ºberhaupt keine Schritte.  In diesem Fall m√ºssen Sie nur das Verhalten des Handlers bestimmen, um den Befehl aufzurufen. </p><br><div class="spoiler">  <b class="spoiler_title">Begr√º√üungsskript</b> <div class="spoiler_text"><pre> <code class="kotlin hljs">handler(<span class="hljs-string"><span class="hljs-string">"/start"</span></span>) { process { _, _ -&gt; MarkdownMessage(<span class="hljs-string"><span class="hljs-string">"!"</span></span>) } }</code> </pre> </div></div><br><h3 id="probuem">  Versuchen Sie es </h3><br><p>  Um dies zu versuchen, gabeln Sie das <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Repository</a> , klonen Sie es auf den lokalen Computer und wechseln Sie in den Ordner <code>telegraff-sample</code> .  Konfigurieren, starten, ber√ºhren! </p><br><p>  Im Allgemeinen ist <code>telegraff-sample</code> ein bewusst unabh√§ngiges Projekt, das nicht mit dem Elternteil zusammenh√§ngt und sogar einen eigenen Gradle Wrapper hat.  Sie k√∂nnen nur diesen Ordner verlassen.  Dies ist eine Art Archetyp. </p><br><h2 id="kak-eto-ustroeno">  Wie funktioniert es </h2><br><h3 id="telegram">  Telegramm </h3><br><p>  Die Integration mit Telegram ist sehr einfach und in <a href=""><code>TelegramApi</code></a> implementiert. </p><br><p>  Jede Methode wurde aufgrund einer Reihe von Umst√§nden absichtlich einzeln implementiert: angefangen von der Verwendung von Spring's RestTemplate (und Tests daf√ºr) bis hin zur Spezifit√§t der Telegramm-API. </p><br><p>  Wie Sie der Konfiguration <a href="">entnehmen</a> k√∂nnen, gibt es in Telegraff zwei Arten von Clients dieser API: <a href="">PollingClient</a> , <a href="">WebhookClient</a> .  Abh√§ngig von der Konfiguration wird ein bestimmter Beh√§lter deklariert. </p><br><p>  Und obwohl sich die Methoden zum Empfangen von Updates (neue Nachrichten) von Telegramm unterscheiden, bleibt das Wesentliche unver√§ndert und l√§uft auf eine Sache hinaus: das Ver√∂ffentlichen eines Ereignisses ( <a href=""><code>TelegramUpdateEvent</code></a> ) √ºber neue Nachrichten √ºber Spring's <code>EventPublisher</code> ("Observer" -Muster).  Wenn Sie m√∂chten, k√∂nnen Sie Ihren eigenen Listener implementieren, indem Sie diese Art von Ereignis abonnieren.  Eine logische Abstraktionsebene, wie es mir scheint, denn es spielt absolut keine Rolle, wie die Nachricht empfangen wurde. </p><br><h3 id="filtry">  Filter </h3><br><p>  Sobald eine neue Nachricht empfangen wurde, muss sie verarbeitet und dem Benutzer geantwortet werden.  Dazu muss die Nachricht die Filterkette durchlaufen. </p><br><p>  Dies √§hnelt Java EE-Filtern, die Java-Programmierern bekannt sind.  Der einzige Unterschied besteht darin, dass die sogenannten Handler (wenn wir eine Parallele zu Java EE ziehen, sind dies Servlets) nicht unabh√§ngig von Filtern sind, sondern Teil davon sind. </p><br><p><img src="https://habrastorage.org/webt/uo/ok/y8/uooky82zpiurpncn-szq4bdejni.png" alt="Filterkette"></p><br><p>  Die Filter sind also optimiert und k√∂nnen Nachrichten weiter unten in der Kette erscheinen lassen, vielleicht auch nicht. </p><br><p>  <code>LoggingFilter</code> ist offensichtlich der Filter mit der h√∂chsten Priorit√§t (erster Filter), der im Rahmen der Verarbeitung einer neuen Nachricht aufgerufen wird.  Protokolliert Informationen zu einer eingehenden Nachricht und sendet sie weiter unten in der Kette.  Ich habe absichtlich <code>LoggingFilter</code> als Beispiel hinzugef√ºgt.  In der Tat kann es nicht sinnvoll sein, weil  Eingehende Nachrichten werden auf Client-Ebene protokolliert. </p><br><p>  Der n√§chste Filter ist <code>CancelFilter</code> .  Es funktioniert im Wesentlichen in Verbindung mit <code>HandlersFilter</code> und ist eine Erg√§nzung dazu.  Die Aufgabe ist einfach: Wenn der Benutzer das aktuelle Skript verlassen m√∂chte, kann er "/ cancel" oder "cancel" schreiben und sein Status (Sitzung) sollte gel√∂scht werden.  Er kann jedes neue Szenario starten, ohne das vorherige abzuschlie√üen.  Aus diesem Grund " <code>CancelFilter</code> " h√∂her (Priorit√§t) <code>HandlersFilter</code> . </p><br><p>  <code>HandlersFilter</code> ist der Hauptfilter im aktuellen Prozess.  Dieser Filter speichert den Status von Benutzerchats, findet und ruft den gew√ºnschten Handler (Skript) auf, wendet Validierungsbl√∂cke an, bestimmt die Reihenfolge der Schritte und antwortet dem Benutzer. </p><br><p>  Wenn der <code>HandlersFilter</code> weder in der Sitzung noch im Inhalt geeignete Handler f√ºr die Benutzernachricht gefunden hat, wird die Nachricht weiter unten in der Kette gesendet.  Der extreme Filter ist <code>UnresolvedFilter</code> .  Dies ist ein Filter, der wei√ü, dass es der letzte ist, daher ist seine Funktionalit√§t einfach: Wenn sie mich erreicht haben, ist es nicht klar, wie sie auf eine Nachricht reagieren sollen. Ich werde sagen, dass ich nichts verstanden habe.  Es scheint mir, dass es besser ist, zumindest einige Nachrichten vom Bot zu erhalten, wenn er nicht wei√ü, wie er antworten soll, als √ºberhaupt nichts zu erhalten. </p><br><p>  Um Ihren Filter hinzuzuf√ºgen, m√ºssen Sie eine Bean der <code>TelegramFilter</code> Klasse deklarieren und die Annotation <code>@TelegramFilterOrder(ORDER_NUMBER)</code> angeben. </p><br><div class="spoiler">  <b class="spoiler_title">Filterbeispiel</b> <div class="spoiler_text"><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@Component</span></span> <span class="hljs-meta"><span class="hljs-meta">@TelegramFilterOrder(Integer.MIN_VALUE)</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LoggingFilter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TelegramFilter { override fun handleMessage</span></span></span></span>(message: TelegramMessage, chain: TelegramFilterChain) { log.info(<span class="hljs-string"><span class="hljs-string">"New message from #{}: {}"</span></span>, message.chat.id, message.text) chain.doFilter(message) } <span class="hljs-keyword"><span class="hljs-keyword">companion</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> log = LoggerFactory.getLogger(LoggingFilter::<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">java</span></span></span><span class="hljs-class">) } }</span></span></code> </pre> </div></div><br><p>  So implementiert <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">@TinkoffRatesBot</a> einen ‚ÄûTaschenrechner‚Äú.  Ohne ein Skript oder einen Befehl aufzurufen, k√∂nnen Sie eine Nummer senden, z. B. "1000", oder sogar einen ganzen Ausdruck, z. B. "4500 * 3 - 12000".  Der Bot berechnet das Ergebnis des Ausdrucks, wendet die aktuellen Wechselkurse auf das Ergebnis an und zeigt Informationen dazu an.  Tats√§chlich ist das Ergebnis solcher Aktionen die Ausf√ºhrung des <code>CalculationFilter</code> , der sich in der Kette unter dem <code>HandlersFilter</code> , aber √ºber dem <code>HandlersFilter</code> befindet. </p><br><h3 id="obrabotchiki-1">  Handler </h3><br><p>  Das Telegraff-Skriptsystem (Handler) basiert auf dem Kotlin DSL.  Kurz gesagt, es geht um Lambdas und um Bauherren. </p><br><p>  Ich sehe keinen Sinn darin, das Kotlin DSL separat zu betrachten, weil  Das ist ein ganz anderes Gespr√§ch.  Es gibt eine gro√üartige <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Dokumentation</a> von JetBrains und einen umfassenden <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Bericht</a> von <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link">i_osipov</a> . </p><br><h3 id="nyuansy">  Nuancen </h3><br><p>  Dieser Abschnitt ist den vorliegenden Funktionen gewidmet.  Alle sind meiner Meinung nach nicht kritisch, einige k√∂nnen repariert werden, andere nicht.  Aber Sie m√ºssen √ºber diese Aspekte Bescheid wissen. </p><br><p>  Wenn Sie den Wunsch haben, teilzunehmen, oder wissen, wie Sie den einen oder anderen Punkt in diesem Abschnitt korrigieren k√∂nnen, bin ich Ihnen sehr dankbar. </p><br><h4 id="telegram-1">  Telegramm </h4><br><p>  Die Integrationsschicht mit Telegramm ist wahrscheinlich nicht vollst√§ndig beschrieben.  Es wurden nur die Methoden implementiert, die ich brauchte.  Wenn Ihnen pers√∂nlich etwas fehlt, korrigieren Sie <a href=""><code>TelegramApi</code></a> und senden Sie PR! </p><br><p>  Im Moment ist der Mangel an Inline-Tastaturunterst√ºtzung wichtig (dies ist der Fall, wenn sich die Tastatur direkt unter der Meldung in der Multifunktionsleiste befindet).  Die Aufgabe wird durch die Tatsache erschwert, dass Inline-Tastaturen korrekt in die vorhandene Struktur ‚Äûeingegeben‚Äú werden m√ºssen, damit sie einfach, bequem und isoliert bleibt.  Es gibt bereits eine gute Idee f√ºr die Implementierung dieser Funktionalit√§t, sie wurde jedoch noch nicht in irgendeiner Form implementiert und getestet. </p><br><h4 id="fat-jar">  Fettglas </h4><br><p>  Leider k√∂nnen einige Bibliotheken wie <code>JRuby</code> und wahrscheinlich der <code>Kotlin Embedded Compiler</code> (der zum Kompilieren von Skripten ben√∂tigt wird) Probleme als Teil der <code>Fat JAR</code> .  <code>Fat JAR</code> ist, wenn Ihr Code und alle Ihre Abh√§ngigkeiten in einer Datei ( <code>*.jar</code> ) gepackt sind. </p><br><p>  Um dieses Problem zu l√∂sen, k√∂nnen Sie Abh√§ngigkeiten zur Laufzeit entpacken.  Das hei√üt, wenn die Anwendung gestartet wird, wird die Abh√§ngigkeits-JAR vom Hauptpaket irgendwo auf der Festplatte bereitgestellt und der Klassenpfad davor angegeben.  Dies ist √ºber <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">die</a> <code>bootJar</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Konfiguration</a> ziemlich einfach: </p><br><div class="spoiler">  <b class="spoiler_title">Plugin Konfiguration</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">bootJar { requiresUnpack "**/**kotlin**.jar" requiresUnpack "**/**telegraff**.jar" }</code> </pre> </div></div><br><p>  Um jedoch von Handlern (Skripten) auf Ihre Beans (z. B. Dienste) verweisen zu k√∂nnen, m√ºssen diese auch entpackt werden.  Dies eliminiert im Prinzip den Nutzen dieses Ansatzes. </p><br><p>  Aus meiner Sicht bleibt die Verwendung des Gradle- <code>application</code> Plugins die zuverl√§ssigste, einfachste und bequemste Methode.  Wenn Sie Ihre Anwendung containerisieren, gibt es au√üerdem keinen Unterschied zum Ergebnis. </p><br><p>  √úber all das habe ich <a href="">hier</a> ausf√ºhrlich geschrieben. </p><br><h4 id="poryadok-inicializacii">  Initialisierungsreihenfolge </h4><br><p>  Hier m√∂chte ich zwei Umst√§nde erw√§hnen. </p><br><p>  Wenn Sie sich das Taxi- <code>enum</code> ansehen, sehen Sie zun√§chst, dass die <code>enum</code> √ºber dem Aufruf an den <code>handler(...)</code> .  Diese Notwendigkeit wird durch die Tatsache auferlegt, dass der <code>handler</code> tats√§chlich ein Funktionsaufruf ist.  Ein Funktionsaufruf, dessen Ergebnis eine Struktur sein sollte, die Telegraff sp√§ter verwenden wird.  Wenn die Factory gem√§√ü dem Ergebnis der Ausf√ºhrung Ihres Skripts das Ergebnis nicht auf den gew√ºnschten Typ bringen kann, tritt in der Initialisierungsphase ein Fehler auf. </p><br><p>  Zweitens m√ºssen Sie bedenken, dass Ihre Skripte fr√ºher als Ihre gesamte Anwendung und Ihre Beans initialisiert werden k√∂nnen.  Wenn wir beispielsweise einen Link zum Kontext in eine statische Variable einf√ºgen und versuchen, in der ersten Zeile der Skriptdatei einen Dienst abzurufen, stellt sich m√∂glicherweise heraus, dass der Kontext diesen nicht hat, weil  es wurde noch nicht initialisiert.  Verwenden Sie <a href="">diese</a> Telegraff-Methode, um solche Probleme zu vermeiden.  Es stellt sicher, dass der Kontext initialisiert wird und alle erforderlichen Beans verf√ºgbar sind.  Ein Beispiel ist hier zu sehen. </p><br><h2 id="zaklyuchenie">  Fazit </h2><br><p>  Ich wollte versuchen - Gabel, <br>  Ich wollte es reparieren - PR senden, <br>  Ich wollte mich bedanken - setzen Sie ein Sternchen in Github, wie die Post und sagen Sie es Ihren Freunden! </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Projekt-Repository</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de445072/">https://habr.com/ru/post/de445072/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de445060/index.html">Organisieren der Datensuche mithilfe von Spring Data Key-Value-Repositorys</a></li>
<li><a href="../de445062/index.html">Modernes Pr√§sentationsformat?</a></li>
<li><a href="../de445064/index.html">Der Kampf um die Netzneutralit√§t - eine Chance zur√ºckzukehren</a></li>
<li><a href="../de445066/index.html">Wie ich Mathe-Notizen zu LaTeX in Vim schreibe</a></li>
<li><a href="../de445070/index.html">Die Zusammenfassung interessanter Materialien f√ºr den mobilen Entwickler # 291 (18. M√§rz - 24. M√§rz)</a></li>
<li><a href="../de445074/index.html">Programmieren von LibreOffice Base. Teil 1</a></li>
<li><a href="../de445076/index.html">Der IT-Riese f√ºhrte eine service-definierte Firewall ein</a></li>
<li><a href="../de445078/index.html">Die Quantenphysik d√ºrfte US-amerikanische Stromnetze vor Hackern sch√ºtzen</a></li>
<li><a href="../de445080/index.html">In Russland wird eine "digitale Eisenbahn" entstehen</a></li>
<li><a href="../de445082/index.html">Letzten Monat haben wir Zuckerberg einen Busen genannt; korrigiert: Tats√§chlich sind er und sein Facebook nur eine verdammte Schande</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>