<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üçò ü§Æ üöî Plantillas avanzadas de compilaci√≥n de varias etapas üöµüèº ‚ÜòÔ∏è üëπ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="La funci√≥n de compilaci√≥n de m√∫ltiples etapas en los archivos Dockerfile le permite crear peque√±as im√°genes de contenedor con un mayor nivel de almace...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Plantillas avanzadas de compilaci√≥n de varias etapas</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/southbridge/blog/433790/"><p><img src="https://habrastorage.org/getpro/habr/post_images/ae4/9db/b18/ae49dbb18f8454823b9e133b737cacf0.png" alt="imagen"></p><br><p>  La funci√≥n de compilaci√≥n de m√∫ltiples etapas en los archivos Dockerfile le permite crear peque√±as im√°genes de contenedor con un mayor nivel de almacenamiento en cach√© y menos protecci√≥n.  En este art√≠culo, le mostrar√© algunas plantillas avanzadas, algo m√°s que copiar archivos entre compilaci√≥n y ejecuci√≥n.  Le permiten lograr la m√°xima eficiencia de la funci√≥n.  Sin embargo, si usted es un principiante en el campo del ensamblaje de etapas m√∫ltiples, primero, probablemente, no ser√° un error leer el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">manual del</a> usuario. </p><a name="habracut"></a><br><h3 id="sovmestimost-versiy">  Compatibilidad de versiones </h3><br><p>  El soporte de compilaci√≥n multietapa se agreg√≥ a Docker en la versi√≥n v17.05.  Todas las plantillas funcionan con cualquier versi√≥n posterior, pero algunas son mucho m√°s eficientes, gracias a los <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">enlazadores que</a> utilizan el lado del servidor <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">BuildKit</a> .  Digamos que BuildKit omite efectivamente las etapas no utilizadas y, si es posible, crea etapas al mismo tiempo (destaqu√© estos ejemplos por separado).  BuildKit se <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">est√°</a> agregando actualmente <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">a Moby</a> como un backend experimental <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">para la</a> compilaci√≥n y deber√≠a estar disponible en Docker CE v18.06.  Tambi√©n se puede usar de forma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aut√≥noma</a> o como parte del proyecto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">img</a> . </p><br><hr><br><h4 id="nasledovanie-ot-etapa">  Herencia esc√©nica </h4><br><p> La construcci√≥n de etapas m√∫ltiples agrega varios conceptos nuevos de sintaxis.  En primer lugar, puede <code>AS stagename</code> la etapa que comience con el comando <code>FROM</code> el nombre <code>AS stagename</code> y usar la <code>--from=stagename</code> en el <code>COPY</code> para copiar archivos de esta etapa.  De hecho, el comando <code>FROM</code> y la etiqueta <code>--from</code> tienen mucho m√°s en com√∫n, no en vano, tienen el mismo nombre.  Ambos toman el mismo argumento, lo reconocen y comienzan una nueva etapa desde este punto, o lo usan como fuente para copiar el archivo.  Es decir, para usar la etapa anterior en la calidad de imagen original para la etapa actual, puede tomar no solo <code>--from=stagename</code> , sino tambi√©n el nombre de etapa <code>FROM stagename</code> .  Es √∫til si usa las mismas partes comunes en varios comandos en el Dockerfile: reduce el c√≥digo com√∫n y simplifica su mantenimiento, manteniendo separados los pasos secundarios.  Por lo tanto, la reconstrucci√≥n de una etapa no afecta la cach√© de ensamblaje para otras.  En consecuencia, cada etapa se puede ensamblar individualmente utilizando la etiqueta <code>--target</code> cuando se llama a <code>--target</code> . </p><br><pre> <code class="plaintext hljs">FROM ubuntu AS base RUN apt-get update &amp;&amp; apt-get install git FROM base AS src1 RUN git clone ‚Ä¶ FROM base as src2 RUN git clone ‚Ä¶</code> </pre> <br><p>  En este ejemplo, las fases segunda y tercera en BuildKit se crean al mismo tiempo. </p><br><h3 id="neposredstvennoe-ispolzovanie-obrazov">  Uso directo de im√°genes. </h3><br><p>  En lugar de usar nombres de etapas de ensamblaje en comandos <code>FROM</code> que anteriormente solo admit√≠an referencias de im√°genes, puede usar im√°genes directamente usando la etiqueta <code>--from</code> .  Resulta copiar archivos directamente de estas im√°genes.  Por ejemplo, <code>linuxkit/ca-certificatesimage</code> en el siguiente c√≥digo copia directamente las ra√≠ces de TLS CA en el paso actual. </p><br><pre> <code class="plaintext hljs">FROM alpine COPY --from=linuxkit/ca-certificates / /</code> </pre> <br><h3 id="psevdonim-obschego-obraza">  Alias ‚Äã‚Äãde imagen com√∫n </h3><br><p>  La fase de construcci√≥n no incluye necesariamente ning√∫n comando;  Puede consistir en una sola l√≠nea <code>FROM</code> .  Si usa la imagen en varios lugares, esto simplificar√° la lectura y har√° que si necesita actualizar la imagen general, solo necesita cambiar una l√≠nea. </p><br><pre> <code class="plaintext hljs">FROM alpine:3.6 AS alpine FROM alpine RUN ‚Ä¶ FROM alpine RUN ‚Ä¶</code> </pre> <br><p>  En este ejemplo, cada lugar que usa la imagen alpina est√° realmente comprometido con <code>alpine:3.6</code> , no <code>alpine:latest</code> .  Cuando llegue el momento de actualizar a <code>alpine:3.7</code> , deber√° cambiar una sola l√≠nea, y no hay duda: ahora todos los elementos del ensamblaje usan una versi√≥n actualizada. </p><br><p>  Esto es a√∫n m√°s importante cuando el argumento de compilaci√≥n se usa en el alias.  El siguiente ejemplo es similar al anterior, pero permite al usuario redefinir todas las instancias del ensamblaje en el que est√° involucrada la imagen alpina configurando la <code>--build-arg ALPINE_VERSION=value</code> .  Recuerde: cualquier argumento utilizado en los comandos <code>FROM</code> debe determinarse <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">antes de la primera fase de compilaci√≥n</a> . </p><br><pre> <code class="plaintext hljs">ARG ALPINE_VERSION=3.6 FROM alpine:${ALPINE_VERSION} AS alpine FROM alpine RUN ‚Ä¶</code> </pre> <br><h3 id="ispolzovanie-argumentov-sborki-v-from">  Usar argumentos de compilaci√≥n en "- desde" </h3><br><p>  El valor especificado en la etiqueta <code>--from</code> del <code>COPY</code> no debe contener argumentos de ensamblaje.  Por ejemplo, el siguiente ejemplo no es v√°lido. </p><br><pre> <code class="plaintext hljs">// THIS EXAMPLE IS INTENTIONALLY INVALID FROM alpine AS build-stage0 RUN ‚Ä¶ FROM alpine ARG src=stage0 COPY --from=build-${src} . .</code> </pre> <br><p>  Esto se debe al hecho de que las dependencias entre las etapas deben determinarse antes de que comience el ensamblaje.  Entonces no se requiere una evaluaci√≥n constante de todos los equipos.  Por ejemplo, una variable de entorno definida en una imagen <code>alpine</code> puede afectar la evaluaci√≥n del valor <code>--from</code> .  La raz√≥n por la que podemos evaluar los argumentos del comando <code>FROM</code> es porque estos argumentos se definen globalmente antes de que comience cualquier etapa.  Afortunadamente, como descubrimos anteriormente, es suficiente definir la etapa del alias usando un comando <code>FROM</code> y consultarlo. </p><br><pre> <code class="plaintext hljs">ARG src=stage0 FROM alpine AS build-stage0 RUN ‚Ä¶ FROM build-${src} AS copy-src FROM alpine COPY --from=copy-src . .</code> </pre> <br><p>  Ahora, si anula el argumento de ensamblaje <code>src</code> , el paso inicial para el elemento <code>COPY</code> final cambiar√°.  Tenga en cuenta: si algunos pasos ya no se utilizan, solo los vinculadores basados ‚Äã‚Äãen BuildKit pueden omitirlos de manera efectiva. </p><br><h3 id="usloviya-ispolzuyuschie-argumenty-sborki">  Condiciones que utilizan argumentos de compilaci√≥n </h3><br><p>  Se nos solicit√≥ agregar soporte para las condiciones de estilo <code>IF/ELSE</code> al Dockerfile.  Todav√≠a no sabemos si agregaremos algo similar, pero en el futuro intentaremos usar el soporte al cliente en BuildKit.  Mientras tanto, para lograr un comportamiento similar, puede usar los conceptos actuales de varias etapas (con algo de planificaci√≥n). </p><br><pre> <code class="plaintext hljs">// THIS EXAMPLE IS INTENTIONALLY INVALID FROM alpine RUN ‚Ä¶ ARG BUILD_VERSION=1 IF $BUILD_VERSION==1 RUN touch version1 ELSE IF $BUILD_VERSION==2 RUN touch version2 DONE RUN ‚Ä¶</code> </pre> <br><p>  El ejemplo anterior muestra pseudoc√≥digo para grabar condiciones usando <code>IF/ELSE</code> .  Para lograr un comportamiento similar con las compilaciones de etapas m√∫ltiples actuales, es posible que deba definir varias condiciones de ramificaci√≥n como pasos separados y usar un argumento para seleccionar la ruta de dependencia correcta. </p><br><pre> <code class="plaintext hljs">ARG BUILD_VERSION=1 FROM alpine AS base RUN ‚Ä¶ FROM base AS branch-version-1 RUN touch version1 FROM base AS branch-version-2 RUN touch version2 FROM branch-version-${BUILD_VERSION} AS after-condition FROM after-condition RUN ‚Ä¶</code> </pre> <br><p>  El √∫ltimo paso en el Dockerfile se basa en la etapa <code>after-condition</code> , que es el alias de la imagen (reconocido en funci√≥n del <code>BUILD_VERSION</code> compilaci√≥n <code>BUILD_VERSION</code> ).  Dependiendo del valor de <code>BUILD_VERSION</code> , se selecciona esta o aquella etapa de la secci√≥n central. </p><br><p>  Tenga en cuenta que solo los vinculadores basados ‚Äã‚Äãen BuildKit pueden omitir ramas no utilizadas.  En las versiones anteriores de los enlazadores, se construir√≠an todas las etapas, pero antes de crear la imagen final, sus resultados se descartar√≠an. </p><br><h3 id="pomoschnik-po-razrabotketestirovaniyu-dlya-minimalnogo-proizvodstvennogo-etapa">  Asistente de desarrollo / pruebas para la fase de producci√≥n m√≠nima </h3><br><p>  En conclusi√≥n, veamos un ejemplo de combinaci√≥n de plantillas anteriores para demostrar c√≥mo crear un Dockerfile que crea una imagen de producci√≥n m√≠nima y luego puede usar su contenido para probar y crear una imagen de desarrollo.  Comencemos con el ejemplo b√°sico de Dockerfile: </p><br><pre> <code class="plaintext hljs">FROM golang:alpine AS stage0 ‚Ä¶ FROM golang:alpine AS stage1 ‚Ä¶ FROM scratch COPY --from=stage0 /binary0 /bin COPY --from=stage1 /binary1 /bin</code> </pre> <br><p>  Cuando se crea una imagen de producci√≥n m√≠nima, esta es una opci√≥n bastante com√∫n.  Pero, ¬øqu√© sucede si tambi√©n necesita obtener una imagen de desarrollador alternativa o ejecutar pruebas con estos binarios en la etapa final?  Lo primero que viene a la mente es simplemente copiar binarios similares en las etapas de prueba y desarrollo.  El problema es este: no hay garant√≠a de que probar√° todos los binarios de producci√≥n en la misma combinaci√≥n.  En la etapa final, algo puede cambiar, pero olvidar√° realizar cambios similares en otras etapas o cometer un error al copiar archivos binarios.  Al final, no estamos probando un archivo binario separado, sino la imagen final. </p><br><p>  Una alternativa es determinar la fase de desarrollo y prueba despu√©s de la fase de producci√≥n y copiar todo el contenido de la fase de producci√≥n.  Luego use un comando <code>FROM</code> para el paso de producci√≥n para hacer que el paso de producci√≥n predeterminado sea el √∫ltimo paso nuevamente. </p><br><pre> <code class="plaintext hljs">FROM golang:alpine AS stage0 ‚Ä¶ FROM scratch AS release COPY --from=stage0 /binary0 /bin COPY --from=stage1 /binary1 /bin FROM golang:alpine AS dev-env COPY --from=release / / ENTRYPOINT ["ash"] FROM golang:alpine AS test COPY --from=release / / RUN go test ‚Ä¶ FROM release</code> </pre> <br><p>  De manera predeterminada, este Dockerfile continuar√° creando la imagen predeterminada m√≠nima, mientras que, por ejemplo, un ensamblaje con la opci√≥n <code>--target=dev-env</code> crear√° una imagen con un shell que contiene todos los archivos binarios de la versi√≥n final. </p><br><hr><br><p>  Espero que esto haya sido √∫til y sugiri√≥ c√≥mo crear archivos Docker de varias etapas m√°s eficientes.  Si participa en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">DockerCon2018</a> y desea obtener m√°s informaci√≥n sobre compilaciones de varias etapas, Dockerfiles, BuildKit o cualquier otro tema relacionado, reg√≠strese en el enlazador de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">pistas</a> del <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">pasillo</a> o siga las reuniones internas de la plataforma Docker en las pistas de <a href="">Contribute y Collaborate</a> o <a href="">Black Belt</a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es433790/">https://habr.com/ru/post/es433790/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es433776/index.html">Tutorial de controladores de MongoDB Go</a></li>
<li><a href="../es433780/index.html">Transici√≥n del kit UI al sistema de dise√±o en QIWI</a></li>
<li><a href="../es433782/index.html">Un ejemplo pr√°ctico de crear su propio componente View</a></li>
<li><a href="../es433786/index.html">Fintech Digest: la criptomoneda es propiedad, se ha emitido un n√∫mero r√©cord de tarjetas de cr√©dito en la Federaci√≥n Rusa</a></li>
<li><a href="../es433788/index.html">Oferta segura y nuevas revisiones independientes</a></li>
<li><a href="../es433792/index.html">Scripts de shell en Ansible</a></li>
<li><a href="../es433796/index.html">C√≥mo el Homo Sapiens conquist√≥ el mundo. Habilidades de comunicaci√≥n y negociaci√≥n.</a></li>
<li><a href="../es433798/index.html">HomeKit y ioBroker Hagamos amigos en casa</a></li>
<li><a href="../es433800/index.html">Usando los controladores UDB PSoC de Cypress para reducir las interrupciones en una impresora 3D</a></li>
<li><a href="../es433802/index.html">C√≥mo y por qu√© ganamos la pista de Big Data en el Hackathon Urban Tech Challenge</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>