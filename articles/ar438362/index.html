<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💪 👢 🙁 كيف قمنا بترجمة تكوين خدماتنا من XML إلى YAML 👩🏿‍🤝‍👨🏾 🖐🏾 🚜</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="الخلفية 
 قامت شركتنا ، من بين أشياء أخرى ، بتطوير العديد من الخدمات (بشكل أكثر دقة - 12) تعمل كخلفية لأنظمتنا. كل من الخدمات هي خدمة Windows وتؤدي مه...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>كيف قمنا بترجمة تكوين خدماتنا من XML إلى YAML</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/utex/blog/438362/" style=";text-align:right;direction:rtl"><h2 style=";text-align:right;direction:rtl">  الخلفية </h2><br>  قامت شركتنا ، من بين أشياء أخرى ، بتطوير العديد من الخدمات (بشكل أكثر دقة - 12) تعمل كخلفية لأنظمتنا.  كل من الخدمات هي خدمة Windows وتؤدي مهامها المحددة. <br><br>  أود نقل جميع هذه الخدمات إلى * nix-OS.  للقيام بذلك ، التخلي عن المجمع في شكل خدمات Windows والتبديل من .NET Framework إلى .NET Standard. <br><br>  يؤدي الشرط الأخير إلى الحاجة إلى التخلص من بعض رمز Legacy ، وهو غير معتمد في .NET Standard ، بما في ذلك  من دعم تكوين خوادمنا عبر XML ، يتم تنفيذها باستخدام فئات من System.Configuration.  في الوقت نفسه ، يعمل هذا على حل المشكلة الطويلة الأمد المتعلقة بحقيقة أننا في ملفات XML-config ارتكبنا أخطاء من وقت لآخر عند تغيير الإعدادات (على سبيل المثال ، في بعض الأحيان نضع علامة الإغلاق في المكان الخطأ أو ننساه على الإطلاق) ، ولكن قارئ رائع لـ System.Xml XML-configs. XmlDocument يبتلع بصمت مثل هذه التكوينات ، مما يؤدي إلى نتيجة غير متوقعة تمامًا. <br><br>  تقرر التبديل إلى التكوين من خلال YAML العصرية.  ما هي المشكلات التي واجهناها وكيف حلها - في هذه المقالة. <br><a name="habracut"></a><br><h2 style=";text-align:right;direction:rtl">  ماذا لدينا </h2><br><h3 style=";text-align:right;direction:rtl">  كيف يمكننا قراءة التكوين من XML </h3><br>  نقرأ XML بطريقة قياسية لمعظم المشاريع الأخرى. <br><br>  تحتوي كل خدمة على ملف إعدادات لمشاريع .NET ، يسمى AppSettings.cs ، والذي يحتوي على كافة الإعدادات المطلوبة بواسطة الخدمة.  شيء مثل هذا: <br><br><pre style=";text-align:right;direction:rtl"><code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">System.Configuration.SettingsProvider(typeof(PortableSettingsProvider))</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">AppSettings</span></span> : <span class="hljs-title"><span class="hljs-title">IServerManagerConfigStorage</span></span>, <span class="hljs-title"><span class="hljs-title">IWebSettingsStorage</span></span>, <span class="hljs-title"><span class="hljs-title">IServerSettingsStorage</span></span>, <span class="hljs-title"><span class="hljs-title">IGraphiteAddressStorage</span></span>, <span class="hljs-title"><span class="hljs-title">IDatabaseConfigStorage</span></span>, <span class="hljs-title"><span class="hljs-title">IBlackListStorage</span></span>, <span class="hljs-title"><span class="hljs-title">IKeyCloackConfigFilePathProvider</span></span>, <span class="hljs-title"><span class="hljs-title">IPrometheusSettingsStorage</span></span>, <span class="hljs-title"><span class="hljs-title">IMetricsConfig</span></span> { }</code> </pre> <br><br>  تقنية مشابهة لفصل الإعدادات إلى واجهات تجعلها ملائمة لاستخدامها لاحقًا عبر حاوية DI. <br><br>  يتم إخفاء كل السحر الرئيسي لتخزين الإعدادات في PortableSettingsProvider (انظر السمة class) ، وكذلك في AppSettings.Designer.cs ملف المصمم: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">global::System.Runtime.CompilerServices.CompilerGeneratedAttribute()</span></span>] [<span class="hljs-keyword"><span class="hljs-keyword">global</span></span>::System.CodeDom.Compiler.GeneratedCodeAttribute(<span class="hljs-string"><span class="hljs-string">"Microsoft.VisualStudio.Editors.SettingsDesigner.SettingsSingleFileGenerator"</span></span>, <span class="hljs-string"><span class="hljs-string">"14.0.0.0"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">AppSettings</span></span> : <span class="hljs-title"><span class="hljs-title">global</span></span>::<span class="hljs-title"><span class="hljs-title">System</span></span>.<span class="hljs-title"><span class="hljs-title">Configuration</span></span>.<span class="hljs-title"><span class="hljs-title">ApplicationSettingsBase</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> AppSettings defaultInstance = ((AppSettings)(<span class="hljs-keyword"><span class="hljs-keyword">global</span></span>::System.Configuration.ApplicationSettingsBase.Synchronized(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AppSettings()))); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> AppSettings Default { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> defaultInstance; } } [<span class="hljs-keyword"><span class="hljs-keyword">global</span></span>::System.Configuration.UserScopedSettingAttribute()] [<span class="hljs-keyword"><span class="hljs-keyword">global</span></span>::System.Diagnostics.DebuggerNonUserCodeAttribute()] [<span class="hljs-keyword"><span class="hljs-keyword">global</span></span>::System.Configuration.DefaultSettingValueAttribute(<span class="hljs-string"><span class="hljs-string">"35016"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ListenPort { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>[<span class="hljs-string"><span class="hljs-string">"ListenPort"</span></span>])); } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>[<span class="hljs-string"><span class="hljs-string">"ListenPort"</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } } ...</code> </pre><br>  كما ترون ، "وراء الكواليس" يتم إخفاء كل تلك الخصائص التي نضيفها إلى تكوين الخادم عندما نقوم بتحريرها من خلال مصمم الإعدادات في Visual Studio. <br><br>  تقوم فئة PortableSettingsProvider ، المذكورة أعلاه ، بقراءة ملف XML مباشرةً ، ويتم استخدام نتيجة القراءة بالفعل في SettingsProvider لكتابة الإعدادات إلى خصائص AppSettings. <br><br>  مثال على تهيئة XML التي نقرأها (معظم الإعدادات مخفية لأسباب أمنية): <br><br><pre style=";text-align:right;direction:rtl"> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configSections</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">sectionGroup</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"userSettings"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"System.Configuration.UserSettingsGroup"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">section</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"MetricServer.Properties.Settings"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"System.Configuration.ClientSettingsSection"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">sectionGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configSections</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">userSettings</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">MetricServer.Properties.Settings</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">setting</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"MCXSettings"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">serializeAs</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"String"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">value</span></span></span><span class="hljs-tag">&gt;</span></span>Inactive, ChartLen: 1000, PrintLen: 50, UseProxy: False<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">value</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">setting</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">setting</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"KickUnknownAfter"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">serializeAs</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"String"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">value</span></span></span><span class="hljs-tag">&gt;</span></span>00:00:10<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">value</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">setting</span></span></span><span class="hljs-tag">&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">MetricServer.Properties.Settings</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">userSettings</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><h3 style=";text-align:right;direction:rtl">  ما YAML الملفات أود أن أقرأ </h3><br>  شيء مثل هذا: <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">VirtualFeed: MaxChartHistoryLength: 10 Port: 35016 UseThrottling: True ThrottlingIntervalMs: 50000 UseHistoryBroadcast: True CalendarName: "EmptyCalendar" UsMarketFeed: UseImbalances: True</code> </pre><br><h3 style=";text-align:right;direction:rtl">  مشاكل الانتقال </h3><br>  <b>أولاً ، تكون</b> التكوينات في XML "مسطحة" ، لكن في YAML لا تكون (الأقسام والأقسام الفرعية مدعومة).  وينظر إلى هذا بوضوح في الأمثلة المذكورة أعلاه.  باستخدام XML ، قمنا بحل مشكلة الإعدادات المسطحة من خلال تقديم موزعات خاصة بنا يمكنها تحويل سلاسل من نوع معين إلى فئات أكثر تعقيدًا لدينا.  مثال على مثل هذه السلسلة المعقدة: <br><br><pre style=";text-align:right;direction:rtl"> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">setting</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"MCXSettings"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">serializeAs</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"String"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">value</span></span></span><span class="hljs-tag">&gt;</span></span>Inactive, ChartLen: 1000, PrintLen: 50, UseProxy: False<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">value</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">setting</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  لا أشعر برغبة في إجراء مثل هذه التحويلات عند العمل مع YAML.  ولكن في الوقت نفسه ، نحن مقيدون بالهيكل "المسطح" الحالي لفئة AppSettings: تتراكم جميع خصائص الإعدادات الموجودة به في كومة واحدة. <br><br>  <b>ثانياً ، إن</b> تكوينات خوادمنا ليست متراصة ثابتة ، فنحن نغيرها من وقت لآخر في سياق الخادم ، أي  هذه التغييرات تحتاج إلى أن تكون قادرة على اللحاق ، في وقت التشغيل.  للقيام بذلك ، في تطبيق XML ، نرث AppSettings الخاصة بنا من INotifyPropertyChanged (في الواقع ، كل واجهة تقوم بتطبيق AppSettings موروثة منه) ونشترك في تحديث أحداث إعدادات الخصائص.  يعمل هذا النهج لأن الفئة الأساسية System.Configuration.ApplicationSettingsBase خارج المربع تنفذ INotifyPropertyChanged.  يجب الحفاظ على سلوك مماثل بعد الانتقال إلى YAML. <br><br>  <b>ثالثًا ،</b> ليس لدينا في الواقع ملف تهيئة واحد لكل خادم ، ولكن يوجد ملفان به: واحد مع الإعدادات الافتراضية ، والآخر بإعدادات تجاوز.  هذا مطلوب حتى لا يكون عليك نسخ مجموعة الإعدادات بالكامل بالكامل في كل حالة من الحالات المتعددة للخوادم من نفس النوع ، والاستماع إلى منافذ مختلفة ولديها إعدادات مختلفة قليلاً. <br><br>  <b>ومشكلة أخرى</b> - الوصول إلى الإعدادات لا يمر عبر واجهات فقط ، ولكن أيضًا عن طريق الوصول المباشر إلى AppSettings.Default.  اسمحوا لي أن أذكركم كيف تم الإعلان عنها في AppSettings.Designer.cs خلف الكواليس: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> AppSettings defaultInstance = ((AppSettings)(<span class="hljs-keyword"><span class="hljs-keyword">global</span></span>::System.Configuration.ApplicationSettingsBase.Synchronized(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AppSettings()))); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> AppSettings Default { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> defaultInstance; } }</code> </pre><br>  بالنظر إلى ما سبق ، كان من الضروري التوصل إلى مقاربة جديدة لتخزين الإعدادات في AppSettings. <br><br><h2 style=";text-align:right;direction:rtl">  الحل </h2><br><h3 style=";text-align:right;direction:rtl">  مجموعة الأدوات </h3><br>  للقراءة المباشرة ، قررت YAML استخدام المكتبات الجاهزة المتوفرة من خلال NuGet: <br><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  YamlDotNet - github.com/aaubry/YamlDotNet.  من وصف المكتبة (ترجمة): <br><blockquote style=";text-align:right;direction:rtl">  YamlDotNet هي مكتبة .NET لـ YAML.  يوفر YamlDotNet محلل منخفض المستوى ومنشئ YAML ، بالإضافة إلى طراز كائن رفيع المستوى يشبه XmlDocument.  يتضمن أيضًا مكتبة التسلسل التي تتيح لك قراءة وكتابة الكائنات من / إلى تدفقات YAML. </blockquote><br></li><li style=";text-align:right;direction:rtl">  NetEscapades.Configuration - github.com/andrewlock/NetEscapades.Configuration.  هذا هو موفر التهيئة نفسه (بمعنى Microsoft.Extensions.Configuration.IConfigurationSource ، والذي يستخدم بنشاط في تطبيقات ASP.NET Core) ، الذي يقرأ ملفات YAML باستخدام فقط المذكورة أعلاه YamlDotNet. <br></li></ul><br>  اقرأ المزيد حول كيفية استخدام هذه المكتبات <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">هنا</a> . <br><br><h3 style=";text-align:right;direction:rtl">  الانتقال إلى YAML </h3><br>  لقد قمنا بالانتقال على مرحلتين: في البداية ، قمنا ببساطة بالتبديل من XML إلى YAML ، مع الاحتفاظ بتسلسل هرمي مسطح لملفات التكوين ، ثم قدمنا ​​أقسامًا في ملفات YAML.  يمكن دمج هذه المراحل ، من حيث المبدأ ، في مرحلة واحدة ، وبساطة العرض سأقوم بذلك.  تم تطبيق جميع الإجراءات الموضحة أدناه بالتتابع على كل خدمة. <br><br><h3 style=";text-align:right;direction:rtl">  تحضير ملف YML </h3><br>  تحتاج أولاً إلى إعداد ملف YAML نفسه.  نسميها اسم المشروع (مفيد لاختبارات التكامل في المستقبل ، والتي يجب أن تكون قادرة على العمل مع خوادم مختلفة وتمييز التكوينات الخاصة بهم فيما بينها) ، ضع الملف مباشرة في جذر المشروع ، بجانب AppSettings: <br><br><img src="https://habrastorage.org/webt/es/2h/jo/es2hjofltziwk8fbqj3f5faxte0.png"><br><br>  في ملف YML ، بالنسبة للمبتدئين ، دعنا نحفظ بنية "مسطحة": <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">VirtualFeed: "MaxChartHistoryLength: 10, UseThrottling: True, ThrottlingIntervalMs: 50000, UseHistoryBroadcast: True, CalendarName: EmptyCalendar" VirtualFeedPort: 35016 UsMarketFeedUseImbalances: True</code> </pre><br><h3 style=";text-align:right;direction:rtl">  ملء AppSettings مع خصائص الإعدادات </h3><br>  ننقل جميع الخصائص من AppSettings.Designer.cs إلى AppSettings.cs ، ونتخلص في وقت واحد من السمات الزائدة عن المصمم والرمز نفسه في get / set-parts. <br><br>  كان: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">global::System.Configuration.UserScopedSettingAttribute()</span></span>] [<span class="hljs-keyword"><span class="hljs-keyword">global</span></span>::System.Diagnostics.DebuggerNonUserCodeAttribute()] [<span class="hljs-keyword"><span class="hljs-keyword">global</span></span>::System.Configuration.DefaultSettingValueAttribute(<span class="hljs-string"><span class="hljs-string">"35016"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> VirtualFeedPort{ <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>[<span class="hljs-string"><span class="hljs-string">"VirtualFeedPort"</span></span>])); } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>[<span class="hljs-string"><span class="hljs-string">"VirtualFeedPort"</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } }</code> </pre><br>  أصبح: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> VirtualFeedPort { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; }</code> </pre><br>  سنقوم بإزالة AppSettings <b>.Designer</b> .cs بشكل غير ضروري.  الآن ، بالمناسبة ، يمكنك التخلص تمامًا من قسم إعدادات المستخدم في ملف app.config ، إذا كان في المشروع ، فإنه يخزن نفس الإعدادات الافتراضية التي نحددها من خلال مصمم الإعدادات. <br>  المضي قدما. <br><br><h3 style=";text-align:right;direction:rtl">  إعدادات التحكم على الطاير </h3><br>  نظرًا لأننا نحتاج إلى الاطلاع على تحديثات إعداداتنا في وقت التشغيل ، فإننا نحتاج إلى تطبيق INotifyPropertyChanged في AppSettings لدينا.  قاعدة System.Configuration.ApplicationSettingsBase لم تعد موجودة ، على التوالي ، لا يمكنك الاعتماد على أي سحر. <br><br>  يمكنك تنفيذه "على الجبهة": عن طريق إضافة تطبيق لطريقة ترمي الحدث المرغوب وتدعوه في واضعة كل خاصية.  ولكن هذه هي سطور إضافية من التعليمات البرمجية ، والتي ستحتاج بالإضافة إلى نسخها في جميع الخدمات. <br><br>  دعونا نفعل ذلك بشكل أفضل - تقديم AutoNotifier أساسي من الدرجة الأساسية ، وهو ما يفعل الشيء نفسه بالفعل ، ولكن خلف الكواليس ، تمامًا مثل System.Configuration.ApplicationSettingsBase ، قام بما يلي: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Implements </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;see cref="INotifyPropertyChanged"/&gt;</span></span></span><span class="hljs-comment"> for classes with a lot of public properties (ie AppSettings). </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> This implementation is: </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> - fairly slow, so don't use it for classes where getting/setting of properties is often operation; </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> - not for properties described in inherited classes of 2nd level (bad idea: Inherit2 -&gt; Inherit1 -&gt; AutoNotifier; good idea: sealed Inherit -&gt; AutoNotifier) </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public abstract class AutoNotifier : INotifyPropertyChanged { public event PropertyChangedEventHandler PropertyChanged; private readonly ConcurrentDictionary</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;string, object&gt;</span></span></span><span class="hljs-comment"> _wrappedValues = new ConcurrentDictionary</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;string, object&gt;</span></span></span><span class="hljs-comment">(); //just to avoid manual writing a lot of fields protected T Get</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;T&gt;</span></span></span><span class="hljs-comment">([CallerMemberName] string propertyName = null) { return (T)_wrappedValues.GetValueOrDefault(propertyName, () =&gt; default(T)); } protected void Set</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;T&gt;</span></span></span><span class="hljs-comment">(T value, [CallerMemberName] string propertyName = null) { // ReSharper disable once AssignNullToNotNullAttribute _wrappedValues.AddOrUpdate(propertyName, value, (s, o) =&gt; value); OnPropertyChanged(propertyName); } public object this[string propertyName] { get { return Get</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;object&gt;</span></span></span><span class="hljs-comment">(propertyName); } set { Set(value, propertyName); } } protected void OnPropertyChanged([CallerMemberName] string propertyName = null) { PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(propertyName)); } }</span></span></code> </pre><br>  هنا تسمح لك السمة [CallerMemberName] بالحصول تلقائيًا على اسم خاصية كائن الاتصال ، أي  AppSettings <br><br>  الآن يمكننا أن نرث AppSettings لدينا من هذا AutoNotifier الأساسي ، ثم يتم تعديل كل خاصية قليلاً: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> VirtualFeedPort { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Get&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(); } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { Set(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); } }</code> </pre><br>  من خلال هذا النهج ، تبدو فئات AppSettings الخاصة بنا ، حتى التي تحتوي على الكثير من الإعدادات ، مضغوطة ، وفي الوقت نفسه تنفذ INotifyPropertyChanged بالكامل. <br><br>  نعم ، أعلم أنه سيكون من الممكن تقديم المزيد من السحر ، باستخدام ، على سبيل المثال ، Castle.DynamicProxy.IInterceptor ، اعتراض التغييرات في الخصائص الضرورية وإثارة الأحداث هناك.  لكن هذا القرار بدا لي مثقلاً للغاية. <br><br><h3 style=";text-align:right;direction:rtl">  قراءة الإعدادات من ملف YAML </h3><br>  الخطوة التالية هي إضافة قارئ لتكوين YAML نفسه.  يحدث هذا في مكان ما أقرب إلى بداية الخدمة.  بإخفاء التفاصيل غير الضرورية التي لا تتعلق بالموضوع قيد المناقشة ، نحصل على شيء مماثل: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> IServerConfigurationProvider </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LoadServerConfiguration</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IReadOnlyDictionary&lt;Type, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; allSections</span></span></span><span class="hljs-function">)</span></span> { IConfigurationBuilder builder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConfigurationBuilder().SetBasePath(ConfigFiles.BasePath); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> configFile <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> configFiles) { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> directory = Path.GetDirectoryName(configFile); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrEmpty(directory)) <span class="hljs-comment"><span class="hljs-comment">//can be empty if relative path is used { Directory.CreateDirectory(directory); } builder = builder.AddYamlFile(configFile, optional: true, reloadOnChange: true); } IConfigurationRoot config = builder.Build(); // load prepared files and merge them return new ServerConfigurationProvider&lt;TAppSettings&gt;(config, allSections); }</span></span></code> </pre><br>  في التعليمة البرمجية المقدمة ، ربما لا يكون ConfigurationBuilder ذا أهمية خاصة - كل العمل معها يشبه العمل مع التكوينات في ASP.NET Core.  لكن النقاط التالية تهمك.  أولاً ، "خارج الصندوق" ، سنحت لنا أيضًا فرصة لدمج الإعدادات من عدة ملفات.  يوفر هذا شرط وجود ملفين للتكوين على الأقل لكل خادم ، كما ذكرت أعلاه.  ثانياً ، نقوم بتمرير كل تكوين القراءة إلى ServerConfigurationProvider معين.  لماذا؟ <br><br><h3 style=";text-align:right;direction:rtl">  المقاطع في ملف YAML </h3><br>  سنقوم بالرد على هذا السؤال لاحقًا ، ونعود الآن إلى متطلبات تخزين الإعدادات المهيكلة في ملف YML. <br><br>  من حيث المبدأ ، تنفيذ هذا بسيط للغاية.  أولاً ، في ملف YML ، نقدم البنية التي نحتاجها: <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">VirtualFeed: MaxChartHistoryLength: 10 Port: 35016 UseThrottling: True ThrottlingIntervalMs: 50000 UseHistoryBroadcast: True CalendarName: "EmptyCalendar" UsMarketFeed: UseImbalances: True</code> </pre><br>  الآن دعنا نذهب إلى AppSettings ونعلمه كيفية تقسيم فنادقنا إلى أقسام.  شيء مثل هذا: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">AppSettings</span></span> : <span class="hljs-title"><span class="hljs-title">AutoNotifier</span></span>, <span class="hljs-title"><span class="hljs-title">IWebSettingsStorage</span></span>, <span class="hljs-title"><span class="hljs-title">IServerSettingsStorage</span></span>, <span class="hljs-title"><span class="hljs-title">IServerManagerAddressStorage</span></span>, <span class="hljs-title"><span class="hljs-title">IGlobalCredentialsStorage</span></span>, <span class="hljs-title"><span class="hljs-title">IGraphiteAddressStorage</span></span>, <span class="hljs-title"><span class="hljs-title">IDatabaseConfigStorage</span></span>, <span class="hljs-title"><span class="hljs-title">IBlackListStorage</span></span>, <span class="hljs-title"><span class="hljs-title">IKeyCloackConfigFilePathProvider</span></span>, <span class="hljs-title"><span class="hljs-title">IPrometheusSettingsStorage</span></span>, <span class="hljs-title"><span class="hljs-title">IHeartBeatConfig</span></span>, <span class="hljs-title"><span class="hljs-title">IConcurrentAcceptorProperties</span></span>, <span class="hljs-title"><span class="hljs-title">IMetricsConfig</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> IReadOnlyDictionary&lt;Type, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; Sections { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;Type, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; { {<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(IDatabaseConfigStorage), <span class="hljs-string"><span class="hljs-string">"Database"</span></span>}, {<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(IWebSettingsStorage), <span class="hljs-string"><span class="hljs-string">"Web"</span></span>}, {<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(IServerSettingsStorage), <span class="hljs-string"><span class="hljs-string">"Server"</span></span>}, {<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(IConcurrentAcceptorProperties), <span class="hljs-string"><span class="hljs-string">"ConcurrentAcceptor"</span></span>}, {<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(IGraphiteAddressStorage), <span class="hljs-string"><span class="hljs-string">"Graphite"</span></span>}, {<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(IKeyCloackConfigFilePathProvider), <span class="hljs-string"><span class="hljs-string">"Keycloak"</span></span>}, {<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(IPrometheusSettingsStorage), <span class="hljs-string"><span class="hljs-string">"Prometheus"</span></span>}, {<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(IHeartBeatConfig), <span class="hljs-string"><span class="hljs-string">"Heartbeat"</span></span>}, {<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(IServerManagerAddressStorage), <span class="hljs-string"><span class="hljs-string">"ServerManager"</span></span>}, {<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(IGlobalCredentialsStorage), <span class="hljs-string"><span class="hljs-string">"GlobalCredentials"</span></span>}, {<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(IBlackListStorage), <span class="hljs-string"><span class="hljs-string">"Blacklist"</span></span>}, {<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(IMetricsConfig), <span class="hljs-string"><span class="hljs-string">"Metrics"</span></span>} }; ...</code> </pre><br>  كما ترى ، أضفنا قاموسًا مباشرةً إلى AppSettings ، حيث تمثل المفاتيح أنواع الواجهات التي تنفذها فئة AppSettings ، والقيم هي رؤوس الأقسام المقابلة.  الآن يمكننا مقارنة التسلسل الهرمي في ملف YML مع التسلسل الهرمي للخصائص في AppSettings (على الرغم من أنه ليس أعمق من مستوى واحد من التداخل ، ولكن في حالتنا كان هذا كافياً). <br><br>  لماذا نفعل هذا هنا - في AppSettings؟  لأننا بهذه الطريقة لا ننشر المعلومات حول الإعدادات للكيانات المختلفة ، وبالإضافة إلى ذلك ، هذا هو المكان الأكثر طبيعية ، لأن  في كل خدمة ، ووفقًا لذلك ، في كل AppSettings ، قسم الإعدادات الخاص به. <br><br><h3 style=";text-align:right;direction:rtl">  إذا كنت لا تحتاج إلى تسلسل هرمي في الإعدادات؟ </h3><br>  من حيث المبدأ ، إنها حالة غريبة ، لكن كان لدينا في المرحلة الأولى بالضبط ، عندما انتقلنا ببساطة من XML إلى YAML ، دون استخدام مزايا YAML. <br><br>  في هذه الحالة ، لا يمكن تخزين قائمة الأقسام بأكملها ، وسيكون ServerConfigurationProvider أبسط بكثير (تمت مناقشته لاحقًا). <br><br>  ولكن النقطة المهمة هي أنه إذا قررنا ترك تسلسل هرمي مسطح ، فيمكننا تلبية متطلبات الحفاظ على القدرة على الوصول إلى الإعدادات من خلال AppSettings.Default.  للقيام بذلك ، أضف هنا مُنشئًا عامًا بسيطًا في AppSettings: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> AppSettings Default { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AppSettings</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Default = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; }</code> </pre><br>  الآن يمكننا متابعة الوصول إلى فئة الإعدادات في كل مكان من خلال AppSettings.Default (شريطة أن تكون الإعدادات قد تمت قراءتها بالفعل من خلال IConfigurationRoot في ServerConfigurationProvider وبالتالي ، تم إنشاء مثيل لـ AppSettings). <br><br>  إذا كان التسلسل الهرمي المسطح غير مقبول ، إذن ، على أي حال ، يجب عليك التخلص من AppSettings.Default في كل مكان عن طريق الرمز والعمل مع الإعدادات فقط من خلال واجهات (وهو أمر جيد من حيث المبدأ).  لماذا ذلك - سوف تصبح أكثر وضوحا. <br><br><h3 style=";text-align:right;direction:rtl">  ServerConfigurationProvider </h3><br>  تتعامل فئة ServerConfigurationProvider الخاصة المذكورة سابقًا مع السحر الذي يتيح لك العمل بشكل كامل مع تكوين YAML الهرمي الجديد مع AppSettings مسطح فقط. <br><br>  إذا كنت لا تستطيع الانتظار ، فهذه هي. <br><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ServerConfigurationProvider رمز الكامل</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Provides different configurations for current server </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public class ServerConfigurationProvider</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TAppSettings&gt;</span></span></span><span class="hljs-comment"> : IServerConfigurationProvider where TAppSettings : new() { private static readonly Logger Logger = LogManager.GetCurrentClassLogger(); private readonly IConfigurationRoot _configuration; private readonly IReadOnlyDictionary</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;Type, string&gt;</span></span></span><span class="hljs-comment"> _sectionsByInterface; private readonly IReadOnlyDictionary</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;string, Type&gt;</span></span></span><span class="hljs-comment"> _interfacesBySections; </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Section name -&gt; config </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> private readonly ConcurrentDictionary</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;string, TAppSettings&gt;</span></span></span><span class="hljs-comment"> _cachedSections; public ServerConfigurationProvider(IConfigurationRoot configuration, IReadOnlyDictionary</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;Type, string&gt;</span></span></span><span class="hljs-comment"> allSections) { _configuration = configuration; _cachedSections = new ConcurrentDictionary</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;string, TAppSettings&gt;</span></span></span><span class="hljs-comment">(); _sectionsByInterface = allSections; var interfacesBySections = new Dictionary</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;string, Type&gt;</span></span></span><span class="hljs-comment">(); foreach (KeyValuePair</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;Type, string&gt;</span></span></span><span class="hljs-comment"> interfaceAndSection in _sectionsByInterface) { //section names must be unique interfacesBySections.Add(interfaceAndSection.Value, interfaceAndSection.Key); } _interfacesBySections = interfacesBySections; _configuration.GetReloadToken()?.RegisterChangeCallback(OnConfigurationFileChanged, null); } private void OnConfigurationFileChanged(object _) { UpdateCache(); } private void UpdateCache() { foreach (string sectionName in _cachedSections.Keys) { Type sectionInterface = _interfacesBySections[sectionName]; TAppSettings newSection = ReadSection(sectionName, sectionInterface); TAppSettings oldSection; if (_cachedSections.TryGetValue(sectionName, out oldSection)) { UpdateSection(oldSection, newSection); } } } private void UpdateSection(TAppSettings oldConfig, TAppSettings newConfig) { foreach (PropertyInfo propertyInfo in typeof(TAppSettings).GetProperties().Where(p =&gt; p.GetMethod != null &amp;&amp; p.SetMethod != null)) { propertyInfo.SetValue(newConfig, propertyInfo.GetValue(oldConfig)); } } public IEnumerable</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;Type&gt;</span></span></span><span class="hljs-comment"> AllSections =&gt; _sectionsByInterface.Keys; public TSettingsSectionInterface FindSection</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TSettingsSectionInterface&gt;</span></span></span><span class="hljs-comment">() where TSettingsSectionInterface : class { return (TSettingsSectionInterface)FindSection(typeof(TSettingsSectionInterface)); } [CanBeNull] public object FindSection(Type sectionInterface) { string sectionName = FindSectionName(sectionInterface); if (sectionName == null) { return null; } //we must return same instance of settings for same requested section (otherwise changing of settings will lead to inconsistent state) return _cachedSections.GetOrAdd(sectionName, typeName =&gt; ReadSection(sectionName, sectionInterface)); } private string FindSectionName(Type sectionInterface) { string sectionName; if (!_sectionsByInterface.TryGetValue(sectionInterface, out sectionName)) { Logger.Debug("This server doesn't contain settings for {0}", sectionInterface.FullName); return null; } return sectionName; } private TAppSettings ReadSection(string sectionName, Type sectionInterface) { TAppSettings parsed; try { IConfigurationSection section = _configuration.GetSection(sectionName); CheckSection(section, sectionName, sectionInterface); parsed = section.Get</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TAppSettings&gt;</span></span></span><span class="hljs-comment">(); if (parsed == null) { //means that this section is empty or all its properties are empty return new TAppSettings(); } ReadArrays(parsed, section); } catch (Exception ex) { Logger.Fatal(ex, "Something wrong during reading section {0} in config", sectionName.SafeSurround()); throw; } return parsed; } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Manual reading of array properties in config </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> private void ReadArrays(TAppSettings settings, IConfigurationSection section) { foreach (PropertyInfo propertyInfo in GetPublicProperties(typeof(TAppSettings), needSetters: true).Where(p =&gt; typeof(IEnumerable</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;string&gt;</span></span></span><span class="hljs-comment">).IsAssignableFrom(p.PropertyType))) { ClearDefaultArrayIfOverridenExists(section.Key, propertyInfo.Name); IConfigurationSection enumerableProperty = section.GetSection(propertyInfo.Name); propertyInfo.SetValue(settings, enumerableProperty.Get</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;IEnumerable&lt;string&gt;</span></span></span><span class="hljs-comment">&gt;()); } } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Clears array property from default config to use overriden one. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Standard implementation merges default and overriden array by indexes - this is not what we need </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> private void ClearDefaultArrayIfOverridenExists(string sectionName, string propertyName) { List</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;IConfigurationProvider&gt;</span></span></span><span class="hljs-comment"> providers = _configuration.Providers.ToList(); if (providers.Count == 0) { return; } string propertyTemplate = $"{sectionName}:{propertyName}:"; if (!providers[providers.Count - 1].TryGet($"{propertyTemplate}{0}", out _)) { //we should use array from default config, because overriden config has no overriden array return; } foreach (IConfigurationProvider provider in providers.Take(providers.Count - 1)) { for (int i = 0; ; i++) { string propertyInnerName = $"{propertyTemplate}{i}"; if (!provider.TryGet(propertyInnerName, out _)) { break; } provider.Set(propertyInnerName, null); } } } private void CheckSection(IConfigurationSection section, string sectionName, Type sectionInterface) { ICollection</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;PropertyInfo&gt;</span></span></span><span class="hljs-comment"> properties = GetPublicProperties(sectionInterface, needSetters: false); var configProperties = new HashSet</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;string&gt;</span></span></span><span class="hljs-comment">(section.GetChildren().Select(c =&gt; c.Key)); foreach (PropertyInfo propertyInfo in properties) { if (!configProperties.Remove(propertyInfo.Name)) { if (propertyInfo.PropertyType != typeof(string) &amp;&amp; typeof(IEnumerable).IsAssignableFrom(propertyInfo.PropertyType)) { //no way to distinguish absent array and empty array :( Logger.Debug("Property {0} has no valuable items in configs section {1}", propertyInfo.Name, sectionName.SafeSurround()); } else { Logger.Fatal("Property {0} not found in configs section {1}", propertyInfo.Name, sectionName.SafeSurround()); } } } if (configProperties.Any()) { Logger.Fatal("Unexpected config properties {0} in configs section {1}", configProperties.SafeSurroundAndJoin(), sectionName.SafeSurround()); } } private static ICollection</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;PropertyInfo&gt;</span></span></span><span class="hljs-comment"> GetPublicProperties(Type type, bool needSetters) { if (!type.IsInterface) { return type.GetProperties().Where(x =&gt; x.GetMethod != null &amp;&amp; (!needSetters || x.SetMethod != null)).ToArray(); } var propertyInfos = new List</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;PropertyInfo&gt;</span></span></span><span class="hljs-comment">(); var considered = new List</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;Type&gt;</span></span></span><span class="hljs-comment">(); var queue = new Queue</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;Type&gt;</span></span></span><span class="hljs-comment">(); considered.Add(type); queue.Enqueue(type); while (queue.Count &gt; 0) { Type subType = queue.Dequeue(); foreach (Type subInterface in subType.GetInterfaces()) { if (considered.Contains(subInterface)) { continue; } considered.Add(subInterface); queue.Enqueue(subInterface); } PropertyInfo[] typeProperties = subType.GetProperties(BindingFlags.FlattenHierarchy | BindingFlags.Public | BindingFlags.Instance); IEnumerable</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;PropertyInfo&gt;</span></span></span><span class="hljs-comment"> newPropertyInfos = typeProperties.Where(x =&gt; x.GetMethod != null &amp;&amp; (!needSetters || x.SetMethod != null) &amp;&amp; !propertyInfos.Contains(x)); propertyInfos.InsertRange(0, newPropertyInfos); } return propertyInfos; } }</span></span></code> </pre><br></div></div><br>  تتم المعلمة ServerConfigurationProvider بواسطة فئة إعدادات AppSettings: <br><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ServerConfigurationProvider</span></span>&lt;<span class="hljs-title"><span class="hljs-title">TAppSettings</span></span>&gt; : <span class="hljs-title"><span class="hljs-title">IServerConfigurationProvider</span></span> <span class="hljs-title"><span class="hljs-title">where</span></span> <span class="hljs-title"><span class="hljs-title">TAppSettings</span></span> : <span class="hljs-title"><span class="hljs-title">new</span></span>()</code> </pre><br>  هذا ، كما تعتقد ، يتيح لك استخدامه على الفور في جميع الخدمات. <br><br>  يتم تمرير تكوين القراءة نفسه (IConfigurationRoot) ، وكذلك قاموس القسم المذكور أعلاه (AppSettings.Sections) إلى المُنشئ.  هناك اشتراك في تحديثات الملفات (هل نريد سحب هذه التغييرات إلينا على الفور في حالة حدوث تغيير في ملف YML؟): <br><br><pre style=";text-align:right;direction:rtl"> <code class="cs hljs">_configuration.GetReloadToken()?.RegisterChangeCallback(OnConfigurationFileChanged, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnConfigurationFileChanged</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> sectionName <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> _cachedSections.Keys) { Type sectionInterface = _interfacesBySections[sectionName]; TAppSettings newSection = ReadSection(sectionName, sectionInterface); TAppSettings oldSection; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_cachedSections.TryGetValue(sectionName, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> oldSection)) { UpdateSection(oldSection, newSection); } } }</code> </pre><br>  كما ترون ، هنا ، في حالة تحديث ملف YML ، نذهب إلى جميع الأقسام التي نعرفها ونقرأ كل منها.  بعد ذلك ، إذا كان قد تم بالفعل قراءة القسم مسبقًا في ذاكرة التخزين المؤقت (أي أنه تم طلبه بالفعل في مكان ما في الكود بواسطة بعض الفئات) ، فإننا نعيد كتابة القيم القديمة في ذاكرة التخزين المؤقت بقيم جديدة. <br><br>  يبدو - لماذا تقرأ كل قسم ، لماذا لا تقرأ فقط تلك الموجودة في ذاكرة التخزين المؤقت (على سبيل المثال)؟  لأنه في قراءة القسم قمنا بتنفيذ التحقق من التكوين الصحيح.  وفي حالة الإعدادات غير الصحيحة ، يتم طرح التنبيهات المقابلة ، وتسجيل المشاكل.  من الأفضل معرفة مشاكل تغييرات التكوين في أسرع وقت ممكن ، والتي نقرأ منها جميع الأقسام على الفور. <br><br>  تحديث القيم القديمة في ذاكرة التخزين المؤقت بقيم جديدة أمر تافه بما فيه الكفاية: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdateSection</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">TAppSettings oldConfig, TAppSettings newConfig</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-function"><span class="hljs-function">PropertyInfo propertyInfo </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">in</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">typeof</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">TAppSettings</span></span></span><span class="hljs-function">).</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetProperties</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>).</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Where</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">p =&gt; p.GetMethod != </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">null</span></span></span></span><span class="hljs-function"><span class="hljs-params"> &amp;&amp; p.SetMethod != </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">null</span></span></span></span></span><span class="hljs-function">))</span></span> { propertyInfo.SetValue(newConfig, propertyInfo.GetValue(oldConfig)); } }</code> </pre><br>  لكن أقسام القراءة ليست بهذه البساطة: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> TAppSettings </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReadSection</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sectionName, Type sectionInterface</span></span></span><span class="hljs-function">)</span></span> { TAppSettings parsed; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { IConfigurationSection section = _configuration.GetSection(sectionName); CheckSection(section, sectionName, sectionInterface); parsed = section.Get&lt;TAppSettings&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parsed == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-comment"><span class="hljs-comment">//means that this section is empty or all its properties are empty return new TAppSettings(); } ReadArrays(parsed, section); } catch (Exception ex) { Logger.Fatal(ex, "Something wrong during reading section {0} in config", sectionName.SafeSurround()); throw; } return parsed; }</span></span></code> </pre><br>  هنا أولاً وقبل كل شيء نقرأ القسم نفسه باستخدام IConfigurationRoot.GetSection القياسي.   -    . <br><br>        : section.Get     YAML- —      ( , .. )  ,     . <br><br>   : <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">VirtualFeed: Names: []</code> </pre><br>    VirtualFeed   Names    ,  YAML-,  , ,   VirtualFeed   .  إنه لأمر محزن. <br><br>             IEnumerable-  .     « »    . <br><br><pre style=";text-align:right;direction:rtl"> <code class="cs hljs">ReadArrays(parsed, section); ... <span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Manual reading of array properties in config </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> private void ReadArrays(TAppSettings settings, IConfigurationSection section) { foreach (PropertyInfo propertyInfo in GetPublicProperties(typeof(TAppSettings), needSetters: true).Where(p =&gt; typeof(IEnumerable</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;string&gt;</span></span></span><span class="hljs-comment">).IsAssignableFrom(p.PropertyType))) { ClearDefaultArrayIfOverridenExists(section.Key, propertyInfo.Name); IConfigurationSection enumerableProperty = section.GetSection(propertyInfo.Name); propertyInfo.SetValue(settings, enumerableProperty.Get</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;IEnumerable&lt;string&gt;</span></span></span><span class="hljs-comment">&gt;()); } } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Clears array property from default config to use overriden one. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Standard implementation merges default and overriden array by indexes - this is not what we need </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> private void ClearDefaultArrayIfOverridenExists(string sectionName, string propertyName) { List</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;IConfigurationProvider&gt;</span></span></span><span class="hljs-comment"> providers = _configuration.Providers.ToList(); if (providers.Count == 0) { return; } string propertyTemplate = $"{sectionName}:{propertyName}:"; if (!providers[providers.Count - 1].TryGet($"{propertyTemplate}{0}", out _)) { //we should use array from default config, because overriden config has no overriden array return; } foreach (IConfigurationProvider provider in providers.Take(providers.Count - 1)) { for (int i = 0; ; i++) { string propertyInnerName = $"{propertyTemplate}{i}"; if (!provider.TryGet(propertyInnerName, out _)) { break; } provider.Set(propertyInnerName, null); } } }</span></span></code> </pre><br>  ,    ,     IEnumerable        «»,       .      :           -?   —     ,  ,    -, .    ,    (     )         IConfigurationSection,       .  -     . <br><br>   ReadSection        : FindSection. <br><br><pre style=";text-align:right;direction:rtl"> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">CanBeNull</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FindSection</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Type sectionInterface</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> sectionName = FindSectionName(sectionInterface); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sectionName == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-comment"><span class="hljs-comment">//we must return same instance of settings for same requested section (otherwise changing of settings will lead to inconsistent state) return _cachedSections.GetOrAdd(sectionName, typeName =&gt; ReadSection(sectionName, sectionInterface)); }</span></span></code> </pre><br>  ,    ,          AppSettings.Default:     ( )    FindSection          AppSettings,      , , ,     AppSettings.Default,                ,       (     — NULL  0). <br><br>        : <br><br><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CheckSection</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IConfigurationSection section, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sectionName, Type sectionInterface</span></span></span><span class="hljs-function">)</span></span> { ICollection&lt;PropertyInfo&gt; properties = GetPublicProperties(sectionInterface, needSetters: <span class="hljs-literal"><span class="hljs-literal">false</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> configProperties = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashSet&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(section.GetChildren().Select(c =&gt; c.Key)); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (PropertyInfo propertyInfo <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> properties) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!configProperties.Remove(propertyInfo.Name)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (propertyInfo.PropertyType != <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>) &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(IEnumerable).IsAssignableFrom(propertyInfo.PropertyType)) { <span class="hljs-comment"><span class="hljs-comment">//no way to distinguish absent array and empty array :( Logger.Debug("Property {0} has no valuable items in configs section {1}", propertyInfo.Name, sectionName.SafeSurround()); } else { Logger.Fatal("Property {0} not found in configs section {1}", propertyInfo.Name, sectionName.SafeSurround()); } } } if (configProperties.Any()) { Logger.Fatal("Unexpected config properties {0} in configs section {1}", configProperties.SafeSurroundAndJoin(), sectionName.SafeSurround()); } }</span></span></code> </pre><br>           ( —  ).           :    ,    ,   ,       - .    ,   -      .   ,     , ..  ,      ,    ,        . <br><br>   —     ,              «--»?   ,    ,   ,       ,    —    ,    ,    . ,          ,  .    ,  ,         . <br><br>          GetPublicProperties, ,  ,       .     ,    ,   ,     ,   ,    , , ,        ,     . <br><br><h3 style=";text-align:right;direction:rtl">    </h3><br>                 : <br><br><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Provides different configurations for current server </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public interface IServerConfigurationProvider { TSettingsSectionInterface FindSection</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TSettingsSectionInterface&gt;</span></span></span><span class="hljs-comment">() where TSettingsSectionInterface : class; object FindSection(Type sectionInterface); IEnumerable</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;Type&gt;</span></span></span><span class="hljs-comment"> AllSections { get; } }</span></span></code> </pre><br>     — FindSection —      .  شيء مثل هذا: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cs hljs">IThreadPoolProperties threadPoolProperties = ConfigurationProvider.FindSection&lt;IThreadPoolProperties&gt;();</code> </pre><br>       —  . <br><br><h3 style=";text-align:right;direction:rtl">    </h3><br>       IoC-  Castle Windsor.          . ,      . <br><br>      Extension-,    ,          : <br><br><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ServerConfigurationProviderExtensions</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RegisterAllConfigurationSections</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params"> IWindsorContainer container, IServerConfigurationProvider configurationProvider</span></span></span><span class="hljs-function">)</span></span> { Register(container, configurationProvider, configurationProvider.AllSections.ToArray()); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Register</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params"> IWindsorContainer container, IServerConfigurationProvider configurationProvider, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">params</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Type[] configSections</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> registrations = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IRegistration[configSections.Length]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; registrations.Length; i++) { Type configSection = configSections[i]; <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> section = configurationProvider.FindSection(configSection); registrations[i] = Component.For(configSection).Instance(section).Named(configSection.FullName); } container.Register(registrations); } }</code> </pre><br>        (     AllSections   IServerConfigurationProvider). <br><br>      ,           ServerConfigurationProvider,        ServerConfigurationProvider    Windsor. <br>     , ,  FindSection  IServerConfigurationProvider. <br><br>        Windsor  Extension-: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cs hljs">container.RegisterAllConfigurationSections(configProvider);</code> </pre><br><h2 style=";text-align:right;direction:rtl">  الخاتمة </h2><br><h3 style=";text-align:right;direction:rtl">   </h3><br>            XML  YAML,         . <br><br> YAML-,    XML,         ,      . <br><br>        YAML,    .   ,          ,    . ,     . <br><br>        -   « ».  ,          YAML- (        -). <br><br>        —    ,        « ». <br><br><h3 style=";text-align:right;direction:rtl">     </h3><br>        ,   -  ,  -, ..       ,  -     -  . <br><br>           AppSettings.Default,    ,  . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar438362/">https://habr.com/ru/post/ar438362/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar438350/index.html">الدليل الكامل للبحث المهني عن الكاميرات الخفية وأجهزة التجسس</a></li>
<li><a href="../ar438352/index.html">فيديو من نزول روفر "Yutu-2" ، أول متر على سطح القمر. النوم لمدة أسبوعين على القمر قد انتهى</a></li>
<li><a href="../ar438354/index.html">Vue ، Storybook ، TypeScript - بدء مشروع جديد مع مراعاة أفضل الممارسات</a></li>
<li><a href="../ar438356/index.html">SQL Server Data Warehouse (DWFT) شهادة هندسة معمارية معتمدة: ما الذي يعنيه وكيف يعمل</a></li>
<li><a href="../ar438358/index.html">عملاء سابقون في وكالة الأمن القومي يتجسسون على هواتف الضحايا بتكليف من الإمارات العربية المتحدة</a></li>
<li><a href="../ar438364/index.html">تكرار أول جهاز تشويش صوت رقمي في العالم</a></li>
<li><a href="../ar438366/index.html">هناك مراجعة أخرى لأدوات OATH المميزة في Azure Cloud MFA</a></li>
<li><a href="../ar438368/index.html">المصابيح الذكية التي ألقيت في سلة المهملات تشكل مصدرا قيما للمعلومات الشخصية.</a></li>
<li><a href="../ar438370/index.html">جرائم الإنترنت كخدمة: الخدمات والأسعار</a></li>
<li><a href="../ar438372/index.html">تواصل ناسا محاولات الاتصال بفرصة الاتصال</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>