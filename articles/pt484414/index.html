<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü¶ì ü§òüèø ü¶í Escolhendo um arquivador para logs de backup üë®üèª‚Äçüíº üç± ‚≠ïÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√° pessoal! 


 Neste artigo, quero falar sobre como escolhi o arquivador para compactar os logs do nosso sistema de front-office. 


 A divis√£o em q...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Escolhendo um arquivador para logs de backup</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/homecredit/blog/484414/"><p>  Ol√° pessoal! </p><br><p>  Neste artigo, quero falar sobre como escolhi o arquivador para compactar os logs do nosso sistema de front-office. </p><br><p>  A divis√£o em que trabalho est√° envolvida no desenvolvimento e manuten√ß√£o de um sistema unificado de front office do Banco.  Sou respons√°vel por sua manuten√ß√£o, monitoramento e DevOps. </p><br><p>  Nosso sistema √© um aplicativo altamente carregado que atende a mais de 5.000 usu√°rios √∫nicos diariamente.  Hoje √© um "mon√≥lito" com todas as suas vantagens e desvantagens.  Mas agora o processo de transfer√™ncia de funcionalidade para microsservi√ßos est√° em andamento. </p><br><p>  Todos os dias, nosso sistema gera mais de 130 GB de logs brutos e, apesar de usarmos a pilha ENG (Elasticsearch Nxlog Graylog), os logs de arquivos cont√™m muito mais informa√ß√µes (por exemplo, erros de rastreamento de pilha) e, portanto, requerem arquivamento e armazenamento. </p><br><p>  Como o local de armazenamento √© limitado, surge a pergunta: "E qual arquivador melhor lidar√° com esta tarefa". </p><br><p>  Para resolver esse problema, escrevi um script do PowerShell que executava a an√°lise para mim. </p><a name="habracut"></a><br><p>  A tarefa do script √© chamar os arquivadores rar, 7z e zip com diferentes par√¢metros de compacta√ß√£o, para calcular a velocidade da forma√ß√£o do arquivo, bem como o espa√ßo em disco usado. </p><br><div class="spoiler">  <b class="spoiler_title">ArchSearch.ps1</b> <div class="spoiler_text"><pre><code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">#Requires -Version 4.0 #  ,      Clear-Host #   ,     Set-Location $PSScriptRoot #  ,      $Archive = "Archive" $ArchFileName = "ArchFileName" [array]$path = (Get-ChildItem '.\logs').DirectoryName|Select-Object -Unique #      -.  ,     . if ((Test-Path -Path ".\$Archive") -ne $true){ New-Item -Path .\ -Name $Archive -ItemType Directory -Force } else { #    -    Get-ChildItem .\$Archive|Remove-Item -Recurse -Force } #      [array]$table=@() #   Rar #rar # m&lt;0..5&gt; Set compression level (0-store...3-default...5-maximal) 1..5|foreach{ $CompressionLevel = $("-m" + $_) $mc = Measure-Command {cmd /c .\rar.exe a -ep1 -ed $CompressionLevel -o+ -tsc .\$Archive\$($ArchFileName + $_) "$path"} [math]::Round(($mc.TotalMilliseconds), 0) $ArchFileNamePath = ".\$Archive\$($ArchFileName + $_ + ".rar")" $table += ""|Select-Object -Property @{name="ArchFileName"; expression={$ArchFileNamePath -split "\\"|Select-Object -Last 1}},` @{name="CompressionLevel"; expression={$CompressionLevel}},@{name="Extension"; expression={"rar"}},@{name="Size"; expression={(Get-ChildItem $ArchFileNamePath).Length}},` @{name="Time"; expression={[math]::Round(($mc.TotalMilliseconds), 0)}},` @{name="Size %"; expression={0}},@{name="Time %"; expression={0}},@{name="Result %"; expression={0}} } #   7z #7z # -mx[N] : set compression level: -mx1 (fastest) ... -mx9 (ultra) #cmd /c "$env:ProgramFiles\7-Zip\7z.exe" a -mx="$MX" -mmt="$MMT" -t7z -ssw -spf $($ArchFileName + "Fastest") "$path" 1..9|foreach{ $CompressionLevel = $("-mx=" + $_) $mc = Measure-Command {cmd /c "$env:ProgramFiles\7-Zip\7z.exe" a $CompressionLevel -t7z -ssw -spf .\$Archive\$($ArchFileName + $_) $path} #-mmt="$MMT" [math]::Round(($mc.TotalMilliseconds), 0) $ArchFileNamePath = ".\$Archive\$($ArchFileName + $_ + ".7z")" $table += ""|Select-Object -Property @{name="ArchFileName"; expression={$ArchFileNamePath -split "\\"|Select-Object -Last 1}},` @{name="CompressionLevel"; expression={$CompressionLevel}},@{name="Extension"; expression={"7z"}},@{name="Size"; expression={(Get-ChildItem $ArchFileNamePath).Length}},` @{name="Time"; expression={[math]::Round(($mc.TotalMilliseconds), 0)}},` @{name="Size %"; expression={0}},@{name="Time %"; expression={0}},@{name="Result %"; expression={0}} } #   zip (  PS "Compress-Archive") #zip 1..2|foreach{ Switch ($_){ 1{$CompressionLevel = "Fastest"} 2{$CompressionLevel = "Optimal"} } $mc = Measure-Command {Compress-Archive -Path $path -DestinationPath .\$Archive\$($ArchFileName + $_) -CompressionLevel $CompressionLevel -Force} [math]::Round(($mc.TotalMilliseconds), 0) $ArchFileNamePath = ".\$Archive\$($ArchFileName + $_ + ".zip")" $table += ""|Select-Object -Property @{name="ArchFileName"; expression={$ArchFileNamePath -split "\\"|Select-Object -Last 1}},` @{name="CompressionLevel"; expression={$CompressionLevel}},@{name="Extension"; expression={"zip"}},@{name="Size"; expression={(Get-ChildItem $ArchFileNamePath).Length}},` @{name="Time"; expression={[math]::Round(($mc.TotalMilliseconds), 0)}},` @{name="Size %"; expression={0}},@{name="Time %"; expression={0}},@{name="Result %"; expression={0}} } #     Size     [0] -     $Size = ($table|Sort-Object -Property Size)[0].Size / 100 #     Time     [0] -      $Time = ($table|Sort-Object -Property Time)[0].Time / 100 #    $table|foreach { $_.time $_."Size %" = [math]::Round(($_.Size / $Size), 0) $_."Time %" = [math]::Round(($_.Time / $Time), 0) if ($_."Size %" -ge $_."Time %"){ $_."Result %" = $_."Size %" - $_."Time %" } else { $_."Result %" = $_."Time %" - $_."Size %" } } #        "Size %" -     $table|Sort-Object -Property "Size %","Result %"|Select-Object -First 1|Format-Table -AutoSize #        "Result %" -          $table|Sort-Object -Property "Result %","Size %","Time %"|Select-Object -First 1|Format-Table -AutoSize $table|Sort-Object -Property "Size %","Result %"|Select-Object -First 1|Format-Table -AutoSize $table|Sort-Object -Property "Result %","Size %","Time %"|Select-Object -First 1|Format-Table -AutoSize #  !   ,     Get-ChildItem .\$Archive|Remove-Item -Force</span></span></code> </pre> </div></div><br><h1 id="podgotovitelnye-raboty">  Trabalho preparat√≥rio: </h1><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">#   ,   PowerShell  4.0 ($PSVersionTable): #Requires -Version 4.0 #  ,      Clear-Host #   ,     (   .\) Set-Location $PSScriptRoot</span></span></code> </pre> <br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">#  ,      $Archive = "Archive" $ArchFileName = "ArchFileName" [array]$path = (Get-ChildItem '.\logs').DirectoryName|Select-Object -Unique #      -.  ,      if ((Test-Path -Path ".\$Archive") -ne $true){ New-Item -Path .\ -Name $Archive -ItemType Directory -Force } else { #   ,     Get-ChildItem .\$Archive|Remove-Item -Recurse -Force } #      [array]$table=@()</span></span></code> </pre> <br><h1 id="razbiraem-podrobnee">  Analisamos com mais detalhes </h1><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">#     1  5       foreach 1..5|foreach{</span></span></code> </pre> <br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">#    $CompressionLevel   1  5($_),       $CompressionLevel = $("-m" + $_)</span></span></code> </pre> <br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">#  Measure-Command     ,   {} $mc = Measure-Command {cmd /c .\rar.exe a -ep1 -ed $CompressionLevel -o+ -tsc .\$Archive\$($ArchFileName + $_) "$path"}</span></span></code> </pre> <br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">#       [math]::Round(($mc.TotalMilliseconds), 0) #    $ArchFileName + $_ + ".rar": Archive1.rar $ArchFileNamePath = ".\$Archive\$($ArchFileName + $_ + ".rar")" #   $table (+=)   $table += ""|Select-Object -Property @{name="ArchFileName"; expression={$ArchFileNamePath -split "\\"|Select-Object -Last 1}},` @{name="CompressionLevel"; expression={$CompressionLevel}},@{name="Extension"; expression={"rar"}},@{name="Size"; expression={(Get-ChildItem $ArchFileNamePath).Length}},` @{name="SizeAVD"; expression={0}},@{name="Time"; expression={[math]::Round(($mc.TotalMilliseconds), 0)}},` @{name="Size %"; expression={0}},@{name="Time %"; expression={0}},@{name="Result %"; expression={0}} }</span></span></code> </pre> <br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">#     Size     [0] -     $Size = ($table|Sort-Object -Property Size)[0].Size / 100 #     Time     [0] -      $Time = ($table|Sort-Object -Property Time)[0].Time / 100 #    $table|foreach { $_.time $_."Size %" = [math]::Round(($_.Size / $Size), 0) $_."Time %" = [math]::Round(($_.Time / $Time), 0) if ($_."Size %" -ge $_."Time %"){ $_."Result %" = $_."Size %" - $_."Time %" } else { $_."Result %" = $_."Time %" - $_."Size %" } } #        "Size %" -     $table|Sort-Object -Property "Size %","Result %"|Select-Object -First 1|Format-Table -AutoSize #        "Result %" -          $table|Sort-Object -Property "Result %","Size %","Time %"|Select-Object -First 1|Format-Table -AutoSize #  !   ,    . Get-ChildItem .\$Archive|Remove-Item -Force</span></span></code> </pre> <br><pre> <code class="php hljs">$table|Sort-Object -Property <span class="hljs-string"><span class="hljs-string">"Size %"</span></span>,<span class="hljs-string"><span class="hljs-string">"Result %"</span></span>|Format-Table -AutoSize</code> </pre> <br><div class="scrollable-table"><table><thead><tr><th>  Archfilename </th><th>  N√≠vel de compress√£o </th><th>  Extens√£o </th><th>  Tamanho </th><th>  Tempo </th><th>  Tamanho% </th><th>  % De tempo </th><th>  % De resultado </th></tr></thead><tbody><tr><td>  ArchFileName8.7z </td><td>  -mx = 8 </td><td>  7z </td><td>  26511520 </td><td>  62404 </td><td>  100 </td><td>  1674 </td><td>  1574 </td></tr><tr><td>  ArchFileName9.7z </td><td>  -mx = 9 </td><td>  7z </td><td>  26511520 </td><td>  64614 </td><td>  100 </td><td>  1733 </td><td>  1633 </td></tr><tr><td>  ArchFileName7.7z </td><td>  -mx = 7 </td><td>  7z </td><td>  28948176 </td><td>  52832 </td><td>  109 </td><td>  1417 </td><td>  1308 </td></tr><tr><td>  ArchFileName6.7z </td><td>  -mx = 6 </td><td>  7z </td><td>  30051742 </td><td>  37339 </td><td>  113 </td><td>  1002 </td><td>  889 </td></tr><tr><td>  ArchFileName5.7z </td><td>  -mx = 5 </td><td>  7z </td><td>  31239355 </td><td>  35169 </td><td>  118 </td><td>  943 </td><td>  825 </td></tr><tr><td>  ArchFileName4.rar </td><td>  -m4 </td><td>  rar </td><td>  33514693 </td><td>  11426 </td><td>  126 </td><td>  306 </td><td>  180 </td></tr><tr><td>  ArchFileName5.rar </td><td>  -m5 </td><td>  rar </td><td>  33465152 </td><td>  12894 </td><td>  126 </td><td>  346 </td><td>  220 </td></tr><tr><td>  ArchFileName3.rar </td><td>  -m3 </td><td>  rar </td><td>  33698079 </td><td>  9835 </td><td>  127 </td><td>  264 </td><td>  137 </td></tr><tr><td>  ArchFileName2.rar </td><td>  -m2 </td><td>  rar </td><td>  34399885 </td><td>  8352 </td><td>  130 </td><td>  224 </td><td>  94 </td></tr><tr><td>  ArchFileName4.7z </td><td>  -mx = 4 </td><td>  7z </td><td>  38926348 </td><td>  6470 </td><td>  147 </td><td>  174 </td><td>  27 </td></tr><tr><td>  ArchFileName3.7z </td><td>  -mx = 3 </td><td>  7z </td><td>  44545819 </td><td>  5889 </td><td>  168 </td><td>  158 </td><td>  10 </td></tr><tr><td>  ArchFileName2.7z </td><td>  -mx = 2 </td><td>  7z </td><td>  51690114 </td><td>  4754 </td><td>  195 </td><td>  128 </td><td>  67 </td></tr><tr><td>  ArchFileName1.rar </td><td>  -m1 </td><td>  rar </td><td>  53605833 </td><td>  4600 </td><td>  202 </td><td>  123 </td><td>  79 </td></tr><tr><td>  ArchFileName1.7z </td><td>  -mx = 1 </td><td>  7z </td><td>  57472172 </td><td>  3728 </td><td>  217 </td><td>  100 </td><td>  117 </td></tr><tr><td>  ArchFileName2.zip </td><td>  √ìtimo </td><td>  zip </td><td>  65733242 </td><td>  14025 </td><td>  248 </td><td>  376 </td><td>  128 </td></tr><tr><td>  ArchFileName1.zip </td><td>  Mais r√°pido </td><td>  zip </td><td>  81556824 </td><td>  9031 </td><td>  308 </td><td>  242 </td><td>  66. </td></tr></tbody></table></div><br><pre> <code class="php hljs">$table|Sort-Object -Property <span class="hljs-string"><span class="hljs-string">"Result %"</span></span>,<span class="hljs-string"><span class="hljs-string">"Size %"</span></span>,<span class="hljs-string"><span class="hljs-string">"Time %"</span></span>|Format-Table -AutoSize</code> </pre> <br><div class="scrollable-table"><table><thead><tr><th>  Archfilename </th><th>  N√≠vel de compress√£o </th><th>  Extens√£o </th><th>  Tamanho </th><th>  Tempo </th><th>  Tamanho% </th><th>  % De tempo </th><th>  % De resultado </th></tr></thead><tbody><tr><td>  ArchFileName3.7z </td><td>  -mx = 3 </td><td>  7z </td><td>  44545819 </td><td>  5889 </td><td>  168 </td><td>  158 </td><td>  10 </td></tr><tr><td>  ArchFileName4.7z </td><td>  -mx = 4 </td><td>  7z </td><td>  38926348 </td><td>  6470 </td><td>  147 </td><td>  174 </td><td>  27 </td></tr><tr><td>  ArchFileName1.zip </td><td>  Mais r√°pido </td><td>  zip </td><td>  81556824 </td><td>  9031 </td><td>  308 </td><td>  242 </td><td>  66. </td></tr><tr><td>  ArchFileName2.7z </td><td>  -mx = 2 </td><td>  7z </td><td>  51690114 </td><td>  4754 </td><td>  195 </td><td>  128 </td><td>  67 </td></tr><tr><td>  ArchFileName1.rar </td><td>  -m1 </td><td>  rar </td><td>  53605833 </td><td>  4600 </td><td>  202 </td><td>  123 </td><td>  79 </td></tr><tr><td>  ArchFileName2.rar </td><td>  -m2 </td><td>  rar </td><td>  34399885 </td><td>  8352 </td><td>  130 </td><td>  224 </td><td>  94 </td></tr><tr><td>  ArchFileName1.7z </td><td>  -mx = 1 </td><td>  7z </td><td>  57472172 </td><td>  3728 </td><td>  217 </td><td>  100 </td><td>  117 </td></tr><tr><td>  ArchFileName2.zip </td><td>  √ìtimo </td><td>  zip </td><td>  65733242 </td><td>  14025 </td><td>  248 </td><td>  376 </td><td>  128 </td></tr><tr><td>  ArchFileName3.rar </td><td>  -m3 </td><td>  rar </td><td>  33698079 </td><td>  9835 </td><td>  127 </td><td>  264 </td><td>  137 </td></tr><tr><td>  ArchFileName4.rar </td><td>  -m4 </td><td>  rar </td><td>  33514693 </td><td>  11426 </td><td>  126 </td><td>  306 </td><td>  180 </td></tr><tr><td>  ArchFileName5.rar </td><td>  -m5 </td><td>  rar </td><td>  33465152 </td><td>  12894 </td><td>  126 </td><td>  346 </td><td>  220 </td></tr><tr><td>  ArchFileName5.7z </td><td>  -mx = 5 </td><td>  7z </td><td>  31239355 </td><td>  35169 </td><td>  118 </td><td>  943 </td><td>  825 </td></tr><tr><td>  ArchFileName6.7z </td><td>  -mx = 6 </td><td>  7z </td><td>  30051742 </td><td>  37339 </td><td>  113 </td><td>  1002 </td><td>  889 </td></tr><tr><td>  ArchFileName7.7z </td><td>  -mx = 7 </td><td>  7z </td><td>  28948176 </td><td>  52832 </td><td>  109 </td><td>  1417 </td><td>  1308 </td></tr><tr><td>  ArchFileName8.7z </td><td>  -mx = 8 </td><td>  7z </td><td>  26511520 </td><td>  62404 </td><td>  100 </td><td>  1674 </td><td>  1574 </td></tr><tr><td>  ArchFileName9.7z </td><td>  -mx = 9 </td><td>  7z </td><td>  26511520 </td><td>  64614 </td><td>  100 </td><td>  1733 </td><td>  1633 </td></tr></tbody></table></div><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">#  !   ,    . Get-ChildItem .\$Archive|Remove-Item -Force</span></span></code> </pre> <br><p>  O resultado: <br>  O mais econ√¥mico em termos de espa√ßo em disco foi 7z com uma taxa de compress√£o de -mx = 8 e -mx = 9 </p><br><p><img src="https://habrastorage.org/webt/cd/mq/f5/cdmqf5xjxwupeq8m3y7erk75tfm.png"></p><br><p>  O tempo de cria√ß√£o do arquivo mais r√°pido foi 7z com uma taxa de compacta√ß√£o de -mx = 1 </p><br><p><img src="https://habrastorage.org/webt/8e/_b/jj/8e_bjj2e0rkquzmbe9sm-dvmzdw.png"></p><br><p>  O melhor em velocidade e espa√ßo ocupado foi 7z com uma taxa de compress√£o de -mx = 3 </p><br><p><img src="https://habrastorage.org/webt/mz/fb/ss/mzfbssm17xhzc_ixnxeuqgdbg5w.png"></p><br><p>  Escolhemos 7z com uma taxa de compacta√ß√£o de -mx = 8, pois o tamanho do arquivo morto √© -mx 9, mas funciona um pouco mais r√°pido. </p><br><p>  √ìtimo, a taxa de arquivamento e compacta√ß√£o est√° selecionada, agora vamos arquivar os logs! </p><br><h1 id="nam-nuzhno-reshit-sleduyuschie-zadachi">  Precisamos resolver os seguintes problemas: </h1><br><ol><li>  Evite alta carga do servidor durante a opera√ß√£o. </li><li>  Processe todas as pastas com os registros de uma subpasta. </li><li>  Exclua arquivos com mais de 30 dias (para n√£o ficar sem espa√ßo em disco). </li><li>  Crie arquivos por dia, dependendo da hora em que os arquivos foram modificados. </li></ol><br><div class="spoiler">  <b class="spoiler_title">ArchLogs.ps1</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">#Requires -Version 4.0 #          #SCHTASKS /Create /SC DAILY /ST 22:00 /TN ArchLogs /TR "C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe C:\Scripts\ArchLogs.ps1" /RU "NT AUTHORITY\NETWORKSERVICE" /F /RL HIGHEST #  ,      Clear-Host #   ,     Set-Location $PSScriptRoot #           . #  1 Function Set-MMTCore { $Core = (Get-WmiObject ‚Äìclass Win32_processor|Measure-Object NumberOfLogicalProcessors -sum).Sum / 2 $CoreTMP = $Core / 4 IF ($Core -lt 4) { $Core = $Core -1 } Else { $Core = $Core - $CoreTMP } [math]::Round($Core) } #    $MX = 8 #     $MMT = Set-MMTCore #  ,      $SearchFolder = "C:\inetpub" #     $SearchFolder $InetpubFolder = Get-ChildItem $SearchFolder #     Logs #  2 $LogsFolder = $InetpubFolder|foreach {Get-ChildItem $_.Fullname|Where-Object{$_.PSIsContainer -eq $true}|Where-Object{$_.name -eq "logs"}} #  ,      $Archive = "Archive" $ArchiveFile = "ArchFiles.txt" #      $LogsFolder   $LogsFolderName   foreach($LogsFolderName in $LogsFolder.Fullname){ $LogsFolderName #   $Archive,       IF ((Test-Path -Path "$LogsFolderName\$Archive") -ne $true){New-Item -Path $LogsFolderName -Name $Archive -ItemType Directory -Force} #    30  #  3 Get-ChildItem "$LogsFolderName\$Archive"|Where-Object {$_.LastWriteTime -le (Get-Date).AddDays(-30)}| Remove-Item -Force #     [Array]$ArchiveItems = Get-ChildItem -Path $LogsFolderName -Exclude $Archive #   , .    -  IF ($ArchiveItems.Count -ne ^_^quot&amp;#0;quot^_^){ #       $AllLogsFiles = Get-ChildItem $ArchiveItems -Recurse &lt;#-Filter *.log#&gt;|Where-Object {$_.LastWriteTime -lt (Get-Date).Date} #     #  4 $AllData = ($AllLogsFiles|Sort-Object -Property LastWriteTime).LastWriteTime.Date|Select-Object -Unique $AllData foreach ($Data in $AllData){ IF ($ArchiveItems.Count -ne ^_^quot&amp;#0;quot^_^){ #         ($AllLogsFiles|Where-Object {$_.LastWriteTime -lt (Get-Date).Date}|Where-Object {$_.LastWriteTime -ge (Get-Date $Data) -and $_.LastWriteTime -lt (Get-Date $Data).AddDays(1)}).FullName|Out-File .\$ArchiveFile -Force -Encoding default Write-Host "===" $Data Write-Host "===" #      IF ($(Get-Content .\ArchFiles.txt -Encoding default) -ne $null){ $ArchiveFileName =$(($LogsFolderName.Remove($LogsFolderName.LastIndexOf("\"))) -split "\\"|Select-Object -Last 1) + "_" + $(Get-Date $Data -Format dd-MM-yyyy) cmd /c "$env:ProgramFiles\7-Zip\7z.exe" a -mx="$MX" -mmt="$MMT" -t7z -ssw -sdel "$LogsFolderName\$Archive\$ArchiveFileName" "@$ArchiveFile" #        IF(Test-Path ".\$ArchiveFile"){Remove-Item ".\$ArchiveFile" -Force} #      Logs $LogsFolderName|foreach {Get-ChildItem $_|Where-Object {(Get-ChildItem -Path $_.FullName) -eq $null}|Remove-Item -Force} } } } } }</span></span></code> </pre> </div></div><br><p>  Aqui n√£o vou pintar todas as linhas do script (descritas nos coment√°rios), mas focar apenas na fun√ß√£o Set-MMTCore, que nos permite calcular o n√∫mero de threads para 7z para n√£o carregar o processador em nosso servidor: </p><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">Function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Set</span></span></span><span class="hljs-function">-</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MMTCore</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">#        2 $Core = (Get-WmiObject ‚Äìclass Win32_processor|Measure-Object NumberOfLogicalProcessors -sum).Sum / 2 #      4 $CoreTMP = $Core / 4 IF ($Core -lt 4) { $Core = $Core -1 } Else { $Core = $Core - $CoreTMP } #    [math]::Round($Core) }</span></span></code> </pre> <br><h6 id="bez-ispolzovaniya-funkcii-set-mmtcore">  Sem usar a fun√ß√£o Set-MMTCore </h6><br><p>  Pode-se ver que a CPU fica em 100%.  Isso significa que inevitavelmente causaremos problemas no servidor e receberemos um alerta do sistema de monitoramento. </p><br><p><img src="https://habrastorage.org/webt/lx/zs/35/lxzs35gatvlgkeq3nqg1lqlosum.png"></p><br><h6 id="pri-ispolzovanii-funkcii-set-mmtcore">  Ao usar a fun√ß√£o Set-MMTCore </h6><br><p>  Pode-se ver que a CPU √© de 30 a 35%.  Isso significa que o uso da fun√ß√£o Set-MMTCore permite arquivar arquivos sem afetar a opera√ß√£o do servidor. </p><br><p><img src="https://habrastorage.org/webt/1i/0e/lu/1i0elui1ntjzib8hlb6i1lgdbea.png"></p><br><p>  O resultado do script de backup: </p><br><h6 id="papka-do-arhivacii">  Pasta antes do arquivamento: </h6><br><p><img src="https://habrastorage.org/webt/jp/4l/zm/jp4lzmtwot2wr8pry4xmxks7uxo.png"></p><br><h6 id="papka-posle-arhivacii">  Pasta ap√≥s o arquivamento: </h6><br><p><img src="https://habrastorage.org/webt/5d/ei/ls/5deils-brkw-qwkq6mdedtw2kxm.png"></p><br><h6 id="fayly-sozdannye--v-processe-arhivacii">  Arquivos criados durante o processo de arquivamento: </h6><br><p><img src="https://habrastorage.org/webt/hi/pv/q-/hipvq-nga8eyesk50mfzb4qs8cw.png"></p><br><h6 id="fayly-v-arhive">  Arquivos no arquivo: </h6><br><p><img src="https://habrastorage.org/webt/a4/3_/s9/a43_s9t2hg2cfjl3ytu559jjxo8.png"></p><br><p><img src="https://habrastorage.org/webt/rl/yf/u2/rlyfu2qtcs3jcq0rdu9__wuok6m.png"></p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt484414/">https://habr.com/ru/post/pt484414/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt484404/index.html">Dirigimos desenvolvedores e fornecemos feedback de maneira cient√≠fica - v√≠deo do Yandex.</a></li>
<li><a href="../pt484406/index.html">Elfos em jun√ß√µes pn</a></li>
<li><a href="../pt484408/index.html">Era RUTM</a></li>
<li><a href="../pt484410/index.html">H√°bitos √∫teis para desenvolvedores</a></li>
<li><a href="../pt484412/index.html">Processador NXP S32G para arquitetura eletr√¥nica automotiva moderna</a></li>
<li><a href="../pt484418/index.html">CEO Motoriki Ilya Chekh: √Äs vezes, eles esperam um trabalho ideal das pr√≥teses experimentais e ficam decepcionados</a></li>
<li><a href="../pt484420/index.html">Mudan√ßas no antichita popular do BattlEye e maneiras de contorn√°-los</a></li>
<li><a href="../pt484424/index.html">Nvidia Orin - um chip para ve√≠culos rob√≥ticos</a></li>
<li><a href="../pt484426/index.html">Eu e meu ciclomotor. Escala de inefici√™ncia</a></li>
<li><a href="../pt484428/index.html">Escolhendo uma ideia para uma startup sem um investidor: pelo contr√°rio</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>