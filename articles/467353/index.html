<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üâë üà∂ üëàüèº M√©todos de optimizaci√≥n de c√≥digo para Redd. Parte 1: efecto cach√© üëµüèæ üé∏ üíáüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En el primer art√≠culo de la serie, promov√≠ activamente la idea de que el desarrollo de c√≥digo para Redd es secundario, y el proyecto principal es prim...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>M√©todos de optimizaci√≥n de c√≥digo para Redd. Parte 1: efecto cach√©</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/467353/"> En el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">primer art√≠culo de la</a> serie, promov√≠ activamente la idea de que el desarrollo de c√≥digo para Redd es secundario, y el proyecto principal es primario.  Redd es una herramienta auxiliar, por lo que dedicar mucho tiempo a ello es incorrecto.  Es decir, el desarrollo para ello deber√≠a ir r√°pidamente.  Pero esto no significa en absoluto que los programas resultantes no sean √≥ptimos.  En realidad, si no est√°n optimizados en absoluto, entonces solo la potencia del equipo no ser√° suficiente para implementar el sistema de prueba deseado.  Por lo tanto, el proceso, como dije, debe ser r√°pido y f√°cil, pero el desarrollador siempre debe tener en cuenta algunos principios de optimizaci√≥n. <br><br><img src="https://habrastorage.org/webt/ky/gv/ge/kygvge7bilfbzntymcu3qzlk4mq.jpeg"><br><br>  Se han publicado libros gruesos sobre optimizaci√≥n.  Algunos de estos libros son √∫tiles, algunos ya est√°n desactualizados, ya que los principios descritos en ellos han migrado durante mucho tiempo a la etapa de optimizaci√≥n autom√°tica al crear c√≥digo ... Pero hay algunas cosas que no tienen valor al desarrollar programas ordinarios para procesadores ordinarios, por lo que los libros t√≠picos generalmente no describen .  Ahora comenzaremos a considerarlos. <br><a name="habracut"></a><br><h2>  Introduccion </h2><br>  Hasta ahora, escrib√≠ sobre el principio de "un problema: un art√≠culo".  Y los art√≠culos se obtuvieron en el formato de conferencias, afectando varios temas a la vez, unidos por un problema com√∫n.  Pero algunos lectores dijeron que dichos art√≠culos no pod√≠an leerse de una vez.  Por lo tanto, ahora trataremos de hablar sobre un solo tema en un art√≠culo.  Tambi√©n es m√°s f√°cil para m√≠ escribir as√≠.  Veamos, de repente ser√° m√°s conveniente para todos. <br><br>  Adem√°s, deleita a los misteriosos mineros.  Si un art√≠culo se publica por la ma√±ana, entonces el primer inconveniente llega despu√©s de un per√≠odo de tiempo durante el cual es imposible leer el texto completo.  Alguien hace esto puramente desde el principio, ahorrando solo temas sobre UDB y balalaika.  Si la publicaci√≥n no fue en la ma√±ana, sino en la tarde, entonces arroja un signo negativo con retraso.  El segundo menos llega durante el d√≠a (y ese amigo, por cierto, tambi√©n se salv√≥ de temas sobre UDB y sobre balalaika).  Habr√° m√°s art√≠culos en el nuevo formato, lo que significa que habr√° momentos m√°s agradables para esta pareja (aunque, personalmente para m√≠, como autor, se vuelve triste e insultante por sus acciones). <br><br>  Art√≠culos anteriores de la serie: <br><br><ol><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Desarrollo del "firmware" m√°s simple para FPGAs instalados en Redd, y depuraci√≥n utilizando la prueba de memoria como ejemplo.</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Desarrollo del "firmware" m√°s simple para FPGAs instalados en Redd.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Parte 2. C√≥digo del programa.</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Desarrollo de su propio n√∫cleo para incrustar en un sistema de procesador basado en FPGA.</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Desarrollo de programas para el procesador central Redd sobre el ejemplo de acceso a la FPGA.</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Los primeros experimentos utilizando el protocolo de transmisi√≥n en el ejemplo de la conexi√≥n de la CPU y el procesador en el FPGA del complejo Redd.</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Merry Quartusel, o c√≥mo el procesador ha llegado a tal vida.</a> </li></ol><br><h2>  Comportamiento misterioso de un sistema t√≠pico. </h2><br>  Hagamos el sistema de procesador m√°s simple al incluir un reloj, un procesador Nios II / f, un controlador SDRAM y un puerto de salida.  As√≠ es como se ve este sistema Spartan en Platform Designer <br><br><img src="https://habrastorage.org/webt/mr/qt/hm/mrqthmfrz5vespqetdjwcguvclu.png"><br><br>  El c√≥digo del programa contendr√° solo una funci√≥n, cuyo cuerpo parece algo extra√±o, ya que contiene muchas l√≠neas repetidas, pero esto nos ser√° √∫til. <br><br><div class="spoiler">  <b class="spoiler_title">El c√≥digo est√° oculto porque es demasiado estricto.</b> <div class="spoiler_text"><pre><code class="plaintext hljs">extern "C" { #include "sys/alt_stdio.h" #include &lt;system.h&gt; #include &lt;io.h&gt; } void MagicFunction() { while (1) { IOWR (PIO_0_BASE,0,1); IOWR (PIO_0_BASE,0,0); IOWR (PIO_0_BASE,0,1); IOWR (PIO_0_BASE,0,0); IOWR (PIO_0_BASE,0,1); IOWR (PIO_0_BASE,0,0); IOWR (PIO_0_BASE,0,1); IOWR (PIO_0_BASE,0,0); IOWR (PIO_0_BASE,0,1); IOWR (PIO_0_BASE,0,0); IOWR (PIO_0_BASE,0,1); IOWR (PIO_0_BASE,0,0); IOWR (PIO_0_BASE,0,1); IOWR (PIO_0_BASE,0,0); IOWR (PIO_0_BASE,0,1); IOWR (PIO_0_BASE,0,0); IOWR (PIO_0_BASE,0,1); IOWR (PIO_0_BASE,0,0); IOWR (PIO_0_BASE,0,1); IOWR (PIO_0_BASE,0,0); IOWR (PIO_0_BASE,0,1); IOWR (PIO_0_BASE,0,0); IOWR (PIO_0_BASE,0,1); IOWR (PIO_0_BASE,0,0); IOWR (PIO_0_BASE,0,1); IOWR (PIO_0_BASE,0,0); IOWR (PIO_0_BASE,0,1); IOWR (PIO_0_BASE,0,0); IOWR (PIO_0_BASE,0,1); IOWR (PIO_0_BASE,0,0); } } int main() { MagicFunction(); /* Event loop never exits. */ while (1); return 0; }</code> </pre> <br></div></div><br>  Pon un punto de interrupci√≥n en la √∫ltima de las l√≠neas: <br><br><pre> <code class="plaintext hljs">IOWR (PIO_0_BASE,0,0);</code> </pre> <br>  en <b>MagicFunction</b> y ejecuta el programa.  ¬øQu√© obtuvimos a la salida del puerto?  Impulsos muy desiguales: <br><br><img src="https://habrastorage.org/webt/n7/qt/qj/n7qtqjkwhcioypjv02_7ir7k3es.png"><br><br>  El horror  Pues si.  Sin embargo, haga clic en "iniciar" nuevamente para completar otra iteraci√≥n del ciclo.  Y ahora a la salida vemos un hermoso meandro suave: <br><br><img src="https://habrastorage.org/webt/ez/nz/4k/eznz4kkvo8smagbksijd0tt4bso.png"><br><br>  Otra iteraci√≥n.  Y uno m√°s ... Meandro estable.  Eliminamos el punto de interrupci√≥n y observamos el trabajo en din√°mica: ya no hay tales interrupciones.  Hay r√°fagas interminables de pulsos. <br><br>  ¬øPor qu√© tuvimos impulsos rotos en el primer pase?  Un accidente?  No  Dejamos de depurar y lo iniciamos nuevamente.  Y nuevamente tenemos impulsos desgarrados.  Las brechas siempre surgen a la entrada del programa. <br><br><h2>  La pista est√° en el cach√© </h2><br>  En realidad, la soluci√≥n a este comportamiento radica en el cach√©.  Nuestro programa est√° almacenado en SDRAM.  Obtener c√≥digo de SDRAM no es r√°pido.  Es necesario dar un comando de lectura, es necesario dar una direcci√≥n, y la direcci√≥n consta de dos partes.  Tienes que esperar un poco.  Solo entonces el microcircuito dar√° los datos.  Para evitar tales demoras cada vez, el microcircuito puede emitir no una, sino varias palabras consecutivas.  No consideraremos los gr√°ficos de tiempo hoy, lo pospondremos para los siguientes art√≠culos. <br><br>  Bueno, en el lado del n√∫cleo del procesador, se cre√≥ un cach√© de forma predeterminada.  Aqu√≠ est√°n sus configuraciones: <br><br><img src="https://habrastorage.org/webt/n3/3b/cx/n33bcxjyhe2v_lvaiuqafjzvdoc.png"><br><br>  En realidad, los retrasos ocurren en el momento en que se est√° cargando por lotes las instrucciones de SDRAM a la cach√©.  En las pr√≥ximas iteraciones, el c√≥digo ya est√° en la memoria cach√©, por lo que ya no es necesario cargarlo. <br><br>  El oscilograma muestra un promedio de 8 entradas por puerto (una unidad se escribe 4 veces y cero se escribe 4 veces) por operaci√≥n de carga.  Un registro: un comando de ensamblador, que se puede encontrar eligiendo el elemento del men√∫ Ventana-&gt; Mostrar vista-&gt; Otro: <br><br><img src="https://habrastorage.org/webt/p-/xp/nh/p-xpnhdsqsklxoqa_ityjp2u-hu.png"><br><br>  y luego Depuraci√≥n-&gt; Desmontaje: <br><br><img src="https://habrastorage.org/webt/2n/7c/in/2n7cinmvmt04ov-_ibduzwcv9zo.png"><br><br>  Aqu√≠ est√°n nuestras cadenas y el c√≥digo de ensamblaje correspondiente: <br><br><img src="https://habrastorage.org/webt/_q/ox/wz/_qoxwz5u9qkgsn4gd5t0yuy4djw.png"><br><br>  8 equipos de 4 bytes cada uno.  Obtenemos 32 bytes por l√≠nea de cach√© ... Miramos nuestro archivo de ayuda favorito C: \ Work \ CachePlay \ software \ CachePlay_bsp \ system.h y vemos: <br><br><pre> <code class="plaintext hljs">#define ALT_CPU_ICACHE_LINE_SIZE 32 #define ALT_CPU_ICACHE_LINE_SIZE_LOG2 5</code> </pre><br>  Los datos pr√°cticamente calculados coincidieron con la teor√≠a.  Adem√°s, de la documentaci√≥n se deduce que el tama√±o de la cadena no se puede cambiar.  Siempre es igual a treinta y dos bytes. <br><br><h2>  Un experimento un poco m√°s complicado </h2><br>  Intentemos provocar un cach√© para reiniciar durante el trabajo establecido.  Cambiemos un poco el programa de prueba.  Hacemos dos funciones y las llamamos desde la funci√≥n <b>main ()</b> , colocando un bucle en ella.  No establecer√© un punto de interrupci√≥n.  Por cierto, si hace que las funciones sean completamente id√©nticas, el optimizador lo notar√° y eliminar√° una de ellas, por lo que al menos una l√≠nea, y deber√≠an diferir ... Esto es lo que escrib√≠ al principio: los optimizadores son muy inteligentes ahora. <br><br><div class="spoiler">  <b class="spoiler_title">C√≥digo de programa de prueba modificado.</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">extern "C" { #include "sys/alt_stdio.h" #include &lt;system.h&gt; #include &lt;io.h&gt; } void MagicFunction1() { IOWR (PIO_0_BASE,0,1); IOWR (PIO_0_BASE,0,0); IOWR (PIO_0_BASE,0,1); IOWR (PIO_0_BASE,0,0); IOWR (PIO_0_BASE,0,1); IOWR (PIO_0_BASE,0,0); IOWR (PIO_0_BASE,0,1); IOWR (PIO_0_BASE,0,0); IOWR (PIO_0_BASE,0,1); IOWR (PIO_0_BASE,0,0); IOWR (PIO_0_BASE,0,1); IOWR (PIO_0_BASE,0,0); IOWR (PIO_0_BASE,0,1); IOWR (PIO_0_BASE,0,0); IOWR (PIO_0_BASE,0,1); IOWR (PIO_0_BASE,0,0); IOWR (PIO_0_BASE,0,1); IOWR (PIO_0_BASE,0,0); IOWR (PIO_0_BASE,0,1); IOWR (PIO_0_BASE,0,0); IOWR (PIO_0_BASE,0,1); IOWR (PIO_0_BASE,0,0); IOWR (PIO_0_BASE,0,1); IOWR (PIO_0_BASE,0,0); IOWR (PIO_0_BASE,0,1); IOWR (PIO_0_BASE,0,0); IOWR (PIO_0_BASE,0,1); IOWR (PIO_0_BASE,0,0); IOWR (PIO_0_BASE,0,1); IOWR (PIO_0_BASE,0,0); } void MagicFunction2() { IOWR (PIO_0_BASE,0,0); IOWR (PIO_0_BASE,0,1); IOWR (PIO_0_BASE,0,0); IOWR (PIO_0_BASE,0,1); IOWR (PIO_0_BASE,0,0); IOWR (PIO_0_BASE,0,1); IOWR (PIO_0_BASE,0,0); IOWR (PIO_0_BASE,0,1); IOWR (PIO_0_BASE,0,0); IOWR (PIO_0_BASE,0,1); IOWR (PIO_0_BASE,0,0); IOWR (PIO_0_BASE,0,1); IOWR (PIO_0_BASE,0,0); IOWR (PIO_0_BASE,0,1); IOWR (PIO_0_BASE,0,0); IOWR (PIO_0_BASE,0,1); IOWR (PIO_0_BASE,0,0); IOWR (PIO_0_BASE,0,1); IOWR (PIO_0_BASE,0,0); IOWR (PIO_0_BASE,0,1); IOWR (PIO_0_BASE,0,0); IOWR (PIO_0_BASE,0,1); IOWR (PIO_0_BASE,0,0); IOWR (PIO_0_BASE,0,1); IOWR (PIO_0_BASE,0,0); IOWR (PIO_0_BASE,0,1); IOWR (PIO_0_BASE,0,0); IOWR (PIO_0_BASE,0,1); IOWR (PIO_0_BASE,0,0); IOWR (PIO_0_BASE,0,1); } int main() { while (1) { MagicFunction1(); MagicFunction2(); } /* Event loop never exits. */ while (1); return 0; }</code> </pre><br></div></div><br>  Obtenemos un resultado bastante hermoso, filmado ya en el modo establecido del programa. <br><br><img src="https://habrastorage.org/webt/6q/ww/xa/6qwwxao-phas4ippal7a1hrhlik.png"><br><br>  Y ahora colocaremos alguna funci√≥n nueva entre este par de funciones, y no la llamaremos, solo se colocar√° entre ellas en la memoria.  Ahora intentar√© hacer que ocupe m√°s espacio ... El tama√±o del cach√© es de 4 kilobytes, por lo que lo haremos igual a cuatro kilobytes ... Simplemente inserte 1024 NOP, cada uno de los cuales tiene un tama√±o de 4 bytes.  Mostrar√© el final de la primera funci√≥n, la nueva funci√≥n y el comienzo de la segunda, para que quede claro c√≥mo cambia el programa: <br><br><pre> <code class="plaintext hljs">... IOWR (PIO_0_BASE,0,0); IOWR (PIO_0_BASE,0,1); IOWR (PIO_0_BASE,0,0); IOWR (PIO_0_BASE,0,1); IOWR (PIO_0_BASE,0,0); } #define Nops4 __asm__ volatile ("nop");__asm__ volatile ("nop");__asm__ volatile ("nop");__asm__ volatile ("nop"); #define Nops16 Nops4 Nops4 Nops4 Nops4 #define Nops64 Nops16 Nops16 Nops16 Nops16 #define Nops256 Nops64 Nops64 Nops64 Nops64 #define Nops1024 Nops256 Nops256 Nops256 Nops256 volatile void FuncBetween() { Nops1024 } void MagicFunction2() { IOWR (PIO_0_BASE,0,0); IOWR (PIO_0_BASE,0,1); IOWR (PIO_0_BASE,0,0); IOWR (PIO_0_BASE,0,1); IOWR (PIO_0_BASE,0,0); ...</code> </pre><br>  La l√≥gica del programa no ha cambiado, pero cuando se ejecuta ahora tenemos pulsos rotos <br><br><img src="https://habrastorage.org/webt/20/on/rq/20onrqyrzqtcdeiqjiulcaa0yuw.png"><br><br>  Har√© una pregunta ingenua: salimos volando del cach√© y ahora, a medida que se ampl√≠a la brecha, ¬øsiempre habr√° carga?  ¬°Para nada!  Cambie el tama√±o de la funci√≥n "mala", haci√©ndola igual a, digamos, cinco kilobytes.  Cinco m√°s que cuatro, ¬øseguimos volando?  O no?  Reemplace el inserto con esto: <br><br><pre> <code class="plaintext hljs">volatile void FuncBetween() { Nops1024 Nops256 }</code> </pre><br>  Y de nuevo obtenemos la belleza: <br><br><img src="https://habrastorage.org/webt/cz/hh/up/czhhupgwhqdrrddlaeyg8kv50yg.png"><br><br>  Entonces, ¬øqu√© determina la necesidad de cargar c√≥digo en el cach√©?  ¬øPodemos predecir algo, o cada vez que necesitamos mirar el hecho?  Profundicemos en la teor√≠a, con la que nos ayuda la <b>Gu√≠a de referencia del procesador Nios II</b> . <br><br><h2>  Poco de teor√≠a </h2><br>  As√≠ es como se divide el campo de direcci√≥n en el procesador: <br><br><img src="https://habrastorage.org/webt/ba/kw/5_/bakw5_bz0uipk2kzstdfcjuiuvy.png"><br><br>  Como puede ver, la direcci√≥n se divide en tres partes.  Etiqueta, l√≠nea y offset.  La dimensi√≥n del campo de desplazamiento es constante para el procesador Nios II y siempre es de cinco bits, es decir, puede direccionar 32 bytes.  La dimensi√≥n del campo "l√≠nea" depende del tama√±o de la memoria cach√© especificada al configurar el procesador.  En la figura anterior, es bastante grande.  No s√© por qu√© el documento tiene una dimensi√≥n tan grande.  Tenemos un tama√±o de cach√© de 4 kilobytes, lo que significa que la profundidad total de bits y el desplazamiento son de 12 bits.  5 bits toman un desplazamiento, para una l√≠nea queda 12-5 = 7 bits. <br><br>  Obtenemos una cierta tabla de 128 filas, cada una de 32 bytes de longitud.  Dar√©, digamos, las primeras 6 l√≠neas: <br><div class="scrollable-table"><table><tbody><tr><th>  Campo de etiqueta </th><th>  Campo "cadena" </th><th>  LSB </th><th>  Donde conseguir </th></tr><tr><td>  No importante </td><td>  0x00 </td><td>  0x000 a 0x01F </td><td>  A la l√≠nea 0 del cach√© </td></tr><tr><td>  No importante </td><td>  0x01 </td><td>  0x020 a 0x03F </td><td>  L√≠nea 1 cach√© </td></tr><tr><td>  No importante </td><td>  0x02 </td><td>  0x040 a 0x05F </td><td>  L√≠nea 2 cach√© </td></tr><tr><td>  No importante </td><td>  0x03 </td><td>  0x060 a 0x07F </td><td>  Line 3 Cache </td></tr><tr><td>  No importante </td><td>  0x04 </td><td>  0x080 a 0x09F </td><td>  L√≠nea 4 cach√© </td></tr><tr><td>  No importante </td><td>  0x05 </td><td>  0x0A0 a 0x0BF </td><td>  Line 5 Cache </td></tr><tr><td>  ... </td><td>  ... </td><td>  ... </td><td>  ... </td></tr><tr><td>  No importante </td><td>  0x7F </td><td>  0xFE0 a 0xFFF </td><td>  a la l√≠nea 127 del cach√© </td></tr></tbody></table></div><br>  Y entonces recurrimos a la direcci√≥n 0x123 <b>004</b> .  Si descarta la parte "no importante", el par "l√≠nea + desplazamiento" es 0x004.  Este es el rango de fila cero.  Los datos se cargar√°n en esta l√≠nea.  Y el trabajo adicional con datos del rango 0x123 <b>000</b> a 0x123 <b>01F</b> funcionar√° a trav√©s de la memoria cach√©.  ¬øEn qu√© condiciones se sobrecargar√° la cadena?  Al acceder a cualquier otra direcci√≥n que termine en el rango de 0x000 a 0x01F.  Bueno, es decir, si recurrimos a la direcci√≥n 0xABC <b>204</b> , todo permanecer√° en su lugar, porque el rango de direcciones m√°s bajas no se superpone con el nuestro.  Y 0xABC <b>804</b> no arruinar√° nada.  Pero al ejecutar el c√≥digo desde la direcci√≥n 0xABC <b>004, se</b> cargar√°n nuevos contenidos en la l√≠nea de cach√©.  Y ya la transici√≥n a la direcci√≥n 0x123 <b>004</b> nuevamente conducir√° a una sobrecarga.  Si salta constantemente entre 0xABC <b>004</b> y 0x123 <b>004</b> , se producir√° una sobrecarga continua. <br><br>  Tratemos de representar esto en forma de una imagen.  Supongamos que solo tenemos 8 l√≠neas en el cach√©, es m√°s conveniente colorearlas en diferentes colores.  Har√© que el tama√±o de l√≠nea sea 0x10, es m√°s conveniente pintar las direcciones en la imagen (recuerde que en Nios II real el tama√±o de l√≠nea siempre es 0x20 bytes).  La memoria late en p√°ginas condicionales que son del mismo tama√±o que las l√≠neas de cach√©.  La p√°gina roja de la memoria siempre ir√° a la l√≠nea roja de la memoria cach√©, de naranja a naranja, y as√≠ sucesivamente.  En consecuencia, los contenidos antiguos se descargar√°n. <br><br><img src="https://habrastorage.org/webt/r0/he/sl/r0heslzwbiuxwjprhq4tnf-xela.png"><br><br>  Bueno, en realidad, el comportamiento del programa durante el experimento ahora est√° claro.  Cuando las funciones se separaron estrictamente por 4 kilobytes, llegaron a p√°ginas de colores similares.  Por lo tanto el c√≥digo <br><br><pre> <code class="plaintext hljs"> while (1) { MagicFunction1(); MagicFunction2(); }</code> </pre><br>  condujo a la carga de la memoria cach√© por el bien de uno, luego por otra funci√≥n.  Y cuando el espacio no era 4, sino 5 kilobytes, las funciones se espaciaban en bloques de diferentes colores.  No hubo conflicto, todo funcion√≥ sin demora. <br><br><h2>  Conclusiones </h2><br>  Cuando le√≠ hace muchos a√±os que hay l√≠neas de n√∫cleos Cortex A, Cortex R y Cortex M dise√±ados para cosas productivas, para trabajar en tiempo real y para trabajar en sistemas baratos, respectivamente, al principio no entend√≠, pero cu√°l es, de hecho, la diferencia .  No, los sistemas baratos son comprensibles, pero los dos primeros son ¬øcu√°les son las diferencias?  Sin embargo, despu√©s de jugar el n√∫cleo Cortex A9 disponible en el FPGA Cyclone V SoC, sent√≠ todos los inconvenientes del cach√© cuando trabajaba con hierro.  Hay muchos cach√©s en el n√∫cleo de Cortex A ... Y la previsibilidad del comportamiento del sistema es casi nula.  Pero el cach√© mejora el rendimiento.  A veces es mejor si todo funciona no predeciblemente preciso al ritmo, pero r√°pido que previsiblemente lento.  Esto es especialmente cierto para la inform√°tica o, por ejemplo, para mostrar gr√°ficos. <br><br>  Pero el problema principal no es que surjan las cosas descritas en el art√≠culo, sino que el comportamiento del sistema cambiar√° de un ensamblaje a otro, ya que nadie sabe en qu√© direcciones caer√° la funci√≥n despu√©s de agregar o eliminar c√≥digo.  Hace 15 a√±os, en el proyecto del emulador de consola de juegos Sega para un decodificador de televisi√≥n por cable, tuvimos que hacer un preprocesador completo que, despu√©s de cada edici√≥n, moviera las funciones que emulaban los comandos del ensamblador de Motorola en el n√∫cleo SPARC-8 para que su tiempo de ejecuci√≥n fuera siempre el mismo (all√≠ debido a la cach√©, de lo contrario todo nad√≥ mucho). <br><br>  Pero, ¬øcu√°ndo necesitamos previsibilidad?  Por supuesto, al crear diagramas de tiempo mediante programaci√≥n (recuerde que, en general, en los FPGA tambi√©n es posible confiar esto al hardware, pero hay algunos detalles con un desarrollo r√°pido).  Pero cuando se trabaja con algoritmos computacionales, no es tan importante.  A menos que el algoritmo sea complejo, debe asegurarse de que las secciones cr√≠ticas no causen una sobrecarga constante de cach√©.  En la mayor√≠a de los casos, el cach√© no crea problemas y aumenta la productividad. <br><br>  En el pr√≥ximo art√≠culo, veremos c√≥mo predecir funciones cr√≠ticas en la memoria no almacenable en cach√©, que siempre se ejecuta a la velocidad m√°xima, y ‚Äã‚Äãdiscutiremos las ventajas impl√≠citas de los FPGA sobre los sistemas est√°ndar que surgen de las tecnolog√≠as utilizadas en este proceso. <br><br><h2>  Para los mas atentos </h2><br>  Un lector corrosivo puede preguntar: "¬øPor qu√© el oscilograma no se rasg√≥ lo suficiente al insertar cuatro kilobytes de c√≥digo?"  Todo es simple  Si inserta exactamente 4 kilobytes, obtenemos las siguientes direcciones para colocar funciones en la memoria: <br><br><pre> <code class="plaintext hljs"> MagicFunction1(): 0200006c: movhi r2,1024 02000070: movi r4,1 02000074: addi r2,r2,4096 02000078: stwio r4,0(r2) 92 IOWR (PIO_0_BASE,0,0); 0200007c: mov r3,zero 02000080: stwio r3,0(r2) 93 IOWR (PIO_0_BASE,0,1); ... 120 IOWR (PIO_0_BASE,0,0); 020000f0: stwio r3,0(r2) 020000f4: ret 131 Nops1024 FuncBetween(): 020000f8: nop 020000fc: nop 02000100: nop 02000104: nop ... 020010ec: nop 020010f0: nop 020010f4: nop 020010f8: ret 135 IOWR (PIO_0_BASE,0,0); MagicFunction2(): 020010fc: movhi r2,1024 02001100: mov r4,zero 02001104: addi r2,r2,4096</code> </pre><br>  Para una forma de onda idealmente mala, debe insertar NOP para que 4 kilobytes sea su volumen junto con la longitud de la funci√≥n <b>MagicFunction1 ()</b> .  No importa lo que vaya para una hermosa foto!  Cambie la inserci√≥n a esto: <br><br><pre> <code class="plaintext hljs">volatile void FuncBetween() { Nops256 Nops256 Nops256 Nops64 Nops64 Nops64 Nops16 Nops16 }</code> </pre><br>  Una y otra vez presto atenci√≥n a que el inserto no recibe control.  Simplemente cambia la posici√≥n de las funciones en la memoria entre s√≠.  Con este inserto, obtenemos el terrible horror deseado: <br><br><img src="https://habrastorage.org/webt/7d/by/om/7dbyomefuy0kgtjxmnysanc_lxm.png"><br><br>  Me pareci√≥ que esos detalles insertados en el texto principal distraer√≠an a todos del texto principal, as√≠ que los puse en una posdata. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/467353/">https://habr.com/ru/post/467353/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../467339/index.html">Y de nuevo, el d√≠a 256 del a√±o.</a></li>
<li><a href="../467343/index.html">Por qu√© dej√© de trabajar como freelance: impresiones del desarrollador de backend despu√©s de 2 a√±os de "libertad"</a></li>
<li><a href="../467345/index.html">Visite los blogs de TI y las 4 capas de capacitaci√≥n: una entrevista con Sergei Abdulmanov de Mosigra</a></li>
<li><a href="../467347/index.html">Libro "Creaci√≥n de contratos inteligentes de Solidez para la cadena de bloques Ethereum. Gu√≠a pr√°ctica</a></li>
<li><a href="../467349/index.html">Traslado de un programador a Estonia: trabajo, dinero y costo de vida.</a></li>
<li><a href="../467355/index.html">Entrevista con el investigador de mercado y las tendencias de desarrollo de software en Europa Central y Oriental, Eugene Schwab-Chesaru</a></li>
<li><a href="../467357/index.html">PVS-Studio en las nubes: Azure DevOps</a></li>
<li><a href="../467359/index.html">PVS-Studio va a las nubes: Azure DevOps</a></li>
<li><a href="../467361/index.html">Nos olvidamos de la delegaci√≥n en JavaScript. Delegaci√≥n de eventos en reaccionar</a></li>
<li><a href="../467363/index.html">Uso de funciones de p√©rdida personalizadas y m√©tricas de calidad de aprendizaje en Keras</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>