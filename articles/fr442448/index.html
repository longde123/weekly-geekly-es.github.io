<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🛌🏻 👦🏽 🚵 Modèles de concurrence et d'erreur masqués dans le code: blocage 🤞🏽 🎺 👩🏻‍🚒</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Certes, beaucoup ont entendu, mais quelqu'un s'est rencontré dans la pratique, tels que des blocages et des conditions de course. Ces concepts sont cl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Modèles de concurrence et d'erreur masqués dans le code: blocage</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/442448/">  Certes, beaucoup ont entendu, mais quelqu'un s'est rencontré dans la pratique, tels que des blocages et des conditions de course.  Ces concepts sont classés comme des erreurs dans l'utilisation de la concurrence.  Si je vous pose une question sur ce qu'est un blocage, vous êtes très susceptible de commencer à dessiner une image de blocage classique ou sa représentation en pseudo-code sans aucun doute.  Quelque chose comme ça: <br><br><img src="https://habrastorage.org/webt/mr/0l/ld/mr0lldyuxzcz1am0qcmo5hsgxze.png"><br><br>  Nous obtenons ces informations à l'institut, qui peuvent être trouvées dans des livres et des articles sur Internet.  Une telle impasse utilisant, par exemple, deux mutex, dans toute sa splendeur, peut être trouvée dans le code.  Mais dans la plupart des cas, tout n'est pas aussi simple, et tout le monde ne peut pas voir le modèle d'erreur classique dans le code s'il n'est pas présenté sous la forme habituelle. <br><a name="habracut"></a><br><img src="https://habrastorage.org/webt/fd/sk/mg/fdskmgiramf-v9islka0at8scgi.jpeg"><br><br>  Considérons une classe dans laquelle nous nous intéressons aux méthodes StartUpdate, CheckAndUpdate et Stop, C ++ est utilisé, le code est aussi simple que possible: <br><br><pre><code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::recursive_mutex m_mutex; Future m_future; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Stop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-function"><span class="hljs-function">unique_lock </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">scoped_lock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(m_mutex)</span></span></span></span>; m_future.Wait(); <span class="hljs-comment"><span class="hljs-comment">// do something } void StartUpdate() { m_future.Wait(); m_future = Future::Schedule(std::bind(&amp;Element::CheckAndUpdate, this), std::chrono::milliseconds(100); } void CheckAndUpdate() { std::unique_lock scoped_lock(m_mutex); //do something }</span></span></code> </pre> <br>  À quoi devez-vous faire attention dans le code présenté: <br><br><ol><li>  mutex récursif est utilisé.  La capture répétée d'un mutex récursif ne mène à l'attente que si cette capture se produit dans le même thread.  Dans ce cas, le nombre d'exemptions mutex devrait correspondre au nombre de captures.  Si nous essayons de capturer un mutex récursif qui est déjà capturé dans un autre thread, le thread passe en mode veille. </li><li>  La fonction Future :: Schedule démarre (en n millisecondes) dans un thread séparé auquel le rappel lui est passé </li></ol><br>  Maintenant, nous analysons toutes les informations reçues et composons une image: <br><br><img src="https://habrastorage.org/webt/9t/nm/rq/9tnmrqiylhu8rq-pmewzbft1etc.png"><br><br>  Compte tenu des deux faits présentés ci-dessus, il n'est pas difficile de conclure qu'une tentative de capture d'un mutex récursif dans l'une des fonctions entraînera l'attente de la libération du mutex s'il a déjà été capturé dans une autre fonction, car le rappel CheckAndUpdate est toujours exécuté dans un thread séparé. <br><br>  À première vue, il n'y a rien de suspect concernant l'impasse.  Mais pour être plus proche, tout se résume à notre image classique.  Lorsque l'objet fonctionnel commence à s'exécuter, nous capturons implicitement la ressource m_future, le rappel directement <br>  associé à m_future: <br><br><img src="https://habrastorage.org/webt/d7/vd/df/d7vddfwbntho41g-9j02le7xouw.png"><br><br>  <b>La séquence d'actions menant à l'impasse est la suivante:</b> <br><br><ol><li>  Il est prévu d'exécuter CheckAndUpdate, mais le rappel ne démarre pas immédiatement, après n millisecondes. </li><li>  La méthode Stop est appelée, puis elle démarre: nous essayons de capturer le mutex - la ressource est une capturée, nous commençons à attendre que m_future se termine - l'objet n'a pas encore été appelé, nous attendons. </li><li>  L'exécution de CheckAndUpdate commence: nous essayons de capturer le mutex - nous ne pouvons pas, la ressource est déjà capturée par un autre thread, nous attendons sa libération. </li></ol><br>  C'est tout: le thread effectuant l'appel Stop attend la fin de CheckAndUpdate, et l'autre thread, à son tour, ne peut pas continuer à fonctionner jusqu'à ce qu'il attrape le mutex qui a déjà été capturé par le thread mentionné précédemment.  C'est une impasse assez classique.  La moitié du travail est effectuée - la cause du problème a été découverte. <br><br><div class="spoiler">  <b class="spoiler_title">Maintenant, un peu sur la façon de le réparer.</b> <div class="spoiler_text">  <b>Approche 1</b> <br>  La procédure de capture des ressources doit être la même, cela évitera les blocages.  Autrement dit, vous devez voir s'il est possible de modifier l'ordre de capture des ressources dans la méthode Stop.  Dans la mesure où le cas de blocage n'est pas entièrement évident et qu'il n'y a pas de capture explicite de la ressource m_future dans CheckAndUpdate, nous avons décidé de réfléchir à une autre solution afin d'éviter le retour d'erreur à l'avenir. <br><br>  <b>Approche 2</b> <br><ol><li>  Vérifiez si vous pouvez désactiver l'utilisation du mutex dans CheckAndUpdate. </li><li>  Puisque nous utilisons le mécanisme de synchronisation, nous restreignons l'accès à certaines ressources.  Il vous suffira peut-être de refaire ces ressources en atomique (comme nous l'avons fait), dont l'accès est déjà thread-safe. </li><li>  Il s'est avéré que les variables, dont l'accès était limité, peuvent être facilement converties en atomiques, de sorte que le mutex mentionné est supprimé avec succès. </li></ol><br></div></div><br>  Voici un exemple simple avec un blocage non évident qui se réduit facilement au modèle de cette erreur.  Enfin, je souhaite que vous écriviez du code fiable et sûr pour les threads! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr442448/">https://habr.com/ru/post/fr442448/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr442438/index.html">Un premier regard sur JavaScript à travers les yeux d'un développeur Java</a></li>
<li><a href="../fr442440/index.html">Création d'une application Android à l'aide des mises en page Anko et des coroutines Anko</a></li>
<li><a href="../fr442442/index.html">Ingénieur senior en recherche de travail. À propos des tâches lors des entretiens techniques et des questions théoriques</a></li>
<li><a href="../fr442444/index.html">Mythes de la physique populaire moderne</a></li>
<li><a href="../fr442446/index.html">Transformation numérique à l'exemple du centre d'appels de toute entreprise</a></li>
<li><a href="../fr442450/index.html">Blockchain et données médicales: comment ça marche</a></li>
<li><a href="../fr442452/index.html">Comment se connecter à NodeJS pour que les garçons dans la cour respectent</a></li>
<li><a href="../fr442454/index.html">Magic Leap prévoit de compléter le monde réel avec des couches numériques</a></li>
<li><a href="../fr442456/index.html">Comment économiser des ressources dans le navigateur et ne pas casser le Web. Rapport Yandex</a></li>
<li><a href="../fr442458/index.html">Abîme ou chemin créé par l'homme d'un pilote RPA à une mise en œuvre à l'échelle de l'entreprise</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>