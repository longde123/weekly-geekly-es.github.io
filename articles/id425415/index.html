<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🖲️ 📂 🔜 Perl 5: bagaimana makro menyembunyikan kesalahan 💥 👨‍👨‍👦 ✋🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Untuk melengkapi daftar bahasa pemrograman open source yang diuji menggunakan analisa kode statis PVS-Studio, Perl 5. dipilih. Artikel ini adalah tent...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Perl 5: bagaimana makro menyembunyikan kesalahan</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pvs-studio/blog/425415/"><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/134/949/fad/134949fad7cf6d492a3eb7324942b640.png"></div><br>  Untuk melengkapi daftar bahasa pemrograman open source yang diuji menggunakan analisa kode statis PVS-Studio, Perl 5. dipilih. Artikel ini adalah tentang kesalahan yang ditemukan dan kesulitan dalam melihat hasil analisis.  Jumlah makro dalam kode begitu besar sehingga tampaknya kode itu tidak ditulis dalam C, tetapi dalam beberapa dialek aneh itu.  Meskipun kesulitan saat melihat kode, saya berhasil mengumpulkan masalah menarik, yang akan dibahas dalam artikel ini. <br><br><h2>  Pendahuluan </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Perl</a> adalah bahasa pemrograman tujuan umum dinamis tingkat tinggi yang diartikan (Perl adalah keluarga dari dua bahasa pemrograman tingkat tinggi, tujuan umum, ditafsirkan, dinamis).  Perl 5 diluncurkan pada tahun 1994.  Setelah beberapa dekade, kode C dengan banyak makro menyebabkan kegugupan bagi programmer modern. <br><br>  Kode sumber untuk Perl 5 diambil dari <a href="">repositori</a> resmi (cabang <i>blead</i> ).  Untuk memeriksa proyek, kami menggunakan penganalisa kode statis <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">PVS-Studio</a> .  Analisis dilakukan pada sistem operasi Linux, tetapi penganalisa juga tersedia untuk Windows dan macOS. <br><br>  Melihat hasil analisis bukanlah tugas yang mudah.  Faktanya adalah bahwa penganalisa memeriksa file <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">.i preprocessed</a> , di mana semua arahan preprocessor sudah dibuka, dan menghasilkan peringatan pada file dengan kode sumber.  Ini adalah perilaku penganalisa yang benar, Anda tidak perlu mengubah apa pun, tetapi banyak peringatan dikeluarkan untuk makro!  Dan di belakang makro adalah kode yang tidak dapat dibaca. <br><a name="habracut"></a><br><h2>  Operator ternary tidak berfungsi seperti yang Anda pikirkan </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">V502</a> Mungkin <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">operator</a> '?:' Bekerja dengan cara yang berbeda dari yang diharapkan.  Operator '?:' Memiliki prioritas lebih rendah daripada operator '-'.  toke.c 9494 <br><br><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">STATIC </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">char</span></span></span><span class="hljs-function"> * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">S_scan_ident</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pTHX_ </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *s, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *dest, STRLEN destlen, I32 ck_uni)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((s &lt;= PL_bufend - (is_utf8) ? UTF8SKIP(s) : <span class="hljs-number"><span class="hljs-number">1</span></span>) &amp;&amp; VALID_LEN_ONE_IDENT(s, PL_bufend, is_utf8)) { .... } .... }</code> </pre> <br>  Mari kita mulai ulasan dengan kesalahan yang indah.  Setiap beberapa ulasan kode harus mengulangi bahwa operator ternary hampir memiliki prioritas terendah dalam komputasi. <br><br>  Pertimbangkan fragmen dengan kesalahan: <br><br><pre> <code class="cpp hljs">s &lt;= PL_bufend - (is_utf8) ? UTF8SKIP(s) : <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br>  Urutan operasi yang diharapkan oleh programmer: <ol><li>  ?: </li><li>  - </li><li>  &lt;= </li></ol><br>  Apa yang sebenarnya terjadi: <ol><li>  - </li><li>  &lt;= </li><li>  ?: </li></ol><br>  Simpan label dengan prioritas operasi: " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Prioritas operasi di C / C ++</a> ." <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">V502</a> Mungkin <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">operator</a> '?:' Bekerja dengan cara yang berbeda dari yang diharapkan.  Operator '?:' Memiliki prioritas lebih rendah daripada operator '=='.  re_exec.c 9193 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">STATIC I32 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">S_regrepeat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pTHX_ regexp *prog, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> **startposp, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> regnode *p, regmatch_info *</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> reginfo, I32 max _pDEPTH)</span></span></span><span class="hljs-function"> </span></span>{ .... assert(STR_LEN(p) == reginfo-&gt;is_utf8_pat ? UTF8SKIP(STRING(p)) : <span class="hljs-number"><span class="hljs-number">1</span></span>); .... }</code> </pre> <br>  Kode sederhana dengan kesalahan serupa.  Tetapi jika Anda tidak tahu prioritas operasi, maka Anda dapat membuat kesalahan dalam ekspresi ukuran berapa pun. <br><br>  Tempat lain dengan menegaskan: <br><br><ul><li>  V502 Mungkin operator '?:' Bekerja dengan cara yang berbeda dari yang diharapkan.  Operator '?:' Memiliki prioritas lebih rendah daripada operator '=='.  re_exec.c 9286 </li></ul><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">V502</a> Mungkin <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">operator</a> '?:' Bekerja dengan cara yang berbeda dari yang diharapkan.  Operator '?:' Memiliki prioritas lebih rendah daripada operator '&amp;&amp;'.  pp_hot.c 3036 <br><br><pre> <code class="cpp hljs">PP(pp_match) { .... MgBYTEPOS_set(mg, TARG, truebase, RXp_OFFS(prog)[<span class="hljs-number"><span class="hljs-number">0</span></span>].end); .... }</code> </pre> <br>  Dan inilah peringatan untuk makro ... Untuk memahami apa yang terjadi di sana, bahkan penerapan makro tidak akan membantu, karena menggunakan beberapa makro lagi! <br><br>  Oleh karena itu, saya lampirkan sebuah fragmen dari file yang telah diproses untuk baris kode ini: <br><br><pre> <code class="cpp hljs">(((targ)-&gt;sv_flags &amp; <span class="hljs-number"><span class="hljs-number">0x00000400</span></span>) &amp;&amp; (!((targ)-&gt;sv_flags &amp; <span class="hljs-number"><span class="hljs-number">0x00200000</span></span>) || S_sv_only_taint_gmagic(targ)) ? (mg)-&gt;mg_len = ((prog-&gt;offs)[<span class="hljs-number"><span class="hljs-number">0</span></span>].end), (mg)-&gt;mg_flags |= <span class="hljs-number"><span class="hljs-number">0x40</span></span> : ((mg)-&gt;mg_len = (((targ)-&gt;sv_flags &amp; <span class="hljs-number"><span class="hljs-number">0x20000000</span></span>) &amp;&amp; !__builtin_expect(((((PL_curcop)-&gt;cop_hints + <span class="hljs-number"><span class="hljs-number">0</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0x00000008</span></span>) ? (<span class="hljs-keyword"><span class="hljs-keyword">_Bool</span></span>)<span class="hljs-number"><span class="hljs-number">1</span></span> :(<span class="hljs-keyword"><span class="hljs-keyword">_Bool</span></span>)<span class="hljs-number"><span class="hljs-number">0</span></span>),(<span class="hljs-number"><span class="hljs-number">0</span></span>))) ? (<span class="hljs-keyword"><span class="hljs-keyword">ssize_t</span></span>)Perl_utf8_length( (U8 *)(truebase), (U8 *)(truebase)+((prog-&gt;offs)[<span class="hljs-number"><span class="hljs-number">0</span></span>].end)) : (<span class="hljs-keyword"><span class="hljs-keyword">ssize_t</span></span>)((prog-&gt;offs)[<span class="hljs-number"><span class="hljs-number">0</span></span>].end), (mg)-&gt;mg_flags &amp;= ~<span class="hljs-number"><span class="hljs-number">0x40</span></span>));</code> </pre> <br>  Di suatu tempat di sini, penganalisa meragukan penggunaan yang benar dari operator ternary (ada 3 dari mereka), tetapi saya tidak menemukan kekuatan untuk memahami apa yang sedang dilakukan dalam kode ini.  Kami telah melihat bahwa pengembang membuat kesalahan seperti itu, jadi di sini juga sangat mungkin terjadi. <br><br>  Tiga kegunaan lagi dari makro ini: <br><br><ul><li>  V502 Mungkin operator '?:' Bekerja dengan cara yang berbeda dari yang diharapkan.  Operator '?:' Memiliki prioritas lebih rendah daripada operator '&amp;&amp;'.  pp_ctl.c 324 </li><li>  V502 Mungkin operator '?:' Bekerja dengan cara yang berbeda dari yang diharapkan.  Operator '?:' Memiliki prioritas lebih rendah daripada operator '&amp;&amp;'.  regexec.c 7335 </li><li>  V502 Mungkin operator '?:' Bekerja dengan cara yang berbeda dari yang diharapkan.  Operator '?:' Memiliki prioritas lebih rendah daripada operator '&amp;&amp;'.  re_exec.c 7335 </li></ul><br>  <b>Catatan rekan Andrei Karpov.</b>  Saya merenungkan kode ini selama 10 menit dan saya cenderung percaya bahwa tidak ada kesalahan.  Tetapi bagaimanapun juga, sangat menyakitkan untuk membaca kode seperti itu, dan lebih baik tidak menulis seperti itu. <br><br><h2>  Kesalahan dalam kondisi </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">V523</a> Pernyataan 'lalu' sama dengan pernyataan 'lain'.  toke.c 12056 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> U8 * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">S_add_utf16_textfilter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pTHX_ U8 *</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> s, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> reversed)</span></span></span><span class="hljs-function"> </span></span>{ .... SvCUR_set(PL_linestr, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (FILTER_READ(<span class="hljs-number"><span class="hljs-number">0</span></span>, PL_linestr, <span class="hljs-number"><span class="hljs-number">0</span></span>)) { SvUTF8_on(PL_linestr); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { SvUTF8_on(PL_linestr); } PL_bufend = SvEND(PL_linestr); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (U8*)SvPVX(PL_linestr); }</code> </pre> <br>  Saya pikir Anda bisa melakukannya tanpa memeriksa isi makro untuk memastikan bahwa ada duplikat kode yang mencurigakan. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">V564</a> The '|'  operator diterapkan pada nilai tipe bool.  Anda mungkin lupa menyertakan tanda kurung atau bermaksud menggunakan '||'  operator.  op.c 11494 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">OP * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Perl_ck_rvconst</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pTHX_ OP *o)</span></span></span><span class="hljs-function"> </span></span>{ .... gv = gv_fetchsv(kidsv, o-&gt;op_type == OP_RV2CV &amp;&amp; o-&gt;op_private &amp; OPpMAY_RETURN_CONSTANT ? GV_NOEXPAND : iscv | !(kid-&gt;op_private &amp; OPpCONST_ENTERED), iscv <span class="hljs-comment"><span class="hljs-comment">// &lt;= ? SVt_PVCV : o-&gt;op_type == OP_RV2SV ? SVt_PV : o-&gt;op_type == OP_RV2AV ? SVt_PVAV : o-&gt;op_type == OP_RV2HV ? SVt_PVHV : SVt_PVGV); .... }</span></span></code> </pre> <br>  Kode yang sangat aneh  Ekspresi "iscv |  ! (kid-&gt; op_private &amp; OPpCONST_ENTERED) "tidak digunakan dengan cara apa pun.  Jelas ada kesalahan ketik di sini.  Sebagai contoh, mungkin Anda harus menulis di sini: <br><br><pre> <code class="cpp hljs">: iscv = !(kid-&gt;op_private &amp; OPpCONST_ENTERED), iscv <span class="hljs-comment"><span class="hljs-comment">// &lt;=</span></span></code> </pre> <br>  Ekspresi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">V547</a> 'RETVAL == 0' selalu benar.  Typemap.c 710 <br><br><pre> <code class="cpp hljs">XS_EUPXS(XS_XS__Typemap_T_SYSRET_pass); XS_EUPXS(XS_XS__Typemap_T_SYSRET_pass) { dVAR; dXSARGS; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (items != <span class="hljs-number"><span class="hljs-number">0</span></span>) croak_xs_usage(cv, <span class="hljs-string"><span class="hljs-string">""</span></span>); { SysRet RETVAL; <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">line</span></span></span><span class="hljs-meta"> 370 </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Typemap.xs"</span></span></span><span class="hljs-meta"> RETVAL = 0; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">line</span></span></span><span class="hljs-meta"> 706 </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Typemap.c"</span></span></span><span class="hljs-meta"> { SV * RETVALSV; RETVALSV = sv_newmortal(); </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (RETVAL != -1) { </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// &lt;= if (RETVAL == 0) // &lt;= sv_setpvn(RETVALSV, "0 but true", 10); else sv_setiv(RETVALSV, (IV)RETVAL); } ST(0) = RETVALSV; } } XSRETURN(1); }</span></span></span></span></code> </pre> <br>  Variabel <i>RETVAL</i> diperiksa dua kali berturut-turut.  Selain itu, dapat dilihat dari kode bahwa variabel ini selalu nol.  Mungkin dalam satu atau kedua kondisi mereka ingin memeriksa pointer <i>RETVALSV</i> , tetapi mereka membuat kesalahan ketik. <br><br><h2>  Melempar peringatan tentang ukuran operator </h2><br>  Ada beberapa jenis aturan diagnostik dalam penganalisa yang mencari kesalahan menggunakan operator <i>sizeof</i> .  Di proyek Perl 5, dua diagnostik ini menghasilkan total sekitar seribu peringatan.  Dalam hal ini, bukan penganalisa yang harus disalahkan, tetapi makro. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">V568</a> Aneh bahwa argumen operator sizeof () adalah ekspresi 'len + 1'.  util.c 1084 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">char</span></span></span><span class="hljs-function"> * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Perl_savepvn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pTHX_ </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *pv, I32 len)</span></span></span><span class="hljs-function"> </span></span>{ .... Newx(newaddr,len+<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>); .... }</code> </pre> <br>  Kode ini memiliki banyak makro yang mirip.  Saya memilih satu sebagai contoh, kami tertarik pada argumen "len + 1". <br><br>  Preprocessor makro berkembang menjadi kode berikut: <br><br><pre> <code class="cpp hljs">(newaddr = ((<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)(__builtin_expect(((((( <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span>) &lt; <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(len+<span class="hljs-number"><span class="hljs-number">1</span></span>) || <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>) &gt; ((<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span>)<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span>*(<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span>) - <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(len+<span class="hljs-number"><span class="hljs-number">1</span></span>)))) ? (<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span>)(len+<span class="hljs-number"><span class="hljs-number">1</span></span>) : ((<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span>)<span class="hljs-number"><span class="hljs-number">-1</span></span>)/<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>)) &gt; ((<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span>)<span class="hljs-number"><span class="hljs-number">-1</span></span>)/<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>))) ? (<span class="hljs-keyword"><span class="hljs-keyword">_Bool</span></span>)<span class="hljs-number"><span class="hljs-number">1</span></span> : (<span class="hljs-keyword"><span class="hljs-keyword">_Bool</span></span>)<span class="hljs-number"><span class="hljs-number">0</span></span>),(<span class="hljs-number"><span class="hljs-number">0</span></span>)) &amp;&amp; (S_croak_memory_wrap(),<span class="hljs-number"><span class="hljs-number">0</span></span>)), (<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>*)(Perl_safesysmalloc((<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span>)((len+<span class="hljs-number"><span class="hljs-number">1</span></span>)*<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>))))));</code> </pre> <br>  Peringatan analisa dikeluarkan untuk <i>ukuran (len +1)</i> konstruksi.  Faktanya adalah bahwa tidak ada perhitungan yang dibuat dalam argumen <i>ukuran</i> operator.  Banyak makro diperluas ke kode serupa.  Ini mungkin kode warisan lama di mana tidak ada yang mau menyentuh apa pun, tetapi pengembang saat ini terus menggunakan makro lama, menunjukkan perilaku mereka yang berbeda. <br><br><h2>  <i>Dereferencing null pointer</i> </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">V522 Dereferencing</a> dari pointer nol 'sv' mungkin terjadi.  pp_ctl.c 577 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">OP * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Perl_pp_formline</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ .... SV *sv = ((<span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *)<span class="hljs-number"><span class="hljs-number">0</span></span>); .... <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (*fpc++) { .... <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>: arg = *fpc++; f += arg; fieldsize = arg; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mark &lt; sp) sv = *++mark; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { sv = &amp;(PL_sv_immortals[<span class="hljs-number"><span class="hljs-number">2</span></span>]); Perl_ck_warner( (<span class="hljs-number"><span class="hljs-number">28</span></span> ), <span class="hljs-string"><span class="hljs-string">"...."</span></span>); } .... <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>: { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *s = item = ((((sv)-&gt;sv_flags &amp; (....)) == <span class="hljs-number"><span class="hljs-number">0x00000400</span></span>) ? .... .... } .... }</code> </pre> <br>  Fragmen kode ini sepenuhnya diambil dari file pracroses, karena tidak mungkin untuk memverifikasi keberadaan masalah dari file sumber, sekali lagi karena makro. <br><br>  Pointer <i>sv</i> diinisialisasi ke nol setelah deklarasi.  Penganalisa menemukan bahwa ketika melewati <i>5</i> dalam <i>pernyataan switch</i> , pointer ini dereferenced, yang tidak pernah diinisialisasi sebelumnya.  Perubahan dalam pointer <i>sv</i> hadir di cabang dengan nilai <i>4</i> , tetapi pada akhir blok kode ini adalah pernyataan <i>break</i> .  Kemungkinan besar, kode tambahan diperlukan di tempat ini. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">V595 Pointer</a> 'k' digunakan sebelum diverifikasi terhadap nullptr.  Periksa baris: 15919, 15920. op.c 15919 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Perl_rpeep</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pTHX_ OP *o)</span></span></span><span class="hljs-function"> </span></span>{ .... OP *k = o-&gt;op_next; U8 want = (k-&gt;op_flags &amp; OPf_WANT); <span class="hljs-comment"><span class="hljs-comment">// &lt;= if ( k // &lt;= &amp;&amp; k-&gt;op_type == OP_KEYS &amp;&amp; ( want == OPf_WANT_VOID || want == OPf_WANT_SCALAR) &amp;&amp; !(k-&gt;op_private &amp; OPpMAYBE_LVSUB) &amp;&amp; !(k-&gt;op_flags &amp; OPf_MOD) ) { .... }</span></span></code> </pre> <br>  Dalam cuplikan kode ini, penganalisa menemukan pointer <i>k</i> , yang mendereferensi satu baris lebih awal dari pemeriksaan validitasnya.  Ini bisa berupa kesalahan atau kode tambahan. <br><br>  Diagnostik <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">V595</a> menemukan banyak peringatan dalam proyek apa pun, Perl 5 tidak terkecuali.  Tidak mungkin untuk memasukkan semua ini ke dalam artikel, oleh karena itu kami akan membatasi diri pada satu contoh, dan pengembang akan memeriksa proyek sendiri jika mereka mau. <br><br><h2>  Lain-lain </h2><br>  V779 Kode tidak terjangkau terdeteksi.  Mungkin saja ada kesalahan.  universal.c 457 <br><br><pre> <code class="cpp hljs">XS(XS_utf8_valid); XS(XS_utf8_valid) { dXSARGS; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (items != <span class="hljs-number"><span class="hljs-number">1</span></span>) croak_xs_usage(cv, <span class="hljs-string"><span class="hljs-string">"sv"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { SV * <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> sv = ST(<span class="hljs-number"><span class="hljs-number">0</span></span>); STRLEN len; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> s = SvPV_const(sv,len); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!SvUTF8(sv) || is_utf8_string((<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> U8*)s,len)) XSRETURN_YES; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> XSRETURN_NO; } XSRETURN_EMPTY; }</code> </pre> <br>  Pada baris dengan <i>XSRETURN_EMPTY,</i> alat analisa mendeteksi kode yang tidak dapat dijangkau.  Ada dua <i>pernyataan pengembalian</i> dalam fungsi ini dan <i>croak_xs_usage</i> - makro yang diperluas ke fungsi noreturn: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Perl_croak_xs_usage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> CV *</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> cv, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> params)</span></span></span><span class="hljs-function"> __</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">attribute__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">((noreturn))</span></span></span></span>;</code> </pre> <br>  Di tempat-tempat serupa dalam kode Perl 5, makro <i>NOT_REACHED</i> digunakan untuk menunjukkan cabang yang tidak terjangkau. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">V784</a> Ukuran bit mask kurang dari ukuran operan pertama.  Ini akan menyebabkan hilangnya bit yang lebih tinggi.  inffast.c 296 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> ZLIB_INTERNAL </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">inflate_fast</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(z_streamp strm, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> start)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> hold; <span class="hljs-comment"><span class="hljs-comment">/* local strm-&gt;hold */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> bits; <span class="hljs-comment"><span class="hljs-comment">/* local strm-&gt;bits */</span></span> .... hold &amp;= (<span class="hljs-number"><span class="hljs-number">1U</span></span> &lt;&lt; bits) - <span class="hljs-number"><span class="hljs-number">1</span></span>; .... }</code> </pre> <br>  Penganalisis mendeteksi operasi yang mencurigakan saat bekerja dengan topeng bit.  Sebagai bitmask, variabel resolusi lebih rendah digunakan daripada variabel <i>holding</i> .  Ini menghasilkan hilangnya bit tinggi.  Pengembang harus memperhatikan kode ini. <br><br><h2>  Kesimpulan </h2><br><p><img src="https://habrastorage.org/getpro/habr/post_images/a9e/e0d/a01/a9ee0da01644c5db03e6d93f79cab705.png" alt="Gambar 6"></p><br><br>  Menemukan kesalahan melalui makro sangat sulit.  Melihat laporan itu membutuhkan banyak waktu dan upaya.  Namun demikian, artikel tersebut memuat kasus-kasus yang sangat menarik yang mirip dengan kesalahan nyata.  Laporan analisa cukup besar, pasti ada jauh lebih menarik di sana.  Tapi saya tidak bisa melihatnya lebih jauh :).  Saya menyarankan pengembang untuk memeriksa proyek sendiri dan menghilangkan cacat yang akan dapat mereka deteksi. <br><br>  PS Kami pasti ingin mendukung proyek yang menarik ini, dan kami siap memberikan pengembang dengan lisensi selama beberapa bulan. <br><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><img src="https://habrastorage.org/webt/ts/z9/km/tsz9kmyjtteajhd4x1au60rsrvq.png" align="left"></a> </p><br><br>  Jika Anda ingin berbagi artikel ini dengan audiens yang berbahasa Inggris, silakan gunakan tautan ke terjemahan: Svyatoslav Razmyslov.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Perl 5: Cara Menyembunyikan Kesalahan di Macro</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id425415/">https://habr.com/ru/post/id425415/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id425405/index.html">Newtype kekuatan besar</a></li>
<li><a href="../id425407/index.html">Firecore - gim seru di AVR</a></li>
<li><a href="../id425409/index.html">DevBoy: membuat generator sinyal</a></li>
<li><a href="../id425411/index.html">Scrum sudah mati</a></li>
<li><a href="../id425413/index.html">Apakah joon sangat baik?</a></li>
<li><a href="../id425417/index.html">Flash untuk semua orang. Semua Flash Array dari QSAN</a></li>
<li><a href="../id425419/index.html">Penulis The Witcher menuntut minimum $ 16 juta dari CD Projekt Red</a></li>
<li><a href="../id425421/index.html">Jumat Ocehan seorang programmer</a></li>
<li><a href="../id425423/index.html">Untuk pertanyaan para panda atau tangisan Yaroslavna berikutnya</a></li>
<li><a href="../id425425/index.html">Tinjauan Paket R untuk Pemasaran Internet, Bagian 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>