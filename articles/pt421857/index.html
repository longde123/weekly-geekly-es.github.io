<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßõüèΩ üåö üõê ToFoIn v 1. Reserva de gateways e altern√¢ncia entre canais externos no FreeBSD üî• üò° üöï</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Anota√ß√£o 
 Em um artigo anterior, a organiza√ß√£o da redund√¢ncia para gateways da LAN foi considerada. Como solu√ß√£o, foi proposto um script que naquele ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ToFoIn v 1. Reserva de gateways e altern√¢ncia entre canais externos no FreeBSD</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/421857/"><h3>  Anota√ß√£o </h3><br>  Em um artigo anterior, a organiza√ß√£o da redund√¢ncia para gateways da LAN foi considerada.  Como solu√ß√£o, foi proposto um script que naquele momento solucionava o problema, mas apresentava v√°rias desvantagens.  Depois de algum tempo, acabou eliminando essas defici√™ncias, reescrevendo parcialmente o c√≥digo e obtendo algo aceit√°vel na sa√≠da.  Agora podemos dizer que os scripts foram testados o suficiente para serem chamados de est√°veis.  Para simplificar o entendimento de todo o sistema, os principais pontos para a configura√ß√£o de servi√ßos secund√°rios (em termos do t√≥pico do artigo) ser√£o parcialmente duplicados abaixo.  O motivo √© simples - durante esse per√≠odo, as regras do ipfw tamb√©m foram reformuladas, o dns passou a viver no AD no Samba4 com um frontend de liga√ß√£o e registros atualizados com seguran√ßa do isc-dhcpd usando kerberos, bem como servidores DNS secund√°rios, como o bind nos gateways, CARP configurado ... Em geral, tornou-se muito mais interessante, mas mais sobre o que e como ele funciona est√° abaixo.  Tudo o que pode ser dado com refer√™ncias √† fonte ser√° projetado de maneira a n√£o produzir ess√™ncia.  O que foi retirado de outros lugares, mas que n√£o est√° mais dispon√≠vel, ser√° fornecido aqui com coment√°rios relevantes. <br><a name="habracut"></a><br><h3>  1. Introdu√ß√£o </h3><br>  Portanto, existem duas maneiras de aumentar a imunidade a ru√≠dos do canal de comunica√ß√£o com o mundo externo por parte do consumidor: backup do gateway e reserva do ponto de conex√£o.  Em outras palavras, no primeiro caso, √© configurado um segundo gateway, que ser√° ativado se o primeiro falhar; no segundo caso, um canal de Internet de backup ser√° organizado em caso de problemas com o principal, e quanto mais eles cruzarem, melhor, obviamente.  Se o <abbr title="Protocolo de redund√¢ncia de endere√ßo comum">CARP</abbr> resolver a primeira tarefa do FreeBSD, a segunda, depois de organizar o segundo canal externo, poder√°, novamente, ser resolvida de v√°rias maneiras.  No m√≠nimo, voc√™ pode organizar o balanceamento de tr√°fego ou alternar entre canais.  Devido √† grande diferen√ßa na largura de banda dos canais externos, a primeira op√ß√£o n√£o me <abbr title="Toogle Failover da Internet">agradou</abbr> ; portanto, o principal culpado da publica√ß√£o foi escrito: <abbr title="Toogle Failover da Internet">ToFoIn</abbr> - um conjunto de scripts bash que visa solucionar problemas de diagn√≥stico e mudar para um canal externo em funcionamento.  Ap√≥s o refinamento, pode ser aplicado a n gateways e m canais.  A situa√ß√£o √© fraca, onde n e m s√£o maiores que 2, mas os scripts abaixo devem trabalhar com grandes valores de n e m, porque  Logicamente, o limite n√£o est√° definido.  Em geral, suspeito que, usando esses scripts, √© poss√≠vel resolver uma ampla gama de tarefas, dependendo do status da conex√£o, limitada, talvez apenas pela imagina√ß√£o. <br><br><img src="https://habrastorage.org/webt/2e/yw/s8/2eyws8o9hbu3cxfpo0yja6dm_ea.png" width="500" align="left"><br>  Aproximadamente, essa topologia de rede assume da forma mais simples o uso de um conjunto de scripts ToFoIn.  Obviamente, os scripts devem funcionar no caso de um √∫nico roteador, mas nesse caso, voc√™ precisar√° alterar fortemente o m√≥dulo Daemon para remover a depend√™ncia da sequ√™ncia de a√ß√µes no estado CARP, que simplesmente estar√° ausente no sistema.  A reserva adicional desses e de outros n√≥s depende apenas do grau de import√¢ncia dos servi√ßos correspondentes. <br><br><h3>  Metas e objetivos </h3><br>  O objetivo do projeto, como antes, √© criar um pacote de software universal e facilmente escal√°vel, focado na identifica√ß√£o de problemas em conex√µes externas e internas e na mudan√ßa autom√°tica para conex√µes vi√°veis.  Em termos gerais, a l√≥gica √© a seguinte: <br><br><ul><li>  Existem n "roteadores" com m canais externos em cada um.  Al√©m disso, todos os n "roteadores" est√£o em uma hierarquia estrita e s√£o conectados entre si usando o CARP em todas as interfaces necess√°rias. </li><li>  Um agente trabalha independentemente em cada m√°quina, cuja tarefa √© baseada no status atual do CARP de sua m√°quina: <br><ul><li>  Se fizer backup - detecte e configure a m√°quina em um roteador que atualmente √© o mestre; </li><li>  Se mestre - verifique o status das conex√µes no momento atual e, se necess√°rio, alterne entre canais externos. </li></ul></li></ul><br><h3>  Solu√ß√£o </h3><br>  A rede interna possui o CARP, que fornece gateways de backup e permite que voc√™ n√£o altere as configura√ß√µes de outros dispositivos de rede na rede interna ao trocar de canal. <br><br>  O dhcpd opera no modo prim√°rio - secund√°rio e, em geral, n√£o importa quais outros pap√©is sua m√°quina desempenha - a conex√£o entre o dhcpd ocorre na rede interna, para a qual os roteadores sempre olham. <br><br>  A liga√ß√£o mestre √© removida no AD, que est√° oculto na rede local, enquanto os servidores de liga√ß√£o secund√°ria est√£o trabalhando nos roteadores de gateway em p√© de igualdade. <br><br>  As regras do ipfw diferem dependendo de qual canal √© considerado o canal principal em um determinado momento e s√£o reiniciadas pelo m√≥dulo Daemon ao alterar as fun√ß√µes. <br><br>  Finalmente, sobre os pr√≥prios scripts.  Agora, os arquivos est√£o localizados nos diret√≥rios apropriados, funcionam com o usu√°rio e t√™m um script de in√≠cio no rc.d.  Tarefas que requerem acesso root s√£o resolvidas pelo sudo.  H√° um script de instala√ß√£o que leva em considera√ß√£o a poss√≠vel presen√ßa de uma vers√£o instalada, bem como um arquivo de configura√ß√µes bastante detalhado.  Os m√≥dulos s√£o os mesmos com pequenas altera√ß√µes, algumas quase n√£o mudaram na funcionalidade: <br><br>  <b>Daemon</b> - como o nome indica - √© o processo principal que executa os m√≥dulos de teste e comuta√ß√£o em um timer e tamb√©m monitora o CARP. <br>  <b>Testador</b> - ainda testa comunica√ß√µes externas usando o comando ping.  (se estiver em execu√ß√£o, considera que a m√°quina possui CARP no estado mestre) <br>  <b>Juiz</b> - com base nos resultados do teste, determina qual canal externo funciona e se a comuta√ß√£o √© necess√°ria, realiza a comuta√ß√£o (se estiver em execu√ß√£o, considera que a m√°quina possui CARP no estado Mestre). <br>  <b>Scout</b> √© um novo m√≥dulo.  Inicia quando o CARP est√° no estado Backup.  √â necess√°rio determinar qual dos roteadores restantes √© atualmente o principal. <br>  <b>Logger</b> - respons√°vel pelo log de eventos.  √â necess√°rio que as informa√ß√µes sobre os eventos n√£o sejam duplicadas e a revista seja mais f√°cil de ler. <br>  <b>Watchdog</b> - √© executado dentro do cronograma do crontab.  Ele determina os "congelamentos" de todos os m√≥dulos e (sempre que poss√≠vel) tenta resolver os problemas que surgiram.  I.e.  pregue todo mundo, basta colocar. <br><br>  Al√©m dos pr√≥prios scripts, vale a pena considerar alguns arquivos mais importantes: <br><br>  <b>Tofoin.conf</b> - um √∫nico arquivo de configura√ß√µes. <br>  <b>Tofoin.log</b> - um √∫nico arquivo de log de eventos. <br>  <b>Resultado_</b> &lt;n√∫mero interno do canal&gt; √© o arquivo de trabalho, os resultados do teste s√£o adicionados aqui, criados em / tmp ao lado de .pid e outros arquivos de trabalho. <br><br>  Posso responder com prazer as perguntas sobre o funcionamento dos m√≥dulos, explicando as solu√ß√µes nos coment√°rios. <br><br><h3>  Parte t√©cnica </h3><br><h4>  Equipamento </h4><br>  Comparado com o tempo anterior, os gateways passaram para o P4, receberam 1536 Mb de RAM e tr√™s HDs de 40 Gb (espelho + sobressalente).  As placas de rede ainda s√£o PCI, as PSUs s√£o normais, naturalmente na presen√ßa de um no-break. <br>  O aumento da capacidade est√° associado ao ferro liberado e a atualiza√ß√µes excessivamente entediantes da fonte, mas principalmente o primeiro.  OS FreeBSD 11.1, FS zfs. <br><br><h4>  Configura√ß√µes dos componentes do sistema </h4><br><div class="spoiler">  <b class="spoiler_title">Mais detalhes</b> <div class="spoiler_text">  O kernel √© compilado com esses par√¢metros adicionais (algo tamb√©m pode ser definido no carregador, mas √© melhor assim): <br><br><pre><code class="bash hljs">options IPFIREWALL <span class="hljs-comment"><span class="hljs-comment"># ipfw firewall options IPFIREWALL_VERBOSE options IPFIREWALL_VERBOSE_LIMIT=50 options IPFIREWALL_NAT options LIBALIAS options DUMMYNET options HZ=1000 options ROUTETABLES=4 options KSTACK_PAGES=4 options KVA_PAGES=512 device carp</span></span></code> </pre> <br>  Configura√ß√µes /boot/loader.conf: <br><pre> <code class="bash hljs">geom_mirror_load=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> zfs_load=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> kern.geom.label.gptid.enable=<span class="hljs-string"><span class="hljs-string">"0"</span></span> vm.kmem_size=<span class="hljs-string"><span class="hljs-string">"1024M"</span></span> vm.kmem_size_max=<span class="hljs-string"><span class="hljs-string">"1024M"</span></span> vfs.zfs.arc_max=<span class="hljs-string"><span class="hljs-string">"512M"</span></span> vfs.zfs.vdev.cache.size=<span class="hljs-string"><span class="hljs-string">"30M"</span></span> vfs.zfs.prefetch_disable=1 kern.vty=vt</code> </pre> <br>  Configura√ß√µes /etc/rc.conf na primeira m√°quina (a configura√ß√£o do CARP √© do principal interesse): <br><pre> <code class="bash hljs">ifconfig_eth0=<span class="hljs-string"><span class="hljs-string">"up"</span></span> vlans_eth0=<span class="hljs-string"><span class="hljs-string">"vlan111 vlan222"</span></span> create_args_vlan111=<span class="hljs-string"><span class="hljs-string">"vlan 111"</span></span> create_args_vlan222=<span class="hljs-string"><span class="hljs-string">"vlan 222"</span></span> ifconfig_eth1=<span class="hljs-string"><span class="hljs-string">"up"</span></span> vlans_eth1=<span class="hljs-string"><span class="hljs-string">"vlan333 vlan444 vlan555"</span></span> create_args_vlan333=<span class="hljs-string"><span class="hljs-string">"vlan 333"</span></span> create_args_vlan444=<span class="hljs-string"><span class="hljs-string">"vlan 444"</span></span> create_args_vlan555=<span class="hljs-string"><span class="hljs-string">"vlan 555"</span></span> ifconfig_eth2=<span class="hljs-string"><span class="hljs-string">"up"</span></span> vlans_eth2=<span class="hljs-string"><span class="hljs-string">"vlan666 vlan777 vlan888"</span></span> create_args_vlan666=<span class="hljs-string"><span class="hljs-string">"vlan 666"</span></span> create_args_vlan777=<span class="hljs-string"><span class="hljs-string">"vlan 777"</span></span> create_args_vlan888=<span class="hljs-string"><span class="hljs-string">"vlan 888"</span></span> ifconfig_vlan666=<span class="hljs-string"><span class="hljs-string">"inet 192.168.0.1/24"</span></span> ifconfig_vlan666_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 100 pass MyPassword alias 192.168.0.5/32"</span></span> ifconfig_vlan777=<span class="hljs-string"><span class="hljs-string">"inet 192.168.1.1/24"</span></span> ifconfig_vlan777_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 100 pass MyPassword alias 192.168.1.5/32"</span></span> ifconfig_vlan888=<span class="hljs-string"><span class="hljs-string">"inet 192.168.2.1/24"</span></span> ifconfig_vlan888_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 100 pass MyPassword alias 192.168.2.5/32"</span></span> ifconfig_vlan111=<span class="hljs-string"><span class="hljs-string">"inet 192.168.3.1/30"</span></span> ifconfig_vlan111_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 100 pass MyPassword alias 1.1.1.2/24"</span></span> ifconfig_vlan222=<span class="hljs-string"><span class="hljs-string">"inet 192.168.4.1/30"</span></span> ifconfig_vlan333=<span class="hljs-string"><span class="hljs-string">"inet 192.168.5.1/30"</span></span> ifconfig_vlan333_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 100 pass MyPassword alias 2.2.2.2/30"</span></span> ifconfig_vlan444=<span class="hljs-string"><span class="hljs-string">"inet 192.168.6.1/30"</span></span> ifconfig_vlan444_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 100 pass MyPassword alias 3.3.3.2/30"</span></span> ifconfig_vlan555=<span class="hljs-string"><span class="hljs-string">"inet 192.168.7.1/30"</span></span> defaultrouter=<span class="hljs-string"><span class="hljs-string">"1.1.1.1"</span></span> setfib1_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> setfib1_defaultrouter=<span class="hljs-string"><span class="hljs-string">"3.3.3.1"</span></span> setfib2_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> setfib2_defaultrouter=<span class="hljs-string"><span class="hljs-string">"2.2.2.1"</span></span> zfs_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> named_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> dhcpd_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> firewall_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> firewall_logging=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> firewall_script=<span class="hljs-string"><span class="hljs-string">"/etc/firewall.sh"</span></span> gateway_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> tofoin_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span></code> </pre> <br>  <i>Legenda:</i> <i><br></i>  <i>eth0, eth1, eth2 - adaptadores f√≠sicos</i> <i><br></i>  <i>vlan666, vlan777, vlan888 - adaptadores de LAN virtual,</i> <i><br></i>  <i>vlan222 e vlan555 - adaptadores para comunica√ß√£o redundante entre placas de rede externas (elas podem n√£o ser mais necess√°rias, eram ativamente usadas anteriormente)</i> <i><br></i>  <i>vlan111 - o principal canal externo</i> <i><br></i>  <i>vlan444 - canal externo de backup</i> <i><br></i>  <i>vlan333 - telefonia</i> <br>  Configura√ß√µes /etc/rc.conf na segunda m√°quina (a configura√ß√£o do CARP √© do interesse principal, algumas das linhas duplicadas s√£o removidas): <br><pre> <code class="bash hljs">ifconfig_vlan666=<span class="hljs-string"><span class="hljs-string">"inet 192.168.0.2/24"</span></span> ifconfig_vlan666_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 0 pass MyPassword alias 192.168.0.5/32"</span></span> ifconfig_vlan777=<span class="hljs-string"><span class="hljs-string">"inet 192.168.1.2/24"</span></span> ifconfig_vlan777_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 0 pass MyPassword alias 192.168.1.5/32"</span></span> ifconfig_vlan888=<span class="hljs-string"><span class="hljs-string">"inet 192.168.2.2/24"</span></span> ifconfig_vlan888_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 0 pass MyPassword alias 192.168.2.5/32"</span></span> ifconfig_vlan111=<span class="hljs-string"><span class="hljs-string">"inet 192.168.3.2/30"</span></span> ifconfig_vlan111_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 0 pass MyPassword alias 1.1.1.2/24"</span></span> ifconfig_vlan222=<span class="hljs-string"><span class="hljs-string">"inet 192.168.4.2/30"</span></span> ifconfig_vlan333=<span class="hljs-string"><span class="hljs-string">"inet 192.168.5.2/30"</span></span> ifconfig_vlan333_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 0 pass MyPassword alias 2.2.2.2/30"</span></span> ifconfig_vlan444=<span class="hljs-string"><span class="hljs-string">"inet 192.168.6.2/30"</span></span> ifconfig_vlan444_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 0 pass MyPassword alias 3.3.3.2/30"</span></span> ifconfig_vlan555=<span class="hljs-string"><span class="hljs-string">"inet 192.168.7.2/30"</span></span> defaultrouter=<span class="hljs-string"><span class="hljs-string">"1.1.1.1"</span></span> setfib1_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> setfib1_defaultrouter=<span class="hljs-string"><span class="hljs-string">"3.3.3.1"</span></span> setfib2_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> setfib2_defaultrouter=<span class="hljs-string"><span class="hljs-string">"2.2.2.1"</span></span></code> </pre> <br>  Algumas regras que s√£o √∫teis ao configurar o ipfw (nat) s√£o: <br>  Para permitir tr√°fego CARP: <br><pre> <code class="bash hljs">/sbin/ipfw -q add allow carp from any to any</code> </pre> <br>  "Nuclear" nat: <br><pre> <code class="bash hljs">/sbin/ipfw -q nat 1 config <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> ip vlan111 reset same_ports deny_in unreg_only /sbin/ipfw -q add nat 1 ip from any to any <span class="hljs-keyword"><span class="hljs-keyword">in</span></span></code> </pre> <br>  Usando tabelas de roteamento espec√≠ficas com adaptadores espec√≠ficos: <br><pre> <code class="bash hljs">/sbin/ipfw -q add setfib 0 all from any to any via vlan666</code> </pre> <br>  Em geral, eu poderia escrever um artigo separado sobre as configura√ß√µes do ipfw que usei, mas isso √© outra hora. <br></div></div><br><h4>  Software de terceiros </h4><br><div class="spoiler">  <b class="spoiler_title">Mais detalhes</b> <div class="spoiler_text">  Como √© necess√°rio trabalhar simultaneamente com dois ou mais canais externos, √© conveniente ter v√°rias tabelas de roteamento, uma para cada canal.  E seria bom se essas tabelas fossem criadas na pr√≥pria inicializa√ß√£o.  O script rc.d setfib ajudar√°.  A l√≥gica usada no ToFoIn assume que o nome do arquivo (setfib1, setfib2 etc.) corresponde ao n√∫mero da tabela na qual um √∫nico script adiciona uma rota padr√£o.  A tabela por padr√£o tem o n√∫mero "0". <br>  Os servidores DNS com o Bind na fun√ß√£o principal funcionam no modo secund√°rio, o principal √© o samba4 + bind, oculto na rede local.  A configura√ß√£o da liga√ß√£o secund√°ria √© muito bem revelada no livro "DNS e BIND" de Cricket Lee e Paul Albitz.  N√£o lembro de nenhum requisito especial que leve em considera√ß√£o o uso do samba4 para servidores secund√°rios e n√£o os mencionei no arquivo de configura√ß√µes.  A menos que, para diferentes canais da Internet, voc√™ precise criar 2 arquivos diferentes, que ser√£o copiados pelo script ToFoIn para o local a partir do qual o pr√≥prio v√≠nculo o ler√°.  Isso se deve ao fato de que, ao especificar os endere√ßos dos servidores DNS de ambos os provedores no mesmo arquivo, levando em considera√ß√£o que o bind funciona com apenas uma tabela de roteamento, surge um problema com rela√ß√£o √† resolu√ß√£o de endere√ßos de servidores upstream inacess√≠veis em um determinado momento. <br>  Failover isc-dhcpd.  Dhcpd n√£o √© essencial para o ToFoIn; al√©m disso, sua aus√™ncia n√£o afetar√° os scripts; no entanto, como me parece, √© bastante l√≥gico colocar servidores dhcp em gateways e a pergunta de failover ainda surge.  E aqui, comparado √† √∫ltima vez, ficou mais interessante ... Al√©m das configura√ß√µes necess√°rias para o failover, que descrevi na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">√∫ltima vez</a> (o in√≠cio da se√ß√£o "predefinida" dentro do menu suspenso). <br>  Voc√™ tamb√©m precisar√° de um script para atualizar com seguran√ßa os registros DNS no AD usando o samba4.  O pr√≥prio servidor samba4 deve ser instalado.  A instala√ß√£o e o lan√ßamento n√£o s√£o necess√°rios, estamos interessados ‚Äã‚Äãapenas nas ferramentas de gerenciamento que acompanham o kit.  Quem desejar pode encontrar outras informa√ß√µes na se√ß√£o "DHCP com atualiza√ß√µes din√¢micas de DNS" <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">em</a> . <br>  Parece assustador, mas funciona. <br>  Neste com a configura√ß√£o do software de terceiros est√° conclu√≠da. <br></div></div><br><h4>  Um pouco sobre ToFoIn </h4><br>  Todo o texto do projeto, juntamente com o script de instala√ß√£o, est√° dispon√≠vel no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">gitlab</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Em conclus√£o, um exemplo de par√¢metros do arquivo de configura√ß√µes do ToFoIn √© considerado:</b> <div class="spoiler_text">  O n√∫mero de roteadores usados ‚Äã‚Äãno sistema: <br><pre> <code class="bash hljs">RNUMBER=2</code> </pre> <br>  Ao usar sub-redes adicionais, voc√™ deve definir uma rota padr√£o quando o roteador se tornar o principal.  Aqui voc√™ pode especificar o n√∫mero do arquivo setfib correspondente que ser√° reiniciado.  Neste exemplo, setfib2: <br><pre> <code class="bash hljs">ADDITLAN=2</code> </pre> <br>  Nome do adaptador interno: <br><pre> <code class="bash hljs">INT_IF=vlan666</code> </pre> <br>  Todas as outras interfaces nas quais os roteadores est√£o conectados via CARP.  Necess√°rio para controlar e manter o mesmo estado de todas as interfaces: <br><pre> <code class="bash hljs">ALL_IF=<span class="hljs-string"><span class="hljs-string">"vlan111 vlan333 vlan444 vlan666 vlan777 vlan888"</span></span></code> </pre> <br>  O que foi usado ao configurar o CARP: <br><pre> <code class="bash hljs">CARP_VHID=1</code> </pre> <br>  Os endere√ßos IP na rede interna de outros roteadores em ordem de import√¢ncia, se necess√°rio, s√£o usados ‚Äã‚Äãsimplesmente ASERV_IP_2, ASERV_IP_3, etc. <br><pre> <code class="bash hljs">ASERV_IP_1=192.168.0.2</code> </pre> <br>  N√∫mero de canais de conex√£o externa: <br><pre> <code class="bash hljs">CNUMBER=2</code> </pre> <br>  Configura√ß√µes para o principal canal de conex√£o externa: <br>  Nome do adaptador: <br><pre> <code class="bash hljs">EXT_0_IF=vlan111</code> </pre> <br>  N√∫mero da tabela de roteamento: <br><pre> <code class="bash hljs">RTABLE_0=0</code> </pre> <br>  Gateway padr√£o: <br><pre> <code class="bash hljs">DEFAULT_GATEWAY=2.2.2.1</code> </pre> <br>  Configura√ß√µes para o canal de conex√£o externa de backup: <br>  Nome do adaptador: <br><pre> <code class="bash hljs">EXT_1_IF=vlan444</code> </pre> <br>  N√∫mero da tabela de roteamento: <br><pre> <code class="bash hljs">RTABLE_1=1</code> </pre> <br>  Um gateway padr√£o n√£o √© necess√°rio, porque para todas as tabelas de roteamento, exceto a principal, √© usado o script rc.d setfib &lt;n√∫mero da tabela&gt;, que, como sup√µe a l√≥gica, deve corresponder ao n√∫mero da tabela. <br>  Par√¢metros do m√≥dulo testador: <br>  O n√∫mero de endere√ßos a serem verificados: <br><pre> <code class="bash hljs">TNUMBER=2</code> </pre> <br>  Endere√ßos das m√°quinas pelas quais as solicita√ß√µes de ping s√£o enviadas.  √â melhor usar o nome de dom√≠nio no primeiro caso e somente depois o endere√ßo IP: <br><pre> <code class="bash hljs">PTARGET_0=ya.ru PTARGET_1=8.8.8.8</code> </pre> <br>  O n√∫mero de pacotes de ping enviados por destino: <br><pre> <code class="bash hljs">PNUMBER=2</code> </pre> <br>  Configura√ß√µes do m√≥dulo de juiz <br>  O n√∫mero de testes bem-sucedidos do canal principal antes de retornar a ele.  O tempo de retorno ao canal principal ap√≥s o rein√≠cio de sua opera√ß√£o √© calculado aproximadamente pela f√≥rmula: (WNUMBER + 1) * JUDGEPERIOD segundos. <br><pre> <code class="bash hljs">WNUMBER=3</code> </pre> <br>  Configura√ß√µes do m√≥dulo de logger <br>  Esses 2 par√¢metros indicam com que frequ√™ncia o Agente de Log registrar√° eventos recorrentes.  Ap√≥s registrar o evento, na pr√≥xima vez que o n√∫mero de tentativas do LOGFREQ1 for relatado, LOGFREQ2 ser√° o n√∫mero de tentativas.  Somente eventos consecutivos s√£o levados em considera√ß√£o. <br><pre> <code class="bash hljs">LOGFREQ1=5 LOGFREQ2=20</code> </pre> <br>  Temporizadores de in√≠cio do m√≥dulo em segundos <br>  O per√≠odo de lan√ßamento do m√≥dulo Testador.  Faz sentido confiar no tempo de tentativas fracassadas de testar todos os destinos. <br><pre> <code class="bash hljs">TESTERPERIOD=240</code> </pre> <br>  O per√≠odo de lan√ßamento do m√≥dulo Juiz.  N√£o instale menos que TESTERPERIOD. <br><pre> <code class="bash hljs">JUDGEPERIOD=300</code> </pre> <br>  O per√≠odo de lan√ßamento do m√≥dulo Scout. <br><pre> <code class="bash hljs">SCOUTPERIOD=360</code> </pre> <br>  O per√≠odo de espera antes de verificar os cron√¥metros de in√≠cio dos m√≥dulos Testador e Juiz.  √â l√≥gico definir menor ou igual ao valor de TESTERPERIOD. <br><pre> <code class="bash hljs">SENSITIVITY=60</code> </pre> <br>  O tempo ap√≥s o qual um m√≥dulo de trabalho √© considerado pendurado.  Usado pelo m√≥dulo Watchdog. <br><pre> <code class="bash hljs">TESTERLIMIT=40 JUDGELIMIT=30 LOGGERLIMIT=20 SCOUTLIMIT=120 WATCHDOGLIMIT=150</code> </pre> <br>  Caminhos para arquivos e diret√≥rios <br>  Caminho para o script ipfw. <br><pre> <code class="bash hljs">FIRESCRIPT=/etc/firewall.sh</code> </pre> <br>  Configura√ß√µes de Ipfw.  Se as configura√ß√µes do ipfw n√£o forem movidas para um arquivo separado, ent√£o FIRESCRIPT = FIRESETDEF. <br><pre> <code class="bash hljs">FIRESETDEF=/etc/firewall/config</code> </pre> <br>  Caminho para as configura√ß√µes do ipfw para o canal externo principal: <br><pre> <code class="bash hljs">FIRESET_0=/etc/firewall/config_0</code> </pre> <br>  O caminho para as configura√ß√µes do ipfw para o canal externo de backup, se necess√°rio, voc√™ pode continuar mais FIRESET_2, etc .: <br><pre> <code class="bash hljs">FIRESET_1=/etc/firewall/config_1</code> </pre> <br>  Caminhos para vincular configura√ß√µes <br><pre> <code class="bash hljs">BINDSETDEF=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/etc/namedb/named.conf</code> </pre> <br>  Configura√ß√µes de liga√ß√£o para o canal externo principal: <br><pre> <code class="bash hljs">BINDSET_0=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/etc/namedb/named.conf.0</code> </pre> <br>  Configura√ß√µes de liga√ß√£o para o canal externo de backup, se necess√°rio, voc√™ pode continuar ainda mais BINDSET_2, etc .: <br><pre> <code class="bash hljs">BINDSET_1=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/etc/namedb/named.conf.1</code> </pre> <br>  Caminhos para todos os execut√°veis ‚Äã‚Äãdo ToFoIn: <br><pre> <code class="bash hljs">DAEMON=/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/sbin/tofoin/daemon.sh TESTER=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/sbin/tofoin/tester.sh JUDGE=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/sbin/tofoin/judge.sh LOGGER=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/sbin/tofoin/logger.sh SCOUT=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/sbin/tofoin/scout.sh WATCHDOG=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/sbin/tofoin/watchdog.sh</code> </pre> <br>  Log de eventos.  Este arquivo N√ÉO √© criado na instala√ß√£o agora: <br><pre> <code class="bash hljs">LOGFILE=/var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/tofoin.log</code> </pre> <br>  Arquivos e diret√≥rios tempor√°rios s√£o criados quando os m√≥dulos correspondentes s√£o iniciados, alguns s√£o exclu√≠dos quando parados: <br><pre> <code class="bash hljs">DIR_TMP=/tmp/tofoin DIR_PID=/var/run/tofoin JUDGEMETER=/tmp/tofoin/judgemeter PREVSTATE=/tmp/tofoin/prevstate SCOUTGATE=/tmp/tofoin/scoutgate LOGTMP=/tmp/tofoin/logger.tmp LOGMETER=/tmp/tofoin/logmeter DAEMON_PID=/var/run/tofoin/daemon.pid TESTER_PID=/var/run/tofoin SCOUT_PID=/var/run/tofoin/scout.pid JUDGE_PID=/var/run/tofoin/judge.pid LOGGER_PID=/var/run/tofoin/logger.pid WATCHDOG_PID=/var/run/tofoin_watchdog.pid</code> </pre> <br></div></div><br><h3>  Sum√°rio </h3><br>  Acabou sendo um conjunto de scripts totalmente funcional e confi√°vel que lida bem com a tarefa de mudar para o canal de trabalho no caso de 2 roteadores com 2 canais de comunica√ß√£o externos. <br><br><h3>  Planos </h3><br>  Meus planos para este projeto dizem respeito, talvez, √† reescrita do bash para o sh puro, para livrar-se de software desnecess√°rio no servidor.  Por outro lado, agora tudo funciona de maneira incr√≠vel e eu realmente n√£o estou com vontade de interferir nesse processo. Al√©m disso, mudar para sh √© repleto de constru√ß√µes de linguagem mais terr√≠veis necess√°rias para obter o mesmo resultado. <br>  Quanto ao resto, provavelmente, valeria a pena considerar a melhor implementa√ß√£o dos m√≥dulos de teste. <br><br><h3>  Refer√™ncias: </h3><br>  ‚Üê <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Artigo anterior</a> <br>  ‚Üí <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">P√°gina do projeto ToFoIn no gitlab</a> <br><div class="spoiler">  <b class="spoiler_title">O resto</b> <div class="spoiler_text">  BIND DNS 9: <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Lee K., Albitz P. - DNS e BIND (5¬™ Edi√ß√£o)</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Servidor DNS BIND</a> <br>  DHCP: <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">DHCP de failover</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">DHCP com atualiza√ß√µes din√¢micas de DNS</a> <br>  <a href="">samba-dnsupdate</a> <br>  SETFIB: <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">V√°rias rotas padr√£o no FreeBSD sem BGP ou similar</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">setfib e alternando entre tabelas de roteamento</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">FreeBSD dois provedores.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">setfib</a> <br>  IPFW + NAT: <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Manual detalhado do ipfw nat</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">FreeBSD 9 + ipfw + ipfw nat</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Manual detalhado do ipfw nat</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Dummynet</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">NAT do kernel</a> <br>  BASH: <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">No√ß√µes b√°sicas de BASH.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Parte 2</a> <br>  <a href="">Guia Avan√ßado de Bash-Scripting</a> <br></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt421857/">https://habr.com/ru/post/pt421857/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt421845/index.html">O que os analistas de dados realmente fazem? Resultados de 35 entrevistas</a></li>
<li><a href="../pt421847/index.html">Salte para a nuvem. Criando uma solu√ß√£o de IoT de or√ßamento no Hub IoT do NodeMCU + Azure</a></li>
<li><a href="../pt421849/index.html">Eventos para RH em TI em setembro de 2018: My Circle Digest</a></li>
<li><a href="../pt421851/index.html">Problemas de coruja e globo: conectando dois assemblies com namespaces e nomes de classe id√™nticos</a></li>
<li><a href="../pt421855/index.html">Projetores dom√©sticos: os melhores ‚Äúde acordo com a vers√£o‚Äù, foco ultra curto, campe√µes em brilho e velocidade</a></li>
<li><a href="../pt421859/index.html">Notas do provedor de IoT. Dispositivos e supera√ß√µes</a></li>
<li><a href="../pt421863/index.html">Uma nova maneira de criar nanotubos: agora em cores</a></li>
<li><a href="../pt421867/index.html">Como tornar o c√≥digo leg√≠vel</a></li>
<li><a href="../pt421869/index.html">Crie um aplicativo Android para detec√ß√£o de rosto em tempo real usando o Kit Firebase ML</a></li>
<li><a href="../pt421871/index.html">Como falhar miseravelmente da migra√ß√£o de Java para Kotlin em um aplicativo Android</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>