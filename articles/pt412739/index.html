<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíπ üêÄ üìõ C√£o pastor ‚å®Ô∏è üë©üèø‚ÄçüöÄ ü§ò</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Sheepdog √© um sistema escal√°vel que fornece dispositivos de bloco distribu√≠dos para m√°quinas virtuais. Seu desenvolvimento come√ßou em 2009 por desenvo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>C√£o pastor</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/412739/"><p><img src="https://habrastorage.org/webt/ru/g3/9i/rug39i1kkn-c4ack--isbvvzjma.jpeg"></p><br><p> <strong>Sheepdog</strong> √© um sistema escal√°vel que fornece dispositivos de bloco distribu√≠dos para m√°quinas virtuais.  Seu desenvolvimento come√ßou em 2009 por desenvolvedores da empresa japonesa <em>Nippon Telegraph and Telephone Corporation</em> .  <strong>Sheepdog</strong> √© um aplicativo de c√≥digo aberto sob a licen√ßa GPL2.  A vers√£o mais recente 0.9.3, lan√ßada em novembro de 2015, ser√° o legado da vers√£o 1.0, adequada para uso comercial <sup><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">1</a></sup> <sup><a name="cite_ref-1"></a></sup>  .  <em>(j√° se tornou - aprox. por.)</em> </p><br><blockquote>  Por uma quest√£o de interesse, a primeira vers√£o (0.1.0) foi lan√ßada pelos desenvolvedores em agosto de 2010 - e, ao mesmo tempo, o suporte do sheepdog foi imediatamente inclu√≠do no principal ramo de desenvolvimento do QEMU. <a name="habracut"></a><br>  Os primeiros testes em um c√£o pastor que realizei em novembro de 2011 <sup><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">2</a></sup> <sup><a name="cite_ref-2"></a></sup>  e os resultados foram bons para opera√ß√µes de E / S.  No entanto, o sistema <strong>Sheepdog ainda</strong> tinha problemas com a restaura√ß√£o do n√≥ ca√≠do.  Esse problema provavelmente foi resolvido em breve, pois o desenvolvimento do aplicativo √© bastante animado, mas naquela √©poca eu usava uma solu√ß√£o diferente. </blockquote><br><h1 id="vozmozhnosti">  As possibilidades </h1><br><p>  O princ√≠pio de funcionamento do <strong>Sheepdog √©</strong> muito bem descrito na apresenta√ß√£o publicada, portanto, me limitarei a apenas uma breve vis√£o geral. </p><br><p>  <strong>√â escal√°vel</strong> <br>  O volume do cluster pode ser arbitrariamente aumentado no n√≠vel do n√≥, aumentando a capacidade e o espa√ßo para dados durante a opera√ß√£o e aumentando o n√∫mero de n√≥s.  Quanto mais n√≥s, maior o desempenho da E / S de VDI. </p><br><p>  <strong>Ele √© simples</strong> <br>  Diferentemente de outros sistemas, como o CEPH, o <strong>Sheepdog</strong> n√£o funciona diretamente com o sistema de arquivos, mas opera com blocos de tamanho fixo; portanto, n√£o √© necess√°rio daemons separados para servir metadados.  Todo o controle √© realizado usando uma √∫nica ferramenta para <strong>c√£es</strong> que se comunica diretamente com as <strong>ovelhas</strong> <br>  <em>(o ceph tamb√©m usa objetos - aprox. por.)</em> </p><br><p>  <strong>Calcula um n√≥ ca√≠do</strong> <br>  Cada VDI consiste nesses blocos (objetos) que s√£o replicados simultaneamente para v√°rios n√≥s; portanto, se um deles cair, os dados permanecer√£o dispon√≠veis e os objetos dos n√≥s ca√≠dos come√ßar√£o a se replicar para o outro n√≥. </p><br><p>  <strong>Suporta instant√¢neos de dispositivo de bloco</strong> <br>  Os <strong>instant√¢neos do</strong> Sheepdog funcionam da mesma forma que os Btrfs.  Os blocos VDI anexados s√£o salvos e novos dados s√£o gravados em novos blocos. </p><br><p>  As seguintes fun√ß√µes podem ser problem√°ticas em determinadas circunst√¢ncias: </p><br><p>  <strong>Sheepdog n√£o suporta SPOF</strong> <br>  Se o VDI for usado como um dispositivo de bloco via QEMU, poder√° ocorrer um problema se ele estiver conectado ao mesmo tempo em v√°rios locais.  O SPOF <sup><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">3</a></sup> poderia ter evitado isso. <sup><a name="cite_ref-3"></a></sup>  Sheepdog n√£o tem.  No entanto, na nova vers√£o do Sheepdog, o VDI pode ser bloqueado para n√£o permitir mais de uma conex√£o. </p><br><p>  <strong>O ciclo de vida dos objetos de dados</strong> <br>  Os objetos VDI podem ser exclu√≠dos apenas quando todos os clones e instant√¢neos associados a eles forem exclu√≠dos.  √â exatamente o mesmo que para o Btrfs.  Portanto, a remo√ß√£o de instant√¢neos n√£o utilizados pode n√£o ser suficiente para liberar espa√ßo para armazenamento. </p><br><h1 id="demon-kommunikacii">  Daemon de comunica√ß√£o </h1><br><p>  O Sheepdog √© ridiculamente pequeno comparado ao Ceph ou GlusterFS.  Isso ocorre porque ele n√£o tenta resolver todos os problemas sozinho, mas usa ao m√°ximo o que j√° est√° funcionando. </p><br><p>  Por sua vez, fornece um dispositivo de bloco que pode ser usado como um disco f√≠sico, bem como uma invas√£o de software, etc. </p><br><p>  Ele se preocupa apenas com a distribui√ß√£o de objetos de dados entre os n√≥s nos quais est√° executando. </p><br><p>  No entanto, ele precisa das informa√ß√µes que o <strong>daemon de comunica√ß√£o</strong> fornece - um componente-chave sem o qual o <strong>Sheepdog</strong> n√£o funcionar√°. </p><br><p>  <strong>Daemon de comunica√ß√£o</strong> - n√£o fornece a capacidade de trocar dados entre n√≥s.  √â isso que <strong>os</strong> dem√¥nios das <strong>ovelhas</strong> est√£o fazendo.  Por meio dele, a <strong>ovelha</strong> s√≥ descobre quais n√≥s est√£o vivos no momento. </p><br><h2 id="corosync">  corosync </h2><br><p>  Primeiro, o <strong>Sheepdog</strong> sup√µe que os n√≥s se comuniquem entre si por meio de <strong>corosync</strong> .  Ele suporta at√© 64 n√≥s, embora teoricamente deva servir mais, seu uso √© ideal para pequenos grupos de at√© 16 n√≥s. </p><br><p>  Normalmente, o <strong>corosync</strong> tamb√©m usa o Pacemaker, portanto, n√£o h√° necessidade de instalar mais nada. </p><br><h3 id="ustanovka-corosync-na-debian">  Instale o corosync no Debian </h3><br><p>  O Corosync est√° nos reposit√≥rios de distribui√ß√£o e sua instala√ß√£o √© simples: </p><br><pre><code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> apt<span class="hljs-literal"><span class="hljs-literal">-get</span></span> install corosync libcoro<span class="hljs-built_in"><span class="hljs-built_in">sync-common4</span></span></code> </pre> <br><h3 id="nastroyka-corosync">  Configura√ß√£o do Corosync </h3><br><h2 id="zookeeper">  tratador </h2><br><p>  <strong>Os</strong> desenvolvedores de <strong>Sheepdog</strong> recomendam o uso do <strong>zookeeper</strong> para grupos maiores.  Segundo os desenvolvedores, um armazenamento de teste <strong>Sheepdog</strong> com 1000 n√≥s foi constru√≠do e testado <sup><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">4</a></sup> <sup><a name="cite_ref-4"></a></sup>  . </p><br><h3 id="ustanovka-zookeeper-na-debian">  Instale o zookeeper no Debian </h3><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> apt<span class="hljs-literal"><span class="hljs-literal">-get</span></span> install zookeeper zookeeperd</code> </pre> <br><p>  Ativando o daemon .. </p><br><pre> <code class="hljs pgsql">$ /usr/<span class="hljs-keyword"><span class="hljs-keyword">share</span></span>/zookeeper/bin/zkServer.sh <span class="hljs-keyword"><span class="hljs-keyword">start</span></span></code> </pre> <br><p>  A porta padr√£o na qual o tratador √© executado √© 2181 </p><br><p>  Executando c√£o pastor com suporte a tratador: </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> sheep <span class="hljs-literal"><span class="hljs-literal">-c</span></span> zookeeper:IP1:PORT1,IP2:PORT2,IP3:PORT3 ...other...option...</code> </pre> <br><p>  O b√¥nus do <strong>zookeeper</strong> √© que, no seu caso, o <strong>Sheepdog</strong> possui uma configura√ß√£o mais clara e mais clara dos n√≥s, mas h√° um problema que o pacote de instala√ß√£o da Debian n√£o inclui seu suporte. </p><br><p>  Portanto, para obter um Sheepdog com suporte a zookeeper, voc√™ deve compil√°-lo a partir do c√≥digo-fonte.  Embora eu n√£o possa descartar que a situa√ß√£o possa ser diferente no momento. <br>  <em>(o suporte ao tratador de zool√≥gico ainda requer compila√ß√£o da fonte - aprox. por.)</em> </p><br><h1 id="nastroyka-demona-sheep">  Configurando o daemon de ovelhas </h1><br><p>  O n√≥ se torna parte do Sheepdog quando o gerenciador de objetos, o daemon de <strong>ovelhas</strong> , √© iniciado.  Sempre funciona em duas c√≥pias: </p><br><ol><li><p>  A primeira inst√¢ncia do processo inicia como um gateway, que recebe solicita√ß√µes de E / S de clientes (por exemplo, dos drivers dos dispositivos de bloco QEMU), calcula os n√≥s de destino e envia solicita√ß√µes para processamento adicional entre eles.  Ou seja, estabelece muitas conex√µes de rede. </p><br></li><li>  Outro funciona como um gerenciador de objetos local ( <strong>Gerenciador de Objetos</strong> ) </li></ol><br><p>  Os par√¢metros de configura√ß√£o do daemon de ovelha podem ser passados ‚Äã‚Äãcomo argumentos de linha de comando no tempo de execu√ß√£o.  Se n√£o houver nenhum, os valores padr√£o ser√£o usados, com os quais voc√™ deve ter cuidado: </p><br><p>  <strong>N√∫mero da porta</strong> <br>  Salvo especifica√ß√£o em contr√°rio, o daemon de ovelhas √© executado na porta 7000 </p><br><p>  <strong>Caminho do Vault</strong> <br>  A menos que especificado de outra forma, o diret√≥rio shep usa o diret√≥rio / var / lib / sheepdog e os objetos VDI s√£o armazenados em seu subdiret√≥rio <code>obj</code> . </p><br><blockquote>  Teoricamente, nada impede que v√°rias inst√¢ncias de <strong>ovelhas</strong> trabalhem em um n√≥ - a principal condi√ß√£o √© que todos usem seu n√∫mero de porta e seu pr√≥prio armazenamento.  A quest√£o do endere√ßo IP do n√≥ est√° quase resolvida.  Cada inst√¢ncia em execu√ß√£o do daemon de <strong>ovelhas</strong> em execu√ß√£o em uma porta diferente se conectar√° automaticamente a um cluster existente! <br><br>  Informa√ß√µes importantes s√£o que o n√∫mero da porta faz parte da configura√ß√£o do cont√™iner VDI.  Voc√™ precisa saber se deseja reconfigurar o daemon do <strong>sheep</strong> para executar na outra porta do cluster existente. <br><br>  Portanto, se voc√™ executar uma inst√¢ncia do daemon de <strong>ovelhas</strong> com um n√∫mero de porta diferente, mas com o mesmo caminho para o armazenamento de objetos, poder√° perder informa√ß√µes nos cont√™ineres VDI existentes. </blockquote><br><h1 id="demon-sheep-kak-shlyuz">  A ovelha demon√≠aca como uma porta de entrada </h1><br><p>  Em m√°quinas que n√£o possuem espa√ßo de armazenamento para objetos VDI, o daemon de <strong>ovelha</strong> pode ser executado exclusivamente no modo de gateway, com o sinalizador <code>-G</code> . </p><br><p>  Nesse caso, ao distribuir objetos VDI, o armazenamento local n√£o ser√° usado e os dados ser√£o distribu√≠dos diretamente para outros n√≥s. </p><br><h1 id="demon-sheep-kak-menedzher-obektov">  Dem√¥nio das ovelhas como gerente de objetos </h1><br><p>  A segunda inst√¢ncia em execu√ß√£o, atua como um gerenciador de objetos local, recebe solicita√ß√µes de E / S de uma inst√¢ncia que inicia como um gateway e executa opera√ß√µes de E / S no armazenamento de objetos local ( <strong>armazenamento de objetos</strong> ) </p><br><h2 id="hranilische-obektov">  Armazenamento de objetos </h2><br><p>  Por padr√£o, o armazenamento para objetos VDI no <strong>Sheepdog</strong> √© o diret√≥rio <code>/var/lib/sheepdog/obj</code> , que tamb√©m √© usado pelo daemon <strong>sheep</strong> como parte de sua estrutura interna de diret√≥rios - esse √© o caminho de armazenamento padr√£o. </p><br><p>  Se voc√™ deseja que os objetos VDI sejam armazenados em outro lugar, pode passar o caminho em que outro dispositivo de bloco est√° montado como par√¢metro na inicializa√ß√£o. </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">sheep</span></span> ... /cesta_do_p≈ô√≠pojn√©ho_bodu</code> </pre> <br><p>  Existem ainda mais maneiras de transmitir.  A nova vers√£o do <strong>Sheepdog</strong> suporta a chamada tecnologia multi-dispositivo, que permite aumentar dinamicamente a capacidade da mem√≥ria, se necess√°rio, sem precisar reiniciar o <strong>Sheepdog</strong> .  Aumentar a capacidade de armazenamento funciona de maneira semelhante ao Btrfs. </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">sheep</span></span> ... /cesta_do_A,/cesta_do_B,/cesta_do_C</code> </pre> <br><p>  <em>(o primeiro diret√≥rio especificado ser√° usado apenas para metadados - aprox. por)</em> </p><br><p>  Armazenamento adicional tamb√©m pode ser adicionado (ou removido) atrav√©s <strong>do n√≥ do c√£o md</strong> </p><br><p>  ... </p><br><p>  A funcionalidade oferecida pelo dispositivo m√∫ltiplo √© especialmente √∫til quando o sistema de arquivos de armazenamento n√£o suporta isso "por design" (diferente dos Btrfs ou ZFS).  Em geral, a escolha de um sistema de arquivos para armazenar objetos, suas propriedades, par√¢metros e configura√ß√µes pode afetar significativamente o desempenho do sistema de arquivos IO de uma m√°quina virtual. </p><br><blockquote>  A tecnologia para v√°rios dispositivos requer atributos avan√ßados no lado do arquivo, o que n√£o √© um problema para sistemas de arquivos modernos, como o btrfs <sup><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">5</a></sup> <sup><a name="cite_ref-5"></a></sup>  ou ext4.  Mas alguns sistemas de arquivos mais antigos, como reiserfs ou ext2 <sup><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">6</a></sup> <sup><a name="cite_ref-6"></a></sup>  N√£o os apoie. <br><br>  Se voc√™ deseja usar um sistema de arquivos que n√£o suporta atributos estendidos para armazenamento de objetos, precisamos compilar o <strong>Sheepdog</strong> sem suporte para v√°rios dispositivos. </blockquote><br><h2 id="tip-hranilischa---plain-versus-tree">  Tipo de armazenamento - comum versus √°rvore </h2><br><p>  Ao formatar um cluster, entre outras op√ß√µes, voc√™ pode especificar o tipo de armazenamento (armazenamento de back-end).  Voc√™ pode definir o tipo como <strong>simples</strong> ou em <strong>√°rvore</strong> .  Para um tipo <strong>simples</strong> , a estrutura de diret√≥rios ter√° a seguinte apar√™ncia: </p><br><pre> <code class="hljs ruby"><span class="hljs-params"><span class="hljs-params">| |</span></span>- obj <span class="hljs-params"><span class="hljs-params">| |</span></span>- &lt;id &gt; <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-params"><span class="hljs-params">|-&lt; &gt; |</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span>-&lt; &gt; <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-params"><span class="hljs-params">|-&lt; &gt; |</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span>- ... <span class="hljs-params"><span class="hljs-params">| |</span></span>- &lt;id  &gt; <span class="hljs-params"><span class="hljs-params">| |</span></span> ... <span class="hljs-params"><span class="hljs-params">|- config [] |</span></span>- epoch <span class="hljs-params"><span class="hljs-params">| |</span></span>- &lt; &gt; <span class="hljs-params"><span class="hljs-params">| |</span></span>- &lt; &gt; <span class="hljs-params"><span class="hljs-params">| |</span></span>- ... <span class="hljs-params"><span class="hljs-params">|- journal \- sheep.log []</span></span></code> </pre> <br><p>  Todos os objetos VDI no diret√≥rio <code>obj</code> ser√£o enviados para um subdiret√≥rio cujo nome se baseia no identificador de √©poca atual.  Ou seja, para cada √©poca, os objetos VDI correspondentes ser√£o armazenados separadamente.  No entanto, durante uma √©poca, um grande n√∫mero de objetos VDI pode aparecer no diret√≥rio, o que atrasa o acesso aos arquivos posteriormente.  Portanto, voc√™ pode escolher a segunda op√ß√£o, que √© a <strong>√°rvore</strong> : </p><br><pre> <code class="hljs ruby"><span class="hljs-params"><span class="hljs-params">|- obj |</span></span> <span class="hljs-params"><span class="hljs-params">|- aa |</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span>-&lt; &gt; <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-params"><span class="hljs-params">|-&lt; &gt; |</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span>-&lt; &gt; <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-params"><span class="hljs-params">|- ... |</span></span> <span class="hljs-params"><span class="hljs-params">|- ab |</span></span> <span class="hljs-params"><span class="hljs-params">| ... |</span></span> <span class="hljs-params"><span class="hljs-params">|- meta |</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span>- &lt; &gt; <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-params"><span class="hljs-params">|- ... |</span></span> <span class="hljs-params"><span class="hljs-params">|- 0a |</span></span> <span class="hljs-params"><span class="hljs-params">| ... |</span></span>- config [] <span class="hljs-params"><span class="hljs-params">|- epoch |</span></span> <span class="hljs-params"><span class="hljs-params">|- &lt; &gt; |</span></span> <span class="hljs-params"><span class="hljs-params">|- &lt; &gt; |</span></span> <span class="hljs-params"><span class="hljs-params">|- ... \- sheep.log []</span></span></code> </pre> <br><p>  Nesse tipo de armazenamento, o daemon <strong>sheep</strong> cria um conjunto de 256 subdiret√≥rios com os nomes <code>0a, ..., 99</code> no diret√≥rio <code>obj</code> e depois espalha objetos com base nos dois √∫ltimos caracteres do <strong>ID de VDI</strong> , que √© exclusivo n√£o apenas para cada cont√™iner de VDI, mas tamb√©m para seus instant√¢neos ou clones. </p><br><h2 id="imena-vdi-obektov">  Nomes de objetos VDI </h2><br><p>  Quando o <strong>Sheepdog</strong> salva os dados no cont√™iner VDI, os arquivos come√ßam a aparecer no armazenamento de dados <code>obj</code> , cada um com seu pr√≥prio nome, composto por v√°rios elementos: </p><br><pre> <code class="hljs go">../obj/<span class="hljs-number"><span class="hljs-number">8f</span></span>/<span class="hljs-number"><span class="hljs-number">00e8</span></span>b18f00000005 ^^</code> </pre> <br><p>  Os dois primeiros caracteres indicam o tipo de objeto.  Os objetos de dados come√ßam com <code>00...</code> e metadados (que podem ser armazenados em outro diret√≥rio) <code>80...</code> </p><br><pre> <code class="hljs go">../obj/<span class="hljs-number"><span class="hljs-number">8f</span></span>/<span class="hljs-number"><span class="hljs-number">00e8</span></span>b18f00000005 ^^^^^^</code> </pre> <br><p>  Depois vem o VDI.  √â exclusivo n√£o apenas para cada cont√™iner, mas tamb√©m para seu instant√¢neo ou clone. </p><br><pre> <code class="hljs go">../obj/<span class="hljs-number"><span class="hljs-number">8f</span></span>/<span class="hljs-number"><span class="hljs-number">00e8</span></span>b18f00000005 ^^ ^^</code> </pre> <br><p>  Os dois √∫ltimos d√≠gitos do identificador VDI indicam - no caso do tipo de armazenamento em <strong>√°rvore</strong> - em que o subdiret√≥rio ao qual o objeto pertence est√° localizado. </p><br><pre> <code class="hljs go">../obj/<span class="hljs-number"><span class="hljs-number">8f</span></span>/<span class="hljs-number"><span class="hljs-number">00e8</span></span>b18f00000005 ^^^^^^^^</code> </pre> <br><p>  E o identificador do cont√™iner VDI em hexadecimal √© seguido pelo n√∫mero de s√©rie do objeto no cont√™iner VDI </p><br><h2 id="epoha">  Era </h2><br><p>  O subdiret√≥rio da <code>epoch</code> cont√©m listas bin√°rias de objetos pertencentes √† √©poca.  O n√∫mero da √©poca aumenta, cada vez que cada cluster √© alterado - quando um n√≥ √© adicionado ou removido.  Cada uma dessas altera√ß√µes inicia o processo de <strong>recupera√ß√£o</strong> , durante o qual o estado atual dos objetos locais ser√° verificado nos n√≥s, seguido por um aumento na era. </p><br><h1 id="kak-optimalno-vybrat-hranilische-vdi-obektov">  Como escolher o armazenamento ideal de objetos VDI </h1><br><p>  A capacidade de armazenamento dispon√≠vel √© calculada com base no espa√ßo livre nos n√≥s.  O espa√ßo escolhido pelo <strong>sheep</strong> sempre depende de quanto espa√ßo est√° dispon√≠vel no dispositivo de bloco em que os objetos VDI est√£o armazenados. </p><br><p>  O tamanho de um cont√™iner VDI √© apenas uma forma virtual que n√£o est√° de forma alguma relacionada √† quantidade de espa√ßo que os objetos VDI ocupam.  √â importante saber como o Sheepdog processa dados em um cluster: </p><br><blockquote>  O Sheepdog sempre tenta armazenar dados de maneira uniforme entre todas as m√°quinas da √©poca. </blockquote><p>  Isso significa que, se um dos n√≥s cair, a era mudar e o <strong>Sheepdog</strong> iniciar imediatamente o processo de recupera√ß√£o, ele criar√° os objetos VDI ausentes nos n√≥s restantes para compensar a perda. </p><br><p>  Uma situa√ß√£o semelhante surgir√° ao adicionar um novo n√≥.  <strong>O Sheepdog</strong> come√ßar√° a mover objetos VDI igualmente de novos n√≥s para seu reposit√≥rio, para que a porcentagem de preenchimento do espa√ßo de dados nos n√≥s seja o mais equilibrada poss√≠vel.  Use o comando a seguir para obter uma vis√£o geral global de quanto espa√ßo √© atualmente usado em seus n√≥s: </p><br><pre> <code class="hljs pgsql">nod1 ~ # collie node md <span class="hljs-keyword"><span class="hljs-keyword">info</span></span> -A Id Size Used Avail Use% <span class="hljs-type"><span class="hljs-type">Path</span></span> Node <span class="hljs-number"><span class="hljs-number">0</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1.1</span></span> TB <span class="hljs-number"><span class="hljs-number">391</span></span> GB <span class="hljs-number"><span class="hljs-number">720</span></span> GB <span class="hljs-number"><span class="hljs-number">35</span></span>% /<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/sheepdog-data/obj Node <span class="hljs-number"><span class="hljs-number">1</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">702</span></span> GB <span class="hljs-number"><span class="hljs-number">394</span></span> GB <span class="hljs-number"><span class="hljs-number">307</span></span> GB <span class="hljs-number"><span class="hljs-number">56</span></span>% /<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/sheepdog-data/obj Node <span class="hljs-number"><span class="hljs-number">2</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">794</span></span> GB <span class="hljs-number"><span class="hljs-number">430</span></span> GB <span class="hljs-number"><span class="hljs-number">364</span></span> GB <span class="hljs-number"><span class="hljs-number">54</span></span>% /<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/sheepdog-data/obj Node <span class="hljs-number"><span class="hljs-number">3</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1.6</span></span> TB <span class="hljs-number"><span class="hljs-number">376</span></span> GB <span class="hljs-number"><span class="hljs-number">1.2</span></span> TB <span class="hljs-number"><span class="hljs-number">22</span></span>% /<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/sheepdog-data/obj Node <span class="hljs-number"><span class="hljs-number">4</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1.2</span></span> TB <span class="hljs-number"><span class="hljs-number">401</span></span> GB <span class="hljs-number"><span class="hljs-number">838</span></span> GB <span class="hljs-number"><span class="hljs-number">32</span></span>% /<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/sheepdog-data/obj Node <span class="hljs-number"><span class="hljs-number">5</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1.5</span></span> TB <span class="hljs-number"><span class="hljs-number">370</span></span> GB <span class="hljs-number"><span class="hljs-number">1.1</span></span> TB <span class="hljs-number"><span class="hljs-number">24</span></span>% /<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/sheepdog-data/obj Node <span class="hljs-number"><span class="hljs-number">6</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1.6</span></span> TB <span class="hljs-number"><span class="hljs-number">388</span></span> GB <span class="hljs-number"><span class="hljs-number">1.2</span></span> TB <span class="hljs-number"><span class="hljs-number">23</span></span>% /<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/sheepdog-data/obj</code> </pre> <br><h2 id="proizvoditelnost-io">  Desempenho de E / S </h2><br><p>  √â importante dizer aqui que o <strong>Sheepdog</strong> funciona de maneira diferente do Ceph e tem prioridades diferentes. </p><br><p>  Para Ceph, o "peso" do dispositivo OSD √© cr√≠tico ao colocar objetos de dados, bem como o desempenho do dispositivo de bloco, a conectividade do host e a velocidade de resposta.  <em>(na verdade n√£o - aprox. por)</em> </p><br><p>  Sheepdog faz algo assim, eu n√£o sei.  Possivelmente.  Os dados para ele v√™m em primeiro lugar.  O desempenho em termos de opera√ß√µes de E / S √© secund√°rio.  Obviamente, com n√≥s mais poderosos, seu desempenho de E / S pode melhorar, mas sempre depende da estrutura espec√≠fica.  <em>(no entanto, os <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">testes</a> mostram melhor desempenho do c√£o pastor em compara√ß√£o com ceph - aprox. por)</em> </p><br><blockquote>  Adicionei um novo n√≥ ao Sheepdog com os dados armazenados em um disco rotativo de 2 TB SATA II.  A velocidade m√°xima de grava√ß√£o para este disco √© de cerca de 80M / s.  De fato, isso varia muito porque as unidades SATA n√£o podem ler e escrever ao mesmo tempo. <br><br>  Inicialmente, a velocidade m√©dia de grava√ß√£o no VDI nesse disco era de cerca de 20 ~ 30M / s, pois al√©m dos dados do VDI, os dados do cont√™iner 392G foram replicados nele como parte do processo de recupera√ß√£o.  Isso continuou por 6,5 horas.  A velocidade de grava√ß√£o variou entre 40 ~ 55M / s. <br><br>  Obviamente, nesse caso, a velocidade de grava√ß√£o foi limitada pelo desempenho de E / S do dispositivo de bloco local. </blockquote><p>  Para Sheepdog, a seguinte regra se aplica: "Quanto mais objetos VDI houver nos n√≥s com conex√£o r√°pida, melhor o desempenho das opera√ß√µes de E / S". </p><br><p>  Como mover objetos VDI em segundo plano significa que a ‚Äúmorte r√°pida de um n√≥‚Äù diminuir√° a replica√ß√£o dos objetos de dados que ocupam mais espa√ßo, isso se manifestar√° como uma diminui√ß√£o no desempenho das opera√ß√µes de E / S do cont√™iner VDI </p><br><h2 id="zanimaemoe-prostranstvo">  Espa√ßo ocupado </h2><br><p>  Ao colocar objetos de dados, a quantidade de espa√ßo livre √© cr√≠tica para o daemon de <strong>ovelhas</strong> .  O mecanismo parece simples.  O daemon de <strong>ovelhas</strong> , atrav√©s do qual os dados s√£o comunicados com o cont√™iner de VDI, de tempos em tempos determina a utiliza√ß√£o do espa√ßo livre e ocupado nos n√≥s, que os classifica.  Em seguida, os dados s√£o distribu√≠dos entre os n√≥s com a menor taxa de utiliza√ß√£o. </p><br><p>  Se houver um caminho de grava√ß√£o predominantemente r√°pido, a opera√ß√£o de grava√ß√£o no cont√™iner VDI tamb√©m ser√° r√°pida.  Como quanto mais r√°pidas as opera√ß√µes de E / S do cont√™iner de VDI s√£o executadas, mais cedo o daemon do <strong>sheep</strong> pode prosseguir para a pr√≥xima opera√ß√£o. </p><br><p>  O importante √© que, com o Sheepdog, n√£o haver√° situa√ß√£o em que um dos n√≥s esteja completamente cheio.  Se a taxa de utiliza√ß√£o no n√≥ se tornar muito pior, o daemon de ovelhas come√ßar√° a mover seus objetos de dados para outro local. </p><br><p>  O Sheepdog funciona como o Btrfs - usando apenas o espa√ßo realmente ocupado.  Assim, voc√™ pode criar um cont√™iner VDI virtual com capacidade de 1 TB, que ocupar√° tanto espa√ßo quanto os dados armazenados nele.  Desse ponto de vista, √© desej√°vel usar esses formatos de discos virtuais e sistemas de arquivos em cont√™ineres VDI que eles possam limpar um ap√≥s o outro. </p><br><h1 id="zapusk-klastera">  Lan√ßamento de cluster </h1><br><blockquote>  Embora todos os n√≥s possam ser parados ao mesmo tempo, os n√≥s n√£o podem ser iniciados por vez !!!  Os n√≥s devem ser conectados gradualmente.  Come√ßando com o n√≥ que foi especificado pela primeira vez na lista de n√≥s. <br>  <em>(esta √© uma afirma√ß√£o extremamente estranha - aprox. por)</em> </blockquote><br><h1 id="vdi">  Vdi </h1><br><p>  Esta √© uma abrevia√ß√£o gen√©rica no <strong>Sheepdog</strong> para disco virtual, n√£o no formato espec√≠fico. <sup><a name="cite_ref-7"></a></sup>  .  Geralmente, essa √© uma caixa virtual com compartimentos de tamanho fixo, na qual o <strong>Sheepdog</strong> coloca os dados que o cliente transmite. </p><br><h1 id="sozdanie-vdi">  Criando VDI </h1><br><p>  Antes de criar ou importar o primeiro VDI, precisamos formatar o cluster.  Ao formatar um cluster, s√£o definidos par√¢metros que ser√£o usados ‚Äã‚Äãpor padr√£o ao criar cada VDI subsequente. </p><br><p>  Um exemplo demonstrando a cria√ß√£o de um novo VDI chamado Disk1 e 1 GB de tamanho </p><br><pre> <code class="hljs ruby">root@nod1 <span class="hljs-symbol"><span class="hljs-symbol">:~</span></span><span class="hljs-comment"><span class="hljs-comment"># collie vdi create disk1 1G root</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@nod</span></span></span><span class="hljs-comment">1 :~# collie vdi list Name Id Size Used Shared Creation time VDI id Copies Tag Block Size Shift disk1 0 1.0 GB 0.0 MB 0.0 MB 2015-12-04 14:07 e8b18f 2 22</span></span></code> </pre> <br><p>  <strong>Id</strong> <br>  Identificador VDI </p><br><p>  <strong>Tamanho</strong> <br>  O tamanho do VDI que n√£o ser√° necessariamente pr√©-alocado imediatamente. <br>  Se esse VDI estiver no formato incremental (qcow2 e similares) criado usando o <code>qemu-img convert</code> , n√£o corresponder√° ao tamanho do disco virtual, mas aumentar√° constantemente. </p><br><p>  <strong>Usado</strong> <br>  Informa√ß√µes sobre quanto espa√ßo os objetos de dados VDI ocupam. <br>  O VDI, que n√£o requer a aloca√ß√£o de objetos de dados durante a cria√ß√£o, n√£o ocupar√° nada, pois os objetos de dados ainda n√£o foram criados para ele. </p><br><p>  <strong>Partilhado</strong> <br>  O volume de objetos de dados que s√£o compartilhados por outros VDIs </p><br><p>  <strong>Tempo de cria√ß√£o</strong> <br>  Hora de cria√ß√£o do VDI </p><br><p>  <strong>Tamanho do bloco</strong> <br>  O tamanho do objeto VDI.  Aten√ß√£o!  N√£o √© especificado em MB, mas como uma pot√™ncia de dois bytes.  Nas vers√µes anteriores, apenas objetos de tamanho fixo de 4 MB eram usados.  Atualmente, o VDI pode ter objetos maiores.  O tamanho ideal para o objeto VDI de uma m√°quina virtual comum parece 64MB (26).  O tamanho padr√£o de 22 (4 MB) tamb√©m √© m√≠nimo.  Menos n√£o pode ser instalado.  Quanto menor o tamanho do objeto, maior o n√∫mero de arquivos que o <strong>Sheepdog</strong> ter√° que processar <strong>ao</strong> trabalhar com VDI, e trabalhar com arquivos n√£o √© um problema barato do ponto de vista do IO.  Um grande n√∫mero de arquivos, especialmente com controladores SATA lentos, pode levar a uma deteriora√ß√£o acentuada nas velocidades de leitura e grava√ß√£o.  O tamanho m√°ximo de objetos que podem ser usados ‚Äã‚Äã√© 31 (2 GB).  Isso pode ser ben√©fico se o VDI armazenar consistentemente uma grande quantidade de dados est√°ticos, como backups. </p><br><p>  <strong>ID do Vdi</strong> <br>  Identificador VDI. </p><br><h2 id="chto-soderzhit-vdi">  O que cont√©m o VDI? </h2><br><p>  Conte√∫do VDI s√£o dados.  Como √© um dispositivo de bloco distribu√≠do, o <strong>Sheepdog</strong> n√£o resolve esses dados ou lixo.  Desse ponto de vista, o VDI parece um volume l√≥gico do LVM.  Um VDI pr√©-preenchido corresponde a uma parti√ß√£o LV cl√°ssica com um intervalo dedicado, enquanto o VDI se assemelha a uma parti√ß√£o LV fina criada em um pool (consulte LVM (thin_provisioning)), mas com a diferen√ßa de que a extens√£o de dados (objetos) n√£o √© armazenada localmente dispositivos de bloco e est√£o espalhados entre n√≥s. </p><br><blockquote>  O formato VDI funciona nessa analogia como um sistema de arquivos.  Alguns ocupam extens√µes reservadas (objetos) sequencialmente, outros os mapeiam como seus inodes e depois enviam dados diretamente para eles.  Uma combina√ß√£o incorreta do sistema de arquivos de armazenamento do n√≥, formato VDI e sistema de arquivos interno pode levar a uma degrada√ß√£o significativa do desempenho de E / S. </blockquote><br><h2 id="kak-poluchit-informaciyu-o-vdi">  Como obter informa√ß√µes sobre VDI </h2><br><p>  Para saber mais sobre o formato VDI, voc√™ pode usar as informa√ß√µes <strong>qemu-img</strong> : </p><br><pre> <code class="hljs mel">root@nod1 :~# qemu-img info sheepdog:localhost:<span class="hljs-number"><span class="hljs-number">8000</span></span>:disk1 <span class="hljs-keyword"><span class="hljs-keyword">image</span></span>: sheepdog:localhost:<span class="hljs-number"><span class="hljs-number">8000</span></span>:test2 <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> <span class="hljs-keyword"><span class="hljs-keyword">format</span></span>: qcow2 virtual <span class="hljs-keyword"><span class="hljs-keyword">size</span></span>: <span class="hljs-number"><span class="hljs-number">12</span></span>G (<span class="hljs-number"><span class="hljs-number">12884901888</span></span> bytes) disk <span class="hljs-keyword"><span class="hljs-keyword">size</span></span>: <span class="hljs-number"><span class="hljs-number">4.0</span></span>G cluster_size: <span class="hljs-number"><span class="hljs-number">65536</span></span> Format specific information: compat: <span class="hljs-number"><span class="hljs-number">1.1</span></span> lazy refcounts: false refcount bits: <span class="hljs-number"><span class="hljs-number">16</span></span> corrupt: false</code> </pre> <br><p>  Na sa√≠da do comando, voc√™ pode descobrir que o disco1 tem um tamanho nominal de 12G.  Atualmente, s√£o necess√°rios apenas 4G.  Como est√° no formato qcow2, √© √≥bvio que foi criado como incremental. </p><br><pre> <code class="hljs mel">root@nod1 :~# collie vdi list Name Id Size Used Shared Creation time VDI id Copies Tag Block Size Shift disk2 <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">4.0</span></span> GB <span class="hljs-number"><span class="hljs-number">4.0</span></span> GB <span class="hljs-number"><span class="hljs-number">0.0</span></span> MB <span class="hljs-number"><span class="hljs-number">2015</span></span><span class="hljs-number"><span class="hljs-number">-12</span></span><span class="hljs-number"><span class="hljs-number">-04</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">07</span></span> <span class="hljs-number"><span class="hljs-number">825</span></span>dc1 <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">31</span></span> root@nod1 :~# qemu-img info sheepdog:localhost:<span class="hljs-number"><span class="hljs-number">8000</span></span>:disk2 <span class="hljs-keyword"><span class="hljs-keyword">image</span></span>: sheepdog:localhost:<span class="hljs-number"><span class="hljs-number">8000</span></span>:disk2 <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> <span class="hljs-keyword"><span class="hljs-keyword">format</span></span>: raw virtual <span class="hljs-keyword"><span class="hljs-keyword">size</span></span>: <span class="hljs-number"><span class="hljs-number">4.0</span></span>G (<span class="hljs-number"><span class="hljs-number">4294967296</span></span> bytes) disk <span class="hljs-keyword"><span class="hljs-keyword">size</span></span>: <span class="hljs-number"><span class="hljs-number">4.0</span></span>G root@nod1 :~# find /datastore/obj/ | grep <span class="hljs-number"><span class="hljs-number">825</span></span>dc1 /datastore/obj/meta/<span class="hljs-number"><span class="hljs-number">80825</span></span>dc100000000 /datastore/obj/c1/<span class="hljs-number"><span class="hljs-number">00825</span></span>dc100000000 /datastore/obj/c1/<span class="hljs-number"><span class="hljs-number">00825</span></span>dc100000001</code> </pre> <br><p>  Nesse caso, o Disk2 foi criado como um VDI pr√©-alocado de 4 GB no formato bruto com um tamanho de bloco de 2 GB, que na verdade leva apenas dois </p><br><h2 id="eksport-vdi-v-fayl">  Exportar VDI para arquivo </h2><br><p>  O conte√∫do VDI pode ser exportado do <strong>Sheepdog de</strong> v√°rias maneiras.  Talvez o mais r√°pido seja usar a <strong>leitura de c√£es</strong> .  O comando √© um pouco confuso, mas significa apenas: "Carregue o conte√∫do do VDI e envie para STDOUT ..", que pode ser redirecionado para um arquivo: </p><br><pre> <code class="hljs ruby">root@nod1 <span class="hljs-symbol"><span class="hljs-symbol">:~</span></span><span class="hljs-comment"><span class="hljs-comment"># collie vdi read disk1 &gt; /backups/soubor.raw</span></span></code> </pre> <br><p>  Se o VDI tiver 10G, mas apenas 2G for usado, ele criar√° um arquivo com capacidade total de 10 GB. </p><br><p>  <strong>Nesse comando, o conte√∫do do VDI permanece inalterado</strong> ; portanto, se o conte√∫do do VDI, por exemplo, um disco virtual no formato qcow2 compactado, puder ser usado diretamente </p><br><pre> <code class="hljs mel">.. -drive <span class="hljs-keyword"><span class="hljs-keyword">file</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">file</span></span>:/disk1_exportovany_z_vdi,..,<span class="hljs-keyword"><span class="hljs-keyword">format</span></span>=qcow2 ..</code> </pre> <br><p>  Outra maneira de obter o conte√∫do da VDI em um arquivo √© usar o <strong>qemu-img convert</strong> .  N√£o √© t√£o r√°pido, mas permite converter VDI para outro formato usando op√ß√µes diferentes do formato de disco virtual correspondente. </p><br><pre> <code class="hljs ruby">root@nod1 <span class="hljs-symbol"><span class="hljs-symbol">:~</span></span><span class="hljs-comment"><span class="hljs-comment"># qemu-img convert -f qcow2 -O file -o preallocation=full,nocow=on sheepdog:localhost:8000:disk1 /disk1_exportovany_z_vdi</span></span></code> </pre> <br><h2 id="inkrementnoe-rezervnoe-kopirovanie">  Backup incremental </h2><br><p>  Criar backup incremental </p><br><p>  Delta entre o primeiro e o segundo instant√¢neo. </p><br><pre> <code class="hljs ruby">root@nod1 <span class="hljs-symbol"><span class="hljs-symbol">:~</span></span><span class="hljs-comment"><span class="hljs-comment"># collie vdi backup test -F snap1 -s snap2 /backups/soubor_diff</span></span></code> </pre> <br><p>  Restaurar VDI do backup incremental </p><br><pre> <code class="hljs ruby">root@nod1 <span class="hljs-symbol"><span class="hljs-symbol">:~</span></span><span class="hljs-comment"><span class="hljs-comment"># collie vdi restore test -s snap1 /tmp/backup restoring /tmp/backup... done</span></span></code> </pre> <br><p>  Ao importar um backup incremental, √© claro que o VDI deve ter a captura instant√¢nea a partir da qual o backup foi feito. </p><br><p>  Verifica√ß√£o atrav√©s da leitura do conte√∫do original do teste de imagem ... </p><br><pre> <code class="hljs ruby"> root@nod1 <span class="hljs-symbol"><span class="hljs-symbol">:~</span></span><span class="hljs-comment"><span class="hljs-comment"># collie vdi read test 0 512 -s 3</span></span></code> </pre> <br><h1 id="import-vdi-iz-fayla">  Importar VDI do arquivo </h1><br><p>  A importa√ß√£o de um disco virtual existente como um arquivo FS local pode ser executada de maneira semelhante √† exporta√ß√£o.  Mas com a diferen√ßa de que a <strong>grava√ß√£o do c√£o √© usada</strong> ("Lendo dados do STDIN e gravando em um arquivo VDI ..") </p><br><pre> <code class="hljs ruby">root@nod1 <span class="hljs-symbol"><span class="hljs-symbol">:~</span></span><span class="hljs-comment"><span class="hljs-comment"># collie vdi write disk1 &lt; /backups/soubor.raw</span></span></code> </pre> <br><p></p><br><blockquote><ul><li>  O conte√∫do pode ser importado apenas para um VDI existente. </li><li>  A VDI importada sempre ocupa mais espa√ßo que o arquivo original, porque os blocos de dados dos quais a VDI √© restaurada cont√™m dados na √°rea marcada. </li></ul><br></blockquote><p>  Se o VDI ainda n√£o existe e n√£o sabemos quanto espa√ßo ser√° necess√°rio para o disco virtual, podemos usar o <strong>qemu-img convert</strong> </p><br><pre> <code class="hljs ruby">root@nod1 <span class="hljs-symbol"><span class="hljs-symbol">:~</span></span><span class="hljs-comment"><span class="hljs-comment"># qemu-img convert -f file -O qcow2 -o redundancy=2:1 ./disk_ukladany_do_vdi sheepdog:localhost:8000:disk</span></span></code> </pre> <br><blockquote>  Embora formatos VDI como qcow2, qed e outros possam ser usados ‚Äã‚Äãno VDI.  Para efici√™ncia de E / S, √© melhor pr√©-alocar blocos de dados. <br>     ,        <strong>Sheepdog</strong>     VDI. </blockquote><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">http://www.sheepdog-project.org/doc/vdi_read_and_write.html</a> </p><br><h1 id="proverka-vdi">  VDI </h1><br><p>    VDI ,      . </p><br><pre> <code class="hljs ruby">root@nod1 <span class="hljs-symbol"><span class="hljs-symbol">:~</span></span><span class="hljs-comment"><span class="hljs-comment"># collie vdi check disk1</span></span></code> </pre> <br><blockquote>    VDI,     .    Sheepdog    ,      .     ,            . </blockquote><p> :   'dog node kill'     ,         ethernet ,   sheep    .          (,    Ethernet),         sheep .               . </p><br><h2 id="io-proizvoditelnost-vdi"> IO  VDI </h2><br><p>  VDI    .          .       ,   IO   VDI. </p><br><p>   <strong>Sheepdog</strong>    SYNC,    .   -,     VFS,   ,       ,       . </p><br><p>       VDI  <strong>Sheepdog</strong>    ,            .              .  <strong>Sheepdog</strong>        VDI-. </p><br><h2 id="ispolzovanie-vfs-kesha-nody">  VFS-  </h2><br><p>      IO  VDI      <strong>sheep</strong>   <strong>-n</strong> .    SYNC         ,   ,        VFS .     ,   VFS  ,   ,      ! </p><br><p>         .            ,          ‚Äî , ,    . </p><br><pre> <code class="hljs nginx"> <span class="hljs-attribute"><span class="hljs-attribute">sheep</span></span> -n ...</code> </pre> <br><blockquote>   <strong>Sheepdog</strong>      .      <strong>-D</strong> </blockquote><br><h1 id="obektnyy-kesh">   </h1><br><p>     -   .   <strong>sheep</strong>           -   IO ‚Äî  SSD .  ,   VDI,       SYNC   .             . </p><br><p>       ,   VDI     ,         VDI   . ,     ,     ,      VDI. </p><br><pre> <code class="hljs dos">sheep -w size=<span class="hljs-number"><span class="hljs-number">20000</span></span>,directio,<span class="hljs-built_in"><span class="hljs-built_in">dir</span></span>=/<span class="hljs-built_in"><span class="hljs-built_in">dir</span></span> ...</code> </pre> <br><p> <strong>size</strong> <br>   </p><br><p> <strong>directio</strong> <br>     <strong>sheep</strong>      ,      .      SSD. </p><br><p> <strong>dir</strong> </p><br><pre> <code class="hljs erlang">     ,     .</code> </pre> <br><p>       ( )   <strong>dog</strong> . </p><br><blockquote>        VDI          <strong>dog vd cashe flush</strong> ,     VDI! </blockquote><br><h2 id="zhurnal">  </h2><br><p>   ‚Äî  .           VDI,     VFS   ,           (/store_dir/journal/[epoch]/[vdi_object_id]),     ,    . </p><br><p>   IO   ,        (cik, cak),   (sequence). </p><br><p>  , <strong>Sheepdog</strong>        VDI ,           ,  SSD-.     ,       VDI    ,           ,                VDI. </p><br><p>        <strong>sheep</strong>      ‚Äî         </p><br><pre> <code class="hljs matlab">$ sheep -<span class="hljs-built_in"><span class="hljs-built_in">j</span></span> <span class="hljs-built_in"><span class="hljs-built_in">size</span></span>=<span class="hljs-number"><span class="hljs-number">256</span></span>M ...</code> </pre> <br><p>       ,  VDI      ,    .        -,   ‚Äî   ‚Äî         -: </p><br><pre> <code class="hljs matlab">$ sheep -<span class="hljs-built_in"><span class="hljs-built_in">j</span></span> dir=/dir,<span class="hljs-built_in"><span class="hljs-built_in">size</span></span>=<span class="hljs-number"><span class="hljs-number">256</span></span>M ...</code> </pre> <br><p>  dir =      ,          .       ,     SW RAID     SSD. </p><br><p> <strong>:</strong>    <strong>sheep</strong>     ,    .     ,      skip,   . </p><br><pre> <code class="hljs matlab">$ sheep -<span class="hljs-built_in"><span class="hljs-built_in">j</span></span> dir=/dir,<span class="hljs-built_in"><span class="hljs-built_in">size</span></span>=<span class="hljs-number"><span class="hljs-number">256</span></span>M,skip ...</code> </pre> <br><hr><br><ol><li> <sup><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">‚Üë</a> <a name="cite_note-1"></a> .       2015 . <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">http://events.linuxfoundation.jp/sites/events/files/slides/COJ2015_Sheepdog_20150604.pdf</a></sup> </li><li> <sup><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">‚Üë</a> <a name="cite_note-2"></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">http://www.abclinuxu.cz/blog/kenyho_stesky/2011/11/sheepdog-hrajeme-si-v-hampejzu</a></sup> </li><li> <sup><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">‚Üë</a> <a name="cite_note-3"></a> SPOF ( <strong>S</strong> ingle <strong>p</strong> oint <strong>o</strong> f <strong>f</strong> ailure) ,             .  SPOF   VDI   iSCSI  <strong>tgtd</strong></sup> </li><li> <sup><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">‚Üë</a> <a name="cite_note-4"></a></sup>  <sup><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">1</a></sup> </li><li><p> <sup><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">‚Üë</a> <a name="cite_note-5"></a> Btrfs ‚Äî    COW,       ,        .   ,      -,      .      ,     ,              .      ,         ,   .  ,     :</sup> </p><br><p> <sup>autodefrag ‚Äî     ,          .</sup> </p><br><p> <sup>      </sup> </p><br><p> <sup>nocow ‚Äî           (),      ‚Äî           GlusterFS</sup> </p><br><p> <sup> Btrfs   ,     ,     FS,       <strong>Sheepdog</strong> .</sup> </p><br><ul><li> <sup>    ,   ,    ,      </sup> </li><li> <sup>  multipath,                         .</sup> </li></ul><br><p> <sup>,  ,        ,        Sheepdog.</sup> </p><br></li><li><p> <sup><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">‚Üë</a> <a name="cite_note-6"></a> <strong>Ext2</strong> .     -  FS  Btrfs,    ext2,     inode.    ext3  ext4     .   inode , Sheepdog          . ,      -,   .           ,   <strong>Sheepdog</strong>      ,         <strong>dog vdi check</strong> . ,  ext2  ,            ‚Äî    -     <strong>dog vdi md</strong> ,       VDI     .</sup> </p><br></li><li> <sup><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">‚Üë</a> <a name="cite_note-7"></a>    ,   , <strong>vdi</strong>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">QEMU_Block_Disk</a></sup> </li></ol><br><h1 id="ssylki">  Refer√™ncias </h1><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://github.com/collie/sheepdog/wiki</a> ‚Äî ,        <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">http://www.osrg.net/sheepdog/</a> ‚Äî    Nippon Telegraph and Telephone Corporation <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">http://www.sheepdog-project.org/doc/index.html</a> ‚Äî   Sheepdog   0.8.0;  ‚Äî Valerio Pachera <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">http://www.admin-magazine.com/Archive/2014/23/Distributed-storage-with-Sheepdog</a> ‚Äî  Udo Seidela   <strong>Sheepdog</strong> ,   23-   Admin   2014  </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt412739/">https://habr.com/ru/post/pt412739/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt412725/index.html">Como tornar sua infraestrutura de TI chata</a></li>
<li><a href="../pt412727/index.html">Como escolher uma ferramenta para prototipagem em 2018?</a></li>
<li><a href="../pt412729/index.html">GDPR. √â necess√°rio realiz√°-lo na R√∫ssia?</a></li>
<li><a href="../pt412735/index.html">Sair do concurso ATM Alone no PHDays 8</a></li>
<li><a href="../pt412737/index.html">Prote√ß√£o de dados pessoais de 3 bilh√µes de pessoas - semelhan√ßas e diferen√ßas na legisla√ß√£o nos pa√≠ses do BRICS</a></li>
<li><a href="../pt412741/index.html">Como parar de ter medo de que a intelig√™ncia artificial o deixe sem trabalho</a></li>
<li><a href="../pt412743/index.html">Profiss√£o: Cyber ‚Äã‚ÄãDetective</a></li>
<li><a href="../pt412747/index.html">MIS. Armazenamento de dados m√©dicos</a></li>
<li><a href="../pt412749/index.html">A eletr√¥nica como arte: corrente el√©trica</a></li>
<li><a href="../pt412751/index.html">Calv√≠cie: Teoria e pr√°tica do tratamento, parte 1 "Minha di-hidrotestosterona, meu inimigo"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>