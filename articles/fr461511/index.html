<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë¢ ‚ö´Ô∏è üèõÔ∏è Gestion des d√©pendances Python: une comparaison des approches ‚ò™Ô∏è üè¥Û†ÅßÛ†Å¢Û†Å∑Û†Å¨Û†Å≥Û†Åø üéß</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="J'√©cris en python depuis cinq ans, dont les trois derni√®res ann√©es ont d√©velopp√© mon propre projet. La plupart de cette fa√ßon, mon √©quipe m'aide. Et a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Gestion des d√©pendances Python: une comparaison des approches</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/461511/"><img src="http://ftcdn.pw/cd64d5e9-af9a-46cc-868b-c8873c98adb6.png" alt="image"><br><br>  J'√©cris en python depuis cinq ans, dont les trois derni√®res ann√©es ont d√©velopp√© mon propre projet.  La plupart de cette fa√ßon, mon √©quipe m'aide.  Et avec chaque version, avec chaque nouvelle fonctionnalit√©, nous essayons de plus en plus de faire en sorte que le projet ne se transforme pas en d√©sordre avec du code non pris en charge;  nous luttons avec les importations cycliques, les d√©pendances mutuelles, allouons des modules r√©utilisables, reconstruisons la structure. <br><br>  Malheureusement, dans la communaut√© Python, il n'y a pas de concept universel de ¬´bonne architecture¬ª, il n'y a que le concept de ¬´pythonicit√©¬ª, nous devons donc trouver l'architecture nous-m√™mes.  Under the cut - Longrid avec des r√©flexions sur l'architecture, et tout d'abord - sur la gestion des d√©pendances est applicable √† Python. <br><a name="habracut"></a><br><h1>  django.setup () </h1><br>  Je vais commencer par une question aux junglers.  √âcrivez-vous souvent ces deux lignes? <br><br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> django django.setup()</code> </pre> <br>  Vous devez d√©marrer le fichier √† partir de cela si vous souhaitez travailler avec des objets django sans d√©marrer le serveur web django lui-m√™me.  Cela s'applique aux mod√®les et aux outils pour travailler avec le temps ( <code><b>django.utils.timezone</b></code> ), les <code><b>django.urls.reverse</b></code> ( <code><b>django.urls.reverse</b></code> ), et bien plus encore.  Si cela n'est pas fait, vous obtiendrez une erreur: <br><br><pre> <code class="plaintext hljs">django.core.exceptions.AppRegistryNotReady: Apps aren't loaded yet.</code> </pre><br>  J'√©cris constamment ces deux lignes.  Je suis un grand fan du code d'√©jection;  J'aime cr√©er un fichier <code><b>.py</b></code> s√©par√©, y tordre les choses, le comprendre - puis l'int√©grer dans le projet. <br><br>  Et cette constante <code><b>django.setup()</b></code> me g√™ne beaucoup.  Premi√®rement, vous en avez assez de le r√©p√©ter partout;  et, deuxi√®mement, l'initialisation de django prend plusieurs secondes (nous avons un gros monolithe), et lorsque vous red√©marrez le m√™me fichier 10, 20, 100 fois - cela ralentit simplement le d√©veloppement. <br><br>  Comment se d√©barrasser de <code><b>django.setup()</b></code> ?  Vous devez √©crire du code qui d√©pend au minimum de django. <br><br>  Par exemple, si nous √©crivons un client d'une API externe, nous pouvons le rendre d√©pendant de django: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django.conf <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> settings <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">APIClient</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self.api_key = settings.SOME_API_KEY <span class="hljs-comment"><span class="hljs-comment"># : client = APIClient()</span></span></code> </pre><br>  ou il peut √™tre ind√©pendant de django: <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">APIClient</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, api_key)</span></span></span><span class="hljs-function">:</span></span> self.api_key = api_key <span class="hljs-comment"><span class="hljs-comment"># : client = APIClient(api_key='abc')</span></span></code> </pre><br>  Dans le deuxi√®me cas, le constructeur est plus encombrant, mais toutes les manipulations avec cette classe peuvent √™tre effectu√©es sans charger l'ensemble des machines dzhangovskoy. <br><br>  Les tests deviennent √©galement plus faciles.  Comment tester un composant qui d√©pend des param√®tres de <code><b>django.conf.settings</b></code> ?  Verrouillez-les simplement avec le d√©corateur <code><b>@override_settings</b></code> .  Et si le composant ne d√©pend de rien, il n'y aura rien √† mouiller: il a transmis les param√®tres au constructeur - et l'a conduit. <br><br><h1>  Gestion des d√©pendances </h1><br>  L'histoire des d√©pendances <code><b>django</b></code> est l'exemple le plus frappant d'un probl√®me que je rencontre tous les jours: les probl√®mes de gestion des d√©pendances en python - et l'architecture globale des applications python. <br><br>  La relation avec la gestion des d√©pendances dans la communaut√© Python est mitig√©e.  On distingue trois camps principaux: <br><br><ul><li>  Python est un langage flexible.  Nous √©crivons comme nous voulons, selon ce que nous voulons.  Nous ne sommes pas g√™n√©s par les d√©pendances cycliques, la substitution d'attributs pour les classes lors de l'ex√©cution, etc. <br><br></li><li>  Python est un langage sp√©cial.  Il existe des fa√ßons idiomatiques de cr√©er une architecture et des d√©pendances.  Le transfert de donn√©es vers le haut et vers le bas de la pile d'appels est effectu√© par des it√©rateurs, des coroutines et des gestionnaires de contexte. <br><br><div class="spoiler">  <b class="spoiler_title">Rapport de classe sur ce sujet et exemple</b> <div class="spoiler_text">  Brandon Rhodes, Dropbox: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Hissez votre IO</a> . <br><br>  Exemple du rapport: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""          """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">"/etc/hosts"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> file: <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> line <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> parse_hosts(file): print(line) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse_hosts</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(lines)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""    -   """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> line <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> lines: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> line.startswith(<span class="hljs-string"><span class="hljs-string">"#"</span></span>): <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span> <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> line</code> </pre><br></div></div><br></li><li>  La flexibilit√© de Python est un moyen suppl√©mentaire de se tirer une balle dans le pied.  Vous avez besoin d'un ensemble rigide de r√®gles pour g√©rer les d√©pendances.  Un bon exemple est les gars russes <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">de python sec</a> .  Il y a toujours une approche moins hardcore - la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">structure Django pour l'√©chelle et la long√©vit√©</a> , mais l'id√©e est la m√™me. <br></li></ul><br>  Il existe plusieurs articles sur la gestion des d√©pendances en python ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">exemple 1</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">exemple 2</a> ), mais ils se r√©sument tous √† la publicit√© des cadres d'injection de d√©pendance de quelqu'un.  Cet article est une nouvelle entr√©e sur le m√™me sujet, mais cette fois c'est une pure exp√©rience de pens√©e sans publicit√©.  Il s'agit d'une tentative de trouver un √©quilibre entre les trois approches ci-dessus, de se passer d'un cadre suppl√©mentaire et de le rendre ¬´pythonique¬ª. <br><br>  J'ai r√©cemment lu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Clean Architecture</a> - et je semble comprendre quelle est la valeur de l'injection de d√©pendances en python et comment elle peut √™tre impl√©ment√©e.  Je l'ai vu sur l'exemple de mon propre projet.  En bref, cela <b>prot√®ge le code contre la rupture lorsqu'un autre code change</b> . <br><br><h1>  Donn√©es source </h1><br>  Il existe un client API qui ex√©cute les requ√™tes HTTP pour le raccourcisseur de service: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># shortener_client.py import requests class ShortenerClient: def __init__(self, api_key): self.api_key = api_key def shorten_link(self, url): response = requests.post( url='https://fstrk.cc/short', headers={'Authorization': self.api_key}, json={'url': url} ) return response.json()['url']</span></span></code> </pre><br>  Et il y a un module qui raccourcit tous les liens dans le texte.  Pour ce faire, il utilise le client API raccourcisseur: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># text_processor.py import re from shortener_client import ShortenerClient class TextProcessor: def __init__(self, text): self.text = text def process(self): changed_text = self.text links = re.findall( r'https?://[^\r\n\t") ]*', self.text, flags=re.MULTILINE ) api_client = ShortenerClient('abc') for link in links: shortened = api_client.shorten_link(link) changed_text = changed_text.replace(link, shortened) return changed_text</span></span></code> </pre><br>  La logique d'ex√©cution du code r√©side dans un fichier de contr√¥le s√©par√© (appelons-le un contr√¥leur): <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># controller.py from text_processor import TextProcessor processor = TextProcessor("""  1: https://ya.ru  2: https://google.com """) print(processor.process())</span></span></code> </pre><br>  Tout fonctionne.  Le processeur analyse le texte, raccourcit les liens √† l'aide d'un raccourcisseur, renvoie le r√©sultat.  Les d√©pendances ressemblent √† ceci: <br><br><img src="http://ftcdn.pw/58d8aa1d-0024-42c6-918e-05b2d41f126d.png" alt="image"><br><br><h1>  Le probl√®me </h1><br>  Voici le probl√®me: la classe <code><b>TextProcessor</b></code> d√©pend de la classe <code><b>ShortenerClient</b></code> - et <b>s'arr√™te lorsque l'interface</b> <code><b>ShortenerClient</b></code> <b>change</b> . <br><br>  Comment cela peut-il arriver? <br><br>  Supposons que dans notre projet, nous avons d√©cid√© de suivre les <code><b>shorten_link</b></code> et d'ajouter l'argument <code><b>callback_url</b></code> √† la m√©thode <code><b>shorten_link</b></code> .  Cet argument signifie l'adresse √† laquelle les notifications doivent parvenir lorsque vous cliquez sur un lien. <br><br>  La m√©thode <code><b>ShortenerClient.shorten_link</b></code> commenc√© √† ressembler √† ceci: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">shorten_link</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, url, callback_url)</span></span></span><span class="hljs-function">:</span></span> response = requests.post( url=<span class="hljs-string"><span class="hljs-string">'https://fstrk.cc/short'</span></span>, headers={<span class="hljs-string"><span class="hljs-string">'Authorization'</span></span>: self.api_key}, json={<span class="hljs-string"><span class="hljs-string">'url'</span></span>: url, <span class="hljs-string"><span class="hljs-string">'callback_on_click'</span></span>: callback_url} ) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> response.json()[<span class="hljs-string"><span class="hljs-string">'url'</span></span>]</code> </pre><br>  Et que se passe-t-il?  Et il s'av√®re que lorsque nous essayons de commencer, nous obtenons une erreur: <br><br><pre> <code class="python hljs">TypeError: shorten_link() missing <span class="hljs-number"><span class="hljs-number">1</span></span> required positional argument: <span class="hljs-string"><span class="hljs-string">'callback_url'</span></span></code> </pre><br>  Autrement dit, nous avons chang√© le raccourcisseur, mais ce n'est pas lui qui s'est cass√©, mais son client: <br><br><img src="http://ftcdn.pw/13e9dcd5-7866-4c82-b1d0-e56134650b62.png" alt="image"><br><br>  Et alors?  Eh bien, le fichier d'appel s'est cass√©, nous sommes all√©s le r√©parer.  Quel est le probl√®me? <br><br>  Si cela est r√©solu en une minute - ils sont all√©s et corrig√©s - alors ce n'est bien s√ªr pas un probl√®me du tout.  S'il y a peu de code dans les classes et si vous les supportez vous-m√™me (c'est votre projet parall√®le, ce sont deux petites classes du m√™me sous-syst√®me, etc.), alors vous pouvez vous arr√™ter l√†. <br><br>  Les probl√®mes commencent lorsque: <br><br><ul><li>  les modules appelants et appel√©s ont beaucoup de code; </li><li>  diff√©rents modules sont pris en charge par diff√©rentes personnes / √©quipes. </li></ul><br>  Si vous √©crivez la classe <code><b>ShortenerClient</b></code> et que votre coll√®gue √©crit <code><b>TextProcessor</b></code> , vous obtenez une situation offensive: <b>vous avez modifi√© le code, mais il s'est cass√©.</b>  Et il s'est cass√© dans un endroit que vous n'avez pas vu dans la vie, et maintenant vous devez vous asseoir et comprendre le code de quelqu'un d'autre. <br><br>  Ce qui est encore plus int√©ressant, c'est lorsque votre module est utilis√© √† plusieurs endroits, et non √† un seul;  et votre modification cassera le code sur le tas de fichiers. <br><br>  Par cons√©quent, le probl√®me peut √™tre formul√© comme suit: comment organiser le code de sorte que lorsque l'interface <code><b>ShortenerClient</b></code> est modifi√©e, <code><b>ShortenerClient</b></code> <b>lui-m√™me <code><b>ShortenerClient</b></code> , et non ses consommateurs</b> (il peut y en avoir beaucoup) <br><br>  La solution ici est: <br><br><ul><li>  Les consommateurs de classe et la classe elle-m√™me doivent se mettre d'accord sur une interface commune.  Cette interface devrait devenir loi. </li><li>  Si la classe cesse de correspondre √† son interface, ce seront ses probl√®mes, et non les probl√®mes des consommateurs. </li></ul><br><img src="http://ftcdn.pw/dbb4d320-2683-4f2e-821e-dea621b54b53.png" alt="image"><br><br><h1>  Geler l'interface </h1><br>  √Ä quoi ressemble la fixation d'une interface en python?  Ceci est une classe abstraite: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> abc <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ABC, abstractmethod <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractClient</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(ABC)</span></span></span><span class="hljs-class">:</span></span> @abstractmethod <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, api_key)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> @abstractmethod <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">shorten_link</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, link)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span></code> </pre><br>  Si maintenant nous h√©ritons de cette classe et oublions d'impl√©menter une m√©thode, nous obtiendrons une erreur: <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ShortenerClient</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(AbstractClient)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__ini__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, api_key)</span></span></span><span class="hljs-function">:</span></span> self.api_key = api_key client = ShortenerClient(<span class="hljs-string"><span class="hljs-string">'123'</span></span>) &gt;&gt;&gt; TypeError: Can<span class="hljs-string"><span class="hljs-string">'t instantiate abstract class ShortenerClient with abstract methods __init__, shorten_link</span></span></code> </pre><br>  Mais cela ne suffit pas.  Une classe abstraite capture uniquement les noms des m√©thodes, mais pas leur signature. <br><br>  Besoin d'un deuxi√®me outil de v√©rification de signature Ce deuxi√®me outil est <code><b>mypy</b></code> .  Cela aidera √† v√©rifier les signatures des m√©thodes h√©rit√©es.  Pour ce faire, nous devons ajouter des annotations √† l'interface: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># shortener_client.py from abc import ABC, abstractmethod class AbstractClient(ABC): @abstractmethod def __init__(self, api_key: str) -&gt; None: pass @abstractmethod def shorten_link(self, link: str) -&gt; str: pass class ShortenerClient(AbstractClient): def __init__(self, api_key: str) -&gt; None: self.api_key = api_key def shorten_link(self, link: str, callback_url: str) -&gt; str: return 'xxx'</span></span></code> </pre><br>  Si nous v√©rifions maintenant ce code avec <code><b>mypy</b></code> , nous obtenons une erreur en raison de l'argument suppl√©mentaire <code><b>callback_url</b></code> : <br><br><pre> <code class="plaintext hljs">mypy shortener_client.py &gt;&gt;&gt; error: Signature of "shorten_link" incompatible with supertype "AbstractClient"</code> </pre><br>  Nous avons maintenant un moyen fiable de valider l'interface de classe. <br><br><h1>  Inversion de d√©pendance </h1><br>  Apr√®s avoir d√©bogu√© l'interface, nous devons la d√©placer vers un autre endroit afin d'√©liminer compl√®tement la d√©pendance du consommateur envers le fichier <code><b>shortener_client.py</b></code> .  Par exemple, vous pouvez faire glisser l'interface directement vers le consommateur - vers un fichier avec le processeur <code><b>TextProcessor</b></code> : <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># text_processor.py import re from abc import ABC, abstractmethod class AbstractClient(ABC): @abstractmethod def __init__(self, api_key: str) -&gt; None: pass @abstractmethod def shorten_link(self, link: str) -&gt; str: pass class TextProcessor: def __init__(self, text, shortener_client: AbstractClient) -&gt; None: self.text = text self.shortener_client = shortener_client def process(self) -&gt; str: changed_text = self.text links = re.findall( r'https?://[^\r\n\t") ]*', self.text, flags=re.MULTILINE ) for link in links: shortened = self.shortener_client.shorten_link(link) changed_text = changed_text.replace(link, shortened) return changed_text</span></span></code> </pre><br>  Et cela va changer le sens de la d√©pendance!  D√©sormais, le <code><b>TextProcessor</b></code> poss√®de l'interface d'interaction et, par cons√©quent, <code><b>ShortenerClient</b></code> d√©pend, et non l'inverse. <br><br><img src="http://ftcdn.pw/33f3c619-63bf-420d-99d0-67bed0dfa628.png" alt="image"><br><br>  En termes simples, nous pouvons d√©crire l'essence de notre transformation comme suit: <br><br><ul><li>  <code><b>TextProcessor</b></code> dit: Je suis un processeur et je suis impliqu√© dans la conversion de texte.  Je ne veux rien savoir du m√©canisme de raccourcissement: ce n'est pas mon affaire.  Je veux tirer la m√©thode <code><b>shorten_link</b></code> pour qu'elle <code><b>shorten_link</b></code> tout pour moi.  Alors s'il vous pla√Æt, donnez-moi un objet qui joue selon mes r√®gles.  Les d√©cisions sur la fa√ßon dont j'interagis sont prises par moi, pas par lui. </li><li>  <code><b>ShortenerClient</b></code> dit: il semble que je ne puisse pas exister dans le vide, et ils n√©cessitent un certain comportement de ma part.  Je vais demander √† <code><b>TextProcessor</b></code> ce dont j'ai besoin pour ne pas casser. </li></ul><br><h1>  Plusieurs consommateurs </h1><br>  Si plusieurs modules utilisent des liens raccourcis, l'interface doit √™tre plac√©e non pas dans l'un d'eux, mais dans un fichier s√©par√©, situ√© au-dessus des autres fichiers, plus haut dans la hi√©rarchie: <br><br><img src="http://ftcdn.pw/a81ef19a-45aa-4b23-b93a-e9a6b9094670.png" alt="image"><br><br><h1>  Composant de contr√¥le </h1><br>  Si les consommateurs n'importent pas <code><b>ShortenerClient</b></code> , alors qui l'importera et cr√©era un objet de classe?  Ce devrait √™tre un composant de contr√¥le - dans notre cas, c'est <code><b>controller.py</b></code> . <br><br>  L'approche la plus simple est une injection de d√©pendance directe, l'injection de d√©pendance ¬´dans le front¬ª.  Nous cr√©ons des objets dans le code appelant, transf√©rons un objet √† un autre.  B√©n√©fice <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># controller.py import TextProcessor import ShortenerClient processor = TextProcessor( text=' 1: https://ya.ru  2: https://google.com', shortener_client=ShortenerClient(api_key='123') ) print(processor.process())</span></span></code> </pre><br><h1>  Approche Python </h1><br>  Une approche plus ¬´pythonique¬ª serait l'injection de d√©pendance par h√©ritage. <br><br><div class="spoiler">  <b class="spoiler_title">Raymond Hettinger en parle en d√©tail dans son rapport Super r√©fl√©chi.</b> <div class="spoiler_text"><div class="oembed">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://www.youtube.com/watch?v=EiOglTERPEo</a> </div><br></div></div><br>  Pour adapter le code √† ce style, vous devez modifier l√©g√®rement le <code><b>TextProcessor</b></code> , le rendant h√©ritable: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># text_processor.py class TextProcessor: def __init__(self, text: str) -&gt; None: self.text = text self.shortener_client: AbstractClient = self.get_shortener_client() def get_shortener_client(self) -&gt; AbstractClient: """      """ raise NotImplementedError</span></span></code> </pre><br>  Et puis, dans le code appelant, h√©ritez-le: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># controller.py import TextProcessor import ShortenerClient class ProcessorWithClient(TextProcessor): """   ,    """ def get_shortener_client(self) -&gt; ShortenerClient: return ShortenerClient(api_key='abc') processor = ProcessorWithClient( text=' 1: https://ya.ru  2: https://google.com' ) print(processor.process())</span></span></code> </pre><br>  Le deuxi√®me exemple est omnipr√©sent dans les cadres populaires: <br><br><ul><li>  Chez Django, nous sommes constamment h√©rit√©s.  Nous red√©finissons les m√©thodes de vue bas√©e sur les classes, les mod√®les, les formulaires;  en d'autres termes, injectez nos d√©pendances dans le travail d√©j√† d√©bogu√© du framework. </li><li>  En DRF, la m√™me chose.  Nous √©largissons les vues, les s√©rialiseurs et les autorisations. </li><li>  Et ainsi de suite.  Il y a beaucoup d'exemples. </li></ul><br>  Le deuxi√®me exemple semble plus joli et plus familier, n'est-ce pas?  D√©veloppons-la et voyons si cette beaut√© est pr√©serv√©e. <br><br><h1>  D√©veloppement Python </h1><br>  Dans la logique m√©tier, il y a g√©n√©ralement plus de deux composants.  Supposons que notre <code><b>TextProcessor</b></code> n'est pas une classe ind√©pendante, mais seulement l'un des √©l√©ments du <code><b>TextPipeline</b></code> qui traite le texte et l'envoie √† la messagerie: <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TextPipeline</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, text, email)</span></span></span><span class="hljs-function">:</span></span> self.text_processor = TextProcessor(text) self.mailer = Mailer(email) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">process_and_mail</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function"> -&gt; </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">None</span></span></span><span class="hljs-function">:</span></span> processed_text = self.text_processor.process() self.mailer.send_text(text=processed_text)</code> </pre><br>  Si nous voulons isoler le <code><b>TextPipeline</b></code> des classes utilis√©es, nous devons suivre la m√™me proc√©dure que pr√©c√©demment: <br><br><ul><li>  la classe <code><b>TextPipeline</b></code> d√©clarera des interfaces pour les composants utilis√©s; </li><li>  les composants utilis√©s seront oblig√©s de se conformer √† ces interfaces; </li><li>  du code externe rassemblera tout et fonctionnera. </li></ul><br>  Le diagramme de d√©pendance ressemblera √† ceci: <br><br><img src="http://ftcdn.pw/35f207fa-3ad7-4779-92c3-ae8f63401b8e.png" alt="image"><br><br>  Mais √† quoi ressemblera maintenant le code assembleur de ces d√©pendances? <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> TextProcessor <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ShortenerClient <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Mailer <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> TextPipeline <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProcessorWithClient</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(TextProcessor)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_shortener_client</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function"> -&gt; ShortenerClient:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ShortenerClient(api_key=<span class="hljs-string"><span class="hljs-string">'123'</span></span>) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PipelineWithDependencies</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(TextPipeline)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_text_processor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, text: str)</span></span></span><span class="hljs-function"> -&gt; ProcessorWithClient:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ProcessorWithClient(text) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_mailer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, email: str)</span></span></span><span class="hljs-function"> -&gt; Mailer:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Mailer(email) pipeline = PipelineWithDependencies( email=<span class="hljs-string"><span class="hljs-string">'abc@def.com'</span></span>, text=<span class="hljs-string"><span class="hljs-string">' 1: https://ya.ru  2: https://google.com'</span></span> ) pipeline.process_and_mail()</code> </pre><br>  L'avez-vous remarqu√©?  Nous <code><b>TextProcessor</b></code> abord de la classe <code><b>TextProcessor</b></code> pour y ins√©rer le <code><b>ShortenerClient</b></code> , puis nous <code><b>TextPipeline</b></code> du <code><b>TextPipeline</b></code> pour y ins√©rer notre <code><b>TextProcessor</b></code> substitu√© (ainsi que <code><b>Mailer</b></code> ).  Nous avons plusieurs niveaux de red√©finition s√©quentielle.  D√©j√† compliqu√©. <br><br>  Pourquoi tous les cadres sont-ils organis√©s de cette mani√®re?  <b>Oui, car il ne convient qu'aux frameworks.</b> <br><br><ul><li>  Tous les niveaux du cadre sont clairement d√©finis et leur nombre est limit√©.  Par exemple, dans Django, vous pouvez remplacer <code><b>FormField</b></code> pour l'ins√©rer dans une substitution d'un <code><b>Form</b></code> , pour ins√©rer un formulaire dans une substitution de <code><b>View</b></code> .  C‚Äôest tout.  Trois niveaux. </li><li>  Chaque cadre sert un objectif.  Cette t√¢che est clairement d√©finie. </li><li>  Chaque cadre poss√®de une documentation d√©taill√©e qui d√©crit comment et quoi h√©riter;  quoi et avec quoi combiner. </li></ul><br>  Pouvez-vous identifier et documenter clairement et sans ambigu√Øt√© votre logique m√©tier?  Surtout l'architecture des niveaux auxquels il fonctionne?  Non.  Malheureusement, l'approche de Raymond Hettinger ne s'adapte pas √† la logique m√©tier. <br><br><h1>  Retour √† l'approche du front </h1><br>  √Ä plusieurs niveaux de difficult√©, une approche simple l'emporte.  Il semble plus simple - et plus facile √† changer lorsque la logique change. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> TextProcessor <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ShortenerClient <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Mailer <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> TextPipeline pipeline = TextPipeline( text_processor=TextProcessor( text=<span class="hljs-string"><span class="hljs-string">' 1: https://ya.ru  2: https://google.com'</span></span>, shortener_client=ShortenerClient(api_key=<span class="hljs-string"><span class="hljs-string">'abc'</span></span>) ), mailer=Mailer(<span class="hljs-string"><span class="hljs-string">'abc@def.com'</span></span>) ) pipeline.process_and_mail()</code> </pre><br>  Mais, lorsque le nombre de niveaux de logique augmente, m√™me cette approche devient incommode.  Nous devons imp√©rativement initier un tas de classes, les passer les uns dans les autres.  Je veux √©viter de nombreux niveaux d'imbrication. <br><br>  Essayons encore un appel. <br><br><h1>  Stockage d'instance global </h1><br>  Essayons de cr√©er un dictionnaire global dans lequel se trouveront les instances des composants dont nous avons besoin.  Et laissez ces composants s'obtenir gr√¢ce √† l'acc√®s √† ce dictionnaire. <br><br>  Appelons-le <code><b>INSTANCE_DICT</b></code> : <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># text_processor.py import INSTANCE_DICT class TextProcessor(AbstractTextProcessor): def __init__(self, text) -&gt; None: self.text = text def process(self) -&gt; str: shortener_client: AbstractClient = INSTANCE_DICT['Shortener'] # ...  </span></span></code> </pre><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># text_pipeline.py import INSTANCE_DICT class TextPipeline: def __init__(self) -&gt; None: self.text_processor: AbstractTextProcessor = INSTANCE_DICT[ 'TextProcessor'] self.mailer: AbstractMailer = INSTANCE_DICT['Mailer'] def process_and_mail(self) -&gt; None: processed_text = self.text_processor.process() self.mailer.send_text(text=processed_text)</span></span></code> </pre><br>  L'astuce consiste √† <b>mettre nos objets dans ce dictionnaire avant d'y acc√©der</b> .  C'est ce que nous ferons dans <code><b>controller.py</b></code> : <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># controller.py import INSTANCE_DICT import TextProcessor import ShortenerClient import Mailer import TextPipeline INSTANCE_DICT['Shortener'] = ShortenerClient('123') INSTANCE_DICT['Mailer'] = Mailer('abc@def.com') INSTANCE_DICT['TextProcessor'] = TextProcessor(text=' : https://ya.ru') pipeline = TextPipeline() pipeline.process_and_mail()</span></span></code> </pre><br>  Avantages de travailler avec un dictionnaire global: <br><br><ul><li>  pas de magie du capot moteur et des cadres DI suppl√©mentaires; </li><li>  une liste plate de d√©pendances dans lesquelles vous n'avez pas besoin de g√©rer l'imbrication; </li><li>  tous les bonus DI: tests simples, ind√©pendance, protection des composants contre les pannes lorsque d'autres composants changent. </li></ul><br>  Bien s√ªr, au lieu de cr√©er <code><b>INSTANCE_DICT</b></code> - <code><b>INSTANCE_DICT</b></code> , vous pouvez utiliser une sorte de framework DI;  mais l'essence de cela ne changera pas.  Le cadre offrira une gestion plus flexible des instances;  il vous permettra de les cr√©er sous forme de singletones ou de bundles, comme une usine;  mais l'id√©e restera la m√™me. <br><br>  Peut-√™tre qu'√† un moment donn√©, cela ne me suffira pas, et je continue de choisir une sorte de cadre. <br><br>  Et, peut-√™tre, tout cela est inutile, et il est plus facile de s'en passer: √©crire des importations directes et ne pas cr√©er d'interfaces abstraites inutiles. <br><br>  Quelle est votre exp√©rience avec la gestion des d√©pendances en python?  Et en g√©n√©ral - est-ce n√©cessaire, ou est-ce que j'invente un probl√®me de l'air? </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr461511/">https://habr.com/ru/post/fr461511/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr461501/index.html">Pourquoi aux √âtats-Unis, ils enqu√™tent sur le travail des grandes entreprises informatiques</a></li>
<li><a href="../fr461503/index.html">Rendre la base de donn√©es disponible pour une connexion √† distance</a></li>
<li><a href="../fr461505/index.html">8 bugs de d√©veloppeurs JavaScript novices qui vous emp√™chent de devenir un professionnel</a></li>
<li><a href="../fr461507/index.html">Pourquoi avons-nous d√©cid√© de lancer l'acc√©l√©rateur d'entreprise Gazprom Neft StartupDrive, et qui l'a d√©j√† adopt√©</a></li>
<li><a href="../fr461509/index.html">Assistants de voyage: une s√©lection de gadgets et accessoires</a></li>
<li><a href="../fr461517/index.html">Meilleurs algorithmes de copier-coller pour C et C ++. Haiku OS Cookbook</a></li>
<li><a href="../fr461519/index.html">Meilleurs algorithmes de copier-coller pour C et C ++. Collection de recettes Haiku OS</a></li>
<li><a href="../fr461523/index.html">WAL dans PostgreSQL: 4. Configuration du journal</a></li>
<li><a href="../fr461525/index.html">Comment j'ai fait un curseur vraiment adaptatif (carrousel)</a></li>
<li><a href="../fr461527/index.html">L√©vitation acoustique bricolage</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>