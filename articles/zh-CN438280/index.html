<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘©ğŸ½â€ğŸ¤â€ğŸ‘¨ğŸ¾ âœ… â• åœ¨Djangoä¸­â€œåˆ é™¤â€å¯¹è±¡ ğŸ‘ğŸ¼ ğŸ‘´ğŸ¿ ğŸ‘©â€ğŸ“</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="è¿Ÿæ—©ï¼Œå¼€å‘äººå‘˜éƒ½é¢ä¸´ç€åˆ é™¤ä¸å¿…è¦æ•°æ®çš„ä»»åŠ¡ã€‚ æœåŠ¡è¶Šå¤æ‚ï¼Œæ‚¨éœ€è¦è€ƒè™‘çš„ç»†å¾®å·®åˆ«å°±è¶Šå¤šã€‚ åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†æè¿°å¦‚ä½•åœ¨å…·æœ‰æ•°ç™¾ä¸ªé“¾æ¥çš„æ•°æ®åº“ä¸­å®ç°â€œåˆ é™¤â€ã€‚ 

 èƒŒæ™¯çŸ¥è¯† 
 ä¸ºäº†ç›‘è§†å¤§å¤šæ•°é¡¹ç›®çš„å¯æ“ä½œæ€§ï¼Œ Mail.ru Groupå’ŒVKontakteä½¿ç”¨äº†è‡ªå·±å¼€å‘çš„æœåŠ¡-Monitoring ã€‚ ä»...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>åœ¨Djangoä¸­â€œåˆ é™¤â€å¯¹è±¡</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/438280/"><img src="https://habrastorage.org/webt/6h/-4/-w/6h-4-wzp5wlydal3wkp2df8aq5a.jpeg"><br><br> è¿Ÿæ—©ï¼Œå¼€å‘äººå‘˜éƒ½é¢ä¸´ç€åˆ é™¤ä¸å¿…è¦æ•°æ®çš„ä»»åŠ¡ã€‚ æœåŠ¡è¶Šå¤æ‚ï¼Œæ‚¨éœ€è¦è€ƒè™‘çš„ç»†å¾®å·®åˆ«å°±è¶Šå¤šã€‚ åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†æè¿°å¦‚ä½•åœ¨å…·æœ‰æ•°ç™¾ä¸ªé“¾æ¥çš„æ•°æ®åº“ä¸­å®ç°â€œåˆ é™¤â€ã€‚ <br><a name="habracut"></a><br><h2> èƒŒæ™¯çŸ¥è¯† </h2><br> ä¸ºäº†ç›‘è§†å¤§å¤šæ•°é¡¹ç›®çš„å¯æ“ä½œæ€§ï¼Œ <b>Mail.ru Group</b>å’Œ<b>VKontakte</b>ä½¿ç”¨äº†è‡ªå·±å¼€å‘çš„æœåŠ¡<b>-Monitoring</b> ã€‚ ä»2012å¹´åº•å¼€å§‹å…¶å†å²ï¼Œç»è¿‡6å¹´çš„å‘å±•ï¼Œè¯¥é¡¹ç›®å·²å‘å±•æˆä¸ºä¸€ä¸ªåºå¤§çš„ç³»ç»Ÿï¼Œå¹¶è·å¾—äº†è®¸å¤šåŠŸèƒ½ã€‚ ç›‘è§†å®šæœŸæ£€æŸ¥æœåŠ¡å™¨çš„å¯ç”¨æ€§å’Œå¯¹è¯·æ±‚çš„å“åº”çš„æ­£ç¡®æ€§ï¼Œæ”¶é›†æœ‰å…³å·²ç”¨å†…å­˜ï¼ŒCPUåˆ©ç”¨ç‡çš„ç»Ÿè®¡ä¿¡æ¯ã€‚ å½“å—ç›‘è§†æœåŠ¡å™¨çš„å‚æ•°è¶…è¿‡å…è®¸å€¼æ—¶ï¼Œè´Ÿè´£æœåŠ¡å™¨çš„å‚æ•°å°†åœ¨ç³»ç»Ÿä¸­é€šè¿‡SMSæ¥æ”¶é€šçŸ¥ã€‚ <br><br> è®°å½•æ‰€æœ‰æ£€æŸ¥å’Œäº‹ä»¶ä»¥è·Ÿè¸ªæœåŠ¡å™¨æ€§èƒ½çš„åŠ¨æ€ï¼Œå› æ­¤æ•°æ®åº“å·²è¾¾åˆ°æ•°äº¿æ¡è®°å½•çš„é¡ºåºã€‚ æ–°æœåŠ¡å™¨å®šæœŸå‡ºç°ï¼Œè€Œæ—§æœåŠ¡å™¨ä¸å†ä½¿ç”¨ã€‚ å¿…é¡»ä»ç›‘è§†ç³»ç»Ÿä¸­åˆ é™¤æœ‰å…³æœªä½¿ç”¨æœåŠ¡å™¨çš„ä¿¡æ¯ï¼Œä»¥ä¾¿ï¼š <i>aï¼‰é¿å…ä¸å¿…è¦çš„ä¿¡æ¯ä½¿æ¥å£è¿‡è½½ï¼Œ</i>å¹¶ä¸”<i>bï¼‰é‡Šæ”¾å”¯ä¸€æ ‡è¯†ç¬¦</i> ã€‚ <br><br><h2> åˆ æ‰ </h2><br> æˆ‘æ˜çŸ¥åœ¨æ–‡ç« çš„æ ‡é¢˜ä¸­ï¼Œâ€œåˆ é™¤â€ä¸€è¯ç”¨å¼•å·å¼•èµ·æ¥ã€‚ æœ‰å‡ ç§æ–¹æ³•å¯ä»¥ä»ç³»ç»Ÿä¸­åˆ é™¤å¯¹è±¡ï¼š <br><br><ul><li> ä»æ•°æ®åº“ä¸­å®Œå…¨åˆ é™¤ï¼› </li><li> å°†å¯¹è±¡æ ‡è®°ä¸ºå·²åˆ é™¤å¹¶ä»ç•Œé¢éšè—ã€‚ ä½œä¸ºæ ‡è®°ï¼Œå¯ä»¥ä½¿ç”¨å¸ƒå°”å€¼æˆ–DateTimeè¿›è¡Œæ›´å‡†ç¡®çš„è®°å½•ã€‚ </li></ul><br><h4> è¿­ä»£1 </h4><br> æœ€åˆï¼Œå½“æˆ‘ä»¬ç®€å•åœ°æ‰§è¡Œ<code>object.delete()</code>å¹¶åˆ é™¤å…·æœ‰æ‰€æœ‰ä¾èµ–é¡¹çš„å¯¹è±¡æ—¶ï¼Œä½¿ç”¨ç¬¬ä¸€ç§æ–¹æ³•ã€‚ ä½†æ˜¯éšç€æ—¶é—´çš„æµé€ï¼Œæˆ‘ä»¬ä¸å¾—ä¸æ”¾å¼ƒè¿™ç§æ–¹æ³•ï¼Œå› ä¸ºä¸€ä¸ªå¯¹è±¡å¯èƒ½ä¸æ•°ç™¾ä¸‡ä¸ªå…¶ä»–å¯¹è±¡å…·æœ‰ä¾èµ–æ€§ï¼Œå¹¶ä¸”çº§è”åˆ é™¤ä¼šä¸¥æ ¼é˜»æ­¢è¡¨ã€‚ è€Œä¸”ç”±äºè¯¥æœåŠ¡æ¯ç§’æ‰§è¡Œæ•°åƒæ¬¡æ£€æŸ¥å¹¶å°†å…¶è®°å½•ä¸‹æ¥ï¼Œå› æ­¤é˜»å¡è¡¨å¯¼è‡´è¯¥æœåŠ¡ä¸¥é‡é™ä½é€Ÿåº¦ï¼Œè¿™å¯¹æˆ‘ä»¬æ¥è¯´æ˜¯æ— æ³•æ¥å—çš„ã€‚ <br><br><h4> è¿­ä»£2 </h4><br> ä¸ºäº†é¿å…é•¿æ—¶é—´é”å®šï¼Œæˆ‘ä»¬å†³å®šåˆ†æ‰¹åˆ é™¤æ•°æ®ã€‚ è¿™å°†å…è®¸åœ¨åˆ é™¤å¯¹è±¡ä¹‹é—´çš„é—´éš”ä¸­è®°å½•å®é™…çš„ç›‘è§†æ•°æ®ã€‚ åˆ é™¤å¯¹è±¡æ—¶ï¼ˆç¡®è®¤åˆ é™¤æ—¶ï¼‰ï¼Œå¯ä»¥é€šè¿‡ç®¡ç†é¢æ¿ä¸­ä½¿ç”¨çš„æ–¹æ³•æ¥è·å–å°†è¦çº§è”åˆ é™¤çš„æ‰€æœ‰å¯¹è±¡çš„åˆ—è¡¨ï¼š <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django.contrib.admin.util <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> NestedObjects <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django.db <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> DEFAULT_DB_ALIAS collector = NestedObjects(using=DEFAULT_DB_ALIAS) collector.collect([obj]) objects_to_delete = collector.nested() <span class="hljs-comment"><span class="hljs-comment"># Recursive delete objects</span></span></code> </pre> <br> æƒ…å†µæœ‰æ‰€æ”¹å–„ï¼šéšç€æ—¶é—´çš„æ¨ç§»åˆ†é…äº†è´Ÿè½½ï¼Œå¼€å§‹æ›´å¿«åœ°è®°å½•æ–°æ•°æ®ã€‚ ä½†æ˜¯æˆ‘ä»¬ç«‹å³é‡åˆ°äº†ä¸‹ä¸€ä¸ªé™·é˜±ã€‚ äº‹å®æ˜¯ï¼Œè¦åˆ é™¤çš„å¯¹è±¡åˆ—è¡¨æ˜¯åœ¨åˆ é™¤çš„æœ€å¼€å§‹å°±å½¢æˆçš„ï¼Œå¦‚æœåœ¨â€œéƒ¨åˆ†â€åˆ é™¤è¿‡ç¨‹ä¸­æ·»åŠ äº†æ–°çš„ä»å±å¯¹è±¡ï¼Œåˆ™ä¸èƒ½åˆ é™¤çˆ¶å…ƒç´ ã€‚ <br><br> æˆ‘ä»¬ç«‹å³æ”¾å¼ƒäº†é€’å½’åˆ é™¤é”™è¯¯çš„æƒ³æ³•ï¼Œä»¥å†æ¬¡æ”¶é›†æœ‰å…³æ–°ä¾èµ–é¡¹çš„æ•°æ®æˆ–åœ¨åˆ é™¤æ—¶ç¦æ­¢æ·»åŠ ä¾èµ–é¡¹è®°å½•ï¼Œå› ä¸º<i>aï¼‰æ‚¨å¯ä»¥è¿›å…¥æ— é™å¾ªç¯ï¼Œ</i>æˆ–è€…<i>bï¼‰æ‚¨å¿…é¡»åœ¨æ•´ä¸ªä»£ç ä¸­æ‰¾åˆ°æ‰€æœ‰ä¾èµ–é¡¹</i> ã€‚ <br><br><h4> è¿­ä»£3 </h4><br> æˆ‘ä»¬è€ƒè™‘äº†ç¬¬äºŒç§åˆ é™¤æ–¹å¼ï¼Œå³åœ¨ç•Œé¢ä¸Šæ ‡è®°å’Œéšè—æ•°æ®æ—¶ã€‚ æœ€åˆï¼Œè¿™ç§æ–¹æ³•è¢«æ‹’ç»äº†ï¼Œå› ä¸ºè¿™ä¼¼ä¹è¦èŠ±è‡³å°‘ä¸€å‘¨çš„æ—¶é—´æ¥æŸ¥æ‰¾æ‰€æœ‰æŸ¥è¯¢å¹¶ä¸ºç¼ºå°‘åˆ é™¤çš„çˆ¶é¡¹æ·»åŠ è¿‡æ»¤å™¨ã€‚ å¦å¤–ï¼Œå¾ˆå¯èƒ½ä¼šä¸¢å¤±å¿…è¦çš„ä»£ç ï¼Œè¿™å°†å¯¼è‡´ä¸å¯é¢„æµ‹çš„åæœã€‚ <br><br> ç„¶åï¼Œæˆ‘ä»¬å†³å®šä½¿ç”¨è£…é¥°å™¨æ¥è¦†ç›–æŸ¥è¯¢ç®¡ç†å™¨ã€‚ æ­¤å¤–ï¼Œçœ‹ä»£ç æ¯”å†™ä¸€ç™¾ä¸ªå•è¯æ›´å¥½ã€‚ <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">exclude_objects_for_deleted_hosts</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*fields)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">""" Decorator that adds .exclude({field__}is_deleted=True) for model_class.objects.get_queryset :param fields: fields for exclude condition """</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">wrapper</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(model_class)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">apply_filters</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(qs)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> field <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> filter_fields: qs = qs.exclude(**{ <span class="hljs-string"><span class="hljs-string">'{}is_deleted'</span></span>.format(<span class="hljs-string"><span class="hljs-string">'{}__'</span></span>.format(field) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> field <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span>): <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, }) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> qs model_class.all_objects = copy.deepcopy(model_class.objects) filter_fields = set(fields) get_queryset = model_class.objects.get_queryset model_class.objects.get_queryset = <span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>: apply_filters(get_queryset()) <span class="hljs-comment"><span class="hljs-comment"># save info about model decorator setattr(model_class, DECORATOR_DEL_HOST_ATTRIBUTE, filter_fields) return model_class return wrapper</span></span></code> </pre><br> å­—æ®µæ¨¡å‹çš„æŒ‡å®šå­—æ®µçš„<code>exclude_objects_for_deleted_hosts(fields)</code>ä¿®é¥°å™¨ä¼šä¸ºæ¯ä¸ªè¯·æ±‚è‡ªåŠ¨æ·»åŠ ä¸€ä¸ª<code>exclude</code>è¿‡æ»¤å™¨ï¼Œè¯¥è¿‡æ»¤å™¨åªä¼šåˆ é™¤ä¸åº”åœ¨ç•Œé¢ä¸­æ˜¾ç¤ºçš„æ¡ç›®ã€‚ <br><br> ç°åœ¨ï¼Œå¯¹äºæ‰€æœ‰å› åˆ é™¤è€Œå—åˆ°æŸç§å½±å“çš„æ¨¡å‹è€Œè¨€ï¼Œæ·»åŠ ä¸€ä¸ªè£…é¥°å™¨å°±è¶³å¤Ÿäº†ï¼š <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@exclude_objects_for_deleted_hosts('host') class Alias(models.Model): host = models.ForeignKey(to=Host, verbose_name='Host', related_name='alias')</span></span></code> </pre><br> ç°åœ¨ï¼Œä¸ºäº†åˆ é™¤<code>Host</code>å¯¹è±¡ï¼Œåªéœ€æ›´æ”¹<code>is_deleted</code>å±æ€§ï¼š <br><br><pre> <code class="python hljs">host.is_deleted = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-comment"><span class="hljs-comment"># after this save the host and all related objects will be inaccessible host.save()</span></span></code> </pre> <br> æ‰€æœ‰æŸ¥è¯¢å°†è‡ªåŠ¨æ’é™¤å¼•ç”¨è¿œç¨‹å¯¹è±¡çš„è®°å½•ï¼š <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># model decorator @exclude_objects_for_deleted_hosts('checker__monhost', 'alias__host') CheckerToAlias.objects.filter( alias__hostname__in=['cloud.spb.s', 'cloud.msk.s'] ).values('id')</span></span></code> </pre><br> åŸæ¥æ˜¯ä»¥ä¸‹SQLæŸ¥è¯¢ï¼š <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> monitoring_checkertoalias.id <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> monitoring_checkertoalias <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> monitoring_checker <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (<span class="hljs-string"><span class="hljs-string">`monitoring_checkertoalias`</span></span>.<span class="hljs-string"><span class="hljs-string">`checker_id`</span></span> = monitoring_checker.<span class="hljs-string"><span class="hljs-string">`id`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Hosts</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (<span class="hljs-string"><span class="hljs-string">`monitoring_checker`</span></span>.<span class="hljs-string"><span class="hljs-string">`monhost_id`</span></span> = Hosts.<span class="hljs-string"><span class="hljs-string">`id`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> dcmap_alias <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (<span class="hljs-string"><span class="hljs-string">`monitoring_checkertoalias`</span></span>.<span class="hljs-string"><span class="hljs-string">`alias_id`</span></span> = dcmap_alias.<span class="hljs-string"><span class="hljs-string">`id`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Hosts</span></span> T5 <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (<span class="hljs-string"><span class="hljs-string">`dcmap_alias`</span></span>.<span class="hljs-string"><span class="hljs-string">`host_id`</span></span> = T5.<span class="hljs-string"><span class="hljs-string">`id`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> (<span class="hljs-string"><span class="hljs-string">`Hosts`</span></span>.<span class="hljs-string"><span class="hljs-string">`is_deleted`</span></span> = <span class="hljs-literal"><span class="hljs-literal">TRUE</span></span>) <span class="hljs-comment"><span class="hljs-comment">-- ,   monitoring_checker AND NOT (T5.`is_deleted` = TRUE) -- ,   dcmap_alias AND dcmap_alias.name IN ('dir1.server.p', 'dir2.server.p') );</span></span></code> </pre> <br> å¦‚æ‚¨æ‰€è§ï¼Œè£…é¥°å™¨ä¸­æŒ‡å®šçš„å­—æ®µçš„å…¶ä»–è”æ¥ä»¥åŠå¯¹<code>`is_deleted` = TRUE</code>æ£€æŸ¥<code>`is_deleted` = TRUE</code>æ·»åŠ åˆ°è¯·æ±‚ä¸­ã€‚ <br><br><h2> å…³äºæ•°å­—çš„ä¸€ç‚¹ </h2><br> é€»è¾‘ä¸Šï¼Œå…¶ä»–è”æ¥å’Œæ¡ä»¶ä¼šå¢åŠ æŸ¥è¯¢æ‰§è¡Œæ—¶é—´ã€‚ å¯¹è¿™ä¸ªé—®é¢˜çš„ç ”ç©¶è¡¨æ˜ï¼Œâ€œå¤æ‚æ€§â€çš„ç¨‹åº¦å–å†³äºæ•°æ®åº“çš„ç»“æ„ï¼Œè®°å½•çš„æ•°é‡å’Œç´¢å¼•çš„å­˜åœ¨ã€‚ <br><br> å…·ä½“æ¥è¯´ï¼Œåœ¨æˆ‘ä»¬çš„æ¡ˆä¾‹ä¸­ï¼Œå¯¹äºæ¯ä¸ªä¾èµ–çº§åˆ«ï¼Œè¯¥è¯·æ±‚éƒ½ä¼šè¢«ç½šæ¬¾çº¦30ï¼…ã€‚ è¿™æ˜¯æˆ‘ä»¬åœ¨å…·æœ‰æ•°ç™¾ä¸‡æ¡è®°å½•çš„æœ€å¤§è¡¨ä¸Šè·å¾—çš„æœ€å¤§æƒ©ç½šï¼›åœ¨è¾ƒå°çš„è¡¨ä¸Šï¼Œæƒ©ç½šè¢«å‡å°‘åˆ°ç™¾åˆ†ä¹‹å‡ ã€‚ å¹¸è¿çš„æ˜¯ï¼Œæˆ‘ä»¬å·²ç»é…ç½®äº†å¿…è¦çš„ç´¢å¼•ï¼Œå¹¶ä¸”å¯¹äºå¤§å¤šæ•°å…³é”®æŸ¥è¯¢è€Œè¨€ï¼Œå·²ç»æœ‰äº†å¿…è¦çš„è”æ¥ï¼Œå› æ­¤æˆ‘ä»¬åœ¨æ€§èƒ½ä¸Šå¹¶æ²¡æœ‰å¤ªå¤§çš„åŒºåˆ«ã€‚ <br><br><h2> å”¯ä¸€æ ‡è¯†ç¬¦ </h2><br> åœ¨åˆ é™¤æ•°æ®ä¹‹å‰ï¼Œå¯èƒ½æœ‰å¿…è¦é‡Šæ”¾è®¡åˆ’åœ¨å°†æ¥ä½¿ç”¨çš„æ ‡è¯†ç¬¦ï¼Œå› ä¸ºè¿™ä¼šåœ¨åˆ›å»ºæ–°å¯¹è±¡æ—¶å¼•èµ·éå”¯ä¸€é”™è¯¯ã€‚ å°½ç®¡æ²¡æœ‰å¯¹è±¡åœ¨Djangoåº”ç”¨ç¨‹åºä¸­å¯è§ï¼Œä½†å®ƒä»¬ä»å°†å­˜åœ¨äºæ•°æ®åº“ä¸­ã€‚ å› æ­¤ï¼Œå¯¹äºå·²åˆ é™¤çš„å¯¹è±¡ï¼Œæˆ‘ä»¬å°†uuidé™„åŠ åˆ°æ ‡è¯†ç¬¦ã€‚ <br><br><pre> <code class="python hljs">host.hostname = <span class="hljs-string"><span class="hljs-string">'{}_{}'</span></span>.format(host.hostname, uuid.uuid4()) host.is_deleted = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> host.save()</code> </pre><br><h2> è¿ä½œæ–¹å¼ </h2><br> å¯¹äºæ¯ä¸ªæ–°æ¨¡å‹æˆ–ä¾èµ–é¡¹ï¼Œå¿…è¦æ—¶éœ€è¦æ›´æ–°è£…é¥°å™¨ã€‚ ä¸ºäº†ç®€åŒ–å¯¹ä¾èµ–æ¨¡å‹çš„æœç´¢ï¼Œæˆ‘ä»¬ç¼–å†™äº†ä¸€ä¸ªâ€œæ™ºèƒ½â€æµ‹è¯•ï¼š <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_deleted_host_decorator_for_models</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">recursive_host_finder</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(model, cache, path, filters)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># cache for skipping looked models cache.add(model) # process all related models for field in (f for f in model._meta.fields if isinstance(f, ForeignKey)): if field.related_model == Host: filters.add(path + field.name) elif field.related_model not in cache: recursive_host_finder(field.related_model, cache.copy(), path + field.name + '__', filters) # check all models for current_model in apps.get_models(): model_filters = getattr(current_model, DECORATOR_DEL_HOST_ATTRIBUTE, set()) found_filters = set() if current_model == Host: found_filters.add('') else: recursive_host_finder(current_model, set(), '', found_filters) if found_filters or model_filters: try: self.assertSetEqual(model_filters, found_filters) except AssertionError as err: err.args = ( '{}\n !!! Fix decorator "exclude_objects_for_deleted_hosts" ' 'for model {}'.format(err.args[0], current_model), ) raise err</span></span></code> </pre><br> è¯¥æµ‹è¯•ä»¥é€’å½’æ–¹å¼æ£€æŸ¥æ‰€æœ‰æ¨¡å‹æ˜¯å¦å­˜åœ¨è¦åˆ é™¤çš„æ¨¡å‹çš„ä¾èµ–é¡¹ï¼Œç„¶åæŸ¥çœ‹æ˜¯å¦å·²ä¸ºæ­¤æ¨¡å‹è®¾ç½®äº†å¿…éœ€å­—æ®µçš„è£…é¥°å™¨ã€‚ å¦‚æœç¼ºå°‘æŸäº›å†…å®¹ï¼Œåˆ™æµ‹è¯•ä¼šå·§å¦™åœ°å‘Šè¯‰æ‚¨åœ¨å“ªé‡Œæ·»åŠ è£…é¥°å™¨ã€‚ <br><br><h2> ç»“è¯­ </h2><br> å› æ­¤ï¼Œå€ŸåŠ©è£…é¥°å™¨ï¼Œå¯ä»¥å®ç°å¯¹å…·æœ‰å¤§é‡ä¾èµ–å…³ç³»çš„æ•°æ®çš„â€œå°åˆ é™¤â€ã€‚ æ‰€æœ‰è¯·æ±‚éƒ½ä¼šè‡ªåŠ¨æ”¶åˆ°æ‰€éœ€çš„<code>exclude</code>è¿‡æ»¤å™¨ã€‚ æ–½åŠ é™„åŠ æ¡ä»¶ä¼šå‡æ…¢æ•°æ®è·å–çš„è¿‡ç¨‹ï¼Œâ€œå¤æ‚â€ç¨‹åº¦å–å†³äºæ•°æ®åº“çš„ç»“æ„ï¼Œè®°å½•æ•°å’Œç´¢å¼•çš„å¯ç”¨æ€§ã€‚ å»ºè®®çš„æµ‹è¯•å°†å‘Šè¯‰æ‚¨éœ€è¦ä¸ºå“ªäº›æ¨¡å‹æ·»åŠ è£…é¥°å™¨ï¼Œå¹¶åœ¨å°†æ¥ç›‘è§†å…¶ä¸€è‡´æ€§ã€‚ </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN438280/">https://habr.com/ru/post/zh-CN438280/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN438266/index.html">ä¸ºä»€ä¹ˆæ¸—é€æµ‹è¯•å¯¹æ‚¨çš„ä¸šåŠ¡å¾ˆé‡è¦ï¼Ÿ</a></li>
<li><a href="../zh-CN438270/index.html">åœ¨Mail.ruç»„çˆ±Kubernetesï¼š2æœˆ14æ—¥</a></li>
<li><a href="../zh-CN438272/index.html">æˆ‘ä»¬å¦‚ä½•ä»å±±æ´å‘é€çŸ­ä¿¡</a></li>
<li><a href="../zh-CN438274/index.html">ITä¸­â€œæœ‰æ¯’äººæ ¼â€çš„å®šä¹‰</a></li>
<li><a href="../zh-CN438278/index.html">æ•™å­©å­ç¼–ç¨‹</a></li>
<li><a href="../zh-CN438286/index.html">åœ¨JavaScriptä¸­ä½¿ç”¨æ—¶åŒº</a></li>
<li><a href="../zh-CN438288/index.html">æ— æ‰€ç•æƒ§çš„ä¿æŠ¤ã€‚ Rustçš„å†…å­˜å®‰å…¨æ€§</a></li>
<li><a href="../zh-CN438290/index.html">GGJ-2019çš„äº‹ååˆ†æï¼šå¦‚ä½•è·å¾—æˆåŠŸï¼Œä½†ä»èƒ½ä½¿æ¸¸æˆæˆä¸ºç°å®</a></li>
<li><a href="../zh-CN438292/index.html">ä½¿ç”¨HomePodï¼ŒRaspberry Piå’ŒNode.jsçš„å…¬å¯“è‡ªåŠ¨åŒ–</a></li>
<li><a href="../zh-CN438294/index.html">åœ¨PUBGæ¯”èµ›ä¸­æŸ¥æ‰¾æŠ½æå½©å¸¦</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>