<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèΩ‚Äçüî¨ ü§πüèæ üë©‚Äçüë©‚Äçüëß 5 fa√ßons de d√©ployer du code PHP dans des conditions de surcharge üç∏ üë∂üèº üèÇüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Si l'enseignement routier √©tait enseign√© √† l'√©cole, le manuel sur ce sujet aurait une telle t√¢che. ¬´Le r√©seau social N compte 2 000 serveurs, sur lesq...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>5 fa√ßons de d√©ployer du code PHP dans des conditions de surcharge</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/449916/">  Si l'enseignement routier √©tait enseign√© √† l'√©cole, le manuel sur ce sujet aurait une telle t√¢che.  ¬´Le r√©seau social N compte 2 000 serveurs, sur lesquels 150 000 fichiers de 900 Mo de code PHP et un cluster interm√©diaire pour 50 machines.  Le code est d√©ploy√© sur les serveurs 2 fois par jour, sur le cluster interm√©diaire, le code est mis √† jour toutes les quelques minutes, et il existe des ¬´correctifs¬ª suppl√©mentaires - de petits ensembles de fichiers qui sont dispos√©s √† leur tour sur tout ou sur la partie s√©lectionn√©e des serveurs, sans attendre le calcul complet.  Question: ces conditions sont-elles consid√©r√©es comme des charges √©lev√©es et comment les d√©ployer?  √âcrivez au moins 5 options de d√©ploiement. "  Nous ne pouvons que r√™ver du livre de probl√®mes hyload, mais nous savons d√©j√† que <strong>Yuri Nasretdinov</strong> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">youROCK</a> ) r√©soudrait d√©finitivement ce probl√®me et obtiendrait les ¬´cinq¬ª. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/qMu4YHJV1Z8" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Yuri ne s'est pas content√© d'une solution simple, mais a √©galement fait un rapport dans lequel il a divulgu√© le concept du concept de ¬´d√©ploiement de code¬ª, a parl√© de solutions classiques et alternatives aux d√©ploiements PHP √† grande √©chelle, analys√© leurs performances et pr√©sent√© le syst√®me de d√©ploiement MDK. <br><a name="habracut"></a><br><h2>  Le concept de ¬´d√©ploiement de code¬ª </h2><br>  En anglais, le terme ¬´d√©ployer¬ª signifie mettre les troupes en alerte, et en russe, nous disons parfois ¬´mettre le code au combat¬ª, ce qui signifie la m√™me chose.  Vous prenez le code dans celui d√©j√† compil√© ou dans l'original, s'il s'agit de PHP, t√©l√©chargez-le sur les serveurs qui servent le trafic utilisateur, puis, par magie, passez d'une mani√®re ou d'une autre la charge d'une version du code √† une autre.  Tout cela est inclus dans le concept de ¬´d√©ploiement de code¬ª. <br><br>  Le processus de d√©ploiement comprend g√©n√©ralement plusieurs √©tapes. <br><br><ul><li>  <strong>R√©cup√©rer le code du r√©f√©rentiel</strong> comme vous le souhaitez: cloner, r√©cup√©rer, extraire. </li><li> <strong>Assemblage - construire</strong> .  Pour le code PHP, la phase de construction peut √™tre manquante.  Dans notre cas, il s'agit, en r√®gle g√©n√©rale, de la g√©n√©ration automatique de fichiers de traduction, du t√©l√©chargement de fichiers statiques sur CDN et de certaines autres op√©rations. </li><li>  <strong>Livraison aux serveurs finaux</strong> - d√©ploiement. </li></ul><br>  Une fois que tout est assembl√©, la phase du d√©ploiement imm√©diat commence - le <strong>code</strong> est <strong>vers√© sur les serveurs de production</strong> .  C'est √† propos de cette phase que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Badoo</a> sera discut√©. <br><br><h2>  Ancien syst√®me de d√©ploiement √† Badoo </h2><br>  Si vous avez un fichier avec une image du syst√®me de fichiers, comment le monter?  Sous Linux, vous devez cr√©er <strong>un p√©riph√©rique de boucle interm√©diaire</strong> , y attacher un fichier et apr√®s cela, vous pouvez d√©j√† monter ce p√©riph√©rique de bloc. <br><br>  Un p√©riph√©rique en boucle est une b√©quille dont Linux a besoin pour monter une image de syst√®me de fichiers.  Il existe des OS dans lesquels cette b√©quille n'est pas requise. <br><br><img src="https://habrastorage.org/webt/gd/ch/h6/gdchh68qpl5ikkpddsvxzwcwvlm.png"><br><br>  Comment le processus de d√©ploiement utilise-t-il des fichiers, que nous appelons √©galement ¬´boucles¬ª pour simplifier?  Il existe un r√©pertoire dans lequel se trouvent le code source et le contenu g√©n√©r√© automatiquement.  Nous prenons une image vide du syst√®me de fichiers - maintenant c'est EXT2, et plus t√¥t nous utilisions ReiserFS.  Nous montons une image vide du syst√®me de fichiers dans un r√©pertoire temporaire, y copions tout le contenu.  Si nous n'avons pas besoin de quelque chose pour entrer en production, nous ne copions pas tout.  Apr√®s cela, d√©montez le p√©riph√©rique et obtenez l'image du syst√®me de fichiers dans lequel se trouvent les fichiers n√©cessaires.  Ensuite, nous <strong>archivons l'image et la t√©l√©chargeons sur tous les serveurs</strong> , nous la d√©compressons et la montons. <br><br><h2>  Autres solutions existantes </h2><br>  Tout d'abord, remercions <strong>Richard Stallman</strong> - sans sa licence, la plupart des utilitaires que nous utilisons n'auraient pas exist√©. <br><br><img src="https://habrastorage.org/webt/8h/oa/yh/8hoayhyyicam7izl-q7egj8bitq.png"><br><br>  J'ai classiquement divis√© les m√©thodes de d√©ploiement de code PHP en 4 cat√©gories. <br><br><ul><li>  <strong>Bas√© sur le syst√®me de contr√¥le de version</strong> : svn up, git pull, hg up. </li><li>  <strong>Bas√© sur l'utilitaire rsync</strong> - vers un nouveau r√©pertoire ou "en haut". </li><li>  <strong>D√©ployez un fichier</strong> - quoi qu'il arrive: phar, hhbc, loop. </li><li>  La mani√®re sp√©ciale que <strong>Rasmus Lerdorf a</strong> sugg√©r√©e est <strong>rsync, 2 r√©pertoires et realpath_root</strong> . </li></ul><br>  Chaque m√©thode a ses avantages et ses inconv√©nients, raison pour laquelle nous les avons abandonn√©s.  Consid√©rez ces 4 m√©thodes plus en d√©tail. <br><br><h3>  D√©ploiement bas√© sur le syst√®me de contr√¥le de version svn up </h3><br>  Je n'ai pas choisi SVN par hasard - selon mes observations, sous cette forme le d√©ploiement existe pr√©cis√©ment dans le cas de SVN.  Le syst√®me est assez <strong>l√©ger</strong> , il vous permet <strong>de</strong> d√©ployer <strong>rapidement et facilement</strong> - ex√©cutez simplement svn up et vous avez termin√©. <br><br>  Mais cette m√©thode a un gros inconv√©nient: si vous faites svn up, et dans le processus de mise √† jour du code source, lorsque de nouvelles requ√™tes proviennent du r√©f√©rentiel, ils verront l'√©tat du syst√®me de fichiers qui n'existait pas dans le r√©f√©rentiel.  Vous aurez une partie des fichiers nouveaux et une partie des anciens - il s'agit d'une <strong>m√©thode de d√©ploiement non atomique</strong> qui ne convient pas aux charges √©lev√©es, mais uniquement aux petits projets.  Malgr√© cela, je connais des projets qui sont toujours d√©ploy√©s de cette fa√ßon, et jusqu'√† pr√©sent, tout fonctionne pour eux. <br><br><h3>  D√©ploiement bas√© sur l'utilitaire rsync </h3><br>  Il existe deux options pour proc√©der: t√©l√©charger des fichiers √† l'aide de l'utilitaire directement sur le serveur et t√©l√©charger ¬´en haut¬ª - mise √† jour. <br><br><h4>  rsync dans un nouveau r√©pertoire </h4><br>  √âtant donn√© que vous versez d'abord tout le code dans un r√©pertoire qui n'existe pas encore sur le serveur, puis que vous changez de trafic, cette m√©thode est <strong>atomique</strong> - personne ne voit un √©tat interm√©diaire.  Dans notre cas, la cr√©ation de 150 000 fichiers et la suppression de l'ancien r√©pertoire, qui contient √©galement 150 000 fichiers, cr√©e une <strong>charge importante sur le sous-syst√®me de disque</strong> .  Nous utilisons les disques durs tr√®s activement, et le serveur quelque part pendant une minute ne se sent pas tr√®s bien apr√®s une telle op√©ration.  Puisque nous avons 2000 serveurs, il faut remplir 900 Mo 2000 fois. <br><br>  Ce sch√©ma peut √™tre am√©lior√© si vous t√©l√©chargez d'abord sur un certain nombre de serveurs interm√©diaires, par exemple, 50, puis les ajoutez au reste.  Cela r√©sout les probl√®mes possibles avec le r√©seau, mais le probl√®me de la cr√©ation et de la suppression d'un grand nombre de fichiers ne dispara√Æt nulle part. <br><br><img src="https://habrastorage.org/webt/wj/c9/pt/wjc9ptyfin79_dn6jmnornudzt8.png"><br><br><h4>  rsync sur le dessus </h4><br>  Si vous avez utilis√© rsync, vous savez que cet utilitaire peut non seulement remplir des r√©pertoires entiers, mais √©galement mettre √† jour les r√©pertoires existants.  L'envoi de modifications uniquement est un plus, mais puisque nous t√©l√©chargeons les modifications dans le m√™me r√©pertoire o√π nous servons le code de bataille, il y aura √©galement une sorte d'√©tat interm√©diaire - c'est un inconv√©nient. <br><br>  Soumettre des modifications fonctionne comme ceci.  Rsync √©tablit des listes de fichiers c√¥t√© serveur √† partir duquel le d√©ploiement est effectu√© et c√¥t√© r√©ception.  Apr√®s cela, il compte les statistiques de tous les fichiers et envoie la liste enti√®re au c√¥t√© r√©cepteur.  Sur le serveur √† partir duquel le d√©ploiement se d√©roule, la diff√©rence entre ces valeurs est prise en compte et il est d√©termin√© quels fichiers doivent √™tre envoy√©s. <br><br>  Dans nos conditions, ce processus prend environ <strong>3 Mo de trafic et 1 seconde de temps processeur</strong> .  Il semble que ce ne soit pas grand-chose, mais nous avons 2 000 serveurs, et tout se passe au moins une minute de temps processeur.  Ce n'est pas une m√©thode aussi rapide, mais certainement meilleure que d'envoyer le tout via rsync.  Il reste √† r√©soudre en quelque sorte le probl√®me de l'atomicit√© et sera presque parfait. <br><br><h3>  D√©ployer un fichier </h3><br>  Quel que soit le fichier que vous t√©l√©chargez, il est relativement simple de le faire en utilisant BitTorrent ou l'utilitaire UFTP.  Un fichier est plus facile √† d√©compresser, peut √™tre atomiquement remplac√© sur Unix, et il est facile de v√©rifier l'int√©grit√© du fichier g√©n√©r√© sur le serveur de g√©n√©ration et livr√© aux machines cibles en calculant les montants MD5 ou SHA-1 √† partir du fichier (dans le cas de rsync, vous ne savez pas ce qui se trouve sur les serveurs de destination ) <br><br>  Pour les disques durs, l'enregistrement s√©quentiel est un gros plus - un fichier de 900 Mo sera √©crit sur un disque dur inoccup√© en environ 10 secondes.  Mais vous devez toujours enregistrer ces m√™mes 900 Mo et les transf√©rer sur le r√©seau. <br><br><h4>  Digression lyrique sur l'UFTP </h4><br>  Cet utilitaire Open Source a √©t√© initialement cr√©√© pour transf√©rer des fichiers sur un r√©seau avec de longs retards, par exemple, via un r√©seau satellite.  Mais UFTP s'est av√©r√© appropri√© pour t√©l√©charger des fichiers sur un grand nombre de machines, car il fonctionne en utilisant le protocole UDP bas√© sur la multidiffusion.  Une seule adresse de multidiffusion est cr√©√©e, toutes les machines qui souhaitent recevoir le fichier s'y abonnent et les commutateurs s'assurent que des copies des paquets sont livr√©es √† chaque machine.  Nous d√©pla√ßons donc le fardeau de la transmission de donn√©es vers le r√©seau.  Si votre r√©seau peut g√©rer cela, cette m√©thode fonctionne beaucoup mieux que BitTorrent. <br><br>  Vous pouvez essayer cet utilitaire Open Source sur votre cluster.  Malgr√© le fait qu'il fonctionne sur UDP, il dispose d'un m√©canisme NACK - accus√© de r√©ception n√©gatif, ce qui force les paquets de r√©acheminement perdus √† la livraison.  <strong>Il s'agit d'un moyen fiable de d√©ploiement</strong> . <br><br><h4>  Options de d√©ploiement de fichier unique </h4><br>  <strong>tar.gz</strong> <br><br>  Une option qui combine les inconv√©nients des deux approches.  Non seulement vous devez √©crire 900 Mo sur le disque de mani√®re s√©quentielle, apr√®s cela, vous devez √† nouveau √©crire les m√™mes 900 Mo avec lecture-√©criture al√©atoire et cr√©er 150 000 fichiers.  Cette m√©thode est encore moins performante que rsync. <br><br>  <strong>phar</strong> <br><br>  PHP prend en charge les archives au format phar (PHP Archive), sait comment donner leur contenu et inclure des fichiers.  Mais tous les projets ne sont pas faciles √† mettre dans un seul phar - vous avez besoin d'une adaptation de code.  Tout simplement parce que le code de cette archive ne fonctionne pas.  De plus, vous ne pouvez pas changer un fichier dans l'archive ( <em>Yuri du futur: en th√©orie, vous pouvez toujours</em> ), vous devez recharger l'int√©gralit√© de l'archive.  De plus, malgr√© le fait que les archives phar fonctionnent avec OPCache, lors du d√©ploiement, le cache doit √™tre supprim√©, car sinon il y aura des d√©chets dans OPCache √† partir de l'ancien fichier phar. <br><br>  <strong>hhbc</strong> <br><br>  Cette m√©thode est native de HHVM - HipHop Virtual Machine et est utilis√©e par Facebook.  Cela ressemble √† une archive phar, mais elle ne contient pas les codes source, mais le code d'octets compil√© de la machine virtuelle HHVM - l'interpr√©teur PHP de Facebook.  Il est interdit de modifier quoi que ce soit dans ce fichier: vous ne pouvez pas cr√©er de nouvelles classes, fonctions et certaines autres fonctionnalit√©s dynamiques dans ce mode sont d√©sactiv√©es.  En raison de ces limitations, la machine virtuelle peut utiliser des optimisations suppl√©mentaires.  Selon Facebook, cela peut amener jusqu'√† 30% √† la vitesse d'ex√©cution du code.  C'est probablement une bonne option pour eux.  Il est √©galement impossible de modifier un fichier ici ( <em>Yuri du futur: en fait, c'est possible, car il s'agit d'une base sqlite</em> ).  Si vous souhaitez modifier une ligne, vous devez refaire l'archive enti√®re √† nouveau. <br><br>  Pour cette m√©thode, il est <strong>interdit d'utiliser eval et dynamic include.</strong>  Il en est ainsi, mais pas tout √† fait.  Eval peut √™tre utilis√©, mais s'il ne cr√©e pas de nouvelles classes ou fonctions, et include ne peut pas √™tre cr√©√© √† partir de r√©pertoires en dehors de cette archive. <br><br>  <strong>boucle</strong> <br><br>  Ceci est notre ancienne version, et elle a deux gros avantages.  Tout d'abord, il ressemble √† un r√©pertoire normal <strong>.</strong>  Vous montez la boucle, et pour le code, cela n'a pas d'importance - cela fonctionne avec des fichiers, √† la fois sur l'environnement de d√©veloppement et sur l'environnement de production.  La deuxi√®me boucle peut √™tre mont√©e en mode lecture et √©criture, et changer un fichier, si vous devez encore changer quelque chose de toute urgence pour la production. <br><br>  Mais la boucle a des inconv√©nients.  Tout d'abord, cela fonctionne √©trangement avec Docker.  J'en parlerai un peu plus tard. <br><br>  Deuxi√®mement, si vous utilisez un lien symbolique sur la derni√®re boucle en tant que document_root, vous aurez des probl√®mes avec OPCache.  Il n'est pas tr√®s bon d'avoir un lien symbolique dans le chemin et commence √† confondre les versions des fichiers √† utiliser.  Par cons√©quent, OPCache doit √™tre r√©initialis√© lors du d√©ploiement. <br><br>  Un autre probl√®me est que les <strong>privil√®ges de superutilisateur sont requis</strong> pour monter des syst√®mes de fichiers.  Et vous ne devez pas oublier de les monter au d√©marrage / red√©marrage de la machine, car sinon il y aura un r√©pertoire vide au lieu du code. <br><br><h4>  Probl√®mes avec docker </h4><br>  Si vous cr√©ez un conteneur Docker et y jetez un dossier dans lequel des ¬´boucles¬ª ou d'autres p√©riph√©riques de bloc sont mont√©s, deux probl√®mes surviennent √† la fois: les nouveaux points de montage ne tombent pas dans le conteneur Docker et les ¬´boucles¬ª qui √©taient au moment de la cr√©ation Un conteneur Docker <strong>ne peut pas √™tre d√©mont√©</strong> car il est occup√© par un conteneur Docker. <br><br>  Naturellement, cela est g√©n√©ralement incompatible avec le d√©ploiement, car le nombre de p√©riph√©riques de boucle est limit√© et on ne sait pas comment le nouveau code doit tomber dans le conteneur. <br><br>  Nous avons essay√© de faire des choses √©tranges, par exemple, √©lever un <strong>serveur NFS local</strong> ou monter un r√©pertoire en utilisant SSHFS, mais pour diverses raisons cela n'a pas pris racine en nous.  En cons√©quence, dans cron, nous avons enregistr√© rsync de la derni√®re ¬´boucle¬ª dans le r√©pertoire courant, et il a ex√©cut√© la commande une fois par minute: <br><pre><code class="php hljs">rsync /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/loop/&lt;N&gt;/ /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/www/</code> </pre> <br>  Ici <code>/var/www/</code> est le r√©pertoire qui est promu dans le conteneur.  Mais sur les machines qui ont des conteneurs Docker, nous n'avons pas besoin d'ex√©cuter des scripts PHP souvent, donc rsync n'√©tait pas atomique, ce qui nous convenait.  Mais encore, cette m√©thode est tr√®s mauvaise, bien s√ªr.  Je voudrais faire un syst√®me de d√©ploiement qui fonctionne bien avec docker. <br><br><h3>  rsync, 2 r√©pertoires et realpath_root </h3><br>  Cette m√©thode a √©t√© propos√©e par Rasmus Lerdorf, l'auteur de PHP, et il sait se d√©ployer. <br><br>  Comment faire un d√©ploiement atomique, et de l'une des mani√®res dont j'ai parl√©?  Prenez le lien symbolique et enregistrez-le en tant que document_root.  √Ä chaque instant, le lien symbolique pointe vers l'un des deux r√©pertoires et vous faites rsync dans un r√©pertoire voisin, c'est-√†-dire vers celui vers lequel le code ne pointe pas. <br><br><img src="https://habrastorage.org/webt/x7/qh/49/x7qh49aslgwu3loufk6wixt8fcg.png"><br><br>  Mais le probl√®me se pose: le code PHP ne sait pas dans quel r√©pertoire il a √©t√© lanc√©.  Par cons√©quent, vous devez utiliser, par exemple, une variable que vous √©crirez quelque part au d√©but de la configuration - elle fixera le r√©pertoire √† partir duquel le code a √©t√© ex√©cut√© et √† partir de quels nouveaux fichiers doivent √™tre inclus.  Sur une diapositive, cela s'appelle <code>ROOT_DIR</code> . <br><br>  Utilisez cette constante lors de l'acc√®s √† tous les fichiers du code que vous utilisez en production.  Vous obtenez donc la propri√©t√© atomicity: les demandes qui arrivent avant que vous ayez chang√© de lien symbolique continuent √† inclure des fichiers de l'ancien r√©pertoire dans lesquels vous n'avez rien chang√©, et les nouvelles demandes qui sont arriv√©es apr√®s le changement de lien symbolique commencent √† fonctionner √† partir du nouveau r√©pertoire et sont servies nouveau code. <br><br><img src="https://habrastorage.org/webt/ny/o3/hh/nyo3hhqqs2iwthucxiquyf-org4.png"><br><br>  Mais cela doit √™tre √©crit dans le code.  Tous les projets ne sont pas pr√™ts pour cela. <br><br><h3>  √Ä la mani√®re de Rasmus </h3><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Rasmus sugg√®re</a> au lieu de modifier manuellement le code et de cr√©er des constantes pour modifier l√©g√®rement Apache ou utiliser nginx. <br><br><img src="https://habrastorage.org/webt/8f/c3/xy/8fc3xyhs8rgmrtp45qeguvtzufi.png"><br><br>  Pour document_root, sp√©cifiez le lien symbolique vers la derni√®re version.  Si vous avez nginx, vous pouvez enregistrer <code>root $realpath_root</code> , pour Apache, vous aurez besoin d'un module s√©par√© avec les param√®tres qui peuvent √™tre vus sur la diapositive.  Cela fonctionne comme ceci - lorsqu'une demande arrive, nginx ou Apache de temps en temps consid√®re realpath () du chemin, l'enregistrant √† partir des liens symboliques, et passe ce chemin comme document_root.  Dans ce cas, document_root pointera toujours vers un r√©pertoire normal sans liens symboliques, et votre code PHP n'aura peut-√™tre pas √† penser √† quel r√©pertoire il est appel√©. <br><br>  Cette m√©thode pr√©sente des avantages int√©ressants - de vrais chemins arrivent √† OPCache PHP, ils ne contiennent pas de lien symbolique.  M√™me le tout premier fichier auquel la demande est arriv√©e sera d√©j√† plein et il n'y aura aucun probl√®me avec OPCache.  Puisque document_root est utilis√©, cela fonctionne avec n'importe quel projet PHP.  Vous n'avez rien √† adapter. <br><br>  Il ne n√©cessite pas de rechargement fpm, il n'est pas n√©cessaire de r√©initialiser OPCache pendant le d√©ploiement, c'est pourquoi le serveur de processeur est tr√®s occup√©, car il doit √† nouveau analyser tous les fichiers.  Dans mon exp√©rience, la r√©initialisation d'OPCache d'environ une demi-minute a augment√© la consommation du processeur d'un facteur 2 √† 3.  Ce serait bien de le r√©utiliser et cette m√©thode vous permet de le faire. <br><br>  Maintenant les inconv√©nients.  Comme vous ne r√©utilisez pas OPCache et que vous avez 2 r√©pertoires, vous devez stocker une copie du fichier en m√©moire pour chaque r√©pertoire - sous OPCache, 2 fois plus de m√©moire est requise. <br><br>  Il existe une autre limitation qui peut sembler √©trange: <strong>vous ne pouvez pas d√©ployer plus d'une fois tous les max_execution_time</strong> .  Sinon, le m√™me probl√®me se produira, car pendant que rsync va dans l'un des r√©pertoires, les requ√™tes peuvent toujours √™tre trait√©es. <br><br>  Si vous utilisez Apache pour une raison quelconque, vous avez besoin d'un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">module tiers</a> que Rasmus a √©galement √©crit. <br><br>  Rasmus dit que le syst√®me est bon et je vous le recommande √©galement.  Pour 99% des projets, il convient aussi bien aux nouveaux projets qu'aux projets existants.  Mais, bien s√ªr, nous ne sommes pas comme √ßa et avons d√©cid√© d'√©crire notre propre d√©cision. <br><br><h2>  Nouveau syst√®me - MDK </h2><br>  Fondamentalement, nos exigences ne sont pas diff√©rentes de celles de la plupart des projets Web.  Nous voulons juste un <strong>d√©ploiement rapide</strong> sur la mise en sc√®ne et la production, une <strong>faible consommation de ressources</strong> , la r√©utilisation d'OPCache et une restauration rapide. <br><br>  Mais il y a deux autres exigences qui peuvent diff√©rer des autres.  Tout d'abord, c'est la possibilit√© d' <strong>appliquer des correctifs de mani√®re atomique</strong> .  Nous appelons les correctifs des changements dans un ou plusieurs fichiers qui r√©gissent quelque chose sur la production.  Nous voulons le faire rapidement.  En principe, le syst√®me propos√© par Rasmus fait face √† la t√¢che de correction. <br><br>  Nous avons √©galement des <strong>scripts CLI</strong> <strong>qui peuvent fonctionner pendant plusieurs heures</strong> , et ils devraient toujours fonctionner avec une version coh√©rente du code.  Dans ce cas, les solutions ci-dessus, malheureusement, ne nous conviennent pas, ou nous devons avoir beaucoup de r√©pertoires. <br><br>  Solutions possibles: <br><br><ul><li>  boucle xN (-staging, -docker, -opcache); </li><li>  rsync xN (-production, -opcache xN); </li><li>  SVN xN (-production, -opcache xN). </li></ul><br>  Ici N est le nombre de calculs effectu√©s en quelques heures.  Nous pouvons en avoir des dizaines, ce qui signifie qu'il faut d√©penser une tr√®s grande quantit√© d'espace pour des copies suppl√©mentaires du code. <br><br>  Par cons√©quent, nous avons mis au point un nouveau syst√®me et l'avons appel√© <strong>MDK.</strong>  Il signifie <strong>Multiversion Deployment Kit</strong> , un outil de d√©ploiement multi-version.  Nous l'avons fait sur la base des hypoth√®ses suivantes. <br><br>  <strong>Nous avons pris l'architecture de stockage d'arborescence de Git.</strong>  Nous devons avoir une version coh√©rente du code dans lequel le script fonctionne, c'est-√†-dire que nous avons besoin d'instantan√©s.  Les instantan√©s sont pris en charge par LVM, mais l√†, ils sont impl√©ment√©s de mani√®re inefficace par des syst√®mes de fichiers exp√©rimentaux comme Btrfs et Git.  Nous avons pris la mise en ≈ìuvre des instantan√©s de Git. <br><br>  <strong>Renomm√© tous les fichiers de file.php en file.php. &lt;version&gt;.</strong>  √âtant donn√© que tous les fichiers que nous avons sont simplement stock√©s sur le disque, alors si nous voulons stocker plusieurs versions du m√™me fichier, nous devons ajouter un suffixe avec la version. <br><br>  <strong>J'adore Go, donc pour la vitesse j'ai √©crit un syst√®me sur Go.</strong> <br><br><h3>  Fonctionnement du kit de d√©ploiement multiversion </h3><br>  Nous avons pris l'id√©e des instantan√©s de Git.  Je l'ai simplifi√© un peu et je vous explique comment il est impl√©ment√© dans MDK. <br><br>  Il existe deux types de fichiers dans MDK.  Le premier est les <strong>cartes.</strong>  Les images ci-dessous sont marqu√©es en vert et correspondent aux r√©pertoires du r√©f√©rentiel.  Le deuxi√®me type est <strong>directement les fichiers,</strong> qui se trouvent au m√™me endroit que d'habitude, mais avec un suffixe sous la forme d'une version de fichier.  Les fichiers et les cartes sont versionn√©s en fonction de leur contenu, dans notre cas simplement MD5. <br><br><img src="https://habrastorage.org/webt/-n/wz/1s/-nwz1str78y7hua15pfwxrrl14o.png"><br><br>  Supposons que nous ayons une hi√©rarchie de fichiers dans laquelle la <strong>carte racine se r√©f√®re √† certaines versions de fichiers provenant d'autres cartes</strong> , et qu'ils se r√©f√®rent √† leur tour √† d'autres fichiers et cartes et corrigent certaines versions.  Nous voulons changer une sorte de fichier. <br><br><img src="https://habrastorage.org/webt/7d/up/_b/7dup_biyh7msgtsp7kejinaulwc.png"><br><br>  Vous avez peut-√™tre d√©j√† vu une image similaire: nous changeons le fichier au deuxi√®me niveau d'imbrication, et dans la carte correspondante - map *, la version du fichier trois * est mise √† jour, son contenu est modifi√©, la version change - et la version change √©galement dans la carte racine.  Si nous changeons quelque chose, nous obtenons toujours une nouvelle carte racine, mais tous les fichiers que nous n'avons pas modifi√©s sont r√©utilis√©s. <br><br>  Les liens restent vers les m√™mes fichiers qu'ils √©taient.  C'est l'id√©e principale de cr√©er des instantan√©s de quelque mani√®re que ce soit, par exemple, dans <strong>ZFS,</strong> il est impl√©ment√© de la m√™me mani√®re. <br><br><h3>  Comment MDK se trouve sur un disque </h3><br><img src="https://habrastorage.org/webt/2r/vb/k4/2rvbk4ucmbe8upitkgczvy1dbns.png"><br><br>  Nous avons sur le disque: un <strong>lien symbolique vers la derni√®re carte racine</strong> - le code qui sera servi √† partir du Web, plusieurs versions de cartes racine, plusieurs fichiers, √©ventuellement avec des versions diff√©rentes, et dans les sous-r√©pertoires, il y a des cartes pour les r√©pertoires correspondants. <br><br>  Je pr√©vois la question: " <em>Et comment cela traite-t-il la demande Web? √Ä quels fichiers le code utilisateur parviendra-t-il?</em> " <br><br>  Oui, je vous ai tromp√© - il existe √©galement des fichiers sans version, car si vous recevez une demande pour index.php, et que vous ne l'avez pas dans le r√©pertoire, le site ne fonctionnera pas. <br><br><img src="https://habrastorage.org/webt/-e/fl/9k/-efl9kqt3-go-tvg0qpu0lnvauo.png"><br><br>  Tous les fichiers PHP ont des fichiers, que nous appelons des <strong>talons</strong> , car ils contiennent deux lignes: exigent du fichier dans lequel la fonction qui sait comment travailler avec ces cartes est d√©clar√©e, et exigent de la version souhait√©e du fichier. <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require_once</span></span> <span class="hljs-string"><span class="hljs-string">"mdk.inc"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> mdk_resolve_path(<span class="hljs-string"><span class="hljs-string">"a.php"</span></span>);</code> </pre><br>  Ceci est fait ainsi, et non li√© √† la derni√®re version, car si vous excluez <strong>b.php</strong> du fichier <strong>a.php</strong> sans version, alors puisque require_once est √©crit, le syst√®me se souviendra de la carte racine √† partir de laquelle il est parti, il l'utilisera, et Obtenez une version coh√©rente des fichiers. <br><br>  Pour le reste des fichiers, nous avons juste un lien symbolique vers la derni√®re version. <br><br><h3>  Comment d√©ployer √† l'aide de MDK </h3><br>  Le mod√®le est tr√®s similaire √† git push. <br><br><ul><li>  Envoyez le contenu de la carte racine. </li><li>  Du c√¥t√© de la r√©ception, nous examinons les fichiers manquants.  √âtant donn√© que la version du fichier est d√©termin√©e par le contenu, nous n'avons pas besoin de le t√©l√©charger une deuxi√®me fois ( <em>Yuri du futur: sauf dans le cas o√π il y aura une collision d'un MD5 raccourci, qui s'est toujours produit une fois en production</em> ). </li><li>  Demandez le fichier manquant. </li><li>  Nous passons au deuxi√®me point et plus loin dans un cercle. </li></ul><br><h4>  Exemple </h4><br>  Supposons qu'il existe un fichier nomm√© "un" sur le serveur.  Envoyez-lui une carte racine. <br><br><img src="https://habrastorage.org/webt/_h/sz/h_/_hszh_rruyekpqegz6-blz5xkeq.png"><br><br>  Dans la carte racine, les fl√®ches en pointill√©s indiquent des liens vers des fichiers que nous n'avons pas.  Nous connaissons leurs noms et versions car ils sont sur la carte.  Nous les demandons au serveur.  Le serveur envoie et il s'av√®re que l'un des fichiers est √©galement une carte. <br><br><img src="https://habrastorage.org/webt/zp/--/ec/zp--ecfpdqqkgjq4zciljreqkk0.png"><br><br>  Nous regardons - nous n'avons pas un seul fichier du tout.  Encore une fois, nous demandons les fichiers manquants.  Le serveur les envoie.  Il ne reste plus de cartes - le processus de d√©ploiement est termin√©. <br><br><img src="https://habrastorage.org/webt/mp/jk/tc/mpjktcmgb80dpamvqjkwp_ya1lg.png"><br><br>  Vous pouvez facilement deviner ce qui se passera si les fichiers sont 150 000, mais l'un a chang√©.  Nous verrons dans la carte racine qu'une carte est manquante, passons par le niveau d'imbrication et obtenons un fichier.  En termes de complexit√© de calcul, le processus n'est pratiquement pas diff√©rent de la copie directe de fichiers, mais en m√™me temps la coh√©rence et les instantan√©s du code sont pr√©serv√©s. <br><br>  MDK n'a aucun inconv√©nient :) Il vous permet de <strong>d√©ployer rapidement et atomiquement de petites modifications</strong> , et les <strong>scripts fonctionnent pendant des jours</strong> , car nous pouvons laisser tous les fichiers qui ont √©t√© d√©ploy√©s en une semaine.  Ils occuperont une quantit√© assez ad√©quate d'espace.  Vous pouvez √©galement r√©utiliser OPCache et le CPU ne mange presque rien. <br><br>  <strong>Le suivi est assez difficile, mais possible</strong> .  Tous les fichiers sont versionn√©s par contenu, et vous pouvez √©crire cron, qui parcourra tous les fichiers et v√©rifiera le nom et le contenu.  Vous pouvez √©galement v√©rifier que la carte racine fait r√©f√©rence √† tous les fichiers, qu'il n'y a pas de liens rompus.  De plus, pendant le d√©ploiement, l'int√©grit√© est v√©rifi√©e. <br><br>  Vous pouvez <strong>facilement annuler les modifications</strong> , car toutes les anciennes cartes sont en place.  On peut juste jeter la carte, tout sera l√† tout de suite. <br><br>  Pour moi, plus le fait que <strong>MDK soit √©crit en Go</strong> signifie que cela fonctionne rapidement. <br><br>  Je vous ai encore tromp√©, il y a encore des inconv√©nients.  Pour que le projet fonctionne avec le syst√®me, <strong>une modification importante du code est n√©cessaire,</strong> mais c'est plus simple qu'il n'y para√Æt √† premi√®re vue.  <strong>Le syst√®me est tr√®s complexe</strong> , je ne recommanderais pas de l'impl√©menter si vous n'avez pas des exigences telles que Badoo.  De plus, de toute fa√ßon, t√¥t ou tard, l'endroit se termine, donc le <strong>garbage collector est requis</strong> . <br><br>  Nous avons √©crit des utilitaires sp√©ciaux pour √©diter des fichiers - les vrais, pas les talons, par exemple, mdk-vim.  Vous sp√©cifiez le fichier, il trouve la version souhait√©e et le modifie. <br><br><h3>  MDK en chiffres </h3><br>  Nous avons 50 serveurs en transit, sur lesquels nous d√©ployons pendant 3-5 s <strong>.</strong>  Par rapport √† tout sauf rsync, c'est tr√®s rapide.  En <strong>production,</strong> nous d√©ployons environ <strong>2 minutes</strong> , de petits correctifs - <strong>5-10 s</strong> . <br><br>  Si, pour une raison quelconque, vous avez perdu le dossier entier avec le code sur tous les serveurs (ce qui ne devrait jamais arriver :)), le <strong>processus de t√©l√©chargement complet prend environ 40 minutes</strong> .  Cela nous est arriv√© une fois, mais la nuit avec un minimum de trafic.  Par cons√©quent, personne n'a √©t√© bless√©.  Le deuxi√®me fichier √©tait sur une paire de serveurs pendant 5 minutes, donc cela ne vaut pas la peine d'√™tre mentionn√©. <br><br>  Le syst√®me n'est pas en Open Source, mais si vous √™tes int√©ress√©, √©crivez dans les commentaires - il peut √™tre pr√©sent√© ( <em>Yuri du futur: le syst√®me n'est toujours pas en Open Source au moment d'√©crire ces lignes</em> ). <br><br><h2>  Conclusion </h2><br>  <strong>√âcoutez Rasmus, il ne ment pas</strong> .  √Ä mon avis, sa m√©thode rsync avec realpath_root est la meilleure, bien que les boucles fonctionnent √©galement tr√®s bien. <br><br>  <strong>Pensez avec votre t√™te</strong> : regardez exactement ce dont votre projet a besoin et n'essayez pas de cr√©er un vaisseau spatial o√π il y a suffisamment de ¬´ma√Øs¬ª.  Mais si vous avez encore des exigences similaires, un syst√®me similaire √† MDK vous conviendra. <br><br><blockquote>  Nous avons d√©cid√© de revenir sur ce sujet, qui a √©t√© discut√© sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">HighLoad ++</a> et, peut-√™tre, n'a pas re√ßu l'attention voulue, car ce n'√©tait qu'une des nombreuses briques pour atteindre des performances √©lev√©es.  Mais maintenant, nous avons une conf√©rence professionnelle <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">PHP Russie</a> distincte enti√®rement d√©di√©e √† PHP.  Et ici, nous nous en sortons vraiment pleinement.  Nous parlerons en d√©tail des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">performances</a> , des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">normes</a> et des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">outils</a> - beaucoup √† ce sujet, y compris le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">refactoring</a> . <br><br>  Abonnez-vous √† la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cha√Æne Telegram</a> avec les mises √† jour du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">programme de la</a> conf√©rence et rendez-vous le 17 mai. </blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr449916/">https://habr.com/ru/post/fr449916/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr449902/index.html">R√©seaux de t√©l√©vision par c√¢ble pour les plus petits. Partie 2: Composition et forme d'onde</a></li>
<li><a href="../fr449904/index.html">Cr√©ation d'une DLL de proxy pour les v√©rifications des op√©rations de DLL de piratage</a></li>
<li><a href="../fr449906/index.html">Serveur REST auto-document√© (Node.JS, TypeScript, Koa, Joi, Swagger)</a></li>
<li><a href="../fr449908/index.html">DDR3 ou DDR4? Pourquoi avons-nous offert le Dell R420 2x E5-2430 2.2Ghz 6C 128GB DDR3 2x960GB SSD 1Gbps pour 99 $ aux Pays-Bas?</a></li>
<li><a href="../fr449910/index.html">GitLab Shell Runner. Lancement concurrentiel de services de test √† l'aide de Docker Compose</a></li>
<li><a href="../fr449918/index.html">Thermom√®tre infrarouge avec capteur MLX90614</a></li>
<li><a href="../fr449920/index.html">10 fa√ßons non standard de nuire au r√©f√©rencement lors du changement de CMS (+1 bonus)</a></li>
<li><a href="../fr449922/index.html">Essai routier nanoCAD SPDS Metalwork 1.2. 3e partie</a></li>
<li><a href="../fr449926/index.html">Le condens√© de mati√®res fra√Æches du monde du front-end de la derni√®re semaine n ¬∞ 362 (22-28 avril 2019)</a></li>
<li><a href="../fr449928/index.html">Non seulement le traitement: comment nous avons cr√©√© une base de donn√©es distribu√©e √† partir de Kafka Streams, et ce qui en est ressorti</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>