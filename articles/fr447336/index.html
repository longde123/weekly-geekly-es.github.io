<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤙🏾 👩🏽‍🎤 👩🏼‍🚀 Surveillance des ressources du cluster Kubernetes 📃 😥 🌗</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="J'ai créé Kube Eagle - un exportateur de Prométhée. Cela s'est avéré être une chose intéressante qui aide à mieux comprendre les ressources des grappe...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Surveillance des ressources du cluster Kubernetes</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/southbridge/blog/447336/"><p> <a href=""><img src="https://habrastorage.org/webt/bn/g6/jg/bng6jgpkvlzy8-2zahywzsnz8du.png"></a> </p><br><p>  J'ai créé Kube Eagle - un exportateur de Prométhée.  Cela s'est avéré être une chose intéressante qui aide à mieux comprendre les ressources des grappes petites et moyennes.  En conséquence, j'ai économisé plus de cent dollars, car j'ai sélectionné les bons types de machines et configuré les limites de ressources d'application pour les charges de travail. </p><br><p>  Je vais parler des avantages du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Kube Eagle</a> , mais je vais d'abord expliquer pourquoi l'agitation est sortie et pourquoi un contrôle de la qualité était nécessaire. </p><a name="habracut"></a><br><p>  J'ai géré plusieurs clusters de 4 à 50 nœuds.  Dans chaque cluster - jusqu'à 200 microservices et applications.  Pour mieux utiliser le matériel disponible, la plupart des déploiements ont été configurés avec des ressources de RAM et de CPU éclatables.  Les pods peuvent donc prendre les ressources disponibles, si nécessaire, et en même temps ne pas interférer avec d'autres applications sur ce nœud.  Eh bien, n'est-ce pas génial? </p><br><p>  Et bien que le cluster ait consommé relativement peu de CPU (8%) et de RAM (40%), nous avons constamment eu des problèmes d'éviction des foyers lorsqu'ils essayaient d'allouer plus de mémoire que ce qui est disponible sur le nœud.  Ensuite, nous n'avions qu'un seul tableau de bord pour surveiller les ressources Kubernetes.  En voici un: </p><br><p><a href=""><img src="https://habrastorage.org/webt/qr/cp/x2/qrcpx2avguhqnbxxg7trlxfnh4u.png"></a> <br>  <em>Tableau de bord Grafana avec mesures cAdvisor uniquement</em> </p><br><p>  Avec un tel panneau, les nœuds qui consomment beaucoup de mémoire et de CPU ne sont pas un problème.  Le problème est de comprendre la raison.  Pour garder les pods en place, vous pouvez bien sûr configurer des ressources garanties sur tous les pods (les ressources demandées sont égales à la limite).  Mais ce n'est pas l'utilisation la plus intelligente du fer.  Il y avait plusieurs centaines de gigaoctets de mémoire sur le cluster, tandis que certains nœuds étaient affamés, tandis que d'autres avaient 4 à 10 Go en réserve. </p><br><p>  Il s'avère que le planificateur Kubernetes répartit les charges de travail de manière inégale sur les ressources disponibles.  Le planificateur Kubernetes prend en compte différentes configurations: règles d'affinité, de taintes et de tolérances, sélecteurs de nœuds pouvant limiter les nœuds disponibles.  Mais dans mon cas, il n'y avait rien de tel, et les pods étaient planifiés en fonction des ressources demandées sur chaque nœud. </p><br><p>  Pour le foyer, un nœud a été sélectionné qui dispose des ressources les plus libres et qui satisfait aux conditions de la demande.  Il s'est avéré que les ressources demandées sur les nœuds ne correspondent pas à l'utilisation réelle, et ici Kube Eagle et sa capacité à surveiller les ressources sont venus à la rescousse. </p><br><p>  J'ai presque tous les clusters Kubernetes suivis uniquement avec l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">exportateur de nœuds</a> et les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">métriques d'état Kube</a> .  Node Exporter fournit des statistiques d'utilisation des E / S et du disque, du processeur et de la RAM, et les métriques d'état du Kube affichent les métriques des objets Kubernetes, telles que les demandes et les limites des ressources CPU et mémoire. </p><br><p>  Nous devons combiner les mesures d'utilisation avec les mesures de demande et de limite dans Grafana, puis nous obtenons toutes les informations sur le problème.  Cela semble simple, mais en fait, dans ces deux outils, les étiquettes sont appelées différemment, et certaines métriques n'ont pas du tout d'étiquettes de métadonnées.  Kube Eagle fait tout par lui-même et le panneau ressemble à ceci: </p><br><p> <a href=""><img src="https://habrastorage.org/webt/u3/ce/hk/u3cehkycztlwc9m7lpip-4lw2xe.png"></a> </p><br><p> <a href=""><img src="https://habrastorage.org/webt/po/zi/fm/pozifm1dgtkf9nsasb42k1faqi4.png"></a> <br>  <em><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Tableau de bord Kube Eagle</a></em> </p><br><p>  Nous avons réussi à résoudre de nombreux problèmes de ressources et à économiser du matériel: </p><br><ol><li>  Certains développeurs ne savaient pas combien de ressources les microservices avaient besoin (ou n'ont tout simplement pas pris la peine).  Nous n'avions rien pour trouver les mauvaises demandes de ressources - pour cela, nous devons connaître la consommation plus les demandes et les limites.  Maintenant, ils voient les métriques de Prometheus, surveillent l'utilisation réelle et affinent les requêtes et les limites. </li><li>  Les applications JVM prennent autant de RAM qu'elles n'en prennent.  Le garbage collector ne libère de la mémoire que si plus de 75% est impliqué.  Et comme la plupart des services ont une mémoire éclatable, la JVM l'a toujours occupée.  Par conséquent, tous ces services Java ont consommé beaucoup plus de RAM que prévu. </li><li>  Certaines applications ont demandé trop de mémoire et le planificateur Kubernetes n'a pas donné ces nœuds à d'autres applications, bien qu'en fait ils soient plus libres que d'autres nœuds.  Un développeur a accidentellement ajouté un chiffre supplémentaire dans la demande et a saisi un gros morceau de RAM: 20 Go au lieu de 2. Personne ne l'a remarqué.  L'application avait 3 répliques, donc 3 nœuds ont été affectés. </li><li>  Nous avons introduit des limites de ressources, replanifié les pods avec les demandes correctes et obtenu l'équilibre parfait de l'utilisation du fer sur tous les nœuds.  Deux nœuds peuvent généralement être fermés.  Et puis nous avons vu que nous avions les mauvaises machines (orientées CPU, pas orientées mémoire).  Nous avons changé le type et supprimé quelques nœuds supplémentaires. </li></ol><br><h3 id="itogi">  Résumé </h3><br><p>  Avec des ressources éclatables dans un cluster, vous utilisez le matériel existant plus efficacement, mais le planificateur Kubernetes planifie les pods sur les demandes de ressources, ce qui est lourd.  Pour tuer deux oiseaux avec une pierre: pour éviter les problèmes et utiliser au maximum les ressources, une bonne surveillance est nécessaire.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Kube Eagle</a> (exportateur Prometheus et tableau de bord Grafana) est utile pour cela. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr447336/">https://habr.com/ru/post/fr447336/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr447324/index.html">Comment l'ordinateur fonctionne à l'intérieur de Hayabusa-2, qui a largué une bombe sur Ryuga. Et des photos de ses développeurs</a></li>
<li><a href="../fr447326/index.html">Fractales en nombre irrationnel. 2e partie</a></li>
<li><a href="../fr447328/index.html">Habro suicide. La douleur de la planification en 1C</a></li>
<li><a href="../fr447330/index.html">C'était le soir, il n'y avait rien à faire, ni comment installer Gentoo sans clavier</a></li>
<li><a href="../fr447334/index.html">Un exemple de stratégie de contenu pour la promotion d'un magasin de pièces d'armes en ligne</a></li>
<li><a href="../fr447338/index.html">Stage d'été Intel 0x7E3 en attente des étudiants</a></li>
<li><a href="../fr447342/index.html">Pyramides non-Mars: étude de la forme des amas nanocristallins sous une couche de graphène</a></li>
<li><a href="../fr447344/index.html">Nouvelles fonctionnalités dans Webmaster</a></li>
<li><a href="../fr447346/index.html">Automatisation des processus métier dans Excel ou comment sauver une fille du traitement</a></li>
<li><a href="../fr447348/index.html">Une étude de la connectivité des monnaies mondiales à travers la corrélation des taux absolus</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>