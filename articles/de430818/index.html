<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèº‚Äç‚öñÔ∏è „äóÔ∏è ü¶ê SQLAlchemy-Beschleunigung f√ºr Architekturastronauten üë®üèø‚Äçüè´ üë©üèº‚Äç‚úàÔ∏è üóÑÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Habr, dies ist ein Bericht des Software-Ingenieurs Alexei Starkov auf der Moscow Python Conf ++ 2018-Konferenz in Moskau. Video am Ende des Beitrags. ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>SQLAlchemy-Beschleunigung f√ºr Architekturastronauten</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/qrator/blog/430818/"><img src="https://habrastorage.org/webt/nk/mr/3o/nkmr3o45oaha-8h6n1elhxx3nai.png"><br><blockquote>  Habr, dies ist ein Bericht des Software-Ingenieurs Alexei Starkov auf der Moscow Python Conf ++ 2018-Konferenz in Moskau.  Video am Ende des Beitrags. </blockquote>  Hallo allerseits!  Mein Name ist Alexei Starkov - das bin ich, in meinen besten Jahren arbeite ich in einer Fabrik. <br>  Jetzt arbeite ich bei Qrator Labs.  Grunds√§tzlich habe ich mein ganzes Leben lang C und C ++ studiert - ich liebe Alexandrescu, The Gang of Four, die Prinzipien von SOLID - das ist alles.  Was mich zu einem architektonischen Astronauten macht.  Ich habe Python in den letzten Jahren geschrieben, weil es mir gef√§llt. <br><br>  Wer sind eigentlich "architektonische Kosmonauten"?  Als ich diesen Begriff zum ersten Mal mit Joel Spolsky traf, haben Sie ihn wahrscheinlich gelesen.  Er beschreibt die "Astronauten" als Menschen, die eine ideale Architektur aufbauen wollen, die Abstraktion √ºber Abstraktion, √ºber Abstraktion h√§ngen, die immer allgemeiner wird.  Am Ende sind diese Ebenen so hoch, dass sie alle m√∂glichen Programme beschreiben, aber keine praktischen Probleme l√∂sen.  In diesem Moment geht dem "Astronauten" (dies ist das letzte Mal, dass dieser Begriff von Anf√ºhrungszeichen umgeben ist) die Luft aus und er stirbt. <br><br>  Ich habe auch Tendenzen zur Erforschung des architektonischen Weltraums, aber in diesem Bericht werde ich ein wenig dar√ºber sprechen, wie es mich gebissen hat und mir nicht erlaubt hat, ein System mit der erforderlichen Leistung zu bauen.  Die Hauptsache ist, wie ich es √ºberwunden habe. <br><br>  Zusammenfassung meines Berichts: war / war. <br><a name="habracut"></a><br><img src="https://habrastorage.org/webt/wj/_u/7c/wj_u7c0h2uaody3dj48xsbytsb4.png"><br><br>  Eine tausende und millionenfache Zunahme.  Als ich diese Folie machte, war der einzige Gedanke, den ich hatte, "Wie?" <br><br><img src="https://habrastorage.org/webt/of/cb/q_/ofcbq_bd033u4wh31hzexjkstfc.png"><br><br>  Wo k√∂nnte ich so viel vermasseln?  Wenn Sie es nicht wie ich vermasseln wollen - lesen Sie weiter. <br><br><img src="https://habrastorage.org/webt/md/ni/gt/mdnigtyu3igzmlqmcf89isptecc.png"><br><br>  Ich werde √ºber das Konfigurationssystem sprechen.  Das Konfigurationssystem ist ein internes Tool in Qrator Labs, das Konfigurationen f√ºr das Software Defined Network (SDN) - unser Filternetzwerk - speichert.  Es ist verpflichtet, die Konfiguration zwischen Komponenten zu synchronisieren und ihren Status zu √ºberwachen. <br><br><img src="https://habrastorage.org/webt/xz/kg/zr/xzkgzr2wrphmvslxnx3v2qezxta.png"><br><br>  Woraus besteht es kurz gesagt?  Wir haben eine Datenbank, in der eine Momentaufnahme unserer Konfiguration f√ºr das gesamte Netzwerk gespeichert ist, und wir haben einen Server, der die eingehenden Befehle verarbeitet und die Konfiguration irgendwie √§ndert. <br><br>  Unsere technischen Administratoren und Clients kommen zu diesem Server und geben √ºber die Konsole, √ºber die Endpunkt-APIs, REST-APIs, JSON-RPCs und andere Dinge Befehle an den Server aus, wodurch unsere Konfiguration ge√§ndert wird. <br><br>  Teams k√∂nnen entweder sehr einfach oder komplizierter sein.  Dann haben wir einen bestimmten Satz von Empf√§ngern, aus denen unser SDN besteht, und der Server √ºbertr√§gt die Konfiguration an diese Empf√§nger.  Das klingt ziemlich einfach.  Grunds√§tzlich werde ich √ºber diesen Teil sprechen. <br><br><img src="https://habrastorage.org/webt/yp/uq/c7/ypuqc7pzaeqvmbzsrksb9gefq-w.png"><br><br>  Da ist sie es, die mit der Datenbank und der Alchemie verwandt ist. <br><br><img src="https://habrastorage.org/webt/qg/sz/np/qgsznprvrp4smdpbuoxopevxxt4.png"><br><br>  Was ist die Besonderheit dieses Systems?  Es ist ziemlich klein - mittelm√§√üig.  Hunderttausende, bis zu Millionen von Entit√§ten werden in dieser Datenbank gespeichert.  Die Besonderheit ist, dass der Graph der Beziehungen zwischen Entit√§ten ziemlich komplex ist.  Es gibt mehrere Vererbungshierarchien zwischen Entit√§ten, es gibt Einschl√ºsse, es gibt einfach Abh√§ngigkeiten zwischen ihnen.  Alle diese Einschr√§nkungen werden von der Gesch√§ftslogik bestimmt und wir m√ºssen sie einhalten. <br><br>  Das Verh√§ltnis von Schreibanforderungen zu Leseanforderungen betr√§gt ungef√§hr 15: 1.  Hier ist klar: Es gibt viele Befehle zum √Ñndern der Konfiguration, und einmal in einem bestimmten Zeitraum haben wir die Konfiguration an die Endpunkte verschoben. <br><br>  MySQL wird intern verwendet - es ist auch in anderen Produkten unseres Unternehmens verf√ºgbar, wir haben ziemlich ernsthaftes Fachwissen in dieser Datenbank, es gibt Leute, die damit arbeiten k√∂nnen: Erstellen eines Datenschemas, Entwurfsabfragen und alles andere.  Daher haben wir MySQL als universelle relationale Datenbank verwendet. <br><br><img src="https://habrastorage.org/webt/x0/xs/ae/x0xsae3wqaqw4dfth-y8q7i3tqk.png"><br><br>  Was war das Problem, nachdem wir dieses System entworfen haben?  Die Ausf√ºhrung eines Befehls dauerte je nach Komplexit√§t des Teams zwischen einer und drei√üig Sekunden.  Dementsprechend erreichte die Verz√∂gerung der Ausf√ºhrung f√ºnf Minuten.  Ein Team traf ein - 30 Sekunden, das zweite und so weiter, ein Stapel angesammelter - eine Verz√∂gerung von 5 Minuten. <br><br>  Die Verz√∂gerung beim Anwenden der Konfiguration betr√§gt bis zu zehn Minuten.  Es wurde entschieden, dass dies f√ºr uns nicht ausreicht und dass eine Optimierung erforderlich ist. <br><br><img src="https://habrastorage.org/webt/ah/6t/fj/ah6tfjmleq-fzvoecldzw5qxxu0.png"><br><br>  Bevor eine Optimierung durchgef√ºhrt wird, muss zun√§chst eine Untersuchung durchgef√ºhrt werden, um herauszufinden, worum es tats√§chlich geht. <br><br><img src="https://habrastorage.org/webt/nu/wf/g6/nuwfg6v2hg2jangw6agmu9i6bw0.png"><br><br>  Wie sich herausstellte, fehlte uns die wichtigste Komponente f√ºr die Untersuchung - wir hatten keine Telemetrie.  Wenn Sie also eine Art System entwerfen, setzen Sie zun√§chst in der Entwurfsphase Telemetrie ein.  Selbst wenn das System anfangs klein ist, dann ein bisschen mehr, dann noch mehr - am Ende kommt jeder in eine Situation, in der man Tracks sehen muss, aber es gibt keine Telemetrie. <br><br><img src="https://habrastorage.org/webt/eh/ws/3t/ehws3tezqmrdlvfcljs1pxbttgm.png"><br><br>  Was kann als n√§chstes getan werden, wenn Sie keine Telemetrie haben?  Sie k√∂nnen die Protokolle analysieren.  Hier gehen ziemlich einfache Skripte unsere Protokolle durch und wandeln sie in eine solche Tabelle um, die die schnellsten, langsamsten und durchschnittlichen Befehlsausf√ºhrungszeiten darstellt.  Ab hier k√∂nnen wir bereits sehen, an welchen Stellen wir Gags haben: Welche Teams brauchen l√§nger, welche schneller. <br><br><img src="https://habrastorage.org/webt/m6/0a/gc/m60agccykga4hl82ktrjfjglzqq.png"><br><br>  Das einzige, was zu beachten ist, ist, dass bei der Analyse der Protokolle nur die Ausf√ºhrungszeit dieser Befehle auf dem Server ber√ºcksichtigt wird.  Dies ist die erste Stufe - die als t2 gekennzeichnete.  t1 - So sieht der Client die Ausf√ºhrungszeit unseres Teams: In die Warteschlange treten, warten, Ausf√ºhrung auf dem Server.  Diese Zeit wird l√§nger sein, daher optimieren wir die Zeit t2 und verwenden dann die Zeit t1, um festzustellen, ob wir das Ziel erreicht haben. <br><br>  t1 ist die Qualit√§tsmetrik unserer Leistung. <br><br><img src="https://habrastorage.org/webt/dx/dd/05/dxdd05sisxq1ciu6nu-na0zons8.png"><br><br>  Dementsprechend haben wir auf diese Weise alle Teams profiliert - das hei√üt, wir haben das Protokoll vom Server genommen, es durch unsere Skripte gef√ºhrt, die Komponenten gesucht und identifiziert, die am langsamsten arbeiteten.  Der Server ist recht modular aufgebaut, f√ºr jeden Befehl ist eine eigene Komponente verantwortlich, und wir k√∂nnen die Komponenten einzeln profilieren - und Benchmarks f√ºr sie erstellen.  Hier hatten wir also eine Klasse - f√ºr jede problematische Komponente, die wir geschrieben haben, in der wir in code_under_test () eine Aktivit√§t ausgef√ºhrt haben, die den Kampfeinsatz der Komponente darstellt.  Und es gab zwei Methoden: profile () und bank ().  Der erste Aufruf von cProfile zeigt an, wie oft was aufgerufen wurde und wo die Engp√§sse liegen. <br><br>  Bench () wurde mehrmals ausgef√ºhrt und hat f√ºr uns unterschiedliche Metriken ber√ºcksichtigt - so haben wir die Leistung bewertet. <br><br>  Es stellte sich jedoch heraus, dass dies nicht das Problem ist! <br><br><img src="https://habrastorage.org/webt/wz/r8/-p/wzr8-pc9epal61cjoraog7bkvxc.png"><br><br>  Das Hauptproblem war die Anzahl der Datenbankabfragen.  Es gab viele Anfragen, und um zu verstehen, warum es so viele gab, schauen wir uns an, wie alles organisiert war. <br><br><img src="https://habrastorage.org/webt/bg/r0/rz/bgr0rzhohcouyykpc3raznbi4rq.png"><br><br>  Vor uns liegt ein Teil einer einfachen Schaltung, die unsere Empf√§nger darstellt und in Form der Reciever-Klasse dargestellt wird.  Sie sind in einer Gruppe - Empf√§ngergruppe - vereint.  Dementsprechend gibt es einige Konfigurationsebenen - Slices der Konfiguration, die eine Teilmenge der Konfigurationen sind, die f√ºr eine ‚ÄûRolle‚Äú dieses Empf√§ngers verantwortlich sind.  Zum Beispiel f√ºr Routing - Routing-Ebene.  Ebenen mit Empf√§ngern k√∂nnen in beliebiger Reihenfolge verbunden werden - das hei√üt, dies ist eine Viele-zu-Viele-Beziehung. <br><br>  Dies ist ein Teil des gro√üen Umrisses, den ich hier pr√§sentiere, damit Beispiele besser verstanden werden k√∂nnen. <br><br>  Was m√∂chte jeder Architektur-Kosmonaut tun, wenn er die API eines anderen sieht?  Er m√∂chte es ausblenden, abstrahieren und seine Schnittstelle schreiben, um diese API entfernen oder vielmehr ausblenden zu k√∂nnen. <br><br><img src="https://habrastorage.org/webt/nq/zq/7-/nqzq7-zlnbxkkmy7mywbp8lqvq4.png"><br><br>  Dementsprechend gibt es eine "schmutzige" API der Alchemie, in der es tats√§chlich Mapper und unsere "reine" Klasse - Receiver gibt, in der einige Konfigurationen gespeichert sind und es Methoden gibt: load (), save (), delete ().  Und alle anderen damit verbundenen Klassen.  Wir erhalten ein Diagramm von Python-Objekten, die irgendwie miteinander verbunden sind - jedes von ihnen verf√ºgt √ºber eine Methode load (), save (), delete (), die sich auf den Alchemy Mapper bezieht, der wiederum die API aufruft. <br><br><img src="https://habrastorage.org/webt/cs/bo/lr/csbolr6uozuvbxhimmqik_llgak.png"><br><br>  Die Implementierung hier ist sehr einfach.  Wir haben eine Lademethode, die eine Abfrage an die Datenbank durchf√ºhrt und f√ºr jedes empfangene Objekt ein eigenes Python-Objekt erstellt.  Es gibt eine Speichermethode, die den umgekehrten Vorgang ausf√ºhrt. Wenn nicht, wird ein Objekt mit dem Prim√§rschl√ºssel in der Datenbank vorhanden. Andernfalls wird der Status dieses Objekts erstellt, hinzugef√ºgt und anschlie√üend gespeichert.  L√∂schen auf dem Prim√§rschl√ºssel empf√§ngt und l√∂scht das Objekt aus der Datenbank. <br><br><img src="https://habrastorage.org/webt/fl/hq/lp/flhqlp2vg6srgo7wswpbowrlq6e.png"><br><br>  Das Hauptproblem ist sofort sichtbar - dies ist die Zuordnung.  Zuerst machen wir es einmal vom Python-Objekt zum Mapper, dann vom Mapper zur Basis.  Zus√§tzliche Zuordnung sind ein oder zwei Aufrufe, die m√∂glicherweise noch nicht so be√§ngstigend sind.  Das Hauptproblem war die manuelle Synchronisation.  Wir haben zwei Objekte unserer "sauberen" Oberfl√§che und eines davon √§ndert das Attribut - wie sehen wir, dass sich das Attribut im anderen ge√§ndert hat?  Auf keinen Fall.  Es ist erforderlich, die √Ñnderungen in der Datenbank zusammenzuf√ºhren und das Attribut in einem anderen Objekt abzurufen.  Wenn wir wissen, dass Objekte im selben Kontext vorhanden sind, k√∂nnen wir dies nat√ºrlich irgendwie verfolgen.  Aber wenn wir zwei Sitzungen an verschiedenen Orten haben - nur √ºber die Basis oder blockieren Sie die Basis im Speicher, was wir nicht getan haben. <br><br>  Dieses Laden / Speichern / L√∂schen ist ein weiterer Mapper, der die Innenseiten der Alchemie vollst√§ndig dupliziert, was gut geschrieben und getestet ist.  Dieses Tool ist viele Jahre alt, es gibt eine Menge Hilfe im Internet und das Duplizieren ist auch nicht sehr gut. <br><br>  Sehen Sie das Symbol in der oberen rechten Ecke?  Also werde ich die Folien markieren, auf denen etwas f√ºr "Reinheit" getan wird, um den Abstraktionsgrad f√ºr die architektonische Astronautik zu erh√∂hen.  Das hei√üt, Folien ohne dieses Symbol sind pragmatisch und langweilig, uninteressant und k√∂nnen nicht gelesen werden. <br><br>  Was tun, wenn viele Abfragen langsam sind?  Wie viele?  Eigentlich viel.  Stellen Sie sich eine Vererbungskette vor: Ein Objekt hat ein Elternteil, dieses hat ein anderes Elternteil.  Wir synchronisieren das untergeordnete Objekt. Dazu m√ºssen Sie zuerst die √ºbergeordneten Objekte synchronisieren.  Um ein √ºbergeordnetes Element zu synchronisieren, m√ºssen Sie das √ºbergeordnete Element synchronisieren.  Nun, alle waren synchronisiert.  Abh√§ngig davon, wie wir das Diagramm erstellt haben, k√∂nnen wir alle diese Objekte hundertmal durchlaufen und synchronisieren - daher eine gro√üe Anzahl von Anforderungen. <br><br><img src="https://habrastorage.org/webt/zo/n7/uh/zon7uhhtngwjd5rnaztxexuatsu.png"><br><br>  Was haben wir getan  Wir haben unsere gesamte Gesch√§ftslogik √ºbernommen und in den Mapper gesteckt.  Alle anderen Objekte hier wurden ebenfalls mit den Mappern zusammengef√ºhrt, und unsere gesamte API, die gesamte Datenabstraktionsschicht, erwies sich als fehlerhaft. <br><br><img src="https://habrastorage.org/webt/qn/4a/fz/qn4afzy7q6yrh0t-yw4r4m6c9se.png"><br><br>  So sieht es in Python aus - unser Mapper hat eine Art Gesch√§ftslogik, genau dort gibt es eine deklarative Beschreibung dieser Platte.  Spalten werden aufgelistet, Beziehungen.  Hier haben wir eine solche Klasse. <br><br><img src="https://habrastorage.org/webt/ez/ud/sg/ezudsgqk1b9domctg8sdvzh4uj8.png"><br><br>  Aus Sicht eines jeden Astronauten ist eine schmutzige API nat√ºrlich ein Nachteil.  Gesch√§ftslogik in einer deklarativen Beschreibung der Basis.  Schemata werden mit Gesch√§ftslogik gemischt.  Puh.  H√§sslich. <br><br>  Die Beschreibung der Schaltung ist un√ºbersichtlich.  Dies ist tats√§chlich ein Problem - wenn die Gesch√§ftslogik nicht aus zwei Zeilen, sondern aus einem gr√∂√üeren Volumen besteht, m√ºssen wir in dieser Klasse sehr lange scrollen oder suchen, um zu bestimmten Beschreibungen zu gelangen.  Davor war alles sch√∂n: an einem Ort die Beschreibung der Basis, deklarativ, Beschreibung der Schemata, an einem anderen Ort Gesch√§ftslogik.  Und dann ist die Schaltung √ºberf√ºllt. <br><br>  Andererseits erhalten wir sofort die Mechanismen der Alchemie: Arbeitseinheit, mit der Sie verfolgen k√∂nnen, welche Objekte verschmutzt sind und welche Relais aktualisiert werden m√ºssen;  Wir erhalten eine Beziehung, die es uns erm√∂glicht, zus√§tzliche Fragen in der Datenbank zu entfernen, ohne sicherzustellen, dass die relevanten Sammlungen gef√ºllt sind.  und die Identit√§tskarte, die uns am meisten geholfen hat.  Die Identit√§tszuordnung stellt sicher, dass zwei Python-Objekte dasselbe Python-Objekt sind, wenn sie denselben Prim√§rschl√ºssel haben. <br><br>  Dementsprechend haben wir die Komplexit√§t sofort auf linear reduziert. <br><br><img src="https://habrastorage.org/webt/j4/ek/x8/j4ekx8dvwphpdavetrxejd1uvxg.png"><br><br>  Dies sind Zwischenergebnisse.  Die Leistung stieg sofort um das Zehnfache, die Anzahl der Abfragen an die Datenbank sank um das 40-80-fache und der RPS stieg auf 1-5.  Gut.  Aber die API ist schmutzig.  Was zu tun ist? <br><br><img src="https://habrastorage.org/webt/kj/po/hs/kjpohswqs8svlzroeizbub0tpmk.png"><br><br>  Mixins.  Wir nehmen die Gesch√§ftslogik, entfernen sie wieder aus unserem Mapper, aber damit es kein Mapping mehr gibt, erben wir unseren Mapper innerhalb der Alchemie von unserem Mixin.  Warum nicht umgekehrt?  Dies wird in der Alchemie nicht funktionieren, sie wird schw√∂ren und sagen: "Sie haben zwei verschiedene Klassen, die sich auf eine Tablette beziehen, es gibt keinen Polyformismus - gehen Sie von hier aus."  Und so - es ist m√∂glich. <br><br>  Wir haben also eine deklarative Beschreibung im Mapper, die vom Mixin geerbt wird und die gesamte Gesch√§ftslogik empf√§ngt.  Sehr bequem.  Und der Rest der Klassen ist genau das gleiche.  Es scheint - cool, alles ist sauber.  Es gibt jedoch eine Einschr√§nkung: Verbindungen und Relais verbleiben in der Alchemie, und wenn wir uns beispielsweise durch eine sekund√§re Zwischenplatten-Tabelle verbinden, ist der Mapper dieser Platte irgendwie im Client-Code vorhanden, was nicht sehr sch√∂n ist. <br><br>  Die Alchemie w√§re kein so guter, ber√ºhmter Rahmen gewesen, wenn sie mir nicht die Gelegenheit gegeben h√§tte, dagegen anzuk√§mpfen. <br><br><img src="https://habrastorage.org/webt/g6/dz/gg/g6dzggup-pvokdl7h4mguhedazc.png"><br><br>  Wie sieht ein Mixin aus?  Er hat Gesch√§ftslogik, Mapper separat, eine deklarative Beschreibung der Platte.  Verbindungen bleiben innerhalb der Alchemie, aber die Gesch√§ftslogik ist getrennt. <br><br>  Wie sieht der allgemeine Umriss aus? <br><br><img src="https://habrastorage.org/webt/xl/1c/eh/xl1cehyjtaoqytk_gz5h-wbc5we.png"><br><br>  Wir haben eine Datei mit einem Schema, in dem alle unsere deklarativen Klassen gesammelt werden - nennen wir es schema.py.  Und wir haben Entit√§ten in der Gesch√§ftslogik separat.  Diese Entit√§ten werden in der Schemadatei vererbt. Wir schreiben f√ºr jede Entit√§t eine separate Klasse und erben sie im Schema.  Somit liegt die Gesch√§ftslogik in einem Haufen, das Schema in einem anderen und sie k√∂nnen unabh√§ngig voneinander ge√§ndert werden. <br><br><img src="https://habrastorage.org/webt/rj/cl/ql/rjclqll79e8wcjwkjfxova8hhpe.png"><br><br>  Als Beispiel f√ºr eine Verbesserung betrachten wir ein einfaches Schema aus zwei Bezeichnungen: Empf√§nger (Empf√§ngertabelle) und Slices der Konfiguration (ReceiverPlanes-Tabelle).  Dem Empf√§ngeretikett sind mehrere Konfigurationsscheiben zugeordnet.  Es gibt nichts besonders kompliziertes. <br><br>  Um Beziehungen innerhalb der ‚Äûschmutzigen‚Äú Schnittstelle der Alchemie zu verbergen, verwenden wir Beziehungen und Sammlungen. <br><br><img src="https://habrastorage.org/webt/mz/ih/qg/mzihqg-lfqb8vhflbkxjpf8igp8.png"><br><br>  Sie erm√∂glichen es uns, unsere Mapper vor dem Client-Code zu verbergen. <br><br><img src="https://habrastorage.org/webt/y8/qc/v1/y8qcv1qj8_jq3y_pn-2xw-t6bji.png"><br><br>  Insbesondere sind zwei sehr n√ºtzliche Sammlungen Associated_proxy und attribute_mapped_collection.  Wir benutzen sie zusammen.  Wie die klassische Beziehung in der Alchemie funktioniert: Wir haben eine Beziehung - dies ist eine bestimmte Sammlung, Liste, Mapper.  Mapper sind weit entfernte Beziehungsobjekte.  Mit Attribute_mapped_collection k√∂nnen Sie diese Liste durch ein Diktat ersetzen, dessen Schl√ºssel einige der Attribute der Mapper sind und deren Werte die Mapper selbst sind. <br><br>  Dies ist der erste Schritt. <br><br><img src="https://habrastorage.org/webt/ho/tj/tt/hotjtty0hmg99f_kquecwyo4ms4.png"><br><br>  Im zweiten Schritt f√ºhren wir Association_Proxy √ºber diese Beziehung aus.  Es erlaubt uns, den Mapper nicht an die Sammlung zu √ºbergeben, sondern einen Wert zu √ºbergeben, der sp√§ter zum Initialisieren unseres Mappers ReceiverPlanes verwendet wird. <br><br>  Hier haben wir Lambda, in dem wir den Schl√ºssel und den Wert √ºbergeben.  Der Schl√ºssel wird zum Namen des Konfigurations-Slice und der Wert zum Wert des Konfigurations-Slice.  Infolgedessen sieht im Client-Code alles so aus. <br><br><img src="https://habrastorage.org/webt/ko/00/s7/ko00s71bgaxu6i-h_baocnnqz-w.png"><br><br>  Wir haben nur eine Art Diktat in eine Art W√∂rterbuch eingef√ºgt.  Alles funktioniert: keine Mapper, keine Alchemie, keine Datenbanken. <br><br>  Es stimmt, es gibt Fallstricke. <br><br><img src="https://habrastorage.org/webt/ux/ji/uy/uxjiuybsymdbtrvqlazqhckdv8c.png"><br><br>  Wenn wir demselben Schl√ºssel zweimal unterschiedliche oder sogar einen Wert zuweisen - Lambda wird f√ºr jedes dieser festgelegten Elemente aufgerufen, wird ein Objekt erstellt - ein Mapper.  Und je nach Struktur des Schemas kann dies zu verschiedenen Konsequenzen f√ºhren, von ‚Äûnur Verst√∂√üen gegen die Konstanten‚Äú bis zu unvorhersehbaren Konsequenzen.  Sie haben beispielsweise ein Objekt aus der Sammlung gel√∂scht, es ist jedoch weiterhin dort geblieben: Sie haben nur eines gel√∂scht.  Als ich anfing, habe ich viel Zeit mit solchen Dingen verbracht. <br><br>  Und eine kleine implizite Synchronisation.  Association_proxy und attribute_mapped_collection k√∂nnen etwas verz√∂gert sein: Wenn wir ein Mapper-Objekt erstellen, wird es der Datenbank hinzugef√ºgt, ist jedoch noch nicht im Auflistungsattribut vorhanden.  Es wird dort nur angezeigt, wenn das Attribut in dieser Sitzung abl√§uft.  Wenn es abl√§uft, wird eine neue Synchronisation mit der Datenbank durchgef√ºhrt und es wird dort ankommen. <br><br>  Um dies zu √ºberwinden, haben wir unsere eigenen, selbst geschriebenen Sammlungen verwendet.  Dies ist nicht einmal Alchemie - Sie k√∂nnen einfach Ihre eigene Sammlung erstellen, um all dies zu √ºberwinden. <br><br><img src="https://habrastorage.org/webt/bk/l6/ya/bkl6yaerwagttjp6qprlfbsdpaw.png"><br><br>  Es gibt mehr Code und der wichtigste Teil wird hervorgehoben.  Wir haben eine bestimmte Sammlung, die von ver√§nderlichen Zuordnungen erbt - dies ist ein Diktat, in dessen Schl√ºsseln Sie die Werte √§ndern k√∂nnen.  Und es gibt eine _get_plane_obj-Methode, um das Konfigurations-Slice-Objekt abzurufen. <br><br>  Hier machen wir einfache Dinge - wir versuchen, es durch Namen, durch einen Prim√§rschl√ºssel zu erhalten, und wenn dies nicht der Fall ist, erstellen wir dieses Objekt und geben es zur√ºck. <br><br>  Als n√§chstes definieren wir nur zwei Methoden neu: __setitem__ und __getitem__ <br>  In __setitem__ f√ºgen wir diese Objekte in einer Sammlung in unsere Sammlung ein.  Das einzige ist, dass wir ganz am Ende Wert zuweisen.  Daher implementieren wir den gleichen Mechanismus wie assoziations_proxy - √ºbergeben Sie den Wert, diktieren Sie dort und er wird dem entsprechenden Attribut zugewiesen. <br><br>  __getitem__ f√ºhrt die umgekehrte Manipulation durch.  Es empf√§ngt per Schl√ºssel ein Objekt vom Relais und gibt sein Attribut zur√ºck.  Hier gibt es auch eine kleine Gefahr: Wenn Sie die Sammlung in unserem Mapping zwischenspeichern, kann es sein, dass die Synchronisation etwas ausf√§llt.  Denn wenn das Attribut der Sammlung in der Alchemie abgelaufen ist, wird die Sammlung nach Ablauf durch eine andere ersetzt.  Daher k√∂nnen wir den Verweis auf die alte Sammlung beibehalten und wissen nicht, dass die alte abgelaufen ist und eine neue bereits erschienen ist.  Daher gehen wir im letzten Teil direkt zur Instanz der Alchemie, erhalten die Sammlung erneut √ºber __getattr__ und machen __getitem__ damit.  Das hei√üt, wir k√∂nnen die Planes-Sammlung hier nicht zwischenspeichern. <br><br><img src="https://habrastorage.org/webt/_0/l6/tt/_0l6tt3pcdjmsxlwy2hivf1b4ty.png"><br><br>  Wie schl√§gt diese Sammlung auf unsere Mixins?  Richten Sie wie gewohnt ein Sammlungsattribut ein.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der einzig interessante Ort ist, dass beim Laden einer Instanz aus der Datenbank die Methode __init__ nicht aufgerufen wird. Alle Attribute werden nachtr√§glich ersetzt. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alchemy bietet einen Standard-Rekonstruktor-Dekorator, mit dem Sie eine Methode als aufgerufen markieren k√∂nnen, nachdem Sie ein Objekt aus der Datenbank geladen haben. Und gerade beim Booten m√ºssen wir unsere Sammlung initialisieren. Selbst ist genau diese Instanz. Die Verwendung ist genau die gleiche wie im vorherigen Beispiel. </font></font><br><br><img src="https://habrastorage.org/webt/qe/yr/h4/qeyrh4fd3cmfpm8-exbfd1rwpkw.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In unserem Schema sind die Ohren der Datenbank jedoch weiterhin sichtbar - dies ist die Konfiguration. Welche Art von Konfiguration? Ist es varchar oder ist es blob? In der Tat ist der Kunde nicht interessiert. Er muss mit abstrakten Entit√§ten seiner Ebene arbeiten. Daf√ºr bietet die Alchemie eine Art Dekoration.</font></font><br><br><img src="https://habrastorage.org/webt/ds/lc/ic/dslcicbf3yrljfchfwbxhcucleq.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ein einfaches Beispiel. Unsere Datenbank speichert IPAddress als varchar. Wir verwenden die TypeDecorator-Klasse, die Teil der Alchemie ist und die es erm√∂glicht, zum einen anzugeben, welcher zugrunde liegende Datenbanktyp f√ºr diesen Typ verwendet wird, und zum anderen zwei Parameter zu definieren: process_bind_param, die den Wert in den Datenbanktyp konvertieren, und process_result_value, wenn wir bewerten Konvertieren Sie vom Datenbanktyp in ein Python-Objekt. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das Attribut from address nimmt den Python-Typ IPAddress an. Und wir k√∂nnen beide Methoden dieses Typs aufrufen und Objekte dieses Typs zuweisen, und alles funktioniert f√ºr uns. Und es ist in der Datenbank gespeichert ... Ich wei√ü nicht, was gespeichert ist, varchar (45), aber wir k√∂nnen diese Zeile ersetzen und der Blob wird gespeichert. Wenn ein nativer Typ IP-Adressen unterst√ºtzt, k√∂nnen Sie ihn verwenden.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Client-Code h√§ngt nicht davon ab, er muss nicht neu geschrieben werden. </font></font><br><br><img src="https://habrastorage.org/webt/xb/m5/uu/xbm5uu_ryeji94kthsv0rp2ogdw.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eine andere interessante Sache ist, dass wir eine Version haben. Wir m√∂chten, dass die Version sofort erh√∂ht wird, sobald wir unser Objekt √§ndern. Wir haben einen Versionsz√§hler, wir haben das Objekt ge√§ndert - es hat sich ge√§ndert, die Version hat sich erh√∂ht. Wir machen das automatisch, um nicht zu vergessen. </font></font><br><br><img src="https://habrastorage.org/webt/zy/g5/ro/zyg5rofkv1ibi-yb-kuv3kikbww.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Daf√ºr haben wir Ereignisse verwendet. Ereignisse sind Ereignisse, die in verschiedenen Lebensphasen eines Mappers auftreten. Sie k√∂nnen ausgel√∂st werden, wenn sich Attribute √§ndern, wenn eine Entit√§t von einem Status in einen anderen wechselt, z. B. "erstellt", "in der Datenbank gespeichert", "aus der Datenbank geladen", "gel√∂scht". und auch - bei Ereignissen auf Sitzungsebene, bevor der SQL-Code an die Datenbank ausgegeben wird, vor dem Festschreiben, nach dem Festschreiben und auch nach dem Rollback.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mit Alchemy k√∂nnen wir Handler f√ºr alle diese Ereignisse zuweisen, aber die Reihenfolge, in der Handler f√ºr dasselbe Ereignis ausgef√ºhrt werden, ist nicht garantiert. Das hei√üt, es ist spezifisch, aber es ist nicht bekannt, welches. Wenn Ihnen die Ausf√ºhrungsreihenfolge wichtig ist, m√ºssen Sie daher einen Registrierungsmechanismus durchf√ºhren. </font></font><br><br><img src="https://habrastorage.org/webt/wb/h2/w1/wbh2w1k4s4y6jqemt4oatlknwug.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hier ist ein Beispiel. Hier werden drei Ereignisse verwendet:</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on_before_flush - Bevor der SQL-Code an die Datenbank ausgegeben wird, gehen wir alle Objekte durch, die in dieser Sitzung als fehlerhaft markiert wurden, und pr√ºfen, ob dieses Objekt ge√§ndert wurde oder nicht. Warum ist das notwendig, wenn die Alchemie bereits alles markiert hat? Alchemie markiert ein Objekt als verschmutzt, sobald sich ein Attribut ge√§ndert hat. Wenn wir diesem Attribut denselben Wert zuweisen, den es hatte, wird es als verschmutzt markiert. Hierf√ºr gibt es eine is_modified-Sitzungsmethode - sie wird intern verwendet, ich habe sie nicht gezeichnet. Aus Sicht unserer Semantik und aus Sicht unserer Gesch√§ftslogik kann das Objekt auch dann unver√§ndert bleiben, wenn sich das Attribut ge√§ndert hat. Zum Beispiel gibt es eine bestimmte Liste, in der zwei Elemente ausgetauscht werden - aus Sicht der Alchemie hat sich das Attribut ge√§ndert, aber es spielt f√ºr die Gesch√§ftslogik keine Rolle, wenn beispielsweiseeine Art.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Und am Ende rufen wir eine andere objektspezifische Methode auf, um zu verstehen, ob das Objekt ge√§ndert wird oder nicht. Und wir f√ºgen sie einer bestimmten Variablen hinzu, die mit der Sitzung verkn√ºpft ist, die wir selbst aufgerufen haben - dies ist unsere Variable dirty_instances, in die wir dieses Objekt einf√ºgen. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das folgende Ereignis tritt vor dem Commit auf - before_commit. Es gibt auch eine kleine Gefahr: Wenn wir f√ºr die gesamte Transaktion keinen einzigen Flush hatten, wird der Flush vor dem Commit aufgerufen. In meinem Fall wurde der Handler vor dem Commit vor dem Flush aufgerufen. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wie Sie sehen k√∂nnen, hilft uns das, was wir im vorherigen Absatz getan haben, m√∂glicherweise nicht und session.dirty_instances ist leer. Daher machen wir im Handler erneut Flush, sodass alle Handler vor dem Flush aufgerufen werden, und erh√∂hen die Version einfach um eins.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">after_commit, after_soft_rollback - nach dem Commit bereinigen wir es einfach, damit es beim n√§chsten Mal keine √úbersch√ºsse gibt. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sie sehen also, diese install_handler-Methode installiert Handler f√ºr drei Ereignisse gleichzeitig. Als Klasse bestehen wir die Sitzung hier, da dies ein Ereignis seines Niveaus ist. </font></font><br><br><img src="https://habrastorage.org/webt/oi/w8/pk/oiw8pkhgdpx7shz7rqrovfmg6lk.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bitte sch√∂n. Ich werde Sie daran erinnern, was wir erreicht haben - Geschwindigkeit von 30-40 Sekunden f√ºr komplexe und gro√üe Teams. √úberhaupt nicht, einige wurden in einer Sekunde abgeschlossen, andere in 200 Millisekunden, wie Sie auf RPS sehen k√∂nnen. Datenbankabfragen wurden zu Hunderten gez√§hlt. </font></font><br><br><img src="https://habrastorage.org/webt/7p/wk/qo/7pwkqo4-g_hksl5m_cqoo3xph5y.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das Ergebnis ist ein ziemlich ausgewogenes System. Es gab jedoch eine Einschr√§nkung. Einige Anfragen kommen von uns in Chargen, Emissionen. Das hei√üt, ungef√§hr 30 Anfragen kommen an und jede von ihnen ist so! (Sprecher zeigt Daumen)</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wenn wir sie jeweils eine Sekunde lang verarbeiten, funktioniert die letzte Anforderung in der Warteschlange 30 Sekunden lang. Der erste, die zweiten beiden und so weiter. </font></font><br><br><img src="https://habrastorage.org/webt/ut/br/gl/utbrglrwurgv0uux2yk8eme4owg.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deshalb m√ºssen wir noch beschleunigen. Was machen wir? </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tats√§chlich besteht die Alchemie aus zwei Teilen. Die erste ist eine Abstraktion √ºber eine SQL-Datenbank namens SQLAlchemy Core. Das zweite ist ORM, die tats√§chliche Zuordnung zwischen der relationalen Datenbank und der Objektdarstellung. Dementsprechend f√§llt der Alchemiekern ungef√§hr eins zu eins mit SQL zusammen - wenn Sie letzteres kennen, werden Sie keine Probleme mit dem Kern haben. Wenn Sie SQL nicht kennen - lernen Sie SQL. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dar√ºber hinaus stellt der Kern den geringsten Overhead dar. Es gibt praktisch kein Pumpen - Abfragen werden mit dem Abfragegenerator generiert und dann ausgef√ºhrt. Der Overhead √ºber Dbapi ist minimal.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir k√∂nnen Anforderungen beliebiger Komplexit√§t und Art erstellen und sie f√ºr die Aufgabe optimieren. Das hei√üt, wenn es ORM im allgemeinen Fall egal ist, wie das Datenbankschema erstellt wird - es gibt eine Beschreibung der Tabellen, werden einige Abfragen generiert, ohne zu wissen, dass es in diesem Fall beispielsweise optimal ist, von hier, in einem anderen - von dort aus auszuw√§hlen Wenden Sie den Filter an, und dort - noch einen, dann k√∂nnen wir hier Anfragen f√ºr die Aufgabe stellen. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Nachteil ist, dass wir wieder zur manuellen Synchronisation gekommen sind. Alle Ereignisse, Relais - all dies im Kern funktioniert nicht. Wir haben eine Auswahl getroffen, Objekte sind zu uns gekommen, wir haben etwas mit ihnen gemacht, dann aktualisiert, eingef√ºgt ... Sie m√ºssen die Version mit Ihren H√§nden erh√∂hen, die Konstanten selbst √ºberpr√ºfen. Core erlaubt es nicht, all dies bequem auf hohem Niveau zu erledigen. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nun, wir leben nicht am ersten Tag.</font></font><br><br><img src="https://habrastorage.org/webt/qx/kk/bx/qxkkbxwleeqwvdukaghimiat7sw.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ein einfacher Anwendungsfall. Jeder Mapper enth√§lt intern ein __table__ -Objekt, das im Core verwendet wird. Als n√§chstes sehen Sie - wir nehmen die √ºbliche Auswahl, listen die Spalten auf, verbinden zwei Platten, geben links und rechts an, geben an, unter welchen Bedingungen wir sie verbinden. Au√üerdem geben wir diese generierte Anforderung in die Sitzung ein und sie gibt sie iterabel an uns zur√ºck, wobei die tippartigen Objekte sowohl nach dem Namen der Spalte als auch nach der Nummer indiziert werden. Die Nummer entspricht der Reihenfolge, in der sie in der Auswahl aufgef√ºhrt sind. </font></font><br><br><img src="https://habrastorage.org/webt/r2/uq/f4/r2uqf4wn-wa-cvigivokusan6um.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es ist viel besser geworden. Die Leistung fiel im schlimmsten Fall auf 2-4 Sekunden, die komplexeste und l√§ngste Anforderung enthielt 14 Befehle und RPS 10-15. Es ist fest. </font></font><br><br><img src="https://habrastorage.org/webt/m9/8d/mw/m98dmwpmo0trjpw3vta7dylmryw.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Was ich abschlie√üend sagen m√∂chte.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Produzieren Sie keine Entit√§ten, wo sie nicht ben√∂tigt werden - schrauben Sie Ihre nicht dort, wo sie fertig sind. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verwenden Sie SQLA ORM - dies ist ein sehr praktisches Tool, mit dem Sie Ereignisse auf hoher Ebene verfolgen, auf verschiedene Ereignisse im Zusammenhang mit der Datenbank reagieren und alle Ohren der Alchemie verbergen k√∂nnen. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wenn alles andere fehlschl√§gt, reicht die Leistung nicht aus - verwenden Sie SQLA Core. </font><font style="vertical-align: inherit;">Dies ist immer noch besser als die Verwendung von reinem SQL, da es eine relationale Abstraktion √ºber die Datenbank bietet. </font><font style="vertical-align: inherit;">Entgeht automatisch Parametern, f√ºhrt Ordner korrekt aus, es spielt keine Rolle, welche Datenbank sich darunter befindet - sie kann ge√§ndert werden und Core unterst√ºtzt verschiedene Dialekte.</font></font> Es ist sehr bequem. <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Das ist alles, was ich dir heute sagen wollte. </font></font><br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/flA2lEl2a0M" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de430818/">https://habr.com/ru/post/de430818/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de430804/index.html">Tesla / Panasonic-Batterien sind die g√ºnstigsten Batterien f√ºr Elektrofahrzeuge auf dem Markt</a></li>
<li><a href="../de430806/index.html">Wir haben angefangen Englisch zu lernen - haben eine Anwendung geschrieben: EWM - Erfahrung bei der Erstellung eines Schulungsprojekts</a></li>
<li><a href="../de430808/index.html">Sprechertheorie: 16 Materialien zur Funktionsweise von Sprechern und Sprechern</a></li>
<li><a href="../de430810/index.html">Lastpr√ºfung mit Heuschrecke. Teil 2</a></li>
<li><a href="../de430812/index.html">Was developer.android.com √ºber RecyclerView spricht</a></li>
<li><a href="../de430820/index.html">Schwarzer Freitag 2018 - VDS in Moskau und Amsterdam</a></li>
<li><a href="../de430822/index.html">Informationssicherheit im Internet der Dinge: Wer ist das Ding und wer ist der Meister?</a></li>
<li><a href="../de430824/index.html">Suchen Sie in MS SQL Server 2005 nach besch√§digtem Objekt anhand der besch√§digten Seitenzahl</a></li>
<li><a href="../de430826/index.html">Wie man einen Entwicklungsmanager entwickelt</a></li>
<li><a href="../de430828/index.html">Erfahrung in der Verwendung von LCD-Displays auf Basis von MELT-Produkten</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>