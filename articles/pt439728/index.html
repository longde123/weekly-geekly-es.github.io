<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üïì üè¥‚Äç‚ò†Ô∏è üíÜ Configurar backup e recupera√ß√£o completos e separados do Zimbra OSE sem usar o Zextras ‚öîÔ∏è üôáüèø üëÇüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="1. Por onde come√ßar 
 Onde o backup √© iniciado? Planejamento. Ao fazer backup de qualquer sistema, voc√™ precisa fazer um plano de backup: com que prec...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Configurar backup e recupera√ß√£o completos e separados do Zimbra OSE sem usar o Zextras</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/439728/"><img src="https://habrastorage.org/webt/tl/fg/oj/tlfgoj8_4wwdpcdcj5n8ndx2pu0.png" alt="imagem"><br><br><h3>  1. Por onde come√ßar </h3><br>  Onde o backup √© iniciado?  Planejamento.  Ao fazer backup de qualquer sistema, voc√™ precisa fazer um plano de backup: com que precis√£o, quantas vezes, por quanto tempo armazenar, haver√° espa√ßo livre suficiente?  Das respostas a estas perguntas, segue a resposta para a pergunta principal - como fazer backup? <br><br>  Se houver muito espa√ßo livre, voc√™ poder√° armazenar toda a m√°quina virtual.  Fa√ßa backups com o mesmo Veeam em um cronograma e n√£o pense nas dificuldades.  Mas, para mim, √© um desperd√≠cio, estou acostumado a fazer tudo da forma mais concisa e econ√¥mica poss√≠vel.  Obviamente, implantei o Veeam, mas apenas fa√ßo c√≥pias de backup desses sistemas que s√£o imposs√≠veis ou problem√°ticos de implantar a partir de backups por um per√≠odo muito longo. <br><br>  Sobre os scripts das ferramentas de gerenciamento do ambiente virtual, simplesmente ficarei em sil√™ncio de maneira significativa. <br><br>  O Zimbra possui uma ferramenta zmmailbox.  E, examinando mais de perto sua funcionalidade, percebi que seria mais do que suficiente para mim.  Ele pode fazer backup e restaurar caixas de correio, mesmo em um sistema ativo.  E gostei da capacidade de fazer backup de caixas de correio cr√≠ticas separadamente do backup de todo o sistema.  Portanto, o espa√ßo ocupado pelos backups ser√° limitado pelo tamanho das caixas de correio arquivadas multiplicado pelo n√∫mero de dias de "profundidade do backup" e n√£o pelo volume de todo o sistema multiplicado pelo mesmo n√∫mero de dias.  Al√©m disso, √© extremamente dif√≠cil recuperar de um backup de todo o sistema, no caso do Zimbra.  √â muito mais f√°cil copiar uma m√°quina virtual usando as ferramentas Veeam ou de gerenciamento de ambiente virtual (Hyper-V, ESXI, digite a desejada) logo ap√≥s configurar o sistema e coloc√°-la na prateleira para que, em um momento cr√≠tico, voc√™ possa implantar rapidamente VMs quase sem peso e fazer o upload nele backups de caixas.  Na minha opini√£o, este √© o cen√°rio menos caro em todos os aspectos. <br><a name="habracut"></a><br><h3>  2. Os dados de origem: </h3><br>  <i>Sistema operacional do servidor</i> : CentOS 7 <br><br><div class="spoiler">  <b class="spoiler_title">Sobre o SO</b> <div class="spoiler_text">  De fato, a diferen√ßa entre o CentOS7 e qualquer outro sistema est√° apenas em comandos para o servidor instalar pacotes e, possivelmente, na localiza√ß√£o de alguns arquivos.  O trabalho √© realizado principalmente com cmdlets do Zimbra, para que as diferen√ßas de configura√ß√£o sejam m√≠nimas. </div></div><br>  <i>Dom√≠nio Zimbra</i> : zimbramail.home.local <br>  <i>Nome de usu√°rio e senha para acessar a pasta compartilhada</i> : ZimbraBackUp / 123123 <br>  <i>O caminho para a pasta compartilhada</i> : \\ BackUpServer1 \ ZM \ <br>  <i>O caminho para montar as bolas no host Zimbra</i> : / mnt / ZM / <br><br><h3>  3. Configura√ß√£o </h3><br>  Ent√£o, vamos come√ßar! <br><br>  Escreveremos backups em um servidor executando o Windows em uma pasta compartilhada.  Se desejar, voc√™ pode mesclar backups em qualquer lugar, mas tudo est√° configurado para que a maioria dos backups seja gravada em BackUpServer1.home.local.  Para que: <br><br>  1) Criamos no dom√≠nio do usu√°rio para acessar a pasta compartilhada neste servidor, para que possa ser montada no servidor Zimbramail.home.local.  Nome de usu√°rio ZimbraBackUp, senha, condicionalmente, 123123. <br><br>  2) No servidor BackUpServer1, crie o diret√≥rio \ ZM \ no reposit√≥rio e compartilhe-o, concedendo direitos de altera√ß√£o para o usu√°rio ZimbraBackUp.  O caminho para a bola ser√°: \\ BackUpServer1 \ ZM \ <br><br>  3) Monte a bola no servidor Zimbramail.home.local.  Para que a pasta seja montada automaticamente, voc√™ precisa corrigir o arquivo / etc / fstab adicionando a linha a ele: <br><br><pre><code class="bash hljs">//BackUpServer/ZM /mnt/ZM cifs user,uid=500,rw,suid,username=ZimbraBackUp,password=123123 0 0</code> </pre> <br>  Mas primeiro voc√™ precisa verificar se a montagem funciona: <br><br><pre> <code class="bash hljs">$ mount -t cifs //BackUpServer/ZM /mnt/ZM -o user=ZimbraBackUp,password=123123</code> </pre> <br>  Muitas vezes, um erro como este aparece: <br><br><pre> <code class="bash hljs">mount: wrong fs <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, bad option, bad superblock on //BackUpServer1/ZM/, missing codepage or helper program, or other error (<span class="hljs-keyword"><span class="hljs-keyword">for</span></span> several filesystems (eg nfs, cifs) you might need a /sbin/mount.&lt;<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>&gt; helper program) In some cases useful info is found <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> syslog - try dmesg | tail or so.</code> </pre> <br>  Voc√™ pode corrigi-lo instalando o cifs-utils: <br><br><pre> <code class="bash hljs">$ yum install cifs-utils</code> </pre> <br>  Ap√≥s a configura√ß√£o, recomendo reiniciar o servidor. <br><br>  4) Crie 3 arquivos de script: FullBackUp.sh HandBackUp.sh Restore.sh <br><br>  O primeiro arquivo ser√° usado para criar automaticamente backups agendados, o segundo para a capacidade de fazer backup de caixas de correio individuais ou simplesmente iniciar manualmente "what if".  E o terceiro script √© a restaura√ß√£o de uma ou de todas as caixas de uma s√≥ vez.  Tentei, tanto quanto poss√≠vel, comentar o trabalho dos scripts e o registro prescrito. <br><br><div class="spoiler">  <b class="spoiler_title">O conte√∫do do arquivo FullBackUp.sh:</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash #   Path="/mnt/ZM/BackUps" #    ArchPath="/mnt/ZM/Archive" #    MPath="/mnt/ZM/Mounthly" #  Zimbra ZDomain="zimbramail.home.local" #  MBoxes="/mnt/ZM/MBoxesList" #  CDate=$(date +%d-%m-%Y) #   MDay=$(date +%d) #   log="/mnt/ZM/BackUpLog.txt" echo -en "BackUp ALL MailBoxes started in $(date +%T)\n" &gt;&gt; $log #       if [ ! -d $Path ]; then #     echo "    ..." mkdir -p $Path if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "BackUp dirctory was created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "BackUp dirctory was NOT created in $(date +%T)\n" &gt;&gt; $log fi else echo "    ,      ..." fi #       if [ ! -d $Path/$CDate ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo #        echo "       ..." mkdir -p $Path/$CDate if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "BackUp CDate dirctory was created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "BackUp CDate dirctory was NOT created in $(date +%T)\n" &gt;&gt; $log fi else echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo "    ,     ..." fi #     /opt/zimbra/bin/zmprov -l gaa $ZDomain &gt; $MBoxes #    if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Mail Boxes list created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6)[FAIL]" echo echo -en "Mail Box list is NOT created! in $(date +%T)\n" &gt;&gt; $log exit fi #       for MailBox in $( cat $MBoxes); do echo "    $MailBox..." /opt/zimbra/bin/zmmailbox -z -m $MailBox getRestUrl "//?fmt=tgz" &gt; $Path/$CDate/$MailBox if [ $? -eq 0 ]; then #        echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Mail Box $MailBox BackUp created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6)[FAIL]" echo echo -en "Mail Box $MailBox BackUp is NOT created! in $(date +%T)\n" &gt;&gt; $log fi done #     echo "    ..." echo -n &gt; $MBoxes if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "File $MBoxes clear\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "File $MBoxes can NOT be cleared\n" &gt;&gt; $log fi #      #      if [ ! -d $ArchPath ]; then #    echo "   ..." mkdir -p $ArchPath if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Archive dirctory was created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Archive dirctory was NOT created in $(date +%T)\n" &gt;&gt; $log fi else echo "   , ..." fi tar -czf $ArchPath/$CDate.tar $Path/$CDate if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Archive created in $(date +%T)\n" &gt;&gt; $log #         if [ "$MDay" = 1 ]; then #      if [ ! -d $MPath ]; then #     echo "    ..." mkdir -p $MPath if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Long saving dirctory was created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Long saving dirctory was NOT created in $(date +%T)\n" &gt;&gt; $log fi else #  echo "    ,     ..." fi cp $ArchPath/$CDate.tgz $MPath/$CDate if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Archive is copied in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Archive is NOT copied in $(date +%T)\n" &gt;&gt; $log fi echo "    ( 1 )..." # ,   ,   find $Path -atime +7 | xargs rm -d if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Old BackUps files was deleted\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Old BackUps files is NOT deleted in $(date +%T)\n" &gt;&gt; $log fi #    ( 2 ) echo "     ( 2 )..." find $ArchPath -atime +61 | xargs rm -f if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Old BackUps archives was deleted\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Old BackUps archives is NOT deleted in $(date +%T)\n" &gt;&gt; $log fi fi else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Archive is NOT created in $(date +%T)\n" &gt;&gt; $log fi echo "BackUp job finished in $(date +%T)" #  -     echo -en "BackUp job finished in $(date +%T) $(date +%T)\n" &gt;&gt; $log echo -en "_____________________________________________\n" &gt;&gt; $log</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Conte√∫do do arquivo HandBackUp.sh:</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash #   Path="/mnt/ZM/BackUps" #    ArchPath="/mnt/ZM/Archive" #  Zimbra ZDomain="zimbramail.home.local" #  MBoxes="/mnt/ZM/MBoxesList" #  CDate=$(date +%d-%m-%Y) #   log="/mnt/ZM/BackUpLog.txt" read -p "    (  ),  ALL      : " A if [[ "$A" = "ALL" || "$A" = "all" ]]; then echo -en "BackUp started in $(date +%T)\n" &gt;&gt; $log #     echo "    ..." /opt/zimbra/bin/zmprov -l gaa $ZDomain &gt; $MBoxes if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Mail Boxes list created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6)[FAIL]" echo echo -en "Mail Box list is NOT created! in $(date +%T)\n" &gt;&gt; $log exit fi if ! [ -d $Path/$Date ]; then #    mkdir -p $Path/$CDate/ echo -en "BackUp directory created in $(date +%T)\n" &gt;&gt; $log fi #       echo "      " for MailBox in $( cat $MBoxes); do echo "    $MailBox..." /opt/zimbra/bin/zmmailbox -z -m $MailBox getRestUrl "//?fmt=tgz" &gt; $Path/$CDate/$MailBox if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Mail Box $MailBox BackUp created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6)[FAIL]" echo echo -en "Mail Box $MailBox BackUp is NOT created! in $(date +%T)\n" &gt;&gt; $log fi done else MailBox="$A@$ZDomain" #    echo "   ..." Result=$(/opt/zimbra/bin/zmprov getMailboxInfo $MailBox) if [ $? -eq 0 ]; then #   echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo "  $MailBox ,  ..." echo -en "Required Mail Box $MailBox exist $(date +%T)\n" &gt;&gt; $log #      if ! [ -d $Path/$Date ]; then #    mkdir -p $Path/$CDate/ echo -en "BackUp directory created in $(date +%T)\n" &gt;&gt; $log fi #    $MailBox /opt/zimbra/bin/zmmailbox -z -m $MailBox getRestUrl "//?fmt=tgz" &gt; $Path/$CDate/$MailBox if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Mail Box $MailBox BackUp created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6)[FAIL]" echo echo -en "Mail Box $MailBox BackUp is NOT created! in $(date +%T)\n" &gt;&gt; $log fi else #    -  echo -n "$(tput hpa $(tput cols))$(tput cub 6)[FAIL]" echo echo "  $MailBox  .   " echo -en "Required Mail Box $MailBox is not exist\n" &gt;&gt; $log exit fi fi read -p "      $MailBox? [N]: " F if [[ "$F" = "Y" || "$F" = "y" ]]; then #      if [ ! -d $ArchPath ]; then #     echo "   ..." mkdir -p $ArchPath if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Archive dirctory was created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Archive dirctory was NOT created in $(date +%T)\n" &gt;&gt; $log fi else echo "   , ..." fi #    echo "  ..." if [[ "$A" = "ALL" || "$A" = "all" ]]; then tar -czf $ArchPath/$CDate.tar $Path/$CDate if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Archive created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Archive is NOT created in $(date +%T)\n" &gt;&gt; $log fi else tar -czf $ArchPath/$MailBox.tar $Path/$CDate/$MailBox if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Archive created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Archive is NOT created in $(date +%T)\n" &gt;&gt; $log fi fi else echo "   " echo -en "User decline archive creating\n" &gt;&gt; $log fi #     echo "    ..." echo -n &gt; $MBoxes if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo fi echo "BackUp job finished in $(date +%T) $(date +%T)" #  -     echo -en "BackUp job finished in $(date +%T) $(date +%T)\n" &gt;&gt; $log echo -en "_____________________________________________\n" &gt;&gt; $log</span></span></code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">O conte√∫do do arquivo Restore.sh:</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash #   Path="/mnt/ZM/BackUps" #  Zimbra ZDomain="zimbramail.home.local" #  MBoxes="/mnt/ZM/MBoxesList" #   log="/mnt/ZM/RestoreLog.txt" read -p "  ,      02-09-2001: " Date if ! [ -d $Path/$Date ]; then echo "     ." echo -en "No BackUp file at $Date $(date +%T)\n" &gt; $log exit fi read -p "    (  ),  ALL        : " A if [[ "$A" = "ALL" || "$A" = "all" ]]; then echo -en "Restore started in $(date +%T)\n" &gt;&gt; $log #     ls "$Path/$Date" &gt; $MBoxes for MailBox in $( cat $MBoxes); do #   echo "   $MailBox" Result=$(/opt/zimbra/bin/zmprov getMailboxInfo $MailBox) if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6) [OK]" echo echo -en "Start restore job for $MailBox $(date +%T)\n" &gt;&gt; $log echo " $MailBox . ..." else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Mail Box $MailBox does not exist, creating Mail Box $MailBox $(date +%T)\n" &gt;&gt; $log echo " $MailBox  .   $MailBox..." #   Result=$(/opt/zimbra/bin/zmprov ca $MailBox 12345678 displayName "$MailBox") if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6) [OK]" echo echo -en "Mail Box $MailBox is created, starting restore $(date +%T)\n" &gt;&gt; $log echo " $MailBox  . ..." else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Can NOT create Mail Box $MailBox ! $(date +%T)\n" &gt;&gt; $log echo " $MailBox   ." fi fi #  Result=$(/opt/zimbra/bin/zmmailbox -z -m $MailBox postRestURL "//?fmt=tgz&amp;resolve=replace" $Path/$Date/$MailBox) if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en " $MailBox   $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6)[FAIL]" echo echo -en " $MailBox  ! $(date +%T)\n" &gt;&gt; $log fi done else #     MailBox="$A@$ZDomain" if [ -a $Path/$Date/$MailBox ]; then #   echo "   $MailBox..." Result=$(/opt/zimbra/bin/zmprov getMailboxInfo $MailBox) if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6) [OK]" echo echo -en "Start restore job for $MailBox $(date +%T)\n" &gt;&gt; $log echo " $MailBox . ..." else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Mail Box $MailBox does not exist $(date +%T)\n" &gt;&gt; $log echo " $MailBox  ." read -p "            ? [N]: " B if [[ "$B" = "Y" || "$B" = "y" ]]; then echo "   $MailBox..." Result=$(/opt/zimbra/bin/zmprov ca $MailBox 12345678 displayName "$MailBox") #   if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6) [OK]" echo echo -en "Mail Box $MailBox is created, starting restore $(date +%T)\n" &gt;&gt; $log echo " $MailBox  . ..." else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Can NOT create Mail Box $MailBox ! $(date +%T)\n" &gt;&gt; $log echo " $MailBox   .   ..." exit fi else #   ,  .  echo "   .   " exit fi fi #  Result=$(/opt/zimbra/bin/zmmailbox -z -m $MailBox postRestURL "//?fmt=tgz&amp;resolve=replace" $Path/$Date/$MailBox) if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en " $MailBox   $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6)[FAIL]" echo echo -en " $MailBox  ! $(date +%T)\n" &gt;&gt; $log fi else #     echo "    .   " echo -en "Required BackUp file is not exist\n" &gt;&gt; $log exit fi fi #     echo "    ..." echo -n &gt; $MBoxes if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo fi echo "BackUp job finished in $(date +%T) $(date +%T)" #  -     echo -en "Restore job complete in $(date +%T)\n" &gt;&gt; $log echo -en "____________________________________\n" &gt;&gt; $log</span></span></code> </pre></div></div><br>  H√° uma sutileza.  Se voc√™ criar e editar arquivos de script para o bash no Windows, quando tentar executar o script, aparecer√° um erro: <b>/ bin / sh ^ M: int√©rprete incorreto: n√£o</b> existe <b>esse arquivo ou diret√≥rio</b> , que s√£o os editores executados no Windows. o final da linha √© o caractere de retorno de carro "CR \ LF", que os editores no Linux n√£o exibem.  Mas este s√≠mbolo est√° l√° e n√£o desapareceu.  Para se livrar do erro e remover os caracteres extras, fa√ßa o seguinte: <br><br><pre> <code class="bash hljs">$ cat your-script.sh | tr -d <span class="hljs-string"><span class="hljs-string">'\r'</span></span> &gt; corrected-your-script.sh</code> </pre> <br>  Bem, ou voc√™ pode usar o utilit√°rio dos2unix, mas ainda precisa instal√°-lo: <br><br><pre> <code class="bash hljs">$ yum install dos2unix $ dos2unix your-script.sh</code> </pre> <br>  5) Tornamos os scripts execut√°veis: <br><br><pre> <code class="bash hljs">$ chmod 0740 /opt/zimbra/BkUpRestScripts/FullBackUp.sh $ chmod 0740 /opt/zimbra/BkUpRestScripts/HandBackUp.sh $ chmod 0740 /opt/zimbra/BkUpRestScripts/Restore.sh</code> </pre> <br>  6) Eu recomendo que voc√™ execute scripts com as m√£os e verifique se eles funcionam e como eles funcionam. <br><br>  7) Crie uma tarefa no CRON para backup di√°rio de caixas de correio: <br><br><pre> <code class="bash hljs">10 0 * * * root /opt/zimbra/ BkUpRestScripts/FullBackUp.sh</code> </pre> <br>  8) Aproveite <br><br><h3>  4. Script </h3><br>  Caso os coment√°rios nos scripts em si n√£o tenham ajudado. <br><br><div class="spoiler">  <b class="spoiler_title">1) Script FullBaclUp.sh:</b> <div class="spoiler_text">  No in√≠cio, as vari√°veis ‚Äã‚Äãs√£o determinadas, qual delas √© respons√°vel pelo qu√™ - tudo √© comentado. <br><br>  A seguir, √© apresentada uma verifica√ß√£o da aus√™ncia de um diret√≥rio para backup; se ele n√£o existir, ele ser√° criado.  A conclus√£o √© feita no arquivo de log e na tela (se iniciada manualmente) sobre o sucesso ou falha da cria√ß√£o de um diret√≥rio. <br><br>  Verifique se h√° um cat√°logo ausente com a data de hoje.  Se n√£o estiver l√°, √© criado, a sa√≠da para a tela e o log do resultado da cria√ß√£o do diret√≥rio tamb√©m s√£o gerados. <br><br>  Gravando em um arquivo todas as caixas de correio Zimbra existentes.  √â necess√°rio para reserva sequencial de cada caixa.  Exibe o resultado do comando. <br><br>  Criando um backup para cada caixa de correio da lista recebida.  Com a sa√≠da da execu√ß√£o na tela e no arquivo de log. <br><br>  Limpando um arquivo com uma lista de caixas.  Como os tr√™s scripts funcionam com esse arquivo, √© recomend√°vel limp√°-lo ap√≥s cada execu√ß√£o, para que n√£o haja surpresas.  Voc√™ pode limp√°-lo antes do in√≠cio do script, mas √© mais familiar para mim n√£o armazenar dados desnecess√°rios ap√≥s o t√©rmino do trabalho, mas fazer o mesmo antes e depois do script funcionar √© um grau moderado de esquizofrenia. <br><br>  A seguir, √© um bloco para criar um arquivo compactado. <br><br>  Verificando a aus√™ncia do diret√≥rio de armazenamento de archive, criando-o na aus√™ncia e exibindo o resultado da cria√ß√£o na tela e no log <br><br>  Arquivamento <br><br>  Marque "n√£o √© o primeiro dia de hoje?"  Eu prefiro armazenar backups durante o primeiro dia de todos os meses por um longo per√≠odo, isso √© suficiente para eu trabalhar.  Ele pode ser armazenado por semanas, mas geralmente isso √© redundante.  Mas a condi√ß√£o para armazenar backups durante todo o per√≠odo de opera√ß√£o do servidor de correio √© definida no topo, para que eles estejam sempre l√°.  Se o n√∫mero for o primeiro, o arquivo resultante ser√° copiado para um diret√≥rio "Mounthly" separado.  E para copi√°-lo, √© necess√°rio verificar se existe um diret√≥rio e, se n√£o, cri√°-lo, o que deve ser relatado na tela e no arquivo de log. <br><br>  Em seguida, o armazenamento √© limpo - todos os backups anteriores a 2 semanas s√£o exclu√≠dos, bem como os arquivos anteriores a 61 dias.  O resultado da exclus√£o √© exibido na tela e no arquivo de log. <br><br>  Ap√≥s o qual o script grava o tempo de conclus√£o no arquivo de log e na tela e termina seu trabalho. </div></div><br><div class="spoiler">  <b class="spoiler_title">2) Script HandBackUp.sh:</b> <div class="spoiler_text">  No in√≠cio, as vari√°veis ‚Äã‚Äãtamb√©m s√£o definidas, tamb√©m comentadas sobre o motivo de serem necess√°rias. <br><br>  Em seguida, o usu√°rio √© solicitado a inserir o nome da caixa de correio que precisa ser copiada, sem especificar o dom√≠nio Zimbra.  (est√° escrito no convite para entrar) ou selecione um backup de todas as caixas de correio escrevendo TODAS ou TODAS. <br><br>  Se voc√™ optar por fazer backup de todas as caixas de correio, o script funcionar√° quase da mesma forma que a primeira listada acima, exceto que, ap√≥s a cria√ß√£o de backups de cada caixa de correio, ser√° perguntado - eu preciso arquiv√°-las? <br><br>  Se uma caixa de correio espec√≠fica foi gravada, sua exist√™ncia √© verificada no Zimbra.  Se existir uma caixa com o nome especificado, o processo de backup dessa caixa ser√° iniciado, com as informa√ß√µes correspondentes exibidas na tela e no arquivo de log.  Se a caixa especificada n√£o existir, o usu√°rio ser√° informado sobre isso e o script concluir√° seu trabalho. <br><br>  Ap√≥s a conclus√£o do backup da caixa, voc√™ ser√° solicitado a arquivar a c√≥pia.  Se o usu√°rio concordar - h√° uma verifica√ß√£o da aus√™ncia de um diret√≥rio para armazenar o arquivo morto e mais abaixo na lista, como no primeiro script. <br><br>  Ap√≥s a conclus√£o do arquivamento, o arquivo com a lista de caixas de correio √© limpo.  Apenas no caso. <br><br>  No final, as informa√ß√µes sobre o tempo de conclus√£o do script s√£o exibidas na tela e no arquivo de log. </div></div><br><div class="spoiler">  <b class="spoiler_title">3) Script Restore.sh:</b> <div class="spoiler_text">  Como nos arquivos anteriores, primeiro - a defini√ß√£o de vari√°veis ‚Äã‚Äãcom coment√°rios. <br><br>  O usu√°rio √© solicitado a selecionar a data do backup a ser restaurado.  Se a data especificada n√£o estiver nos backups, o script ser√° encerrado relatando isso. <br><br>  Se existirem backups para a data especificada - solicite ao usu√°rio que digite o nome da caixa que precisa ser restaurada.  Para restaurar todas as caixas, voc√™ precisa escrever TODAS ou TODAS. <br><br>  Se a op√ß√£o ALL estiver selecionada, o script criar√° uma lista de arquivos na pasta de backup no arquivo, notificando sobre o resultado da cria√ß√£o. <br><br>  A seguir, √© apresentada uma recupera√ß√£o passo a passo de cada caixa.  Primeiro, verifique a exist√™ncia de uma caixa no sistema, caso contr√°rio, ela √© criada e depois restaurada.  As informa√ß√µes sobre cada opera√ß√£o s√£o exibidas no arquivo de log e na tela. <br><br>  Se uma caixa espec√≠fica √© selecionada, √© quase a mesma.  Verifique a exist√™ncia de um arquivo com o nome solicitado.  Sa√≠da para a tela e o arquivo de log de resultados. <br><br>  Verificando a exist√™ncia de uma caixa no sistema.  Sa√≠da para a tela e o arquivo de log de resultados. <br>  O convite para o usu√°rio concordar com a cria√ß√£o da caixa na aus√™ncia dela no sistema.  Sa√≠da para a tela e o arquivo de log de resultados. <br><br>  Crie uma caixa, se acordado.  Sa√≠da para a tela e o arquivo de log de resultados. <br>  Recupera√ß√£o de caixa de correio.  Sa√≠da para a tela e o arquivo de log de resultados. <br><br>  Limpando um arquivo com uma lista de caixas de recupera√ß√£o. <br><br>  No final, as informa√ß√µes sobre o tempo de conclus√£o do script s√£o exibidas na tela e no arquivo de log. </div></div><br><h3>  5. Quanto √† recupera√ß√£o </h3><br>  Se voc√™ modificar levemente esses scripts, eles ser√£o adequados para mover mensagens de servidor para servidor, simplesmente criando em um novo local caixas de correio com todo o conte√∫do.  Tamb√©m √© poss√≠vel restaurar o sistema a partir do zero, quando, por algum motivo, √© mais f√°cil aumentar novamente o servidor Zimbra do que tentar reviver o antigo.  Como descrito acima, voc√™ pode salvar a imagem da m√°quina virtual configurada expandindo-a, se necess√°rio, e preenchendo-a com todos os dados.  O mesmo algoritmo para mover de um servidor Zimbra para outro.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> E n√£o s√£o necess√°rios utilit√°rios pagos como o Zextras. </font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 6. Conclus√£o </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em geral, n√£o h√° nada complicado nos scripts que escrevi. </font><font style="vertical-align: inherit;">Sim, existem muitas condi√ß√µes neles, porque tentei prever o maior n√∫mero poss√≠vel de problemas e erros no trabalho deles, mas tamb√©m tentei comentar o script o mais claramente poss√≠vel. </font><font style="vertical-align: inherit;">Provavelmente, fora da caixa, eles n√£o funcionar√£o para todos. </font><font style="vertical-align: inherit;">Talvez algu√©m n√£o tenha esse m√©todo de backup. </font><font style="vertical-align: inherit;">Mas espero que muitos achem √∫til.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 7. PS: </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Este √© o segundo artigo da s√©rie "Como eu implementei o Zimbra". </font><font style="vertical-align: inherit;">O primeiro √© sobre implementa√ß√£o, autoriza√ß√£o LDAP e cria√ß√£o autom√°tica de caixas de correio para usu√°rios do AD, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O terceiro artigo sobre a gera√ß√£o autom√°tica e atualiza√ß√£o de listas de discuss√£o baseadas em AD no Zimbra OSE </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">est√° aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">E tamb√©m quero observar que esta √© a minha primeira experi√™ncia de script em uma base, por causa disso, os scripts acabaram sendo muito volumosos e "especialmente inteligentes", como eles dizem.</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt439728/">https://habr.com/ru/post/pt439728/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt439718/index.html">Desenvolvimento de aplicativos no Elixir / Phoenix com Docker</a></li>
<li><a href="../pt439720/index.html">Introdu√ß√£o √† programa√ß√£o: um simples atirador 3D desde o in√≠cio no fim de semana, parte 2</a></li>
<li><a href="../pt439722/index.html">Efeitos dos filtros SVG. Parte 2. Texto de estrutura de t√≥picos com feMorphology</a></li>
<li><a href="../pt439724/index.html">Vis√£o geral das solu√ß√µes de IA e ML em 2018 e previs√µes para 2019: Parte 2 - Ferramentas e bibliotecas, AutoML, RL, √©tica em AI</a></li>
<li><a href="../pt439726/index.html">Lock-in: verdadeiro ou fic√ß√£o?</a></li>
<li><a href="../pt439730/index.html">Organiza√ß√£o do redutor atrav√©s de uma classe padr√£o</a></li>
<li><a href="../pt439732/index.html">Lazarus - anima√ß√£o simples usando o componente TImageFragment</a></li>
<li><a href="../pt439734/index.html">Implantando o Kubernetes na √°rea de trabalho em minutos com o MicroK8s</a></li>
<li><a href="../pt439736/index.html">Conex√£o VPN IPSec entre MikroTik e Kerio Control</a></li>
<li><a href="../pt439738/index.html">Em busca do bot√£o "Fa√ßa bem". Zyxel na rede de pequenas e m√©dias empresas</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>