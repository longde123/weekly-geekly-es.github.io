<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤞🏾 🧒🏼 👦🏼 Monad "Reader" عبر المزامنة / في انتظار C # 💅 😆 ☸️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="في مقالتي السابقة ، وصفت كيفية تنفيذ نمط ربما مناد باستخدام عبارات غير متزامنة / تنتظر . هذه المرة سوف أخبرك بكيفية تطبيق قالب تصميم شائع آخر ، "Monad...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Monad "Reader" عبر المزامنة / في انتظار C #</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/470501/" style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/jb/8f/kq/jb8fkqbv4lkkzgyy4j-66ykf9nu.jpeg"></p><br><p style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">في مقالتي السابقة ،</a> وصفت كيفية تنفيذ نمط ربما مناد باستخدام عبارات غير <strong>متزامنة / تنتظر</strong> .  هذه المرة سوف أخبرك بكيفية تطبيق قالب تصميم شائع آخر ، "Monad Reader" ، باستخدام نفس التقنيات. </p><br><p style=";text-align:right;direction:rtl">  يسمح لك هذا القالب بنقل سياق معين ضمنيًا إلى التسلسل الهرمي لاستدعاءات الوظائف دون استخدام معلمات أو حقول فئة ، ويمكن اعتباره طريقة أخرى لتطبيق Dependency Injection.  على سبيل المثال: </p><a name="habracut"></a><br><pre style=";text-align:right;direction:rtl"><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Config</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Template; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Console.WriteLine(<span class="hljs-keyword"><span class="hljs-keyword">await</span></span> GreetGuys().Apply(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Config {Template = <span class="hljs-string"><span class="hljs-string">"Hi, {0}!"</span></span>})); <span class="hljs-comment"><span class="hljs-comment">//(Hi, John!, Hi, José!) Console.WriteLine(await GreetGuys().Apply(new Config {Template = "¡Hola, {0}!" })); //(¡Hola, John!, ¡Hola, José!) } //       -   “Config". public static async Reader&lt;(string gJohn, string gJose)&gt; GreetGuys() =&gt; (await Greet("John"), await Greet("José")); static async Reader&lt;string&gt; Greet(string name) =&gt; string.Format(await ExtractTemplate(), name); static async Reader&lt;string&gt; ExtractTemplate() =&gt; await Reader&lt;string&gt;.Read&lt;Config&gt;(c =&gt; c.Template);</span></span></code> </pre> <br><h2 id="klassicheskiy-reader" style=";text-align:right;direction:rtl">  "القارئ" الكلاسيكي </h2><br><p style=";text-align:right;direction:rtl">  أولاً ، دعنا نرى كيف يمكنك تطبيق هذا النمط دون عبارات <strong>التزامن / الانتظار</strong> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Config</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Template; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ClassicReader</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> greeter = GreetGuys(); Console.WriteLine(greeter.Apply(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Config{Template = <span class="hljs-string"><span class="hljs-string">"Hello, {0}"</span></span>})); <span class="hljs-comment"><span class="hljs-comment">//(Hello, John, Hello, Jose) Console.WriteLine(greeter.Apply(new Config{Template = "¡Hola, {0}!" })); //(¡Hola, John!, ¡Hola, Jose!) } public static Reader&lt;(string gJohn, string gJose), Config&gt; GreetGuys() =&gt; from toJohn in Greet("John") from toJose in Greet("Jose") select (toJohn, toJose); //  "query syntax"      : //Greet("John") // .SelectMany( // toJohn =&gt; Greet("Jose"), // (toJohn, toJose) =&gt; (toJohn, toJose)) public static Reader&lt;string, Config&gt; Greet(string name) =&gt; new Reader&lt;string, Config&gt;(cfg =&gt; string.Format(cfg.Template, name)); }</span></span></code> </pre> <br><p style=";text-align:right;direction:rtl">  <em>(القارئ)</em> </p><br><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Reader</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>, <span class="hljs-title"><span class="hljs-title">TCtx</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Func&lt;TCtx, T&gt; _exec; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Reader</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Func&lt;TCtx, T&gt; exec</span></span></span><span class="hljs-function">)</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._exec = exec; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Apply</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">TCtx ctx</span></span></span><span class="hljs-function">)</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._exec(ctx); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Reader</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Reader&lt;TJoin, TCtx&gt; SelectMany&lt;TIn, TOut, TCtx, TJoin&gt;( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> Reader&lt;TIn, TCtx&gt; source, Func&lt;TIn, Reader&lt;TOut, TCtx&gt;&gt; bind, Func&lt;TIn, TOut, TJoin&gt; <span class="hljs-keyword"><span class="hljs-keyword">join</span></span>) =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Reader&lt;TJoin, TCtx&gt;(ctx =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> inValue = source.Apply(ctx); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> outValue = bind(inValue).Apply(ctx); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span>(inValue, outValue); }); }</code> </pre> <br><p style=";text-align:right;direction:rtl">  تعمل هذه التعليمة البرمجية ، لكن بدون استخدام بناء جملة الاستعلام (والذي لا يناسب دائمًا حد ذاته) ، تنخفض قابلية قراءته بشكل كبير وهذا ليس مفاجئًا لأن الأحاديات جاءت من لغات وظيفية حيث تبدو هذه الشفرة طبيعية وتقرأ جيدًا (على الرغم من أنه حتى في Haskelel ظهرت "do") تدوين لتحسين قابلية القراءة).  ومع ذلك ، فإن التطبيق الكلاسيكي يساعد على فهم جوهر النموذج - بدلاً من تنفيذ بعض التعليمات البرمجية على الفور ، يتم وضعه في وظيفة لن يتم استدعاؤها إلا عندما يحصل على سياقها. </p><br><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Reader&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function">, Config&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Greet</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> name</span></span></span><span class="hljs-function">)</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Reader&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, Config&gt;(cfg =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Format(cfg.Template, name)); <span class="hljs-comment"><span class="hljs-comment">//      ,     : //public static string Greet(string name, Config cfg) // =&gt; string.Format(cfg.Template, name);</span></span></code> </pre> <br><p style=";text-align:right;direction:rtl">  يمكن لـ <strong>SelectMany</strong> تجميع العديد من هذه الوظائف في واحدة ، حتى تتمكن من إنشاء روتين كامل سيتم تأجيله حتى يتم تطبيق السياق الخاص به.  من ناحية أخرى ، يشبه هذا الأسلوب كتابة التعليمات البرمجية غير المتزامنة ، حيث يتم إيقاف تنفيذ البرنامج إذا كانت نتيجة بعض العمليات غير المتزامنة مطلوبة.  عندما تكون نتيجة العملية جاهزة ، سيستمر البرنامج.  هناك افتراض أن البنية الأساسية C # ، المصممة للعمل مع العمليات غير <em><strong>المتزامنة</strong></em> (غير <em><strong>المتزامن / تنتظر</strong></em> ) ، يمكن استخدامها بطريقة أو بأخرى عند تنفيذ monad "Reader" و ... هذا الافتراض صحيح!  إذا كانت الوظائف تتطلب الوصول إلى السياق ، فيمكن عندئذٍ تعليقه مؤقتًا حتى يتم تحديد هذا السياق خارجيًا. </p><br><h2 id="asinhronnyy-reader" style=";text-align:right;direction:rtl">  قارئ غير متزامن </h2><br><p style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">في مقالتي السابقة ،</a> أوضحت كيفية التحكم في عبارات <strong>المزامنة / الانتظار</strong> باستخدام <strong>أنواع الإرجاع غير المتزامنة العامة</strong> .  وسيتم استخدام نفس النهج هذه المرة.  لنبدأ بفئة <strong>Reader</strong> ، والتي سيتم استخدامها كنوع من نتائج العمليات غير المتزامنة: </p><br><pre style=";text-align:right;direction:rtl"> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">AsyncMethodBuilder(typeof(ReaderTaskMethodBuilder&lt;&gt;))</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Reader</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; : <span class="hljs-title"><span class="hljs-title">INotifyCompletion</span></span>, <span class="hljs-title"><span class="hljs-title">IReader</span></span> { ...</code> </pre> <br><p style=";text-align:right;direction:rtl">  هذه الفئة لها مهمتان (نظريا ، يمكننا إنشاء فئتين مختلفتين): </p><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  استرداد القيم من السياق. </li><li style=";text-align:right;direction:rtl">  قم بإنشاء قائمة مرتبط <strong>بمثيلات</strong> فئة <strong>Reader</strong> التي سيتم استخدامها لتوزيع السياق عبر التسلسل الهرمي للمكالمات. </li></ol><br><p style=";text-align:right;direction:rtl">  لكل مهمة من هذه المهام ، سنقوم بإنشاء مُنشئ منفصل: </p><br><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Func&lt;<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>, T&gt; _extractor; <span class="hljs-comment"><span class="hljs-comment">//1.       public static Reader&lt;T&gt; Read&lt;TCtx&gt;(Func&lt;TCtx, T&gt; extractor) =&gt; new Reader&lt;T&gt;(ctx =&gt; extractor((TCtx)ctx)); private Reader(Func&lt;object, T&gt; exec) =&gt; this._extractor = exec; //2.   ReaderTaskMethodBuilder     C# internal Reader() { }</span></span></code> </pre> <br><p style=";text-align:right;direction:rtl">  عند استخدام مثيل لفئة <strong>Reader</strong> كوسيطة لمشغل <strong>انتظار</strong> ، يحصل هذا المثيل على إشارة إلى المفوض الذي سيواصل البرنامج.  يجب استدعاء هذا المفوض بعد تلقي السياق من استخراج البيانات اللازمة للمتابعة. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/8q/k2/u3/8qk2u3lwleoo6hfd55fzclhz1sa.png"></p><br><p style=";text-align:right;direction:rtl">  لربط مثيلات فئة <strong>Reader</strong> ، دعنا <strong>ننشئ</strong> طريقة <strong>SetChild</strong> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> IReader _child; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetChild</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IReader reader</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._child = reader; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._ctx != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._child.SetCtx(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._ctx); } }</code> </pre> <br><p style=";text-align:right;direction:rtl">  والتي سوف تسمى داخل <strong>ReaderTaskMethodBuilder</strong> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ReaderTaskMethodBuilder</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; { ... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> GenericAwaitOnCompleted&lt;TAwaiter, TStateMachine&gt;( <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> TAwaiter awaiter, <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> TStateMachine stateMachine) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> TAwaiter : INotifyCompletion <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> TStateMachine : IAsyncStateMachine { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (awaiter <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> IReader reader) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Task.SetChild(reader); } awaiter.OnCompleted(stateMachine.MoveNext); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Reader&lt;T&gt; Task { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } }</code> </pre> <br><p style=";text-align:right;direction:rtl">  داخل طريقة <strong>SetChild ،</strong> ندعو وظيفة <strong>SetCtx</strong> لنشر السياق عبر التسلسل الهرمي للمكالمات.  إذا ، عند استدعاء <strong>SetCtx</strong> على هذا المستوى من التسلسل الهرمي ، تم تحديد وظيفة _ <strong>extractor</strong> (المُنشئ الأول لفئة <strong>Reader</strong> ) التي تقوم باستخراج البيانات مباشرة من السياق ، يمكنك الآن الاتصال بها ، والحصول على البيانات اللازمة وإكمال العملية الحالية غير المتزامنة من خلال مكالمة إلى <strong>SetResult</strong> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetCtx</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ctx</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._ctx = ctx; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._ctx != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._child?.SetCtx(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._ctx); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._extractor != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SetResult(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._extractor(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._ctx)); } } }</code> </pre> <br><p style=";text-align:right;direction:rtl">  <strong>تقوم SetResult</strong> بتخزين القيمة التي يتم استردادها من السياق وتدعو المفوض لمتابعة البرنامج: </p><br><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetResult</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T result</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._result = result; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.IsCompleted = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._continuation?.Invoke(); }</code> </pre> <br><p style=";text-align:right;direction:rtl">  في حالة عدم وجود مثيل لفئة <strong>Reader ،</strong> بدأت الدالة _ <strong>extractor</strong> (المُنشئ الثاني لفئة <strong>Reader</strong> ) ، ثم يجب استدعاء <strong>SetResult</strong> بواسطة <strong>ReaderTaskMethodBuilder</strong> عندما <strong>ينتقل</strong> جهاز الحالة <strong>المُنشأ</strong> إلى الحالة النهائية. </p><br><p style=";text-align:right;direction:rtl">  يُسمى <strong>SetCtx</strong> أيضًا في الأسلوب <strong>Apply</strong> لتعيين السياق في عقدة الجذر للتسلسل الهرمي: </p><br><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Reader&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Apply</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ctx</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SetCtx(ctx); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; }</code> </pre> <br><p style=";text-align:right;direction:rtl">  <a href="">رمز جيثب الكامل</a> </p><br><p style=";text-align:right;direction:rtl">  الآن ، يمكنك إلقاء نظرة على مثال أكثر واقعية لاستخدام <strong>قارئ</strong> غير متزامن - أ: </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">انقر لتوسيع المثال.</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ReaderTest</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Configuration</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> DataBaseId; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GreetingTemplate; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> NameFormat; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Configuration</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dataBaseId, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> greetingTemplate, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> nameFormat</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.DataBaseId = dataBaseId; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.GreetingTemplate = greetingTemplate; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.NameFormat = nameFormat; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[] ids = { <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span> }; Configuration[] configurations = { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Configuration(<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-string"><span class="hljs-string">"Congratulations, {0}! You won {1}$!"</span></span>, <span class="hljs-string"><span class="hljs-string">"{0} {1}"</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Configuration(<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-string"><span class="hljs-string">"¡Felicidades, {0}! Ganaste {1} $"</span></span>, <span class="hljs-string"><span class="hljs-string">"{0}"</span></span>), }; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> configuration <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> configurations) { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> userId <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ids) { <span class="hljs-comment"><span class="hljs-comment">//""      - userId var logic = GetGreeting(userId); //  (database Id, templates)     var greeting = await logic.Apply(configuration); Console.WriteLine(greeting) } } //Congratulations, John Smith! You won 110$! //Congratulations, Mary Louie! You won 30$! //Congratulations, Louis Slaughter! You won 47$! //¡Felicidades, John! Ganaste 110 $ //¡Felicidades, Mary! Ganaste 30 $ //¡Felicidades, Louis! Ganaste 47 $ } private static async Reader&lt;string&gt; GetGreeting(int userId) { var template = await Reader&lt;string&gt;.Read&lt;Configuration&gt;(cfg =&gt; cfg.GreetingTemplate); var fullName = await GetFullName(userId); var win = await GetWin(userId); return string.Format(template, fullName, win); } private static async Reader&lt;string&gt; GetFullName(int userId) { var template = await Reader&lt;string&gt;.Read&lt;Configuration&gt;(cfg =&gt; cfg.NameFormat); var firstName = await GetFirstName(userId); var lastName = await GetLastName(userId); return string.Format(template, firstName, lastName); } private static async Reader&lt;string&gt; GetFirstName(int userId) { var dataBase = await GetDataBase(); return await dataBase.GetFirstName(userId); } private static async Reader&lt;string&gt; GetLastName(int userId) { var dataBase = await GetDataBase(); return await dataBase.GetLastName(userId); } private static async Reader&lt;int&gt; GetWin(int userId) { var dataBase = await GetDataBase(); return await dataBase.GetWin(userId); } private static async Reader&lt;Database&gt; GetDataBase() { var dataBaseId = await Reader&lt;int&gt;.Read&lt;Configuration&gt;(cfg =&gt; cfg.DataBaseId); return Database.ConnectTo(dataBaseId); } } public class Database { public static Database ConnectTo(int id) { if (id == 100) { return new Database(); } throw new Exception("Wrong database"); } private Database() { } private static readonly (int Id, string FirstName, string LastName, int Win)[] Data = { (1, "John","Smith", 110), (2, "Mary","Louie", 30), (3, "Louis","Slaughter", 47), }; public async Task&lt;string&gt; GetFirstName(int id) { await Task.Delay(50); return Data.Single(i =&gt; i.Id == id).FirstName; } public async Task&lt;string&gt; GetLastName(int id) { await Task.Delay(50); return Data.Single(i =&gt; i.Id == id).LastName; } public async Task&lt;int&gt; GetWin(int id) { await Task.Delay(50); return Data.Single(i =&gt; i.Id == id).Win; } }</span></span></code> </pre> </div></div><br><p style=";text-align:right;direction:rtl">  يعرض البرنامج تحيات بعض المستخدمين ، لكننا لا نعرف أسماءهم مقدمًا لأن لدينا معرفاتهم فقط ، لذلك نحتاج إلى قراءة أسمائهم من "قاعدة البيانات".  للاتصال بـ "قاعدة البيانات" هذه ، تحتاج إلى معرفة معلمات الاتصال ، ولإنشاء تحيات ، نحتاج أيضًا إلى قوالب لهذه التحيات.  يتم تمرير كل هذه المعلومات ضمنيًا من خلال <strong>قارئ</strong> غير متزامن. </p><br><h2 id="vnedrenie-zavisimostey-chrez-asinhronnyy-reader" style=";text-align:right;direction:rtl">  حقن التبعية عبر "قارئ" غير متزامن </h2><br><p style=";text-align:right;direction:rtl">  مقارنةً بالتطبيق الكلاسيكي ، يكون <strong>للقارئ</strong> غير المتزامن عيب واحد - لا يمكننا تحديد نوع السياق المطلوب إرساله.  يأتي هذا القيد من حقيقة أن برنامج التحويل البرمجي C # يسمح بنوع واحد فقط من البيانات ذات المعلمات (النوع العام) في فئة <strong>ReaderTaskMethodBuilder</strong> (قد يتم إصلاح هذا في الإصدارات المستقبلية). </p><br><p style=";text-align:right;direction:rtl">  من ناحية أخرى ، لا أعتقد أن هذا أمر بالغ الأهمية ، لأنه في الحياة الواقعية على الأرجح سيتم تمرير حاوية حقن التبعية كسياق: </p><br><pre style=";text-align:right;direction:rtl"> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Reader</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Reader&lt;TService&gt; GetService&lt;TService&gt;() =&gt; Reader&lt;TService&gt;.Read&lt;IServiceProvider&gt;(serviceProvider =&gt; (TService)serviceProvider .GetService(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(TService))); }</code> </pre> <br><pre style=";text-align:right;direction:rtl"> <code class="cs hljs">... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Reader&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Greet</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> userName</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> service = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> Reader.GetService&lt;IGreater&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> service.GreetUser(userName); } ...</code> </pre> <br><p style=";text-align:right;direction:rtl">  <a href="">( <em>هنا يمكنك العثور على النسخة الكاملة ...</em> )</a> </p><br><p style=";text-align:right;direction:rtl">  على عكس <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">"ربما" غير المتزامن</a> ، والذي لم أوصي باستخدامه في أي كود صناعي ، سأفكر في استخدام <strong>القارئ</strong> غير المتزامن - في بعض مشاريع الحياة الحقيقية كبديل (أو إضافة) لآليات حقن التبعية التقليدية (عندما يتم تمرير جميع التبعيات كمعلمات مُنشئ) منذ <strong>Reader</strong> -a لديه عدد من المزايا: </p><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ليست هناك حاجة للحقول التي تخزن فئاتها الموارد المضمنة.  في الواقع ، لن تكون هناك حاجة لفئات حقيقية على الإطلاق ، حيث يمكن تنفيذ كل المنطق بطرق ثابتة. </li><li style=";text-align:right;direction:rtl">  سيؤدي استخدام <strong>Reader</strong> -a إلى كتابة تعليمات برمجية غير محظورة لأن جميع الطرق ستكون غير متزامنة ولن يتداخل أي شيء مع استخدام الإصدارات غير المتزامنة لوظائف المكتبة. </li><li style=";text-align:right;direction:rtl">  ستكون الشفرة أكثر قابلية للقراءة قليلاً ، لأنه في كل مرة نرى فيها <strong>القارئ</strong> هو نوع الإرجاع لبعض الطرق ، سنعرف أنه يتطلب الوصول إلى بعض السياق الضمني </li><li style=";text-align:right;direction:rtl">  <strong>القارئ</strong> غير المتزامن لا يستخدم الانعكاس. </li></ol><br><p style=";text-align:right;direction:rtl">  بالطبع ، قد تكون هناك اعتراضات على استخدام هذا <strong>Reader</strong> -a ، ولكن على أي حال ، فإن المهمة الرئيسية لهذه المقالات هي إظهار كيف يمكن تكييف القوالب التي تم إنشاؤها أصلاً للغات الوظيفية للحصول على أسلوب برمجة ضروري ، والذي يعتبره معظم الناس أسهل في الفهم . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar470501/">https://habr.com/ru/post/ar470501/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar470483/index.html">مختبر تكنولوجيا أزور في موسكو</a></li>
<li><a href="../ar470487/index.html">المسابقات التكنولوجية Radiofest-2019</a></li>
<li><a href="../ar470489/index.html">أسبوع الأمان 41: المزيد من نقاط الضعف في بطاقات SIM ، فك تشفير PDF</a></li>
<li><a href="../ar470497/index.html">كيفية استخدام systemd-nspawn لاستعادة نظام Linux</a></li>
<li><a href="../ar470499/index.html">كيفية استخدام الانقطاعات في Unity Animator على أكمل وجه</a></li>
<li><a href="../ar470503/index.html">Kubernetes RBAC المستخدمين والترخيص</a></li>
<li><a href="../ar470513/index.html">كيف وجدت منزلاً ذكيًا يهيمن عليه الروبوتات</a></li>
<li><a href="../ar470515/index.html">خطوة صغيرة للاختبار: أفضل 10 تقارير من Heisenbug 2019 Piter</a></li>
<li><a href="../ar470517/index.html">EP الروسية لأصغر</a></li>
<li><a href="../ar470519/index.html">تجربة بناء مجموعات Linux للحصول على تحديثات اللوحة الفردية مع الدعم</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>