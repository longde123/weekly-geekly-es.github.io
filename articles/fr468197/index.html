<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üõÅ üîß üîÜ Comment nous automatisons un grand r√©seau existant üëó ü§üüèæ ü§Ø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Salut Nous avons plus de 15 260 objets et 38 000 p√©riph√©riques r√©seau qui doivent √™tre configur√©s, mis √† jour et v√©rifi√©s pour √™tre op√©rationnels. Le ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment nous automatisons un grand r√©seau existant</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/X5RetailGroup/blog/468197/">  Salut  Nous avons plus de 15 260 objets et 38 000 p√©riph√©riques r√©seau qui doivent √™tre configur√©s, mis √† jour et v√©rifi√©s pour √™tre op√©rationnels.  Le maintien d'une telle flotte d'√©quipements est assez difficile et n√©cessite beaucoup de temps, d'efforts et de personnes.  Par cons√©quent, nous devions automatiser le travail avec les √©quipements r√©seau et nous avons d√©cid√© d'adapter le concept de r√©seau en tant que code pour g√©rer le r√©seau dans notre entreprise.  Sous la coupe, lisez notre historique d'automatisation, les erreurs commises et un autre plan pour les syst√®mes de construction. <br><br><img src="https://habrastorage.org/webt/tq/6w/po/tq6wposkryjnbyoqfcpv6qgj-q8.png"><br><a name="habracut"></a><br><h2>  Pour faire court, nous voulons automatiser le r√©seau </h2><br>  Salut  Je m'appelle Alexander Prokhorov et, avec l'√©quipe d'ing√©nieurs r√©seau de notre d√©partement, nous <b>travaillons</b> sur un r√©seau en <b>#IT</b> <b><font color="#FFA500">X5</font></b> .  Notre d√©partement d√©veloppe l'infrastructure r√©seau, la surveillance, l'automatisation du r√©seau et la direction tendance de Network as a Code. <br><br>  Au d√©part, je ne croyais pas vraiment √† une quelconque automatisation de notre r√©seau en principe.  Il y avait beaucoup d'erreurs h√©rit√©es et de configuration - pas partout o√π il y avait une autorisation centrale, pas tout le mat√©riel SSH pris en charge, pas partout <abbr title="Protocole de gestion de r√©seau simple">SNMP</abbr> √©tait configur√©.  Tout cela a grandement √©branl√© la croyance en l'automatisation.  Par cons√©quent, tout d'abord, nous mettons en ordre ce qui est n√©cessaire pour d√©marrer l'automatisation, √† savoir: la normalisation de la connexion SSH, l'autorisation unique ( <abbr title="Authentification, autorisation, comptabilit√©">AAA</abbr> ) et les profils SNMP.  Toute cette fondation vous permet d'√©crire un outil pour la livraison en masse de configurations sur un appareil, mais la question se pose: puis-je en obtenir plus?  Nous en sommes donc arriv√©s √† la n√©cessit√© d'√©laborer un plan de d√©veloppement de l'automatisation et du concept de R√©seau en tant que Code en particulier. <br><br>  Le concept de r√©seau en tant que code, selon Cisco, signifie les principes suivants: <br><br><ul><li>  Stocker les configurations cibles dans le r√©f√©rentiel, contr√¥le de source </li><li>  Les modifications de configuration passent par le r√©f√©rentiel, Single Source of Truth </li><li>  Incorporation de configurations via l' <abbr title="Interface de programmation d'application">API</abbr> </li></ul><br><img src="https://habrastorage.org/webt/bw/wi/6u/bwwi6us89ipickqukqdgd1zkvk0.jpeg" align="right" width="240"><br><br>  Les deux premiers points vous permettent d'appliquer l'approche DevOps ou NetDevOps √† la gestion de votre infrastructure r√©seau.  Avec le troisi√®me paragraphe, il y a des difficult√©s, par exemple, que faire s'il n'y a pas d'API?  Bien s√ªr, SSH et CLI, nous sommes des networkers! <br><br><div class="spoiler">  <b class="spoiler_title">Et est-ce tout ce dont nous avons besoin?</b> <div class="spoiler_text">  L'application de ces principes ne r√©sout pas √† elle seule tous les probl√®mes de l'infrastructure r√©seau, tout comme leur application n√©cessite une certaine base de donn√©es r√©seau. <br><br>  Questions qui se sont pos√©es lorsque nous y avons r√©fl√©chi: <br><br><ul><li>  OK, je stocke la configuration sous forme de code, comment dois-je l'appliquer sur un objet sp√©cifique? </li><li>  Ok, j'ai un mod√®le de configuration dans le r√©f√©rentiel, mais comment puis-je configurer automatiquement une configuration pour un objet bas√© dessus? </li><li>  Comment savoir quel mod√®le et quel fournisseur doit √™tre sur cet objet?  Puis-je le faire automatiquement? </li><li>  Comment puis-je v√©rifier si les param√®tres actuels de l'objet correspondent aux param√®tres du r√©f√©rentiel? </li><li>  Comment travailler avec les modifications du r√©f√©rentiel et les r√©pliquer sur un r√©seau productif? </li><li>  De quel ensemble de donn√©es et de quels syst√®mes ai-je besoin pour penser au Zero Touch Provisioning? </li><li>  Qu'en est-il des diff√©rences entre les fournisseurs, et m√™me les mod√®les du m√™me fournisseur? </li><li>  Comment stocker des sous-r√©seaux pour une configuration automatique? </li></ul><br>  Sur la base de toutes les questions ci-dessus, il est devenu clair que nous avons besoin d'un ensemble de syst√®mes qui r√©solvent divers probl√®mes, travaillent ensemble et nous donnent des informations compl√®tes sur l'infrastructure du r√©seau. <br><br><img src="https://habrastorage.org/webt/iz/us/cx/izuscxapcn5-6ync8yexgqlxs0u.jpeg"><br></div></div><br>  En plus d'essayer d'appliquer de nouvelles approches √† la gestion de r√©seau, nous voulions r√©soudre certains probl√®mes plus aigus dans l'infrastructure de r√©seau, tels que l'int√©grit√© des donn√©es, la mise √† jour et, bien s√ªr, l'automatisation.  Par automatisation, nous entendons non seulement la livraison en masse de configurations aux √©quipements, mais √©galement la configuration automatique, la collecte automatique des donn√©es d'inventaire des √©quipements de r√©seau, l'int√©gration avec les syst√®mes de surveillance.  Mais tout d'abord. <br><br>  La fonctionnalit√© que nous visions est: <br><br><ul><li>  Base de donn√©es d'√©quipements r√©seau (+ d√©couverte, + mise √† jour automatique) </li><li>  Adresses r√©seau de base (IPAM + contr√¥les de validation) </li><li>  Int√©gration de syst√®mes de surveillance avec des donn√©es d'inventaire </li><li>  Stockage des normes de configuration dans le syst√®me de contr√¥le de version </li><li>  Formation automatique de configurations cibles pour un objet </li><li>  Livraison en vrac des configurations √† l'√©quipement r√©seau </li><li>  Mettre en ≈ìuvre un processus CI / CD pour g√©rer les modifications de configuration r√©seau </li><li>  Test des configurations r√©seau avec CI / CD </li><li>  ZTP (Zero Touch Provisioning) - configuration automatique de l'√©quipement pour un objet </li></ul><br><div class="spoiler">  <b class="spoiler_title">Longue histoire, nous avons essay√© l'automatisation</b> <div class="spoiler_text">  Nous avons commenc√© √† essayer d'automatiser le travail de configuration du r√©seau il y a 2 ans.  Pourquoi cette question a-t-elle refait surface et m√©rite-t-elle l'attention? <br><br>  C'est fastidieux et ennuyeux de configurer plus de quelques dizaines d'appareils avec vos mains.  Parfois, la main de l'ing√©nieur tressaute et il fait des erreurs.  Pour plusieurs dizaines, un script √©crit par un ing√©nieur suffit g√©n√©ralement, ce qui transf√®re les param√®tres mis √† jour √† l'√©quipement r√©seau. <br><br>  Pourquoi ne pas en rester l√†?  En fait, de nombreux ing√©nieurs r√©seau savent d√©j√† comment faire toutes sortes de pythons, et ceux qui ne savent pas comment le feront d√©j√† tr√®s bient√¥t (Natalya Samoilenko, cependant, a publi√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">un excellent travail sur Python</a> , en particulier pour les networkers).  Quiconque est charg√© de configurer n + 1 routeurs est capable d'√©crire un script et de d√©ployer les param√®tres tr√®s rapidement.  Beaucoup plus rapide qu'alors capable de tout ramener.  Selon l'exp√©rience de l'automatisation ¬´chacun pour soi¬ª, des erreurs se produisent lorsque vous ne pouvez r√©tablir la communication qu'avec vos mains, et seulement avec de grandes souffrances pour toute l'√©quipe. <br><br><img src="https://habrastorage.org/webt/rp/ts/ie/rptsiexeli86bdhhumak_d1z7eo.jpeg"><br><br><h5>  Exemple </h5><br><img src="https://habrastorage.org/webt/ow/q8/tk/owq8tkmg8p5xeorxn0ypbwqudw0.png" align="right" width="240">  Une fois, l'un des ing√©nieurs a d√©cid√© d'effectuer une t√¢che importante - r√©tablir l'ordre dans les configurations des routeurs.  √Ä la suite de l'audit de plusieurs objets, une <i><font color="#008080">liste de pr√©fixes</font></i> obsol√®tes avec des sous-r√©seaux sp√©cifiques a √©t√© trouv√©e, dont nous n'avions plus besoin.  Auparavant, il √©tait utilis√© pour filtrer les adresses de <i><font color="#008080">bouclage</font></i> des sites centraux afin qu'ils ne transitent que par un seul canal, et nous pouvions tester la connexion sur ce canal.  Mais le m√©canisme a √©t√© optimis√©, et ils ont cess√© d'utiliser un tel sch√©ma de test de canal.  L'employ√© a d√©cid√© de supprimer cette <i><font color="#008080">liste de pr√©fixes</font></i> afin qu'elle ne se profile pas dans la configuration et ne cr√©e pas de confusion √† l'avenir.  Tout le monde a accept√© de supprimer la <i><font color="#008080">liste de pr√©fixes</font></i> inutilis√©e, la t√¢che est simple, ils ont imm√©diatement oubli√©.  Mais supprimer la m√™me <i><font color="#008080">liste de pr√©fixes</font></i> avec vos mains sur des dizaines d'objets est assez ennuyeux et prend du temps.  Et l'ing√©nieur a √©crit un script qui va rapidement parcourir l'√©quipement, faire <i><font color="#008080">¬´pas de liste de pr√©fixes pl-cisco-primer¬ª</font></i> et enregistrer solennellement la configuration. <br><br>  Quelque temps apr√®s la discussion, quelques heures ou une journ√©e, je ne me souviens pas, un objet est tomb√©.  Apr√®s quelques minutes, une autre, similaire.  Le nombre d'objets inaccessibles a continu√© de cro√Ætre, en une demi-heure √† 10, et toutes les 2-3 minutes, un nouveau a √©t√© ajout√©.  Tous les ing√©nieurs ont √©t√© connect√©s pour le diagnostic.  40-50 minutes apr√®s le d√©but de l'accident, tout le monde a √©t√© interrog√© sur les changements et l'employ√© a arr√™t√© le script.  A cette √©poque, il y avait d√©j√† une vingtaine d'objets avec des canaux cass√©s.  Une restauration compl√®te a pris 7 ing√©nieurs pendant plusieurs heures. <br><br><h5>  C√¥t√© technique </h5><br>  <i><font color="#008080">La liste des pr√©fixes a √©t√©</font></i> utilis√©e pour filtrer les <i><font color="#008080">bouclages</font></i> - l'un a √©t√© filtr√© sur un canal, le second sur la sauvegarde.  Cela a √©t√© utilis√© pour tester la communication sans commuter le trafic productif entre les canaux.  Par cons√©quent, la premi√®re r√®gle d'une <i><font color="#008080">route-map</font></i> entrante sur un voisin <i><font color="#008080">BGP</font></i> √©tait <i><font color="#008080">DENY</font></i> avec <i><font color="#008080">"match ip address prefix list"</font></i> .  Les autres r√®gles de la <i><font color="#008080">carte d'itin√©raire</font></i> √©taient toutes <i><font color="#008080">PERMISES</font></i> . <br><br>  Il convient de noter plusieurs nuances: <br><br><ul><li>  La r√®gle de <i><font color="#008080">route-map</font></i> dans laquelle il n'y a pas de <i><font color="#008080">correspondance</font></i> - saute tout </li><li>  √Ä la fin de la <i><font color="#008080">liste</font></i> des <i><font color="#008080">pr√©fixes</font></i> , il y a un <i><font color="#008080">refus implicite</font></i> , mais seulement s'il n'est pas vide </li><li>  Une <i><font color="#008080">liste de pr√©fixes</font></i> vide est un <i><font color="#008080">permis implicite</font></i> </li></ul><br>  Tout ce qui pr√©c√®de est vrai pour <b>Cisco IOS</b> .  Une <i><font color="#008080">liste de pr√©fixes</font></i> vide peut appara√Ætre lorsque vous d√©clarez une <i><font color="#008080">carte d'itin√©raire</font></i> , faites-la <i><font color="#008080">"correspondre √† la liste de pr√©fixes d'adresse IP pl-test-cisco"</font></i> .  Cette <i><font color="#008080">liste de pr√©fixes</font></i> ne sera pas explicitement d√©clar√©e dans la configuration (en plus de la ligne avec <i><font color="#008080">match</font></i> ), mais elle peut √™tre trouv√©e dans <i><font color="#008080">show ip prefix-list</font></i> . <br><br><pre><code class="plaintext hljs">2901-NOC-4.2(config)#route-map rm-test-in 2901-NOC-4.2(config-route-map)#match ip address prefix-list pl-test-in 2901-NOC-4.2(config-route-map)#do sh run | i prefix match ip address prefix-list pl-test-in 2901-NOC-4.2(config-route-map)#do sh ip prefix ip prefix-list pl-test-in: 0 entries 2901-NOC-4.2(config-route-map)#</code> </pre> <br>  Pour revenir √† ce qui s'est pass√©, lorsque la <i><font color="#008080">liste</font></i> des <i><font color="#008080">pr√©fixes a</font></i> √©t√© supprim√©e par le script, elle est devenue vide, car elle se trouvait toujours dans la premi√®re r√®gle <i><font color="#008080">DENY</font></i> de la <i><font color="#008080">route-map</font></i> .  Une <i><font color="#008080">liste de pr√©fixes</font></i> vide autorise tous les sous-r√©seaux, donc tout ce qu'un pair <i><font color="#008080">BGP</font></i> nous a transmis est tomb√© dans la premi√®re r√®gle <i><font color="#008080">DENY</font></i> . <br>  Pourquoi l'ing√©nieur n'a-t-il pas imm√©diatement remarqu√© qu'il avait rompu la connexion?  Ici a jou√© le r√¥le de temporisateurs <i><font color="#008080">BGP</font></i> dans Cisco. <br>  <i><font color="#008080">BGP</font></i> lui-m√™me n'√©change pas de routes sur une planification, et si vous avez mis √† jour la strat√©gie de routage <i><font color="#008080">BGP</font></i> , vous devez r√©initialiser la session BGP pour appliquer les modifications, <i><font color="#008080">"clear ip bgp &lt;peer-ip&gt;"</font></i> √† Cisco. <br><br>  Afin de ne pas r√©initialiser la session, il existe deux m√©canismes: <br><br><ul><li>  Cisco <b>Soft-Reconfiguration</b> </li><li>  <b>Actualiser l'itin√©raire en</b> tant que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">RFC2918</a> </li></ul><br>  <b>La reconfiguration en douceur</b> contient les informations re√ßues dans <i><font color="#008080">UPDATE</font></i> du voisin sur les routes jusqu'√† ce que les politiques soient appliqu√©es dans la table locale <i><font color="#008080">adj-RIB-in</font></i> .  Lors de la mise √† jour des politiques, il devient possible d'√©muler <i><font color="#008080">UPDATE √†</font></i> partir d'un voisin. <br>  <b>L'actualisation de l'itin√©raire</b> est la ¬´capacit√©¬ª des pairs √† envoyer <i><font color="#008080">UPDATE</font></i> sur demande.  La disponibilit√© de cette opportunit√© est convenue lors de la cr√©ation d'un quartier.  Avantages - Pas besoin de stocker une copie de <i><font color="#008080">UPDATE</font></i> localement.  Inconv√©nients - en pratique, apr√®s une demande <i><font color="#008080">UPDATE</font></i> d'un voisin, vous devez attendre qu'il l'envoie.  Par ailleurs, vous pouvez d√©sactiver la fonctionnalit√© sur Cisco avec une commande cach√©e: <br><br><pre> <code class="plaintext hljs">neighbor &lt;peer-ip&gt; dont-capability-negotiate</code> </pre><br>  Il existe une fonctionnalit√© non document√©e de Cisco - un temporisateur de 30 secondes, qui est d√©clench√© par un changement dans les politiques <i><font color="#008080">BGP</font></i> .  Apr√®s avoir modifi√© les politiques, le processus de mise √† jour des itin√©raires √† l'aide de l'une des technologies ci-dessus d√©marre dans 30 secondes.  Je n'ai pas pu trouver une description document√©e de ce temporisateur, mais il en est fait mention dans le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">BUG CSCvi91270</a> .  Vous pouvez en apprendre davantage sur sa disponibilit√© dans la pratique, <img src="https://habrastorage.org/webt/mk/tm/7s/mktm7sjydraauxoeajhyzkm9lyc.png" align="right" width="400">  apr√®s avoir apport√© des modifications dans le laboratoire et recherch√© dans le <i><font color="#008080">d√©bogage</font></i> des demandes <i><font color="#008080">UPDATE</font></i> au voisin ou le <i><font color="#008080">processus de reconfiguration en douceur</font></i> .  (S'il y a des informations suppl√©mentaires sur le sujet - vous pouvez laisser dans les commentaires) <br><br>  Pour la <b>reconfiguration en douceur</b> , le minuteur fonctionne comme ceci: <br><br><pre> <code class="plaintext hljs">2901-NOC-4.2(config)#no ip prefix-list pl-test seq 10 permit 10.5.5.0/26 2901-NOC-4.2(config)#do sh clock 16:53:31.117 Tue Sep 24 2019 Sep 24 16:53:59.396: BGP(0): start inbound soft reconfiguration for Sep 24 16:53:59.396: BGP(0): process 10.5.5.0/26, next hop 10.0.0.1, metric 0 from 10.0.0.1 Sep 24 16:53:59.396: BGP(0): Prefix 10.5.5.0/26 rejected by inbound route-map. Sep 24 16:53:59.396: BGP(0): update denied, previous used path deleted Sep 24 16:53:59.396: BGP(0): no valid path for 10.5.5.0/26 Sep 24 16:53:59.396: BGP(0): complete inbound soft reconfiguration, ran for 0ms Sep 24 16:53:59.396: BGP: topo global:IPv4 Unicast:base Remove_fwdroute for 10.5.5.0/26 2901-NOC-4.2(config)#</code> </pre><br>  Pour <b>Route-Refresh</b> du c√¥t√© du voisin comme ceci: <br><br><pre> <code class="plaintext hljs">2801-RTR (config-router)# *Sep 24 20:57:29.847 MSK: BGP: 10.0.0.2 rcv REFRESH_REQ for afi/sfai: 1/1 *Sep 24 20:57:29.847 MSK: BGP: 10.0.0.2 start outbound soft reconfig for afi/safi: 1/1</code> </pre><br>  Si <i><font color="#008080">Route-Refresh n'est</font></i> pas pris en charge par l'un des homologues et que <i><font color="#008080">la reconfiguration logicielle entrante n'est</font></i> pas activ√©e, la mise √† jour des itin√©raires par la nouvelle strat√©gie ne se fera pas automatiquement. <br><br>  Ainsi, la <i><font color="#008080">liste des pr√©fixes a</font></i> √©t√© supprim√©e, la connexion est rest√©e, apr√®s 30 secondes, elle a disparu.  Le script a r√©ussi √† modifier la configuration, √† v√©rifier la connexion et √† enregistrer la configuration.  La chute du script n'√©tait pas imm√©diatement li√©e, sur fond d'un grand nombre d'objets. <br><br>  Tout cela pourrait facilement √™tre √©vit√© par des tests, une r√©plication partielle des param√®tres. Il √©tait entendu que l'automatisation devrait √™tre centralis√©e et contr√¥l√©e. <br><br><img src="https://habrastorage.org/webt/du/ew/zc/duewzcojsasaegoufuir8jymcz0.jpeg"><br></div></div><br><h2>  Les syst√®mes dont nous avons besoin et leurs connexions </h2><br>  Une br√®ve conclusion du spoiler - il est pr√©f√©rable de syst√©matiser et de contr√¥ler le processus de livraison en masse des configurations afin de ne pas arriver √† la livraison en masse des erreurs dans les configurations. <br><br><pre> <code class="plaintext hljs">- DevOps:    50ms     4    -     : ", !@#$%"</code> </pre><br>  Le sch√©ma auquel nous sommes arriv√©s consiste en des blocs de donn√©es de base ¬´m√©tier¬ª, des blocs de donn√©es de base ¬´r√©seau¬ª, des syst√®mes de surveillance d'infrastructure de r√©seau, des syst√®mes de livraison de configuration, des syst√®mes de contr√¥le de version avec une unit√© de test. <br><br><img src="https://habrastorage.org/webt/ft/sc/wl/ftscwlfa_zs4afvfwkeybwo7et0.jpeg"><br><br><h3>  Tout ce dont nous avons besoin, c'est de donn√©es </h3><br>  Nous devons d'abord savoir quels sont les objets dans l'entreprise. <br><br>  <b>SAP</b> - Syst√®me d'entreprise <abbr title="Planification des ressources en entreprise">ERP</abbr> .  Il existe des donn√©es sur presque toutes les installations, et plus pr√©cis√©ment sur tous les magasins et centres de distribution.  De plus, il existe des donn√©es sur les √©quipements qui ont transit√© par un entrep√¥t informatique avec des num√©ros d'inventaire, qui nous seront √©galement utiles √† l'avenir.  Seuls les bureaux manquent, ils ne sont pas d√©marr√©s dans le syst√®me.  Nous essayons de r√©soudre ce probl√®me dans un processus s√©par√©, √† partir du moment de l'ouverture, nous avons besoin d'une connexion sur chaque objet, et nous s√©lectionnons les param√®tres de communication, donc quelque part √† ce moment, nous devons cr√©er des donn√©es de base.  Mais l'insuffisance des donn√©es est un sujet distinct, il est pr√©f√©rable de mettre cette description dans un article s√©par√© si cela vous int√©resse. <br><br>  <b><abbr title="HP Service Manager">HPSM</abbr></b> - un syst√®me contenant une <abbr title="Base de donn√©es de gestion de la configuration">CMDB</abbr> commune pour l'informatique, la gestion des incidents, la gestion du changement.  √âtant donn√© que le syst√®me est commun √† tous les services informatiques, il doit disposer de tous les √©quipements informatiques, y compris les √©quipements r√©seau.  C'est l'endroit o√π nous ajouterons toutes les donn√©es finales sur le r√©seau.  Avec la gestion des incidents et des changements, nous pr√©voyons d'interagir √† partir des syst√®mes de surveillance √† l'avenir. <br><br>  Nous savons quels objets nous avons, les enrichir avec des donn√©es sur le r√©seau.  √Ä cette fin, nous avons deux syst√®mes - <abbr title="Gestion des adresses IP">IPAM</abbr> de <i>SolarWinds</i> et notre propre syst√®me CMDB.noc. <br><br>  <b>IPAM</b> est un r√©f√©rentiel de sous-r√©seaux IP, les donn√©es les plus correctes et correctes sur la propri√©t√© des adresses IP dans l'entreprise devraient √™tre ici. <br><br>  <b>CMDB.noc</b> est une base de donn√©es avec une interface WEB o√π sont stock√©es des donn√©es statiques sur l'√©quipement r√©seau - routeurs, commutateurs, points d'acc√®s, ainsi que les fournisseurs et leurs caract√©ristiques.  Dans le cadre de moyens statiques, leur changement ne s'effectue qu'avec la participation de l'homme.  En d'autres termes, la d√©couverte automatique ne modifie pas cette base de donn√©es, nous en avons besoin pour comprendre ce qui ¬´devrait¬ª √™tre install√© sur l'objet.  Sa base est n√©cessaire comme tampon entre les syst√®mes productifs avec lesquels toute l'entreprise travaille et les outils r√©seau internes.  Acc√©l√®re le d√©veloppement, en ajoutant les champs n√©cessaires, de nouvelles relations, en ajustant les param√®tres, etc.  De plus, cette solution est non seulement dans la vitesse de d√©veloppement, mais aussi en pr√©sence de ces relations entre les donn√©es dont nous avons besoin, sans compromis.  Comme mini-exemple, nous utilisons plusieurs <abbr title="Identifiant externe">exid</abbr> dans la base de donn√©es pour la communication entre IPAM, SAP et HPSM. <br><br>  En cons√©quence, nous avons re√ßu des donn√©es compl√®tes sur tous les objets, avec l'√©quipement r√©seau connect√© et les adresses IP.  Nous avons maintenant besoin de mod√®les de configuration ou de services r√©seau que nous fournissons sur ces sites. <br><br><img src="https://habrastorage.org/webt/uy/qp/7f/uyqp7fxlkyf4rluokbotmtg5wvy.jpeg"><br><br><h3>  Source unique de v√©rit√© </h3><br>  Ici, nous venons d'atteindre l'application du premier principe NaaC - le stockage des configurations cibles dans le r√©f√©rentiel.  Dans notre cas, c'est Gitlab.  Le choix pour nous √©tait simple: <br><br><ul><li>  Premi√®rement, nous avons d√©j√† cet outil dans notre entreprise, nous n'avons pas eu besoin de le d√©ployer √† partir de z√©ro </li><li>  Deuxi√®mement, il convient parfaitement √† toutes nos t√¢ches actuelles et futures sur l'infrastructure r√©seau </li></ul><br>  La principale partie int√©ressante de l'automatisation se produira dans Gitlab - le processus de modification de la norme de configuration ou, plus simplement, du mod√®le. <br><br><h5>  Exemple de processus de changement standard </h5>  L'un des types d'objets que nous avons est le magasin Pyaterochka.  L√†, une topologie typique se compose d'un routeur et d'un / deux commutateurs.  Le fichier de configuration du mod√®le est stock√© dans Gitlab, dans cette partie tout est simple.  Mais ce n'est pas tout √† fait NaaC. <br><br>  Supposons maintenant qu'un nouveau projet nous arrive.  Les t√¢ches du nouveau projet informatique sont de r√©aliser un pilote dans un certain volume de magasins.  Selon les r√©sultats du pilote - en cas de succ√®s, effectuez une r√©plication pour tous les objets de ce type;  sinon r√©duisez le pilote sans effectuer de r√©plication. <br><br>  Ce processus s'int√®gre tr√®s bien dans la logique Git: <br><br><ol><li>  Pour un nouveau projet, nous cr√©ons une branche, o√π nous apportons des modifications aux configurations. </li><li>  Dans Branch, nous conservons √©galement une liste des objets sur lesquels ce projet est pilot√©. </li><li>  En cas de succ√®s, nous faisons une demande de fusion dans la branche principale, qui devra √™tre r√©pliqu√©e sur le prod-network </li><li>  En cas d'√©chec, quittez Branch pour l'historique, ou supprimez simplement </li></ol><br><img src="https://habrastorage.org/webt/lx/o1/hu/lxo1hulupq0mzqe37qcodnutxno.png" align="right" width="240"><br>  En premi√®re approximation - m√™me sans automatisation, c'est un outil tr√®s pratique pour travailler ensemble sur une configuration r√©seau.  Surtout si vous imaginez que trois projets ou plus sont arriv√©s en m√™me temps.  Lorsque le moment sera venu de publier les projets dans prod, vous devrez r√©soudre tous les conflits de configuration dans les demandes de fusion et v√©rifier que les modifications apport√©es aux param√®tres ne s'excluent pas mutuellement.  Et c'est tr√®s pratique √† faire dans git. <br><br>  De plus, cette approche nous ajoute la flexibilit√© d'utiliser les outils Gitlab CI / CD pour tester virtuellement des configurations, pour automatiser la livraison de configurations √† un banc de test ou √† un groupe pilote d'objets.  // Et m√™me sur prod si vous voulez. <br><br><h3>  D√©ployer la configuration dans n'importe quel environnement </h3><br>  Initialement, l'objectif principal √©tait pr√©cis√©ment la livraison en masse de configurations, en tant qu'outil qui permet tr√®s clairement de gagner du temps aux ing√©nieurs et d'acc√©l√©rer l'ex√©cution des t√¢ches de configuration.  Pour ce faire, avant m√™me le d√©but de la grande activit√© ¬´Network as a Code¬ª, nous avons √©crit une solution <i>python</i> pour se connecter √† des √©quipements soit pour collecter des configurations d'√©quipements, soit pour les configurer.  C'est <i>netmiko</i> , c'est <i>pysnmp</i> , c'est <i>jinja2</i> , etc. <br><br>  Mais il est temps pour nous de diviser la configuration en bloc en plusieurs sous-esp√®ces: <br><br><ol><li><div class="spoiler">  <b class="spoiler_title">Livraison de configurations pour tester et zones pilotes</b> <div class="spoiler_text">  Cet √©l√©ment est bas√© sur Gitlab CI, qui vous permet d'activer la remise de la configuration aux zones pilote et de test dans le pipeline. <br></div></div></li><li><div class="spoiler">  <b class="spoiler_title">Duplication de configurations dans prod</b> <div class="spoiler_text"><ul><li>  Un √©l√©ment distinct, le plus souvent la r√©plication vers des appareils 38k a lieu en plusieurs vagues - augmentant le volume - pour surveiller la situation en prod.  De plus, un travail de cette ampleur n√©cessite une coordination du travail, il est donc pr√©f√©rable de d√©marrer ce processus √† la main.  Pour cela, il est pratique d'utiliser Ansible + -AWX et d'y fixer la compilation dynamique de l'inventaire de nos syst√®mes de donn√©es de base. </li><li>  En outre, il s'agit d'une solution pratique lorsque vous devez donner √† la deuxi√®me ligne le lancement de playbooks pr√©configur√©s qui effectuent des op√©rations complexes et importantes, telles que la commutation du trafic entre les sites. </li></ul></div></div></li><li><div class="spoiler">  <b class="spoiler_title">Collecte de donn√©es</b> <div class="spoiler_text"><ul><li>  D√©couverte automatique des p√©riph√©riques r√©seau </li><li>  Configurations de sauvegarde </li><li>  V√©rifier la connectivit√© </li></ul><br>  Nous avons attribu√© cette t√¢che dans un bloc s√©par√©, car il y a des moments o√π quelqu'un a soudainement d√©mont√© un commutateur ou install√© un nouvel appareil, mais nous ne le savions pas √† l'avance.  En cons√©quence, cet appareil ne sera pas dans nos donn√©es de base et tombera du processus de livraison de configuration, de surveillance et, en g√©n√©ral, de travail op√©rationnel.  Il arrive que l'√©quipement ait √©t√© install√© l√©gitimement, mais la configuration y a √©t√© "mal" vers√©e et, pour une raison quelconque, <i>ssh</i> , <i>snmp</i> , <i>aaa</i> ou des mots de passe non standard pour l'acc√®s n'y fonctionnent pas.  Pour ce faire, nous avons python pour essayer toutes les m√©thodes de connexion <i>h√©rit√©es</i> possibles que nous pourrions avoir dans l'entreprise, faire de la force brute pour tous les anciens mots de passe, et tout cela pour obtenir le morceau de fer et le pr√©parer √† travailler avec <i>ansible</i> et √† surveiller . <br><br>  Il existe un moyen simple - de cr√©er plusieurs fichiers d' <i>inventaire</i> pour ansible, o√π d√©crire toutes les donn√©es possibles pour les connexions (tous les types de fournisseurs avec toutes les paires nom d'utilisateur / mot de passe possibles) et ex√©cuter un <i>playbook</i> pour chaque variante d' <i>inventaire</i> .  Nous esp√©rions une meilleure solution, mais lors de la conf√©rence RedHat, l'architecte Ansible a conseill√© la m√™me chose.  Il est g√©n√©ralement admis que vous savez √† l'avance √† quoi vous vous connectez. <br>  Nous voulions une solution universelle - lorsque vous supprimez une sauvegarde, recherchez un nouvel √©quipement et, s'il est trouv√©, ajoutez-le √† tous les syst√®mes n√©cessaires.  Par cons√©quent, nous choisissons une solution en python - sachez ce qui pourrait √™tre plus beau qu'un programme qui lui-m√™me peut d√©tecter un mat√©riel r√©seau pour s'y connecter, ind√©pendamment de ce qui y est configur√© (dans des limites raisonnables, bien s√ªr), configurer selon les besoins, supprimer la configuration et, en m√™me temps, Ajoutez des donn√©es API aux syst√®mes requis. <br></div></div></li></ol><br><h3>  V√©rification comme la surveillance </h3><br>  L'une des t√¢ches de l'automatisation est, bien s√ªr, de d√©couvrir ce qui est tomb√© de cette automatisation.  Les 38k ne sont pas tous parfaitement configur√©s la premi√®re fois, il arrive m√™me que quelqu'un installe l'√©quipement avec ses mains.  Et il est n√©cessaire de suivre ces changements et de rendre <s>justice √† la</s> configuration cible. <br><br>  Il existe trois approches pour v√©rifier la conformit√© de la configuration avec la norme: <br><br><ul><li>  Faites une v√©rification une fois par p√©riode - d√©chargez l'√©tat actuel, comparez avec la cible et corrigez les lacunes identifi√©es. </li><li>  Sans rien v√©rifier, une fois par p√©riode - d√©ployez les configurations cibles.  Certes, il y a un risque de casser quelque chose - peut-√™tre qu'il n'y avait pas tout dans la configuration cible. </li><li>  Une approche pratique consiste √† consid√©rer les diff√©rences par rapport √† la configuration cible dans <i>Single Source of Truth</i> comme des alertes et √† les surveiller par le syst√®me de surveillance.  Cela comprend: une incompatibilit√© avec la norme de configuration actuelle, une diff√©rence entre le mat√©riel et celui sp√©cifi√© dans les donn√©es de base, une incompatibilit√© avec les donn√©es dans <i>IPAM</i> . </li></ul><br>  Dans le troisi√®me cas, une option semble transf√©rer ce travail √† la gestion des incidents (OS), afin que les incoh√©rences soient √©limin√©es par petites portions tout au long du temps plus d'une fois par urgence. <br><br>  <b>Zabbix</b> , dont j'ai parl√© plus t√¥t dans l'article <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">¬´Comment nous avons surveill√© 14 000 objets¬ª,</a> est notre syst√®me de surveillance des objets distribu√©s o√π nous pouvons effectuer tous les d√©clencheurs et alertes auxquels nous pouvons penser.  Depuis la r√©daction du dernier article, nous avons mis √† niveau vers Zabbix 4.0 <abbr title="Support √† long terme">LTS</abbr> . <br><br>  Sur la base de <i>Web Zabbix,</i> nous avons mis √† jour notre portail de support r√©seau, o√π vous pouvez d√©sormais trouver toutes les informations sur un objet de tous nos syst√®mes sur un seul √©cran, ainsi que ex√©cuter des scripts pour v√©rifier les probl√®mes fr√©quents. <br><br><img src="https://habrastorage.org/webt/o_/65/ha/o_65haiskiyx5jvmofs1wwmy9a8.png"><br><br>  Nous avons √©galement introduit une nouvelle fonctionnalit√© - pour nous, Zabbix est devenu, en quelque sorte, un <i>CRON</i> pour le lancement de scripts programm√©s, tels que les scripts d'int√©gration syst√®me, les scripts de <i>d√©couverte automatique</i> .  C'est tr√®s pratique lorsque vous devez regarder les scripts actuels et quand et o√π ils s'ex√©cutent sans v√©rifier tous les serveurs.  Certes, pour les scripts qui s'ex√©cutent pendant plus de 30 secondes, vous aurez besoin d'un <i>lanceur</i> qui les lance sans attendre la fin.  Heureusement, c'est simple: <br><br><div class="spoiler">  <b class="spoiler_title">launcher.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash nohup $* &gt; /dev/null 2&gt;/dev/null &amp; echo $(date) Started job for $*</span></span></code> </pre><br></div></div><br><img src="https://habrastorage.org/webt/gu/vp/ww/guvpwwbg0scnt8ngqkhuy7keey8.png"><br><br>  <b>Splunk</b> est une solution qui vous permet de collecter des journaux d'√©v√©nements √† partir de l'√©quipement r√©seau, et cela peut √©galement √™tre utilis√© pour surveiller l'automatisation.  Par exemple, lors de la collecte d'une sauvegarde de configuration, un script <i>python</i> g√©n√®re un message <i>LOG</i> <i>CFG-5-BACKUP</i> , un routeur ou un commutateur envoie un message √† Splunk, dans lequel nous comptons le nombre de messages de ce type provenant de l'√©quipement r√©seau.  Cela nous permet de suivre la quantit√© d'√©quipement que le script a d√©tect√©.  Et nous voyons combien de morceaux de fer ont pu signaler cela √† <i>Splunk</i> et v√©rifier que les messages de tous les morceaux de fer sont arriv√©s. <br>  <b>Spectrum</b> est un syst√®me complet que nous utilisons pour surveiller les objets critiques, un outil plut√¥t puissant qui nous aide beaucoup √† r√©soudre les incidents r√©seau critiques.  Dans l'automatisation, nous l'utilisons uniquement en extrayant des donn√©es, ce n'est pas <i>open-source</i> , donc les possibilit√©s sont quelque peu limit√©es. <br><br><h3>  La cerise sur le g√¢teau </h3><br><img src="https://habrastorage.org/webt/-a/g_/qk/-ag_qktnw97gq5edbpbswa1h_xa.png" align="right" width="240">  En utilisant des syst√®mes avec des donn√©es de base sur l'√©quipement, nous pouvons penser √† cr√©er ZTP, ou Zero Touch Provisioning.  Comme un bouton "auto-tuning", mais seulement sans bouton. <br><br>  Nous avons toutes les donn√©es n√©cessaires des blocs pr√©c√©dents - nous connaissons l'objet, son type, quel √©quipement est l√† (fournisseur et mod√®le), quelles adresses sont l√† (IPAM), quelle est la norme de configuration actuelle (Git).  En les rassemblant tous, nous pouvons au moins pr√©parer un mod√®le de configuration pour le t√©l√©chargement sur l'appareil, ce sera plus comme One Touch Provisioning, mais parfois plus n'est pas n√©cessaire. <br><br>  True Zero Touch a besoin d'un moyen de fournir automatiquement la configuration √† du mat√©riel non configur√©.  De plus, il est souhaitable quel que soit le fournisseur.  Il existe plusieurs options de travail - un serveur de console, si tout l'√©quipement passe par l'entrep√¥t central, des solutions de console mobile, si l'√©quipement arrive imm√©diatement.  Nous travaillons simplement sur ces solutions, mais d√®s qu'il y a une option de travail, nous pouvons la partager. <br><br><h3>  Conclusion </h3><br>  Au total, dans notre concept de <b>r√©seau en tant que code</b> , il y avait 5 √©tapes principales: <br><br><ul><li>  Donn√©es de base (communication des syst√®mes et des donn√©es entre eux, API des syst√®mes, suffisance des donn√©es pour le support et le lancement) </li><li>  Surveillance des donn√©es et des configurations (d√©couverte automatique des p√©riph√©riques r√©seau, v√©rification de la pertinence de la configuration dans l'installation) </li><li>  Contr√¥le de version, tests et configurations de pilotage (Gitlab CI / CD appliqu√© au r√©seau, outils de test de configuration r√©seau) </li><li>  Livraison de la configuration (Ansible, AWX, scripts python pour se connecter) </li><li>  Zero Touch Provisioning (quelles donn√©es sont n√©cessaires, comment construire un processus pour qu'il soit, comment se connecter √† un mat√©riel non configur√©) </li></ul><br>  Cela n'a pas fonctionn√© de tout int√©grer dans un seul article, chaque √©l√©ment m√©rite une discussion distincte, nous pouvons parler de quelque chose maintenant, de quelque chose lorsque nous v√©rifions les solutions dans la pratique.  Si vous √™tes int√©ress√© par l'un des sujets - √† la fin, il y aura un sondage o√π vous pourrez voter pour le prochain article.  Si le sujet n'est pas inclus dans la liste, mais qu'il est int√©ressant de le lire, laissez un commentaire d√®s que possible, assurez-vous de partager notre exp√©rience. <br><br><hr><br>  Un merci sp√©cial √† Virilin Alexander ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">xscrew</a> ) et Sibgatulin Marat ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">eucariot</a> ) pour la visite de r√©f√©rence √† l'automne 2018 sur le cloud yandex et l'histoire de l'automatisation dans l'infrastructure de r√©seau cloud.  Apr√®s lui, nous avons trouv√© l'inspiration et beaucoup d'id√©es sur l'utilisation de l'automatisation et de NetDevOps dans l'infrastructure du X5 Retail Group. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr468197/">https://habr.com/ru/post/fr468197/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr468185/index.html">Service AWS EC2 et collaboration avec lui</a></li>
<li><a href="../fr468189/index.html">Boostez les comp√©tences de d√©bogage JavaScript √† l'aide d'astuces de console</a></li>
<li><a href="../fr468191/index.html">RubyRussia 2019: Nikolay Sverchkov √† propos du serveur sans serveur</a></li>
<li><a href="../fr468193/index.html">Internes JVM, partie 1 - chargeur de classe</a></li>
<li><a href="../fr468195/index.html">Pourquoi mes finances d√©pendent-elles de Beeline?</a></li>
<li><a href="../fr468203/index.html">√ânigmes √† la recherche d'une chance parfaite</a></li>
<li><a href="../fr468205/index.html">GIT de l'int√©rieur: introduction (traduction)</a></li>
<li><a href="../fr468207/index.html">Comment nous avons mis √† jour Zabbix</a></li>
<li><a href="../fr468211/index.html">¬´Je voulais juste faire une blague, mais personne n'a compris¬ª ou comment ne pas m'enterrer lors de la pr√©sentation du projet</a></li>
<li><a href="../fr468213/index.html">tinc-boot - r√©seau maill√© sans douleur</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>