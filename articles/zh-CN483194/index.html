<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ•¦ ğŸ’¿ ğŸ‘¨â€ğŸ‘¨â€ğŸ‘§â€ğŸ‘¦ æœºå™¨äººæ”¶è´¹ã€‚ ç”¨æ–°æŠ€æœ¯å»è¸¢è¶³çƒ ğŸ‘©ğŸ»â€ğŸ¤â€ğŸ‘¨ğŸ¾ ğŸ‘§ ğŸ‘¨ğŸ½â€âš•ï¸</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="å¼•è¨€ 


 å¤§å®¶å¥½ åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†ä»‹ç»ä½¿ç”¨NodeJSçš„ç”µæŠ¥æ¶ˆæ¯ä¼ é€’æœåŠ¡å’ŒVKç¤¾äº¤ç½‘ç»œçš„èŠå¤©æœºå™¨äººã€‚ 


 åœ¨è¿™ä¸€ç‚¹ä¸Šï¼Œè®¸å¤šè¯»è€…åº”è¯¥æå‡ºç±»ä¼¼çš„å†…å®¹ï¼šâ€œå¤šé•¿æ—¶é—´ï¼â€ æˆ–â€œåˆæ˜¯ä»€ä¹ˆï¼Ÿï¼â€ 
 æ˜¯çš„ï¼Œç±»ä¼¼çš„å‡ºç‰ˆç‰©å·²ç»å¤‡å—å…³æ³¨ã€‚ ä½†æ˜¯ï¼Œå°½ç®¡å¦‚æ­¤ï¼Œæˆ‘è®¤ä¸ºè¿™ç¯‡æ–‡ç« è¿˜æ˜¯æœ‰ç”¨çš„ã€‚ ç®€è¦ä»‹ç»ä¸€ä¸‹è¯¥æœºå™¨äººçš„æŠ€æœ¯å®ç°...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>æœºå™¨äººæ”¶è´¹ã€‚ ç”¨æ–°æŠ€æœ¯å»è¸¢è¶³çƒ</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/483194/"><h2 id="vvedenie"> å¼•è¨€ </h2><br><p> å¤§å®¶å¥½ åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†ä»‹ç»ä½¿ç”¨NodeJSçš„ç”µæŠ¥æ¶ˆæ¯ä¼ é€’æœåŠ¡å’ŒVKç¤¾äº¤ç½‘ç»œçš„èŠå¤©æœºå™¨äººã€‚ </p><br><p> åœ¨è¿™ä¸€ç‚¹ä¸Šï¼Œè®¸å¤šè¯»è€…åº”è¯¥æå‡ºç±»ä¼¼çš„å†…å®¹ï¼šâ€œå¤šé•¿æ—¶é—´ï¼â€ æˆ–â€œåˆæ˜¯ä»€ä¹ˆï¼Ÿï¼â€ <br> æ˜¯çš„ï¼Œç±»ä¼¼çš„å‡ºç‰ˆç‰©å·²ç»å¤‡å—å…³æ³¨ã€‚ ä½†æ˜¯ï¼Œå°½ç®¡å¦‚æ­¤ï¼Œæˆ‘è®¤ä¸ºè¿™ç¯‡æ–‡ç« è¿˜æ˜¯æœ‰ç”¨çš„ã€‚ ç®€è¦ä»‹ç»ä¸€ä¸‹è¯¥æœºå™¨äººçš„æŠ€æœ¯å®ç°ï¼š </p><br><ol><li> ä½œä¸ºè¯¥åº”ç”¨ç¨‹åºçš„æ¡†æ¶ï¼Œ <a href="https://nestjs.com/">NestJS</a>æ¡†æ¶è¶Šæ¥è¶Šå—æ¬¢è¿ã€‚ </li><li> ç”¨äºä¸Telegram APIäº¤äº’çš„<a href="https://www.npmjs.com/package/telegraf">telegraf</a>åº“ã€‚ </li><li> ç”¨äºä¸VK APIäº¤äº’çš„<a href="https://www.npmjs.com/package/node-vk-bot-api">node-vk-bot-api</a>åº“ã€‚ </li><li> ç”¨äºç»„ç»‡æ•°æ®å­˜å‚¨å±‚çš„<a href="https://www.npmjs.com/package/typeorm">Typeorm</a>åº“ã€‚ </li><li> ä½¿ç”¨<a href="https://www.npmjs.com/package/mocha">mocha</a>å’Œchai <a href="https://www.npmjs.com/package/chai">æ–­è¨€</a>åº“è¿›è¡Œæµ‹è¯•ã€‚ </li><li>  CIä½¿ç”¨Travis CIè¿›è¡Œæµ‹è¯•ï¼Œå¹¶ä½¿ç”¨Giâ€‹â€‹tHub Actionséƒ¨ç½²Dockeræ˜ åƒã€‚ </li></ol><br><p> ä½œä¸ºé™„å¸¦å·¥ä½œï¼Œè®©æˆ‘ä»¬å°è¯•ä¸Viberæˆä¸ºæˆ‘ä»¬çš„æœºå™¨äººæœ‹å‹ï¼Œä½¿å…¶åœ¨å¤šç§æ¶ˆæ¯ä¼ é€’æœåŠ¡ä¸­é€šç”¨ã€‚ </p><br><p> å¯¹äºé‚£äº›æƒ³çŸ¥é“å®ƒå¸¦æ¥äº†ä»€ä¹ˆçš„äººï¼Œæ¬¢è¿çŒ«ã€‚ </p><a name="habracut"></a><br><h2 id="postanovka-zadachi"> é—®é¢˜é™ˆè¿° </h2><br><p> ä½œä¸ºæœ‰ç›Šçš„ä½“è‚²é”»ç‚¼ï¼Œæˆ‘æ›´å–œæ¬¢è¶³çƒã€‚ å½“ç„¶ï¼Œåœ¨ä¸šä½™æ°´å¹³ä¸Šã€‚ ä½œä¸ºvkï¼Œviberå’Œç”µæŠ¥ä¸­å‡ ä¸ªé¢‘é“å’ŒèŠå¤©çš„æˆå‘˜ï¼Œæ‚¨é€šå¸¸å¿…é¡»çœ‹åˆ°ä»¥ä¸‹å›¾ç‰‡ï¼š </p><br><p><img src="https://habrastorage.org/webt/jt/c7/h8/jtc7h8oxebenbzwymug3y2oi0oo.png" alt="å›¾ç‰‡"></p><br><p> æˆ‘ä»¬åœ¨è¿™é‡Œçœ‹åˆ°çš„æ˜¯ï¼š </p><br><ol><li>  â€œ Pâ€æ·»åŠ äº†è‡ªå·±ã€‚ </li><li> åœ¨ä»–ä¹‹åï¼Œåˆå¢åŠ äº†3ä¸ªäººï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªâ€œ Câ€ã€‚ </li><li>  â€œ Pâ€æ·»åŠ äº†ä»–çš„åŒå¿—â€œ Dimonâ€ã€‚ </li><li> æ­¤åï¼Œâ€œ Pâ€å¹¶ä¸æ˜¯å¤ªæ‡’æƒ°ï¼Œå¹¶è®¡ç®—å‡ºç›®å‰å·²ç»æœ‰å¤šè¾¾5ä¸ªäººã€‚ </li><li> ä½†æ˜¯ï¼Œç”±äºæˆ‘ä¹Ÿå†³å®šè·‘æ­¥å¹¶æ·»åŠ è‡ªå·±ï¼Œå› æ­¤æ­¤ä¿¡æ¯å·²ä¸å†é€‚ç”¨ã€‚ </li></ol><br><p> åœ¨ç‰¹åˆ«è¢«å¿½ç•¥çš„æƒ…å†µä¸‹ï¼Œäººä»¬å¯ä»¥æ‰“â€œ +â€å·ç„¶åå–æ¶ˆå…¶å‚ä¸ï¼Œé‚€è¯·ä¸å‚åŠ èŠå¤©çš„æœ‹å‹ï¼Œæˆ–è€…æ³¨å†Œå…¶ä»–èŠå¤©å‚ä¸è€…å¹¶è¿›è¡Œå…¶ä»–æ´»åŠ¨ã€‚ æœ€åï¼Œè¿™å¯¼è‡´äº†ä¸€ä¸ªäº‹å®ï¼Œå½“æ¯ä¸ªäººæœ€ç»ˆéƒ½å‚åŠ æ¯”èµ›æ—¶ï¼Œäº‹å®è¯æ˜ï¼š </p><br><ol><li>  Vasyaè®¾ç½®+1ä¸ä»…æ„å‘³ç€ä»–æœ¬äººï¼Œè¿˜æ„å‘³ç€ä»–çš„æœ‹å‹Goshã€‚ </li><li>  Kolyaå†™é“ä»–ä¼šæ¥ï¼Œä½†ç»„ç»‡è€…Spiridonç”¨ä»–çš„çœ¼ç›è®¤ä¸ºåªæ˜¯ä¼˜ç‚¹ã€‚ </li></ol><br><p> ç»“æœï¼Œæˆ‘ä»¬çš„å›¢é˜Ÿæ•°é‡å¯èƒ½ä¸ç›¸ç­‰ï¼Œâ€œé¢å¤–çš„å¤©å“ªâ€å¹¶å‡ºä¹æ„æ–™åœ°å‡ºç°äº†ç§‘é‡Œäºšã€‚ </p><br><p> ä¸ºäº†é¿å…æ­¤ç±»å†²çªï¼Œæˆ‘ç¼–å†™äº†ä¸€ä¸ªç®€å•çš„æœºå™¨äººï¼Œè¯¥æœºå™¨äººå¯ä»¥ç›´è§‚åœ°æ˜¾ç¤ºå³å°†åˆ°æ¥çš„æ¸¸æˆä¸­å‚ä¸è€…çš„ç»„æˆï¼Œå¹¶ä¸”å¯ä»¥æ–¹ä¾¿åœ°åœ¨å…¶ä¸­æ·»åŠ /åˆ é™¤ã€‚ </p><br><p> å› æ­¤ï¼Œåœ¨æˆ‘çš„åŸºæœ¬å®ç°ä¸­ï¼Œæˆ‘è®¤ä¸ºè¯¥æœºå™¨äººåº”è¯¥èƒ½å¤Ÿï¼š </p><br><ol><li> åµŒå…¥åˆ°ä»»æ„æ•°é‡çš„èŠå¤©ä¸­ã€‚ åˆ†åˆ«å­˜å‚¨æ¯ä¸ªèŠå¤©çš„çŠ¶æ€ã€‚ </li><li>  <em>ä½¿ç”¨</em>å‘½ä»¤<em>/ event_addï¼Œ</em>ä½¿ç”¨æŸäº›ä¿¡æ¯å’Œä¸€ä¸ªç©ºçƒå‘˜åˆ—è¡¨åˆ›å»ºä¸€ä¸ªæ–°çš„æ´»åŠ¨äº‹ä»¶ã€‚ å…ˆå‰çš„æ´»åŠ¨äº‹ä»¶åº”å˜ä¸ºéæ´»åŠ¨çŠ¶æ€ã€‚ </li><li>  <em>/ event_removeå‘½ä»¤</em>åº”å–æ¶ˆå½“å‰æ´»åŠ¨çš„äº‹ä»¶ã€‚ </li><li>  <em>/ add</em>å‘½ä»¤åº”å°†ä¸€ä¸ªæ–°æˆå‘˜æ·»åŠ åˆ°å½“å‰æ´»åŠ¨çš„äº‹ä»¶ä¸­ã€‚ æ­¤å¤–ï¼Œå¦‚æœè°ƒç”¨è¯¥å‘½ä»¤æ—¶æ²¡æœ‰ä»»ä½•å…¶ä»–æ–‡æœ¬ï¼Œåˆ™åº”è¯¥æ·»åŠ é”®å…¥è¯¥å‘½ä»¤çš„ç”¨æˆ·ã€‚ å¦åˆ™ï¼Œå°†æ·»åŠ ä¸€ä¸ªäººï¼Œè¯¥äººçš„åå­—åœ¨è°ƒç”¨å‘½ä»¤æ—¶æŒ‡å®šã€‚ </li><li>  <em>/ remove</em>å‘½ä»¤æ ¹æ®ä¸º<em>/ add</em>å‘½ä»¤æè¿°çš„è§„åˆ™ä»å‚ä¸è€…åˆ—è¡¨ä¸­åˆ é™¤ä¸€ä¸ªäººã€‚ </li><li>  <em>/ info</em>å‘½ä»¤å…è®¸æ‚¨æŸ¥çœ‹è°å·²ç»æ³¨å†Œäº†æ¸¸æˆã€‚ </li><li> æœ€å¥½è®©æ¼«æ¸¸å™¨ä»¥ä¸æ’­æ”¾å™¨é…ç½®ç›¸åŒçš„è¯­è¨€ï¼ˆæˆ–é»˜è®¤æƒ…å†µä¸‹ä¸ºè‹±è¯­ï¼‰è¿›è¡Œå“åº”ã€‚ </li></ol><br><p> è¦å¿«é€ŸæŸ¥çœ‹æœ€ç»ˆå‘ç”Ÿçš„æƒ…å†µï¼Œæ‚¨å¯ä»¥ç«‹å³è½¬åˆ°æœ€åä¸€éƒ¨åˆ†â€œç»“æœå’Œç»“è®ºâ€ã€‚ å¥½å§ï¼Œå¦‚æœæ‚¨å¯¹å®ç°ç»†èŠ‚æ„Ÿå…´è¶£ï¼Œé‚£ä¹ˆä¸‹é¢å°†å¯¹è¿™äº›ä¿¡æ¯è¿›è¡Œè¶³å¤Ÿè¯¦ç»†çš„æè¿°ã€‚ </p><br><h2 id="proektirovanie-i-razrabotka"> è®¾è®¡å¼€å‘ </h2><br><p> åœ¨è®¾è®¡åº”ç”¨ç¨‹åºæ—¶ï¼Œæˆ‘æƒ³åˆ°äº†ä»¥ä¸‹æ–¹æ¡ˆï¼š </p><br><p><img src="https://habrastorage.org/webt/v7/j4/gz/v7j4gzjufgbeuayina59yy8blia.jpeg" alt="å›¾ç‰‡"></p><br><p> åœ¨è¿™é‡Œï¼Œä¸»è¦æ€æƒ³æ˜¯å°†ä¸å„ç§æ¶ˆæ¯ä¼ é€’ç³»ç»Ÿä¸€èµ·ä½¿ç”¨çš„æ‰€æœ‰ç»†èŠ‚å¼•å…¥é€‚å½“çš„é€‚é…å™¨ä¸­ï¼Œå¹¶å°è£…ä¸å®ç°ç›¸åº”APIçš„åº“è¿›è¡Œäº¤äº’çš„é€»è¾‘ï¼Œä»è€Œå°†æ•°æ®å¤„ç†å¹¶å°†å…¶è½¬æ¢ä¸ºå•ä¸€å½¢å¼ã€‚ </p><br><h3 id="interfeys-i-modeli-soobscheniy"> ç•Œé¢å’Œæ¶ˆæ¯æ¨¡å‹ </h3><br><p> å¯¹äºæ¶ˆæ¯ï¼Œå¯ä»¥è®¾è®¡ä»¥ä¸‹<em>IMessage</em>æ¥å£ï¼Œ <em>è¯¥ç±»</em>å¯ä»¥é€šè¿‡å­˜å‚¨ç”¨äºå„ç§ç³»ç»Ÿçš„ä¼ å…¥æ¶ˆæ¯æ•°æ®çš„ç±»ä»¥åŠä½¿ç”¨è¯¥æ•°æ®çš„æ–¹æ³•æ¥æ»¡è¶³ï¼š </p><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> interface IMessage { <span class="hljs-attr"><span class="hljs-attr">chatId</span></span>: number; lang: string; text: string; fullText: string; command: string; name: string; getReplyStatus: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> string; getReplyData: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> any; setStatus: <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">status: string</span></span></span><span class="hljs-function">) =&gt;</span></span> IMessage; withData: <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data: any</span></span></span><span class="hljs-function">) =&gt;</span></span> IMessage; answer: <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">args: any</span></span></span><span class="hljs-function">) =&gt;</span></span> string | <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>; }</code> </pre> <br><p> å®ç°æ­¤æ¥å£çš„åŸºç±»<em>BaseMessage</em>å…·æœ‰ä»¥ä¸‹å½¢å¼ï¼š </p><br><div class="spoiler">  <b class="spoiler_title">åŸºæœ¬æ¶ˆæ¯</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {IMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../message/i-message'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseMessage</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IMessage</span></span></span><span class="hljs-class"> </span></span>{ public chatId: number; public lang: string; public text: string; public fullText: string; public command: string; protected firstName: string; protected lastName: string; protected replyStatus: string; protected replyData: any; get name(): string { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> firstName: string = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.firstName || <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> lastName: string = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.lastName || <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${firstName}</span></span></span><span class="hljs-string"> </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${lastName}</span></span></span><span class="hljs-string">`</span></span>.trim(); } public getReplyStatus(): string { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.replyStatus; } public getReplyData(): any { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.replyData; } public setStatus(status: string): IMessage { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.replyStatus = status; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } public withData(data: any): IMessage { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.replyData = data; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } public answer(args: any): string | <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(<span class="hljs-string"><span class="hljs-string">'not implemented'</span></span>); } } }</code> </pre> </div></div><br><p> ç”µæŠ¥çš„æ¶ˆæ¯ç±»ï¼š </p><br><div class="spoiler">  <b class="spoiler_title">ç”µæŠ¥æ¶ˆæ¯</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {BaseMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../message/base.message'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {IMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../message/i-message'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TelegramMessage</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseMessage</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IMessage</span></span></span><span class="hljs-class"> </span></span>{ private ctx: any; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(ctx) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ctx = ctx; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> {message} = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ctx.update; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.chatId = message.chat.id; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fullText = message.text; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.command = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ctx.command; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.text = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fullText.replace(<span class="hljs-string"><span class="hljs-string">`/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${</span></span><span class="hljs-keyword"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-string"><span class="hljs-subst">.command}</span></span></span><span class="hljs-string">`</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.lang = message.from.language_code; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.firstName = message.from.first_name; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.lastName = message.from.last_name; } public answer(args: any): string | <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ctx.replyWithHTML(args); } }</code> </pre> </div></div><br><p> å¯¹äºVKï¼š </p><br><div class="spoiler">  <b class="spoiler_title">VKæ¶ˆæ¯</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {BaseMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../message/base.message'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {IMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../message/i-message'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">VKMessage</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseMessage</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IMessage</span></span></span><span class="hljs-class"> </span></span>{ private ctx: any; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(ctx) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ctx = ctx; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> {message} = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ctx; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.chatId = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getChatId(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ctx); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fullText = message.text; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.command = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ctx.command; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.text = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fullText.replace(<span class="hljs-string"><span class="hljs-string">`/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${</span></span><span class="hljs-keyword"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-string"><span class="hljs-subst">.command}</span></span></span><span class="hljs-string">`</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.lang = <span class="hljs-string"><span class="hljs-string">'ru'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.firstName = message.from.first_name; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.lastName = message.from.last_name; } public answer(args: any) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> answer: string = <span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${args}</span></span></span><span class="hljs-string">`</span></span>.replace(<span class="hljs-regexp"><span class="hljs-regexp">/&lt;\/?(strong|i)&gt;/gm</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ctx.reply(answer); } private getChatId({message, bot}): number { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> peerId: number = +<span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${message.peer_id}</span></span></span><span class="hljs-string">`</span></span>.replace(<span class="hljs-regexp"><span class="hljs-regexp">/[0-9]0+/</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> groupId: number = bot.settings.group_id; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> peerId + groupId; } }</code> </pre> </div></div><br><p> æ‚¨è¦æ³¨æ„çš„æ˜¯ï¼š </p><br><ol><li><p>  <em>chatId</em>æ˜¯èŠå¤©çš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚ å¯¹äºTelegramï¼Œå®ƒæ˜ç¡®åœ°å‡ºç°åœ¨æ¯ä¸ªæ¶ˆæ¯çš„ç»“æ„ä¸­ã€‚ ä½†æ˜¯ï¼Œå¯¹äºVKï¼Œæ²¡æœ‰æ˜ç¡®çš„æ­¤ç±»æ ‡è¯†ç¬¦ã€‚ æ€ä¹ˆæ · è¦å›ç­”è¿™ä¸ªé—®é¢˜ï¼Œæ‚¨éœ€è¦äº†è§£Botåœ¨VKä¸­çš„åŠŸèƒ½ã€‚ åœ¨æ­¤ç³»ç»Ÿä¸­ï¼Œç»„é€šä¿¡ä¸­çš„æ¼«æ¸¸å™¨ä»£è¡¨å…¶å¯åŠ¨çš„ç¤¾åŒºã€‚ å³ æ¯ä¸ªæ¼«æ¸¸å™¨æ¶ˆæ¯éƒ½åŒ…å«ä¸€ä¸ª<em>group_id</em>ç¤¾åŒºæ ‡è¯†ç¬¦ã€‚ å¦å¤–ï¼Œåœ¨æœ¬ä¾‹ä¸­ï¼Œæ¶ˆæ¯ä¸­<em>åŒ…å«peer_id</em> ï¼ˆæ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§ï¼‰ï¼Œä½œä¸ºç»„å¯¹è¯çš„æ ‡è¯†ç¬¦ã€‚ åŸºäºè¿™ä¸¤ä¸ªæ ‡è¯†ç¬¦ï¼Œæ‚¨å¯ä»¥æ„å»ºæ‚¨çš„èŠå¤©æ ‡è¯†ç¬¦ï¼Œä¾‹å¦‚ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š </p><br><pre> <code class="javascript hljs">private getChatId({message, bot}): number { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> peerId: number = +(<span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${message.peer_id}</span></span></span><span class="hljs-string">`</span></span>.replace(<span class="hljs-regexp"><span class="hljs-regexp">/[0-9]0+/</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> groupId: number = bot.settings.group_id; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> peerId + groupId; }</code> </pre> <br><p> æ­¤æ–¹æ³•å½“ç„¶ä¸æ˜¯å®Œç¾çš„ï¼Œä½†é€‚ç”¨äºå½“å‰ä»»åŠ¡ã€‚ </p><br></li><li><p>  <em>fullText</em>å’Œ<em>text</em> ã€‚ å¦‚å˜é‡å<em>æ‰€ç¤º</em> ï¼Œ <em>fullText</em>åŒ…å«æ¶ˆæ¯çš„<em>å…¨æ–‡</em> ï¼Œè€Œ<em>text</em>ä»…åŒ…å«å‘½ä»¤åç§°åçš„éƒ¨åˆ†ã€‚ </p><br></li></ol><br><p> è¿™å¾ˆæ–¹ä¾¿ï¼Œå› ä¸ºå®ƒå…è®¸æ‚¨ä½¿ç”¨ç°æˆçš„<em>æ–‡æœ¬</em>å­—æ®µæ¥è§£æå…¶ä¸­åŒ…å«çš„è¾…åŠ©ä¿¡æ¯ï¼Œä¾‹å¦‚äº‹ä»¶çš„æ—¥æœŸæˆ–æ’­æ”¾å™¨çš„åç§°ã€‚ </p><br><ol><li> ä¸Telegramä¸åŒï¼ŒVKæ¶ˆæ¯ä¸æ”¯æŒç”¨äºçªå‡ºæ˜¾ç¤º<code>&lt;b&gt;</code>æˆ–<code>&lt;i&gt;</code>ç±»çš„æ–‡æœ¬çš„æ ‡è®°é›†ï¼Œå› æ­¤ï¼Œåœ¨å“åº”æ—¶ï¼Œå¿…é¡»ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åˆ é™¤è¿™äº›æ ‡è®°ã€‚ </li></ol><br><h3 id="adaptery-dlya-priema-i-otpravki-soobscheniy"> æ¥æ”¶å’Œå‘é€æ¶ˆæ¯çš„é€‚é…å™¨ </h3><br><p> åœ¨ä¸ºç”µæŠ¥å’ŒVKæ¶ˆæ¯åˆ›å»ºæ¥å£å’Œæ•°æ®ç»“æ„ä¹‹åï¼Œå°±è¯¥å®ç°ç”¨äºå¤„ç†ä¼ å…¥äº‹ä»¶çš„æœåŠ¡äº†ã€‚ </p><br><p><img src="https://habrastorage.org/webt/gz/-z/2y/gz-z2y0x-x9_78hjdhg2mul9byu.jpeg" alt="å›¾ç‰‡"></p><br><p> è¿™äº›æœåŠ¡å¿…é¡»åˆå§‹åŒ–ç¬¬ä¸‰æ–¹æ¨¡å—ï¼Œä»¥ä¸Telegramå’ŒVK APIè¿›è¡Œäº¤äº’ï¼Œå¹¶å¯åŠ¨é•¿è½®è¯¢æœºåˆ¶ï¼Œå¹¶ä¸”åœ¨ä»æ¶ˆæ¯ä¼ é€’æœåŠ¡æ¥æ”¶æ•°æ®æ—¶ï¼Œè¾“å…¥å‘½ä»¤ä¸ç³»ç»Ÿä¸­å‘ç”Ÿçš„å†…éƒ¨äº‹ä»¶ä¹‹é—´å…·æœ‰è¿æ¥ã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">ç”µæŠ¥æœåŠ¡</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Telegraf <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'telegraf'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Injectable} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@nestjs/common'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> SocksAgent <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'socks5-https-client/lib/Agent'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {ConfigService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/config.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {AppEmitter} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/event-bus.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {TelegramMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./telegram.message'</span></span>; @Injectable() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TelegramService</span></span></span><span class="hljs-class"> </span></span>{ private bot: Telegraf&lt;any&gt;; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(config: ConfigService, appEmitter: AppEmitter) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> botToken: string = config.get(<span class="hljs-string"><span class="hljs-string">'TELEGRAM_BOT_TOKEN'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.bot = config.get(<span class="hljs-string"><span class="hljs-string">'TELEGRAM_USE_PROXY'</span></span>) ? <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Telegraf(botToken, { <span class="hljs-attr"><span class="hljs-attr">telegram</span></span>: {<span class="hljs-attr"><span class="hljs-attr">agent</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getProxy(config)}, }) : <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Telegraf(botToken); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getCommandEventMapping(appEmitter).forEach(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[command, event]</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.bot.command(command, ctx =&gt; { ctx.command = command; appEmitter.emit(event, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TelegramMessage(ctx)); }); }); } public launch(): <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.bot.launch(); } private getProxy(config: ConfigService): SocksAgent { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SocksAgent({ <span class="hljs-attr"><span class="hljs-attr">socksHost</span></span>: config.get(<span class="hljs-string"><span class="hljs-string">'TELEGRAM_PROXY_HOST'</span></span>), <span class="hljs-attr"><span class="hljs-attr">socksPort</span></span>: config.get(<span class="hljs-string"><span class="hljs-string">'TELEGRAM_PROXY_PORT'</span></span>), <span class="hljs-attr"><span class="hljs-attr">socksUsername</span></span>: config.get(<span class="hljs-string"><span class="hljs-string">'TELEGRAM_PROXY_LOGIN'</span></span>), <span class="hljs-attr"><span class="hljs-attr">socksPassword</span></span>: config.get(<span class="hljs-string"><span class="hljs-string">'TELEGRAM_PROXY_PASSWORD'</span></span>), }); } private getCommandEventMapping( appEmitter: AppEmitter, ): <span class="hljs-built_in"><span class="hljs-built_in">Array</span></span>&lt;[string, string]&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ [<span class="hljs-string"><span class="hljs-string">'event_add'</span></span>, appEmitter.EVENT_ADD], [<span class="hljs-string"><span class="hljs-string">'event_remove'</span></span>, appEmitter.EVENT_REMOVE], [<span class="hljs-string"><span class="hljs-string">'info'</span></span>, appEmitter.EVENT_INFO], [<span class="hljs-string"><span class="hljs-string">'add'</span></span>, appEmitter.PLAYER_ADD], [<span class="hljs-string"><span class="hljs-string">'remove'</span></span>, appEmitter.PLAYER_REMOVE], ]; } }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">VKæœåŠ¡</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> VkBot <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'node-vk-bot-api'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Injectable} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@nestjs/common'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {ConfigService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/config.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {AppEmitter} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/event-bus.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {VKMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./vk.message'</span></span>; @Injectable() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">VKService</span></span></span><span class="hljs-class"> </span></span>{ private bot: VkBot&lt;any&gt;; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(config: ConfigService, appEmitter: AppEmitter) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> botToken: string = config.get(<span class="hljs-string"><span class="hljs-string">'VK_TOKEN'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.bot = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> VkBot(botToken); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getCommandEventMapping(appEmitter).forEach(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[command, event]</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.bot.command(<span class="hljs-string"><span class="hljs-string">`/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${command}</span></span></span><span class="hljs-string">`</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> ctx =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">from</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.bot.execute(<span class="hljs-string"><span class="hljs-string">'users.get'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">user_ids</span></span>: ctx.message.from_id, }); ctx.message.from = <span class="hljs-keyword"><span class="hljs-keyword">from</span></span>; ctx.command = command; appEmitter.emit(event, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> VKMessage(ctx)); }); }); } public launch(): <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.bot.startPolling(); } private getCommandEventMapping( appEmitter: AppEmitter, ): <span class="hljs-built_in"><span class="hljs-built_in">Array</span></span>&lt;[string, string]&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ [<span class="hljs-string"><span class="hljs-string">'event_add'</span></span>, appEmitter.EVENT_ADD], [<span class="hljs-string"><span class="hljs-string">'event_remove'</span></span>, appEmitter.EVENT_REMOVE], [<span class="hljs-string"><span class="hljs-string">'info'</span></span>, appEmitter.EVENT_INFO], [<span class="hljs-string"><span class="hljs-string">'add'</span></span>, appEmitter.PLAYER_ADD], [<span class="hljs-string"><span class="hljs-string">'remove'</span></span>, appEmitter.PLAYER_REMOVE], ]; } }</code> </pre> </div></div><br><p> æ‚¨è¦æ³¨æ„çš„æ˜¯ï¼š </p><br><ol><li> ç”±äºè®¿é—®TelegramæœåŠ¡ï¼ˆhi Roskomnadzorï¼‰çš„æŸäº›é—®é¢˜ï¼Œæœ‰å¿…è¦é€‰æ‹©ä½¿ç”¨æä¾›<a href="https-client">socks5-https-client</a>è½¯ä»¶åŒ…çš„ä»£ç†ã€‚ </li><li> å¤„ç†äº‹ä»¶æ—¶ï¼Œä¼šå°†å­—æ®µä¸å‘½ä»¤çš„å€¼ä¸€èµ·æ·»åŠ åˆ°ä¸Šä¸‹æ–‡ä¸­ï¼Œè¯¥å‘½ä»¤çš„å€¼åŒ…å«æ¥æ”¶åˆ°è¯¥æ¶ˆæ¯çš„æ–‡æœ¬ã€‚ </li><li> å¯¹äºVKï¼Œæ‚¨å¿…é¡»ä½¿ç”¨å•ç‹¬çš„APIè°ƒç”¨åˆ†åˆ«ä¸‹è½½å‘é€æ¶ˆæ¯çš„ç”¨æˆ·çš„æ•°æ®ï¼š <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">from</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.bot.execute(<span class="hljs-string"><span class="hljs-string">'users.get'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">user_ids</span></span>: ctx.message.from_id, });</code> </pre> </li></ol><br><h3 id="model-dannyh"> èµ„æ–™æ¨¡å‹ </h3><br><p> ä¸ºäº†å®ç°æœºå™¨äººçš„å£°æ˜åŠŸèƒ½ï¼Œä¸‰ä¸ªæ¨¡å‹å°±è¶³å¤Ÿäº†ï¼š </p><br><ol><li>  <code>Chat</code> -èŠå¤©æˆ–å¯¹è¯ã€‚ </li><li>  <code>Event</code> -å®‰æ’åœ¨ç‰¹å®šæ—¥æœŸå’Œæ—¶é—´çš„èŠå¤©äº‹ä»¶ã€‚ </li><li>  <code>Player</code> -å‚åŠ æ´»åŠ¨çš„å‚ä¸è€…æˆ–å‚ä¸è€…ã€‚ </li></ol><br><p><img src="https://habrastorage.org/webt/yj/dc/rw/yjdcrwzw4bsie2im9fuelyb590k.jpeg" alt="æ•°æ®æ¨¡å¼"></p><br><p> ä½¿ç”¨<a href="https://www.npmjs.com/package/typeorm">typeorm</a>åº“çš„æ¨¡å‹å®ç°ä¸ºï¼š </p><br><div class="spoiler">  <b class="spoiler_title">èŠå¤©å®¤</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Entity, PrimaryGeneratedColumn, Column, OneToMany, JoinColumn, Index, } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'typeorm'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Event} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./event'</span></span>; @Entity() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Chat</span></span></span><span class="hljs-class"> </span></span>{ @PrimaryGeneratedColumn() id: number; @Index({<span class="hljs-attr"><span class="hljs-attr">unique</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>}) @Column() chatId: number; @OneToMany(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">type</span></span></span><span class="hljs-function"> =&gt;</span></span> Event, event =&gt; event.chat) @JoinColumn() events: Event[]; }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">å¤§äº‹è®°</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Entity, PrimaryGeneratedColumn, Column, OneToMany, ManyToOne, JoinColumn, } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'typeorm'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Chat} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./chat'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Player} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./player'</span></span>; @Entity() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Event</span></span></span><span class="hljs-class"> </span></span>{ @PrimaryGeneratedColumn() id: number; @Column() date: <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>; @Column() active: boolean; @ManyToOne(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">type</span></span></span><span class="hljs-function"> =&gt;</span></span> Chat, chat =&gt; chat.events) chat: Chat; @OneToMany(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">type</span></span></span><span class="hljs-function"> =&gt;</span></span> Player, player =&gt; player.event) @JoinColumn() players: Player[]; }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">æ’­æ”¾å™¨</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Entity, PrimaryGeneratedColumn, Column, ManyToOne, JoinColumn, } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'typeorm'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Event} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./event'</span></span>; @Entity() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Player</span></span></span><span class="hljs-class"> </span></span>{ @PrimaryGeneratedColumn() id: number; @Column() name: string; @ManyToOne(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">type</span></span></span><span class="hljs-function"> =&gt;</span></span> Event, event =&gt; event.players) @JoinColumn() event: Event; }</code> </pre> </div></div><br><p> åœ¨è¿™é‡Œï¼Œæœ‰å¿…è¦åœ¨æ“çºµ<em>èŠå¤©</em> ï¼Œ <em>äº‹ä»¶</em>å’Œ<em>ç©å®¶</em>æ¨¡å‹æ–¹é¢å†æ¬¡è®¨è®ºè¯¥æœºå™¨äººé’ˆå¯¹å„ä¸ªå›¢é˜Ÿçš„æœºåˆ¶ã€‚ </p><br><ol><li> æ”¶åˆ°ä»»ä½•å‘½ä»¤åï¼Œå°†ä½¿ç”¨<code>chatId</code>æ£€æŸ¥æ•°æ®åº“ä¸­æ˜¯å¦å­˜åœ¨èŠå¤©ã€‚ å¦‚æœæ²¡æœ‰ç›¸åº”çš„è®°å½•ï¼Œåˆ™åˆ›å»ºå®ƒã€‚ </li><li> ä¸ºäº†ç®€åŒ–é€»è¾‘ï¼Œæ¯æ¬¡èŠå¤©åªèƒ½æœ‰ä¸€ä¸ªæ´»åŠ¨äº‹ä»¶ï¼ˆ <em>Event</em> ï¼‰ã€‚ å³  <code>/event_add</code>å‘½ä»¤æ—¶ï¼Œå°†åœ¨ç³»ç»Ÿä¸­åˆ›å»ºä¸€ä¸ªå…·æœ‰æŒ‡å®šæ—¥æœŸçš„æ–°æ´»åŠ¨äº‹ä»¶ <br> å½“å‰æ´»åŠ¨äº‹ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰å˜ä¸ºéæ´»åŠ¨çŠ¶æ€ã€‚ </li><li>  <code>/event_remove</code>åœ¨å½“å‰èŠå¤©ä¸­æ‰¾åˆ°æ´»åŠ¨äº‹ä»¶å¹¶å°†å…¶åœç”¨ã€‚ </li><li>  <code>/info</code>åœ¨å½“å‰èŠå¤©ä¸­æŸ¥æ‰¾ä¸€ä¸ªæ´»åŠ¨äº‹ä»¶ï¼Œæ˜¾ç¤ºæœ‰å…³æ­¤äº‹ä»¶çš„ä¿¡æ¯ä»¥åŠç©å®¶åˆ—è¡¨ï¼ˆ <em>Player</em> ï¼‰ã€‚ </li><li>  <code>/add</code>å’Œ<code>/remove</code>æ´»åŠ¨äº‹ä»¶ï¼Œå¹¶ä»ä¸­æ·»åŠ å’Œåˆ é™¤æ’­æ”¾å™¨ã€‚ </li></ol><br><p> ç”¨äºå¤„ç†æ•°æ®çš„ç›¸åº”æœåŠ¡å¦‚ä¸‹ï¼š </p><br><div class="spoiler">  <b class="spoiler_title">å­˜å‚¨æœåŠ¡</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Injectable} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@nestjs/common'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {InjectConnection} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@nestjs/typeorm'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Connection, Repository, UpdateResult} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'typeorm'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Chat} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./models/chat'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Event} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./models/event'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Player} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./models/player'</span></span>; @Injectable() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StorageService</span></span></span><span class="hljs-class"> </span></span>{ private chatRepository: Repository&lt;Chat&gt;; private eventRepository: Repository&lt;Event&gt;; private playerRepository: Repository&lt;Player&gt;; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(@InjectConnection() private readonly dbConnection: Connection) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.chatRepository = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dbConnection.getRepository(Chat); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.eventRepository = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dbConnection.getRepository(Event); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerRepository = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dbConnection.getRepository(Player); } public get connection() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dbConnection; } public <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> ensureChat(chatId: number): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;Chat&gt; { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> chat: Chat = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.chatRepository.findOne({chatId}); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (chat) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> chat; } chat = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Chat(); chat.chatId = chatId; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.chatRepository.save(chat); } public markChatEventsInactive(chat: Chat): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;UpdateResult&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dbConnection .createQueryBuilder() .update(Event) .set({<span class="hljs-attr"><span class="hljs-attr">active</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>}) .where({chat}) .execute(); } public appendChatActiveEvent(chat: Chat, <span class="hljs-attr"><span class="hljs-attr">date</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;Event&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> event: Event = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Event(); event.chat = chat; event.active = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; event.date = date; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.eventRepository.save(event); } public findChatActiveEvent(chat: Chat): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;Event | <span class="hljs-literal"><span class="hljs-literal">null</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.eventRepository.findOne({<span class="hljs-attr"><span class="hljs-attr">where</span></span>: {chat, <span class="hljs-attr"><span class="hljs-attr">active</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>}}); } public getPlayers(event: Event): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;Player[]&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerRepository.find({<span class="hljs-attr"><span class="hljs-attr">where</span></span>: {event}}); } public findPlayer(event: Event, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: string): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;Player | <span class="hljs-literal"><span class="hljs-literal">null</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerRepository.findOne({<span class="hljs-attr"><span class="hljs-attr">where</span></span>: {event, name}}); } public addPlayer(event: Event, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: string): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;Player&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> player: Player = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Player(); player.event = event; player.name = name; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerRepository.save(player); } public removePlayer(player: Player): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;Player&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerRepository.remove(player); } }</code> </pre> </div></div><br><h3 id="shablonizaciya-otvetov"> èŒƒæœ¬å›åº” </h3><br><p> é™¤äº†ä¸Šè¿°ç”¨äºå¤„ç†æ•°æ®çš„<em>StorageService</em>æœåŠ¡ä¹‹å¤–ï¼Œè¿˜éœ€è¦å®ç°ä¸“ç”¨çš„<em>TemplateService</em>æœåŠ¡ï¼Œè¯¥æœåŠ¡ç›®å‰çš„ä»»åŠ¡æ˜¯ï¼š </p><br><ol><li> ä¸‹è½½å¹¶ç¼–è¯‘<a href="https://handlebarsjs.com/">è½¦æŠŠ</a>æ¨¡æ¿ï¼Œä»¥è·å–ä¸åŒè¯­è¨€çš„å„ç§å‘½ä»¤çš„ç­”æ¡ˆé€‰é¡¹ã€‚ </li><li> æ ¹æ®å½“å‰äº‹ä»¶ï¼Œå“åº”çŠ¶æ€å’Œç”¨æˆ·è¯­è¨€é€‰æ‹©åˆé€‚çš„æ¨¡æ¿ã€‚ </li><li> ä½¿ç”¨å‘½ä»¤è·å¾—çš„æ•°æ®å¡«å……æ¨¡æ¿ã€‚ </li></ol><br><div class="spoiler">  <b class="spoiler_title">æ¨¡æ¿æœåŠ¡</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> path <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'path'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> fs <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'fs'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> handlebars <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'handlebars'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {readDirDeepSync} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'read-dir-deep'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Injectable, Logger} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@nestjs/common'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> interface IParams { <span class="hljs-attr"><span class="hljs-attr">action</span></span>: string; status: string; lang?: string; } @Injectable() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TemplateService</span></span></span><span class="hljs-class"> </span></span>{ private readonly DEFAULT_LANG: string = <span class="hljs-string"><span class="hljs-string">'en'</span></span>; private readonly TEMPLATE_PATH: string = <span class="hljs-string"><span class="hljs-string">'templates'</span></span>; private logger: Logger; private templatesMap: <span class="hljs-built_in"><span class="hljs-built_in">Map</span></span>&lt;string, (d: any) =&gt; string&gt;; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(logger: Logger) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.logger = logger; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.load(); } public apply(params: IParams, <span class="hljs-attr"><span class="hljs-attr">data</span></span>: any): string { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.logger.log( <span class="hljs-string"><span class="hljs-string">`apply template: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${params.action}</span></span></span><span class="hljs-string"> </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${params.status}</span></span></span><span class="hljs-string"> </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${params.lang}</span></span></span><span class="hljs-string">`</span></span>, ); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> template = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getTemplate(params); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!template) { params.lang = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.DEFAULT_LANG; template = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getTemplate(params); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!template) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(<span class="hljs-string"><span class="hljs-string">'template-not-found'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> template(data); } private getTemplate(params: IParams): <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data: any</span></span></span><span class="hljs-function">) =&gt;</span></span> string { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> {lang, action, status} = params; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.templatesMap.get(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getTemplateKey(lang, action, status)); } private load() { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> templatesDir: string = path.join( process.cwd(), <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.TEMPLATE_PATH, ); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> templateFileNames: string[] = readDirDeepSync(templatesDir); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.templatesMap = templateFileNames.reduce(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">acc, fileName</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> template = fs.readFileSync(fileName, {<span class="hljs-attr"><span class="hljs-attr">encoding</span></span>: <span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>}); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> [, lang, action, status] = fileName .replace(<span class="hljs-regexp"><span class="hljs-regexp">/\.hbs$/</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>) .split(<span class="hljs-string"><span class="hljs-string">'/'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> acc.set( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getTemplateKey(lang, action, status), handlebars.compile(template), ); }, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Map</span></span>()); } private getTemplateKey( lang: string, <span class="hljs-attr"><span class="hljs-attr">action</span></span>: string, <span class="hljs-attr"><span class="hljs-attr">status</span></span>: string, ): string { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${lang}</span></span></span><span class="hljs-string">-</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${action}</span></span></span><span class="hljs-string">-</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${status}</span></span></span><span class="hljs-string">`</span></span>; } }</code> </pre> </div></div><br><p> æ‚¨è¦æ³¨æ„çš„æ˜¯ï¼š </p><br><ol><li><p> æ¨¡æ¿æ–‡ä»¶ä½äºé¡¹ç›®æ ¹ç›®å½•ä¸‹å•ç‹¬çš„<code>./templates</code>ç›®å½•ä¸­ï¼Œå¹¶ç”±è¯­è¨€ï¼Œæ“ä½œï¼ˆå‘½ä»¤ï¼‰å’Œå“åº”çŠ¶æ€æ„æˆã€‚ </p><br><pre> <code class="plaintext hljs">- templates - en - event_add - invalid_date.hbs - success.hbs - event_info - ru</code> </pre> <br><p> åˆå§‹åŒ–åº”ç”¨ç¨‹åºåï¼Œæ‰€æœ‰å“åº”æ¨¡æ¿éƒ½å°†åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œå¹¶ä½¿ç”¨å”¯ä¸€æ ‡è¯†è¯¥æ¨¡æ¿çš„é”®å¡«å……Mapï¼š </p><br><pre> <code class="javascript hljs">private getTemplateKey(lang: string, <span class="hljs-attr"><span class="hljs-attr">action</span></span>: string, <span class="hljs-attr"><span class="hljs-attr">status</span></span>: string): string { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${lang}</span></span></span><span class="hljs-string">-</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${action}</span></span></span><span class="hljs-string">-</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${status}</span></span></span><span class="hljs-string">`</span></span>; }</code> </pre> <br></li><li><p> å½“å‰ï¼Œè¯¥ç³»ç»Ÿå…·æœ‰2å¥—æ¨¡æ¿ï¼šä¿„è¯­å’Œè‹±è¯­ã€‚ <br> åœ¨ç¼ºå°‘å½“å‰äº‹ä»¶è¯­è¨€æ‰€éœ€çš„æ¨¡æ¿çš„æƒ…å†µä¸‹ï¼Œä»¥é»˜è®¤è¯­è¨€ï¼ˆè‹±è¯­ï¼‰æä¾›åå¤‡å¹¿å‘Šã€‚ </p><br></li><li><p>  <a href="https://handlebarsjs.com/">è½¦æŠŠ</a>æ¨¡æ¿æœ¬èº«ï¼Œä¾‹å¦‚ï¼š </p><br><pre> <code class="plaintext hljs">Player &lt;strong&gt;{{name}}&lt;/strong&gt; will take part in the game List of players: {{#each players}} {{index}}: &lt;i&gt;{{name}}&lt;/i&gt; {{/each}} Total: &lt;strong&gt;{{total}}&lt;/strong&gt;</code> </pre> <br><p> åŒæ—¶åŒ…å«ä¼ ç»Ÿçš„å ä½ç¬¦å’Œä¸€<a href="https://tlgrm.ru/docs/bots/api">ç»„æœ‰æ•ˆçš„æ ‡è®°ï¼Œ</a>ç”¨äºæ ¼å¼åŒ–Telegramä¸­çš„å“åº”ã€‚ </p><br></li></ol><br><h3 id="servisy-obrabotki-komand-actions"> å‘½ä»¤å¤„ç†æœåŠ¡ï¼ˆæ“ä½œï¼‰ </h3><br><p> ç°åœ¨å·²ç»ä»‹ç»äº†åŸºæœ¬æ”¯æŒæœåŠ¡ï¼Œæ˜¯æ—¶å€™ç»§ç»­å®æ–½è¯¥æœºå™¨äººçš„ä¸šåŠ¡é€»è¾‘æœ¬èº«äº†ã€‚ è¿™äº›æ¨¡å—ä¹‹é—´çš„è¿æ¥ç¤ºæ„å›¾å¦‚ä¸‹ï¼š </p><br><p><img src="https://habrastorage.org/webt/b3/xl/vl/b3xlvlw5qc93vkc3n-nylnjwpqa.jpeg" alt="è¡ŒåŠ¨"></p><br><p>  <em>BaseAction</em>åŸºç±»çš„ä»»åŠ¡åŒ…æ‹¬ï¼š </p><br><ol><li> ä»<em>AppEmitter</em>è®¢é˜…ç‰¹å®šäº‹ä»¶ã€‚ </li><li> äº‹ä»¶å¤„ç†çš„æ•´ä½“åŠŸèƒ½ï¼Œå³ï¼š <br><ul><li> æœç´¢å°†è¦å¤„ç†çš„å›¢é˜Ÿä¸­ç°æœ‰çš„èŠå¤©å®¤æˆ–åˆ›å»ºæ–°çš„èŠå¤©å®¤ </li><li> è°ƒç”¨<code>doAction</code>æ¨¡æ¿æ–¹æ³•<code>doAction</code>è¯¥æ–¹æ³•<code>doAction</code>å®ç°å¯¹äºç»§æ‰¿<em>BaseActionçš„</em>æ¯ä¸ªç±»éƒ½æ˜¯å•ç‹¬çš„ã€‚ </li><li> ä½¿ç”¨<em>TemplateService</em>å°†æ¨¡æ¿åº”ç”¨äºç”Ÿæˆçš„<code>doAction</code>å“åº”ã€‚ </li></ul></li></ol><br><div class="spoiler">  <b class="spoiler_title">åŸºæœ¬åŠ¨ä½œ</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Injectable, Logger} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@nestjs/common'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {IMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../message/i-message'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {ConfigService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/config.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {AppEmitter} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/event-bus.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {TemplateService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/template.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {StorageService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/storage.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Chat} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/chat'</span></span>; @Injectable() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseAction</span></span></span><span class="hljs-class"> </span></span>{ protected appEmitter: AppEmitter; protected config: ConfigService; protected logger: Logger; protected templateService: TemplateService; protected storageService: StorageService; protected event: string; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>( config: ConfigService, appEmitter: AppEmitter, logger: Logger, templateService: TemplateService, storageService: StorageService, ) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.config = config; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.logger = logger; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.appEmitter = appEmitter; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.templateService = templateService; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService = storageService; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.setEvent(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.logger.log(<span class="hljs-string"><span class="hljs-string">`subscribe on "</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${</span></span><span class="hljs-keyword"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-string"><span class="hljs-subst">.event}</span></span></span><span class="hljs-string">" event`</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.appEmitter.on(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.event, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.handleEvent.bind(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>)); } protected setEvent(): <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(<span class="hljs-string"><span class="hljs-string">'not implemented'</span></span>); } protected <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> doAction(chat: Chat, <span class="hljs-attr"><span class="hljs-attr">message</span></span>: IMessage): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;IMessage&gt; { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(<span class="hljs-string"><span class="hljs-string">'not implemented'</span></span>); } private <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> handleEvent(message: IMessage) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.logger.log(<span class="hljs-string"><span class="hljs-string">`"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${</span></span><span class="hljs-keyword"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-string"><span class="hljs-subst">.event}</span></span></span><span class="hljs-string">" event received`</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> chatId: number = message.chatId; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> chat: Chat = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.ensureChat(chatId); message = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.doAction(chat, message); message.answer( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.templateService.apply( { <span class="hljs-attr"><span class="hljs-attr">action</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.event, <span class="hljs-attr"><span class="hljs-attr">status</span></span>: message.getReplyStatus(), <span class="hljs-attr"><span class="hljs-attr">lang</span></span>: message.lang, }, message.getReplyData(), ), ); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (error) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.logger.error(error); message.answer(error.message); } } }</code> </pre> </div></div><br><p>  <em>BaseAction</em>å­ç±»çš„ä»»åŠ¡æ˜¯æ‰§è¡Œè¾“å…¥çš„<code>doAction</code>æ–¹æ³•ï¼š </p><br><ol><li> åœ¨åŸºç±»ä¸­åˆ›å»ºæˆ–å®šä¹‰çš„<em>èŠå¤©</em> </li><li> ç¬¦åˆ<em>IMessage</em>åè®®çš„å¯¹è±¡ã€‚ </li></ol><br><p> ä½œä¸ºæ‰§è¡Œæ­¤æ–¹æ³•çš„ç»“æœï¼Œè¿˜å°†è¿”å›<em>IMessage</em> ï¼Œä½†æ˜¯<em>IMessage</em>å…·æœ‰ç¡®å®šçš„çŠ¶æ€ï¼Œç”¨äºé€‰æ‹©æ­£ç¡®çš„æ¨¡æ¿ä»¥åŠå°†å‚ä¸å“åº”æ¨¡æ¿çš„æ•°æ®ã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">EventAddAction</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Injectable} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@nestjs/common'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> statuses <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./statuses'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {parseEventDate, formatEventDate} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/utils'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {BaseAction} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./base.action'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Chat} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/chat'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Event} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/event'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {IMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../message/i-message'</span></span>; @Injectable() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EventAddAction</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseAction</span></span></span><span class="hljs-class"> </span></span>{ protected setEvent(): <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.event = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.appEmitter.EVENT_ADD; } protected <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> doAction(chat: Chat, <span class="hljs-attr"><span class="hljs-attr">message</span></span>: IMessage): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;IMessage&gt; { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.markChatEventsInactive(chat); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> eventDate: <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span> = parseEventDate(message.text.trim()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!eventDate) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message.setStatus(statuses.STATUS_INVALID_DATE); } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> event: Event = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.appendChatActiveEvent( chat, eventDate, ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message.setStatus(statuses.STATUS_SUCCESS).withData({ <span class="hljs-attr"><span class="hljs-attr">date</span></span>: formatEventDate(event.date), }); } }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">EventRemoveAction</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Injectable} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@nestjs/common'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> statuses <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./statuses'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {formatEventDate} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/utils'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {BaseAction} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./base.action'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Chat} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/chat'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Event} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/event'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {IMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../message/i-message'</span></span>; @Injectable() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EventRemoveAction</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseAction</span></span></span><span class="hljs-class"> </span></span>{ protected setEvent(): <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.event = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.appEmitter.EVENT_REMOVE; } protected <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> doAction(chat: Chat, <span class="hljs-attr"><span class="hljs-attr">message</span></span>: IMessage): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;IMessage&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> activeEvent: Event = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.findChatActiveEvent( chat, ); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.markChatEventsInactive(chat); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (activeEvent) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message.setStatus(statuses.STATUS_SUCCESS).withData({ <span class="hljs-attr"><span class="hljs-attr">date</span></span>: formatEventDate(activeEvent.date), }); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message.setStatus(statuses.STATUS_NO_EVENT); } } }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">EventInfoAction</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Injectable, Logger} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@nestjs/common'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> statuses <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./statuses'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {formatEventDate} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/utils'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {ConfigService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/config.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {AppEmitter} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/event-bus.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {TemplateService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/template.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {StorageService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/storage.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {BaseAction} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./base.action'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {PlayerHelper} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./player.helper'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Chat} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/chat'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Event} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/event'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Player} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/player'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {IMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../message/i-message'</span></span>; @Injectable() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EventInfoAction</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseAction</span></span></span><span class="hljs-class"> </span></span>{ private playerHelper: PlayerHelper; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>( config: ConfigService, appEmitter: AppEmitter, logger: Logger, templateService: TemplateService, playerHelper: PlayerHelper, storageService: StorageService, ) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(config, appEmitter, logger, templateService, storageService); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerHelper = playerHelper; } protected setEvent(): <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.event = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.appEmitter.EVENT_INFO; } protected <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> doAction(chat: Chat, <span class="hljs-attr"><span class="hljs-attr">message</span></span>: IMessage): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;IMessage&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> activeEvent: Event = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.findChatActiveEvent( chat, ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!activeEvent) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message.setStatus(statuses.STATUS_NO_EVENT); } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> players: Player[] = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.getPlayers( activeEvent, ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message.setStatus(statuses.STATUS_SUCCESS).withData({ <span class="hljs-attr"><span class="hljs-attr">date</span></span>: formatEventDate(activeEvent.date), ...(<span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerHelper.getPlayersList(activeEvent)), }); } }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">PlayerAddAction</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Injectable, Logger} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@nestjs/common'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> statuses <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./statuses'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {ConfigService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/config.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {AppEmitter} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/event-bus.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {TemplateService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/template.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {StorageService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/storage.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {BaseAction} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./base.action'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {PlayerHelper} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./player.helper'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Chat} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/chat'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Event} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/event'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Player} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/player'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {IMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../message/i-message'</span></span>; @Injectable() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PlayerAddAction</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseAction</span></span></span><span class="hljs-class"> </span></span>{ private playerHelper: PlayerHelper; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>( config: ConfigService, appEmitter: AppEmitter, logger: Logger, templateService: TemplateService, playerHelper: PlayerHelper, storageService: StorageService, ) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(config, appEmitter, logger, templateService, storageService); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerHelper = playerHelper; } protected setEvent(): <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.event = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.appEmitter.PLAYER_ADD; } protected <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> doAction(chat: Chat, <span class="hljs-attr"><span class="hljs-attr">message</span></span>: IMessage): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;IMessage&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> activeEvent: Event = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.findChatActiveEvent( chat, ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!activeEvent) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message.setStatus(statuses.STATUS_NO_EVENT); } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> name: string = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerHelper.getPlayerName(message); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> existedPlayer: Player = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.findPlayer( activeEvent, name, ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (existedPlayer) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message .setStatus(statuses.STATUS_ALREADY_ADDED) .withData({name}); } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> newPlayer: Player = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.addPlayer( activeEvent, name, ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message.setStatus(statuses.STATUS_SUCCESS).withData({ <span class="hljs-attr"><span class="hljs-attr">name</span></span>: newPlayer.name, ...(<span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerHelper.getPlayersList(activeEvent)), }); } }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">PlayerRemoveAction</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Injectable, Logger} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@nestjs/common'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> statuses <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./statuses'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {ConfigService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/config.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {AppEmitter} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/event-bus.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {TemplateService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/template.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {StorageService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/storage.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {BaseAction} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./base.action'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {PlayerHelper} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./player.helper'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Chat} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/chat'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Event} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/event'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Player} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/player'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {IMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../message/i-message'</span></span>; @Injectable() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PlayerRemoveAction</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseAction</span></span></span><span class="hljs-class"> </span></span>{ private playerHelper: PlayerHelper; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>( config: ConfigService, appEmitter: AppEmitter, logger: Logger, templateService: TemplateService, playerHelper: PlayerHelper, storageService: StorageService, ) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(config, appEmitter, logger, templateService, storageService); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerHelper = playerHelper; } protected setEvent(): <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.event = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.appEmitter.PLAYER_REMOVE; } protected <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> doAction(chat: Chat, <span class="hljs-attr"><span class="hljs-attr">message</span></span>: IMessage): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;IMessage&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> activeEvent: Event = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.findChatActiveEvent( chat, ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!activeEvent) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message.setStatus(statuses.STATUS_NO_EVENT); } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> name: string = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerHelper.getPlayerName(message); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> existedPlayer: Player = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.findPlayer( activeEvent, name, ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!existedPlayer) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message .setStatus(statuses.STATUS_NO_PLAYER) .withData({name}); } <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.removePlayer(existedPlayer); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message.setStatus(statuses.STATUS_SUCCESS).withData({ name, ...(<span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerHelper.getPlayersList(activeEvent)), }); } }</code> </pre> </div></div><br><p> æ‚¨è¦æ³¨æ„çš„æ˜¯ï¼š </p><br><ol><li>  <code>/add</code>å’Œ<code>/remove</code>å‘½ä»¤æ·»åŠ /åˆ é™¤åç§°åœ¨å‘½ä»¤åé¢çš„æ’­æ”¾å™¨ã€‚ å¦‚æœæœªæŒ‡å®šåç§°ï¼Œåˆ™ä¼šæ·»åŠ /åˆ é™¤å‘¼å«å›¢é˜Ÿçš„çƒå‘˜ã€‚ </li><li> å“åº”<code>/add</code> ï¼Œ <code>/remove</code>å’Œ<code>/info</code>å‘½ä»¤ï¼Œå°†æ˜¾ç¤ºæ´»åŠ¨äº‹ä»¶çš„ç©å®¶æ›´æ–°åˆ—è¡¨ã€‚ </li></ol><br><p> å®ç°ï¼ˆ1ï¼‰å’Œï¼ˆ2ï¼‰æ‰€éœ€çš„åŠŸèƒ½å·²ç§»è‡³ç‰¹æ®Šçš„è¾…åŠ©ç±»ï¼š </p><br><div class="spoiler">  <b class="spoiler_title">PlayerHelper</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Injectable} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@nestjs/common'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {StorageService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/storage.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Event} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/event'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Player} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/player'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {IMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../message/i-message'</span></span>; @Injectable() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PlayerHelper</span></span></span><span class="hljs-class"> </span></span>{ protected storageService: StorageService; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(storageService: StorageService) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService = storageService; } public getPlayerName(message: IMessage) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> name = message.text.trim(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> name.length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> ? name : message.name; } public <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> getPlayersList(event: Event) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> players: Player[] = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.getPlayers(event); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">total</span></span>: players.length, <span class="hljs-attr"><span class="hljs-attr">players</span></span>: players.map(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">player, index</span></span></span><span class="hljs-function">) =&gt;</span></span> ({ <span class="hljs-attr"><span class="hljs-attr">index</span></span>: index + <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: player.name, })), }; } }</code> </pre></div></div><br><h3 id="sobiraem-vse-vmeste"> å…¨éƒ¨æ”¾åœ¨ä¸€èµ· </h3><br><p> å¦‚æœ¬æ–‡å¼€å¤´æ‰€è¿°ï¼Œ <a href="https://nestjs.com/">NestJS</a>æ¡†æ¶ç”¨ä½œåº”ç”¨ç¨‹åºæ¡†æ¶ã€‚ ä¸€æ¬¡ï¼Œæˆ‘å¾ˆå¹¸è¿èƒ½äº²è‡ªå‚åŠ è¿™ä¸ªå¥‡å¦™å›¾ä¹¦é¦†åˆ›å»ºè€…çš„<a href="https://www.youtube.com/watch%3Fv%3Djo-1EUxMmxc">æŠ¥å‘Š</a> ã€‚ </p><br><p> è®¸å¤šNodeJSæ ·æ¿æ–‡ä»¶ï¼Œæ‰‹å†Œå’Œåº“ç»å¸¸å› ä¸æä¾›ä»»ä½•åˆç†çš„åˆå§‹åŒ–ç­–ç•¥å’Œæ¨¡å—ä¹‹é—´çš„è¿æ¥è€Œå¸¦æ¥éº»çƒ¦ã€‚ éšç€åº”ç”¨ç¨‹åºçš„å¢é•¿ï¼Œåœ¨æ²¡æœ‰é€‚å½“æ³¨æ„çš„æƒ…å†µä¸‹ï¼Œä»£ç åº“å˜æˆäº†æ¨¡å—ä¹‹é—´çš„require-sæ··æ‚ï¼Œé€šå¸¸ç”šè‡³å¯¼è‡´å¾ªç¯ä¾èµ–æˆ–å…³ç³»ï¼Œè€ŒåŸåˆ™ä¸Šä¸åº”è¿™æ ·åšã€‚        Dependency Injection   <a href="https://www.npmjs.com/package/awilix">awilix</a> ,  <a href="https://nestjs.com/">NestJS</a>  . </p><br><p>   DI      ,    NodeJS ,            ,        . </p><br><p><img src="https://habrastorage.org/webt/l2/gq/lc/l2gqlc0vig_zsywifjjopmt_4wc.jpeg" alt="  "></p><br><h2 id="konfiguraciya">  </h2><br><p>            . </p><br><ol><li> <code>TELEGRAM_BOT_TOKEN</code> â€”    Telegram . </li><li> <code>TELEGRAM_USE_PROXY</code> â€”          TelegramAPI. </li><li> <code>TELEGRAM_PROXY_HOST</code> â€”       TelegramAPI. </li><li> <code>TELEGRAM_PROXY_PORT</code> â€”       TelegramAPI. </li><li> <code>TELEGRAM_PROXY_LOGIN</code> â€”       TelegramAPI. </li><li> <code>TELEGRAM_PROXY_PASSWORD</code> â€”       TelegramAPI. </li><li> <code>VK_TOKEN</code> â€”    VK . </li><li> <code>DATABASE_URL</code> â€”    .   production . </li></ol><br><p>      : </p><br><ol><li> <code>TELEGRAM_BOT_TOKEN</code>       <a href="https://tlgrm.ru/docs/bots"> </a>      Telegram. </li><li> <code>VK_TOKEN</code> â€”    ,  VK    . å³    ,             .       <a href="https://vk.com/dev/bots_docs">  </a>  . </li><li> <code>DATABASE_URL</code> â€”  production      PostgreSQL.          DBaaS   <a href="https://www.elephantsql.com/">elephantsql</a>   . </li></ol><br><h2 id="ci"> CI </h2><br><p> " -   â€”   ".    ,       <a href="https://travis-ci.org/">TravisCI</a>       : </p><br><pre> <code class="plaintext hljs">language: node_js node_js: - '8' - '10' - '12' script: - npm run lint - npm run build - npm run test:cov after_script: - npm install -g codecov - codecov</code> </pre> <br><p>                      <a href="https://codecov.io/">codecov</a> . </p><br><p>    <a href="https://www.docker.com/">Docker</a>      <a href="https://hub.docker.com/">Docker Hub</a>        <a href="https://habr.com/ru/users/Gonf/">Gonf</a>    <a href="https://habr.com/ru/post/476368/">  CI/CD   GitHub Actions  Python</a> .         Continuous Deployment,       Github: </p><br><pre> <code class="plaintext hljs">name: Release on: release: types: [published] jobs: build: runs-on: ubuntu-latest env: LOGIN: ${{ secrets.DOCKER_LOGIN }} NAME: ${{ secrets.DOCKER_NAME }} steps: - uses: actions/checkout@v1 - name: Install Node.js uses: actions/setup-node@v1 - name: Login to docker.io run: echo ${{ secrets.DOCKER_PWD }} | docker login -u ${{ secrets.DOCKER_LOGIN }} --password-stdin - name: npm install and build run: npm ci &amp;&amp; npm run build - name: Build the Docker image run: docker build -t $LOGIN/$NAME:${GITHUB_REF:10} -f Dockerfile . - name: Push image to docker.io run: docker push $LOGIN/$NAME:${GITHUB_REF:10}</code> </pre> <br><h2 id="rezultat-i-vyvody">    </h2><br><p>     .  Telegram     : <br>        . </p><br><p><img src="https://habrastorage.org/webt/mi/tr/nb/mitrnbq3hcwu33lizpvmbxuirl0.png" alt="demo1"></p><br><p>    . </p><br><p><img src="https://habrastorage.org/webt/4v/y-/lk/4vy-lkg-dungqdpmbou0gop2w4e.png" alt="demo2"></p><br><p>      . </p><br><p><img src="https://habrastorage.org/webt/w8/i2/oo/w8i2oog_swdu2sjvqsqihwu8ww4.png" alt="demo3"></p><br><p>     VK      <code>&lt;b&gt;</code>  <code>&lt;i&gt;</code> . <br>        . </p><br><p><img src="https://habrastorage.org/webt/ak/cu/fo/akcufo-5cwygqzcdfysm-uytzdi.png" alt="demo4"></p><br><p>      . </p><br><p><img src="https://habrastorage.org/webt/pg/ye/c7/pgyec7wg7kgltgjk7ton5wc7w64.png" alt="demo6"></p><br><p>   <a href="https://www.viber.com/">Viber</a> ,              .         ,    <a href="https://www.viber.com/">Viber</a>   webhooks  long-polling.    ,    Viber         .       <a href="https://github.com/Viber/sample-bot-isitup/issues/2"></a> .          (?) . </p><br><p>  Telegram            <code>@Tormozz48bot</code> . </p><br><p>     <a href="https://github.com/tormozz48/football-chat-bot-2"> Github</a> .   ,   . </p><br><p> PS    . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN483194/">https://habr.com/ru/post/zh-CN483194/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN483178/index.html">è¿™æ˜¯Flutter 1.9å‘è¡Œç‰ˆä¸Dart 2.5ç¼–ç¨‹ç»“åˆçš„æ›´æ–°</a></li>
<li><a href="../zh-CN483182/index.html">ä½¿ç”¨Array.reduceï¼ˆï¼‰çš„äº”ç§æœ‰è¶£æ–¹å¼ï¼ˆä¸€ç§æ— èŠçš„æ–¹å¼ï¼‰</a></li>
<li><a href="../zh-CN483184/index.html">è‡ªåŠ¨å°†ä»£ç å‡çº§åˆ°TensorFlow 2</a></li>
<li><a href="../zh-CN483186/index.html">Java 13ç®€ä»‹ï¼šè®©æˆ‘ä»¬æ·±å…¥äº†è§£JDKçš„æ–°åŠŸèƒ½</a></li>
<li><a href="../zh-CN483190/index.html">3CXæŠ€æœ¯æ”¯æŒç­”æ¡ˆï¼šä»ä»¥å‰çš„ç‰ˆæœ¬å‡çº§åˆ°3CX v16</a></li>
<li><a href="../zh-CN483198/index.html">é˜¿é‡Œäº‘å¦‚ä½•é€šè¿‡... Kubernetesç®¡ç†æ•°ä¸‡ä¸ªKubernetesé›†ç¾¤</a></li>
<li><a href="../zh-CN483202/index.html">REST APIç®€ä»‹-RESTful WebæœåŠ¡</a></li>
<li><a href="../zh-CN483204/index.html">RESTå’ŒSOAPä¹‹é—´çš„åŒºåˆ«</a></li>
<li><a href="../zh-CN483206/index.html">REST APIå¼€å‘-ä»€ä¹ˆæ˜¯åˆåŒç¬¬ä¸€ï¼Ÿ</a></li>
<li><a href="../zh-CN483208/index.html">å›é¡¾Kaggle MLï¼†DS Survey2019ã€‚æˆ–è€…MLä¸“å®¶èµšå¤šå°‘é’±</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>