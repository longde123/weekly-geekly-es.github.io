<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🕦 💿 👨‍👨‍👧‍👦 机器人收费。 用新技术去踢足球 👩🏻‍🤝‍👨🏾 👧 👨🏽‍⚕️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="引言 


 大家好 在本文中，我将介绍使用NodeJS的电报消息传递服务和VK社交网络的聊天机器人。 


 在这一点上，许多读者应该提出类似的内容：“多长时间！” 或“又是什么？！” 
 是的，类似的出版物已经备受关注。 但是，尽管如此，我认为这篇文章还是有用的。 简要介绍一下该机器人的技术实现...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>机器人收费。 用新技术去踢足球</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/483194/"><h2 id="vvedenie"> 引言 </h2><br><p> 大家好 在本文中，我将介绍使用NodeJS的电报消息传递服务和VK社交网络的聊天机器人。 </p><br><p> 在这一点上，许多读者应该提出类似的内容：“多长时间！” 或“又是什么？！” <br> 是的，类似的出版物已经备受关注。 但是，尽管如此，我认为这篇文章还是有用的。 简要介绍一下该机器人的技术实现： </p><br><ol><li> 作为该应用程序的框架， <a href="https://nestjs.com/">NestJS</a>框架越来越受欢迎。 </li><li> 用于与Telegram API交互的<a href="https://www.npmjs.com/package/telegraf">telegraf</a>库。 </li><li> 用于与VK API交互的<a href="https://www.npmjs.com/package/node-vk-bot-api">node-vk-bot-api</a>库。 </li><li> 用于组织数据存储层的<a href="https://www.npmjs.com/package/typeorm">Typeorm</a>库。 </li><li> 使用<a href="https://www.npmjs.com/package/mocha">mocha</a>和chai <a href="https://www.npmjs.com/package/chai">断言</a>库进行测试。 </li><li>  CI使用Travis CI进行测试，并使用Gi​​tHub Actions部署Docker映像。 </li></ol><br><p> 作为附带工作，让我们尝试与Viber成为我们的机器人朋友，使其在多种消息传递服务中通用。 </p><br><p> 对于那些想知道它带来了什么的人，欢迎猫。 </p><a name="habracut"></a><br><h2 id="postanovka-zadachi"> 问题陈述 </h2><br><p> 作为有益的体育锻炼，我更喜欢足球。 当然，在业余水平上。 作为vk，viber和电报中几个频道和聊天的成员，您通常必须看到以下图片： </p><br><p><img src="https://habrastorage.org/webt/jt/c7/h8/jtc7h8oxebenbzwymug3y2oi0oo.png" alt="图片"></p><br><p> 我们在这里看到的是： </p><br><ol><li>  “ P”添加了自己。 </li><li> 在他之后，又增加了3个人，其中有一个“ C”。 </li><li>  “ P”添加了他的同志“ Dimon”。 </li><li> 此后，“ P”并不是太懒惰，并计算出目前已经有多达5个人。 </li><li> 但是，由于我也决定跑步并添加自己，因此此信息已不再适用。 </li></ol><br><p> 在特别被忽略的情况下，人们可以打“ +”号然后取消其参与，邀请不参加聊天的朋友，或者注册其他聊天参与者并进行其他活动。 最后，这导致了一个事实，当每个人最终都参加比赛时，事实证明： </p><br><ol><li>  Vasya设置+1不仅意味着他本人，还意味着他的朋友Gosh。 </li><li>  Kolya写道他会来，但组织者Spiridon用他的眼睛认为只是优点。 </li></ol><br><p> 结果，我们的团队数量可能不相等，“额外的天哪”并出乎意料地出现了科里亚。 </p><br><p> 为了避免此类冲突，我编写了一个简单的机器人，该机器人可以直观地显示即将到来的游戏中参与者的组成，并且可以方便地在其中添加/删除。 </p><br><p> 因此，在我的基本实现中，我认为该机器人应该能够： </p><br><ol><li> 嵌入到任意数量的聊天中。 分别存储每个聊天的状态。 </li><li>  <em>使用</em>命令<em>/ event_add，</em>使用某些信息和一个空球员列表创建一个新的活动事件。 先前的活动事件应变为非活动状态。 </li><li>  <em>/ event_remove命令</em>应取消当前活动的事件。 </li><li>  <em>/ add</em>命令应将一个新成员添加到当前活动的事件中。 此外，如果调用该命令时没有任何其他文本，则应该添加键入该命令的用户。 否则，将添加一个人，该人的名字在调用命令时指定。 </li><li>  <em>/ remove</em>命令根据为<em>/ add</em>命令描述的规则从参与者列表中删除一个人。 </li><li>  <em>/ info</em>命令允许您查看谁已经注册了游戏。 </li><li> 最好让漫游器以与播放器配置相同的语言（或默认情况下为英语）进行响应。 </li></ol><br><p> 要快速查看最终发生的情况，您可以立即转到最后一部分“结果和结论”。 好吧，如果您对实现细节感兴趣，那么下面将对这些信息进行足够详细的描述。 </p><br><h2 id="proektirovanie-i-razrabotka"> 设计开发 </h2><br><p> 在设计应用程序时，我想到了以下方案： </p><br><p><img src="https://habrastorage.org/webt/v7/j4/gz/v7j4gzjufgbeuayina59yy8blia.jpeg" alt="图片"></p><br><p> 在这里，主要思想是将与各种消息传递系统一起使用的所有细节引入适当的适配器中，并封装与实现相应API的库进行交互的逻辑，从而将数据处理并将其转换为单一形式。 </p><br><h3 id="interfeys-i-modeli-soobscheniy"> 界面和消息模型 </h3><br><p> 对于消息，可以设计以下<em>IMessage</em>接口， <em>该类</em>可以通过存储用于各种系统的传入消息数据的类以及使用该数据的方法来满足： </p><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> interface IMessage { <span class="hljs-attr"><span class="hljs-attr">chatId</span></span>: number; lang: string; text: string; fullText: string; command: string; name: string; getReplyStatus: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> string; getReplyData: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> any; setStatus: <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">status: string</span></span></span><span class="hljs-function">) =&gt;</span></span> IMessage; withData: <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data: any</span></span></span><span class="hljs-function">) =&gt;</span></span> IMessage; answer: <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">args: any</span></span></span><span class="hljs-function">) =&gt;</span></span> string | <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>; }</code> </pre> <br><p> 实现此接口的基类<em>BaseMessage</em>具有以下形式： </p><br><div class="spoiler">  <b class="spoiler_title">基本消息</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {IMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../message/i-message'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseMessage</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IMessage</span></span></span><span class="hljs-class"> </span></span>{ public chatId: number; public lang: string; public text: string; public fullText: string; public command: string; protected firstName: string; protected lastName: string; protected replyStatus: string; protected replyData: any; get name(): string { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> firstName: string = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.firstName || <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> lastName: string = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.lastName || <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${firstName}</span></span></span><span class="hljs-string"> </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${lastName}</span></span></span><span class="hljs-string">`</span></span>.trim(); } public getReplyStatus(): string { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.replyStatus; } public getReplyData(): any { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.replyData; } public setStatus(status: string): IMessage { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.replyStatus = status; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } public withData(data: any): IMessage { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.replyData = data; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } public answer(args: any): string | <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(<span class="hljs-string"><span class="hljs-string">'not implemented'</span></span>); } } }</code> </pre> </div></div><br><p> 电报的消息类： </p><br><div class="spoiler">  <b class="spoiler_title">电报消息</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {BaseMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../message/base.message'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {IMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../message/i-message'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TelegramMessage</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseMessage</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IMessage</span></span></span><span class="hljs-class"> </span></span>{ private ctx: any; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(ctx) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ctx = ctx; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> {message} = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ctx.update; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.chatId = message.chat.id; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fullText = message.text; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.command = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ctx.command; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.text = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fullText.replace(<span class="hljs-string"><span class="hljs-string">`/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${</span></span><span class="hljs-keyword"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-string"><span class="hljs-subst">.command}</span></span></span><span class="hljs-string">`</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.lang = message.from.language_code; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.firstName = message.from.first_name; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.lastName = message.from.last_name; } public answer(args: any): string | <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ctx.replyWithHTML(args); } }</code> </pre> </div></div><br><p> 对于VK： </p><br><div class="spoiler">  <b class="spoiler_title">VK消息</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {BaseMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../message/base.message'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {IMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../message/i-message'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">VKMessage</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseMessage</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IMessage</span></span></span><span class="hljs-class"> </span></span>{ private ctx: any; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(ctx) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ctx = ctx; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> {message} = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ctx; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.chatId = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getChatId(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ctx); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fullText = message.text; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.command = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ctx.command; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.text = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fullText.replace(<span class="hljs-string"><span class="hljs-string">`/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${</span></span><span class="hljs-keyword"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-string"><span class="hljs-subst">.command}</span></span></span><span class="hljs-string">`</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.lang = <span class="hljs-string"><span class="hljs-string">'ru'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.firstName = message.from.first_name; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.lastName = message.from.last_name; } public answer(args: any) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> answer: string = <span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${args}</span></span></span><span class="hljs-string">`</span></span>.replace(<span class="hljs-regexp"><span class="hljs-regexp">/&lt;\/?(strong|i)&gt;/gm</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ctx.reply(answer); } private getChatId({message, bot}): number { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> peerId: number = +<span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${message.peer_id}</span></span></span><span class="hljs-string">`</span></span>.replace(<span class="hljs-regexp"><span class="hljs-regexp">/[0-9]0+/</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> groupId: number = bot.settings.group_id; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> peerId + groupId; } }</code> </pre> </div></div><br><p> 您要注意的是： </p><br><ol><li><p>  <em>chatId</em>是聊天的唯一标识符。 对于Telegram，它明确地出现在每个消息的结构中。 但是，对于VK，没有明确的此类标识符。 怎么样 要回答这个问题，您需要了解Bot在VK中的功能。 在此系统中，组通信中的漫游器代表其启动的社区。 即 每个漫游器消息都包含一个<em>group_id</em>社区标识符。 另外，在本例中，消息中<em>包含peer_id</em> （更多详细信息，请参见），作为组对话的标识符。 基于这两个标识符，您可以构建您的聊天标识符，例如，如下所示： </p><br><pre> <code class="javascript hljs">private getChatId({message, bot}): number { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> peerId: number = +(<span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${message.peer_id}</span></span></span><span class="hljs-string">`</span></span>.replace(<span class="hljs-regexp"><span class="hljs-regexp">/[0-9]0+/</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> groupId: number = bot.settings.group_id; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> peerId + groupId; }</code> </pre> <br><p> 此方法当然不是完美的，但适用于当前任务。 </p><br></li><li><p>  <em>fullText</em>和<em>text</em> 。 如变量名<em>所示</em> ， <em>fullText</em>包含消息的<em>全文</em> ，而<em>text</em>仅包含命令名称后的部分。 </p><br></li></ol><br><p> 这很方便，因为它允许您使用现成的<em>文本</em>字段来解析其中包含的辅助信息，例如事件的日期或播放器的名称。 </p><br><ol><li> 与Telegram不同，VK消息不支持用于突出显示<code>&lt;b&gt;</code>或<code>&lt;i&gt;</code>类的文本的标记集，因此，在响应时，必须使用正则表达式删除这些标记。 </li></ol><br><h3 id="adaptery-dlya-priema-i-otpravki-soobscheniy"> 接收和发送消息的适配器 </h3><br><p> 在为电报和VK消息创建接口和数据结构之后，就该实现用于处理传入事件的服务了。 </p><br><p><img src="https://habrastorage.org/webt/gz/-z/2y/gz-z2y0x-x9_78hjdhg2mul9byu.jpeg" alt="图片"></p><br><p> 这些服务必须初始化第三方模块，以与Telegram和VK API进行交互，并启动长轮询机制，并且在从消息传递服务接收数据时，输入命令与系统中发生的内部事件之间具有连接。 </p><br><div class="spoiler">  <b class="spoiler_title">电报服务</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Telegraf <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'telegraf'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Injectable} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@nestjs/common'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> SocksAgent <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'socks5-https-client/lib/Agent'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {ConfigService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/config.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {AppEmitter} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/event-bus.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {TelegramMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./telegram.message'</span></span>; @Injectable() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TelegramService</span></span></span><span class="hljs-class"> </span></span>{ private bot: Telegraf&lt;any&gt;; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(config: ConfigService, appEmitter: AppEmitter) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> botToken: string = config.get(<span class="hljs-string"><span class="hljs-string">'TELEGRAM_BOT_TOKEN'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.bot = config.get(<span class="hljs-string"><span class="hljs-string">'TELEGRAM_USE_PROXY'</span></span>) ? <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Telegraf(botToken, { <span class="hljs-attr"><span class="hljs-attr">telegram</span></span>: {<span class="hljs-attr"><span class="hljs-attr">agent</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getProxy(config)}, }) : <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Telegraf(botToken); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getCommandEventMapping(appEmitter).forEach(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[command, event]</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.bot.command(command, ctx =&gt; { ctx.command = command; appEmitter.emit(event, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TelegramMessage(ctx)); }); }); } public launch(): <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.bot.launch(); } private getProxy(config: ConfigService): SocksAgent { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SocksAgent({ <span class="hljs-attr"><span class="hljs-attr">socksHost</span></span>: config.get(<span class="hljs-string"><span class="hljs-string">'TELEGRAM_PROXY_HOST'</span></span>), <span class="hljs-attr"><span class="hljs-attr">socksPort</span></span>: config.get(<span class="hljs-string"><span class="hljs-string">'TELEGRAM_PROXY_PORT'</span></span>), <span class="hljs-attr"><span class="hljs-attr">socksUsername</span></span>: config.get(<span class="hljs-string"><span class="hljs-string">'TELEGRAM_PROXY_LOGIN'</span></span>), <span class="hljs-attr"><span class="hljs-attr">socksPassword</span></span>: config.get(<span class="hljs-string"><span class="hljs-string">'TELEGRAM_PROXY_PASSWORD'</span></span>), }); } private getCommandEventMapping( appEmitter: AppEmitter, ): <span class="hljs-built_in"><span class="hljs-built_in">Array</span></span>&lt;[string, string]&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ [<span class="hljs-string"><span class="hljs-string">'event_add'</span></span>, appEmitter.EVENT_ADD], [<span class="hljs-string"><span class="hljs-string">'event_remove'</span></span>, appEmitter.EVENT_REMOVE], [<span class="hljs-string"><span class="hljs-string">'info'</span></span>, appEmitter.EVENT_INFO], [<span class="hljs-string"><span class="hljs-string">'add'</span></span>, appEmitter.PLAYER_ADD], [<span class="hljs-string"><span class="hljs-string">'remove'</span></span>, appEmitter.PLAYER_REMOVE], ]; } }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">VK服务</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> VkBot <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'node-vk-bot-api'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Injectable} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@nestjs/common'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {ConfigService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/config.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {AppEmitter} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/event-bus.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {VKMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./vk.message'</span></span>; @Injectable() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">VKService</span></span></span><span class="hljs-class"> </span></span>{ private bot: VkBot&lt;any&gt;; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(config: ConfigService, appEmitter: AppEmitter) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> botToken: string = config.get(<span class="hljs-string"><span class="hljs-string">'VK_TOKEN'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.bot = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> VkBot(botToken); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getCommandEventMapping(appEmitter).forEach(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[command, event]</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.bot.command(<span class="hljs-string"><span class="hljs-string">`/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${command}</span></span></span><span class="hljs-string">`</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> ctx =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">from</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.bot.execute(<span class="hljs-string"><span class="hljs-string">'users.get'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">user_ids</span></span>: ctx.message.from_id, }); ctx.message.from = <span class="hljs-keyword"><span class="hljs-keyword">from</span></span>; ctx.command = command; appEmitter.emit(event, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> VKMessage(ctx)); }); }); } public launch(): <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.bot.startPolling(); } private getCommandEventMapping( appEmitter: AppEmitter, ): <span class="hljs-built_in"><span class="hljs-built_in">Array</span></span>&lt;[string, string]&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ [<span class="hljs-string"><span class="hljs-string">'event_add'</span></span>, appEmitter.EVENT_ADD], [<span class="hljs-string"><span class="hljs-string">'event_remove'</span></span>, appEmitter.EVENT_REMOVE], [<span class="hljs-string"><span class="hljs-string">'info'</span></span>, appEmitter.EVENT_INFO], [<span class="hljs-string"><span class="hljs-string">'add'</span></span>, appEmitter.PLAYER_ADD], [<span class="hljs-string"><span class="hljs-string">'remove'</span></span>, appEmitter.PLAYER_REMOVE], ]; } }</code> </pre> </div></div><br><p> 您要注意的是： </p><br><ol><li> 由于访问Telegram服务（hi Roskomnadzor）的某些问题，有必要选择使用提供<a href="https-client">socks5-https-client</a>软件包的代理。 </li><li> 处理事件时，会将字段与命令的值一起添加到上下文中，该命令的值包含接收到该消息的文本。 </li><li> 对于VK，您必须使用单独的API调用分别下载发送消息的用户的数据： <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">from</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.bot.execute(<span class="hljs-string"><span class="hljs-string">'users.get'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">user_ids</span></span>: ctx.message.from_id, });</code> </pre> </li></ol><br><h3 id="model-dannyh"> 资料模型 </h3><br><p> 为了实现机器人的声明功能，三个模型就足够了： </p><br><ol><li>  <code>Chat</code> -聊天或对话。 </li><li>  <code>Event</code> -安排在特定日期和时间的聊天事件。 </li><li>  <code>Player</code> -参加活动的参与者或参与者。 </li></ol><br><p><img src="https://habrastorage.org/webt/yj/dc/rw/yjdcrwzw4bsie2im9fuelyb590k.jpeg" alt="数据模式"></p><br><p> 使用<a href="https://www.npmjs.com/package/typeorm">typeorm</a>库的模型实现为： </p><br><div class="spoiler">  <b class="spoiler_title">聊天室</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Entity, PrimaryGeneratedColumn, Column, OneToMany, JoinColumn, Index, } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'typeorm'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Event} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./event'</span></span>; @Entity() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Chat</span></span></span><span class="hljs-class"> </span></span>{ @PrimaryGeneratedColumn() id: number; @Index({<span class="hljs-attr"><span class="hljs-attr">unique</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>}) @Column() chatId: number; @OneToMany(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">type</span></span></span><span class="hljs-function"> =&gt;</span></span> Event, event =&gt; event.chat) @JoinColumn() events: Event[]; }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">大事记</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Entity, PrimaryGeneratedColumn, Column, OneToMany, ManyToOne, JoinColumn, } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'typeorm'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Chat} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./chat'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Player} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./player'</span></span>; @Entity() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Event</span></span></span><span class="hljs-class"> </span></span>{ @PrimaryGeneratedColumn() id: number; @Column() date: <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>; @Column() active: boolean; @ManyToOne(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">type</span></span></span><span class="hljs-function"> =&gt;</span></span> Chat, chat =&gt; chat.events) chat: Chat; @OneToMany(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">type</span></span></span><span class="hljs-function"> =&gt;</span></span> Player, player =&gt; player.event) @JoinColumn() players: Player[]; }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">播放器</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Entity, PrimaryGeneratedColumn, Column, ManyToOne, JoinColumn, } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'typeorm'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Event} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./event'</span></span>; @Entity() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Player</span></span></span><span class="hljs-class"> </span></span>{ @PrimaryGeneratedColumn() id: number; @Column() name: string; @ManyToOne(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">type</span></span></span><span class="hljs-function"> =&gt;</span></span> Event, event =&gt; event.players) @JoinColumn() event: Event; }</code> </pre> </div></div><br><p> 在这里，有必要在操纵<em>聊天</em> ， <em>事件</em>和<em>玩家</em>模型方面再次讨论该机器人针对各个团队的机制。 </p><br><ol><li> 收到任何命令后，将使用<code>chatId</code>检查数据库中是否存在聊天。 如果没有相应的记录，则创建它。 </li><li> 为了简化逻辑，每次聊天只能有一个活动事件（ <em>Event</em> ）。 即  <code>/event_add</code>命令时，将在系统中创建一个具有指定日期的新活动事件 <br> 当前活动事件（如果存在）变为非活动状态。 </li><li>  <code>/event_remove</code>在当前聊天中找到活动事件并将其停用。 </li><li>  <code>/info</code>在当前聊天中查找一个活动事件，显示有关此事件的信息以及玩家列表（ <em>Player</em> ）。 </li><li>  <code>/add</code>和<code>/remove</code>活动事件，并从中添加和删除播放器。 </li></ol><br><p> 用于处理数据的相应服务如下： </p><br><div class="spoiler">  <b class="spoiler_title">存储服务</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Injectable} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@nestjs/common'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {InjectConnection} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@nestjs/typeorm'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Connection, Repository, UpdateResult} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'typeorm'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Chat} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./models/chat'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Event} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./models/event'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Player} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./models/player'</span></span>; @Injectable() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StorageService</span></span></span><span class="hljs-class"> </span></span>{ private chatRepository: Repository&lt;Chat&gt;; private eventRepository: Repository&lt;Event&gt;; private playerRepository: Repository&lt;Player&gt;; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(@InjectConnection() private readonly dbConnection: Connection) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.chatRepository = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dbConnection.getRepository(Chat); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.eventRepository = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dbConnection.getRepository(Event); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerRepository = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dbConnection.getRepository(Player); } public get connection() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dbConnection; } public <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> ensureChat(chatId: number): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;Chat&gt; { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> chat: Chat = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.chatRepository.findOne({chatId}); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (chat) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> chat; } chat = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Chat(); chat.chatId = chatId; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.chatRepository.save(chat); } public markChatEventsInactive(chat: Chat): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;UpdateResult&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dbConnection .createQueryBuilder() .update(Event) .set({<span class="hljs-attr"><span class="hljs-attr">active</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>}) .where({chat}) .execute(); } public appendChatActiveEvent(chat: Chat, <span class="hljs-attr"><span class="hljs-attr">date</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;Event&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> event: Event = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Event(); event.chat = chat; event.active = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; event.date = date; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.eventRepository.save(event); } public findChatActiveEvent(chat: Chat): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;Event | <span class="hljs-literal"><span class="hljs-literal">null</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.eventRepository.findOne({<span class="hljs-attr"><span class="hljs-attr">where</span></span>: {chat, <span class="hljs-attr"><span class="hljs-attr">active</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>}}); } public getPlayers(event: Event): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;Player[]&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerRepository.find({<span class="hljs-attr"><span class="hljs-attr">where</span></span>: {event}}); } public findPlayer(event: Event, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: string): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;Player | <span class="hljs-literal"><span class="hljs-literal">null</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerRepository.findOne({<span class="hljs-attr"><span class="hljs-attr">where</span></span>: {event, name}}); } public addPlayer(event: Event, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: string): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;Player&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> player: Player = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Player(); player.event = event; player.name = name; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerRepository.save(player); } public removePlayer(player: Player): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;Player&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerRepository.remove(player); } }</code> </pre> </div></div><br><h3 id="shablonizaciya-otvetov"> 范本回应 </h3><br><p> 除了上述用于处理数据的<em>StorageService</em>服务之外，还需要实现专用的<em>TemplateService</em>服务，该服务目前的任务是： </p><br><ol><li> 下载并编译<a href="https://handlebarsjs.com/">车把</a>模板，以获取不同语言的各种命令的答案选项。 </li><li> 根据当前事件，响应状态和用户语言选择合适的模板。 </li><li> 使用命令获得的数据填充模板。 </li></ol><br><div class="spoiler">  <b class="spoiler_title">模板服务</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> path <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'path'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> fs <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'fs'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> handlebars <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'handlebars'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {readDirDeepSync} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'read-dir-deep'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Injectable, Logger} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@nestjs/common'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> interface IParams { <span class="hljs-attr"><span class="hljs-attr">action</span></span>: string; status: string; lang?: string; } @Injectable() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TemplateService</span></span></span><span class="hljs-class"> </span></span>{ private readonly DEFAULT_LANG: string = <span class="hljs-string"><span class="hljs-string">'en'</span></span>; private readonly TEMPLATE_PATH: string = <span class="hljs-string"><span class="hljs-string">'templates'</span></span>; private logger: Logger; private templatesMap: <span class="hljs-built_in"><span class="hljs-built_in">Map</span></span>&lt;string, (d: any) =&gt; string&gt;; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(logger: Logger) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.logger = logger; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.load(); } public apply(params: IParams, <span class="hljs-attr"><span class="hljs-attr">data</span></span>: any): string { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.logger.log( <span class="hljs-string"><span class="hljs-string">`apply template: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${params.action}</span></span></span><span class="hljs-string"> </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${params.status}</span></span></span><span class="hljs-string"> </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${params.lang}</span></span></span><span class="hljs-string">`</span></span>, ); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> template = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getTemplate(params); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!template) { params.lang = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.DEFAULT_LANG; template = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getTemplate(params); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!template) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(<span class="hljs-string"><span class="hljs-string">'template-not-found'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> template(data); } private getTemplate(params: IParams): <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data: any</span></span></span><span class="hljs-function">) =&gt;</span></span> string { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> {lang, action, status} = params; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.templatesMap.get(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getTemplateKey(lang, action, status)); } private load() { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> templatesDir: string = path.join( process.cwd(), <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.TEMPLATE_PATH, ); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> templateFileNames: string[] = readDirDeepSync(templatesDir); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.templatesMap = templateFileNames.reduce(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">acc, fileName</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> template = fs.readFileSync(fileName, {<span class="hljs-attr"><span class="hljs-attr">encoding</span></span>: <span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>}); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> [, lang, action, status] = fileName .replace(<span class="hljs-regexp"><span class="hljs-regexp">/\.hbs$/</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>) .split(<span class="hljs-string"><span class="hljs-string">'/'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> acc.set( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getTemplateKey(lang, action, status), handlebars.compile(template), ); }, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Map</span></span>()); } private getTemplateKey( lang: string, <span class="hljs-attr"><span class="hljs-attr">action</span></span>: string, <span class="hljs-attr"><span class="hljs-attr">status</span></span>: string, ): string { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${lang}</span></span></span><span class="hljs-string">-</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${action}</span></span></span><span class="hljs-string">-</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${status}</span></span></span><span class="hljs-string">`</span></span>; } }</code> </pre> </div></div><br><p> 您要注意的是： </p><br><ol><li><p> 模板文件位于项目根目录下单独的<code>./templates</code>目录中，并由语言，操作（命令）和响应状态构成。 </p><br><pre> <code class="plaintext hljs">- templates - en - event_add - invalid_date.hbs - success.hbs - event_info - ru</code> </pre> <br><p> 初始化应用程序后，所有响应模板都将加载到内存中，并使用唯一标识该模板的键填充Map： </p><br><pre> <code class="javascript hljs">private getTemplateKey(lang: string, <span class="hljs-attr"><span class="hljs-attr">action</span></span>: string, <span class="hljs-attr"><span class="hljs-attr">status</span></span>: string): string { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${lang}</span></span></span><span class="hljs-string">-</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${action}</span></span></span><span class="hljs-string">-</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${status}</span></span></span><span class="hljs-string">`</span></span>; }</code> </pre> <br></li><li><p> 当前，该系统具有2套模板：俄语和英语。 <br> 在缺少当前事件语言所需的模板的情况下，以默认语言（英语）提供后备广告。 </p><br></li><li><p>  <a href="https://handlebarsjs.com/">车把</a>模板本身，例如： </p><br><pre> <code class="plaintext hljs">Player &lt;strong&gt;{{name}}&lt;/strong&gt; will take part in the game List of players: {{#each players}} {{index}}: &lt;i&gt;{{name}}&lt;/i&gt; {{/each}} Total: &lt;strong&gt;{{total}}&lt;/strong&gt;</code> </pre> <br><p> 同时包含传统的占位符和一<a href="https://tlgrm.ru/docs/bots/api">组有效的标记，</a>用于格式化Telegram中的响应。 </p><br></li></ol><br><h3 id="servisy-obrabotki-komand-actions"> 命令处理服务（操作） </h3><br><p> 现在已经介绍了基本支持服务，是时候继续实施该机器人的业务逻辑本身了。 这些模块之间的连接示意图如下： </p><br><p><img src="https://habrastorage.org/webt/b3/xl/vl/b3xlvlw5qc93vkc3n-nylnjwpqa.jpeg" alt="行动"></p><br><p>  <em>BaseAction</em>基类的任务包括： </p><br><ol><li> 从<em>AppEmitter</em>订阅特定事件。 </li><li> 事件处理的整体功能，即： <br><ul><li> 搜索将要处理的团队中现有的聊天室或创建新的聊天室 </li><li> 调用<code>doAction</code>模板方法<code>doAction</code>该方法<code>doAction</code>实现对于继承<em>BaseAction的</em>每个类都是单独的。 </li><li> 使用<em>TemplateService</em>将模板应用于生成的<code>doAction</code>响应。 </li></ul></li></ol><br><div class="spoiler">  <b class="spoiler_title">基本动作</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Injectable, Logger} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@nestjs/common'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {IMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../message/i-message'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {ConfigService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/config.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {AppEmitter} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/event-bus.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {TemplateService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/template.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {StorageService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/storage.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Chat} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/chat'</span></span>; @Injectable() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseAction</span></span></span><span class="hljs-class"> </span></span>{ protected appEmitter: AppEmitter; protected config: ConfigService; protected logger: Logger; protected templateService: TemplateService; protected storageService: StorageService; protected event: string; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>( config: ConfigService, appEmitter: AppEmitter, logger: Logger, templateService: TemplateService, storageService: StorageService, ) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.config = config; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.logger = logger; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.appEmitter = appEmitter; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.templateService = templateService; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService = storageService; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.setEvent(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.logger.log(<span class="hljs-string"><span class="hljs-string">`subscribe on "</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${</span></span><span class="hljs-keyword"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-string"><span class="hljs-subst">.event}</span></span></span><span class="hljs-string">" event`</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.appEmitter.on(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.event, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.handleEvent.bind(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>)); } protected setEvent(): <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(<span class="hljs-string"><span class="hljs-string">'not implemented'</span></span>); } protected <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> doAction(chat: Chat, <span class="hljs-attr"><span class="hljs-attr">message</span></span>: IMessage): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;IMessage&gt; { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(<span class="hljs-string"><span class="hljs-string">'not implemented'</span></span>); } private <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> handleEvent(message: IMessage) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.logger.log(<span class="hljs-string"><span class="hljs-string">`"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${</span></span><span class="hljs-keyword"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-string"><span class="hljs-subst">.event}</span></span></span><span class="hljs-string">" event received`</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> chatId: number = message.chatId; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> chat: Chat = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.ensureChat(chatId); message = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.doAction(chat, message); message.answer( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.templateService.apply( { <span class="hljs-attr"><span class="hljs-attr">action</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.event, <span class="hljs-attr"><span class="hljs-attr">status</span></span>: message.getReplyStatus(), <span class="hljs-attr"><span class="hljs-attr">lang</span></span>: message.lang, }, message.getReplyData(), ), ); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (error) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.logger.error(error); message.answer(error.message); } } }</code> </pre> </div></div><br><p>  <em>BaseAction</em>子类的任务是执行输入的<code>doAction</code>方法： </p><br><ol><li> 在基类中创建或定义的<em>聊天</em> </li><li> 符合<em>IMessage</em>协议的对象。 </li></ol><br><p> 作为执行此方法的结果，还将返回<em>IMessage</em> ，但是<em>IMessage</em>具有确定的状态，用于选择正确的模板以及将参与响应模板的数据。 </p><br><div class="spoiler">  <b class="spoiler_title">EventAddAction</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Injectable} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@nestjs/common'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> statuses <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./statuses'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {parseEventDate, formatEventDate} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/utils'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {BaseAction} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./base.action'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Chat} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/chat'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Event} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/event'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {IMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../message/i-message'</span></span>; @Injectable() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EventAddAction</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseAction</span></span></span><span class="hljs-class"> </span></span>{ protected setEvent(): <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.event = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.appEmitter.EVENT_ADD; } protected <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> doAction(chat: Chat, <span class="hljs-attr"><span class="hljs-attr">message</span></span>: IMessage): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;IMessage&gt; { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.markChatEventsInactive(chat); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> eventDate: <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span> = parseEventDate(message.text.trim()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!eventDate) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message.setStatus(statuses.STATUS_INVALID_DATE); } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> event: Event = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.appendChatActiveEvent( chat, eventDate, ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message.setStatus(statuses.STATUS_SUCCESS).withData({ <span class="hljs-attr"><span class="hljs-attr">date</span></span>: formatEventDate(event.date), }); } }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">EventRemoveAction</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Injectable} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@nestjs/common'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> statuses <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./statuses'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {formatEventDate} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/utils'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {BaseAction} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./base.action'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Chat} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/chat'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Event} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/event'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {IMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../message/i-message'</span></span>; @Injectable() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EventRemoveAction</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseAction</span></span></span><span class="hljs-class"> </span></span>{ protected setEvent(): <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.event = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.appEmitter.EVENT_REMOVE; } protected <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> doAction(chat: Chat, <span class="hljs-attr"><span class="hljs-attr">message</span></span>: IMessage): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;IMessage&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> activeEvent: Event = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.findChatActiveEvent( chat, ); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.markChatEventsInactive(chat); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (activeEvent) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message.setStatus(statuses.STATUS_SUCCESS).withData({ <span class="hljs-attr"><span class="hljs-attr">date</span></span>: formatEventDate(activeEvent.date), }); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message.setStatus(statuses.STATUS_NO_EVENT); } } }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">EventInfoAction</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Injectable, Logger} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@nestjs/common'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> statuses <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./statuses'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {formatEventDate} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/utils'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {ConfigService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/config.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {AppEmitter} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/event-bus.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {TemplateService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/template.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {StorageService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/storage.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {BaseAction} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./base.action'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {PlayerHelper} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./player.helper'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Chat} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/chat'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Event} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/event'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Player} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/player'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {IMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../message/i-message'</span></span>; @Injectable() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EventInfoAction</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseAction</span></span></span><span class="hljs-class"> </span></span>{ private playerHelper: PlayerHelper; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>( config: ConfigService, appEmitter: AppEmitter, logger: Logger, templateService: TemplateService, playerHelper: PlayerHelper, storageService: StorageService, ) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(config, appEmitter, logger, templateService, storageService); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerHelper = playerHelper; } protected setEvent(): <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.event = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.appEmitter.EVENT_INFO; } protected <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> doAction(chat: Chat, <span class="hljs-attr"><span class="hljs-attr">message</span></span>: IMessage): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;IMessage&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> activeEvent: Event = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.findChatActiveEvent( chat, ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!activeEvent) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message.setStatus(statuses.STATUS_NO_EVENT); } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> players: Player[] = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.getPlayers( activeEvent, ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message.setStatus(statuses.STATUS_SUCCESS).withData({ <span class="hljs-attr"><span class="hljs-attr">date</span></span>: formatEventDate(activeEvent.date), ...(<span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerHelper.getPlayersList(activeEvent)), }); } }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">PlayerAddAction</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Injectable, Logger} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@nestjs/common'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> statuses <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./statuses'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {ConfigService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/config.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {AppEmitter} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/event-bus.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {TemplateService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/template.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {StorageService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/storage.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {BaseAction} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./base.action'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {PlayerHelper} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./player.helper'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Chat} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/chat'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Event} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/event'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Player} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/player'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {IMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../message/i-message'</span></span>; @Injectable() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PlayerAddAction</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseAction</span></span></span><span class="hljs-class"> </span></span>{ private playerHelper: PlayerHelper; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>( config: ConfigService, appEmitter: AppEmitter, logger: Logger, templateService: TemplateService, playerHelper: PlayerHelper, storageService: StorageService, ) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(config, appEmitter, logger, templateService, storageService); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerHelper = playerHelper; } protected setEvent(): <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.event = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.appEmitter.PLAYER_ADD; } protected <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> doAction(chat: Chat, <span class="hljs-attr"><span class="hljs-attr">message</span></span>: IMessage): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;IMessage&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> activeEvent: Event = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.findChatActiveEvent( chat, ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!activeEvent) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message.setStatus(statuses.STATUS_NO_EVENT); } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> name: string = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerHelper.getPlayerName(message); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> existedPlayer: Player = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.findPlayer( activeEvent, name, ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (existedPlayer) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message .setStatus(statuses.STATUS_ALREADY_ADDED) .withData({name}); } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> newPlayer: Player = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.addPlayer( activeEvent, name, ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message.setStatus(statuses.STATUS_SUCCESS).withData({ <span class="hljs-attr"><span class="hljs-attr">name</span></span>: newPlayer.name, ...(<span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerHelper.getPlayersList(activeEvent)), }); } }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">PlayerRemoveAction</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Injectable, Logger} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@nestjs/common'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> statuses <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./statuses'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {ConfigService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/config.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {AppEmitter} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/event-bus.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {TemplateService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/template.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {StorageService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/storage.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {BaseAction} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./base.action'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {PlayerHelper} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./player.helper'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Chat} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/chat'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Event} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/event'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Player} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/player'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {IMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../message/i-message'</span></span>; @Injectable() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PlayerRemoveAction</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseAction</span></span></span><span class="hljs-class"> </span></span>{ private playerHelper: PlayerHelper; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>( config: ConfigService, appEmitter: AppEmitter, logger: Logger, templateService: TemplateService, playerHelper: PlayerHelper, storageService: StorageService, ) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(config, appEmitter, logger, templateService, storageService); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerHelper = playerHelper; } protected setEvent(): <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.event = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.appEmitter.PLAYER_REMOVE; } protected <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> doAction(chat: Chat, <span class="hljs-attr"><span class="hljs-attr">message</span></span>: IMessage): <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;IMessage&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> activeEvent: Event = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.findChatActiveEvent( chat, ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!activeEvent) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message.setStatus(statuses.STATUS_NO_EVENT); } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> name: string = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerHelper.getPlayerName(message); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> existedPlayer: Player = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.findPlayer( activeEvent, name, ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!existedPlayer) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message .setStatus(statuses.STATUS_NO_PLAYER) .withData({name}); } <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.removePlayer(existedPlayer); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message.setStatus(statuses.STATUS_SUCCESS).withData({ name, ...(<span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.playerHelper.getPlayersList(activeEvent)), }); } }</code> </pre> </div></div><br><p> 您要注意的是： </p><br><ol><li>  <code>/add</code>和<code>/remove</code>命令添加/删除名称在命令后面的播放器。 如果未指定名称，则会添加/删除呼叫团队的球员。 </li><li> 响应<code>/add</code> ， <code>/remove</code>和<code>/info</code>命令，将显示活动事件的玩家更新列表。 </li></ol><br><p> 实现（1）和（2）所需的功能已移至特殊的辅助类： </p><br><div class="spoiler">  <b class="spoiler_title">PlayerHelper</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Injectable} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@nestjs/common'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {StorageService} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/storage.service'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Event} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/event'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {Player} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../storage/models/player'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {IMessage} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../message/i-message'</span></span>; @Injectable() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PlayerHelper</span></span></span><span class="hljs-class"> </span></span>{ protected storageService: StorageService; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(storageService: StorageService) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService = storageService; } public getPlayerName(message: IMessage) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> name = message.text.trim(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> name.length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> ? name : message.name; } public <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> getPlayersList(event: Event) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> players: Player[] = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.storageService.getPlayers(event); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">total</span></span>: players.length, <span class="hljs-attr"><span class="hljs-attr">players</span></span>: players.map(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">player, index</span></span></span><span class="hljs-function">) =&gt;</span></span> ({ <span class="hljs-attr"><span class="hljs-attr">index</span></span>: index + <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: player.name, })), }; } }</code> </pre></div></div><br><h3 id="sobiraem-vse-vmeste"> 全部放在一起 </h3><br><p> 如本文开头所述， <a href="https://nestjs.com/">NestJS</a>框架用作应用程序框架。 一次，我很幸运能亲自参加这个奇妙图书馆创建者的<a href="https://www.youtube.com/watch%3Fv%3Djo-1EUxMmxc">报告</a> 。 </p><br><p> 许多NodeJS样板文件，手册和库经常因不提供任何合理的初始化策略和模块之间的连接而带来麻烦。 随着应用程序的增长，在没有适当注意的情况下，代码库变成了模块之间的require-s混杂，通常甚至导致循环依赖或关系，而原则上不应这样做。        Dependency Injection   <a href="https://www.npmjs.com/package/awilix">awilix</a> ,  <a href="https://nestjs.com/">NestJS</a>  . </p><br><p>   DI      ,    NodeJS ,            ,        . </p><br><p><img src="https://habrastorage.org/webt/l2/gq/lc/l2gqlc0vig_zsywifjjopmt_4wc.jpeg" alt="  "></p><br><h2 id="konfiguraciya">  </h2><br><p>            . </p><br><ol><li> <code>TELEGRAM_BOT_TOKEN</code> —    Telegram . </li><li> <code>TELEGRAM_USE_PROXY</code> —          TelegramAPI. </li><li> <code>TELEGRAM_PROXY_HOST</code> —       TelegramAPI. </li><li> <code>TELEGRAM_PROXY_PORT</code> —       TelegramAPI. </li><li> <code>TELEGRAM_PROXY_LOGIN</code> —       TelegramAPI. </li><li> <code>TELEGRAM_PROXY_PASSWORD</code> —       TelegramAPI. </li><li> <code>VK_TOKEN</code> —    VK . </li><li> <code>DATABASE_URL</code> —    .   production . </li></ol><br><p>      : </p><br><ol><li> <code>TELEGRAM_BOT_TOKEN</code>       <a href="https://tlgrm.ru/docs/bots"> </a>      Telegram. </li><li> <code>VK_TOKEN</code> —    ,  VK    . 即    ,             .       <a href="https://vk.com/dev/bots_docs">  </a>  . </li><li> <code>DATABASE_URL</code> —  production      PostgreSQL.          DBaaS   <a href="https://www.elephantsql.com/">elephantsql</a>   . </li></ol><br><h2 id="ci"> CI </h2><br><p> " -   —   ".    ,       <a href="https://travis-ci.org/">TravisCI</a>       : </p><br><pre> <code class="plaintext hljs">language: node_js node_js: - '8' - '10' - '12' script: - npm run lint - npm run build - npm run test:cov after_script: - npm install -g codecov - codecov</code> </pre> <br><p>                      <a href="https://codecov.io/">codecov</a> . </p><br><p>    <a href="https://www.docker.com/">Docker</a>      <a href="https://hub.docker.com/">Docker Hub</a>        <a href="https://habr.com/ru/users/Gonf/">Gonf</a>    <a href="https://habr.com/ru/post/476368/">  CI/CD   GitHub Actions  Python</a> .         Continuous Deployment,       Github: </p><br><pre> <code class="plaintext hljs">name: Release on: release: types: [published] jobs: build: runs-on: ubuntu-latest env: LOGIN: ${{ secrets.DOCKER_LOGIN }} NAME: ${{ secrets.DOCKER_NAME }} steps: - uses: actions/checkout@v1 - name: Install Node.js uses: actions/setup-node@v1 - name: Login to docker.io run: echo ${{ secrets.DOCKER_PWD }} | docker login -u ${{ secrets.DOCKER_LOGIN }} --password-stdin - name: npm install and build run: npm ci &amp;&amp; npm run build - name: Build the Docker image run: docker build -t $LOGIN/$NAME:${GITHUB_REF:10} -f Dockerfile . - name: Push image to docker.io run: docker push $LOGIN/$NAME:${GITHUB_REF:10}</code> </pre> <br><h2 id="rezultat-i-vyvody">    </h2><br><p>     .  Telegram     : <br>        . </p><br><p><img src="https://habrastorage.org/webt/mi/tr/nb/mitrnbq3hcwu33lizpvmbxuirl0.png" alt="demo1"></p><br><p>    . </p><br><p><img src="https://habrastorage.org/webt/4v/y-/lk/4vy-lkg-dungqdpmbou0gop2w4e.png" alt="demo2"></p><br><p>      . </p><br><p><img src="https://habrastorage.org/webt/w8/i2/oo/w8i2oog_swdu2sjvqsqihwu8ww4.png" alt="demo3"></p><br><p>     VK      <code>&lt;b&gt;</code>  <code>&lt;i&gt;</code> . <br>        . </p><br><p><img src="https://habrastorage.org/webt/ak/cu/fo/akcufo-5cwygqzcdfysm-uytzdi.png" alt="demo4"></p><br><p>      . </p><br><p><img src="https://habrastorage.org/webt/pg/ye/c7/pgyec7wg7kgltgjk7ton5wc7w64.png" alt="demo6"></p><br><p>   <a href="https://www.viber.com/">Viber</a> ,              .         ,    <a href="https://www.viber.com/">Viber</a>   webhooks  long-polling.    ,    Viber         .       <a href="https://github.com/Viber/sample-bot-isitup/issues/2"></a> .          (?) . </p><br><p>  Telegram            <code>@Tormozz48bot</code> . </p><br><p>     <a href="https://github.com/tormozz48/football-chat-bot-2"> Github</a> .   ,   . </p><br><p> PS    . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN483194/">https://habr.com/ru/post/zh-CN483194/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN483178/index.html">这是Flutter 1.9发行版与Dart 2.5编程结合的更新</a></li>
<li><a href="../zh-CN483182/index.html">使用Array.reduce（）的五种有趣方式（一种无聊的方式）</a></li>
<li><a href="../zh-CN483184/index.html">自动将代码升级到TensorFlow 2</a></li>
<li><a href="../zh-CN483186/index.html">Java 13简介：让我们深入了解JDK的新功能</a></li>
<li><a href="../zh-CN483190/index.html">3CX技术支持答案：从以前的版本升级到3CX v16</a></li>
<li><a href="../zh-CN483198/index.html">阿里云如何通过... Kubernetes管理数万个Kubernetes集群</a></li>
<li><a href="../zh-CN483202/index.html">REST API简介-RESTful Web服务</a></li>
<li><a href="../zh-CN483204/index.html">REST和SOAP之间的区别</a></li>
<li><a href="../zh-CN483206/index.html">REST API开发-什么是合同第一？</a></li>
<li><a href="../zh-CN483208/index.html">回顾Kaggle ML＆DS Survey2019。或者ML专家赚多少钱</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>