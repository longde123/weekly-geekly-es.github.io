<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üç¶ üöó üßí Como o Microsoft Excel funciona com alturas de linha üßïüèø ‚ùï üòû</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="√Äs vezes fico entediado e, armado com um depurador, come√ßo a pesquisar em diferentes programas. Dessa vez, minha escolha foi no Excel e havia um desej...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como o Microsoft Excel funciona com alturas de linha</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/435426/"><p> √Äs vezes fico entediado e, armado com um depurador, come√ßo a pesquisar em diferentes programas.  Dessa vez, minha escolha foi no Excel e havia um desejo de descobrir como ele lida com as alturas das linhas, o que as armazena, como considera a altura de um intervalo de c√©lulas etc.  Analisei o Excel 2010 (excel.exe, 32 bits, vers√£o 14.0.4756.1000, SHA1 a805cf60a5542f21001b0ea5d142d1cd0ee00b28). </p><a name="habracut"></a><br><h2 id="nachnyom-s-teorii">  Vamos come√ßar com a teoria </h2><br><p>  Se voc√™ recorrer √† documenta√ß√£o do VBA para Microsoft Office, poder√° ver que a altura da linha pode ser obtida de uma maneira ou de outra atrav√©s de duas propriedades: </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" title="Rowheight">RowHeight</a> - Retorna ou define a altura da primeira linha no intervalo especificado, medido em pontos.  Leitura / grava√ß√£o dupla; </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" title="Altura">Altura</a> - Retorna um valor Duplo que representa a altura, em pontos, do intervalo.  Somente leitura. </li></ul><br><p>  E se voc√™ tamb√©m procurar aqui: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" title="Especifica√ß√µes e limites do Excel">Especifica√ß√µes e limites do Excel</a> .  Voc√™ pode descobrir que a altura m√°xima da linha √© 409 pontos.  Infelizmente, isso est√° longe de ser o √∫nico caso em que os documentos oficiais da Microsoft s√£o um pouco enganadores.  De fato, no c√≥digo do Excel, a altura m√°xima da linha √© definida como 2047 pixels, que ser√° 1535,25 em pontos.  E o tamanho m√°ximo da fonte √© 409,55 pontos.  √â imposs√≠vel obter uma linha com uma altura t√£o grande atribuindo-a simplesmente no VBA / Interop, mas voc√™ pode fazer uma linha, definir a fonte Cambria Math em sua primeira c√©lula e definir o tamanho da fonte para 409,55 pontos.  Em seguida, o Excel, com seu algoritmo de ast√∫cia, calcular√° a altura da linha com base no formato da c√©lula, obter√° um n√∫mero superior a 2047 pixels (acredite na palavra) e definir√° a linha para a altura m√°xima poss√≠vel.  Se voc√™ perguntar a altura desta s√©rie por meio da interface do usu√°rio, o Excel indicar√° que a altura √© 409,5 pontos, mas se voc√™ solicitar a altura da s√©rie por meio do VBA, obter√° 1535,25 pontos honestos, o que equivale a 2047 pixels.  √â verdade que, depois de salvar o documento, a altura ainda cair√° para 409,5 pontos.  Essa manipula√ß√£o pode ser observada aqui neste v√≠deo: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">http://recordit.co/ivnFEsELLI</a> </p><br><p>  Mencionei os pixels no par√°grafo anterior por um motivo.  Na verdade, o Excel armazena e calcula o tamanho das c√©lulas em n√∫meros inteiros (geralmente faz tudo o m√°ximo poss√≠vel em n√∫meros inteiros).  Na maioria das vezes, esses pixels s√£o multiplicados por algum fator.  Curiosamente, o Excel armazena a escala de apar√™ncia na forma de uma fra√ß√£o comum, por exemplo, uma escala de 75% ser√° armazenada como dois n√∫meros 3 e 4. E quando for necess√°rio exibir a linha, o Excel assumir√° a altura da linha como um n√∫mero inteiro de pixels, multiplique por 3 e divida por 4. Mas ele executar√° essa opera√ß√£o j√° no final, a partir disso, cria-se o efeito de que tudo seja considerado em n√∫meros fracion√°rios.  Para verificar isso, escreva o seguinte c√≥digo no VBA: </p><br><pre><code class="vbscript hljs">w.Rows(<span class="hljs-number"><span class="hljs-number">1</span></span>).RowHeight = <span class="hljs-number"><span class="hljs-number">75.375</span></span> Debug.Print w.Rows(<span class="hljs-number"><span class="hljs-number">1</span></span>).Height</code> </pre> <br><p>  VBA vai dar 75 porque  75.375 pixels ser√£o 100,5 pixels, e o Excel n√£o pode pagar e reduzir√° a parte fracion√°ria em at√© 100 pixels.  Quando o VBA solicita a altura da linha em pontos, o Excel honestamente converte 100 pixels em pontos e retorna 75. </p><br><p>  Em princ√≠pio, j√° come√ßamos a escrever uma classe em C # que descrever√° informa√ß√µes sobre a altura da linha: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">RowHeightInfo</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ushort</span></span> Value { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-comment"><span class="hljs-comment">//    ,   4. public ushort Flags { get; set; } //  }</span></span></code> </pre> <br><p>  Voc√™ ter√° que aceitar minha palavra por enquanto, mas no Excel, a altura da linha √© armazenada dessa maneira.  Ou seja, se for especificado que a altura da linha √© 75 pontos, ser√° 100 em pixels e 400 ser√£o armazenados em Valor. Ainda n√£o entendi o que todos os bits em Flags significam (√© dif√≠cil e longo descobrir os valores dos sinalizadores), mas tenho certeza 0x4000 √© definido para linhas cuja altura √© definida manualmente e 0x2000 - √© definido para linhas ocultas.  Em geral, para linhas vis√≠veis com uma altura definida manualmente, Flags geralmente √© igual a 0x4005 e para linhas nas quais a altura √© calculada com base na formata√ß√£o de Flags, √© 0xA ou 0x800E. </p><br><h2 id="sprashivaem-vysotu-ryada">  Pedimos a altura da linha </h2><br><p>  Agora, em princ√≠pio, voc√™ pode dar uma olhada no m√©todo em excel.exe, que retorna a altura da linha por seu √≠ndice (gra√ßas a HexRays pelo c√≥digo bonito): </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> __userpurge GetRowHeight@&lt;eax&gt;(<span class="hljs-keyword"><span class="hljs-keyword">signed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> rowIndex@&lt;edx&gt;, SheetLayoutInfo *sheetLayoutInfo@&lt;esi&gt;, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> flag) { RowHeightInfo *rowHeightInfo; <span class="hljs-comment"><span class="hljs-comment">// eax int result; // ecx if ( sheetLayoutInfo-&gt;dword1A0 ) return sheetLayoutInfo-&gt;defaultFullRowHeightMul4 | (~(sheetLayoutInfo-&gt;defaultRowDelta2 &gt;&gt; 14 &lt;&lt; 15) &amp; 0x8000); if ( rowIndex &lt; sheetLayoutInfo-&gt;MinRowIndexNonDefault ) return sheetLayoutInfo-&gt;defaultFullRowHeightMul4 | (~(sheetLayoutInfo-&gt;defaultRowDelta2 &gt;&gt; 14 &lt;&lt; 15) &amp; 0x8000); if ( rowIndex &gt;= sheetLayoutInfo-&gt;MaxRowIndexNonDefault ) return sheetLayoutInfo-&gt;defaultFullRowHeightMul4 | (~(sheetLayoutInfo-&gt;defaultRowDelta2 &gt;&gt; 14 &lt;&lt; 15) &amp; 0x8000); rowHeightInfo = GetRowHeightCore(sheetLayoutInfo, rowIndex); if ( !rowHeightInfo ) return sheetLayoutInfo-&gt;defaultFullRowHeightMul4 | (~(sheetLayoutInfo-&gt;defaultRowDelta2 &gt;&gt; 14 &lt;&lt; 15) &amp; 0x8000); result = 0; if ( flag || !(rowHeightInfo-&gt;Flags &amp; 0x2000) ) result = rowHeightInfo-&gt;Value; if ( !(rowHeightInfo-&gt;Flags &amp; 0x4000) ) result |= 0x8000u; return result; }</span></span></code> </pre> <br><p>  O que √© dword1A0, ainda n√£o descobri.  n√£o foi poss√≠vel encontrar um local em que esse sinalizador est√° definido :( <br>  O que √© defaultRowDelta2 para mim tamb√©m continua sendo um mist√©rio.  Quando o Excel calcula a altura da linha com base no formato, ele representa a soma de dois n√∫meros.  defaultRowDelta2 √© o segundo n√∫mero dessa soma para a altura da linha padr√£o.  O valor do par√¢metro flag tamb√©m √© misterioso, pois  onde quer que eu vi uma chamada para esse m√©todo na flag passou false. <br>  A classe SheetLayoutInfo tamb√©m aparece nesse m√©todo.  Eu o nomeei assim, porque ele armazena muitas informa√ß√µes sobre a apar√™ncia da planilha.  No SheetLayoutInfo, existem campos como: </p><br><ul><li>  DefaultFullRowHeightMul4 - altura da linha padr√£o; </li><li>  MinRowIndexNonDefault - o √≠ndice da primeira linha na qual a altura difere do padr√£o; </li><li>  MaxRowIndexNonDefault - √≠ndice da s√©rie ap√≥s a √∫ltima, na qual a altura difere da padr√£o; </li><li>  DefaultRowDelta2 √© a mesma parte da soma da altura da linha padr√£o. </li><li>  GroupIndexDelta - mais sobre isso mais tarde </li></ul><br><p>  Em princ√≠pio, a l√≥gica deste m√©todo √© compreens√≠vel: </p><br><ol><li>  Se o √≠ndice da s√©rie for menor que o primeiro com uma altura n√£o padr√£o, retorne o padr√£o; </li><li>  Se o √≠ndice da s√©rie for maior que o √∫ltimo com uma altura n√£o padr√£o, retorne o padr√£o; </li><li>  Caso contr√°rio, obteremos o objeto rowHeightInfo da s√©rie do m√©todo GetRowHeightCore; </li><li>  Se rowHeightInfo == null retorne a altura da linha padr√£o; </li><li>  Existe m√°gica com sinalizadores, mas, em geral, retornamos o que est√° em rowHeightInfo.Value e configuramos o 16¬∫ bit na resposta se a altura da linha n√£o foi definida manualmente. </li></ol><br><p>  Se voc√™ reescrever esse c√≥digo em C #, obter√° algo como o seguinte: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ulong</span></span> HiddenRowMask = <span class="hljs-number"><span class="hljs-number">0x2000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ulong</span></span> CustomHeightMask = <span class="hljs-number"><span class="hljs-number">0x4000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ushort</span></span> DefaultHeightMask = <span class="hljs-number"><span class="hljs-number">0x8000</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">ushort</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetRowHeight</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> rowIndex, SheetLayoutInfo sheetLayoutInfo</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">ushort</span></span> defaultHeight = (<span class="hljs-keyword"><span class="hljs-keyword">ushort</span></span>) (sheetLayoutInfo.DefaultFullRowHeightMul4 | (~(sheetLayoutInfo.DefaultRowDelta2 &gt;&gt; <span class="hljs-number"><span class="hljs-number">14</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">15</span></span>) &amp; DefaultHeightMask)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rowIndex &lt; sheetLayoutInfo.MinRowIndexNonDefault) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> defaultHeight; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rowIndex &gt;= sheetLayoutInfo.MaxRowIndexNonDefault) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> defaultHeight; RowHeightInfo rowHeightInfo = GetRowHeightCore(sheetLayoutInfo, rowIndex); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rowHeightInfo == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> defaultHeight; <span class="hljs-keyword"><span class="hljs-keyword">ushort</span></span> result = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((rowHeightInfo.Flags &amp; HiddenRowMask) == <span class="hljs-number"><span class="hljs-number">0</span></span>) result = rowHeightInfo.Value; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((rowHeightInfo.Flags &amp; CustomHeightMask) == <span class="hljs-number"><span class="hljs-number">0</span></span>) result |= DefaultHeightMask; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre> <br><p>  Agora voc√™ pode dar uma olhada no que est√° acontecendo no GetRowHeightCore: </p><br><pre> <code class="cpp hljs">RowHeightInfo *__<span class="hljs-function"><span class="hljs-function">fastcall </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetRowHeightCore</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SheetLayoutInfo *sheetLayoutInfo, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">signed</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> rowIndex)</span></span></span><span class="hljs-function"> </span></span>{ RowHeightInfo *result; <span class="hljs-comment"><span class="hljs-comment">// eax RowsGroupInfo *rowsGroupInfo; // ecx int rowInfoIndex; // edx result = 0; if ( rowIndex &lt; sheetLayoutInfo-&gt;MinRowIndexNonDefault || rowIndex &gt;= sheetLayoutInfo-&gt;MaxRowIndexNonDefault ) return result; rowsGroupInfo = sheetLayoutInfo-&gt;RowsGroups[sheetLayoutInfo-GroupIndexDelta + (rowIndex &gt;&gt; 4)]; result = 0; if ( !rowsGroupInfo ) return result; rowInfoIndex = rowsGroupInfo-&gt;Indices[rowIndex &amp; 0xF]; if ( rowInfoIndex ) result = (rowsGroupInfo + 8 * (rowInfoIndex + rowsGroupInfo-&gt;wordBA + rowsGroupInfo-&gt;wordBC - rowsGroupInfo-&gt;wordB8)); return result; }</span></span></code> </pre> <br><ol><li>  Novamente, no in√≠cio, o Excel verifica se o √≠ndice da s√©rie est√° entre as linhas com uma altura alterada e, se n√£o, retorna nulo. </li><li>  Localiza o grupo de linhas desejado; se n√£o houver um grupo, ele retornar√° nulo. </li><li>  Obt√©m o √≠ndice da s√©rie no grupo. </li><li>  Al√©m disso, pelo √≠ndice da s√©rie, ele encontra o objeto desejado da classe RowHeightInfo.  wordBA, wordBC, wordB8 - algumas constantes.  Eles mudam apenas com a hist√≥ria.  Em princ√≠pio, eles n√£o afetam o entendimento do algoritmo. </li></ol><br><p>  Aqui vale a pena desviar do t√≥pico e contar mais sobre o RowsGroupInfo.  O Excel armazena RowHeightInfo em grupos de 16 partes, onde o i-√©simo grupo, representado pela classe RowsGroupInfo, armazenar√° informa√ß√µes sobre linhas de i √ó 16 a i √ó 16 + 15, inclusive. </p><br><p>  Mas as informa√ß√µes de altura da linha no RowsGroupInfo s√£o armazenadas de uma maneira um tanto incomum.  Provavelmente devido √† necessidade de manter o hist√≥rico no Excel. </p><br><p>  Existem tr√™s campos importantes no RowsGroupInfo: Indices, HeightInfos e RowsCount, o segundo n√£o √© vis√≠vel no c√≥digo acima (ele deve estar nesta linha: (linesGroupInfo + 8 √ó (...)), porque rowInfoIndex pode assumir valores muito diferentes , J√° vi mais de 1000 e n√£o tenho ideia de como definir essa estrutura na IDA.O campo RowsCount n√£o aparece no c√≥digo acima, mas √© quantas linhas realmente n√£o padr√£o s√£o armazenadas no grupo. <br>  Al√©m disso, em SheetLayoutInfo, h√° GroupIndexDelta - a diferen√ßa entre o √≠ndice real do grupo e o √≠ndice do primeiro grupo com uma altura de linha modificada. </p><br><p>  O campo √çndices armazena as compensa√ß√µes de RowHeightInfo para cada √≠ndice da s√©rie dentro do grupo.  Eles s√£o armazenados l√° em ordem, mas em HeightInfos RowHeightInfo j√° est√£o armazenados na ordem de altera√ß√£o. </p><br><p>  Suponha que tenhamos uma nova planilha em branco e, de alguma forma, alteramos a altura do n√∫mero da linha 23. Essa linha est√° no segundo grupo de 16 linhas; </p><br><ol><li>  O Excel determinar√° o √≠ndice do grupo para esta s√©rie.  No caso atual, o √≠ndice ser√° 1 e mudar√° GroupIndexDelta = -1. </li><li>  Cria um objeto da classe RowsGroupInfo para uma s√©rie de linhas e o coloca em sheetLayoutInfo-&gt; RowsGroups sob o √≠ndice 0 (sheetLayoutInfo-&gt; GroupIndexDelta + 1); </li><li>  No RowsGroupInfo, o Excel alocar√° mem√≥ria para 16 √≠ndices de 4 bytes, para RowsCount, wordBA, wordBA, wordBC e wordB8, etc.; </li><li>  Em seguida, o Excel calcula o √≠ndice da s√©rie no grupo atrav√©s da opera√ß√£o AND bit a bit (isso √© muito mais r√°pido do que o restante da divis√£o): rowIndex &amp; 0xF.  O √≠ndice desejado no grupo ser√°: 23 ‚Äã‚Äã&amp; 0xF = 7; </li><li>  Depois disso, o Excel obt√©m o deslocamento para o √≠ndice 7: deslocamento = √≠ndices [7].  Se deslocamento = 0, o Excel aloca 8 bytes no final de RowsGroupInto, aumenta o RowsCount em um e grava o novo deslocamento nos √çndices [7].  De qualquer forma, no final, o Excel grava informa√ß√µes sobre a nova altura da linha e sinalizadores no deslocamento no RowsGroupInfo. </li></ol><br><p>  A classe RowsGroupInfo no pr√≥prio C # ficaria assim: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">RowsGroupInfo</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[] Indices { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;RowHeightInfo&gt; HeightInfos { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RowsGroupInfo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Indices = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[SheetLayoutInfo.MaxRowsCountInGroup]; HeightInfos = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;RowHeightInfo&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; SheetLayoutInfo.MaxRowsCountInGroup; i++) { Indices[i] = <span class="hljs-number"><span class="hljs-number">-1</span></span>; } } }</code> </pre> <br><p>  O m√©todo GetRowHeightCore ficaria assim: </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> RowHeightInfo </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetRowHeightCore</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">SheetLayoutInfo sheetLayoutInfo, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> rowIndex</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rowIndex &lt; sheetLayoutInfo.MinRowIndexNonDefault || rowIndex &gt;= sheetLayoutInfo.MaxRowIndexNonDefault) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; RowsGroupInfo rowsGroupInfo = sheetLayoutInfo.RowsGroups[sheetLayoutInfo.GroupIndexDelta + (rowIndex &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>)]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rowsGroupInfo == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> rowInfoIndex = rowsGroupInfo.Indices[rowIndex &amp; <span class="hljs-number"><span class="hljs-number">0xF</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> rowInfoIndex != <span class="hljs-number"><span class="hljs-number">-1</span></span> ? rowsGroupInfo.HeightInfos[rowInfoIndex] : <span class="hljs-literal"><span class="hljs-literal">null</span></span>; }</code> </pre> <br><p>  E √© assim que o SetRowHeight se pareceria (eu n√£o listei seu c√≥digo no excel.exe): </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetRowHeight</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> rowIndex, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ushort</span></span></span></span><span class="hljs-function"><span class="hljs-params"> newRowHeight, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ushort</span></span></span></span><span class="hljs-function"><span class="hljs-params"> flags, SheetLayoutInfo sheetLayoutInfo</span></span></span><span class="hljs-function">)</span></span> { sheetLayoutInfo.MaxRowIndexNonDefault = Math.Max(sheetLayoutInfo.MaxRowIndexNonDefault, rowIndex + <span class="hljs-number"><span class="hljs-number">1</span></span>); sheetLayoutInfo.MinRowIndexNonDefault = Math.Min(sheetLayoutInfo.MinRowIndexNonDefault, rowIndex); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> realGroupIndex = rowIndex &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sheetLayoutInfo.RowsGroups.Count == <span class="hljs-number"><span class="hljs-number">0</span></span>) { sheetLayoutInfo.RowsGroups.Add(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); sheetLayoutInfo.GroupIndexDelta = -realGroupIndex; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sheetLayoutInfo.GroupIndexDelta + realGroupIndex &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> bucketSize = -(sheetLayoutInfo.GroupIndexDelta + realGroupIndex); sheetLayoutInfo.RowsGroups.InsertRange(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RowsGroupInfo[bucketSize]); sheetLayoutInfo.GroupIndexDelta = -realGroupIndex; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sheetLayoutInfo.GroupIndexDelta + realGroupIndex &gt;= sheetLayoutInfo.RowsGroups.Count) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> bucketSize = sheetLayoutInfo.GroupIndexDelta + realGroupIndex - sheetLayoutInfo.RowsGroups.Count + <span class="hljs-number"><span class="hljs-number">1</span></span>; sheetLayoutInfo.RowsGroups.AddRange(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RowsGroupInfo[bucketSize]); } RowsGroupInfo rowsGroupInfo = sheetLayoutInfo.RowsGroups[sheetLayoutInfo.GroupIndexDelta + realGroupIndex]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rowsGroupInfo == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { rowsGroupInfo = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RowsGroupInfo(); sheetLayoutInfo.RowsGroups[sheetLayoutInfo.GroupIndexDelta + realGroupIndex] = rowsGroupInfo; } <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> rowInfoIndex = rowsGroupInfo.Indices[rowIndex &amp; <span class="hljs-number"><span class="hljs-number">0xF</span></span>]; RowHeightInfo rowHeightInfo; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rowInfoIndex == <span class="hljs-number"><span class="hljs-number">-1</span></span>) { rowHeightInfo = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RowHeightInfo(); rowsGroupInfo.HeightInfos.Add(rowHeightInfo); rowsGroupInfo.Indices[rowIndex &amp; <span class="hljs-number"><span class="hljs-number">0xF</span></span>] = rowsGroupInfo.HeightInfos.Count - <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { rowHeightInfo = rowsGroupInfo.HeightInfos[rowInfoIndex]; } rowHeightInfo.Value = newRowHeight; rowHeightInfo.Flags = flags; }</code> </pre> <br><h2 id="nemnogo-praktiki">  Um pouco de pr√°tica </h2><br><p>  Ap√≥s o exemplo acima, com uma altera√ß√£o na altura da linha 23, o Excel se parecer√° com isso (eu defino a linha 23 com 75 pontos de altura): </p><br><div class="spoiler">  <b class="spoiler_title">sheetLayoutInfo</b> <div class="spoiler_text"><ul><li>  DefaultFullRowHeightMul4 = 80 </li><li>  DefaultRowDelta2 = 5 </li><li>  MaxRowIndexNonDefault = 24 </li><li>  MinRowIndexNonDefault = 23 </li><li>  GroupIndexDelta = -1 </li><li>  Contagem de RowsGroups = 1 <br><ul><li>  [0] RowsGroupInfo </li><li>  HeightInfos Count = 1 <br><ul><li>  [0] RowHeightInfo </li><li>  Sinalizadores = 0x4005 </li><li>  Valor = 100 </li></ul></li><li>  √çndices <br><ul><li>  [0] = -1 </li><li>  [1] = -1 </li><li>  [2] = -1 </li><li>  [3] = -1 </li><li>  [4] = -1 </li><li>  [5] = -1 </li><li>  [6] = -1 </li><li>  [7] = 0 </li><li>  [8] = -1 </li><li>  [9] = -1 </li><li>  [10] = -1 </li><li>  [11] = -1 </li><li>  [12] = -1 </li><li>  [13] = -1 </li><li>  [14] = -1 </li><li>  [15] = -1 </li></ul></li></ul></li></ul></div></div><br>  Aqui e no exemplo a seguir, apresentarei uma representa√ß√£o esquem√°tica de como s√£o os dados na mem√≥ria do Excel, criados no Visual Studio a partir de classes auto-escritas, porque um despejo direto da mem√≥ria n√£o √© muito informativo. <br>  Agora vamos tentar ocultar a linha 23. Para fazer isso, defina o bit 0x2000 dos sinalizadores.  Vamos mudar a mem√≥ria para viver.  O resultado pode ser visto neste v√≠deo: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">http://recordit.co/79vYIbwbzB</a> . <br>  Sempre que voc√™ oculta linhas, o Excel faz o mesmo. <br>  Agora vamos definir a altura da linha n√£o explicitamente, mas atrav√©s do formato da c√©lula.  Deixe a fonte na c√©lula A20 se tornar uma altura de 40 pontos, ent√£o a altura da c√©lula em pontos ser√° 45,75 e na mem√≥ria do Excel ser√° algo como isto: <br><div class="spoiler">  <b class="spoiler_title">sheetLayoutInfo</b> <div class="spoiler_text"><ul><li>  DefaultFullRowHeightMul4 = 80 </li><li>  DefaultRowDelta2 = 5 </li><li>  MaxRowIndexNonDefault = 24 </li><li>  MinRowIndexNonDefault = 20 </li><li>  GroupIndexDelta = -1 </li><li>  Contagem de RowsGroups = 1 <br><ul><li>  [0] RowsGroupInfo </li><li>  HeightInfos Count = 2 <br><ul><li>  [0] RowHeightInfo </li><li>  Sinalizadores = 0x4005 </li><li>  Valor = 100 </li><li>  [1] RowHeightInfo </li><li>  Sinalizadores = 0x800E </li><li>  Valor = 244 </li></ul></li><li>  √çndices <br><ul><li>  [0] = -1 </li><li>  [1] = -1 </li><li>  [2] = -1 </li><li>  [3] = -1 </li><li>  [4] = 1 </li><li>  [5] = -1 </li><li>  [6] = -1 </li><li>  [7] = 0 </li><li>  [8] = -1 </li><li>  [9] = -1 </li><li>  [10] = -1 </li><li>  [11] = -1 </li><li>  [12] = -1 </li><li>  [13] = -1 </li><li>  [14] = -1 </li><li>  [15] = -1 </li></ul></li></ul></li></ul></div></div><br><p>  Voc√™ pode perceber que o Excel sempre armazena a altura da linha, se n√£o for padr√£o.  Mesmo que a altura n√£o seja definida explicitamente, mas seja calculada com base no conte√∫do das c√©lulas ou formato, o Excel ainda a calcular√° uma vez e colocar√° o resultado no grupo apropriado. </p><br><h2 id="razbiraemsya-so-vstavkoyudaleniem-ryadov">  Lidamos com a inser√ß√£o / exclus√£o de linhas </h2><br><p>  Seria interessante analisar o que acontece ao inserir / excluir linhas.  O c√≥digo correspondente no excel.exe n√£o √© dif√≠cil de encontrar, mas n√£o havia o desejo de desmont√°-lo; voc√™ pode dar uma olhada em uma parte dele: </p><br><div class="spoiler">  <b class="spoiler_title">sub_305EC930</b> <div class="spoiler_text"><p>  O sinalizador a5 determina qual opera√ß√£o est√° ocorrendo atualmente. </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> __userpurge sub_305EC930@&lt;eax&gt;(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a1@&lt;eax&gt;, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a2@&lt;edx&gt;, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a3@&lt;ecx&gt;, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a4, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a5, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a6) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> v6; <span class="hljs-comment"><span class="hljs-comment">// esi int v7; // ebx int v8; // edi int v9; // edx int v10; // ecx size_t v11; // eax _WORD *v12; // ebp size_t v13; // eax size_t v14; // eax int v15; // eax unsigned __int16 *v16; // ecx _WORD *v17; // eax _WORD *v18; // ecx int v19; // edx __int16 v20; // bx int v21; // eax _WORD *v22; // ecx int v24; // edx int v25; // eax int v26; // esi int v27; // ebx size_t v28; // eax int v29; // ebp size_t v30; // eax int v31; // esi size_t v32; // eax int v33; // eax unsigned __int16 *v34; // ecx int v35; // eax _WORD *v36; // edx _WORD *v37; // ecx int v38; // eax __int16 v39; // bx int v40; // eax _WORD *v41; // ecx int v42; // [esp+10h] [ebp-48h] int v43; // [esp+10h] [ebp-48h] int v44; // [esp+14h] [ebp-44h] char v45; // [esp+14h] [ebp-44h] int Dst[16]; // [esp+18h] [ebp-40h] int v47; // [esp+5Ch] [ebp+4h] int v48; // [esp+60h] [ebp+8h] v6 = a1; v7 = a1 &amp; 0xF; v8 = a2; if ( !a5 ) { v24 = a4 - a1; v25 = a1 - a3; v43 = a4 - v6; if ( v7 &gt;= v25 ) v7 = v25; v47 = a4 - v7; v26 = v6 - v7; v27 = v7 + 1; v48 = v27; if ( !v8 ) return v27; v28 = 4 * v24; if ( (4 * v24) &gt; 0x40 ) v28 = 64; v45 = v27 + v26; v29 = (v27 + v26) &amp; 0xF; memmove(Dst, (v8 + 4 * v29), v28); v30 = 4 * v27; if ( (4 * v27) &gt; 0x40 ) v30 = 64; v31 = v26 &amp; 0xF; memmove((v8 + 4 * (v47 &amp; 0xF)), (v8 + 4 * v31), v30); v32 = 4 * v43; if ( (4 * v43) &gt; 0x40 ) v32 = 64; memmove((v8 + 4 * v31), Dst, v32); if ( !a6 ) return v48; v33 = v29; if ( v29 &lt; v29 + v43 ) { v34 = (v8 + 4 * v29 + 214); do { Dst[v33++] = *v34 &gt;&gt; 15; v34 += 2; } while ( v33 &lt; v29 + v43 ); } v35 = (v45 - 1) &amp; 0xF; if ( v35 &gt;= v31 ) { v36 = (v8 + 4 * ((v27 + v47 - 1) &amp; 0xF) + 214); v37 = (v8 + 4 * ((v45 - 1) &amp; 0xF) + 214); v38 = v35 - v31 + 1; do { v39 = *v37 ^ (*v37 ^ *v36) &amp; 0x7FFF; v37 -= 2; *v36 = v39; v36 -= 2; --v38; } while ( v38 ); v27 = v48; } v40 = v31; if ( v31 &gt;= v31 + v43 ) return v27; v41 = (v8 + 4 * v31 + 214); do { *v41 = *v41 &amp; 0x7FFF | (LOWORD(Dst[v40++]) &lt;&lt; 15); v41 += 2; } while ( v40 &lt; v31 + v43 ); return v27; } v9 = a1 - a4; v10 = a3 - a1; v42 = a1 - a4; v48 = 16 - v7; if ( 16 - v7 &gt;= v10 ) v48 = v10; if ( !v8 ) return v48; v11 = 4 * v9; if ( (4 * v9) &gt; 0x40 ) v11 = 64; v12 = (v8 + 4 * (a4 &amp; 0xF)); v44 = a4 &amp; 0xF; memmove(Dst, v12, v11); v13 = 4 * v48; if ( (4 * v48) &gt; 0x40 ) v13 = 64; memmove(v12, (v8 + 4 * v7), v13); v14 = 4 * v42; if ( (4 * v42) &gt; 0x40 ) v14 = 64; memmove((v8 + 4 * ((a4 + v48) &amp; 0xF)), Dst, v14); if ( !a6 ) return v48; v15 = a4 &amp; 0xF; if ( v44 &lt; v44 + v42 ) { v16 = (v8 + 4 * v44 + 214); do { Dst[v15++] = *v16 &gt;&gt; 15; v16 += 2; } while ( v15 &lt; v44 + v42 ); } if ( v7 &lt; v48 + v7 ) { v17 = (v8 + 4 * v7 + 214); v18 = v12 + 107; v19 = v48; do { v20 = *v17 ^ (*v17 ^ *v18) &amp; 0x7FFF; v17 += 2; *v18 = v20; v18 += 2; --v19; } while ( v19 ); } v21 = a4 &amp; 0xF; if ( v44 &gt;= v44 + v42 ) return v48; v22 = (v8 + 4 * (v44 + v48) + 214); do { *v22 = *v22 &amp; 0x7FFF | (LOWORD(Dst[v21++]) &lt;&lt; 15); v22 += 2; } while ( v21 &lt; v44 + v42 ); return v48; }</span></span></code> </pre> </div></div><br><p>  Al√©m disso, na apar√™ncia, voc√™ pode entender aproximadamente o que est√° acontecendo l√° e o restante para terminar com sinais indiretos. <br>  Tentamos identificar esses recursos indiretos.  Primeiro, defina a altura das linhas 16 a 64, inclusive em ordem aleat√≥ria.  Em seguida, na frente da linha no √≠ndice 39, insira uma nova linha.  A nova linha copiar√° a altura da linha 38. <br>  Vejamos as informa√ß√µes nos grupos de s√©ries antes e depois de adicionar uma s√©rie, destaquei as diferen√ßas arrojadas: </p><br><table><thead><tr><th>  Antes de adicionar uma linha </th><th>  Depois de adicionar uma linha </th></tr></thead><tbody><tr><td>  Deslocamentos no primeiro grupo: </td><td>  Deslocamentos no primeiro grupo: </td></tr><tr><td>  0E, 04, 07, 00, 05, 0A, 09, 0F, 03, 06, 08, 0D, 01, 0B, 0C, 02 </td><td>  0E, 04, 07, 00, 05, 0A, 09, 0F, 03, 06, 08, 0D, 01, 0B, 0C, 02 </td></tr><tr><td>  Os valores das alturas das linhas no primeiro grupo: </td><td>  Os valores das alturas das linhas no primeiro grupo: </td></tr><tr><td>  05, 2B, 35, 45, 4B, 50, 5B, 6B, 7B, 8B, A5, AB, B0, B5, E0, 100 </td><td>  05, 2B, 35, 45, 4B, 50, 5B, 6B, 7B, 8B, A5, AB, B0, B5, E0, 100 </td></tr><tr><td>  Deslocamentos no segundo grupo: </td><td>  Deslocamentos no segundo grupo: </td></tr><tr><td>  06, 02, 0E, 09, 01, 07, <strong>0F, 0C</strong> , 00, 0A, 04, 0B, 03, 08, <strong>0D, 05</strong> </td><td>  06, 02, 0E, 09, 01, 07, <strong>0F, 05, 0C</strong> , 00, 0A, 04, 0B, 03, 08, <strong>0D</strong> </td></tr><tr><td>  Os valores das alturas das linhas no segundo grupo: </td><td>  Os valores das alturas das linhas no segundo grupo: </td></tr><tr><td>  10, 15, 20, 25, 30, <strong>75</strong> , 85, 90, 9B, A0, C5, CB, D0, D5, E5, F0 </td><td>  10, 15, 20, 25, 30, <strong>F0</strong> , 85, 90, 9B, A0, C5, CB, D0, D5, E5, F0 </td></tr><tr><td>  Deslocamentos no terceiro grupo: </td><td>  Deslocamentos no terceiro grupo: </td></tr><tr><td>  0C, 08, 0E, 07, 0A, 01, 06, 0F, 09, 0D, 00, 05, 0B, 02, 04, <strong>03</strong> </td><td>  <strong>03</strong> , 0C, 08, 0E, 07, 0A, 01, 06, 0F, 09, 0D, 00, 05, 0B, 02, 04 </td></tr><tr><td>  Os valores das alturas das linhas no terceiro grupo: </td><td>  Os valores das alturas das linhas no terceiro grupo: </td></tr><tr><td>  0B, 1B, 3B, <strong>40</strong> , 55, 60, 65, 70, 80, 95, BB, C0, DB, EB, F5, FB </td><td>  0B, 1B, 3B, <strong>75</strong> , 55, 60, 65, 70, 80, 95, BB, C0, DB, EB, F5, FB </td></tr><tr><td>  Compensa√ß√µes no quarto grupo: </td><td>  Compensa√ß√µes no quarto grupo: </td></tr><tr><td>  _ </td><td>  <strong>00</strong> </td></tr><tr><td>  Os valores das alturas das linhas no quarto grupo: </td><td>  Os valores das alturas das linhas no quarto grupo: </td></tr><tr><td>  _ </td><td>  <strong>40.</strong> </td></tr></tbody></table><br><p>  Era o que era esperado: o Excel insere no segundo grupo uma nova linha com o √≠ndice 7 (39 &amp; 0xF), cujo deslocamento √© 0x05, copia a altura da linha no √≠ndice 6, enquanto a √∫ltima linha, que foi deslocada 05, √© empurrada para a pr√≥xima grupo, e a partir da√≠ a √∫ltima linha √© empurrada para a quarta, etc. </p><br><p>  Agora vamos ver o que acontece se voc√™ excluir a 29¬™ linha. </p><br><table><thead><tr><th>  Antes de remover uma linha </th><th>  Depois de remover a linha </th></tr></thead><tbody><tr><td>  Deslocamentos no primeiro grupo: </td><td>  Deslocamentos no primeiro grupo: </td></tr><tr><td>  0E, 04, 07, 00, 05, 0A, 09, 0F, 03, 06, 08, 0D, 01, <strong>0B, 0C, 02</strong> </td><td>  0E, 04, 07, 00, 05, 0A, 09, 0F, 03, 06, 08, 0D, 01, <strong>0C, 02, 0B</strong> </td></tr><tr><td>  Os valores das alturas das linhas no primeiro grupo: </td><td>  Os valores das alturas das linhas no primeiro grupo: </td></tr><tr><td>  05, 2B, 35, 45, 4B, 50, 5B, 6B, 7B, 8B, A5, <strong>AB</strong> , B0, B5, E0, 100 </td><td>  05, 2B, 35, 45, 4B, 50, 5B, 6B, 7B, 8B, A5, <strong>85</strong> , B0, B5, E0, 100 </td></tr><tr><td>  Deslocamentos no segundo grupo: </td><td>  Deslocamentos no segundo grupo: </td></tr><tr><td>  <strong>06</strong> , 02, 0E, 09, 01, 07, 0F, 05, 0C, 00, 0A, 04, 0B, 03, 08, 0D </td><td>  02, 0E, 09, 01, 07, 0F, 05, 0C, 00, 0A, 04, 0B, 03, 08, 0D, <strong>06</strong> </td></tr><tr><td>  Os valores das alturas das linhas no segundo grupo: </td><td>  Os valores das alturas das linhas no segundo grupo: </td></tr><tr><td>  10, 15, 20, 25, 30, F0, <strong>85</strong> , 90, 9B, A0, C5, CB, D0, D5, E5, F0 </td><td>  10, 15, 20, 25, 30, F0, <strong>75</strong> , 90, 9B, A0, C5, CB, D0, D5, E5, F0 </td></tr><tr><td>  Deslocamentos no terceiro grupo: </td><td>  Deslocamentos no terceiro grupo: </td></tr><tr><td>  <strong>03</strong> , 0C, 08, 0E, 07, 0A, 01, 06, 0F, 09, 0D, 00, 05, 0B, 02, 04 </td><td>  0C, 08, 0E, 07, 0A, 01, 06, 0F, 09, 0D, 00, 05, 0B, 02, 04, <strong>03</strong> </td></tr><tr><td>  Os valores das alturas das linhas no terceiro grupo: </td><td>  Os valores das alturas das linhas no terceiro grupo: </td></tr><tr><td>  0B, 1B, 3B, <strong>75</strong> , 55, 60, 65, 70, 80, 95, BB, C0, DB, EB, F5, FB </td><td>  0B, 1B, 3B, <strong>40</strong> , 55, 60, 65, 70, 80, 95, BB, C0, DB, EB, F5, FB </td></tr><tr><td>  Compensa√ß√µes no quarto grupo: </td><td>  Compensa√ß√µes no quarto grupo: </td></tr><tr><td>  00 </td><td>  00 </td></tr><tr><td>  Os valores das alturas das linhas no quarto grupo: </td><td>  Os valores das alturas das linhas no quarto grupo: </td></tr><tr><td>  <strong>40.</strong> </td><td>  <strong>50.</strong> </td></tr></tbody></table><br><p>  Em princ√≠pio, quando uma linha √© exclu√≠da, ocorrem opera√ß√µes reversas.  Nesse caso, o quarto grupo continua a existir e o valor da altura da linha √© preenchido com a altura padr√£o com o sinalizador correspondente - 0x8005. </p><br><p>  Esses dados s√£o suficientes para reproduzir esse algoritmo em C #: </p><br><div class="spoiler">  <b class="spoiler_title">Insertrow</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InsertRow</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">SheetLayoutInfo sheetLayoutInfo, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> rowIndex</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rowIndex &gt;= sheetLayoutInfo.MaxRowIndexNonDefault) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; RowHeightInfo etalonRowHeightInfo = GetRowHeightCore(sheetLayoutInfo, rowIndex); RowHeightInfo newRowHeightInfo = etalonRowHeightInfo != <span class="hljs-literal"><span class="hljs-literal">null</span></span> ? etalonRowHeightInfo.Clone() : CreateDefaultRowHeight(sheetLayoutInfo); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> realGroupIndex = (rowIndex + <span class="hljs-number"><span class="hljs-number">1</span></span>) &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> newRowInGroupIndex = (rowIndex + <span class="hljs-number"><span class="hljs-number">1</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0xF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> groupIndex; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (groupIndex = realGroupIndex + sheetLayoutInfo.GroupIndexDelta; groupIndex &lt; sheetLayoutInfo.RowsGroups.Count; groupIndex++, newRowInGroupIndex = <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (groupIndex &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (groupIndex == SheetLayoutInfo.MaxGroupsCount) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; RowsGroupInfo rowsGroupInfo = sheetLayoutInfo.RowsGroups[groupIndex]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rowsGroupInfo == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((newRowHeightInfo.Flags &amp; CustomHeightMask) == <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; rowsGroupInfo = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RowsGroupInfo(); sheetLayoutInfo.RowsGroups[groupIndex] = rowsGroupInfo; } <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> rowInfoIndex = rowsGroupInfo.Indices[newRowInGroupIndex]; RowHeightInfo lastRowHeightInGroup; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rowInfoIndex == <span class="hljs-number"><span class="hljs-number">-1</span></span> || rowsGroupInfo.HeightInfos.Count &lt; SheetLayoutInfo.MaxRowsCountInGroup) { lastRowHeightInGroup = GetRowHeightCore(sheetLayoutInfo, ((groupIndex - sheetLayoutInfo.GroupIndexDelta) &lt;&lt; <span class="hljs-number"><span class="hljs-number">4</span></span>) + SheetLayoutInfo.MaxRowsCountInGroup - <span class="hljs-number"><span class="hljs-number">1</span></span>); Array.Copy(rowsGroupInfo.Indices, newRowInGroupIndex, rowsGroupInfo.Indices, newRowInGroupIndex + <span class="hljs-number"><span class="hljs-number">1</span></span>, SheetLayoutInfo.MaxRowsCountInGroup - <span class="hljs-number"><span class="hljs-number">1</span></span> - newRowInGroupIndex); rowsGroupInfo.HeightInfos.Add(newRowHeightInfo); rowsGroupInfo.Indices[newRowInGroupIndex] = rowsGroupInfo.HeightInfos.Count - <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> lastIndex = rowsGroupInfo.Indices[SheetLayoutInfo.MaxRowsCountInGroup - <span class="hljs-number"><span class="hljs-number">1</span></span>]; lastRowHeightInGroup = rowsGroupInfo.HeightInfos[lastIndex]; Array.Copy(rowsGroupInfo.Indices, newRowInGroupIndex, rowsGroupInfo.Indices, newRowInGroupIndex + <span class="hljs-number"><span class="hljs-number">1</span></span>, SheetLayoutInfo.MaxRowsCountInGroup - <span class="hljs-number"><span class="hljs-number">1</span></span> - newRowInGroupIndex); rowsGroupInfo.HeightInfos[lastIndex] = newRowHeightInfo; rowsGroupInfo.Indices[newRowInGroupIndex] = lastIndex; } newRowHeightInfo = lastRowHeightInGroup ?? CreateDefaultRowHeight(sheetLayoutInfo); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((newRowHeightInfo.Flags &amp; CustomHeightMask) != <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; groupIndex != SheetLayoutInfo.MaxGroupsCount) { SetRowHeight(((groupIndex - sheetLayoutInfo.GroupIndexDelta) &lt;&lt; <span class="hljs-number"><span class="hljs-number">4</span></span>) + newRowInGroupIndex, newRowHeightInfo.Value, newRowHeightInfo.Flags, sheetLayoutInfo); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { sheetLayoutInfo.MaxRowIndexNonDefault = Math.Min(sheetLayoutInfo.MaxRowIndexNonDefault + <span class="hljs-number"><span class="hljs-number">1</span></span>, SheetLayoutInfo.MaxRowsCount); } }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Removow</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RemoveRow</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">SheetLayoutInfo sheetLayoutInfo, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> rowIndex</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rowIndex &gt;= sheetLayoutInfo.MaxRowIndexNonDefault) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> realGroupIndex = rowIndex &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> newRowInGroupIndex = rowIndex &amp; <span class="hljs-number"><span class="hljs-number">0xF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> groupIndex; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (groupIndex = realGroupIndex + sheetLayoutInfo.GroupIndexDelta; groupIndex &lt; sheetLayoutInfo.RowsGroups.Count; groupIndex++, newRowInGroupIndex = <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (groupIndex &lt; <span class="hljs-number"><span class="hljs-number">-1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (groupIndex == <span class="hljs-number"><span class="hljs-number">-1</span></span>) { sheetLayoutInfo.RowsGroups.Insert(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); sheetLayoutInfo.GroupIndexDelta++; groupIndex = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (groupIndex == SheetLayoutInfo.MaxGroupsCount) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> newRowHeightInfo = groupIndex == SheetLayoutInfo.MaxGroupsCount - <span class="hljs-number"><span class="hljs-number">1</span></span> ? <span class="hljs-literal"><span class="hljs-literal">null</span></span> : GetRowHeightCore(sheetLayoutInfo, (groupIndex - sheetLayoutInfo.GroupIndexDelta + <span class="hljs-number"><span class="hljs-number">1</span></span>) &lt;&lt; <span class="hljs-number"><span class="hljs-number">4</span></span>); RowsGroupInfo rowsGroupInfo = sheetLayoutInfo.RowsGroups[groupIndex]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rowsGroupInfo == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (newRowHeightInfo == <span class="hljs-literal"><span class="hljs-literal">null</span></span> || (newRowHeightInfo.Flags &amp; CustomHeightMask) == <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; rowsGroupInfo = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RowsGroupInfo(); sheetLayoutInfo.RowsGroups[groupIndex] = rowsGroupInfo; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (newRowHeightInfo == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { newRowHeightInfo = CreateDefaultRowHeight(sheetLayoutInfo); } <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> rowInfoIndex = rowsGroupInfo.Indices[newRowInGroupIndex]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rowInfoIndex == <span class="hljs-number"><span class="hljs-number">-1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = newRowInGroupIndex; i &lt; SheetLayoutInfo.MaxRowsCountInGroup - <span class="hljs-number"><span class="hljs-number">1</span></span>; i++) { rowsGroupInfo.Indices[i] = rowsGroupInfo.Indices[i + <span class="hljs-number"><span class="hljs-number">1</span></span>]; } rowsGroupInfo.HeightInfos.Add(newRowHeightInfo); rowsGroupInfo.Indices[SheetLayoutInfo.MaxRowsCountInGroup - <span class="hljs-number"><span class="hljs-number">1</span></span>] = rowsGroupInfo.HeightInfos.Count - <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = newRowInGroupIndex; i &lt; rowsGroupInfo.HeightInfos.Count - <span class="hljs-number"><span class="hljs-number">1</span></span>; i++) { rowsGroupInfo.Indices[i] = rowsGroupInfo.Indices[i + <span class="hljs-number"><span class="hljs-number">1</span></span>]; } rowsGroupInfo.Indices[rowsGroupInfo.HeightInfos.Count - <span class="hljs-number"><span class="hljs-number">1</span></span>] = rowInfoIndex; rowsGroupInfo.HeightInfos[rowInfoIndex] = newRowHeightInfo; } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(rowIndex &lt;= sheetLayoutInfo.MinRowIndexNonDefault) { sheetLayoutInfo.MinRowIndexNonDefault = Math.Max(sheetLayoutInfo.MinRowIndexNonDefault - <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); } }</code> </pre> </div></div><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><strong>Voc√™ pode encontrar todo o c√≥digo acima no GitHub</strong></a> </p><br><h2 id="vyvody">  Conclus√µes </h2><br><p>  Esta n√£o √© a primeira vez que o c√≥digo do Excel √© surpreendido por truques interessantes.  Dessa vez, descobri como ele armazena informa√ß√µes sobre as alturas das linhas.  Se a comunidade estiver interessada, no pr√≥ximo artigo, mostrarei como o Excel considera a altura do intervalo de c√©lulas (spoiler: existe algo semelhante √† decomposi√ß√£o do SQRT, mas por algum motivo sem cache de soma), √© poss√≠vel ver como ele aplica o dimensionamento em n√∫meros inteiros . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt435426/">https://habr.com/ru/post/pt435426/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt435416/index.html">T√©cnica de projeto DIY. Parte introdut√≥ria</a></li>
<li><a href="../pt435418/index.html">Usando SQLite no Flutter</a></li>
<li><a href="../pt435420/index.html">O futuro da luta contra o crime √© o estudo de √°rvores geneal√≥gicas</a></li>
<li><a href="../pt435422/index.html">Como as pessoas experientes no Vale do Sil√≠cio</a></li>
<li><a href="../pt435424/index.html">Parse & Android: recomenda√ß√µes para desenvolvedores iniciantes</a></li>
<li><a href="../pt435428/index.html">Controle remoto do emulador Fceux usando Python</a></li>
<li><a href="../pt435430/index.html">As not√≠cias mais legais CES 2019</a></li>
<li><a href="../pt435432/index.html">Ano Novo, Novo GitHub: Reposit√≥rios Privados Gratuitos Ilimitados</a></li>
<li><a href="../pt435436/index.html">5 tend√™ncias em infraestrutura de TI: previs√£o para 2019</a></li>
<li><a href="../pt435438/index.html">PHP: alterando a estrutura do banco de dados no desenvolvimento de equipes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>