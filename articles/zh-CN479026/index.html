<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🌻 ⏮️ 🍓 互联网通道的真实汇总-OpenMPTCPRouter 🤒 👩🏽‍⚖️ 🛎️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="是否可以将多个Internet通道组合成一个通道？ 关于此主题有很多误解和神话，即使是有经验的网络工程师也常常不知道这是可能的。 在大多数情况下，链路聚合被错误地称为NAT或故障转移。 但是实际求和允许在所有Internet通道 （例如，视频广播） 上同时启动一个TCP连接 ，以便在任何Intern...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>互联网通道的真实汇总-OpenMPTCPRouter</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/vdsina/blog/479026/"><img src="https://habrastorage.org/webt/se/rs/1v/sers1v4esjgljbe_rptqoiilyq8.png"><br><br> 是否可以将多个Internet通道组合成一个通道？ 关于此主题有很多误解和神话，即使是有经验的网络工程师也常常不知道这是可能的。 在大多数情况下，链路聚合被错误地称为NAT或故障转移。 但是实际求和允许<b>在所有Internet通道</b> （例如，视频广播） <b>上同时启动一个TCP连接</b> ，以便在任何Internet通道断开时，广播都不会中断。 <br><br> 存在用于视频广播的昂贵的商业解决方案，但是这种设备花费了很多千金。 本文介绍了免费的开放包OpenMPTCPRouter的配置，并分析了有关信道聚合的流行神话。 <br><a name="habracut"></a><br><h2> 渠道总结神话 </h2><br> 有许多支持多WAN功能的家用路由器。 有时制造商称这种渠道总和，这并非完全正确。 许多网络人员认为，除了<a href="https://ru.wikipedia.org/wiki/%25D0%2590%25D0%25B3%25D1%2580%25D0%25B5%25D0%25B3%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5_%25D0%25BA%25D0%25B0%25D0%25BD%25D0%25B0%25D0%25BB%25D0%25BE%25D0%25B2">LACP</a>和L2级别的求和之外，没有其他<a href="https://ru.wikipedia.org/wiki/%25D0%2590%25D0%25B3%25D1%2580%25D0%25B5%25D0%25B3%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5_%25D0%25BA%25D0%25B0%25D0%25BD%25D0%25B0%25D0%25BB%25D0%25BE%25D0%25B2">链路</a>聚合存在。 我经常听到，电信行业的人们通常不可能做到这一点。 因此，我们将尝试了解流行的神话。 <br><br><h2>  IP连接平衡 </h2><br> 这是同时使用多个Internet渠道的最实惠和最受欢迎的方式。 为简单起见，假设您有三个Internet提供商，每个Internet提供商都为您提供了网络中的真实IP地址。 所有这些提供程序都连接到支持Multi-WAN的路由器。 它可以是带有mwan3，mikrotik，ubiquiti软件包或任何其他家用路由器的OpenWRT，因为现在此选项并不罕见。 <br><br> 为了模拟这种情况，请想象提供者给了我们以下地址： <br><br><pre><code class="plaintext hljs">WAN1 — 11.11.11.11 WAN2 — 22.22.22.22 WAN2 — 33.33.33.33</code> </pre> <br> 也就是说，通过每个提供程序连接到远程<b>example.com</b>服务器，该远程服务器将看到三个独立的源ip客户端。 平衡允许您分担通道上的负载，并同时使用所有这三个通道。 为简单起见，假设我们在所有通道之间均分负载。 结果，当客户打开一个站点上通常有三个图像的站点时，他会通过单独的提供程序上传每个图像。 在站点方面，看起来像是来自三个不同IP的连接。 <br><br><img src="https://habrastorage.org/webt/ax/ok/p7/axokp7nlj9_z25icy2_pavghxmq.png"><br>  <font color="9999999"><sup>在连接级别进行平衡时，每个TCP连接都要经过一个单独的provider</sup></font> 。 <br><br> 这种平衡模式通常会给用户带来麻烦。 例如，许多站点将Cookie和令牌紧密地附加到客户端的IP地址，如果突然更改，则该请求将被拒绝或客户端在该站点上注销。 这通常在具有严格用户会话规则的客户银行系统和其他站点上复制。 这是一个简单的说明性示例：VK.com中的音乐文件仅具有与IP绑定的有效会话密钥，并且使用这种平衡的客户端通常不会播放音频，因为请求没有经过与会话绑定的提供者。 <br><br><img src="https://habrastorage.org/webt/f5/yh/ls/f5yhlsflpwxh322jbt9-z0mqc1k.png"><br>  <font color="9999999"><sup>下载种子时，连接级别的平衡求和所有通道的带宽</sup></font> <br><br> 通过这种平衡，您可以在使用多个连接时获得Internet通道速度的总和。 例如，如果三个提供者中的每个提供者的速度为100兆比特，那么在下载种子时，我们将获得300兆比特。 因为洪流打开了许多连接，这些连接分布在所有提供商之间，并最终利用了整个渠道。 <br><br> 重要的是要理解，单个TCP连接将始终仅通过一个提供程序。 也就是说，如果我们通过HTTP下载一个大文件，则将通过其中一个提供程序建立此连接，并且如果与此提供程序的连接中断，则下载也将中断。 <br><br><img src="https://habrastorage.org/webt/mk/tq/4x/mktq4xx2a_e4qkhmws1qam-vdfs.png"><br>  <font color="9999999"><sup>一个连接将始终仅使用一个Internet通道</sup></font> <br><br> 对于视频广播来说是这样。 如果将视频流传输到某种条件的Twitch，则IP连接级别的平衡不会带来任何特别的好处，因为视频流将在同一IP连接中进行广播。 在这种情况下，如果WAN 3提供程序开始出现通信问题，例如数据包丢失或速度降低，您将无法立即切换到另一个提供程序。 广播将必须停止并重新连接。 <br><br><h2> 真通道求和 </h2><br> 通道的实际总和使得可以立即通过所有提供者开始与条件Twitch的一个连接，以使得如果任何提供者断开，连接都不会断开。 这是一个非常困难的任务，仍然没有最佳解决方案。 许多人甚至不知道这是可能的！ <br><br> 从前面的插图中，我们记得有条件的Twitch服务器只能从一个源IP地址接收来自我们的视频流，这意味着它应该始终与我们保持不变，无论哪个提供商掉线，哪个提供商在工作。 为此，我们需要一个汇总服务器，该服务器将终止所有连接并将它们合并为一个。 <br><br><img src="https://habrastorage.org/webt/gp/vd/zd/gpvdzdtkypa4xiffh6vtc6high4.png"><br>  <font color="999999999"><sup>求和服务器将所有通道聚合到一个隧道中。</sup></font>  <font color="999999999"><sup>所有连接均来自求和服务器的地址</sup></font> <br><br> 在此方案中，将使用所有提供程序，并且禁用任何提供程序都不会导致与Twitch服务器的通信中断。 实际上，这是一个特殊的VPN隧道，在它的引擎盖下一次有多个Internet通道。 这种方案的主要任务是获得最高质量的通信信道。 如果问题从提供商之一开始出现，即丢包，增加的延迟，则这不会影响通信质量，因为负载将通过其他更好的可用渠道自动分配。 <br><br><h3> 商业解决方案 </h3><br> 长期以来，这个问题一直困扰着那些直播现场事件并且无法访问高质量Internet的人们。 有多种商业解决方案可用于此类任务，例如，Teradek公司制造了这样的怪异路由器，其中插入了USB调制解调器包： <br><br><div style="text-align:center;"><img width="370" src="https://habrastorage.org/webt/gx/4i/jb/gx4ijbrcmj-wnfvmdng7cjemjho.jpeg"></div><br>  <font color="9999999"><sup>具有频道求和功能的视频广播路由器</sup></font> <br><br> 在此类设备中，通常具有通过HDMI或SDI捕获视频的能力。 与路由器一起，出售对频道求和服务的订阅，以及处理视频流，对其进行转码和进一步中继。 带有一套调制解调器的此类设备的价格从2k美元起，外加对该服务的单独订购。 <br><br> 有时看起来很吓人： <br><br><img src="https://habrastorage.org/webt/x_/nv/dr/x_nvdrtmbkqapprvtdcpsx8ujq8.jpeg"><br><br><h2> 配置OpenMPTCPRouter </h2><br> 发明<a href="https://www.multipath-tcp.org/">MP-TCP协议</a> （MultiPath TCP）的目的是能够一次跨多个通道进行连接。 例如，它<a href="https://developer.apple.com/documentation/foundation/urlsessionconfiguration/improving_network_reliability_using_multipath_tcp">支持iOS，</a>并可以通过WiFi和蜂窝网络同时连接到远程服务器。 重要的是要理解，这些连接不是两个单独的TCP连接，而只是在两个通道上立即建立的一个连接。 为此，远程服务器也必须支持MPTCP。 <br><br>  <a href="https://www.openmptcprouter.com/">OpenMPTCPRouter</a>是一个开源路由器项目，可让您真正添加通道。 作者声明该项目处于alpha状态，但已经可以使用。 它由两部分组成-位于Internet上的汇总服务器和路由器，几个Internet提供商和客户端设备本身连接到它们：计算机，电话。 作为自定义路由器，Raspberry Pi，某些WiFi路由器或常规计算机都可以起作用。 有适合各种平台的现成组件，非常方便。 <br><br><img src="https://habrastorage.org/webt/q3/zr/c9/q3zrc9jy82er0o16sjyp6ysqtvq.png"><br>  <font color="9999999"><sup>OpenMPTCPRouter的工作方式</sup></font> <br><br><h2> 配置汇总服务器 </h2><br> 求和服务器位于Internet上，并终止来自客户端路由器所有通道的连接。 通过OpenMPTCPRouter访问Internet时，此服务器的IP地址将是外部地址。 <br><br> 对于此任务，我们将在Debian 10上使用VPS服务器。 <br><br> 汇总服务器要求： <br><br><ul><li>  MPTCP在OpenVZ虚拟化上不起作用 </li><li> 应该可以安装自己的Linux内核 </li></ul><br> 通过执行单个命令来部署服务器。 该脚本将安装具有mptcp支持和所有必要软件包的内核。 安装脚本可用于Ubuntu和Debian。 <br><br><pre> <code class="plaintext hljs">wget -O - http://www.openmptcprouter.com/server/debian10-x86_64.sh | sh</code> </pre><br> 成功安装服务器的结果。 <br><br><img src="https://habrastorage.org/webt/xu/rd/9s/xurd9sjf9dq1ft7id49nednyju0.png"><br><br> 我们保存了密码，我们将需要它们来配置客户端路由器，然后重新启动。 重要的是要记住，安装后，SSH将在端口65222上可用。重新启动后，您需要确保我们使用新内核启动 <br><br><pre> <code class="plaintext hljs">uname -a Linux test-server.local 4.19.67-mptcp</code> </pre><br> 我们在版本号旁边看到mptcp，这表示内核已正确安装。 <br><br><h2> 设置客户端路由器 </h2><br> 在<a href="https://www.openmptcprouter.com/download">项目站点上</a> ，可以为某些平台使用现成的程序集，例如Raspberry Pi，Banana Pi，Lynksys路由器和虚拟机。 <br>  openmptcprouter的这一部分基于OpenWRT，使用LuCI作为界面，这对曾经接触过OpenWRT的每个人都是熟悉的。 该分发套件重约50MB！ <br><br><img src="https://habrastorage.org/webt/nc/y5/u6/ncy5u6cfasrfqpxgfocqlkk8dnu.jpeg"><br><br> 作为测试平台，我将使用Raspberry Pi和几个具有不同操作员的USB调制解调器：MTS和Megaphone。 我想，如何将图像写入SD卡无需说明。 <br><br> 最初，Raspberry Pi中的以太网端口被配置为具有静态IP地址<b>192.168.100.1</b>的局域网。 为了不弄乱桌子上的电线，我将Raspberry Pi连接到了WiFi接入点，并在计算机的WiFi适配器上设置了静态地址<b>192.168.100.2</b> 。 默认情况下，DHCP服务器未启用，因此您需要使用静态地址。 <br><br> 现在您可以转到Web界面<a href="http://192.168.100.1/">192.168.100.1</a> <br><br> 首次登录时，系统会要求您设置root密码，SSH可以使用相同的密码。 <br><br><img src="https://habrastorage.org/webt/zb/mg/tu/zbmgtumuovlw9wm1jrrtb-wq6kw.png"><br> 在LAN设置中，您可以设置所需的子网并启用DHCP服务器。 <br><br> 我使用的调制解调器被定义为具有单独DHCP服务器的USB以太网接口，因此这需要安装<a href="https://protyposis.net/blog/using-the-huawei-e3372-hi-link-lte-dongle-with-openwrt/">其他软件包</a> 。 该过程与在通常的OpenWRT中设置调制解调器相同，因此在此不再赘述。 <br><br> 接下来，您需要配置WAN接口。 最初，在系统中创建了两个虚拟接口WAN1和WAN2。 需要为它们分配一个物理设备，在我的情况下，这些是USB调制解调器接口的名称。 <br><br> 为了避免混淆接口名称，我建议您通过SSH连接来观看dmesg消息。 <br><br> 由于我的调制解调器本身充当路由器，并且它们本身具有DHCP服务器，因此我不得不更改其内部网络范围的设置并禁用DHCP服务器，因为最初两个调制解调器都从同一网络发出地址，这会引起冲突。 <br><br>  OpenMPTCPRouter要求WAN接口的地址是静态的，因此我们为子网设置了调制解调器，并在菜单系统→openmptcprouter→接口设置中对其进行了配置。 在这里，您需要指定在安装汇总服务器期间获得的IP地址和服务器密钥。 <br><br><img width="400" src="https://habrastorage.org/webt/f5/6s/gh/f56sghurd2nyyvyedwpxmlgwxr4.png"><br><br> 如果成功安装，状态页上将出现类似的图片。 可以看出，路由器能够到达求和服务器，并且两个通道都正常工作。 <br><br><img src="https://habrastorage.org/webt/ba/na/gq/banagqaco2b8hfstnnpvyet9xzk.png"><br><br> 默认模式是shadowsocks + mptcp。 这是包装所有连接的代理。 最初，它被配置为仅处理TCP，但是您可以启用UDP。 <br><br><img src="https://habrastorage.org/webt/5q/ld/hy/5qldhyxa4dro9nrej2gc8g--xw4.png"><br><br> 如果状态页上没有错误，则可以认为该设置已完成。 <br> 对于某些提供程序，当mptcp标志在流量路由上被切断时，可能会出现这样的情况： <br><br><img width="300" src="https://habrastorage.org/webt/uv/wx/kt/uvwxktvpaaca_9m27fjmkzg2n2a.png"><br><br> 在这种情况下，您可以在不使用MPTCP的情况下使用其他操作模式，有关更多信息，请参见<a href="https://github.com/Ysurac/openmptcprouter/issues/177">此处</a> 。 <br><br><h2> 结论 </h2><br>  OpenMPTCPRouter项目非常有趣且重要，因为这可能是解决通道求和问题的唯一开放式综合解决方案。 其他所有内容都是紧密封闭且专有的，或者只是普通人无法处理的单独模块。 在目前的开发阶段，该项目还很粗糙，文档非常差，许多事情根本没有描述。 但是他仍然在工作。 我希望它将继续发展，并且我们将获得能够正常使用组合通道的家用路由器。 <br><br> <a href="https://vdsina.ru/%3Fpartner%3D7d159c89hz"><img src="https://habrastorage.org/webt/ud/xv/wf/udxvwfcz80j3nug11rxaguqelww.png"><br></a> <br><h3> 订阅我们的Instagram开发人员 </h3><br> <a href="http://bit.ly/34w4T9B"><img src="https://habrastorage.org/webt/e5/as/-l/e5as-ltfnotkemk2dsqngygimra.png"></a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN479026/">https://habr.com/ru/post/zh-CN479026/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN479008/index.html">如何在2020年在您的网站上烹饪RTSP，或者为什么公猪没有机会逃脱</a></li>
<li><a href="../zh-CN479016/index.html">保护商业秘密的5个步骤</a></li>
<li><a href="../zh-CN479018/index.html">前端的Docker。 第2部分。您是什么？</a></li>
<li><a href="../zh-CN479020/index.html">Google Play如何在一小时内完成我十年的工作的故事</a></li>
<li><a href="../zh-CN479022/index.html">三星，LG，Vizio和TCL的智能电视每秒获取屏幕的“指纹”并发送到服务器</a></li>
<li><a href="../zh-CN479034/index.html">如何使用openconnect和vpn-slice连接到Linux中的公司VPN</a></li>
<li><a href="../zh-CN479036/index.html">英特尔无法满足对处理器的需求。 惠普和戴尔因此而受苦</a></li>
<li><a href="../zh-CN479038/index.html">数字转换Leroy Merlin：设计用于处理客户呼叫的接口</a></li>
<li><a href="../zh-CN479040/index.html">视觉回归测试。 重新开机</a></li>
<li><a href="../zh-CN479042/index.html">Y方法是构建魔方的一种非常简单的方法</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>