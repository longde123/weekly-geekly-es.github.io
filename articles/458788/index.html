<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ôãÔ∏è üå† üåô Plantillas personalizadas en GTM: un ejemplo üí´ üë®üèø‚Äçüíª üöÇ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A finales de mayo, Google introdujo una nueva funci√≥n en el Administrador de etiquetas de Google (GTM): plantillas personalizadas o plantillas persona...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Plantillas personalizadas en GTM: un ejemplo</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/458788/">  A finales de mayo, Google introdujo una nueva funci√≥n en el Administrador de etiquetas de Google (GTM): plantillas personalizadas o plantillas personalizadas.  Veamos por qu√© es necesario, c√≥mo usarlo, cu√°les son las diferencias con las etiquetas HTML y las variables de JavaScript. <br><br>  Como ejemplo, considere crear una Plantilla personalizada para un p√≠xel de retargeting din√°mico VKontakte y personalizar a√∫n m√°s las etiquetas GTM a trav√©s de √©l. <br><br><img src="https://habrastorage.org/webt/c-/62/zr/c-62zrfxks1t6c2gfsv0kn2brjm.png"><br><a name="habracut"></a><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Palabras simples sobre plantillas personalizadas</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Crear una plantilla personalizada</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">‚Ä¢ pesta√±a Informaci√≥n</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">‚Ä¢ pesta√±a Campos</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">‚Ä¢ pesta√±a C√≥digo</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">‚Ä¢ pesta√±a Permisos</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Personalizaci√≥n y prueba de la etiqueta en la plantilla personalizada creada</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">‚Ä¢ P√°gina vista</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">‚Ä¢ AddToCart</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">‚Ä¢ Prueba de miner√≠a</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Conclusi√≥n</a> <br><br><a name="1"></a><h2>  Palabras simples sobre plantillas personalizadas </h2><br>  Las plantillas personalizadas son plantillas mediante las cuales los usuarios pueden crear nuevas etiquetas o variables.  GTM tiene plantillas listas para usar (en la secci√≥n Destacado o Recomendado), por ejemplo, la etiqueta de Google Analytics, Google Optimize y otras.  Ahora podemos complementarlos con nuestras plantillas.  Una vez creados, aparecer√°n en la pesta√±a Personalizado: <br><br><img src="https://habrastorage.org/webt/nx/q_/mu/nxq_mu_uxl6tyiumnl8xbzt6o2c.png"><br><br>  La diferencia clave de las etiquetas HTML y las variables JS es que cuando un usuario crea una etiqueta o variable de acuerdo con una plantilla preparada, no interact√∫a con el c√≥digo JS. <br><br>  El c√≥digo de la plantilla de usuario est√° escrito por el desarrollador o analista web en la etapa de su creaci√≥n.  Luego, al crear una etiqueta o variable de acuerdo con una plantilla de usuario, toda la interacci√≥n se lleva a cabo a trav√©s de la interfaz (que tambi√©n se configura al crear una plantilla de usuario): <br><br><img src="https://habrastorage.org/webt/pe/e2/te/pee2tevqbahm_nplbfgj0btis34.png"><br><br>  En consecuencia, en comparaci√≥n con escribir una etiqueta HTML o una variable JS, personalizar una etiqueta o variable de acuerdo con una plantilla de usuario se vuelve un orden de magnitud m√°s f√°cil, ya que esto no requiere conocimientos y habilidades para trabajar con JavaScript. <br><br>  Otra gran ventaja de las plantillas personalizadas es que la probabilidad de "poner" un sitio se reduce en un orden de magnitud debido a un error en el c√≥digo JS de la etiqueta. <br><br>  En nuestro ejemplo, para configurar la etiqueta de retargeting din√°mico "VKontakte", ya no necesita ponerse en contacto con los desarrolladores: todo se puede configurar de forma independiente, incluso la transferencia de datos sobre productos (cuando el comercio electr√≥nico avanzado de Google est√° configurado en el sitio), teniendo solo experiencia con GTM. <br><br><a name="2"></a><h2>  Crear una plantilla personalizada </h2><br>  Como estamos creando una plantilla de etiqueta, debemos ir a la secci√≥n Plantillas y hacer clic en el bot√≥n Nuevo en la secci√≥n Plantillas de etiqueta. <br><br><img src="https://habrastorage.org/webt/ca/bt/sa/cabtsaamxy-zoglccqgvt1v_tra.png"><br><br>  Despu√©s de eso, se abre el Editor de plantillas: <br><br><img src="https://habrastorage.org/webt/bf/c3/jf/bfc3jf2xgpkasmc3qvik2tp4wxy.png"><br><br>  En el lado izquierdo del editor est√° la ventana de configuraci√≥n, en el lado derecho est√° la ventana de vista previa y la consola.  Hay cuatro pesta√±as en la ventana de configuraci√≥n que son necesarias para crear y trabajar con la plantilla. <br><br><a name="3"></a><h3>  Pesta√±a Informaci√≥n </h3><br>  La informaci√≥n de la etiqueta se completa en esta pesta√±a: nombre, descripci√≥n, icono.  Esta es la informaci√≥n que veremos al crear una nueva etiqueta en la lista de plantillas: <br><br><img src="https://habrastorage.org/webt/dd/nm/9f/ddnm9fvcygh2ob6jzkliccqgi1o.png"><br><br>  Hay requisitos para el icono de etiqueta: formato PNG, JPEG o GIF, una resoluci√≥n de al menos 64x64 p√≠xeles y un tama√±o de no m√°s de 50 KB. <br><br><a name="4"></a><h3>  Pesta√±a Campos </h3><br>  Esta secci√≥n crea la interfaz de nuestra plantilla.  La interfaz consta de varios campos y formularios con los que el usuario interact√∫a en la etapa de creaci√≥n de una nueva etiqueta o variable. <br><br>  En el futuro, la informaci√≥n que ingres√≥ el usuario al crear la etiqueta usando la interfaz se usa en el c√≥digo de la plantilla. <br><br>  Para agregar un nuevo elemento, haga clic en el bot√≥n Agregar campo.  Aparece la ventana para seleccionar el tipo de elemento: <br><br><img src="https://habrastorage.org/webt/g5/ko/d7/g5kod7ox7dal761180kpdfhojto.png"><br><br>  GTM le permite seleccionar los siguientes tipos de elementos de interfaz: <br><br><ul><li>  <b>cuadro de texto</b> </li><li>  <b>men√∫ desplegable</b> </li><li>  <b>casilla de verificaci√≥n</b> ; </li><li>  <b>interruptores</b> </li><li>  <b>tabla simple</b> , aqu√≠ puede editar cada celda. </li><li>  <b>tabla extendida</b> , solo puede editar una fila, este tipo de tabla es conveniente para crear un diccionario a partir de pares clave-valor; </li><li>  <b>grupo de elementos</b> , le permite agrupar varios tipos en un grupo; </li><li>  <b>el acceso directo se</b> usa para agregar texto a la interfaz; no requiere que el usuario ingrese ning√∫n dato. </li></ul><br>  Despu√©s de agregar un elemento, debe darle un nombre descriptivo, que luego se utilizar√° en el c√≥digo.  Este es un tipo de nombre de variable: debe ser comprensible y revelar la esencia del elemento de interfaz creado.  Por ejemplo, el nombre "ID" no significa nada espec√≠fico, pero el nombre "pixelIDs" ya muestra que las ID de p√≠xeles ingresadas por el usuario se almacenan en este elemento: <br><br><img src="https://habrastorage.org/webt/fv/1h/ht/fv1hht_iaatbuhi1ejovajkehhc.png"><br><br>  A continuaci√≥n, vaya a la configuraci√≥n de cada elemento y active las propiedades necesarias. <br>  En diferentes situaciones, se requieren diferentes propiedades del elemento de interfaz, por lo que de forma predeterminada est√°n todas ocultas y necesitamos activar las que se necesitan ahora: <br><br><img src="https://habrastorage.org/webt/ah/jx/o1/ahjxo1oz0w8fp6pntytshfs1y_o.png"><br><br>  Para diferentes tipos de elementos, las propiedades disponibles difieren, indicar√© los m√°s utilizados, que son casi todos los elementos: <br><br>  <b>1. Nombre para mostrar</b> .  Este es el nombre que el usuario ver√° en la interfaz al crear la etiqueta: <br><br><img src="https://habrastorage.org/webt/jf/lk/-g/jflk-glzt0dahft6vpdx9qrzy8q.png"><br><br>  <b>2. Valor de ejemplo</b> .  Esta es una pista para el usuario sobre qu√© valores ingresar en el campo: <br><br><img src="https://habrastorage.org/webt/b6/zz/sc/b6zzscielm1pjho74x22rk88c0c.png"><br><br>  <b>3. Texto de ayuda</b> .  Este es el texto que el usuario ver√° si pasa el cursor sobre el √≠cono de ayuda del elemento: <br><br><img src="https://habrastorage.org/webt/nv/wo/qr/nvwoqraide7hp-qrbdjaomwvg3e.png"><br><br>  <b>4. Reglas para la verificaci√≥n de datos</b> .  En esta propiedad, puede establecer ciertas reglas para verificar los datos ingresados ‚Äã‚Äãpor el usuario en el campo y, si es necesario, el texto de error que aparece cuando intenta guardar una etiqueta con datos que no pasaron la prueba. <br><br>  Por ejemplo, puede especificar que el campo se debe completar.  El segundo ejemplo: necesita obtener una direcci√≥n de correo electr√≥nico del usuario, luego puede verificar que los datos ingresados ‚Äã‚Äãpor el usuario deben coincidir con la expresi√≥n regular <b>. * @. * \ .. *</b> . <br><br><img src="https://habrastorage.org/webt/3s/ma/pb/3smapbl1aorsc4fsvhwpd-1oy4m.png"><br><br>  Para especificar el texto de error que aparece si los datos ingresados ‚Äã‚Äãno cumplen con las reglas de verificaci√≥n, debe activar la configuraci√≥n avanzada de reglas: <br><br><img src="https://habrastorage.org/webt/kb/zw/qr/kbzwqr32irigkreu9bbht9fxf1m.png"><br><br><img src="https://habrastorage.org/webt/ek/xh/hg/ekxhhgobsta59wpr6uxsbaqzdwg.png"><br><br>  Adem√°s, en la configuraci√≥n avanzada, puede especificar las condiciones bajo las cuales se activa esta regla (el campo Habilitar condici√≥n). <br><br>  <b>5. T√©rminos de inclusi√≥n</b> .  Estas son las condiciones bajo las cuales el usuario tendr√° este elemento de interfaz. <br><br>  Por ejemplo, para no sobrecargar la plantilla con elementos de interfaz, puede hacer aparecer los elementos necesarios cuando la casilla de verificaci√≥n est√° seleccionada.  Es decir, suponga que si un usuario desea configurar la transferencia de datos del producto en un p√≠xel (esto es posible con el sitio avanzado de comercio electr√≥nico de Google configurado en el sitio), luego selecciona la casilla de verificaci√≥n "Usar dataLayer para transferir datos del producto", y despu√©s de marcar la casilla, aparecen elementos en la interfaz de la etiqueta requerido para configurar dicha transferencia.  Si la casilla no est√° marcada, no hay elementos en la interfaz. <br><br><img src="https://habrastorage.org/webt/rp/ui/x_/rpuix__y-ya--_uat8taekcwpa0.png"><br><br>  Observo que aqu√≠ es necesario indicar el nombre del elemento, que tuvo que asignarse inmediatamente despu√©s de agregarlo. <br><br>  A medida que agrega configuraciones y crea una interfaz, todos los cambios se pueden ver y probar de inmediato en la ventana de vista previa: <br><br><img src="https://habrastorage.org/webt/df/bl/l9/dfbll9mc0qvpwcxnbzzx-fbg71g.png"><br><br><a name="5"></a><h3>  Pesta√±a C√≥digo </h3><br>  Esta pesta√±a es un editor de c√≥digo. <br><br>  El c√≥digo de las plantillas personalizadas de GTM est√° escrito en JavaScript ES6 simplificado y se ejecuta en un entorno aislado donde toda la comunicaci√≥n con datos globales (es decir, directamente con la p√°gina) se realiza a trav√©s de la API.  No hay objetos globales, como ventanas o documentos, en √©l, respectivamente, los m√©todos habituales tambi√©n.  Por ejemplo, constructores (nuevo objeto y similares), setTimeout, parseInt, delete, etc.  - Todo esto no funcionar√° en la plantilla personalizada. <br><br>  Pero hay una API para todo esto.  Y, por lo tanto, escribir c√≥digo para la Plantilla personalizada debe comenzar con el hecho de que definimos las API que utilizaremos en nuestro c√≥digo: <br><br><pre><code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// API //     const copyFromWindow = require('copyFromWindow'); //     const setInWindow = require('setInWindow'); //      const injectScript = require('injectScript'); //    const callInWindow = require('callInWindow'); //  ,     ,    const makeTableMap = require('makeTableMap'); //   URL  const getUrl = require('getUrl'); //    const getQueryParameters = require('getQueryParameters'); //     const makeInteger = require('makeInteger'); //    const makeString = require('makeString'); //  setTimeout const callLater = require('callLater'); //  console.log const logToConsole = require('logToConsole');</span></span></code> </pre> <br>  Consulte la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Ayuda del desarrollador de Google para obtener una</a> lista completa de las API con documentaci√≥n detallada. <br><br>  Te mostrar√© ejemplos de c√≥mo trabajar con la API: <br><div class="scrollable-table"><table><tbody><tr><th>  Descripci√≥n de la acci√≥n </th><th>  Js cl√°sico </th><th>  API de plantilla personalizada </th></tr><tr><td>  Salida de la consola </td><td>  console.log ('Hola'); </td><td>  logToConsole ('Hola'); </td></tr><tr><td>  Establecer temporizador </td><td>  setTimeout (funci√≥n, 100); </td><td>  callLater (funci√≥n); </td></tr><tr><td>  Convertir a cadena </td><td>  Cadena (1234); </td><td>  makeString (1234); </td></tr><tr><td>  Conversi√≥n a entero </td><td>  parseInt ('1234', 10); </td><td>  makeInteger ('1234'); </td></tr><tr><td>  Anfitri√≥n de la p√°gina </td><td>  window.location.hostname </td><td>  getUrl ('host'); </td></tr></tbody></table></div><br>  Como puede ver en la tabla de ejemplo, despu√©s de definir la API, debe usarla en lugar de las construcciones JS est√°ndar. <br><br>  Despu√©s de haber definido la API, es conveniente definir un objeto con la configuraci√≥n que ingres√≥ el usuario.  Esto tambi√©n se puede hacer despu√©s, por ejemplo, durante el c√≥digo ejecutable, solicitando los datos necesarios de la configuraci√≥n del usuario.  Pero si definimos el objeto de configuraci√≥n desde el principio, entonces trabajar con el c√≥digo se vuelve m√°s f√°cil y m√°s comprensible, ya que todas las configuraciones del usuario se almacenan en un objeto separado. <br><br>  Para obtener datos de un elemento de interfaz, debe usar la construcci√≥n de datos. <br><br>  {{nombre del elemento}}: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//    const settings = { //  event: data.event, //ID  () pixelIDs: data.pixelIDs, //ID - (  1 -) priceListId: data.priceListId, //   -? fewPriceLists: data.fewPriceLists, //ID - (    ) priceListIds: data.priceListIds === undefined ? data.priceListIds : makeTableMap(data.priceListIds,'hostname','priceListId'), //  ecommerce   ? ecommerceUse: data.ecommerceUse, // ecommerce   eventEcommerce: data.eventEcommerce, //     siteSearchQueryParam: data.siteSearchQueryParam };</span></span></code> </pre><br>  Nota: si pasa indefinido al m√©todo makeTableMap, causar√° un error de script, por lo que utilizo una construcci√≥n con un operador ternario (construcci√≥n abreviada if-else) para filtrar dichos scripts. <br><br><div class="spoiler">  <b class="spoiler_title">Sobre el m√©todo makeTableMap.</b> <div class="spoiler_text">  Si la interfaz utiliza una tabla extendida, los datos que contiene se almacenan de esta forma: <br><br><pre> <code class="javascript hljs">[ <span class="hljs-string"><span class="hljs-string">'key'</span></span>: <span class="hljs-string"><span class="hljs-string">'k1'</span></span>, <span class="hljs-string"><span class="hljs-string">'value'</span></span>: <span class="hljs-string"><span class="hljs-string">'v1'</span></span>}, <span class="hljs-string"><span class="hljs-string">'key'</span></span>: <span class="hljs-string"><span class="hljs-string">'k2'</span></span>, <span class="hljs-string"><span class="hljs-string">'value'</span></span>: <span class="hljs-string"><span class="hljs-string">'v2'</span></span>} ]</code> </pre><br>  Despu√©s de procesar con el m√©todo makeTableMap, los datos se convierten en un objeto regular con pares clave-valor: <br><br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">'k1'</span></span>: <span class="hljs-string"><span class="hljs-string">'v1'</span></span>, <span class="hljs-string"><span class="hljs-string">'k2'</span></span>: <span class="hljs-string"><span class="hljs-string">'v2'</span></span> }</code> </pre><br></div></div><br>  Otro requisito para el c√≥digo de plantilla personalizada: si la etiqueta se ejecuta con √©xito, debe llamar al m√©todo data.gtmOnSuccess () y, en caso de error, llame al m√©todo data.gtmOnFailure (). <br><br>  Por ejemplo, en mi c√≥digo, se llama al m√©todo data.gtmOnSuccess () despu√©s de que la solicitud se haya enviado correctamente, y se llama al m√©todo data.gtmOnFailure () si la descarga falla en la p√°gina del script externo VK openapi.js. <br><br>  Despu√©s de definir la API y definir el objeto con la configuraci√≥n, puede comenzar a escribir un algoritmo para calcular el p√≠xel. <br><br>  Lo principal para recordar aqu√≠ es: <br><br>  ‚Ä¢ Si necesita obtener una variable global, use el m√©todo de la API copyFromWindow. <br><br><pre> <code class="javascript hljs">copyFromWindow(<span class="hljs-string"><span class="hljs-string">'VK'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//VK -   ,    </span></span></code> </pre><br>  ‚Ä¢ Si necesita establecer una variable global, utilizamos el m√©todo de API setInWindow. <br><br><pre> <code class="javascript hljs">setInWindow(<span class="hljs-string"><span class="hljs-string">'openapiInject'</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-comment"><span class="hljs-comment">//openapiInject -   ,    //1 - ,    .</span></span></code> </pre><br>  ‚Ä¢ Si necesita ejecutar una funci√≥n global, usamos el m√©todo de API callInWindow. <br><br><pre> <code class="javascript hljs">callInWindow(<span class="hljs-string"><span class="hljs-string">'VK.Retargeting.Init'</span></span>, p); <span class="hljs-comment"><span class="hljs-comment">//VK.Retargeting.Init -   ,    //p - ,     </span></span></code> </pre><br>  ‚Ä¢ Si necesita agregar un script externo a la p√°gina, use el m√©todo API injectScript. <br><br><pre> <code class="javascript hljs">injectScript(<span class="hljs-string"><span class="hljs-string">'https://vk.com/js/api/openapi.js?159'</span></span>, pixel.setVkAsyncInit(), data.gtmOnFailure, <span class="hljs-string"><span class="hljs-string">'vkPixel'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//https://vk.com/js/api/openapi.js?159 -  ,      //pixel.setVkAsyncInit() - ,        //data.gtmOnFailure - ,        //vkPixel -  ,  ,   URL  .    ,   JavaScript      </span></span></code> </pre><br>  ‚Ä¢ Si necesita obtener la URL (o parte de ella), use el m√©todo getUrl API. <br><br><pre> <code class="javascript hljs">getUrl(<span class="hljs-string"><span class="hljs-string">'host'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//host -  URL,  .  ,  host: protocol, port, path, extension, fragment, query.</span></span></code> </pre><br>  Como escrib√≠ anteriormente, la plantilla personalizada admite JS ES6.  Es recomendable utilizar esta sintaxis, ya que acorta el c√≥digo y lo hace m√°s legible, y el trabajo de JS es m√°s predecible y similar a otros lenguajes de programaci√≥n. <br><br><div class="spoiler">  <b class="spoiler_title">M√°s informaci√≥n sobre la sintaxis de JS ES6</b> <div class="spoiler_text">  Lo principal que es deseable usar son las funciones de flecha y las declaraciones de variables const y let en lugar de var. <br><br>  Una variable declarada a trav√©s de const es una constante cuyo valor no se puede cambiar. <br><br>  Una variable declarada a trav√©s de let difiere de una variable declarada a trav√©s de var de la siguiente manera: <br><br><ul><li>  let no se agrega al objeto de ventana global; </li><li>  la visibilidad se limita al bloque de declaraci√≥n; </li><li>  Las variables declaradas a trav√©s de let no se pueden volver a declarar. </li></ul><br>  Las funciones de flecha son una abreviatura de las funciones habituales: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//1.   const func1 = function() { return 'test'; } //    const func1 = () =&gt; 'test'; //2.   const func2 = function(arg) { if (arg &gt; 0) return 'plus'; else return 'minus'; } //    const func2 = arg =&gt; { if (arg &gt; 0) return 'plus'; else return 'minus'; } //3.   const func3 = function(arg1, arg2){ if (arg1 &gt; arg2) return arg1; else return arg2; } //    const func3 = (arg1, arg2) =&gt; { if (arg1 &gt; arg2) return arg1; else return arg2; }</span></span></code> </pre><br></div></div><br>  Ahora que entendemos c√≥mo usar la API de plantilla personalizada, podemos escribir el c√≥digo de operaci√≥n de la etiqueta usando la sintaxis de JavaScript ES6. <br><br>  Mi c√≥digo contiene m√©todos para iniciar un p√≠xel, instalar VK openapi.js, recuperar datos de productos de dataLayer (con el sitio de comercio electr√≥nico avanzado de Google configurado), procesar estos datos para llevarlos al formulario necesario para enviarlos al p√≠xel de retargeting de VKontakte y el m√©todo de env√≠o de eventos. <br><br>  El m√©todo de activaci√≥n de p√≠xeles admite tres escenarios: <br><br><ol><li>  El p√≠xel se ejecuta en una p√°gina donde falta openapi.js. </li><li>  El p√≠xel se ejecuta en la p√°gina donde hay openapi.js, pero a√∫n no se ha cargado. </li><li>  El p√≠xel se inicia en la p√°gina con openapi.js cargado. </li></ol><br><div class="spoiler">  <b class="spoiler_title">El c√≥digo completo de mi plantilla GTM personalizada para el p√≠xel de retargeting din√°mico VKontakte</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//api const copyFromWindow = require('copyFromWindow'); const setInWindow = require('setInWindow'); const injectScript = require('injectScript'); const callInWindow = require('callInWindow'); const makeTableMap = require('makeTableMap'); const getUrl = require('getUrl'); const getQueryParameters = require('getQueryParameters'); const makeInteger = require('makeInteger'); const makeString = require('makeString'); const callLater = require('callLater'); //    const settings = { event: data.event, pixelIDs: data.pixelIDs, priceListId: data.priceListId, fewPriceLists: data.fewPriceLists, priceListIds: data.priceListIds === undefined ? data.priceListIds : makeTableMap(data.priceListIds,'hostname','priceListId'), ecommerceUse: data.ecommerceUse, eventEcommerce: data.eventEcommerce, siteSearchQueryParam: data.siteSearchQueryParam }; //       const pixel = { //    getPageHostname: () =&gt; getUrl('host'), //    VK getVK: () =&gt; copyFromWindow('VK'), //    VK setVkAsyncInit: () =&gt; { setInWindow('vkAsyncInit', pixel.sendEvent); }, //       getSiteSearchPhrase: () =&gt; { if (settings.event === 'view_search') return getQueryParameters(settings.siteSearchQueryParam); else return undefined; }, //      getEventParams: (products, currencyCode, revenue) =&gt; { let eventParamsClean= {}; let eventParams = { products: eventProducts.getProductParams(products), category_ids: eventProducts.getCategoryString(products), currency_code: currencyCode, total_price: eventProducts.getTotalPrice(products, revenue), search_string: pixel.getSiteSearchPhrase() }; if (eventParams.products !== undefined) eventParamsClean.products = eventParams.products; if (eventParams.category_ids !== undefined) eventParamsClean.category_ids = eventParams.category_ids; if (eventParams.currency_code !== undefined) eventParamsClean.currency_code = eventParams.currency_code; if (eventParams.total_price !== undefined) eventParamsClean.total_price = eventParams.total_price; if (eventParams.search_string !== undefined) eventParamsClean.search_string = eventParams.search_string; return eventParamsClean; }, //  - getPriceListId: hostname =&gt; { if (settings.fewPriceLists) return settings.priceListIds[hostname]; else return settings.priceListId; }, //  openapi.js openapiInit: () =&gt; { injectScript('https://vk.com/js/api/openapi.js?159', pixel.setVkAsyncInit(), data.gtmOnFailure, 'vkPixel'); setInWindow('openapiInject', 1); }, //   sendEvent: () =&gt; { if (settings.event === 'hit') { settings.pixelIDs.split(',').forEach(p =&gt; { callInWindow('VK.Retargeting.Init',p); callInWindow('VK.Retargeting.Hit'); }); } else { const pricelist = pixel.getPriceListId(pixel.getPageHostname()); const name = settings.event; let products = []; if(settings.ecommerceUse) products = name === 'view_home' || name === 'view_category' || name === 'view_search' || name === 'view_other' ? settings.eventEcommerce : settings.eventEcommerce.products; else products = undefined; const currencyCode = settings.ecommerceUse ? settings.eventEcommerce.currencyCode : undefined; const revenue = (settings.ecommerceUse &amp;&amp; name === 'purchase') ? settings.eventEcommerce.actionField.revenue : undefined; const eventParams = settings.ecommerceUse ? pixel.getEventParams(products, currencyCode, revenue) : undefined; settings.pixelIDs.split(',').forEach(p =&gt; { callInWindow('VK.Retargeting.Init',p); callInWindow('VK.Retargeting.ProductEvent', pricelist, name, eventParams); }); }, //   start: () =&gt; { if (pixel.getVK() === undefined &amp;&amp; copyFromWindow('openapiInject') !== 1) { pixel.openapiInit(); data.gtmOnSuccess(); } else if (pixel.getVK() === undefined &amp;&amp; copyFromWindow('openapiInject') === 1) { if (pixel.count &lt; 50) { callLater(pixel.start); pixel.count++; } else return; } else { pixel.sendEvent(); data.gtmOnSuccess(); }, //   count: 0 }; //       const eventProducts = { //    products   getProductParams: products =&gt; { let arr = []; products.forEach(i =&gt; { let productParamsClean = {}; let productParams = { id: makeString(i.id), group_id: makeString(i.brand), price: makeInteger(i.price * 100) / 100 }; if (productParams.id !== 'undefined') productParamsClean.id = productParams.id; if (productParams.group_id !== 'undefined') productParamsClean.group_id = productParams.group_id; if (productParams.price !== 0) productParamsClean.price = productParams.price; arr.push(productParamsClean); }); return arr; }, //       'a,b,c'       getCategoryString: products =&gt; { let categoryId = ''; let check = []; products.forEach(i =&gt; { if(check.indexOf(i.category) === -1) { check.push(i.category); categoryId += ',' + i.category; }); return categoryId.slice(1); }, //     getTotalPrice: (products, revenue) =&gt; { let sumPrice = 0; if (revenue !== undefined ) return makeInteger(revenue * 100) / 100; else { products.forEach(i =&gt; { if (i.hasOwnProperty('quantity')) sumPrice += (makeInteger(i.price * 100) / 100) * makeInteger(i.quantity); else sumPrice += makeInteger(i.price * 100) / 100; }); return sumPrice; }; //  pixel.start();</span></span></code> </pre> <br></div></div><br><a name="6"></a><h2>  Pesta√±a de permisos </h2><br>  Despu√©s de escribir el c√≥digo de etiqueta, queda la etapa final: emitir permisos para interactuar con los datos globales de la p√°gina.  Esto se hace solo en la pesta√±a Permisos. <br><br>  Dado que el c√≥digo se ejecuta en un entorno aislado y la interacci√≥n con los datos globales se produce a trav√©s de la API, para cada m√©todo de la API (cuando sea necesario) debemos especificar manualmente los permisos para ciertas acciones. <br><br>  Esto se hace para enfocar el trabajo con los datos de la p√°gina global de la manera m√°s cuidadosa posible y, por lo tanto, minimizar las posibilidades de "poner" el sitio en un error en el c√≥digo de nuestra plantilla. <br><br>  Para los m√©todos API utilizados en mi c√≥digo, se deben emitir tres tipos de permisos: <br><br><img src="https://habrastorage.org/webt/29/og/lw/29oglwyra6zkhac7_2lr4jpqq5a.png"><br><br>  <b>1. Accede a las variables globales</b> : lee, escribe, ejecuta el acceso a las variables globales que se utilizan en nuestro c√≥digo.  Las variables deben agregarse manualmente y para cada una de ellas indicar lo que permitimos hacer. <br><br><img src="https://habrastorage.org/webt/f3/qb/6b/f3qb6b9sj6rn1v4q55t_z9f362e.png"><br><br>  Por ejemplo, la variable VK solo se puede leer, vkAsyncInit se puede leer y redefinir, y el m√©todo VK.Retargeting.Hit solo se puede ejecutar. <br><br>  <b>2. Lee la URL</b> .  Aqu√≠ debe especificar qu√© partes de la URL pueden recibir.  Permito que se reciba cualquier parte de la URL: <br><br><img src="https://habrastorage.org/webt/do/um/li/doumlixqd-rw2cppm4ordw1svae.png"><br><br>  Pero si lo desea, puede especificar cualquier espec√≠fico: <br><br><img src="https://habrastorage.org/webt/sj/d3/ne/sjd3nefe52_foeat88kifeodi-w.png"><br><br>  <b>3. Inyecta scripts</b> .  Aqu√≠ es necesario registrar las direcciones desde las cuales puede descargar scripts externos.  En mi c√≥digo, solo se carga un script con VK openapi.js, especifico su direcci√≥n: <br><br><img src="https://habrastorage.org/webt/xt/oy/hd/xtoyhd-yprd2sn_eu41mbquh2s0.png"><br><br>  Eso es todo, la configuraci√≥n de la plantilla personalizada est√° completa, puede guardar la plantilla y proceder a la prueba. <br><br><a name="7"></a><h2>  Personalizaci√≥n y prueba de la etiqueta en la plantilla personalizada creada </h2><br>  Como ejemplo, crearemos dos etiquetas de retargeting din√°mico ‚ÄúVKontakte‚Äù utilizando la Plantilla personalizada creada: pageview y addToCart. <br><br><a name="8"></a><h3>  Vista de p√°gina </h3><br>  Entraremos en el contenedor GTM necesario, crearemos una nueva etiqueta, seleccionaremos el tipo de etiqueta VK Pixel en la secci√≥n Personalizada: <br><br><img src="https://habrastorage.org/webt/gd/s-/fi/gds-fi0tqxxcmfkkccsi8trowq4.png"><br><br>  Completamos el nombre de la etiqueta, seleccionamos el evento que se va a rastrear, seleccionamos Hit (esta es una vista de p√°gina est√°ndar), en el campo "ID de p√≠xel", indica la ID de dos p√≠xeles a los que se enviar√°n los datos, separados por una coma y configuramos el disparador de Todas las p√°ginas: <br><br><img src="https://habrastorage.org/webt/vr/op/-0/vrop-0cjfqndkh35qnbtdsoxpc4.png"><br><br>  Guarda la etiqueta creada. <br><br><a name="9"></a><h3>  AddToCart </h3><br>  Crear una etiqueta para un evento y agregar un producto al carrito ser√° un poco m√°s complicado que una etiqueta Hit. <br><br>  Primero, debe transferir los productos que se agregan a la cesta.  Como escrib√≠ anteriormente, esto es posible con el comercio electr√≥nico avanzado de Google configurado en el sitio.  En este caso, los datos del producto se toman de dataLayer. <br><br>  Para hacer esto, necesitamos crear la variable dataLayer en GTM, que almacenar√° el objeto de comercio electr√≥nico para el evento addToCart.  La configuraci√≥n variable se ve as√≠: <br><br><img src="https://habrastorage.org/webt/ko/r5/gu/kor5gumudjjzs9groemuo7nepco.png"><br><br>  En segundo lugar, debe crear un activador que active la etiqueta cuando ocurra el evento addToCart de comercio electr√≥nico (el activador activar√° la etiqueta al presionar el DataLayer con el evento addToCart): <br><br><img src="https://habrastorage.org/webt/og/xl/lt/ogxlltp_4_spurvq8fesqg3uy0m.png"><br><br>  Despu√©s de crear una variable con un objeto de comercio electr√≥nico y un activador, puede comenzar a crear la etiqueta: <br><br><img src="https://habrastorage.org/webt/dp/qg/zq/dpqgzqb27rcdydnjeen5fftp6ba.png"><br><br>  En orden: <br><br><ol><li>  Como evento rastreado, seleccione Agregar al carrito. </li><li>  Completamos la ID separada por comas de dos p√≠xeles a los que se deben transferir los datos. </li><li>  Establezca la casilla de verificaci√≥n "Usar m√∫ltiples listas de precios": para Mosc√∫ y San Petersburgo, en nuestro ejemplo, es necesario usar diferentes listas de precios. </li><li>  Complete la tabla con las listas de precios. </li><li>  Establezca la casilla de verificaci√≥n "Usar comercio electr√≥nico para transferir productos y par√°metros". </li><li>  En el objeto de comercio electr√≥nico de este evento, especifique la variable creada anteriormente. </li><li>  Configuramos el disparador para el evento monitoreado, en este caso: AddToCart. </li><li>  Guardar. </li></ol><br><a name="10"></a><h3>  Prueba de miner√≠a </h3><br>  Para verificar el funcionamiento de los p√≠xeles del retargeting din√°mico en VKontakte, debe activar el modo Vista previa en GTM, vaya a nuestro sitio web y abra la secci√≥n Red en la consola del navegador e ingrese 'rtrg' en el campo Filtro: <br><img src="https://habrastorage.org/webt/ci/m9/z8/cim9z824mbc9dfvdz-4425fe02w.png"><br><br>  Despu√©s de eso, actualizamos la p√°gina y deber√≠amos tener dos solicitudes: el evento Hit enviado en dos p√≠xeles: <br><br><img src="https://habrastorage.org/webt/o0/5x/80/o05x80jeypiwcogusca_zgsnaju.png"><br><br>  El estado 200 significa que el servidor env√≠a y recibe solicitudes con √©xito. <br><br>  Tambi√©n en la ventana Vista previa de GTM, vemos que nuestra etiqueta creada funcion√≥ correctamente para el evento Vista de p√°gina. <br><br>  Para verificar el evento Agregar al carrito, agregue el producto al carrito y en la consola tenemos dos solicitudes m√°s: <br><br><img src="https://habrastorage.org/webt/wt/jm/-k/wtjm-k50mmapqa1xtyva_yd3wcc.png"><br><br>  En la ventana Vista previa de GTM, vemos que la segunda etiqueta funcion√≥ correctamente.  Los datos del producto de dataLayer se extrajeron y procesaron correctamente, tambi√©n se sustituy√≥ la lista de precios correcta. <br><br>  Para el segundo host, la lista de precios tambi√©n se sustituye correctamente: <br><br><img src="https://habrastorage.org/webt/n3/de/h3/n3deh30jep61h2kv9zefwruu8cy.png"><br><br>  Las etiquetas para otros eventos se configuran y verifican de la misma manera. <br><br><a name="11"></a><h2>  Conclusi√≥n </h2><br>  Las plantillas personalizadas est√°n cambiando el paradigma familiar de usar GTM.  Todos est√°n acostumbrados a las etiquetas HTML y las variables JS, pero ahora hay una gran alternativa. <br><br>  Es suficiente crear una plantilla personalizada de alta calidad una vez, y luego cualquiera que est√© familiarizado con GTM puede usarla. <br><br>  Dada la capacidad de compartir las plantillas creadas, creo que deber√≠an ganar popularidad entre los usuarios. <br><br>  Puede <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">descargar la plantilla de</a> p√≠xel de retargeting din√°mico <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">personalizado de</a> VKontakte, que examinamos en este art√≠culo. <br><br>  Para importar una plantilla, debe crear una nueva plantilla personalizada y seleccionar Importar en el men√∫: <br><br><img src="https://habrastorage.org/webt/mx/nn/jc/mxnnjc0419poxmshokabjcgeoye.png"><br><br>  <i>Material preparado por m√≠ para ppc.world</i> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/458788/">https://habr.com/ru/post/458788/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../458774/index.html">DBMS funcional</a></li>
<li><a href="../458778/index.html">Satellite 6.5 Reporting Engine: qu√© y por qu√©</a></li>
<li><a href="../458782/index.html">Adaptaci√≥n de programas para ZX Spectrum a TR-DOS por medios modernos. Parte 3</a></li>
<li><a href="../458784/index.html">Transmita proyectos y bibliotecas de Altium Designer a PADS Professional</a></li>
<li><a href="../458786/index.html">Los guardianes de los videojuegos mantienen la cultura del juego paso a paso</a></li>
<li><a href="../458790/index.html">Introducci√≥n a CatBoost. Informe Yandex</a></li>
<li><a href="../458792/index.html">Empleados "quemados": ¬øhay alguna salida?</a></li>
<li><a href="../458794/index.html">Reuni√≥n de analistas de negocios en Redmadrobot 18 de julio</a></li>
<li><a href="../458796/index.html">C√≥mo preparar su sitio para grandes cargas de trabajo: 5 consejos pr√°cticos y herramientas √∫tiles</a></li>
<li><a href="../458798/index.html">Nutrient Bot o c√≥mo quiero tomar el pan de los entrenadores de fitness</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>