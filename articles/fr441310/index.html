<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üåÜ üë®üèΩ‚Äçüé® ü¶Ç Exp√©rience dans la construction d'infrastructures sur une architecture de microservices üë¥üèø üë©‚Äçüé® ü•õ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Au cours de l'ann√©e √©coul√©e, il y a eu tellement de publications sur les microservices que ce serait une perte de temps de dire ce que c'est et pourqu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Exp√©rience dans la construction d'infrastructures sur une architecture de microservices</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/441310/"><p><img src="https://habrastorage.org/webt/vn/kb/qn/vnkbqnbwlqbmim3tn1ipiy_rhri.jpeg"></p><br><p>  Au cours de l'ann√©e √©coul√©e, il y a eu tellement de publications sur les microservices que ce serait une perte de temps de dire ce que c'est et pourquoi, donc le reste de la discussion se concentrera sur la question de savoir comment mettre en ≈ìuvre cette architecture et pourquoi elle a √©t√© confront√©e exactement et quels probl√®mes elle a rencontr√©s. </p><br><p>  Nous avons eu de gros probl√®mes dans une petite banque: 3 monolithes de python connect√©s par une quantit√© monstrueuse d'interactions RPC synchrones avec un grand volume d'h√©ritage.  Afin de r√©soudre au moins partiellement tous les probl√®mes qui se posent dans ce cas, il a √©t√© d√©cid√© de passer √† une architecture de microservice.  Mais avant de d√©cider d'une telle √©tape, vous devez r√©pondre √† 3 questions principales: </p><br><ul><li>  Comment briser un monolithe en microservices et quels crit√®res doivent √™tre suivis. </li><li>  Comment les microservices interagiront-ils? </li><li>  Comment surveiller? </li></ul><br><p>  En fait, de br√®ves r√©ponses √† ces questions seront consacr√©es √† cet article. </p><a name="habracut"></a><br><h2 id="kak-razbit-monolit-na-mikroservisy-i-kakimi-kriteriyami-sleduet-pri-etom-rukovodstvovatsya">  Comment briser un monolithe en microservices et quels crit√®res doivent √™tre suivis. </h2><br><p>  Cette question apparemment simple a finalement d√©termin√© l'ensemble de l'architecture future. </p><br><p>  Nous sommes une banque, donc tout le syst√®me tourne autour des op√©rations avec des finances et diverses choses auxiliaires.  Il est certainement possible de transf√©rer <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">des transactions financi√®res ACID vers un syst√®me distribu√© avec des sagas</a> , mais dans le cas g√©n√©ral, c'est extr√™mement difficile.  Ainsi, nous avons d√©velopp√© les r√®gles suivantes: </p><br><ul><li>  Conformez-vous √† S de SOLID pour les microservices </li><li>  La transaction doit √™tre enti√®rement effectu√©e dans le microservice - aucune transaction distribu√©e sur les dommages de la base de donn√©es </li><li>  Pour fonctionner, le microservice a besoin d'informations de sa propre base de donn√©es ou d'une requ√™te </li><li>  Essayez d'assurer la propret√© (au sens des langages fonctionnels) des microservices </li></ul><br><p>  Naturellement, en m√™me temps, il √©tait impossible de les satisfaire compl√®tement, mais m√™me une mise en ≈ìuvre partielle simplifie consid√©rablement le d√©veloppement. </p><br><h2 id="kakim-obrazom-mikroservisy-budut-vzaimodeystvovat">  Comment les microservices interagiront-ils? </h2><br><p>  Il existe de nombreuses options, mais au final, toutes peuvent √™tre r√©sum√©es par de simples "messages d'√©change de microservices", mais si vous impl√©mentez un protocole synchrone (par exemple, RPC via REST), la plupart des inconv√©nients du monolithe resteront, mais les avantages des microservices n'appara√Ætront gu√®re.  La solution √©vidente √©tait donc de prendre n'importe quel courtier de messages et de commencer.  Le choix entre RabbitMQ et Kafka s'est install√© sur ce dernier, et voici pourquoi: </p><br><ul><li>  Kafka est plus simple et fournit un mod√®le de messagerie unique - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Publier - s'abonner</a> </li><li>  Il est relativement facile d'obtenir des donn√©es de Kafka une deuxi√®me fois.  Ceci est extr√™mement pratique pour le d√©bogage ou la correction de bogues lors d'un traitement incorrect, ainsi que pour la surveillance et la journalisation. </li><li>  Un moyen clair et simple de faire √©voluer le service: ajout de partitions au sujet, lancement de plus d'abonn√©s - le reste sera fait par kafka. </li></ul><br><p>  De plus, je veux attirer l'attention sur une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">comparaison d√©taill√©e de tr√®s haute qualit√©</a> . </p><br><p>  Les files d'attente sur kafka + asynchronie nous permettent de: </p><br><ul><li>  D√©sactivez bri√®vement tout microservice pour les mises √† jour sans cons√©quences notables pour le reste </li><li>  D√©sactivez tout service pendant une longue p√©riode et ne vous souciez pas de la r√©cup√©ration de donn√©es.  Par exemple, le microservice de fiscalisation a r√©cemment chut√©.  Il a √©t√© r√©par√© apr√®s 2 heures, il a pris les comptes bruts de Kafka et a tout trait√©.  Il n'√©tait pas n√©cessaire, comme auparavant, de restaurer ce qui devait s'y produire et d'ex√©cuter manuellement les journaux HTTP et une table distincte dans la base de donn√©es. </li><li>  Ex√©cutez des versions de test des services sur les donn√©es actuelles de la vente et comparez les r√©sultats de leur traitement avec la version du service sur la vente. </li></ul><br><p>  En tant que syst√®me de s√©rialisation des donn√©es, nous avons choisi AVRO, pourquoi - d√©crit dans un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article s√©par√©</a> . </p><br><p>  Mais quelle que soit la m√©thode de s√©rialisation choisie, il est important de comprendre comment le protocole sera mis √† jour.  Bien qu'AVRO supporte la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">r√©solution de sch√©ma,</a> nous ne l'utilisons pas et d√©cidons de mani√®re purement administrative: </p><br><ul><li>  Les donn√©es dans les rubriques sont √©crites et lues uniquement via AVRO, le nom de la rubrique correspond au nom du sch√©ma (et Confluent a une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">approche diff√©rente</a> - ils √©crivent les sch√©mas ID AVRO √† partir du registre dans les octets √©lev√©s du message, afin qu'ils puissent avoir diff√©rents types de messages dans une rubrique </li><li>  Si vous devez ajouter ou modifier des donn√©es, un nouveau sch√©ma est cr√©√© avec un nouveau sujet dans kafka, apr√®s quoi tous les producteurs passent √† un nouveau sujet, puis sont suivis par les abonn√©s </li></ul><br><p>  Nous stockons les circuits AVRO eux-m√™mes dans des sous-modules git et nous nous connectons √† tous les projets kafka.  Ils ont d√©cid√© de ne pas encore mettre en place un registre centralis√© des r√©gimes. </p><br><p>  PS: mes coll√®gues ont <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">fait l'option opensource mais uniquement avec le sch√©ma JSON au lieu d'AVRO</a> . </p><br><h3 id="nekotorye-tonkosti">  Quelques subtilit√©s </h3><br><h4 id="kazhdyy-podpischik-poluchaet-vse-soobscheniya-iz-topika">  Chaque abonn√© re√ßoit tous les messages du sujet </h4><br><p>  C'est la sp√©cificit√© du mod√®le d'interaction Publier - s'abonner - lorsqu'il est abonn√© √† un sujet, l'abonn√© les recevra tous.  Par cons√©quent, si le service n'a besoin que de certains messages, il devra les filtrer.  Si cela devient un probl√®me, il sera possible de cr√©er un routeur de service s√©par√© qui disposera des messages dans plusieurs rubriques diff√©rentes, mettant ainsi en ≈ìuvre une partie de la fonctionnalit√© RabbitMQ qui n'est pas dans le kafka.  Maintenant, nous avons un abonn√© sur python dans un thread qui traite environ 7 √† 5 000 messages par seconde, mais si vous ex√©cutez via PyPy, la vitesse passe √† 11-15 000 / sec. </p><br><h4 id="ogranichenie-vremeni-zhizni-ukazatelya-v-topike">  Limiter la dur√©e de vie d'un pointeur dans un sujet </h4><br><p>  Dans les param√®tres de la kafka, il y a un param√®tre qui limite le temps pendant lequel la kafka "se souvient" de l'endroit o√π le lecteur s'est arr√™t√© - la valeur par d√©faut est 2 jours.  Il serait bon de le porter √† une semaine, de sorte que si le probl√®me survient les jours f√©ri√©s et que 2 jours ne soient pas r√©solus, cela ne conduirait pas √† une perte de position dans le sujet. </p><br><h4 id="ogranichenie-vremeni-na-podtverzhdenie-chteniya">  Lire le d√©lai de confirmation </h4><br><p>  Si le lecteur Kafka ne confirme pas la lecture dans les 30 secondes (param√®tre configurable), le courtier pense que quelque chose s'est mal pass√© et une erreur se produit lors de la tentative de confirmation de la lecture.  Pour √©viter cela, lors du traitement d'un message pendant une longue p√©riode, nous envoyons des confirmations de lecture sans d√©placer le pointeur. </p><br><h4 id="graf-svyazey-poluchaetsya-trudnym-dlya-vospriyatiya">  Le graphique des connexions est difficile √† comprendre. </h4><br><p>  Si vous dessinez honn√™tement toutes les relations dans graphviz, un h√©risson de l'apocalypse, qui est traditionnel pour les microservices, appara√Æt avec des dizaines de connexions dans un n≈ìud.  Pour au moins en quelque sorte le rendre (le graphique des connexions) lisible, nous nous sommes mis d'accord sur la notation suivante: microservices - ovales, sujets de kafka - rectangles.  Ainsi, sur un graphique, il est possible d'afficher √† la fois le fait de l'interaction et son type.  Mais, h√©las, √ßa ne va pas beaucoup mieux.  Cette question est donc toujours ouverte. </p><br><p><img src="https://habrastorage.org/webt/fy/lw/qf/fylwqfrc5nspiw_ci170mvntzku.png"></p><br><h2 id="kak-osuschestvlyat-monitoring">  Comment surveiller? </h2><br><p>  M√™me dans le cadre du monolithe, nous avions des journaux dans les fichiers et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Sentry.</a> Mais alors que nous passions √† l'interaction via Kafka et d√©ployions vers k8, les journaux √©taient d√©plac√©s vers ElasticSearch et, en cons√©quence, nous avons d'abord surveill√© la lecture des journaux de l'abonn√© dans Elastic.  Pas de journaux - pas de travail. <br>  Apr√®s cela, ils ont commenc√© √† utiliser Prometheus et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">kafka-exporter a</a> l√©g√®rement modifi√© son tableau de bord: <a href="">https://github.com/kkirsanov/articles/blob/master/2019-habr-kafka/dashboard.json</a> </p><br><p>  En cons√©quence, nous obtenons ces images: <br><img src="https://habrastorage.org/webt/lg/bg/k5/lgbgk5zs7fzl_3hrhork-ybejjw.png"><br>  Vous pouvez voir quel service a cess√© de traiter quels messages. </p><br><p>  De plus, tous les messages des sujets cl√©s (transactions de paiement, notifications des partenaires, etc.) sont copi√©s dans InfluxDB, qui est configur√© dans le m√™me grafana.  Ainsi, nous pouvons non seulement enregistrer le fait de la transmission des messages, mais √©galement effectuer divers √©chantillons en fonction du contenu.  Ainsi, les r√©ponses √† des questions telles que ¬´quel est le d√©lai moyen pour une r√©ponse d'un service¬ª ou ¬´Le flux de transactions est-il tr√®s diff√©rent aujourd'hui d'hier dans ce magasin¬ª sont toujours √† port√©e de main. </p><br><p>  De plus, pour simplifier l'analyse des incidents, nous utilisons l'approche suivante: chaque service, lors du traitement d'un message, le compl√®te avec des m√©ta-informations contenant l'UUID √©mis lorsque le syst√®me affiche un tableau d'enregistrements du type: </p><br><ul><li>  nom du service </li><li>  UUID du processus de traitement dans ce microservice </li><li>  horodatage de d√©marrage du processus </li><li>  temps de traitement </li><li>  jeu de balises </li></ul><br><p>  Par cons√©quent, lorsque le message passe √† travers le graphe de calcul, le message est enrichi d'informations sur le chemin parcouru sur le graphe.  Il s'av√®re un analogue de zipkin / opentracing pour MQ, qui permet de recevoir un message pour restaurer facilement son chemin sur le graphique.  Cela acquiert une valeur sp√©ciale dans les cas o√π des cycles apparaissent sur le graphique.  Rappelez-vous l'exemple d'un petit service dont la part des paiements n'est que de 0,0001%. En analysant les m√©ta-informations contenues dans le message, il peut d√©terminer s'ils sont √† l'origine du paiement, sans contacter la base de donn√©es pour v√©rification. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr441310/">https://habr.com/ru/post/fr441310/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr441296/index.html">OpenStreetMap Part Medium: Visualisation de donn√©es cach√©es</a></li>
<li><a href="../fr441298/index.html">Cisco Live EMEA 2019: remplacer l'ancien v√©lo informatique par BMW dans les nuages</a></li>
<li><a href="../fr441300/index.html">Anachronismes, craquements, mauvaise structure organisationnelle: trois douleurs de chef d'√©quipe dans une entreprise</a></li>
<li><a href="../fr441302/index.html">AMA avec Habr (ligne directe avec TM, v 6.0)</a></li>
<li><a href="../fr441306/index.html">Comment obtenir une offre √† Moscou en 1 jour pour un ing√©nieur QA (et c'est cher de vivre ici)</a></li>
<li><a href="../fr441312/index.html">Le monde flou du bruit de Perlin</a></li>
<li><a href="../fr441314/index.html">PyCon Russia 2019: r√©ponses aux questions cl√©s</a></li>
<li><a href="../fr441316/index.html">Choisir de vrais √©couteurs sans fil: 6 mois plus tard ...</a></li>
<li><a href="../fr441318/index.html">Extensions de code Visual Studio populaires</a></li>
<li><a href="../fr441320/index.html">Apprivoisez votre support technique</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>