<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤹🏿 🚊 🤦🏾 Datenkonsistenz in stark ausgelasteten Systemen 🖕🏻 🐠 👩🏿‍🌾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Problem 
 Fast jedes Informationssystem benötigt eine fortlaufende Datenspeicherung. In den meisten Systemen mit kleiner und mittlerer Last wird diese...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Datenkonsistenz in stark ausgelasteten Systemen</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/431854/"><h2>  Problem </h2><br>  Fast jedes Informationssystem benötigt eine fortlaufende Datenspeicherung.  In den meisten Systemen mit kleiner und mittlerer Last wird diese Funktion von relationalen DBMS ausgeführt, deren unbestreitbarer Vorteil die Garantie der Datenkonsistenz ist. <br><br>  Ein klassisches Beispiel, das erklärt, was Datenkonsistenz ist - das Überweisen von Geldern von einem Konto auf ein anderes.  In dem Moment, in dem die Änderung des Kontostands eines Kontos bereits abgeschlossen ist und das andere noch keine Zeit hatte, kann ein Fehler auftreten.  Dann wird das Geld von einem Konto abgebucht, aber nicht einem anderen gutgeschrieben.  Dieser Zustand der Systemdaten wird als inkonsistent bezeichnet, und es besteht möglicherweise keine Notwendigkeit zu erklären, zu welchen Konsequenzen dies führen kann.  Relationale DBMS bieten einen Transaktionsmechanismus, der jederzeit Datenkonsistenz garantiert.  Eine Transaktion ist eine endliche Menge von Operationen, die einen konsistenten Zustand in einen anderen konsistenten Zustand übertragen. <a name="habracut"></a>  Im Falle eines Fehlers bei einem Schritt bricht das DBMS alle zuvor ausgeführten Vorgänge ab und bringt die Daten in den ursprünglich vereinbarten Zustand zurück.  Mit anderen Worten, entweder werden alle Operationen ausgeführt oder keine einzige. <br><br>  Bei großen Systemen ist es aufgrund der zu hohen Last bei weitem nicht immer möglich, eine einzige Datenbank in ihnen zu verwenden.  In solchen Fällen wird jedem Systemmodul (Dienst) eine eigene Datenbank zur Verfügung gestellt.  In diesem Fall stellt sich die Frage, wie die Datenkonsistenz für eine solche Clusterarchitektur sichergestellt werden kann. <br><br><h2>  Datenkonsistenz lösen </h2><br>  Eine Lösung sind verteilte Transaktionen.  Zuerst müssen alle Knoten des Clusters zustimmen, dass die Operation möglich ist, dann werden die Änderungen an alle Knoten übergeben.  Da die Knoten kein gemeinsames Speichergerät haben, besteht die einzige Möglichkeit, zu einer gemeinsamen Meinung zu gelangen, darin, sich auf ein verteiltes Konsensprotokoll zu einigen. <br><br>  Ein einfaches Protokoll zum Erfassen globaler Transaktionen ist das Two-Phase-Commit (2PC).  Der Knoten, der die Transaktion ausführt, wird als Koordinator betrachtet.  In der Vorbereitungsphase (Vorbereitung) informiert der Koordinator die anderen Knoten über das Transaktions-Commit und wartet auf die Bestätigung von ihnen, dass sie zum Commit bereit sind.  Wenn mindestens ein Knoten nicht bereit ist, wird die Transaktion unterbrochen.  In der Festschreibungsphase informiert der Koordinator alle Knoten über die Entscheidung, die Transaktion festzuschreiben.  Nach Erhalt der Bestätigung von allen, dass alles in Ordnung ist, erfasst der Koordinator auch die Transaktion. <br><br><img src="https://access.redhat.com/webassets/avalon/d/JBoss_Enterprise_Application_Platform-5-Transactions_Development_Guide-en-US/images/721547b5fb5ee9da94ec3200cb1231fe/fig-two-phase-commit-overview.png" alt="Bild"><br><br><h4>  Abbildung 1 - Allgemeines Schema eines Zwei-Phasen-Commits </h4><br>  Dieses Protokoll vermeidet ein Minimum an Nachrichten, ist jedoch nicht robust.  Wenn der Koordinator beispielsweise nach der Vorbereitungsphase ausfällt, haben die verbleibenden Knoten keine Informationen darüber, ob die Transaktion festgeschrieben oder abgebrochen werden soll (sie müssen warten, bis der Fehler behoben ist).  Ein weiterer schwerwiegender Nachteil von 2PC (und anderen verteilten Transaktionsprotokollen, z. B. 3PC) besteht darin, dass mit zunehmender Anzahl von Clusterknoten die Leistung von zweiphasigen Commits abnimmt. <br><br><img src="http://www.techort.com/wp-content/uploads/2018/10/1539271021_859_data-integrity-in-microservice-architecture-how-to-ensure-it-without-distributed-transactions-and-tight-connectivity-avito-habr-blog.png" alt="Bild"><br><br><h4>  Abbildung 2 - Abhängigkeit der Geschwindigkeit eines Zwei-Basen-Commits von der Anzahl der Server in einem DBMS-Cluster </h4><br>  Darüber hinaus unterliegt der verteilte Transaktionsansatz einer Einschränkung: Alle Module des Systems müssen dasselbe DBMS verwenden, was nicht immer praktisch ist. <br><br>  Eine weitere Option besteht darin, einen Mechanismus bereitzustellen, mit dem Sie mit verschiedenen Datenbanken (für Dienste) als einzelne Datenbank arbeiten können (um das Problem mit der Datenintegrität in einer verteilten Datenbank zu lösen).  Gleichzeitig ist ein bestimmtes Analogon einer Transaktion für ein verteiltes System („Geschäftstransaktion“) erforderlich. <br><br>  Bei normalen Transaktionen sowie bei zweiphasigen Festschreibungen werden alle Vorgänge vom Transaktionsmechanismus gesteuert (unter Verwendung von Sperren). Dies geschieht, um die Möglichkeit zu bieten, jeden Vorgang zurückzusetzen (pessimistischer Ansatz - wir betrachten jeden Vorgang als potenziell fehlerhaft).  Dies ist der Engpass des Systems.  Eine Alternative ist der sogenannte optimistische Ansatz: Wir glauben, dass die meisten Operationen erfolgreich abgeschlossen werden.  Wir führen auch zusätzliche Maßnahmen durch, wenn ein Fehler vorliegt.  Das heißt,  Reduzierung der Kosten für die meisten Vorgänge, was zu einer Steigerung der Produktivität führt. <br><br><h2>  Was ist eine Saga und wie funktioniert sie? </h2><br>  Eine Alternative zu Transaktionen für die Microservice-Architektur ist Saga.  Saga (Saga) ist eine Reihe von Schritten, die von verschiedenen Modulen des Systems (Dienste) ausgeführt werden.  Außerdem ist der Saga-Service erforderlich, der für den gesamten Betrieb (Geschäftsvorgang) verantwortlich ist.  Schritte werden durch ein Ereignisdiagramm verknüpft.  Nach Abschluss der Saga muss das System von einem vereinbarten Zustand in einen anderen wechseln (bei erfolgreicher Ausführung) oder zum vorherigen vereinbarten Zustand zurückkehren (im Falle einer Stornierung). <br><br>  Wie kann eine solche Rückgabe oder ein Rollback eines Geschäftsvorfalls implementiert werden?  Zu diesem Zweck verwendet die Saga den Mechanismus der Aufhebung von Schritten (Ausgleichsmaßnahmen).  Beispielsweise war einer der Schritte erfolgreich (z. B. wurde der Benutzerdatenbanktabelle ein Eintrag hinzugefügt), aber einer der folgenden Schritte schlug fehl und die gesamte Saga sollte abgebrochen werden.  Dann erhält derselbe Dienst einen Befehl - brechen Sie die Aktion ab.  Im Service-DBMS wurde die lokale Transaktion jedoch bereits abgeschlossen und der Benutzerdatensatz hinzugefügt.  Um zum vorherigen Status zurückzukehren, muss der Dienst eine Ausgleichsaktion ausführen (in unserem Beispiel löschen Sie den Datensatz).  Durch die Aufhebung von Schritten kann die Atomizität („alles oder nichts“) im Rahmen der Saga implementiert werden - alle Schritte werden ausgeführt oder kompensiert. <br><br><img src="https://cdn-images-1.medium.com/max/1200/1*IUfYVaCXhQHWqM13_6sLhQ.png" alt="Bild"><br><br><h4>  Abbildung 3 - Der Arbeitsmechanismus von Saga und die Art des Ausgleichseffekts </h4><br>  In Abbildung 3 sind die Schritte der Saga als T1 ... T4 bezeichnet, wobei die Aktionen kompensiert werden: C1 ... C4. <br>  Sagas unterstützen die Idempotenz von Schritten (eine Aktion, deren wiederholte Wiederholung einer einzelnen entspricht).  Der Sag-Ansatz bietet die Möglichkeit, einen beliebigen Schritt zu wiederholen (z. B. wenn Sie nach erfolgreichem Abschluss keine Antwort erhalten haben).  Mit Idempotenz können Sie auch den Status wiederherstellen, wenn Daten auf einem Knoten verloren gehen (Fehler und Wiederherstellung).  Bei der Ausführung eines Schritts sollte jeder Dienst (anhand des Idempotenzschlüssels) bestimmen, ob er diesen Schritt bereits ausgeführt hat oder nicht (falls nicht, ausführen, andernfalls überspringen).  Zur Kompensation von Aktionen können auch Idempotenzschlüssel und Wiederholungen von Vorgängen hinzugefügt werden (um Persistenz / Stabilität zu gewährleisten). <br><br><h2>  Zusammenfassung </h2><br>  Von den vier Anforderungen für das ACID-Transaktionssystem (Atomizität, Konsistenz, Isolation, Stabilität) ermöglicht der Durchhangmechanismus die Implementierung von drei - alle außer Isolation.  Mangelnde Isolation kann zu Anomalien führen ("Dirty Reads", "nicht wiederholbare Lesevorgänge", Umschreiben von Änderungen zwischen verschiedenen Geschäftsvorfällen usw.).  Um solche Situationen zu überwinden, müssen zusätzliche Mechanismen verwendet werden, beispielsweise die Versionierung veränderlicher Objekte. <br><br>  Mit Sagas können Sie die folgenden Aufgaben lösen: <br><br><ul><li>  Bereitstellung abhängiger Datenänderungen für geschäftskritische Daten; </li><li>  In der Lage sein, eine strikte Reihenfolge der Schritte festzulegen; </li><li>  100% ige Konsistenz einhalten (Daten auch bei Unfällen koordinieren); </li><li>  Stellen Sie Leistungsprüfungen auf allen Ebenen bereit. </li></ul><br><h2>  Anwendungsbereich und Anwendungsbeispiele </h2><br>  Sagas werden häufig auf Systemen mit einer großen Anzahl von Anforderungen verwendet.  Zum Beispiel beliebte E-Mail-Dienste, soziale Netzwerke.  Der Ansatz kann jedoch in kleineren Projekten Anwendung finden. <br><br>  Unser Unternehmen hat Erfahrung in der Entwicklung eines Buchhaltungssystems für ein großes Unternehmen, das für mehrere Dutzend Benutzer konzipiert wurde und in dem alle Daten in einem relationalen DBMS gespeichert wurden.  Das Problem trat bei der Implementierung der automatischen Berechnung der geplanten Arbeit auf: In einigen Fällen waren die Berechnungen sehr umfangreich und erforderten das Einfügen von Millionen von Datensätzen in die DBMS-Tabellen, wodurch das DBMS erheblich belastet und der Betrieb des gesamten Systems verlangsamt wurde. <br><br>  Es wurde eine Lösung gefunden - die Arbeitsberechnungslogik in einen separaten Dienst mit einem eigenen DBMS zu stellen, um die Arbeit selbst und verwandte Objekte zu speichern.  Die Datenkonsistenz wurde durch die Saga sichergestellt.  Wenn die Berechnung fehlgeschlagen ist, hat das Hauptmodul der Anwendung einen Befehl zum Abbrechen der logischen Berechnungsoperation erhalten. <br><br><h2>  Saga-fähige Bibliotheken </h2><br>  Die Anwendung wurde auf .Net entwickelt, und für diese Technologie gibt es mehrere Service Manager-Bibliotheken mit Unterstützung für Sagen.  Wir haben uns die Bibliotheken NServiceBus, MassTransit und Rebus angesehen.  Infolgedessen haben wir uns für Rebus entschieden - diese Bibliothek ist leichter zu erlernen, während das Prinzip der Sagen vollständig verwirklicht wird und kostenlos verwendet werden kann.  NServiceBus und MassTransit sind anspruchsvollere Tools mit unzähligen zusätzlichen Funktionen.  Sie wurden im Rahmen unserer Aufgabe nicht benötigt, es kann jedoch ratsam sein, sie in zukünftigen Projekten mit komplexerer Logik zu verwenden. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de431854/">https://habr.com/ru/post/de431854/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de431844/index.html">Swift Heroes 2018. Wie es war</a></li>
<li><a href="../de431846/index.html">GeekBrains beginnt mit der Vorbereitung von Full-Stack-Python-Entwicklern</a></li>
<li><a href="../de431848/index.html">Da habe ich das größte Skript für Altium Designer geschrieben</a></li>
<li><a href="../de431850/index.html">Heisenbug 2018 Moskau: kostenlose Online-Übertragung, Party und vieles mehr</a></li>
<li><a href="../de431852/index.html">50.000 Netzwerkdrucker hacken und beliebigen Text drucken? Nichts ist einfacher</a></li>
<li><a href="../de431856/index.html">Erweitern des Unity-Editors um das Editorfenster, das skriptfähige Objekt und den benutzerdefinierten Editor</a></li>
<li><a href="../de431858/index.html">Mitap Sbertekh in Rostow am Don</a></li>
<li><a href="../de431860/index.html">Über Linux-Treiberoptionen oder wie ich das Wochenende verbracht habe</a></li>
<li><a href="../de431862/index.html">Mitap Sbertekh in Jekaterinburg</a></li>
<li><a href="../de431864/index.html">PVS-Studio ROI: Wie man nicht Millionen verliert (Entwurfsversion des Artikels)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>