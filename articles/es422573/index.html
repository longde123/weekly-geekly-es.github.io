<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§Ωüèº ü§∞üèΩ üë®üèΩ‚ÄçüöÄ La ingenier√≠a inversa de la representaci√≥n de The Witcher 3 üë∏üèæ üëßüèæ üå©Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recientemente, comenc√© a tratar con la representaci√≥n de The Witcher 3. Este juego tiene incre√≠bles t√©cnicas de renderizado. Adem√°s, ella es magn√≠fica...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>La ingenier√≠a inversa de la representaci√≥n de The Witcher 3</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/422573/">  Recientemente, comenc√© a tratar con la representaci√≥n de The Witcher 3.  Este juego tiene incre√≠bles t√©cnicas de renderizado.  Adem√°s, ella es magn√≠fica en t√©rminos de trama / m√∫sica / juego. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e5b/54e/95e/e5b54e95e53d14c22be446c3de24f8c3.jpg"></div><br><br>  En este art√≠culo hablar√© sobre las soluciones utilizadas para representar The Witcher 3. No ser√° tan completo como el an√°lisis de los gr√°ficos de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">GTA V</a> por Adrian Correger, al menos por ahora. <br><br>  Comenzaremos con la ingenier√≠a inversa de la correcci√≥n de tono. <br><a name="habracut"></a><br><h2>  Parte 1: correcci√≥n de tono </h2><br>  En la mayor√≠a de los juegos AAA modernos, uno de los pasos de representaci√≥n es necesariamente la correcci√≥n de tono. <br><br>  Perm√≠tame recordarle que en la vida real hay un rango de brillo bastante amplio, mientras que en las pantallas de las computadoras es muy limitado (8 bits por p√≠xel, lo que nos da 0-255).  Aqu√≠ es donde el mapa de tonos viene al rescate, lo que le permite ajustar un rango m√°s amplio en un intervalo de iluminaci√≥n limitado.  Por lo general, hay dos fuentes de datos en este proceso: una imagen HDR con un punto flotante, cuyos valores de color exceden 1.0, y la iluminaci√≥n promedio de la escena (esta √∫ltima se puede calcular de varias maneras, incluso teniendo en cuenta la adaptaci√≥n del ojo para simular el comportamiento de los ojos humanos, pero no importa aqu√≠). <br><br>  El siguiente (y √∫ltimo) paso es obtener la velocidad del obturador, calcular el color con la velocidad del obturador y procesarlo usando la curva de correcci√≥n de tono.  Y aqu√≠ todo se vuelve bastante confuso, porque aparecen nuevos conceptos, como el "punto blanco" (punto blanco) y el "gris medio" (gris medio).  Hay al menos unas pocas curvas populares, y algunas de ellas est√°n cubiertas en el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">mapeo de tonos de</a> Matt Pettineo. <br><br>  Honestamente, siempre tuve problemas con la implementaci√≥n correcta de la correcci√≥n de tono en mi propio c√≥digo.  Hay al menos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">algunos</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ejemplos</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">diferentes en</a> l√≠nea que me han sido √∫tiles ... hasta cierto punto.  Algunos de ellos tienen en cuenta el brillo HDR / punto blanco / gris medio, otros no, por lo tanto, realmente no ayudan.  Quer√≠a encontrar una implementaci√≥n "probada en batalla". <br><br>  Trabajaremos en RenderDoc con la captura de este marco de una de las principales misiones de Novigrad.  Todos los ajustes son m√°ximos: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/406/c2d/e21/406c2de21d4e934e0f25d0e6331fd272.jpg"></div><br>  Despu√©s de buscar un poco, encontr√© una llamada de sorteo para la correcci√≥n de tono.  Como mencion√© anteriormente, hay un b√∫fer de colores HDR (textura n√∫mero 0, resoluci√≥n completa) y el brillo promedio de la escena (textura n√∫mero 1, 1x1, coma flotante, calculada anteriormente por el sombreador de c√°lculo). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/9fe/836/3bd/9fe8363bdeda3b9e7336f0f67fc41dc3.jpg"></div><br>  Echemos un vistazo al c√≥digo de ensamblador para el sombreador de p√≠xeles: <br><br><pre><code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">ps_5_0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_globalFlags</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">refactoringAllowed</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_constantbuffer</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[17]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">immediateIndexed</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_resource_texture2d</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_resource_texture2d</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">t1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_input_ps_siv</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">v0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">position</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_output</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">o0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_temps</span></span> 4 0: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ld_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0, 0, 0, 0), <span class="hljs-selector-tag"><span class="hljs-selector-tag">t1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 1: <span class="hljs-selector-tag"><span class="hljs-selector-tag">max</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[4]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 2: <span class="hljs-selector-tag"><span class="hljs-selector-tag">min</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[4]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span> 3: <span class="hljs-selector-tag"><span class="hljs-selector-tag">max</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0<span class="hljs-selector-class"><span class="hljs-selector-class">.000100</span></span>) 4: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[16]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(11<span class="hljs-selector-class"><span class="hljs-selector-class">.200000</span></span>) 5: <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 6: <span class="hljs-selector-tag"><span class="hljs-selector-tag">log</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span> 7: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[16]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span> 8: <span class="hljs-selector-tag"><span class="hljs-selector-tag">exp</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span> 9: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span> 10: <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[16]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span> 11: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ftou</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">v0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span> 12: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0, 0, 0, 0) 13: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ld_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.wxyz</span></span> 14: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzwy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span> 15: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[7]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[7]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yyyy</span></span> 16: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[8]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzyy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[8]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span> 17: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yyyy</span></span> 18: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[7]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[7]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span> 19: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[7]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.wwww</span></span> 20: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span> 21: <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span> 22: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[7]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(11<span class="hljs-selector-class"><span class="hljs-selector-class">.200000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span> 23: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(11<span class="hljs-selector-class"><span class="hljs-selector-class">.200000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span> 24: <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[8]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[8]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span> 25: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span> 26: <span class="hljs-selector-tag"><span class="hljs-selector-tag">max</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0, 0, 0, 0) 27: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[16]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yyyy</span></span> 28: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[7]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(11<span class="hljs-selector-class"><span class="hljs-selector-class">.200000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[7]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 29: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(11<span class="hljs-selector-class"><span class="hljs-selector-class">.200000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 30: <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 31: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span> 32: <span class="hljs-selector-tag"><span class="hljs-selector-tag">max</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0) 33: <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">o0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.wwww</span></span> 34: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">o0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(1<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>) 35: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ret</span></span></code> </pre> <br>  Hay varios puntos que vale la pena se√±alar.  En primer lugar, el brillo cargado no tiene que ser igual al utilizado, ya que est√° limitado (llamadas m√°ximas / m√≠nimas) dentro de los valores elegidos por los artistas (del b√∫fer constante).  Esto es conveniente porque le permite evitar la velocidad de obturaci√≥n demasiado alta o baja de la escena.  Este movimiento parece bastante com√∫n, pero nunca lo he hecho antes.  En segundo lugar, alguien que est√© familiarizado con las curvas de correcci√≥n de tono reconocer√° instant√°neamente este valor "11.2", porque de hecho este es el valor del punto blanco de la curva de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">correcci√≥n de tono Uncharted2</a> de John Hable. <br><br>  Los par√°metros AF se cargan desde cbuffer. <br><br>  Entonces, tenemos tres par√°metros m√°s: cb3_v16.x, cb3_v16.y, cb3_v16.z.  Podemos examinar sus significados: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a52/975/78b/a5297578b0069fdded06bd3e82f2fadf.jpg"></div><br>  Mi corazonada: <br><br>  Creo que "x" es una especie de "escala blanca" o gris medio, porque se multiplica por 11.2 (l√≠nea 4), y luego se usa como un numerador para calcular la configuraci√≥n de la velocidad del obturador (l√≠nea 10). <br><br>  "Y" - Lo llam√© el "factor del numerador u2", y pronto ver√° por qu√©. <br><br>  "Z" es el "par√°metro de exponenciaci√≥n", porque se usa en el triple log / mul / exp (de hecho, en exponenciaci√≥n). <br><br>  ¬°Pero trate estos nombres variables con cierto grado de escepticismo! <br><br>  Tambi√©n: <br><br>  cb3_v4.yz - valores min / max de brillo admisible, <br>  cb3_v7.xyz: par√°metros de CA de la curva Uncharted2, <br>  cb3_v8.xyz: par√°metros DF de la curva Uncharted2. <br><br>  Ahora pasemos a la parte dif√≠cil: escribiremos un sombreador HLSL que nos dar√° exactamente el mismo c√≥digo de ensamblador. <br><br>  Esto puede ser muy dif√≠cil, y cuanto m√°s largo sea el sombreador, m√°s dif√≠cil ser√° la tarea.  Afortunadamente, hace alg√∫n tiempo escrib√≠ una herramienta para explorar r√°pidamente hlsl-&gt; asm. <br><br>  Damas y caballeros ... ¬°Bienvenidos D3DShaderDisassembler! <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/394/463/6ec/3944636ec3737e5e1ff5463e7b89d49f.jpg"></div><br>  Despu√©s de experimentar con el c√≥digo, obtuve la <b><i>correcci√≥n tonal</i></b> HLSL ya preparada <b><i>The Witcher 3</i></b> : <br><br><pre> <code class="hljs pgsql"> cbuffer cBuffer : register (b3) { <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v0; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v1; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v2; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v3; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v4; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v5; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v6; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v7; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v8; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v9; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v10; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v11; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v12; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v13; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v14; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v15; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v16, cb3_v17; } Texture2D TexHDRColor : register (t0); Texture2D TexAvgLuminance : register (t1); struct VS_OUTPUT_POSTFX { <span class="hljs-type"><span class="hljs-type">float4</span></span> Position : SV_Position; }; float3 U2Func( <span class="hljs-type"><span class="hljs-type">float</span></span> A, <span class="hljs-type"><span class="hljs-type">float</span></span> B, <span class="hljs-type"><span class="hljs-type">float</span></span> C, <span class="hljs-type"><span class="hljs-type">float</span></span> D, <span class="hljs-type"><span class="hljs-type">float</span></span> E, <span class="hljs-type"><span class="hljs-type">float</span></span> F, float3 x ) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F)) - E/F; } float3 ToneMapU2Func( <span class="hljs-type"><span class="hljs-type">float</span></span> A, <span class="hljs-type"><span class="hljs-type">float</span></span> B, <span class="hljs-type"><span class="hljs-type">float</span></span> C, <span class="hljs-type"><span class="hljs-type">float</span></span> D, <span class="hljs-type"><span class="hljs-type">float</span></span> E, <span class="hljs-type"><span class="hljs-type">float</span></span> F, float3 color, <span class="hljs-type"><span class="hljs-type">float</span></span> numMultiplier ) { float3 numerator = U2Func( A, B, C, D, E, F, color ); numerator = max( numerator, <span class="hljs-number"><span class="hljs-number">0</span></span> ); numerator.rgb *= numMultiplier; float3 denominator = U2Func( A, B, C, D, E, F, <span class="hljs-number"><span class="hljs-number">11.2</span></span> ); denominator = max( denominator, <span class="hljs-number"><span class="hljs-number">0</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> numerator / denominator; } <span class="hljs-type"><span class="hljs-type">float4</span></span> ToneMappingPS( VS_OUTPUT_POSTFX <span class="hljs-keyword"><span class="hljs-keyword">Input</span></span>) : SV_Target0 { <span class="hljs-type"><span class="hljs-type">float</span></span> avgLuminance = TexAvgLuminance.<span class="hljs-keyword"><span class="hljs-keyword">Load</span></span>( int3(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) ); avgLuminance = clamp( avgLuminance, cb3_v4.y, cb3_v4.z ); avgLuminance = max( avgLuminance, <span class="hljs-number"><span class="hljs-number">1e-4</span></span> ); <span class="hljs-type"><span class="hljs-type">float</span></span> scaledWhitePoint = cb3_v16.x * <span class="hljs-number"><span class="hljs-number">11.2</span></span>; <span class="hljs-type"><span class="hljs-type">float</span></span> luma = avgLuminance / scaledWhitePoint; luma = pow( luma, cb3_v16.z ); luma = luma * scaledWhitePoint; luma = cb3_v16.x / luma; float3 HDRColor = TexHDRColor.<span class="hljs-keyword"><span class="hljs-keyword">Load</span></span>( uint3(<span class="hljs-keyword"><span class="hljs-keyword">Input</span></span>.Position.xy, <span class="hljs-number"><span class="hljs-number">0</span></span>) ).rgb; float3 color = ToneMapU2Func( cb3_v7.x, cb3_v7.y, cb3_v7.z, cb3_v8.x, cb3_v8.y, cb3_v8.z, luma*HDRColor, cb3_v16.y); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-type"><span class="hljs-type">float4</span></span>(color, <span class="hljs-number"><span class="hljs-number">1</span></span>); }</code> </pre> <br>  Una captura de pantalla de mi utilidad para confirmar esto: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f9c/1e9/70a/f9c1e970a743cac54c9129261514c3e1.jpg"></div><br>  Voila! <br><br>  Creo que esta es una implementaci√≥n bastante precisa de la correcci√≥n de tono TW3, al menos en t√©rminos de c√≥digo de ensamblador.  ¬°Ya lo apliqu√© en mi marco y funciona muy bien! <br><br>  Dije "suficiente" porque no <i>tengo idea de</i> por qu√© el denominador en ToneMapU2Func se convierte en m√°ximo en cero.  Al dividir por 0, ¬ødeber√≠a quedar indefinido? <br><br>  Esto podr√≠a terminarse, pero casi por accidente encontr√© en este cuadro otra versi√≥n del sombreador de tonos TW3, utilizada para una hermosa puesta de sol (¬°es interesante que se use con configuraciones de gr√°ficos m√≠nimas!) <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/292/25b/bea/29225bbeae55c97c5a83e3461f7f24a7.jpg"></div><br>  Vamos a verlo  Primero, el c√≥digo del ensamblador para el sombreador: <br><br><pre> <code class="hljs css"> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ps_5_0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_globalFlags</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">refactoringAllowed</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_constantbuffer</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[18]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">immediateIndexed</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_resource_texture2d</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_resource_texture2d</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">t1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_input_ps_siv</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">v0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">position</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_output</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">o0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_temps</span></span> 5 0: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ld_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0, 0, 0, 0), <span class="hljs-selector-tag"><span class="hljs-selector-tag">t1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 1: <span class="hljs-selector-tag"><span class="hljs-selector-tag">max</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[9]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 2: <span class="hljs-selector-tag"><span class="hljs-selector-tag">max</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[4]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 3: <span class="hljs-selector-tag"><span class="hljs-selector-tag">min</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[4]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span> 4: <span class="hljs-selector-tag"><span class="hljs-selector-tag">min</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[9]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span> 5: <span class="hljs-selector-tag"><span class="hljs-selector-tag">max</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0<span class="hljs-selector-class"><span class="hljs-selector-class">.000100</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.000100</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>) 6: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[17]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(11<span class="hljs-selector-class"><span class="hljs-selector-class">.200000</span></span>) 7: <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span> 8: <span class="hljs-selector-tag"><span class="hljs-selector-tag">log</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 9: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[17]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span> 10: <span class="hljs-selector-tag"><span class="hljs-selector-tag">exp</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 11: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 12: <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[17]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 13: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ftou</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">v0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span> 14: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0, 0, 0, 0) 15: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ld_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 16: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yyyy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxyz</span></span> 17: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[11]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzwy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[11]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yyyy</span></span> 18: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[12]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzyy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[12]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span> 19: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzwy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yyyy</span></span> 20: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[11]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[11]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span> 21: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[11]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzwy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.wwww</span></span> 22: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span> 23: <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxyz</span></span> 24: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[11]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(11<span class="hljs-selector-class"><span class="hljs-selector-class">.200000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span> 25: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(11<span class="hljs-selector-class"><span class="hljs-selector-class">.200000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span> 26: <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[12]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[12]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span> 27: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span> 28: <span class="hljs-selector-tag"><span class="hljs-selector-tag">max</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0, 0, 0, 0) 29: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[17]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yyyy</span></span> 30: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[11]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(11<span class="hljs-selector-class"><span class="hljs-selector-class">.200000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[11]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 31: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(11<span class="hljs-selector-class"><span class="hljs-selector-class">.200000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 32: <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 33: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span> 34: <span class="hljs-selector-tag"><span class="hljs-selector-tag">max</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0) 35: <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.wwww</span></span> 36: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[16]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(11<span class="hljs-selector-class"><span class="hljs-selector-class">.200000</span></span>) 37: <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span> 38: <span class="hljs-selector-tag"><span class="hljs-selector-tag">log</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span> 39: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[16]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span> 40: <span class="hljs-selector-tag"><span class="hljs-selector-tag">exp</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span> 41: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span> 42: <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[16]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span> 43: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span> 44: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[7]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[7]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yyyy</span></span> 45: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[8]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzyy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[8]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span> 46: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yyyy</span></span> 47: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[7]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[7]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span> 48: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[7]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span> 49: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span> 50: <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span> 51: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[7]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(11<span class="hljs-selector-class"><span class="hljs-selector-class">.200000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span> 52: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(11<span class="hljs-selector-class"><span class="hljs-selector-class">.200000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span> 53: <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[8]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[8]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span> 54: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.wwww</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span> 55: <span class="hljs-selector-tag"><span class="hljs-selector-tag">max</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0, 0, 0, 0) 56: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[16]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yyyy</span></span> 57: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[7]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(11<span class="hljs-selector-class"><span class="hljs-selector-class">.200000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[7]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 58: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(11<span class="hljs-selector-class"><span class="hljs-selector-class">.200000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 59: <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span> 60: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span> 61: <span class="hljs-selector-tag"><span class="hljs-selector-tag">max</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0) 62: <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span> 63: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzwy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span> 64: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">o0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[13]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span> 65: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">o0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(1<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>) 66: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ret</span></span></code> </pre> <br>  Al principio, el c√≥digo puede parecer intimidante, pero de hecho, no todo es tan malo.  Despu√©s de un breve an√°lisis, notar√° que hay dos llamadas a la funci√≥n Uncharted2 con diferentes conjuntos de datos de entrada (AF, brillo m√≠nimo / m√°ximo ...).  Nunca antes hab√≠a visto una decisi√≥n as√≠. <br><br>  Y HLSL: <br><br><pre> <code class="hljs pgsql"> cbuffer cBuffer : register (b3) { <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v0; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v1; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v2; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v3; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v4; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v5; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v6; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v7; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v8; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v9; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v10; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v11; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v12; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v13; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v14; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v15; <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v16, cb3_v17; } Texture2D TexHDRColor : register (t0); Texture2D TexAvgLuminance : register (t1); float3 U2Func( <span class="hljs-type"><span class="hljs-type">float</span></span> A, <span class="hljs-type"><span class="hljs-type">float</span></span> B, <span class="hljs-type"><span class="hljs-type">float</span></span> C, <span class="hljs-type"><span class="hljs-type">float</span></span> D, <span class="hljs-type"><span class="hljs-type">float</span></span> E, <span class="hljs-type"><span class="hljs-type">float</span></span> F, float3 x ) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F)) - E/F; } float3 ToneMapU2Func( <span class="hljs-type"><span class="hljs-type">float</span></span> A, <span class="hljs-type"><span class="hljs-type">float</span></span> B, <span class="hljs-type"><span class="hljs-type">float</span></span> C, <span class="hljs-type"><span class="hljs-type">float</span></span> D, <span class="hljs-type"><span class="hljs-type">float</span></span> E, <span class="hljs-type"><span class="hljs-type">float</span></span> F, float3 color, <span class="hljs-type"><span class="hljs-type">float</span></span> numMultiplier ) { float3 numerator = U2Func( A, B, C, D, E, F, color ); numerator = max( numerator, <span class="hljs-number"><span class="hljs-number">0</span></span> ); numerator.rgb *= numMultiplier; float3 denominator = U2Func( A, B, C, D, E, F, <span class="hljs-number"><span class="hljs-number">11.2</span></span> ); denominator = max( denominator, <span class="hljs-number"><span class="hljs-number">0</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> numerator / denominator; } struct VS_OUTPUT_POSTFX { <span class="hljs-type"><span class="hljs-type">float4</span></span> Position : SV_Position; }; <span class="hljs-type"><span class="hljs-type">float</span></span> getExposure(<span class="hljs-type"><span class="hljs-type">float</span></span> avgLuminance, <span class="hljs-type"><span class="hljs-type">float</span></span> minLuminance, <span class="hljs-type"><span class="hljs-type">float</span></span> maxLuminance, <span class="hljs-type"><span class="hljs-type">float</span></span> middleGray, <span class="hljs-type"><span class="hljs-type">float</span></span> powParam) { avgLuminance = clamp( avgLuminance, minLuminance, maxLuminance ); avgLuminance = max( avgLuminance, <span class="hljs-number"><span class="hljs-number">1e-4</span></span> ); <span class="hljs-type"><span class="hljs-type">float</span></span> scaledWhitePoint = middleGray * <span class="hljs-number"><span class="hljs-number">11.2</span></span>; <span class="hljs-type"><span class="hljs-type">float</span></span> luma = avgLuminance / scaledWhitePoint; luma = pow( luma, powParam); luma = luma * scaledWhitePoint; <span class="hljs-type"><span class="hljs-type">float</span></span> exposure = middleGray / luma; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> exposure; } <span class="hljs-type"><span class="hljs-type">float4</span></span> ToneMappingPS( VS_OUTPUT_POSTFX <span class="hljs-keyword"><span class="hljs-keyword">Input</span></span>) : SV_Target0 { <span class="hljs-type"><span class="hljs-type">float</span></span> avgLuminance = TexAvgLuminance.<span class="hljs-keyword"><span class="hljs-keyword">Load</span></span>( int3(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) ); <span class="hljs-type"><span class="hljs-type">float</span></span> exposure1 = getExposure( avgLuminance, cb3_v9.y, cb3_v9.z, cb3_v17.x, cb3_v17.z); <span class="hljs-type"><span class="hljs-type">float</span></span> exposure2 = getExposure( avgLuminance, cb3_v4.y, cb3_v4.z, cb3_v16.x, cb3_v16.z); float3 HDRColor = TexHDRColor.<span class="hljs-keyword"><span class="hljs-keyword">Load</span></span>( uint3(<span class="hljs-keyword"><span class="hljs-keyword">Input</span></span>.Position.xy, <span class="hljs-number"><span class="hljs-number">0</span></span>) ).rgb; float3 color1 = ToneMapU2Func( cb3_v11.x, cb3_v11.y, cb3_v11.z, cb3_v12.x, cb3_v12.y, cb3_v12.z, exposure1*HDRColor, cb3_v17.y); float3 color2 = ToneMapU2Func( cb3_v7.x, cb3_v7.y, cb3_v7.z, cb3_v8.x, cb3_v8.y, cb3_v8.z, exposure2*HDRColor, cb3_v16.y); float3 finalColor = lerp( color2, color1, cb3_v13.x ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-type"><span class="hljs-type">float4</span></span>(finalColor, <span class="hljs-number"><span class="hljs-number">1</span></span>); }</code> </pre> <br>  Es decir, de hecho, tenemos dos conjuntos de par√°metros de control, calculamos dos colores con correcci√≥n de tono y al final los interpolamos.  Decisi√≥n inteligente! <br><br><h2>  Parte 2: adaptaci√≥n ocular </h2><br>  La segunda parte ser√° mucho m√°s simple. <br><br>  En la primera parte, mostr√© c√≥mo se realiza la correcci√≥n tonal en TW3.  Al explicar los antecedentes te√≥ricos, mencion√© brevemente la adaptaci√≥n del ojo.  ¬øY sabes que?  En esta parte hablar√© sobre c√≥mo se realiza esta adaptaci√≥n del ojo. <br><br>  Pero espera, ¬øqu√© es la adaptaci√≥n ocular y por qu√© la necesitamos?  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Wikipedia lo</a> sabe todo al respecto, pero lo explicar√©: imagina que est√°s en una habitaci√≥n oscura (recuerda que Life is Strange) o en una cueva, y ve afuera donde hay luz.  Por ejemplo, la principal fuente de iluminaci√≥n puede ser el sol. <br><br>  En la oscuridad, nuestras pupilas se dilatan para que entre m√°s luz a la retina a trav√©s de ellas.  Cuando se vuelve claro, nuestras pupilas disminuyen y a veces cerramos los ojos porque "duele". <br><br>  Este cambio no ocurre al instante.  El ojo debe adaptarse a los cambios de brillo.  Es por eso que realizamos la adaptaci√≥n del ojo en renderizado en tiempo real. <br><br>  Un buen ejemplo de cuando se nota una falta de adaptaci√≥n ocular es el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">HDRToneMappingCS11</a> del DirectX SDK.  Los cambios bruscos de brillo medio son bastante desagradables y antinaturales. <br><br>  ¬°Empecemos!  En aras de la coherencia, analizaremos el mismo marco de Novigrad. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/406/c2d/e21/406c2de21d4e934e0f25d0e6331fd272.jpg"></div><br>  Ahora profundizaremos en el programa de captura de cuadros RenderDoc.  La adaptaci√≥n del ojo generalmente se realiza justo antes de la correcci√≥n tonal, y The Witcher 3 no es una excepci√≥n. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8ed/fde/eec/8edfdeeec29fef781801b94948c90e6f.png"></div><br>  Veamos el estado del sombreador de p√≠xeles: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e68/2fd/2f4/e682fd2f410f32eb8661c2476c8a2294.jpg"></div><br>  Tenemos dos fuentes de entrada: 2 texturas, R32_FLOAT, 1x1 (un p√≠xel).  texture0 contiene el brillo promedio de la escena del cuadro anterior.  texture1 contiene el brillo promedio de la escena desde el cuadro actual (calculado inmediatamente antes de este sombreador de c√°lculo; lo marqu√© en azul). <br><br>  Se espera que haya una salida: R32_FLOAT, 1x1.  Veamos el sombreador de p√≠xeles. <br><br><pre> <code class="hljs css"> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ps_5_0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_globalFlags</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">refactoringAllowed</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_constantbuffer</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[1]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">immediateIndexed</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_sampler</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">mode_default</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_sampler</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">s1</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">mode_default</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_resource_texture2d</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_resource_texture2d</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">t1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_output</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">o0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_temps</span></span> 1 0: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_l</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0, 0, 0, 0), <span class="hljs-selector-tag"><span class="hljs-selector-tag">t1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s1</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0) 1: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_l</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0, 0, 0, 0), <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yxzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0) 2: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ge</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span> 3: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span> 4: <span class="hljs-selector-tag"><span class="hljs-selector-tag">movc</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[0]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[0]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 5: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">o0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zzzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yyyy</span></span> 6: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ret</span></span></code> </pre> <br>  Wow, que simple!  Solo 7 l√≠neas de c√≥digo ensamblador.  ¬øQu√© est√° pasando aqu√≠?  Explicar√© cada l√≠nea: <br><br>  0) Obtenga el brillo promedio del cuadro actual. <br>  1) Obtenga el brillo promedio del cuadro anterior. <br>  2) Realice una comprobaci√≥n: ¬øel brillo actual es menor o igual que el brillo del fotograma anterior? <br>  Si es as√≠, entonces el brillo disminuye, si no, entonces el brillo aumenta. <br>  3) Calcule la diferencia: <i>diferencia = currentLum - previousLum.</i> <br>  4) Esta transferencia condicional (movc) asigna un factor de velocidad desde el b√∫fer constante.  Se pueden asignar dos valores diferentes desde la l√≠nea 2, dependiendo del resultado de la verificaci√≥n.  Este es un movimiento inteligente, porque de esta manera puede obtener diferentes velocidades de adaptaci√≥n para reducir y aumentar el brillo.  Pero en el marco estudiado, ambos valores son iguales y var√≠an de 0.11 a 0.3. <br>  5) El c√°lculo final del brillo adaptado: <i>adaptLuminance = speedFactor * diferencia + anteriorLuminance.</i> <br>  6) El final del sombreador <br><br>  Esto se implementa en HLSL simplemente: <br><br><pre> <code class="hljs pgsql"> // The Witcher <span class="hljs-number"><span class="hljs-number">3</span></span> eye adaptation shader cbuffer cBuffer : register (b3) { <span class="hljs-type"><span class="hljs-type">float4</span></span> cb3_v0; } struct VS_OUTPUT_POSTFX { <span class="hljs-type"><span class="hljs-type">float4</span></span> Position : SV_Position; }; SamplerState samplerPointClamp : register (s0); SamplerState samplerPointClamp2 : register (s1); Texture2D TexPreviousAvgLuminance : register (t0); Texture2D TexCurrentAvgLuminance : register (t1); <span class="hljs-type"><span class="hljs-type">float4</span></span> TW3_EyeAdaptationPS(VS_OUTPUT_POSTFX <span class="hljs-keyword"><span class="hljs-keyword">Input</span></span>) : SV_TARGET { // <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span> <span class="hljs-keyword"><span class="hljs-keyword">current</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> previous luminance. <span class="hljs-type"><span class="hljs-type">float</span></span> currentAvgLuminance = TexCurrentAvgLuminance.SampleLevel( samplerPointClamp2, float2(<span class="hljs-number"><span class="hljs-number">0.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.0</span></span>), <span class="hljs-number"><span class="hljs-number">0</span></span> ); <span class="hljs-type"><span class="hljs-type">float</span></span> previousAvgLuminance = TexPreviousAvgLuminance.SampleLevel( samplerPointClamp, float2(<span class="hljs-number"><span class="hljs-number">0.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.0</span></span>), <span class="hljs-number"><span class="hljs-number">0</span></span> ); // Difference <span class="hljs-keyword"><span class="hljs-keyword">between</span></span> <span class="hljs-keyword"><span class="hljs-keyword">current</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> previous luminance. <span class="hljs-type"><span class="hljs-type">float</span></span> difference = currentAvgLuminance - previousAvgLuminance; // Scale factor. Can be different <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">both</span></span> falling down <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> rising up <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> luminance. // It affects speed <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> adaptation. // Small conditional test <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> performed here, so different speed can be <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> differently <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">both</span></span> these cases. <span class="hljs-type"><span class="hljs-type">float</span></span> adaptationSpeedFactor = (currentAvgLuminance &lt;= previousAvgLuminance) ? cb3_v0.x : cb3_v0.y; // Calculate adapted luminance. <span class="hljs-type"><span class="hljs-type">float</span></span> adaptedLuminance = adaptationSpeedFactor * difference + previousAvgLuminance; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> adaptedLuminance; }</code> </pre> <br>  Estas l√≠neas nos dan el mismo c√≥digo de ensamblador.  Solo sugerir√≠a reemplazar el tipo de salida con <i>float4</i> con <i>float</i> .  No hay necesidad de desperdicio de ancho de banda.  As√≠ es como Witcher 3 implementa la adaptaci√≥n ocular.  Bastante simple, ¬øverdad? <br><br>  PS.  Muchas gracias a Baldur Karlsson (Twitter: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">@baldurk</a> ) por RenderDoc.  El programa es simplemente genial. <br><br><h2>  Parte 3: aberraci√≥n crom√°tica </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">La aberraci√≥n crom√°tica</a> es un efecto que se encuentra principalmente en lentes baratos.  Ocurre porque las lentes tienen diferentes √≠ndices de refracci√≥n para diferentes longitudes de luz visible.  Como resultado, aparece una distorsi√≥n visible.  Sin embargo, no a todos les gusta.  Afortunadamente, en Witcher 3 este efecto es muy sutil y, por lo tanto, no es molesto en el juego (al menos para m√≠).  Pero puede desactivarlo si lo desea. <br><br>  Echemos un vistazo de cerca a un ejemplo de una escena con aberraci√≥n crom√°tica y sin ella: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a5e/078/853/a5e0788530c688f849013ff3ed64134f.png"></div><br>  <i>Aberraci√≥n crom√°tica incluida</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d8d/20f/ee7/d8d20fee7a901301b9f2e5f67a2f56be.png"></div><br>  <i>Aberraci√≥n crom√°tica deshabilitada</i> <br><br>  ¬øNotas alguna diferencia cerca de los bordes?  Yo tampoco  Probemos otra escena: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/cff/9a3/b41/cff9a3b41c135e4c43cd3065328dc235.png"></div><br>  <i>La aberraci√≥n crom√°tica est√° incluida.</i>  <i>Observe la ligera distorsi√≥n "roja" en el √°rea indicada.</i> <br><br>  Si, mucho mejor!  Aqu√≠ el contraste entre las √°reas oscuras y claras es m√°s fuerte, y en la esquina vemos una ligera distorsi√≥n.  Como puede ver, este efecto es muy d√©bil.  Sin embargo, me preguntaba c√≥mo se implementa.  Pasemos a la parte m√°s curiosa: ¬°el c√≥digo! <br><br>  <b>Implementaci√≥n</b> <br><br>  Lo primero que debe hacer es encontrar la llamada de sorteo correcta con un sombreador de p√≠xeles.  De hecho, la aberraci√≥n crom√°tica es parte del gran sombreador de p√≠xeles de "procesamiento posterior", que consiste en la aberraci√≥n crom√°tica, vi√±eteado y correcci√≥n gamma.  Todo esto est√° dentro de un solo sombreador de p√≠xeles.  Echemos un vistazo m√°s de cerca al c√≥digo de ensamblador para el sombreador de p√≠xeles: <br><br><pre> <code class="hljs css"> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ps_5_0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_globalFlags</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">refactoringAllowed</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_constantbuffer</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[18]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">immediateIndexed</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_sampler</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">s1</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">mode_default</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_resource_texture2d</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_input_ps_siv</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">v0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">position</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_input_ps</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">linear</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">v1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zw</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_output</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">o0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_temps</span></span> 4 0: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">v0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[17]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span> 1: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">v0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[17]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zzzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[17]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxy</span></span> 2: <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zzzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[17]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxy</span></span> 3: <span class="hljs-selector-tag"><span class="hljs-selector-tag">dp2</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span> 4: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sqrt</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span> 5: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[16]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 6: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul_sat</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[16]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span> 7: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_l</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s1</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0) 8: <span class="hljs-selector-tag"><span class="hljs-selector-tag">lt</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 9: <span class="hljs-selector-tag"><span class="hljs-selector-tag">if_nz</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span> 10: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 11: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[16]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span> 12: <span class="hljs-selector-tag"><span class="hljs-selector-tag">max</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0<span class="hljs-selector-class"><span class="hljs-selector-class">.000100</span></span>) 13: <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span> 14: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zzzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span> 15: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zzzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[17]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zzzw</span></span> 16: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(2<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, 2<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span> 17: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_l</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s1</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0) 18: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">v0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[17]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span> 19: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_l</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s1</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0) 20: <span class="hljs-selector-tag"><span class="hljs-selector-tag">endif</span></span> ...</code> </pre> <br>  Y a los valores de cbuffer: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7d9/e1d/6b6/7d9e1d6b60039074712ea0e60dba2ae0.jpg"></div><br>  Entonces, tratemos de entender lo que est√° sucediendo aqu√≠.  De hecho, cb3_v17.xy es el centro de la aberraci√≥n crom√°tica, por lo que las primeras l√≠neas calculan el vector 2d a partir de las coordenadas texel (cb3_v17.zw = el rec√≠proco del tama√±o de la ventana gr√°fica) al "centro de aberraci√≥n crom√°tica" y su longitud, luego realiza otros c√°lculos, verificaci√≥n y ramificaci√≥n .  Al aplicar la aberraci√≥n crom√°tica, calculamos los desplazamientos utilizando ciertos valores del b√∫fer constante y distorsionamos los canales R y G. En general, cuanto m√°s cerca de los bordes de la pantalla, m√°s fuerte es el efecto.  La l√≠nea 10 es bastante interesante porque hace que los p√≠xeles "se acerquen", especialmente cuando exageramos la aberraci√≥n.  Con mucho gusto compartir√© con ustedes mi comprensi√≥n del efecto.  Como de costumbre, tome nombres de variables con una parte (s√≥lida) de escepticismo.  Y tenga en cuenta que el efecto se aplica <i>antes de</i> la correcci√≥n gamma. <br><br><pre> <code class="hljs pgsql"> <span class="hljs-type"><span class="hljs-type">void</span></span> ChromaticAberration( float2 uv, <span class="hljs-keyword"><span class="hljs-keyword">inout</span></span> float3 color ) { // <span class="hljs-keyword"><span class="hljs-keyword">User</span></span>-defined params float2 chromaticAberrationCenter = float2(<span class="hljs-number"><span class="hljs-number">0.5</span></span>, <span class="hljs-number"><span class="hljs-number">0.5</span></span>); <span class="hljs-type"><span class="hljs-type">float</span></span> chromaticAberrationCenterAvoidanceDistance = <span class="hljs-number"><span class="hljs-number">0.2</span></span>; <span class="hljs-type"><span class="hljs-type">float</span></span> fA = <span class="hljs-number"><span class="hljs-number">1.25</span></span>; <span class="hljs-type"><span class="hljs-type">float</span></span> fChromaticAbberationIntensity = <span class="hljs-number"><span class="hljs-number">30</span></span>; <span class="hljs-type"><span class="hljs-type">float</span></span> fChromaticAberrationDistortionSize = <span class="hljs-number"><span class="hljs-number">0.75</span></span>; // Calculate vector float2 chromaticAberrationOffset = uv - chromaticAberrationCenter; chromaticAberrationOffset = chromaticAberrationOffset / chromaticAberrationCenter; <span class="hljs-type"><span class="hljs-type">float</span></span> chromaticAberrationOffsetLength = length(chromaticAberrationOffset); // <span class="hljs-keyword"><span class="hljs-keyword">To</span></span> avoid applying chromatic aberration <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> center, subtract small <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> // just calculated length. <span class="hljs-type"><span class="hljs-type">float</span></span> chromaticAberrationOffsetLengthFixed = chromaticAberrationOffsetLength - chromaticAberrationCenterAvoidanceDistance; <span class="hljs-type"><span class="hljs-type">float</span></span> chromaticAberrationTexel = saturate(chromaticAberrationOffsetLengthFixed * fA); <span class="hljs-type"><span class="hljs-type">float</span></span> fApplyChromaticAberration = (<span class="hljs-number"><span class="hljs-number">0.0</span></span> &lt; chromaticAberrationTexel); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fApplyChromaticAberration) { chromaticAberrationTexel *= chromaticAberrationTexel; chromaticAberrationTexel *= fChromaticAberrationDistortionSize; chromaticAberrationOffsetLength = max(chromaticAberrationOffsetLength, <span class="hljs-number"><span class="hljs-number">1e-4</span></span>); <span class="hljs-type"><span class="hljs-type">float</span></span> fMultiplier = chromaticAberrationTexel / chromaticAberrationOffsetLength; chromaticAberrationOffset *= fMultiplier; chromaticAberrationOffset *= g_Viewport.zw; chromaticAberrationOffset *= fChromaticAbberationIntensity; float2 offsetUV = -chromaticAberrationOffset * <span class="hljs-number"><span class="hljs-number">2</span></span> + uv; color.r = TexColorBuffer.SampleLevel(samplerLinearClamp, offsetUV, <span class="hljs-number"><span class="hljs-number">0</span></span>).r; offsetUV = uv - chromaticAberrationOffset; color.g = TexColorBuffer.SampleLevel(samplerLinearClamp, offsetUV, <span class="hljs-number"><span class="hljs-number">0</span></span>).g; } }</code> </pre> <br>  Agregu√© "fChromaticAberrationIntensity" para aumentar el tama√±o del desplazamiento y, por lo tanto, la fuerza del efecto, como su nombre indica (TW3 = 1.0).  Intensidad = 40: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/864/69e/aea/86469eaea28862b558fa90784b8c4585.png"></div><br>  Eso es todo!  Espero que hayas disfrutado esta parte. <br><br><h2>  Parte 4: vi√±eteado </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">El vi√±eteado</a> es uno de los efectos de procesamiento posterior m√°s comunes utilizados en los juegos.  Tambi√©n es popular en fotograf√≠a.  Las esquinas ligeramente sombreadas pueden crear un hermoso efecto.  Hay varios tipos de vi√±etas.  Por ejemplo, <a href="">Unreal Engine 4</a> usa natural.  Pero volvamos a The Witcher 3. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Haga clic aqu√≠</a> para ver una comparaci√≥n interactiva de marcos con y sin vi√±etas.  La comparaci√≥n se toma de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">la gu√≠a de rendimiento de NVIDIA para The Witcher 3</a> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b27/b52/986/b27b52986e845f39a32710276adc9fa8.png"></div><br>  <i>Captura de pantalla de "The Witcher 3" con vi√±etas activadas.</i> <br><br>  Tenga en cuenta que la esquina superior izquierda (cielo) no est√° tan sombreada como las otras partes de la imagen.  M√°s tarde volveremos a esto. <br><br>  <b>Detalles de implementaci√≥n</b> <br><br>  En primer lugar, hay una ligera diferencia entre las vi√±etas utilizadas en la versi√≥n original de The Witcher 3 (que se lanz√≥ el 19 de mayo de 2015) y en The Witcher 3: Blood and Wine.  En el primero, el "gradiente inverso" se calcula dentro del sombreador de p√≠xeles, y en el segundo se calcula previamente en una textura 2D de 256x256: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/455/0b4/c1d/4550b4c1d1a0ae80923cd75cd63c3e7f.jpg"></div><br>  Textura 256x256, utilizada como "gradiente inverso" en el complemento "Sangre y vino". <br><br>  Usar√© el sombreador de "Blood and Wine" (un gran juego, por cierto).  Como en la mayor√≠a de los otros juegos, la vi√±eta de Witcher 3 se calcula en el sombreador de p√≠xeles del posprocesamiento final.  Echa un vistazo al c√≥digo del ensamblador: <br><br><pre> <code class="hljs css"> ... 44: <span class="hljs-selector-tag"><span class="hljs-selector-tag">log</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span> 45: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0<span class="hljs-selector-class"><span class="hljs-selector-class">.454545</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.454545</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.454545</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>) 46: <span class="hljs-selector-tag"><span class="hljs-selector-tag">exp</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span> 47: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[9]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span> 48: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">v1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzwx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s2</span></span> 49: <span class="hljs-selector-tag"><span class="hljs-selector-tag">log</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span> 50: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(2<span class="hljs-selector-class"><span class="hljs-selector-class">.200000</span></span>, 2<span class="hljs-selector-class"><span class="hljs-selector-class">.200000</span></span>, 2<span class="hljs-selector-class"><span class="hljs-selector-class">.200000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>) 51: <span class="hljs-selector-tag"><span class="hljs-selector-tag">exp</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span> 52: <span class="hljs-selector-tag"><span class="hljs-selector-tag">dp3</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[6]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span> 53: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add_sat</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(1<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>) 54: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[6]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span> 55: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul_sat</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span> 56: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[9]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[7]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span> 57: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.wwww</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzx</span></span> ...</code> </pre> <br>  Interesante!  Parece que se usan tanto gamma (l√≠nea 46) como espacios lineales (l√≠nea 51) para calcular el vi√±eteado.  En la l√≠nea 48, tomamos muestras de la textura del "gradiente inverso".  cb3 [9] .xyz no est√° relacionado con las vi√±etas.  En cada cuadro marcado, se le asigna el valor float3 (1.0, 1.0, 1.0), es decir, es probable que sea el filtro final utilizado en los efectos de aparici√≥n / desaparici√≥n gradual.  Hay tres par√°metros principales para vi√±etar en TW3: <br><br><ul><li>  Opacidad (cb3 [6] .w): afecta la fuerza de las vi√±etas.  0: sin vi√±eteado, 1: vi√±eteado m√°ximo.  Seg√∫n mis observaciones, en la base The Witcher 3 es aproximadamente 1.0, mientras que en Blood and Wine fluct√∫a alrededor de 0.15. </li><li>  Color (cb3 [7] .xyz): una caracter√≠stica excelente de las vi√±etas TW3 es la capacidad de cambiar su color.  No tiene que ser negro, pero en la pr√°ctica ... Por lo general, tiene los valores float3 (3.0 / 255.0, 4.0 / 255.0, 5.0 / 255.0) y as√≠ sucesivamente; en el caso general, estos son m√∫ltiplos de 0.00392156 = 1.0 / 255.0 </li><li>  Los pesos (cb3 [6] .xyz) es un par√°metro muy interesante.  Siempre vi vi√±etas "planas", por ejemplo: </li></ul><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a25/9e8/7f9/a259e87f9e5bbfc3edf6b4ff30aea90d.png"></div><br>  <i>M√°scara de vi√±eta t√≠pica</i> <br><br>  Pero usando pesos (l√≠nea 52), puede obtener resultados muy interesantes: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6c0/c88/6c0/6c0c886c0175635ba609ef61e61b3ea3.png"></div><br>  <i>M√°scara de vi√±eteado TW3 calculada usando pesos</i> <br><br>  Los pesos est√°n cerca de 1.0.  Observe los datos constantes del b√∫fer para un cuadro de Blood and Wine (un mundo m√°gico con un arco iris): esta es la raz√≥n por la que el vi√±eteado no afect√≥ a los p√≠xeles brillantes del cielo de arriba. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/68a/2a9/9e5/68a2a99e54b0c8cf9e71561001315a34.png"></div><br>  <b>C√≥digo</b> <br><br>  Aqu√≠ est√° mi implementaci√≥n de vi√±etas TW3 en HLSL. <br><br>  GammaToLinear = pow (color, 2.2) <br><br><pre> <code class="hljs pgsql"> <span class="hljs-comment"><span class="hljs-comment">/* // The Witcher 3 vignette. // // Input color is in gamma space // Output color is in gamma space as well. */</span></span> float3 Vignette_TW3( <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> float3 gammaColor, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> float3 vignetteColor, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> float3 vignetteWeights, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-type"><span class="hljs-type">float</span></span> vignetteOpacity, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> Texture2D texVignette, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> float2 texUV ) { // <span class="hljs-keyword"><span class="hljs-keyword">For</span></span> coloring vignette float3 vignetteColorGammaSpace = -gammaColor + vignetteColor; // Calculate vignette amount based <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> color <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> *LINEAR* color space <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> vignette weights. <span class="hljs-type"><span class="hljs-type">float</span></span> vignetteWeight = dot( GammaToLinear( gammaColor ), vignetteWeights ); // We need <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> keep vignette weight <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> [<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-number"><span class="hljs-number">-1</span></span>] range vignetteWeight = saturate( <span class="hljs-number"><span class="hljs-number">1.0</span></span> - vignetteWeight ); // Multiply <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> opacity vignetteWeight *= vignetteOpacity; // Obtain vignette mask (here <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> texture; you can <span class="hljs-keyword"><span class="hljs-keyword">also</span></span> calculate your custom mask here) <span class="hljs-type"><span class="hljs-type">float</span></span> sampledVignetteMask = texVignette.Sample( samplerLinearClamp, texUV ).x; // Final (inversed) vignette mask <span class="hljs-type"><span class="hljs-type">float</span></span> finalInvVignetteMask = saturate( vignetteWeight * sampledVignetteMask ); // final composite <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> gamma space float3 Color = vignetteColorGammaSpace * finalInvVignetteMask + gammaColor.rgb; // * uncomment <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">debug</span></span> vignette mask: // <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1.0</span></span> - finalInvVignetteMask; // <span class="hljs-keyword"><span class="hljs-keyword">Return</span></span> final color <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Color; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Espero que lo hayas disfrutado. </font><font style="vertical-align: inherit;">Tambi√©n puede probar mi </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HLSLexplorer</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que me ayud√≥ mucho a comprender el c√≥digo del ensamblador HLSL. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como antes, tome los nombres de las variables con cierto grado de escepticismo: los sombreadores TW3 son procesados ‚Äã‚Äãpor D3DStripShader, por lo que, de hecho, no s√© casi nada sobre ellos, solo puedo adivinar. </font><font style="vertical-align: inherit;">Adem√°s, no tengo ninguna responsabilidad por el da√±o causado a su equipo por este sombreador;) </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bonificaci√≥n: c√°lculo del gradiente</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> En The Witcher 3, lanzado en 2015, el gradiente inverso se calcul√≥ en el sombreador de p√≠xeles, en lugar de muestrear una textura calculada previamente. </font><font style="vertical-align: inherit;">Echa un vistazo al c√≥digo del ensamblador:</font></font><br><br><pre> <code class="hljs css"> 35: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">v1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.500000</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.500000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>) 36: <span class="hljs-selector-tag"><span class="hljs-selector-tag">dp2</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span> 37: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sqrt</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span> 38: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(2<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.550000</span></span>) 39: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul_sat</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(1<span class="hljs-selector-class"><span class="hljs-selector-class">.219512</span></span>) 40: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span> 41: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zzzz</span></span> 42: <span class="hljs-selector-tag"><span class="hljs-selector-tag">dp4</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.100000</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.105000</span></span>, 1<span class="hljs-selector-class"><span class="hljs-selector-class">.120000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.090000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 43: <span class="hljs-selector-tag"><span class="hljs-selector-tag">min</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0<span class="hljs-selector-class"><span class="hljs-selector-class">.940000</span></span>)</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Afortunadamente para nosotros, es bastante simple. </font><font style="vertical-align: inherit;">En HLSL, se ver√° m√°s o menos as√≠:</font></font><br><br><pre> <code class="hljs pgsql"> <span class="hljs-type"><span class="hljs-type">float</span></span> TheWitcher3_2015_Mask( <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> float2 uv ) { <span class="hljs-type"><span class="hljs-type">float</span></span> distanceFromCenter = length( uv - float2(<span class="hljs-number"><span class="hljs-number">0.5</span></span>, <span class="hljs-number"><span class="hljs-number">0.5</span></span>) ); <span class="hljs-type"><span class="hljs-type">float</span></span> x = distanceFromCenter * <span class="hljs-number"><span class="hljs-number">2.0</span></span> - <span class="hljs-number"><span class="hljs-number">0.55</span></span>; x = saturate( x * <span class="hljs-number"><span class="hljs-number">1.219512</span></span> ); // <span class="hljs-number"><span class="hljs-number">1.219512</span></span> = <span class="hljs-number"><span class="hljs-number">100</span></span>/<span class="hljs-number"><span class="hljs-number">82</span></span> <span class="hljs-type"><span class="hljs-type">float</span></span> x2 = x * x; <span class="hljs-type"><span class="hljs-type">float</span></span> x3 = x2 * x; <span class="hljs-type"><span class="hljs-type">float</span></span> x4 = x2 * x2; <span class="hljs-type"><span class="hljs-type">float</span></span> outX = dot( <span class="hljs-type"><span class="hljs-type">float4</span></span>(x4, x3, x2, x), <span class="hljs-type"><span class="hljs-type">float4</span></span>(<span class="hljs-number"><span class="hljs-number">-0.10</span></span>, <span class="hljs-number"><span class="hljs-number">-0.105</span></span>, <span class="hljs-number"><span class="hljs-number">1.12</span></span>, <span class="hljs-number"><span class="hljs-number">0.09</span></span>) ); outX = min( outX, <span class="hljs-number"><span class="hljs-number">0.94</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> outX; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es decir, simplemente calculamos la distancia desde el centro al textil, hacemos algo de magia con √©l (multiplicaci√≥n, saturaci√≥n ...) y luego ... ¬°calculamos el polinomio! </font><font style="vertical-align: inherit;">Impresionante</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/25d/79c/e67/25d79ce679f05a53946b475c6c152cc4.png"></div><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Parte 5: el efecto de la intoxicaci√≥n </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Veamos c√≥mo el juego "The Witcher 3: Wild Hunt" implementa el efecto de la intoxicaci√≥n. </font><font style="vertical-align: inherit;">Si a√∫n no lo ha jugado, </font></font><strike><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">suelte todo, compre y juegue,</font></font></strike><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mire un video: </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tarde:</font></font><br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/Gy_B2V0QaqA" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Noche: </font></font><br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/CXu3e7LWkjE" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Primero, vemos una imagen doble y giratoria, que a menudo surge cuando bebes en la vida real. </font><font style="vertical-align: inherit;">Cuanto m√°s lejos est√© un p√≠xel del centro de la imagen, m√°s fuerte ser√° el efecto de rotaci√≥n. </font><font style="vertical-align: inherit;">Publiqu√© intencionalmente el segundo video con la noche, porque puedes ver claramente esta rotaci√≥n en las estrellas (¬øves 8 puntos separados?) </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La segunda parte del efecto de la intoxicaci√≥n, que puede no notarse de inmediato, es un ligero cambio en el zoom. </font><font style="vertical-align: inherit;">Se nota cerca del centro. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Probablemente sea obvio que este efecto es un postprocesamiento t√≠pico (sombreador de p√≠xeles). </font><font style="vertical-align: inherit;">Sin embargo, su ubicaci√≥n en la canalizaci√≥n de renderizado puede no ser tan obvia. </font><font style="vertical-align: inherit;">Resulta que el efecto de la intoxicaci√≥n se aplica inmediatamente </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">despu√©s de la</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> correcci√≥n tonal y justo antes del desenfoque de movimiento (la imagen "borracha" es la entrada para el desenfoque de movimiento).</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Comencemos los juegos con el c√≥digo ensamblador: </font></font><br><br><pre> <code class="hljs css"> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ps_5_0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_globalFlags</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">refactoringAllowed</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_constantbuffer</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb0</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[2]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">immediateIndexed</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_constantbuffer</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[3]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">immediateIndexed</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_sampler</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">mode_default</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_resource_texture2d</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_input_ps_siv</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">v1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">position</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_output</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">o0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dcl_temps</span></span> 8 0: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[0]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.100000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(1<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>) 1: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[1]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxyx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.050000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.050000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>) 2: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">v1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb0</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[1]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[2]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span> 3: <span class="hljs-selector-tag"><span class="hljs-selector-tag">dp2</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span> 4: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sqrt</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span> 5: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(10<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>) 6: <span class="hljs-selector-tag"><span class="hljs-selector-tag">min</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(1<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>) 7: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[0]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span> 8: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zzzz</span></span> 9: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 10: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span> 11: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zzzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxy</span></span> 12: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[2]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxy</span></span> 13: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[2]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxy</span></span> 14: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[0]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span> 15: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(5<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>) 16: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[0]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzw</span></span> 17: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(1<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 18: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span> 19: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span> 20: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 21: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0<span class="hljs-selector-class"><span class="hljs-selector-class">.707000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.707000</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.707000</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.707000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 22: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r7</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span> 23: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span> 24: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r7</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 25: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 26: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, 1<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 27: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.707000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.707000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.707000</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.707000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 28: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r7</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span> 29: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span> 30: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r7</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 31: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 32: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span> 33: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span> 34: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 35: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 36: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0<span class="hljs-selector-class"><span class="hljs-selector-class">.062500</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.062500</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.062500</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.062500</span></span>) 37: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(1<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzw</span></span> 38: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span> 39: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span> 40: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 41: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0<span class="hljs-selector-class"><span class="hljs-selector-class">.707000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.707000</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.707000</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.707000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzw</span></span> 42: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r7</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span> 43: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span> 44: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r7</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 45: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 46: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, 1<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzw</span></span> 47: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.707000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.707000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.707000</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.707000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 48: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span> 49: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span> 50: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 51: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 52: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span> 53: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span> 54: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 55: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 56: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0<span class="hljs-selector-class"><span class="hljs-selector-class">.062500</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.062500</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.062500</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.062500</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 57: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[0]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(8<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>) 58: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[0]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span> 59: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[1]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0<span class="hljs-selector-class"><span class="hljs-selector-class">.020000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(1<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>) 60: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zzzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxy</span></span> 61: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zzzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[2]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span> 62: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span> 63: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span> 64: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(2<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, 2<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span> 65: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span> 66: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span> 67: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sample_indexable</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">texture2d</span></span>)(<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">float</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">t0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">s0</span></span> 68: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 69: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 70: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0<span class="hljs-selector-class"><span class="hljs-selector-class">.333333</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.333333</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.333333</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.333333</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 71: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0<span class="hljs-selector-class"><span class="hljs-selector-class">.333333</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.333333</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.333333</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.333333</span></span>) 72: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.wwww</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 73: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">o0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[0]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yyyy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 74: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ret</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aqu√≠ se usan dos tampones constantes separados. Veamos sus valores:</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d7e/ce2/eb8/d7ece2eb8b0acf421cffd93222dd6821.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/832/ef8/941/832ef8941e9b4b6a38ad24b0c2e84cfa.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Estamos interesados ‚Äã‚Äãen algunos de ellos: </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cb0_v0.x -&gt; tiempo transcurrido (en segundos) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cb0_v1.xyzw - tama√±o de ventana y el rec√≠proco del tama√±o de ventana (tambi√©n conocido como "tama√±o de p√≠xel") </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cb3_v0.x - rotaci√≥n alrededor de un p√≠xel, siempre tiene un valor de 1.0. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cb3_v0.y: la magnitud del efecto de la intoxicaci√≥n. Despu√©s de encenderlo, no funciona con toda su fuerza, pero aumenta gradualmente de 0.0 a 1.0. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cv3_v1.xy - compensaciones de p√≠xeles (m√°s sobre esto a continuaci√≥n). Este es un par sin / cos, por lo que puede usar sincos (tiempo) en el sombreador si lo desea. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cb3_v2.xy es el centro del efecto, generalmente float2 (0.5, 0.5). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aqu√≠ queremos centrarnos en comprender lo que est√° sucediendo, y no solo reescribir ciegamente el sombreador. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comenzaremos con las primeras l√≠neas:</font></font><br><br><pre> <code class="hljs css"> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ps_5_0</span></span> 0: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[0]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.100000</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(1<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>) 1: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[1]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxyx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.050000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.050000</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.000000</span></span>) 2: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">v1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb0</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[1]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zwzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[2]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span> 3: <span class="hljs-selector-tag"><span class="hljs-selector-tag">dp2</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span> 4: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sqrt</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.w</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Llamo a la l√≠nea 0 "relaci√≥n de zoom" y pronto ver√° por qu√©. </font><font style="vertical-align: inherit;">Inmediatamente despu√©s (l√≠nea 1), calculamos el "desplazamiento de rotaci√≥n". </font><font style="vertical-align: inherit;">Esto es solo un par de datos de entrada sin / cos multiplicado por 0.05. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L√≠neas 2-4: Primero, calculamos el vector desde el centro del efecto hasta las coordenadas UV de la textura. </font><font style="vertical-align: inherit;">Luego calculamos el cuadrado de la distancia (3) y la distancia simple (4) (desde el centro hasta el texel)</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Zoom coordenadas de textura </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Veamos el siguiente c√≥digo de ensamblador: </font></font><br><br><pre> <code class="hljs css"> 8: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zzzz</span></span> 9: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 10: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xxxx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxx</span></span> 11: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yzyz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.zzzz</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxy</span></span> 12: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[2]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxy</span></span> 13: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[2]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyxy</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como est√°n empaquetados de esta manera, solo podemos analizar un par de flotadores. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para empezar, r0.yz son "desplazamientos de rotaci√≥n", r1.z es la distancia desde el centro al texel, r1.xy es el vector desde el centro al texel, r0.x es el "factor de zoom". </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para entender esto, supongamos por ahora que zoomFactor = 1.0, es decir, puede escribir lo siguiente:</font></font><br><br><pre> <code class="hljs powershell"> <span class="hljs-number"><span class="hljs-number">8</span></span>: mul r2.xyzw, r0.yzyz, r1.zzzz <span class="hljs-number"><span class="hljs-number">9</span></span>: mad r2.xyzw, r1.xyxy, r0.xxxx, <span class="hljs-literal"><span class="hljs-literal">-r2</span></span>.xyzw <span class="hljs-number"><span class="hljs-number">13</span></span>: add r2.xyzw, r2.xyzw, cb3[<span class="hljs-number"><span class="hljs-number">2</span></span>].xyxy r2.xy = (texel - center) * zoomFactor - rotationOffsets * distanceFromCenter + center;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pero zoomFactor = 1.0: </font></font><br><br><pre> <code class="hljs markdown"> r2.xy = texel - center - rotationOffsets <span class="hljs-bullet"><span class="hljs-bullet">* distanceFromCenter + center; r2.xy = texel - rotationOffsets *</span></span> distanceFromCenter;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Del mismo modo para r3.xy: </font></font><br><br><pre> <code class="hljs cs"> <span class="hljs-number"><span class="hljs-number">10</span></span>: mul r3.xy, r0.xxxx, r1.xyxx <span class="hljs-number"><span class="hljs-number">11</span></span>: mad r3.xyzw, r0.yzyz, r1.zzzz, r3.xyxy <span class="hljs-number"><span class="hljs-number">12</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> r3.xyzw, r3.xyzw, cb3[<span class="hljs-number"><span class="hljs-number">2</span></span>].xyxy r3.xy = rotationOffsets * distanceFromCenter + zoomFactor * (texel - center) + center</code> </pre> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pero zoomFactor = 1.0: </font><font style="vertical-align: inherit;">Genial. </font><font style="vertical-align: inherit;">Es decir, en este momento tenemos esencialmente el actual TextureUV (texel) ¬± desplazamiento de rotaci√≥n, pero ¬øqu√© pasa con zoomFactor? </font><font style="vertical-align: inherit;">Mire la l√≠nea 0. De hecho, zoomFactor = 1.0 - 0.1 * drunkAmount. </font><font style="vertical-align: inherit;">Para la cantidad m√°xima de borracho, el valor de zoomFactor debe ser 0.9, y las coordenadas de textura con zoom ahora se calculan de la siguiente manera:</font></font><br><br> <code>r3.xy = rotationOffsets * distanceFromCenter + texel - <strike>center</strike> + <strike>center</strike> r3.xy = texel + rotationOffsets * distanceFromCenter</code> <br> <br><font style="vertical-align: inherit;"></font><br><br><pre> <code class="hljs markdown"> baseTexcoordsA = 0.9 <span class="hljs-bullet"><span class="hljs-bullet">* texel + 0.1 *</span></span> center + rotationOffsets <span class="hljs-bullet"><span class="hljs-bullet">* distanceFromCenter baseTexcoordsB = 0.9 *</span></span> texel + 0.1 <span class="hljs-bullet"><span class="hljs-bullet">* center - rotationOffsets *</span></span> distanceFromCenter</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quiz√°s tal explicaci√≥n ser√≠a m√°s intuitiva: es simplemente una interpolaci√≥n lineal por alg√∫n factor entre las coordenadas de textura normalizadas y el centro. </font><font style="vertical-align: inherit;">Esta es una imagen de "acercamiento". </font><font style="vertical-align: inherit;">Para entender esto, es mejor experimentar con los valores. </font><font style="vertical-align: inherit;">Aqu√≠ hay un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">enlace</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> a Shadertoy, donde puedes ver el efecto en acci√≥n.</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Desplazamiento de textura </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Todo el fragmento en c√≥digo ensamblador: </font></font><br><br><pre> <code class="hljs powershell"> <span class="hljs-number"><span class="hljs-number">2</span></span>: mad r1.xy, v1.xyxx, cb0[<span class="hljs-number"><span class="hljs-number">1</span></span>].zwzz, <span class="hljs-literal"><span class="hljs-literal">-cb3</span></span>[<span class="hljs-number"><span class="hljs-number">2</span></span>].xyxx <span class="hljs-number"><span class="hljs-number">3</span></span>: dp2 r0.w, r1.xyxx, r1.xyxx <span class="hljs-number"><span class="hljs-number">5</span></span>: mul r0.w, r0.w, l(<span class="hljs-number"><span class="hljs-number">10.000000</span></span>) <span class="hljs-number"><span class="hljs-number">6</span></span>: min r0.w, r0.w, l(<span class="hljs-number"><span class="hljs-number">1.000000</span></span>) <span class="hljs-number"><span class="hljs-number">7</span></span>: mul r0.w, r0.w, cb3[<span class="hljs-number"><span class="hljs-number">0</span></span>].y <span class="hljs-number"><span class="hljs-number">14</span></span>: mul r0.x, r0.w, cb3[<span class="hljs-number"><span class="hljs-number">0</span></span>].x <span class="hljs-number"><span class="hljs-number">15</span></span>: mul r0.x, r0.x, l(<span class="hljs-number"><span class="hljs-number">5.000000</span></span>) // texcoords offset intensity <span class="hljs-number"><span class="hljs-number">16</span></span>: mul r4.xyzw, r0.xxxx, cb3[<span class="hljs-number"><span class="hljs-number">0</span></span>].zwzw // texcoords offset</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">crea un cierto gradiente, llam√©moslo la "m√°scara de intensidad de desplazamiento". </font><font style="vertical-align: inherit;">De hecho, le da dos significados. </font><font style="vertical-align: inherit;">El primero est√° en r0.w (lo usaremos m√°s tarde) y el segundo es 5 veces m√°s fuerte en r0.x (l√≠nea 15). </font><font style="vertical-align: inherit;">Este √∫ltimo realmente sirve como un factor para el tama√±o del texel, por lo que afecta la fuerza de sesgo. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Muestreo relacionado con la rotaci√≥n</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> A continuaci√≥n, se realiza una serie de muestreo de textura. </font><font style="vertical-align: inherit;">De hecho, se utilizan 2 series de 8 muestras, una para cada "lado". </font><font style="vertical-align: inherit;">En HLSL, puede escribir esto de la siguiente manera:</font></font><br><br><pre> <code class="hljs powershell"> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> const float2 pointsAroundPixel<span class="hljs-function"><span class="hljs-function">[</span><span class="hljs-number"><span class="hljs-function"><span class="hljs-number">8</span></span></span><span class="hljs-function">] = { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">float2</span></span></span></span>(<span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.0</span></span>), float2(<span class="hljs-literal"><span class="hljs-literal">-1</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0.0</span></span>), float2(<span class="hljs-number"><span class="hljs-number">0.707</span></span>, <span class="hljs-number"><span class="hljs-number">0.707</span></span>), float2(<span class="hljs-literal"><span class="hljs-literal">-0</span></span>.<span class="hljs-number"><span class="hljs-number">707</span></span>, <span class="hljs-literal"><span class="hljs-literal">-0</span></span>.<span class="hljs-number"><span class="hljs-number">707</span></span>), float2(<span class="hljs-number"><span class="hljs-number">0.0</span></span>, <span class="hljs-number"><span class="hljs-number">1.0</span></span>), float2(<span class="hljs-number"><span class="hljs-number">0.0</span></span>, <span class="hljs-literal"><span class="hljs-literal">-1</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>), float2(<span class="hljs-literal"><span class="hljs-literal">-0</span></span>.<span class="hljs-number"><span class="hljs-number">707</span></span>, <span class="hljs-number"><span class="hljs-number">0.707</span></span>), float2(<span class="hljs-number"><span class="hljs-number">0.707</span></span>, <span class="hljs-literal"><span class="hljs-literal">-0</span></span>.<span class="hljs-number"><span class="hljs-number">707</span></span>) }; float4 colorA = <span class="hljs-number"><span class="hljs-number">0</span></span>; float4 colorB = <span class="hljs-number"><span class="hljs-number">0</span></span>; int i=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-function"><span class="hljs-function">[</span><span class="hljs-type"><span class="hljs-function"><span class="hljs-type">unroll</span></span></span><span class="hljs-function">] </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">for</span></span></span></span> (i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">8</span></span>; i++) { colorA += TexColorBuffer.Sample( samplerLinearClamp, baseTexcoordsA + texcoordsOffset * pointsAroundPixel<span class="hljs-function"><span class="hljs-function">[</span><span class="hljs-type"><span class="hljs-function"><span class="hljs-type">i</span></span></span><span class="hljs-function">] ); } </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">colorA</span></span></span></span> /= <span class="hljs-number"><span class="hljs-number">16.0</span></span>; <span class="hljs-function"><span class="hljs-function">[</span><span class="hljs-type"><span class="hljs-function"><span class="hljs-type">unroll</span></span></span><span class="hljs-function">] </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">for</span></span></span></span> (i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">8</span></span>; i++) { colorB += TexColorBuffer.Sample( samplerLinearClamp, baseTexcoordsB + texcoordsOffset * pointsAroundPixel[<span class="hljs-type"><span class="hljs-type">i</span></span>] ); } colorB /= <span class="hljs-number"><span class="hljs-number">16.0</span></span>; float4 rotationPart = colorA + colorB;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El truco es que agregamos a baseTexcoordsA / B un desplazamiento adicional en el c√≠rculo unitario, multiplicado por la "intensidad del cambio de coordenadas de textura" mencionada anteriormente. </font><font style="vertical-align: inherit;">Cuanto m√°s lejos del centro est√© el p√≠xel, mayor ser√° el radio del c√≠rculo alrededor del p√≠xel: lo muestreamos 8 veces, lo que es claramente visible en las estrellas. </font><font style="vertical-align: inherit;">Valores PointsAroundPixel (m√∫ltiplos de 45 grados):</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0cb/5d0/5b4/0cb5d05b44fd9d2969af0416684d4b77.jpg"></div><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≠rculo √∫nico </font></font></a> <br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Muestreo relacionado con zoom</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> La segunda parte del efecto de embriaguez en The Witcher 3 es hacer zoom con acercar y alejar. </font><font style="vertical-align: inherit;">Veamos el c√≥digo del ensamblador que realiza esta tarea:</font></font><br><br><pre> <code class="hljs pgsql"> <span class="hljs-number"><span class="hljs-number">56</span></span>: mad r2.xyzw, r3.xyzw, l(<span class="hljs-number"><span class="hljs-number">0.062500</span></span>, <span class="hljs-number"><span class="hljs-number">0.062500</span></span>, <span class="hljs-number"><span class="hljs-number">0.062500</span></span>, <span class="hljs-number"><span class="hljs-number">0.062500</span></span>), r2.xyzw // the rotation part <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> stored <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> r2 register <span class="hljs-number"><span class="hljs-number">57</span></span>: mul r0.x, cb3[<span class="hljs-number"><span class="hljs-number">0</span></span>].y, l(<span class="hljs-number"><span class="hljs-number">8.000000</span></span>) <span class="hljs-number"><span class="hljs-number">58</span></span>: mul r0.xy, r0.xxxx, cb3[<span class="hljs-number"><span class="hljs-number">0</span></span>].zwzz <span class="hljs-number"><span class="hljs-number">59</span></span>: mad r0.z, cb3[<span class="hljs-number"><span class="hljs-number">1</span></span>].y, l(<span class="hljs-number"><span class="hljs-number">0.020000</span></span>), l(<span class="hljs-number"><span class="hljs-number">1.000000</span></span>) <span class="hljs-number"><span class="hljs-number">60</span></span>: mul r1.zw, r0.zzzz, r1.xxxy <span class="hljs-number"><span class="hljs-number">61</span></span>: mad r1.xy, r1.xyxx, r0.zzzz, cb3[<span class="hljs-number"><span class="hljs-number">2</span></span>].xyxx <span class="hljs-number"><span class="hljs-number">62</span></span>: mad r3.xy, r1.zwzz, r0.xyxx, r1.xyxx <span class="hljs-number"><span class="hljs-number">63</span></span>: mul r0.xy, r0.xyxx, r1.zwzz <span class="hljs-number"><span class="hljs-number">64</span></span>: mad r0.xy, r0.xyxx, l(<span class="hljs-number"><span class="hljs-number">2.000000</span></span>, <span class="hljs-number"><span class="hljs-number">2.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>, <span class="hljs-number"><span class="hljs-number">0.000000</span></span>), r1.xyxx <span class="hljs-number"><span class="hljs-number">65</span></span>: sample_indexable(texture2d)(<span class="hljs-type"><span class="hljs-type">float</span></span>,<span class="hljs-type"><span class="hljs-type">float</span></span>,<span class="hljs-type"><span class="hljs-type">float</span></span>,<span class="hljs-type"><span class="hljs-type">float</span></span>) r1.xyzw, r1.xyxx, t0.xyzw, s0 <span class="hljs-number"><span class="hljs-number">66</span></span>: sample_indexable(texture2d)(<span class="hljs-type"><span class="hljs-type">float</span></span>,<span class="hljs-type"><span class="hljs-type">float</span></span>,<span class="hljs-type"><span class="hljs-type">float</span></span>,<span class="hljs-type"><span class="hljs-type">float</span></span>) r4.xyzw, r0.xyxx, t0.xyzw, s0 <span class="hljs-number"><span class="hljs-number">67</span></span>: sample_indexable(texture2d)(<span class="hljs-type"><span class="hljs-type">float</span></span>,<span class="hljs-type"><span class="hljs-type">float</span></span>,<span class="hljs-type"><span class="hljs-type">float</span></span>,<span class="hljs-type"><span class="hljs-type">float</span></span>) r3.xyzw, r3.xyxx, t0.xyzw, s0 <span class="hljs-number"><span class="hljs-number">68</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> r1.xyzw, r1.xyzw, r3.xyzw <span class="hljs-number"><span class="hljs-number">69</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> r1.xyzw, r4.xyzw, r1.xyzw</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vemos que hay tres llamadas de textura separadas, es decir, tres coordenadas de textura diferentes. </font><font style="vertical-align: inherit;">Analicemos c√≥mo se calculan las coordenadas de textura a partir de ellos. </font><font style="vertical-align: inherit;">Pero primero, mostramos la entrada para esta parte:</font></font><br><br><pre> <code class="hljs pgsql"> <span class="hljs-type"><span class="hljs-type">float</span></span> zoomInOutScalePixels = drunkEffectAmount * <span class="hljs-number"><span class="hljs-number">8.0</span></span>; // <span class="hljs-type"><span class="hljs-type">line</span></span> <span class="hljs-number"><span class="hljs-number">57</span></span> float2 zoomInOutScaleNormalizedScreenCoordinates = zoomInOutScalePixels * texelSize.xy; // <span class="hljs-type"><span class="hljs-type">line</span></span> <span class="hljs-number"><span class="hljs-number">58</span></span> <span class="hljs-type"><span class="hljs-type">float</span></span> zoomInOutAmplitude = <span class="hljs-number"><span class="hljs-number">1.0</span></span> + <span class="hljs-number"><span class="hljs-number">0.02</span></span>*cos(<span class="hljs-type"><span class="hljs-type">time</span></span>); // <span class="hljs-type"><span class="hljs-type">line</span></span> <span class="hljs-number"><span class="hljs-number">59</span></span> float2 zoomInOutfromCenterToTexel = zoomInOutAmplitude * fromCenterToTexel; // <span class="hljs-type"><span class="hljs-type">line</span></span> <span class="hljs-number"><span class="hljs-number">60</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Algunas palabras sobre la entrada. </font><font style="vertical-align: inherit;">Calculamos el desplazamiento en texels (por ejemplo, 8.0 * texel size), que luego se agrega a las coordenadas uv base. </font><font style="vertical-align: inherit;">La amplitud simplemente oscila entre 0,98 y 1,02 para dar una sensaci√≥n de zoom, al igual que zoomFactor en la parte que realiza la rotaci√≥n. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comencemos con el primer par - r1.xy (l√≠nea 61)</font></font><br><br><pre> <code class="hljs markdown"> r1.xy = fromCenterToTexel <span class="hljs-bullet"><span class="hljs-bullet">* amplitude + center r1.xy = (TextureUV - Center) *</span></span> amplitude + Center // you can insert here zoomInOutfromCenterToTexel r1.xy = TextureUV <span class="hljs-bullet"><span class="hljs-bullet">* amplitude - Center *</span></span> amplitude + Center r1.xy = TextureUV <span class="hljs-bullet"><span class="hljs-bullet">* amplitude + Center *</span></span> 1.0 - Center <span class="hljs-bullet"><span class="hljs-bullet">* amplitude r1.xy = TextureUV *</span></span> amplitude + Center * (1.0 - amplitude) r1.xy = lerp( TextureUV, Center, amplitude);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Eso es: </font></font><br><br><pre> <code class="hljs lisp">float2 zoomInOutBaseTextureUV = lerp(<span class="hljs-name"><span class="hljs-name">TextureUV</span></span>, Center, amplitude)<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Vamos a ver el segundo par - r3.xy (l√≠nea 62) </font></font><br><br><pre> <code class="hljs markdown"> r3.xy = (amplitude <span class="hljs-bullet"><span class="hljs-bullet">* fromCenterToTexel) *</span></span> zoomInOutScaleNormalizedScreenCoordinates + zoomInOutBaseTextureUV</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Eso es: </font></font><br><br><pre> <code class="hljs nginx"> <span class="hljs-attribute"><span class="hljs-attribute">float2</span></span> zoomInOutAddTextureUV0 = zoomInOutBaseTextureUV + zoomInOutfromCenterToTexel*zoomInOutScaleNormalizedScreenCoordinates;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Vamos a ver el tercer par - r0.xy (l√≠neas 63-64) </font></font><br><br><pre> <code class="hljs markdown"> r0.xy = zoomInOutScaleNormalizedScreenCoordinates <span class="hljs-bullet"><span class="hljs-bullet">* (amplitude *</span></span> fromCenterToTexel) * 2.0 + zoomInOutBaseTextureUV</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Eso es: </font></font><br><br><pre> <code class="hljs markdown"> float2 zoomInOutAddTextureUV1 = zoomInOutBaseTextureUV + 2.0<span class="hljs-emphasis"><span class="hljs-emphasis">*zoomInOutfromCenterToTexel*</span></span>zoomInOutScaleNormalizedScreenCoordinates</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Las tres consultas de textura se suman y el resultado se almacena en el registro r1. </font><font style="vertical-align: inherit;">Vale la pena se√±alar que este sombreador de p√≠xeles utiliza un muestreador de direccionamiento limitado. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Poniendo todo junto</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Entonces, en este momento tenemos el resultado de la rotaci√≥n en el registro r2 y tres solicitudes de zoom plegadas en el registro r1. </font><font style="vertical-align: inherit;">Veamos las √∫ltimas l√≠neas de c√≥digo ensamblador:</font></font><br><br><pre> <code class="hljs css"> 70: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0<span class="hljs-selector-class"><span class="hljs-selector-class">.333333</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.333333</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.333333</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.333333</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 71: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">l</span></span>(0<span class="hljs-selector-class"><span class="hljs-selector-class">.333333</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.333333</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.333333</span></span>, 0<span class="hljs-selector-class"><span class="hljs-selector-class">.333333</span></span>) 72: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mul</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.wwww</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 73: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mad</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">o0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">cb3</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[0]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yyyy</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">r1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xyzw</span></span> 74: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ret</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Acerca de la entrada adicional: r0.w se toma de la l√≠nea 7, esta es nuestra m√°scara de intensidad, y cb3 [0] .y es la magnitud del efecto de intoxicaci√≥n. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Veamos como funciona. </font><font style="vertical-align: inherit;">Mi primer acercamiento fue la fuerza bruta:</font></font><br><br><pre> <code class="hljs nginx"> <span class="hljs-attribute"><span class="hljs-attribute">float4</span></span> finalColor = intensityMask * (rotationPart - zoomingPart); <span class="hljs-attribute"><span class="hljs-attribute">finalColor</span></span> = drunkIntensity * finalColor + zoomingPart; <span class="hljs-attribute"><span class="hljs-attribute">return</span></span> finalColor;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pero </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qu√© demonios, nadie escribe sombreadores as√≠</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Tom√© un l√°piz con papel y escrib√≠ esta f√≥rmula:</font></font><br><br><pre> <code class="hljs powershell"> finalColor = effectAmount * [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span><span class="hljs-type"><span class="hljs-type">ensityMask</span></span> * (<span class="hljs-type"><span class="hljs-type">rotationPart</span></span> - <span class="hljs-type"><span class="hljs-type">zoomPart</span></span>)] + zoomPart finalColor = effectAmount * intensityMask * rotationPart - effectAmount * intensityMask * zoomPart + zooomPart</code> </pre> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Donde t = effectAmount * intensidadMask </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Entonces, obtenemos:</font></font><br><br><pre> <code class="hljs lisp"> finalColor = <span class="hljs-literal"><span class="hljs-literal">t</span></span> * rotationPart - <span class="hljs-literal"><span class="hljs-literal">t</span></span> * zoomPart + zoomPart finalColor = <span class="hljs-literal"><span class="hljs-literal">t</span></span> * rotationPart + zoomPart - <span class="hljs-literal"><span class="hljs-literal">t</span></span> * zoomPart finalColor = <span class="hljs-literal"><span class="hljs-literal">t</span></span> * rotationPart + (<span class="hljs-number"><span class="hljs-number">1.0</span></span> - <span class="hljs-literal"><span class="hljs-literal">t</span></span>) * zoomPart finalColor = lerp( <span class="hljs-name"><span class="hljs-name">zoomingPart</span></span>, rotationPart, <span class="hljs-literal"><span class="hljs-literal">t</span></span> )</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Y llegamos a lo siguiente: </font></font><br><br><pre> <code class="hljs lisp"> finalColor = lerp(<span class="hljs-name"><span class="hljs-name">zoomingPart</span></span>, rotationPart, intensityMask * drunkIntensity);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">S√≠, esta parte del art√≠culo result√≥ ser muy detallada, ¬°pero finalmente terminamos! </font><font style="vertical-align: inherit;">Personalmente, aprend√≠ algo en el proceso de escritura, ¬°espero que t√∫ tambi√©n lo hagas! </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si est√° interesado, las fuentes completas de HLSL est√°n disponibles </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqu√≠</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Los prob√© con mi </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HLSLexplorer</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , y aunque no hay correspondencias directas uno a uno con el sombreador original, las diferencias son tan peque√±as (una l√≠nea menos) que puedo decir con seguridad que funciona. </font><font style="vertical-align: inherit;">Gracias por leer!</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es422573/">https://habr.com/ru/post/es422573/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es422555/index.html">Arquitectura de m√∫ltiples m√≥dulos de Android. De la A a la Z</a></li>
<li><a href="../es422561/index.html">C√≥mo Yandex aplic√≥ la visi√≥n por computadora para mejorar la calidad de las transmisiones de video. Tecnolog√≠a DeepHD</a></li>
<li><a href="../es422565/index.html">Seminarios web de Skillbox Friday: todo para programadores y dise√±adores</a></li>
<li><a href="../es422569/index.html">Aplicaci√≥n de seguimiento horario</a></li>
<li><a href="../es422571/index.html">Paralelizaci√≥n de tareas con dependencias: ejemplo de .NET</a></li>
<li><a href="../es422575/index.html">Portero raro</a></li>
<li><a href="../es422577/index.html">Copias y derechos de autor: c√≥mo las patentes y los derechos de autor afectan el desarrollo de la impresi√≥n 3D</a></li>
<li><a href="../es422581/index.html">Interruptor cu√°ntico estilo Schr√∂dinger</a></li>
<li><a href="../es422583/index.html">Tough Middling: revisi√≥n del tel√©fono Snom D735 IP</a></li>
<li><a href="../es422585/index.html">El uso pr√°ctico de las redes neuronales.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>