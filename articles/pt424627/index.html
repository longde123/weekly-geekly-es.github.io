<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëâ ü¶ã üç¶ Altera√ß√£o de caixas registradoras. Parte 1 üë∞üèø üëéüèΩ üôãüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bom dia a todos. Alguns anos atr√°s, uma velha caixa registradora descomissionada caiu acidentalmente em minhas m√£os. Foi chamado "Elfos Micro-F". Porq...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Altera√ß√£o de caixas registradoras. Parte 1</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/424627/"><p>  Bom dia a todos.  Alguns anos atr√°s, uma velha caixa registradora descomissionada caiu acidentalmente em minhas m√£os.  Foi chamado "Elfos Micro-F".  Porque  Estou interessado em eletr√¥nica e programa√ß√£o, incluindo a constru√ß√£o de v√°rios dispositivos em microcontroladores, o dispositivo decidiu investigar.  Tendo desmontado, vi: </p><br><ul><li>  uma placa com enchimento eletr√¥nico e um microcontrolador AT89C52 em um soquete </li><li>  exibi√ß√£o </li><li>  impressora t√©rmica </li><li>  bateria </li><li>  teclado de filme </li><li>  dois LEDs </li></ul><a name="habracut"></a><br><p><img src="http://avsrv2.sytes.net/pics/kassa/IMAG0162.jpg" alt="imagem"><br>  <em>Fig. 1 Apar√™ncia da mesa de caixa</em> </p><br><p>  Naquela √©poca, eu j√° tinha a experi√™ncia de criar dispositivos simples a partir do zero (rel√≥gios, rel√©s controlados pela porta COM etc.).  Compreender o dispositivo acabado parecia muito mais dif√≠cil.  Para come√ßar, encontrei na rede uma descri√ß√£o desse dispositivo, um diagrama e uma documenta√ß√£o de reparo.  Como se viu, existem v√°rios esquemas, eles diferem bastante fortemente, embora os dispositivos sejam chamados quase da mesma forma.  Mas no final, encontrei o circuito certo.  Ele olhou para ela e percebeu que, de fato, o dispositivo de pagamento n√£o √© t√£o complicado. </p><br><p>  Eu tive que descobrir: </p><br><ul><li>  qu√£o f√°cil √© programar o microcontrolador para n√£o arrast√°-lo para frente e para tr√°s, depois para o programador e depois para o quadro </li><li>  como estabelecer uma troca com um computador </li><li>  como trabalhar com RAM (e houve um AT24C08 serial) </li><li>  como desenhar algo no visor </li><li>  como obter as teclas digitadas </li><li>  e o mais importante!  como produzir algo significativo para uma impressora t√©rmica </li></ul><br><p>  Neste artigo, falarei sobre o in√≠cio do meu trabalho.  O objetivo final √© criar uma impressora t√©rmica a partir de uma antiga caixa registradora baixada. </p><br><p>  Parte 1 <br>  Iniciar </p><br><p>  No come√ßo, decidi abandonar o microcontrolador que estava no quadro.  Primeiro, ele s√≥ podia ser programado em um programador, o que eu n√£o tinha para esse tipo de controlador.  Em segundo lugar, ele tinha pouca mem√≥ria flash interna para programas. <br>  Tendo sido atormentado com a escolha, decidi pelo microcontrolador Winbond w78e58b.  Ele estava no mesmo pacote (plcc44), tinha 32Kb de mem√≥ria de programa e mais mem√≥ria est√°tica interna para armazenar vari√°veis ‚Äã‚Äãe, o mais importante, permitia que voc√™ se programa usando o programador em circuito sem remov√™-lo do soquete! </p><br><p>  Mas havia uma dificuldade: para come√ßar a program√°-lo, foi necess√°rio um programador paralelo para esse tipo de microcontrolador para carregar o bootloader, com o qual eu mais tarde carregaria meu firmware.  Encontrei informa√ß√µes sobre como criar um programador na Internet, montar um programador e um carregador de inicializa√ß√£o com patches! </p><br><p>  Depois, houve outro problema - esta unidade n√£o tinha um conector para conectar a um PC! </p><br><p><img src="http://avsrv2.sytes.net/pics/kassa/int_plats_big.jpg" alt="imagem"><br>  <em>Fig. 2 Placa de interface original</em> <em><br></em> <br>  Embora, como li nos manuais, houvesse um len√ßo assim e houvesse plugues no estojo do dispositivo e um conector na placa, mas n√£o consegui esse emparelhamento.  Naquela √©poca, n√£o estava √† venda em lugar algum e n√£o custava dinheiro doentio.  Ent√£o eu decidi fazer a interface eu mesmo.  Eu quebrei um plugue do gabinete, desmontei o soquete da rede local com um conector para RJ45, cortei esse conector em um peda√ßo da placa e colei na bilheteria para colar adesivos de fus√£o a quente.  Como resultado, o par tran√ßado usual foi inserido perfeitamente do lado de fora at√© um clique!  Resta conectar os pinos do conector ao microcontrolador.  Diretamente, √© claro, √© imposs√≠vel, √© necess√°rio atrav√©s de um conversor de n√≠vel, por exemplo, MAX232.  Em um pequeno peda√ßo da t√°bua de p√£o, ele colocou o chip, os capacitores de cintas, soldou a fia√ß√£o.  Soldei um cabo para conectar a um computador a partir de um peda√ßo de par tran√ßado.  Por um lado, um conector RJ45 comum, por outro, uma m√£e DB9 para um conector de porta COM. </p><br><p>  A pr√≥xima tarefa foi encontrar um compilador, gratuito e n√£o particularmente dif√≠cil para esses prop√≥sitos.  Me deparei com microvis√£o keil.  Era algum tipo de vers√£o demo com um limite de comprimento de c√≥digo.  O suficiente para meus prop√≥sitos.  O primeiro programa foi simples: enviar para o computador no programa terminal apenas algo como Hello world! </p><br><p>  Eu escrevi um programa, a dificuldade estava apenas na inicializa√ß√£o inicial de portas e registros de servi√ßo.  Mas, depois de pesquisar na rede por exemplos, rapidamente lidei com isso.  Em seguida, lancei o programa <br>  8051IspWriter, que carrega o firmware.  Para que o microcontrolador alternasse para o modo bay do firmware, era necess√°rio ativar o gerenciador de inicializa√ß√£o embutido.  Como se viu, isso pode ser feito colocando em curto a terra a sa√≠da do controlador antes de aplicar energia.  Qual deles - encontrado na folha de dados no microcontrolador.  O firmware foi carregado, ap√≥s o que eu desliguei, liguei o caixa e vi meu texto na tela do terminal!  O sistema funcionou! </p><br><p>  Al√©m disso, decidi controlar um pouco a caixa registradora ou piscar o LED.  De acordo com o esquema, eu determinei para qual perna do microcontrolador este LED vai, escrevi um pisca-pisca simples e o LED come√ßou a piscar no caixa!  O caminho para o objetivo final j√° se tornou vis√≠vel! </p><br><p>  Trechos do c√≥digo fonte: </p><br><pre><code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span></span><span class="hljs-function">)</span></span> { UCHAR i; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> c; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> data <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; UCHAR bCassaTypeOld; UCHAR iNumSymbolsOld; jmpLDROM=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">//            P0 |= 0x01; // PPWR = 1 P1 |= 0x20; // PM1 = 1 P1 |= 0x40; // PM2 = 1 P3 &amp;= ~0x40; // SI = 0 P3 &amp;= ~0x20; // CLOCK = 0 P3 |= 0x80; // LATCH = 1 P3 |= 0x10; // STBA = 1 P3 |= 0x08; // STBB = 1 //          initUart(BAUD_RATE_19200); puts("Hello world!"); while(1) ; }</span></span></code> </pre> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt424627/">https://habr.com/ru/post/pt424627/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt424613/index.html">Experi√™ncia no uso de redux sem redutores</a></li>
<li><a href="../pt424615/index.html">Sa√≠da da fun√ß√£o curva para limitar par√¢metros, sinais e n√£o apenas no Wolfram Mathematica</a></li>
<li><a href="../pt424621/index.html">Super-her√≥is que n√£o s√£o filmes. Quem e como protege o canteiro de obras do Lakhta Center contra inc√™ndios?</a></li>
<li><a href="../pt424623/index.html">Vamos processar o som no Go</a></li>
<li><a href="../pt424625/index.html">Vazamento de c√≥digo-fonte dos servi√ßos Web da Aeroflot</a></li>
<li><a href="../pt424629/index.html">Como as startups aumentam suas chances de investir ao se comunicar com um investidor?</a></li>
<li><a href="../pt424633/index.html">Como STACKLEAK melhora a seguran√ßa do kernel do Linux</a></li>
<li><a href="../pt424635/index.html">Bem-vindo ao Sberbank Data Science Journey 2018 - Corrida de algoritmos de aprendizado de m√°quina</a></li>
<li><a href="../pt424637/index.html">C√≥digo de barras m√°gico</a></li>
<li><a href="../pt424639/index.html">Google tem 20 anos</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>