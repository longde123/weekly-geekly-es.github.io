<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üí¢ ü•ü üßòüèæ Files d'attente de messages PostgreSQL utilisant PgQ üì¶ üë®‚Äç‚ù§Ô∏è‚Äçüë® ‚õπÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Les files d'attente de messages sont utilis√©es pour effectuer: op√©rations en attente, interaction entre services, ¬´traitement par lots¬ª, etc. Il exist...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Files d'attente de messages PostgreSQL utilisant PgQ</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/483014/"><img src="https://habrastorage.org/webt/g4/5g/b1/g45gb1ef-etyywuggdsyiyr-lyk.jpeg"><br><br>  Les files d'attente de messages sont utilis√©es pour effectuer: op√©rations en attente, interaction entre services, ¬´traitement par lots¬ª, etc.  Il existe des solutions sp√©cialis√©es pour organiser de telles files d'attente, telles que: RabbitMQ, ActiveMQ, ZeroMQ, etc., mais il arrive souvent qu'elles ne soient pas d'un grand besoin, et leur installation et leur support causeront plus de douleur et de souffrance qu'elles n'en apporteront d'avantages.  Supposons que vous ayez un service lors de votre inscription dans lequel un e-mail est envoy√© √† l'utilisateur pour confirmation, et si vous utilisez Postgres, alors vous avez de la chance - dans Postgres, presque pr√™t √† l'emploi, il existe une extension PgQ qui fera tout le sale boulot pour vous. <br><br>  Dans cet article, je parlerai de la mise en file d'attente des messages (t√¢ches) dans PostgreSQL en utilisant l'extension PgQ.  Cet article sera utile si vous n'avez pas utilis√© PgQ ou utilisez des files d'attente auto-√©crites au-dessus de Postgres. <br><br>  Pourquoi avez-vous besoin de PgQ, si vous pouvez simplement cr√©er une tablette et y √©crire des t√¢ches?  Cela semble possible, mais vous devrez prendre en compte l'acc√®s parall√®le aux t√¢ches, les erreurs possibles (que se passera-t-il si le processus de traitement de la t√¢che tombe?), Ainsi que les performances (PgQ est tr√®s rapide, et les solutions auto-√©crites ne le sont g√©n√©ralement pas, surtout si la transaction est en la base de donn√©es ne se ferme pas pendant toute l'ex√©cution de la t√¢che), mais la raison la plus importante √† mon avis pour laquelle il est n√©cessaire d'utiliser PgQ est que PgQ est d√©j√† √©crit et fonctionne, et la solution auto-√©crite doit encore √™tre √©crite (UPD: pourquoi cela ne vaut pas la peine d'utiliser des files d'attente auto-√©crites , vous pouvez lire, par exemple, <a href="https://habr.com/ru/company/oleg-bunin/blog/455248/">ici</a> ). <br>  (UPD: puisque PgQ s'ex√©cute au-dessus de Postgres, tous les plaisirs des transactions peuvent √©galement y √™tre utilis√©s) <br><br>  Mais PgQ a un √©norme inconv√©nient - le manque de documentation, j'essaie de compenser cette lacune avec cet article. <br><a name="habracut"></a><br><h4>  P√©riph√©rique </h4><br>  PgQ se compose de parties (au moins 2): 1 - extension pgq pour postgres, 2 - d√©mon pgqd (pour les installer un peu plus tard). <br><br>  Toutes les interactions avec la file d'attente sont effectu√©es √† l'aide de fonctions √† l'int√©rieur de Postgres. <br><br>  Par exemple, pour cr√©er une file d'attente, vous devez ex√©cuter <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pgq.create_queue({ } <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>);</code> </pre> <br>  Une fois la file d'attente cr√©√©e, vous pouvez y ajouter des messages. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pgq.insert_event({ } <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, { } <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, {  } <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>);</code> </pre> <br>  Maintenant, nous devons apprendre √† recevoir des messages enregistr√©s.  Pour cela, il existe une entit√© telle que ¬´consommateur¬ª (j'√©crirai un consommateur), qui re√ßoit non pas des messages (√©v√©nements), mais ¬´batch¬ª (batch).  Un bach est un groupe de messages cons√©cutifs, les baches sont cr√©√©s √† l'aide de pgqd.  P√©riodiquement (le param√®tre ¬´ticker_period¬ª dans le fichier de configuration) pgqd prend tous les messages accumul√©s et √©crit dans un nouveau bach.  <b>Il est important</b> que pgqd ne fonctionne pas, alors de nouveaux bachs ne sont pas cr√©√©s, ce qui signifie que les consommateurs n'ont rien √† lire, √©galement si pgqd n'a pas fonctionn√© pendant une longue p√©riode puis allum√©, il cr√©era un gros bach √† partir des messages accumul√©s pendant ce temps, donc pgqd ne devrait pas √™tre il suffit de l'√©teindre. <br><br>  Enregistrement d'un consommateur ( <b>Important! Un</b> consommateur ne recevra des √©v√©nements enregistr√©s <b>qu'apr√®s</b> son enregistrement, vous devez donc d'abord cr√©er un consommateur, puis √©crire des √©v√©nements uniquement): <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pgq.register_consumer({ } <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, { } <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>);</code> </pre> <br>  <i>(similaire √† pgq.unregister_consumer)</i> <br>  Chaque consommateur recevra <b>absolument tous les √©v√©nements</b> survenus apr√®s sa cr√©ation (m√™me trait√©s par un autre consommateur), ce qui signifie que vous n'avez probablement besoin que d'un seul consommateur pour un tour.  Ensuite, je vais vous dire comment r√©partir la charge sur plusieurs serveurs. <br><br>  Pour obtenir un bach, vous devez d'abord trouver son ID: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pgq.next_batch({ } <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, { } <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>);</code> </pre> <br>  La fonction peut retourner NULL si le consommateur a trait√© tous les bachs.  Dans ce cas, il vous suffit d'attendre que pgqd cr√©e un nouveau bach. <br><br>  Dans ce cas, alors que le bach n'est pas trait√©, cette fonction retournera la m√™me valeur. <br>  Vous pouvez obtenir tous les √©v√©nements du lot en utilisant: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pgq.get_batch_events({<span class="hljs-keyword"><span class="hljs-keyword">id</span></span> } <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>);</code> </pre> <br>  (Le bach est peut-√™tre vide.) <br><br>  Si une erreur s'est produite lors du traitement de l'un d'eux, vous pouvez essayer de traiter cet √©v√©nement ult√©rieurement: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pgq.event_retry({<span class="hljs-keyword"><span class="hljs-keyword">id</span></span> } <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>, {<span class="hljs-keyword"><span class="hljs-keyword">id</span></span> } <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>, {   } <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>);</code> </pre> <br>  Pour informer sur la fin du bach et avoir l'opportunit√© d'en d√©marrer un nouveau, il est utilis√© <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pgq.finish_batch({<span class="hljs-keyword"><span class="hljs-keyword">id</span></span> } <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>);</code> </pre> <br>  Bien s√ªr, ce ne sont pas toutes les fonctions de l'extension, je recommande de lire <a href="https://pgq.github.io/extension/pgq/files/external-sql.html" rel="nofollow">pgq.github.io/extension/pgq/files/external-sql.html</a> et <a href="https://github.com/pgq/pgq/tree/master/functions" rel="nofollow">github.com/pgq/pgq/tree/master/functions</a> (chaque fichier contient une d√©finition et une description fonction correspondante). <br><br><h4>  Partage de charge </h4><br>  Afin de g√©rer les √©v√©nements simultan√©ment par plusieurs gestionnaires, il existe l'extension pgq_coop, qui fonctionne comme pgq et ajoute une nouvelle entit√© appel√©e ¬´sous-consommateur¬ª, qui recevra tous les √©v√©nements √† partir du moment de l'enregistrement du consommateur parent, bien s√ªr, √† l'exception de ceux d√©j√† trait√©s. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pgq_coop.register_subconsumer({ } <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, { } <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, { } <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>);</code> </pre> <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pgq_coop.next_batch({ } <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, { } <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, { } <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>);</code> </pre> <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pgq_coop.next_batch({ } <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, { } <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, { } <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, {        ,      } <span class="hljs-built_in"><span class="hljs-built_in">interval</span></span>);</code> </pre> <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pgq_coop.finish_batch({<span class="hljs-keyword"><span class="hljs-keyword">id</span></span> } <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>);</code> </pre> <br>  D√©couvrez toutes les fonctionnalit√©s <a href="https://github.com/pgq/pgq-coop/tree/master/functions" rel="nofollow">ici</a> . <br><br><h4>  L'installation </h4><br>  L'extension pgq et le d√©mon pgqd sont inclus dans les r√©f√©rentiels PGDG et sont install√©s tr√®s simplement dans la plupart des distributions, par exemple dans Debian: <br><br>  <code>sudo apt install postgresql-XX-pgq3 pgqd</code> (XX est le num√©ro de version). <br><br>  pgqd est un petit programme que vous pouvez d√©couvrir sur l'utilisation de <code>pgqd --help</code> , n'oubliez pas de l'ajouter √† l' <code>sudo systemctl enable pgqd.service</code> automatique ( <code>sudo systemctl enable pgqd.service</code> , et la configuration par d√©faut est <code>/etc/pgqd.ini</code> ). <br><br>  Pour commencer √† utiliser PgQ, dans la base de donn√©es il vous suffit de connecter l'extension: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> extension <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exists</span></span> pgq;</code> </pre> <br><br>  Avec pgq_coop, tout est un peu plus compliqu√©, ce n'est pas dans le d√©p√¥t, mais ce n'est pas difficile de le compiler √† partir des sources (exemple pour Debian): <br><br><pre> <code class="plaintext hljs">sudo apt install postgresql-server-dev-XX git clone https://github.com/pgq/pgq-coop.git cd pgq-coop sudo make install</code> </pre><br>  et connectez l'extension √† l'aide <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> extension <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exists</span></span> pgq_coop;</code> </pre> <br><h4>  Liens utiles </h4><br>  <a href="https://pgq.github.io/extension/pgq/files/external-sql.html" rel="nofollow">Documentation PGQ</a> <br>  <a href="https://github.com/pgq/pgq/tree/master/functions" rel="nofollow">Fonctions Pgq</a> <br>  <a href="https://github.com/pgq/pgq-coop/tree/master/functions" rel="nofollow">Fonctions Pgq_coop</a> <br>  <a href="https://github.com/pgq/pgqd" rel="nofollow">Code source pgqd</a> <br>  <a href="https://github.com/pgq" rel="nofollow">compte github avec tous les projets associ√©s</a> <br>  <a href="https://wiki.postgresql.org/wiki/PGQ_Tutorial" rel="nofollow">Postgres wiki</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr483014/">https://habr.com/ru/post/fr483014/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr482998/index.html">Nouvelles du monde d'OpenStreetMap n ¬∞ 492 (17/12/2019 - 23/12/2019)</a></li>
<li><a href="../fr483000/index.html">La position officielle de Telegram concernant la blockchain TON</a></li>
<li><a href="../fr483004/index.html">Effet Kuleshov dans Disco Elysium: comment le contexte cr√©e du sens</a></li>
<li><a href="../fr483008/index.html">Un autre avenir - une scission de l'humanit√©</a></li>
<li><a href="../fr483012/index.html">Antiquit√©s: Roland MT-32, un son alternatif pour les jeux DOS</a></li>
<li><a href="../fr483016/index.html">Une br√®ve histoire des microprocesseurs spatiaux, deuxi√®me partie</a></li>
<li><a href="../fr483018/index.html">Mask-R CNN du d√©butant au professionnel</a></li>
<li><a href="../fr483024/index.html">¬´Qu'est-ce que les entreprises ont fait avec votre vie priv√©e?¬ª, Arthur Khachuyan (Tazeros Global)</a></li>
<li><a href="../fr483026/index.html">Java / Spring: comment g√©n√©rer compl√®tement une API CRUD REST √† l'aide de Speedment</a></li>
<li><a href="../fr483030/index.html">API qui vous fait pleurer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>