<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üóëÔ∏è üö¥üèø üóª Nicht offensichtliche Funktionen der Rotativa-Anwendung zum Generieren von PDF in der ASP.NET MVC-Anwendung üå´Ô∏è ü§õ üï∫üèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Viele Entwickler stehen vor der Aufgabe, PDF-Berichte f√ºr Webanwendungen zu erstellen, eine ganz nat√ºrliche Anforderung. Ich m√∂chte Sie auf meine Erfa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Nicht offensichtliche Funktionen der Rotativa-Anwendung zum Generieren von PDF in der ASP.NET MVC-Anwendung</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/425511/"><p>  Viele Entwickler stehen vor der Aufgabe, PDF-Berichte f√ºr Webanwendungen zu erstellen, eine ganz nat√ºrliche Anforderung.  Ich m√∂chte Sie auf meine Erfahrungen mit einer solchen Aufgabe bei der Verwendung der Rotativa-Bibliothek zur Erstellung von Berichten aufmerksam machen.  Dies ist meiner Meinung nach eine der praktischsten Bibliotheken f√ºr einen solchen Zweck in ihrem Segment, aber als ich sie verwendete, stie√ü ich auf einige nicht offensichtliche Punkte, √ºber die ich sprechen m√∂chte. </p><a name="habracut"></a><br><p>  Um ganz ehrlich zu sein, m√∂chte ich die Reihe von Rechen teilen, auf die ich bei der Integration dieser Bibliothek gesto√üen bin, ohne Zweifel schnell und sehr praktisch. </p><br><p> In diesem Artikel werde ich nicht auf das Problem der Auswahl einer Bibliothek eingehen.  Jeder kann seine eigenen Gr√ºnde haben, dies oder das zu verwenden.  Ich habe mich f√ºr Rotativa entschieden, weil es mit minimalen Einrichtungskosten alles Notwendige hat, um die Kundenanforderungen zu erf√ºllen.  Zus√§tzlich zu ihr habe ich drei oder vier weitere Optionen ausprobiert. </p><br><h3 id="postanovka-zadachi">  Erkl√§rung des Problems </h3><br><p>  Webanwendung unter ASP.NET MVC, .NET Version 4.6.  Andere Funktionen sind in diesem Zusammenhang mit Ausnahme der Bereitstellung nicht relevant.  Die Bereitstellung wird voraussichtlich in Azure erfolgen.  Dies ist wichtig, da einige andere Bibliotheken (z. B. HiQPdf) in bestimmten Azure-Konfigurationen keine Installationen √ºbertragen. Dies ist dokumentiert. </p><br><p>  Ich muss einen bestimmten statischen HTML-Bericht mit einem Link und eine PDF-Version desselben Berichts mit dem zweiten Link √∂ffnen.  Der Bericht selbst besteht lediglich aus einigen Tabellen, Feldern und Grafiken, die dem Benutzer demonstriert werden sollen.  Beide Versionen erfordern ein Men√º mit Navigation durch Abschnitte des Berichts, das Vorhandensein von Tabellen und einige Grafiken (Farben, Textgr√∂√üe, Rahmen). </p><br><h3 id="primenenie-biblioteki-rotativa">  Verwenden der Rotativa-Bibliothek </h3><br><p>  Rotativa ist meiner Meinung nach so einfach wie m√∂glich anzuwenden. </p><br><ol><li>  Sie haben bereits einen vorgefertigten HTML-Bericht in Form einer ASP.NET MVC-Vorlage und eines Controllers, z. B.: </li></ol><br><pre><code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">HttpGet</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task&lt;ActionResult&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Index</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> param1, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> param2</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> model = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> service.GetReportDataAsync(param1, param2); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(model); }</code> </pre> <br><ol><li><p>  Installieren Sie das Nuget Rotativa-Paket </p><br></li><li><p>  Neuen Controller f√ºr PDF-Bericht hinzuf√ºgen </p><br></li></ol><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">HttpGet</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task&lt;ActionResult&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Pdf</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> param1, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> param2</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> model = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> service.GetReportDataAsync(param1, param2); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ViewAsPdf(<span class="hljs-string"><span class="hljs-string">"Index"</span></span>, model); }</code> </pre> <br><p>  Im Wesentlichen wird von nun an eine PDF-Datei als Datei zur√ºckgegeben, die alle Daten aus dem urspr√ºnglichen HTML-Bericht enth√§lt. </p><br><p>  <em>Ich habe das Routing hier nicht beschrieben, aber es versteht sich, dass Sie Routen so konfiguriert haben, dass beide Controller ordnungsgem√§√ü aufgerufen werden</em> </p><br><p>  Interessanterweise ist diese Bibliothek selbst im Wesentlichen ein Wrapper √ºber das bekannte Konsolendienstprogramm <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">wkhtmltopdf</a> .  Die Geschwindigkeit der Arbeit in der H√∂he, auf die Sie wetten k√∂nnen, wird funktionieren.  Es gibt jedoch Funktionen, √ºber die wir sprechen werden. </p><br><h3 id="page-number">  Seitenzahl </h3><br><p>  Es ist logisch anzunehmen, dass der Kunde das PDF druckt und die Seitenzahl sehen m√∂chte.  Dank der Macher von Rotativa ist hier alles sehr einfach. </p><br><p>  Gem√§√ü der Rotativa-Dokumentation k√∂nnen Sie √ºber den Parameter <code>CustomSwitches</code> die Argumente angeben, die an das Dienstprogramm <code>wkhtmltopdf</code> .  Nun, Online-Tipps sind gro√üz√ºgig mit Beispielen.  Der folgende Aufruf f√ºgt am Ende jeder Seite eine Nummer hinzu: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ViewAsPdf(<span class="hljs-string"><span class="hljs-string">"Index"</span></span>, model) { PageMargins = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Rotativa.Options.Margins(<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>), PageSize = Rotativa.Options.Size.A4, PageOrientation = Rotativa.Options.Orientation.Portrait, CustomSwitches = <span class="hljs-string"><span class="hljs-string">"--page-offset 0 --footer-center [page] --footer-font-size 8 };</span></span></code> </pre> <br><p>  Es funktioniert gro√üartig.  Die Seitenzahl selbst wird mit dem Parameter <code>[page]</code> . Diese Art von Parametern wird durch bestimmte Werte ersetzt. </p><br><blockquote>  Neben <code>[page]</code> gibt es noch andere: <br><ul><li>  [Seite] Ersetzt durch die Anzahl der aktuell gedruckten Seiten </li><li>  [frompage] Ersetzt durch die Nummer der ersten zu druckenden Seite </li><li>  [topage] Ersetzt durch die Nummer der zuletzt zu druckenden Seite </li><li>  [Webseite] Ersetzt durch die URL der zu druckenden Seite </li><li>  [Abschnitt] Ersetzt durch den Namen des aktuellen Abschnitts </li><li>  [Unterabschnitt] Ersetzt durch den Namen des aktuellen Unterabschnitts </li><li>  [Datum] Ersetzt durch das aktuelle Datum im lokalen Systemformat </li><li>  [isodate] Ersetzt durch das aktuelle Datum im erweiterten ISO 8601-Format </li><li>  [Zeit] Ersetzt durch die aktuelle Zeit im lokalen Systemformat </li><li>  [title] Ersetzt durch den Titel des aktuellen Seitenobjekts </li><li>  [doctitle] Ersetzt durch den Titel des Ausgabedokuments </li><li>  [sitepage] Ersetzt durch die Nummer der Seite auf der aktuellen Site, die konvertiert wird </li><li>  [sitepages] Ersetzt durch die Anzahl der Seiten auf der aktuellen Site, die konvertiert werden </li></ul><br></blockquote><br><h3 id="table-of-content">  Inhaltsverzeichnis </h3><br><p>  Gro√üe mehrseitige Berichte erfordern PDF-Inhalt und Seitennavigation.  Dies ist sehr praktisch und einfach wichtig, wenn die Anzahl der Seiten in einem Bericht einhundert √ºberschreitet. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Das wkhtmltopdf-Handbuch</a> enth√§lt eine vollst√§ndige Liste aller Optionen, darunter <code>--toc</code> .  Wenn dieser Parameter angezeigt wird, sammelt das Dienstprogramm im Wesentlichen alle Tags <code>&lt;h1&gt;, &lt;h2&gt;, ... &lt;h6&gt;</code> im Dokument und generiert darauf basierend ein Inhaltsverzeichnis.  Dementsprechend ist es erforderlich, die korrekte Verwendung dieser Header-Tags in Ihrer HTML-Vorlage sicherzustellen. </p><br><p>  In Wirklichkeit hat das Hinzuf√ºgen von <code>--toc</code> jedoch keine Konsequenzen.  Als ob es keinen Parameter g√§be.  Andere Optionen funktionieren jedoch.  Dank eines Beitrags in einem Forum habe ich festgestellt, dass dieser Parameter ohne Bindestriche √ºbergeben werden sollte: <code>toc</code> .  In diesem Fall wird der Inhalt als allererste Seite hinzugef√ºgt.  Wenn Sie auf eine Zeile im Inhalt klicken, gelangen Sie zur gew√ºnschten Seite im Dokument. Die Seitenzahlen sind korrekt. </p><br><p>  Es ist noch nicht ganz klar, wie die Stile eingerichtet werden sollen, aber ich habe es noch nicht getan. </p><br><h3 id="javascript-execution">  Javascript-Ausf√ºhrung </h3><br><p>  Der n√§chste Punkt, auf den ich stie√ü, war die Notwendigkeit, dem Bericht Diagramme hinzuzuf√ºgen.  Meine HTML-Seite enth√§lt JS-Code, der mithilfe der Bibliothek <code>dc.js</code> Grafiken <code>dc.js</code> .  Hier ist ein Beispiel: </p><br><pre> <code class="hljs matlab"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initChart</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">renderChart</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Html.Raw(Json.Encode(Model.Chart_1_Data)</span></span></span><span class="hljs-function">), '</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">chartDiv_1</span></span></span><span class="hljs-function">'); } </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">renderChart</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(data, chartElementId)</span></span></span><span class="hljs-function"> { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">var</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">colors</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">['#03a9f4', '#67daff', '#8bc34a']</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">var</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">barHeight</span></span></span><span class="hljs-function"> = 45; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">var</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">clientHeight</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">data</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">length</span></span></span><span class="hljs-function"> * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">barHeight</span></span></span><span class="hljs-function"> + 50; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">var</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">clientWidth</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">document</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getElementById</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(chartId)</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">offsetWidth</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">var</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">chart</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dc</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rowChart</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">('#' + chartElementId)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">var</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ndx</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">crossfilter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(dataToRender)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">var</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dimension</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ndx</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dimension</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(d =&gt; d.name)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">var</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">group</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dimension</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">group</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reduceSum</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(d =&gt; d.value)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">chart</span></span></span><span class="hljs-function"> .</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">width</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(clientWidth)</span></span></span><span class="hljs-function"> .</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">height</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(clientHeight)</span></span></span><span class="hljs-function"> .</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">margins</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">({ top: 16, right: 16, bottom: 16, left: 16 })</span></span></span><span class="hljs-function"> .</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ordinalColors</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(colors)</span></span></span><span class="hljs-function"> .</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dimension</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(dimension)</span></span></span><span class="hljs-function"> .</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">group</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(group)</span></span></span><span class="hljs-function"> .</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">xAxis</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> .</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">scale</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(d3.scaleLinear()</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">domain</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">([0, 2])</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">range</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">([1, 3])</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nice</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">); </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">chart</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">render</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">; }</span></span></code> </pre> <br><p>  Gleichzeitig habe ich in HTML ein entsprechendes Element: </p><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"chart_C2"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"dc-chart"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  Damit dieser Code funktioniert, m√ºssen Sie die entsprechenden Bibliotheken importieren: <code>dc.js</code> , <code>d3.js</code> , <code>crossfilter.js</code> .  Ein Aufruf der <code>initChart</code> Funktion erstellt ein Diagramm und f√ºgt das Ergebnis ein <br>  svg zum angegebenen Element im Baum. </p><br><p>  Das PDF enth√§lt jedoch keine Spur von Grafiken.  Sowie alle anderen Spuren der Ausf√ºhrung von JavaScript-Code vor dem PDF-Rendering.  Dies zu √ºberpr√ºfen ist ganz einfach - f√ºgen Sie einfach den Elementarcode hinzu, um ein einfaches <code>&lt;div&gt;</code> -Element mit Text zu erstellen, und testen Sie die Tatsache des JavaScript-Aufrufs. </p><br><p>  Empirisch stellte sich heraus, dass der Speicherort des JS-Codes f√ºr <code>wkhtmltopdf</code> eine wichtige Rolle spielt.  Der Code am Ende von <code>&lt;html&gt;</code> oder beispielsweise am Ende von <code>&lt;body&gt;</code> JS wird nicht ausgef√ºhrt.  Es scheint, dass der Versorger ihn einfach nicht bemerkt oder nicht erwartet, ihn dort zu treffen. </p><br><p>  Der Code im <code>&lt;head&gt;</code> wird jedoch ausgef√ºhrt.  So kam ich zu dem Schema, wenn sich JavaScript-Code nach der Deklaration von Stilen innerhalb des <code>&lt;head&gt;</code> befindet und mit der √ºblichen Konstruktion aufgerufen wird: </p><br><pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">onload</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"initCharts()"</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  In diesem Fall wird der Code wie erwartet ausgef√ºhrt. </p><br><h3 id="javascript-limitations">  JavaScript-Einschr√§nkungen </h3><br><p>  Das Ausgabe-PDF enthielt jedoch ohnehin keine Grafiken.  Dann begann ich zu vermuten, dass die PDF-Rendering- und Ausf√ºhrungs-Engine, da sie kein vollst√§ndiger Browser ist, h√∂chstwahrscheinlich nicht perfekt ist und die letzten Regeln nicht versteht.  Wiederum habe ich experimentell herausgefunden, dass Pfeilfunktionen nicht wahrgenommen werden.  Wenn der Dolmetscher etwas Unbekanntes f√ºr ihn findet, funktioniert es einfach nicht mehr. </p><br><p>  Ersetzen von <code>x =&gt; x.value</code> der Form <code>x =&gt; x.value</code> durch klassischere <code>function(x) { return x.value; }</code>  <code>function(x) { return x.value; }</code> geholfen und der gesamte Code wurde ausgef√ºhrt. Das resultierende Diagramm wurde in eine PDF-Datei √ºbertragen. </p><br><h3 id="chart-width">  Diagrammbreite </h3><br><p>  Empirisch stellte sich heraus, dass die Breite des √ºbergeordneten Elements des Diagramms klar angegeben werden musste.  Daf√ºr habe ich den <code>dc-chart</code> Stil angegeben.  Es enth√§lt die Breite des Diagramms in Pixel.  Andernfalls ist das Diagramm in der PDF-Datei sehr klein, obwohl es in der HTML-Version die gesamte Breite einnimmt.  Die Angabe der prozentualen Breite funktioniert nur f√ºr HTML. </p><br><h3 id="inline-javascript--css">  Inline-JavaScript / CSS </h3><br><p>  Abschlie√üend m√∂chte ich darauf hinweisen, dass viele Bibliotheken, die HTML in PDF konvertieren, eine bestimmte baseUrl als Parameter akzeptieren.  Dies ist die URL, auf deren Grundlage der Konverter die relativen Pfade f√ºr den Empfang importierter CSS-Stile, JavaScirpt-Dateien oder Schriftarten vervollst√§ndigt.  Ich kann nicht sicher sagen, wie das in Rotativa funktioniert, aber ich habe mir einen anderen Ansatz ausgedacht. </p><br><p>  Um das anf√§ngliche Laden des Berichts zu beschleunigen und die Ursache f√ºr die Probleme beim Einbetten von Skript- oder Stildateien w√§hrend der Konvertierung zu beseitigen, binde ich das erforderliche JS und CSS direkt in den Hauptteil der HTML-Vorlage ein. </p><br><p>  Erstellen Sie dazu die entsprechenden Bundles: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">BundleConfig</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RegisterBundles</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">BundleCollection bundles</span></span></span><span class="hljs-function">)</span></span> { bundles.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StyleBundle(<span class="hljs-string"><span class="hljs-string">"~/Styles/report-html"</span></span>) .Include(<span class="hljs-string"><span class="hljs-string">"~/Styles/report-common.css"</span></span>) .Include(<span class="hljs-string"><span class="hljs-string">"~/Styles/report-html.css"</span></span>) ); bundles.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StyleBundle(<span class="hljs-string"><span class="hljs-string">"~/Styles/report-pdf"</span></span>) .Include(<span class="hljs-string"><span class="hljs-string">"~/Styles/report-common.css"</span></span>) .Include(<span class="hljs-string"><span class="hljs-string">"~/Styles/report-pdf.css"</span></span>) ); bundles.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ScriptBundle(<span class="hljs-string"><span class="hljs-string">"~/Scripts/charts"</span></span>) .Include(<span class="hljs-string"><span class="hljs-string">"~/Scripts/d3/d3.js"</span></span>) .Include(<span class="hljs-string"><span class="hljs-string">"~/Scripts/crossfilter/crossfilter.js"</span></span>) .Include(<span class="hljs-string"><span class="hljs-string">"~/Scripts/dc/dc.js"</span></span>) ); } }</code> </pre> <br><p>  F√ºgen Sie <code>Global.asax.cs</code> einen Konfigurationsaufruf f√ºr diese Bundles <code>Global.asax.cs</code> </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Application_Start</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { ... BundleConfig.RegisterBundles(BundleTable.Bundles); }</code> </pre> <br><p>  F√ºgen Sie die entsprechende Methode hinzu, um den Code in die Seite einzubetten.  Es muss im selben Namespace wie <code>Global.asax.cs</code> werden, damit die Methode √ºber die HTML-Vorlage aufgerufen werden kann: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">HtmlHelperExtensions</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> IHtmlString </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InlineStyles</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params"> HtmlHelper htmlHelper, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> bundleVirtualPath</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> bundleContent = LoadBundleContent(htmlHelper.ViewContext.HttpContext, bundleVirtualPath); <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> htmlTag = <span class="hljs-string"><span class="hljs-string">$"&lt;style rel=\"stylesheet\" type=\"text/css\"&gt;</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{bundleContent}</span></span></span><span class="hljs-string">&lt;/style&gt;"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HtmlString(htmlTag); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> IHtmlString </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InlineScripts</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params"> HtmlHelper htmlHelper, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> bundleVirtualPath</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> bundleContent = LoadBundleContent(htmlHelper.ViewContext.HttpContext, bundleVirtualPath); <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> htmlTag = <span class="hljs-string"><span class="hljs-string">$"&lt;script type=\"text/javascript\"&gt;</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{bundleContent}</span></span></span><span class="hljs-string">&lt;/script&gt;"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HtmlString(htmlTag); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LoadBundleContent</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">HttpContextBase httpContext, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> bundleVirtualPath</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bundleContext = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BundleContext(httpContext, BundleTable.Bundles, bundleVirtualPath); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bundle = BundleTable.Bundles.Single(b =&gt; b.Path == bundleVirtualPath); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bundleResponse = bundle.GenerateBundleResponse(bundleContext); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bundleResponse.Content; } }</code> </pre> <br><p>  Nun, der letzte Schliff ist ein Aufruf aus der Vorlage: </p><br><pre> <code class="html hljs xml">@Html.InlineStyles("~/Styles/report-pdf"); @Html.InlineScripts("~/Scripts/charts");</code> </pre> <br><p>  Infolgedessen befinden sich alle erforderlichen CSS- und JavaScript-Dateien direkt in HTML, obwohl Sie w√§hrend der Entwicklung mit einzelnen Dateien arbeiten k√∂nnen. </p><br><p>  H√∂chstwahrscheinlich werden viele sofort √ºber die Ineffizienz dieses Ansatzes beim Zwischenspeichern von Anforderungen durch den Browser nachdenken.  Aber ich hatte zwei spezifische Ziele: </p><br><ul><li>  damit der PDF-Konverter nicht irgendwo nach Stilen oder Code fragen muss und der Benutzer darauf warten muss; </li><li>  Der erste Download von PDF- und HTML-Berichten dauert nur minimal, ohne auf einige zus√§tzliche Anfragen warten zu m√ºssen.  Im Kontext meines Projekts ist dies wichtig; </li></ul><br><h3 id="page-breaks">  Seitenumbr√ºche </h3><br><p>  Die Strukturierung des Berichts in Abschnitte kann mit Anforderungen verbunden sein, um einen neuen Abschnitt von einer neuen Seite aus zu beginnen.  In diesem Fall k√∂nnen Sie den einfachen CSS-Ansatz erfolgreich verwenden: </p><br><pre> <code class="css hljs"><span class="hljs-selector-class"><span class="hljs-selector-class">.page-break-before</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">page-break-before</span></span>: always; } <span class="hljs-selector-class"><span class="hljs-selector-class">.no-page-break-inside</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">page-break-before</span></span>: auto; <span class="hljs-attribute"><span class="hljs-attribute">page-break-inside</span></span>: avoid; }</code> </pre> <br><p>  Das Dienstprogramm wkhtmltopdf liest diese Klassen erfolgreich und versteht, dass eine neue Seite gestartet werden muss.  Die erste Klasse - <code>page-break-before</code> - weist das Dienstprogramm an, immer eine neue Seite mit diesem Element zu starten.  Die zweite Klasse - <code>no-page-break-inside</code> - sollte auf diejenigen Elemente angewendet werden, die auf der Seite so vollst√§ndig wie m√∂glich gehalten werden sollen.  Sie haben beispielsweise aufeinanderfolgende Bl√∂cke strukturierter Informationen oder sagen Tabellen.  Wenn zwei Bl√∂cke auf die Seite passen, werden sie gefunden.  Wenn der dritte nicht in die Seite passt, ist es nicht der n√§chste.  Wenn es gr√∂√üer als eine Seite ist, ist seine √úbertragung bereits unvermeidlich.  All dies funktioniert angemessen und bequem. </p><br><h3 id="flex-behavior-in-wkhtmltopdf">  Flex-Verhalten in wkhtmltopdf </h3><br><p>  Nun, die letzte Funktion, die mir aufgefallen ist, bezieht sich auf die Verwendung von Flexbox-Markup-Stilen.  Wir haben uns alle an sie gew√∂hnt und fast das gesamte Markup wird durch Flexes gemacht.  Wkhtmltopdf liegt in dieser Hinsicht jedoch etwas zur√ºck.  Horizontale Flex-Optionen funktionieren nicht (zumindest in meinem Fall hat dies nicht funktioniert. Ich habe im Netzwerk erw√§hnt, dass es sich lohnt, Flex-Stile wie folgt zu duplizieren: </p><br><pre> <code class="css hljs"><span class="hljs-selector-tag"><span class="hljs-selector-tag">display</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">-webkit-flex</span></span>; <span class="hljs-selector-tag"><span class="hljs-selector-tag">display</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">flex</span></span>; <span class="hljs-selector-tag"><span class="hljs-selector-tag">flex-direction</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">row</span></span>; <span class="hljs-selector-tag"><span class="hljs-selector-tag">-webkit-flex-direction</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">row</span></span>; <span class="hljs-selector-tag"><span class="hljs-selector-tag">-webkit-box-pack</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">justify</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* wkhtmltopdf uses this one */</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-webkit-justify-content</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">space-between</span></span>; <span class="hljs-selector-tag"><span class="hljs-selector-tag">justify-content</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">space-between</span></span>;</code> </pre> <br><p>  Dies f√ºhrte jedoch leider nicht zum erwarteten Markup im PDF.  Ich musste das Layout einiger Elemente wiederholen, damit die horizontale Platzierung der Bl√∂cke den Anforderungen entsprach.  Wenn jemand erfolgreiche Erfahrung mit der Integration von Flexes f√ºr wkhtmltopdf hat, teilen Sie diese bitte mit.  Das w√§re sehr hilfreich. </p><br><p>  Einige Links: </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">wkhtmltopdf</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">wkhtmltopdf Handbuch</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Rotativa Github</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Rotativa-Paket</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Inline-Stile</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de425511/">https://habr.com/ru/post/de425511/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de425499/index.html">HyperX Impact DDR4 - SO-DIMM, das k√∂nnte! Oder warum in einem Laptop 64 GB Speicher mit einer Frequenz von 3200 MHz?</a></li>
<li><a href="../de425501/index.html">A / B-Tests auf Android von A bis Z.</a></li>
<li><a href="../de425503/index.html">Cassandra Sink f√ºr Spark Structured Streaming</a></li>
<li><a href="../de425505/index.html">Analyse des Linux-Kernel-Boot-Prozesses</a></li>
<li><a href="../de425507/index.html">Parsim Wikipedia f√ºr NLP-Aufgaben in 4 Teams</a></li>
<li><a href="../de425515/index.html">Apple blockiert die unabh√§ngige Reparatur neuer MacBook-Modelle</a></li>
<li><a href="../de425517/index.html">Wie Yandex mithilfe von Radar und Satelliten eine globale Niederschlagsvorhersage erstellte</a></li>
<li><a href="../de425521/index.html">Gesch√ºtzte Methoden in JavaScript ES5</a></li>
<li><a href="../de425525/index.html">Tim Berners-Lee geht auf den Kriegspfad: "Ein kleiner Schritt f√ºr das Web ..."</a></li>
<li><a href="../de425527/index.html">Listen bei Kotlin. Haskell Ansatz</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>