<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèø‚Äçüé® üßïüèø üö¨ √âtendre et compl√©ter Kubernetes (revue et rapport vid√©o) üõãÔ∏è üôÖüèΩ üêÇ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Le 8 avril, lors de la conf√©rence Saint HighLoad ++ 2019 , dans le cadre de la section DevOps et op√©rations, un rapport a √©t√© r√©alis√© ¬´√âtendre et comp...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>√âtendre et compl√©ter Kubernetes (revue et rapport vid√©o)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/449096/"><img src="https://habrastorage.org/webt/kv/co/ra/kvcoraarvayusctrljjfqzvmukq.jpeg"><br><br>  Le 8 avril, lors de la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">conf√©rence Saint HighLoad ++ 2019</a> , dans le cadre de la section DevOps et op√©rations, un rapport a √©t√© r√©alis√© ¬´√âtendre et compl√©ter Kubernetes¬ª, cr√©√© par trois employ√©s de la soci√©t√© Flant.  Nous y parlons de nombreuses situations dans lesquelles nous voulions √©tendre et compl√©ter les capacit√©s de Kubernetes, mais pour lesquelles nous n'avons pas trouv√© de solution toute faite et simple.  Les solutions n√©cessaires sont apparues sous forme de projets Open Source, et cette pr√©sentation leur est √©galement d√©di√©e. <br><br>  Par tradition, nous sommes heureux de pr√©senter une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><b>vid√©o avec un rapport</b></a> (50 minutes, beaucoup plus informatif que l'article) et la principale compression sous forme de texte.  C'est parti! <a name="habracut"></a><br><br><h2>  K8s Kernel and Add-ons </h2><br>  Kubernetes transforme une approche industrielle et administrative √©tablie de longue date: <br><br><ul><li>  Gr√¢ce √† ses <b>abstractions</b> , nous ne fonctionnons plus avec des concepts tels que la configuration d'une config ou l'ex√©cution d'une commande (Chef, Ansible ...), mais utilisons le regroupement de conteneurs, de services, etc. </li><li>  On peut pr√©parer des candidatures sans penser aux nuances de la <b>plateforme sp√©cifique</b> sur laquelle elle sera lanc√©e: bare metal, le cloud de l'un des fournisseurs, etc. </li><li>  Avec les K8, les <b>meilleures pratiques</b> d'organisation des infrastructures sont devenues plus accessibles que jamais: √©volutivit√©, auto-r√©paration, tol√©rance aux pannes, etc. </li></ul><br>  Cependant, bien s√ªr, tout n'est pas si simple: avec Kubernetes sont venus leurs propres - nouveaux - d√©fis. <br><br>  Kubernetes n'est <b>pas</b> une moissonneuse-batteuse qui r√©sout tous les probl√®mes de tous les utilisateurs.  <b>Le noyau</b> Kubernetes est uniquement responsable de l'ensemble des fonctions minimales n√©cessaires pr√©sentes dans <b>chaque</b> cluster: <br><br><img src="https://habrastorage.org/webt/j4/bi/2r/j4bi2rovwoaeg30vtxmqvkf3gr0.png"><br><br>  Au c≈ìur de Kubernetes, un ensemble de base de primitives est d√©fini - pour regrouper les conteneurs, g√©rer le trafic, etc.  Nous en avons parl√© plus en d√©tail dans un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">rapport il y a 2 ans</a> . <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img src="https://habrastorage.org/webt/ri/3r/bh/ri3rbhiadlucbkmjxoi7evenkoc.png"></a> <br><br>  D'un autre c√¥t√©, les K8 offrent de grandes opportunit√©s pour √©tendre les fonctions disponibles, ce qui aide √† combler les besoins des autres utilisateurs sp√©cifiques.  Les administrateurs de cluster sont responsables des ajouts √† Kubernetes, qui doivent installer et configurer tout ce qui est n√©cessaire pour que leur cluster "prenne la forme n√©cessaire" [pour r√©soudre leurs probl√®mes sp√©cifiques].  De quel genre d'ajouts s'agit-il?  Regardons quelques exemples. <br><br><h2>  Exemples d'ajouts </h2><br>  Apr√®s avoir install√© Kubernetes, nous pouvons √™tre surpris que le r√©seau, si n√©cessaire pour l'interaction des pods √† la fois au sein du n≈ìud et entre les n≈ìuds, ne fonctionne pas seul.  Le noyau Kubernetes ne garantit pas les connexions n√©cessaires - √† la place, il d√©finit une <b>interface</b> r√©seau ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">CNI</a> ) pour les modules compl√©mentaires tiers.  Nous devons installer l'un de ces ajouts, qui sera responsable de la configuration du r√©seau. <br><br><img src="https://habrastorage.org/webt/y1/dz/kh/y1dzkhba60lopgq_nokdcisaols.png"><br><br>  Un exemple proche est les solutions de stockage de donn√©es (disque local, p√©riph√©rique de bloc r√©seau, Ceph ...).  Initialement, ils √©taient dans le noyau, mais avec l'av√®nement de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">CSI, la</a> situation passe √† une situation similaire d√©j√† d√©crite: dans Kubernetes, l'interface et son impl√©mentation, dans des modules tiers. <br><br>  Entre autres exemples: <br><br><ul><li>  Contr√¥leurs d' <b>entr√©e</b> <i>(pour un examen, consultez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">notre r√©cent article</a> )</i> . </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><b>cert-manager</b></a> : <br><br><img src="https://habrastorage.org/webt/jd/be/oc/jdbeocyiociiucegto-own0o6g0.gif"></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><b>Les op√©rateurs</b></a> sont toute une classe d'add-ons (qui incluent le gestionnaire de certificats mentionn√©), ils d√©finissent les primitives et les contr√¥leurs.  La logique de leur travail n'est limit√©e que par notre imagination et nous permet de transformer des composants d'infrastructure pr√™ts √† l'emploi (par exemple, SGBD) en primitives, qui sont beaucoup plus faciles √† travailler (qu'avec un ensemble de conteneurs et leurs param√®tres).  Un grand nombre d'op√©rateurs ont √©t√© √©crits - m√™me si beaucoup d'entre eux ne sont pas encore pr√™ts pour la production, ce n'est qu'une question de temps: <br><br><img src="https://habrastorage.org/webt/uu/yp/gi/uuypgi9fy-7ot0uho2vh27uq7nq.png"></li><li>  <b>Les m√©triques</b> sont une autre illustration de la fa√ßon dont Kubernetes a s√©par√© l'interface (API de m√©triques) de son impl√©mentation (modules compl√©mentaires tiers tels que l'adaptateur Prometheus, l'agent de cluster Datadog ...). </li><li>  Pour la <b>surveillance et les statistiques</b> , o√π en pratique non seulement <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Prom√©th√©e et Grafana sont n√©cessaires</a> , mais aussi les m√©triques d'√©tat du kube, l'exportateur de n≈ìuds, etc. </li></ul><br>  Et ce n'est pas une liste compl√®te d'add-ons ... Par exemple, chez Flant, nous installons aujourd'hui <b>29 add-ons</b> pour chaque cluster Kubernetes (tous cr√©ent au total 249 objets Kubernetes).  Autrement dit, nous ne voyons pas la vie d'un cluster sans ajouts. <br><br><h2>  Automatisation </h2><br>  Les op√©rateurs sont con√ßus pour automatiser les op√©rations de routine auxquelles nous sommes confront√©s quotidiennement.  Voici des exemples de vie qui seraient parfaits pour √©crire un op√©rateur: <br><br><ol><li>  Il existe un registre priv√© (c'est-√†-dire n√©cessitant une connexion) avec des images pour l'application.  Il est suppos√© que chaque pod est li√© √† un secret sp√©cial qui permet l'authentification dans le registre.  Notre t√¢che est de nous assurer que ce secret se trouve dans l'espace de noms, afin que les pods puissent t√©l√©charger des images.  Il peut y avoir beaucoup d'applications (dont chacune a besoin d'un secret), et il est utile de mettre √† jour r√©guli√®rement les secrets eux-m√™mes, de sorte que l'option de d√©couvrir les secrets avec vos mains disparaisse.  Ici, l'op√©rateur vient √† la rescousse: nous cr√©ons un contr√¥leur qui attend que l'espace de noms apparaisse et ajoute un secret √† l'espace de noms pour cet √©v√©nement. </li><li>  Supposons que par d√©faut, l'acc√®s des pods √† Internet soit interdit.  Mais parfois, cela peut √™tre n√©cessaire: il est logique que le m√©canisme d'autorisation d'acc√®s fonctionne simplement sans n√©cessiter de comp√©tences sp√©cifiques, par exemple, par la pr√©sence d'une certaine √©tiquette dans l'espace de noms.  Comment l'op√©rateur nous aidera-t-il ici?  Un contr√¥leur est cr√©√© qui s'attend √† ce que l'√©tiquette apparaisse dans l'espace de noms et ajoute la strat√©gie appropri√©e pour acc√©der √† Internet. </li><li>  Une situation similaire: nous devons ajouter une certaine <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">tache</a> au n≈ìud s'il a une √©tiquette similaire (avec une sorte de pr√©fixe).  Les actions avec l'op√©rateur sont √©videntes ... </li></ol><br>  Dans tout cluster, il est n√©cessaire de r√©soudre les t√¢ches de routine, et <b>correctement</b> de le faire - en utilisant des op√©rateurs. <br><br>  En r√©sumant toutes les histoires d√©crites, nous sommes arriv√©s √† la conclusion que <b>pour un travail confortable dans Kubernetes, il est n√©cessaire</b> : a) d' <b>installer des modules compl√©mentaires</b> , b) de <b>d√©velopper des op√©rateurs</b> (pour r√©soudre les t√¢ches d'administration quotidiennes). <br><br><h2>  Comment √©crire une d√©claration pour Kubernetes? </h2><br>  En g√©n√©ral, le sch√©ma est simple: <br><br><img src="https://habrastorage.org/webt/qt/jo/7u/qtjo7ujblxe_kbzr05hw0ixow1y.png"><br><br>  ... mais il s'av√®re que: <br><br><ul><li>  L'API Kubernetes est une chose plut√¥t simple qui n√©cessite beaucoup de temps √† ma√Ætriser; </li><li>  la programmation n'est pas non plus pour tout le monde (Go est choisi comme langue pr√©f√©r√©e car il existe un cadre sp√©cial pour cela - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Operator SDK</a> ); </li><li>  avec le cadre en tant que tel, une situation similaire. </li></ul><br>  Conclusion: <b>pour √©crire un contr√¥leur</b> (op√©rateur), vous devez <b>d√©penser des ressources importantes</b> pour √©tudier le mat√©riel.  Cela serait justifi√© pour les "gros" op√©rateurs - disons, pour le SGBD MySQL.  Mais si nous rappelons les exemples d√©crits ci-dessus (r√©v√©lation de secrets, acc√®s des pods √† Internet ...), que nous voulons √©galement faire correctement, alors nous comprendrons que les efforts d√©pens√©s l'emporteront sur le r√©sultat d√©sormais recherch√©: <br><br><img src="https://habrastorage.org/webt/zn/w3/9b/znw39bssazgqnsoe9mrsh8e7o6o.png"><br><br>  En g√©n√©ral, un dilemme se pose: d√©penser beaucoup de ressources et trouver le bon outil pour r√©diger des d√©clarations ou agir "√† l'ancienne" (mais rapidement).  Pour le r√©soudre - pour trouver un compromis entre ces extr√™mes - nous avons cr√©√© notre propre projet: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><b>shell-operator</b></a> <i>(voir aussi sa <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">r√©cente annonce</a> sur le hub)</i> . <br><br><h2>  Op√©rateur Shell </h2><br>  Comment fonctionne-t-il?  Dans le cluster, il y a un pod dans lequel se trouve le Go-binary avec shell-operator.  Un ensemble de <b>crochets</b> est stock√© √† c√¥t√© <i>(pour plus de d√©tails √† leur sujet, voir ci-dessous)</i> .  L'op√©rateur shell lui-m√™me souscrit √† certains <b>√©v√©nements</b> dans l'API Kubernetes, sur lesquels il lance les hooks correspondants. <br><br>  Comment l'op√©rateur shell comprend-il les hooks √† d√©clencher sous quels √©v√©nements?  Ces informations sont transmises √† l'op√©rateur shell par les hooks eux-m√™mes et ils le rendent tr√®s simple. <br><br>  Un hook est un script Bash ou tout autre fichier ex√©cutable qui prend en charge un seul argument <code>--config</code> et renvoie JSON en r√©ponse.  Ce dernier d√©termine quels objets l'int√©ressent et quels √©v√©nements (pour ces objets) doivent √™tre r√©agis: <br><br><img src="https://habrastorage.org/webt/6m/7f/ei/6m7feilxyvybractmb6aoxj-olm.png"><br><br>  J'illustrerai la mise en ≈ìuvre par un op√©rateur shell de l'un de nos exemples - r√©v√©lant des secrets pour acc√©der √† un registre priv√© avec des images d'application.  Il se compose de deux √©tapes. <br><br><h3>  Pratique: 1. √âcrire un crochet </h3><br>  La premi√®re √©tape du hook consiste √† traiter <code>--config</code> , indiquant que nous nous int√©ressons aux espaces de noms, et plus pr√©cis√©ment au moment de leur cr√©ation: <br><br><pre> <code class="bash hljs">[[ <span class="hljs-variable"><span class="hljs-variable">$1</span></span> == <span class="hljs-string"><span class="hljs-string">"--config"</span></span> ]] ; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> cat &lt;&lt; EOF { <span class="hljs-string"><span class="hljs-string">"onKubernetesEvent"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"kind"</span></span>: <span class="hljs-string"><span class="hljs-string">"namespace"</span></span>, <span class="hljs-string"><span class="hljs-string">"event"</span></span>: [<span class="hljs-string"><span class="hljs-string">"add"</span></span>] } ] } EOF ‚Ä¶</code> </pre> <br>  √Ä quoi ressemblera la logique?  Assez simple aussi: <br><br><pre> <code class="bash hljs">‚Ä¶ <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> createdNamespace=$(jq -r <span class="hljs-string"><span class="hljs-string">'.[0].resourceName'</span></span> <span class="hljs-variable"><span class="hljs-variable">$BINDING_CONTEXT_PATH</span></span>) kubectl create -n <span class="hljs-variable"><span class="hljs-variable">${createdNamespace}</span></span> -f - &lt;&lt; EOF Kind: Secret ... EOF <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span></code> </pre> <br>  La premi√®re √©tape consiste √† d√©couvrir quel espace de noms a √©t√© cr√©√© et la deuxi√®me √©tape consiste √† cr√©er un secret pour cet espace de noms via <code>kubectl</code> . <br><br><h3>  Pratique: 2. Assembler une image </h3><br>  Il reste √† transf√©rer le crochet cr√©√© √† l'op√©rateur shell - comment faire?  L'op√©rateur shell lui-m√™me est fourni en tant qu'image Docker, notre t√¢che consiste donc √† ajouter un hook √† un r√©pertoire sp√©cial dans cette image: <br><br><pre> <code class="plaintext hljs">FROM flant/shell-operator:v1.0.0-beta.1 ADD my-handler.sh /hooks</code> </pre> <br>  Il reste √† le ramasser et √† le push'nut: <br><br><pre> <code class="bash hljs">$ docker build -t registry.example.com/my-operator:v1 . $ docker push registry.example.com/my-operator:v1</code> </pre> <br>  La touche finale consiste √† int√©grer l'image dans un cluster.  Pour ce faire, √©crivez <i>D√©ploiement</i> : <br><br><pre> <code class="plaintext hljs">apiVersion: extensions/v1beta1 kind: Deployment metadata: name: my-operator spec: template: spec: containers: - name: my-operator image: registry.example.com/my-operator:v1 # 1 serviceAccountName: my-operator # 2</code> </pre> <br>  Dans ce document, vous devez faire attention √† deux points: <br><br><ol><li>  Indication de l'image nouvellement cr√©√©e; </li><li>  il s'agit d'un composant syst√®me qui (au minimum) a besoin de droits pour s'abonner aux √©v√©nements dans Kubernetes et pour r√©v√©ler des secrets par espace de noms, nous cr√©ons donc un ServiceAccount (et un ensemble de r√®gles) pour le hook. </li></ol><br>  Le r√©sultat - nous avons r√©solu notre probl√®me d'une mani√®re <b>native</b> de Kubernetes, cr√©ant un op√©rateur pour r√©v√©ler des secrets. <br><br><h3>  Autres fonctionnalit√©s de shell-operator </h3><br>  Pour limiter les objets du type de votre choix avec lesquels le crochet fonctionnera, <b>vous pouvez les filtrer en les filtrant</b> par des √©tiquettes sp√©cifiques (ou en utilisant <code>matchExpressions</code> ): <br><br><pre> <code class="plaintext hljs">"onKubernetesEvent": [ { "selector": { "matchLabels": { "foo": "bar", }, "matchExpressions": [ { "key": "allow", "operation": "In", "values": ["wan", "warehouse"], }, ], } ‚Ä¶ } ]</code> </pre> <br>  Un <b>m√©canisme de d√©duplication est</b> fourni, qui - √† l'aide d'un filtre jq - vous permet de convertir de gros JSON d'objets en petits, o√π seuls les param√®tres que nous voulons surveiller sont modifi√©s. <br><br>  Lorsque le hook est appel√©, l'op√©rateur shell lui transmet des <b>donn√©es sur l'objet</b> , qui peuvent √™tre utilis√©es pour tous les besoins. <br><br>  Les √©v√©nements sur lesquels des hooks sont d√©clench√©s ne sont pas limit√©s aux √©v√©nements Kubernetes: l'op√©rateur shell fournit un support pour <b>appeler des hooks √† temps</b> (similaire √† crontab dans le planificateur traditionnel), ainsi qu'un √©v√©nement <b>onStartup</b> sp√©cial.  Tous ces √©v√©nements peuvent √™tre combin√©s et affect√©s au m√™me hook. <br><br>  Et deux autres fonctionnalit√©s de shell-operator: <br><br><ol><li>  Cela fonctionne de <b>mani√®re asynchrone</b> .  Depuis l'√©v√©nement Kubernetes (par exemple, la cr√©ation d'un objet), d'autres √©v√©nements (par exemple, la suppression du m√™me objet) peuvent se produire dans le cluster, et cela doit √™tre pris en compte dans les hooks.  Si le hook a √©chou√©, par d√©faut, il sera <b>rappel√©</b> jusqu'√† la fin (ce comportement peut √™tre modifi√©). </li><li>  Il exporte des <b>m√©triques</b> pour Prometheus, avec lesquelles vous pouvez comprendre si l'op√©rateur shell fonctionne, conna√Ætre le nombre d'erreurs pour chaque hook et la taille de la file d'attente actuelle. </li></ol><br>  Pour r√©sumer cette partie du rapport: <br><br><img src="https://habrastorage.org/webt/v2/aa/zo/v2aazotslqg8mvbgb4wbkrwz1do.png"><br><br><h2>  Installation de modules compl√©mentaires </h2><br>  Pour un travail confortable avec Kubernetes, la n√©cessit√© d'installer des modules compl√©mentaires a √©galement √©t√© mentionn√©e.  Je vais en parler sur l'exemple de la fa√ßon dont notre entreprise est de savoir comment nous le faisons maintenant. <br><br>  Nous avons commenc√© √† travailler avec Kubernetes avec plusieurs clusters, dont le seul ajout √©tait Ingress.  Il fallait le placer diff√©remment dans chaque cluster, et nous avons r√©alis√© plusieurs configurations YAML pour diff√©rents environnements: bare metal, AWS ... <br><br>  Il y avait plus de clusters - plus de configurations.  De plus, nous avons am√©lior√© ces configurations elles-m√™mes, ce qui les a rendues assez h√©t√©rog√®nes: <br><br><img src="https://habrastorage.org/webt/sx/bb/3n/sxbb3ndabtfctyjimx7lzwvg-sk.png"><br><br>  Pour mettre tout en ordre, nous avons commenc√© avec un script ( <code>install-ingress.sh</code> ), qui a pris comme argument le type de cluster √† d√©ployer, a g√©n√©r√© la configuration YAML souhait√©e et l'a d√©ploy√©e sur Kubernetes. <br><br>  En bref, notre nouvelle voie et les arguments qui y sont li√©s √©taient les suivants: <br><br><ul><li>  pour travailler avec des configurations YAML, un moteur de template est requis (dans les premiers temps c'est un sed simple); </li><li>  avec l'augmentation du nombre de clusters, le besoin est venu de mises √† jour automatiques (la premi√®re solution est de mettre un script dans Git, de le mettre √† jour par cron et de l'ex√©cuter); </li><li>  un script similaire √©tait requis pour Prometheus ( <code>install-prometheus.sh</code> ), mais il est remarquable en ce qu'il n√©cessite beaucoup plus de donn√©es d'entr√©e, ainsi que leur stockage (dans le bon sens, centralis√© et dans le cluster), et certaines donn√©es (mots de passe) pourraient √™tre g√©n√©r√©es automatiquement : <br><br><img src="https://habrastorage.org/webt/u9/3s/oe/u93soes0m24zohi4oy0ugk2uvcg.png"></li><li>  le risque de rouler quelque chose de mal dans un nombre croissant de clusters augmentait constamment, nous avons donc r√©alis√© que les installateurs <i>(c'est-√†-dire deux scripts: pour Ingress et Prometheus)</i> avaient besoin d'une configuration de sc√®ne (plusieurs branches dans Git, plusieurs cron pour les mettre √† jour dans les correspondantes: clusters stables ou de test); </li><li>  il est devenu difficile de travailler avec <code>kubectl apply</code> , car il n'est pas d√©claratif et ne peut que cr√©er des objets, mais pas prendre des d√©cisions sur leur statut / les supprimer; </li><li>  manquait de fonctions que nous ne r√©alisions pas √† l'√©poque: <br><ul><li>  un contr√¥le total sur le r√©sultat des mises √† jour du cluster, </li><li>  d√©termination automatique de certains param√®tres (saisie pour les scripts d'installation) √† partir des donn√©es pouvant √™tre obtenues √† partir du cluster (d√©couverte), </li><li>  son d√©veloppement logique sous forme de d√©couverte continue. </li></ul></li></ul><br>  Nous avons r√©alis√© toute cette exp√©rience accumul√©e dans le cadre de notre autre projet - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><b>addon-operator</b></a> . <br><br><h2>  Addon-operator </h2><br>  Il est bas√© sur l'op√©rateur shell d√©j√† mentionn√©.  L'ensemble du syst√®me est le suivant: <br><br>  Aux crochets de l'op√©rateur shell sont ajout√©s: <br><br><ul><li>  <b>stockage des valeurs</b> </li><li>  <b>Tableau de barre</b> </li><li>  le composant qui <b>surveille le r√©f√©rentiel de valeurs</b> et - en cas de changement - demande √† Helm de relancer le graphique. </li></ul><br><img src="https://habrastorage.org/webt/w8/8f/kf/w88fkfrbrukitlgx_u5jzauwtzq.gif"><br><br>  Ainsi, nous pouvons r√©pondre √† un √©v√©nement dans Kubernetes, lancer un hook et, √† partir de ce hook, apporter des modifications au r√©f√©rentiel, apr√®s quoi le graphique sera re-pomp√©.  Dans le sch√©ma r√©sultant, nous s√©lectionnons un ensemble de crochets et un graphique en un seul composant, que nous appelons un <b>module</b> : <br><br><img src="https://habrastorage.org/webt/b9/3j/qj/b93jqjumemaiju4cwcji2qnmaqw.png"><br><br>  Il peut y avoir de nombreux modules et nous y ajoutons des hooks globaux, un stockage de valeurs globales et un composant qui surveille ce stockage global. <br><br>  Maintenant que quelque chose se passe dans Kubernetes, nous pouvons y r√©pondre avec un hook global et changer quelque chose dans le r√©f√©rentiel global.  Cette modification sera remarqu√©e et entra√Ænera la restauration de tous les modules du cluster: <br><br><img src="https://habrastorage.org/webt/ad/hh/e-/adhhe-ml3wrrqjks5dniduqxecg.gif"><br><br>  Ce sch√©ma r√©pond √† toutes les exigences d'installation des modules compl√©mentaires annonc√©es ci-dessus: <br><br><ul><li>  Helm est responsable de la normalisation et de la d√©clarativit√©. </li><li>  Le probl√®me de mise √† jour automatique a √©t√© r√©solu √† l'aide d'un hook global, qui va au registre selon un calendrier et, s'il y voit une nouvelle image du syst√®me, le relance (c'est-√†-dire ¬´lui-m√™me¬ª). </li><li>  Le stockage des param√®tres dans le cluster est impl√©ment√© √† l'aide de <i>ConfigMap</i> , dans lequel les donn√©es primaires des stockages sont enregistr√©es (au d√©marrage, elles sont charg√©es dans les stockages). </li><li>  Les probl√®mes de g√©n√©ration de mot de passe, de d√©couverte et de d√©couverte continue sont r√©solus √† l'aide de crochets. </li><li>  La mise en sc√®ne est r√©alis√©e gr√¢ce aux balises prises en charge par Docker. </li><li>  Le r√©sultat est contr√¥l√© √† l'aide de mesures permettant de comprendre l'√©tat. </li></ul><br>  L'ensemble de ce syst√®me est impl√©ment√© comme un seul binaire on Go, qui a √©t√© appel√© addon-operator.  Gr√¢ce √† cela, le sch√©ma semble plus simple: <br><br><img src="https://habrastorage.org/webt/ip/2n/cf/ip2ncf-unok3h5azr8-icyby3hs.png"><br><br>  Le composant principal de ce diagramme est un ensemble de modules <i>(gris√© ci-dessous)</i> .  Maintenant, nous pouvons √©crire un module avec un petit effort pour le module compl√©mentaire souhait√© et √™tre s√ªr qu'il sera install√© dans chaque cluster, sera mis √† jour et r√©pondra aux √©v√©nements dont il a besoin dans le cluster. <br><br>  Flant utilise l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">op√©rateur d'addon</a> sur plus de 70 clusters Kubernetes.  Le statut actuel est <b>la version alpha</b> .  Nous pr√©parons maintenant la documentation pour la sortie de la b√™ta, mais pour l'instant <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">, des exemples sont disponibles</a> dans le r√©f√©rentiel, sur la base desquels vous pouvez cr√©er votre addon. <br><br>  O√π obtenir les modules d'op√©rateur d'addon eux-m√™mes?  La publication de notre biblioth√®que est la prochaine √©tape pour nous, nous pr√©voyons de le faire en √©t√©. <br><br><h2>  Vid√©os et diapositives </h2><br>  Vid√©o de la performance (~ 50 minutes): <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/6VHk1R1TNgk" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  Pr√©sentation du rapport: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/https://translate" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br><h2>  PS </h2><br>  Autres reportages sur notre blog: <br><br><ul><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Bases de donn√©es et Kubernetes</a> ";  <i>(Dmitry Stolyarov; 8 novembre 2018 √† HighLoad ++)</i> ; </li><li>  ¬´ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Surveillance et Kubernetes</a> ¬ª;  <i>(Dmitry Stolyarov; 28 mai 2018 √† RootConf)</i> ; </li><li>  ¬´ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Meilleures pratiques CI / CD avec Kubernetes et GitLab</a> ¬ª;  <i>(Dmitry Stolyarov; 7 novembre 2017 √† HighLoad ++)</i> ; </li><li>  ¬´ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Notre exp√©rience avec Kubernetes dans les petits projets</a> ¬ª;  <i>(Dmitry Stolyarov; 6 juin 2017 √† RootConf)</i> . </li></ul><br>  Vous pourriez √©galement √™tre int√©ress√© par les publications suivantes: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Est-il facile et pratique de pr√©parer un cluster Kubernetes?</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Annoncer addon-operator</a> ¬ª; </li><li>  ¬´ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Pr√©sentation de l'op√©rateur shell: faciliter encore plus les op√©rateurs pour Kubernetes</a> .¬ª </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr449096/">https://habr.com/ru/post/fr449096/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr449086/index.html">√Ä l'int√©rieur de la flamme: une nouvelle m√©thode pour √©tudier les syst√®mes r√©actifs √† haute temp√©rature</a></li>
<li><a href="../fr449088/index.html">Il est temps que les investisseurs et les entrepreneurs commencent √† r√©soudre le probl√®me de la sant√© mentale dans les startups.</a></li>
<li><a href="../fr449090/index.html">Modifier dynamiquement le sch√©ma JSON dans Go with gob</a></li>
<li><a href="../fr449092/index.html">Trois paradigme de programmation asynchrone dans Vertx</a></li>
<li><a href="../fr449094/index.html">Psychologie de d√©marrage: des transformations que tout le monde ne vivra pas</a></li>
<li><a href="../fr449098/index.html">Comment une entreprise de logiciels espions est entr√©e dans le magasin de certificats de Mozilla et ce qui en est sorti</a></li>
<li><a href="../fr449100/index.html">Dans le sillage de RTM. Enqu√™te m√©dico-l√©gale sur un ordinateur infect√© par un cheval de Troie bancaire</a></li>
<li><a href="../fr449106/index.html">UPS pour les institutions bancaires et financi√®res</a></li>
<li><a href="../fr449108/index.html">UDB. Qu'est-ce que c'est? Partie 7. Module de commande de temporisation et de r√©initialisation</a></li>
<li><a href="../fr449110/index.html">Correction d'un bug li√© √† l'impossibilit√© d'utiliser l'alphabet cyrillique dans les noms des dossiers IMAP</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>