<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©‚Äçüíº üíáüèø üôáüèø Os autores do jogo 0 AD - bem feito üïõ üëãüèª üíÆ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="0 AD √© um jogo tridimensional do g√™nero de estrat√©gia hist√≥rica em tempo real, desenvolvido pela comunidade de volunt√°rios. O tamanho da base de c√≥dig...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Os autores do jogo 0 AD - bem feito</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pvs-studio/blog/420267/"><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6c5/b41/bfb/6c5b41bfb68b23ef10d61f6ecd1a6665.png" alt="PVS-Studio e 0 A.D."></div><br>  0 AD √© um jogo tridimensional do g√™nero de estrat√©gia hist√≥rica em tempo real, desenvolvido pela comunidade de volunt√°rios.  O tamanho da base de c√≥digo √© pequeno e eu decidi verificar o jogo como uma pausa de grandes projetos como Android e XNU Kernel.  Portanto, diante de n√≥s, h√° um projeto que cont√©m 165.000 linhas de c√≥digo em C ++.  Vamos ver o que √© interessante, que pode ser encontrado usando o analisador est√°tico PVS-Studio. <br><a name="habracut"></a><br><h2>  0 AD </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">0 AD</a> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">0 AD</a> ) √© um jogo tridimensional gratuito no g√™nero de estrat√©gia hist√≥rica em tempo real, desenvolvido por uma comunidade de volunt√°rios (os principais desenvolvedores est√£o unidos na equipe dos Jogos Wildfire).  O jogo permite controlar civiliza√ß√µes que existiam no per√≠odo de 500 aC.  e. - 1 ano aC.  e  A partir do ver√£o de 2018, o projeto est√° na vers√£o alfa.  [ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Descri√ß√£o</a> retirada da Wikipedia]. <br><br>  Por que exatamente 0 AD? <br><br>  Pedi a um colega de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Egor Bredikhin</a> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">EgorBredikhin</a> ) que escolhesse e verificasse para mim algum pequeno projeto aberto com o qual eu pudesse trabalhar entre outras tarefas.  Ele me enviou um log para o projeto do AD 0. √Ä pergunta: "Por que esse projeto?"  - houve uma resposta: "Sim, acabei de jogar este jogo, uma boa estrat√©gia em tempo real".  Ok, ent√£o ser√° 0 AD :). <br><br><h2>  Densidade de erro </h2><br>  Quero elogiar os autores do 0 AD pela boa qualidade do c√≥digo C ++.  Bem feito, voc√™ raramente consegue encontrar uma densidade t√£o baixa de erros.  Obviamente, esses nem todos s√£o erros, mas aqueles que podem ser detectados usando o PVS-Studio.  Como eu disse, embora o PVS-Studio n√£o encontre todos os erros, no entanto, podemos falar com seguran√ßa sobre a rela√ß√£o entre a densidade dos erros e a qualidade do c√≥digo como um todo. <br><br>  Alguns n√∫meros.  O n√∫mero total de linhas de c√≥digo n√£o vazias √© 231270. Desses, 28,7% s√£o coment√°rios.  No total, 165.000 linhas de c√≥digo C ++ puro. <br><br>  O n√∫mero de mensagens emitidas pelo analisador era pequeno e, tendo analisado todas elas, escrevi 19 erros.  Vou considerar todos esses erros posteriormente neste artigo.  Talvez eu tenha perdido alguma coisa, considerando o erro um c√≥digo desleixado e inofensivo.  No entanto, em geral, isso n√£o muda a imagem. <br><br>  Ent√£o, encontrei 19 erros em 165.000 linhas de c√≥digo.  Calculamos a densidade do erro: 19 * 1000/165000 = 0,111. <br><br>  Por uma quest√£o de simplicidade, conclu√≠mos e assumimos que o analisador PVS-Studio detecta 0,1 erros por 1000 linhas de c√≥digo no c√≥digo do jogo. <br><br>  √ìtimo resultado!  Para compara√ß√£o, em meu recente <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">artigo sobre Android,</a> calculei que havia detectado pelo menos 0,25 erros por 1.000 linhas de c√≥digo.  De fato, a densidade de erros √© ainda maior, s√≥ n√£o encontrei for√ßas para analisar todo o relat√≥rio com cuidado. <br><br>  Ou use as Bibliotecas principais do EFL como exemplo, que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">estudei</a> cuidadosamente e calculei o n√∫mero de defeitos.  Nele, o PVS-Studio detecta 0,71 erros por 1000 linhas de c√≥digo. <br><br>  Portanto, os autores de 0 AD s√£o bons companheiros, no entanto, por uma quest√£o de justi√ßa, deve-se notar que uma pequena quantidade de c√≥digo escrito em C ++ os ajuda.  Infelizmente, quanto maior o projeto, mais r√°pida sua complexidade aumenta e a densidade de erros aumenta de maneira n√£o linear ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">mais</a> ). <br><br><h2>  Erros </h2><br>  Vejamos agora os 19 erros que encontrei no jogo.  Para analisar o projeto, usei o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">PVS-Studio</a> vers√£o 6.24.  Eu sugiro que voc√™ tente baixar a vers√£o demo e verificar os projetos em que est√° trabalhando. <br><br>  <b>Nota</b>  Posicionamos o PVS-Studio como uma solu√ß√£o B2B.  Para pequenos projetos e desenvolvedores individuais, temos uma op√ß√£o de licen√ßa gratuita: " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Como usar o PVS-Studio gratuitamente</a> ". <br><br>  <b>Erro N1</b> <br><br>  Vamos come√ßar analisando um erro complexo.  Na verdade, n√£o √© complicado, mas voc√™ ter√° que se familiarizar com um peda√ßo de c√≥digo bastante grande. <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> WaterManager::CreateWaveMeshes() { .... <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> nbNeighb = <span class="hljs-number"><span class="hljs-number">0</span></span>; .... <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> found = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; nbNeighb = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> p = <span class="hljs-number"><span class="hljs-number">0</span></span>; p &lt; <span class="hljs-number"><span class="hljs-number">8</span></span>; ++p) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (CoastalPointsSet.count(xx+around[p][<span class="hljs-number"><span class="hljs-number">0</span></span>] + (yy + around[p][<span class="hljs-number"><span class="hljs-number">1</span></span>])*SideSize)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (nbNeighb &gt;= <span class="hljs-number"><span class="hljs-number">2</span></span>) { CoastalPointsSet.erase(xx + yy*SideSize); <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } ++nbNeighb; <span class="hljs-comment"><span class="hljs-comment">// We've found a new point around us. // Move there xx = xx + around[p][0]; yy = yy + around[p][1]; indexx = xx + yy*SideSize; if (i == 0) Chain.push_back(CoastalPoint(indexx,CVector2D(xx*2,yy*2))); else Chain.push_front(CoastalPoint(indexx,CVector2D(xx*2,yy*2))); CoastalPointsSet.erase(xx + yy*SideSize); found = true; break; } } if (!found) endedChain = true; .... }</span></span></code> </pre> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Aviso do</a> PVS-Studio: A express√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">V547</a> CWE-570 'nbNeighb&gt; = 2' √© sempre falsa.  WaterManager.cpp 581 <br><br>  √Ä primeira vista, a mensagem do analisador parece estranha.  Por que a condi√ß√£o <i>nbNeighb&gt; = 2</i> sempre √© falsa?  De fato, no corpo do loop, h√° um incremento da vari√°vel <i>nbNeighb</i> ! <br><br>  Veja abaixo e voc√™ ver√° uma declara√ß√£o de interrup√ß√£o que interrompe a execu√ß√£o do loop.  Portanto, se a vari√°vel <i>nbNeighb</i> for aumentada, o ciclo ser√° interrompido.  Portanto, o valor da vari√°vel <i>nbNeighb</i> nunca alcan√ßar√° um valor maior que 1. <br><br>  O c√≥digo cont√©m claramente algum tipo de erro l√≥gico. <br><br>  <b>Erro N2</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> CmpRallyPointRenderer::MergeVisibilitySegments( <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">deque</span></span>&lt;SVisibilitySegment&gt;&amp; segments) { .... segments.erase(segments.end()); .... }</code> </pre> <br>  PVS-Studio Warning: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">V783</a> CWE-119 A desreferencia√ß√£o do iterador inv√°lido 'segmentos.end ()' pode ocorrer.  CCmpRallyPointRenderer.cpp 1290 <br><br>  C√≥digo muito, muito estranho.  Talvez o programador desejasse remover o √∫ltimo elemento do cont√™iner.  Nesse caso, o c√≥digo deve ser assim: <br><br><pre> <code class="cpp hljs">segments.erase(segments.end() - <span class="hljs-number"><span class="hljs-number">1</span></span>);</code> </pre> <br>  Embora, seria mais f√°cil escrever: <br><br><pre> <code class="cpp hljs">segments.pop_back();</code> </pre> <br>  Para ser sincero, n√£o est√° totalmente claro para mim o que exatamente deveria ter sido escrito aqui. <br><br>  <b>Erro N3, N4</b> <br><br>  Decidi considerar dois erros juntos, pois eles est√£o relacionados a um vazamento de recurso e primeiro preciso mostrar o que √© a macro <i>WARN_RETURN</i> . <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> WARN_RETURN(status)\ do\ {\ DEBUG_WARN_ERR(status);\ return status;\ }\ while(0)</span></span></code> </pre> <br>  Portanto, como voc√™ pode ver, a macro <i>WARN_RETURN</i> faz com que a fun√ß√£o saia do corpo.  Agora vamos ver maneiras imprecisas de usar essa macro. <br><br>  O primeiro fragmento. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">Status </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sys_generate_random_bytes</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(u8* buf, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> count)</span></span></span><span class="hljs-function"> </span></span>{ FILE* f = fopen(<span class="hljs-string"><span class="hljs-string">"/dev/urandom"</span></span>, <span class="hljs-string"><span class="hljs-string">"rb"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!f) WARN_RETURN(ERR::FAIL); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (count) { <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> numread = fread(buf, <span class="hljs-number"><span class="hljs-number">1</span></span>, count, f); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (numread == <span class="hljs-number"><span class="hljs-number">0</span></span>) WARN_RETURN(ERR::FAIL); buf += numread; count -= numread; } fclose(f); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> INFO::OK; }</code> </pre> <br>  Aviso do PVS-Studio: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">V773</a> CWE-401 A fun√ß√£o foi encerrada sem liberar o identificador 'f'.  Um vazamento de recurso √© poss√≠vel.  unix.cpp 332 <br><br>  Se a fun√ß√£o <i>fread</i> n√£o puder ler os dados, a fun√ß√£o <i>sys_generate_random_bytes</i> sair√° sem liberar o descritor de arquivo.  Na pr√°tica, isso √© quase imposs√≠vel.  √â duvidoso que voc√™ n√£o consiga ler dados de "/ dev / urandom".  No entanto, o c√≥digo √© desleixado. <br><br>  O segundo fragmento. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">Status </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sys_cursor_create</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... sys_cursor_impl* impl = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> sys_cursor_impl; impl-&gt;image = image; impl-&gt;cursor = XcursorImageLoadCursor(wminfo.info.x11.display, image); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(impl-&gt;cursor == None) WARN_RETURN(ERR::FAIL); *cursor = <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;sys_cursor&gt;(impl); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> INFO::OK; }</code> </pre> <br>  Aviso do PVS-Studio: V773 CWE-401 A fun√ß√£o foi encerrada sem liberar o ponteiro 'impl'.  √â poss√≠vel um vazamento de mem√≥ria.  x.cpp 421 <br><br>  Se o cursor falhar ao carregar, ocorre um vazamento de mem√≥ria. <br><br>  <b>Erro N5</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">Status </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LoadHeightmapImageOs</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>&lt;u8&gt; fileData = <span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>&lt;u8&gt;(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> u8[fileSize]); .... }</code> </pre> <br>  Aviso do PVS-Studio: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">V554</a> CWE-762 Uso incorreto de shared_ptr.  A mem√≥ria alocada com 'new []' ser√° limpa usando 'delete'.  MapIO.cpp 54 <br><br>  A op√ß√£o correta: <br><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>&lt;u8[]&gt; fileData = <span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>&lt;u8&gt;(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> u8[fileSize]);</code> </pre> <br>  <b>Erro N6</b> <br><br><pre> <code class="cpp hljs">FUTrackedPtr(ObjectClass* _ptr = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) : ptr(_ptr) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ptr != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) FUTracker::TrackObject((FUTrackable*) ptr); ptr = ptr; }</code> </pre> <br>  PVS-Studio Warning: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">V570</a> A vari√°vel 'ptr' √© atribu√≠da a si mesma.  FUTracker.h 122 <br><br>  <b>Erro N7, N8</b> <br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::wstring TraceEntry::EncodeAsText() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">wchar_t</span></span> action = (<span class="hljs-keyword"><span class="hljs-keyword">wchar_t</span></span>)m_action; <span class="hljs-keyword"><span class="hljs-keyword">wchar_t</span></span> buf[<span class="hljs-number"><span class="hljs-number">1000</span></span>]; swprintf_s(buf, ARRAY_SIZE(buf), <span class="hljs-string"><span class="hljs-string">L"%#010f: %c \"%ls\" %lu\n"</span></span>, m_timestamp, action, m_pathname.<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>().c_str(), (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)m_size); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> buf; }</code> </pre> <br>  Aviso do PVS-Studio: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">V576</a> CWE-628 Formato incorreto.  Considere verificar o quinto argumento real da fun√ß√£o 'swprintf_s'.  O argumento do tipo char √© esperado.  trace.cpp 93 <br><br>  Aqui encontramos um hist√≥rico confuso e indistinto de uma implementa√ß√£o alternativa da fun√ß√£o <i>swprintf</i> no Visual C ++.  N√£o vou <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">recont√°-</a> lo, mas consulte a documenta√ß√£o para o diagn√≥stico do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">V576</a> (consulte a se√ß√£o "Linhas largas"). <br><br>  Nesse caso, provavelmente, esse c√≥digo funcionar√° corretamente ao compilar no Visual C ++ para Windows e incorretamente ao criar para Linux ou macOS. <br><br>  Erro semelhante: V576 CWE-628 Formato incorreto.  Considere verificar o quarto argumento real da fun√ß√£o 'swprintf_s'.  O argumento do tipo char √© esperado.  vfs_tree.cpp 211 <br><br>  <b>Erro N9, N10, N11</b> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Cl√°ssico</a>  No in√≠cio, o ponteiro √© usado e s√≥ depois verificado. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TEST_CAT2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* dst, ....)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">strcpy</span></span>(dst, dst_val); <span class="hljs-comment"><span class="hljs-comment">// &lt;= int ret = strcat_s(dst, max_dst_chars, src); TS_ASSERT_EQUALS(ret, expected_ret); if(dst != 0) // &lt;= TS_ASSERT(!strcmp(dst, expected_dst)); }</span></span></code> </pre> <br>  Aviso do PVS-Studio: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">V595</a> CWE-476 O ponteiro 'dst' foi utilizado antes de ser verificado no nullptr.  Verifique as linhas: 140, 143. test_secure_crt.h 140 <br><br>  Eu acho que o erro n√£o requer explica√ß√£o.  Avisos semelhantes: <br><br><ul><li>  V595 CWE-476 O ponteiro 'dst' foi utilizado antes de ser verificado com rela√ß√£o ao nullptr.  Verifique as linhas: 150, 153. test_secure_crt.h 150 </li><li>  V595 CWE-476 O ponteiro 'dst' foi utilizado antes de ser verificado com rela√ß√£o ao nullptr.  Verifique as linhas: 314, 317. test_secure_crt.h 314 </li></ul><br>  <b>Erro N12</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> tbool; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> MikkTSpace::setTSpace(...., <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> tbool bIsOrientationPreserving, ....) { .... m_NewVertices.push_back(bIsOrientationPreserving &gt; <span class="hljs-number"><span class="hljs-number">0.5</span></span> ? <span class="hljs-number"><span class="hljs-number">1.0f</span></span> : (<span class="hljs-number"><span class="hljs-number">-1.0f</span></span>)); .... }</code> </pre> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">V674</a> CWE-682 O literal '0.5' do tipo 'double' √© comparado com um valor do tipo 'int'.  Considere inspecionar a express√£o 'bIsOrientationPreserving&gt; 0.5'.  MikktspaceWrap.cpp 137 <br><br>  N√£o faz sentido comparar uma vari√°vel do tipo <i>int</i> com uma constante de 0,5.  Al√©m disso, em termos de significado, essa geralmente √© uma vari√°vel do tipo booleano, o que significa que compar√°-la com 0,5 parece muito estranha.  Suponha que, em vez de <i>bIsOrientationPreserving,</i> outra vari√°vel deva ser usada aqui. <br><br>  <b>Erro N13</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> Status </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReplaceFile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> VfsPath&amp; pathname, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">shared_ptr</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;u8&gt;&amp; fileContents, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> size)</span></span></span><span class="hljs-function"> </span></span>{ ScopedLock s; VfsDirectory* directory; VfsFile* file; Status st; st = vfs_Lookup(pathname, &amp;m_rootDirectory, directory, &amp;file, VFS_LOOKUP_ADD|VFS_LOOKUP_CREATE); <span class="hljs-comment"><span class="hljs-comment">// There is no such file, create it. if (st == ERR::VFS_FILE_NOT_FOUND) { s.~ScopedLock(); return CreateFile(pathname, fileContents, size); } .... }</span></span></code> </pre> <br>  PVS-Studio Warning: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">V749</a> CWE-675 O destruidor do objeto 's' ser√° invocado uma segunda vez ap√≥s sair do escopo do objeto.  vfs.cpp 165 <br><br>  Antes de criar um arquivo, √© necess√°rio que um objeto do tipo <i>ScopedLock</i> "desbloqueie" um objeto.  Para isso, um destruidor √© chamado explicitamente.  O problema √© que o destruidor do objeto <i>s</i> ser√° chamado automaticamente novamente quando a fun√ß√£o sair.  I.e.  o destruidor ser√° chamado duas vezes.  N√£o estudei o dispositivo da classe <i>ScopedLock</i> , mas, de qualquer forma, voc√™ n√£o deve fazer isso.  Freq√ºentemente, uma chamada dupla para o destruidor leva a um comportamento indefinido ou outros erros desagrad√°veis.  Mesmo se o c√≥digo estiver funcionando bem agora, √© muito f√°cil quebrar tudo alterando a implementa√ß√£o da classe <i>ScopedLock</i> . <br><br>  <b>Erro N14, N15, N16, N17</b> <br><br><pre> <code class="cpp hljs">CFsmEvent* CFsm::AddEvent( <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> eventType ) { .... pEvent = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CFsmEvent( eventType ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !pEvent ) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; .... }</code> </pre> <br>  Aviso do PVS-Studio: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">V668</a> CWE-570 N√£o faz sentido testar o ponteiro 'pEvent' contra nulo, pois a mem√≥ria foi alocada usando o operador 'novo'.  A exce√ß√£o ser√° gerada no caso de erro de aloca√ß√£o de mem√≥ria.  fsm.cpp 259 <br><br>  A verifica√ß√£o do ponteiro n√£o faz sentido, porque, no caso de um erro de aloca√ß√£o de mem√≥ria, ser√° <i>lan√ßada</i> uma exce√ß√£o <i>std :: bad_alloc</i> . <br><br>  Portanto, a verifica√ß√£o √© sup√©rflua, mas o erro n√£o √© grave.  No entanto, tudo fica muito pior quando alguma l√≥gica √© executada no corpo da <i>instru√ß√£o if</i> .  Considere o seguinte caso: <br><br><pre> <code class="cpp hljs">CFsmTransition* CFsm::AddTransition(....) { .... CFsmEvent* pEvent = AddEvent( eventType ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !pEvent ) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-comment"><span class="hljs-comment">// Create new transition CFsmTransition* pNewTransition = new CFsmTransition( state ); if ( !pNewTransition ) { delete pEvent; return NULL; } .... }</span></span></code> </pre> <br>  Aviso do analisador: V668 CWE-570 N√£o h√° sentido em testar o ponteiro 'pNewTransition' contra nulo, pois a mem√≥ria foi alocada usando o operador 'new'.  A exce√ß√£o ser√° gerada no caso de erro de aloca√ß√£o de mem√≥ria.  fsm.cpp 289 <br><br>  √â feita uma tentativa de liberar mem√≥ria cujo endere√ßo est√° armazenado no ponteiro de <i>pEvent</i> .  Naturalmente, isso n√£o acontecer√° e ocorrer√° um vazamento de mem√≥ria. <br><br>  De fato, quando comecei a lidar com esse c√≥digo, tudo ficou mais complicado e talvez n√£o houvesse um erro, mas dois.  Agora vou explicar o que h√° de errado com este c√≥digo.  Para fazer isso, precisamos nos familiarizar com o dispositivo de fun√ß√£o <i>AddEvent</i> . <br><br><pre> <code class="cpp hljs">CFsmEvent* CFsm::AddEvent( <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> eventType ) { CFsmEvent* pEvent = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-comment"><span class="hljs-comment">// Lookup event by type EventMap::iterator it = m_Events.find( eventType ); if ( it != m_Events.end() ) { pEvent = it-&gt;second; } else { pEvent = new CFsmEvent( eventType ); if ( !pEvent ) return NULL; // Store new event into internal map m_Events[ eventType ] = pEvent; } return pEvent; }</span></span></code> </pre> <br>  Observe que a fun√ß√£o nem sempre retorna um ponteiro para um novo objeto criado usando o <i>novo</i> operador.  √Äs vezes, √© necess√°rio um objeto existente do cont√™iner <i>m_Events</i> .  E o ponteiro para o objeto rec√©m-criado, a prop√≥sito, tamb√©m ser√° colocado em <i>m_Events</i> . <br><br>  E aqui surge a pergunta: quem √© o propriet√°rio e deve destruir os objetos cujos ponteiros est√£o armazenados no cont√™iner <i>m_Events</i> ?  N√£o estou familiarizado com o projeto, mas provavelmente em algum lugar existe um c√≥digo que destr√≥i todos esses objetos.  Em seguida, excluir um objeto dentro da <i>fun√ß√£o CFsm :: AddTransition</i> geralmente <i>√©</i> sup√©rfluo. <br><br>  Tive a impress√£o de que voc√™ pode simplesmente excluir o seguinte fragmento de c√≥digo: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !pNewTransition ) { <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> pEvent; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; }</code> </pre> <br>  Outros erros: <br><br><ul><li>  V668 CWE-571 N√£o h√° sentido em testar o ponteiro 'ret' contra nulo, pois a mem√≥ria foi alocada usando o operador 'novo'.  A exce√ß√£o ser√° gerada no caso de erro de aloca√ß√£o de mem√≥ria.  TerrainTextureEntry.cpp 120 </li><li>  V668 CWE-571 N√£o h√° sentido em testar o ponteiro 'resposta' contra nulo, pois a mem√≥ria foi alocada usando o operador 'novo'.  A exce√ß√£o ser√° gerada no caso de erro de aloca√ß√£o de mem√≥ria.  SoundManager.cpp 542 </li></ul><br>  <b>Erro N18, N19</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dir_scan_callback</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct de *de, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *data)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dir_scan_data</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dsd</span></span></span><span class="hljs-class"> = (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dir_scan_data</span></span></span><span class="hljs-class"> *) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dsd-&gt;entries == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> || dsd-&gt;num_entries &gt;= dsd-&gt;arr_size) { dsd-&gt;arr_size *= <span class="hljs-number"><span class="hljs-number">2</span></span>; dsd-&gt;entries = (struct de *) <span class="hljs-built_in"><span class="hljs-built_in">realloc</span></span>(dsd-&gt;entries, dsd-&gt;arr_size * <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(dsd-&gt;entries[<span class="hljs-number"><span class="hljs-number">0</span></span>])); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dsd-&gt;entries == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// TODO(lsm): propagate an error to the caller dsd-&gt;num_entries = 0; } else { dsd-&gt;entries[dsd-&gt;num_entries].file_name = mg_strdup(de-&gt;file_name); dsd-&gt;entries[dsd-&gt;num_entries].st = de-&gt;st; dsd-&gt;entries[dsd-&gt;num_entries].conn = de-&gt;conn; dsd-&gt;num_entries++; } }</span></span></code> </pre> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Aviso do</a> PVS-Studio: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">V701</a> CWE-401 realloc () poss√≠vel vazamento: quando realloc () falha na aloca√ß√£o de mem√≥ria, o ponteiro original 'dsd-&gt; entradas' √© perdido.  Considere atribuir realloc () a um ponteiro tempor√°rio.  mongoose.cpp 2462 <br><br>  Se o tamanho da matriz se tornar insuficiente, a mem√≥ria ser√° alocada usando a fun√ß√£o <i>realloc</i> .  O erro √© que o valor do ponteiro para o bloco de mem√≥ria original √© imediatamente substitu√≠do pelo novo valor retornado pela fun√ß√£o <i>realloc</i> . <br><br>  Se a aloca√ß√£o de mem√≥ria falhar, a fun√ß√£o <i>realloc</i> retornar√° NULL e esse NULL ser√° gravado na vari√°vel <i>dsd-&gt; inputs</i> .  Depois disso, ser√° imposs√≠vel liberar o bloco de mem√≥ria cujo endere√ßo foi armazenado anteriormente nas <i>entradas dsd-&gt;</i> .  Um vazamento de mem√≥ria ocorrer√°. <br><br>  Outro erro: V701 CWE-401 realloc () poss√≠vel vazamento: quando realloc () falha na aloca√ß√£o de mem√≥ria, o ponteiro original 'Buffer' √© perdido.  Considere atribuir realloc () a um ponteiro tempor√°rio.  Preprocessor.cpp 84 <br><br><h2>  Conclus√£o </h2><br>  N√£o posso dizer que desta vez o artigo tenha sido fascinante ou que consegui mostrar muitos erros terr√≠veis.  O que fazer, uma vez por vez, n√£o √© necess√°rio.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O que eu vejo, ent√£o eu escrevo</a> . <br><br>  Obrigado pela aten√ß√£o.  Para variar, terminarei o artigo com um convite para me seguir no Instagram <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">@pvs_studio_unicorn</a> e no Twitter <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">@Code_Analysis</a> . <br><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><img src="https://habrastorage.org/webt/ts/z9/km/tsz9kmyjtteajhd4x1au60rsrvq.png" align="left"></a> </p><br><br>  Se voc√™ deseja compartilhar este artigo com um p√∫blico que fala ingl√™s, use o link para a tradu√ß√£o: Andrey Karpov.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Bom trabalho, autores do jogo 0 AD!</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt420267/">https://habr.com/ru/post/pt420267/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt420257/index.html">Voc√™ ainda instala o Windows 2008? Eu tamb√©m, e √© por isso</a></li>
<li><a href="../pt420259/index.html">Painel de diagn√≥stico de envelhecimento em Cingapura</a></li>
<li><a href="../pt420261/index.html">O que vamos medir? Como escolher as m√©tricas corretas de ML para tarefas de neg√≥cios</a></li>
<li><a href="../pt420263/index.html">Confer√™ncia ServiceNow "Knowledge18"</a></li>
<li><a href="../pt420265/index.html">Sete quest√µes de implementa√ß√£o do Scrum que n√£o sab√≠amos</a></li>
<li><a href="../pt420269/index.html">Dinheiro pelo ralo: por que seu antiphishing n√£o detecta sites de phishing e como a Ci√™ncia de Dados o faz funcionar?</a></li>
<li><a href="../pt420271/index.html">Treinamento de empatia: estimulando as conex√µes neurais do c√©rebro por meio de um videogame</a></li>
<li><a href="../pt420273/index.html">Como √© organizado um carro de passageiros de longa dist√¢ncia</a></li>
<li><a href="../pt420275/index.html">Principais confer√™ncias na Internet das coisas em 2018-2019. R√∫ssia e o mundo</a></li>
<li><a href="../pt420277/index.html">Ap√≥s a corrida do ouro: perspectivas da tecnologia Blockchain</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>