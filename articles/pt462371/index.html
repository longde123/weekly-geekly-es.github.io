<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üîù üéè üõÄüèª Iniciar Spring StateMachine ü•ä üïü üë©‚Äç‚ù§Ô∏è‚Äçüíã‚Äçüë®</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Entrada 
 Nos projetos, encontrei tr√™s exemplos, de uma forma ou de outra relacionados √† teoria dos aut√¥matos finitos 



- Exemplo 1. Um c√≥digo govno...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Iniciar Spring StateMachine</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/462371/"><h3>  Entrada </h3><br>  Nos projetos, encontrei tr√™s exemplos, de uma forma ou de outra relacionados √† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">teoria dos aut√¥matos finitos</a> <br><br><ul><li>  Exemplo 1. <b>Um</b> <b>c√≥digo</b> <s>govnokod</s> <b>divertido</b> .  Demora muito tempo para entender o que est√° acontecendo.  Uma caracter√≠stica da modalidade da teoria indicada no c√≥digo √© um despejo bastante feroz que √†s vezes se parece muito com um c√≥digo processual.  O fato de que esta vers√£o do c√≥digo √© melhor para n√£o tocar no projeto conhece todos os tecn√≥logos, metod√≥logos e especialistas em produtos.  Eles entram nesse c√≥digo para corrigir algo em caso de emerg√™ncia (quando est√° completamente quebrado), n√£o h√° como finalizar nenhum recurso.  Por que √© assustador quebrar.  O segundo recurso marcante que isola esse tipo √© a presen√ßa de switches t√£o poderosos, em tela cheia. <br>  H√° at√© uma piada sobre esse ponto: <a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">Tamanho ideal</b> <div class="spoiler_text"> Em um dos JPoint, um dos oradores, talvez Nikolai Alimenkov, falou sobre quantos casos no switch s√£o normais, disse que a resposta principal √© "at√© agora cabe na tela".  Portanto, se voc√™ interferir e sua op√ß√£o j√° n√£o estiver normal, pegue e reduza o tamanho da fonte no IDE <br></div></div></li><li>  Exemplo 2. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><b>Estado do Padr√£o</b></a> .  A id√©ia principal (para quem n√£o gosta de seguir os links) √© que dividimos uma determinada tarefa de neg√≥cios em um conjunto de estados finais e as descrevemos com c√≥digo. <br>  A principal desvantagem do Estado Padr√£o √© que os estados se conhecem, sabem que existem irm√£os e se chamam.  Esse c√≥digo √© bastante dif√≠cil de universalizar.  Por exemplo, ao implementar um sistema de pagamento com v√°rios tipos de pagamento, voc√™ corre o risco de cavar tanto no Generic-s que a declara√ß√£o de seus m√©todos pode se tornar algo como isto: <cut></cut><br><br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> &lt; T extends BaseContextPayment, Q extends BaseDomainPaymentRequest, S, B extends AbstractPaymentDetailBuilder&lt;T, Q, S, B&gt;, F extends AbstractPaymentBuilder&lt;T, Q, S, B&gt; &gt; <span class="hljs-function"><span class="hljs-function">PaymentContext&lt;T, S&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">build</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Q request, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Class&lt;F&gt; factoryClass)</span></span></span></span>{ <span class="hljs-comment"><span class="hljs-comment">//""  }</span></span></code> </pre> <br>  Resumindo Estado: uma implementa√ß√£o pode resultar em c√≥digo bastante complicado. </li><li>  Exemplo 3 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">StateMachine</a> A id√©ia principal do Pattern √© que os estados n√£o se conhecem, o controle de transi√ß√£o √© realizado pelo contexto, √© melhor, menos conectado, o c√≥digo √© mais simples. <br></li></ul><br>  Tendo experimentado todo o ‚Äúpoder‚Äù do primeiro tipo e a complexidade do segundo, decidimos usar o Pattern StateMachine para o novo caso de neg√≥cios. <br>  Para n√£o reinventar a roda, foi decidido tomar a Statemachine Spring como base (esta √© a Spring). <br><br>  Depois de ler as docas, fui ao YouTube e Habr (para entender como as pessoas trabalham com ele, como se sente no produto, que tipo de rake, etc.). Acontece que h√° pouca informa√ß√£o, no YouTube h√° alguns v√≠deos, todos s√£o bastante superficiais.  Sobre Habr√©, sobre esse assunto, encontrei apenas um artigo, bem como o v√≠deo, bastante superficial. <br>  Em um artigo, √© imposs√≠vel descrever todas as sutilezas do trabalho da Spring statemachine, contornar o cais e descrever todos os casos, mas tentarei dizer o mais importante e exigido, e sobre o rake, especificamente para mim, quando me familiarizei com a estrutura, as informa√ß√µes abaixo eram seria muito √∫til. <br><br><h3>  Corpo principal </h3><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Criaremos um aplicativo Spring Boot,</a> adicionaremos um iniciador da Web (o aplicativo Web ser√° executado o mais r√°pido poss√≠vel) .O aplicativo ser√° uma abstra√ß√£o do processo de compra.  O produto na compra passar√° pelas etapas de novo decl√≠nio reservado e reservado e a compra ser√° conclu√≠da. <br>  Um pouco de improvisa√ß√£o, haveria mais status em um projeto real, mas tudo bem, tamb√©m temos um projeto muito real. <br>  No pom.xml do aplicativo da Web rec√©m-instalado, adicione a depend√™ncia da m√°quina e dos testes para ele (o Web Starter j√° deve estar, se coletado via <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">start.spring.io</a> ): <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.springframework.statemachine<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>spring-statemachine-core<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>2.1.3.RELEASE<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.springframework.statemachine<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>spring-statemachine-test<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>2.1.3.RELEASE<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">scope</span></span></span><span class="hljs-tag">&gt;</span></span>test<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">scope</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">cut</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre><br>  Crie a estrutura: <br><img src="https://habrastorage.org/webt/u8/nw/oq/u8nwoqaezenqp1pouozil4qjwno.png"><br>  Ainda n√£o preciso entrar em detalhes dessa estrutura, explicarei tudo em sequ√™ncia e haver√° um link para a fonte no final do artigo. <br><br>  Ent√£o vamos l√°. <br>  Temos um projeto limpo com as depend√™ncias necess√°rias; para come√ßar, criaremos enum, com estados e eventos, uma abstra√ß√£o bastante simples, esses componentes em si n√£o possuem l√≥gica. <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> PurchaseEvent { RESERVE, BUY, RESERVE_DECLINE }</code> </pre> <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> PurchaseState { NEW, RESERVED, CANCEL_RESERVED, PURCHASE_COMPLETE }</code> </pre> <br>  Embora formalmente, voc√™ pode adicionar campos a esses enum e codificar algo que √© caracter√≠stico de, por exemplo, um estado espec√≠fico, o que √© bastante l√≥gico (fizemos isso resolvendo nosso caso de maneira conveniente). <br>  Vamos configurar a m√°quina atrav√©s da configura√ß√£o java, criar o arquivo de configura√ß√£o e, para a classe estendida EnumStateMachineConfigurerAdapter &lt;PurchaseState, PurchaseEvent&gt;.  Como nosso estado e evento s√£o enum, a interface √© apropriada, mas n√£o √© necess√°ria, qualquer tipo de objeto pode ser usado como gen√©rico (n√£o consideraremos outros exemplos no artigo, pois EnumStateMachineConfigurerAdapter √© mais que suficiente na minha opini√£o). <br><br>  O pr√≥ximo ponto importante √© se uma m√°quina permanecer√° no contexto do aplicativo: em uma √∫nica inst√¢ncia do @EnableStateMachine ou sempre que um novo @EnableStateMachineFactory ser√° criado.  Se este for um aplicativo da web para v√°rios usu√°rios com v√°rios usu√°rios, a primeira op√ß√£o dificilmente ser√° adequada para voc√™, portanto, usaremos o segundo como o mais popular.  O StateMachine tamb√©m pode ser criado via construtor como um bean comum (consulte a documenta√ß√£o), o que √© conveniente em alguns casos (por exemplo, voc√™ precisa que a m√°quina seja declarada explicitamente como um bean) e, se for um bean separado, podemos dizer qual √© o seu escopo por exemplo, sess√£o ou solicita√ß√£o.  Em nosso projeto, o wrapper (recursos de nossa l√≥gica de neg√≥cios) foi implementado no bean de m√°quina do estado, o wrapper era √∫nico e a pr√≥pria m√°quina de prot√≥tipo <br><div class="spoiler">  <b class="spoiler_title">Ancinho</b> <div class="spoiler_text">  Como implementar prot√≥tipo em singlton? <br>  Na verdade, tudo o que voc√™ precisa fazer √© obter um novo bean do applicationContext toda vez que acessar o objeto.  A inje√ß√£o de um applicationContext na l√≥gica de neg√≥cios √© um pecado; portanto, uma m√°quina de estado de bean deve implementar uma interface com pelo menos um m√©todo ou um m√©todo abstrato (inje√ß√£o de m√©todo). Ao criar uma configura√ß√£o java, voc√™ precisar√° implementar o m√©todo abstrato indicado e, na implementa√ß√£o, obteremos applicationContext novo bean.  √â pr√°tica comum ter um link para o applicationContext na classe config e, atrav√©s do m√©todo abstrato, chamaremos .getBean (); <br></div></div><br>  A classe EnumStateMachineConfigurerAdapter possui v√°rios m√©todos, substituindo os que configuramos na m√°quina. <br>  Para come√ßar, registre os status: <br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">configure</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> StateMachineStateConfigurer&lt;PurchaseState, PurchaseEvent&gt; states)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ states .withStates() .initial(NEW) .end(PURCHASE_COMPLETE) .states(EnumSet.allOf(PurchaseState.class)); }</code> </pre> <br>  initial (NEW) √© o status em que a m√°quina estar√° ap√≥s a cria√ß√£o do bean, end (PURCHASE_COMPLETE) √© o status em que a m√°quina executa statemachine.stop (), para uma m√°quina n√£o determin√≠stica (a maioria) √© irrelevante, mas algo precisa ser especificado .  .states (EnumSet.allOf (PurchaseState.class) de todos os status, voc√™ pode empurrar em massa. <br><br>  Definir configura√ß√µes globais da m√°quina <br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">configure</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> StateMachineConfigurationConfigurer&lt;PurchaseState, PurchaseEvent&gt; config)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ config .withConfiguration() .autoStartup(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) .listener(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PurchaseStateMachineApplicationListener()); }</code> </pre> <br>  Aqui, o autoStartup determina se a m√°quina ser√° iniciada imediatamente ap√≥s a cria√ß√£o por padr√£o, em outras palavras - se ela alternar√° automaticamente para o status NEW (falso por padr√£o).  Imediatamente, registramos um ouvinte para o contexto da m√°quina (sobre isso um pouco mais tarde), na mesma configura√ß√£o, voc√™ pode definir um TaskExecutor separado, o que √© conveniente quando uma a√ß√£o longa √© executada em algumas de suas transi√ß√µes e o aplicativo deve ir al√©m. <br>  Bem, as pr√≥prias transi√ß√µes: <br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">configure</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> StateMachineTransitionConfigurer&lt;PurchaseState, PurchaseEvent&gt; transitions)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ transitions .withExternal() .source(NEW) .target(RESERVED) .event(RESERVE) .action(reservedAction(), errorAction()) .and() .withExternal() .source(RESERVED) .target(CANCEL_RESERVED) .event(RESERVE_DECLINE) .action(cancelAction(), errorAction()) .and() .withExternal() .source(RESERVED) .target(PURCHASE_COMPLETE) .event(BUY) .guard(hideGuard()) .action(buyAction(), errorAction()); }</code> </pre> <br>  Toda l√≥gica de transi√ß√µes ou transi√ß√µes √© definida aqui, o Guard pode ser pendurado nas transi√ß√µes, um componente que sempre retorna booleano, o que exatamente voc√™ confere na transi√ß√£o de um status para outro a seu crit√©rio, qualquer l√≥gica pode ser perfeita no Guard, este √© um componente completamente comum mas ele deve retornar booleano.  Na estrutura de nosso projeto, por exemplo, o HideGuard pode verificar uma determinada configura√ß√£o que o usu√°rio pode definir (n√£o mostra este produto) e, de acordo com ele, n√£o deixa a m√°quina entrar no estado protegido pelo Guard.  Observo que o Guard, apenas um pode ser adicionado a uma transi√ß√£o na configura√ß√£o, esse design n√£o funcionar√°: <br><pre> <code class="java hljs"> .withExternal() .source(RESERVED) .target(PURCHASE_COMPLETE) .event(BUY) .guard(hideGuard()) .guard(veryHideGuard())</code> </pre> <br>  Mais precisamente, ele funcionar√°, mas apenas o primeiro guarda (hideGuard ()) <br>  Mas voc√™ pode adicionar v√°rias a√ß√µes (agora estamos falando sobre a a√ß√£o, que prescrevemos na configura√ß√£o de transi√ß√µes), eu pessoalmente tentei adicionar tr√™s a√ß√µes a uma transi√ß√£o. <br><pre> <code class="java hljs"> .withExternal() .source(NEW) .target(RESERVED) .event(RESERVE) .action(reservedAction(), errorAction())</code> </pre> <br>  o segundo argumento √© ErrorAction, o controle chegar√° a ele se o ReservedAction gerar uma exce√ß√£o (throw ). <br><div class="spoiler">  <b class="spoiler_title">Ancinho</b> <div class="spoiler_text">  Lembre-se de que se em sua a√ß√£o voc√™ ainda manipular o erro via tentativa / captura, n√£o entrar√° no ErrorAction; se precisar processar e entrar no ErrorAction, dever√° lan√ßar RuntimeException () do catch, por exemplo (voc√™ mesmo disse que √© muito necess√°rio). <br></div></div><br>  Al√©m da a√ß√£o "suspensa" nas transi√ß√µes, voc√™ tamb√©m pode "suspend√™-las" no m√©todo configure for state, aproximadamente da seguinte forma: <br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">configure</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> StateMachineStateConfigurer&lt;PurchaseState, PurchaseEvent&gt; states)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ states .withStates() .initial(NEW) .end(PURCHASE_COMPLETE) .stateEntry() .stateExit() .state() .states(EnumSet.allOf(PurchaseState.class)); }</code> </pre> <br>  Tudo depende de como voc√™ deseja executar a a√ß√£o. <br><div class="spoiler">  <b class="spoiler_title">Ancinho</b> <div class="spoiler_text">  Observe que, se voc√™ especificar uma a√ß√£o ao configurar state (), assim <br><pre> <code class="java hljs"> states .withStates() .initial(NEW) .end(PURCHASE_COMPLETE) .state(randomAction())</code> </pre> <br>  ela ser√° executada de forma ass√≠ncrona, pressup√µe-se que, se voc√™ disser .stateEntry (), por exemplo, a A√ß√£o seja executada diretamente na entrada, mas se voc√™ disser .state (), a A√ß√£o dever√° ser executada no estado de destino, mas n√£o √© t√£o importante quando. <br>  Em nosso projeto, configuramos todas as a√ß√µes na configura√ß√£o de transi√ß√£o, pois voc√™ pode pendur√°-las v√°rias de cada vez. <br></div></div><br>  A vers√£o final da configura√ß√£o ficar√° assim: <br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Configuration</span></span> <span class="hljs-meta"><span class="hljs-meta">@EnableStateMachineFactory</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StateMachineConfig</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EnumStateMachineConfigurerAdapter</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PurchaseState</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PurchaseEvent</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">configure</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> StateMachineConfigurationConfigurer&lt;PurchaseState, PurchaseEvent&gt; config)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ config .withConfiguration() .autoStartup(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) .listener(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PurchaseStateMachineApplicationListener()); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">configure</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> StateMachineStateConfigurer&lt;PurchaseState, PurchaseEvent&gt; states)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ states .withStates() .initial(NEW) .end(PURCHASE_COMPLETE) .stateEntry() .stateExit() .state() .states(EnumSet.allOf(PurchaseState.class)); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">configure</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> StateMachineTransitionConfigurer&lt;PurchaseState, PurchaseEvent&gt; transitions)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ transitions .withExternal() .source(NEW) .target(RESERVED) .event(RESERVE) .action(reservedAction(), errorAction()) .and() .withExternal() .source(RESERVED) .target(CANCEL_RESERVED) .event(RESERVE_DECLINE) .action(cancelAction(), errorAction()) .and() .withExternal() .source(RESERVED) .target(PURCHASE_COMPLETE) .event(BUY) .guard(hideGuard()) .action(buyAction(), errorAction()); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Action&lt;PurchaseState, PurchaseEvent&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reservedAction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ReservedAction(); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Action&lt;PurchaseState, PurchaseEvent&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cancelAction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CancelAction(); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Action&lt;PurchaseState, PurchaseEvent&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">buyAction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BuyAction(); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Action&lt;PurchaseState, PurchaseEvent&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">errorAction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ErrorAction(); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Guard&lt;PurchaseState, PurchaseEvent&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hideGuard</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HideGuard(); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> StateMachinePersister&lt;PurchaseState, PurchaseEvent, String&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">persister</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DefaultStateMachinePersister&lt;&gt;(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PurchaseStateMachinePersister()); }</code> </pre> <br>  Preste aten√ß√£o ao esquema da m√°quina, √© muito claramente vis√≠vel o que exatamente codificamos (quais transi√ß√µes em quais eventos s√£o v√°lidos, qual Guard protege o status e o que ser√° executado quando o status for alternado, qual a√ß√£o). <br><img src="https://habrastorage.org/webt/l8/2z/2v/l82z2v6pwdaudcrvdpqi99xw48s.png"><br>  Vamos fazer o controlador: <br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RestController</span></span> <span class="hljs-meta"><span class="hljs-meta">@SuppressWarnings</span></span>(<span class="hljs-string"><span class="hljs-string">"unused"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PurchaseController</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> PurchaseService purchaseService; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PurchaseController</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(PurchaseService purchaseService)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.purchaseService = purchaseService; } <span class="hljs-meta"><span class="hljs-meta">@RequestMapping</span></span>(path = <span class="hljs-string"><span class="hljs-string">"/reserve"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reserve</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> String userId, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> String productId)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> purchaseService.reserved(userId, productId); } <span class="hljs-meta"><span class="hljs-meta">@RequestMapping</span></span>(path = <span class="hljs-string"><span class="hljs-string">"/cancel"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cancelReserve</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> String userId)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> purchaseService.cancelReserve(userId); } <span class="hljs-meta"><span class="hljs-meta">@RequestMapping</span></span>(path = <span class="hljs-string"><span class="hljs-string">"/buy"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">buyReserve</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> String userId)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> purchaseService.buy(userId); } }</code> </pre> <br><cut></cut><br>  interface de servi√ßo <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PurchaseService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** *    ,          * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> userId id ,    ,      id  *    http- * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> productId id ,     * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> /  ,             *      . */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reserved</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String userId, String productId)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/** *   /    * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> userId id ,    ,      id  *    http- * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> /  ,             *      . */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cancelReserve</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String userId)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/** *     * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> userId id ,    ,      id  *    http- * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> /  ,             *      . */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">buy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String userId)</span></span></span></span>; }</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Ancinho</b> <div class="spoiler_text">  Voc√™ sabe por que √© importante criar bean atrav√©s da interface ao trabalhar com o Spring?  Diante deste problema (bem, sim, sim, e Zhenya Borisov falou no estripador), quando uma vez no controlador, eles tentaram implementar uma interface improvisada e n√£o vazia.  O Spring cria um proxy para componentes e, se o componente n√£o implementa nenhuma interface, ele o faz por meio do CGLIB, mas assim que voc√™ implementa alguma interface - o Spring tenta criar um proxy por meio de um proxy din√¢mico, como resultado, voc√™ obt√©m um tipo de objeto incompreens√≠vel e NoSuchBeanDefinitionException . <br></div></div><br>  O pr√≥ximo ponto importante √© como voc√™ restaurar√° o estado da sua m√°quina, pois a cada chamada ser√° criado um novo bean que n√£o sabe nada sobre seus status anteriores da m√°quina e seu contexto. <br>  Para esses fins, a m√°quina de estado da mola possui um mecanismo Persistens: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PurchaseStateMachinePersister</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StateMachinePersist</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PurchaseState</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PurchaseEvent</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">String</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> HashMap&lt;String, StateMachineContext&lt;PurchaseState, PurchaseEvent&gt;&gt; contexts = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap&lt;&gt;(); <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">write</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> StateMachineContext&lt;PurchaseState, PurchaseEvent&gt; context, String contextObj)</span></span></span><span class="hljs-function"> </span></span>{ contexts.put(contextObj, context); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> StateMachineContext&lt;PurchaseState, PurchaseEvent&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> String contextObj)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> contexts.get(contextObj); } }</code> </pre> <br>  Para nossa implementa√ß√£o ing√™nua, usamos o Mapa habitual como um armazenamento de estado; em uma implementa√ß√£o n√£o ing√™nua, ser√° algum tipo de banco de dados, preste aten√ß√£o ao terceiro tipo gen√©rico String, esta √© a chave pela qual o estado da sua m√°quina ser√° salvo, com todos os status, vari√°veis ‚Äã‚Äãno contexto, id e assim por diante.  No meu exemplo, usei o ID do usu√°rio para a chave de salvamento, que pode ser absolutamente qualquer chave (usu√°rio session_id, login exclusivo etc.). <br><div class="spoiler">  <b class="spoiler_title">Ancinho</b> <div class="spoiler_text">  Em nosso projeto, o mecanismo para salvar e restaurar estados da caixa n√£o nos convinha, pois armazen√°vamos os status da m√°quina no banco de dados e podiam ser alterados por um trabalho que n√£o sabia nada sobre a m√°quina. <br>  Eu tive que fixar o status recebido do banco de dados, executar alguma InitAction que, quando a m√°quina √© iniciada, recebeu o status do banco de dados e defini-lo √† for√ßa, e s√≥ ent√£o lan√ßou o evento, um exemplo de c√≥digo que faz o seguinte: <br><pre> <code class="java hljs">stateMachine .getStateMachineAccessor() .doWithAllRegions(access -&gt; { access.resetStateMachine(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DefaultStateMachineContext&lt;&gt;({ResetState}, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>)); }); stateMachine.start(); stateMachine.sendEvent({NewEventFromResetState});</code> </pre> <br></div></div><br>  Consideraremos a implementa√ß√£o do servi√ßo em cada m√©todo: <br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reserved</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> String userId, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> String productId)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> StateMachine&lt;PurchaseState, PurchaseEvent&gt; stateMachine = stateMachineFactory.getStateMachine(); stateMachine.getExtendedState().getVariables().put(<span class="hljs-string"><span class="hljs-string">"PRODUCT_ID"</span></span>, productId); stateMachine.sendEvent(RESERVE); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { persister.persist(stateMachine, userId); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Exception e) { e.printStackTrace(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; }</code> </pre> <br>  Pegamos o carro na f√°brica, colocamos um par√¢metro no contexto da m√°quina; no nosso caso, √© um productId, o contexto √© um tipo de caixa na qual voc√™ pode colocar tudo o que precisa, sempre que houver acesso ao bean de m√°quina de estado ou ao seu contexto, pois a m√°quina inicia automaticamente quando o contexto √© iniciado , depois do in√≠cio, nosso carro estar√° no status NOVO, lance o evento na reserva de mercadorias. <br><br>  Os dois m√©todos restantes s√£o semelhantes: <br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cancelReserve</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> String userId)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> StateMachine&lt;PurchaseState, PurchaseEvent&gt; stateMachine = stateMachineFactory.getStateMachine(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { persister.restore(stateMachine, userId); stateMachine.sendEvent(RESERVE_DECLINE); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e) { e.printStackTrace(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">buy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> String userId)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> StateMachine&lt;PurchaseState, PurchaseEvent&gt; stateMachine = stateMachineFactory.getStateMachine(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { persister.restore(stateMachine, userId); stateMachine.sendEvent(BUY); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e) { e.printStackTrace(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; }</code> </pre> <br>  Aqui, primeiro restauramos o estado da m√°quina para o userId de um usu√°rio espec√≠fico e, em seguida, lan√ßamos um evento que corresponde ao m√©todo api. <br>  Observe que productId n√£o aparece mais no m√©todo, o adicionamos ao contexto da m√°quina e o obtemos ap√≥s a restaura√ß√£o da m√°quina a partir do backup. <br>  Na implementa√ß√£o Action, obteremos o ID do produto no contexto da m√°quina e exibiremos uma mensagem correspondente √† transi√ß√£o no log; por exemplo, darei o c√≥digo ReservedAction: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ReservedAction</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Action</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PurchaseState</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PurchaseEvent</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(StateContext&lt;PurchaseState, PurchaseEvent&gt; context)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String productId = context.getExtendedState().get(<span class="hljs-string"><span class="hljs-string">"PRODUCT_ID"</span></span>, String.class); System.out.println(<span class="hljs-string"><span class="hljs-string">"   "</span></span> + productId + <span class="hljs-string"><span class="hljs-string">" ."</span></span>); } }</code> </pre> <br>  N√£o podemos deixar de mencionar o ouvinte, que prontamente oferece alguns scripts nos quais voc√™ pode aguentar, veja por si mesmo: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PurchaseStateMachineApplicationListener</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StateMachineListener</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PurchaseState</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PurchaseEvent</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stateChanged</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(State&lt;PurchaseState, PurchaseEvent&gt; from, State&lt;PurchaseState, PurchaseEvent&gt; to)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (from.getId() != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { System.out.println(<span class="hljs-string"><span class="hljs-string">"   "</span></span> + from.getId() + <span class="hljs-string"><span class="hljs-string">"   "</span></span> + to.getId()); } } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stateEntered</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(State&lt;PurchaseState, PurchaseEvent&gt; state)</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stateExited</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(State&lt;PurchaseState, PurchaseEvent&gt; state)</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">eventNotAccepted</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Message&lt;PurchaseEvent&gt; event)</span></span></span><span class="hljs-function"> </span></span>{ System.out.println(<span class="hljs-string"><span class="hljs-string">"   "</span></span> + event); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">transition</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Transition&lt;PurchaseState, PurchaseEvent&gt; transition)</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">transitionStarted</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Transition&lt;PurchaseState, PurchaseEvent&gt; transition)</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">transitionEnded</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Transition&lt;PurchaseState, PurchaseEvent&gt; transition)</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stateMachineStarted</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(StateMachine&lt;PurchaseState, PurchaseEvent&gt; stateMachine)</span></span></span><span class="hljs-function"> </span></span>{ System.out.println(<span class="hljs-string"><span class="hljs-string">"Machine started"</span></span>); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stateMachineStopped</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(StateMachine&lt;PurchaseState, PurchaseEvent&gt; stateMachine)</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stateMachineError</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(StateMachine&lt;PurchaseState, PurchaseEvent&gt; stateMachine, Exception exception)</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">extendedStateChanged</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object key, Object value)</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stateContext</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(StateContext&lt;PurchaseState, PurchaseEvent&gt; stateContext)</span></span></span><span class="hljs-function"> </span></span>{ } }</code> </pre> <br>  O √∫nico problema √© que essa √© uma interface, o que significa que voc√™ precisa implementar todos esses m√©todos, mas como √© improv√°vel que precise de todos eles, alguns ficar√£o vazios, cuja cobertura dir√° que os m√©todos n√£o s√£o cobertos por testes. <br>  Aqui no lisener, podemos pendurar absolutamente quaisquer m√©tricas em eventos completamente diferentes da m√°quina (por exemplo, os pagamentos n√£o passam, a m√°quina geralmente entra em algum tipo de status PAYMENT_FAIL, ouvimos transi√ß√µes e, se a m√°quina entrar em um status incorreto - escrevemos, em um log estranho, ou base ou chame a pol√≠cia, o que for). <br><div class="spoiler">  <b class="spoiler_title">Ancinho</b> <div class="spoiler_text">  H√° um evento stateMachineError no lisener-e, mas com uma nuance, quando voc√™ tem uma exce√ß√£o e a manipula na captura, a m√°quina n√£o considera que houve um erro, √© necess√°rio falar explicitamente na captura <br>  stateMachine.setStateMachineError (exce√ß√£o) e transmite um erro. <br></div></div><br>  Como uma verifica√ß√£o do que fizemos, executaremos dois casos: <br><ul><li>  1. Reserva e subsequente rejei√ß√£o da compra.  Enviaremos ao aplicativo uma solicita√ß√£o para o URI "/ reserve", com os par√¢metros userId = 007, productId = 10001, e depois a solicita√ß√£o "/ cancel" com o par√¢metro userId = 007, a sa√≠da do console ser√° a seguinte: <br> <code>Machine started <br>    10001 . <br>    NEW   RESERVED <br> Machine started <br>   10001  <br>    RESERVED   CANCEL_RESERVED</code> </li> <li>  2. Reserva e compra bem-sucedida: <br> <code>Machine started <br>    10001 . <br>    NEW   RESERVED <br> Machine started <br>    10001   <br>    RESERVED   PURCHASE_COMPLETE</code> </li> </ul><br><h3>  Conclus√£o </h3><br>  Concluindo, darei um exemplo de teste da estrutura, acho que tudo ficar√° claro a partir do c√≥digo, voc√™ s√≥ precisa de uma depend√™ncia da m√°quina de teste e pode verificar a configura√ß√£o declarativamente. <br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testWhenReservedCancel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ StateMachine&lt;PurchaseState, PurchaseEvent&gt; machine = factory.getStateMachine(); StateMachineTestPlan&lt;PurchaseState, PurchaseEvent&gt; plan = StateMachineTestPlanBuilder.&lt;PurchaseState, PurchaseEvent&gt;builder() .defaultAwaitTime(<span class="hljs-number"><span class="hljs-number">2</span></span>) .stateMachine(machine) .step() .expectStates(NEW) .expectStateChanged(<span class="hljs-number"><span class="hljs-number">0</span></span>) .and() .step() .sendEvent(RESERVE) .expectState(RESERVED) .expectStateChanged(<span class="hljs-number"><span class="hljs-number">1</span></span>) .and() .step() .sendEvent(RESERVE_DECLINE) .expectState(CANCEL_RESERVED) .expectStateChanged(<span class="hljs-number"><span class="hljs-number">1</span></span>) .and() .build(); plan.test(); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testWhenPurchaseComplete</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ StateMachine&lt;PurchaseState, PurchaseEvent&gt; machine = factory.getStateMachine(); StateMachineTestPlan&lt;PurchaseState, PurchaseEvent&gt; plan = StateMachineTestPlanBuilder.&lt;PurchaseState, PurchaseEvent&gt;builder() .defaultAwaitTime(<span class="hljs-number"><span class="hljs-number">2</span></span>) .stateMachine(machine) .step() .expectStates(NEW) .expectStateChanged(<span class="hljs-number"><span class="hljs-number">0</span></span>) .and() .step() .sendEvent(RESERVE) .expectState(RESERVED) .expectStateChanged(<span class="hljs-number"><span class="hljs-number">1</span></span>) .and() .step() .sendEvent(BUY) .expectState(PURCHASE_COMPLETE) .expectStateChanged(<span class="hljs-number"><span class="hljs-number">1</span></span>) .and() .build(); plan.test(); }</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Ancinho</b> <div class="spoiler_text">  Se de repente voc√™ quiser testar sua m√°quina sem elevar o contexto com os testes de unidade usuais, poder√° criar uma m√°quina atrav√©s do construtor (discutido parcialmente acima), criar uma inst√¢ncia da classe com uma configura√ß√£o e obter a√ß√£o e prote√ß√£o a partir da√≠, ela funcionar√° sem contexto, voc√™ pode escrever um pequeno teste A estrutura √© falsa; ser√° uma vantagem verificar quais a√ß√µes foram chamadas, quais n√£o s√£o, quantas vezes etc., em casos diferentes. <br></div></div><br><h3>  PS </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Nossa m√°quina est√° trabalhando de forma produtiva; at√© agora n√£o encontramos nenhum problema operacional, est√° chegando um recurso no qual podemos usar a grande maioria dos componentes da m√°quina atual ao implementar uma nova (a prote√ß√£o e algumas a√ß√µes s√£o perfeitas) </font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Nota </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> N√£o considerei isso no artigo, mas quero mencionar oportunidades como escolha, esse √© um tipo de gatilho que funciona com o princ√≠pio de troca, onde os guardas est√£o pendurados nos casos, e a m√°quina tenta alternadamente ir para esse estado, que √© descrito na configura√ß√£o de op√ß√µes e para onde o guarda deixar√° ir, sem alguns eventos, √© conveniente quando, ao inicializar a m√°quina, precisamos mudar automaticamente para algum tipo de pseudo-host. </font></font><br><br><h3>  Refer√™ncias </h3><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Doca </font></font></a> <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sources</font></font></a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt462371/">https://habr.com/ru/post/pt462371/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt462355/index.html">Programa√ß√£o JavaScript ass√≠ncrona (retorno de chamada, promessa, RxJs)</a></li>
<li><a href="../pt462357/index.html">Primeiro prot√≥tipo: Unikernels como um est√°gio na evolu√ß√£o do Linux</a></li>
<li><a href="../pt462359/index.html">Dat - que protocolo √© e quem o utiliza</a></li>
<li><a href="../pt462365/index.html">Limita√ß√µes do Machine Learning</a></li>
<li><a href="../pt462367/index.html">13 fatos sobre capitalismo de risco para fundadores</a></li>
<li><a href="../pt462377/index.html">Como as masmorras s√£o geradas em Enter The Gungeon</a></li>
<li><a href="../pt462379/index.html">Criptografia de arquivo de configura√ß√£o</a></li>
<li><a href="../pt462381/index.html">Redes neurais e aprendizado profundo, cap√≠tulo 5: por que as redes neurais profundas s√£o t√£o dif√≠ceis de treinar?</a></li>
<li><a href="../pt462383/index.html">De um armaz√©m no Daguest√£o - a programadores: como me tornei um desenvolvedor iOS do zero</a></li>
<li><a href="../pt462385/index.html">Uma nova abordagem pode nos ajudar a nos livrar dos c√°lculos de ponto flutuante</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>