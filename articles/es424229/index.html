<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üåó üöµüèΩ üî† Kubernetes en producci√≥n: servicios üëØ ‚úçüèæ üßîüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hace seis meses, completamos la migraci√≥n de todos nuestros servicios ap√°tridas a kubernetes. A primera vista, la tarea es bastante simple: debe imple...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Kubernetes en producci√≥n: servicios</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/okmeter/blog/424229/"><p><img align="left" width="250" src="https://habrastorage.org/webt/ww/yz/_z/wwyz_zvbfjx8vrreqprenpo0a00.png">  Hace seis meses, completamos la migraci√≥n de todos nuestros servicios ap√°tridas a kubernetes.  A primera vista, la tarea es bastante simple: debe implementar un cl√∫ster, escribir las especificaciones de la aplicaci√≥n y listo.  Debido a la obsesi√≥n por garantizar la estabilidad en el trabajo de nuestro servicio, tuve que comenzar a comprender de inmediato c√≥mo funciona k8s y probar varios escenarios de falla.  La mayor√≠a de las preguntas que ten√≠a sobre todo lo relacionado con la red.  Uno de esos problemas resbaladizos es la operaci√≥n de los Servicios en kubernetes. </p><br><p>  La documentaci√≥n nos dice: </p><br><ul><li>  implementar la aplicaci√≥n </li><li>  establecer muestras de vida / preparaci√≥n </li><li>  crear un servicio </li><li>  entonces todo funcionar√°: equilibrio de carga, conmutaci√≥n por error, etc. </li></ul><br><p>  Pero en la pr√°ctica, todo es algo m√°s complicado.  Veamos c√≥mo funciona realmente. </p><a name="habracut"></a><br><h2 id="nemnogo-teorii">  Poco de teor√≠a </h2><br><p>  Adem√°s, quiero decir que el lector ya est√° familiarizado con el dispositivo kubernetes y su terminolog√≠a; solo recordamos qu√© es un servicio. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">El servicio</a> es la esencia de k8s, que describe un conjunto de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">hogares</a> y m√©todos para acceder a ellos. </p><br><p>  Por ejemplo, lanzamos nuestra aplicaci√≥n: </p><br><pre><code class="plaintext hljs">apiVersion: apps/v1 kind: Deployment metadata: name: webapp spec: selector: matchLabels: app: webapp replicas: 2 template: metadata: labels: app: webapp spec: containers: - name: webapp image: defaultxz/webapp command: ["/webapp", "0.0.0.0:80"] ports: - containerPort: 80 readinessProbe: httpGet: {path: /, port: 80} initialDelaySeconds: 1 periodSeconds: 1</code> </pre> <br><pre> <code class="bash hljs">$ kubectl get pods -l app=webapp NAME READY STATUS RESTARTS AGE webapp-5d5d96f786-b2jxb 1/1 Running 0 3h webapp-5d5d96f786-rt6j7 1/1 Running 0 3h</code> </pre> <br><p>  Ahora, para acceder a √©l, debemos crear un servicio en el que determinemos a qu√© canales queremos tener acceso (selector) y en qu√© puertos: </p><br><pre> <code class="plaintext hljs">kind: Service apiVersion: v1 metadata: name: webapp spec: selector: app: webapp ports: - protocol: TCP port: 80 targetPort: 80</code> </pre> <br><pre> <code class="bash hljs">$ kubectl get svc webapp NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE webapp ClusterIP 10.97.149.77 &lt;none&gt; 80/TCP 1d</code> </pre> <br><p>  Ahora podemos acceder a nuestro servicio desde cualquier m√°quina en el cl√∫ster: </p><br><pre> <code class="bash hljs">curl -i http://10.97.149.77 HTTP/1.1 200 OK Date: Mon, 24 Sep 2018 11:55:14 GMT Content-Length: 2 Content-Type: text/plain; charset=utf-8</code> </pre> <br><h2 id="kak-eto-vse-rabotaet">  Como funciona todo </h2><br><img src="https://habrastorage.org/webt/bn/uc/y4/bnucy4fkcptbeo3fwyycr-fc6po.jpeg"><br><p>  Muy simplificado: </p><br><ul><li>  hiciste kubectl aplicar especificaciones de implementaci√≥n </li><li>  ocurre la magia, cuyos detalles no son importantes en este contexto </li><li>  Como resultado, los nodos de trabajo de la aplicaci√≥n resultaron estar en algunos nodos </li><li>  una vez que cada intervalo de kubelet (agente de k8s en cada nodo) realiza muestras de vida / preparaci√≥n de todos los pods que se ejecutan en su nodo, env√≠a los resultados a un servidor (interfaz para los cerebros de k8s) </li><li>  kube-proxy en cada nodo recibe notificaciones de un servidor sobre todos los cambios en los servicios y hogares que participan en los servicios </li><li>  kube-proxy refleja todos los cambios en la configuraci√≥n de los <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">subsistemas subyacentes</a> (iptables, ipvs) </li></ul><br><p>  Para simplificar, considere el m√©todo proxy predeterminado: iptables.  En iptables, tenemos para nuestra ip virtual 10.97.149.77: </p><br><pre> <code class="bash hljs">-A KUBE-SERVICES -d 10.97.149.77/32 -p tcp -m comment --comment <span class="hljs-string"><span class="hljs-string">"default/webapp: cluster IP"</span></span> -m tcp --dport 80 -j KUBE-SVC-BL7FHTIPVYJBLWZN</code> </pre> <br><p>  el tr√°fico va a la <strong>cadena KUBE-SVC-BL7FHTIPVYJBLWZN</strong> , en la que se distribuye entre otras 2 cadenas </p><br><pre> <code class="bash hljs">-A KUBE-SVC-BL7FHTIPVYJBLWZN -m comment --comment <span class="hljs-string"><span class="hljs-string">"default/webapp:"</span></span> -m statistic --mode random --probability 0.50000000000 -j KUBE-SEP-UPKHDYQWGW4MVMBS -A KUBE-SVC-BL7FHTIPVYJBLWZN -m comment --comment <span class="hljs-string"><span class="hljs-string">"default/webapp:"</span></span> -j KUBE-SEP-FFCBJRUPEN3YPZQT</code> </pre> <br><p>  Estas son nuestras vainas: </p><br><pre> <code class="bash hljs">-A KUBE-SEP-UPKHDYQWGW4MVMBS -p tcp -m comment --comment <span class="hljs-string"><span class="hljs-string">"default/webapp:"</span></span> -m tcp -j DNAT --to-destination 10.244.0.10:80 -A KUBE-SEP-FFCBJRUPEN3YPZQT -p tcp -m comment --comment <span class="hljs-string"><span class="hljs-string">"default/webapp:"</span></span> -m tcp -j DNAT --to-destination 10.244.0.11:80</code> </pre> <br><h2 id="testiruem-otkaz-odnogo-iz-podov">  Probar la falla de uno de los hogares </h2><br><p>  Mi aplicaci√≥n de prueba de webapp puede cambiar al modo "error rash", para esto necesita extraer la url "/ err". </p><br><p>  Los resultados de ab -c 50 -n 20,000 en el medio de la prueba tiraron "/ err" en uno de los hogares: </p><br><pre> <code class="bash hljs">Complete requests: 20000 Failed requests: 3719</code> </pre> <br><p>  El punto aqu√≠ no es el n√∫mero espec√≠fico de errores (su n√∫mero variar√° dependiendo de la carga), sino que lo son.  En general, desechamos el "mal" fuera de balance, pero al momento de cambiar el cliente del servicio recibimos errores.  La causa de los errores es bastante f√°cil de explicar: las pruebas de preparaci√≥n se realizan kubelet una vez por segundo + incluso un breve per√≠odo de tiempo para difundir informaci√≥n que no respondi√≥ a la prueba. </p><br><h2 id="pomozhet-li-ipvs-bekend-dlya-kube-proxy-experimental">  ¬øServir√° el backend IPVS para kube-proxy (experimental)? </h2><br><p>  En realidad no!  Resuelve el problema de la optimizaci√≥n del proxy, ofrece un algoritmo de equilibrio personalizado, pero no resuelve el problema del procesamiento de fallas. </p><br><h2 id="kak-byt">  Como ser </h2><br><p>  Este problema solo puede ser resuelto por un equilibrador que pueda reintentar (reintentos).  En otras palabras, para http necesitamos un equilibrador L7.  Dichos equilibradores para kubernetes ya est√°n en pleno uso, ya sea en forma de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ingreso</a> (impl√≠cito como un punto en el movimiento hacia el cl√∫ster, pero en general hace exactamente lo que necesita), o como una implementaci√≥n de una capa separada: una malla de servicio, por ejemplo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">istio</a> . </p><br><p>  En nuestra producci√≥n, todav√≠a no hemos comenzado a utilizar el ingreso ni la malla de servicio debido a la complejidad adicional.  Tales abstracciones, en mi opini√≥n, ayudan en los casos en los que necesita configurar a menudo una gran cantidad de servicios.  Pero al mismo tiempo "paga" la capacidad de control y la infraestructura simple.  Dedicar√° m√°s tiempo a descubrir c√≥mo configurar el rertai y los tiempos de espera para un servicio en particular. </p><br><h2 id="kak-delaem-my">  Como </h2><br><p>  Utilizamos servicios K8 sin cabeza.  Dichos servicios no tienen una ip virtual y, en consecuencia, kube-proxy e iptables no est√°n involucrados en su trabajo.  Para cada uno de estos servicios, puede obtener una lista de hogares en vivo a trav√©s del DNS o de la API. </p><br><p>  Para aplicaciones que interact√∫an con otros servicios, hacemos un contenedor de sidecar con <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">enviado</a> .  Evoy recibe peri√≥dicamente una lista actualizada de pods para todos los servicios necesarios a trav√©s de DNS, y lo m√°s importante, puede volver a intentar las solicitudes de otros pods en caso de error.  Puede ejecutarlo como un DaemonSet en cada nodo, pero si esta instancia falla, todas las aplicaciones que lo usen dejar√°n de funcionar.  Dado que el consumo de recursos de este proxy es bastante peque√±o, decidimos usarlo en la variante de contenedor de sidecar. </p><br><p>  Esto es esencialmente lo que hace istio, pero en nuestro caso el equilibrio se ha desplazado hacia la simplicidad (no es necesario aprender istio, encontrarse con sus errores).  Quiz√°s este equilibrio cambie, y comenzaremos a usar algo como istio. </p><br><p>  <em>Nosotros en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">okmeter.io</a> kubernetes definitivamente hemos echado ra√≠ces, y creemos en su distribuci√≥n adicional.</em>  <em>El soporte para monitorear k8s en nuestro servicio est√° en camino, ¬°estad atentos!</em> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es424229/">https://habr.com/ru/post/es424229/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es424211/index.html">Comprensi√≥n de la interfaz de almacenamiento de contenedores (en Kubernetes y m√°s)</a></li>
<li><a href="../es424215/index.html">Olmo C√≥modo e inc√≥modo</a></li>
<li><a href="../es424217/index.html">Razonamiento para guerras santas, as√≠ como una s√∫plica por la paz</a></li>
<li><a href="../es424223/index.html">Clientes desechables. Segmentaci√≥n para compras repetidas</a></li>
<li><a href="../es424227/index.html">Distribuya uniformemente los puntos a trav√©s de la esfera en pytorch y tensorflow</a></li>
<li><a href="../es424231/index.html">C√≥mo ganar dinero con los hosters</a></li>
<li><a href="../es424233/index.html">Computadora ense√±ada a detectar demencia con una precisi√≥n del 93%</a></li>
<li><a href="../es424235/index.html">C√≥mo usar STATSPACK en lugar de AWR en Oracle Standard Edition</a></li>
<li><a href="../es424237/index.html">¬°Carga tus cerebros directamente! Tiempos de ejecuci√≥n, compiladores y rendimiento en Joker 2018</a></li>
<li><a href="../es424239/index.html">Seminarios de oto√±o de IBM: Contenedores, Visi√≥n por computadora, Transformaci√≥n digital</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>