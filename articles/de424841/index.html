<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üè´ ü§ôüèª üîç Speichern Sie ein Bildarchiv f√ºr eine Site im Azure BLOB-Speicher üõê üßëüèø‚Äçü§ù‚Äçüßëüèº üë®üèø‚Äçüöí</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Der Artikel beschreibt die Erfahrung beim Organisieren der Budgetspeicherung eines Bildarchivs f√ºr eine Website mit Millionen von Anzeigen. 



 In me...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Speichern Sie ein Bildarchiv f√ºr eine Site im Azure BLOB-Speicher</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/424841/"> Der Artikel beschreibt die Erfahrung beim Organisieren der Budgetspeicherung eines Bildarchivs f√ºr eine Website mit Millionen von Anzeigen. <br><br><img src="https://habrastorage.org/webt/9c/_6/sg/9c_6sgzywejobg-vzsrzgazv7_w.png"><br><a name="habracut"></a><br>  In meinem Fall werden Bilder als Fotografien von Wohnungen, H√§usern, Grundst√ºcken usw. verstanden.  Ich habe mein <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">eigenes Projekt</a> , eine Website mit Anzeigen f√ºr den Verkauf und die Vermietung von Immobilien.  Die Website gibt es seit ungef√§hr 6 Jahren und in dieser Zeit hat sich eine ziemlich gro√üe Anzahl von Anzeigen angesammelt.  Auf jeder Objektkarte werden Fotos angezeigt, durchschnittlich 8 Fotos pro Anzeige.  Eigentlich werde ich diese Fotos in der Cloud speichern, damit ich sie sp√§ter den Besuchern auf Objektkarten zeigen kann. <br><br>  Wie habe ich sie vorher aufbewahrt?  - Auf keinen Fall.  Ich habe keine Bilder aufbewahrt, au√üer denen, die manuell platziert wurden.  In den meisten F√§llen gelangen Anzeigen √ºber Partner √ºber den automatischen Feed-Upload auf die Website.  Im Feed f√ºr jedes Objekt gibt es Links zu Fotos - ich speichere die Links und gebe dem Besucher ein Foto direkt vom Partner.  Diese Schaltung funktioniert hervorragend und spart eine Menge Ressourcen. <br><br>  Die Fotos, die Besucher in der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Auswahl der Anzeigen</a> oder auf der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Karte</a> des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Objekts sehen,</a> werden tats√§chlich aus Ressourcen von Drittanbietern geladen. <br><br>  Es gibt eine Einschr√§nkung in Bezug auf die Besonderheiten der Site: Archivobjekte werden niemals gel√∂scht.  Das hei√üt,  Nachdem die Anzeige aus der Ver√∂ffentlichung entfernt wurde, verschwindet sie zwar aus den Suchergebnissen, der direkte Link ist jedoch immer verf√ºgbar (ohne die Kontakte des Verk√§ufers).  Seit einiger Zeit leben noch Links zu Fotografien, manchmal jahrelang, aber fr√ºher oder sp√§ter sterben sie.  Archivierte Objekte sind wertvoll, da Besucher von Suchmaschinen weiterhin zu ihnen kommen.  Au√üerdem wird aus dem Archiv <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">eine Preiskarte erstellt</a> (ich habe bereits dar√ºber <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">geschrieben</a> ), und ich habe versehentlich eine zus√§tzliche Einnahmequelle f√ºr das Projekt in Form des Verkaufs von Kontaktinformationen von Archivobjekten entdeckt.  Warum sie sie kaufen, wei√ü ich nicht genau, aber ich nehme an, dass Besucher Kontakte erhalten m√∂chten, weil sie der Meinung sind, dass die Werbung versehentlich oder versehentlich aus der Ver√∂ffentlichung entfernt wurde.  Es kommt wahrscheinlich auch vor, dass sie etwas von den Vorbesitzern lernen wollen.  Auf die eine oder andere Weise wird in diesem Fall eher eine Anzeige mit Fotos gekauft.  Der Wert von Fotografien steigt nach Kenntnis dieser Nuance. <br><br>  Die Datenmenge, die ich in der Cloud speichern werde, betr√§gt ca. 3-4 Terabyte.  Plus ein t√§glicher Gewinn von mehreren Gigabyte.  Da diese Innovation kein direktes Geld bringt, kann sie nur indirekt die Entscheidungsfindung des Besuchers beeinflussen. Das Budget, in dem ich ein sehr bescheidenes treffen wollte, betr√§gt 1000-2000 r.  im Monat.  Es w√§re √ºberhaupt kostenlos, aber ich habe keine solche Gelegenheit gefunden. <br><br><h2>  Azure </h2><br>  Ich habe mich sofort nach Azure umgesehen, weil ich an .net arbeite und oft sch√∂ne Werbeartikel zu diesem Thema sehe.  Au√üerdem muss ich diese Plattform f√ºr meine Hauptaufgabe verwenden, aber dort sind meine F√§higkeiten durch die Anforderungen des Unternehmens und die W√ºnsche des Managements begrenzt. <br><br>  Azure bietet BLOB-Speicher mit drei Speicherebenen: Hot, Cool und Archive.  Die Preise auf allen Ebenen sind unterschiedlich.  Im Allgemeinen gilt: Je hei√üer, desto billiger das Lesen / Schreiben und desto teurer die monatliche Speichergeb√ºhr und umgekehrt.  On Hot - es ist rentabel, viel zu schreiben / lesen und zu l√∂schen, aber es ist teuer, es f√ºr eine lange Zeit zu speichern.  Archiv ist billig zu speichern, aber teuer zu lesen / schreiben.  Auf Archiv- und Cold-Ebene wird eine Geb√ºhr f√ºr das vorzeitige L√∂schen erhoben. Dies bedeutet, dass mir f√ºr den gesamten Zeitraum eine Geb√ºhr berechnet wird, wenn ich ein Objekt vor einem bestimmten Zeitraum l√∂sche (oder auf eine andere Ebene √ºbertrage).  F√ºr die Archivebene sind dies 180 Tage, f√ºr die K√§lte 30. <br><br><h2>  Preise </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Die Speicherkosten</a> betragen 0,0023 USD pro GB und Monat auf Archivebene, 0,01 USD bei K√§lte und 0,0196 USD bei Hitze.  Bei der aktuellen Rate sind dies ungef√§hr 0,15, 0,65 bzw. 1,28 Rubel. <br><br>  Ich habe im Vergleich zu den Kosten bei Amazon und Google festgestellt, dass Azure billiger ist. <br><br><table><tbody><tr><td></td><td>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Azure</a></b> </td><td>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Amazon (S3)</a></b> </td><td>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Google</a></b> </td></tr><tr><td>  <b>Hei√ü</b> </td><td>  0,0196 USD </td><td>  $ 0,024 </td><td>  $ 0,026 </td></tr><tr><td>  <b>Cool</b> </td><td>  0,01 $ </td><td>  0,01 $ </td><td>  0,01 $ </td></tr><tr><td>  <b>Archiv</b> </td><td>  0,0023 USD </td><td>  0,0045 USD </td><td>  0,007 USD </td></tr></tbody></table><br><br>  Neben den Lagerkosten m√ºssen auch die Betriebskosten ber√ºcksichtigt werden - sie sind auch auf allen Ebenen unterschiedlich.  Die Preise gelten f√ºr 10.000 Transaktionen. <br><br>  <b>Hei√ü</b> <br>  Lesen: $ 0,0043, Schreiben: $ 0,054 <br><br>  <b>Cool</b> <br>  Lesen: 0,01 $, Schreiben: 0,10 $ <br><br>  <b>Archiv</b> <br>  Lesen: $ 6, Schreiben: $ 0,12 <br><br><h2>  Arbeitslogik </h2><br><br>  W√§hrend die Anzeige aktiv ist, werden die darin enthaltenen Fotos durch Links von Ressourcen Dritter (von Partnern) angezeigt.  Nachdem die Ank√ºndigung aus der Ver√∂ffentlichung entfernt wurde, wird sie archiviert, aber Links zu Fotos sind noch einige Zeit lebendig.  Fr√ºher oder sp√§ter sterben sie, und Sie m√ºssen sicherstellen, dass zu diesem Zeitpunkt eine Archivkopie vorhanden ist. <br><br>  Der Prozess der Verarbeitung von Fotos kann in den folgenden Schritten beschrieben werden: <br><br><ol><li>  Sobald die Anzeige aus der Partnerimportdatei verschwindet, d.h.  Wenn der Partner die Ver√∂ffentlichung beendet hat, wird ein Eintrag in der Priorit√§tswarteschlange gebildet, wobei die Priorit√§t die Anzahl der Ansichten der Besucher ist. Je mehr Ansichten, desto wahrscheinlicher ist es, dass das Objekt archiviert und weiter angezeigt wird. </li><li>  Bei der Verarbeitung eines Datensatzes aus der Warteschlange wird ein BLOB-Objekt gebildet, das reduzierte (bis zu 800 x 600) Fotos f√ºr die Werbung enth√§lt.  Die Verwendung von zusammengesetzten Objekten anstelle von direkten Fotos ist ebenfalls auf Einsparungen zur√ºckzuf√ºhren - anstelle von 8 Aufnahmevorg√§ngen (durchschnittlich 8 Fotos pro Objekt) wird einer ausgef√ºhrt, und jeder Vorgang kostet Geld. </li><li>  BLOB wird zuerst in Hot geladen und dann sofort in das Archiv √ºbertragen.  Es gibt keine M√∂glichkeit, direkt in das Archiv zu schreiben. Da f√ºr Cool eine Geb√ºhr f√ºr die vorzeitige L√∂schung erhoben wird, ist es billiger, Hot als Transit zu verwenden. </li><li>  Das BLOB-Archiv ist so lange g√ºltig, wie die Links zu den Originalfotos aktiv sind (Fotos werden bisher durch Links von Partnern angezeigt). </li><li>  Die Links werden auf Funktionalit√§t √ºberpr√ºft, wenn der Besucher die Karte des Objekts besucht. Wenn er sie besucht, ist das Objekt beliebt und es ist sinnvoll, Fotos aus dem Archiv wiederherzustellen. </li><li>  Wenn die Links zu den Originalfotos nicht mehr vorhanden sind, √ºberpr√ºfe ich, ob eine Archivkopie vorhanden ist, und sende in diesem Fall eine Anforderung zur Wiederherstellung aus dem Archiv an Cool (es kann bis zu 15 Stunden dauern, bis ein Blob aus dem Archiv wiederhergestellt ist - dies wird als Rehydration von Microsoft bezeichnet). </li><li>  Sobald das BLOB aus dem Archiv wiederhergestellt wurde, wird es in den lokalen Speicher kopiert und in normale Fotos unterteilt.  Lokaler Speicher ist die Festplatte meines Servers. </li><li>  Fotos auf der Ank√ºndigungskarte stammen bereits aus dem lokalen Speicher. </li><li>  Fotos werden mehrere Tage im lokalen Speicher gespeichert.  Wenn w√§hrend dieser Zeit Scans durchgef√ºhrt wurden, wird die lokale Speicherdauer verl√§ngert.  Wenn keine Ansichten vorhanden waren, werden die Fotos aus dem lokalen Speicher gel√∂scht, bleiben jedoch in Azure auf der Stufe "Cool". </li><li>  Von Cool zu Archiv werden sie kopiert, wenn zwei Monate lang keine Ansichten vorhanden waren - das Objekt ist eindeutig nicht beliebt und es ist daher nicht sinnvoll, die Speicherung in Cool zu viel zu bezahlen. </li></ol><br><br><h2>  Erster Start </h2><br>  Als der Prozess geschrieben und getestet wurde, war es Zeit f√ºr den Testbetrieb, und es wurden Probleme erwartet.  In der Warteschlange befanden sich zu dieser Zeit ungef√§hr 10 Millionen Objekte. Ich beschloss, die Migration von 30.000 Objekten pro Tag zu starten.  Richten Sie sch√∂ne Grafiken auf dem Armaturenbrett ein und beginnen Sie zu beobachten.  In der Statistik sah ich seltsame "Ausfallschritte" bei GetBlobProperties-Anfragen.  Sie treten in einem ungef√§hr gleichen Intervall von einer Stunde auf, beginnen immer ungef√§hr eineinhalb Stunden nach Beginn der Migration und dauern einige Zeit nach deren Abschluss. <br><br><img src="https://habrastorage.org/webt/wm/qx/qr/wmqxqrsvn7zctu-xyulyvr-25wu.png"><br><br>  Die Anzahl solcher Anfragen war zu gro√ü, um sie zu ignorieren.  Ich habe mir die Protokolle angesehen und festgestellt, dass diese Anforderungen nicht von meinem Server, sondern von fremden IP-Adressen stammen.  Ich wollte sie √ºberhaupt nicht bezahlen. <br><br>  Ich habe auf dem Stapel und in der Dokumentation gesucht, aber ohne Erfolg.  Schrieb eine <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Frage zu Stackoverflow</a> und technischem Support.  Infolgedessen haben sie mir nach einer langen Korrespondenz mit dem technischen Support und der Bereitstellung von Protokollen mitgeteilt, dass sie die Situation reproduzieren k√∂nnen, und dies ist ein Fehler auf ihrer Seite. <br><br>  Eine interessante Nuance ist, dass meine Frage zu Stackoverflow beantwortet wurde, ohne die Gr√ºnde zu erl√§utern, sondern nur um zu best√§tigen, dass ich f√ºr diese Anfragen bezahlen werde, aber die Person, die die Antwort gegeben hat, hat mich eindringlich gebeten, sie als richtig zu markieren.  Er hat mir im Vorbeigehen auch angedeutet, dass sie (zur Unterst√ºtzung) nicht gerne √ºber Fehler in ihren eigenen Produkten berichten k√∂nnen.  Ich habe ihn wissen lassen, dass ich es nicht tun werde, bis er die Wahrheit schreibt.  Ich k√∂nnte das selbst schreiben, aber ich dachte, dass die Mitarbeiter des technischen Supports wahrscheinlich die Anzahl der best√§tigten Antworten gemessen haben, also bat ich ihn, den wahren Grund zu schreiben, und in diesem Fall markiere ich seine Antwort als richtig.  Nach einigem Z√∂gern stimmte er zu und erg√§nzte seinen Kommentar mit einem Fehlerbericht.  Im Allgemeinen hat mir gefallen, wie der technische Support funktioniert - ich wurde sogar zu einem russischen M√§dchen versetzt, das mich immer noch √ºber √Ñnderungen in diesem Bereich auf dem Laufenden h√§lt. <br><br>  Die Tatsache, dass der Fehler erkannt wurde, befriedigte mich nur moralisch, aber ich wollte den Mechanismus in Betrieb nehmen und gleichzeitig kein Geld f√ºr linksh√§ndige Anfragen bezahlen.  Besonders wenn man bedenkt, dass ich normalerweise verwirrt war, um die Anzahl der Anfragen und damit die Kosten zu minimieren. <br><br>  Im technischen Support wurde mir geraten, mit dem Start zu warten, und nach ein paar Wochen wurde geschrieben, dass der Fehler behoben wurde, aber wann die Ver√∂ffentlichung mit dem Fix sein wird, ist nicht bekannt.  Sie boten an, die Protokollierung zu aktivieren und so zu arbeiten, und forderten nach der Ver√∂ffentlichung eine Entsch√§digung bei Microsoft an.  In diesem Modus funktioniert es tats√§chlich immer noch.  Jeden Tag starte ich eine Migration einer kleinen Anzahl von Objekten und warte auf die Ver√∂ffentlichung. <br><br><h2>  Fazit </h2><br>  Die Kosten f√ºr t√§glich 30.000 Objekte betragen immer noch 900 p.  pro Monat - und das ist durchaus akzeptabel.  Die meisten Ausgaben sind Schreibvorg√§nge.  Wenn also die gesamte Warteschlange verarbeitet wird und die Phase der geplanten Arbeit beginnt, ist klar, wie hoch die tats√§chlichen Kosten eines solchen Speichers sind.  Aber nach meinen Berechnungen wird dies in ungef√§hr einem Jahr geschehen. <br><br>  Wenn es eine Ver√∂ffentlichung im Azure Blob-Speicher geben wird, werde ich hier hinzuf√ºgen, ob es mir gelungen ist, eine Entsch√§digung zu erhalten.  Bei den monatlichen Ausgaben sind dies etwa 10% der Kosten. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de424841/">https://habr.com/ru/post/de424841/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de424823/index.html">Wie kalorienarme Ern√§hrung das Altern beeinflusst</a></li>
<li><a href="../de424825/index.html">Roboter und Kommunismus</a></li>
<li><a href="../de424827/index.html">Die Illusion von Raum: Wie der neue Spiderman R√§ume ohne Geometrie rendert</a></li>
<li><a href="../de424831/index.html">Was ist in die digitale Wirtschaft investiert</a></li>
<li><a href="../de424835/index.html">So reduzieren Sie das Risiko von Investitionen an der B√∂rse: 3 Diversifizierungsfaktoren</a></li>
<li><a href="../de424843/index.html">Ist IBOutlet in Ihren iOS-Apps privat?</a></li>
<li><a href="../de424845/index.html">Berechnung magischer Quadrate mit einer GPU</a></li>
<li><a href="../de424847/index.html">MNaaS und eSIM - Vor- und Nachteile der Virtualisierung f√ºr Mobilfunkbetreiber und deren Kunden</a></li>
<li><a href="../de424849/index.html">Was macht den neuen UCS C480 ML M5 interessant - Server f√ºr maschinelles Lernen von Cisco</a></li>
<li><a href="../de424851/index.html">Was ist falsch daran, IT einzustellen?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>