<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü•ê üîº üîä Wir bearbeiten Bestellungen aus dem Online-Shop mit RabbitMQ und TypeScript üë¶üèæ üõê ü§æüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hallo allerseits! Die Popularit√§t des Internethandels w√§chst stetig, ebenso wie der Anteil der Informatisierung aller Arten von Aktivit√§ten im Zusamme...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Wir bearbeiten Bestellungen aus dem Online-Shop mit RabbitMQ und TypeScript</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/469991/"><p><img src="https://habrastorage.org/webt/wh/2y/cv/wh2ycv5atat_nuru35jo5pwfo08.jpeg"></p><br><p>  Hallo allerseits!  Die Popularit√§t des Internethandels w√§chst stetig, ebenso wie der Anteil der Informatisierung aller Arten von Aktivit√§ten im Zusammenhang mit dem Handel.  Gleichzeitig w√§chst die Komplexit√§t der Informationsverarbeitung.  Jede Bestellung eines Kunden eines Online-Shops generiert eine gro√üe Anzahl von Integrationen mit verschiedenen Diensten.  Solche Dienstleistungen k√∂nnen Zahlungsabwicklungs-, Liefer-, Buchhaltungs- und Loyalit√§tsdienste umfassen.  Jede Bestellung muss bezahlt, aufgezeichnet, zusammengestellt und geliefert werden und auch f√ºr weitere Analysen zur Verf√ºgung stehen.  Dies und damit keine einfache Situation wird durch die Tatsache erschwert, dass ein Benutzer eines Online-Shops bei der Bestellung nicht lange und schmerzhaft auf etwas warten m√∂chte.  Die Antwort des Online-Shops sollte schnell sein, da jede Millisekunde Verz√∂gerung die Wahrscheinlichkeit erh√∂ht, einen Kunden zu verlieren und anschlie√üend zu profitieren.  In diesem Artikel m√∂chte ich √ºber den RabbitMQ-Nachrichtenbroker und dessen Verwendung zur Organisation der Auftragsabwicklung mithilfe von Node.js und TypeScript sprechen.  Willkommen bei Katze. </p><a name="habracut"></a><br><h2 id="neobhodimaya-teoriya">  Die notwendige Theorie </h2><br><p>  Ich denke, viele haben von RabbitMQ geh√∂rt, weil die erste Open-Source-Version dieses Nachrichtenbrokers, die auf dem AMQP-Protokoll basiert, bereits 2007 ver√∂ffentlicht wurde.  Ein Nachrichtenbroker wird ben√∂tigt, um verschiedene Komponenten des Systems zu einem Ganzen zu verbinden, da Klebstoff ben√∂tigt wird, um eine kaputte Vase wiederzubeleben.  Mit dem Nachrichtenbroker k√∂nnen Sie die asynchrone Verarbeitung von im System empfangenen Ereignissen implementieren.  Es ist eine solche asynchrone Auftragsabwicklung, die der Online-Shop ben√∂tigt.  Aber zuerst m√ºssen Sie die grundlegenden Komponenten von RabbitMQ verstehen.  Dieser Broker besteht aus drei Hauptkomponenten, mit denen wir den Verarbeitungsprozess erstellen: </p><br><ul><li>  <strong>Nachricht</strong>  Dies ist die kleinste Informationseinheit innerhalb des Nachrichtenbrokers und unseres Verarbeitungsdienstes, die verarbeitet werden kann.  RabbitMQ selbst speichert Nachrichten in bin√§rer Form, aber f√ºr unser System und f√ºr den Artikel ist dies nicht wichtig.  Wir werden Nachrichten in Form von JSON empfangen und verarbeiten.  Erw√§hnenswert ist auch, dass Nachrichten in RabbitMQ Header haben.  Sie √§hneln den Headern von http-Anforderungen.  Dies ist ein assoziatives Array, in das Sie die erforderlichen Informationen schreiben k√∂nnen. </li><li>  <strong>Nachrichtenwarteschlange</strong> .  Dies ist die Warteschlange, in der RabbitMQ Nachrichten speichert.  Eine Nachrichtenwarteschlange kann von einem oder mehreren Verbrauchern abonniert werden.  Jede Nachricht in der Kaninchenwarteschlange wird mithilfe des Round-Robin-Algorithmus an die Verbraucher verteilt. </li><li>  <strong>Austausch</strong>  Dies ist, wie der Name schon sagt, ein Austauschpunkt.  An diesem Punkt k√∂nnen Warteschlangen oder andere Austauscher angebracht werden.  Ein Austauschpunkt speichert keine Nachrichten. Seine Hauptfunktion besteht darin, Nachrichten an eine oder mehrere Warteschlangen oder an dieselben Austauschpunkte weiterzuleiten.  Jede Warteschlange oder jeder Austauscher ist an einen Routing-Schl√ºssel gebunden.  In RabbitMQ gibt es verschiedene Arten von Austauschern, die sich darauf auswirken, wie genau der Austausch die darin empfangene Nachricht weiterleitet. </li></ul><br><p>  Um zu beschreiben, wie verschiedene Arten von Austauschern funktionieren, muss man verstehen, was Routing-Schl√ºssel sind.  Der Routing-Schl√ºssel befindet sich sowohl in der Bindung der Warteschlange an den Austauscher als auch in der Nachricht selbst.  <strong>Der Routing-Schl√ºssel</strong> ist nur eine Zeichenfolge, die in Bl√∂cke unterteilt ist.  Jeder Block ist durch einen Punkt getrennt.  Zum Beispiel "notify.sendEmail.sendSms".  Gleichzeitig k√∂nnen Muster f√ºr den Nachrichtenweiterleitungsschl√ºssel mit den Sonderzeichen # und * festgelegt werden.  * - sagt, dass nach einem Punkt jeder Block gehen kann, aber nach # eine beliebige Anzahl von Bl√∂cken gehen kann.  Zum Beispiel "notify.sendSms. *" Oder "notify. #".  Jetzt k√∂nnen Sie zu den Arten von Austauschpunkten √ºbergehen. </p><br><p>  Es gibt vier Arten von Austauschern: </p><br><ul><li>  <strong>Fanout</strong>  Die Routing-Logik dieses Austauschs ist einfach: Sie leitet eine eingehende Nachricht an alle damit verbundenen Warteschlangen oder Austauscher um. </li></ul><br><p><img src="https://habrastorage.org/webt/iw/f5/ib/iwf5ibz1b-6-qqhby_z_kqope9e.png"></p><br><ul><li>  <strong>Direkt</strong>  Dieser Austausch leitet die Nachricht um, abh√§ngig davon, ob der Routing-Schl√ºssel der Nachricht mit dem Routing-Schl√ºssel der Bindung √ºbereinstimmt. </li></ul><br><p><img src="https://habrastorage.org/webt/vu/pm/ia/vupmiavbtemxaxoecqcuklmpvqe.png"></p><br><ul><li>  <strong>Thema</strong>  Exchange dieses Typs sowie Direct leiten die Nachricht abh√§ngig vom Routing-Schl√ºssel weiter.  Ein Muster kann jedoch als Routing-Schl√ºssel fungieren. </li></ul><br><p><img src="https://habrastorage.org/webt/yz/h4/ug/yzh4ug3abx7ywf9ex-bei3k20oe.png"></p><br><ul><li>  <strong>√úberschriften</strong> .  Dieser Austausch verwendet im Gegensatz zu den anderen Nachrichtenkopfzeilen f√ºr das Routing.  Gleichzeitig werden Warteschlangen an den Austauscher auch √ºber ein assoziatives Array gebunden.  Die Logik, mit der der Austauscher Nachrichten weiterleitet, kann mithilfe des speziellen Schl√ºssels ‚Äûx-match‚Äú ge√§ndert werden, der im assoziativen Bindungsarray festgelegt ist.  Der Schl√ºssel kann auf zwei oder alle Werte eingestellt werden.  Wenn der Wert alle ist, m√ºssen die Nachrichtenkopfzeilen vollst√§ndig mit dem assoziativen Bindungsarray √ºbereinstimmen. Wenn der Wert einer ist, muss der Wert mit mindestens einem Schl√ºssel √ºbereinstimmen. </li></ul><br><p><img src="https://habrastorage.org/webt/gq/pd/gm/gqpdgmxxipjwviioorrzouqdj0o.png"></p><br><p>  Dies sind die Kernkomponenten von RabbitMQ.  Weitere Informationen zu diesen Komponenten finden Sie in <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">der AMQP-Protokollspezifikation</a> .  Als N√§chstes entwerfen und implementieren wir ein Auftragsabwicklungssystem am Beispiel von TypeScript und verstehen gleichzeitig die Einstellungen der einzelnen Komponenten. </p><br><h2 id="proektirovanie">  Design </h2><br><p>  Um das Beispiel zu vereinfachen, gehen wir davon aus, dass wir f√ºr die erfolgreiche Bearbeitung einer Online-Bestellung √ºber folgende Funktionen verf√ºgen m√ºssen: </p><br><ul><li>  Eingehende Bestellungen speichern </li><li>  Senden Sie dem Kunden eine SMS mit der Bestellnummer sowie dem Status der Bestellung </li><li>  Senden Sie eine Nachricht an den Kurierdienst √ºber eine neue Bestellung aus unserem Online-Shop, wenn der Kunde diese Versandmethode gew√§hlt hat </li></ul><br><p>  Die Implementierung dieser Funktionalit√§t reicht jedoch nicht aus, da unser Online-Shop plant, die Funktionalit√§t zu erweitern und seinen Kunden in Zukunft mehr verschiedene M√∂glichkeiten zu bieten (und dies geschieht immer).  Benachrichtigen Sie beispielsweise den Kunden per E-Mail oder w√§hlen Sie verschiedene Versandmethoden f√ºr die Bestellung aus.  Daraus folgt, dass wir das System so gestalten m√ºssen, dass das Hinzuf√ºgen von Funktionen einfach war. </p><br><p>  Es ist auch erw√§hnenswert, dass ich die Vorlage f√ºr zur√ºckgestellte Nachrichten verwenden werde, damit es m√∂glich ist, die Logik mehrmals zu wiederholen, wenn der externe Dienst nicht verf√ºgbar ist.  √úber diese Vorlage k√∂nnen Sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> lesen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">.</a> </p><br><p>  Um das Endziel klarer darzustellen, werde ich ein Diagramm zeichnen. </p><br><p><img src="https://habrastorage.org/webt/mu/bz/ji/mubzjikeu0b35eac4e_qj0rxdt4.png"></p><br><p>  Lassen Sie uns sehen, wie der Auftragsabwicklungsprozess in diesem Diagramm funktioniert.  Das Schema ist in Bl√∂cke und verschiedene Farben unterteilt.  Wei√üe Bl√∂cke kennzeichnen externe Dienste, die wir nicht ber√ºcksichtigen werden.  Graue Bl√∂cke zeigen RabbitMQ-Elemente an.  Warteschlangen und Austauscher.  Die gr√ºne Farbe spiegelt die Bl√∂cke der Gesch√§ftslogik wider, die implementiert werden m√ºssen.  Au√üerdem ist jeder Block, der sich auf unsere Logik bezieht, nummeriert.  Die Zahlen geben den Prozess und den Teilprozess in der Reihenfolge an. </p><br><p>  Zun√§chst wird die HTTP-API-Nachricht in unseren Dienst aufgenommen.  Danach m√ºssen wir der Bestellung eine Nummer zuweisen, die Bestellung in der Datenbank mit dem Status ‚ÄûNeu‚Äú speichern und eine Antwort √ºber die erfolgreiche Erstellung der Bestellung mit ihrer Nummer zur√ºcksenden.  Der Kunde, der eine Nachricht √ºber die erfolgreiche Erstellung des Auftrags erhalten hat, geht seinem eigenen Gesch√§ft nach.  Durch das Senden einer positiven Antwort senden wir das Auftragsobjekt an die Nachbearbeitungsb√∂rse, von der es in den Mitarbeiter der Routing-Schl√ºsselformation f√§llt.  Dieser Mitarbeiter, der das Bestellobjekt aus der Warteschlange erhalten hat (unabh√§ngig davon, ob die Bestellung eine E-Mail oder ein Kundentelefon enth√§lt, welche Versandmethode ausgew√§hlt wurde), muss den Bestellungsrouting-Schl√ºssel bilden.  Nachdem der Mitarbeiter einen Routing-Schl√ºssel gebildet hat, sendet er eine Nachricht zur√ºck an die Nachbearbeitungsb√∂rse. Jetzt hat sich der Routing-Schl√ºssel der Bestellung ge√§ndert und der Austauscher kann ihn bereits auf der gew√ºnschten Route senden.  Abh√§ngig vom Schl√ºssel kann die Bestellung an den Austausch gesendet werden, der f√ºr Benachrichtigungen, Austauschintegrationen oder beides gleichzeitig verantwortlich ist.  Und weiter die gleiche Logik in einer Warteschlange und Arbeiter. </p><br><p>  SMS-Mitarbeiter und Zustelldienste versuchen mehrmals, die Nachricht zu verarbeiten.  Die Anzahl solcher Versuche kann in einer Umgebungsvariablen √ºbergeben werden.  Sie sollten die Nachricht jedoch nicht endlos verarbeiten, da der Fehler m√∂glicherweise in der Nachricht selbst oder in der Logik des Arbeiters liegt.  Daher wird die Nachricht nach √úberschreiten der Anzahl der zul√§ssigen Versuche aus den Warteschlangen gel√∂scht und an den Fehlerspeicher gesendet, von dem aus sie erneut an die gew√ºnschte Verarbeitungsebene zur√ºckgesendet werden kann. </p><br><h2 id="realizaciya">  Implementierung </h2><br><p>  Um die Implementierung zu √ºberpr√ºfen, ben√∂tigen Sie Kaninchen selbst.  Ich empfehle, zu diesem Zweck Docker und ein offizielles Broker-Image zu verwenden.  Installieren Sie den Container und f√ºhren Sie ihn mit dem folgenden Befehl aus. </p><br><pre><code class="bash hljs">docker run -d --name rabbit -p 5672:5672 -e rabbitmq:3.7.15-management-alpine</code> </pre> <br><p>  Dies ist ein Image mit einer Webschnittstelle, die an Port 15672 zum bequemen Debuggen verf√ºgbar ist. </p><br><p>  Wir werden unsere Pl√§ne mit TypeScript und der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">amqplib-</a> Bibliothek (RabbitMQ-Client-Implementierung f√ºr Node.js) implementieren. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Daher</a> m√ºssen Sie zun√§chst mehrere Schnittstellen beschreiben.  Wir beschreiben die Schnittstellen der Bestellung und die Nachrichten, die wir an Kaninchen senden. </p><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//    export interface Product { id: string; name: string; price: number; } //    export interface Order { clientName: string; city: string; email?: string; phone?: string; products: Product[]; totalSum: number; deliveryAddress?: string; } //         export interface OrderWithPhone extends Order { phone: string; } //        export interface OrderWithDeliveryAddress extends Order { deliveryAddress: string; } // Types Guard'        export const isOrderWithPhone = (order: Order): order is OrderWithPhone =&gt; Boolean(order.phone); export const isOrderWithDeliveryAddress = (order: Order): order is OrderWithDeliveryAddress =&gt; Boolean(order.deliveryAddress); //    . export interface Message&lt;O extends Order&gt; { errors: string[]; retry: number; order: O; //         export interface FailOrder extends Message&lt;Order&gt; { exchange: string; routingKey: string; }</span></span></code> </pre> <br><p>  Nun m√ºssen wir die Konfigurationsschnittstelle von Warteschlangen und Austauschern beschreiben, auf deren Grundlage wir die Verarbeitungsstruktur in Kaninchen aufbauen werden. </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Types, ExchangeTypes } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../constants'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Options } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'amqplib'</span></span>; <span class="hljs-comment"><span class="hljs-comment">//   RabbitMQ       export enum Types { QUEUE = 'queue', EXCHANGE = 'exchange', } //      export enum ExchangeTypes { TOPIC = 'topic', } //    export interface Queue { name: string; options: Options.AssertQueue; } //    export interface Exchange { name: string; type: ExchangeTypes; } //    export interface Binding { type: Types; destination: string; source: string; routingKey: string; } //   RabbitMQ export interface PipelineConfig { queues: Queue[]; exchanges: Exchange[]; bindings: Binding[]; }</span></span></code> </pre> <br><p>  Nachdem wir die Hauptkomponenten des Systems beschrieben haben, beschreiben wir die Konfiguration, die mit dem Objekt im Diagramm gezeichnet wurde. </p><br><p>  Warteschlangen </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> [ <span class="hljs-comment"><span class="hljs-comment">//        routingKey { name: 'generateRoutingKey', options: { durable: true, }, }, //   sms { name: 'sendSms', options: { durable: true, }, }, //      { name: 'delivery', options: { durable: true, }, }, //         sms { name: 'sendSmsHold', options: { durable: true, deadLetterExchange: 'notify', deadLetterRoutingKey: 'sendSms', messageTtl: 60000, }, }, //            { name: 'deliveryHold', options: { durable: true, deadLetterExchange: 'integrates', deadLetterRoutingKey: 'delivery', messageTtl: 60000, }, }, ];</span></span></code> </pre> <br><p>  Bei der Beschreibung von Warteschlangen werden die folgenden Optionen f√ºr die Warteschlange verwendet. </p><br><ul><li>  <strong>langlebig</strong> .  Standardm√§√üig werden alle Warteschlangennachrichten im Speicher gespeichert.  Daher werden beim Neustart des Brokers Nachrichten ausgeblendet.  Um dies zu vermeiden, k√∂nnen Sie diese Option verwenden.  Mit dieser Einstellung sp√ºlt Rabbit Nachrichten auf die Festplatte.  Aber es gibt eine Einschr√§nkung.  Damit Nachrichten nach dem Neustart des Brokers gespeichert werden, reicht diese Einstellung nicht aus. Nachrichten m√ºssen mit der Option persistent an die Warteschlange gesendet werden. </li><li>  <strong>messageTtl</strong> .  Die Lebensdauer der Nachricht.  In Millisekunden angegeben </li><li>  <strong>deadLetterExchange</strong> .  Der Name des Austauschers, an den die Nachricht nach Ablauf der Warteschlange gesendet wird </li><li>  <strong>deadLetterRoutingKey</strong> .  RoutingKey, mit dem die Nachricht von der vorherigen Option an den Austauscher gesendet wird </li></ul><br><p>  B√∂rsen </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { ExchangeTypes } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../constants'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> [ { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'postprocessing'</span></span>, <span class="hljs-attr"><span class="hljs-attr">type</span></span>: ExchangeTypes.TOPIC, }, { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'notify'</span></span>, <span class="hljs-attr"><span class="hljs-attr">type</span></span>: ExchangeTypes.TOPIC, }, { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'integrates'</span></span>, <span class="hljs-attr"><span class="hljs-attr">type</span></span>: ExchangeTypes.TOPIC, }, ];</code> </pre> <br><p>  Bindungen </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Types } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../constants'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> [ { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: Types.EXCHANGE, <span class="hljs-attr"><span class="hljs-attr">destination</span></span>: <span class="hljs-string"><span class="hljs-string">'notify'</span></span>, <span class="hljs-attr"><span class="hljs-attr">source</span></span>: <span class="hljs-string"><span class="hljs-string">'postprocessing'</span></span>, <span class="hljs-attr"><span class="hljs-attr">routingKey</span></span>: <span class="hljs-string"><span class="hljs-string">'#.notify.#'</span></span>, }, { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: Types.EXCHANGE, <span class="hljs-attr"><span class="hljs-attr">destination</span></span>: <span class="hljs-string"><span class="hljs-string">'integrates'</span></span>, <span class="hljs-attr"><span class="hljs-attr">source</span></span>: <span class="hljs-string"><span class="hljs-string">'postprocessing'</span></span>, <span class="hljs-attr"><span class="hljs-attr">routingKey</span></span>: <span class="hljs-string"><span class="hljs-string">'#.integrates.#'</span></span>, }, { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: Types.QUEUE, <span class="hljs-attr"><span class="hljs-attr">destination</span></span>: <span class="hljs-string"><span class="hljs-string">'generateRoutingKey'</span></span>, <span class="hljs-attr"><span class="hljs-attr">source</span></span>: <span class="hljs-string"><span class="hljs-string">'postprocessing'</span></span>, <span class="hljs-attr"><span class="hljs-attr">routingKey</span></span>: <span class="hljs-string"><span class="hljs-string">'generateRoutingKey'</span></span>, }, { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: Types.QUEUE, <span class="hljs-attr"><span class="hljs-attr">destination</span></span>: <span class="hljs-string"><span class="hljs-string">'sendSms'</span></span>, <span class="hljs-attr"><span class="hljs-attr">source</span></span>: <span class="hljs-string"><span class="hljs-string">'notify'</span></span>, <span class="hljs-attr"><span class="hljs-attr">routingKey</span></span>: <span class="hljs-string"><span class="hljs-string">'#.sendSms.#'</span></span>, }, { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: Types.QUEUE, <span class="hljs-attr"><span class="hljs-attr">destination</span></span>: <span class="hljs-string"><span class="hljs-string">'delivery'</span></span>, <span class="hljs-attr"><span class="hljs-attr">source</span></span>: <span class="hljs-string"><span class="hljs-string">'integrates'</span></span>, <span class="hljs-attr"><span class="hljs-attr">routingKey</span></span>: <span class="hljs-string"><span class="hljs-string">'#.delivery.#'</span></span>, }, { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: Types.QUEUE, <span class="hljs-attr"><span class="hljs-attr">destination</span></span>: <span class="hljs-string"><span class="hljs-string">'sendSmsHold'</span></span>, <span class="hljs-attr"><span class="hljs-attr">source</span></span>: <span class="hljs-string"><span class="hljs-string">'notify'</span></span>, <span class="hljs-attr"><span class="hljs-attr">routingKey</span></span>: <span class="hljs-string"><span class="hljs-string">'sendSmsHold'</span></span>, }, { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: Types.QUEUE, <span class="hljs-attr"><span class="hljs-attr">destination</span></span>: <span class="hljs-string"><span class="hljs-string">'deliveryHold'</span></span>, <span class="hljs-attr"><span class="hljs-attr">source</span></span>: <span class="hljs-string"><span class="hljs-string">'integrates'</span></span>, <span class="hljs-attr"><span class="hljs-attr">routingKey</span></span>: <span class="hljs-string"><span class="hljs-string">'deliveryHold'</span></span>, }, ];</code> </pre> <br><p>  Vollst√§ndige Konfiguration </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { PipelineConfig } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../interfaces'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> exchanges <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./exchanges'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> queues <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./queues'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> bindings <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./bindigs'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> pipelineConfig: PipelineConfig = { exchanges, queues, bindings, };</code> </pre> <br><p>  Schreiben Sie eine Klasse, um eine Verbindung zum Kaninchen herzustellen. </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { connect, Connection, Channel } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'amqplib'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RabbitConnect</span></span></span><span class="hljs-class"> </span></span>{ private _uri: string; private _connection: Connection; private _chanel: Channel; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>() { <span class="hljs-comment"><span class="hljs-comment">//    rabbit     this._uri = process.env.RABBIT_URI || 'amqp://localhost'; } protected async connect() { this._connection = await connect(this._uri); this._chanel = await this._connection.createChannel(); } protected async disconnect() { await this._chanel.close(); return this._connection.close(); } protected get chanel() { return this._chanel; } }</span></span></code> </pre> <br><p>  Schreiben wir die Pipeline-Klasse, die beim Start die gesamte erforderliche Infrastruktur in Rabbit gem√§√ü der zuvor beschriebenen Konfiguration erstellt. </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { RabbitConnect } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./RabbitConnect'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { PipelineConfig } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./interfaces'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Types } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./constants'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Pipeline</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RabbitConnect</span></span></span><span class="hljs-class"> </span></span>{ private _pipeline: PipelineConfig; <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(pipelineConfig: PipelineConfig) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._pipeline = pipelineConfig; } public <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> create() { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.connect(); <span class="hljs-comment"><span class="hljs-comment">//   const createQueues = this._pipeline.queues.map(queue =&gt; this.chanel.assertQueue(queue.name, queue.options), ) as PromiseLike&lt;any&gt;[]; //   const createExchanges = this._pipeline.exchanges.map(exchange =&gt; this.chanel.assertExchange(exchange.name, exchange.type), ) as PromiseLike&lt;any&gt;[]; await Promise.all([...createQueues, ...createExchanges]); //       const createBindings = this._pipeline.bindings.map(binding =&gt; { if (binding.type === Types.QUEUE) { return this.chanel.bindQueue(binding.destination, binding.source, binding.routingKey); } return this.chanel.bindExchange(binding.destination, binding.source, binding.routingKey); }); await Promise.all(createBindings); return this.disconnect(); } catch (error) { console.error(error); throw new Error(error); } } }</span></span></code> </pre> <br><p>  Jetzt schreiben wir eine abstrakte Worker-Klasse mit einer gemeinsamen Funktionalit√§t f√ºr alle Worker, von denen geerbt werden kann. </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { RabbitConnect } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./RabbitConnect'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Message, Order, FailOrder } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./interfaces'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { ConsumeMessage } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'amqplib'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> interface WorkerParams { maxRetry?: number; <span class="hljs-comment"><span class="hljs-comment">//     active: string; //    exchange: string; //       holdKey?: string; //      } export abstract class Worker&lt;M extends Order&gt; extends RabbitConnect { private _maxRetry: number; private _active: string; private _holdKey: string | undefined; protected exchange: string; private _currentMessage: Message&lt;M&gt;; private _currentConsumeMessage: ConsumeMessage; constructor({ active, holdKey, exchange, maxRetry }: WorkerParams) { super(); this._maxRetry = maxRetry || 0; this._active = active; this._holdKey = holdKey; this.exchange = exchange; } public async subscribe() { await this.connect(); this.chanel.consume(this._active, this.checkMessage.bind(this)); } //          private async checkMessage(message: ConsumeMessage) { this._currentConsumeMessage = message; const orderMessage: Message&lt;M&gt; = JSON.parse(message.content.toString()); if (orderMessage.retry &gt;= this._maxRetry) { await this.sendToErrorStorage('  '); } this._currentMessage = orderMessage; //           await this.handler(orderMessage.order || orderMessage); } //       protected async sendToErrorStorage(error: string) { const message: FailOrder = { order: this._currentMessage.order, errors: [...this._currentMessage.errors, error], retry: this._currentMessage.retry + 1, exchange: this.exchange, routingKey: this._active }; console.log('   ', message); this.ack(); } //       protected async hold(error: string) { if (!this._holdKey) { return; } const orderMessage = { order: this._currentMessage.order, errors: [...this._currentMessage.errors, error], retry: this._currentMessage.retry + 1, }; const orderData = Buffer.from(JSON.stringify(orderMessage)); return this.chanel.publish(this.exchange, this._holdKey, orderData); } //      protected async ack() { return this.chanel.ack(this._currentConsumeMessage); } protected abstract handler(message: M): void; }</span></span></code> </pre> <br><p>  Standardm√§√üig erfordert Kaninchen die Best√§tigung einer erfolgreichen Nachrichtenverarbeitung durch den Arbeiter.  Hierzu verf√ºgt der Verbindungskanal √ºber eine Best√§tigungsmethode.  Wenn der Arbeiter die Nachricht nicht verarbeiten konnte, gibt es eine Nack-Methode, die Rabbit anweist, die Nachricht an einen anderen Arbeiter zu senden. </p><br><p>  Jetzt k√∂nnen wir einige einfache Arbeiter aus dem Diagramm schreiben. </p><br><p>  Arbeiter, der einen Routing-Schl√ºssel generiert. </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Worker } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../Worker'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { isOrderWithPhone, isOrderWithDeliveryAddress, Order, Message, } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../interfaces'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Keys } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../constants'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GenerateRoutingKey</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Worker</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Order</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>({ <span class="hljs-attr"><span class="hljs-attr">active</span></span>: <span class="hljs-string"><span class="hljs-string">'generateRoutingKey'</span></span>, <span class="hljs-attr"><span class="hljs-attr">exchange</span></span>: <span class="hljs-string"><span class="hljs-string">'postprocessing'</span></span>, }); } protected <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> handler(order: Order) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> routingKey: string[] = []; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isOrderWithPhone(order)) { routingKey.push(Keys.SEND_SMS); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isOrderWithDeliveryAddress(order)) { routingKey.push(Keys.SEND_TO_DELIVERY); } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> message: Message&lt;Order&gt; = { <span class="hljs-attr"><span class="hljs-attr">retry</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">errors</span></span>: [], order, }; <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.chanel.publish( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.exchange, routingKey.join(<span class="hljs-string"><span class="hljs-string">'.'</span></span>), Buffer.from(<span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify(message)), ); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ack(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (error) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.error(error); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.sendToErrorStorage(error); } } }</code> </pre> <br><p>  Arbeiter senden SMS. </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Worker } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../Worker'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { OrderWithPhone } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../interfaces'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SendSms</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Worker</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OrderWithPhone</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>({ <span class="hljs-attr"><span class="hljs-attr">active</span></span>: <span class="hljs-string"><span class="hljs-string">'sendSms'</span></span>, <span class="hljs-attr"><span class="hljs-attr">exchange</span></span>: <span class="hljs-string"><span class="hljs-string">'notify'</span></span>, <span class="hljs-attr"><span class="hljs-attr">holdKey</span></span>: <span class="hljs-string"><span class="hljs-string">'sendSmsHold'</span></span>, <span class="hljs-attr"><span class="hljs-attr">maxRetry</span></span>: process.env.MAX_RETRY ? <span class="hljs-built_in"><span class="hljs-built_in">parseInt</span></span>(process.env.MAX_RETRY) : <span class="hljs-number"><span class="hljs-number">5</span></span>, }); } protected <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> handler(message: OrderWithPhone) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">' sms  : '</span></span>, message.phone); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ack(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (error) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.error(error); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.hold(error); } } }</code> </pre> <br><p>  Arbeitnehmerintegration mit dem Lieferservice. </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Worker } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../Worker'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { OrderWithDeliveryAddress } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../interfaces'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Delivery</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Worker</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OrderWithDeliveryAddress</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>({ <span class="hljs-attr"><span class="hljs-attr">active</span></span>: <span class="hljs-string"><span class="hljs-string">'delivery'</span></span>, <span class="hljs-attr"><span class="hljs-attr">exchange</span></span>: <span class="hljs-string"><span class="hljs-string">'interates'</span></span>, <span class="hljs-attr"><span class="hljs-attr">holdKey</span></span>: <span class="hljs-string"><span class="hljs-string">'deliveryHold'</span></span>, <span class="hljs-attr"><span class="hljs-attr">maxRetry</span></span>: process.env.MAX_RETRY ? <span class="hljs-built_in"><span class="hljs-built_in">parseInt</span></span>(process.env.MAX_RETRY) : <span class="hljs-number"><span class="hljs-number">5</span></span>, }); } protected <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> handler(message: OrderWithDeliveryAddress) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'      : '</span></span>, message.deliveryAddress); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ack(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (error) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.error(error); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.hold(error); } } }</code> </pre> <br><p>  Der Einstiegspunkt in die Anwendung. </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Pipeline } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./Pipeline'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { pipelineConfig } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./pipeline'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { GenerateRoutingKey } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./workers/GenerateRoutingKey'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { SendSms } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./workers/SendSms'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Delivery } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./workers/Delivery'</span></span>; <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">async</span></span></span></span><span class="hljs-function"><span class="hljs-params"> (</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> pipeline = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Pipeline(pipelineConfig); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> generateRoutingKey = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GenerateRoutingKey(); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> sendSms = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SendSms(); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> delivery = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Delivery(); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> pipeline.create(); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>.all([generateRoutingKey.subscribe(), sendSms.subscribe(), delivery.subscribe()]); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (error) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.error(error); process.exit(<span class="hljs-number"><span class="hljs-number">1</span></span>); } })();</code> </pre> <br><p>  Ich werde kein Beispiel f√ºr eine Codeklasse zum Schreiben einer Bestellung in die Datenbank und zum Generieren einer Internet-Bestellnummer geben.  Dies w√ºrde den Rahmen dieses Artikels sprengen.  Um den Code zu √ºberpr√ºfen, k√∂nnen Sie die Kaninchen-Weboberfl√§che verwenden, indem Sie die Bestellung json an den Austausch des Herstellers senden. </p><br><h2 id="zaklyuchenie">  Fazit </h2><br><p>  Ein solches Konstruktionsschema zur Bearbeitung einer Online-Bestellung erleichtert die Skalierung des Systems.  Es wird f√ºr uns nicht schwierig sein, diesem Schema mehrere Warteschlangen und Worker hinzuzuf√ºgen, um die erforderlichen Funktionen hinzuzuf√ºgen.  Sie k√∂nnen beispielsweise das Senden von Benachrichtigungen per E-Mail oder das Senden einer Bestellung f√ºr die Buchhaltung in 1C hinzuf√ºgen.  Die konvertierte Schaltung sieht folgenderma√üen aus: </p><br><p><img src="https://habrastorage.org/webt/id/rt/7j/idrt7j5jx9zmzcma6axa3st7-nq.png"></p><br><p>  Ich hoffe dir hat der Artikel gefallen.  Ich freue mich √ºber Kommentare und Kritik.  Alle eingereichten Codes finden <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Sie auf github</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de469991/">https://habr.com/ru/post/de469991/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de469979/index.html">Aufzeichnungen von Berichten aus dem zweiten iOS mitap Redmadrobot</a></li>
<li><a href="../de469981/index.html">Was ist im Chat-Bot?</a></li>
<li><a href="../de469983/index.html">Wie kann man eine Strategie entwickeln, um das Altern zu besiegen?</a></li>
<li><a href="../de469985/index.html">Beschleunigen eines Programms f√ºr einen synthetisierten Redd-Prozessor ohne Optimierung: Ersetzen einer Uhr</a></li>
<li><a href="../de469987/index.html">Top 20 Marktentwicklungsunternehmen aus aller Welt</a></li>
<li><a href="../de469995/index.html">Python SAX-Parser gegen Python DOM-Parser. Parsim FIAS-H√§user</a></li>
<li><a href="../de469997/index.html">Welche Schlagzeilen am ehesten Aufmerksamkeit erregen oder HabraHabr-Analyse</a></li>
<li><a href="../de469999/index.html">Wie Server miteinander verhandeln: Raft Distributed Consensus-Algorithmus</a></li>
<li><a href="../de470003/index.html">F # 1: Hallo Welt</a></li>
<li><a href="../de470005/index.html">Fernsteuerung des Computers √ºber einen Browser</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>