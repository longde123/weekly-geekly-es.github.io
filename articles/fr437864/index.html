<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>â™ï¸ â›„ï¸ ğŸ‘©ğŸ¿â€âœˆï¸ SystÃ¨me de surveillance pour les serveurs Windows sur SQL pur, et comment je l'avais secrÃ¨tement glissÃ© dans la production ğŸ‘« ğŸ™†ğŸ½ ğŸ‘©â€ğŸ‘©â€ğŸ‘§</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Il y a longtemps, dans une galaxie lointaine, trÃ¨s lointaine, une entreprise Ã©tait passÃ©e d'une start-up Ã  quelque chose de beaucoup plus grand, mais ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>SystÃ¨me de surveillance pour les serveurs Windows sur SQL pur, et comment je l'avais secrÃ¨tement glissÃ© dans la production</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/437864/"> Il y a longtemps, dans une galaxie lointaine, trÃ¨s lointaine, une entreprise Ã©tait passÃ©e d'une start-up Ã  quelque chose de beaucoup plus grand, mais pendant un certain temps, le service informatique Ã©tait encore compact et trÃ¨s efficace.  Cette sociÃ©tÃ© a hÃ©bergÃ© <i>sur des</i> centaines de serveurs Windows virtuels, et bien sÃ»r, ces serveurs ont Ã©tÃ© surveillÃ©s.  Avant mÃªme de rejoindre l'entreprise, NetIQ avait Ã©tÃ© choisie comme solution de surveillance. <br><br>  L'une de mes nouvelles tÃ¢ches consistait Ã  prendre en charge NetIQ.  La personne, qui a dÃ©jÃ  travaillÃ© avec NetIQ, a beaucoup parlÃ© de son expÃ©rience avec NetIQ, malheureusement, si j'essaie de le mettre ici, ce ne serait qu'une longue lignÃ©e de caractÃ¨res '****'.  J'ai vite compris pourquoi.  Steve Jobs tourne probablement dans sa tombe en regardant l'interface comme ceci: <br><br><img src="https://habrastorage.org/webt/wv/cq/kj/wvcqkjtunh0raiwt14rvhpbn-pw.png" alt="image"><br><a name="habracut"></a><br>  Dans une ligne, la logique de la case Ã  cocher est positive ( <i>Ã©vÃ©nement dÃ©clencheur</i> ), dans la suivante est nÃ©gative ( <i>Ã©vÃ©nement non dÃ©clencheur</i> ).  Alors, comment fonctionne ' <i>Raise event only i</i> f'?  Je n'en ai aucune idÃ©e. <br><br>  Cependant, il y avait bien pire avec NetIQ: son agent de surveillance Ã©tait trÃ¨s fragile.  Beaucoup plus vulnÃ©rable que Windows lui-mÃªme.  MÃ©moire insuffisante?  L'agent est en panne.  Le CPU est Ã  100%?  L'agent ne rÃ©pond pas.  0 octets libres sur un lecteur de disque?  Eh bien, pour envoyer un message d'alerte, un agent doit d'abord l'enregistrer dans un fichier sur un disque ... Alors oui, vous ne recevez aucune alerte dans ce cas. <br><br>  Cependant, Â«ne rÃ©parez pas ce qui n'est pas cassÃ©Â», et d'une maniÃ¨re ou d'une autre, nous avons vÃ©cu avec jusqu'Ã  ce que notre entreprise soit achetÃ©e par une entreprise beaucoup plus grande.  Lorsqu'une grande entreprise en achÃ¨te une petite, la petite se dissipe sous forme de gouttelettes d'eau dans une mer.  Cependant, dans notre cas, nous (du point de vue informatique) n'Ã©tions pas beaucoup plus petits que l'informatique d'une plus grande entreprise, et il Ã©tait Ã©vident dÃ¨s le dÃ©but que la fusion serait trÃ¨s dÃ©licate.  Si dÃ©licat que pendant un certain temps, nous avons Ã©tÃ© laissÃ©s seuls en tant que service indÃ©pendant et que tous les processus commerciaux et informatiques ont Ã©tÃ© conservÃ©s de la mÃªme maniÃ¨re, juste sous l'Ã©gide du nouveau nom.  Cela me rappelle le moment oÃ¹ <b>THE RING</b> Ã©tait allongÃ© sur la lave mais n'a pas encore commencÃ© Ã  fondre. <br><br><img src="https://habrastorage.org/webt/qf/--/cy/qf--cyd5ehkjz_5zjhmogmwekcw.jpeg" alt="image"><br><br>  Pendant ce temps, j'avais mis Ã  niveau NetIQ de la version 7 Ã  la version 8, puis Ã  la version 9. C'est Ã  ce moment que tous nos problÃ¨mes ont commencÃ©.  Nous utilisions NetIQ pour surveiller seulement quelques Ã©lÃ©ments de base: la disponibilitÃ© d'un serveur, la mÃ©moire, le processeur, l'espace disque et le plus important pour nous - l'Ã©tat des services locaux.  Lorsqu'un type de dÃ©marrage de service local a Ã©tÃ© dÃ©fini sur Â«AutomatiqueÂ», il doit toujours Ãªtre en cours d'exÃ©cution (sinon nous le considÃ©rons comme ayant plantÃ©).  Il ne devrait pas y avoir de cas comme celui-ci: <br><br><img src="https://habrastorage.org/webt/45/fz/1h/45fz1ho3t3mxx6ka8yjlhg-_yjs.jpeg" alt="image"><br><br>  NetIQ a donc cessÃ© de surveiller l'Ã©tat des services.  AprÃ¨s une semaine d'expÃ©rimentation et une autre semaine d'appels avec le support de NetIQ, nous avions appris que Â« <i>ce n'Ã©tait pas un bug, c'Ã©tait une fonctionnalitÃ©</i> Â» et l'alerte n'Ã©tait dÃ©clenchÃ©e que lorsqu'un processus se terminait avec un code de sortie spÃ©cifique.  Et nos services se sont Ã©crasÃ©s avec TOUT code. <br><br>  Ã€ ce moment-lÃ , il Ã©tait trop tard pour revenir en arriÃ¨re.  Comme vous le comprenez, dÃ¨s que nous avons dÃ©couvert que notre infrastructure critique n'Ã©tait pas surveillÃ©e, nous n'avions immÃ©diatement ... eh ... rien fait.  Parce qu'Ã  cette Ã©poque, le processus de Â«fusionÂ» de notre entreprise en une plus grande a atteint une phase active, et cela ressemblait Ã  ceci: <br><br><img src="https://habrastorage.org/webt/cq/y3/zk/cqy3zk1iyhts4aijbhx0umtxab8.jpeg" alt="image"><br><br>  J'entendais des sons de tonnerre de trÃ¨s loin et il semblait que les dieux d'Olympe dÃ©cidaient du sort du monde, alors que j'essayais de les distraire avec mon petit problÃ¨me technique.  En mÃªme temps, je ne pouvais pas dormir sachant que notre systÃ¨me de surveillance Ã©tait Ã  moitiÃ© aveugle. <br><br>  AprÃ¨s avoir rÃ©alisÃ© qu'il n'y avait rien Ã  attendre, j'ai dÃ©cidÃ© de crÃ©er une solution rapide et sale - un minuscule scanner de service qui devrait parcourir tous les serveurs pour vÃ©rifier les services et envoyer des e-mails pour les services qui Ã©taient en panne, exactement comme l'ancienne version de NetIQ l'a fait.  Vous pourriez penser que le script PowerShell est la meilleure faÃ§on de le faire, mais ... Si tout ce que vous avez est un marteau, tout ressemble Ã  un clou.  Si vous Ãªtes un DBA qui travaille avec SQL depuis la version 6.0 alors ... Voici un court extrait du code, pour que vous puissiez comprendre de quoi je parle: <br><br><img src="https://habrastorage.org/webt/zt/bb/3h/ztbb3hzjroe6t_bzlsj1atrulbi.png" alt="image"><br><br>  Il ne m'a fallu que quelques heures pour Ã©crire la premiÃ¨re solution.  Au cours des prochains jours, j'ai ajoutÃ© un audit, des paramÃ¨tres et d'autres choses fantaisistes.  AprÃ¨s avoir examinÃ© ce que la commande WMIC pouvait faire, je n'ai pas pu m'arrÃªter.  Je ne me souviens pas exactement de ce qui s'est passÃ© au cours des 2 semaines suivantes - tout Ã©tait un peu flou, mais quand je me suis rÃ©veillÃ©, toutes les fonctionnalitÃ©s de NetIQ ont Ã©tÃ© implÃ©mentÃ©es en utilisant du SQL pur. <br><br>  Je n'ai pas simplement copiÃ© la fonctionnalitÃ© NetIQ Â«telle quelleÂ», j'avais mis en Å“uvre tout ce dont j'avais toujours rÃªvÃ©.  Dans l'alerte par e-mail de LOWDISK, vous obtenez Ã©galement un PDF joint avec un graphique de croissance de l'utilisation du disque afin que vous puissiez instantanÃ©ment comprendre si la croissance est rÃ©elle ou si quelque chose s'est mal passÃ©.  Faible mÃ©moire - et vous obtenez non seulement le graphique, mais aussi une distribution de mÃ©moire par processus, plus pour w3wp.exe vous obtenez un nom de pool ajoutÃ©.  J'avais Ã©galement mis en place des rappels intelligents avec protection contre les inondations et bien d'autres choses fantaisistes.  BTW, la liste des serveurs virtuels a Ã©tÃ© extraite automatiquement des rÃ©fÃ©rentiels VMware.  En regardant simplement les sujets d'alerte dans un client mobile, vous pouvez dire instantanÃ©ment ce qui se passe - mÃªme sans ouvrir les e-mails: <br><br><img src="https://habrastorage.org/webt/ps/cq/fk/pscqfkh5qb23_oujl6zyjmeexzy.png" alt="image"><br><br>  Les dÃ©veloppeurs modernes se sont habituÃ©s Ã  crÃ©er des niveaux d'abstraction dans une mesure oÃ¹ cela nuit Ã  leur capacitÃ© Ã  Ã©crire un code simple et direct.  Ils ne peuvent pas crÃ©er un systÃ¨me de surveillance sans dire: "Ok, donc pour n'importe quel serveur, nous pouvons exÃ©cuter n'importe quel ensemble de scripts avec des rÃ¨gles Ã  partir d'un rÃ©fÃ©rentiel ... Quelle flexibilitÃ© ...".  Mais la surveillance de quelques Ã©lÃ©ments fondamentaux comme la mÃ©moire, le processeur, le disque et l'Ã©tat des services est unique.  En mettant en Å“uvre la vÃ©rification de ces conditions de base avec un niveau d'abstraction, elles se terminent par un code qui fonctionne Ã©galement mal dans tous les cas.  Ceci est un exemple du systÃ¨me SCOM.  Je suis sÃ»r qu'il a Ã©tÃ© mis en Å“uvre exactement par les spÃ©cifications: <br><br><img src="https://habrastorage.org/webt/wm/3m/ut/wm3mutentcltlmpobwyjutqm0me.png" alt="image"><br><br>  Mais le principal avantage du nouveau systÃ¨me Ã©tait qu'il n'y avait aucun agent.  Aucun agent - rien Ã  installer, rien Ã  casser.  Le systÃ¨me Ã©tait simple et fiable comme hummer. <br><br>  Peu le mois prochain, je suis venu travailler et j'ai passÃ© une heure ou deux Ã  travailler sur ma nouvelle crÃ©ation - lentement, sans dÃ©lais ni ETA, ne laissant pratiquement aucune dette technique.  Au bout d'un moment, je me suis forcÃ© Ã  arrÃªter. <br><br>  NetIQ Ã©tait toujours en production, mais les gens prÃ©fÃ©raient dÃ©finitivement les alertes du nouveau systÃ¨me, plus fiables et informatives.  Peu Ã  peu, j'ai dÃ©placÃ© tous les Â«abonnÃ©sÂ» alertes vers le nouveau systÃ¨me, tout en maintenant l'ancien systÃ¨me en vie.  Pendant ce temps, le processus de Â«fusionÂ» de notre ancienne entreprise en une plus grande avait atteint son stade final: <br><br><img src="https://habrastorage.org/webt/8j/sy/da/8jsydazfbheft25w9ugymimk_hi.jpeg" alt="image"><br><br>  Eh bien, tout a une fin.  J'ai mÃªme Ã©tÃ© surpris d'avoir eu la chance de jouer avec de telles choses dans une grande entreprise bureaucratique.  AprÃ¨s un mois de prÃ©paration, on m'a dit que Â« <i>ok, dans une semaine, nous avons fermÃ© NetIQ et passer Ã  SCOM en tant que norme d'entreprise</i> Â».  J'ai fermÃ© NetIQ (je dois admettre que je le dÃ©testais tellement que c'Ã©tait l'un des moments les plus heureux de ma carriÃ¨re) et j'ai commencÃ© Ã  attendre l'arrivÃ©e de SCOM.  Mais il n'y en avait pas.  Rien depuis une semaine, un mois, et mÃªme un quart. <br><br>  Nous n'avons obtenu SCOM qu'aprÃ¨s 6 mois complets - quelqu'un avait oubliÃ© le coÃ»t des licences pour le grand nombre de serveurs que nous avions.  Au cours de ces 6 mois, de nombreux dÃ©partements sont devenus tellement dÃ©pendants du nouveau systÃ¨me, qui a non seulement gardÃ© les alertes mais aussi les mesures de performance et les inventaires qu'il Ã©tait hors de question de le fermer.  C'est devenu un deuxiÃ¨me systÃ¨me de sauvegarde.  Pour les auditeurs il y a SCOM, pour les choses vraiment utiles - il y a ma crÃ©ation. <br><br>  De temps en temps, des gestionnaires Ã  diffÃ©rents niveaux de la hiÃ©rarchie ont dÃ©passÃ© les alertes de ce systÃ¨me et ont demandÃ© - qu'est-ce que c'est?  RÃ©cemment, j'avais expliquÃ© toute l'histoire derriÃ¨re ce produit.  Ils ont ri et ont laissÃ© ce systÃ¨me vivre, et pour moi, c'Ã©tait une chance d'Ã©crire un code comme quand j'Ã©tais Ã©tudiant - guidÃ© non par des spÃ©cifications mais basÃ© sur ma propre comprÃ©hension, comme un hobby.  C'Ã©tait trÃ¨s amusant. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Article en russe</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr437864/">https://habr.com/ru/post/fr437864/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr437846/index.html">bobaoskit - accessoires, dnssd et WebSocket</a></li>
<li><a href="../fr437848/index.html">Nous rendons le processus de dÃ©veloppement de logiciels lourds pour microcontrÃ´leurs plus pratique (non)</a></li>
<li><a href="../fr437850/index.html">Qui est le plus efficace dans la disposition des PCB?</a></li>
<li><a href="../fr437852/index.html">Histoire de Shipastik</a></li>
<li><a href="../fr437858/index.html">ConfÃ©rences supplÃ©mentaires du cours Â«Designing Highly Loaded SystemsÂ» (automne 2018) Ã  Technopolis</a></li>
<li><a href="../fr437868/index.html">Semaine de la sÃ©curitÃ© 05: imprimantes, appareils photo, 7zip et Ã©thique</a></li>
<li><a href="../fr437870/index.html">Comment Resident Evil 2 s'est effondrÃ©, mais a pu devenir le plus grand succÃ¨s de Capcom</a></li>
<li><a href="../fr437872/index.html">Cordonnier sans bottes. Comment les Ã©lÃ¨ves ont Ã©crit des e-mails de phishing</a></li>
<li><a href="../fr437876/index.html">"Clouds": quel est l'avantage sur le serveur d'entreprise</a></li>
<li><a href="../fr437878/index.html">Tendances de cybersÃ©curitÃ© de BI.ZONE</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>