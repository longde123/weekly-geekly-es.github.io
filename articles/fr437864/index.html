<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>♍️ ⛄️ 👩🏿‍✈️ Système de surveillance pour les serveurs Windows sur SQL pur, et comment je l'avais secrètement glissé dans la production 👫 🙆🏽 👩‍👩‍👧</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Il y a longtemps, dans une galaxie lointaine, très lointaine, une entreprise était passée d'une start-up à quelque chose de beaucoup plus grand, mais ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Système de surveillance pour les serveurs Windows sur SQL pur, et comment je l'avais secrètement glissé dans la production</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/437864/"> Il y a longtemps, dans une galaxie lointaine, très lointaine, une entreprise était passée d'une start-up à quelque chose de beaucoup plus grand, mais pendant un certain temps, le service informatique était encore compact et très efficace.  Cette société a hébergé <i>sur des</i> centaines de serveurs Windows virtuels, et bien sûr, ces serveurs ont été surveillés.  Avant même de rejoindre l'entreprise, NetIQ avait été choisie comme solution de surveillance. <br><br>  L'une de mes nouvelles tâches consistait à prendre en charge NetIQ.  La personne, qui a déjà travaillé avec NetIQ, a beaucoup parlé de son expérience avec NetIQ, malheureusement, si j'essaie de le mettre ici, ce ne serait qu'une longue lignée de caractères '****'.  J'ai vite compris pourquoi.  Steve Jobs tourne probablement dans sa tombe en regardant l'interface comme ceci: <br><br><img src="https://habrastorage.org/webt/wv/cq/kj/wvcqkjtunh0raiwt14rvhpbn-pw.png" alt="image"><br><a name="habracut"></a><br>  Dans une ligne, la logique de la case à cocher est positive ( <i>événement déclencheur</i> ), dans la suivante est négative ( <i>événement non déclencheur</i> ).  Alors, comment fonctionne ' <i>Raise event only i</i> f'?  Je n'en ai aucune idée. <br><br>  Cependant, il y avait bien pire avec NetIQ: son agent de surveillance était très fragile.  Beaucoup plus vulnérable que Windows lui-même.  Mémoire insuffisante?  L'agent est en panne.  Le CPU est à 100%?  L'agent ne répond pas.  0 octets libres sur un lecteur de disque?  Eh bien, pour envoyer un message d'alerte, un agent doit d'abord l'enregistrer dans un fichier sur un disque ... Alors oui, vous ne recevez aucune alerte dans ce cas. <br><br>  Cependant, «ne réparez pas ce qui n'est pas cassé», et d'une manière ou d'une autre, nous avons vécu avec jusqu'à ce que notre entreprise soit achetée par une entreprise beaucoup plus grande.  Lorsqu'une grande entreprise en achète une petite, la petite se dissipe sous forme de gouttelettes d'eau dans une mer.  Cependant, dans notre cas, nous (du point de vue informatique) n'étions pas beaucoup plus petits que l'informatique d'une plus grande entreprise, et il était évident dès le début que la fusion serait très délicate.  Si délicat que pendant un certain temps, nous avons été laissés seuls en tant que service indépendant et que tous les processus commerciaux et informatiques ont été conservés de la même manière, juste sous l'égide du nouveau nom.  Cela me rappelle le moment où <b>THE RING</b> était allongé sur la lave mais n'a pas encore commencé à fondre. <br><br><img src="https://habrastorage.org/webt/qf/--/cy/qf--cyd5ehkjz_5zjhmogmwekcw.jpeg" alt="image"><br><br>  Pendant ce temps, j'avais mis à niveau NetIQ de la version 7 à la version 8, puis à la version 9. C'est à ce moment que tous nos problèmes ont commencé.  Nous utilisions NetIQ pour surveiller seulement quelques éléments de base: la disponibilité d'un serveur, la mémoire, le processeur, l'espace disque et le plus important pour nous - l'état des services locaux.  Lorsqu'un type de démarrage de service local a été défini sur «Automatique», il doit toujours être en cours d'exécution (sinon nous le considérons comme ayant planté).  Il ne devrait pas y avoir de cas comme celui-ci: <br><br><img src="https://habrastorage.org/webt/45/fz/1h/45fz1ho3t3mxx6ka8yjlhg-_yjs.jpeg" alt="image"><br><br>  NetIQ a donc cessé de surveiller l'état des services.  Après une semaine d'expérimentation et une autre semaine d'appels avec le support de NetIQ, nous avions appris que « <i>ce n'était pas un bug, c'était une fonctionnalité</i> » et l'alerte n'était déclenchée que lorsqu'un processus se terminait avec un code de sortie spécifique.  Et nos services se sont écrasés avec TOUT code. <br><br>  À ce moment-là, il était trop tard pour revenir en arrière.  Comme vous le comprenez, dès que nous avons découvert que notre infrastructure critique n'était pas surveillée, nous n'avions immédiatement ... eh ... rien fait.  Parce qu'à cette époque, le processus de «fusion» de notre entreprise en une plus grande a atteint une phase active, et cela ressemblait à ceci: <br><br><img src="https://habrastorage.org/webt/cq/y3/zk/cqy3zk1iyhts4aijbhx0umtxab8.jpeg" alt="image"><br><br>  J'entendais des sons de tonnerre de très loin et il semblait que les dieux d'Olympe décidaient du sort du monde, alors que j'essayais de les distraire avec mon petit problème technique.  En même temps, je ne pouvais pas dormir sachant que notre système de surveillance était à moitié aveugle. <br><br>  Après avoir réalisé qu'il n'y avait rien à attendre, j'ai décidé de créer une solution rapide et sale - un minuscule scanner de service qui devrait parcourir tous les serveurs pour vérifier les services et envoyer des e-mails pour les services qui étaient en panne, exactement comme l'ancienne version de NetIQ l'a fait.  Vous pourriez penser que le script PowerShell est la meilleure façon de le faire, mais ... Si tout ce que vous avez est un marteau, tout ressemble à un clou.  Si vous êtes un DBA qui travaille avec SQL depuis la version 6.0 alors ... Voici un court extrait du code, pour que vous puissiez comprendre de quoi je parle: <br><br><img src="https://habrastorage.org/webt/zt/bb/3h/ztbb3hzjroe6t_bzlsj1atrulbi.png" alt="image"><br><br>  Il ne m'a fallu que quelques heures pour écrire la première solution.  Au cours des prochains jours, j'ai ajouté un audit, des paramètres et d'autres choses fantaisistes.  Après avoir examiné ce que la commande WMIC pouvait faire, je n'ai pas pu m'arrêter.  Je ne me souviens pas exactement de ce qui s'est passé au cours des 2 semaines suivantes - tout était un peu flou, mais quand je me suis réveillé, toutes les fonctionnalités de NetIQ ont été implémentées en utilisant du SQL pur. <br><br>  Je n'ai pas simplement copié la fonctionnalité NetIQ «telle quelle», j'avais mis en œuvre tout ce dont j'avais toujours rêvé.  Dans l'alerte par e-mail de LOWDISK, vous obtenez également un PDF joint avec un graphique de croissance de l'utilisation du disque afin que vous puissiez instantanément comprendre si la croissance est réelle ou si quelque chose s'est mal passé.  Faible mémoire - et vous obtenez non seulement le graphique, mais aussi une distribution de mémoire par processus, plus pour w3wp.exe vous obtenez un nom de pool ajouté.  J'avais également mis en place des rappels intelligents avec protection contre les inondations et bien d'autres choses fantaisistes.  BTW, la liste des serveurs virtuels a été extraite automatiquement des référentiels VMware.  En regardant simplement les sujets d'alerte dans un client mobile, vous pouvez dire instantanément ce qui se passe - même sans ouvrir les e-mails: <br><br><img src="https://habrastorage.org/webt/ps/cq/fk/pscqfkh5qb23_oujl6zyjmeexzy.png" alt="image"><br><br>  Les développeurs modernes se sont habitués à créer des niveaux d'abstraction dans une mesure où cela nuit à leur capacité à écrire un code simple et direct.  Ils ne peuvent pas créer un système de surveillance sans dire: "Ok, donc pour n'importe quel serveur, nous pouvons exécuter n'importe quel ensemble de scripts avec des règles à partir d'un référentiel ... Quelle flexibilité ...".  Mais la surveillance de quelques éléments fondamentaux comme la mémoire, le processeur, le disque et l'état des services est unique.  En mettant en œuvre la vérification de ces conditions de base avec un niveau d'abstraction, elles se terminent par un code qui fonctionne également mal dans tous les cas.  Ceci est un exemple du système SCOM.  Je suis sûr qu'il a été mis en œuvre exactement par les spécifications: <br><br><img src="https://habrastorage.org/webt/wm/3m/ut/wm3mutentcltlmpobwyjutqm0me.png" alt="image"><br><br>  Mais le principal avantage du nouveau système était qu'il n'y avait aucun agent.  Aucun agent - rien à installer, rien à casser.  Le système était simple et fiable comme hummer. <br><br>  Peu le mois prochain, je suis venu travailler et j'ai passé une heure ou deux à travailler sur ma nouvelle création - lentement, sans délais ni ETA, ne laissant pratiquement aucune dette technique.  Au bout d'un moment, je me suis forcé à arrêter. <br><br>  NetIQ était toujours en production, mais les gens préféraient définitivement les alertes du nouveau système, plus fiables et informatives.  Peu à peu, j'ai déplacé tous les «abonnés» alertes vers le nouveau système, tout en maintenant l'ancien système en vie.  Pendant ce temps, le processus de «fusion» de notre ancienne entreprise en une plus grande avait atteint son stade final: <br><br><img src="https://habrastorage.org/webt/8j/sy/da/8jsydazfbheft25w9ugymimk_hi.jpeg" alt="image"><br><br>  Eh bien, tout a une fin.  J'ai même été surpris d'avoir eu la chance de jouer avec de telles choses dans une grande entreprise bureaucratique.  Après un mois de préparation, on m'a dit que « <i>ok, dans une semaine, nous avons fermé NetIQ et passer à SCOM en tant que norme d'entreprise</i> ».  J'ai fermé NetIQ (je dois admettre que je le détestais tellement que c'était l'un des moments les plus heureux de ma carrière) et j'ai commencé à attendre l'arrivée de SCOM.  Mais il n'y en avait pas.  Rien depuis une semaine, un mois, et même un quart. <br><br>  Nous n'avons obtenu SCOM qu'après 6 mois complets - quelqu'un avait oublié le coût des licences pour le grand nombre de serveurs que nous avions.  Au cours de ces 6 mois, de nombreux départements sont devenus tellement dépendants du nouveau système, qui a non seulement gardé les alertes mais aussi les mesures de performance et les inventaires qu'il était hors de question de le fermer.  C'est devenu un deuxième système de sauvegarde.  Pour les auditeurs il y a SCOM, pour les choses vraiment utiles - il y a ma création. <br><br>  De temps en temps, des gestionnaires à différents niveaux de la hiérarchie ont dépassé les alertes de ce système et ont demandé - qu'est-ce que c'est?  Récemment, j'avais expliqué toute l'histoire derrière ce produit.  Ils ont ri et ont laissé ce système vivre, et pour moi, c'était une chance d'écrire un code comme quand j'étais étudiant - guidé non par des spécifications mais basé sur ma propre compréhension, comme un hobby.  C'était très amusant. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Article en russe</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr437864/">https://habr.com/ru/post/fr437864/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr437846/index.html">bobaoskit - accessoires, dnssd et WebSocket</a></li>
<li><a href="../fr437848/index.html">Nous rendons le processus de développement de logiciels lourds pour microcontrôleurs plus pratique (non)</a></li>
<li><a href="../fr437850/index.html">Qui est le plus efficace dans la disposition des PCB?</a></li>
<li><a href="../fr437852/index.html">Histoire de Shipastik</a></li>
<li><a href="../fr437858/index.html">Conférences supplémentaires du cours «Designing Highly Loaded Systems» (automne 2018) à Technopolis</a></li>
<li><a href="../fr437868/index.html">Semaine de la sécurité 05: imprimantes, appareils photo, 7zip et éthique</a></li>
<li><a href="../fr437870/index.html">Comment Resident Evil 2 s'est effondré, mais a pu devenir le plus grand succès de Capcom</a></li>
<li><a href="../fr437872/index.html">Cordonnier sans bottes. Comment les élèves ont écrit des e-mails de phishing</a></li>
<li><a href="../fr437876/index.html">"Clouds": quel est l'avantage sur le serveur d'entreprise</a></li>
<li><a href="../fr437878/index.html">Tendances de cybersécurité de BI.ZONE</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>