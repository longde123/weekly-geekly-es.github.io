<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëçüèº üññüèæ üçç Probar el c√≥digo de SQL Server con tSQLt üëâüèΩ üöº ü§ò</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="FYI: este art√≠culo es una versi√≥n ampliada de mi charla en SQA Days # 25. 

 En base a mi experiencia con colegas, puedo afirmar: la prueba de c√≥digo ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Probar el c√≥digo de SQL Server con tSQLt</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/arcadia/blog/465567/">  <i>FYI: este art√≠culo es una versi√≥n ampliada de mi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">charla</a> en SQA Days # 25.</i> <br><br>  En base a mi experiencia con colegas, puedo afirmar: la prueba de c√≥digo de base de datos no es una pr√°ctica ampliamente difundida.  Esto puede ser potencialmente peligroso.  La l√≥gica de DB est√° escrita por seres humanos al igual que todos los dem√°s c√≥digos "habituales".  Por lo tanto, puede haber fallas que pueden causar consecuencias negativas para un producto, empresa o usuarios.  Si estos son procedimientos almacenados que ayudan al backend o si se trata de modificar datos de ETL en un almac√©n, siempre existe un riesgo y las pruebas ayudan a disminuirlos.  Quiero decirte qu√© es tSQLt y c√≥mo nos ayuda a probar el c√≥digo DB. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/2e/-h/nx/2e-hnxb3bddbq3ck_8vi4jwah8i.jpeg"></div><a name="habracut"></a><br><h1>  El contexto </h1><br>  Hay un gran almac√©n que utiliza SQL Server y contiene diferentes datos de ensayos cl√≠nicos.  Se llena de una variedad de fuentes (bases de datos orientadas a documentos principalmente).  Muchas ETL transforman datos dentro del almac√©n en muchas ocasiones.  Estos datos se pueden cargar en bases de datos m√°s peque√±as para que las utilicen las aplicaciones web orientadas a peque√±as tareas espec√≠ficas.  Algunos de los clientes del cliente solicitaron implementar API para sus necesidades.  Dichas API a menudo usan procedimientos almacenados y consultas diferentes. <br><br><div style="text-align:center;"><img width="75%" height="75%" src="https://habrastorage.org/webt/iw/vu/rz/iwvurz8sbflhuz3mkj39ipf9rag.png"></div><br>  En general, hay una gran cantidad de c√≥digo en el lado de DBMS. <br><br><h1>  ¬øPor qu√© necesitamos esto? </h1><br>  Como puede ver en la introducci√≥n, el c√≥digo DB es parte del c√≥digo de la aplicaci√≥n y tambi√©n puede contener errores. <br><br>  Supongo que muchos de nosotros estamos familiarizados con la curva de Boehm: los errores siempre son m√°s caros de solucionar m√°s adelante en el proceso.  Un error que se realiz√≥ en una etapa de desarrollo anterior y se localiz√≥ en una posterior puede costar m√°s.  Esto se debe a la necesidad de pasar por muchos pasos intermedios (codificaci√≥n, prueba unitaria, prueba de integraci√≥n, prueba del sistema, etc.) dos veces: para la depuraci√≥n y para devolver el c√≥digo a la etapa donde se encontr√≥.  Este efecto tambi√©n es cierto para el caso del almac√©n.  Si hay un error en un procedimiento ETL y los datos se modifican varias veces, debemos: <br><br><ol><li>  siga todos los pasos de transformaci√≥n de datos de vuelta a la fuente del problema </li><li>  arreglar el problema </li><li>  derivar los datos correctos nuevamente (se pueden requerir ediciones manuales adicionales) </li><li>  aseg√∫rese de que no haya otros datos rotos causados ‚Äã‚Äãpor el error. </li></ol><br>  No olvides que no vendemos peluches.  Un error en un √°rea como los ensayos cl√≠nicos puede da√±ar no solo los negocios sino tambi√©n la salud humana. <br><br><h1>  ¬øC√≥mo hacer la prueba? </h1><br>  Como estamos hablando de pruebas de c√≥digo, nos referimos a pruebas de unidad e integraci√≥n.  Estas cosas son muy repetitivas e implican una regresi√≥n persistente.  Estrictamente hablando, tales pruebas nunca se realizan manualmente (bueno, excepto algunos casos singulares probablemente). <br><br>  Bonificaci√≥n adicional: las pruebas pueden ser materiales de apoyo para la documentaci√≥n del c√≥digo.  Por ejemplo, los requisitos pueden verse as√≠ (hacer clic): <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/webt/fh/af/xb/fhafxb5yph-tgvy2zhka9jfcvmk.png"></a> </div><br>  Archivo XLS, 2 columnas con requisitos + informaci√≥n adicional fragmentada en otras columnas + marcado confuso.  Puede ser dif√≠cil restaurar los deseos iniciales si es necesario.  Las pruebas pueden ayudar a registrar los matices de implementaci√≥n.  Por supuesto, no deben considerarse como un reemplazo de la documentaci√≥n. <br><br>  Desafortunadamente, la complejidad de las pruebas aumenta con el crecimiento de la complejidad del c√≥digo, por lo que este efecto se puede suavizar. <br><br>  Las pruebas pueden ser una capa de seguridad adicional contra fusiones espont√°neas.  Las pruebas autom√°ticas de CI ayudan con este problema debido a su formalismo. <br><br>  Entonces, si hemos decidido usar la automatizaci√≥n, debemos elegir una herramienta para ello. <br><br><h1>  ¬øQu√© usar para las pruebas? </h1><br>  En el caso de las pruebas de c√≥digo DB, veo 2 enfoques: con tecnolog√≠a SQL (cuando una herramienta funciona en DBMS directamente) y sin tecnolog√≠a SQL.  Estas son las principales diferencias que encontr√©: <br><div class="scrollable-table"><table><tbody><tr><th>  Impulsado por SQL <br></th><th>  No alimentado por sql <br></th></tr><tr><td>  Requiere la instalaci√≥n de objetos DB <br></td><td>  Requiere la instalaci√≥n de herramientas externas (en relaci√≥n con DB) <br></td></tr><tr><td>  Las pruebas son independientes de las tecnolog√≠as utilizadas fuera de DB <br></td><td>  Las pruebas pueden depender de tecnolog√≠as utilizadas fuera de DB <br></td></tr><tr><td>  El marco siempre est√° dedicado a un solo DBMS <br></td><td>  Framework a menudo soporta m√∫ltiples DBMS <br></td></tr><tr><td>  El conocimiento de DBMS es el √∫nico requisito para escribir pruebas;  Es posible utilizar probadores manuales o DBA <br></td><td>  Se requieren conocimientos adicionales de lenguajes o tecnolog√≠as de programaci√≥n para escribir pruebas;  a menudo se necesita la ayuda de un desarrollador <br></td></tr><tr><td>  La ejecuci√≥n a nivel de DBMS permite el uso avanzado de falsificaciones y aserciones. <br></td><td>  La ejecuci√≥n fuera de un DBMS puede limitar las caracter√≠sticas de la herramienta <br></td></tr></tbody></table></div>  En el caso de SQL Server, tenemos varias opciones: <br><div class="scrollable-table"><table><tbody><tr><th colspan="6" align="center">  Informaci√≥n general </th></tr><tr><th>  Nombre </th><th>  Enfoque </th><th>  Arquitectura </th><th>  Lengua / Plataforma </th><th>  Idioma de las pruebas </th></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">tSQLt</a> </td><td>  Impulsado por SQL </td><td>  xUnit </td><td>  T-SQL + CLR </td><td>  T-sql </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">TSQLUnit</a> </td><td>  Impulsado por SQL </td><td>  xUnit </td><td>  T-sql </td><td>  T-sql </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">utTSQL</a> </td><td>  Impulsado por SQL </td><td>  xUnit </td><td>  T-sql </td><td>  T-sql </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Tst</a> </td><td>  Impulsado por SQL </td><td>  xUnit </td><td>  T-sql </td><td>  T-sql </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Dbfit</a> </td><td>  No alimentado por sql </td><td>  Fitnessess </td><td>  C # / java </td><td>  Markdown de Wiki </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Vago</a> </td><td>  No alimentado por sql </td><td>  RSpec (orientado a BDD) </td><td>  Rub√≠ </td><td>  Rub√≠ </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">NUnit</a> , etc. </td><td>  No alimentado por sql </td><td>  xUnit </td><td>  N / a </td><td>  N / a </td></tr></tbody></table></div><div class="scrollable-table"><table><tbody><tr><th colspan="4" align="center">  Fechas </th></tr><tr><th>  Nombre </th><th>  Primera aparici√≥n </th><th>  √öltimo compromiso </th><th>  √öltimo lanzamiento </th></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">tSQLt</a> </td><td>  2007-07-27 </td><td>  07/07/2019 </td><td>  31/01/2016 </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">TSQLUnit</a> </td><td>  2006-12-16 (0.9) <br>  2007-07-21 (0.91 rc1) </td><td>  26/04/2018 (GitHub) </td><td>  04/09/2011 (SourceForge) </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">utTSQL</a> </td><td>  2003-03-12 </td><td>  2003-03-12 </td><td>  2003-03-12 </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Tst</a> </td><td>  02-03-2009 (v1.0) </td><td>  N / a </td><td>  30-03-2012 </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Dbfit</a> </td><td>  12-01-2009 </td><td>  10-09-2018 </td><td>  15/08/2015 </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Vago</a> </td><td>  23/06/2011 </td><td>  12-12-2018 </td><td>  12-12-2018 </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">NUnit</a> , etc. </td><td>  N / a </td><td>  N / a </td><td>  N / a </td></tr></tbody></table></div><div class="scrollable-table"><table><tbody><tr><th colspan="7" align="center">  Caracteristicas </th></tr><tr><th>  Nombre </th><th>  No se requiere CLR </th><th>  Salida XML </th><th>  Pruebas en transacciones separadas. </th><th>  Falsificaciones </th><th>  Manejadores de errores </th><th>  Aserciones </th></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">tSQLt</a> </td><td>  - </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  Excelente </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">TSQLUnit</a> </td><td>  + </td><td>  - </td><td>  + </td><td>  - </td><td>  - </td><td>  Fallando </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">utTSQL</a> </td><td>  + </td><td>  - </td><td>  - </td><td>  - </td><td>  - </td><td>  Por debajo del promedio </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Tst</a> </td><td>  + </td><td>  + </td><td>  + (opcional) </td><td>  - </td><td>  + </td><td>  Excelente </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Dbfit</a> </td><td>  + </td><td>  - </td><td>  + (opcional) </td><td>  - </td><td>  + </td><td>  Muy bueno  matizado </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Vago</a> </td><td>  + </td><td>  - </td><td>  + (opcional) </td><td>  - </td><td>  - </td><td>  Muy bueno  matizado </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">NUnit</a> , etc. </td><td>  + </td><td>  + </td><td>  N / a </td><td>  N / a </td><td>  N / a </td><td>  Excelente;  matizado </td></tr></tbody></table></div><div class="scrollable-table"><table><tbody><tr><th colspan="3" align="center">  Otros </th></tr><tr><th>  Nombre </th><th>  Documentaci√≥n </th><th>  Comunidad </th></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">tSQLt</a> </td><td>  Excelente;  matizado </td><td>  Excelente </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">TSQLUnit</a> </td><td>  Por debajo del promedio </td><td>  Por debajo del promedio </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">utTSQL</a> </td><td>  Excelente </td><td>  Por debajo del promedio </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Tst</a> </td><td>  Excelente </td><td>  Por debajo del promedio </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Dbfit</a> </td><td>  Excelente </td><td>  Media </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Vago</a> </td><td>  Excelente </td><td>  Media </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">NUnit</a> , etc. </td><td>  Excelente </td><td>  Excelente </td></tr></tbody></table></div>  La escala "Excelente - Fallido" es subjetiva, lo siento, es dif√≠cil encontrar una soluci√≥n. <br><br>  "Primera aparici√≥n" - la fecha m√°s temprana de aparici√≥n del framework que pude encontrar - la primera versi√≥n o confirmaci√≥n. <br><br>  Como puede ver, las alternativas basadas en SQL fueron abandonadas hace bastante tiempo, y tSQLt es el √∫nico producto actualmente compatible.  Adem√°s, tSQLt gana funcionalmente.  Lo √∫nico es que TST cuenta con un conjunto de afirmaciones un poco m√°s rico que tSQLt;  Sin embargo, dudo que esto pueda superar todas las desventajas. <br><br>  La documentaci√≥n de tSQLt tiene algunos matices, los describir√© m√°s adelante. <br><br>  En el mundo sin SQL, las cosas no est√°n tan claras.  Se est√°n desarrollando alternativas, aunque no s√∫per activas.  DbFit es una herramienta bastante interesante basada en el marco FitNesse.  Implica usar el marcado de wiki para escribir pruebas.  Slacker tambi√©n es interesante: se sugiere el enfoque BDD para las pruebas de c√≥digo DB. <br><br>  Debo decir sobre aserciones en soluciones no basadas en SQL.  A primera vista, la cantidad de afirmaciones es menor, y podemos pensar que tales herramientas son peores.  Pero debemos tener en cuenta que son fundamentalmente diferentes de tSQLt, por lo que una mirada tan superficial es incorrecta. <br><br>  La √∫ltima fila: "NUnit, etc."  - Es m√°s como un recordatorio.  Con la ayuda de bibliotecas adicionales, se pueden aplicar muchos marcos de pruebas unitarias habituales al c√≥digo DB.  Hay muchas N / A en esta fila porque esta fila, de hecho, incluye m√∫ltiples herramientas.  Esa es la fuente de "matices" en la columna "aserciones": diferentes herramientas pueden proporcionar diferentes conjuntos y no hay garant√≠a de que todas las aserciones puedan aplicarse a la base de datos. <br><br>  Como otra m√©trica interesante, podemos considerar las <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">tendencias de Google</a> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ud/2u/km/ud2ukmcoyjvstvhcu2taegpib34.png"></div><br>  Matices: <br><br><ol><li>  Decid√≠ no incluir Slacker porque este nombre puede significar cosas diferentes (y consultas como "Slacker framework" apenas se ven en el gr√°fico). </li><li>  Solo por curiosidad (y porque una ranura permaneci√≥ vac√≠a), agregu√© la tendencia TST.  Pero apenas nos muestra la imagen real porque es la abreviatura que tambi√©n puede significar cosas diferentes. </li><li>  No he incluido NUnit y sus an√°logos.  Estas herramientas son marcos para pruebas de c√≥digo "habituales", por lo que sus tendencias no son descriptivas para nuestro contexto. </li></ol><br>  Como puede ver, tSQLt es la herramienta m√°s buscable en la lista.  Otra herramienta (menos) popular es DbFit.  Otras herramientas tienen una popularidad limitada. <br><br>  En general, podemos ver que tSQLt brilla en el fondo. <br><br><h1>  ¬øQu√© es tSQLt? </h1><br>  Es f√°cil adivinar que tSQLt es un marco de pruebas unitarias basado en SQL.  El sitio oficial es <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://tsqlt.org</a> . <br><br>  Se promete que tSQLt es compatible con SQL Server a partir de 2005 SP2.  No he revisado tales revisiones tempranas, pero no veo ning√∫n problema con 2012 en nuestro servidor de desarrollo y 2017 en mi m√°quina local. <br><br>  C√≥digo abierto, licencia Apache 2.0, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">disponible en GitHub</a> .  Como de costumbre, podemos bifurcar, contribuir, usar de forma gratuita en proyectos comerciales y, lo que es m√°s importante, no debemos temer al spyware en CLR. <br><br><h1>  Mec√°nica </h1><br><div style="text-align:center;"><img width="85%" height="85%" src="https://habrastorage.org/webt/1v/kx/wi/1vkxwixwjyna756vsce7uhwqzw0.png"></div><br>  Los casos de prueba son procedimientos almacenados.  Se pueden combinar en clases de prueba (conjunto de pruebas en terminolog√≠a xUnit). <br><br>  Las clases de prueba no son m√°s que esquemas de base de datos.  tSQLt requiere registrarlos con el procedimiento NewTestClass que agrega clases de prueba a una tabla especial. <br><br>  Es posible determinar un procedimiento de configuraci√≥n.  Dicho procedimiento se ejecutar√° antes de cada caso de prueba separado. <br><br>  No se requiere el procedimiento de desmontaje despu√©s de la ejecuci√≥n del caso de prueba.  Cada caso de prueba con su configuraci√≥n se ejecuta en una transacci√≥n separada que se revierte despu√©s de la recopilaci√≥n de resultados.  Es muy conveniente pero tiene algunas consecuencias negativas: las describir√© un poco m√°s adelante. <br><br>  El marco permite ejecutar casos de prueba uno a la vez, todas las clases de prueba a la vez o incluso todas las clases de prueba registradas con un solo comando. <br><br><h1>  Caracter√≠sticas y ejemplos. </h1><br>  No dispuesto a repetir la gu√≠a oficial, mostrar√© las caracter√≠sticas de tSQLt en los ejemplos. <br><br>  <i>Descargo de responsabilidad:</i> <br><br><ul><li>  <i>los ejemplos son simplificados</i> </li><li>  <i>el c√≥digo original no es completamente m√≠o, son m√°s bien creaciones colectivas</i> </li><li>  <i>el ejemplo 2 es ficcionalizado por m√≠ para demostrar caracter√≠sticas m√°s completamente.</i> </li></ul><br><h3>  Ejemplo # 1: CsvSql </h3><br>  Lo siguiente se implement√≥ a pedido de uno de los clientes del cliente.  Hay consultas SQL almacenadas en los campos de Nvarchar (MAX).  Se crea una interfaz de usuario m√≠nima para verlos.  Los conjuntos de resultados generados por estas consultas se utilizan en el backend para componer m√°s como archivos CSV.  Los archivos CSV pueden solicitarse mediante una llamada API. <br><br><div style="text-align:center;"><img width="75%" height="75%" src="https://habrastorage.org/webt/5q/mu/oy/5qmuoyyjjvlphk79jt-xtawwjn8.png"></div><br>  Los conjuntos de resultados son grandes y contienen una gran cantidad de columnas.  Un ejemplo hipot√©tico de tal conjunto de resultados: <br><br><div style="text-align:center;"><img width="75%" height="75%" src="https://habrastorage.org/webt/dg/50/bb/dg50bbx25qaw6ycwpfqcsfj5kyk.png"></div><br>  Este conjunto de resultados representa datos de ensayos cl√≠nicos.  Echemos un vistazo m√°s de cerca al c√°lculo [ClinicsNum].  Tenemos 2 tablas: [Trial] y [Clinic]. <br><br><div style="text-align:center;"><img width="85%" height="85%" src="https://habrastorage.org/webt/qo/mu/n-/qomun-gdbdl05teniypbtzi8jio.png"></div><br>  Hay un FK: [Cl√≠nica]. [TrialID] -&gt; [Trial]. [TrialID].  Obviamente, es suficiente usar COUNT (*) para obtener varias cl√≠nicas: <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(*), ...  <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dbo.Trial  <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> dbo.Clinic    <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> Trial.ID = Clinic.TrialID  <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> Trial.Name = @trialName  <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> ...</code> </pre> <br>  ¬øC√≥mo podemos probar tal consulta?  Primero, usemos stub FakeTable, lo que har√° que nuestro trabajo posterior sea mucho m√°s f√°cil. <br><br><pre> <code class="plaintext hljs">EXEC tSQLt.FakeTable 'dbo.Trial'; EXEC tSQLt.FakeTable 'dbo.Clinic';</code> </pre> <br>  FakeTable hace una cosa simple: renombra tablas viejas y crea nuevas con el mismo nombre.  Los mismos nombres, las mismas columnas, pero sin restricciones ni desencadenantes. <br><br>  Necesitamos esto porque: <br><br><ol><li>  Test DB puede contener algunos datos que pueden evitar una ejecuci√≥n correcta de la prueba.  FakeTable nos permite no depender de ellos. </li><li>  Por lo general, solo necesitamos llenar unas pocas columnas para los prop√≥sitos de la prueba.  La tabla puede contener muchos de ellos, a menudo con restricciones y desencadenantes.  Hacemos que sea m√°s f√°cil insertar datos m√°s tarde: insertaremos solo lo requerido para la informaci√≥n de la prueba, manteniendo la prueba lo m√°s minimalista posible. </li><li>  No habr√° ejecuciones de disparador no deseadas, por lo que no debemos preocuparnos por los efectos posteriores. </li></ol><br>  Luego insertamos los datos de prueba requeridos: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> dbo.Trial ([<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>], [<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>,   <span class="hljs-string"><span class="hljs-string">'Valerian'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> dbo.Clinic ([<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>], [TrialID], [<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>,   <span class="hljs-number"><span class="hljs-number">1</span></span>,        <span class="hljs-string"><span class="hljs-string">'Clinic1'</span></span>), (<span class="hljs-number"><span class="hljs-number">2</span></span>,   <span class="hljs-number"><span class="hljs-number">1</span></span>,        <span class="hljs-string"><span class="hljs-string">'Clinic2'</span></span>);</code> </pre> <br>  Derivamos la consulta del DB, creamos la tabla [Actual] y la llenamos con el resultado <br>  establecido desde la consulta. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @sqlStatement <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) = (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span>‚Ä¶ <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> actual ([TrialID], ...); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> actual EXEC sp_executesql @sqlStatement, ...</code> </pre> <br>  Ahora, llenamos [Esperado] - nuestros valores esperados: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> expected (   ClinicsNum <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> expected <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span></code> </pre> <br>  Quiero llamar su atenci√≥n de que solo tenemos una columna en la tabla [Esperado], aunque tenemos el conjunto completo en la columna [Actual]. <br><br><div style="text-align:center;"><img width="80%" height="80%" src="https://habrastorage.org/webt/qd/gx/ga/qdgxgaqr4cjp2eayoz0eycjs8cg.png"></div><br>  Esto se debe a una caracter√≠stica √∫til del procedimiento AssertEqualsTable que usaremos para la verificaci√≥n de valores. <br><br><pre> <code class="sql hljs">EXEC tSQLt.AssertEqualsTable   'expected',   'actual',   'incorrect number of clinics';</code> </pre> <br>  Compara solo las columnas que se presentan en ambas tablas.  Es muy conveniente en nuestro caso porque la consulta bajo prueba devuelve muchas columnas, cada una conectada con una l√≥gica bastante complicada.  No queremos inflar los casos de prueba, por lo que esta caracter√≠stica realmente ayuda.  Por supuesto, esta caracter√≠stica es una espada de doble filo.  Si se completa [Actual] a trav√©s de SELECT TOP 0 y en un momento aparece una columna inesperada, tal caso de prueba no captar√° esto.  Debe escribir cheques adicionales para cubrir esto. <br><br><h3>  AssertEqualsTable procedimientos gemelos </h3><br>  Vale la pena mencionar que tSQLt contiene 2 procedimientos como AssertEqualsTable.  Son AssertEqualsTableSchema y AssertResultSetsHaveSameMetaData.  El primero hace lo mismo que AssertEqualsTable pero en los metadatos de las tablas.  El segundo hace lo mismo pero en los metadatos de los conjuntos de resultados. <br><br><h3>  Ejemplo # 2: restricciones </h3><br>  El ejemplo anterior nos mostr√≥ c√≥mo podemos eliminar restricciones.  Pero, ¬øy si necesitamos verificarlos?  T√©cnicamente, las restricciones tambi√©n son parte de la l√≥gica, y pueden considerarse como un candidato para la cobertura mediante pruebas. <br><br>  Considere la situaci√≥n del ejemplo anterior.  2 tablas: [Trial] y [Clinic];  [TrialID] FK: <br><br><div style="text-align:center;"><img width="80%" height="80%" src="https://habrastorage.org/webt/-8/zu/v3/-8zuv3clqoo3ygm9wko5hpibc90.png"></div><br>  Intentemos escribir un caso de prueba para verificarlo.  Primero, como en el caso anterior, falsificamos las tablas: <br><br><pre> <code class="sql hljs">EXEC tSQLt.FakeTable '[dbo].[Trial]' EXEC tSQLt.FakeTable '[dbo].[Clinic]'</code> </pre> <br>  El objetivo es el mismo: deshacerse de los l√≠mites innecesarios.  Queremos cheques aislados sin esfuerzo excesivo. <br><br>  A continuaci√≥n, devolvemos la restricci√≥n que queremos probar usando ApplyConstraint: <br><br><pre> <code class="sql hljs">EXEC tSQLt.ApplyConstraint   '[dbo].[Clinic]',   'Trial_FK';</code> </pre> <br>  Ahora tenemos una configuraci√≥n para la verificaci√≥n.  La comprobaci√≥n en s√≠ misma es que intentar insertar datos provocar√° una excepci√≥n.  Para el caso de prueba que pasa necesitamos capturar esta excepci√≥n.  El controlador de excepciones ExpectException puede ayudar. <br><br><pre> <code class="sql hljs">EXEC tSQLt.ExpectException   @ExpectedMessage = 'The <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">statement</span></span> conflicted...<span class="hljs-string"><span class="hljs-string">',   @ExpectedSeverity = 16,   @ExpectedState = 0;</span></span></code> </pre> <br>  Podemos intentar insertar no insertables despu√©s de la configuraci√≥n del controlador. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> [dbo].[Clinic] ([TrialID])   <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre> <br>  La excepci√≥n fue atrapada.  Pase de prueba <br><br><h3>  Aplicar procedimientos gemelos de restricci√≥n </h3><br>  La forma de probar los desencadenantes propuestos por los autores de tSQLt es similar a las restricciones de prueba.  Podemos usar el procedimiento ApplyTrigger para devolver el activador a la tabla.  Despu√©s de eso, todo va como en el ejemplo anterior: inicie el disparador, verifique el resultado. <br><br><h3>  ExpectNoException - el ant√≥nimo de ExpectException </h3><br>  Existe un procedimiento ExpectNoException para los casos en que no debe ocurrir una excepci√≥n.  Funciona de la misma manera que ExpectException, excepto que la prueba falla en caso de que ocurra una excepci√≥n. <br><br><h3>  Ejemplo # 3: Sem√°foro </h3><br>  Hay algunos procedimientos almacenados y servicios de Windows.  El inicio de su ejecuci√≥n puede ser causado por diferentes eventos externos.  Sin embargo, el orden de su ejecuci√≥n es fijo.  Por lo tanto, es necesario implementar el control de acceso en el lado de la base de datos, es decir, un sem√°foro.  En nuestro caso, el sem√°foro es un grupo de procedimientos almacenados que trabajan juntos. <br><br>  Veamos un procedimiento dentro del sem√°foro.  Tenemos 2 tablas: [Proceso] y [ProcStatus]: <br><br><div style="text-align:center;"><img width="80%" height="80%" src="https://habrastorage.org/webt/-m/hz/8-/-mhz8-fm_n1w7njpryiv8z3epiw.png"></div><br>  La tabla [Proceso] contiene una lista de procesos permitidos para la ejecuci√≥n.  [ProcStatus], obviamente, contiene la lista de estados del proceso de la tabla anterior. <br><br>  Entonces, ¬øqu√© hace nuestro procedimiento?  Primero, realiza las siguientes verificaciones: <br><br><ol><li>  Hemos pasado un nombre de proceso como uno de los par√°metros de entrada del procedimiento.  Este nombre se busca en el campo [Nombre] de la tabla [Proceso]. </li><li>  Si se ha encontrado el nombre del proceso, verifica el indicador [IsRunable] de la tabla [Proceso]. </li><li>  Si el indicador est√° activado, consideramos que el proceso puede ejecutarse.  La √∫ltima comprobaci√≥n se realiza en la tabla [ProcStatus].  Necesitamos asegurarnos de que el proceso no se est√© ejecutando actualmente, lo que significa la ausencia de registros sobre el proceso con el estado "InProg" en la tabla [ProcStatus]. </li></ol><br>  Si todo est√° bien y se pasan todas las comprobaciones, agregamos un nuevo registro sobre nuestro proceso en la tabla [ProcStatus] con el estado "InProg".  El ID de este nuevo registro se devuelve con el par√°metro de salida ProcStatusId. <br><br>  Si algo ha salido mal, esperamos lo siguiente: <br><br><ol><li>  Se env√≠a un correo electr√≥nico a un administrador del sistema. </li><li>  ProcStatusId = -1 se devuelve. </li><li>  No se agregaron nuevos registros [ProcStatus]. </li></ol><br>  Creemos un caso de prueba para verificar el caso de ausencia de proceso en la tabla [Proceso]. <br><br>  Usamos FakeTable nuevamente.  Aqu√≠ no es tan cr√≠tico, pero puede ser conveniente porque: <br><br><ol><li>  Se garantiza que no habr√° datos que puedan interrumpir la ejecuci√≥n del caso de prueba. </li><li>  La verificaci√≥n adicional de la nueva ausencia de registros [ProcStatus] se simplificar√°. </li></ol><br><pre> <code class="sql hljs">EXEC tSQLt.FakeTable 'dbo.Process'; EXEC tSQLt.FakeTable 'dbo.ProcStatus';</code> </pre> <br>  Hay un procedimiento [SendEmail] cuyo nombre habla por s√≠ mismo.  Necesitamos atender su llamada.  tSQLt sugiere usar el simulacro SpyProcedure para eso. <br><br><pre> <code class="plaintext hljs">EXEC tSQLt.SpyProcedure 'dbo.SendEmail'</code> </pre> <br>  SpyProcedure hace lo siguiente: <br><br><ol><li>  Crea una tabla con un nombre que se parece a [dbo]. [ProcedureName_SpyProcedureLog] </li><li>  Al igual que FakeTable, reemplaza el procedimiento original con uno generado autom√°ticamente, con el mismo nombre, pero con l√≥gica de registro en su interior.  Tambi√©n puede agregar su propia l√≥gica al procedimiento generado si es necesario. </li></ol><br>  No es dif√≠cil adivinar que los registros se graban en la tabla [dbo]. [SendEmail_SpyProcedureLog].  Esta tabla contiene una columna [_ID_] que es para los n√∫meros de secuencia de las llamadas.  Las columnas posteriores se nombran despu√©s de los par√°metros pasados ‚Äã‚Äãal procedimiento y se utilizan para recopilarlos, por lo que los valores de los par√°metros tambi√©n se pueden verificar. <br><br><div style="text-align:center;"><img width="75%" height="75%" src="https://habrastorage.org/webt/ko/gh/4h/kogh4hgcdsxagldk2bmdcfrptzi.png"></div><br>  Lo √∫ltimo que debemos hacer antes de la llamada del sem√°foro es crear una variable para almacenar el valor [ProcStatusId] (para ser m√°s exactos, -1, ya que el registro no se agregar√°). <br><br><pre> <code class="plaintext hljs">DECLARE @ProcStatusId BIGINT;</code> </pre> <br>  Llamamos al sem√°foro: <br><br><pre> <code class="plaintext hljs">EXEC dbo.[Semaphore_JobStarter]   'SomeProcess',   @ProcStatusId OUTPUT; -- here we get -1</code> </pre> <br>  Ahora tenemos todos los datos necesarios para las verificaciones.  Comencemos por verificar <br>  que el mensaje ha sido enviado. <br><br><pre> <code class="plaintext hljs">IF NOT EXISTS (   SELECT *   FROM dbo.SendEmail_SpyProcedureLog) EXEC tSQLt.Fail 'SendEmail has not been run.';</code> </pre> <br>  En este caso, no verificamos los par√°metros pasados ‚Äã‚Äãy probamos solo el env√≠o.  Quiero llamar su atenci√≥n sobre el procedimiento de falla.  Nos permite "oficialmente" fallar un caso de prueba.  Si necesita construir una construcci√≥n sofisticada, Fail puede ayudarlo. <br><br>  Ahora verificamos la ausencia de registros en la tabla [ProcStatus] con el procedimiento AssertEmptyTable. <br><br><pre> <code class="plaintext hljs">EXEC tSQLt.AssertEmptyTable 'dbo.ProcStatus';</code> </pre> <br>  Aqu√≠ es donde FakeTable que utilizamos al principio nos ayud√≥.  Con √©l, podemos esperar una tabla vac√≠a y probar usando una sola l√≠nea de c√≥digo.  La forma correcta de verificar esto sin falsificar la tabla ser√≠a comparar el n√∫mero de filas antes y despu√©s de la ejecuci√≥n del procedimiento, y eso requerir√≠a m√°s acciones. <br><br>  Podemos verificar f√°cilmente la igualdad ProcStatusId = -1 con AssertEquals. <br><br><pre> <code class="sql hljs">EXEC tSQLt.AssertEquals   -1,       @ProcStatusId,       'Wrong ProcStatusId.';</code> </pre> <br>  AssertEquals es minimalista.  Simplemente compara 2 valores, nada extraordinario. <br><br><h3>  AssertEquals procedimientos gemelos </h3><br>  Tenemos los siguientes procedimientos para la comparaci√≥n de valores: <br><br><ul><li>  AssertEquals </li><li>  AssertNotEquals </li><li>  AssertEqualsString </li><li>  Asertivo </li></ul><br>  Los nombres se explican por s√≠ mismos, creo.  El √∫nico procedimiento que quiero enfatizar es AssertEqualsString.  Es el procedimiento dedicado a la verificaci√≥n de valores de cadena.  ¬øPor qu√© necesitamos un procedimiento m√°s, considerando los AssertEquals universales dados?  La cuesti√≥n es que AssertEquals / AssertNotEquals / AssertLike funciona con el tipo SQL_VARIANT.  NVARCHAR (MAX) no est√° incluido en SQL_VARIANT, por lo que los desarrolladores de tSQLt tuvieron que realizar un procedimiento adicional. <br><br><h3>  Funci√≥n falsa </h3><br>  En un momento, podemos llamar a FakeFunction un procedimiento similar a SpyProcedure.  Este falso permite reemplazar cualquier funci√≥n por una m√°s simple.  Como las funciones de SQL Server funcionan como un tubo de pasta de dientes (el resultado se devuelve a trav√©s del √∫nico "agujero"), es t√©cnicamente imposible implementar una funcionalidad de registro.  El reemplazo de la l√≥gica interna es la √∫nica forma disponible. <br><br><h1>  Trampas </h1><br>  Quiero contarte algunos problemas que puedes enfrentar durante el uso de tSQLt.  En este caso, "dificultades" significan algunos problemas causados ‚Äã‚Äãpor restricciones de SQL Server y / o que los desarrolladores de framework no pueden resolver. <br><br><h3>  Transacciones de reversi√≥n y condena </h3><br>  El primer y principal problema que enfrenta nuestro equipo es la reversi√≥n de transacciones y la condena.  SQL Server no puede revertir la transacci√≥n anidada por separado.  Siempre revierte todas las transacciones hasta el extremo exterior.  Teniendo en cuenta que tSQLt envuelve cada prueba en una transacci√≥n separada, puede convertirse en un problema porque la reversi√≥n dentro de un procedimiento almacenado puede interrumpir una ejecuci√≥n de prueba con un error de ejecuci√≥n no descriptivo. <br><br>  Como soluci√≥n alternativa, utilizamos puntos de guardado.  La idea es simple.  Al principio, verificamos si estamos dentro de una transacci√≥n o no.  En caso afirmativo, suponemos que es una transacci√≥n tSQLt y ponemos un punto de rescate, por lo que volveremos a hacerlo si es necesario.  Si no, comenzamos una nueva transacci√≥n.  De hecho, no permitimos anidar. <br><br><div style="text-align:center;"><img width="85%" height="85%" src="https://habrastorage.org/webt/bu/ih/vl/buihvlf1ffnwuzbotecbqtev09o.png"></div><br>  El problema se complica por la cancelaci√≥n de transacciones: puede suceder si se produce una excepci√≥n.  Una transacci√≥n condenada no puede confirmarse ni revertirse a un punto de rescate, por lo que debemos revertirla a la transacci√≥n m√°s externa nuevamente. <br><br>  Teniendo en cuenta los puntos descritos anteriormente, debemos utilizar la siguiente estructura: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @isNestedTransaction <span class="hljs-built_in"><span class="hljs-built_in">BIT</span></span> =   <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> @@trancount &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'true'</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-string"><span class="hljs-string">'false'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> TRY   <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @isNestedTransaction = <span class="hljs-string"><span class="hljs-string">'false'</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">SAVE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span> SavepointName;       <span class="hljs-comment"><span class="hljs-comment">-- something useful   IF @isNestedTransaction = 'false'   COMMIT TRANSACTION; END TRY BEGIN CATCH   DECLARE @isCommitable BIT =       CASE WHEN XACT_STATE() = 1           THEN 'true'           ELSE 'false'   END;   IF @isCommitable = 'true' AND @isNestedTransaction = 'true'       ROLLBACK TRANSACTION SavepointName;   ELSE       ROLLBACK;   THROW; END CATCH;</span></span></code> </pre> <br>  Repasemos el c√≥digo pieza por pieza.  Primero, necesitamos determinar si estamos dentro de una transacci√≥n o no. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @isNestedTransaction <span class="hljs-built_in"><span class="hljs-built_in">BIT</span></span> =   <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> @@trancount &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'true'</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-string"><span class="hljs-string">'false'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>;</code> </pre> <br>  Despu√©s de obtener el indicador @isNestedTransaction, podemos iniciar el bloque TRY y establecer un punto de guardado o iniciar una transacci√≥n seg√∫n la situaci√≥n. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> TRY   <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @isNestedTransaction = <span class="hljs-string"><span class="hljs-string">'false'</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">SAVE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span> SavepointName;       <span class="hljs-comment"><span class="hljs-comment">-- something useful</span></span></code> </pre> <br>  Despu√©s de hacer algo √∫til, confirmamos los resultados si se trata de un procedimiento "real" ejecutado. <br><br><pre> <code class="sql hljs">       <span class="hljs-comment"><span class="hljs-comment">-- something useful   IF @isNestedTransaction = 'false'   COMMIT TRANSACTION; END TRY</span></span></code> </pre> <br>  Por supuesto, si se trata de un caso de prueba, no necesitamos comprometer nada.  tSQLt revertir√° los cambios al final autom√°ticamente. <br><br>  Si algo ha salido mal y nos metemos en el bloque CATCH, debemos determinar si la transacci√≥n es confirmable o no. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> CATCH   <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @isCommitable <span class="hljs-built_in"><span class="hljs-built_in">BIT</span></span> =       <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> XACT_STATE() = <span class="hljs-number"><span class="hljs-number">1</span></span>           <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'true'</span></span>           <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-string"><span class="hljs-string">'false'</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>;</code> </pre> <br>  Podemos retroceder al punto de guardado solo si: <br><br><ol><li>  La transacci√≥n es commitable </li><li>  Es una prueba de funcionamiento, entonces existe un punto de rescate. </li></ol><br>  En todos los dem√°s casos, debemos revertir toda la transacci√≥n. <br><br><pre> <code class="sql hljs">   IF @isCommitable = 'true' AND @isNestedTransaction = 'true'       <span class="hljs-keyword"><span class="hljs-keyword">ROLLBACK</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span> SavepointName;   ELSE       <span class="hljs-keyword"><span class="hljs-keyword">ROLLBACK</span></span>;   THROW; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> CATCH;</code> </pre> <br>  S√≠, desafortunadamente, si hemos alcanzado un estado de transacci√≥n no confirmable durante una ejecuci√≥n de prueba, a√∫n obtenemos el error de ejecuci√≥n. <br><br><h3>  Faketable y la cuesti√≥n de la clave extranjera </h3><br>  Repasemos las tablas familiares [Prueba] y [Cl√≠nica] <br><br><div style="text-align:center;"><img width="85%" height="85%" src="https://habrastorage.org/webt/fy/k7/nm/fyk7nmhfha_fnezignyxclpflay.png"></div><br>  Recordamos sobre [TrialID] FK.  ¬øQu√© problema puede causar?  En los ejemplos anteriores, aplicamos FakeTable en ambas tablas.  Si lo usamos solo en uno de ellos, alcanzaremos la siguiente configuraci√≥n: <br><br><div style="text-align:center;"><img width="85%" height="85%" src="https://habrastorage.org/webt/og/to/3-/ogto3-drjheieblpi1_gsyup4hs.png"></div><br>  Por lo tanto, un intento de insertar un registro en [Cl√≠nica] puede fallar incluso si hemos preparado los datos en la versi√≥n falsa de [Prueba]. <br><br><pre> <code class="sql hljs">[dbo].[Test_FK_Problem] failed: (Error) The <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">statement</span></span> conflicted <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constraint</span></span> <span class="hljs-string"><span class="hljs-string">"Trial_Fk"</span></span>. The conflict occurred <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">database</span></span> <span class="hljs-string"><span class="hljs-string">"HabrDemo"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-string"><span class="hljs-string">"dbo.tSQLt_tempobject_ba8f36353f7a44f6a9176a7d1db02493"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">column</span></span> <span class="hljs-string"><span class="hljs-string">'TrialID'</span></span>.[<span class="hljs-number"><span class="hljs-number">16</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>]{Test_FK_Problem,<span class="hljs-number"><span class="hljs-number">14</span></span>}</code> </pre> <br>  Conclusi√≥n: falso todo o ninguno.  En caso de que ninguno, obviamente, debe preparar una base de datos con todos los datos de prueba requeridos. <br><br><h3>  SpyProcedure sobre procedimientos del sistema </h3><br>  Desafortunadamente, no podemos espiar los procedimientos del sistema: <br><br><pre> <code class="sql hljs">[HabrDemo].[test_test] failed: (Error) Cannot <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> SpyProcedure <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> sys.sp_help because the <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> does <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> exist[<span class="hljs-number"><span class="hljs-number">16</span></span>,<span class="hljs-number"><span class="hljs-number">10</span></span>] {tSQLt.Private_ValidateProcedureCanBeUsedWithSpyProcedure,<span class="hljs-number"><span class="hljs-number">7</span></span>}</code> </pre> <br>  En el ejemplo del sem√°foro, rastreamos llamadas del procedimiento [SendEmail], que fue creado por nuestros desarrolladores.  En este caso, no se requer√≠a solo mediante pruebas.  Era necesario crear un procedimiento separado porque es necesario preparar algunos datos antes de enviarlos.  Pero debe estar mentalmente preparado para escribir un procedimiento de capa intermedia para cumplir con los objetivos de la prueba. <br><br><h1>  Pros </h1><br><h3>  Instalaci√≥n r√°pida </h3><br>  La instalaci√≥n de tSQLt consta de 2 pasos y toma alrededor de 2 minutos.  Debe activar CLR si no est√° activo actualmente y ejecutar un solo script SQL.  Eso es todo: ahora puede agregar su primera clase de prueba y escribir casos de prueba. <br><br><h3>  Aprendizaje r√°pido </h3><br>  tSQLt es f√°cil de aprender.  Me llev√≥ un poco m√°s de un d√≠a de trabajo.  Le pregunt√© a mis colegas y parece que tambi√©n toma alrededor de 1 d√≠a laboral para otros.  Dudo que pueda tomar mucho m√°s tiempo. <br><br><h3>  Integraci√≥n r√°pida de CI </h3><br>  Tom√≥ alrededor de 2 horas configurar la integraci√≥n de CI en nuestro proyecto.  El tiempo puede variar, por supuesto, pero no es un problema en general, y se puede hacer r√°pidamente. <br><br><h3>  Un amplio conjunto de instrumentos. </h3><br>  Es subjetivo, pero en mi opini√≥n, la funcionalidad tSQLt es rica y la mayor parte de las necesidades pueden ser cubiertas por ella.  Si no es suficiente, siempre puede usar el procedimiento Fail para casos raros y sofisticados. <br><br><h3>  Documentaci√≥n conveniente </h3><br>  Las gu√≠as oficiales son convenientes y consistentes.  Puede comprender f√°cilmente el uso de tSQLt en un per√≠odo corto, incluso si es su primera herramienta de prueba de unidad. <br><br><h3>  Salida clara </h3><br>  La salida de prueba se puede tomar en un formato de texto ilustrativo: <br><br><pre> <code class="plaintext hljs">[tSQLtDemo].[test_error_messages] failed: (Failure) Expected an error to be raised. [tSQLtDemo].[test_tables_comparison] failed: (Failure) useful and descriptive error message Unexpected/missing resultset rows! |_m_|Column1|Column2| +---+-------+-------+ |&lt; |2 |Value2 | |= |1 |Value1 | |= |3 |Value3 | |&gt; |2 |Value3 | +----------------------+ |Test Execution Summary| +----------------------+ |No|Test Case Name |Dur(ms)|Result | +--+------------------------------------+-------+-------+ |1 |[tSQLtDemo].[test_constraint] | 83|Success| |2 |[tSQLtDemo].[test_trial_view] | 83|Success| |3 |[tSQLtDemo].[test_error_messages] | 127|Failure| |4 |[tSQLtDemo].[test_tables_comparison]| 147|Failure| ----------------------------------------------------------------------------- Msg 50000, Level 16, State 10, Line 1 Test Case Summary: 4 test case(s) executed, 2 succeeded, 2 failed, 0 errored. -----------------------------------------------------------------------------</code> </pre><br>  Tambi√©n se puede derivar del DB (cliqueable) ... <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/webt/-f/83/la/-f83lajcz1mfcnkhtttz45b0x3g.png"></a> </div><br>  ... o incluso como XML. <br><br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">testsuites</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">testsuite</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tSQLtDemo"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">tests</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"3"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">errors</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">failures</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">timestamp</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2019-06-22T16:46:06"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">time</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0.433"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">hostname</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"BLAHBLAHBLAH\SQL2017"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">package</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tSQLt"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">properties</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">testcase</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">classname</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tSQLtDemo"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"test_constraint"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">time</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0.097"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">testcase</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">classname</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tSQLtDemo"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"test_error_messages"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">time</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0.153"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">failure</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">message</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Expected an error to be raised."</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tSQLt.Fail"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">testcase</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">testcase</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">classname</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tSQLtDemo"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"test_trial_view"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">time</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0.156"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system-out</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system-err</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">testsuite</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">testsuites</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  El √∫ltimo formato permite la integraci√≥n de CI sin ning√∫n problema.  Espec√≠ficamente, usamos tSQLt junto con Atlassian Bamboo. <br><br><h3>  Apoyo de redgate </h3><br>  Como uno de los profesionales, puedo nombrar el soporte de uno de los mayores proveedores de herramientas de DBA: RedGate.  Su complemento de SQL Server Management Studio llamado SQL Test funciona con tSQLt desde el principio.  Adem√°s, RedGate ayuda al desarrollador principal de tSQLt con dev-environment, seg√∫n sus palabras en los <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">grupos de Google</a> . <br><br><h1>  Contras </h1><br><h3>  No hay tablas temporales falsificadas </h3><br>  tSQLt no permite falsificar tablas temporales.  Pensamientos, en caso de necesidad, puede usar un complemento no oficial.  Desafortunadamente, este complemento funciona solo con SQL Server 2016+. <br><br><h3>  Trabajar con bases de datos externas </h3><br>  tSQLt est√° dise√±ado para funcionar con el c√≥digo en la misma base de datos en la que est√° instalado el marco.  Por lo tanto, puede ser imposible usarlo con un DB externo.  Al menos, las falsificaciones no funcionar√°n. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> [tSQLtDemo].[test_outer_db] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP <span class="hljs-number"><span class="hljs-number">10</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [AdventureWorks2017].[Person].[<span class="hljs-keyword"><span class="hljs-keyword">Password</span></span>]   EXEC tSQLt.FakeTable <span class="hljs-string"><span class="hljs-string">'[AdventureWorks2017].[Person].[Password]'</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP <span class="hljs-number"><span class="hljs-number">10</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [AdventureWorks2017].[Person].[<span class="hljs-keyword"><span class="hljs-keyword">Password</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">END</span></span></code> </pre><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ga/au/ny/gaaunygdr124sssxhonbb2s0b_0.png"></div><br>  Parece que las afirmaciones funcionan, pero su viabilidad no est√° garantizada, por supuesto. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> [tSQLtDemo].[test_outer_db_assertions] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP <span class="hljs-number"><span class="hljs-number">1</span></span> *   <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-comment"><span class="hljs-comment">#Actual   FROM [AdventureWorks2017].[Person].[Password]   SELECT *   INTO #Expected   FROM (          SELECT 'bE3XiWw=' AS [PasswordSalt]   ) expectedresult;   EXEC tSQLt.AssertEqualsTable '#Expected', '#Actual', 'The salt is not salty'; END</span></span></code> </pre> <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/cg/dk/ow/cgdkowych69imevqmbirkkgsniq.png"></div><br><h3>  Errores de documentaci√≥n </h3><br>  A pesar de que mencion√© anteriormente que las gu√≠as son convenientes y consistentes, la documentaci√≥n tiene algunos problemas.  Contiene partes obsoletas. <br><br>  Ejemplo 1. La <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">‚ÄúGu√≠a de inicio r√°pido‚Äù</a> sugiere descargar el marco de SourceForge. <br>  Se mudaron de SourceForge <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">hasta 2015</a> . <br><br>  Ejemplo 2. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">La gu√≠a ApplyConstraint</a> utiliza un dise√±o voluminoso con el procedimiento Fail dentro de un ejemplo de captura de excepci√≥n.  Esto se puede reemplazar con un c√≥digo simple y claro usando ExpectException. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> ConstraintTests.[<span class="hljs-keyword"><span class="hljs-keyword">test</span></span> ReferencingTable_ReferencedTable_FK prevents <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> orphaned <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> EXEC tSQLt.FakeTable <span class="hljs-string"><span class="hljs-string">'dbo.ReferencedTable'</span></span>; EXEC tSQLt.FakeTable 'dbo.ReferencingTable'; EXEC tSQLt.ApplyConstraint 'dbo.ReferencingTable','ReferencingTable_ReferencedTable_FK'; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @ErrorMessage <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @ErrorMessage = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* [NB] Why don't we use ExceptException below? */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> TRY <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> dbo.ReferencingTable ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, ReferencedTableId ) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> ( <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">11</span></span> ) ; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> TRY <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> CATCH <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @ErrorMessage = ERROR_MESSAGE(); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> CATCH <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @ErrorMessage <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIKE</span></span> <span class="hljs-string"><span class="hljs-string">'%ReferencingTable_ReferencedTable_FK%'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> EXEC tSQLt.Fail <span class="hljs-string"><span class="hljs-string">'Expected error message containing ''ReferencingTable_ReferencedTable_FK'' but got: '''</span></span>,@ErrorMessage,<span class="hljs-string"><span class="hljs-string">'''!'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre><br>  Y esto se espera, debido a ... <br><br><h3>  Abandono parcial </h3><br>  Hubo una pausa prolongada en el desarrollo desde principios de 2016 hasta junio de 2019. S√≠, desafortunadamente, esta herramienta est√° parcialmente abandonada.  El desarrollo comenz√≥ lentamente en 2019, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">seg√∫n GitHub</a> .  Aunque los Grupos de Google oficiales <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">tienen un hilo</a> en el que se le pregunt√≥ a Sebastian, el desarrollador principal de tSQLt, sobre el futuro del proyecto.  La √∫ltima pregunta se hizo el 2 de marzo de 2019, sin respuesta. <br><br><h3>  Problema de SQL Server 2017 </h3><br>  La instalaci√≥n de tSQLt puede requerir algunas acciones adicionales si est√° utilizando SQL Server 2017. Microsoft implement√≥ el primer cambio de seguridad desde 2012 en esta versi√≥n.  Se ha agregado el indicador de nivel de servidor "Seguridad estricta CLR".  Este indicador no permite la creaci√≥n de conjuntos sin firmar '(incluso SAFE).  La descripci√≥n detallada merece un art√≠culo separado (y, afortunadamente, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ya tenemos</a> uno bueno; vea tambi√©n los siguientes art√≠culos en la secuencia. Solo prep√°rese mentalmente para esto. <br><br>  Por supuesto, podr√≠a atribuir este problema a las "trampas", pero los desarrolladores de tSQLt pueden resolver este problema.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">El problema de GitHub ya ha surgido</a> .  A√∫n as√≠, no se ha resuelto desde octubre de 2017. <br><br><h1>  Alternativas (¬±) para otros DBMS </h1><br>  tSQLt no es √∫nico en su clase.  Aunque no puede usarlo en otros DBMS debido a los matices CLR y T-SQL, a√∫n puede encontrar algo similar.  Vale la pena mencionar que estas alternativas no est√°n muy cerca de tSQLt, por lo que me refiero al enfoque basado en SQL. <br><br>  Por ejemplo, los usuarios de PostgreSQL pueden probar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">pgTAP</a> .  Es una herramienta bien desarrollada y en desarrollo activo que utiliza PL / pgSQL nativo para pruebas y formato de salida TAP.  La herramienta similar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">MyTap</a> puede ayudarlo con las pruebas en MySQL.  Este marco es un poco menos funcional que pgTAP pero a√∫n puede ser √∫til.  Y tambi√©n est√° en desarrollo activo.  Si es un usuario feliz de Oracle, tiene la oportunidad de usar la herramienta muy poderosa <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">utPLSQL</a> .  Se est√° desarrollando de manera muy activa y ofrece una gran cantidad de caracter√≠sticas. <br><br><h1>  Conclusi√≥n </h1><br>  Quer√≠a transmitir 2 ideas: <br><br>  El primero: la utilidad de las pruebas de c√≥digo DB.  No es importante si est√° utilizando SQL Server, Oracle, MySQL u otra cosa.  Si su base de datos contiene l√≥gica no probada, est√° tomando riesgos.  Como todos los dem√°s errores en el resto del c√≥digo, los errores del c√≥digo DB pueden da√±ar el producto y la compa√±√≠a que lo proporciona. <br><br>  El segundo: la elecci√≥n de la herramienta.  Para aquellos que trabajan con SQL Server, tSQLt, incluso si no es un ganador del 100%, sin duda merece atenci√≥n.  A pesar del lento desarrollo y algunos problemas, sigue siendo un marco pr√°ctico que podr√≠a hacer que su trabajo sea mucho m√°s f√°cil. <br><br><div class="spoiler">  <b class="spoiler_title">Fuentes que me ayudaron (lista no exhaustiva)</b> <div class="spoiler_text">  DbFit - Pruebas automatizadas de bases de datos de c√≥digo abierto: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">http://www.methodsandtools.com/tools/dbfit.php</a> <br><br>  Documentaci√≥n de DbFit: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://dbfit.github.io/dbfit/docs/</a> <br><br>  Wiki de Slacker: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://github.com/vassilvk/slacker/wiki</a> <br><br>  Documentaci√≥n de TST: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://archive.codeplex.com/projects/TST/4e04e281-9f35-4891-809a-15f09d304f4e</a> <br><br>  Afirmaciones de NUnit: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://github.com/nunit/docs/wiki/Assertions</a> <br><br>  C√≥digo utTSQL: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://sourceforge.net/p/uttsql/code/HEAD/tree/</a> <br><br>  Afirmaci√≥n de clase Junit: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://junit.org/junit4/javadoc/latest/org/junit/Assert.html</a> <br><br>  pgTap: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://pgtap.org/</a> <br><br>  utPLSQL: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">http://utplsql.org/</a> <br><br>  MyTap: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://github.com/hepabolu/mytap</a> <br><br>  tSQLt Grupos de Google: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://groups.google.com/forum/#!forum/tsqlt</a> <br><br>  Sitio web oficial de tSQLt: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://tsqlt.org/</a> <br><br>  tSQLt GitHub: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://github.com/tSQLt-org/tSQLt</a> <br><br>  Tendencias de Google: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://bit.ly/2x7BQL6</a> <br><br>  C√≥mo ROLLBACK una transacci√≥n cuando se prueba usando tSQLt: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://stackoverflow.com/questions/8973138/how-to-rollback-a-transaction-when-testing-using-tsqlt</a> <br><br>  ¬øCu√°les son los pros y los contras de las pruebas unitarias manuales contra las pruebas unitarias automatizadas?: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Https://stackoverflow.com/questions/2948337/what-are-the-pros-and-cons-of-manual-unit-testing-against -the-automatic-unit-tes # 2948354</a> <br><br>  Lo bueno, lo malo y lo descuidado ¬Ø¬Ø¬Ø: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://sqlquantumleap.com/2017/08/07/sqlclr-vs-sql-server-2017-part-1-clr-strict-security/</a> <br><br>  Rex Black, Erik Van Veenendal, Dorothy Graham, Fundamentos de las pruebas de software, Tercera edici√≥n, Cengage Learning EMEA 2012 <br></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/465567/">https://habr.com/ru/post/465567/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../465551/index.html">Resumen de eventos de TI de septiembre (primera parte)</a></li>
<li><a href="../465553/index.html">Lenguaje de programaci√≥n √ú. Introducci√≥n, motivaci√≥n para crear, metas</a></li>
<li><a href="../465555/index.html">12 habilidades blandas que hacen que los gerentes de proyectos de TI sean imparables</a></li>
<li><a href="../465557/index.html">Plazos de desarrollo de productos</a></li>
<li><a href="../465561/index.html">Lo que aprend√≠ de un programador l√≠der</a></li>
<li><a href="../465569/index.html">Mapa de desarrollo para desarrolladores m√≥viles</a></li>
<li><a href="../465571/index.html">C√≥mo vender cigarrillos de hombres para mujeres y hacer que los salvajes se protejan a s√≠ mismos: redactores que podr√≠an</a></li>
<li><a href="../465573/index.html">Todo el poder de IntelliJ IDEA en el ejemplo de un idioma (en im√°genes)</a></li>
<li><a href="../465575/index.html">Operaciones de comparaci√≥n en C ++ 20</a></li>
<li><a href="../465577/index.html">Nuevos tipos de micromarcado para fragmentos interactivos avanzados</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>