<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>😂 😀 👴🏻 Expérience de mise à niveau classique SAMBA sur Debian 8 🚑 ⛺️ 👩🏾‍🚒</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Contexte 
 Il y a un petit réseau local de l'entreprise, dans lequel il y a environ 10 ans un domaine sur 3rd Samba + LDAP + BIND (sur la passerelle) ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Expérience de mise à niveau classique SAMBA sur Debian 8</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/418499/"><h2>  Contexte </h2><br>  Il y a un petit réseau local de l'entreprise, dans lequel il y a environ 10 ans un domaine sur 3rd Samba + LDAP + BIND (sur la passerelle) a été créé sur Debian 5.  En fait, elle n'avait besoin que de l'authentification des utilisateurs et des boules de fichiers.  Au fil des ans, le serveur est passé à de nouvelles versions de Debian sans aucun problème.  Pour le moment, il a Debian 8 et Samba 4.2 à partir des packages. <br><br>  Depuis Windows 7, l'introduction d'ordinateurs dans le domaine, sans la béquille bien connue avec la modification du registre, n'a pas fonctionné.  La même béquille a fonctionné dans Win 8 et Win 10 jusqu'à la version 1803. En plus de l'impossibilité d'entrer des ordinateurs dans le domaine, d'autres problèmes se sont accumulés, et en conséquence, il a été décidé d'effectuer une mise à niveau classique.  En raison de la simplicité de la structure LAN, il a été décidé d'utiliser le DNS Samba interne. <br><br>  Je veux dire tout de suite que l'article n'est pas un guide exact, mais plutôt l'expérience de la réalisation de cette opération.  La phase de pré-test est fortement recommandée.  Dans mon cas, des images de serveur ont été prises pour être testées et déployées sur des machines virtuelles VirtualBox. Pour tester le comportement des clients de domaine existants, Win XP SP3 et Win 10 1709 et 1803 ont été créés. <br><br>  Je tiens également à noter que des erreurs répétées ont été causées par des fautes de frappe courantes.  Soyez prudent. <br><a name="habracut"></a><br><h2>  Description de l'environnement </h2><br>  Système d'exploitation: Debian 8 <br>  Domaine: samdom.local <br>  Nom du serveur: pdc <br>  IP du serveur: 10.10.1.220 <br><cut></cut><br><h2>  Processus de transition </h2><br><h4>  Mise à jour des packages vers les dernières versions + installation des manquants. </h4><br>  Dans mon cas, après la mise à jour, seul l'utilisateur krb5 devait être livré. <br><br><pre><code class="hljs sql">apt-get <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-keyword"><span class="hljs-keyword">upgrade</span></span> apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> samba smbclient krb5-<span class="hljs-keyword"><span class="hljs-keyword">user</span></span> winbind</code> </pre> <br>  Lors de l'installation de krb5-user, le système posera quelques questions sur le nom du serveur et le nom de domaine.  Nous remplissons les données de notre serveur. <br><cut></cut><br><h4>  Arrêt Samba </h4><br><pre> <code class="hljs sql">service samba-ad-dc <span class="hljs-keyword"><span class="hljs-keyword">stop</span></span> service smbd <span class="hljs-keyword"><span class="hljs-keyword">stop</span></span> service nmbd <span class="hljs-keyword"><span class="hljs-keyword">stop</span></span> service winbind <span class="hljs-keyword"><span class="hljs-keyword">stop</span></span></code> </pre> <br><h4>  Transfert d'anciennes bases et configuration de samba </h4><br><pre> <code class="hljs swift">mv /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/lib/samba /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/lib/samba.<span class="hljs-type"><span class="hljs-type">NT</span></span> mv /etc/samba/smb.conf /etc/samba/smb.conf.<span class="hljs-type"><span class="hljs-type">NT</span></span></code> </pre> <br>  J'ai déplacé les anciennes bases de données vers /var/lib/samba.NT, vous devez donc recréer le répertoire / var / lib / samba <br><br><pre> <code class="hljs swift">mkdir /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/lib/samba</code> </pre> <br>  La documentation recommande de déplacer toutes les bases de données dans un dossier distinct.  Dans mon cas, seul gencache_notrans.tdb se trouvait séparément, j'ai donc dû le transférer uniquement. <br><br><pre> <code class="hljs swift">cp -p /run/samba/gencache_notrans.tdb /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/lib/samba.<span class="hljs-type"><span class="hljs-type">NT</span></span></code> </pre> <br>  La documentation indique également que seulement six bases de données sont nécessaires: <br><br><blockquote>  secrets.tdb <br>  schannel_store.tdb <br>  passdb.tdb <br>  gencache_notrans.tdb <br>  group_mapping.tdb <br>  account_policy.tdb </blockquote><br>  Cependant, la présence d'autres fichiers dans le dossier n'a pas empêché le processus de transition. <br><cut></cut><br><h4>  Démarrage du processus de mise à niveau classique </h4><br><pre> <code class="hljs powershell">samba<span class="hljs-literal"><span class="hljs-literal">-tool</span></span> domain classicupgrade —dbdir=/var/lib/samba.NT -<span class="hljs-literal"><span class="hljs-literal">-realm</span></span>=samdom.local -<span class="hljs-literal"><span class="hljs-literal">-dns</span></span><span class="hljs-literal"><span class="hljs-literal">-backend</span></span>=SAMBA_INTERNAL /etc/samba/smb.conf.NT</code> </pre> <br>  Je note que la documentation ne recommande pas d'utiliser le domaine local de premier niveau., Mais dans mon cas, cela s'est produit historiquement. <br><br>  Dans la feuille qui apparaît à l'écran, le mot de passe administrateur clignote, que vous pouvez noter si vous le souhaitez). <br><br>  Si vous rencontrez des problèmes, avant de nouvelles tentatives de mise à niveau classique, vous devez vous rappeler de supprimer les fichiers de base de données et smb.conf créés au cours du processus. <br><br><pre> <code class="hljs powershell">rm <span class="hljs-operator"><span class="hljs-operator">-f</span></span> /etc/samba/smb.conf rm <span class="hljs-literal"><span class="hljs-literal">-rf</span></span> /var/lib/samba/*</code> </pre> <br>  Si tout s'est bien passé, vous pouvez passer à l'étape suivante. <br><br><h4>  Vérification et modification des configurations de serveur </h4><br>  Dans /etc/resolv.conf devrait être (s'il n'est pas créé automatiquement pour vous) <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">domain</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">samdom</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.local</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">nameserver</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.220</span></span></code> </pre> <br>  Dans / etc / hosts <br><br><pre> <code class="hljs css">127<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">localhost</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">localhost</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.localdomain</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.220</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">pdc</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.samdom</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.local</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">pdc</span></span></code> </pre> <br>  Le fichier / etc / hostname doit avoir un nom d'hôte abrégé <br><br><pre> <code class="hljs">pdc</code> </pre> <br>  Dans / etc / network / interfaces <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">dns-nameservers</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.220</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dns-search</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">samdom</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.local</span></span></code> </pre> <br><h4>  Rediriger les demandes DNS </h4><br>  Si votre serveur redirige les requêtes DNS vers Internet (et INTERNAL_DNS Samba est utilisé), vous devez ajouter la ligne de l'IP de votre fournisseur dans la section [globale] de smb.conf: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">dns</span></span> forwarder = ip</code> </pre> <br>  Dans "Samba" 4.2, vous ne pouvez spécifier qu'une seule IP.  Dans la suite - quelques-uns, avec un espace. <br>  Si le trafic sortant est contrôlé sur votre passerelle, n'oubliez pas d'ouvrir le passage des paquets udp du serveur vers le port 53. <br><br><h4>  Configurer Kerberos </h4><br>  Nous apportons /etc/krb5.conf sous une forme similaire: <br><br><pre> <code class="hljs pgsql">[libdefaults] default_realm = SAMDOM.<span class="hljs-keyword"><span class="hljs-keyword">LOCAL</span></span> dns_lookup_realm = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> dns_lookup_kdc = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> krb4_config = /etc/krb.conf krb4_realms = /etc/krb.realms kdc_timesync = <span class="hljs-number"><span class="hljs-number">1</span></span> ccache_type = <span class="hljs-number"><span class="hljs-number">4</span></span> forwardable = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> proxiable = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> v4_instance_resolve = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> v4_name_convert = { host = { rcmd = host ftp = ftp } plain = { something = something-<span class="hljs-keyword"><span class="hljs-keyword">else</span></span> } } fcc-mit-ticketflags = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> [realms] SAMDOM.<span class="hljs-keyword"><span class="hljs-keyword">LOCAL</span></span> = { kdc = pdc admin_server = pdc default_domain = SAMDOM.<span class="hljs-keyword"><span class="hljs-keyword">LOCAL</span></span> } [domain_realm] .samdom.<span class="hljs-keyword"><span class="hljs-keyword">local</span></span> = SAMDOM.<span class="hljs-keyword"><span class="hljs-keyword">LOCAL</span></span> samdom.<span class="hljs-keyword"><span class="hljs-keyword">local</span></span> = SAMDOM.<span class="hljs-keyword"><span class="hljs-keyword">LOCAL</span></span></code> </pre> <br><h4>  Synchronisation horaire </h4><br>  Si le package ntp n'en vaut pas la peine, alors définissez: <br><br><pre> <code class="hljs swift">apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> install ntp</code> </pre> <br>  Dans mon cas, il n'y avait pas de répertoire / var / lib / samba / ntp_signd /.  Créé manuellement. <br><br>  Ensuite, vous devez lui donner des droits: <br><br><pre> <code class="hljs swift">chown root:ntp /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/lib/samba/ntp_signd/ chmod <span class="hljs-number"><span class="hljs-number">750</span></span> /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/lib/samba/ntp_signd/</code> </pre> <br>  Ensuite, vous devez amener le fichier /etc/ntp.conf sous une forme similaire: <br><br><pre> <code class="hljs pgsql"># <span class="hljs-keyword"><span class="hljs-keyword">Local</span></span> clock (Note: This <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> the localhost address!) <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-number"><span class="hljs-number">127.127</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> fudge <span class="hljs-number"><span class="hljs-number">127.127</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> stratum <span class="hljs-number"><span class="hljs-number">10</span></span> # The source, <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> we are receiving the <span class="hljs-type"><span class="hljs-type">time</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-number"><span class="hljs-number">0.</span></span>pool.ntp.org iburst prefer driftfile /var/lib/ntp/ntp.drift logfile /var/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/ntp ntpsigndsocket /var/lib/samba/ntp_signd/ # <span class="hljs-keyword"><span class="hljs-keyword">Access</span></span> control # <span class="hljs-keyword"><span class="hljs-keyword">Default</span></span> restriction: <span class="hljs-keyword"><span class="hljs-keyword">Only</span></span> allow querying <span class="hljs-type"><span class="hljs-type">time</span></span> (incl. ms-sntp) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> this machine <span class="hljs-keyword"><span class="hljs-keyword">restrict</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> kod nomodify notrap nopeer mssntp # Allow everything <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> localhost <span class="hljs-keyword"><span class="hljs-keyword">restrict</span></span> <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> # Allow that our <span class="hljs-type"><span class="hljs-type">time</span></span> source can <span class="hljs-keyword"><span class="hljs-keyword">only</span></span> provide <span class="hljs-type"><span class="hljs-type">time</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">nothing</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">restrict</span></span> <span class="hljs-number"><span class="hljs-number">0.</span></span>pool.ntp.org mask <span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span> nomodify notrap nopeer noquery</code> </pre> <br><h4>  Suppression de slapd et redémarrage </h4><br><pre> <code class="hljs cs">apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-keyword"><span class="hljs-keyword">remove</span></span> slapd reboot</code> </pre> <br><h4>  Test </h4><br>  Dans la documentation, les tests sont effectués à partir du compte administrateur.  Nous avons historiquement développé que les actions administratives proviennent de domain_admin.  Ensuite, les commandes et leur sortie correcte seront affichées. <br><br>  <b>Test de la samba:</b> <br><br><pre> <code class="hljs pgsql">root@debian:/root# smbclient -L localhost -U% <span class="hljs-keyword"><span class="hljs-keyword">Domain</span></span>=[SAMDOM] OS=[Unix] <span class="hljs-keyword"><span class="hljs-keyword">Server</span></span>=[Samba <span class="hljs-number"><span class="hljs-number">4.1</span></span><span class="hljs-number"><span class="hljs-number">.17</span></span>-Debian] Sharename <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Comment</span></span> <span class="hljs-comment"><span class="hljs-comment">--------- ---- ------- netlogon Disk sysvol Disk IPC$ IPC IPC Service (Samba 4.1.17-Debian) Domain=[SAMDOM] OS=[Unix] Server=[Samba 4.1.17-Debian] Server Comment --------- ------- Workgroup Master --------- -------</span></span></code> </pre> <br>  Si vous obtenez une erreur ici: <br><blockquote>  La connexion à loclhost a échoué (erreur NT_STATUS_UNSUCCESSFUL) </blockquote><br>  vérifiez si la samba démarre.  Dans un test, j'ai oublié de supprimer (désactiver) slapd et j'ai également vu cette erreur. <br><br>  Encore une vérification: <br><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> smbclient //localhost/netlogon <span class="hljs-literal"><span class="hljs-literal">-Udomain_admin</span></span> <span class="hljs-literal"><span class="hljs-literal">-c</span></span> <span class="hljs-string"><span class="hljs-string">'ls'</span></span> Enter Administrator<span class="hljs-string"><span class="hljs-string">'s password: Domain=[SAMDOM] OS=[Unix] Server=[Samba xyz] . D 0 Tue Nov 1 08:40:00 2016 .. D 0 Tue Nov 1 08:40:00 2016 49386 blocks of size 524288. 42093 blocks available</span></span></code> </pre> <br>  <b>Test DNS</b> <br><br><pre> <code class="hljs pgsql">root@debian:/root# nslookup samdom.<span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Server</span></span>: <span class="hljs-number"><span class="hljs-number">10.10</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.220</span></span> Address: <span class="hljs-number"><span class="hljs-number">10.10</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.220</span></span>#<span class="hljs-number"><span class="hljs-number">53</span></span> <span class="hljs-type"><span class="hljs-type">Name</span></span>: samdom.<span class="hljs-keyword"><span class="hljs-keyword">local</span></span> Address: <span class="hljs-number"><span class="hljs-number">10.10</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.220</span></span></code> </pre> <br><pre> <code class="hljs pgsql">$ host -t SRV _ldap._tcp.samdom.<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>. _ldap._tcp.samdom.example.com has SRV <span class="hljs-type"><span class="hljs-type">record</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-number"><span class="hljs-number">389</span></span> pdc.samdom.example.com.</code> </pre> <br><pre> <code class="hljs pgsql">$ host -t SRV _kerberos._udp.samdom.<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>. _kerberos._udp.samdom.example.com has SRV <span class="hljs-type"><span class="hljs-type">record</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-number"><span class="hljs-number">88</span></span> pdc.samdom.example.com.</code> </pre> <br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> host <span class="hljs-literal"><span class="hljs-literal">-t</span></span> A pdc.samdom.local. dc1.samdom.example.com has address <span class="hljs-number"><span class="hljs-number">10.10</span></span>.<span class="hljs-number"><span class="hljs-number">1.220</span></span></code> </pre> <br>  <b>Test de Kerberos</b> <br><br><pre> <code class="hljs pgsql">root@debian:/root# kinit domain_admin@SAMDOM.<span class="hljs-keyword"><span class="hljs-keyword">LOCAL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Password</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> domain_admin@SAMDOM.<span class="hljs-keyword"><span class="hljs-keyword">LOCAL</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">Warning</span></span>: Your <span class="hljs-keyword"><span class="hljs-keyword">password</span></span> will expire <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">41</span></span> days <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>  <span class="hljs-number"><span class="hljs-number">27</span></span>  <span class="hljs-number"><span class="hljs-number">2015</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">34</span></span>:<span class="hljs-number"><span class="hljs-number">46</span></span></code> </pre><br><pre> <code class="hljs ruby">root@debian<span class="hljs-symbol"><span class="hljs-symbol">:/root</span></span><span class="hljs-comment"><span class="hljs-comment"># klist Ticket cache: FILE:/tmp/krb5cc_0 Default principal: domain_admin</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@SAMDOM</span></span></span><span class="hljs-comment">.LOCAL Valid starting Expires Service principal 16.10.2015 15:07:12 17.10.2015 01:07:12 krbtgt/SAMDOM.LOCAL</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@SAMDOM</span></span></span><span class="hljs-comment">.LOCAL renew until 17.10.2015 15:07:07</span></span></code> </pre> <br><h2>  Configuration supplémentaire </h2><br>  <b>Pour que les noms de domaine et les groupes apparaissent sous linux, vous devez corriger /etc/nsswitch.conf au lieu des nombres</b> <br><br>  Les chaînes doivent être réduites à la forme suivante: <br><blockquote>  passwd: fichiers <u>winbind</u> <br>  groupe: fichiers <u>winbind</u> </blockquote><br>  Veuillez noter que winbind n'est ajouté qu'à ces lignes.  Pour plus de détails, consultez la documentation. <br>  Dans mon cas, j'ai également supprimé la mention de ldap de ce fichier. <br><br><pre> <code class="hljs">reboot</code> </pre> <br>  <b>Si vous, comme moi, avant classicupgrade dns, le serveur était situé sur une autre machine et que vous utilisez un serveur DHCP, n'oubliez pas de modifier les paramètres du serveur DHCP pointant vers le serveur DNS</b> <br><br><h4>  Configurer les dossiers réseau </h4><br>  Il n'est pas recommandé aux développeurs d'utiliser le contrôleur de domaine AD comme serveur de fichiers.  Cependant, dans mon cas, il n'y avait pas d'autres serveurs. <br><br>  Le paramètre est très bien décrit dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation</a> de "Samba" et vous devez y regarder.  Bref, alors: <br><br>  <b>Il est nécessaire de vérifier le support ACL samba.</b> <br><br><pre> <code class="hljs perl">smbd -b | <span class="hljs-keyword"><span class="hljs-keyword">grep</span></span> HAVE_LIBACL HAVE_LIBACL</code> </pre> <br>  <b>N'oubliez pas que la section doit être montée avec les options user_xattr et acl.</b> <br><br>  <b>Seuls les utilisateurs et les groupes avec SeDiskOperatorPrivilege peuvent configurer les droits sur les boules:</b> <br><br>  Par exemple, pour accorder ces droits au groupe Administrateurs du domaine, vous devez exécuter la commande: <br><pre> <code class="hljs pgsql">net rpc rights <span class="hljs-keyword"><span class="hljs-keyword">grant</span></span> "Samdom\Domain Admins" SeDiskOperatorPrivilege -U "Samdom\domain_admin"</code> </pre> <br>  <b>Pour ajouter directement des balles dont vous avez besoin:</b> <br><br>  Créez un répertoire et attribuez les droits nécessaires: <br><br><pre> <code class="hljs objectivec"><span class="hljs-meta"><span class="hljs-meta"># mkdir -p /srv/samba/Demo/ # chown root:</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Domain Admins"</span></span></span><span class="hljs-meta"> /srv/samba/Demo/ # chmod 0770 /srv/samba/Demo/</span></span></code> </pre> <br>  ajouter à smb.conf <br><br><pre> <code class="hljs pgsql">[Demo] <span class="hljs-type"><span class="hljs-type">path</span></span> = /srv/samba/Demo/ <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> <span class="hljs-keyword"><span class="hljs-keyword">only</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">no</span></span></code> </pre> <br>  Après cela, rechargez les configurations samba avec la commande: <br><br><pre> <code class="hljs pgsql">smbcontrol <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> reload-config</code> </pre> <br>  Comme précédemment, les boules peuvent être cachées en ajoutant à sa description: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">browseable</span></span> = <span class="hljs-literal"><span class="hljs-literal">no</span></span></code> </pre> <br>  Ensuite, les droits sont distribués à partir des fenêtres de la machine, à partir d'un compte avec <u>SeDiskOperatorPrivilege</u> .  Pour ce faire, allez dans "gestion informatique". <br>  Accrochez-vous à un ordinateur distant (contrôleur de domaine pdc dans notre cas).  Distribuez les droits via: "Dossiers partagés" -&gt; "Ressources partagées". <br><br>  Il est probable que lorsque vous accédez à l'élément "Dossiers partagés", vous obtiendrez une erreur "Le numéro de procédure est en dehors des limites autorisées (1745)".  Je l'ignore, car je n'ai rien trouvé d'intelligible sur Internet et cela ne pose pas de problème lors des tests et du fonctionnement. <br><br>  Des problèmes peuvent être possibles si vous partagez les anciens dossiers réseau de cette manière.  Avant la mise à niveau classique, les droits sur les balles étaient définis via smb.conf, les utilisateurs linux, group, other et setfacl.  Après la mise à niveau classique, les écoles ayant le droit de changer, de renommer, etc. ont commencé à apparaître progressivement.  Le setfacl récursif n'a pas aidé, car des jambages avec héritage sont apparus. <br><br>  Il est à noter que dans la documentation, il est recommandé de répartir les droits depuis les fenêtres de la machine, via un accès à distance. <br><br>  En conséquence, en raison du volume peu important de fichiers, il a été décidé de transférer des données vers une machine Windows pendant les heures non travaillées, de recréer des dossiers réseau sur la recommandation des développeurs de samba et de télécharger à nouveau les fichiers. <br><br><h4>  Dossiers de départ des utilisateurs sur le serveur </h4><br>  La gestion des dossiers de départ des utilisateurs a également changé. <br>  Il convient de noter que le processus de configuration est également très bien décrit dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation</a> . <br>  Je ne décrirai que les principales caractéristiques de mon cas. <br><br>  Auparavant, chaque utilisateur avait sa propre balle.  Désormais, seul le dossier partagé est partagé et les utilisateurs n'ont accès qu'à leur répertoire. <br><br>  La configuration est effectuée à l'aide <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">des outils d'administration de serveur distant Microsoft (RSAT)</a> .  RSAT a une caractéristique désagréable.  Lors de la mise à niveau de Win 10 vers une nouvelle version, il doit être réinstallé. <br><br>  Les balles à domicile peuvent être récupérées manuellement, via les propriétés de l'utilisateur dans le composant logiciel enfichable Utilisateurs et ordinateurs.  Onglet Profil.  Disque U: \\ pdc \ partages utilisateurs \ nom d'utilisateur <br><br>  Cependant, il est plus pratique de le faire via la stratégie de domaine, qui est très clairement décrite dans la documentation ci-dessus dans le paragraphe <b>«Utilisation d'une préférence de stratégie de groupe»</b> . <br><br>  N'oubliez pas que la balle commune peut être cachée en ajoutant à sa description: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">browseable</span></span> = <span class="hljs-literal"><span class="hljs-literal">no</span></span></code> </pre> <br><h4>  Niveau de domaine supérieur </h4><br>  Le domaine a été mis à niveau sans problème au niveau 2008_R2 avec la commande: <br><br><pre> <code class="hljs pgsql">samba-tool <span class="hljs-keyword"><span class="hljs-keyword">domain</span></span> <span class="hljs-keyword"><span class="hljs-keyword">level</span></span> <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> <span class="hljs-comment"><span class="hljs-comment">--domain=2008_R2 --forest=2008_R2</span></span></code> </pre> <br>  Vous pouvez visualiser le niveau avec la commande: <br><br><pre> <code class="hljs pgsql">samba-tool <span class="hljs-keyword"><span class="hljs-keyword">domain</span></span> <span class="hljs-keyword"><span class="hljs-keyword">level</span></span> <span class="hljs-keyword"><span class="hljs-keyword">show</span></span></code> </pre> <br><h4>  Si smbd.log est bombardé d'erreurs CUPS </h4><br>  Dans mon cas, ce problème est apparu: <br><br><blockquote>  Impossible de se connecter à l'hôte local du serveur CUPS: 631 </blockquote><br>  Corrigé par <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ce</a> court article. <br><br><h2>  Mise à niveau ultérieure vers le problème et la solution Debian 9 </h2><br>  À <br><br><pre> <code class="hljs powershell">apt<span class="hljs-literal"><span class="hljs-literal">-get</span></span> dist<span class="hljs-literal"><span class="hljs-literal">-upgrade</span></span></code> </pre> <br>  Il y avait un problème, à savoir que samba et winbind ne voulaient pas être mis à jour.  Entré dans un conflit de dépendances. <br><br>  La méthode de l'article a aidé le lien vers lequel je n'ai malheureusement pas enregistré. <br>  En voici une citation directe: <br><br><blockquote>  si Samba est en mode AD-DC, il échoue et winbind. <br>  effectuez ces commandes, puis essayez d'exécuter à nouveau la mise à niveau <br><br>  systemctl stop smbd nmbd winbind <br>  systemctl désactiver smbd nmbd winbind <br>  systemctl démasque samba-ad-dc <br>  systemctl démarrer samba-ad-dc <br>  systemctl activer samba-ad-dc <br></blockquote><br><br><h4>  Après la mise à jour de la version SAMBA, il est recommandé de: «Vérifier la base de données Samba AD DC». </h4><br><br> <code># samba-tool dbcheck --cross-ncs</code> <br> <br>  Depuis dans Deb 9 SAMBA version 4.5, j'ai eu un tas d'erreurs "replPropertyMetaData". <br>  Le processus de dépannage est décrit dans la documentation: <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">wiki.samba.org/index.php/Updating_Samba#Fixing_replPropertyMetaData_Attributes</a> <br><br>  Et cela se résume à l'exécution de la commande: <br><br> <code>samba-tool dbcheck --cross-ncs --fix --yes</code> <br> <br><h2>  Liste des sources utilisées </h2><br>  Documentation SAMBA: <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Migration d'un domaine Samba NT4 vers Samba AD (mise à niveau classique)</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Configuration de Samba en tant que contrôleur de domaine Active Directory</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Configuration d'un partage à l'aide des listes de contrôle d'accès Windows</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Dossiers personnels des utilisateurs</a> <br>  Excellent article: <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Contrôleur de domaine Debian 8 (... qui a déjà un Samba4 intégré)</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Erreur Samba: impossible de se connecter à l'hôte local du serveur CUPS: 631</a> <br>  Un article d'un auteur anglais inconnu décrivant comment passer à Debian 9 </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr418499/">https://habr.com/ru/post/fr418499/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr418487/index.html">À propos du travail en Allemagne</a></li>
<li><a href="../fr418489/index.html">Chefs-d'œuvre de la construction de colonnes dans le monde: évolution d'un standard à trois voies, culte studio de JBL</a></li>
<li><a href="../fr418491/index.html">Tester la résistance d'automatisation</a></li>
<li><a href="../fr418493/index.html">Bluetooth Histoire à la première personne</a></li>
<li><a href="../fr418497/index.html">«Je ne te reconnais pas dans le maquillage» (c)</a></li>
<li><a href="../fr418501/index.html">Victimes du RGPD: qui ont déjà arrêté de travailler en raison de la nouvelle réglementation des données personnelles</a></li>
<li><a href="../fr418503/index.html">Après 2020, le Royaume-Uni acquerra le premier port spatial - en Écosse</a></li>
<li><a href="../fr418505/index.html">Présentation et comparaison des plates-formes logicielles Quantum au niveau de la porte</a></li>
<li><a href="../fr418507/index.html">Qu'est-ce que la cosmonautique nous a apporté?</a></li>
<li><a href="../fr418509/index.html">Amazon Rekognition reconnaît 28 membres du Congrès américain comme des criminels</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>