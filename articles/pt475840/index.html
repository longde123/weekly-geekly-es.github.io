<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèª‚ÄçüöÄ üèÇ üë®üèº‚Äçüöí Cliente da API do Badoo Jira: magia no Jira em PHP üë≥üèø „äóÔ∏è üñïüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Se voc√™ digitar ‚ÄúJira Badoo‚Äù na string de pesquisa em Habr√©, os resultados levar√£o mais de uma p√°gina: n√≥s a mencionamos em quase todos os lugares, po...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Cliente da API do Badoo Jira: magia no Jira em PHP</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/badoo/blog/475840/"> Se voc√™ digitar ‚ÄúJira Badoo‚Äù na string de pesquisa em Habr√©, os resultados levar√£o mais de uma p√°gina: n√≥s a mencionamos em quase todos os lugares, porque ela desempenha um papel importante em nossos processos.  E cada um de n√≥s quer um pouco diferente dela. <br><br><img src="https://habrastorage.org/webt/xy/8u/z0/xy8uz0gbqfd5idb0tokgpsxvdqs.jpeg"><br><br>  O desenvolvedor, que recebeu a tarefa para a revis√£o, espera que uma ramifica√ß√£o seja indicada na tarefa, h√° links para diff e o log de altera√ß√µes.  O desenvolvedor que escreveu o c√≥digo espera ver coment√°rios em Jira ap√≥s a revis√£o.  O testador, que recebe a tarefa ap√≥s eles, deseja ver os resultados do teste e poder executar os assemblies necess√°rios sem precisar acessar outras interfaces.  Os gerentes de produto geralmente desejam criar dez tarefas de desenvolvimento ao mesmo tempo pressionando um √∫nico bot√£o. <br><br>  E tudo isso est√° dispon√≠vel hoje e acontece automaticamente.  Implementamos a maior parte da m√°gica em PHP usando a API Jira em constante evolu√ß√£o e usando seu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">webhook</a> .  E hoje queremos compartilhar com a comunidade nossa vers√£o do cliente para esta API. <br><br>  Inicialmente, quer√≠amos apenas falar sobre as id√©ias e abordagens que usamos e, em seguida, decidimos que definitivamente n√£o havia c√≥digo suficiente para um artigo como esse para maior clareza.  Portanto, havia uma vers√£o de c√≥digo aberto do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Badoo Jira PHP Client</a> .  Muito obrigado a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">ShaggyRatte</a> por ajudar com sua descri√ß√£o.  E bem-vindo ao Kat! <br><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">Mais detalhes e contexto.</b> <div class="spoiler_text">  Se precisar de mais detalhes sobre o que fazemos com o Jira, voc√™ pode encontr√°-los em nossos outros artigos: <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">habr.com/en/company/badoo/blog/169417</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">habr.com/en/company/badoo/blog/433540</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">habr.com/en/company/badoo/blog/424655</a> <br></div></div><br><h2>  O que ele pode fazer? </h2><br>  De fato, o Badoo Jira PHP Client √© um conjunto de classes de wrapper prontas para respostas da API Jira, a maioria das quais pode se comportar como ActiveRecord: eles sabem como obter dados sobre si mesmos e atualiz√°-los no servidor, suportam inicializa√ß√£o lenta e cache de dados no n√≠vel c√≥digo.  Todas as entidades do Jira com as quais voc√™ precisa trabalhar constantemente s√£o agrupadas: <b>problema, status, prioridade, registro de altera√ß√µes, usu√°rio, vers√£o, componente</b> etc. (quase tudo que voc√™ v√™ na interface). <br><br>  Al√©m disso, o Badoo Jira PHP Client fornece uma hierarquia de classe √∫nica para todos os campos personalizados do Jira e √© capaz de gerar defini√ß√µes de classe para cada campo personalizado necess√°rio. <br><br><pre><code class="php hljs">$Issue = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \Badoo\Jira\Issue(<span class="hljs-string"><span class="hljs-string">'SMPL-1'</span></span>); $Issue-&gt;addComment(<span class="hljs-string"><span class="hljs-string">'Sample comment text'</span></span>); $Issue-&gt;attachFile(<span class="hljs-string"><span class="hljs-string">'kitten.jpeg'</span></span>, <span class="hljs-string"><span class="hljs-string">'pretty!'</span></span>, <span class="hljs-string"><span class="hljs-string">'image/jpeg'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($Issue-&gt;getStatus()-&gt;getName() === <span class="hljs-string"><span class="hljs-string">'Open'</span></span>) { $Issue-&gt;step(<span class="hljs-string"><span class="hljs-string">'In Progress'</span></span>); }</code> </pre> <br><pre> <code class="php hljs">$DeveloperField = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \Example\CustomFields\Developer($Issue); $DeveloperField-&gt;setValue(<span class="hljs-string"><span class="hljs-string">'username'</span></span>)-&gt;save();</code> </pre><br><pre> <code class="php hljs">$User = \Badoo\Jira\User::get(<span class="hljs-string"><span class="hljs-string">'username'</span></span>); $User-&gt;watchIssue(<span class="hljs-string"><span class="hljs-string">'SMPL-1'</span></span>); $User-&gt;assign(<span class="hljs-string"><span class="hljs-string">'SMPL-2'</span></span>);</code> </pre><br>  Gra√ßas a isso, a intera√ß√£o com a API do PHP se torna mais simples e conveniente, e a documenta√ß√£o do seu Jira se move diretamente para o c√≥digo, o que permite usar o preenchimento autom√°tico no IDE para muitas a√ß√µes padr√£o. <br><br>  Mas as primeiras coisas primeiro. <br><br><h2>  Recursos de API que encontramos </h2><br>  Quando come√ßamos a usar ativamente a API do Jira, ela estava dispon√≠vel apenas atrav√©s do protocolo SOAP.  Sua vers√£o REST apareceu mais tarde e est√°vamos entre os primeiros usu√°rios.  Naquela √©poca, havia muito poucos clientes REST dispon√≠veis publicamente escritos em PHP.  Foi ainda mais dif√≠cil encontrar algo que pudesse ser facilmente integrado √† nossa base de c√≥digo, passando gradualmente do SOAP para o REST.  Portanto, n√£o tivemos escolha: decidimos continuar desenvolvendo nosso pr√≥prio cliente. <br><br>  Por isso, vivemos arrastando e soltando todos os tipos de hacks e muletas do cliente SOAP e adquirindo novos devido aos recursos REST.  Como resultado, desenvolvemos algumas classes muito ousadas com um monte de c√≥digo duplicado e √© necess√°rio limpar essa bagun√ßa. <br><br>  Os campos personalizados sempre foram o lugar mais doloroso para n√≥s: temos mais de 300 deles (no momento em que escrevemos este artigo - 338), e esse n√∫mero est√° crescendo lentamente. <br><br><h3>  Mensagens de erro estranhas </h3><br>  Ao longo da longa hist√≥ria de intera√ß√£o com a API, vimos muitas coisas diferentes.  A maioria das mensagens de erro √© adequada, mas h√° aquelas para as quais voc√™ precisa sobrecarregar bastante o c√©rebro. <br><br>  Por exemplo, se Jira de repente reconhecer um rob√¥ no seu usu√°rio, ela come√ßar√° a mostrar um captcha.  Nesse caso, ao acessar a API, ela descaradamente ignora o cabe√ßalho <i>Accept-Encoding: application / json</i> e fornece HTML.  Naturalmente, o cliente que est√° aguardando JSON pode n√£o estar pronto para esse "ol√°". <br><br>  E aqui est√° um exemplo de trabalho com um campo personalizado: <br><br><img width="600" src="https://habrastorage.org/webt/sc/xt/xe/scxtxekex33vyguynhxr9hjpp_m.png"><br><br>  Ao escrever o c√≥digo e "testar agora", voc√™ est√° testando, √© muito f√°cil entender que customfield_12664 √© <b>Desenvolvedores</b> .  E se esse erro aparecer em algum lugar da produ√ß√£o (por exemplo, porque algu√©m alterou a configura√ß√£o e alterou a lista de valores aceit√°veis ‚Äã‚Äãpara o campo Selecionar), geralmente a √∫nica maneira de identificar o campo √© entrar no Jira e descobrir o nome a partir da√≠.  Al√©m disso, em sua interface, os IDs n√£o s√£o exibidos - apenas nomes. <br><br>  Acontece que quando voc√™ deseja descobrir o nome do campo que levou ao erro e corrigir sua configura√ß√£o, voc√™ pode fazer isso atrav√©s de uma solicita√ß√£o para a API ou usando outros m√©todos n√£o √≥bvios: vasculhando o c√≥digo fonte da p√°gina, abrindo as configura√ß√µes para um campo arbitr√°rio e corrigir o URL na barra de endere√ßo, etc. Esse processo n√£o pode ser chamado de conveniente e cada vez que leva muito tempo para uma tarefa t√£o simples. <br><br>  Mas nomes de campos obscuros n√£o se limitam a problemas.  Veja como √© a intera√ß√£o com a API se voc√™ cometer um erro na estrutura de dados ao atualizar o campo: <br><br><img width="600" src="https://habrastorage.org/webt/v_/ab/jo/v_abjobegilkmh8tjdoh2sigius.png"><br><img width="600" src="https://habrastorage.org/webt/pr/nr/fg/prnrfg7hbhxtge1pwejzmuvrgsq.png"><br><br><h3>  Muitos formatos de dados diferentes </h3><br>  E n√£o esque√ßa que atualizar campos de tipos diferentes requer estruturas de dados diferentes. <br><br><pre> <code class="php hljs">$Jira-&gt;issue()-&gt;edit( <span class="hljs-string"><span class="hljs-string">'SMPL-1'</span></span>, [ <span class="hljs-string"><span class="hljs-string">'customfield_10200'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'name'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'denkoren'</span></span>], <span class="hljs-string"><span class="hljs-string">'customfield_10300'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'value'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'PHP'</span></span>], <span class="hljs-string"><span class="hljs-string">'customfield_10400'</span></span> =&gt; [[<span class="hljs-string"><span class="hljs-string">'value'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Android'</span></span>], [<span class="hljs-string"><span class="hljs-string">'value'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'iOS'</span></span>]], <span class="hljs-string"><span class="hljs-string">'security'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'id'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">100500</span></span>], <span class="hljs-string"><span class="hljs-string">'description'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Just text'</span></span>, ], );</code> </pre><br>  As respostas da API para eles tamb√©m s√£o diferentes. <br><br>  √â poss√≠vel ter isso em mente apenas se voc√™ estiver trabalhando constantemente com a API do Jira e n√£o se distrair por um longo tempo resolvendo outros problemas.  Caso contr√°rio, esses recursos ficar√£o sem mem√≥ria em algumas semanas.  Al√©m disso, voc√™ precisa se lembrar do tipo de campo necess√°rio para "aliment√°-lo" com a estrutura correta.  Quando voc√™ possui centenas de campos personalizados, geralmente precisa procurar no c√≥digo onde ele ainda foi usado ou subir no painel de administra√ß√£o do Jira. <br><br>  Antes de escrevermos nosso cliente, Stack Overflow e Atlassian Community eram meus melhores amigos na atualiza√ß√£o de campos personalizados.  Agora, essas informa√ß√µes s√£o pesquisadas no Google de maneira f√°cil e r√°pida, mas mudamos para a API REST quando ela ainda era relativamente nova e ativamente desenvolvida: demorou dez minutos para encontrar uma solicita√ß√£o de cURL adequada no Google e ent√£o voc√™ teve que analisar esse monte de colchetes com os olhos e converter na estrutura correta do PHP, que geralmente n√£o funcionava na primeira tentativa. <br><br>  Em geral, a intera√ß√£o com campos personalizados √© o processo cuja reorganiza√ß√£o foi necess√°ria em primeiro lugar. <br><br><h2>  Em que consiste o cliente? </h2><br><h3>  Classes para trabalhar com campos personalizados </h3><br>  Antes de tudo, quer√≠amos nos livrar da lembran√ßa das estruturas de dados para interagir com a API e obter nomes de campos leg√≠veis quando ocorreram erros. <br><br>  Como resultado, criamos uma hierarquia de classe √∫nica para todos os campos personalizados.  Descobriu-se tr√™s camadas: <br><br><ol><li>  Um pai abstrato abstrato para todos: <b>\ Badoo \ Jira \ CustomFields \ CustomField</b> . </li><li>  Por uma classe abstrata para cada tipo de campo: <b>SelectField, UserField, TextField</b> , etc. </li><li>  Por classe para cada campo espec√≠fico: por exemplo, <b>Desenvolvedor</b> ou <b>Revisor</b> . </li></ol><br>  Essas classes podem ser escritas independentemente ou podem ser criadas automaticamente usando um gerador de script especial (retornaremos a ela). <br><img src="https://habrastorage.org/webt/1p/zz/eu/1pzzeucvu78qctdq-12elpstlkm.png"><br><br>  Gra√ßas a essa estrutura, para ensinar o c√≥digo a atualizar o valor do seu campo personalizado do tipo <b>Lista de Sele√ß√£o (m√∫ltipla escolha)</b> , basta criar uma classe PHP herdada do <b>SelectField</b> .  De fato, todo campo Jira personalizado se transforma em um ActiveRecord regular no c√≥digo PHP. <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> \<span class="hljs-title"><span class="hljs-title">Example</span></span>\<span class="hljs-title"><span class="hljs-title">CustomFields</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Developer</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> \</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Badoo</span></span></span><span class="hljs-class">\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Jira</span></span></span><span class="hljs-class">\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomFields</span></span></span><span class="hljs-class">\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SingleUserField</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ID = <span class="hljs-string"><span class="hljs-string">'customfield_10200'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> NAME = <span class="hljs-string"><span class="hljs-string">'Developer'</span></span>; } <span class="hljs-comment"><span class="hljs-comment">// ,  ,  !</span></span></code> </pre><br><br>  Na mesma classe, armazenamos informa√ß√µes sobre o campo: por padr√£o, esse √© um ID, o nome do campo e uma lista de valores dispon√≠veis, se forem limitados (por exemplo, para <b>Checkbox</b> e <b>Select</b> ). <br><br><div class="spoiler">  <b class="spoiler_title">Exemplos de campos na interface Jira e sua classe correspondente</b> <div class="spoiler_text"><img width="500" src="https://habrastorage.org/webt/ea/dd/bf/eaddbfm0cphjpqionp16hqstxg0.png"><br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IssueFor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> \</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Badoo</span></span></span><span class="hljs-class">\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Jira</span></span></span><span class="hljs-class">\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomFields</span></span></span><span class="hljs-class">\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SingleSelectField</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ID = <span class="hljs-string"><span class="hljs-string">'customfield_10662'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> NAME = <span class="hljs-string"><span class="hljs-string">'Issue for'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* Available field values. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> VALUE_BI = <span class="hljs-string"><span class="hljs-string">'BI'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> VALUE_C_C = <span class="hljs-string"><span class="hljs-string">'C\C++'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> VALUE_HTML_CSS = <span class="hljs-string"><span class="hljs-string">'HTML\CSS'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> VALUE_JS = <span class="hljs-string"><span class="hljs-string">'JS'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> VALUE_OTHER = <span class="hljs-string"><span class="hljs-string">'Other'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> VALUE_PHP = <span class="hljs-string"><span class="hljs-string">'PHP'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> VALUE_TRANSLATION = <span class="hljs-string"><span class="hljs-string">'Translation'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> VALUES = [ <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::VALUE_BI, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::VALUE_C_C, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::VALUE_HTML_CSS, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::VALUE_JS, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::VALUE_OTHER, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::VALUE_PHP, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::VALUE_TRANSLATION, ]; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getItemsList</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">array</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::VALUES; } }</code> </pre><br></div></div><br>  Acontece que esse tipo de documenta√ß√£o √© para o seu Jira, localizado diretamente no c√≥digo PHP.  Quando est√° t√£o perto, √© muito conveniente e acelera significativamente o desenvolvimento, reduzindo o n√∫mero de erros. <br><br>  Al√©m disso, as mensagens de erro ficam mais claras: em vez de dizer nada, <b>'customfield_12664'</b> falha, por exemplo, algo como isto: <br><br><pre> <code class="plaintext hljs">Uncaught Badoo\Jira\Exception\CustomField: User 'asdkljfh' not found in Jira. Can't change 'Developer' field value.</code> </pre><br><h3>  Classes para trabalhar com objetos do sistema </h3><br>  O Jira possui muitos dados com uma estrutura complexa: por exemplo, os campos do sistema <b>Status</b> e <b>Seguran√ßa</b> , links entre tarefas, usu√°rios, vers√µes, anexos (arquivos). <br><br>  Tamb√©m os envolvemos em aulas: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//   $Status = $Issue-&gt;getStatus(); $Status-&gt;getName(); $Status-&gt;getId();</span></span></code> </pre><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// changelog  $History = \Badoo\Jira\Issue\History::forIssue('SMPL-1'); $seconds_in_status = $History-&gt;getTimeInStatus('Open');</span></span></code> </pre><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//  Jira $User = new \Badoo\Jira\User('sampleuser'); $User-&gt;assign('SMPL-1');</span></span></code> </pre><br>  Esses wrappers oferecem ao seu IDE a capacidade de informar quais dados est√£o dispon√≠veis e permitem formalizar estritamente as interfaces de fun√ß√£o no seu c√≥digo.  Utilizamos ativamente declara√ß√µes de tipo, quase sempre nos permite ver um erro, mesmo ao escrever c√≥digo, gra√ßas ao destaque do IDE.  E se voc√™ ainda perdeu o erro, ele sair√° exatamente no local em que apareceu pela primeira vez, e n√£o onde voc√™ finalmente soltou seu c√≥digo. <br><br>  Ainda existem m√©todos est√°ticos que permitem obter rapidamente um objeto por algum crit√©rio: <br><br><pre> <code class="php hljs">$users = \Badoo\Jira\User::search(<span class="hljs-string"><span class="hljs-string">'&lt;pattern&gt;'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//    login, email  display name $Version = \Badoo\Jira\Version::byName('&lt;project&gt;', '&lt;version name&gt;'); //        $components = \Badoo\Jira\Component::forProject('&lt;project&gt;'); //     </span></span></code> </pre><br>  Esses m√©todos obedecem √†s regras gerais para que sejam f√°ceis de encontrar: <br><ul><li>  <i>:: search ()</i> , se voc√™ precisar encontrar objetos em v√°rios campos: \ Badoo \ Jira \ Issue :: search () procura tarefas usando JQL, onde √© poss√≠vel especificar muitos crit√©rios de pesquisa, e \ Badoo \ Jira \ User :: search () pesquisa o usu√°rio ao mesmo tempo por <i>'nome'</i> (login), <i>'email'</i> e <i>'displayName'</i> (o nome que √© renderizado na web); </li><li>  <i>:: by * ()</i> , se voc√™ precisar obter o objeto n√£o por ID, mas por algum outro crit√©rio: \ Badoo \ Jira \ User :: byEmail () est√° procurando um usu√°rio pelo endere√ßo de email; </li><li>  <i>:: for * ()</i> procura todos os objetos associados a algo: \ Badoo \ Jira \ Version :: forProject <br>  fornece todas as vers√µes de um projeto espec√≠fico; </li><li>  <i>:: fromStdClass ()</i> criar√° um objeto a partir de dados brutos que possuem uma estrutura adequada, mas n√£o recebida da API, mas, por exemplo, do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">webhook</a> : no corpo da solicita√ß√£o POST, Jira envia ao JSON informa√ß√µes diferentes sobre o evento, incluindo o corpo da tarefa incluindo todos os campos.  Com base nesses dados, voc√™ pode criar o objeto \ Badoo \ Jira \ Issue e us√°-lo normalmente. </li></ul><br><h3>  Classe \ Badoo \ Jira \ Issue </h3><br>  Parece-me que a seguinte captura de tela do PhpStorm √© bastante eloquente em si: <br><br><img width="600" src="https://habrastorage.org/webt/ox/_m/jz/ox_mjzztnjrjtzexiudykocfkwc.png"><br><br>  Em ess√™ncia, o objeto <b>\ Badoo \ Jira \ Issue</b> vincula tudo descrito acima em um √∫nico sistema.  Ele armazena todas as informa√ß√µes sobre a tarefa, possui m√©todos para acesso r√°pido aos dados usados ‚Äã‚Äãcom mais frequ√™ncia, transfer√™ncia de tarefas entre status etc. <br><br>  Para criar um objeto no caso mais simples, basta conhecer apenas a chave da tarefa. <br><br><div class="spoiler">  <b class="spoiler_title">Crie um objeto com apenas uma chave de tarefa no bolso</b> <div class="spoiler_text"><pre> <code class="php hljs">$Issue = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \Badoo\Jira\Issue(<span class="hljs-string"><span class="hljs-string">'SMPL-1'</span></span>);</code> </pre><br></div></div><br>  Voc√™ tamb√©m pode usar qualquer conjunto de dados fragmentado.  Por exemplo, as informa√ß√µes do link entre as tarefas que chegam da API cont√™m apenas alguns campos: ID, resumo, status, prioridade e tipo de emiss√£o.  <b>\ Badoo \ Jira \ Issue</b> permite coletar um objeto desses dados para que ele possa ser retornado imediatamente e, para o restante, acessar a API. <br><br><div class="spoiler">  <b class="spoiler_title">Crie um objeto, armazenando em cache valores para alguns campos</b> <div class="spoiler_text"><pre> <code class="php hljs"> $IssueFromLink = \Badoo\Jira\Issue::fromStdClass( $LinkInfo, [ <span class="hljs-string"><span class="hljs-string">'id'</span></span>, <span class="hljs-string"><span class="hljs-string">'key'</span></span>, <span class="hljs-string"><span class="hljs-string">'summary'</span></span>, <span class="hljs-string"><span class="hljs-string">'status'</span></span>, <span class="hljs-string"><span class="hljs-string">'priority'</span></span>, <span class="hljs-string"><span class="hljs-string">'issuetype'</span></span>, ] );</code> </pre><br></div></div><br>  Isso √© obtido atrav√©s da inicializa√ß√£o lenta e do armazenamento em cache de dados no c√≥digo.  Essa abordagem √© especialmente conveniente, pois voc√™ s√≥ pode trocar objetos <b>\ Badoo \ Jira \ Issue</b> no seu c√≥digo, independentemente de qual conjunto de campos eles foram criados. <br><br><div class="spoiler">  <b class="spoiler_title">Obter os dados da tarefa ausentes</b> <div class="spoiler_text"><pre> <code class="php hljs">$IssueFromLink-&gt;getSummary(); <span class="hljs-comment"><span class="hljs-comment">//    API,    $IssueFromLink-&gt;getDescription(); //  API    description</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Como vamos para a API</b> <div class="spoiler_text">  Na API do Jira, √© poss√≠vel obter nem todos os campos de uma tarefa, mas apenas os campos necess√°rios no momento: por exemplo, apenas chave e resumo.  No entanto, intencionalmente n√£o vamos a Jira para apenas um campo no getter.  No exemplo acima, getDescription () atualizar√° informa√ß√µes sobre todos os campos de uma s√≥ vez.  Como o <b>\ Badoo \ Jira \ Issue</b> n√£o tem a menor id√©ia do que mais voc√™ precisa a seguir, √© mais lucrativo obter tudo da API imediatamente, j√° que fomos para l√° de qualquer maneira.  Sim, a consulta "obter apenas descri√ß√£o" e a consulta "obter todos os campos por padr√£o" para algumas centenas de tickets levam tempos diferentes, mas para um, essa diferen√ßa n√£o √© t√£o percept√≠vel. <br><br><pre> <code class="plaintext hljs">//Time for single field: 0.40271635055542 (second) //Time for all default fields: 0.84159119129181 (second)</code> </pre><br>  A partir das figuras, fica claro que, ao receber apenas tr√™s campos (um na solicita√ß√£o), √© mais rent√°vel obter tudo de uma s√≥ vez, em vez de acessar a API de cada um.  O resultado dessa medi√ß√£o, de fato, depende da configura√ß√£o do Jira e do servidor no qual ele √© executado.  De tarefa para tarefa e de medi√ß√£o em medi√ß√£o, os n√∫meros mudam e o <b>Tempo para todos os campos padr√£o</b> acaba sendo estavelmente menor que tr√™s. <b>Tempo para campo √∫nico</b> e, geralmente, menor que dois. <br><br>  No entanto, ao trabalhar com um grande n√∫mero de tarefas, a diferen√ßa pode ser medida em segundos.  Portanto, quando voc√™ sabe que precisa apenas de chave e descri√ß√£o para 500 tickets, a capacidade de obt√™-los com uma consulta efetiva permanece nos <b>m√©todos</b> <b>\ Badoo \ Jira \ Issue :: search ()</b> e <b>\ Badoo \ Jira \ Issue :: byKeys ()</b> . <br><br></div></div><br>  <b>\ Badoo \ Jira \ Issue</b> - geralmente sobre tarefas em algum Jira abstrato.  Mas o seu (como o nosso) Jira n√£o √© abstrato - ele tem um conjunto muito espec√≠fico de campos personalizados e seu pr√≥prio fluxo de trabalho.  Voc√™ usa alguns dos campos e transi√ß√µes com frequ√™ncia, por isso n√£o √© muito conveniente ir atr√°s deles o tempo todo.  Portanto, <b>\ Badoo \ Jira \ Issue</b> pode ser facilmente estendido com seus pr√≥prios m√©todos espec√≠ficos para uma configura√ß√£o espec√≠fica do Jira. <br><br><div class="spoiler">  <b class="spoiler_title">Um exemplo de extens√£o de classe por um m√©todo para obter rapidamente um campo personalizado</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> \<span class="hljs-title"><span class="hljs-title">Deploy</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Issue</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> \</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Badoo</span></span></span><span class="hljs-class">\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Jira</span></span></span><span class="hljs-class">\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Issue</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ‚Ä¶ /** * Get 'Developer' custom field as object */ function getDeveloperField() : \Deploy\CustomFields\Developer { return $this-&gt;getCustomField(\Deploy\CustomFields\Developer::class); } // ... }</span></span></code> </pre><br></div></div><br><br><h3>  Solicita√ß√£o de cria√ß√£o de problema </h3><br>  Criar uma tarefa no Jira √© um procedimento bastante complicado.  Quando voc√™ faz isso atrav√©s da interface da web, √© exibida uma tela especial (Criar tela) com um conjunto de campos.  Alguns deles podem ser preenchidos simplesmente porque voc√™ deseja, e alguns s√£o marcados como obrigat√≥rios.  Ao mesmo tempo, a tela Criar pode ser exclusiva para cada projeto e at√© para diferentes tipos de tarefas em um projeto.  Portanto, existem todos os tipos de restri√ß√µes nos valores do campo e na pr√≥pria possibilidade de definir o valor do campo no processo de cria√ß√£o da tarefa. <br><br>  A coisa mais desagrad√°vel para os desenvolvedores nessa situa√ß√£o √© que essas restri√ß√µes se aplicam √† API.  O √∫ltimo possui uma solicita√ß√£o especial ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">create-meta est√°</a> dispon√≠vel na API REST desde a vers√£o 5.0), com a qual voc√™ pode obter uma lista das configura√ß√µes de campo dispon√≠veis ao criar uma tarefa.  No entanto, um desenvolvedor que precisa "simplesmente fazer uma coisa simples agora" provavelmente n√£o se incomodar√° com isso. <br><br>  Como resultado, aconteceu da seguinte maneira: como a solicita√ß√£o para criar uma tarefa pode ser bastante grande, geralmente adicionamos dados gradualmente a ela e recebemos um erro ao tentar enviar tudo para Jira.  Depois disso, tive que procurar no c√≥digo todos os lugares onde algo mudou na solicita√ß√£o e uma tentativa longa e entediante de entender o que exatamente deu errado. <br><br>  Portanto, fizemos <b>\ Badoo \ Jira \ Issue \ CreateRequest</b> .  Ele permite que voc√™ veja o erro mais cedo, exatamente no local em que est√° tentando fazer algo errado: forne√ßa ao campo algum tipo de valor curvo ou altere o campo que n√£o est√° dispon√≠vel.  Por exemplo, se voc√™ tentar especificar um componente que n√£o existe no projeto, a exce√ß√£o ser√° interrompida no local em que voc√™ o fez e n√£o no local em que voc√™ finalmente enviou a solicita√ß√£o √† API. <br><br><div class="spoiler">  <b class="spoiler_title">O fluxo de trabalho com CreateRequest se parece com isso</b> <div class="spoiler_text"><pre> <code class="php hljs">$Request = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \Badoo\Jira\Issue\CreateRequest(<span class="hljs-string"><span class="hljs-string">'DD'</span></span>, <span class="hljs-string"><span class="hljs-string">'Task'</span></span>, $Client); $Request -&gt;setSummary(<span class="hljs-string"><span class="hljs-string">'summary'</span></span>) -&gt;setDescription(<span class="hljs-string"><span class="hljs-string">'description'</span></span>) -&gt;setFieldValue(<span class="hljs-string"><span class="hljs-string">'For QA'</span></span>, <span class="hljs-string"><span class="hljs-string">'custom field with some comments for QA who will check the issue'</span></span>); $Request-&gt;send();</code> </pre><br></div></div><br><h3>  Trabalhar diretamente com a API </h3><br>  O conjunto de classes descrito acima cobre a maioria das necessidades.  No entanto, estamos bem cientes de que a maioria est√° longe de tudo.  Portanto, tamb√©m temos um cliente pequeno para trabalhar diretamente com a API - <b>\ Badoo \ Jira \ REST \ Client</b> . <br><br><div class="spoiler">  <b class="spoiler_title">Caso de Uso do Cliente</b> <div class="spoiler_text"><pre> <code class="php hljs">$Jira = \Badoo\Jira\REST\Client::instance(); $Jira-&gt;setJiraUrl(<span class="hljs-string"><span class="hljs-string">'https://jira.example.com/'</span></span>); $Jira-&gt;setAuth(<span class="hljs-string"><span class="hljs-string">'user'</span></span>, <span class="hljs-string"><span class="hljs-string">'password'</span></span>) $IssueInfo = $Jira-&gt;issue()-&gt;get(<span class="hljs-string"><span class="hljs-string">'SMPL-1'</span></span>);</code> </pre><br></div></div><br><h2>  Gerador de classe para campos personalizados </h2><br>  Para facilitar o trabalho com campos personalizados, cada campo deve ter sua pr√≥pria classe no c√≥digo.  N√≥s os criamos manualmente, conforme necess√°rio, mas antes de publicar o cliente, decidimos que essa abordagem pode n√£o ser muito conveniente para novos usu√°rios.  Portanto, criamos um gerador especial que pode acessar a API do Jira para obter uma lista de campos personalizados e criar classes de modelos para os tipos de campos conhecidos. <br><br>  Acreditamos que, para a maioria das tarefas, √© suficiente usar o script CLI <b>bin / generate</b> do nosso reposit√≥rio.  Voc√™ pode pedir que ele conte sobre si mesmo atrav√©s da op√ß√£o <b>--help / -h</b> : <br><br><pre> <code class="bash hljs">./bin/generate --<span class="hljs-built_in"><span class="hljs-built_in">help</span></span></code> </pre><br>  No caso mais simples, para gera√ß√£o, basta especificar a URL do seu Jira, o usu√°rio, sua senha, espa√ßo para nome das classes e o diret√≥rio onde colocar o c√≥digo: <br><br><pre> <code class="bash hljs">./bin/generate -u user -p password --jira-url https://jira.mlan --target-dir custom-fields --namespace CustomFields</code> </pre><br>  Tamb√©m implementamos a capacidade de adicionar nossos pr√≥prios modelos e gerar classes para campos individuais.  Isso pode ser encontrado na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documenta√ß√£o</a> . <br><br><h2>  Conclus√£o </h2><br>  N√≥s gostamos do que conseguimos.  Com esse conceito - nossas pr√≥prias classes para campos personalizados, wrappers para status, vers√µes, usu√°rios etc. - vivemos h√° mais de um ano e nos sentimos bem.  Antes de publicar o c√≥digo, at√© expandimos a funcionalidade e adicionamos coisas maravilhosas que n√£o chegavam √†s suas m√£os por muito tempo para usar o cliente era ainda mais conveniente: por exemplo, adicionamos a capacidade de atualizar v√°rios campos no problema em uma solicita√ß√£o e escrevemos um gerador de classe para campos personalizados. <br><br>  Em nossa opini√£o, acabou sendo uma coisa boa, que definitivamente deve ser sentida para entender se ela se adequa √†s suas tarefas e requisitos.  Sob o nosso - apenas ajuste. <br><br>  Link novamente: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">github.com/badoo/jira-client</a> . <br><br>  Obrigado por ler at√© o fim.  Esperamos que este c√≥digo agora seja beneficiado e economize tempo, n√£o apenas para n√≥s. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt475840/">https://habr.com/ru/post/pt475840/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt475830/index.html">Console retro port√°til de bricolage</a></li>
<li><a href="../pt475832/index.html">Express√µes de m√≠dia CSS t√™m mais do que largura m√°xima</a></li>
<li><a href="../pt475834/index.html">Scrum n√£o ir√° ajud√°-lo. Entendemos porque</a></li>
<li><a href="../pt475836/index.html">Entrevista com Arthur Khachuyan: como calcular um bilion√°rio nas redes sociais?</a></li>
<li><a href="../pt475838/index.html">MUDAR pessoas. Ou ... mudar pessoas. Sobre como "decolar" o projeto de transforma√ß√£o</a></li>
<li><a href="../pt475842/index.html">Substituindo URL de a√ß√£o e URI em telefones SIP ou gerenciando via websockets?</a></li>
<li><a href="../pt475848/index.html">Como a pesquisa Yandex.Market funciona e o que acontecer√° se um dos servidores travar</a></li>
<li><a href="../pt475850/index.html">Como come√ßar a construir uma carreira em TI, se voc√™ ainda n√£o tem experi√™ncia</a></li>
<li><a href="../pt475856/index.html">O Google App Script, Mikrotik, Telegram e VPNBook come√ßaram a tocar um quarteto</a></li>
<li><a href="../pt475858/index.html">Divertido cripto-energia: o calor da minera√ß√£o para humanos e o calor dos humanos para minera√ß√£o</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>