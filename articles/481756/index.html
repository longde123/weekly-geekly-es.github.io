<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üõå üî∞ üòõ ¬øC√≥mo organizar DDoS para buenos prop√≥sitos? üë∂üèæ üë©‚Äçüë©‚Äçüë¶ üí∏</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Antes del lanzamiento de un nuevo servicio, ser√≠a bueno asegurarse de que funciona de acuerdo con nuestras expectativas y que est√° disponible independ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>¬øC√≥mo organizar DDoS para buenos prop√≥sitos?</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ntc-vulkan/blog/481756/"><p><img src="https://habrastorage.org/webt/qa/gk/up/qagkupe_y5cx7thbrqpj4aynn1y.png" alt="imagen"></p><br><p>  Antes del lanzamiento de un nuevo servicio, ser√≠a bueno asegurarse de que funciona de acuerdo con nuestras expectativas y que est√° disponible independientemente de cu√°ntos clientes lo usen al mismo tiempo. </p><br><p>  ¬øY c√≥mo reaccionar√° este servicio si se organiza un ataque DoS distribuido contra √©l?  ¬øEl recurso est√° protegido de posibles atacantes? </p><br><p>  Para evaluar los posibles riesgos y aumentar la seguridad, tiene sentido llevar a cabo de forma independiente acciones que simulen un ataque DDoS mientras el recurso a√∫n no se haya lanzado para uso masivo. </p><br><p>  En este art√≠culo, hablaremos sobre la experiencia de organizar pruebas de carga para servicios DNS y HTTP. </p><a name="habracut"></a><br><h1>  Preparaci√≥n </h1><br><p>  Para provocar la generaci√≥n de una gran cantidad de tr√°fico de red en el recurso monitoreado, debe usar muchas m√°quinas virtuales, cada una de las cuales enviar√° el n√∫mero m√°ximo de solicitudes al servicio.  Si no tiene un centro de datos potente, tiene sentido alquilar temporalmente m√°quinas virtuales en una nube.  Esta idea tiene una caracter√≠stica: debe asegurarse de que la nube no se arrastre, tomando su actividad por las acciones de un atacante. </p><br><p>  Al comparar las pol√≠ticas de varios servicios en la nube (alguien despiadadamente proh√≠be una cuenta con la que, presumiblemente, se tomaron medidas que llevaron a una falla de recursos) con respecto a las pruebas de carga utilizando su funcionalidad, decidimos detenernos en <a href="https://aws.amazon.com/">Amazon Web Services</a> (AWS).  Sus <a href="https://aws.amazon.com/ru/ec2/testing/">documentos</a> indican que AWS permite pruebas de carga, pero solicita aprobaci√≥n enviando un correo electr√≥nico a una direcci√≥n espec√≠fica. </p><br><h1>  Armonizaci√≥n de las pruebas de resistencia. </h1><br><p>  Enviamos un mensaje donde hablamos brevemente sobre nuestras intenciones, y recibimos un formulario que debe completarse: </p><br><pre><code class="plaintext hljs">Customer ID: Customer Name: Email Address: AWS Account ID load test will be performed from: Does the customer have an NDA? Target Data EC2 Resources: Cloudfront Distribution: API Gateway / Lambda ID: ELB Names: Non-AWS Target: Region (please list all regions in scope for testing): Source Data: IP Addresses: Source Account ID: Regions involved: Testing Parameters: How much traffic do you plan to generate by region during testing? What is your expected peak load from source by region? (ie xx Gbps) What is your expected peak load at destination? (ie xx Gbps) Are you testing traffic outbound from EC2, inbound into EC2, or both? Are you testing traffic outbound (egress) from EC2, inbound (ingress) into EC2, or both: Egress. What is your expected peak load from source by region? (ie xx Gbps) Ingress. What is your expected peak load from source by region? (ie xx Gbps) Start Date: End Date: Finite testing details including timeline of testing: Summary of Test: Testing Timelines by phase including rps, pps, and Gbps: Peak bandwidth for each source IP: Tools Used for each phase of test: Types of testing to be performed for each phase of the request: What criteria/metrics will you monitor to ensure the success of this test? Who is performing the Load Test? (Please provide contact details): Does the tester have an NDA? Testing Security Do you have a way to monitor the data traffic for the duration of the test to verify bandwidth limits do not exceed approved rates? Do you have a way to immediately stop the traffic if we/you discover any issue? 2 Emergency contact names and phone numbers:</code> </pre> <br><p>  Hay varios matices: </p><br><ol><li><p>  Nos preguntan a qui√©n "broncearemos".  ¬øTenemos derecho a esto?  Decimos que este es nuestro recurso (aparentemente, nadie verifica si esto es as√≠) y que las pruebas son completamente consistentes. </p><br></li><li><p>  Necesitamos designar cu√°nto tr√°fico crearemos en cada una de las regiones.  Durante la correspondencia, descubrimos que cada regi√≥n tiene su propio l√≠mite en la cantidad de tr√°fico de red.  En total, se les permite solicitar 645 Gb / s.  Consideramos cu√°nto se necesita para el ataque y seleccionamos las regiones de tal manera que se obtenga el valor necesario. </p><br></li><li><p>  Es necesario describir a qu√© hora se llevar√° a cabo el ataque, cu√°nto durar√° y c√≥mo crecer√° su poder.  En forma libre, pero con suficiente detalle hablamos de nuestros planes.  El ataque se lleva a cabo con un aumento gradual de la potencia, por lo que pintamos qu√© etapas tendr√° la prueba y qu√© potencia m√°xima se espera en cada una de ellas.  La fecha del ataque puede omitirse hasta un d√≠a; es muy posible indicar un rango de dos a tres semanas. </p><br></li><li><p>  Y sin falta, estamos haciendo todo lo posible para asegurarnos de que nos comportaremos bien, monitorear cuidadosamente el progreso de las pruebas y detenerlo en la primera solicitud si es necesario. </p><br></li></ol><br><p>  Lo m√°s probable es que, en respuesta al formulario completado, soliciten alguna aclaraci√≥n, por lo que nos corresponde y respondemos preguntas hasta que obtengamos permiso para realizar la prueba. </p><br><p>  Se tarda unos tres d√≠as h√°biles en completar el proceso de aprobaci√≥n si se responde con prontitud. </p><br><h1>  Preparaci√≥n de infraestructura </h1><br><p>  Despu√©s de las aprobaciones, nos enfrentamos a la necesidad de preparar la infraestructura para las pruebas.  El hecho es que durante el control tendremos que: </p><br><p>  ‚Ä¢ incluir una instancia; </p><br><p>  ‚Ä¢ lanzar un ataque de prueba; </p><br><p>  ‚Ä¢ recopilar estad√≠sticas sobre el progreso; </p><br><p>  ‚Ä¢ detener el ataque de prueba; </p><br><p>  ‚Ä¢ cambiar la direcci√≥n IP; </p><br><p>  ‚Ä¢ apague la instancia. </p><br><h2>  Crear imagen de instancia </h2><br><h3>  Seleccionar tipo de instancia </h3><br><p>  Primero, creemos una imagen de AWS que contendr√° las herramientas y los scripts necesarios para la administraci√≥n.  El primer paso es elegir qu√© instancia alquilar.  Estudiamos las caracter√≠sticas de diferentes tipos de instancias: observamos el precio, la cantidad de tr√°fico m√°ximo, la potencia de la CPU (esto √∫ltimo es importante, porque el tr√°fico es creado por las capacidades del procesador despu√©s de todo), luego probamos el rendimiento real y el n√∫mero m√°ximo de solicitudes.  Seg√∫n nuestras estimaciones, las <code>t3.small</code> instancias son las m√°s convenientes para la prueba, pero aqu√≠ todos eligen su gusto. </p><br><p>  Las caracter√≠sticas de las instancias se pueden encontrar <a href="https://aws.amazon.com/ec2/instance-types/">aqu√≠</a> .  Tambi√©n puede seleccionar y comparar instancias <a href="https://www.ec2instances.info/">aqu√≠</a> . </p><br><h3>  Solicitud de l√≠mite </h3><br><p>  Debe pensar de antemano cu√°ntas instancias participar√°n en la prueba.  El hecho es que Amazon proporciona a cada regi√≥n sus l√≠mites en el n√∫mero de instancias.  Si tiene la sensaci√≥n de que necesitar√° m√°s instancias de las que est√°n disponibles por defecto, entonces debe solicitar un aumento en el l√≠mite lo antes posible.  Para hacerlo, vaya a la secci√≥n <a href="https://console.aws.amazon.com/support/cases">Soporte</a> , cree una llamada de tipo Aumento del l√≠mite de servicio.  El tiempo de procesamiento de una solicitud puede ser diferente: alguien responde al d√≠a siguiente, proporcionando tantas entidades como se le solicite, alguien dice que no permitir√° que se ejecuten m√°s de N instancias.  Hubo regiones que respondieron a la solicitud durante aproximadamente un mes. </p><br><h3>  Ajuste de rendimiento </h3><br><p>  A continuaci√≥n, debe crear una imagen de instancia que se iniciar√° durante la prueba.  Para hacer esto, activamos la instancia del tipo seleccionado, hacemos todos los ajustes y luego guardamos lo que sucedi√≥ como una imagen (en el men√∫ Acciones, donde puede habilitar la instancia, as√≠ como la funcionalidad para crear una Imagen Crear Imagen). </p><br><p>  Necesitamos obtener el m√°ximo tr√°fico saliente de cada instancia, por lo que primero optimizamos la configuraci√≥n de red y memoria para nuestra tarea en la instancia. </p><br><p>  Para hacer esto, realice la configuraci√≥n en el archivo <code>/etc/sysctl.conf</code> : </p><br><p>  ‚Ä¢ Aumente el rango de puertos locales y reduzca el tiempo que pasan los sockets en el estado FIN_WAIT: </p><br><pre> <code class="plaintext hljs">net.ipv4.ip_local_port_range = 1024-65535 ( : 32768-61000) net.ipv4.tcp_fin_timeout = 10 ( : 60)</code> </pre> <br><p>  El rango de puerto local determina el n√∫mero m√°ximo de sockets salientes que un host puede crear desde una IP espec√≠fica. </p><br><p>  Con la configuraci√≥n predeterminada (61,000‚Äì32,768), se obtienen 28,233 sockets.  Con nuevas configuraciones - 64 500. </p><br><p>  Fin_timeout define el tiempo m√≠nimo que los sockets salientes pueden estar en estado FIN_WAIT. </p><br><p>  Si se especifican valores predeterminados, el sistema no puede proporcionar m√°s de (61,000‚Äì32,768) / 60 = 470 sockets por segundo. </p><br><p>  Al aumentar port_range y disminuir fin_timeout, podemos afectar la capacidad del sistema para generar m√°s conexiones salientes. </p><br><p>  ‚Ä¢ Reutilicemos los sockets en el estado TIME_WAIT cuando finalicen los gratuitos: </p><br><pre> <code class="plaintext hljs">net.ipv4.tcp_tw_reuse = 1</code> </pre> <br><p>  Establecer la opci√≥n anterior (que est√° deshabilitada de manera predeterminada) ayuda a minimizar la p√©rdida de conexiones "inactivas" ya realizadas. </p><br><p>  Muy detallado sobre TIME_WAIT se describe en este <a href="https://vincent.bernat.ch/en/blog/2014-tcp-time-wait-state-linux">art√≠culo</a> . </p><br><p>  ‚Ä¢ Active la opci√≥n tcp_timestamps para que funcione la opci√≥n tcp_tw_reuse anterior: </p><br><pre> <code class="plaintext hljs">net.ipv4.tcp_timestamps = 1 ‚Äì   `tcp_timestamps`     tcp_tw_reuse</code> </pre> <br><p>  ‚Ä¢ Otras opciones: </p><br><pre> <code class="plaintext hljs">net.ipv4.tcp_max_tw_buckets = 720000 ‚Äì       TIME_WAIT net.ipv4.tcp_keepalive_time = 600 ‚Äì  - keepalive- net.ipv4.tcp_keepalive_probes = 3 ‚Äì   keepalive- net.ipv4.tcp_keepalive_intvl = 10 ‚Äì     keepalive- net.ipv4.tcp_window_scaling = 1 ‚Äì   TCP- net.ipv4.tcp_mem = 8192 131072 196304 ‚Äì     TCP- net.ipv4.udp_mem = 8192 131072 196304 ‚Äì     udp- net.ipv4.tcp_slow_start_after_idle=0 ‚Äì  Slow-Start Restart net.core.wmem_default = 31457280 ‚Äì         net.core.wmem_max = 33554432 ‚Äì        net.core.somaxconn = 65535 ‚Äì        net.core.netdev_max_backlog = 65535 ‚Äì          vm.swappiness = 30 ‚Äì    vm.dirty_ratio = 50 ‚Äì     50 %  vm.pagecache = 90 ‚Äì    </code> </pre> <br><h3>  Probar guiones de ataque </h3><br><p>  <strong>1. ataque DNS</strong> </p><br><p>  Una de las principales tareas de las pruebas es evaluar el rendimiento de los servidores DNS.  Es decir, los servidores DNS pueden convertirse en el cuello de botella de la tolerancia a fallas de un sitio, porque incluso si el servicio m√°s estable no est√° disponible si hay problemas con DNS.  Para crear una carga en los servidores DNS, generaremos muchas consultas DNS diferentes.  Las solicitudes deben ser v√°lidas y requieren la mayor respuesta posible y m√°s larga del servidor DNS. </p><br><p>  La utilidad <a href="https://www.dns-oarc.net/tools/dnsperf">DNSPerf</a> es adecuada para generar dicho tr√°fico. </p><br><p>  DNSPerf es una herramienta de prueba de rendimiento de DNS simple, flexible y gratuita.  Est√° dise√±ado principalmente para servidores DNS autorizados, pero tambi√©n se puede usar para medir el rendimiento de los servidores de almacenamiento en cach√©. </p><br><p>  En nuestro caso, se cargan servidores DNS autorizados que sirven a una zona: example.com. </p><br><p>  Para DNSPerf, primero preparamos un archivo con las solicitudes <code>dns_queries.txt</code> (principalmente CUALQUIERA para aumentar el tiempo y el tama√±o de la respuesta del servidor DNS): </p><br><pre> <code class="plaintext hljs">#dns_queries.txt example.com ANY www.example.com ANY test.example.com ANY static.example.com ANY example.com  www.example.com  test.example.com MX</code> </pre> <br><p>  Ejemplo de ejecuci√≥n de la utilidad: </p><br><pre> <code class="plaintext hljs">dnsperf -s TARGET_IP -d dns_queries.txt -c 100 -n 100 -s =  IP- -d =      .   ‚Äì stdin -c =   .         -n =  ¬´¬ª   .</code> </pre> <br><p>  <strong>2. Ataque a ICMP</strong> </p><br><p>  La siguiente etapa de prueba es evaluar la resistencia a una gran cantidad de tr√°fico ICMP.  Dado que, por razones t√©cnicas, los servidores a menudo necesitan poder responder a las solicitudes de ping, existe la posibilidad de un ataque DDoS mediante solicitudes de ping.  Adem√°s de especificar configuraciones que excluyen la posibilidad de <code>ping-to-death</code> , debe asegurarse de que los servidores sean resistentes a las cargas m√°ximas de ICMP.  Para crear tales cargas, es mejor usar la conocida utilidad <a href="https://linux.die.net/man/8/hping3">hping3</a> , que le permite ajustar la cantidad de solicitudes, el intervalo entre env√≠os y el tama√±o del paquete. </p><br><p>  Ejemplo de ejecuci√≥n de la utilidad: </p><br><pre> <code class="plaintext hljs">hping3 -i u1000 -d 1500 -c 100000 -1 TARGET_IP -i u100 =     (uX for X microseconds) -d 1500 =    -c 1000000 =     -1 =  ICMP</code> </pre> <br><p>  <strong>3. ataque HTTP</strong> </p><br><p>  Ahora verificamos la resistencia al estr√©s, la funcionalidad principal del servicio: procesar el tr√°fico HTTP (S).  Una de las herramientas m√°s flexibles y f√°ciles para generar tr√°fico HTTP es el <a href="https://linux.die.net/man/1/siege">asedio</a> .  Siege es una utilidad multiproceso de c√≥digo abierto dise√±ada para probar el rendimiento de un recurso web. </p><br><p>  Al igual que DNSPerf, el sitio le permite cargar el servidor con solicitudes de un n√∫mero determinado de usuarios virtuales (la emulaci√≥n del usuario se lleva a cabo utilizando un puerto separado), as√≠ como utilizar un conjunto predefinido de solicitudes.  Esto es muy conveniente, ya que puede incluir las consultas m√°s intensivas en recursos en la prueba. </p><br><p>  Ejemplo de ejecuci√≥n de la utilidad: </p><br><pre> <code class="plaintext hljs">siege -b -c 100 -f test_urls.txt -b =   ( benchmark) -c =   .         -f =   </code> </pre> <br><p>  Formato de contenido <code>test_urls.txt</code> : </p><br><pre> <code class="plaintext hljs">http://example.com/site/login POST login=username&amp;password=test http://example.com/site/client POST useragent=Mozilla&amp;version=123&amp;date=24May http://example.com/site/order POST user=username&amp;company=ooo&amp;phone=812345678</code> </pre> <br><p>  Como puede ver, las pruebas se llevaron a cabo utilizando principalmente solicitudes POST que requieren procesamiento en el lado del servidor y ocupan la mayor cantidad de recursos en comparaci√≥n con otros tipos de solicitudes. </p><br><p>  Ninguna de las opciones utiliza suplantaci√≥n de IP, ya que Amazon no lo permite.  Independientemente de lo que se especifique src_IP en el paquete, se cambiar√° al correcto al salir de la instancia. </p><br><p>  Todas las solicitudes generadas deben ser leg√≠timas, sin oleadas de tr√°fico saliente sin respuesta, ya que la pol√≠tica DDoS de Amazon es bastante estricta.  Incluso una prueba de esfuerzo coordinada toma un m√≠nimo de varios d√≠as para comunicarse con el soporte t√©cnico, y en las primeras acciones "maliciosas" obtenemos la prohibici√≥n del puerto del que sali√≥ el tr√°fico, y el requisito debe explicarse de inmediato. </p><br><h3>  Scripts para lanzar ataques </h3><br><p>  Para la gesti√≥n remota de pruebas, prepararemos scripts de bash (dns.sh, ping.sh, http.sh) que inician el tipo de ataque deseado y los archivos de carga √∫til (test_urls.txt, valid_dns_queries.txt). </p><br><p>  Cuando cargamos todo esto en la imagen de AWS (desde la cual se crear√°n todas las instancias), cada prueba se puede ejecutar de forma remota con el comando del siguiente formato: </p><br><pre> <code class="plaintext hljs">ssh instance-amazon 'sudo &lt;stress-script&gt;.sh start &lt;params&gt; &amp;&gt;&gt;stress.log &amp;'</code> </pre> <br><p>  El script del tipo requerido se especifica como stress-script.sh, y los par√°metros son los par√°metros correspondientes.  En el archivo stress.log, rastrearemos el resultado de la utilidad en ejecuci√≥n.  Para mayor comodidad, utilizaremos diferentes registros para diferentes utilidades: dns.log, ping.log, http.log. </p><br><p>  Ejemplo de script <code>dns.sh</code> : </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash if [[ ! "$1" =~ ^(start|stop|status)$ ]]; then echo "nothing to do: need argument for stop,start or status" exit 1 fi if [[ "$1" = "start" ]]; then shift dnsperf $@ fi if [[ "$1" = "stop" ]]; then kill $(pidof dnsperf) fi if [[ "$1" = "status" ]]; then if [[ ! "$(pidof dnsperf)" = "" ]]; then echo "dnperf is running with PID $(pidof dnsperf)" ps aux | grep dnsperf else echo "dnsperf is not running" fi fi</span></span></code> </pre> <br><p>  Como se puede ver en el c√≥digo, el script se puede iniciar y detener, as√≠ como verificar el estado (en ejecuci√≥n / no en ejecuci√≥n). </p><br><p>  Las secuencias de comandos para las pruebas ICMP y HTTP se construyen de la misma manera, comenzando hping3 y siege, respectivamente, con la cadena de par√°metros pasada a trav√©s del argumento. </p><br><p>  Ejemplos de comandos: </p><br><pre> <code class="plaintext hljs">ssh instance-amazon 'sudo dns.sh start -s TARGET_IP -d valid_dns_queries.txt -c 1 -n 100 &amp;&gt;&gt;dns.log &amp;' ssh instance-amazon 'sudo ping.sh start -i u1000 -d 1500 -c 100000 -1 TARGET_IP &amp;&gt;&gt;ping.log &amp;' ssh instance-amazon 'sudo http.sh start -b -c 100 -f test_urls.txt &amp;&gt;&gt; http.log &amp;'</code> </pre> <br><h3>  Supervisar guiones </h3><br><p>  Para evaluar el tr√°fico saliente y el estado de la infraestructura de prueba, necesitamos una herramienta de monitoreo.  Por razones de simplicidad y ahorro de recursos, utilizamos iptables.  Para hacer esto, escribiremos un script que cuente la cantidad de MB enviados y lo colocaremos en la imagen de AWS: </p><br><pre> <code class="plaintext hljs">#iptables.sh sudo iptables -N TRAFFIC_OUT sudo iptables -A TRAFFIC_OUT -p tcp sudo iptables -A TRAFFIC_OUT -p udp sudo iptables -A TRAFFIC_OUT -p icmp sudo iptables -A OUTPUT -j TRAFFIC_OUT sudo iptables-save</code> </pre> <br><p>  El script crea una nueva cadena TRAFFIC_OUT y le agrega filtros para los protocolos necesarios: tcp, udp, icmp. </p><br><p>  El reenv√≠o de paquetes a TRAFFIC_OUT se agrega a la cadena OUTPUT. </p><br><p>  El comando puede encontrar la cantidad de datos transferidos: </p><br><pre> <code class="plaintext hljs"># iptables -L TRAFFIC_OUT -v -n -x | tail -n 3 | awk '{print $2/1024/1024,"Mb\t\t\t",$3}' : 2.2 Mb tcp 4.4 Mb udp 3.2 Mb icmp</code> </pre> <br><p>  Instale el script como un servicio.  Para hacer esto, cree un archivo tracking.service y mu√©valo al directorio <code>/etc/systemd/system</code> de nuestra imagen: </p><br><pre> <code class="plaintext hljs"># /etc/systemd/system/monitoring.service [Unit] After=network.target [Service] ExecStart=/usr/local/bin/monitoring.sh [Install] WantedBy=default.target</code> </pre> <br><p>  Ahora puede agregar el servicio al inicio: </p><br><pre> <code class="plaintext hljs">systemctl enable monitoring.service systemctl start monitoring.service</code> </pre> <br><h2>  Gesti√≥n de instancias </h2><br><p>  Ahora tratemos con la administraci√≥n de instancias remota (lo m√°s automatizada posible). </p><br><p>  Para estos fines, puede usar el mecanismo de <a href="https://aws.amazon.com/ru/cli/">AWS CLI</a> : administraci√≥n de la consola. </p><br><p>  Cree una <a href="https://console.aws.amazon.com/iam/home%3Fnc2%3Dh_m_sc">clave secreta</a> (claves de acceso (ID de clave de acceso y clave de acceso secreta)) y configure la consola. </p><br><p>  Ahora tenemos acceso a todas las funciones de la cuenta. </p><br><p>  La peculiaridad de trabajar con AWS es que todas las acciones se realizan para una regi√≥n espec√≠fica y deben repetirse si hay varias regiones involucradas. </p><br><p>  Para crear una nueva instancia a partir de la imagen que creamos anteriormente (suponemos que hay una ID-ami p√∫blica que usamos en el script), haremos lo siguiente: </p><br><ul><li>  cree una clave SSH y agr√©guela a AWS: </li></ul><br><pre> <code class="bash hljs">yes n |ssh-keygen -q -t rsa -f <span class="hljs-variable"><span class="hljs-variable">$KEYNAME</span></span> -m pem -N <span class="hljs-string"><span class="hljs-string">""</span></span> &gt; /dev/null chmod 400 <span class="hljs-variable"><span class="hljs-variable">$KEYNAME</span></span> aws ec2 import-key-pair --region <span class="hljs-variable"><span class="hljs-variable">$REGION</span></span> --key-name <span class="hljs-variable"><span class="hljs-variable">$KEYNAME</span></span> --public-key-material file:///$(<span class="hljs-built_in"><span class="hljs-built_in">pwd</span></span>)/<span class="hljs-variable"><span class="hljs-variable">$KEYNAME</span></span>.pub</code> </pre> <br><ul><li>  cree un grupo de seguridad que permita el acceso a la m√°quina a trav√©s de SSH.  De lo contrario, se denegar√°n las conexiones SSH entrantes: </li></ul><br><pre> <code class="bash hljs">SECURITY=<span class="hljs-string"><span class="hljs-string">"ssh-group"</span></span> aws ec2 create-security-group --region <span class="hljs-variable"><span class="hljs-variable">$REGION</span></span> --group-name <span class="hljs-variable"><span class="hljs-variable">$SECURITY</span></span> --description <span class="hljs-string"><span class="hljs-string">"Just ssh. Nothing more"</span></span> IP_RANGE=<span class="hljs-string"><span class="hljs-string">"0.0.0.0/24"</span></span> aws ec2 authorize-security-group-ingress --region <span class="hljs-variable"><span class="hljs-variable">$REGION</span></span> --group-name <span class="hljs-variable"><span class="hljs-variable">$SECURITY</span></span> --protocol tcp --port 22 --cidr <span class="hljs-variable"><span class="hljs-variable">$IP_RANGE</span></span></code> </pre> <br><ul><li>  cree una instancia con la clave y el grupo de seguridad creados anteriormente y especifique la ID de la imagen.  El n√∫mero de instancias creadas a la vez puede ser arbitrario: </li></ul><br><pre> <code class="bash hljs">IMG=<span class="hljs-string"><span class="hljs-string">'ami-0d0eaed20348a3389'</span></span> NUM=1 aws ec2 run-instances --region <span class="hljs-variable"><span class="hljs-variable">$REGION</span></span> --image-id <span class="hljs-variable"><span class="hljs-variable">$IMG</span></span> --count <span class="hljs-variable"><span class="hljs-variable">$NUM</span></span> --instance-type t2.micro --key-name <span class="hljs-variable"><span class="hljs-variable">$KEYNAME</span></span> --security-groups default <span class="hljs-variable"><span class="hljs-variable">$SECURITY</span></span> &gt; instances.json</code> </pre> <br><ul><li>  espere hasta que la m√°quina se inicialice.  Esto lleva algo de tiempo: primero obtenemos una respuesta correcta (instancias.json), pero en ese momento la m√°quina se acaba de crear pero a√∫n no se ha iniciado (por ejemplo, a√∫n no se le ha asignado una direcci√≥n IP).  Es necesario esperar a que se complete el lanzamiento (por lo general, un minuto es suficiente para esto). </li></ul><br><p>  Entonces puede conectarse a trav√©s de SSH si conocemos la direcci√≥n IP.  Simplemente solicite una lista de m√°quinas que se est√°n ejecutando actualmente.  Entre sus par√°metros encontramos PublicDnsName o PublicIpAddress. </p><br><pre> <code class="bash hljs">aws ec2 describe-instances --region</code> </pre> <br><p>  A continuaci√≥n, ejecutamos los comandos SSH, indicando la clave SSH creada anteriormente: </p><br><pre> <code class="plaintext hljs">ssh -I $KEYNAME -oStrictHostKeyChecking=no ubuntu''+ins_dns echo''O''</code> </pre> <br><p>  Los comandos SSH le permiten controlar el ataque y obtener toda la informaci√≥n sobre el estado del ataque, ya que proporcionamos a las instancias todos los scripts y herramientas necesarios. </p><br><p>  Debe comprender que la mayor√≠a de las defensas contra los ataques de denegaci√≥n de servicio bloquean la direcci√≥n IP desde la que se reciben de manera an√≥mala muchas solicitudes.  Por lo tanto, las direcciones IP de las m√°quinas virtuales deben cambiar constantemente para mantener el poder de ataque. </p><br><p>  AWS asigna una nueva direcci√≥n IP cada vez que se inicia la m√°quina.  Por lo tanto, para cambiar la IP, debe apagar y volver a encender la m√°quina (¬°no es necesario quitarla!). </p><br><p>  La diferencia entre apagar y eliminar es que enviamos diferentes se√±ales.  Detener - para apagar, finalizar - para apagar y eliminar de inmediato. </p><br><p>  Para monitorear el tr√°fico entrante de una instancia, utilizamos el siguiente comando con el ID de la instancia: cuando comienza la medici√≥n del tr√°fico, cuando finaliza, durante qu√© per√≠odo se suman los valores: </p><br><pre> <code class="bash hljs">aws cloudwatch get-metric-statistics --region REGION --namespace AWS/EC2 \ --statistics Sum --metric-name NetworkIn --start-time <span class="hljs-variable"><span class="hljs-variable">$STARTTIME</span></span> --end-time <span class="hljs-variable"><span class="hljs-variable">$FINISHTIME</span></span> --period <span class="hljs-variable"><span class="hljs-variable">$PERIOD</span></span> --dimensions Name=InstanceId,Value=<span class="hljs-variable"><span class="hljs-variable">$INCTANCEID</span></span></code> </pre> <br><h1>  Servicio de Monitoreo de Disponibilidad </h1><br><p>  Adem√°s, para realizar un ataque, deber√° observar si el servicio que estamos probando est√° activo. </p><br><p>  Creamos y ejecutamos el script "ping" m√°s simple que monitorea la disponibilidad de los puertos de destino (53 y 80 en nuestro caso). </p><br><p>  Ejemplo de c√≥digo Python que automatiza la verificaci√≥n de disponibilidad: </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">http</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(url)</span></span></span><span class="hljs-function">:</span></span> cmd = [<span class="hljs-string"><span class="hljs-string">'curl'</span></span>, <span class="hljs-string"><span class="hljs-string">'-w'</span></span>, <span class="hljs-string"><span class="hljs-string">'"%{time_total}"'</span></span>, <span class="hljs-string"><span class="hljs-string">'-o'</span></span>, <span class="hljs-string"><span class="hljs-string">'/dev/null'</span></span>, <span class="hljs-string"><span class="hljs-string">'-s'</span></span>, url] result = check_output(cmd).decode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) result = float(json.loads(result)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result * <span class="hljs-number"><span class="hljs-number">1000000</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dns</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ip, domain)</span></span></span><span class="hljs-function">:</span></span> cmd = [<span class="hljs-string"><span class="hljs-string">'dig'</span></span>, <span class="hljs-string"><span class="hljs-string">'any'</span></span>, <span class="hljs-string"><span class="hljs-string">'@'</span></span>+ip, domain ] result = check_output(cmd).decode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) result = int(result.split(<span class="hljs-string"><span class="hljs-string">'Query time:'</span></span>)[<span class="hljs-number"><span class="hljs-number">1</span></span>].split(<span class="hljs-string"><span class="hljs-string">'msec'</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result</code> </pre> <br><p>  La informaci√≥n recibida se almacena en un archivo de registro, sobre la base de la cual, en funci√≥n de los resultados del ataque, ser√° posible construir un gr√°fico de disponibilidad de recursos. </p><br><p>  Durante las pruebas, es necesario verificar constantemente el registro de "ping" para no eliminar el recurso por completo e irrevocablemente.  Tan pronto como aparezca una degradaci√≥n significativa y la respuesta a la solicitud tarde demasiado, el ataque debe detenerse. </p><br><p>  Si la desaceleraci√≥n es insignificante y el poder de ataque ha alcanzado el m√°ximo establecido, entonces tiene sentido esperar uno o dos minutos, y si el servicio contin√∫a funcionando sin interrupciones, entonces la verificaci√≥n se considera exitosa. </p><br><h1>  Problema financiero </h1><br><p>  Vale la pena discutir otro tema relacionado con la organizaci√≥n de las pruebas: el costo de todo este evento. </p><br><p>  Amazon proporciona informaci√≥n detallada sobre precios, pero debe comprender que tiene que pagar por casi todo.  Sin embargo, muchos c√°lculos pueden ser descuidados.  En primer lugar, vale la pena calcular el costo del tr√°fico (depende de la regi√≥n y de cu√°nto se transmitir√° la cantidad total de informaci√≥n) y el costo de las instancias de alquiler (pago por minuto).  Estos art√≠culos representan aproximadamente el 99% del costo de todo el ataque. </p><br><p>  Por lo tanto, el costo del ataque se calcula en cada caso por separado, dependiendo de la potencia m√°xima de ataque [escala de hostilidades] y el n√∫mero de lanzamientos planeados. </p><br><p>  Desde el punto de vista de la simplificaci√≥n de los c√°lculos, es mejor usar una cuenta de Amazon, que se registr√≥ hace no m√°s de un a√±o.  Entonces, parte de las operaciones ser√°n gratuitas.  Lea m√°s sobre los l√≠mites de uso gratuito <a href="https://aws.amazon.com/ru/free/%3Fall-free-tier.sort-by%3Ditem.additionalFields.SortRank%26all-free-tier.sort-order%3Dasc">aqu√≠</a> . </p><br><p>  Para ilustrar el c√°lculo del costo de realizar pruebas de carga, digamos que queremos verificar la estabilidad del servidor DNS a una carga de 10 Gb / s. </p><br><p>  Sabemos que las herramientas utilizadas y las capacidades de la instancia t3.small lanzada en Mumbai le permiten emitir 500 Mb / s desde una instancia en ejecuci√≥n.  El precio por alquilar una entidad es de $ 0.0224 por hora, por tr√°fico: $ 0.01093 por 1 GB.  Es decir, el pico del ataque significa la operaci√≥n simult√°nea de 20 entidades. </p><br><p>  Incrementaremos el poder de ataque gradualmente, para esto primero lanzamos una entidad, luego agregamos otra cada 60 s. </p><br><p>  La f√≥rmula para calcular el costo toma la forma: </p><br><pre> <code class="plaintext hljs">60  * (   ) + 60  * 0,5 /c * (  ) =       60 . 1 * (    ) + 2 * (    ) + ... + 20 * (    ) =   </code> </pre> <br><p>  Resulta que el costo de un ataque con una capacidad de 10 Gb / s para un servidor DNS es de aproximadamente $ 70.  Tenga en cuenta que esta es una estimaci√≥n aproximada, ya que el volumen de tr√°fico no se puede predecir con precisi√≥n.      <a href="https://aws.amazon.com/ru/ec2/pricing/on-demand/"></a> .  ,   ‚Äì    ,     . </p><br><p>       .          . </p><cut></cut></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/481756/">https://habr.com/ru/post/481756/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../481746/index.html">Configuraci√≥n del entorno en la CLI. Terminal WSL / Windows</a></li>
<li><a href="../481748/index.html">Paquete de beneficios en Armenia: desde seguro y bonificaci√≥n de referencia hasta masajes y pr√©stamos</a></li>
<li><a href="../481750/index.html">Tarea n√∫mero 3. Conversi√≥n de datos y carga a servicios de terceros</a></li>
<li><a href="../481752/index.html">Resultados de la encuesta de idiomas</a></li>
<li><a href="../481754/index.html">Yo bot y mi punz√≥n</a></li>
<li><a href="../481758/index.html">Estad√≠sticas de construcci√≥n, suministro y visitas a la ISS</a></li>
<li><a href="../481762/index.html">Ecuaciones para la cocina bajo el arbol de navidad</a></li>
<li><a href="../481764/index.html">¬øPor qu√© la energ√≠a verde tiene un futuro dif√≠cil?</a></li>
<li><a href="../481768/index.html">Nos ocupamos de WebKit en 1C, por ejemplo, la integraci√≥n de TinyMCE en un formulario administrado en UT 11.4</a></li>
<li><a href="../481770/index.html">El pionero de la programaci√≥n inform√°tica Tony Brucker fallece a los 94 a√±os</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>