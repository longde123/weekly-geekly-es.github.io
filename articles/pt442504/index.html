<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üì© üóëÔ∏è üßú Proxy PHP Xdebug: quando os recursos padr√£o do Xdebug n√£o s√£o suficientes üí™üèª üìØ üçª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Para depurar programas PHP, use frequentemente o Xdebug . No entanto, os recursos padr√£o do IDE e do Xdebug nem sempre s√£o suficientes. Alguns dos pro...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Proxy PHP Xdebug: quando os recursos padr√£o do Xdebug n√£o s√£o suficientes</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/badoo/blog/442504/"><p><img src="https://habrastorage.org/webt/qr/30/pd/qr30pdoglljz7da1c8uooyutxu8.jpeg" alt="Proxy PHP Xdebug: quando os recursos padr√£o do Xdebug n√£o s√£o suficientes"></p><br><p>  Para depurar programas PHP, use frequentemente o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Xdebug</a> .  No entanto, os recursos padr√£o do IDE e do Xdebug nem sempre s√£o suficientes.  Alguns dos problemas podem ser resolvidos usando o proxy Xdebug - pydbgpproxy, mas ainda n√£o todos.  Portanto, implementei o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">proxy PHP Xdebug com</a> base na estrutura ass√≠ncrona amphp. </p><br><p>  Abaixo, mostrarei o que h√° de errado com o pydbgpproxy, o que est√° faltando e por que n√£o o modifiquei.  Tamb√©m explicarei como o proxy PHP Xdebug funciona e mostrarei como estend√™-lo usando um exemplo. <a name="habracut"></a></p><br><h2 id="pydbgpproxy-vs-php-xdebug-proxy">  Pydbgpproxy vs PHP Xdebug proxy </h2><br><p>  O proxy Xdebug √© um servi√ßo intermedi√°rio entre o IDE e o Xdebug (solicita√ß√µes de proxies do Xdebug para o IDE e vice-versa).  Na maioria das vezes, √© usado para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">depura√ß√£o multiusu√°rio</a> .  √â quando voc√™ tem um servidor web e v√°rios desenvolvedores. </p><br><p>  Como proxy, o pydbgpproxy geralmente √© usado.  Mas ele tem alguns problemas: </p><br><ul><li>  nenhuma p√°gina oficial; </li><li>  dif√≠cil encontrar onde fazer o download;  acontece que isso pode ser feito <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> - de repente, o cliente de depura√ß√£o remota Python; </li><li>  N√£o encontrei o reposit√≥rio oficial; </li><li>  como conseq√º√™ncia do par√°grafo anterior, n√£o est√° claro para onde levar a solicita√ß√£o de recebimento; </li><li>  proxy, como o nome indica, √© escrito em Python, que nem todos os desenvolvedores de PHP conhecem, o que significa que expandir √© um problema; </li><li>  continua√ß√£o do par√°grafo anterior: se houver algum c√≥digo no PHP, e ele precisar ser usado em proxy, ele dever√° ser portado para Python, e a duplica√ß√£o de c√≥digo nem sempre ser√° muito boa. </li></ul><br><p>  A busca por um proxy Xdebug escrito em PHP no GitHub e na Internet n√£o obteve resultados.  Ent√£o eu escrevi o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">proxy PHP Xdebug</a> .  Sob o cap√¥, usei a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">estrutura</a> ass√≠ncrona de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">amphp</a> . </p><br><p>  As principais vantagens do proxy PHP Xdebug sobre o pydbgpproxy: </p><br><ul><li>  O proxy PHP Xdebug √© escrito em uma linguagem familiar aos desenvolvedores de PHP, o que significa: <br><ul><li>  √© mais f√°cil resolver problemas nele; </li><li>  √© mais f√°cil expandir; </li></ul></li><li>  O proxy PHP Xdebug possui um reposit√≥rio p√∫blico, o que significa: <br><ul><li>  Voc√™ pode bifurcar e finalizar de acordo com suas necessidades; </li><li>  Voc√™ pode enviar uma solicita√ß√£o de recebimento com um recurso ausente ou uma solu√ß√£o para um problema. </li></ul></li></ul><br><h2 id="kak-rabotat-s-php-xdebug-proxy">  Como trabalhar com o proxy PHP Xdebug </h2><br><h3 id="ustanovka">  Instala√ß√£o </h3><br><p>  O proxy PHP Xdebug pode ser instalado como uma depend√™ncia do desenvolvedor via <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">compositor</a> : </p><br><pre><code class="bash hljs">composer.phar require mougrim/php-xdebug-proxy --dev</code> </pre> <br><p>  Mas se voc√™ n√£o deseja arrastar depend√™ncias extras para o seu projeto, o proxy PHP Xdebug pode ser instalado como um projeto atrav√©s do mesmo compositor: </p><br><pre> <code class="bash hljs">composer.phar create-project mougrim/php-xdebug-proxy <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> php-xdebug-proxy</code> </pre> <br><p>  O proxy Xdebug do PHP √© extens√≠vel, mas o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ext-dom</a> √© necess√°rio por padr√£o (a extens√£o √© ativada por padr√£o no PHP) para analisar XML e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">amphp / log</a> para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">log</a> ass√≠ncrono: </p><br><pre> <code class="bash hljs">composer.phar require amphp/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span> <span class="hljs-string"><span class="hljs-string">'^1.0.0'</span></span></code> </pre> <br><h3 id="zapusk">  Lan√ßamento </h3><br><p><img src="https://habrastorage.org/webt/jb/n4/dc/jbn4dcyqwpirx7koyqjzwxfwozc.jpeg" alt="Proxy PHP Xdebug"></p><br><p>  O proxy inicia da seguinte maneira: </p><br><pre> <code class="bash hljs">bin/xdebug-proxy</code> </pre> <br><p>  O proxy come√ßar√° com as configura√ß√µes padr√£o: </p><br><pre> <code class="plaintext hljs">Using config path /path/to/php-xdebug-proxy/config [2019-02-14 10:46:24] xdebug-proxy.NOTICE: Use default ide: 127.0.0.1:9000 array ( ) array ( ) [2019-02-14 10:46:24] xdebug-proxy.NOTICE: Use predefined ides array ( 'predefinedIdeList' =&gt; array ( 'idekey' =&gt; '127.0.0.1:9000', ), ) array ( ) [2019-02-14 10:46:24] xdebug-proxy.NOTICE: [Proxy][IdeRegistration] Listening for new connections on '127.0.0.1:9001'... array ( ) array ( ) [2019-02-14 10:46:24] xdebug-proxy.NOTICE: [Proxy][Xdebug] Listening for new connections on '127.0.0.1:9002'... array ( ) array ( )</code> </pre> <br><p>  No log, voc√™ pode ver que o proxy padr√£o: </p><br><ul><li>  escuta <code>127.0.0.1:9001</code> para conex√µes de login do IDE; </li><li>  ouve <code>127.0.0.1:9002</code> para conex√µes Xdebug; </li><li>  usa <code>127.0.0.1:9000</code> como o IDE padr√£o e o IDE predefinido com a chave idekey. </li></ul><br><h3 id="konfiguraciya">  Configura√ß√£o </h3><br><p>  Se voc√™ deseja configurar portas de escuta, etc., pode especificar o caminho para a pasta de configura√ß√µes.  Basta copiar a pasta de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">configura√ß√£o</a> : </p><br><pre> <code class="bash hljs">cp -r /path/to/php-xdebug-proxy/config /your/custom/path</code> </pre> <br><p>  Existem tr√™s arquivos na pasta de configura√ß√µes: </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>config.php</code></a> : <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ <span class="hljs-string"><span class="hljs-string">'xdebugServer'</span></span> =&gt; [ <span class="hljs-comment"><span class="hljs-comment">// host:port    Xdebug 'listen' =&gt; '127.0.0.1:9002', ], 'ideServer' =&gt; [ //  proxy    IDE,     IDE  , //    IDE  ,     . // IDE   ,  proxy    . 'defaultIde' =&gt; '127.0.0.1:9000', //  IDE    'idekey' =&gt; 'host:port', //   IDE  ,     . //  IDE ,   proxy  , //           proxy. 'predefinedIdeList' =&gt; [ 'idekey' =&gt; '127.0.0.1:9000', ], ], 'ideRegistrationServer' =&gt; [ // host:port     IDE, //     IDE,     . 'listen' =&gt; '127.0.0.1:9001', ], ];</span></span></code> </pre> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>logger.php</code></a> : voc√™ pode configurar o logger;  o arquivo deve retornar um objeto que √© uma inst√¢ncia de <code>\Psr\Log\LoggerInterface</code> , o padr√£o √© <code>\Monolog\Logger</code> com <code>\Amp\Log\StreamHandler</code> (para grava√ß√£o sem bloqueio), exibe logs para stdout; </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>factory.php</code></a> : voc√™ pode configurar as classes que s√£o usadas no proxy;  o arquivo deve retornar um objeto que √© uma inst√¢ncia de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>Factory\Factory</code></a> , o padr√£o √© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>Factory\DefaultFactory</code></a> . </li></ul><br><p>  Ap√≥s copiar os arquivos, voc√™ pode editar e executar o proxy: </p><br><pre> <code class="bash hljs">bin/xdebug-proxy --configs=/your/custom/path/config</code> </pre> <br><h3 id="otladka">  Depura√ß√£o </h3><br><p>  Muitos artigos foram escritos sobre como depurar c√≥digo usando o Xdebug.  Vou anotar os pontos principais. </p><br><p>  No php.ini, as seguintes configura√ß√µes devem estar na se√ß√£o <code>[xdebug]</code> (corrija-as se forem diferentes das padr√£o): </p><br><ul><li>  idekey = idekey </li><li>  remote_host = 127.0.0.1 </li><li>  remote_port = 9002 </li><li>  remote_enable = Ativado </li><li>  remote_autostart = Ativado </li><li>  remote_connect_back = Desativado </li></ul><br><p>  Ent√£o voc√™ pode executar o c√≥digo PHP depurado: </p><br><pre> <code class="bash hljs">php /path/to/your/script.php</code> </pre> <br><p>  Se voc√™ fez tudo certo, a depura√ß√£o ser√° iniciada a partir do primeiro ponto de interrup√ß√£o no IDE.  A depura√ß√£o no modo php-fpm por v√°rios desenvolvedores est√° al√©m do escopo deste artigo, mas √© descrita, por exemplo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . </p><br><h2 id="rasshirenie-funkciy-proxy">  Recursos de proxy de extens√£o </h2><br><p>  Tudo o que examinamos acima, pydbgpproxy, tamb√©m √© capaz em um grau ou outro. </p><br><p>  Agora vamos falar sobre o mais interessante no proxy PHP Xdebug.  Os proxies podem ser expandidos usando sua pr√≥pria f√°brica (criada na configura√ß√£o <code>factory.php</code> , veja acima).  A f√°brica deve implementar a interface <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>Factory\Factory</code></a> . </p><br><p>  Os mais poderosos s√£o os chamados preparadores de solicita√ß√µes.  Eles podem modificar solicita√ß√µes do Xdebug para o IDE e vice-versa.  Para adicionar um <code>Factory\DefaultFactory::createRequestPreparers()</code> consultas, voc√™ deve substituir o m√©todo <code>Factory\DefaultFactory::createRequestPreparers()</code> .  O m√©todo retorna uma matriz de objetos que implementam a interface <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>RequestPreparer\RequestPreparer</code></a> .  Ao fazer o proxy de uma solicita√ß√£o do Xdebug para o IDE, elas s√£o executadas na ordem direta; ao fazer o proxy de uma solicita√ß√£o do IDE para o Xdebug, ela √© revertida. </p><br><p>  Os manipuladores de consulta podem ser usados, por exemplo, para alterar caminhos para arquivos (em pontos de interrup√ß√£o e arquivos execut√°veis). </p><br><h3 id="debag-perepisannyh-faylov">  Depurar arquivos substitu√≠dos </h3><br><p>  Para dar um exemplo de preparador, farei uma pequena digress√£o.  Nos testes de unidade, usamos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">soft-zomba</a> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">GitHub</a> ).  Soft-zomba permite que voc√™ substitua fun√ß√µes, m√©todos est√°ticos, constantes, etc. em testes, √© uma alternativa para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">runkit</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">uopz</a> .  Isso funciona reescrevendo arquivos PHP em tempo real.  Da mesma forma, o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">AspectMock</a> ainda funciona. </p><br><p>  Mas os recursos padr√£o do Xdebug e do IDE permitem depurar reescritos (com um caminho diferente), em vez dos arquivos originais. </p><br><p>  Vamos dar uma olhada no problema de depura√ß√£o usando zombarias nos testes.  Primeiro, considere o caso em que o c√≥digo PHP √© executado localmente. </p><br><p>  As primeiras dificuldades aparecem no est√°gio de defini√ß√£o de pontos de interrup√ß√£o (pontos de interrup√ß√£o).  No IDE, eles s√£o instalados nos arquivos originais, n√£o nos reescritos.  Para colocar um ponto de interrup√ß√£o no IDE, voc√™ precisa encontrar o arquivo reescrito real.  O problema √© agravado pelo fato de que cada vez que o arquivo original √© alterado, um novo arquivo reescrito √© criado, ou seja, para cada conte√∫do de arquivo exclusivo, haver√° um arquivo reescrito exclusivo. </p><br><p>  Esse problema pode ser resolvido chamando a fun√ß√£o <code>xdebug_break()</code> , que √© semelhante √† configura√ß√£o de um ponto de interrup√ß√£o.  Nesse caso, n√£o h√° necessidade de procurar um arquivo reescrito. </p><br><p>  Agora considere a situa√ß√£o mais complicada: o aplicativo √© executado em uma m√°quina remota. </p><br><p>  Nesse caso, voc√™ pode montar a pasta com os arquivos reescritos, por exemplo, atrav√©s do SSHFS.  Se os caminhos local e remoto para a pasta forem diferentes, voc√™ ainda precisar√° registrar mapeamentos no IDE. </p><br><p>  De uma forma ou de outra, esse m√©todo √© um pouco diferente do usual e permite depurar apenas os arquivos copiados, mas n√£o os originais.  Mas ainda quero editar e depurar os mesmos arquivos originais. </p><br><p>  O AspectMock solucionou o problema <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ativando o modo de depura√ß√£o</a> sem a capacidade de desativ√°-lo: </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array $options = [])</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($options[<span class="hljs-string"><span class="hljs-string">'excludePaths'</span></span>])) { $options[<span class="hljs-string"><span class="hljs-string">'excludePaths'</span></span>] = []; } $options[<span class="hljs-string"><span class="hljs-string">'debug'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; $options[<span class="hljs-string"><span class="hljs-string">'excludePaths'</span></span>][] = <span class="hljs-keyword"><span class="hljs-keyword">__DIR__</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>::init($options); }</code> </pre> <br><p>  Em um exemplo de teste simples, o modo de depura√ß√£o √© mais lento em 20%, mas n√£o tenho testes suficientes do AspectMock para fornecer uma estimativa mais precisa de qu√£o lento √©.  Se voc√™ tiver muitos testes no AspectMock, ficarei feliz em compartilhar a compara√ß√£o nos coment√°rios. </p><br><h3 id="ispolzovanie-xdebug-s-soft-mocks">  Usando o Xdebug com soft-zomba </h3><br><p><img src="https://habrastorage.org/webt/eu/3d/ui/eu3duipif0jihrhzwlquhfpywuc.jpeg" alt="Xdebug + zombarias"></p><br><p>  Agora que o problema est√° claro, considere como resolv√™-lo usando o proxy Xdebug do PHP.  A parte principal est√° na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>RequestPreparer\SoftMocksRequestPreparer</code></a> . </p><br><p>  No construtor da classe, defina o caminho para o script de inicializa√ß√£o de soft-mocks e execute-o (pressup√µe-se que os soft-mocks estejam conectados como uma depend√™ncia, mas qualquer caminho pode ser passado para o construtor): </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(LoggerInterface $logger, string $initScript = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">''</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;logger = $logger; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$initScript) { $possibleInitScriptPaths = [ <span class="hljs-comment"><span class="hljs-comment">// proxy   , soft-mocks ‚Äî    __DIR__.'/../../vendor/badoo/soft-mocks/src/init_with_composer.php', // proxy  soft-mocks    __DIR__.'/../../../../badoo/soft-mocks/src/init_with_composer.php', ]; foreach ($possibleInitScriptPaths as $possiblInitScriptPath) { if (file_exists($possiblInitScriptPath)) { $initScript = $possiblInitScriptPath; break; } } } if (!$initScript) { throw new Error("Can't find soft-mocks init script"); } //  soft-mocks (       ..) require $initScript; }</span></span></code> </pre> <br><p><img src="https://habrastorage.org/webt/9p/8t/u7/9p8tu7eatpdhaewvfxvv2ossunu.jpeg" alt="Xdebug + soft-zomba: do Xdebug para o IDE"></p><br><p>  Para preparar uma solicita√ß√£o do Xdebug para o IDE, √© necess√°rio substituir o caminho do arquivo reescrito pelo arquivo original: </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prepareRequestToIde</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(XmlDocument $xmlRequest, string $rawRequest)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span></span>{ $context = [ <span class="hljs-string"><span class="hljs-string">'request'</span></span> =&gt; $rawRequest, ]; $root = $xmlRequest-&gt;getRoot(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$root) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($root-&gt;getChildren() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $child) { <span class="hljs-comment"><span class="hljs-comment">//         : // - 'stack': https://xdebug.org/docs-dbgp.php#stack-get // - 'xde</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">bug:</span></span></span><span class="hljs-comment">message': https://xdebug.org/docs-dbgp.php#error-notification if (!in_array($child-&gt;getName(), ['stack', 'xde</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">bug:</span></span></span><span class="hljs-comment">message'], true)) { continue; } $attributes = $child-&gt;getAttributes(); if (isset($attributes['filename'])) { //         ,      $filename = $this-&gt;getOriginalFilePath($attributes['filename'], $context); if ($attributes['filename'] !== $filename) { $this-&gt;logger-&gt;info("Change '{$attributes['filename']}' to '{$filename}'", $context); $child-&gt;addAttribute('filename', $filename); } } } }</span></span></code> </pre> <br><p><img src="https://habrastorage.org/webt/6h/qw/er/6hqwerwharffc9a_ylzobqxut9o.jpeg" alt="Xdebug + soft-zomba: do IDE ao Xdebug"></p><br><p>  Para preparar uma solicita√ß√£o do IDE para o Xdebug, voc√™ precisa substituir o caminho para o arquivo original pelo caminho para o reescrito: </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prepareRequestToXdebug</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(string $request, CommandToXdebugParser $commandToXdebugParser)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//       [$command, $arguments] = $commandToXdebugParser-&gt;parseCommand($request); $context = [ 'request' =&gt; $request, 'arguments' =&gt; $arguments, ]; if ($command === 'breakpoint_set') { //    -f,          // . https://xdebug.org/docs-dbgp.php#id3 if (isset($arguments['-f'])) { $file = $this-&gt;getRewrittenFilePath($arguments['-f'], $context); if ($file) { $this-&gt;logger-&gt;info("Change '{$arguments['-f']}' to '{$file}'", $context); $arguments['-f'] = $file; //    $request = $commandToXdebugParser-&gt;buildCommand($command, $arguments); } } else { $this-&gt;logger-&gt;error("Command {$command} is without argument '-f'", $context); } } return $request; }</span></span></code> </pre> <br><p>  Para que o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>Factory\DefaultFactory</code></a> consultas funcione, voc√™ precisa criar sua classe de f√°brica e herd√°-la de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>Factory\DefaultFactory</code></a> ou implementar a interface <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>Factory\Factory</code></a> .  Para soft-zombarias, a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>Factory\SoftMocksFactory</code></a> √© semelhante a: </p><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SoftMocksFactory</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DefaultFactory</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createConfig</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array $config)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Config</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//       return new SoftMocksConfig($config); } public function createRequestPreparers(LoggerInterface $logger, Config $config): array { $requestPreparers = parent::createRequestPreparers($logger, $config); return array_merge($requestPreparers, [$this-&gt;createSoftMocksRequestPreparer($logger, $config)]); } public function createSoftMocksRequestPreparer(LoggerInterface $logger, SoftMocksConfig $config): SoftMocksRequestPreparer { //     init-   return new SoftMocksRequestPreparer($logger, $config-&gt;getSoftMocks()-&gt;getInitScript()); } }</span></span></code> </pre> <br><p>  Aqui voc√™ precisa de sua pr√≥pria classe de configura√ß√£o para poder especificar o caminho do script init de soft-mocks.  O que √©, voc√™ pode ver em <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Config \ SoftMocksConfig</a> . </p><br><p>  Restou apenas um pouco: criar uma nova f√°brica e indicar o caminho para o script init de soft-mock.  Como isso √© feito pode ser visualizado no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>softMocksConfig</code></a> . </p><br><h3 id="neblokiruyuschiy-api">  API sem bloqueio </h3><br><p>  Como escrevi acima, o proxy PHP Xdebug usa amphp por baixo do cap√¥, o que significa que uma API sem bloqueio deve ser usada para trabalhar com <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">E / S.</a>  O Apmphp j√° possui muitos componentes que implementam essa API sem bloqueio.  Se voc√™ deseja estender o proxy PHP Xdebug e us√°-lo no modo multiusu√°rio, certifique-se de usar APIs sem bloqueio. </p><br><h2 id="vyvody">  Conclus√µes </h2><br><p>  O proxy PHP Xdebug ainda √© um projeto bastante jovem, mas no Badoo ele j√° √© usado ativamente para depurar testes usando soft-zomba. </p><br><p>  Proxy do PHP Xdebug: </p><br><ul><li>  substitui pydbgpproxy na depura√ß√£o multiusu√°rio; </li><li>  pode trabalhar com zombarias; </li><li>  pode ser expandido: <br><ul><li>  Voc√™ pode substituir os caminhos dos arquivos provenientes do IDE e do Xdebug; </li><li>  as estat√≠sticas podem ser coletadas: no modo de depura√ß√£o, pelo menos o contexto execut√°vel est√° dispon√≠vel durante a depura√ß√£o (valores de vari√°veis ‚Äã‚Äãe linha de c√≥digo execut√°vel). </li></ul></li></ul><br><p>  Se voc√™ usar o proxy Xdebug para outra coisa que n√£o seja a depura√ß√£o multiusu√°rio, compartilhe seu caso e o proxy Xdebug que voc√™ usa nos coment√°rios. </p><br><p>  Se voc√™ usa o pydbgpproxy ou algum outro proxy Xdebug, tente o proxy PHP Xdebug, conte sobre seus problemas, compartilhe solicita√ß√µes pull.  Vamos desenvolver o projeto juntos!  :) </p><br><p>  PS Obrigado ao meu colega Yevgeny <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Makhrov</a> aka <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">eZH</a> pela id√©ia de proxy <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">smdbgpproxy</a> ! </p><br><h2 id="eschyo-raz-ssylki">  Links novamente </h2><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Proxy PHP Xdebug</a> - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Proxy</a> Xdebug, que √© discutido no artigo; </li><li>  O pydbgpproxy pode ser baixado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> - de repente, o Cliente de Depura√ß√£o Remota do Python; </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">amphp</a> - estrutura PHP ass√≠ncrona e sem bloqueio; </li><li>  ferramentas para mock-s: <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">zombarias</a> ; </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">AspectMock</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">uopz</a> ; </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">runkit</a> . </li></ul></li></ul><br><p>  Obrigado pela aten√ß√£o! </p><br><p>  Terei o maior prazer em coment√°rios e sugest√µes. </p><br><p>  Rinat Akhmadeev, Sr.  Desenvolvedor PHP </p><br><p>  <strong>UPD</strong> : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tradu√ß√£o</a> publicada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">do</a> artigo para o ingl√™s. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt442504/">https://habr.com/ru/post/pt442504/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt442494/index.html">Componente Figma e organiza√ß√£o de inst√¢ncias usando o Userpic como exemplo</a></li>
<li><a href="../pt442496/index.html">Porco corporativo</a></li>
<li><a href="../pt442498/index.html">Os 10 principais relat√≥rios da confer√™ncia C ++ Russia 2018: v√≠deos completos, slides e coment√°rios</a></li>
<li><a href="../pt442500/index.html">Analisador est√°tico de Detekt para Kotlin</a></li>
<li><a href="../pt442502/index.html">Transformamos o local de trabalho em um reclin√°vel por US $ 200</a></li>
<li><a href="../pt442506/index.html">A R√∫ssia √© punida pelo com√©rcio ilegal de dados pessoais?</a></li>
<li><a href="../pt442508/index.html">Como o udalenka acelera a inova√ß√£o no GitLab</a></li>
<li><a href="../pt442512/index.html">Customiza√ß√£o do Django ORM no exemplo do ZomboDB</a></li>
<li><a href="../pt442514/index.html">Sistemas distribu√≠dos. Padr√µes de design. Resenha</a></li>
<li><a href="../pt442516/index.html">Guia do Pandas para an√°lise de big data</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>