<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíáüèª üéöÔ∏è üëÅ‚Äçüó® Serveur natif Commento avec Docker Compose üåÖ üë©‚Äçüëß‚Äçüëß ‚ö™Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Remarque: il s'agit d'une traduction de mon article (en anglais), d√©crivant la mise en ≈ìuvre du serveur de commentaires utilis√© sur le m√™me site o√π se...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Serveur natif Commento avec Docker Compose</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/464105/"><p>  <em>Remarque: il s'agit d'une traduction de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">mon article</a> (en anglais), d√©crivant la mise en ≈ìuvre du serveur de commentaires utilis√© sur le m√™me site o√π se trouve l'original.</em> </p><br><blockquote>  Version TL; DR: J'ai d√©velopp√© la configuration du serveur Commento, qui se d√©ploie facilement et simplement en mode semi-automatique.  Copiez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ce r√©f√©rentiel</a> √† partir de GitHub et suivez les instructions du <a href="">fichier README</a> . </blockquote><p>  Il y a quelque temps, je voulais irr√©sistiblement changer Disqus - qui est peut-√™tre le syst√®me le plus courant pour ajouter des commentaires aux pages - en un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Commento</a> gratuit et ouvert. </p><br>
<h2 id="pochemu-imenno-commento">  Pourquoi Commento? </h2><br><p>  Le probl√®me avec Disqus, comme beaucoup d'autres produits "gratuits", c'est que le produit dans ce cas est l'utilisateur - c'est-√†-dire vous.  De plus, Disqus ¬´enrichit¬ª chaque page o√π il est utilis√© avec des m√©gaoctets de scripts et plus d'une <em>centaine de</em> requ√™tes HTTP suppl√©mentaires. </p><br><p>  De plus, sa version gratuite affiche des publicit√©s √† partir desquelles vous pouvez payer "seulement" pour 9 $ par mois (plan Plus).  Cela suffit √† lui seul pour vouloir trouver quelque chose de mieux. </p><br><p>  √Ä un moment donn√©, je suis tomb√© sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ce post</a> et j'ai d√©couvert l'existence d'un serveur de commentaires gratuit appel√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Commento</a> .  Par une heureuse co√Øncidence, Commento est r√©cemment devenu compl√®tement ouvert - avant qu'il ne soit disponible en deux versions, <em>Communaut√©</em> gratuite et <em>Entreprise</em> commerciale.  Merci √† son d√©veloppeur Adhityaa Chandrasekar. </p><a name="habracut"></a><br><p>  Commento est des <em>ordres de grandeur</em> plus efficaces que Disqus, la taille typique de la charge suppl√©mentaire est d'environ <strong>11 Ko</strong> , plus les commentaires eux-m√™mes, bien s√ªr.  Environ la m√™me situation avec les requ√™tes HTTP requises. </p><br><p>  Un autre avantage du serveur Commento est qu'il est tr√®s rapide, car il est √©crit en Go. </p><br><p>  Eh bien, cerise sur le g√¢teau, il a une importation de commentaires de Disqus, de quoi d'autre pourrait-il r√™ver? </p><br><h2 id="varianty-ispolzovaniya-commento">  Cas d'utilisation de Commento </h2><br><p>  Pour les utilisateurs non avanc√©s (techniquement), Commento dispose d'un service cloud pr√™t √† l'emploi sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">commento.io</a> .  L'auteur vous propose de choisir vous-m√™me le tarif mensuel, mais il ne peut √™tre inf√©rieur √† 3 $ "pour des raisons techniques". </p><br><p>  M. Chandrasekar offre √©galement g√©n√©reusement un compte gratuit sur Commento.io en √©change de ¬´correctifs non triviaux¬ª pour le produit. </p><br><p>  Eh bien, j'ai choisi la troisi√®me option: augmenter moi-m√™me le serveur Commento.  Dans ce cas, vous ne d√©pendez de personne (√† part l'h√©bergeur, bien s√ªr), et j'aime l'ind√©pendance. </p><br><h2 id="trudnosti">  Des difficult√©s </h2><br><p>  Je suis un grand fan des conteneurs Docker et j'utilise aussi souvent <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Docker Compose</a> , un outil pour g√©rer des groupes de plusieurs conteneurs associ√©s.  Commento a une image Docker pr√™te √† l'emploi dans le registre des conteneurs GitLab. </p><br><p>  Par cons√©quent, la d√©cision d'utiliser des conteneurs a m√ªri par elle-m√™me - mais d'abord quelques choses ont d√ª √™tre d√©cid√©es. </p><br><h3 id="trudnost-1-postgresql">  Difficult√© n ¬∞ 1: PostgreSQL </h3><br><p>  Commento n√©cessite une version assez r√©cente du serveur PostgreSQL, malheureusement aucun autre serveur SQL n'est pris en charge. </p><br><p>  Eh bien, nous ex√©cutons toujours tout dans des conteneurs, c'est donc assez simple. </p><br><h3 id="trudnost-2-net-podderzhki-https">  Difficult√© n ¬∞ 2: pas de support HTTPS </h3><br><p>  Commento lui-m√™me est un serveur Web, mais il ne prend en charge que le protocole HTTP non s√©curis√©. </p><br><p>  Il convient de noter que cette pratique est assez courante de nos jours: dans ce cas, le serveur est cach√© derri√®re le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">proxy inverse</a> , qui effectue √©galement le d√©chargement SSL.  Le fait est que le support SSL / HTTPS est absolument n√©cessaire dans ce cas, apr√®s tout, dans la cour 2019 et examiner les tentatives d'autorisation d'un utilisateur √† l'aide d'un protocole Internet non s√©curis√© sera tr√®s ironique. </p><br><p>  J'ai d√©cid√© d'utiliser le serveur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Nginx</a> , d'une part, j'avais une grande exp√©rience de travail avec lui, et d'autre part, il est tr√®s rapide, √©conomique et stable.  Et publie les versions officielles des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">images Docker</a> . </p><br><p>  Le deuxi√®me ingr√©dient de la recette HTTPS est le certificat SSL du domaine.  Je suis √©ternellement reconnaissant √† EFF et Mozilla d'avoir cr√©√© l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Autorit√© de</a> certification <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Let's Encrypt</a> , qui √©met des millions de certificats gratuits chaque mois. </p><br><p>  Let's Encrypt fournit √©galement un utilitaire de ligne de commande gratuit appel√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">certbot</a> , qui simplifie consid√©rablement le processus d'obtention et de mise √† jour d'un certificat.  Eh bien, et - bien s√ªr - une image Docker pour lui! </p><br><h3 id="trudnost-3-problema-kuricy-yayca-certbot">  Difficult√© n ¬∞ 3: Probl√®me d'oeufs de poulet Certbot </h3><br><p>  Mais cette astuce est plus d√©licate. </p><br><p>  Nous voulons faire r√©f√©rence au certificat SSL dans la configuration de notre proxy inverse sur Nginx, ce qui signifie que sans certificat, il refuse simplement de d√©marrer.  Dans le m√™me temps, pour <em>obtenir un</em> certificat SSL pour un domaine, vous avez besoin d'un serveur HTTP fonctionnel, qui Let's Encrypt prouvera votre propri√©t√© de ce domaine. </p><br><p>  J'ai r√©ussi √† r√©soudre ce probl√®me et, il me semble, assez √©l√©gamment: </p><br><ol><li>  Tout d'abord, un certificat factice non valide est g√©n√©r√©, dont le seul but est de laisser Nginx d√©marrer. </li><li>  Nginx et certbot re√ßoivent conjointement un nouveau certificat, d√©sormais valide. </li><li>  D√®s r√©ception du certificat, certbot passe en ¬´mode veille¬ª, se r√©veillant toutes les 12 heures pour v√©rifier s'il doit √™tre mis √† jour - selon les recommandations de Let's Encrypt. </li><li>  Lorsque le moment est venu et que le certificat a √©t√© renouvel√©, certbot signalera √† Nginx de red√©marrer. </li></ol><br><h3 id="trudnost-4-chto-to-dolzhno-sohranyatsya">  Difficult√© n ¬∞ 4: quelque chose doit √™tre pr√©serv√© </h3><br><p>  Je soup√ßonne fortement que vous souhaitez que les commentaires des utilisateurs soient enregistr√©s apr√®s un red√©marrage ou une mise √† jour du syst√®me. </p><br><p>  De plus, afin que Let's Encrypt ne vous interdise pas en raison de demandes trop fr√©quentes, il serait bon de conserver les certificats re√ßus pour toute la date d'expiration. </p><br><p> Les deux points ont √©t√© r√©solus dans la configuration propos√©e en utilisant les volumes du Docker, cr√©√©s automatiquement par <em>systemd</em> lors du premier lancement de Commento.  Les volumes sont marqu√©s comme <code>external</code> , donc Docker les ignore lors de la suppression des conteneurs √† l'aide de <code>docker-compose down -v</code> . </p><br><h2 id="svodim-vsyo-voedino">  Rassemblez tout </h2><br><p>  Vous pouvez maintenant voir comment tout cela fonctionne ensemble. </p><br><p>  La figure ci-dessous montre l'interaction et le trafic entre les quatre conteneurs: </p><br><p><img src="https://habrastorage.org/webt/zl/kr/y3/zlkry3l9lxx8mfwzzlsnuvubi6a.png"></p><br><p>  J'ai appliqu√© l'option <code>depends_on</code> Docker Compose <code>depends_on</code> pour garantir que les conteneurs d√©marrent dans le bon ordre. </p><br><p>  Si vous souhaitez uniquement d√©marrer votre propre serveur Commento, vous pouvez ignorer le reste de l'article et acc√©der directement au <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">code sur GitHub</a> . </p><br><p>  Eh bien, je parlerai plus en d√©tail de cette impl√©mentation plus tard. </p><br><h2 id="kak-eto-vsyo-rabotaet">  Comment √ßa marche </h2><br><h3 id="fayl-compose">  Composer un fichier </h3><br><p>  Comme vous pouvez le voir sur l'image ci-dessus, ma ¬´composition¬ª se compose de quatre services: </p><br><ol><li>  <code>certbot</code> - utilitaire <code>certbot</code> d'EFF </li><li>  <code>nginx</code> - proxy inverse impl√©mentant le d√©chargement SSL </li><li>  <code>app</code> - serveur Commento </li><li>  <code>postgres</code> - Base de donn√©es PostgreSQL </li></ol><br><p>  Le <a href=""><code>docker-compose.yml</code></a> contient des d√©clarations de son propre r√©seau Docker, appel√© <code>commento_network</code> , et trois volumes, dont deux externes (c'est-√†-dire qu'ils doivent √™tre cr√©√©s en dehors de Compose): </p><br><ul><li>  <code>commento_postgres_volume</code> stocke les donn√©es du serveur PostgreSQL pour Commento: utilisateurs, mod√©rateurs, commentaires, etc. </li><li>  <code>certbot_etc_volume</code> contient les certificats re√ßus par <code>certbot</code> . </li></ul><br><h3 id="nginx">  Nginx </h3><br><p>  Le conteneur Nginx est bas√© sur une image officielle l√©g√®re bas√©e sur Alpine et utilise le script suivant pour s'ex√©cuter: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh trap exit TERM # Wait for the certificate file to arrive wait_for_certs() { echo 'Waiting for config files from certbot...' i=0 while [[ ! -f /etc/letsencrypt/options-ssl-nginx.conf ]]; do sleep 0.5 [[ $((i++)) -gt 20 ]] &amp;&amp; echo 'No files after 10 seconds, aborting' &amp;&amp; exit 2 done } # Watches for a "reload flag" (planted by certbot container) file and reloads nginx config once it's there watch_restart_flag() { while :; do [[ -f /var/www/certbot/.nginx-reload ]] &amp;&amp; rm -f /var/www/certbot/.nginx-reload &amp;&amp; echo 'Reloading nginx' &amp;&amp; nginx -s reload sleep 10 done } # Wait for certbot wait_for_certs # Start "reload flag" watcher watch_restart_flag &amp; # Run nginx in the foreground echo 'Starting nginx' exec nginx -g 'daemon off;'</span></span></code> </pre> <br><ul><li>  Ligne <strong>3</strong> ( <em>ARRGHHH, Habr ne prend pas en charge l'affichage des num√©ros de ligne dans le code - environ la traduction</em> ) <em>.</em> Un gestionnaire d'interruption est enregistr√© afin que Nginx et le processus de surveillance en arri√®re-plan terminent avec succ√®s le travail lorsque le conteneur s'arr√™te. </li><li>  La ligne <strong>27</strong> appelle la fonction d'attente, qui suspend le processus de d√©marrage de Nginx jusqu'√† ce que les fichiers de configuration SSL cr√©√©s par le conteneur <code>certbot</code> .  Sans cela, Nginx refuserait de commencer. </li><li>  La ligne <strong>30</strong> cr√©e un processus d'arri√®re-plan qui v√©rifie r√©guli√®rement, toutes les dix secondes, la pr√©sence d'un fichier indicateur avec le nom <code>.nginx-reload</code> , et d√®s qu'il le d√©tecte, demande √† Nginx de recharger la configuration.  Ce fichier cr√©e √©galement certbot lorsque le certificat est mis √† jour. </li><li>  La ligne <strong>34</strong> d√©marre Nginx en mode normal.  Dans ce cas, <code>exec</code> signifie que le processus shell actuel est <em>remplac√© par</em> le processus Nginx. </li></ul><br><p>  Un autre fichier important de cette image est la configuration du serveur virtuel Commento, qui force Nginx √† transmettre les requ√™tes HTTPS au conteneur <code>commento</code> : </p><br><pre> <code class="nginx hljs"><span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> [::]:<span class="hljs-number"><span class="hljs-number">443</span></span> ssl ipv6only=<span class="hljs-literal"><span class="hljs-literal">on</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> <span class="hljs-number"><span class="hljs-number">443</span></span> ssl; <span class="hljs-attribute"><span class="hljs-attribute">server_tokens</span></span> <span class="hljs-literal"><span class="hljs-literal">off</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">root</span></span> /var/www/html; <span class="hljs-attribute"><span class="hljs-attribute">index</span></span> index.html index.htm index.nginx-debian.html; <span class="hljs-attribute"><span class="hljs-attribute">server_name</span></span> __DOMAIN__; <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> / { <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> http://app:8080/; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> Host <span class="hljs-variable"><span class="hljs-variable">$http_host</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-Real-IP <span class="hljs-variable"><span class="hljs-variable">$remote_addr</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-Forwarded-For <span class="hljs-variable"><span class="hljs-variable">$proxy_add_x_forwarded_for</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">ssl_certificate</span></span> /etc/letsencrypt/live/__DOMAIN__/fullchain.pem; <span class="hljs-attribute"><span class="hljs-attribute">ssl_certificate_key</span></span> /etc/letsencrypt/live/__DOMAIN__/privkey.pem; <span class="hljs-attribute"><span class="hljs-attribute">include</span></span> /etc/letsencrypt/options-ssl-nginx.conf; <span class="hljs-attribute"><span class="hljs-attribute">ssl_dhparam</span></span> /etc/letsencrypt/ssl-dhparams.pem; } <span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span> default_server; <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> [::]:<span class="hljs-number"><span class="hljs-number">80</span></span> default_server; <span class="hljs-attribute"><span class="hljs-attribute">server_tokens</span></span> <span class="hljs-literal"><span class="hljs-literal">off</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">server_name</span></span> __DOMAIN__; <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> /.well-known/acme-challenge/ { <span class="hljs-attribute"><span class="hljs-attribute">root</span></span> /var/www/certbot; } <span class="hljs-comment"><span class="hljs-comment"># Redirect to HTTPS on port 80 location / { return 301 https://$host$request_uri; } }</span></span></code> </pre> <br><p>  Le premier bloc serveur (lignes <strong>1-21</strong> ) d√©crit comment travailler avec HTTPS et la r√®gle de transfert.  C'est l√† que les fichiers de certificat Let's Encrypt sont mentionn√©s (ou les talons utilis√©s √† la place). </p><br><p>  Le domaine servi par le serveur est pass√© en argument lors de la construction de l'image;  il remplace la ligne <code>__DOMAIN__</code> dans la configuration du serveur. </p><br><p>  Le deuxi√®me bloc (lignes <strong>23-38</strong> ) est la configuration du serveur HTTP, qui est utilis√© par le certbot pour confirmer la propri√©t√© du domaine (le soi-disant ¬´d√©fi ACME¬ª).  Toutes les autres demandes entra√Ænent une redirection vers l'adresse correspondante via HTTPS. </p><br><h3 id="certbot">  certbot </h3><br><p>  Notre image certbot est bas√©e sur la version <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">officielle</a> avec le script suivant: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh trap exit TERM # Wait until nginx is up and running, up to 10 seconds wait_for_nginx() { echo 'Waiting for nginx...' i=0 while ! nc -z nginx 80 &amp;&gt;/dev/null; do sleep 0.5 [[ $((i++)) -gt 20 ]] &amp;&amp; echo "nginx isn't online after 10 seconds, aborting" &amp;&amp; exit 4 done echo 'nginx is up and running' } # Check vars [[ -z "$DOMAIN" ]] &amp;&amp; echo "Environment variable 'DOMAIN' isn't defined" &amp;&amp; exit 2 [[ -z "$EMAIL" ]] &amp;&amp; echo "Environment variable 'EMAIL' isn't defined" &amp;&amp; exit 2 TEST="${TEST:-false}" # Check external mounts data_dir='/etc/letsencrypt' www_dir='/var/www/certbot' [[ ! -d "$data_dir" ]] &amp;&amp; echo "Directory $data_dir must be externally mounted" [[ ! -d "$www_dir" ]] &amp;&amp; echo "Directory $www_dir must be externally mounted" # If the config/certificates haven't been initialised yet if [[ ! -e "$data_dir/options-ssl-nginx.conf" ]]; then # Copy config over from the initial location echo 'Initialising nginx config' cp /conf/options-ssl-nginx.conf /conf/ssl-dhparams.pem "$data_dir/" # Copy dummy certificates mkdir -p "$data_dir/live/$DOMAIN" cp /conf/privkey.pem /conf/fullchain.pem "$data_dir/live/$DOMAIN/" # Wait for nginx wait_for_nginx # Remove dummy certificates rm -rf "$data_dir/live/$DOMAIN/" # Run certbot to validate/renew certificate test_arg= $TEST &amp;&amp; test_arg='--test-cert' certbot certonly --webroot -w /var/www/certbot -n -d "$DOMAIN" $test_arg -m "$EMAIL" --rsa-key-size 4096 --agree-tos --force-renewal # Reload nginx config touch /var/www/certbot/.nginx-reload # nginx config has been already initialised - just give nginx time to come up else wait_for_nginx fi # Run certbot in a loop for renewals while :; do certbot renew # Reload nginx config touch /var/www/certbot/.nginx-reload sleep 12h done</span></span></code> </pre> <br><p>  Un bref tour d'horizon de ses lignes: </p><br><ul><li>  La ligne <strong>3</strong> , comme dans le script pr√©c√©dent, est requise pour l'ach√®vement r√©gulier du conteneur. </li><li>  Les lignes <strong>17-19</strong> v√©rifient les variables requises. </li><li>  Et dans les lignes <strong>22-25</strong> - que les r√©pertoires n√©cessaires au fonctionnement de certbot sont mont√©s correctement. </li><li>  La fourche suit: <br><ul><li>  Les lignes <strong>30-50</strong> sont ex√©cut√©es uniquement au premier d√©marrage du conteneur: <br><ul><li>  Un certificat factice est copi√©, permettant √† Nginx de d√©marrer normalement. </li><li>  Nginx, quant √† lui, attend la fin de ce processus, apr√®s quoi il continue de se t√©l√©charger. </li><li>  Une fois Nginx d√©marr√©, certbot lance le processus d'obtention d'un certificat valide aupr√®s de Let's Encrypt. </li><li>  Et enfin, d√®s que le certificat est re√ßu, le fichier <code>.nginx-reload</code> est cr√©√©, <code>.nginx-reload</code> entendre √† Nginx qu'il est temps de recharger la configuration. </li></ul></li><li>  La ligne <strong>54</strong> attend le d√©marrage de Nginx - dans le cas o√π un certificat complet est d√©j√† disponible. </li></ul></li><li>  Apr√®s tout cela (lignes <strong>58-63</strong> ), il continue de faire du v√©lo, une fois toutes les 12 heures v√©rifiant la n√©cessit√© de renouveler le certificat et signalant √† Nginx de red√©marrer. </li></ul><br><h3 id="commento-i-postgresql">  Commento et PostgreSQL </h3><br><p>  L' <code>app</code> et les conteneurs <code>postgres</code> utilisent les images originales fournies par les d√©veloppeurs sans aucune modification. </p><br><h3 id="servis-systemd">  Service Systemd </h3><br><p>  La derni√®re pi√®ce de ce puzzle est le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">fichier d'unit√© systemd</a> <code>commento.service</code> , sur lequel vous devez cr√©er un lien symbolique dans <code>/etc/systemd/system/commento.service</code> pour qu'il d√©marre au bon moment au d√©marrage du syst√®me: </p><br><pre> <code class="plaintext hljs">[Unit] Description=Commento server [Service] TimeoutStopSec=30 WorkingDirectory=/opt/commento ExecStartPre=-/usr/bin/docker volume create commento_postgres_volume ExecStartPre=-/usr/bin/docker volume create certbot_etc_volume ExecStartPre=-/usr/local/bin/docker-compose -p commento down -v ExecStart=/usr/local/bin/docker-compose -p commento up --abort-on-container-exit ExecStop=/usr/local/bin/docker-compose -p commento down -v [Install] WantedBy=multi-user.target</code> </pre> <br><p>  Rang√©es: </p><br><ul><li>  La ligne <strong>6</strong> implique que le code du projet est clon√© dans le r√©pertoire <code>/opt/commento</code> - c'est beaucoup plus simple. </li><li>  Les lignes <strong>7 √† 8</strong> cr√©ent des volumes externes, s'ils ne le sont pas d√©j√†. </li><li>  √Ä la ligne <strong>9</strong> , les restes √©ventuels des conteneurs pr√©c√©dents sont supprim√©s.  Les volumes ext√©rieurs sont conserv√©s. </li><li>  La ligne <strong>10</strong> marque le lancement r√©el de Docker Compose.  L' <code>--abort-on-container-exit</code> tout le troupeau de conteneurs lorsque l'un d'eux est <code>--abort-on-container-exit</code> .  Gr√¢ce √† cela, systemd sera au moins conscient que le service est arr√™t√©. </li><li>  La ligne <strong>11</strong> nettoie et supprime √† nouveau les conteneurs, les r√©seaux et les volumes. </li></ul><br><h2 id="ishodnyy-kod">  Code source </h2><br><p>  Une impl√©mentation pleinement fonctionnelle, ne n√©cessitant que la configuration des variables dans <code>docker-compose.yml</code> , est disponible <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sur GitHub</a> .  Il vous suffit de suivre attentivement les √©tapes d√©crites dans le <a href="">fichier README</a> . </p><br><p>  Le code est soumis √† la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">licence MIT</a> . </p><br><p>  Merci d'avoir lu cet endroit, les commentaires sont fr√©n√©tiquement les bienvenus! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr464105/">https://habr.com/ru/post/fr464105/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr464093/index.html">Produits num√©riques: que faire si un client vient chercher un achat dans un an?</a></li>
<li><a href="../fr464095/index.html">Getters et Setters √† Dart et Flutter</a></li>
<li><a href="../fr464097/index.html">L'√©volution de l'intelligence: pourquoi les robots ont besoin d'√©motions</a></li>
<li><a href="../fr464099/index.html">Analyse du langage VKScript: JavaScript, √™tes-vous?</a></li>
<li><a href="../fr464103/index.html">Projet de norme nationale IoT OpenUNB: examen critique</a></li>
<li><a href="../fr464107/index.html">√âv√©nements num√©riques √† Moscou du 19 au 25 ao√ªt</a></li>
<li><a href="../fr464109/index.html">Parachutes supersoniques spatiaux</a></li>
<li><a href="../fr464111/index.html">Natas Web. Passage de la plateforme CTF visant √† exploiter les vuln√©rabilit√©s du Web</a></li>
<li><a href="../fr464113/index.html">"CAD pour tout le monde, gratuitement et ne laissez personne partir ..." ou les premi√®res √©tapes de la programmation de FreeCAD en Python</a></li>
<li><a href="../fr464115/index.html">Comment se faire des amis en tant que designer, maquettiste et ¬´Figma¬ª en utilisant un syst√®me de design, un pied-de-biche et une sorte de m√®re ‚Ñ¢</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>