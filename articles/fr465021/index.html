<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§¥üèø üèáüèº üë©üèæ‚Äçüöí Comment d√©boguer des variables d'environnement sous Linux ü§úüèª üîù üëåüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Il arrive souvent que vous arriviez sur la machine et que vous trouviez une sorte de script en cours d'ex√©cution sous l'utilisateur syst√®me il y a une...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment d√©boguer des variables d'environnement sous Linux</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/badoo/blog/465021/">  Il arrive souvent que vous arriviez sur la machine et que vous trouviez une sorte de script en cours d'ex√©cution sous l'utilisateur syst√®me il y a une semaine.  Qui l'a lanc√©?  O√π chercher ce run.php?  Ou vous ajoutez une entr√©e √† / etc / crontab, et le script se bloque l√†-bas avec l'erreur "commande introuvable".  Pourquoi?  Et que faire? <br><br>  J'ai les r√©ponses √† ces questions. <br><br><img src="https://habrastorage.org/webt/wl/09/8k/wl098km-rv1zzu0xniek6equaj0.jpeg"><a name="habracut"></a><br><br><h2>  Variables d'environnement </h2><br>  Dans presque tous les syst√®mes d'exploitation modernes, les processus ont des variables d'environnement.  Techniquement, ils sont une collection de cha√Ænes nomm√©es.  Si un sous-processus est d√©marr√©, il h√©rite automatiquement d'une copie de l'environnement du parent. <br><br>  Entre autres, il y a la variable PATH, qui indique les chemins pour rechercher des fichiers ex√©cutables, la variable HOME, qui pointe vers le r√©pertoire personnel de l'utilisateur, les variables responsables des pr√©f√©rences linguistiques de l'utilisateur, et bien d'autres. <br><br>  Il existe de nombreuses revues d√©crivant la signification de ces variables, mais il n'y a pratiquement aucun article sur la fa√ßon d'enqu√™ter sur les probl√®mes.  Comblez cette lacune. <br><br><h2>  Qui a commenc√© le processus? </h2><br>  Nous avons donc trouv√© un script ex√©cut√© sous l'utilisateur syst√®me il y a une semaine.  Qui l'a lanc√©?  Pourquoi?  Peut-√™tre qu'ils l'ont juste oubli√©?  10 √† 15 personnes pourraient le lancer, vous n'interviewerez pas tout le monde.  Comment savoir qui c'√©tait?  Et o√π se trouve ce run.php? <br><br><pre><code class="bash hljs">$ ps x | grep run.php 10684 ? Ss 472:25 /<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/php/bin/php run.php</code> </pre> <br>  Les variables d'environnement de processus et la fonction sudo viennent √† la rescousse.  Il existe une telle variable PWD dans laquelle le shell stocke le r√©pertoire de travail actuel;  cette valeur, en fait, enregistre des informations sur le r√©pertoire courant au moment o√π la commande est ex√©cut√©e.  De plus, l'utilitaire sudo laisse par d√©faut des informations dans la variable d'environnement de processus sur l'utilisateur √† partir duquel il a √©t√© lanc√©. <br><br>  Les variables d'environnement (et bien plus) pour tout processus en cours d'ex√©cution peuvent √™tre trouv√©es dans / proc.  Voila: <br><br><pre> <code class="bash hljs">$ cat /proc/10684/environ | tr <span class="hljs-string"><span class="hljs-string">'\0'</span></span> <span class="hljs-string"><span class="hljs-string">'\n'</span></span> | grep SUDO_USER SUDO_USER=alexxz $ cat /proc/10684/environ | tr <span class="hljs-string"><span class="hljs-string">'\0'</span></span> <span class="hljs-string"><span class="hljs-string">'\n'</span></span> | grep PWD PWD=/home/etlmaster</code> </pre><br>  Ahem, je l'ai lanc√© moi-m√™me.  Eh bien, qui ne se produit pas? .. <br><br>  En g√©n√©ral, en utilisant une m√©thode aussi simple dans des situations simples, vous pouvez trouver des informations sur le processus, qui ne sont g√©n√©ralement pas disponibles. <br><br><h2>  Le script fonctionne √† partir de la ligne de commande, mais ne fonctionne pas √† partir de cron </h2><br>  L'un des cas o√π vous devez penser aux variables d'environnement est lorsqu'un script ajout√© √† / etc / crontab se bloque avec une erreur.  Vous allez sur le serveur via SSH, ex√©cutez la commande, tout semble fonctionner comme il se doit.  Et quand il d√©marre automatiquement, il affiche quelque chose comme ¬´hive: commande introuvable¬ª. <br><br>  En g√©n√©ral, il est recommand√© d'√©crire le chemin d'acc√®s complet aux commandes ex√©cutables, mais ce n'est pas toujours possible.  Dans de tels cas, les d√©veloppeurs s'en sortent comme n'importe qui peut.  Quelqu'un ajoute le chemin souhait√© dans PATH en tant que membre de l'√©quipe de crontab.  Les plus exp√©riment√©s encapsulent leur commande dans bash -l.  Et les bombes √† corbeau enseign√©es par une exp√©rience am√®re n‚Äôoublient toujours pas de se rassembler.  Tout est ainsi: fait, ajout√© √† la surveillance et oubli√©. <br><br>  Apr√®s de telles manipulations, un s√©diment reste dans l'√¢me d'un v√©ritable ing√©nieur.  Oui, le probl√®me est r√©solu.  Mais je ne comprenais pas ce qui se passait!  Comment une approche est-elle meilleure qu'une autre?  O√π sont stock√©s tous ces param√®tres et par qui sont-ils modifi√©s? <br><br>  Comparons les variables d'environnement d'un processus lorsqu'il est lanc√© √† partir de la couronne et les variables d'environnement que nous avons sur la ligne de commande.  Nous enregistrons la sortie de la commande env depuis la couronne et notre environnement actuel: <br><br><pre> <code class="bash hljs">$ <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"* * * * * env &gt; ~/crontab.env"</span></span> | crontab; sleep 60; <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span> | crontab; $ env &gt; my.env</code> </pre><br>  Regardez ce qu'il y a dans la variable PATH: <br><br><pre> <code class="bash hljs">&gt; grep ^PATH= crontab.env my.env Crontab.env: PATH=/usr/bin:/bin My.env: PATH=/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/hive/bin:/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/python/bin:/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/hadoop/bin:/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/hadoop/bin:/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/hive/bin:/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/hadoop/bin:/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin:/usr/bin:/bin</code> </pre><br><img src="https://habrastorage.org/webt/75/h-/qu/75h-qu_bfabmlzt-2ghgkinzjrm.png"><br><br>  Mama Mia!  Il n'y a donc sous la couronne que le minimum!  Bien s√ªr, vous devez charger les variables d'environnement normales. <br><br>  Voyons ce que sera l'environnement si nous ajoutons bash -l: <br><br><pre> <code class="bash hljs">$ <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"* * * * * bash -l env &gt; ~/crontab.env"</span></span> | crontab; sleep 60; <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span> | crontab; alexxz@bi1.mlan:~&gt; grep ^PATH= crontab.env my.env Crontab.env: PATH=/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/hive/bin:/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/python/bin:/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/hadoop/bin:/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/hadoop/bin:/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/hadoop/bin:/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/hive/bin:/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin:/usr/bin:/bin My.env: PATH=/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/hive/bin:/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/python/bin:/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/hadoop/bin:/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/hadoop/bin:/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/hive/bin:/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/hadoop/bin:/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin:/usr/bin:/bin</code> </pre><br>  La diff√©rence n'est pas si perceptible.  Tous les chemins sont pr√©sent√©s.  Certains dans un ordre diff√©rent, certains sont r√©p√©t√©s, mais c'est d√©j√† beaucoup mieux que ce qu'il √©tait.  Les autres variables sont √©galement bien ajust√©es.  Il y a, bien s√ªr, une l√©g√®re diff√©rence dans les param√®tres r√©gionaux, dans les variables de SSH, mais cela ne devrait plus affecter consid√©rablement le script. <br><br>  Maintenant, il est clair pourquoi bash -l est n√©cessaire dans les entr√©es crontab.  Et, bien s√ªr, n'oubliez pas le troupeau. <br><br><h2>  D√©boguer l'initialisation des scripts de connexion </h2><br>  Le probl√®me semble √™tre r√©solu, tout depuis la couronne fonctionne.  Mais comment se fait-il que certains chemins soient dupliqu√©s dans la variable PATH?  Il y a donc une sorte de g√¢chis dans la configuration du serveur.  Essayons de le comprendre. <br><br>  Nous ouvrons quelques hommes pour initialiser l'environnement, nous lisons quels scripts et dans quel ordre sont ex√©cut√©s, avec enthousiasme nous commen√ßons √† courir √† travers leurs yeux - et apr√®s quelques minutes, un sentiment de d√©sespoir survient.  Un flux infini de conditions sur certains cas particuliers d'architectures, de terminaux et de param√®tres de couleurs incroyablement importants pour la commande ls.  Douleur, d√©sespoir, haine!  Nous sommes int√©ress√©s par une fichue variable PATH! <br><br>  En fait, tout est un peu plus simple.  Rencontrez: <br><br><pre> <code class="bash hljs">env -i bash -x -l -c <span class="hljs-string"><span class="hljs-string">'echo 123'</span></span> &gt; login.log 2&gt;&amp;1</code> </pre> <br>  Que fait cette √©quipe?  Cr√©e un nouveau processus bash avec un environnement vierge, indique qu'il est n√©cessaire d'ex√©cuter des scripts d'initialisation et de tout s√©curiser en d√©tail dans le fichier login.log.  Nous avons maintenant la possibilit√© de ne pas ex√©cuter tous les scripts dans notre esprit, mais simplement de lire quoi, o√π et quand il a √©t√© ex√©cut√© et d'o√π vient tel ou tel param√®tre d'environnement. <br><br>  Je n'analyserai pas en d√©tail comment lire le journal r√©sultant.  Tout y est presque banal.  Je mentionne seulement qu'un hit est venu de / etc / profile et deux de /etc/bash.bashrc.  Oui, quelque part, ils √©taient trop intelligents lors de la configuration des packages dans un pappet.  Bon, rien, √ßa ne me d√©range pas de travailler. <br><br>  Mais maintenant je sais et je peux! <br><br>  PS Dans les cas tr√®s difficiles et afin de tout comprendre, vous pouvez encapsuler la commande en strace: <br><br><pre> <code class="bash hljs"> strace -f env -i bash -x -l -c <span class="hljs-string"><span class="hljs-string">'echo 123'</span></span> &gt; login.log 2&gt;&amp;1</code> </pre></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr465021/">https://habr.com/ru/post/fr465021/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr465011/index.html">Notations bancaires. La participation ne peut pas √™tre fix√©e</a></li>
<li><a href="../fr465013/index.html">Freelance / Full Time Coefficient ou comment comprendre qu'il est temps de penser √† Freelance</a></li>
<li><a href="../fr465015/index.html">Psychanalyse de l'effet d'un sp√©cialiste m√©connu. Partie 2. Comment et pourquoi r√©sister</a></li>
<li><a href="../fr465017/index.html">Intel Use NUC - Gagnez le concours NUC</a></li>
<li><a href="../fr465019/index.html">Slurm √† Saint-P√©tersbourg: les derniers jours d'inscription</a></li>
<li><a href="../fr465023/index.html">Tendances du march√© des √©couteurs: ce que nous allons acheter dans un avenir proche</a></li>
<li><a href="../fr465027/index.html">10 questions na√Øves mais importantes sur le CRM</a></li>
<li><a href="../fr465029/index.html">[POSSIBLE] SORM d√©chiffre le trafic HTTPS vers Mail.ru et ICQ</a></li>
<li><a href="../fr465031/index.html">Vue int√©rieure: RFID dans le monde moderne. Partie 2: RFID chinoise</a></li>
<li><a href="../fr465033/index.html">Venez avec la technologie Powercheck</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>