<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üññüèº üïû üë©üèø‚Äçüç≥ Comment assembler une image Oracle DB pour Testcontainers üçü üóº ‚ö´Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Le code doit √™tre test√© sur le SGBD avec lequel il fonctionnera. Testcontainers est une biblioth√®que qui vous permet d'utiliser presque tous les SGBD ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment assembler une image Oracle DB pour Testcontainers</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/480106/"><p>  Le code doit √™tre test√© sur le SGBD avec lequel il fonctionnera.  Testcontainers est une biblioth√®que qui vous permet d'utiliser presque tous les SGBD dans les tests unitaires avec la m√™me facilit√© que les bases de donn√©es int√©gr√©es comme HSQLDB ou H2.  Il n'y aurait qu'une image de docker </p><br><img src="https://habrastorage.org/webt/hn/x3/ho/hnx3hojiqvya8flignz-mqkrk6s.jpeg"><br><p>  Cet article est consacr√© √† l'assemblage d'une image docker qui est pratique pour une utilisation avec Testcontainers.  Quand j'ai essay√© de le faire, j'ai eu des probl√®mes, et ici je partage ma solution. <br>  Je vais collecter l'image pour Oracle 11, car elle est petite et j'ai assez de version 11.  Avec d'autres versions, l'approche est √† peu pr√®s la m√™me. </p><br><p>  Afin d'indiquer clairement comment utiliser l'image, il y aura √©galement du code Java qui montre l'utilisation de l'image pour tester les applications Spring Boot.  La m√©thode de connexion aux conteneurs de test que j'ai donn√©e n'est probablement pas la meilleure.  Mais tout d'abord, il montre comment utiliser les param√®tres sp√©cifi√©s lors de la cr√©ation de l'image.  Deuxi√®mement, c'est simple.  Et troisi√®mement, il n'est presque pas li√© √† Spring, il peut m√™me √™tre bloqu√© dans du code Java, dans lequel il n'y a que du vide public statique principal. </p><br><p>  Il est suppos√© que le lecteur est superficiellement familier avec Docker et Testcontaners, et conna√Æt √©galement bien Java.  Pour construire, vous devez utiliser linux, si vous construisez sous Windows, vous devrez utiliser msys2 ou quelque chose comme √ßa. </p><br><p>  Le code de d√©monstration est t√©l√©charg√© sur le github ici <a href="https://github.com/poxu/testcontainers-spring-demo" rel="nofollow">https://github.com/poxu/testcontainers-spring-demo Les</a> scripts corrig√©s pour assembler l'image peuvent √™tre consult√©s dans ma fourchette des instructions d'Oraklov <a href="https://github.com/poxu/docker-images/tree/master/OracleDatabase/SingleInstance" rel="nofollow">https://github.com/poxu/docker-images/tree/ master / OracleDatabase / SingleInstance</a> </p><a name="habracut"></a><br><h1>  Cr√©er une image Docker </h1><br><p>  Oracle ne fournit pas d'images pour docker, mais a publi√© des instructions d√©taill√©es sur la fa√ßon de les assembler sur le github. </p><br><p>  Malheureusement, il n'est pas possible d'utiliser ces images dans des conteneurs de test car, car le conteneur qui est lanc√© √† partir de cette image d√©marre de deux √† 20 minutes. </p><br><p>  Ceci est inacceptable pour une utilisation dans les tests unitaires, vous devez donc apporter vos propres modifications aux scripts, mais tout d'abord, il est pr√©f√©rable d'essayer d'assembler le conteneur conform√©ment aux instructions fournies par Oracle.  Je vais faire un bref r√©cit ici, une instruction plus compl√®te se trouve sur ce lien <a href="https://github.com/oracle/docker-images/tree/master/OracleDatabase/SingleInstance" rel="nofollow">https://github.com/oracle/docker-images/tree/master/OracleDatabase/SingleInstance</a> </p><br><h2>  Assemblage d'images selon les instructions d'Oracle </h2><br><p>  Tout d'abord, vous devez cloner le r√©f√©rentiel avec des instructions sur la fa√ßon d'assembler l'image. </p><br><pre><code class="bash hljs">git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/oracle/docker-images.git</code> </pre> <br><p>  Procurez-vous ensuite le package rpm pour la version express autoris√©e d'Oracle 11.2.0.2. Ce n'est pas tr√®s difficile, il vous suffit de vous inscrire sur le site Web d'Oracle, d'acc√©der √† la page de t√©l√©chargement d'Oracle DBMS, de s√©lectionner la version 11.2.0.2 XE et de t√©l√©charger le fichier rpm compress√© oracle-xe-11.2.0 -1.0.x86 ~ 64 ~ .rpm.zip. </p><br><p>  Placez le fichier dans le r√©f√©rentiel git t√©l√©charg√© dans le r√©pertoire docker-images / OracleDatabase / SingleInstance / dockerfiles / 11.2.0.2 / </p><br><p>  Ensuite, acc√©dez au r√©pertoire docker-images / OracleDatabase / SingleInstance / dockerfiles et ex√©cutez la commande </p><br><pre> <code class="bash hljs">./buildDockerImage.sh -v 11.2.0.2 -x</code> </pre> <br><p>  Le docker assemblera une image appel√©e oracle / database: 11.2.0.2-xe sur la base de laquelle vous devez cr√©er le conteneur avec cette commande </p><br><pre> <code class="bash hljs">docker run --rm --name vanilla_oracle_test_habr \ -p 1234:1521 \ -p 5678:5500 \ -e ORACLE_PWD=123 \ --shm-size=<span class="hljs-string"><span class="hljs-string">"1g"</span></span> \ oracle/database:11.2.0.2-xe</code> </pre> <br><p>  Le conteneur d√©marre quelques minutes, car apr√®s le d√©marrage, il cr√©e une nouvelle base de donn√©es et ce processus n'est pas rapide. </p><br><p>  Apr√®s quelques minutes, une banni√®re appara√Ætra dans la console </p><br><blockquote>  ############################ <br>  LA BASE DE DONN√âES EST PR√äTE √Ä UTILISER! <br>  ############################ </blockquote><p>  Apr√®s cela, vous pouvez vous connecter √† la base de donn√©es √† l'aide de la connexion SYSTEM, le mot de passe est 123, l'adresse de connexion est localhost et SID est XE. </p><br><p>  Si tout a fonctionn√©, vous pouvez passer au processus de cr√©ation d'une image sous testcontainers.  Sinon, il est pr√©f√©rable de parcourir d'abord le manuel d'Oracle et de d√©couvrir ce qui ne va pas. </p><br><p>  Comme nous l'avons d√©j√† d√©couvert, le conteneur d√©marre longtemps car une base de donn√©es est cr√©√©e apr√®s le d√©marrage.  Dans certains cas, cela peut probablement √™tre pratique, mais cela cause maintenant un pr√©judice complet.  Il est n√©cessaire de rendre le r√©cipient pr√™t √† l'emploi imm√©diatement apr√®s le lancement. </p><br><h2>  Raffinement manuel de l'image </h2><br><p>  Une fa√ßon d'obtenir l'image √† partir de la base de donn√©es termin√©e est d'attendre que le conteneur d√©marre et que la cr√©ation de la base de donn√©es soit termin√©e, puis d'enregistrer le conteneur dans une nouvelle image. </p><br><p>  Il est seulement important de ne pas d√©marrer le conteneur avec l'argument --rm, sinon le docker le battra imm√©diatement apr√®s l'arr√™t. </p><br><pre> <code class="bash hljs">docker commit --message <span class="hljs-string"><span class="hljs-string">"container for unit tests"</span></span> &lt;container id&gt; my/oracle-11.2.0.2-for-unit-tests</code> </pre> <br><p>  Cela cr√©era une nouvelle image √† partir du conteneur, qui sera lanc√©e non seulement quelques minutes, mais 20 √† 30 secondes. </p><br><h2>  Modification du processus d'assemblage d'images afin d'obtenir une image finale imm√©diatement apr√®s l'assemblage </h2><br><p>  Bien s√ªr, il est bon d'avoir des instructions pour assembler l'image sous forme de code afin de pouvoir d√©marrer l'assemblage avec une seule commande et il n'est pas n√©cessaire d'attendre que le conteneur d√©marre et de cr√©er une image √† partir de celle-ci avec vos mains. </p><br><p>  La derni√®re ligne du dockerfile indique la commande qui est ex√©cut√©e apr√®s le d√©marrage </p><br><pre> <code class="bash hljs">CMD <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> <span class="hljs-variable"><span class="hljs-variable">$ORACLE_BASE</span></span>/<span class="hljs-variable"><span class="hljs-variable">$RUN_FILE</span></span></code> </pre> <br><p>  \ $ ORACLE ~ BASE ~ / \ $ RUN ~ FILE ~ pointe vers le fichier docker-images / OracleDatabase / SingleInstance / dockerfiles / 11.2.0.2 / runOracle.sh </p><br><p>  Si vous arr√™tez ce conteneur, puis le r√©ex√©cutez, par cons√©quent, pour la premi√®re fois, le script cr√©era la base de donn√©es et, pour la deuxi√®me fois, il le d√©marrera simplement.  On peut supposer que si vous ex√©cutez le script au stade de l'assemblage d'image, l'image sera assembl√©e √† partir de la base de donn√©es d√©j√† cr√©√©e. </p><br><p>  Mais sur le chemin de la mise en ≈ìuvre de ce plan audacieux, une complication se pose. </p><br><p>  Le script s'ex√©cute pour toujours, c'est-√†-dire jusqu'√† ce qu'un signal arrive dans le conteneur indiquant que le travail doit √™tre termin√©.  Ceci est r√©solu tout simplement.  La derni√®re ligne du fichier runOracle.sh contient la commande wait.  Nous savons qu'au stade de l'assemblage, vous n'avez pas besoin d'attendre quoi que ce soit, vous devez terminer le travail et nous mettrons donc une instruction conditionnelle dans le script. </p><br><p>  Il v√©rifiera si l'argument --running-while-building n'est pas pass√© au fichier et si cet argument est pass√©, alors n'attendez aucun signal, mais interrompez simplement le travail.  Autrement dit, faites comme ceci: </p><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">"</span></span> != <span class="hljs-string"><span class="hljs-string">"--running-while-building"</span></span> ] <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">wait</span></span> <span class="hljs-variable"><span class="hljs-variable">$childPID</span></span> <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span></code> </pre> <br><p>  Eh bien, dans le dockerfile, nous ajoutons un autre appel de script, uniquement au stade de l'assemblage.  √áa va tourner comme √ßa. </p><br><pre> <code class="bash hljs">RUN <span class="hljs-variable"><span class="hljs-variable">$ORACLE_BASE</span></span>/<span class="hljs-variable"><span class="hljs-variable">$RUN_FILE</span></span> --running-while-building CMD <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> <span class="hljs-variable"><span class="hljs-variable">$ORACLE_BASE</span></span>/<span class="hljs-variable"><span class="hljs-variable">$RUN_FILE</span></span></code> </pre> <br><h2>  Modifications requises pour une utilisation dans les tests </h2><br><h3 id="ustranit-ispolzovanie-tomov">  √âlimine l'utilisation du volume </h3><br><p>  Besoin de trouver la ligne </p><br><blockquote>  VOLUME ["\ $ ORACLE ~ BASE ~ / oradata"] </blockquote><p>  Et commentez-le.  Il n'est pas n√©cessaire d'utiliser des volumes, car toutes les modifications seront apport√©es apr√®s chaque test, mais des probl√®mes d'utilisation des volumes peuvent facilement survenir lors de la copie d'images. </p><br><h3 id="udalit-nenuzhnye-fayly">  Supprimer les fichiers inutiles </h3><br><p>  Besoin d'ajouter des lignes </p><br><pre> <code class="bash hljs">rm -rf <span class="hljs-variable"><span class="hljs-variable">$ORACLE_HOME</span></span>/demo &amp;&amp; \ rm -rf <span class="hljs-variable"><span class="hljs-variable">$ORACLE_HOME</span></span>/jdbc &amp;&amp; \ rm -rf <span class="hljs-variable"><span class="hljs-variable">$ORACLE_HOME</span></span>/jlib &amp;&amp; \ rm -rf <span class="hljs-variable"><span class="hljs-variable">$ORACLE_HOME</span></span>/md &amp;&amp; \ rm -rf <span class="hljs-variable"><span class="hljs-variable">$ORACLE_HOME</span></span>/nls/demo &amp;&amp; \ rm -rf <span class="hljs-variable"><span class="hljs-variable">$ORACLE_HOME</span></span>/odbc &amp;&amp; \ rm -rf <span class="hljs-variable"><span class="hljs-variable">$ORACLE_HOME</span></span>/rdbms/jlib &amp;&amp; \ rm -rf <span class="hljs-variable"><span class="hljs-variable">$ORACLE_HOME</span></span>/rdbms/public &amp;&amp; \ rm -rf <span class="hljs-variable"><span class="hljs-variable">$ORACLE_HOME</span></span>/rdbms/demo &amp;&amp; \ rm -rf <span class="hljs-variable"><span class="hljs-variable">$ORACLE_HOME</span></span>/bin/rman &amp;&amp; \</code> </pre> <br><p>  Juste avant la ligne </p><br><pre> <code class="bash hljs">chmod ug+x <span class="hljs-variable"><span class="hljs-variable">$ORACLE_BASE</span></span>/*.sh</code> </pre> <br><p>  Cela supprimera de l'image tous les fichiers qui ne sont pas n√©cessaires √† des fins de test.  Plus l'image est petite, mieux c'est. </p><br><h3 id="ubrat-razbienie-obraza-na-sloi">  Supprimer la division d'image </h3><br><p>  Afin de r√©duire l'image, vous devez la construire en utilisant l'argument <strong>squash</strong> .  Il supprimera la s√©paration en couches de l'image, ce qui r√©duira encore son volume.  L'argument squash est exp√©rimental, vous devez donc l'activer s√©par√©ment.  Dans diff√©rents syst√®mes d'exploitation, cela se fait de diff√©rentes mani√®res. </p><br><p>  Pour transmettre des arguments au docker, docker-images / OracleDatabase / SingleInstance / dockerfiles / buildDockerImage.sh fournit l'argument -o.  Autrement dit, pour transmettre l'argument --squash au docker, vous devez appeler buildDockerImage.sh comme ceci </p><br><pre> <code class="bash hljs">./buildDockerImage.sh -o <span class="hljs-string"><span class="hljs-string">'--squash'</span></span></code> </pre> <br><h3 id="pomenyat-nazvanie-obraza">  Changer le nom de l'image </h3><br><p>  √Ä ce jour, l'image est sensiblement diff√©rente de ce qu'Oracle propose de faire, elle doit donc √™tre renomm√©e.  Pour ce faire, vous devez d√©j√† √©diter le fichier buildDockerImage.sh lui-m√™me. Le script prend le nom de l'image dans la variable IMAGE ~ NAME ~, dont la valeur est directement d√©finie dans le fichier </p><br><p>  Ici </p><br><pre> <code class="plaintext hljs"># Oracle Database Image Name IMAGE_NAME="oracle/database:$VERSION-$EDITION"</code> </pre> <br><p>  J'ai chang√© pour </p><br><pre> <code class="plaintext hljs"># Oracle Database Image Name IMAGE_NAME="my/oracle-for-habr:$VERSION-$EDITION"</code> </pre> <br><h3 id="zadat-parol-k-bd">  D√©finir le mot de passe DB </h3><br><p>  Ce mot de passe est d√©fini dans la variable d'environnement ORACLE ~ PWD ~ lors du premier d√©marrage du conteneur.  Mais nous avons la configuration de la base de donn√©es lors de la construction de l'image, donc la variable doit √™tre d√©finie √† ce stade.  Si la possibilit√© de d√©finir un mot de passe pour chaque assemblage via la ligne de commande n'est pas n√©cessaire, vous pouvez simplement le saisir dans le dockerfile: </p><br><pre> <code class="plaintext hljs">ENV ORACLE_PWD=123</code> </pre> <br><p>  Si, pour quelque chose, vous devez √™tre en mesure de d√©terminer √† nouveau le mot de passe √† chaque g√©n√©ration, puis pour transmettre l'argument au docker, vous pouvez √† nouveau utiliser -o </p><br><pre> <code class="bash hljs">./buildDockerImage.sh -v 11.2.0.2 -x -o <span class="hljs-string"><span class="hljs-string">'--squash --build-arg ORACLE_PWD=123'</span></span></code> </pre> <br><p>  Cela transf√®rera la variable d'environnement ORACLE ~ PWD ~ dans le fichier docker, mais le fichier docker ne la transmettra pas aux scripts qui s'ex√©cutent pendant la g√©n√©ration.  Pour ce faire, ajoutez l'instruction ARG au dockerfile. </p><br><pre> <code class="plaintext hljs">ARG ORACLE_PWD=default</code> </pre> <br><p>  Le mot de passe, comme il est probablement d√©j√† devenu clair, sera 123, et si vous ne passez pas ORACLE ~ PWD ~ √† buildDockerImage.sh alors par d√©faut. </p><br><p>  Parfois, Oracle pense que le mot de passe est incorrect et ne veut pas fonctionner, il peut donc √™tre n√©cessaire de remplacer 123 par autre chose </p><br><h2>  Test augmentant l'image r√©sultante </h2><br><p>  Vous pouvez maintenant essayer d'ex√©cuter le conteneur en fonction de l'image </p><br><pre> <code class="bash hljs">docker run --rm --name dockertest_habr \ -p 1234:1521 \ -p 5678:5500 \ --shm-size=<span class="hljs-string"><span class="hljs-string">"1g"</span></span> \ my/oracle-for-habr:11.2.0.2-xe</code> </pre> <br><p>  L'argument --shm-size = "1g" est important ici, sans lequel le conteneur d√©marre, mais Oracle 11.2.0.2 lui-m√™me ne peut pas fonctionner.  Cela, au cas o√π, ne signifie pas que le conteneur aura besoin d'un gigaoctet de RAM, il consomme environ 100 m√©gaoctets. </p><br><p>  Si le conteneur a augment√© normalement, vous pouvez essayer de vous connecter √† la base de donn√©es, qui s'y trouve. </p><br><p>  Adresse de base - h√¥te local le plus probable <br>  Port - 1234 <br>  Utilisateur - SYST√àME <br>  Mot de passe - 123 </p><br><p>  S'il d√©marre normalement, vous pouvez passer √† l'√©tape suivante. </p><br><h2>  Script d'initialisation de la base de donn√©es </h2><br><p>  Pour que le programme puisse fonctionner avec la base de donn√©es √† partir de l'image, il est n√©cessaire qu'il y ait un circuit apr√®s le lancement.  Vous pouvez cr√©er ce circuit au stade de la construction, mais je pr√©f√®re le faire lorsque le conteneur d√©marre. </p><br><p>  Apr√®s le d√©marrage, le conteneur cherchera dans le r√©pertoire <em>u01 / app / oracle / scripts / startup</em> et ex√©cutera tous les scripts sql qu'il y trouve, que vous pouvez utiliser en y pla√ßant le fichier qui cr√©era le circuit.  Quelque chose comme √ßa. </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span> TEST_USER <span class="hljs-keyword"><span class="hljs-keyword">IDENTIFIED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> passwordnoquotes; <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span> TEST_USER <span class="hljs-keyword"><span class="hljs-keyword">QUOTA</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unlimited</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SYSTEM</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">GRANT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SESSION</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONNECT</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">RESOURCE</span></span>, DBA <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> TEST_USER; <span class="hljs-keyword"><span class="hljs-keyword">GRANT</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">PRIVILEGES</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> TEST_USER;</code> </pre> <br><p>  Tout cela doit √™tre ajout√© au fichier init ~ db ~ .sql, et le fichier est jet√© dans le conteneur en utilisant -v </p><br><pre> <code class="bash hljs">docker run --rm --name dockertest_habr \ -p 1234:1521 \ -p 5678:5500 \ -e ORACLE_PWD=123 \ -v <span class="hljs-variable"><span class="hljs-variable">${PWD}</span></span>/init_db.sql:/u01/app/oracle/scripts/startup/init_db.sql \ --shm-size=<span class="hljs-string"><span class="hljs-string">"1g"</span></span> \ my/oracle-for-habr:11.2.0.2-xe</code> </pre> <br><p>  \ $ {PWD} Ici, il est utilis√© car le chemin absolu du fichier est n√©cessaire, lorsque vous utilisez Windows, vous devez le sp√©cifier diff√©remment.  Si, apr√®s le d√©marrage, le sch√©ma TEST ~ USER ~ a √©t√© cr√©√© avec succ√®s, vous pouvez continuer √† visser le conteneur fra√Æchement cr√©√© aux tests. </p><br><h1>  Utiliser une image en code Java </h1><br><p>  Lors des tests √† l'aide de la base de donn√©es int√©gr√©e, en r√®gle g√©n√©rale, le m√™me probl√®me se pose.  Si la configuration ne peut pas √™tre extraite du cache, Spring la recueille √† nouveau.  En particulier, il recr√©e la base de donn√©es int√©gr√©e, ce qui ralentit bien s√ªr s√©rieusement les tests.  J'ai r√©solu le probl√®me de la force brute en faisant simplement de la pi√®ce de levage de conteneur un singleton.  Vrai, condo. </p><br><p>  Pour Oracle XE, Testcontainers a une classe sp√©cialement pr√©par√©e.  Tout d'abord, cette classe sait que nous parlons d'un conteneur avec un SGBD et que pour d√©terminer s'il est d√©clench√©, nous devons essayer de nous connecter √† la base de donn√©es en utilisant jdbc. </p><br><p>  Un objet de cette classe attendra que le conteneur soit soulev√© par lui-m√™me, il vous suffit de lui indiquer les journaux avec mot de passe √† utiliser. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.testcontainers.containers.BindMode; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.testcontainers.containers.OracleContainer; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StaticOracleContainer</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> OracleContainer </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getContainer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> LazyOracleContainer.ORACLE_CONTAINER; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LazyOracleContainer</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> OracleContainer ORACLE_CONTAINER = makeContainer(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> OracleContainer </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">makeContainer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//       testcontainers.properties //  oracle.container.image final var dockerImageName = "my/oracle-for-habr"; final var container = new OracleContainer(dockerImageName) //    ,  testcontainers //  ,  ,  //   .withUsername("SYSTEM").withPassword("123") // ,  testcontainers  //     .withExposedPorts(1521, 5500) //      shared memory //    .withSharedMemorySize(2147483648L) //   ,       // -v /path/to/init_db.sql:/u01/app/oracle/scripts/startup/init_db.sql //    init_db.sql   .withClasspathResourceMapping("init_db.sql" , "/u01/app/oracle/scripts/startup/init_db.sql" , BindMode.READ_ONLY); container.start(); return container; } } }</span></span></code> </pre> <br><p>  En outre, les conteneurs de test, lorsqu'ils sont lanc√©s, mappent les ports internes du conteneur aux ports externes inoccup√©s d√©finis de mani√®re al√©atoire.  Par cons√©quent, vous ne pouvez pas avoir peur que le conteneur ne monte pas, car le port est d√©j√† utilis√© par quelqu'un.  Un port externe peut √™tre obtenu √† partir du conteneur √† l'aide de la m√©thode getOraclePort (). </p><br><p>  Vous pouvez √©galement obtenir l'adresse du conteneur √† l'aide de la m√©thode getContainerIpAddress (), mais tout conteneur poss√®de cette m√©thode. </p><br><p>  Apr√®s le premier appel √† la m√©thode getContainer, le conteneur ne sera pas recr√©√©, mais celui existant sera renvoy√©.  Cette m√©thode peut maintenant √™tre utilis√©e en Java nu ou dans la configuration de Spring afin d'obtenir un objet avec un conteneur √† partir duquel vous pouvez extraire les ports et l'adresse de la connexion. </p><br><p>  Par exemple, vous pouvez cr√©er un initialiseur qui, lors de l'√©l√©vation du contexte, remplacera les attributs Spring qui sont responsables de la connexion √† la base de donn√©es. </p><br><h2>  Classe pour attacher des conteneurs de test √† Spring </h2><br><p>  Apr√®s avoir soulev√© le conteneur, l'initialiseur remplace les propri√©t√©s responsables de l'URL pour la connexion √† la base de donn√©es, la connexion, le mot de passe et tout cela. </p><br><p>  Mais, s'il n'y a pas de param√®tre evilcorp.testcontainers.enabled dans application.properties, le conteneur ne sera pas lev√© et tout fonctionnera comme si personne ne connectait les conteneurs de test. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.evilcorp.demo; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.junit.platform.commons.logging.Logger; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.junit.platform.commons.logging.LoggerFactory; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.boot.test.util.TestPropertyValues; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.context.ApplicationContextInitializer; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.context.ConfigurableApplicationContext; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.testcontainers.containers.OracleContainer; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestcontainersInitializer</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApplicationContextInitializer</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConfigurableApplicationContext</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Logger log = LoggerFactory.getLogger(TestcontainersInitializer.class); <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initialize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ConfigurableApplicationContext applicationContext)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ,   Testcontainers final String testcontainersEnabled = applicationContext.getEnvironment().getProperty("evilcorp.testcontainers.enabled"); if (!"true".equals(testcontainersEnabled)) { return; } OracleContainer oracleContainer = StaticOracleContainer.getContainer(); oracleContainer.followOutput(s -&gt; log.debug(() -&gt; s.getUtf8String())); // IP       //  ,    // (linux, MacOs, Windows  ) , //    oracleContainer.getContainerIpAddress() //    // // Testcontainers     //   ,    oracleContainer.getOraclePort() //  ,         final String jdbcUrl = "jdbc:oracle:thin:@//" + oracleContainer.getContainerIpAddress() + ":" + oracleContainer.getOraclePort() + "/XE"; //      init_db.sql //      final String user = "TEST_USER"; final String password = "passwordnoquotes"; TestPropertyValues.of( "spring.jpa.properties.hibernate.default_schema=" + user, "spring.datasource.driver-class-name=oracle.jdbc.OracleDriver", "spring.jpa.database-platform=org.hibernate.dialect.Oracle10gDialect", "spring.datasource.username=" + user, "spring.datasource.password=" + password, "spring.datasource.url=" + jdbcUrl, "spring.liquibase.url=" + jdbcUrl, "spring.liquibase.user=" + user, "spring.liquibase.password=" + password ).applyTo(applicationContext.getEnvironment(), TestPropertyValues.Type.MAP, "test"); } }</span></span></code> </pre> <br><p>  Cette configuration peut √™tre utilis√©e dans le test de d√©marrage de printemps pour remplacer les param√®tres de la base de donn√©es √† la vol√©e. </p><br><h2>  Test √† l'aide de Testcontainers </h2><br><p>  Le test √©crit simplement un objet dans la base de donn√©es, puis le lit, rien de sp√©cial. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.evilcorp.demo; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.evilcorp.demo.entity.User; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.junit.jupiter.api.BeforeEach; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.junit.jupiter.api.Test; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.beans.factory.annotation.Autowired; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.boot.test.context.SpringBootTest; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.test.context.ContextConfiguration; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Optional; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> org.junit.jupiter.api.Assertions.assertEquals; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> org.junit.jupiter.api.Assertions.assertNotNull; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> org.junit.jupiter.api.Assertions.assertNotSame; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> org.junit.jupiter.api.Assertions.assertTrue; <span class="hljs-meta"><span class="hljs-meta">@SpringBootTest</span></span> <span class="hljs-meta"><span class="hljs-meta">@ContextConfiguration</span></span>(initializers = {TestcontainersInitializer.class}) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestcontainersSpringDemoApplicationTests</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> UserRepository userRepository; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> User createdUser; <span class="hljs-meta"><span class="hljs-meta">@BeforeEach</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setUp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ createdUser = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User(); createdUser.setName(<span class="hljs-string"><span class="hljs-string">"Fry"</span></span>); userRepository.save(createdUser); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">userRepositoryLoaded</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ assertNotNull(userRepository); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">userAdded</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Optional&lt;User&gt; loadedUser = userRepository.findById(createdUser.getUserId()); assertTrue(loadedUser.isPresent()); assertEquals(<span class="hljs-string"><span class="hljs-string">"Fry"</span></span>, loadedUser.get().getName()); assertNotSame(createdUser, loadedUser.get()); } }</code> </pre> <br><p>  Et oui, ajoutez des d√©pendances √† pom.xml </p><br><pre> <code class="xml hljs"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.testcontainers<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>testcontainers<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>1.12.3<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">scope</span></span></span><span class="hljs-tag">&gt;</span></span>test<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">scope</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.testcontainers<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>oracle-xe<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>1.12.3<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">scope</span></span></span><span class="hljs-tag">&gt;</span></span>test<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">scope</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  Voil√† comment vous pouvez cr√©er une image de docker Oracle DBMS et l'utiliser dans du code Java.  Il ne reste plus qu'√† mettre l'image dans le r√©f√©rentiel d'entreprise des artefacts et √† organiser le lancement des tests dans un autre conteneur docker.  Mais c'est une histoire compl√®tement diff√©rente. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr480106/">https://habr.com/ru/post/fr480106/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr480096/index.html">Fin de l'enfance: droit d'auteur sur les ≈ìuvres cr√©√©es par l'intelligence artificielle (IA)</a></li>
<li><a href="../fr480098/index.html">JH Rainwater "Comment faire pa√Ætre les chats": de l'autre c√¥t√© du d√©veloppement</a></li>
<li><a href="../fr480100/index.html">D√©butants sur le r√©f√©rencement</a></li>
<li><a href="../fr480102/index.html">Sommaire de novembre sur la gestion des produits</a></li>
<li><a href="../fr480104/index.html">9 astuces HTML utiles</a></li>
<li><a href="../fr480108/index.html">La physique dans un projet Unity utilisant le combat mobile comme exemple</a></li>
<li><a href="../fr480110/index.html">uMCPIno: √âcriture d'un protocole simple avec livraison garantie pour Arduino</a></li>
<li><a href="../fr480112/index.html">Diff√©rences entre C ++ / Visual Basic et Java au niveau g√©n√©ral (pour d√©butants et √©tudiants)</a></li>
<li><a href="../fr480114/index.html">Tout sur les taxes pour les ind√©pendants IT. IE et ind√©pendants. Partie 1</a></li>
<li><a href="../fr480116/index.html">Position du groupe Mail.ru sur le d√©veloppement de l'open source en Russie</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>