<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👈🏽 🧖 ◽️ Buildroot: Membuat firmware lintas platform dengan zabbix-server 🤚🏻 😨 🖱️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Riwayat tugas 


 Perusahaan kecil, di satu sisi, membutuhkan pemantauan infrastruktur mereka yang berkualitas tinggi (terutama mengingat adanya virtu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Buildroot: Membuat firmware lintas platform dengan zabbix-server</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/477008/"><p><img src="https://habrastorage.org/webt/zw/xx/fo/zwxxfo_u8w_l057x6clcqrn9h4k.png"></p><br><h2 id="istoriya-zadachi">  Riwayat tugas </h2><br><p>  Perusahaan kecil, di satu sisi, membutuhkan pemantauan infrastruktur mereka yang berkualitas tinggi (terutama mengingat adanya virtualisasi yang meluas), di sisi lain, secara finansial sulit bagi mereka untuk membeli peralatan baru.  Juga, sering ada masalah dengan server / perangkat keras: sering ada 1-3 menara server di sebelah workstation pengguna atau di ceruk / lemari kecil. </p><br><p> Lebih mudah menggunakan perakitan siap pakai (distribusi), yang cukup untuk mengunggah ke kartu microSD dan memasukkannya ke komputer papan tunggal yang umum (beaglebone, raspberry pi dan oranye pi, keluarga papan asus tinker).  Selain itu, peralatan seperti itu tidak mahal dan dapat dipasang di mana saja. </p><a name="habracut"></a><br><h2 id="postanovka-zadachi">  Pernyataan masalah </h2><br><p>  Dalam banyak hal, proyek dikembangkan sebagai semacam pekerjaan laboratorium dengan kemungkinan penerapan hasilnya. </p><br><p>  Zabbix dipilih sebagai sistem pemantauan, karena merupakan sistem yang kuat, gratis dan terdokumentasi dengan baik. </p><br><p>  Pertanyaan muncul dengan tajam pada platform perangkat keras.Menempatkan mesin terpisah di bawah pengawasan juga bukan solusi yang baik - baik itu mahal untuk membeli peralatan baru, atau mencari yang lama + di perusahaan kecil sering terjadi masalah dengan server / perangkat keras. </p><br><p>  Menggunakan sistem buildroot build memungkinkan Anda untuk membuat solusi khusus yang dapat dioperasikan oleh staf dengan pengetahuan minimal tentang keluarga OS Linux.  Sistem ini ramah untuk pemula, tetapi pada saat yang sama memberikan banyak peluang untuk penyesuaian di tangan pengembang berpengalaman.  Ini sempurna untuk menyelesaikan tugas yang tidak mahal, tetapi pemantauan penuh fitur infrastruktur TI, yang minimal menuntut dalam pelatihan personil pengoperasiannya. </p><br><h2 id="shagi-resheniya">  Langkah solusi </h2><br><p>  Pada awalnya diputuskan untuk membuat firmware agar x86_64 berjalan di qemu, karena ini adalah solusi yang nyaman dan cepat untuk debugging.  Kemudian port ke lengan komputer papan tunggal (saya suka papan tinker asus). </p><br><p>  Buildroot dipilih sebagai sistem build.  Awalnya, ini tidak memiliki paket zabbix, jadi saya harus mem-port-nya. Ada masalah dengan lokal Rusia yang diselesaikan dengan menerapkan tambalan yang sesuai (catatan: dalam versi yang lebih baru dari buildroot tambalan ini tidak lagi diperlukan). </p><br><p>  Porting paket zabbix itu sendiri akan dijelaskan dalam artikel terpisah. </p><br><p>  Karena semuanya harus berfungsi sebagai firmware (gambar sistem tidak berubah + file konfigurasi / database yang dapat dipulihkan), Anda perlu menuliskan target, layanan, dan penghitung waktu systemd Anda (target, layanan, timer). </p><br><p>  Diputuskan untuk membagi media menjadi 2 bagian - bagian dengan file sistem dan bagian dengan konfigurasi yang bisa berubah dan file basis data zabbix. </p><br><p>  Ternyata menjadi sedikit lebih sulit untuk menyelesaikan masalah yang terkait dengan database.  Saya tidak ingin menempatkannya langsung di media.  Pada saat yang sama, ukuran pangkalan dapat mencapai ukuran melebihi ukuran ramdisk yang mungkin.  Oleh karena itu, solusi kompromi dipilih: basis data terletak di bagian kedua kartu sd (kartu SLC modern memiliki hingga 30.000 siklus tulis), tetapi ada pengaturan yang memungkinkan Anda untuk menggunakan media eksternal (misalnya, usb-hdd). </p><br><p>  Pemantauan suhu diimplementasikan melalui perangkat RODOS-5.  Tentu saja, Anda dapat menggunakan dallas 1820 secara langsung, tetapi lebih cepat dan lebih mudah untuk memasang USB. </p><br><p>  Grub2 dipilih sebagai bootloader untuk x86_64.  Butuh saya untuk menulis konfigurasi minimal untuk dijalankan. </p><br><p>  Setelah debugging pada qemu, porting ke papan asus tinker dilakukan.  Dalam struktur overlay saya, cross-platforming awalnya diletakkan - pemilihan konfigurasi khusus untuk masing-masing papan (defconfig board, bootloader, generasi gambar dengan partisi sistem) dan keseragaman maksimum dalam penyetelan sistem file / membuat gambar dengan data.  Karena persiapan seperti itu, porting cepat. </p><br><p>  Sangat disarankan agar Anda membaca artikel pendahuluan: <br>  <a href="https://habr.com/ru/post/448638/">https://habr.com/en/post/448638/</a> <br>  <a href="https://habr.com/ru/post/449348/">https://habr.com/en/post/449348/</a> </p><br><h2 id="kak-sobrat">  Cara merakit </h2><br><p>  <a href="https://github.com/skif-web/monitor">Proyek disimpan di github</a> <br>  Setelah kloning repositori, struktur file berikut diperoleh: </p><br><pre><code class="bash hljs">[alexey@comp monitor]$ ls -1 buildroot-2019.05.tar.gz overlay README.md run_me.sh</code> </pre> <br><p>  buildroot-2019.05.tar.gz - arsip buildroot bersih <br>  overlay adalah direktori saya dengan external-tree.  Ini berisi semua yang Anda butuhkan untuk membangun firmware menggunakan buildroot <br>  README.md - deskripsi proyek dan panduan dalam bahasa Inggris. <br>  run_me.sh adalah skrip yang menyiapkan sistem build.  Memperluas buildroot dari arsip, menempelkan overlay padanya (melalui mekanisme eksternal-pohon) dan memungkinkan Anda untuk memilih papan target untuk perakitan </p><br><pre> <code class="bash hljs">[0] my_asus_tinker_defconfig [1] my_beaglebone_defconfig [2] x86_64_defconfig Select defconfig, press A <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> abort. Default [0]</code> </pre> <br><p>  Setelah itu, buka saja direktori buildroot-2019.05 dan jalankan perintah make. <br>  Setelah perakitan selesai, semua hasil perakitan akan berada di direktori output / gambar: </p><br><pre> <code class="bash hljs">[alexey@comp buildroot-2019.05]$ ls -1 output/images/ boot.img boot.vfat bzImage data data.img external.img external.qcow2 grub-eltorito.img grub.img intel-ucode monitor-0.9-beta.tar.gz qemu.qcow2 rootfs.cpio sdcard.img sys update</code> </pre> <br><p>  File yang dibutuhkan: </p><br><ul><li>  sdcard.img - gambar media untuk menulis ke kartu sd (via dd atau rufus di bawah wibdows). </li><li>  qemu.qcow2 - gambar media untuk dijalankan di qemu. </li><li>  external.qcow2 - citra media eksternal untuk basis data </li><li>  monitor-0.9-beta.tar.gz - arsip untuk memperbarui melalui antarmuka web </li></ul><br><h3 id="generaciya-rukovodstv">  Pembuatan Manual </h3><br><p>  Tidak perlu menulis instruksi yang sama beberapa kali.  Dan paling logis untuk menulis sekali dalam penurunan harga, dan kemudian mengonversikannya ke PDF untuk diunduh dan html untuk antarmuka web.  Ini dimungkinkan berkat paket pandoc. </p><br><p>  Pada saat yang sama, Anda perlu membuat semua file ini sebelum gambar sistem dirakit, skrip post-build itu sudah tidak berguna.  Oleh karena itu, generasi dibuat dalam bentuk paket manual.  Anda dapat melihatnya di overlay / paket / manual. </p><br><p>  File manuals.mk (yang melakukan semua pekerjaan) </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">################################################################################ # # manuals # ################################################################################ MANUALS_VERSION:= 1.0.0 MANUALS_SITE:= ${BR2_EXTERNAL_monitorOverlay_PATH}/package/manuals MANUALS_SITE_METHOD:=local define MANUALS_BUILD_CMDS pandoc -s -o ${TARGET_DIR}/var/www/manual_en.pdf ${BR2_EXTERNAL_monitorOverlay_PATH}/../README.md pandoc -f markdown -t html -o ${TARGET_DIR}/var/www/manual_en.html ${BR2_EXTERNAL_monitorOverlay_PATH}/../README.md endef $(eval $(generic-package))</span></span></code> </pre> <br><h3 id="systemd">  systemd </h3><br><p>  Dunia Linux secara aktif pindah ke systemd, dan saya harus melakukannya juga. <br>  Dari inovasi yang bagus - kehadiran pengatur waktu.  Secara umum, artikel terpisah ditulis tentang mereka (dan tidak hanya tentang mereka), tetapi saya akan memberi tahu Anda secara singkat. </p><br><p>  Ada tindakan yang harus dilakukan secara berkala.  Saya perlu menjalankan logrotate untuk menghapus log lighttpd dan php-fpm.  Akan paling umum untuk menulis perintah di cron, tapi saya memutuskan untuk menggunakan timer systemd yang monoton.  Jadi, logrotate dimulai pada interval waktu yang ketat. </p><br><p>  Tentu saja, ada kemungkinan membuat timer yang bekerja pada tanggal tertentu, tetapi saya tidak membutuhkannya. <br>  Timer contoh: </p><br><ul><li>  File pengatur waktu <br><pre> <code class="bash hljs">[Unit] Description=RODOS temp daemon timer</code> </pre> </li></ul><br><p>  [Timer] <br>  OnBootSec = 1 menit <br>  OnUnitActiveSec = 1 menit </p><br><p>  [Instal] <br>  WantedBy = timers.target </p><br><pre> <code class="plaintext hljs">-  ,  : ```bash [Unit] Description=RODOS temp daemon [Service] ExecStart=/usr/bin/rodos.sh</code> </pre> <br><h2 id="podderzhivaemye-platy">  Dewan yang didukung </h2><br><p>  Papan tinker Asus - papan utama di mana semuanya harus bekerja.  Dipilih sebagai yang murah dan sangat kuat. </p><br><p>  Beaglebone black adalah papan pertama di mana pekerjaan itu diuji (selama pemilihan papan yang lebih kuat). </p><br><p>  Qemu x86_64 - digunakan untuk mengembangkan debugging. </p><br><h2 id="kak-rabotaet">  Bagaimana cara kerjanya </h2><br><p>  Saat startup, pemulihan pengaturan dua tahap terjadi: </p><br><ul><li>  menjalankan skrip settings_restore (melalui layanan).  Ini mengembalikan pengaturan sistem dasar - zona waktu, lokal, pengaturan jaringan, dll. </li><li>  menjalankan skrip persiapan (melalui layanan) - di sini zabbix disiapkan, basis data, IP ditampilkan di konsol. </li></ul><br><p>  Pada awal pertama, ukuran bagian kedua kartu sd ditentukan.  Jika masih ada ruang yang tidak terisi - media dipartisi ulang, bagian data menempati semua ruang kosong.  Ini dilakukan untuk mengurangi ukuran gambar instalasi (sdcard.img).  Selain itu, direktori kerja postgresql dibuat pada titik ini.  Itulah sebabnya peluncuran pertama dengan media baru akan lebih lama dari yang berikutnya. </p><br><p>  Ketika Anda menghubungkan drive eksternal, pada saat mulai mencari drive gratis dan format dalam ext4 dengan label eksternal. </p><br><p>  Perhatian!  Saat menghubungkan drive eksternal (serta melepaskan atau menggantinya), Anda perlu membuat cadangan dan mengembalikan pengaturan! </p><br><p>  Untuk memantau suhu, perangkat RODOS 5. digunakan. Pabrikan memberikan sumber utilitasnya untuk bekerja dengan perangkat.  Ketika sistem dihidupkan, timer rodos dimulai, yang meluncurkan utilitas ini satu menit sekali.  Suhu saat ini ditulis ke file / tmp / rodos_current_temp, setelah itu zabbix dapat memonitor file ini sebagai sensor. </p><br><p>  Media penyimpanan untuk konfigurasi sudah terpasang di direktori / data. </p><br><p>  Saat Anda memulai sistem dan mempersiapkannya untuk bekerja, sebuah pesan muncul di konsol: </p><br><pre> <code class="bash hljs">System starting, please <span class="hljs-built_in"><span class="hljs-built_in">wait</span></span></code> </pre> <br><p>  Setelah menyelesaikan pekerjaan persiapan, itu akan berubah untuk menampilkan alamat IP: </p><br><pre> <code class="bash hljs">current ip 192.168.1.32 Ready to work</code> </pre> <br><h2 id="nastroyka-zabbix-dlya-monitoringa-temperatury">  Mengkonfigurasi zabbix untuk pemantauan suhu </h2><br><p>  Untuk memantau suhu, cukup lakukan 2 langkah: </p><br><ul><li>  sambungkan perangkat RODOS ke port usb </li><li>  buat item data dalam zabbix </li></ul><br><p>  Buka antarmuka web zabbix: </p><br><ul><li>  Buka bagian Konfigurasi → Host </li><li>  Klik pada Item di baris server zabbix kami </li><li>  Klik pada Buat item </li></ul><br><p><img src="https://habrastorage.org/webt/wg/7r/5r/wg7r5rphxeb8pf-p04j9n89h_w4.png"></p><br><p>  Masukkan data berikut: </p><br><ul><li>  name - sesuai kebijaksanaan Anda (misalnya, serverRoomTemp) </li><li>  Jenis - agen zabbix </li><li>  Kunci - rodo </li><li>  Ketik - numerik </li><li>  Unit - C </li><li>  Periode penyimpanan histori - istilah histori.  tersisa 10 hari </li><li>  Tren periode penyimpanan - periode penyimpanan dinamika perubahan.  Tersisa 30 hari </li><li>  Aplikasi baru - server Temp Room </li></ul><br><p>  Dan tekan tombol ADD. <br><img src="https://habrastorage.org/webt/to/ym/bt/toymbti2klzkuwdkn6whrar2veu.png"></p><br><h2 id="upravlenie-nastroykami-cherez-veb-interfeys">  Manajemen Berbasis Web </h2><br><p>  Antarmuka web ditulis dalam php.  Ada fungsi utama: </p><br><ul><li>  lihat status perangkat </li><li>  ubah pengaturan jaringan <br><img src="https://habrastorage.org/webt/jq/g_/mh/jqg_mh6ujouewhlfkbcfr9vzfwq.png"></li><li>  ubah kata sandi pengguna </li><li>  pemilihan zona waktu </li><li>  backup / restore / reset ke pengaturan pabrik </li><li>  kemampuan untuk menghubungkan drive eksternal </li><li>  Pembaruan sistem <br><img src="https://habrastorage.org/webt/zr/4k/sj/zr4ksjhttcoapjntsivihrofwue.png"></li></ul><br><p>  Login ke antarmuka web dilindungi kata sandi.  Halaman awal - manual. </p><br><p>  Alamat antarmuka Zabbix: \ $ {ip / dns} / zabbix <br>  Alamat Antarmuka Manajemen: \ $ {ip / dns} / manage <br><img src="https://habrastorage.org/webt/os/cz/f7/osczf71wkg4jgzhmhmcfzceyyw0.png"></p><br><h2 id="zapusk-v-qemu">  Jalankan di qemu </h2><br><p>  qemu-system-x86_64 -smp 4 -m 4026M -enable-kvm -machine q35, accel = kvm-service intel-iommu -cpu host -net nic -net bridge, br = bridge0 -device virtio-scsi-pci, id = scsi0 -drive file = output / images / qemu.qcow2, format = qcow2, aio = utas-alat virtio-scsi-pci, id = scsi0 -drive file = output / images / external.qcow2, format = qcow2, aio = utas </p><br><p>  Perintah ini akan memulai sistem dengan 4 core, 2048 RAM diaktifkan oleh KVM, kartu jaringan pada bridge0 dan dua disk: untuk sistem dan eksternal untuk postgresql. </p><br><p>  Gambar dapat dikonversi dan dijalankan di Virtualbox: </p><br><pre> <code class="bash hljs">qemu-img convert -f qcow2 qemu.qcow2 -O vdi qcow2.vdi qemu-img convert -f qcow2 external.qcow2 -O vdi external.vdi</code> </pre> <br><p>  Kemudian impor mereka ke virtualbox dan sambungkan melalui sata. </p><br><p>  Kesimpulan </p><br><p>  Dalam prosesnya, saya menjadi tertarik untuk membuat produk siap bekerja - dengan antarmuka yang tidak terlalu bagus (saya tidak suka menulisnya), tetapi berfungsi dan mudah dikonfigurasikan. </p><br><p>  Upaya terakhir untuk menginstal zabbix-appliance di KVM menunjukkan kebenaran langkah ini (sistem tidak memulai setelah instalasi selesai).  Mungkin saya melakukan sesuatu yang salah;) </p><br><hr><br><p>  <a href="https://www.zabbix.com/documentation/4.2/ru/manual">Material</a> </p><br><p>  <a href="https://buildroot.org/">https://buildroot.org/</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id477008/">https://habr.com/ru/post/id477008/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id476998/index.html">Kubernetes 1.17: Tinjauan Umum Inovasi-inovasi Utama</a></li>
<li><a href="../id477000/index.html">Cara meningkatkan akurasi sensor</a></li>
<li><a href="../id477002/index.html">Bagaimana kami menjadi tuan rumah 8chan imageboard yang memalukan</a></li>
<li><a href="../id477004/index.html">Energi Matahari Asin</a></li>
<li><a href="../id477006/index.html">Apakah Java bahasa pemrograman terbaik untuk pemula?</a></li>
<li><a href="../id477010/index.html">Slurm Mega. Instalasi cluster siap produksi, 3 tips berguna untuk speaker dan Slurm dengan Luke Skyoker dan R2D2</a></li>
<li><a href="../id477014/index.html">Anak-anak di Internet: cara memastikan keamanan siber dari pengguna yang paling rentan</a></li>
<li><a href="../id477016/index.html">Mengapa kita pergi ke konferensi ilmiah?</a></li>
<li><a href="../id477018/index.html">Retas mekanisme privasi Mimblewimble</a></li>
<li><a href="../id477020/index.html">Menilai siapa pun dengan sentuhan tombol</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>