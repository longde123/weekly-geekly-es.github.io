<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤜 🕡 🤞🏼 Gateway für UDP zwischen Wi-Fi und LoRa 💺 🥚 🤶🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Wir stellen das Gateway zwischen Wi-Fi und LoRa für UDP her 





 Ich hatte einen Kindheitstraum - jedem „Wi-Fi-freien“ Haushaltsgerät ein Netzwerkti...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Gateway für UDP zwischen Wi-Fi und LoRa</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/482080/"><h1 id="delaem-shlyuz-mezhdu-wi-fi-i-lora-dlya-udp">  Wir stellen das Gateway zwischen Wi-Fi und LoRa für UDP her </h1><br><p><img src="https://habrastorage.org/webt/7r/6w/qs/7r6wqsteous5ebxb2pjrlplmqbm.png"></p><br><p>  Ich hatte einen Kindheitstraum - jedem „Wi-Fi-freien“ Haushaltsgerät ein Netzwerkticket zu geben, das heißt eine IP-Adresse und einen Port.  Nach einiger Zeit wurde mir klar, dass ich es nicht aufschieben sollte.  Wir müssen nehmen und tun. </p><br><h2 id="tehnicheskoe-zadanie">  Technische Aufgabe </h2><br><p>  Machen Sie es zu einem M5Stack-Gateway mit installiertem LoRa-Modul (Abbildung 1).  Das Gateway wird mit einem Wi-Fi-Netzwerk verbunden, in dem über DHCP eine lokale IP-Adresse abgerufen werden kann.  Das Gateway sendet seinen Namen in LoRa-Ether mit einer bestimmten Frequenz (analog zu SSID für Wi-Fi) und dem Bereich akzeptabler Ports, damit andere Geräte wissen, dass es ein solches Netzwerk gibt, zu dem Sie eine Verbindung herstellen können, und in welchem ​​Bereich Sie einen freien Port auswählen können.  Da dies ein Prototyp sein wird, findet diesmal keine Authentifizierung statt.  Neue Client-Geräte finden ein verfügbares LoRa-Netzwerk und übertragen den ausgewählten Port an dieses.  Nachdem das Gateway einen Port von einem neuen Client erhalten hat, prüft es, ob dieser frei ist. In diesem Fall registriert es einen neuen Client und beginnt, diesen Port auf seinem eigenen asynchronen UDP-Server abzuhören.  Nach der Registrierung erhält der Kunde eine Einwilligung oder Verweigerung der Nutzung des angegebenen Hafens.  Die Arbeitsweise ist in Tabelle 1 dargestellt. </p><br><p><img src="https://habrastorage.org/webt/cz/am/ab/czamabsepozwcixjn0rdwe7hmw8.png"><br>  Abbildung 1 </p><br><p>  Tabelle 1 </p><br><div class="scrollable-table"><table><thead><tr><th>  Seite </th><th>  Richtung und Daten </th><th>  Seite </th><th>  die Sitzung </th></tr></thead><tbody><tr><td>  [Kunde] </td><td>  &lt;- Bakensignal - </td><td>  [gateway] </td><td>  0xA1 </td></tr><tr><td>  [Kunde] </td><td>  - ausgewählter Hafen -&gt; </td><td>  [gateway] </td><td>  0xB1 </td></tr><tr><td>  [Kunde] </td><td>  &lt;- Zustimmung oder Ablehnung - </td><td>  [gateway] </td><td>  0xA2 </td></tr><tr><td>  [Kunde] </td><td>  - UPD-Paket -&gt; </td><td>  [gateway] </td><td>  0xB2 </td></tr><tr><td>  [Kunde] </td><td>  &lt;- UPD-Paket - </td><td>  [gateway] </td><td>  0xA3 </td></tr><tr><td>  [Netzwerk] </td><td>  &lt;- UPD-Paket - </td><td>  [gateway] </td><td>  0xC1 </td></tr></tbody></table></div><br><p>  Vor mir auf dem Tisch liegen alle möglichen Module für den M5Stack und langweilen sich.  Nehmen wir LoR <del>  und viel spaß mit ihr </del>  .  Das Modulkonzept selbst ist wunderschön!  Was soll ich sagen  Aber die Module meiner ersten Revision, in denen eine schreckliche Antenne verbaut ist, wurden auf eine flexible Leiterplatte geklebt und an die Seitenwand des Gehäuses geklebt.  Ich habe einmal Feldversuche mit solchen Modulen durchgeführt (Sie können sie auf dem russischsprachigen Kanal auf YouTube ansehen): </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/2mWAu6X_v-U" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  Natürlich musste ich diese Rudimente entfernen und die Standard-Wendelantennen löten, die mit dem Ra-01 geliefert wurden.  Nach einer solchen Anpassung verbesserte sich die Kommunikationsreichweite merklich, es trat jedoch ein Seitenpunkt auf - die Antenne hat einen Durchmesser, der größer ist als der zulässige Abstand zwischen den Modulen.  Ich musste das Final-Modul für die Dauer des Projekts aufgeben. </p><a name="habracut"></a><br><h2 id="pervye-trudnosti-ot-sihronnoy-tugosti">  Erste Schwierigkeiten <del>  von der synchronen Dichtheit </del></h2><br><p>  Es scheint, dass die <strong>WiFiUdp.h-</strong> Bibliothek, in der alles für die komfortable Existenz eines UDP-Servers steht, nein.  Die Bibliothek dient zum Aufheben eines synchronen Servers, der leider nicht mehrere Verbindungen gleichzeitig bedienen kann.  Eine solche Bibliothek ist für die aktuelle Aufgabe nicht geeignet.  Ich musste eine Menge Tee trinken und nach einer Bibliothek suchen, mit der wir einen asynchronen UDP-Server aufbauen konnten, der viele Verbindungen gleichzeitig unterstützen konnte.  Eine solche Bibliothek wurde gefunden - <strong>AsyncUDP.h</strong> .  Was ist der Unterschied zwischen einem synchronen und einem asynchronen Server?  Werfen wir einen Blick auf sechs Folgen in Abbildung 2, in denen die Optionen für den Socket-Betrieb trivial angezeigt werden. </p><br><p><img src="https://habrastorage.org/webt/fa/ay/fv/faayfvfxtqvi8nu5s_ks4ssbava.jpeg"></p><br><p>  Abbildung 2 </p><br><p>  Darsteller: </p><br><p>  <strong>Ein Mann</strong> in der Rolle einer <strong>Steckdose</strong> ; </p><br><p>  <strong>Taube</strong> in der Rolle der <strong>Verbindung</strong> ; </p><br><p>  <strong>Pismo</strong> als <strong>Daten</strong> . </p><br><h3 id="epizod-a-sinhronnyy-soket-bez-taymauta">  Folge A. Synchroner Socket ohne Timeout </h3><br><p>  Eine Person wird stehen, bis die Taube ihm einen Brief bringt. </p><br><h3 id="epizod-b-sinhronnyy-soket-s-taymautom">  Folge B. Synchroner Socket mit Timeout </h3><br><p>  Ein Mann wartet auf die mit der Taube vereinbarte Zeit, und wenn er nicht rechtzeitig ankommt, wird der Mann gehen. </p><br><h3 id="epizod-c-sinhronnyy-soket-s-mnogopotochnostyu">  Folge C. Synchroner Multithreading-Socket </h3><br><p>  Ein Mann räkelt sich und beobachtet, wie die Tauben selbst Briefe ausliefern. </p><br><h3 id="epizod-d-asinhronnyy-soket-kogda-nechego-eschyo-poluchat">  Episode D. Asynchroner Socket (wenn nichts anderes zu empfangen ist) </h3><br><p>  Ein Mann macht seine Lieblingssachen, vergisst aber nicht die Tauben. </p><br><h3 id="epizod-e-asinhronnyy-soket-kogda-est-chto-poluchit">  Episode E. Asynchroner Socket (wenn etwas zu empfangen ist) </h3><br><p>  Der Mann ließ sich kurz von seinen Angelegenheiten ablenken, um einen Brief von der Taube zu erhalten. </p><br><h3 id="epizod-f-asinhronnyy-soket-s-mnogopotochnostyu">  Episode F. Asynchroner Multithreading-Socket </h3><br><p>  Ein Mann geht seinem Geschäft nach und sieht zu, wie die Tauben selbst Briefe ausliefern. </p><br><p>  Wenn Sie vorsichtig waren, sollten Sie wahrscheinlich bemerkt haben, dass die Halsbänder der Tauben in jeder Episode eine bestimmte Farbe haben.  Und das ist kein Zufall.  In Folge A und B funktioniert nur ein Socket auf dem Server, und das war's.  Episode C hat bereits zwei Steckdosen.  Die Folgen D, E und F haben bereits drei Buchsen.  "Warum gibt es zwei, aber hier sind drei?"  - Du fragst.  Dies ist bedingt 2 und 3, statt 2 können es 20 und statt drei 200 sein. Die Aufgabe besteht darin, zu zeigen, dass asynchrone Steckdosen nicht so viel Eisen verbrennen wie synchrone. </p><br><h2 id="kuda-skolko-chego-vmeschaetsya">  Wo passt was? </h2><br><p>  Schauen wir uns Tabelle 1 an, die die Struktur des UDP-Pakets zeigt, und überlegen, was Sie dagegen tun können. </p><br><p>  Tabelle 1. UDP-Paketstruktur </p><br><div class="scrollable-table"><table><thead><tr><th>  Bits </th><th>  0 - 15 </th><th>  16 - 31 </th></tr></thead><tbody><tr><td>  0-31 </td><td>  Quellport </td><td>  Zielhafen </td></tr><tr><td>  32-63 </td><td>  Datagrammlänge </td><td>  Prüfsumme </td></tr><tr><td>  64 -... </td><td>  Daten </td><td></td></tr></tbody></table></div><br><p>  Fügen Sie ganz am Anfang dieser Tabelle ein weiteres <strong>Sitzungsfeld</strong> (1 Byte) hinzu.  Das reicht für dieses Projekt.  Basierend auf der Sitzung weiß das Gerät, was als nächstes mit dem Paket zu tun ist.  Jetzt werden wir Codes für die Sitzungen ausarbeiten und diese in Tabelle 2 schreiben. </p><br><p>  Tabelle 2. Sitzungsbeschreibung </p><br><div class="scrollable-table"><table><thead><tr><th>  Code </th><th>  Titel </th><th>  Erklärung </th></tr></thead><tbody><tr><td>  0xA1 </td><td>  Leuchtturm </td><td>  Das Gateway sendet den Namen des LoRa-Netzwerks und den Bereich der zulässigen Ports mit einer bestimmten Frequenz.  Dies ist erforderlich, damit neue Clients das verfügbare Netzwerk sehen und aktuelle Clients, wenn keine Übertragungen vorliegen, den Signalpegel bestimmen können. </td></tr><tr><td>  0xB1 </td><td>  Bewerbung </td><td>  Wenn der Client das Netzwerk findet, sendet er den bevorzugten Port. </td></tr><tr><td>  0xA2 </td><td>  Zustimmung oder Ablehnung </td><td>  Wenn der vom Client angeforderte Port frei ist, antwortet der Server mit Zustimmung und andernfalls mit einer Ablehnung. </td></tr><tr><td>  0xB2 </td><td>  Link nach oben </td><td>  Wenn der Client das UDP-Paket an das Gateway sendet. </td></tr><tr><td>  0xA3 </td><td>  Downlink </td><td>  Wenn das Gateway das UDP-Paket an den Client sendet. </td></tr><tr><td>  0xC1 </td><td>  Fortsetzung Up-Link </td><td>  Wenn das Gateway ein UDP-Paket an das lokale Netzwerk sendet. </td></tr></tbody></table></div><br><p>  Gut  Besprechen wir nun die Zusammensetzung der Sitzungen in Tabelle 3. </p><br><p>  Tabelle 3. Sitzungen </p><br><div class="scrollable-table"><table><thead><tr><th>  Sitzungsname </th><th>  Zusammensetzung </th></tr></thead><tbody><tr><td>  Leuchtturm </td><td>  Sitzungscode (1 Byte) + LoRa-Netzwerkname (4 Byte) + Startport (2 Byte) + Endport (2 Byte) </td></tr><tr><td>  Bewerbung </td><td>  Übertragungscode (1 Byte) + LoRa-Netzwerkname (4 Byte) + Bevorzugter Port (2 Byte) </td></tr><tr><td>  Zustimmung oder Ablehnung </td><td>  Übertragungscode (1 Byte) + LoRa-Netzwerkname (4 Byte) + Bevorzugter Port (2 Byte) + Ergebnis (1 Byte) </td></tr><tr><td>  Link nach oben </td><td>  Übertragungscode (1 Byte) + LoRa-Netzwerkname (4 Byte) + Remote-IP-Adresse (4 Byte) + Remote-Port (2 Byte) + Lokale IP-Adresse (4 Byte) + Lokaler Port (2 Byte) + Datengröße (2 Bytes) + Daten </td></tr><tr><td>  Downlink </td><td>  Übertragungscode (1 Byte) + LoRa-Netzwerkname (4 Byte) + Remote-IP-Adresse (4 Byte) + Remote-Port (2 Byte) + Lokale IP-Adresse (4 Byte) + Lokaler Port (2 Byte) + Datengröße (2 Bytes) + Daten </td></tr><tr><td>  Fortsetzung Up-Link </td><td>  Remote-IP-Adresse (4 Byte) + Remote-Port (2 Byte) + Datengröße (2 Byte) + Daten </td></tr></tbody></table></div><br><p>  Schrieb zwei Clients für Arduino und für M5Stack.  Wie das geht, sehen Sie im <a href="https://youtu.be/g4aHpgWcJnY" rel="nofollow">Video</a> .  Es gibt keine Probleme in der Wohnung, ich habe noch keine Feldtests durchgeführt. </p><br><p>  Der Quellcode ist auf GitHub unter verfügbar </p><br><p>  Erfahren Sie mehr über die M5Stack Base Unit und kaufen Sie <a href="http://ru.m5stack.com/%3Fsearch%3D%25D0%25BA%25D0%25BB%25D0%25B0%25D1%2581%25D1%2581%25D0%25B8%25D1%2587%25D0%25B5%25D1%2581%25D0%25BA%25D0%25B8%25D0%25B9" rel="nofollow">hier.</a> </p><br><p>  Hier können Sie LoRa-Funkmodule für die Basiseinheit auswählen </p><br><p>  <strong>Ich freue mich, wenn dieses Projekt für Sie nützlich ist.</strong>  <strong>Vielen Dank für Ihre Zeit!</strong> </p><br><p>  Referenzen und (oder) Quellen: </p><br><ul><li>  <a href="https://qna.habr.com/q/388343" rel="nofollow">Habr Q &amp; A "Was ist ein asynchroner Socket?"</a> </li><li>  <a href="https://ru.wikipedia.org/wiki/UDP" rel="nofollow">Wikipedia "UDP"</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de482080/">https://habr.com/ru/post/de482080/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de482066/index.html">Ersetzen Sie User Story durch Job Story</a></li>
<li><a href="../de482068/index.html">Muss ich ein RAID-Array aus SSD erstellen und welche Controller werden dafür benötigt?</a></li>
<li><a href="../de482070/index.html">Fünf Gewohnheiten, die zur Aufrechterhaltung der Gehirnleistung beitragen</a></li>
<li><a href="../de482076/index.html">Kunden vertrauen asoshnikov</a></li>
<li><a href="../de482078/index.html">Risiken von IT-Projekten und IT-Teams</a></li>
<li><a href="../de482084/index.html">Was an Feiertagen zu lesen</a></li>
<li><a href="../de482086/index.html">Bootkit-Analyse</a></li>
<li><a href="../de482088/index.html">Umarmung für Entwickler oder wie ich zu KotlinConf kam</a></li>
<li><a href="../de482092/index.html">Was braucht der Blinde? Rückblick auf den taubblinden Experten Sergei Fleitin</a></li>
<li><a href="../de482094/index.html">Software Architect: Warum wird es benötigt und was ist sein Fluch</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>