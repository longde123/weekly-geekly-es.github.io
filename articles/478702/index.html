<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëçüèæ ‚ò¢Ô∏è üöõ Trucos de procesamiento m√©trico en Kapacitor üßòüèª üëÉüèΩ ‚è∫Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Lo m√°s probable es que hoy nadie tenga una pregunta de por qu√© necesitan recopilar m√©tricas de servicio. El siguiente paso l√≥gico es configurar la ale...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Trucos de procesamiento m√©trico en Kapacitor</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ostrovok/blog/478702/">  Lo m√°s probable es que hoy nadie tenga una pregunta de por qu√© necesitan recopilar m√©tricas de servicio.  El siguiente paso l√≥gico es configurar la alerta para las m√©tricas recopiladas, que le notificar√° sobre cualquier desviaci√≥n en los datos en los canales convenientes para usted (correo, Slack, Telegram).  En el servicio de reserva en l√≠nea de los hoteles <a href="https://www.habr.com/%3Futm_source%3Dhabr%26utm_medium%3Dpr%26utm_campaign%3DErmolaev_dec19%26utm_content%3Darticle">Ostrovok.ru</a> , todas las m√©tricas de nuestros servicios se vierten en InfluxDB y se muestran en Grafana, all√≠ tambi√©n se establece una alerta b√°sica.  Para tareas como "necesita calcular algo y compararlo", utilizamos Kapacitor. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/oe/cl/5h/oecl5hgip8nkmeau21l2qaem8ek.png"></div><br>  Kapacitor es parte de la pila TICK que puede manejar m√©tricas de InfluxDB.  Puede conectar varias dimensiones entre s√≠ (unirse), calcular algo √∫til a partir de los datos recibidos, escribir el resultado en InfluxDB, enviar una alerta a Slack / Telegram / mail. <br><br>  Toda la pila tiene <a href="">documentaci√≥n</a> interesante y detallada, pero siempre hay cosas √∫tiles que no se especifican expl√≠citamente en los manuales.  En este art√≠culo, decid√≠ recopilar una serie de consejos √∫tiles y no obvios ( <a href="https://docs.influxdata.com/kapacitor/v1.5/tick/syntax/">aqu√≠</a> se describe la sintaxis b√°sica de TICKscipt) y mostrar c√≥mo se pueden aplicar, usando un ejemplo para resolver uno de nuestros problemas. <br><br>  Vamos! <br><a name="habracut"></a><br><h4>  float &amp; int, errores de c√°lculo </h4><br>  Problema absolutamente est√°ndar, se resuelve a trav√©s de castas: <br><br><pre><code class="python hljs">var alert_float = <span class="hljs-number"><span class="hljs-number">5.0</span></span> var alert_int = <span class="hljs-number"><span class="hljs-number">10</span></span> data|eval(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>: float(<span class="hljs-string"><span class="hljs-string">"value"</span></span>) &gt; alert_float OR float(<span class="hljs-string"><span class="hljs-string">"value"</span></span>) &lt; float(<span class="hljs-string"><span class="hljs-string">"alert_int"</span></span>))</code> </pre> <br><h4>  Usando default () </h4><br>  Si la etiqueta / campo no est√° llena, se producir√°n errores en los c√°lculos: <br><br><pre> <code class="python hljs">|default() .tag(<span class="hljs-string"><span class="hljs-string">'status'</span></span>, <span class="hljs-string"><span class="hljs-string">'empty'</span></span>) .field(<span class="hljs-string"><span class="hljs-string">'value'</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>)</code> </pre><br><h4>  rellenar unirse (interior vs exterior) </h4><br>  De manera predeterminada, join soltar√° puntos donde no hay datos (internos). <br>  Con fill ('null'), se ejecutar√° la uni√≥n externa, despu√©s de lo cual debe hacer default () y completar los valores vac√≠os: <br><br><pre> <code class="python hljs">var data = res1 |join(res2) .<span class="hljs-keyword"><span class="hljs-keyword">as</span></span>(<span class="hljs-string"><span class="hljs-string">'res1'</span></span>, <span class="hljs-string"><span class="hljs-string">'res2) .fill('</span></span>null<span class="hljs-string"><span class="hljs-string">') |default() .field('</span></span>res1.value<span class="hljs-string"><span class="hljs-string">', 0.0) .field('</span></span>res2.value<span class="hljs-string"><span class="hljs-string">', 100.0)</span></span></code> </pre><br>  Todav√≠a hay un matiz.  Si en el ejemplo anterior una de las series (res1 o res2) est√° vac√≠a, la serie final (datos) tambi√©n estar√° vac√≠a.  Hay varias entradas sobre este tema en el github ( <a href="https://github.com/influxdata/kapacitor/issues/1633">1633</a> , <a href="https://github.com/influxdata/kapacitor/issues/1871">1871</a> , <a href="https://github.com/influxdata/influxdb/issues/6967">6967</a> ): estamos esperando soluciones y sufrimos un poco. <br><br><h4>  Uso de condiciones en los c√°lculos (si est√° en lambda) </h4><br><pre> <code class="python hljs">|eval(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-string"><span class="hljs-string">"value"</span></span> &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, true, false)</code> </pre><br><h4>  Los √∫ltimos cinco minutos desde la tuber√≠a durante el per√≠odo </h4><br>  Por ejemplo, debe comparar los valores de los √∫ltimos cinco minutos con la semana anterior.  Puede tomar dos paquetes de datos con dos lotes separados o extraer parte de los datos de un per√≠odo mayor: <br><br><pre> <code class="python hljs"> |where(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>: duration((unixNano(now()) - unixNano(<span class="hljs-string"><span class="hljs-string">"time"</span></span>))/<span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>u) &lt; <span class="hljs-number"><span class="hljs-number">5</span></span>m)</code> </pre><br>  Una alternativa para los √∫ltimos cinco minutos podr√≠a ser usar el nodo BarrierNode, que corta los datos antes del tiempo especificado: <br><br><pre> <code class="python hljs">|barrier() .period(<span class="hljs-number"><span class="hljs-number">5</span></span>m)</code> </pre><br><h2>  Ejemplos de uso de patrones de Go'sh en el mensaje </h2><br>  Las plantillas corresponden al formato del paquete <a href="https://golang.org/pkg/text/template/">text.template</a> , a continuaci√≥n se presentan algunas tareas comunes. <br><br><h4>  si m√°s </h4><br>  Ponemos las cosas en orden, no activamos a las personas con el texto una vez m√°s: <br><br><pre> <code class="python hljs">|alert() ... .message( <span class="hljs-string"><span class="hljs-string">'{{ if eq .Level "OK" }}It is ok now{{ else }}Chief, everything is broken{{end}}'</span></span> )</code> </pre><br><h4>  Dos decimales en el mensaje </h4><br>  Mejora de la legibilidad del mensaje: <br><br><pre> <code class="python hljs">|alert() ... .message( <span class="hljs-string"><span class="hljs-string">'now value is {{ index .Fields "value" | printf "%0.2f" }}'</span></span> )</code> </pre><br><h4>  Expandiendo variables en mensaje </h4><br>  Mostramos m√°s informaci√≥n en el mensaje para responder la pregunta "¬øPor qu√© est√° gritando?" <br><br><pre> <code class="python hljs">var warnAlert = <span class="hljs-number"><span class="hljs-number">10</span></span> |alert() ... .message( <span class="hljs-string"><span class="hljs-string">'Today value less then '</span></span>+string(warnAlert)+<span class="hljs-string"><span class="hljs-string">'%'</span></span> )</code> </pre><br><h4>  Identificador √∫nico de alerta </h4><br>  Lo correcto cuando hay m√°s de un grupo en los datos, de lo contrario solo se generar√° una alerta: <br><br><pre> <code class="python hljs">|alert() ... .id(<span class="hljs-string"><span class="hljs-string">'{{ index .Tags "myname" }}/{{ index .Tags "myfield" }}'</span></span>)</code> </pre><br><h4>  Manejador personalizado </h4><br>  La gran lista de controladores tiene exec, que le permite ejecutar su script con los par√°metros pasados ‚Äã‚Äã(stdin): ¬°creatividad y m√°s! <br><br>  Una de nuestras herramientas personalizadas es un peque√±o script de Python para enviar notificaciones a Slack. <br>  Primero, quer√≠amos enviar una imagen de una grafana protegida por autorizaci√≥n en el mensaje.  Despu√©s: escriba OK en el hilo en la alerta anterior del mismo grupo, y no como un mensaje separado.  Un poco m√°s tarde: para agregar el mensaje de error m√°s com√∫n en los √∫ltimos X minutos. <br><br>  Un tema separado es la comunicaci√≥n con otros servicios y cualquier acci√≥n iniciada por una alerta (solo si su monitoreo funciona lo suficientemente bien). <br>  Un ejemplo de una descripci√≥n de un controlador, donde slack_handler.py es nuestro script auto-escrito: <br><br><pre> <code class="python hljs">topic: slack_graph id: slack_graph.alert match: level() != INFO AND changed() == TRUE kind: <span class="hljs-keyword"><span class="hljs-keyword">exec</span></span> options: prog: /sbin/slack_handler.py args: [<span class="hljs-string"><span class="hljs-string">"-c"</span></span>, <span class="hljs-string"><span class="hljs-string">"CHANNELID"</span></span>, <span class="hljs-string"><span class="hljs-string">"--graph"</span></span>, <span class="hljs-string"><span class="hljs-string">"--search"</span></span>]</code> </pre><br><h2>  ¬øC√≥mo debutar? </h2><br><h4>  Opci√≥n de salida de registro </h4><br><pre> <code class="python hljs">|log() .level(<span class="hljs-string"><span class="hljs-string">"error"</span></span>) .prefix(<span class="hljs-string"><span class="hljs-string">"something"</span></span>)</code> </pre><br>  Watch (cli): kapacitor -url <a href="http://host-or-ip/">host-or-ip</a> : 9092 logs lvl = error <br><br><h4>  Variante con httpOut </h4><br>  Muestra datos en la tuber√≠a actual: <br><br><pre> <code class="python hljs">|httpOut(<span class="hljs-string"><span class="hljs-string">'something'</span></span>)</code> </pre><br>  Watch (get): <a href="http://host-or-ip/">host-or-ip</a> : 9092 / kapacitor / v1 / task / task_name / something <br><br><h4>  Esquema de ejecuci√≥n </h4><br><ul><li>  Cada tarea devuelve un √°rbol de ejecuci√≥n con n√∫meros √∫tiles en formato <a href="https://www.graphviz.org/">graphviz</a> . </li><li>  Toma el bloque de <a href="http://host-or-ip:9092/kapacitor/v1/tasks/task_name%3Fdot-view%3Dlabels">puntos</a> . </li><li>  Nos insertamos en el visor, <a href="https://dreampuf.github.io/GraphvizOnline">disfrutamos</a> . <br></li></ul><br><br><h2>  ¬øD√≥nde m√°s puedo conseguir un rastrillo? </h2><br><h4>  marca de tiempo de influxdb en reescritura </h4><br>  Por ejemplo, configuramos una alerta para la suma de solicitudes por hora (groupBy (1h)) y queremos registrar el incidente en influxdb (para mostrar maravillosamente el hecho de un problema en el gr√°fico en grafana). <br><br>  influxDBOut () escribir√° el valor de tiempo de la alerta en la marca de tiempo, respectivamente, el punto en el gr√°fico se registrar√° antes / despu√©s de la alerta. <br><br>  Cuando se requiere precisi√≥n: evitamos este problema llamando a un controlador personalizado, que escribir√° datos para influxdb con la marca de tiempo actual. <br><br><h4>  acoplador, construir y desplegar </h4><br>  Al inicio, kapacitor puede cargar tareas, plantillas y manejadores desde el directorio especificado en la configuraci√≥n en el bloque [cargar]. <br><br>  Para crear una tarea correctamente, se necesitan las siguientes cosas: <br><br><ol><li>  Nombre de archivo: se expande al nombre de id / script </li><li>  Tipo - flujo / lote </li><li>  dbrp: palabra clave para indicar en qu√© base de datos + pol√≠tica funciona el script (dbrp "proveedor". "autogen") </li></ol><br>  Si no hay una l√≠nea con dbrp en alguna tarea por lotes, todo el servicio se negar√° a comenzar y honestamente escribir√° sobre ello en el registro. <br><br>  En chronograf, por el contrario, esta l√≠nea no debe ser, no se acepta a trav√©s de la interfaz y arroja un error. <br><br>  Hackear al compilar el contenedor: Dockerfile sale con -1 si hay l√≠neas con //.+dbrp, que comprender√° de inmediato el motivo del archivo al compilar la compilaci√≥n. <br><br><h4>  une uno a muchos </h4><br>  Tarea de ejemplo: debe tomar el percentil 95 del tiempo de funcionamiento del servicio por semana, comparar cada minuto de los √∫ltimos 10 con este valor. <br><br>  No puede unir uno a muchos, la √∫ltima / media / mediana por grupo de puntos convierte el nodo en secuencia, el error "no puede agregar bordes secundarios no coincidentes: lote -&gt; secuencia" volver√°. <br><br>  El resultado del lote, como una variable en una expresi√≥n lambda, tampoco se sustituye. <br><br>  Hay una opci√≥n para guardar los n√∫meros necesarios del primer lote en un archivo a trav√©s de udf y cargar este archivo a trav√©s de la carga lateral. <br><br><h2>  ¬øQu√© decidimos? </h2><br>  Tenemos alrededor de 100 proveedores de hoteles, cada uno de ellos puede tener varias conexiones, llam√©moslo canal.  Hay aproximadamente 300 de estos canales; cada uno de los canales puede caerse.  De todas las m√©tricas registradas, supervisaremos la tasa de error (solicitudes y errores). <br><br><h4>  ¬øPor qu√© no grafana? </h4><br>  Las alertas de error configuradas en grafan tienen varias desventajas.  Algunos cr√≠ticos, otros pueden cerrar los ojos, dependiendo de la situaci√≥n. <br><br>  Grafana no sabe c√≥mo calcular entre dimensiones + alerta, pero necesitamos una tasa (peticiones-errores) / solicitudes. <br><br>  Los errores parecen viciosos: <br><br><img src="https://habrastorage.org/webt/iq/0h/nq/iq0hnqauk_l0nm4akwynyeb0hbc.png"><br><br>  Y menos vicioso cuando se ve con solicitudes exitosas: <br><br><img src="https://habrastorage.org/webt/mw/vs/ok/mwvsok9hb7qfa3lifpna4_rrno4.png"><br><br>  De acuerdo, podemos calcular previamente la tasa en el servicio antes de grafana, y en algunos casos lo har√°.  Pero no la nuestra, porque  para cada canal, su relaci√≥n se considera "normal" y las alertas funcionan de acuerdo con valores est√°ticos (miramos con los ojos, cambiamos, si a menudo estamos alertas). <br><br>  Estos son ejemplos de "normal" para diferentes canales: <br><br><img src="https://habrastorage.org/webt/3f/d5/fg/3fd5fg6los9dg7pjlkuanfuv_mk.png"><br><br><img src="https://habrastorage.org/webt/hp/n-/q6/hpn-q6cnqtaugwlsmch1jvapnuc.png"><br><br>  Descuidamos el p√°rrafo anterior y asumimos que todos los proveedores tienen una imagen "normal".  Ahora todo est√° bien, ¬øy podemos salir con alertas en grafana? <br>  Podemos, pero realmente no queremos, porque debemos elegir una de las opciones: <br>  a) hacer muchos gr√°ficos para cada canal por separado (y acompa√±arlos dolorosamente) <br>  b) deje un gr√°fico con todos los canales (y pi√©rdase en l√≠neas coloridas y alertas sintonizadas) <br><br><img src="https://habrastorage.org/webt/sk/8c/-b/sk8c-bayyodb08xuchmfbfjhe8q.png"><br><br><h4>  Como lo hiciste </h4><br>  Una vez m√°s, la documentaci√≥n tiene un buen ejemplo inicial ( <a href="https://docs.influxdata.com/kapacitor/v1.5/guides/join_backfill/">Calcular tasas a trav√©s de series unidas</a> ), puede echar un vistazo o tomar como base en tareas similares. <br><br>  ¬øQu√© hiciste como resultado? <br><br><ul><li>  une dos episodios en pocas horas, agrupando por canal; </li><li>  complete la serie por grupos, si no hubo datos; </li><li>  compare la mediana de los √∫ltimos 10 minutos con los datos anteriores; </li><li>  gritamos si encontramos algo; </li><li>  escribir tasas calculadas y alertas ocurridas en influxdb; </li><li>  env√≠a un mensaje √∫til a slack. </li></ul><br>  En mi opini√≥n, logramos todo lo bellamente posible todo lo que nos gustar√≠a obtener en la salida (e incluso un poco m√°s con controladores personalizados). <br><br>  En github.com puede ver el <a href="">c√≥digo de muestra</a> y el <a href="">diagrama m√≠nimo (graphviz) del</a> script resultante. <br><br><div class="spoiler">  <b class="spoiler_title">Ejemplo del c√≥digo resultante:</b> <div class="spoiler_text"><pre> <code class="python hljs">dbrp <span class="hljs-string"><span class="hljs-string">"supplier"</span></span>.<span class="hljs-string"><span class="hljs-string">"autogen"</span></span> var name = <span class="hljs-string"><span class="hljs-string">'requests.rate'</span></span> var grafana_dash = <span class="hljs-string"><span class="hljs-string">'pczpmYZWU/mydashboard'</span></span> var grafana_panel = <span class="hljs-string"><span class="hljs-string">'26'</span></span> var period = <span class="hljs-number"><span class="hljs-number">8</span></span>h var todayPeriod = <span class="hljs-number"><span class="hljs-number">10</span></span>m var every = <span class="hljs-number"><span class="hljs-number">1</span></span>m var warnAlert = <span class="hljs-number"><span class="hljs-number">15</span></span> var warnReset = <span class="hljs-number"><span class="hljs-number">5</span></span> var reqQuery = <span class="hljs-string"><span class="hljs-string">'SELECT sum("count") AS value FROM "supplier"."autogen"."requests"'</span></span> var errQuery = <span class="hljs-string"><span class="hljs-string">'SELECT sum("count") AS value FROM "supplier"."autogen"."errors"'</span></span> var prevErr = batch |query(errQuery) .period(period) .every(every) .groupBy(<span class="hljs-number"><span class="hljs-number">1</span></span>m, <span class="hljs-string"><span class="hljs-string">'channel'</span></span>, <span class="hljs-string"><span class="hljs-string">'supplier'</span></span>) var prevReq = batch |query(reqQuery) .period(period) .every(every) .groupBy(<span class="hljs-number"><span class="hljs-number">1</span></span>m, <span class="hljs-string"><span class="hljs-string">'channel'</span></span>, <span class="hljs-string"><span class="hljs-string">'supplier'</span></span>) var rates = prevReq |join(prevErr) .<span class="hljs-keyword"><span class="hljs-keyword">as</span></span>(<span class="hljs-string"><span class="hljs-string">'req'</span></span>, <span class="hljs-string"><span class="hljs-string">'err'</span></span>) .tolerance(<span class="hljs-number"><span class="hljs-number">1</span></span>m) .fill(<span class="hljs-string"><span class="hljs-string">'null'</span></span>) //   ,     |default() .field(<span class="hljs-string"><span class="hljs-string">'err.value'</span></span>, <span class="hljs-number"><span class="hljs-number">0.0</span></span>) .field(<span class="hljs-string"><span class="hljs-string">'req.value'</span></span>, <span class="hljs-number"><span class="hljs-number">0.0</span></span>) // <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>  <span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>:  ,     |eval(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-string"><span class="hljs-string">"err.value"</span></span> &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">100.0</span></span> * (float(<span class="hljs-string"><span class="hljs-string">"req.value"</span></span>) - float(<span class="hljs-string"><span class="hljs-string">"err.value"</span></span>)) / float(<span class="hljs-string"><span class="hljs-string">"req.value"</span></span>), <span class="hljs-number"><span class="hljs-number">100.0</span></span>)) .<span class="hljs-keyword"><span class="hljs-keyword">as</span></span>(<span class="hljs-string"><span class="hljs-string">'rate'</span></span>) //      rates |influxDBOut() .quiet() .create() .database(<span class="hljs-string"><span class="hljs-string">'kapacitor'</span></span>) .retentionPolicy(<span class="hljs-string"><span class="hljs-string">'autogen'</span></span>) .measurement(<span class="hljs-string"><span class="hljs-string">'rates'</span></span>) //     <span class="hljs-number"><span class="hljs-number">10</span></span> ,   var todayRate = rates |where(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>: duration((unixNano(now()) - unixNano(<span class="hljs-string"><span class="hljs-string">"time"</span></span>)) / <span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>u) &lt; todayPeriod) |median(<span class="hljs-string"><span class="hljs-string">'rate'</span></span>) .<span class="hljs-keyword"><span class="hljs-keyword">as</span></span>(<span class="hljs-string"><span class="hljs-string">'median'</span></span>) var prevRate = rates |median(<span class="hljs-string"><span class="hljs-string">'rate'</span></span>) .<span class="hljs-keyword"><span class="hljs-keyword">as</span></span>(<span class="hljs-string"><span class="hljs-string">'median'</span></span>) var joined = todayRate |join(prevRate) .<span class="hljs-keyword"><span class="hljs-keyword">as</span></span>(<span class="hljs-string"><span class="hljs-string">'today'</span></span>, <span class="hljs-string"><span class="hljs-string">'prev'</span></span>) |httpOut(<span class="hljs-string"><span class="hljs-string">'join'</span></span>) var trigger = joined |alert() .warn(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>: (<span class="hljs-string"><span class="hljs-string">"prev.median"</span></span> - <span class="hljs-string"><span class="hljs-string">"today.median"</span></span>) &gt; warnAlert) .warnReset(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>: (<span class="hljs-string"><span class="hljs-string">"prev.median"</span></span> - <span class="hljs-string"><span class="hljs-string">"today.median"</span></span>) &lt; warnReset) .flapping(<span class="hljs-number"><span class="hljs-number">0.25</span></span>, <span class="hljs-number"><span class="hljs-number">0.5</span></span>) .stateChangesOnly() //   message      .message( <span class="hljs-string"><span class="hljs-string">'{{ .Level }}: {{ index .Tags "channel" }} err/req ratio ({{ index .Tags "supplier" }}) {{ if eq .Level "OK" }}It is ok now{{ else }} '</span></span>+string(todayPeriod)+<span class="hljs-string"><span class="hljs-string">' median is {{ index .Fields "today.median" | printf "%0.2f" }}%, by previous '</span></span>+string(period)+<span class="hljs-string"><span class="hljs-string">' is {{ index .Fields "prev.median" | printf "%0.2f" }}%{{ end }} http://grafana.ostrovok.in/d/'</span></span>+string(grafana_dash)+ <span class="hljs-string"><span class="hljs-string">'?var-supplier={{ index .Tags "supplier" }}&amp;var-channel={{ index .Tags "channel" }}&amp;panelId='</span></span>+string(grafana_panel)+<span class="hljs-string"><span class="hljs-string">'&amp;fullscreen&amp;tz=UTC%2B03%3A00'</span></span> ) .id(<span class="hljs-string"><span class="hljs-string">'{{ index .Tags "name" }}/{{ index .Tags "channel" }}'</span></span>) .levelTag(<span class="hljs-string"><span class="hljs-string">'level'</span></span>) .messageField(<span class="hljs-string"><span class="hljs-string">'message'</span></span>) .durationField(<span class="hljs-string"><span class="hljs-string">'duration'</span></span>) .topic(<span class="hljs-string"><span class="hljs-string">'slack_graph'</span></span>) // <span class="hljs-string"><span class="hljs-string">"today.median"</span></span>   <span class="hljs-string"><span class="hljs-string">"value"</span></span>,        (keep) trigger |eval(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>: <span class="hljs-string"><span class="hljs-string">"today.median"</span></span>) .<span class="hljs-keyword"><span class="hljs-keyword">as</span></span>(<span class="hljs-string"><span class="hljs-string">'value'</span></span>) .keep() |influxDBOut() .quiet() .create() .database(<span class="hljs-string"><span class="hljs-string">'kapacitor'</span></span>) .retentionPolicy(<span class="hljs-string"><span class="hljs-string">'autogen'</span></span>) .measurement(<span class="hljs-string"><span class="hljs-string">'alerts'</span></span>) .tag(<span class="hljs-string"><span class="hljs-string">'alertName'</span></span>, name)</code> </pre><br></div></div><br><h2>  ¬øCu√°l es la conclusi√≥n? </h2><br>  Kapacitor es muy bueno para monitorear alertas con un grupo de grupos, realizar c√°lculos adicionales en m√©tricas ya registradas, realizar acciones personalizadas y ejecutar scripts (udf). <br><br>  El umbral de entrada no es muy alto: pru√©belo si la grafana u otras herramientas no satisfacen completamente su lista de deseos. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/478702/">https://habr.com/ru/post/478702/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../478680/index.html">¬øPor qu√©, y lo m√°s importante, a d√≥nde va la gente de TI?</a></li>
<li><a href="../478688/index.html">C√≥mo fue estudiar Data Science en 2019</a></li>
<li><a href="../478692/index.html">C√≥mo se admite Java 8 en Android</a></li>
<li><a href="../478696/index.html">C√≥mo visit√© Urban Tech 2019. Informe del evento</a></li>
<li><a href="../478698/index.html">Hacemos un plan de terreno interactivo en 15 minutos.</a></li>
<li><a href="../478704/index.html">Qu√© hacer si los correos ya han llegado a Spam: 5 pasos pr√°cticos</a></li>
<li><a href="../478706/index.html">Arquitecto de alta carga. Nuevo curso de OTUS</a></li>
<li><a href="../478708/index.html">C√≥mo los randomisers te permiten dar nueva vida a los viejos juegos</a></li>
<li><a href="../478710/index.html">Despliegue f√°cil y sencillo de aplicaciones en el cartucho de Tarantool (parte 1)</a></li>
<li><a href="../478712/index.html">C√≥mo no pagar el alojamiento Java o el inicio r√°pido con Google App Engine</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>