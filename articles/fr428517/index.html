<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèª‚Äçüî¨ üë©üèø‚Äçüéì ü§æüèΩ GraphQL - API d'une nouvelle fa√ßon ü•¶ üë®üèø‚Äçüöí ‚ò¶Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Qu'est-ce que le langage de requ√™te GraphQL? Quels avantages cette technologie offre-t-elle et quels probl√®mes les d√©veloppeurs rencontreront-ils lors...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>GraphQL - API d'une nouvelle fa√ßon</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/jugru/blog/428517/">  Qu'est-ce que le langage de requ√™te GraphQL?  Quels avantages cette technologie offre-t-elle et quels probl√®mes les d√©veloppeurs rencontreront-ils lorsqu'ils l'utiliseront?  Comment utiliser GraphQL efficacement?  √Ä propos de tout cela sous la coupe. <br><br><img src="https://habrastorage.org/webt/d4/w4/cg/d4w4cgweq81ewi6vo51e1kbw9tu.jpeg"><br><br>  L'article est bas√© sur le rapport d'introduction de <b>Vladimir Tsukur</b> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">volodymyrtsukur</a> ) de la conf√©rence <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Joker 2017</a> . <br><a name="habracut"></a><br><iframe width="560" height="315" src="https://www.youtube.com/embed/YgRmgHPTXr4" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Je m'appelle Vladimir, je dirige le d√©veloppement d'un des d√©partements de WIX.  Plus d'une centaine de millions d'utilisateurs de WIX cr√©ent des sites Web de diff√©rentes directions - des sites et magasins de cartes de visite aux applications Web complexes o√π vous pouvez √©crire du code et une logique arbitraire.  En tant qu'exemple vivant d'un projet sur WIX, je voudrais vous montrer le site <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Web √†</a> succ√®s <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">unicornadoptions.com</a> , qui offre la possibilit√© d'acheter un kit pour apprivoiser une licorne - un excellent cadeau pour un enfant. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2a9/7ec/db8/2a97ecdb8542ecb4aff1213a5b8690b9.jpg"><br><br>  Un visiteur de ce site peut choisir un kit qu'il aime apprivoiser une licorne, disons rose, puis voir ce qu'il y a exactement dans ce kit: jouet, certificat, badge.  De plus, l'acheteur a la possibilit√© d'ajouter des marchandises au panier, d'afficher son contenu et de passer une commande.  Ceci est un exemple simple d'un site de magasin, et nous en avons plusieurs centaines de milliers.  Tous sont construits sur la m√™me plate-forme, avec un backend, avec un ensemble de clients que nous prenons en charge en utilisant l'API pour cela.  Il s'agit de l'API qui sera discut√©e plus loin. <br><br><h2>  API simple et ses probl√®mes </h2><br>  Imaginons quelle API √† usage g√©n√©ral (c'est-√†-dire une API pour tous les magasins au-dessus de la plate-forme) nous pourrions cr√©er pour fournir des fonctionnalit√©s de magasin.  Concentrons-nous uniquement sur l'obtention de donn√©es. <br><br>  Pour une page de produit sur un tel site, le nom du produit, le prix, les photos, la description, des informations suppl√©mentaires et bien plus doivent √™tre retourn√©s.  Dans une solution compl√®te pour les magasins sur WIX, il existe plus de deux douzaines de tels champs de donn√©es.  La solution standard pour une telle t√¢che en plus de l'API HTTP est de d√©crire la ressource <code>/products/:id</code> , qui renvoie les donn√©es produit sur la demande <code>GET</code> .  Voici un exemple de donn√©es de r√©ponse: <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-string"><span class="hljs-string">"59eb83c0040fa80b29938e3f"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Combo Pack with Dreamy Eyes 12\" (Pink) Soft Toy"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"price"</span></span>: <span class="hljs-number"><span class="hljs-number">26.99</span></span>, <span class="hljs-attr"><span class="hljs-attr">"description"</span></span>: <span class="hljs-string"><span class="hljs-string">"Spread Unicorn love amongst your friends and family by purchasing a Unicorn adoption combo pack today. You'll receive your very own fabulous adoption pack and a 12\" Dreamy Eyes (Pink) cuddly toy. It makes the perfect gift for loved ones. Go on, you know you want to, adopt today!"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"sku"</span></span>:<span class="hljs-string"><span class="hljs-string">"010"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"images"</span></span>: [   <span class="hljs-string"><span class="hljs-string">"http://localhost:8080/img/918d8d4cc83d4e5f8680ca4edfd5b6b2.jpg"</span></span>,   <span class="hljs-string"><span class="hljs-string">"http://localhost:8080/img/f343889c0bb94965845e65d3f39f8798.jpg"</span></span>,   <span class="hljs-string"><span class="hljs-string">"http://localhost:8080/img/dd55129473e04f489806db0dc6468dd9.jpg"</span></span>,   <span class="hljs-string"><span class="hljs-string">"http://localhost:8080/img/64eba4524a1f4d5d9f1687a815795643.jpg"</span></span>,   <span class="hljs-string"><span class="hljs-string">"http://localhost:8080/img/5727549e9131440dbb3cd707dce45d0f.jpg"</span></span>,   <span class="hljs-string"><span class="hljs-string">"http://localhost:8080/img/28ae9369ec3c442dbfe6901434ad15af.jpg"</span></span> ] }</code> </pre> <br><img src="https://habrastorage.org/getpro/habr/post_images/ecf/5d6/4ac/ecf5d64acd1da66df56b6aa49f5eb6be.jpg"><br><br>  Regardons maintenant la page du catalogue de produits.  Pour cette page, vous avez besoin de la collection de ressources <i>/ products</i> .  Mais uniquement en affichant la collection de produits sur la page du catalogue, toutes les donn√©es produit ne sont pas n√©cessaires, mais uniquement le prix, le nom et l'image principale.  Par exemple, la description, les informations suppl√©mentaires, les images d'arri√®re-plan, etc. ne nous int√©ressent pas. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/aa4/82b/0ed/aa482b0edf598fcc605eee75216e963b.png"><br><br>  Supposons, par souci de simplicit√©, que nous d√©cidions d'utiliser le m√™me mod√®le de donn√©es produit pour les ressources <code>/products</code> et <code>/products/:id</code> .  Dans le cas d'une collection de tels produits, il y en aura potentiellement plusieurs.  Le sch√©ma de r√©ponse peut √™tre repr√©sent√© comme suit: <br><br><pre> <code class="javascript hljs">GET /products [ {   title   price   images   description   info   ... } ]</code> </pre><br>  Examinons maintenant la ¬´charge utile¬ª de la r√©ponse du serveur pour la collection de produits.  Voici ce qui est r√©ellement utilis√© par le client parmi plus de deux douzaines de champs: <br><br> <code>{ <br> <s>"id": "59eb83c0040fa80b29938e3f",</s> <br> "title": "Combo Pack with Dreamy Eyes 12\" (Pink) Soft Toy", <br> "price": 26.99, <br> <s>"info": "Spread Unicorn love amongst your friends and family by purchasing a Unicorn adoption combo pack today. You'll receive your very own fabulous adoption pack and a 12\" Dreamy Eyes (Pink) cuddly toy. It makes the perfect gift for loved ones. Go on, you know you want to, adopt todayl",</s> <br> " <s>description": "Your fabulous Unicorn adoption combo pack contains:\nA 12\" Dreamy Eyes (Pink) Unicorn Soft Toy\nA blank Unicorn adoption certificate ‚Äî name your Unicorn!\nA confirmation letter\nA Unicorn badge\nA Unicorn key ring\nA Unicorn face mask (self assembly)\nA Unicorn bookmark\nA Unicorn colouring in sheet\nA A4 Unicorn posters\n2 x Unicorn postcards\n3 x Unicorn stickers",</s> <br> "images": [ <br> "http://localhost:8080/img/918d8d4cc83d4e5f8680ca4edfd5b6b2.jpg", <br> <s>"http://localhost:8080/img/f343889c0bb94965845e65d3f39f8798.jpg",</s> <br> <s>"http://localhost:8080/img/dd55129473604f489806db0dC6468dd9.jpg",</s> <br> <s>"http://localhost:8080/img/64eba4524a1f4d5d9f1687a815795643.jpg",</s> <br> <s>"http://localhost:8080/img/5727549e9l3l440dbb3cd707dce45d0f.jpg",</s> <br> <s>"http://localhost:8080/img/28ae9369ec3c442dbfe6901434ad15af.jpg"</s> <br> ], <br> <s>...</s> <br> }</code> <br> <br>  √âvidemment, si je veux garder le mod√®le de produit simple en renvoyant les m√™mes donn√©es, je me retrouve avec un probl√®me de fetching, obtenant dans certains cas plus de donn√©es que je n'en ai besoin.  Dans ce cas, cela est apparu sur la page du catalogue de produits, mais en g√©n√©ral, tout √©cran d'interface utilisateur qui est en quelque sorte connect√© au produit ne n√©cessitera potentiellement de lui qu'une partie (et pas toutes) des donn√©es. <br><br>  Regardons maintenant la page du panier.  Dans le panier, en plus des produits eux-m√™mes, il y a aussi leur quantit√© (dans ce panier), le prix, ainsi que le co√ªt total de la commande enti√®re: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/653/da1/ad3/653da1ad36872dff8cda2d13b28b5f45.png"><br><br>  Si nous continuons l'approche de la mod√©lisation simple de l'API HTTP, alors le panier peut √™tre repr√©sent√© √† travers la ressource <i>/ carts /: id</i> , dont la pr√©sentation fait r√©f√©rence aux ressources des produits ajout√©s √† ce panier: <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">"items"</span></span>: [   {     <span class="hljs-attr"><span class="hljs-attr">"product"</span></span>: <span class="hljs-string"><span class="hljs-string">"/products/59eb83c0040fa80b29938e3f"</span></span>,     <span class="hljs-attr"><span class="hljs-attr">"quantity"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>,     <span class="hljs-attr"><span class="hljs-attr">"total"</span></span>: <span class="hljs-number"><span class="hljs-number">26.99</span></span>   },   {     <span class="hljs-attr"><span class="hljs-attr">"product"</span></span>: <span class="hljs-string"><span class="hljs-string">"/products/59eb83c0040fa80b29938e40"</span></span>,     <span class="hljs-attr"><span class="hljs-attr">"quantity"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>,     <span class="hljs-attr"><span class="hljs-attr">"total"</span></span>: <span class="hljs-number"><span class="hljs-number">25.98</span></span>   },   {     <span class="hljs-attr"><span class="hljs-attr">"product"</span></span>: <span class="hljs-string"><span class="hljs-string">"/products/59eb88bd040fa8125aa9c400"</span></span>,     <span class="hljs-attr"><span class="hljs-attr">"quantity"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>,     <span class="hljs-attr"><span class="hljs-attr">"total"</span></span>: <span class="hljs-number"><span class="hljs-number">26.99</span></span>   } ], <span class="hljs-attr"><span class="hljs-attr">"subTotal"</span></span>: <span class="hljs-number"><span class="hljs-number">79.96</span></span> }</code> </pre><br>  Maintenant, par exemple, afin de dessiner un panier avec trois produits √† l'avant, vous devez faire quatre demandes: une pour charger le panier lui-m√™me et trois demandes pour charger les donn√©es de produit (nom, prix et num√©ro de r√©f√©rence). <br><br>  Le deuxi√®me probl√®me que nous avons eu est sous-r√©cup√©r√©.  La diff√©renciation des responsabilit√©s entre le panier et les ressources produit a conduit √† la n√©cessit√© de faire des demandes suppl√©mentaires.  Il y a √©videmment un certain nombre d'inconv√©nients ici: en raison <i>d'un</i> plus grand nombre de demandes, nous atterrissons la batterie du t√©l√©phone mobile plus rapidement et obtenons la r√©ponse compl√®te plus lentement.  Et l'√©volutivit√© de notre solution soul√®ve √©galement des questions. <br><br>  Bien entendu, cette solution n'est pas adapt√©e √† la production.  Une fa√ßon de r√©soudre le probl√®me consiste √† ajouter un support de projection pour le panier.  Une de ces projections pourrait, en plus des donn√©es du panier lui-m√™me, renvoyer des donn√©es sur les produits.  De plus, cette projection sera tr√®s sp√©cifique, car c'est sur la page panier que vous avez besoin du num√©ro d'inventaire (SKU) du produit.  Nulle part ailleurs le SKU n'√©tait n√©cessaire ailleurs. <br><br><pre> <code class="plaintext hljs">GET /carts/1?projection=with-products</code> </pre> <br><img src="https://habrastorage.org/getpro/habr/post_images/a5f/3d7/901/a5f3d7901a3d60622575ae1fdf6787d1.png"><br><br>  Un tel ¬´ajustement¬ª des ressources pour une interface utilisateur sp√©cifique ne se termine g√©n√©ralement pas, et nous commen√ßons √† g√©n√©rer d'autres projections: de br√®ves informations sur le panier, la projection du panier pour le Web mobile, puis la projection pour les licornes. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/9ff/6b5/dad/9ff6b5dad7ee3ec4e7d95790dcd2eb05.png"><br><br>  (En g√©n√©ral, dans WIX Designer, en tant qu'utilisateur, vous pouvez configurer les donn√©es de produit que vous souhaitez afficher sur la page du produit et les donn√©es √† afficher dans le panier) <br><br>  Et l√†, des difficult√©s nous attendent: nous encadrons le jardin et recherchons des solutions complexes.  Il existe peu de solutions standard du point de vue de l'API pour une telle t√¢che, et elles d√©pendent g√©n√©ralement fortement du cadre ou de la biblioth√®que de description des ressources HTTP. <br><br>  Plus important encore, il devient maintenant plus difficile de travailler, car lorsque les exigences c√¥t√© client changent, le backend doit constamment ¬´rattraper¬ª et les satisfaire. <br><br>  En tant que ¬´cerise sur le g√¢teau¬ª, examinons une autre question importante.  Dans le cas d'une simple API HTTP, le d√©veloppeur du serveur n'a aucune id√©e du type de donn√©es que le client utilise.  Le prix est-il utilis√©?  Description?  Une ou toutes les images? <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1f1/943/2d4/1f19432d49f8577cc70197bdb74a7987.png"><br><br>  En cons√©quence, plusieurs questions se posent.  Comment travailler avec des donn√©es obsol√®tes / obsol√®tes?  Comment savoir quelles donn√©es ne sont plus utilis√©es?  Comment est-il relativement s√ªr de supprimer des donn√©es de la r√©ponse sans casser la plupart des clients?  Il n'y a pas de r√©ponse √† ces questions avec l'API HTTP habituelle.  Malgr√© le fait que nous soyons optimistes et que l'API semble simple, la situation ne semble pas si chaude.  Cette gamme de probl√®mes d'API n'est pas propre √† WIX.  Un grand nombre d'entreprises ont d√ª faire affaire avec eux.  Maintenant, il est int√©ressant de chercher une solution potentielle. <br><br><h2>  GraphQL.  Commencer </h2><br>  En 2012, dans le processus de d√©veloppement d'une application mobile, Facebook a √©t√© confront√© √† un probl√®me similaire.  Les ing√©nieurs souhaitaient atteindre le nombre minimal d'appels d'applications mobiles vers le serveur, tandis qu'√† chaque √©tape, ils ne recevaient que les donn√©es n√©cessaires et rien d'autre qu'eux.  Le r√©sultat de leurs efforts a √©t√© GraphQL, pr√©sent√© √† la conf√©rence React Conf 2015.  GraphQL est un langage de description de requ√™te, ainsi qu'un environnement d'ex√©cution pour ces requ√™tes. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/052/9fc/00c/0529fc00c59b43faf40c8cbd4064d1ac.png"><br><br>  Envisagez une approche typique pour travailler avec des serveurs GraphQL. <br><br><h3>  Nous d√©crivons le sch√©ma </h3><br>  Le sch√©ma de donn√©es dans GraphQL d√©finit les types et les relations entre eux et le fait de mani√®re fortement typ√©e.  Par exemple, imaginez un mod√®le simple de r√©seau social.  <code>User</code> conna√Æt des amis, des <code>friends</code> .  Les utilisateurs vivent dans la ville et la ville conna√Æt ses habitants √† travers le champ des <code>citizens</code> .  Voici ce qu'est un graphique d'un tel mod√®le dans GraphQL: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ae4/5e8/2e9/ae45e82e9610ff7abb7291fbe4671062.png"><br><br>  Bien s√ªr, pour que le graphique soit utile, les soi-disant ¬´points d'entr√©e¬ª sont √©galement n√©cessaires.  Par exemple, un tel point d'entr√©e pourrait obtenir un utilisateur par son nom. <br><br><h3>  Demander des donn√©es </h3><br>  Voyons quelle est l'essence du langage de requ√™te GraphQL.  Traduisons cette question dans cette langue: <i>"Pour un utilisateur nomm√© Vanya Unicorn, je veux conna√Ætre les noms de ses amis, ainsi que le nom et la population de la ville dans laquelle Vanya vit"</i> : <br><br><pre> <code class="javascript hljs">{ user(name: <span class="hljs-string"><span class="hljs-string">"Vanya Unicorn"</span></span>) {   friends {     name   }   city {     name     population   } } }</code> </pre> <br>  Et voici la r√©ponse du serveur GraphQL: <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"data"</span></span>: {   <span class="hljs-attr"><span class="hljs-attr">"user"</span></span>: {     <span class="hljs-attr"><span class="hljs-attr">"friends"</span></span>: [       { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Lena"</span></span> },       { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Stas"</span></span> }     ]     <span class="hljs-string"><span class="hljs-string">"city"</span></span>: {       <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Kyiv"</span></span>,       <span class="hljs-attr"><span class="hljs-attr">"population"</span></span>: <span class="hljs-number"><span class="hljs-number">2928087</span></span>     }   } } }</code> </pre><br>  Remarquez comment le formulaire de demande est ¬´conforme¬ª au formulaire de r√©ponse.  Il y a un sentiment que ce langage de requ√™te a √©t√© cr√©√© pour JSON.  Avec une frappe forte.  Et tout cela se fait en une seule requ√™te HTTP POST - pas besoin de faire plusieurs appels au serveur. <br><br>  Voyons √† quoi cela ressemble dans la pratique.  Ouvrons la console standard pour le serveur GraphQL, qui s'appelle Graph <i>i</i> QL ("graph").  Pour demander un panier, je r√©pondrai √† la demande suivante: <i>"Je souhaite obtenir un panier par identifiant 1, je suis int√©ress√© par toutes les positions de ce panier et les informations produit.</i>  <i>D'apr√®s les informations, le nom, le prix, le num√©ro d'inventaire et les images sont importants (et seulement la premi√®re).</i>  <i>Je suis √©galement int√©ress√© par la quantit√© de ces produits, quel est leur prix et le co√ªt total dans le panier</i> . <i>"</i> <br><br><pre> <code class="javascript hljs">{ cart(id: <span class="hljs-number"><span class="hljs-number">1</span></span>) {   items {     product {       title       price       sku       images(limit: <span class="hljs-number"><span class="hljs-number">1</span></span>)     }     quantity     total   }   subTotal } }</code> </pre> <br>  Apr√®s avoir r√©ussi la demande, nous obtenons exactement ce qui a √©t√© demand√©: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/cf7/c04/a8e/cf7c04a8ef9d309387a6bcc935d40d10.png"><br><br><h2>  Avantages cl√©s </h2><br><ul><li>  <b>√âchantillonnage flexible.</b>  Le client peut faire une demande selon ses besoins sp√©cifiques. <br></li><li>  <b>√âchantillonnage efficace.</b>  La r√©ponse renvoie uniquement les donn√©es demand√©es. <br></li><li>  <b>D√©veloppement plus rapide.</b>  De nombreux changements sur le client peuvent se produire sans avoir √† changer quoi que ce soit c√¥t√© serveur.  Par exemple, sur la base de notre exemple, vous pouvez facilement afficher une vue diff√©rente du panier pour le Web mobile. <br></li><li>  <b>Analyses utiles.</b>  √âtant donn√© que le client doit indiquer les champs explicitement dans la demande, le serveur sait exactement quels champs sont vraiment n√©cessaires.  Et ce sont des informations importantes pour la politique de d√©pr√©ciation. <br></li><li>  <b>Fonctionne au-dessus de n'importe quelle source de donn√©es et transport.</b>  Il est important que GraphQL vous permette de travailler au-dessus de n'importe quelle source de donn√©es et de tout transport.  Dans ce cas, HTTP n'est pas une panac√©e, GraphQL peut √©galement fonctionner via WebSocket, et nous aborderons ce point un peu plus tard. <br></li></ul><br>  Aujourd'hui, un serveur GraphQL peut √™tre cr√©√© dans presque toutes les langues.  La version la plus compl√®te du serveur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">GraphQL</a> est <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">GraphQL.js</a> pour la plateforme Node.  Dans la communaut√© Java, l'impl√©mentation de r√©f√©rence est <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">GraphQL Java</a> . <br><br><h2>  Cr√©er l'API GraphQL </h2><br>  Voyons comment cr√©er un serveur GraphQL sur un exemple de vie concret. <br><br>  Prenons une version simplifi√©e d'une boutique en ligne bas√©e sur une architecture de microservice √† deux composants: <br><br><ul><li>  Service de chariot offrant du travail avec un panier personnalis√©.  Stocke les donn√©es dans une base de donn√©es relationnelle et utilise SQL pour acc√©der aux donn√©es.  Service tr√®s simple, sans trop de magie :) <br></li><li>  Service produit donnant acc√®s au catalogue de produits, √† partir duquel, en fait, le panier est rempli.  Fournit une API HTTP pour acc√©der aux donn√©es produit. <br></li></ul><br>  Les deux services sont impl√©ment√©s en plus du Spring Boot classique et contiennent d√©j√† toute la logique de base. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5f0/1e9/560/5f01e95602be2c3d88178f1327f791c6.png"><br><br>  Nous avons l'intention de cr√©er l'API GraphQL en plus du service Cart.  Cette API est con√ßue pour fournir un acc√®s aux donn√©es du panier et aux produits qui y sont ajout√©s. <br><br><h3>  Premi√®re version </h3><br>  L'impl√©mentation de r√©f√©rence GraphQL pour l'√©cosyst√®me Java, que nous avons mentionn√©e pr√©c√©demment - GraphQL Java, nous aidera. <br><br>  Ajoutez quelques d√©pendances √† <code>pom.xml:</code> <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span>   <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>com.graphql-java<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>   <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>graphql-java<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>   <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>9.3<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span>   <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>com.graphql-java<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>   <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>graphql-java-tools<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>   <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>5.2.4<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span>   <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>com.graphql-java<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>   <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>graphql-spring-boot-starter<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>   <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>5.0.2<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span>   <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>com.graphql-java<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>   <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>graphiql-spring-boot-starter<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>   <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>5.0.2<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  En plus du <code>graphql-java</code> mentionn√© <code>graphql-java</code> nous aurons besoin d'une biblioth√®que d' <code>graphql-java-tools,</code> ainsi que de ¬´d√©marreurs¬ª Spring Boot pour GraphQL, ce qui simplifiera consid√©rablement les premi√®res √©tapes de cr√©ation d'un serveur GraphQL: <br><br><ul><li>  <i>graphql-spring-boot-starter</i> fournit un m√©canisme pour connecter rapidement GraphQL Java √† Spring Boot; <br></li><li>  <i>graphiql-spring-boot-starter</i> ajoute une console Web interactive Graph <i>i</i> QL pour ex√©cuter les requ√™tes GraphQL. <br></li></ul><br>  La prochaine √©tape importante consiste √† d√©terminer le sch√©ma de service graphQL, notre graphique.  Les n≈ìuds de ce graphique sont d√©crits √† l'aide de <i>types</i> et les bords √† l'aide de <i>champs</i> .  Une d√©finition de graphique vide ressemble √† ceci: <br><br><pre> <code class="javascript hljs">schema { }</code> </pre> <br>  Dans ce sch√©ma m√™me, comme vous vous en souvenez, il existe des ¬´points d'entr√©e¬ª ou des requ√™tes de niveau sup√©rieur.  Ils sont d√©finis via le champ de <i>requ√™te</i> du sch√©ma.  Appelez notre type pour les <i>points d'</i> entr√©e <i>EntryPoints</i> : <br><br><pre> <code class="javascript hljs">schema { <span class="hljs-attr"><span class="hljs-attr">query</span></span>: EntryPoints }</code> </pre><br>  Nous y d√©finissons une recherche de panier par identifiant comme premier point d'entr√©e: <br><br><pre> <code class="javascript hljs">type EntryPoints { cart(id: Long!): Cart }</code> </pre><br>  <code>Cart</code> n'est rien de plus qu'un <i>champ</i> en termes GraphQL.  <code>id</code> est un param√®tre de ce champ avec le type scalaire <code>Long</code> .  Point d'exclamation <code>!</code>  apr√®s avoir sp√©cifi√© le type signifie que le param√®tre est obligatoire. <br><br>  Il est temps d'identifier et de taper <code>Cart</code> : <br><br><pre> <code class="javascript hljs">type Cart { <span class="hljs-attr"><span class="hljs-attr">id</span></span>: Long! items: [CartItem!]! subTotal: BigDecimal! }</code> </pre><br>  En plus de l' <code>id</code> standard, le panier comprend ses √©l√©ments d'articles et le montant pour tous les produits de sous- <code>subTotal</code> .  Notez que les <i>√©l√©ments sont</i> d√©finis comme une liste, comme indiqu√© par les crochets <code>[]</code> .  Les √©l√©ments de cette liste sont des types <code>CartItem</code> .  La pr√©sence d'un point d'exclamation apr√®s le nom du type de champ <code>!</code>  indique que le champ est obligatoire.  Cela signifie que le serveur accepte de renvoyer une valeur non vide pour ce champ, le cas √©ch√©ant. <br><br>  Reste √† regarder la d√©finition du type <code>CartItem</code> , qui comprend un lien vers le produit ( <i>productId</i> ), combien de fois il est ajout√© au panier ( <code>quantity</code> ) et le montant du produit, calcul√© sur le nombre ( <code>total</code> ): <br><br><pre> <code class="javascript hljs">type CartItem { <span class="hljs-attr"><span class="hljs-attr">productId</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>! quantity: Int! total: BigDecimal! }</code> </pre><br>  Tout est simple ici - tous les champs de types scalaires sont obligatoires. <br><br>  Ce sch√©ma n'a pas √©t√© choisi par hasard.  Le service Cart a d√©j√† d√©fini le panier Cart et ses √©l√©ments <code>CartItem</code> avec exactement les m√™mes noms de champs et types que dans le sch√©ma GraphQL.  Le mod√®le de chariot utilise la biblioth√®que Lombok pour les getters / setters √† g√©n√©ration automatique, les constructeurs et d'autres m√©thodes.  JPA est utilis√© pour la persistance dans la base de donn√©es. <br><br>  Classe de <code>Cart</code> : <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> lombok.Data; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.persistence.*; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.math.BigDecimal; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.ArrayList; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.List; <span class="hljs-meta"><span class="hljs-meta">@Entity</span></span> <span class="hljs-meta"><span class="hljs-meta">@Data</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Cart</span></span></span><span class="hljs-class"> </span></span>{   <span class="hljs-meta"><span class="hljs-meta">@Id</span></span>   <span class="hljs-meta"><span class="hljs-meta">@GeneratedValue</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Long id;   <span class="hljs-meta"><span class="hljs-meta">@ElementCollection</span></span>(fetch = FetchType.EAGER)   <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;CartItem&gt; items = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;&gt;();   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> BigDecimal </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getSubTotal</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{       <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> getItems().stream()               .map(Item::getTotal)               .reduce(BigDecimal.ZERO, BigDecimal::add);   } }</code> </pre><br>  <code>CartItem</code> Class: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> lombok.AllArgsConstructor; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> lombok.Data; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.persistence.Column; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.persistence.Embeddable; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.math.BigDecimal; <span class="hljs-meta"><span class="hljs-meta">@Embeddable</span></span> <span class="hljs-meta"><span class="hljs-meta">@Data</span></span> <span class="hljs-meta"><span class="hljs-meta">@AllArgsConstructor</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CartItem</span></span></span><span class="hljs-class"> </span></span>{   <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(nullable = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)   <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String productId;   <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(nullable = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)   <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> quantity;   <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(nullable = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)   <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> BigDecimal total; }</code> </pre><br>  Ainsi, le panier ( <code>Cart</code> ) et les √©l√©ments du panier ( <code>CartItem</code> ) sont d√©crits √† la fois dans le diagramme GraphQL et dans le code, et sont ¬´compatibles¬ª entre eux en fonction de l'ensemble des champs et de leurs types.  Mais cela ne suffit toujours pas pour que notre service fonctionne. <br><br>  Nous devons clarifier exactement comment le point d'entr√©e " <code>cart(id: Long!): Cart</code> " fonctionnera.  Pour ce faire, cr√©ez une configuration Java extr√™mement simple pour Spring avec un bean de type GraphQLQueryResolver.  GraphQLQueryResolver d√©crit simplement les "points d'entr√©e" dans le sch√©ma.  Nous d√©finissons une m√©thode avec un nom identique au champ au point d'entr√©e ( <code>cart</code> ), la <code>cartService</code> compatible par type de param√®tres et utilisons <code>cartService</code> pour trouver le m√™me panier par identifiant: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> GraphQLQueryResolver </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">queryResolver</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GraphQLQueryResolver () {       <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Cart </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cart</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Long id)</span></span></span><span class="hljs-function"> </span></span>{           <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cartService.findCart(id);       }   } }</code> </pre><br>  Ces changements nous suffisent pour obtenir une application qui fonctionne.  Apr√®s avoir red√©marr√© le service Cart dans la console GraphiQL, la requ√™te suivante commencera √† s'ex√©cuter avec succ√®s: <br><br><pre> <code class="javascript hljs">{ cart(id: <span class="hljs-number"><span class="hljs-number">1</span></span>) {   items {     productId     quantity     total   }   subTotal } }</code> </pre> <br><h3>  Remarque </h3><br><ul><li>  Nous utilisons les types scalaires <code>Long</code> et <code>String</code> comme identifiants uniques pour le panier et le produit.  GraphQL a un type sp√©cial √† ces fins - <code>ID</code> .  S√©mantiquement, c'est un meilleur choix pour une v√©ritable API.  Les valeurs de type <code>ID</code> peuvent √™tre utilis√©es comme cl√© pour la mise en cache. <br></li><li>  A ce stade du d√©veloppement de notre application, les mod√®les de domaine interne et externe sont totalement identiques.  Nous parlons des <code>CartItem</code> <code>Cart</code> et <code>CartItem</code> et de leur utilisation directe dans les r√©solveurs GraphQL.  Dans les applications de combat, il est recommand√© de s√©parer ces mod√®les.  Pour les r√©solveurs GraphQL, un mod√®le distinct de la zone de sujet interne doit exister. <br></li></ul><br><h3>  Rendre l'API utile </h3><br>  Nous avons donc obtenu le premier r√©sultat, et c'est merveilleux.  Mais maintenant, notre API est trop primitive.  Par exemple, jusqu'√† pr√©sent, il n'y a aucun moyen de demander des donn√©es utiles sur un produit, telles que son nom, son prix, son article, ses photos, etc.  Au lieu de cela, il n'y a qu'un <code>productId</code> .  Rendons l'API vraiment utile et ajoutons une prise en charge compl√®te du concept de produit.  Voici √† quoi ressemble sa d√©finition dans le diagramme: <br><br><pre> <code class="javascript hljs">type Product { <span class="hljs-attr"><span class="hljs-attr">id</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>! title: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>! price: BigDecimal! description: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> sku: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>! images: [<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>!]! }</code> </pre><br>  Ajoutez le champ requis √† <code>CartItem</code> et <code>productId</code> champ productId comme obsol√®te: <br><br><pre> <code class="javascript hljs">type Item { <span class="hljs-attr"><span class="hljs-attr">quantity</span></span>: Int! product: Product! productId: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>! @deprecated(reason: <span class="hljs-string"><span class="hljs-string">"don't use it!"</span></span>) total: BigDecimal! }</code> </pre> <br>  Nous avons compris le sch√©ma.  Et maintenant, il est temps de d√©crire le fonctionnement de la s√©lection pour le domaine de <code>product</code> .  Nous nous <code>CartItem</code> auparavant sur les getters des <code>CartItem</code> <code>Cart</code> et <code>CartItem</code> , ce qui permettait √† GraphQL Java de lier automatiquement les valeurs.  Mais ici, il convient de rappeler que seule la propri√©t√© du <code>product</code> dans la classe <code>CartItem</code> pas: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Embeddable</span></span> <span class="hljs-meta"><span class="hljs-meta">@Data</span></span> <span class="hljs-meta"><span class="hljs-meta">@AllArgsConstructor</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CartItem</span></span></span><span class="hljs-class"> </span></span>{   <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(nullable = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)   <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String productId;   <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(nullable = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)   <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> quantity;   <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(nullable = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)   <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> BigDecimal total; }</code> </pre><br>  Nous avons le choix: <br><br><ol><li>  Ajoutez la propri√©t√© du <i>produit</i> √† <i>CartItem</i> et "apprenez" comment recevoir les donn√©es du produit; <br></li><li>  D√©terminez comment obtenir le <i>produit</i> sans modifier la classe <i>CartItem</i> . <br></li></ol><br>  La deuxi√®me voie est pr√©f√©rable, car le mod√®le de description du domaine interne (classe <code>CartItem</code> ) dans ce cas ne sera pas couvert avec les d√©tails de l'impl√©mentation de l'API Graph <i>i</i> QL. <br><br>  Pour atteindre cet objectif, l'interface du marqueur GraphQLResolver vous aidera.  En l'impl√©mentant, vous pouvez d√©terminer (ou remplacer) comment obtenir les valeurs de champ pour le type <code>T</code>  Voici √† quoi ressemble le bean correspondant dans la configuration Spring: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> GraphQLResolver&lt;CartItem&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cartItemResolver</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GraphQLResolver&lt;CartItem&gt;() {       <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Product </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">product</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CartItem item)</span></span></span><span class="hljs-function"> </span></span>{           <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> http.getForObject(<span class="hljs-string"><span class="hljs-string">"http://localhost:9090/products/{id}"</span></span>,                   Product.class,                   item.getProductId());       }   }; }</code> </pre> <br>  Le nom de la m√©thode du <code>product</code> n'a pas √©t√© choisi par hasard.  GraphQL Java recherche des m√©thodes de t√©l√©chargement de donn√©es par nom de champ, et nous venons de d√©finir un chargeur pour le champ <code>product</code> !  Un objet de type <code>CartItem</code> pass√© en param√®tre d√©finit le contexte dans lequel le produit est s√©lectionn√©.  Vient ensuite une question de technologie.  En utilisant un client <code>http</code> tel que <code>RestTemplate</code> nous faisons une requ√™te GET au service Product et convertissons le r√©sultat en <code>Product</code> , qui ressemble √† ceci: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Data</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Product</span></span></span><span class="hljs-class"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String id;   <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String title;   <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> BigDecimal price;   <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String description;   <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String sku;   <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;String&gt; images; }</code> </pre> <br>  Ces changements devraient √™tre suffisants pour mettre en ≈ìuvre un √©chantillon plus int√©ressant, qui inclut la v√©ritable relation entre le panier et les produits qui y sont ajout√©s. <br><br>  Apr√®s avoir red√©marr√© l'application, vous pouvez essayer une nouvelle requ√™te dans la console Graph <i>i</i> QL. <br><br><pre> <code class="javascript hljs">{ cart(id: <span class="hljs-number"><span class="hljs-number">1</span></span>) {   items {     product {       title       price       sku       images     }     quantity     total   }   subTotal } }</code> </pre><br>  Et voici le r√©sultat de l'ex√©cution de la requ√™te: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0c8/778/3f4/0c87783f4f843696b9900771c2b2860e.png"><br><br>  Bien que <code>productId</code> √©t√© marqu√© comme <code>@deprecated</code> , les requ√™tes indiquant ce champ continueront de fonctionner.  Mais la console Graph <i>i</i> QL n'offrira pas de saisie semi-automatique pour ces champs et mettra en √©vidence leur utilisation d'une mani√®re sp√©ciale: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/afc/96a/d45/afc96ad45f3f4372a8e86cf78b892acd.png"><br><br>  Il est temps de montrer l'Explorateur de documents, qui fait partie de la console Graph <i>i</i> QL, qui est construit sur la base du sch√©ma GraphQL et affiche des informations sur tous les types d√©finis.  Voici √† quoi ressemble Document Explorer pour le type <code>CartItem</code> : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f83/c04/38b/f83c0438b2f906b34414b764182a37fc.png"><br><br>  Mais revenons √† l'exemple.  Afin d'atteindre les m√™mes fonctionnalit√©s que dans la toute premi√®re d√©mo, il n'y a toujours pas assez de limite pour le nombre d'images retourn√©es.  En effet, pour un panier, par exemple, vous n'avez besoin que d'une image pour chaque produit: <br><br><pre> <code class="javascript hljs">images(limit: <span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre> <br>  Pour ce faire, modifiez le sch√©ma et ajoutez un nouveau param√®tre pour le champ <i>images</i> au type de <i>produit</i> : <br><br><pre> <code class="javascript hljs">type Product { <span class="hljs-attr"><span class="hljs-attr">id</span></span>: ID! title: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>! price: BigDecimal! description: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> sku: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>! images(limit: Int = <span class="hljs-number"><span class="hljs-number">0</span></span>): [<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>!]! }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Et dans le code de l'application, nous l'utiliserons √† nouveau </font></font><code>GraphQLResolver</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, mais cette fois par type </font></font><code>Product</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> GraphQLResolver&lt;Product&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">productResolver</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GraphQLResolver&lt;Product&gt;() {       <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> List&lt;String&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">images</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Product product, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> limit)</span></span></span><span class="hljs-function"> </span></span>{           List&lt;String&gt; images = product.getImages();           <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> normalizedLimit = limit &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> ? limit : images.size();           <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> images.subList(<span class="hljs-number"><span class="hljs-number">0</span></span>, Math.min(normalizedLimit, images.size()));       }   }; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Encore une fois, j'attire votre attention sur le fait que le nom de la m√©thode n'est pas accidentel: il co√Øncide avec le nom du champ </font></font><code>images</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">L'objet contextuel </font></font><code>Product</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">donne acc√®s aux images et </font></font><code>limit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">est un param√®tre du champ lui-m√™me. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si le client n'a rien sp√©cifi√© comme valeur pour </font></font><code>limit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, alors notre service retournera toutes les images du produit. </font><font style="vertical-align: inherit;">Si le client a sp√©cifi√© une valeur sp√©cifique, le service retournera exactement autant (mais pas plus qu'il n'y en a dans le produit). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous compilons le projet et attendons le red√©marrage du serveur. </font><font style="vertical-align: inherit;">En red√©marrant le circuit dans la console et en ex√©cutant la requ√™te, nous voyons qu'une requ√™te √† part enti√®re fonctionne vraiment.</font></font><br><br><pre> <code class="javascript hljs">{ cart(id: <span class="hljs-number"><span class="hljs-number">1</span></span>) {   items {     product {       title       price       sku       images(limit: <span class="hljs-number"><span class="hljs-number">1</span></span>)     }     quantity     total   }   subTotal } }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D'accord, tout cela est tr√®s cool. </font><font style="vertical-align: inherit;">En peu de temps, nous avons non seulement appris ce qu'est GraphQL, mais √©galement transf√©r√© un syst√®me de microservice simple pour prendre en charge une telle API. </font><font style="vertical-align: inherit;">Et peu importe pour nous d'o√π proviennent les donn√©es: les API SQL et HTTP s'int√®grent bien sous un m√™me toit.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Approche Code-First et GraphQL SPQR </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vous avez peut-√™tre remarqu√© que pendant le processus de d√©veloppement, il y a eu quelques inconv√©nients, √† savoir la n√©cessit√© de garder constamment le sch√©ma et le code GraphQL synchronis√©s. Les changements de type devaient toujours √™tre effectu√©s √† deux endroits. Dans de nombreux cas, il est plus pratique d'utiliser l'approche du code en premier. Son essence est que le sch√©ma de GraphQL est g√©n√©r√© automatiquement √† partir du code. Dans ce cas, vous n'avez pas besoin de maintenir le circuit s√©par√©ment. Je vais maintenant vous montrer √† quoi √ßa ressemble. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Seules les fonctionnalit√©s de base de GraphQL Java ne nous suffisent pas, nous aurons √©galement besoin de la biblioth√®que GraphQL SPQR. La bonne nouvelle est que GraphQL SPQR est un module compl√©mentaire pour GraphQL Java, et non une impl√©mentation alternative du serveur GraphQL en Java. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ajoutez la d√©pendance souhait√©e √† </font></font><code>pom.xml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span>   <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>io.leangen.graphql<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>   <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>spqr<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>   <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>0.9.8<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Voici le code qui impl√©mente la m√™me fonctionnalit√© bas√©e sur GraphQL SPQR pour le panier: </font></font><br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Component</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CartGraph</span></span></span><span class="hljs-class"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> CartService cartService;   <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span>   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CartGraph</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CartService cartService)</span></span></span><span class="hljs-function"> </span></span>{       <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.cartService = cartService;   }   <span class="hljs-meta"><span class="hljs-meta">@GraphQLQuery</span></span>(name = <span class="hljs-string"><span class="hljs-string">"cart"</span></span>)   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Cart </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cart</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@GraphQLArgument(name = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"id"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> Long id) </span></span>{       <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cartService.findCart(id);   } }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Et pour le produit: </font></font><br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Component</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProductGraph</span></span></span><span class="hljs-class"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> RestTemplate http;   <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span>   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProductGraph</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(RestTemplate http)</span></span></span><span class="hljs-function"> </span></span>{       <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.http = http;   }   <span class="hljs-meta"><span class="hljs-meta">@GraphQLQuery</span></span>(name = <span class="hljs-string"><span class="hljs-string">"product"</span></span>)   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Product </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">product</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@GraphQLContext CartItem cartItem)</span></span></span><span class="hljs-function"> </span></span>{       <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> http.getForObject(               <span class="hljs-string"><span class="hljs-string">"http://localhost:9090/products/{id}"</span></span>,               Product.class,               cartItem.getProductId()       );   }   <span class="hljs-meta"><span class="hljs-meta">@GraphQLQuery</span></span>(name = <span class="hljs-string"><span class="hljs-string">"images"</span></span>)   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> List&lt;String&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">images</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@GraphQLContext Product product,                              @GraphQLArgument(name = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"limit"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, defaultValue = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"0"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> limit) </span></span>{       List&lt;String&gt; images = product.getImages();       <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> normalizedLimit = limit &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> ? limit : images.size();       <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> images.subList(<span class="hljs-number"><span class="hljs-number">0</span></span>, Math.min(normalizedLimit, images.size()));   } }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'annotation @GraphQLQuery est utilis√©e pour marquer les m√©thodes du chargeur de champ. </font><font style="vertical-align: inherit;">L'annotation </font></font><code>@GraphQLContext</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d√©finit le type de s√©lection pour le champ. </font><font style="vertical-align: inherit;">Et l'annotation </font></font><code>@GraphQLArgument</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">marque clairement les param√®tres d'argument. </font><font style="vertical-align: inherit;">Tous ces √©l√©ments font partie d'un m√©canisme qui aide GraphQL SPQR √† g√©n√©rer automatiquement un sch√©ma. </font><font style="vertical-align: inherit;">Maintenant, si vous supprimez l'ancienne configuration et le sch√©ma Java, red√©marrez le service Cart en utilisant les nouvelles puces de GraphQL SPQR, vous pouvez vous assurer que tout fonctionne de la m√™me mani√®re qu'auparavant.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Nous r√©solvons le probl√®me de N + 1 </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il est temps de regarder b </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">le</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> d√©tail lshih comment la mise en </font><font style="vertical-align: inherit;">≈ìuvre de la demande tout ¬´ sous le capot ¬ª. Nous avons rapidement cr√©√© l'API GraphQL, mais fonctionne-t-il efficacement? </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prenons l'exemple suivant: L' </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/05c/626/303/05c62630323d9ad9eeb97999c19fcd04.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">obtention du panier </font></font><code>cart</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se produit dans une requ√™te SQL vers la base de donn√©es. Les donn√©es y </font></font><code>items</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sont </font></font><code>subtotal</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">renvoy√©es, car les √©l√©ments du panier sont charg√©s avec toute la collection, en fonction de la strat√©gie JPA d√©sireuse:</font></font><br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Data</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Cart</span></span></span><span class="hljs-class"> </span></span>{   <span class="hljs-meta"><span class="hljs-meta">@ElementCollection</span></span>(fetch = FetchType.EAGER)   <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;Item&gt; items = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;&gt;();   ... }</code> </pre> <br><img src="https://habrastorage.org/getpro/habr/post_images/674/0e4/863/6740e4863b4847f782f64588e52ecc36.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lorsqu'il s'agit de t√©l√©charger des donn√©es sur des produits, les demandes de service Produit seront ex√©cut√©es exactement autant que dans ce panier de produits. S'il y a trois produits diff√©rents dans le panier, nous recevrons alors trois demandes √† l'API HTTP du service produit, et s'il y en a dix, alors le m√™me service devra r√©pondre √† dix de ces demandes. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/92c/9c0/b1a/92c9c0b1a06c15f081c0eb9dc9ce8a1f.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Voici la communication entre le service Cart et le service Produit dans Charles Proxy: En </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/c15/8df/d08/c158dfd08badf133f49499baa43c1970.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cons√©quence, nous revenons au probl√®me classique N + 1. Exactement celui dont ils ont tant cherch√© √† sortir au tout d√©but du rapport. Sans aucun doute, nous avons progress√©, car exactement une demande est ex√©cut√©e entre le client final et notre syst√®me. Mais au sein de l'√©cosyst√®me de serveurs, les performances doivent clairement √™tre am√©lior√©es.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Je veux r√©soudre ce probl√®me en obtenant tous les bons produits en une seule demande. </font><font style="vertical-align: inherit;">Heureusement, le service Produit prend d√©j√† en charge cette fonctionnalit√© via un param√®tre </font></font><code>ids</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dans la ressource de collecte:</font></font><br><br><pre> <code class="plaintext hljs">GET /products?ids=:id1,:id2,...,:idn</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Voyons comment vous pouvez modifier l'exemple de code de m√©thode pour le champ </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">produit</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Version pr√©c√©dente:</font></font><br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@GraphQLQuery</span></span>(name = <span class="hljs-string"><span class="hljs-string">"product"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Product </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">product</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@GraphQLContext CartItem cartItem)</span></span></span><span class="hljs-function"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> http.getForObject(           <span class="hljs-string"><span class="hljs-string">"http://localhost:9090/products/{id}"</span></span>,           Product.class,           cartItem.getProductId()   ); }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Remplacez-le par un autre plus efficace: </font></font><br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@GraphQLQuery</span></span>(name = <span class="hljs-string"><span class="hljs-string">"product"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Batched</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> List&lt;Product&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">products</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@GraphQLContext List&lt;Item&gt; items)</span></span></span><span class="hljs-function"> </span></span>{   String productIds = items.stream()           .map(Item::getProductId)           .collect(Collectors.joining(<span class="hljs-string"><span class="hljs-string">","</span></span>));   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> http.getForObject(           <span class="hljs-string"><span class="hljs-string">"http://localhost:9090/products?ids={ids}"</span></span>,           Products.class,           productIds   ).getProducts(); }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Nous avons fait exactement trois choses: </font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">marqu√© la m√©thode du chargeur de d√©marrage avec </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">une</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> annotation </font><i><font style="vertical-align: inherit;">@Batched</font></i><font style="vertical-align: inherit;"> , </font><i><font style="vertical-align: inherit;">indiquant</font></i><font style="vertical-align: inherit;"> clairement √† GraphQL SPQR que le chargement doit avoir lieu avec un lot;</font></font><br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> chang√© le type de retour et le param√®tre de contexte en liste, car travailler avec le lot suppose que plusieurs objets sont accept√©s et retourn√©s; </font></font><br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> chang√© le corps de la m√©thode, en mettant en ≈ìuvre une s√©lection de tous les produits n√©cessaires √† la fois. </font></font><br></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ces changements suffisent √† r√©soudre notre probl√®me N + 1. </font><font style="vertical-align: inherit;">La fen√™tre de l'application Charles Proxy affiche d√©sormais une demande au service Produit, qui renvoie trois produits √† la fois:</font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/5c2/806/98d/5c280698dfbdf383cf44052f51a09ae8.png"><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √âchantillons de terrain efficaces </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous avons r√©solu le probl√®me principal, mais vous pouvez faire la s√©lection encore plus rapidement! </font><font style="vertical-align: inherit;">D√©sormais, le service Produit renvoie toutes les donn√©es, quels que soient les besoins du client final. </font><font style="vertical-align: inherit;">Nous pourrions am√©liorer la requ√™te et renvoyer uniquement les champs demand√©s. </font><font style="vertical-align: inherit;">Par exemple, si le client final n'a pas demand√© l'image, pourquoi devons-nous les transf√©rer au service Cart? </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C'est formidable que l'API HTTP du service Produit prenne d√©j√† en charge cette fonctionnalit√© via le param√®tre </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">include</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour la m√™me ressource de collecte:</font></font><br><br><pre> <code class="plaintext hljs">GET /products?ids=...?include=:field1,:field2,...,:fieldN</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour la m√©thode du chargeur de d√©marrage, ajoutez un param√®tre de type Set avec annotation </font></font><code>@GraphQLEnvironment</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">GraphQL SPQR comprend que le code dans ce cas ¬´demande¬ª une liste de noms de champs qui sont demand√©s pour le produit, et les remplit automatiquement:</font></font><br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@GraphQLQuery</span></span>(name = <span class="hljs-string"><span class="hljs-string">"product"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Batched</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> List&lt;Product&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">products</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@GraphQLContext List&lt;Item&gt; items,                             @GraphQLEnvironment Set&lt;String&gt; fields)</span></span></span><span class="hljs-function"> </span></span>{   String productIds = items.stream()           .map(Item::getProductId)           .collect(Collectors.joining(<span class="hljs-string"><span class="hljs-string">","</span></span>));   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> http.getForObject(           <span class="hljs-string"><span class="hljs-string">"http://localhost:9090/products?ids={ids}&amp;include={fields}"</span></span>,           Products.class,           productIds,           String.join(<span class="hljs-string"><span class="hljs-string">","</span></span>, fields)   ).getProducts(); }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Maintenant, notre √©chantillon est vraiment efficace, d√©pourvu du probl√®me N + 1 et utilise uniquement les donn√©es n√©cessaires: </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/242/592/98f/24259298fe8acb19d21e04083689d5dd.png"><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Demandes "lourdes" </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Imaginez travailler avec un graphique utilisateur dans un r√©seau social classique tel que Facebook. </font><font style="vertical-align: inherit;">Si un tel syst√®me fournit l'API GraphQL, rien n'emp√™che le client d'envoyer une demande de la nature suivante:</font></font><br><br><pre> <code class="javascript hljs">{ user(name: <span class="hljs-string"><span class="hljs-string">"Vova Unicorn"</span></span>) {   friends {     name     friends {       name       friends {         name         friends {            name            ...         }       }     }   } } }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Au niveau d'imbrication 5-6, la mise en ≈ìuvre compl√®te d'une telle demande conduira √† une s√©lection de tous les utilisateurs dans le monde. </font><font style="vertical-align: inherit;">Le serveur ne sera certainement pas en mesure de faire face √† une telle t√¢che en une seule fois et tr√®s probablement il "tombera" simplement. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il existe un certain nombre de mesures qui doivent √™tre prises afin de vous prot√©ger de telles situations:</font></font><br><br><ul><li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Limiter la profondeur de demande. </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En d'autres termes, les clients ne devraient pas √™tre autoris√©s √† demander des donn√©es d'imbrication arbitraire.</font></font><br></li><li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Limitez la complexit√© de la demande. </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En affectant un poids √† chaque champ et en calculant la somme des poids de tous les champs de la demande, vous pouvez accepter ou rejeter ces demandes sur le serveur.</font></font><br></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Par exemple, consid√©rez la requ√™te suivante: </font></font><br><br><pre> <code class="javascript hljs">{ cart(id: <span class="hljs-number"><span class="hljs-number">1</span></span>) {   items {     product {       title     }     quantity   }   subTotal } }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">De toute √©vidence, la profondeur d'une telle demande est de 4, car le chemin le plus long se trouve √† l'int√©rieur </font></font><code>cart -&gt; items -&gt; product -&gt; title</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si nous supposons que le poids de chaque champ est de 1, alors en tenant compte de 7 champs dans la requ√™te, sa complexit√© est √©galement de 7. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans GraphQL Java, la superposition des contr√¥les est obtenue en indiquant une instrumentation suppl√©mentaire lors de la cr√©ation de l'objet </font></font><code>GraphQL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="java hljs">GraphQL.newGraphQL(schema)       .instrumentation(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ChainedInstrumentation(Arrays.asList(               <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MaxQueryComplexityInstrumentation(<span class="hljs-number"><span class="hljs-number">20</span></span>),               <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MaxQueryDepthInstrumentation(<span class="hljs-number"><span class="hljs-number">3</span></span>)       )))       .build();</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'instrumentation </font></font><code>MaxQueryDepthInstrumentation</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">v√©rifie la profondeur de la requ√™te et ne permet pas de lancer des requ√™tes trop "profondes" (dans ce cas, avec une profondeur sup√©rieure √† 3). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'instrumentation </font></font><code>MaxQueryComplexityInstrumentation</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avant d'ex√©cuter une requ√™te compte et v√©rifie sa complexit√©. Si ce nombre d√©passe la valeur sp√©cifi√©e (20), une telle demande est rejet√©e. Vous pouvez red√©finir le poids de chaque champ, car certains d'entre eux deviennent √©videmment "plus durs" que d'autres. Par exemple, le champ produit peut √™tre affect√© de la complexit√© 10 via l'annotation </font></font><code>@GraphQLComplexity,</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">prise en charge dans GraphQL SPQR:</font></font><br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@GraphQLQuery</span></span>(name = <span class="hljs-string"><span class="hljs-string">"product"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@GraphQLComplexity</span></span>(<span class="hljs-string"><span class="hljs-string">"10"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> List&lt;Product&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">products</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(...)</span></span></span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Voici un exemple de v√©rification de profondeur lorsqu'elle d√©passe clairement la valeur sp√©cifi√©e: </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/54c/c39/584/54cc39584792997b198370c40e8b2431.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Au fait, le m√©canisme d'instrumentation ne se limite pas √† imposer des restrictions. </font><font style="vertical-align: inherit;">Il peut √©galement √™tre utilis√© √† d'autres fins, telles que la journalisation ou le tra√ßage. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous avons examin√© les mesures de ¬´protection¬ª sp√©cifiques √† GraphQL. </font><font style="vertical-align: inherit;">Cependant, il existe un certain nombre d'astuces qui m√©ritent une attention particuli√®re quel que soit le type d'API:</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √©tranglement / limitation de d√©bit - limiter le nombre de demandes par unit√© de temps </font></font><br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> d√©lais d'expiration - d√©lai pour les op√©rations avec d'autres services, bases de donn√©es, etc.; </font></font><br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pagination - support de pagination. </font></font><br></li></ul><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Mutation de donn√©es </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jusqu'√† pr√©sent, nous avons envisag√© un √©chantillonnage purement de donn√©es. </font><font style="vertical-align: inherit;">Mais GraphQL vous permet d'organiser organiquement non seulement la r√©ception des donn√©es, mais aussi leur modification. </font><font style="vertical-align: inherit;">Il existe un m√©canisme pour cela </font></font><code></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Dans le sch√©ma, une place sp√©ciale est r√©serv√©e √† cela - le champ </font></font><code>mutation</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="javascript hljs">schema { <span class="hljs-attr"><span class="hljs-attr">query</span></span>: EntryPoints, <span class="hljs-attr"><span class="hljs-attr">mutation</span></span>: Mutations }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Par exemple, l'ajout d'un produit √† un panier peut √™tre organis√© par la mutation suivante: </font></font><br><br><pre> <code class="javascript hljs">type Mutations {   addProductToCart(cartId: Long!,                    <span class="hljs-attr"><span class="hljs-attr">productId</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>!,                    <span class="hljs-attr"><span class="hljs-attr">count</span></span>: Int = <span class="hljs-number"><span class="hljs-number">1</span></span>): Cart }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cela revient √† d√©finir un champ, car une mutation a √©galement des param√®tres et une valeur de retour. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'impl√©mentation d'une mutation dans le code serveur √† l'aide de GraphQL SPQR est la suivante:</font></font><br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@GraphQLMutation</span></span>(name = <span class="hljs-string"><span class="hljs-string">"addProductToCart"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Cart </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addProductToCart</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(       @GraphQLArgument(name = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"cartId"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> Long cartId,       @</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GraphQLArgument</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(name = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"productId"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> String productId,       @</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GraphQLArgument</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(name = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"quantity"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, defaultValue = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"1"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> quantity) </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cartService.addProductToCart(cartId, productId, quantity); }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bien s√ªr, la plupart du travail utile se fait en interne </font></font><code>cartService</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Et la t√¢che de cette m√©thode intercouche est de l'associer √† l'API. Comme dans le cas de l'√©chantillonnage de donn√©es, gr√¢ce aux annotations, il est </font></font><code>@GraphQL*</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tr√®s facile de comprendre quel sch√©ma GraphQL est g√©n√©r√© √† partir de cette d√©finition de m√©thode. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans la console GraphQL, vous pouvez d√©sormais effectuer une demande de mutation pour ajouter un produit sp√©cifique √† notre panier au montant de 2:</font></font><br><br><pre> <code class="javascript hljs">mutation { addProductToCart(     cartId: <span class="hljs-number"><span class="hljs-number">1</span></span>,     <span class="hljs-attr"><span class="hljs-attr">productId</span></span>: <span class="hljs-string"><span class="hljs-string">"59eb83c0040fa80b29938e3f"</span></span>,     <span class="hljs-attr"><span class="hljs-attr">quantity</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>) {   items {     product {       title     }     quantity     total   }   subTotal } }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La mutation ayant une valeur de retour, il est possible de lui demander des champs selon les m√™mes r√®gles que pour les √©chantillons ordinaires. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Plusieurs √©quipes de d√©veloppement WIX utilisent activement GraphQL avec Scala et la biblioth√®que Sangria, l'impl√©mentation principale de GraphQL dans ce langage. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'une des techniques utiles utilis√©es dans WIX est la prise en charge des requ√™tes GraphQL lors du rendu HTML. </font><font style="vertical-align: inherit;">Nous faisons cela afin de g√©n√©rer du JSON directement dans le code de la page. </font><font style="vertical-align: inherit;">Voici un exemple de remplissage d'un mod√®le HTML:</font></font><br><br><pre> <code class="xml hljs">// Pre-rendered <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data-embedded-graphiql</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"><span class="undefined"> {   product(productId: $productId)     title     description     price     ...   } } </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Et voici la sortie: </font></font><br><br><pre> <code class="xml hljs">// Rendered <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="javascript"> </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">window</span></span></span><span class="javascript">.DATA = {   </span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">product</span></span></span><span class="javascript">: {          </span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">title</span></span></span><span class="javascript">: </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'GraphQL Sticker'</span></span></span><span class="javascript">,          </span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">description</span></span></span><span class="javascript">: </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'High quality sticker'</span></span></span><span class="javascript">,           </span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">price</span></span></span><span class="javascript">: </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'$2'</span></span></span><span class="javascript">           ... } } </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Une telle combinaison de rendu HTML et de serveur GraphQL nous permet de r√©utiliser notre API au maximum et de ne pas cr√©er une couche suppl√©mentaire de contr√¥leurs. </font><font style="vertical-align: inherit;">De plus, cette technique s'av√®re souvent avantageuse en termes de performances, car apr√®s le chargement de la page, l'application JavaScript n'a pas besoin d'aller au backend pour les premi√®res donn√©es n√©cessaires - elle est d√©j√† sur la page.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Inconv√©nients de GraphQL </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aujourd'hui, GraphQL utilise un grand nombre d'entreprises, y compris des g√©ants tels que GitHub, Yelp, Facebook et bien d'autres. </font><font style="vertical-align: inherit;">Et si vous d√©cidez de rejoindre leur num√©ro, vous devez conna√Ætre non seulement les avantages de GraphQL, mais aussi ses inconv√©nients, et ils sont nombreux:</font></font><br><br><ul><li> -,  GraphQL <b>     </b> .  GraphQL      ,   HTTP API.  <i>Cache-Control</i>  <i>Last-Modified</i>    HTTP      GraphQL API.         ,  proxy  gateways (Varnish, Fastly  ).   , GraphQL    ,    ,   . <br></li><li>   GraphQL ‚Äî <b>    </b> .    ,         API,    ,       . <br></li><li> <b> </b>  GraphQL       .        . <br></li><li>  <b>     </b> . GraphQL ‚Äî       .     JSON  XML, , ,          GraphQL,       . <br></li><li>  GraphQL <b>   </b> . ,       HTTP   <i>PUT</i>     <i>POST</i>  -.   ,       .    GraphQL       .        . <br></li><li> <b>   </b> . ,     -: ¬´delete¬ª  ¬´kill¬ª, ¬´annihilate¬ª  ¬´terminate¬ª,    .   GraphQL API    .   HTTP          <i>DELETE</i> . <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Joker 2016   </a>   .  GraphQL <b>      </b> .  API-   ,   ,    ,     HATEOAS,     ,   ¬´ REST¬ª. ,     ,  GraphQL     . <br></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il convient √©galement de se rappeler que si vous n'avez pas r√©ussi √† bien d√©velopper l'API HTTP, vous ne pourrez probablement pas d√©velopper l'API GraphQL. Apr√®s tout, qu'est-ce qui est le plus important dans le d√©veloppement d'une API? S√©parez le mod√®le de domaine interne du mod√®le d'API externe. Cr√©ez une API bas√©e sur des sc√©narios d'utilisation et non sur le p√©riph√©rique interne de l'application. Ouvrez uniquement les informations minimales n√©cessaires, et pas toutes de suite. Choisissez les bons noms. D√©crivez le graphique correctement. Il existe un graphique de ressources dans l'API HTTP et un graphique de champ dans l'API GraphQL. Dans les deux cas, ce graphique doit √™tre fait qualitativement.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il existe des alternatives dans le monde de l'API HTTP, et vous n'avez pas toujours besoin d'utiliser GraphQL lorsque vous avez besoin de s√©lections complexes. </font><font style="vertical-align: inherit;">Par exemple, il existe la norme OData, qui prend en charge les s√©lections partielles et √©tendues, comme GraphQL, et fonctionne au-dessus de HTTP. </font><font style="vertical-align: inherit;">Il existe une API JSON standard qui fonctionne avec JSON et prend en charge l'hyperm√©dia et les capacit√©s de r√©cup√©ration complexes. </font><font style="vertical-align: inherit;">Il y a aussi LinkRest, dont vous pouvez en savoir plus sur le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://youtu.be/EsldBtrb1Qc "&gt; rapport d'Andrus Adamchik</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sur Joker 2017. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour ceux qui veulent essayer GraphQL, je recommande fortement de lire des articles comparatifs d'ing√©nieurs qui connaissent profond√©ment REST et GraphQL d'un point de vue pratique et philosophique:</font></font><br><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://philsturgeon.uk/api/2017/01/24/graphql-vs-rest-overview/</font></font></a> <br></li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://blog.runscope.com/posts/you-might-not-need-graphql</font></font></a> <br></li></ul><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Enfin sur les abonnements et </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reporter</font></font></a> </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GraphQL a un avantage int√©ressant par rapport aux API standard. </font><font style="vertical-align: inherit;">Dans GraphQL, les cas d'utilisation synchrones et asynchrones peuvent se trouver sous le m√™me toit. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous avons envisag√© de recevoir des donn√©es par votre interm√©diaire </font></font><code>query</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, de modifier le statut du serveur </font></font><code>mutation</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, mais il y a une autre qualit√©. </font><font style="vertical-align: inherit;">Par exemple, la possibilit√© d'organiser des abonnements </font></font><code>subscriptions</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Imaginez qu'un client souhaite recevoir des notifications sur l'ajout d'un produit au panier de mani√®re asynchrone. </font><font style="vertical-align: inherit;">Gr√¢ce √† l'API GraphQL, cela peut √™tre fait sur la base d'un tel sch√©ma:</font></font><br><br><pre> <code class="javascript hljs">schema { <span class="hljs-attr"><span class="hljs-attr">query</span></span>: Queries, <span class="hljs-attr"><span class="hljs-attr">mutation</span></span>: Mutations, <span class="hljs-attr"><span class="hljs-attr">subscription</span></span>: Subscriptions } type Subscriptions { productAdded(cartId: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>!): Cart }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Le client peut souscrire via la demande suivante: </font></font><br><br><pre> <code class="javascript hljs">subscription { productAdded(cart: <span class="hljs-number"><span class="hljs-number">1</span></span>) {   items {     product ...   }   subTotal } }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©sormais, chaque fois qu'un produit est ajout√© au panier 1, le serveur enverra √† chaque client abonn√© un message sur WebSocket avec les donn√©es demand√©es sur le panier. </font><font style="vertical-align: inherit;">Encore une fois, en poursuivant la politique GraphQL, seules les donn√©es demand√©es par le client lors de la souscription viendront:</font></font><br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"data"</span></span>: {   <span class="hljs-attr"><span class="hljs-attr">"productAdded"</span></span>: {     <span class="hljs-attr"><span class="hljs-attr">"items"</span></span>: [       { <span class="hljs-attr"><span class="hljs-attr">"product"</span></span>: ‚Ä¶, <span class="hljs-attr"><span class="hljs-attr">"subTotal"</span></span>: ‚Ä¶ },       { <span class="hljs-attr"><span class="hljs-attr">"product"</span></span>: ‚Ä¶, <span class="hljs-attr"><span class="hljs-attr">"subTotal"</span></span>: ‚Ä¶ },       { <span class="hljs-attr"><span class="hljs-attr">"product"</span></span>: ‚Ä¶, <span class="hljs-attr"><span class="hljs-attr">"subTotal"</span></span>: ‚Ä¶ },       { <span class="hljs-attr"><span class="hljs-attr">"product"</span></span>: ‚Ä¶, <span class="hljs-attr"><span class="hljs-attr">"subTotal"</span></span>: ‚Ä¶ }     ],     <span class="hljs-attr"><span class="hljs-attr">"subTotal"</span></span>: <span class="hljs-number"><span class="hljs-number">289.33</span></span>   } } }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le client peut d√©sormais redessiner le panier, pas n√©cessairement redessiner la page enti√®re. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ceci est pratique car l'API synchrone (HTTP) et l'API asynchrone (WebSocket) peuvent √™tre d√©crites via GraphQL. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un autre exemple d'utilisation de la communication asynchrone est le m√©canisme de </font></font><i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">report</font></font></a></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">L'id√©e principale est que le client choisisse les donn√©es qu'il souhaite recevoir imm√©diatement (de mani√®re synchrone) et celles qu'il est pr√™t √† recevoir plus tard (de mani√®re asynchrone). </font><font style="vertical-align: inherit;">Par exemple, pour une telle demande:</font></font><br><br><pre> <code class="javascript hljs">query { feedStories {   author { name }   message   comments @defer {     author { name }     message   } } }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Le serveur retournera d'abord l'auteur et un message pour chaque histoire: </font></font><br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"data"</span></span>: {   <span class="hljs-attr"><span class="hljs-attr">"feedStories"</span></span>: [     {       <span class="hljs-attr"><span class="hljs-attr">"author"</span></span>: ‚Ä¶,       <span class="hljs-attr"><span class="hljs-attr">"message"</span></span>: ‚Ä¶     },     {       <span class="hljs-attr"><span class="hljs-attr">"author"</span></span>: ‚Ä¶,       <span class="hljs-attr"><span class="hljs-attr">"message"</span></span>: ‚Ä¶     }   ] } }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Apr√®s cela, le serveur, apr√®s avoir re√ßu des donn√©es sur les commentaires, les livrera au client via WebSocket de mani√®re asynchrone, indiquant dans le chemin pour lequel les commentaires d'historique sont maintenant pr√™ts: </font></font><br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"path"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"feedStories"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"comments"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"data"</span></span>: [   {     <span class="hljs-attr"><span class="hljs-attr">"author"</span></span>: ‚Ä¶,     <span class="hljs-attr"><span class="hljs-attr">"message"</span></span>: ‚Ä¶   } ] }</code> </pre> <br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Exemple de source </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le code utilis√© pour pr√©parer ce rapport </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">est disponible sur GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Plus r√©cemment, nous avons annonc√© </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JPoint 2019</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qui se tiendra du 5 au 6 avril 2019. </font><font style="vertical-align: inherit;">Vous pouvez en savoir plus sur ce que vous pouvez attendre de la conf√©rence de notre </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Jusqu'au 1er d√©cembre, les </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">billets Early Bird</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sont toujours disponibles </font><font style="vertical-align: inherit;">au prix le plus bas.</font></font></blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr428517/">https://habr.com/ru/post/fr428517/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr428507/index.html">Nous √©crivons un chat bot pour VKontakte sur python en utilisant longpoll</a></li>
<li><a href="../fr428509/index.html">Comment H&M essaie de se sauver avec l'IA et le Big Data</a></li>
<li><a href="../fr428511/index.html">√ânergie hydrog√®ne: le d√©but d'un long chemin</a></li>
<li><a href="../fr428513/index.html">500 pointeurs laser au m√™me endroit</a></li>
<li><a href="../fr428515/index.html">Top 3D Shop: comment nous avons chang√© au cours de l'ann√©e - R√©sultats 2018</a></li>
<li><a href="../fr428521/index.html">Pourquoi il n'y a pas d'amis sur GitHub. √Ä propos de Robbie Barrath, Evident et Copyright</a></li>
<li><a href="../fr428523/index.html">ShadowCloud - client cloud universel</a></li>
<li><a href="../fr428525/index.html">RecyclerView √† vitesse maximale: analyse des biblioth√®ques</a></li>
<li><a href="../fr428526/index.html">Taxe Google: virage √† 180 ¬∞</a></li>
<li><a href="../fr428528/index.html">Pourquoi les r√©volutionnaires aiment la nourriture √©pic√©e ou comment le chili est arriv√© en Chine</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>