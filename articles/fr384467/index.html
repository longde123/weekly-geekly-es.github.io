<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>😷 👃 📽️ Chien de garde basé sur Arduino Nano 👩🏻‍✈️ 👩🏻‍🚀 🎟️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Watchdog est un appareil conçu pour détecter et résoudre les problèmes matériels. Habituellement, un temporisateur est utilisé pour cela, dont un redé...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Chien de garde basé sur Arduino Nano</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/384467/"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Watchdog est un appareil conçu pour détecter et résoudre les problèmes matériels. </font><font style="vertical-align: inherit;">Habituellement, un temporisateur est utilisé pour cela, dont un redémarrage périodique empêche l'envoi d'un signal au redémarrage. </font></font></i><br>
<br>
<img src="https://habrastorage.org/files/521/6a2/019/5216a20198774a66bbc61882047bfe8b.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le serveur principal sur Gentoo est utilisé par moi principalement pour des expériences, cependant, il exécute un certain nombre de services qui, si possible, devraient être disponibles sans interruption. </font><font style="vertical-align: inherit;">Malheureusement, les conséquences de certaines expériences conduisent à la panique du noyau, à 100% de charge CPU et à d'autres problèmes au moment le plus inopportun. </font><font style="vertical-align: inherit;">L'idée d'ajouter un chien de garde a donc longtemps retenu l'attention et s'est finalement concrétisée dans cet appareil.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après une inspection minutieuse de ce qui était disponible et une évaluation du temps disponible, le chien de garde assemblé sur la base de l'Arduino Nano était la meilleure option. </font><font style="vertical-align: inherit;">Une liste d'exigences est apparue autour de la même:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Démarrage et arrêt du démon pour travailler avec une minuterie, un outil de système d'exploitation normal (OpenRC).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Propre chien de garde sur l'appareil, dans ATmega, vous devez l'utiliser.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le journal des événements sur l'appareil pour fixer le redémarrage et la minuterie.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Synchronisez l'heure de l'appareil avec l'hôte pour enregistrer l'heure correcte dans le journal.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recevoir et afficher l'état de l'appareil et ses entrées de journal.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Effacer le journal et réinitialiser l'appareil à son état d'origine.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi, le «microscope» a été retrouvé, le «clou» est marqué… on peut marteler.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Matériel</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La base de l'appareil était le clone chinois Arduino Nano, fabriqué sur la base de la puce CH340. </font><font style="vertical-align: inherit;">Les nouveaux noyaux Linux (testés depuis la 3.16) ont un pilote approprié, donc le périphérique est facilement détecté comme un port série USB.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Redémarrage indésirable Arduino</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Chaque fois que le terminal est connecté, l'Arduino redémarre. </font><font style="vertical-align: inherit;">La raison en est que le terminal envoie un signal DTR (Data Terminal Ready), ce qui provoque le redémarrage de l'appareil. </font><font style="vertical-align: inherit;">Ainsi, l'IDE Arduino met l'appareil en mode de chargement des croquis. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il existe plusieurs options pour résoudre le problème, mais une seule s'est avérée fonctionner - il est nécessaire d'installer un électrolyte de 10µF (C1 dans le diagramme ci-dessous) entre les contacts RST et GND. </font><font style="vertical-align: inherit;">Malheureusement, cela bloque également le téléchargement de croquis sur l'appareil. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En conséquence - le schéma est le suivant: </font></font><br>
<br>
<img src="https://habrastorage.org/files/2e3/9f0/ac0/2e39f0ac019f42459a7d599306573f5c.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dessiné à l'aide de KiCad</font></font></i><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Explications du schéma</font></font></b><div class="spoiler_text"><ul>
<li><b>R1</b> —    ,      PC817: <nobr>(5V — 1.2V / 0.02A) = 190Ω</nobr>,    180Ω.</li>
<li><b>U2</b> —     Arduino  PC.    ,     ( USB ),    .</li>
<li><b>JP1</b> — ,      .        .</li>
<li><b>1</b> — ,        DTR.</li>
<li><b>MB_RST</b>, <b>MB_GND</b> — RESET     ,    RST   (GND).    ,    .</li>
<li><b>BTN_RST</b>, <b>BTN_GND</b> —   ,    , ,   ,   .</li>
</ul><br>
</div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Boucle de démarrage (redémarrage cyclique) lors de l'utilisation de WDT</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les microcontrôleurs ATmega ont un mécanisme de réinitialisation WDT (WatchDog Timer) intégré. Cependant, toutes les tentatives d'utilisation de cette fonction ont conduit à une boucle de démarrage, qui ne pouvait être interrompue qu'en coupant l'alimentation. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Peu de recherches ont révélé que les chargeurs de démarrage de la plupart des clones Arduino ne prennent pas en charge WDT. Heureusement, ce problème a été résolu dans le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">chargeur</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de démarrage alternatif </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">Optiboot</font></a><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Afin de flasher le chargeur de démarrage, vous avez besoin d'un programmeur qui peut fonctionner en utilisant le protocole SPI, il est également souhaitable que l'IDE Arduino connaisse cet appareil «en personne». Dans ce cas, un autre Arduino est idéal. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si nous prenons Arduino UNO, en tant que programmeur, et la dernière version d'Arduino IDE v1.6.5, alors l'algorithme sera le suivant:</font></font><br>
<br>
<ol>
<li>   <b>boards-1.6.txt</b>   optiboot    <b><nobr>hardware/arduino/avr/boards.txt</nobr></b>    Arduino IDE.</li>
<li> Arduino Uno,    <b><nobr>File → Examples → ArduinoISP</nobr></b>.</li>
<li>    Arduino Nano  :<br>
<table>
<tbody><tr>
<th>Arduino Uno ()</th>
<th>Arduino Nano (ICSP )</th>
</tr>
<tr>
<td> <table>
<tbody><tr>
<td><b>5V</b> → Vcc</td>
</tr>
<tr>
<td><b>GND</b> → GND</td>
</tr>
<tr>
<td><b>D11</b> → MOSI</td>
</tr>
<tr>
<td><b>D12</b> → MISO</td>
</tr>
<tr>
<td><b>D13</b> → SCK</td>
</tr>
<tr>
<td><b>D10</b> → Reset</td>
</tr>
</tbody></table><br>
 </td>
<td> <table>
<tbody><tr>
<td><b>Pin1</b> (MISO) ← D12</td>
<td><b>Pin2</b> (Vcc) ← 5V</td>
</tr>
<tr>
<td><b>Pin3</b> (SCK) ← D13</td>
<td><b>Pin4</b> (MOSI) ← D11</td>
</tr>
<tr>
<td><b>Pin5</b> (Reset) ← D10</td>
<td><b>Pin6</b> (GND) ← GND</td>
</tr>
</tbody></table><br>
 </td>
</tr>
</tbody></table><br>
<div class="spoiler"><b class="spoiler_title">    </b><div class="spoiler_text"><img src="https://habrastorage.org/files/868/919/4fe/8689194fe6a94d9cbd22b6ec284cc7e3.jpg"><br>
</div></div></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans l'IDE Arduino, dans le menu Outils, définissez les paramètres comme dans la capture d'écran:</font></font><br>
<img src="https://habrastorage.org/files/699/f29/4af/699f294af6cc48179e44c65543a758c5.png"></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sélectionnez l'élément de menu </font></font><nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Outils → Graver Bootloader</font></font></nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et assurez-vous que le processus s'est terminé sans erreur.</font></font></li>
</ol><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après cette procédure, vous devez télécharger des </font><font style="vertical-align: inherit;">croquis à Arduino Nano en choisissant les mêmes paramètres - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conseil</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Optiboot sur 32 broches CPUs, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Processeur</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : ATMEGA328P, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CPU Speed</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : 16MHz.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Soudure</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, vous devez tout souder pour qu'il ressemble à une seule pièce. </font></font><br>
<br>
<img src="https://habrastorage.org/files/eab/32a/27c/eab32a27cc06458faf2589287cb886e4.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ici, une prise USB était nécessaire en raison du fait que j'ai une carte mère mini-ITX avec un seul connecteur pour une paire d'USB2.0, qui sont nécessaires sur le panneau avant, et il n'y avait rien à connecter au pad USB3.0. </font><font style="vertical-align: inherit;">Si possible, ces appareils doivent être connectés directement à la carte mère afin que les fils ne dépassent pas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La soudure, en règle générale, ne pose pas de problème, mais dans ce cas, une planche à pain est utilisée, et cela a ses propres spécificités.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment souder des pistes sur une planche à pain</font></font></b><div class="spoiler_text">      (  ,      ).             .<br>
<br>
   :<br>
<br>
<img src="https://habrastorage.org/files/847/e13/6d5/847e136d5af547abafdfcb4e40ced271.jpg"><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Résultat: </font></font><br>
<br>
<img src="https://habrastorage.org/files/86b/5dc/95b/86b5dc95b0d142288c0a007826abcaa0.jpg"><br>
<br>
<img src="https://habrastorage.org/files/1ce/697/fa3/1ce697fa32f04962a5a9324fb365fe48.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
il peut sembler que certains contacts sont mal soudés, mais ce n'est qu'un flux. </font><font style="vertical-align: inherit;">La consommation de soudure sur la planche à pain est assez importante, donc tout ce qui est possible est enduit d'un flux ici. </font><font style="vertical-align: inherit;">En fait, c'est un bon exemple de la façon dont vous n'avez pas besoin de quitter le produit après le soudage. </font><font style="vertical-align: inherit;">Le flux doit être lavé, sinon il peut y avoir des problèmes de corrosion des composés. </font><font style="vertical-align: inherit;">Je vais ajouter et aller me laver ... C'est mieux:</font></font><br>
<br>
<img src="https://habrastorage.org/files/a91/fd1/111/a91fd11110b348f2b9dcc8d9326d4f37.jpg"><br>
<br>
&nbsp;<br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Partie logiciel</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Objectivement parlant, le code de ce projet n'a pas un intérêt particulier. </font><font style="vertical-align: inherit;">Les introductions sont loin d'être extrêmes, et l'architecture est décrite en une phrase: envoyer une commande - attendre une réponse. </font><font style="vertical-align: inherit;">Par souci d'ordre, je décrirai ici les fonctionnalités principales et m'attarderai brièvement sur les points les plus intéressants, de mon point de vue. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout le code est publié sur GitHub, donc si vous êtes familier avec Bash et C / C ++ (dans le contexte des croquis Arduino), la lecture à ce stade peut être terminée. </font><font style="vertical-align: inherit;">Si vous êtes intéressé, le résultat final peut être trouvé </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Connexion chien de garde</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque vous connectez le chien de garde, un fichier de périphérique est créé contenant le numéro de série. </font><font style="vertical-align: inherit;">Si le système possède d'autres périphériques ttyUSB (dans mon cas, un modem), il y a un problème de numérotation. </font><font style="vertical-align: inherit;">Pour identifier de manière unique le périphérique, vous devez créer un lien symbolique avec un nom unique. </font><font style="vertical-align: inherit;">Pour cela, udev est conçu, qui existe probablement déjà dans le système. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous devez d'abord trouver visuellement le chien de garde connecté, par exemple, en consultant le fichier journal du système. </font><font style="vertical-align: inherit;">Ensuite, en remplaçant / dev / ttyUSB0 par le périphérique souhaité, écrivez dans le terminal:</font></font><br>
<br>
<pre><code class="bash hljs">udevadm info -a -p <span class="hljs-string">"<span class="hljs-subst">$(udevadm info -q path -n /dev/ttyUSB0)</span>"</span>
</code></pre><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exemple de sortie</font></font></b><div class="spoiler_text"><pre>  looking at device '/devices/pci0000:00/0000:00:14.0/usb1/1-1/1-1.4/1-1.4:1.0/ttyUSB0/tty/ttyUSB0':<font></font>
    KERNEL=="ttyUSB0"<font></font>
    SUBSYSTEM=="tty"<font></font>
    ...<font></font>
    <font></font>
  looking at parent device '/devices/pci0000:00/0000:00:14.0/usb1/1-1/1-1.4/1-1.4:1.0/ttyUSB0':<font></font>
    KERNELS=="ttyUSB0"<font></font>
    SUBSYSTEMS=="usb-serial"<font></font>
    DRIVERS=="ch341-uart"<font></font>
    ...<font></font>
    <font></font>
  looking at parent device '/devices/pci0000:00/0000:00:14.0/usb1/1-1/1-1.4/1-1.4:1.0':<font></font>
    ...<font></font>
    <font></font>
  looking at parent device '/devices/pci0000:00/0000:00:14.0/usb1/1-1/1-1.4':<font></font>
    SUBSYSTEMS=="usb"<font></font>
    DRIVERS=="usb"<font></font>
    ATTRS{idVendor}=="1a86"<font></font>
    ATTRS{idProduct}=="7523"<font></font>
    ATTRS{product}=="USB2.0-Serial"<font></font>
    ...<font></font>
</pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans ce cas, la règle ressemblera à ceci: </font></font><pre><code class="hljs cs">ACTION==<span class="hljs-string">"add"</span>, KERNEL==<span class="hljs-string">"ttyUSB[0-9]*"</span>, SUBSYSTEM==<span class="hljs-string">"tty"</span>, SUBSYSTEMS==<span class="hljs-string">"usb"</span>, ATTRS{idVendor}==<span class="hljs-string">"1a86"</span>, ATTRS{idProduct}==<span class="hljs-string">"7523"</span>, SYMLINK+=<span class="hljs-string">"ttyrst-watchdog"</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous devez le placer dans un fichier séparé dans le répertoire </font></font><nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/udev/rules.d</font></font></nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , par exemple, </font></font><nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">51-ttyrst-watchdog.rules</font></font></nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et dire à udev de recharger les règles:</font></font><pre><code class="bash hljs">udevadm control --reload-rules</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
À partir de ce moment, lors de la connexion du chien de garde, un lien </font></font><nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ dev / ttyrst-</font></font></nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> watchdog sera créé </font><font style="vertical-align: inherit;">sur le périphérique souhaité, qui sera utilisé plus tard.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Script bash (ttyrst-watchdog.sh)</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La communication avec le chien de garde s'effectue à une vitesse de 9600 bauds. </font><font style="vertical-align: inherit;">Arduino fonctionne sans problème avec les terminaux à haute vitesse, mais les commandes pour travailler avec du texte (chat, écho, etc.) ne reçoivent et n'envoient que des ordures. </font><font style="vertical-align: inherit;">Il est possible que ce soit une caractéristique de ma seule copie de l'Arduino Nano. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour le cycle de redémarrage du minuteur principal et pour les fonctions de ligne de commande, un script est utilisé. </font><font style="vertical-align: inherit;">La raison en est que les deux composants utilisent une ressource commune - le fichier de périphérique, et il est nécessaire de lui fournir un accès synchrone. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La synchronisation consiste essentiellement en une boucle d'attente:</font></font><pre><code class="bash hljs"><span class="hljs-keyword">while</span> fuser <span class="hljs-variable">${DEVICE}</span> &gt;/dev/null 2&gt;&amp;1; <span class="hljs-keyword">do</span> <span class="hljs-literal">true</span>; <span class="hljs-keyword">done</span></code></pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et capturer l'appareil pendant le temps requis: </font></font><pre><code class="bash hljs">cat &lt;<span class="hljs-variable">${DEVICE}</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De toute évidence, un tel régime est soumis à une condition de concurrence. Vous pouvez gérer cela de manière adulte (par exemple, pour organiser une file d'attente de messages), mais dans ce cas, il suffit de définir correctement les délais afin de garantir un résultat dans un délai acceptable. En fait, l'ensemble du script fonctionne avec des délais d'attente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La diabolisation (exécutée en arrière-plan) est effectuée à l'aide du package OpenRC. Il est supposé que ce script se trouve dans le fichier </font></font><nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/usr/local/bin/ttyrst-watchdog.sh</font></font></nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et que le script OpenRC se trouve dans </font></font><nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/init.d/ttyrst-watchdog</font></font></nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque le démon s'arrête, la désactivation correcte du chien de garde est requise. Pour ce faire, le script définit le gestionnaire de signal qui doit être terminé:</font></font><pre><code class="bash hljs"><span class="hljs-built_in">trap</span> deactivate SIGINT SIGTERM</code></pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Et ici, un problème surgit - OpenRC ne peut pas arrêter le démon, ou plutôt, mais pas souvent. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le fait est que la commande kill envoie un signal au script et que le programme sleep, qui est utilisé pour suspendre le script, est exécuté dans un autre processus et ne reçoit pas le signal. Par conséquent, la fonction de désactivation n'est lancée qu'après la fin du sommeil, ce qui est trop long. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La solution consiste à démarrer le sommeil en arrière-plan et à attendre la fin du processus dans le script:</font></font><pre><code class="bash hljs">sleep <span class="hljs-variable">${SLEEP_TIME}</span> &amp; <span class="hljs-built_in">wait</span> $!  <span class="hljs-comment">#  $!  ID   </span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Constantes de base: </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WATCHDOG_ACTIVE</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - YES ou NO, respectivement, envoient un signal pour redémarrer lorsque le temporisateur est déclenché ou non. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WATCHDOG_TIMER</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - temps en secondes pour lequel la minuterie est réglée. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SLEEP_TIME</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - temps en secondes après lequel le temporisateur doit être redémarré. Il doit être beaucoup plus petit que WATCHDOG_TIMER, mais pas très petit, afin de ne pas créer de charge excessive sur le système et l'appareil. Aux délais d'attente actuels, un minimum raisonnable est d'environ 5 secondes. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DEFAULT_LOG_LINES</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - le nombre d'entrées de journal de périphérique récentes retournées par la commande de journal par défaut. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Commandes de script: </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">démarrer</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- début du cycle de redémarrage de la minuterie principale. </font><font style="vertical-align: inherit;">Vous pouvez ajouter un code de vérification supplémentaire à la fonction is_alive, par exemple, pour vérifier la possibilité de se connecter via ssh. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">état</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - affiche l'état de l'appareil. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reset</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - réinitialisation de l'EEPROM (données de journal) et redémarrage de l'appareil pour restaurer le chien de garde à son état d'origine. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">log &lt;nombre d'entrées&gt;</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - affiche le nombre spécifié d'entrées de journal récentes.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Croquis Arduino (ttyrst-watchdog.ino)</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour compiler avec succès l'esquisse, vous avez besoin d'une bibliothèque de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">temps</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tierce </font><font style="vertical-align: inherit;">, nécessaire à la synchronisation de l'heure. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un croquis se compose de deux fichiers. Cela est dû au fait que l'IDE Arduino n'accepte pas les structures (struct) déclarées dans le fichier principal, elles doivent être déplacées vers un fichier d'en-tête externe. De plus, pour déclarer une structure, le mot-clé typedef n'est pas nécessaire, il est probablement même dangereux ... après avoir vérifié les options standard, je n'ai pas trouvé la syntaxe appropriée. Le reste est du C ++ plus ou moins standard. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les fonctions wdt_enable et wdt_reset fonctionnent avec le chien de garde intégré dans le microcontrôleur. Après avoir initialisé le WDT, la principale chose à retenir est de le réinitialiser dans la boucle principale et à l'intérieur des boucles de toutes les opérations longues.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les entrées de journal sont écrites dans la mémoire EEPROM non volatile, sa taille disponible peut être spécifiée dans logrecord.h, dans ce cas, il est 1024. Le journal est fait sous forme d'anneau, le séparateur est une structure avec des valeurs nulles. </font><font style="vertical-align: inherit;">Le nombre maximum d'entrées pour 1 Kio EEPROM est de 203. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un enregistrement sur le chargement de l'appareil ne parvient au journal qu'après synchronisation de l'heure. </font><font style="vertical-align: inherit;">La synchronisation est effectuée en même temps que le temporisateur est redémarré et avant l'exécution de toute commande lors de l'initialisation du périphérique. </font><font style="vertical-align: inherit;">Sinon, il ne sera pas possible de comparer l'heure correcte avec cet événement, et les informations sur les redémarrages des périphériques, isolément du démon de travail, ne sont pas très intéressantes. </font></font><br>
<br>
<img src="https://habrastorage.org/files/11c/823/d3e/11c823d3eac445b6b543cec6ca061a95.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est tout, merci d'avoir regardé! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les fichiers source du projet sont situés sur </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHub</font></font></a></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr384467/">https://habr.com/ru/post/fr384467/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr384457/index.html">Le travail des modules Wi-Fi Master Kit dans le système de contrôle domotique OpenHAB. Partie 2: Connectez le thermostat MP3502</a></li>
<li><a href="../fr384459/index.html">Un bug dans le moteur Google Chrome avec une baisse de 16 caractères est déjà utilisé pour créer des jeux</a></li>
<li><a href="../fr384461/index.html">Cerveau. Mémoire holographique. Biologie de l'informatique quantique</a></li>
<li><a href="../fr384463/index.html">Attention! Concours d'accessoires imprimés en 3D pour Apple iPhone 6s</a></li>
<li><a href="../fr384465/index.html">Les quadricoptères construisent un pont de corde</a></li>
<li><a href="../fr384471/index.html">Le robot de construction d'Hadrien peut fonctionner 20 fois plus vite que les humains</a></li>
<li><a href="../fr384473/index.html">Parler de cinéma maison</a></li>
<li><a href="../fr384475/index.html">L'examen n'est pas un gadget. Choisir le meilleur étui d'entraînement et autres accessoires pour smartphones: pansements, sacs et poche en silicone Adidas</a></li>
<li><a href="../fr384477/index.html">La NASA testera la technologie de développement d'astéroïdes utilisant la lumière du soleil</a></li>
<li><a href="../fr384479/index.html">Développement de jeux sur Traitement avec contrôle via la carte Arduino Uno</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>