<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üéöÔ∏è ‚Ü™Ô∏è üêå Rapports quotidiens sur l'√©tat des machines virtuelles avec R et PowerShell üë®‚Äçüë©‚Äçüëß‚Äçüë¶ ü§õüèΩ üí±</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Entr√©e 


 Bonjour. Depuis maintenant six mois, nous ex√©cutons un script (plus pr√©cis√©ment un ensemble de scripts) qui g√©n√®re des rapports sur l'√©tat ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Rapports quotidiens sur l'√©tat des machines virtuelles avec R et PowerShell</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/454400/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/px/tu/kg/pxtukg8q2rhe_wcyxiwdbfa9euq.jpeg"></div><br><h4 id="vstuplenie">  Entr√©e </h4><br><p>  Bonjour.  Depuis maintenant six mois, nous ex√©cutons un script (plus pr√©cis√©ment un ensemble de scripts) qui g√©n√®re des rapports sur l'√©tat des machines virtuelles (et pas seulement).  J'ai d√©cid√© de partager l'exp√©rience de cr√©ation et le code lui-m√™me.  Je compte sur la critique et le fait que ce mat√©riel peut √™tre utile √† quelqu'un. </p><a name="habracut"></a><br><h4 id="formirovanie-potrebnosti">  Besoin de formation </h4><br><p>  Nous avons beaucoup de machines virtuelles (environ 1500 VM r√©parties sur le 3√®me vCenter).  De nouveaux sont cr√©√©s et les anciens sont supprim√©s assez souvent.  Pour pr√©server l'ordre, plusieurs champs personnalis√©s ont √©t√© ajout√©s √† vCenter pour diviser les machines virtuelles en sous-syst√®mes, indiquer si elles sont test√©es, ainsi que par qui et quand.  Le facteur humain a conduit au fait que plus de la moiti√© des voitures ont √©t√© laiss√©es avec des champs vides, ce qui a compliqu√© le travail.  Une fois tous les six mois, quelqu'un a paniqu√©, a commenc√© √† mettre √† jour ces donn√©es, mais le r√©sultat a cess√© d'√™tre pertinent pendant une semaine et demie. <br>  Je pr√©cise tout de suite que tout le monde comprend qu'il devrait y avoir des applications pour cr√©er des machines, un processus pour les cr√©er, etc.  etc.  Et tandis que tout ce processus est strictement suivi et en ordre.  Malheureusement, ce n'est pas le cas chez nous, mais ce n'est pas le sujet de l'article :) </p><br><p>  En g√©n√©ral, il a √©t√© d√©cid√© d'automatiser la v√©rification de l'exactitude du remplissage des champs. <br>  Nous avons d√©cid√© qu'une lettre quotidienne avec une liste de machines mal remplies pour tous les ing√©nieurs responsables et leurs sup√©rieurs serait un bon d√©but. </p><br><p>  √Ä ce stade, l'un des coll√®gues avait d√©j√† impl√©ment√© un script PowerShell, qui chaque jour selon un calendrier collectait des informations sur toutes les machines de tous les vCenter et formait 3 documents csv (chacun dans son propre vCenter), qui √©taient dispos√©s sur un disque partag√©.  Il a √©t√© d√©cid√© de prendre ce script comme base et de le compl√©ter avec des v√©rifications en utilisant le langage R, avec lequel j'avais une certaine exp√©rience. </p><br><p>  En cours de finalisation, la solution a √©t√© envahie par des informations par courrier, une base de donn√©es avec les tables principales et historiques (plus d'informations √† ce sujet plus tard), ainsi que par l'analyse des journaux vSphere pour trouver les v√©ritables cr√©ateurs de vm et l'heure de leur cr√©ation. </p><br><p>  Pour le d√©veloppement, IDE RStudio Desktop et PowerShell ISE ont √©t√© utilis√©s. </p><br><p>  Le script est lanc√© √† partir d'une machine virtuelle Windows standard. </p><br><h4 id="opisanie-obschey-logiki">  Description de la logique g√©n√©rale. </h4><br><p>  La logique g√©n√©rale des scripts est la suivante. </p><br><ul><li>  Nous collectons des donn√©es sur des machines virtuelles √† l'aide du script PowerShell, qui est appel√© via R, le r√©sultat est combin√© en un seul csv.  L'interaction inverse entre les langues se fait de mani√®re similaire.  (il √©tait possible de diriger des donn√©es directement de R vers PowerShell sous forme de variables, mais c'est difficile, et m√™me avec un csv interm√©diaire, il est plus facile de d√©boguer et de partager des r√©sultats interm√©diaires avec quelqu'un). </li><li>  En utilisant R, nous formons des param√®tres valides pour les champs dont nous v√©rifions les valeurs.  - Nous formons un document Word qui contiendra les valeurs de ces champs pour l'insertion dans une lettre d'information qui sera une r√©ponse aux questions des coll√®gues "Pas bien, mais comment dois-je le remplir?" </li><li>  Nous chargeons des donn√©es sur toutes les machines virtuelles de csv en utilisant R, formons un cadre de donn√©es, supprimons les champs inutiles et formons un document d'informations xlsx qui contiendra des informations r√©capitulatives sur toutes les machines virtuelles que nous t√©l√©chargeons sur une ressource partag√©e. </li><li>  √Ä la trame de donn√©es pour toutes les machines virtuelles, nous appliquons toutes les v√©rifications de l'exactitude du remplissage des champs et formons un tableau contenant uniquement les machines virtuelles avec des champs incorrectement remplis (et uniquement ces champs). </li><li>  La liste r√©sultante des machines virtuelles est envoy√©e √† un autre script PowerShell, qui examinera les journaux vCenter pour les √©v√©nements de cr√©ation de machines virtuelles, ce qui vous permettra de sp√©cifier l'heure estim√©e de cr√©ation de la machine virtuelle et le cr√©ateur souhait√©.  C'est le cas lorsque personne ne confesse √† qui appartient la voiture.  Ce script ne fonctionne pas rapidement, surtout s'il y a beaucoup de journaux, donc nous ne regardons que les 2 derni√®res semaines, et nous utilisons √©galement le workflow, qui vous permet de rechercher des informations sur plusieurs machines virtuelles en m√™me temps.  Dans l'exemple de script, il existe des commentaires d√©taill√©s sur ce m√©canisme.  Le r√©sultat est ajout√© √† csv, qui est √† nouveau charg√© dans R. </li><li>  Nous formons un document xlsx magnifiquement format√© dans lequel les champs incorrectement remplis seront surlign√©s en rouge, des filtres seront appliqu√©s √† certaines colonnes, et des colonnes suppl√©mentaires contenant les cr√©ateurs pr√©sum√©s et l'heure de la cr√©ation de la VM seront indiqu√©es. </li><li>  Nous formons un e-mail, o√π nous mettons un document d√©crivant les valeurs de champ valides, ainsi qu'un tableau avec un remplissage incorrect.  Dans le texte, nous indiquons le nombre total de VM mal cr√©√©es, un lien vers une ressource partag√©e et une image de motivation.  S'il n'y a pas de VM mal remplies, nous envoyons une autre lettre avec une image de motivation plus joyeuse. </li><li>  Nous enregistrons des donn√©es sur toutes les machines virtuelles dans la base de donn√©es SQL Server, en tenant compte du m√©canisme impl√©ment√© des tables historiques (un m√©canisme tr√®s int√©ressant - dont plus en d√©tail) </li></ul><br><h4 id="sobstvenno-skripty">  Scripts </h4><br><div class="spoiler">  <b class="spoiler_title">Le fichier principal avec le code pour R</b> <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#     (       ) setwd("C:\\Scripts\\getVm") ####    #### library(tidyverse) library(xlsx) library(mailR) library(rmarkdown) #####         ##### source(file = "const.R", local = T, encoding = "utf-8") #        ,  . if (file.exists(filenameVmCreationRules)) {file.remove(filenameVmCreationRules)} ####       render("VM_name_rules.Rmd", output_format = word_document(), output_file = filenameVmCreationRules) #        ,   if (file.exists(allVmXlsxPath)) {file.remove(allVmXlsxPath)} ####       PowerShell .    csv. system(paste0("powershell -File ", getVmPsPath)) #  df fullXslx_df &lt;- allVmXlsxPath %&gt;% read.csv2(stringsAsFactors = FALSE) #     full_df &lt;- fullXslx_df %&gt;% mutate( #       ,    ,      , isSubsystemCorrect = Subsystem %&gt;% gsub("[[:space:]]", "", .) %&gt;% str_split(., ",") %&gt;% map(function(x) (all(x %in% AllowedValues$Subsystem))) %&gt;% as.logical(), isOwnerCorrect = Owner %in% AllowedValues$Owner, isCategoryCorrect = Category %in% AllowedValues$Category, isCreatorCorrect = (!is.na(Creator) &amp; Creator != ''), isCreation.DateCorrect = map(Creation.Date, IsDate) ) #        ,  . if (file.exists(filenameAll)) {file.remove(filenameAll)} ####  xslx    #### #      full_df %&gt;% write.xlsx(file=filenameAll, sheetName=names[1], col.names=TRUE, row.names=FALSE, append=FALSE) ####  xslx      #### #  df incorrect_df &lt;- full_df %&gt;% select(VM.Name, IP.s, Owner, Subsystem, Creator, Category, Creation.Date, isOwnerCorrect, isSubsystemCorrect, isCategoryCorrect, isCreatorCorrect, vCenter.Name) %&gt;% filter(isSubsystemCorrect == F | isOwnerCorrect == F | isCategoryCorrect == F | isCreatorCorrect == F) #        ,  . if (file.exists(filenameIncVM)) {file.remove(filenameIncVM)} #   VM     csv incorrect_df %&gt;% select(VM.Name) %&gt;% write_csv2(path = filenameIncVM, append = FALSE) #      incorrect_df_filtered &lt;- incorrect_df %&gt;% select(VM.Name, IP.s, Owner, Subsystem, Category, Creator, vCenter.Name, Creation.Date ) #    numberOfRows &lt;- nrow(incorrect_df) ####   #### #        ,  . #   -     if (numberOfRows &gt; 0) { #       ,  . if (file.exists(creatorsFilePath)) {file.remove(creatorsFilePath)} #  PowerShell ,     VM.    csv. system(paste0("powershell -File ", getCreatorsPath)) #     creators_df &lt;- creatorsFilePath %&gt;% read.csv2(stringsAsFactors = FALSE) #     ,       incorrect_df_filtered &lt;- incorrect_df_filtered %&gt;% select(VM.Name, IP.s, Owner, Subsystem, Category, Creator, vCenter.Name, Creation.Date ) %&gt;% left_join(creators_df, by = "VM.Name") %&gt;% rename(` ` = CreatedBy, `  ` = CreatedOn) #    emailBody &lt;- paste0( '&lt;html&gt; &lt;h3&gt; ,  .&lt;/h3&gt; &lt;p&gt;           H:  :&lt;p&gt; &lt;p&gt;\\\\server.ru\\VM\\', sourceFileFormat, '&lt;/p&gt; &lt;p&gt;      &lt;strong&gt; &lt;/strong&gt; .   &lt;strong&gt;', numberOfRows,'&lt;/strong&gt;.&lt;/p&gt; &lt;p&gt;   2  . &lt;strong&gt; &lt;/strong&gt;  &lt;strong&gt;  &lt;/strong&gt;,     vCenter   2 &lt;/p&gt; &lt;p&gt;        .      &lt;/p&gt; &lt;p&gt;&lt;img src="data/meme.jpg"&gt;&lt;/p&gt; &lt;/html&gt;' ) #    if (file.exists(filenameIncorrect)) {file.remove(filenameIncorrect)} #       .. source(file = "email.R", local = T, encoding = "utf-8") ####       #### send.mail(from = emailParams$from, to = emailParams$to, subject = "    ", body = emailBody, encoding = "utf-8", html = TRUE, inline = TRUE, smtp = emailParams$smtpParams, authenticate = TRUE, send = TRUE, attach.files = c(filenameIncorrect, filenameVmCreationRules), debug = FALSE) ####   ,      #### } else { #    emailBody &lt;- paste0( '&lt;html&gt; &lt;h3&gt; ,  &lt;/h3&gt; &lt;p&gt;           H:  :&lt;p&gt; &lt;p&gt;\\\\server.ru\\VM\\', sourceFileFormat, '&lt;/p&gt; &lt;p&gt;,   ,     &lt;/p&gt; &lt;p&gt;&lt;img src="data/meme_correct.jpg"&gt;&lt;/p&gt; &lt;/html&gt;' ) ####      VM #### send.mail(from = emailParams$from, to = emailParams$to, subject = " ", body = emailBody, encoding = "utf-8", html = TRUE, inline = TRUE, smtp = emailParams$smtpParams, authenticate = TRUE, send = TRUE, debug = FALSE) } #######     ##### source(file = "DB.R", local = T, encoding = "utf-8")</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Script pour obtenir la liste vm sur PowerShell</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#       $vCenterNames = @( "vcenter01", "vcenter02", "vcenter03" ) $vCenterUsername = "myusername" $vCenterPassword = "mypassword" $filename = "C:\Scripts\getVm\data\allvm\all-vm-$(get-date -f yyyy-MM-dd).csv" $destinationSMB = "\\server.ru\myfolder$\vm" $IP0="" $IP1="" $IP2="" $IP3="" $IP4="" $IP5="" #    vCenter,    .  ,      (, ) Connect-VIServer -Server $vCenterNames -User $vCenterUsername -Password $vCenterPassword write-host "" #       vCenter- function Get-VMinventory { #       ,   $AllVM = Get-VM | Sort Name $cnt = $AllVM.Count $count = 1 #            foreach ($vm in $AllVM) { $StartTime = $(get-date) $IP0 = $vm.Guest.IPAddress[0] $IP1 = $vm.Guest.IPAddress[1] $IP2 = $vm.Guest.IPAddress[2] $IP3 = $vm.Guest.IPAddress[3] $IP4 = $vm.Guest.IPAddress[4] $IP5 = $vm.Guest.IPAddress[5] If ($IP0 -ne $null) {If ($IP0.Contains(":") -ne 0) {$IP0=""}} If ($IP1 -ne $null) {If ($IP1.Contains(":") -ne 0) {$IP1=""}} If ($IP2 -ne $null) {If ($IP2.Contains(":") -ne 0) {$IP2=""}} If ($IP3 -ne $null) {If ($IP3.Contains(":") -ne 0) {$IP3=""}} If ($IP4 -ne $null) {If ($IP4.Contains(":") -ne 0) {$IP4=""}} If ($IP5 -ne $null) {If ($IP5.Contains(":") -ne 0) {$IP5=""}} $cluster = $vm | Get-Cluster | Select-Object -ExpandProperty name $Bootime = $vm.ExtensionData.Runtime.BootTime $TotalHDDs = $vm.ProvisionedSpaceGB -as [int] $CreationDate = $vm.CustomFields.Item("CreationDate") -as [string] $Creator = $vm.CustomFields.Item("Creator") -as [string] $Category = $vm.CustomFields.Item("Category") -as [string] $Owner = $vm.CustomFields.Item("Owner") -as [string] $Subsystem = $vm.CustomFields.Item("Subsystem") -as [string] $IPS = $vm.CustomFields.Item("IP") -as [string] $vCPU = $vm.NumCpu $CorePerSocket = $vm.ExtensionData.config.hardware.NumCoresPerSocket $Sockets = $vCPU/$CorePerSocket $Id = $vm.Id.Split('-')[2] -as [int] #       $Vmresult = New-Object PSObject $Vmresult | add-member -MemberType NoteProperty -Name "Id" -Value $Id $Vmresult | add-member -MemberType NoteProperty -Name "VM Name" -Value $vm.Name $Vmresult | add-member -MemberType NoteProperty -Name "Cluster" -Value $cluster $Vmresult | add-member -MemberType NoteProperty -Name "Esxi Host" -Value $VM.VMHost $Vmresult | add-member -MemberType NoteProperty -Name "IP Address 1" -Value $IP0 $Vmresult | add-member -MemberType NoteProperty -Name "IP Address 2" -Value $IP1 $Vmresult | add-member -MemberType NoteProperty -Name "IP Address 3" -Value $IP2 $Vmresult | add-member -MemberType NoteProperty -Name "IP Address 4" -Value $IP3 $Vmresult | add-member -MemberType NoteProperty -Name "IP Address 5" -Value $IP4 $Vmresult | add-member -MemberType NoteProperty -Name "IP Address 6" -Value $IP5 $Vmresult | add-member -MemberType NoteProperty -Name "vCPU" -Value $vCPU $Vmresult | Add-Member -MemberType NoteProperty -Name "CPU Sockets" -Value $Sockets $Vmresult | Add-Member -MemberType NoteProperty -Name "Core per Socket" -Value $CorePerSocket $Vmresult | add-member -MemberType NoteProperty -Name "RAM (GB)" -Value $vm.MemoryGB $Vmresult | add-member -MemberType NoteProperty -Name "Total-HDD (GB)" -Value $TotalHDDs $Vmresult | add-member -MemberType NoteProperty -Name "Power State" -Value $vm.PowerState $Vmresult | add-member -MemberType NoteProperty -Name "OS" -Value $VM.ExtensionData.summary.config.guestfullname $Vmresult | Add-Member -MemberType NoteProperty -Name "Boot Time" -Value $Bootime $Vmresult | add-member -MemberType NoteProperty -Name "VMTools Status" -Value $vm.ExtensionData.Guest.ToolsStatus $Vmresult | add-member -MemberType NoteProperty -Name "VMTools Version" -Value $vm.ExtensionData.Guest.ToolsVersion $Vmresult | add-member -MemberType NoteProperty -Name "VMTools Version Status" -Value $vm.ExtensionData.Guest.ToolsVersionStatus $Vmresult | add-member -MemberType NoteProperty -Name "VMTools Running Status" -Value $vm.ExtensionData.Guest.ToolsRunningStatus $Vmresult | add-member -MemberType NoteProperty -Name "Creation Date" -Value $CreationDate $Vmresult | add-member -MemberType NoteProperty -Name "Creator" -Value $Creator $Vmresult | add-member -MemberType NoteProperty -Name "Category" -Value $Category $Vmresult | add-member -MemberType NoteProperty -Name "Owner" -Value $Owner $Vmresult | add-member -MemberType NoteProperty -Name "Subsystem" -Value $Subsystem $Vmresult | add-member -MemberType NoteProperty -Name "IP's" -Value $IPS $Vmresult | add-member -MemberType NoteProperty -Name "vCenter Name" -Value $vm.Uid.Split('@')[1].Split(':')[0] #           .   ,      . $elapsedTime = $(get-date) - $StartTime $totalTime = "{0:HH:mm:ss}" -f ([datetime]($elapsedTime.Ticks*($cnt - $count))) clear-host Write-Host "Processing" $count "from" $cnt Write-host "Progress:" ([math]::Round($count/$cnt*100, 2)) "%" Write-host "You have about " $totalTime "for cofee" Write-host "" $count++ #  ,   ""       $Vmresult } } #         csv $allVm = Get-VMinventory | Export-CSV -Path $filename -NoTypeInformation -UseCulture -Force #         ,   ,  . try { Copy-Item $filename -Destination $destinationSMB -Force -ErrorAction SilentlyContinue } catch { $error | Export-CSV -Path $filename".error" -NoTypeInformation -UseCulture -Force }</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Script PowerShell extrayant les journaux des cr√©ateurs de machines virtuelles et leurs dates de cr√©ation</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#   ,      VM $VMfilePath = "C:\Scripts\getVm\creators_VM\creators_VM_$(get-date -f yyyy-MM-dd).csv" #   ,      $filePath = "C:\Scripts\getVm\data\creators\creators-$(get-date -f yyyy-MM-dd).csv" #   Workflow GetCreators-Wf { # ,        param([string[]]$VMfilePath) # ,     workflow $vCenterUsername = "myusername" $vCenterPassword = "mypassword" $daysToLook = 14 $start = (get-date).AddDays(-$daysToLook) $finish = get-date # ,     csv  ,       $UnknownUser = "UNKNOWN" $UnknownCreatedTime = "0000-00-00" #      ,      . $vCenterNames = @( "vcenter01", "vcenter02", "vcenter03" ) #   VM  csv     $list = Import-Csv $VMfilePath -UseCulture | select -ExpandProperty VM.Name # ,     ( 5   ) foreach -parallel ($row in $list) { #  ,       ,     $Using InlineScript { #      $StartTime = $(get-date) Write-Host "" Write-Host "Processing $Using:row started at $StartTime" Write-Host "" #    ,         $con = Connect-VIServer -Server $Using:vCenterNames -User $Using:vCenterUsername -Password $Using:vCenterPassword #   vm $vm = Get-VM -Name $Using:row #  2  .     ,  - .   , $Event = $vm | Get-VIEvent -Start $Using:start -Finish $Using:finish -Types Info | Where { $_.Gettype().Name -eq "VmBeingDeployedEvent" -or $_.Gettype().Name -eq "VmCreatedEvent" -or $_.Gettype().Name -eq "VmRegisteredEvent" -or $_.Gettype().Name -eq "VmClonedEvent"} # $Event = $vm | Get-VIEvent -Types Info | Where { $_.Gettype().Name -eq "VmBeingDeployedEvent" -or $_.Gettype().Name -eq "VmCreatedEvent" -or $_.Gettype().Name -eq "VmRegisteredEvent" -or $_.Gettype().Name -eq "VmClonedEvent"} #      ,      - If (($Event | Measure-Object).Count -eq 0){ $User = $Using:UnknownUser $Created = $Using:UnknownCreatedTime $CreatedFormat = $Using:UnknownCreatedTime } Else { If ($Event.Username -eq "" -or $Event.Username -eq $null) { $User = $Using:UnknownUser } Else { $User = $Event.Username } # Else $CreatedFormat = $Event.CreatedTime #     ,      ,   .      . $Created = $Event.CreatedTime.ToString('yyyy-MM-dd') } # Else Write-Host "Creator for $vm is $User. Creating object." #  .  . $Vmresult = New-Object PSObject $Vmresult | add-member -MemberType NoteProperty -Name "VM Name" -Value $vm.Name $Vmresult | add-member -MemberType NoteProperty -Name "CreatedBy" -Value $User $Vmresult | add-member -MemberType NoteProperty -Name "CreatedOn" -Value $CreatedFormat $Vmresult | add-member -MemberType NoteProperty -Name "CreatedOnFormat" -Value $Created #   $Vmresult } # Inline } # ForEach } $Creators = GetCreators-Wf $VMfilePath #     $Creators | select 'VM Name', CreatedBy, CreatedOn | Export-Csv -Path $filePath -NoTypeInformation -UseCulture -Force Write-Host "CSV generetion finisghed at $(get-date). PROFIT"</span></span></code> </pre></div></div><br><p>  La biblioth√®que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">xlsx</a> m√©rite une attention particuli√®re, ce qui a permis de rendre la pi√®ce jointe √† la lettre clairement format√©e (comme le manuel l'aime), et pas seulement une table csv. </p><br><div class="spoiler">  <b class="spoiler_title">Cr√©ation d'un beau document xlsx avec une liste de machines incorrectement remplies</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#    #   : "xls"  "xlsx" wb&lt;-createWorkbook(type="xlsx") #         TABLE_ROWNAMES_STYLE &lt;- CellStyle(wb) + Font(wb, isBold=TRUE) TABLE_COLNAMES_STYLE &lt;- CellStyle(wb) + Font(wb, isBold=TRUE) + Alignment(wrapText=TRUE, horizontal="ALIGN_CENTER") + Border(color="black", position=c("TOP", "BOTTOM"), pen=c("BORDER_THIN", "BORDER_THICK")) #    sheet &lt;- createSheet(wb, sheetName = names[2]) #   addDataFrame(incorrect_df_filtered, sheet, startRow=1, startColumn=1, row.names=FALSE, byrow=FALSE, colnamesStyle = TABLE_COLNAMES_STYLE, rownamesStyle = TABLE_ROWNAMES_STYLE) #  ,     autoSizeColumn(sheet = sheet, colIndex=c(1:ncol(incorrect_df))) #   addAutoFilter(sheet, cellRange = "C1:G1") #   fo2 &lt;- Fill(foregroundColor="red") cs2 &lt;- CellStyle(wb, fill = fo2, dataFormat = DataFormat("@")) #              rowsOwner &lt;- getRows(sheet, rowIndex = (which(!incorrect_df$isOwnerCorrect) + 1)) cellsOwner &lt;- getCells(rowsOwner, colIndex = which( colnames(incorrect_df_filtered) == "Owner" )) lapply(names(cellsOwner), function(x) setCellStyle(cellsOwner[[x]], cs2)) #              rowsSubsystem &lt;- getRows(sheet, rowIndex = (which(!incorrect_df$isSubsystemCorrect) + 1)) cellsSubsystem &lt;- getCells(rowsSubsystem, colIndex = which( colnames(incorrect_df_filtered) == "Subsystem" )) lapply(names(cellsSubsystem), function(x) setCellStyle(cellsSubsystem[[x]], cs2)) #    rowsCategory &lt;- getRows(sheet, rowIndex = (which(!incorrect_df$isCategoryCorrect) + 1)) cellsCategory &lt;- getCells(rowsCategory, colIndex = which( colnames(incorrect_df_filtered) == "Category" )) lapply(names(cellsCategory), function(x) setCellStyle(cellsCategory[[x]], cs2)) #  rowsCreator &lt;- getRows(sheet, rowIndex = (which(!incorrect_df$isCreatorCorrect) + 1)) cellsCreator &lt;- getCells(rowsCreator, colIndex = which( colnames(incorrect_df_filtered) == "Creator" )) lapply(names(cellsCreator), function(x) setCellStyle(cellsCreator[[x]], cs2)) #   saveWorkbook(wb, filenameIncorrect)</span></span></code> </pre> </div></div><br><p>  La sortie est quelque chose comme ceci: </p><br><img src="https://habrastorage.org/webt/ax/y7/bv/axy7bvclwghyjabvvzuanyb2_ry.jpeg"><br><br>  Il y avait aussi une nuance int√©ressante dans la configuration du planificateur Windows.  Cela n'a pas fonctionn√© pour s√©lectionner les droits et param√®tres corrects afin que tout commence comme il se doit.  En cons√©quence, la biblioth√®que R a √©t√© trouv√©e, qui cr√©e elle-m√™me une t√¢che pour ex√©cuter le script R et n'oublie m√™me pas le fichier journal.  Ensuite, vous pouvez corriger la t√¢che avec des stylos. <br><br><br><div class="spoiler">  <b class="spoiler_title">Un morceau de code R avec deux exemples qui cr√©e une t√¢che dans le planificateur Windows</b> <div class="spoiler_text"><pre> <code class="python hljs">library(taskscheduleR) myscript &lt;- file.path(getwd(), <span class="hljs-string"><span class="hljs-string">"all_vm.R"</span></span>) <span class="hljs-comment"><span class="hljs-comment">##    62  taskscheduler_create(taskname = "getAllVm", rscript = myscript, schedule = "ONCE", starttime = format(Sys.time() + 62, "%H:%M")) ##      09:10 taskscheduler_create(taskname = "getAllVmDaily", rscript = myscript, schedule = "WEEKLY", days = c("MON", "TUE", "WED", "THU", "FRI"), starttime = "02:00") ##   taskscheduler_delete(taskname = "getAllVm") taskscheduler_delete(taskname = "getAllVmDaily") #   ( 4 ) tail(readLines("all_vm.log"), sep ="\n", n = 4)</span></span></code> </pre> </div></div><br><h4 id="otdelno-pro-bd">  S√©par√©ment, sur la base de donn√©es </h4><br><p>  Apr√®s avoir configur√© le script, d'autres questions ont commenc√© √† appara√Ætre.  Par exemple, je voulais trouver la date √† laquelle la machine virtuelle a √©t√© supprim√©e et les journaux dans vCenter √©taient d√©j√† us√©s.  Puisque le script place les fichiers dans le dossier tous les jours et ne les nettoie pas (nous les nettoyons avec nos mains quand nous nous souvenons), vous pouvez regarder les anciens fichiers et trouver le premier fichier dans lequel cette machine virtuelle ne se trouve pas.  Mais ce n'est pas cool. </p><br><p>  Je voulais cr√©er une base de donn√©es historique. </p><br><p>  La fonctionnalit√© MS SQL SERVER est venue √† l'aide - une table temporelle versionn√©e par le syst√®me.  Il est g√©n√©ralement traduit par des tables temporaires (non temporaires). </p><br><p>  Vous pouvez lire en d√©tail dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation officielle de Microsoft</a> . </p><br><p>  En bref, nous cr√©ons une table, nous disons que nous l'aurons avec la gestion des versions et SQL Server cr√©e 2 colonnes datetime suppl√©mentaires dans cette table (la date √† laquelle l'enregistrement a √©t√© cr√©√© et la date √† laquelle l'enregistrement a expir√©) et une table suppl√©mentaire dans laquelle les modifications seront √©crites.  En cons√©quence, nous obtenons des informations pertinentes et, √† travers de simples requ√™tes, dont des exemples sont donn√©s dans la documentation, nous pouvons voir soit le cycle de vie d'une machine virtuelle particuli√®re, soit l'√©tat de toutes les VM √† un certain moment. </p><br><p>  En termes de performances, la transaction d'√©criture dans la table principale ne sera pas termin√©e tant que la transaction d'√©criture dans la table temporaire ne sera pas termin√©e.  C'est-√†-dire  sur les tables avec un grand nombre d'op√©rations d'√©criture, cette fonctionnalit√© doit √™tre impl√©ment√©e avec prudence, mais dans notre cas, c'est une chose tr√®s cool. </p><br><p>  Pour que le m√©canisme fonctionne correctement, il √©tait n√©cessaire d'ajouter un petit morceau de code sur R qui comparerait la nouvelle table avec les donn√©es de toutes les machines virtuelles √† celle stock√©e dans la base de donn√©es et n'y √©crirait que les lignes modifi√©es.  Le code n'est pas tr√®s d√©licat, il utilise la biblioth√®que compareDF, mais je vais aussi le donner ci-dessous. </p><br><div class="spoiler">  <b class="spoiler_title">Code R pour √©crire des donn√©es dans la base de donn√©es</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#   library(odbc) library(compareDF) #   con &lt;- dbConnect(odbc(), Driver = "ODBC Driver 13 for SQL Server", Server = DBParams$server, Database = DBParams$database, UID = DBParams$UID, PWD = DBParams$PWD, Port = 1433) ####    .   - . #### if (!dbExistsTable(con, DBParams$TblName)) { ####   #### create &lt;- dbSendStatement( con, paste0( 'CREATE TABLE ', DBParams$TblName, '( [Id] [int] NOT NULL PRIMARY KEY CLUSTERED, [VM.Name] [varchar](255) NULL, [Cluster] [varchar](255) NULL, [Esxi.Host] [varchar](255) NULL, [IP.Address.1] [varchar](255) NULL, [IP.Address.2] [varchar](255) NULL, [IP.Address.3] [varchar](255) NULL, [IP.Address.4] [varchar](255) NULL, [IP.Address.5] [varchar](255) NULL, [IP.Address.6] [varchar](255) NULL, [vCPU] [int] NULL, [CPU.Sockets] [int] NULL, [Core.per.Socket] [int] NULL, [RAM..GB.] [int] NULL, [Total.HDD..GB.] [int] NULL, [Power.State] [varchar](255) NULL, [OS] [varchar](255) NULL, [Boot.Time] [varchar](255) NULL, [VMTools.Status] [varchar](255) NULL, [VMTools.Version] [int] NULL, [VMTools.Version.Status] [varchar](255) NULL, [VMTools.Running.Status] [varchar](255) NULL, [Creation.Date] [varchar](255) NULL, [Creator] [varchar](255) NULL, [Category] [varchar](255) NULL, [Owner] [varchar](255) NULL, [Subsystem] [varchar](255) NULL, [IP.s] [varchar](255) NULL, [vCenter.Name] [varchar](255) NULL, DateFrom datetime2 GENERATED ALWAYS AS ROW START NOT NULL, DateTo datetime2 GENERATED ALWAYS AS ROW END NOT NULL, PERIOD FOR SYSTEM_TIME (DateFrom, DateTo) ) ON [PRIMARY] WITH (SYSTEM_VERSIONING = ON (HISTORY_TABLE = ', DBParams$TblHistName,'));' ) ) #    dbClearResult(create) } # if ####     #### #  ,     allVM_db_con &lt;- tbl(con, DBParams$TblName) ####   #### #     (   ) allVM_db &lt;- allVM_db_con %&gt;% select(c(-"DateTo", -"DateFrom")) %&gt;% collect() #     .   Id #       -,   +,   -  + ctable_VM &lt;- fullXslx_df %&gt;% compare_df(allVM_db, c("Id")) ####   #### #  Id ,      remove_Id &lt;- ctable_VM$comparison_df %&gt;% filter(chng_type == "-") %&gt;% select(Id) # ,    (   -     ) if (remove_Id %&gt;% nrow() &gt; 0) { #        delete &lt;- dbSendStatement(con, paste0(' DELETE FROM ', DBParams$TblName, ' WHERE "Id"=? ') # paste ) # send #      dbBind(delete, remove_Id) #    dbClearResult(delete) } # if ####   #### #  ,  ,   . allVM_add &lt;- ctable_VM$comparison_df %&gt;% filter(chng_type == "+") %&gt;% select(-chng_type) # ,   ,      (  -  ) if (allVM_add %&gt;% nrow() &gt; 0) { #       dbWriteTable(con, DBParams$TblName, allVM_add, overwrite = FALSE, append = TRUE) } # if ####     #### dbDisconnect(con)</span></span></code> </pre> </div></div><br><h4 id="itogo">  Total </h4><br><p>  √Ä la suite de l'introduction du script, l'ordre a √©t√© maintenu et maintenu pendant plusieurs mois.  Parfois, des machines virtuelles mal remplies apparaissent, mais le script sert de bon rappel et une machine virtuelle rare entre dans la liste pendant 2 jours cons√©cutifs. </p><br><p>  Une r√©serve a √©galement √©t√© constitu√©e pour l'analyse des donn√©es historiques. </p><br><p>  Il est clair qu'une grande partie de cela peut √™tre r√©alis√©e non pas ¬´sur le genou¬ª, mais avec un logiciel sp√©cialis√©, mais la t√¢che √©tait int√©ressante et, pourrait-on dire, facultative. </p><br><p>  R s'est r√©v√©l√© une fois de plus √™tre un merveilleux langage universel, parfait non seulement pour r√©soudre des probl√®mes statistiques, mais aussi comme un excellent ¬´pontage¬ª entre d'autres sources de donn√©es. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/g6/bn/1i/g6bn1ijgn9x3_e2nhnjq6jk5bdw.jpeg"></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr454400/">https://habr.com/ru/post/fr454400/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr454386/index.html">MessageBox pour AvaloniaUI</a></li>
<li><a href="../fr454388/index.html">ARA: algorithme pour trouver le nombre maximum de points sur une ligne droite</a></li>
<li><a href="../fr454394/index.html">Lecteur MIDI minimaliste en quatre parties</a></li>
<li><a href="../fr454396/index.html">Installer sdl2 sur les principales distributions</a></li>
<li><a href="../fr454398/index.html">Des critiques aux algorithmes: comment la d√©mocratie et la technocratie sont venues dans l'industrie musicale</a></li>
<li><a href="../fr454402/index.html">Architecture de la machine d'√©tat Unity pour l'organisation des comportements d'unit√©</a></li>
<li><a href="../fr454404/index.html">Formation Cisco 200-125 CCNA v3.0. Jour 6. Remplissez les blancs (DHCP, TCP, ¬´handshake¬ª, num√©ros de port communs)</a></li>
<li><a href="../fr454406/index.html">Akihabara: site de nidification des otaku</a></li>
<li><a href="../fr454408/index.html">CortexM3 / M4 (ARM) bande de bits mat√©rielle, architecture du noyau, assembleur, C / C ++ 14 et une goutte de m√©taprogrammation</a></li>
<li><a href="../fr454410/index.html">Nouveau dans PHP 7.4</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>