<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßùüèæ üì∫ üöú ESP32 + Arduino Core + FreeRTOS + Blynk = maison avec les d√©buts de l'esprit üëÜüèæ ‚¨ÜÔ∏è üò†</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Objectifs du projet 


 D'une certaine mani√®re, il s'est av√©r√© que j'ai construit ma maison, un squelette. Dans mon aul de luxe, il n'y a pas de gaz e...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ESP32 + Arduino Core + FreeRTOS + Blynk = maison avec les d√©buts de l'esprit</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/479156/"><h2 id="celi-proekta">  Objectifs du projet </h2><br><p> D'une certaine mani√®re, il s'est av√©r√© que j'ai construit ma maison, un squelette.  Dans mon aul de luxe, il n'y a pas de gaz et n'est pas pr√©vu dans un avenir proche, c'est pourquoi j'ai choisi un squelette - tout le reste, pour moi, il serait tr√®s co√ªteux de chauffer √† l'√©lectricit√©.  Eh bien, aussi parce que c'est l'une des technologies les moins ch√®res. <br>  D'accord, j'ai jet√© des tuyaux autour de la maison, accroch√© des piles, une chaudi√®re, il semblait chaud, mais quelque chose n'allait pas. </p><br><p>  Apr√®s m'√™tre √©cout√©, j'ai r√©alis√© que c'est un crapaud que je n'aime pas, que pendant que je ne suis pas √† la maison (12-16 heures par jour), le chauffage fonctionne.  Et cela pourrait ne pas fonctionner, ne l'allumez qu'avant l'arriv√©e, car le squelette a une l√©g√®re inertie et vous permet d'augmenter rapidement la temp√©rature.  La m√™me situation quand quelque part depuis longtemps pour quitter la maison.  Eh bien, en g√©n√©ral, courir, tourner la poign√©e de la chaudi√®re avec des changements de temp√©rature dans la rue n'est en quelque sorte pas casher. </p><a name="habracut"></a><br><p>  Il est devenu clair que sans automatisation, nulle part, la chaudi√®re est la plus simple, mais elle a des contacts pour connecter un relais de contr√¥le externe.  Bien s√ªr, vous pouvez imm√©diatement acheter une chaudi√®re avec toutes les fonctions n√©cessaires, mais pour moi, ces chaudi√®res sont en quelque sorte inhumaines.  De plus, je voulais m'accroupir avec le cerveau, faire pipi quelque chose pour l'√¢me, apprendre un petit C, bien que dans la version Arduino. </p><br><p>  En fait sur les exigences: </p><br><ul><li>  contr√¥le de la temp√©rature de consigne </li><li>  contr√¥le de la temp√©rature du liquide de refroidissement en fonction de la temp√©rature ext√©rieure ou manuellement </li><li>  fuseaux horaires avec diff√©rents r√©glages, plus froid le jour, plus chaud la nuit </li><li>  mode automatique, avec transition jour-nuit automatique </li><li>  mode manuel, pas de transitions automatiques, pour le week-end </li><li>  mode non automatique, o√π vous pouvez r√©gler manuellement la temp√©rature du liquide de refroidissement et allumer / √©teindre la chaudi√®re </li><li>  contr√¥le du chauffage localement, depuis les boutons et l'√©cran et via le site web / l'application mobile </li></ul><br><p>  C'√©tait au d√©but, puis j'ai souffert et j'ai ajout√©: </p><br><ul><li>  commande de r√©verb√®re (projecteur LED) </li><li>  syst√®me d'alarme bas√© sur d√©tecteur de mouvement, sir√®ne et lampadaire </li><li>  mesure de l'√©nergie consomm√©e par la chaudi√®re par jour / mois / ann√©e + pour chaque mois de l'ann√©e </li><li>  mode alarme uniquement par clignotement lent d'une lampe </li><li>  mode de signalisation par clignotement rapide d'une lampe et bips courts d'une sir√®ne </li><li>  mode de signalisation par clignotement rapide d'une lampe et hurlement constant d'une sir√®ne </li></ul><br><p>  Le but de cet article est de partager l'exp√©rience, de d√©crire quelque chose en russe que je n'ai pas trouv√© sur Internet.  Je pense que cet article sera utile aux bricoleurs d√©butants Arduino qui sont d√©j√† un peu familiaris√©s avec la programmation, comme  des choses absolument basiques que je n'ai pas d√©crites.  J'ai essay√© d'√©crire le code aussi clairement que possible, j'esp√®re avoir r√©ussi. </p><br><h2 id="chto-bylo-v-nachale">  Ce qui √©tait au d√©but </h2><br><p>  Initialement, le projet a √©t√© mis en ≈ìuvre sur un tas sauvage d'Arduino Nano + ESP8266, mais ESP n'est pas un bouclier, mais un appareil s√©par√©.  Pourquoi  Oui, parce que j'avais d√©j√† tout cela, mais il n'y avait pas d'argent du tout, donc je ne voulais pas acheter de fer neuf en principe.  Pourquoi ESP n'est-il pas comme un bouclier?  Maintenant, je ne me souviens m√™me plus. </p><br><p>  Arduino a dirig√© tous les processus parce qu'il avait la quantit√© requise de GPIO, et ESP a envoy√© toutes les donn√©es au serveur Blynk, car il connaissait Internet et n'avait pas assez de GPIO.  Ils se sont connect√©s via UART et se sont envoy√©s des donn√©es avec JSON.  Le r√©gime est inhabituel, mais il a fonctionn√© pendant un an avec presque aucune plainte.  <a href="https://github.com/abashind/HomeHeater">Toute personne</a> int√©ress√©e peut voir le <a href="https://github.com/abashind/HomeHeater">codec</a> . </p><br><p>  Je ferai une r√©servation tout de suite, je n‚Äô√©tais pas tr√®s habile √† ce moment-l√† (et m√™me maintenant je voudrais le faire mieux), donc c'est mieux pour les femmes enceintes et les enfants de ne pas regarder.  De plus, tout a √©t√© √©crit dans l'IDE Arduino, on ne s'en souviendra pas de nuit, ce qui est tr√®s limit√© en termes de refactoring, tout y est tr√®s primitif. </p><br><h2 id="zhelezo">  Le fer </h2><br><p>  Ainsi, un an s'est √©coul√©, les finances ont permis d'acheter ESP32 devkit v1, qui a suffisamment de GPIO, peut acc√©der √† Internet et g√©n√©ralement √† un super contr√¥leur.  En plus des blagues, je l'aimais beaucoup √† la fin du travail. </p><br><p>  Liste de fer: </p><br><ul><li>  ESP32 devkit v1 noname Chine </li><li>  3 capteurs de temp√©rature DS18B20, temp√©rature √† l'int√©rieur de la maison, √† l'ext√©rieur et la temp√©rature du liquide de refroidissement dans les tuyaux </li><li>  bloc de 4 relais </li><li>  capteur pir HC-SR501 </li></ul><br><p>  Je ne dessinerai pas de sch√©ma, je pense que tout sera clair √† partir des macros avec les noms des broches. </p><br><h2 id="pochemu-freertos-i-arduino-core">  Pourquoi FreeRTOS et Arduino Core </h2><br><p>  Un tas de biblioth√®ques sont √©crites sur Arduino, en particulier le m√™me Blynk, donc vous ne vous √©loignerez pas d'Arduino Core. </p><br><p>  FreeRTOS car il vous permet d'organiser le travail d'un petit morceau de fer similaire au travail d'un contr√¥leur industriel √† part enti√®re.  Chaque t√¢che peut √™tre d√©plac√©e dans sa propre t√¢che, arr√™t√©e, d√©marr√©e, cr√©√©e si n√©cessaire, supprim√©e - tout cela est beaucoup plus flexible que d'√©crire une longue merde de code Arduino, quand √† la fin tout se fait √† son tour dans la fonction de boucle. </p><br><p>  Lors de l'utilisation de FreeRTOS, chaque t√¢che sera ex√©cut√©e √† une heure strictement sp√©cifi√©e, si seule la puissance du processeur est suffisante.  Au contraire, dans Arduino, tout le code est ex√©cut√© dans une fonction, dans un thread, si quelque chose ralentit, le reste des t√¢ches sera retard√©.  Ceci est particuli√®rement visible lors de la gestion de processus rapides, dans ce projet, ce clignotement d'une lampe de poche et d'un bip de sir√®ne sera discut√© ci-dessous. </p><br><h2 id="pro-logiku">  √Ä propos de la logique </h2><br><h3 id="pro-freertos-taski">  √Ä propos des t√¢ches FreeRTOS </h3><br><p>  ‚Üí Lien vers l' <a href="https://github.com/abashind/home_auto_2019">ensemble du codec du projet</a> </p><br><p>  Ainsi, lorsque vous utilisez FreeRTOS, la fonction de configuration joue le r√¥le de la fonction principale, le point d'entr√©e de l'application, les t√¢ches FreeRTOS (ci-apr√®s les t√¢ches) y sont cr√©√©es, la fonction de boucle ne peut pas √™tre utilis√©e du tout. </p><br><p>  Consid√©rons une petite t√¢che pour calculer la temp√©rature du liquide de refroidissement: </p><br><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">calculate_water_temp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *pvParameters)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (heating_mode == <span class="hljs-number"><span class="hljs-number">3</span></span>) {} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (temp_outside &gt; <span class="hljs-number"><span class="hljs-number">-20</span></span>) max_water_temp = <span class="hljs-number"><span class="hljs-number">60</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (temp_outside &lt;= <span class="hljs-number"><span class="hljs-number">-20</span></span> &amp;&amp; temp_outside &gt; <span class="hljs-number"><span class="hljs-number">-25</span></span>) max_water_temp = <span class="hljs-number"><span class="hljs-number">65</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (temp_outside &lt;= <span class="hljs-number"><span class="hljs-number">-25</span></span> &amp;&amp; temp_outside &gt; <span class="hljs-number"><span class="hljs-number">-30</span></span>) max_water_temp = <span class="hljs-number"><span class="hljs-number">70</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (temp_outside &lt;= <span class="hljs-number"><span class="hljs-number">-30</span></span>) max_water_temp = <span class="hljs-number"><span class="hljs-number">85</span></span>; } vTaskDelay(<span class="hljs-number"><span class="hljs-number">1000</span></span> / portTICK_RATE_MS); } }</code> </pre> <br><p>  Il est d√©clar√© comme une fonction qui doit prendre _void <code>pvParameters</code> , une boucle sans fin est organis√©e √† l'int√©rieur de la fonction, j'ai utilis√© <code>while (true)</code> . </p><br><p>  Un simple calcul de temp√©rature est <code>vTaskDelay(1000 / portTICK_RATE_MS)</code> (si le mode de fonctionnement le permet) puis la t√¢che est euthanasi√©e par <code>vTaskDelay(1000 / portTICK_RATE_MS)</code> pendant 1 seconde.  Dans ce mode, il ne consomme pas de temps CPU, les variables avec lesquelles la t√¢che a travaill√©, en d'autres termes, le contexte, sont stock√©es sur la pile pour les sortir de l√† le moment venu. </p><br><p>  La t√¢che suivante doit √™tre cr√©√©e dans la configuration.  Cela se fait en appelant la m√©thode <code>xTaskCreate</code> : </p><br><p> <code>xTaskCreate(calculate_water_temp, "calculate_water_temp", 2048, NULL, 1, NULL);</code> </p> <br><p>  Il existe de nombreux arguments, mais pour nous, <em>Calculate_water_temp</em> est significatif - le nom de la fonction contenant le code de t√¢che et 2048 est la taille de la pile en octets. </p><br><p>  La taille de la pile a initialement d√©fini tout le monde √† 1024 octets, puis j'ai calcul√© la m√©thode souhait√©e en tapant, si le contr√¥leur commen√ßait √† tomber avec un d√©bordement de pile (comme on peut le voir sur la sortie dans uart), j'ai juste augment√© la taille de la pile de 2 fois, si cela n'a pas aid√©, de 2 fois et ainsi de suite jusqu'√† ce que cela fonctionne.  Bien s√ªr, cela n'√©conomise pas trop de m√©moire, mais ESP32 en a assez, dans mon cas, vous ne pourriez pas vous emb√™ter avec cela. </p><br><p>  Vous pouvez √©galement sp√©cifier un descripteur pour la t√¢che - un descripteur avec lequel vous pouvez contr√¥ler la t√¢che apr√®s la cr√©ation, par exemple - supprimer.  Il s'agit du dernier NULL de l'exemple.  Une poign√©e est cr√©√©e comme ceci: </p><br><p> <code>TaskHandle_t slow_blink_handle;</code> </p> <br><p>  Ensuite, lors de la cr√©ation d'une t√¢che, un pointeur vers le <code>xTaskCreate</code> transmis au param√®tre xTaskCreate: </p><br><p> <code>xTaskCreate(outside_lamp_blinks, "outside_lamp_blynk", 10000, (void *)1000, 1, &amp;slow_blink_handle);</code> </p> <br><p>  Et si nous voulons supprimer la t√¢che, nous le faisons: </p><br><p> <code>vTaskDelete(slow_blink_handle);</code> </p> <br><p>  Comment cela est utilis√© peut √™tre vu dans le code de <code>panic_control</code> panic_control. </p><br><h3 id="pro-freertos-myuteksy">  FreeRTOS Mutex Pros </h3><br><p>  Mutex est utilis√© pour √©liminer les conflits entre les t√¢ches lors de l'acc√®s √† des ressources telles que uart, wifi, etc.  Dans mon cas, j'avais besoin de mutex pour le wifi et l'acc√®s √† la m√©moire flash. </p><br><p>  Cr√©ez un lien vers le mutex: </p><br><p> <code>SemaphoreHandle_t wifi_mutex;</code> </p> <br><p>  Dans la <code>setup</code> cr√©ez un mutex: </p><br><p> <code>wifi_mutex = xSemaphoreCreateMutex();</code> </p> <br><p>  De plus, lorsque nous avons besoin d'acc√©der √† la ressource de t√¢che, il prend le mutex, informant ainsi le reste des t√¢ches que la ressource est occup√©e et qu'il n'est pas n√©cessaire d'essayer de travailler avec elle: </p><br><p> <code>xSemaphoreTake(wifi_mutex, portMAX_DELAY);</code> </p> <br><p>  <code>portMAX_DELAY</code> - attendre ind√©finiment jusqu'√† ce que la ressource et le mutex soient lib√©r√©s par d'autres t√¢ches, pendant tout ce temps, la t√¢che va dormir. </p><br><p>  Apr√®s avoir travaill√© avec la ressource, nous donnons le mutex pour que d'autres puissent l'utiliser: </p><br><p> <code>xSemaphoreGive(wifi_mutex);</code> </p> <br><p>  Vous pouvez voir le code plus en <code>send_data_to_blynk</code> dans la <code>send_data_to_blynk</code> send_data_to_blynk. </p><br><p>  En pratique, la non-utilisation de mutex n'√©tait pas perceptible pendant le fonctionnement du contr√¥leur, mais lors du d√©bogage JTAG, des erreurs disparaissaient constamment qui disparaissaient apr√®s l'utilisation des mutex. </p><br><h3 id="kratkoe-opisanie-tasok">  Br√®ve description de tasok </h3><br><p>  <code>get_temps</code> - recevoir la temp√©rature des capteurs, toutes les 30 secondes, plus souvent ce n'est pas n√©cessaire. <br>  <code>get_time_task</code> - r√©cup√®re l'heure des serveurs NTP.  Auparavant, le temps venait du module RTC DS3231, mais il a commenc√© √† √©chouer apr√®s un an de travail, j'ai donc d√©cid√© de m'en d√©barrasser.  J'ai d√©cid√© que cela n'avait pas de cons√©quences particuli√®res pour moi, principalement le temps affectait la commutation du fuseau horaire de chauffage - jour ou nuit.  Si Internet dispara√Æt pendant le fonctionnement du contr√¥leur, l'heure se figera simplement, le fuseau horaire restera simplement le m√™me.  Si le contr√¥leur s'√©teint et apr√®s avoir allum√©, il n'y a pas d'Internet, l'heure sera toujours 0:00:00 - mode chauffage la nuit. <br>  <code>calculate_water_temp</code> - consid√©r√© ci-dessus. <br>  <code>detect_pir_move</code> - r√©ception d'un signal de mouvement du capteur HC-SR501.  Le capteur forme une unit√© logique + 3,3 V lorsqu'un mouvement est d√©tect√©, qui est d√©tect√© √† l'aide de <code>digitalRead</code> , en passant, la broche de d√©tection de ce capteur doit √™tre tir√©e jusqu'√† GND - <code>pinMode(pir_pin, INPUT_PULLDOWN);</code> <br>  <code>heating_control</code> - commutation des modes de chauffage. <br>  <code>out_lamp_control</code> - contr√¥le d'un r√©verb√®re. <br>  <code>panic_control</code> - contr√¥le la sir√®ne et le projecteur lorsqu'un mouvement est d√©tect√©.  Pour cr√©er l'effet des sir√®nes et des feux clignotants, des t√¢ches distinctes sont utilis√©es, <code>outside_lamp_blinks</code> et <code>siren_beeps</code> .  Lorsque vous utilisez FreeRTOS, le clignotement et les bips fonctionnent parfaitement, exactement aux intervalles d√©finis, d'autres t√¢ches n'affectent pas leur travail, car  ils vivent dans des ruisseaux s√©par√©s.  FreeRTOS garantit que le code de la t√¢che s'ex√©cutera √† l'heure sp√©cifi√©e.  Lors de la mise en ≈ìuvre de ces fonctions dans la <code>loop</code> tout ne fonctionnait pas si bien, car  influenc√© par l'ex√©cution d'un autre code. <br>  <code>guard_control</code> - contr√¥le des modes de garde. <br>  <code>send_data_to_blynk</code> - envoie des donn√©es √† l'application Blynk. <br>  <code>run_blynk</code> - t√¢che pour lancer <code>Blynk.run()</code> comme requis par le manuel d'utilisation de Blynk.  Si je comprends bien, cela est n√©cessaire pour obtenir des donn√©es de l'application vers le contr√¥leur.  En g√©n√©ral, <code>Blynk.run()</code> devrait √™tre dans une <code>loop</code> , mais je ne voulais essentiellement rien y mettre et j'en ai fait une t√¢che distincte. <br>  <code>write_setting_to_pref</code> - enregistre les param√®tres et les modes de fonctionnement afin de les rattraper apr√®s un red√©marrage.  A propos de pref sera d√©crit ci-dessous. <br>  <code>count_heated_hours</code> - compter le temps de fonctionnement de la chaudi√®re.  Je l'ai fait simplement, si la chaudi√®re est allum√©e au moment du lancement de la t√¢che (une fois toutes les 30 secondes), dans la m√©moire flash la valeur de la touche souhait√©e est incr√©ment√©e d'une unit√©. <br>  <code>send_heated_hours_to_app</code> - dans cette t√¢che, les valeurs sont extraites et multipli√©es par 0,00833 (1/120 heures), les heures de fonctionnement re√ßues de la chaudi√®re sont envoy√©es √† l'application Blynk. <br>  <code>feed_watchdog</code> - nourrit Watchdog.  J'ai d√ª √©crire un chien de garde, car  une fois tous les quelques jours, le contr√¥leur peut geler.  Ce avec quoi il est connect√© n'est pas clair, il peut y avoir une sorte d'interf√©rence avec l'alimentation, mais l'utilisation d'un chien de garde r√©sout ce probl√®me.  Minuteur de surveillance 10 secondes, ce n'est pas grave si le contr√¥leur n'est pas disponible pendant 10 secondes. <br>  <code>heart_beat</code> - t√¢che avec une impulsion.  Lorsque je passe le contr√¥leur, je veux savoir que cela fonctionne bien.  Parce que  sur ma carte il n'y a pas de LED int√©gr√©e, j'ai d√ª utiliser la LED UART - installer <code>Serial.begin(9600);</code>  et √©crire une longue cha√Æne dans UART.  Cela fonctionne plut√¥t bien. </p><br><h3 id="esp32-nvs-wear-leveling">  Nivellement d'usure ESP32 NVS </h3><br><p>  <em>Les descriptions suivantes sont assez grossi√®res, litt√©ralement sur les doigts, juste pour transmettre l'essence du probl√®me.</em>  <em><a href="https://docs.espressif.com/projects/esp-idf/en/latest/api-reference/storage/nvs_flash.html">Plus de d√©tails</a></em> </p><br><p>  Arduino utilise la m√©moire EEPROM pour stocker des donn√©es dans une m√©moire non volatile.  Il s'agit d'une petite m√©moire dans laquelle chaque octet peut √™tre √©crit et effac√© s√©par√©ment, tandis que la m√©moire flash n'est effac√©e que par secteurs. </p><br><p>  Il n'y a pas d'EEPROM dans ESP32, mais il y a g√©n√©ralement une m√©moire flash de 4 Mo dans laquelle vous pouvez cr√©er des partitions pour le microprogramme du contr√¥leur ou pour stocker les donn√©es utilisateur.  Les sections pour les donn√©es utilisateur sont de plusieurs types - NVS, FATFS, SPIFFS.  Il doit √™tre s√©lectionn√© en fonction du type de donn√©es destin√©es √† l'enregistrement. </p><br><p>  Parce que  toutes les donn√©es √©crites dans ce projet sont de type Int, j'ai choisi NVS - Non-Volitile Storage.  Ce type de partition est bien adapt√© au stockage de petites donn√©es, souvent √©crasables.  Pour comprendre pourquoi, vous devriez approfondir un peu l'organisation de NVS. </p><br><p>  L'EEPROM et le FLASH ont une restriction sur l'√©crasement des donn√©es, les octets de l'EEPROM peuvent √™tre √©cras√©s de 100 000 √† 1 000 000 de fois, le secteur FLASH est le m√™me.  Si nous √©crivons des donn√©es une fois par seconde, nous obtenons alors 60 secondes x 60 minutes x 24 heures = 86 400 fois / jour.  Autrement dit, dans ce mode, l'octet durera 11 jours, ce qui est un peu.  Apr√®s quoi l'octet ne sera pas disponible pour l'√©criture et la lecture. </p><br><p>  Pour att√©nuer ce probl√®me, les fonctions <code>update()</code> <code>put()</code> de la biblioth√®que Arduino EEPROM n'√©crivent des donn√©es que lorsqu'elles changent.  Autrement dit, vous pouvez √©crire chaque seconde des param√®tres et des codes de mode qui changent assez rarement. </p><br><p>  NVS utilise une m√©thode diff√©rente pour contr√¥ler le niveau d'usure.  Comme mentionn√© ci-dessus, les donn√©es du secteur flash peuvent √™tre √©crites en parties, mais seul le secteur entier peut √™tre effac√©.  Par cons√©quent, l'enregistrement des donn√©es dans NVS est effectu√© dans une sorte de journal, ce journal est divis√© en pages, qui sont plac√©es dans un secteur de la m√©moire flash.  Les donn√©es sont √©crites par paires cl√©: valeur.  En fait, c'est encore plus facile qu'avec l'EEPROM, car  travailler avec un nom significatif est plus facile qu'avec une adresse en m√©moire.  <strong>Upd:</strong> la longueur de la cl√© ne d√©passe pas 15 caract√®res! </p><br><p>  Si vous √©crivez d'abord la valeur <code>1</code> sur la cl√© <code>somekey</code> , puis √©crivez la valeur <code>2</code> sur la m√™me cl√©, la premi√®re valeur ne sera pas supprim√©e, elle sera uniquement marqu√©e comme supprim√©e (effac√©e) et une nouvelle entr√©e sera ajout√©e au journal: </p><br><p><img src="https://habrastorage.org/webt/pw/ri/of/pwriofnineuwy7bmctgzcngiqrk.jpeg"></p><br><p>  Si vous essayez de lire des donn√©es par une <code>somekey</code> derni√®re valeur de cette cl√© sera retourn√©e.  Parce que  √âtant donn√© que le journal est commun, les valeurs des diff√©rentes cl√©s sont stock√©es les unes √† c√¥t√© des autres au fur et √† mesure qu'elles sont √©crites. </p><br><p>  La page a un statut, Vide - vide, sans entr√©es, Actif - les donn√©es y sont actuellement √©crites, Complet - est plein, vous ne pouvez pas y √©crire.  D√®s que la page manque d'espace, elle est de <br>  Active passe √† Complet et la page vide suivante devient Active. </p><br><p><img src="https://habrastorage.org/webt/6q/lz/ym/6qlzymofwdhy9ah2x-ekgpd23tq.jpeg"></p><br><p>  D'apr√®s ce que j'ai compris de la documentation sur le site Web Espressif et divers forums, le nettoyage des pages commence lorsque les pages gratuites se terminent.  Pour √™tre plus pr√©cis, selon <a href="">cela</a> , l'effacement se produira lorsqu'il ne restera qu'une seule page libre. </p><br><p>  Si la page doit √™tre effac√©e, les enregistrements actuels (non effac√©s) sont d√©plac√©s vers une autre page et la page est remplac√©e. </p><br><p>  Ainsi, l'op√©ration d'effacement en √©criture pour chaque page particuli√®re est assez rare, plus il y a de pages - moins souvent.  Sur cette base, j'ai augment√© la taille de la partition NVS √† 1 Mo. √Ä mon taux d'enregistrement, cela suffit pour 170 ans, ce qui est g√©n√©ralement suffisant.  Le redimensionnement de la section NVS sera le suivant. </p><br><p>  Pour un travail pratique avec NVS, ESP32 pour Arduino Core dispose d'une biblioth√®que pratique de pr√©f√©rences √©crites, comment l'utiliser est √©crit <a href="">ici</a> . </p><br><h3 id="nemnogo-o-visualgdb">  Un peu sur VisualGDB </h3><br><p>  D√®s que j'ai commenc√© √† travailler avec l'IDE Arduino, j'ai √©t√© imm√©diatement surpris par la mis√©rable fonctionnalit√© par rapport √† Visual Studio.  Ils disent que VS n'est pas non plus une fontaine, m√™me si cela me convient, mais √©crire quelque chose de plus de 50 lignes dans l'IDE Arduino est douloureusement douloureux et douloureusement long.  Ainsi, la question s'est pos√©e de choisir un IDE pour le d√©veloppement.  Parce que  Je connais VS, je me suis install√© sur <a href="https://visualgdb.com/tutorials/arduino/esp32/">VisualGDB</a> . </p><br><p>  Apr√®s l'IDE Arduino, le d√©veloppement de l'ESP32 est tout simplement un havre.  Quelle est la transition vers la d√©finition, la recherche d'appels dans le projet et la possibilit√© de renommer la variable. </p><br><h3 id="izmenenie-tablicy-razdelov-esp32-pri-rabote-s-visualgdb">  Modification de la table de partition ESP32 avec VisualGDB </h3><br><p>  Comme mentionn√© ci-dessus, la table peut √™tre modifi√©e avec la partition ESP32; nous verrons comment cela peut √™tre fait. <br>  Le tableau est modifi√© en tant que fichier csv, par d√©faut VisualGDB √©crit le tableau suivant: </p><br><pre> <code class="plaintext hljs">Name, Type, SubType, Offset, Size, Flags nvs, data, nvs, 0x9000, 0x5000, otadata, data, ota, 0xe000, 0x2000, app0, app, ota_0, 0x10000, 0x140000, app1, app, ota_1, 0x150000,0x140000, spiffs, data, spiffs, 0x290000,0x170000,</code> </pre> <br><p>  Ici, nous voyons une section sous NVS, deux sections pour les applications et quelques autres sections.  Parmi les nuances, on peut noter que app0 (votre application) doit toujours √™tre √©crit √† l'offset 0x10000, √† partir de l'adresse z√©ro, sinon le chargeur de d√©marrage ne le d√©tectera pas.  En outre, les d√©calages doivent √™tre s√©lectionn√©s de sorte que les sections ne se "chevauchent" pas.  La table de partition elle-m√™me est √©crite √† l'offset 0x8000.  Comme vous pouvez le voir, la taille du NVS dans ce cas est 0x5000 - 20 Ko, ce qui n'est pas beaucoup. </p><br><p>  J'ai modifi√© la table de partition comme suit: </p><br><pre> <code class="plaintext hljs">Name, Type, SubType, Offset, Size, Flags app0, app, ota_0, 0x10000, 0x140000, nvs, data, nvs, , 1M, otadata, data, ota, , 0x2000, spiffs, data, spiffs, , 0x170000,</code> </pre><br><p>  N'oubliez pas d'ajouter une grille avant Nom, si vous utilisez ce tableau, vous avez besoin que cette ligne soit consid√©r√©e comme un commentaire. </p><br><p>  Comme vous pouvez le voir, la taille du NVS est augment√©e √† 1 Mo.  Si vous ne sp√©cifiez pas de d√©calage, la section commencera imm√©diatement apr√®s la pr√©c√©dente, il suffit donc d'indiquer le d√©calage uniquement pour app0.  Les fichiers CSV peuvent √™tre modifi√©s dans le bloc-notes en tant que txt, puis changer l'autorisation en csv pour le fichier enregistr√©. </p><br><p>  Ensuite, la table de partition doit √™tre convertie en binaire, car  il entre dans le contr√¥leur sous cette forme.  Pour ce faire, ex√©cutez le convertisseur: <br>  <code>c:\Users\userName\Documents\ArduinoData\packages\esp32\hardware\esp32\1.0.3\tools\gen_esp32part.exe part_table_name.csv part_table_name.bin</code> .  Le premier param√®tre est votre CSV, le deuxi√®me param√®tre est le binaire de sortie. </p><br><p>  Le binaire r√©sultant doit √™tre plac√© dans <code>c:\Users\userName\Documents\ArduinoData\packages\esp32\hardware\esp32\1.0.3\tools\partitions\part_table_name.csv</code> , apr√®s quoi il est n√©cessaire de sp√©cifier que c'est lui qui a √©t√© amen√© √† construire la solution, et pas de table de partition par d√©faut.  Vous pouvez le faire en √©crivant le nom de votre table dans le fichier <code>c:\Users\userName\Documents\ArduinoData\packages\esp32\hardware\esp32\1.0.3\boards.txt</code> .  Dans mon cas, c'est <code>esp32doit-devkit-v1.build.partitions=part_table_name</code> <br>  Apr√®s ces manipulations, VisualGDB lors de la cr√©ation de l'application prendra exactement votre table de partition et la placera dans <br>  <code>~project_folder_path\Output\board_name\Debug\project_name.ino.partitions.bin</code> , d'o√π il sera d√©j√† vers√© dans la carte. </p><br><h3 id="jtag-otladchik-cjmc-ft232h">  D√©bogueur JTAG CJMC-FT232H </h3><br><p>  Pour autant que je sache, c'est le d√©bogueur le moins cher qui peut fonctionner avec ESP32, il m'a co√ªt√© environ 600 roubles, il y en a beaucoup sur Aliexpress. </p><br><p><img src="https://habrastorage.org/webt/gn/cu/gm/gncugmqpjnb1hbmj630nnegxjgq.jpeg"></p><br><p>  Lorsque vous connectez le d√©bogueur, Windows y installe des pilotes inadapt√©s qui doivent √™tre modifi√©s √† l'aide du programme Zadig, tout y est simple, je ne le d√©crirai pas. </p><br><p>  Il se connecte √† ESP32 devkit-v1 de la mani√®re suivante: <br>  FT232H - ESP32 <br>  AD0 - GPIO13 <br>  AD1 - GPIO12 <br>  AD2 - GPIO15 <br>  AD3 - GPIO14 <br>  Ensuite, dans <code>Project -&gt; VisualGDB Project Properties</code> vous devez d√©finir les param√®tres suivants: </p><br><p><img src="https://habrastorage.org/webt/eg/oi/7b/egoi7bhrpkjaprfvyz-jd9puccw.jpeg"></p><br><p>  Cliquez ensuite sur Test.  Parfois, il arrive que la connexion ne soit pas √©tablie la premi√®re fois, le processus semble se figer, puis vous devez interrompre et r√©p√©ter le test.  Si tout est en ordre, le processus de test de la connexion prend environ 5 secondes. </p><br><p>  J'ai g√©n√©ralement assembl√© le projet et l'ai t√©l√©charg√© via USB sur l'ESP32 lui-m√™me (pas via le d√©bogueur), apr√®s quoi j'ai commenc√© √† d√©boguer avec <code>Debug -&gt; Attach to Running Embedded Firmware</code> .  Dans le code, vous pouvez d√©finir des points d'arr√™t, regarder les valeurs des variables au moment de la panne et dans la fen√™tre <code>Debug -&gt; Windows -&gt; Threads</code> , vous pouvez voir dans quelle t√¢che FreeRTOS le code s'est arr√™t√©, ce qui est utile si une erreur se produit pendant le d√©bogage.  Ces fonctions du d√©bogueur me suffisaient pour travailler confortablement. <br>  Lorsque j'ai commenc√© √† travailler avec NVS, le d√©bogage √©tait constamment interrompu par des erreurs obscures.  Si je comprends bien, c'est parce que le d√©bogueur doit cr√©er quelque chose comme un vidage dans la section NVS par d√©faut, mais √† ce stade, le NVS est d√©j√† utilis√© par le contr√¥leur.  Bien s√ªr, cela pourrait √™tre contourn√© en cr√©ant 2 partitions NVS, l'une avec le nom par d√©faut pour le d√©bogage et l'autre pour ses propres besoins.  Mais il n'y avait rien de compliqu√© l√†-bas, dans le code ajout√©, cela a fonctionn√© la premi√®re fois, donc je ne l'ai pas v√©rifi√©. </p><br><h3 id="glyuki-esp32">  Glitches ESP32 </h3><br><p>  Comme tout appareil avec Aliexpress, ma carte ESP32 avait la sienne, d√©crite nulle part.  Quand elle est arriv√©e, j'ai aliment√© certains p√©riph√©riques qui fonctionnaient sur I2C √† partir de la carte, mais apr√®s un certain temps, la carte a commenc√© √† red√©marrer si un √©quipement consommateur ou m√™me juste un condensateur √©tait attach√© √† la jambe + 5V.  Pourquoi est-ce compl√®tement incompr√©hensible? </p><br><p>  Maintenant, j'alimente la carte √† partir de la charge chinoise de 0,7 A, les capteurs ds18b20 du pied de la carte 3,3 V et le relais et le capteur de mouvement d'une autre charge de 2 A.  Le pied GND de la carte est bien s√ªr connect√© aux broches GND du reste du fer.  Pas cher et gai est notre option. </p><br><h3 id="o-rezultatah-proekta">  √Ä propos des r√©sultats du projet </h3><br><p>  J'ai eu la possibilit√© de contr√¥ler de mani√®re flexible le chauffage de la maison, √©conomisant ainsi de l'argent et de la sueur.  √Ä l'heure actuelle, si le chauffage maintient 23 degr√©s toute la journ√©e √† -5 - -7 √† l'ext√©rieur, c'est environ 11 heures de fonctionnement de la chaudi√®re.  Si pendant la journ√©e pour maintenir 20 degr√©s et chauffer √† 23 seulement le soir, alors c'est d√©j√† 9 heures de fonctionnement de la chaudi√®re.  La capacit√© de la chaudi√®re est de 6 kW, avec un prix actuel de kilowatts de 2,2 roubles, soit environ 26,4 roubles par jour.  La dur√©e de la saison de chauffage dans notre r√©gion est de 200 jours, la temp√©rature moyenne de la saison de chauffage est d'environ -5 degr√©s.  Ainsi, nous obtenons environ 5000r d'√©conomies pour la saison de chauffage. </p><br><p>  Le co√ªt de l'√©quipement ne d√©passe pas 2000r, c'est-√†-dire qu'il sera repouss√© dans quelques mois, sans parler du fait qu'un syst√®me pr√™t √† l'emploi d'une telle automatisation co√ªterait au moins 20 000r.  Une autre chose est que j'ai pass√© environ une semaine de pur temps de travail √† √©crire du firmware et √† d√©boguer, mais au cours du travail, par exemple, j'ai finalement r√©alis√© ce que sont les pointeurs en C ++ et j'ai acquis beaucoup d'autres exp√©riences (par exemple, l'exp√©rience de plusieurs heures de d√©bogage de probl√®mes incompr√©hensibles).  Et l'exp√©rience, comme vous le savez, est difficile √† surestimer. </p><br><p>  Captures d'√©cran de l'application mobile Blynk: </p><br><p><img src="https://habrastorage.org/webt/f8/a-/57/f8a-57tioype-tcgmjmodpagpwa.jpeg"></p><br><p><img src="https://habrastorage.org/webt/ez/3a/o3/ez3ao3_ht2lgjsbf9jvv_xcoksc.jpeg"></p><br><p><img src="https://habrastorage.org/webt/xi/xv/f-/xixvf-6pvrnw-2trm_toszimwrm.jpeg"></p><br><p>  Bien s√ªr, le code du projet n'est pas un chef-d'≈ìuvre, mais je l'ai √©crit dans des conditions de manque de temps et concentr√© principalement sur la lisibilit√©.  Il n'y a tout simplement pas de temps pour refactoriser.  En g√©n√©ral, j'ai beaucoup d'excuses pour lesquelles mon code est si effrayant, mais c'est mon pr√©f√©r√©, donc je vais m'y attarder, je ne d√©velopperai pas le sujet plus loin. </p><br><p>  Si mon gribouillis aide quelqu'un, je serai sinc√®rement heureux.  Je serai heureux de tout commentaire et suggestion. </p><br><div class="spoiler">  <b class="spoiler_title">Liste de r√©f√©rences</b> <div class="spoiler_text"><ol><li>  <a href="http://microsin.net/programming/ARM/freertos-part1.html">http://microsin.net/programming/ARM/freertos-part1.html</a> </li><li>  <a href="https://docs.espressif.com/projects/esp-idf/en/latest/api-reference/storage/nvs_flash.html">https://docs.espressif.com/projects/esp-idf/en/latest/api-reference/storage/nvs_flash.html</a> </li><li>  <a href="https://docs.espressif.com/projects/esp-idf/en/latest/api-guides/partition-tables.html">https://docs.espressif.com/projects/esp-idf/en/latest/api-guides/partition-tables.html</a> </li><li>  <a href="https://docs.blynk.cc/">https://docs.blynk.cc/</a> </li></ol><br></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr479156/">https://habr.com/ru/post/fr479156/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr479144/index.html">Dois-je enregistrer ma marque</a></li>
<li><a href="../fr479146/index.html">Comparaison des outils de contournement \ VPN</a></li>
<li><a href="../fr479150/index.html">Les robots agricoles avancent</a></li>
<li><a href="../fr479152/index.html">React et Vue sans npm et builds</a></li>
<li><a href="../fr479154/index.html">Toujours un combat ou assez?</a></li>
<li><a href="../fr479158/index.html">7 principes fondamentaux d'ITIL</a></li>
<li><a href="../fr479162/index.html">Aurores sur les plan√®tes du syst√®me solaire</a></li>
<li><a href="../fr479164/index.html">Qu'est-ce que l'EEG et pourquoi est-il n√©cessaire</a></li>
<li><a href="../fr479166/index.html">√âcrire votre module d'expiration plafonn√© pour tarantool</a></li>
<li><a href="../fr479168/index.html">Comment cr√©er une API RESTful sur la plate-forme Symfony 5 + API pour un projet MODX</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>