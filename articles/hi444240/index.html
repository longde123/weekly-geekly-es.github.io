<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ЁЯзФЁЯП┐ ЁЯХе ЁЯд╛ЁЯП┐ рд╕реНрдкреНрд░рд┐рдВрдЧ рдбреЗрдЯрд╛ рдЬреЗрдкреАрдП: рдлрд╛рдЗрд▓реЗрдВ рд▓рд╛рдирд╛ ЁЯзТЁЯП┐ ЁЯС┤ЁЯП╗ ЁЯзЧ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="рдЕрднрд┐рд╡рд╛рджрди, рдпрд╣ рд╕реНрдкреНрд░рд┐рдВрдЧ рдбреЗрдЯрд╛ рдЬреЗрдкреАрдП рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рджреВрд╕рд░реА рдкреЛрд╕реНрдЯ рд╣реИред рдкрд╣рд▓рд╛ рднрд╛рдЧ рдкреВрд░реА рддрд░рд╣ рд╕реЗ рдкрд╛рдиреА рдХреЗ рдиреАрдЪреЗ рдХреА рд░реЗрдХ рдХреЗ рд▓рд┐рдП рд╕рдорд░реНрдкрд┐рдд рдерд╛, рд╕рд╛рде рд╣реА рд╕рд╛рде рдЕрдиреБрднрд╡реА рд▓реЛрдЧреЛрдВ рдХреЗ рд╕реБрдЭ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>рд╕реНрдкреНрд░рд┐рдВрдЧ рдбреЗрдЯрд╛ рдЬреЗрдкреАрдП: рдлрд╛рдЗрд▓реЗрдВ рд▓рд╛рдирд╛</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/444240/"><p> рдЕрднрд┐рд╡рд╛рджрди, рдпрд╣ рд╕реНрдкреНрд░рд┐рдВрдЧ рдбреЗрдЯрд╛ рдЬреЗрдкреАрдП рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рджреВрд╕рд░реА рдкреЛрд╕реНрдЯ рд╣реИред  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдкрд╣рд▓рд╛ рднрд╛рдЧ</a> рдкреВрд░реА рддрд░рд╣ рд╕реЗ рдкрд╛рдиреА рдХреЗ рдиреАрдЪреЗ рдХреА рд░реЗрдХ рдХреЗ рд▓рд┐рдП рд╕рдорд░реНрдкрд┐рдд рдерд╛, рд╕рд╛рде рд╣реА рд╕рд╛рде рдЕрдиреБрднрд╡реА рд▓реЛрдЧреЛрдВ рдХреЗ рд╕реБрдЭрд╛рд╡ рднреАред  рдЗрд╕ рднрд╛рдЧ рдореЗрдВ рд╣рдо рдмрд╛рдд рдХрд░реЗрдВрдЧреЗ рдХрд┐ рдЕрдкрдиреА рдЖрд╡рд╢реНрдпрдХрддрд╛рдУрдВ рдХреЗ рд▓рд┐рдП рд░реВрдкрд░реЗрдЦрд╛ рдХреЛ рдХреИрд╕реЗ рддреЗрдЬ рдХрд┐рдпрд╛ рдЬрд╛рдПред  рд╡рд░реНрдгрд┐рдд рд╕рднреА рдЙрджрд╛рд╣рд░рдг <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдпрд╣рд╛рдВ</a> рдЙрдкрд▓рдмреНрдз <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рд╣реИрдВ</a> ред </p><a name="habracut"></a><br><h4 id="grafy">  рдЧрд┐рдирддрд╛ </h4><br><p>  рдЪрд▓реЛ рд╢реБрд░реВ рдХрд░рддреЗ рд╣реИрдВ, рд╢рд╛рдпрдж, рдПрдХ рд╕рд░рд▓ рдФрд░ рдПрдХ рд╣реА рд╕рдордп рдореЗрдВ рд╕рд╛рдорд╛рдиреНрдп рдХрд╛рд░реНрдп рдХреЗ рд╕рд╛рде: рдПрдХ рдЗрдХрд╛рдИ рдХреЛ рд▓реЛрдб рдХрд░рддреЗ рд╕рдордп, рдЪреБрдирд┐рдВрджрд╛ рд░реВрдк рд╕реЗ рдЗрд╕рдХреА "рдмреЗрдЯреА" рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдирд╛ рдЖрд╡рд╢реНрдпрдХ рд╣реИред  рдПрдХ рд╕рд╛рдзрд╛рд░рдг рдЙрджрд╛рд╣рд░рдг рдкрд░ рд╡рд┐рдЪрд╛рд░ рдХрд░реЗрдВ: </p><br><pre><code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Entity</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Child</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Long id; <span class="hljs-meta"><span class="hljs-meta">@JoinColumn</span></span>(name = <span class="hljs-string"><span class="hljs-string">"parent_id"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@ManyToOne</span></span>(fetch = FetchType.LAZY, cascade = CascadeType.ALL) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Parent parent; } <span class="hljs-meta"><span class="hljs-meta">@Entity</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Parent</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Long id; }</code> </pre> <br><p>  рд╣рдорд╛рд░реЗ рдЙрджрд╛рд╣рд░рдг рдореЗрдВ рдмрд╛рд▓ рдЗрдХрд╛рдИ рдЖрд▓рд╕реА рд╣реИ: рд╣рдо <code>Child</code> рдкреНрд░рд╛рдкреНрдд рдХрд░рддреЗ рд╕рдордп рдЕрдирд╛рд╡рд╢реНрдпрдХ рдбреЗрдЯрд╛ рд▓реЛрдб рдирд╣реАрдВ рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ (рдФрд░ рдПрд╕рдХреНрдпреВрдПрд▓ рдХреНрд╡реЗрд░реА рдореЗрдВ рджреВрд╕рд░реА рддрд╛рд▓рд┐рдХрд╛ рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ)ред  рд▓реЗрдХрд┐рди рд╣рдорд╛рд░реЗ рдЖрд╡реЗрджрди рдореЗрдВ рдХреБрдЫ рдорд╛рдорд▓реЛрдВ рдореЗрдВ рд╣рдо рдпрд╣ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЬрд╛рдирддреЗ рд╣реИрдВ рдХрд┐ рд╣рдореЗрдВ рдмрдЪреНрдЪреЗ рдФрд░ рдЙрд╕рдХреЗ рдорд╛рддрд╛-рдкрд┐рддрд╛ рджреЛрдиреЛрдВ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрдЧреАред  рдпрджрд┐ рдЖрдк рдЗрдХрд╛рдИ рдХреЛ рдЖрд▓рд╕реА рдЫреЛрдбрд╝ рджреЗрддреЗ рд╣реИрдВ, рддреЛ рд╣рдореЗрдВ 2 рдЕрд▓рдЧ-рдЕрд▓рдЧ рдЕрдиреБрд░реЛрдз рдорд┐рд▓рддреЗ рд╣реИрдВред  рдпрджрд┐ рдЖрдк <code>FetchType.LAZY</code> рдХреЛ рд╣рдЯрд╛рдХрд░ рддреЗрдЬреА рд╕реЗ рд▓реЛрдбрд┐рдВрдЧ рд▓рд╛рдЧреВ рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рджреЛрдиреЛрдВ рд╕рдВрд╕реНрдерд╛рдПрдВ рд╣рдореЗрд╢рд╛ рдкрд╣рд▓реЗ рдЕрдиреБрд░реЛрдз рдкрд░ рд▓реЛрдб рдХреА рдЬрд╛рдПрдВрдЧреА (рдФрд░ рд╣рдо рдРрд╕рд╛ рдирд╣реАрдВ рдЪрд╛рд╣рддреЗ рд╣реИрдВ)ред </p><br><p>  JPQL рдмреЙрдХреНрд╕ рд╕реЗ рдПрдХ рдЕрдЪреНрдЫрд╛ рд╕рдорд╛рдзрд╛рди рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИ - рдпрд╣ <code>fetch</code> рдХреАрд╡рд░реНрдб рд╣реИ: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ChildRepository</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JpaRepository</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Child</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Long</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Query</span></span>(<span class="hljs-string"><span class="hljs-string">"select c from Child c join fetch c.parent where c.id = :id"</span></span>) <span class="hljs-function"><span class="hljs-function">Child </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findByIdFetchParent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Param(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"id"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> Long id)</span></span>; }</code> </pre> <br><p>  рдпрд╣ рдЕрдиреБрд░реЛрдз рд╕рд░рд▓ рдФрд░ рд╕реНрдкрд╖реНрдЯ рд╣реИ, рд▓реЗрдХрд┐рди рдЗрд╕рдореЗрдВ рдХрдорд┐рдпрд╛рдВ рд╣реИрдВ: </p><br><ul><li>  рд╣рдордиреЗ рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ <code>JpaRepository::findById</code> рдХреЗ рддрд░реНрдХ рдХреЛ <code>JpaRepository::findById</code> рдХреЛ рд╕реНрдкрд╖реНрдЯ рд▓реЛрдбрд┐рдВрдЧ рдЬреЛрдбрд╝рдХрд░ </li><li>  <code>@Query</code> рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╡рд░реНрдгрд┐рдд рдкреНрд░рддреНрдпреЗрдХ рдХреНрд╡реЗрд░реА рдХреЛ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рд╕реНрдЯрд╛рд░реНрдЯрдЕрдк рдкрд░ <code>@Query</code> рд╣реИ, рдЬрд┐рд╕рдореЗрдВ рдХреНрд╡реЗрд░реА рдХреЛ рдкрд╛рд░реНрд╕ рдХрд░рдиреЗ, рддрд░реНрдХреЛрдВ рдХреЛ рдЬрд╛рдВрдЪрдиреЗ, рдЖрджрд┐ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ (рджреЗрдЦреЗрдВ <a href="">org.springframework.data.jpa.repository.query.SimpleJpaQuery :: validateQuery</a> )ред  рдпрд╣ рд╕рдм рдХрд╛рдо рд╣реИ рдЬреЛ рд╕рдордп рдФрд░ рд╕реНрдореГрддрд┐ рд▓реЗрддрд╛ рд╣реИред </li><li>  рджрд░реНрдЬрдиреЛрдВ рд░рд┐рдкреЙрдЬрд┐рдЯрд░реА рдФрд░ entwined рд╕рдВрд╕реНрдерд╛рдУрдВ рдХреЗ рд╕рд╛рде рдПрдХ рдмрдбрд╝реА рдкрд░рд┐рдпреЛрдЬрдирд╛ рдореЗрдВ рдЗрд╕ рддрд░рд╣ рдХреЗ рджреГрд╖реНрдЯрд┐рдХреЛрдг рдХрд╛ рдЙрдкрдпреЛрдЧ (рдХрднреА-рдХрднреА рдПрдХ рджрд░реНрдЬрди "рдмреЗрдЯрд┐рдпреЛрдВ") рдХреЗ рд╕рд╛рде рдПрдХ рджрд╣рдирд╢реАрд▓ рд╡рд┐рд╕реНрдлреЛрдЯ рдХрд╛ рдХрд╛рд░рдг рд╣реЛрдЧрд╛ред </li></ul><br><p>  рдорд╛рдпрдиреЗ рд░рдЦрддрд╛ рд╣реИ рд╣рдорд╛рд░реА рд╕рд╣рд╛рдпрддрд╛ рдХреЗ рд▓рд┐рдП: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Entity</span></span> <span class="hljs-meta"><span class="hljs-meta">@NamedEntityGraphs</span></span>(value = { <span class="hljs-meta"><span class="hljs-meta">@NamedEntityGraph</span></span>( name = Child.PARENT, attributeNodes = <span class="hljs-meta"><span class="hljs-meta">@NamedAttributeNode</span></span>(<span class="hljs-string"><span class="hljs-string">"parent"</span></span>) ) }) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Child</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String PARENT = <span class="hljs-string"><span class="hljs-string">"Child[parent]"</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Long id; <span class="hljs-meta"><span class="hljs-meta">@JoinColumn</span></span>(name = <span class="hljs-string"><span class="hljs-string">"parent_id"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@ManyToOne</span></span>(fetch = FetchType.LAZY, cascade = CascadeType.ALL) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Parent parent; }</code> </pre> <br><p>  рдЧреНрд░рд╛рдл рдХрд╛ рд╡рд░реНрдгрди рдХрд░рдирд╛ рдЖрд╕рд╛рди рд╣реИ, рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╕рдордп рдХрдард┐рдирд╛рдЗрдпрд╛рдВ рд╢реБрд░реВ рд╣реЛрддреА рд╣реИрдВред  рдЕрдкрдиреЗ рдкреЗрдЬ рдкрд░ рд╕реНрдкреНрд░рд┐рдВрдЧ рдбрд╛рдЯрд╛ рдЬреЗрдкреАрдП рдЗрд╕реЗ рдЗрд╕ рддрд░рд╣ рд╕реЗ рдХрд░рдиреЗ рдХрд╛ рд╕реБрдЭрд╛рд╡ рджреЗрддрд╛ рд╣реИ (рдЬреИрд╕рд╛ рдХрд┐ рд╣рдорд╛рд░реЗ рдорд╛рдорд▓реЗ рдкрд░ рд▓рд╛рдЧреВ рд╣реЛрддрд╛ рд╣реИ) </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GroupRepository</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JpaRepository</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GroupInfo</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">String</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@EntityGraph</span></span>(value = Child.PARENT) <span class="hljs-meta"><span class="hljs-meta">@Query</span></span>(<span class="hljs-string"><span class="hljs-string">"select c from Child c where c.id = :id"</span></span>) <span class="hljs-function"><span class="hljs-function">Child </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findByIdFetchParent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Param(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"id"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> Long id)</span></span>; }</code> </pre> <br><p>  рдпрд╣рд╛рдВ рд╣рдо рд╕рднреА рд╕рдорд╛рди рд╕рдорд╕реНрдпрд╛рдУрдВ рдХреЛ рджреЗрдЦрддреЗ рд╣реИрдВ (рд╕рд┐рд╡рд╛рдп рдЗрд╕рдХреЗ рдХрд┐ рд▓рд┐рдЦрд┐рдд рдЕрдиреБрд░реЛрдз рдереЛрдбрд╝рд╛ рдЖрд╕рд╛рди рд╣реЛ рдЧрдпрд╛ рд╣реИ)ред  рдЖрдк рдЙрдиреНрд╣реЗрдВ рдареАрдХ рдЯреНрдпреВрдирд┐рдВрдЧ рдХреА рдорджрдж рд╕реЗ рдПрдХ рдЭрдЯрдХреЗ рдореЗрдВ рд╕рдорд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред  рдЕрдкрдирд╛ рд╕реНрд╡рдпрдВ рдХрд╛ рдЗрдВрдЯрд░рдлрд╝реЗрд╕ рдмрдирд╛рдПрдБ, рдЬрд┐рд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рд╣рдо рдмреЙрдХреНрд╕рд┐рдВрдЧ <code>JpaRepository</code> рдмрдЬрд╛рдп рд░рд┐рдкреЙрдЬрд┐рдЯрд░реА рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП <code>JpaRepository</code> : </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@NoRepositoryBean</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseJpaRepository</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ID</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Serializable</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JpaRepository</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ID</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-function">T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findById</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ID id, String graphName)</span></span></span></span>; }</code> </pre> <br><p>  рдЕрдм рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseJpaRepositoryImpl</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ID</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Serializable</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SimpleJpaRepository</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ID</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseJpaRepository</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ID</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> JpaEntityInformation&lt;T, ?&gt; entityInfo; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> EntityManager entityManager; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BaseJpaRepositoryImpl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JpaEntityInformation&lt;T, ?&gt; ei, EntityManager em)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(ei, em); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.entityInfo = ei; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.entityManager = em; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findById</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ID id, String graphName)</span></span></span><span class="hljs-function"> </span></span>{ Assert.notNull(id, <span class="hljs-string"><span class="hljs-string">"The given id must not be null!"</span></span>); <span class="hljs-comment"><span class="hljs-comment">//  EntityGraph&lt;?&gt; graph = entityManager.getEntityGraph(graphName); Map&lt;String, Object&gt; hints = singletonMap(QueryHints.HINT_LOADGRAPH, graph); return entityManager.find(getDomainClass(), id, hints); }</span></span></code> </pre> <br><p>  рдЕрдм рд╕реНрдкреНрд░рд┐рдВрдЧ рдХреЛ рд╣рдорд╛рд░реЗ рдЖрд╡реЗрджрди рдХреЗ рд╕рднреА рд░рд┐рдкреЙрдЬрд┐рдЯрд░реА рдХреЗ рдЖрдзрд╛рд░ рдХреЗ рд░реВрдк рдореЗрдВ <code>BaseJpaRepositoryImpl</code> рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП <code>BaseJpaRepositoryImpl</code> рдХрд░реЗрдВ: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@EnableJpaRepositories</span></span>(repositoryBaseClass = BaseJpaRepositoryImpl.class) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AppConfig</span></span></span><span class="hljs-class"> </span></span>{ }</code> </pre> <br><p>  рдЕрдм рд╣рдорд╛рд░реА рд╡рд┐рдзрд┐ рд╣рдорд╛рд░реЗ <code>BaseJpaRepository</code> рд╕реЗ рд╡рд┐рд░рд╛рд╕рдд рдореЗрдВ рдорд┐рд▓реА рд╕рднреА рд░рд┐рдкреЙрдЬрд┐рдЯрд░реА рд╕реЗ рдЙрдкрд▓рдмреНрдз рд╣реЛрдЧреАред </p><br><p>  рдЗрд╕ рджреГрд╖реНрдЯрд┐рдХреЛрдг рдореЗрдВ рдПрдХ рджреЛрд╖ рд╣реИ рдЬреЛ рдмрд╣реБрдд рдореЛрдЯрд╛ рд╕реБрдЕрд░ рдбрд╛рд▓ рд╕рдХрддрд╛ рд╣реИред </p><br><div class="spoiler">  <b class="spoiler_title">рдЕрдкрдиреЗ рд▓рд┐рдП рд╕реЛрдЪрдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░реЗрдВ</b> <div class="spoiler_text"><p>  рд╕рдорд╕реНрдпрд╛ рдпрд╣ рд╣реИ рдХрд┐ рд╣рд╛рдЗрдмрд░рдиреЗрдЯ (рд▓реЗрдЦрди рдХреЗ рд╕рдордп рдХрдо рд╕реЗ рдХрдо) рд░реЗрдЦрд╛рдВрдХрди рдФрд░ рд░реЗрдЦрд╛рдВрдХрди рдХреЗ рдирд╛рдореЛрдВ рд╕реЗ рдореЗрд▓ рдирд╣реАрдВ рдЦрд╛рддрд╛ рд╣реИред  рдЗрд╕рдХреЗ рдХрд╛рд░рдг, рдЬрдм рд╣рдо рдХрд┐рд╕реА рдЪреАрдЬрд╝ рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рддреЗ рд╣реИрдВ рддреЛ рд░рдирдЯрд╛рдЗрдо рддреНрд░реБрдЯрд┐ рд╣реЛ рд╕рдХрддреА рд╣реИ </p><br><pre> <code class="java hljs">Optional&lt;MyEntity&gt; entity = repository.findById(id, NON_EXISTING_GRAPH);</code> </pre> </div></div><br><p>  рдЖрдк рдкрд░реАрдХреНрд╖рдг рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдорд╛рдзрд╛рди рдХреЗ рд╕реНрд╡рд╛рд╕реНрдереНрдп рдХреА рдЬрд╛рдВрдЪ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Sql</span></span>(<span class="hljs-string"><span class="hljs-string">"/ChildRepositoryGraphTest.sql"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ChildRepositoryGraphTest</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestBase</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Long childId = <span class="hljs-number"><span class="hljs-number">1L</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testGraph_expectFieldInitialized</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Child child1 = childRepository.findOne(childId, Child.PARENT); <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> initialized = Hibernate.isInitialized(child1.getParent()); assertTrue(initialized); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testGraph_expectFieldNotInitialized</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Child child1 = childRepository .findById(childId) .orElseThrow(NullPointerException::<span class="hljs-keyword"><span class="hljs-keyword">new</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> initialized = Hibernate.isInitialized(child1.getParent()); assertFalse(initialized); } }</code> </pre> <br><h4 id="kogda-derevya-byli-bolshimi">  рдЬрдм рдкреЗрдбрд╝ рдмрдбрд╝реЗ рдереЗ </h4><br><p>  рдФрд░ рд╣рдо рдЫреЛрдЯреЗ рдФрд░ рдЕрдиреБрднрд╡рд╣реАрди рдереЗ, рд╣рдореЗрдВ рдЕрдХреНрд╕рд░ рдпрд╣ рдХреЛрдб рджреЗрдЦрдирд╛ рдкрдбрд╝рддрд╛ рдерд╛: </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> List&lt;DailyRecord&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findBetweenDates</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Date from, Date to)</span></span></span><span class="hljs-function"> </span></span>{ StringBuilder query = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"from Record "</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (from != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { query.append(<span class="hljs-string"><span class="hljs-string">" where date &gt;="</span></span>).append(format(from)).append(<span class="hljs-string"><span class="hljs-string">" "</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (to != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (from == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { query.append(<span class="hljs-string"><span class="hljs-string">" where date &lt;= "</span></span> + format(to) + <span class="hljs-string"><span class="hljs-string">" "</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { query.append(<span class="hljs-string"><span class="hljs-string">" and date &lt;= "</span></span> + format(to) + <span class="hljs-string"><span class="hljs-string">" "</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> em.createQuery(query.toString(), DailyRecord.class).getResultList(); }</code> </pre> <br><p>  рдпрд╣ рдХреЛрдб рдЯреБрдХрдбрд╝рд╛ рджреНрд╡рд╛рд░рд╛ рдЕрдиреБрд░реЛрдз рдЯреБрдХрдбрд╝рд╛ рдПрдХрддреНрд░ рдХрд░рддрд╛ рд╣реИред  рдЗрд╕ рджреГрд╖реНрдЯрд┐рдХреЛрдг рдХреЗ рдиреБрдХрд╕рд╛рди рд╕реНрдкрд╖реНрдЯ рд╣реИрдВ: </p><br><ul><li>  рдЖрдкрдХреЛ рдЕрдкрдиреЗ рд╣рд╛рдереЛрдВ рд╕реЗ рдмрд╣реБрдд рдХреБрдЫ рдХрд░рдирд╛ рд╣реИ </li><li>  рдЬрд╣рд╛рдБ рдореИрдиреБрдЕрд▓ рдХрд╛рдо рд╣реИ - рдЧрд▓рддрд┐рдпрд╛рдБ рд╣реИрдВ </li><li>  рдХреЛрдИ рд╕рд┐рдВрдЯреИрдХреНрд╕ рд╣рд╛рдЗрд▓рд╛рдЗрдЯрд┐рдВрдЧ (рд░рдирдЯрд╛рдЗрдо рдХреЗ рджреМрд░рд╛рди рдЯрд╛рдЗрдкреЛ рдкреЙрдк рдЕрдк) </li><li>  рдХреЛрдб рдХрд╛ рд╡рд┐рд╕реНрддрд╛рд░ рдХрд░рдирд╛ рдФрд░ рдЙрд╕реЗ рдмрдирд╛рдП рд░рдЦрдирд╛ рдмрд╣реБрдд рдореБрд╢реНрдХрд┐рд▓ рд╣реИ </li></ul><br><p>  рдереЛрдбрд╝реА рджреЗрд░ рдмрд╛рдж, рдорд╛рдирджрдВрдб рдПрдкреАрдЖрдИ рджрд┐рдЦрд╛рдИ рджрд┐рдпрд╛, рдЬрд┐рд╕рдиреЗ рд╣рдореЗрдВ рдЙрдкрд░реЛрдХреНрдд рдХреЛрдб рдХреЛ рдереЛрдбрд╝рд╛ рдирд┐рдЪреЛрдбрд╝рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреА: </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> List&lt;DailyRecord&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findBetweenDates</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Date from, Date to)</span></span></span><span class="hljs-function"> </span></span>{ Criteria criteria = em .unwrap(Session.class) .createCriteria(DailyRecord.class); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (from != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { criteria.add(Expression.ge(<span class="hljs-string"><span class="hljs-string">"date"</span></span>, from)); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (to != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { criteria.add(Expression.le(<span class="hljs-string"><span class="hljs-string">"date"</span></span>, to)); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> criteria.list(); }</code> </pre> <br><p>  рдорд╛рдирджрдВрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рдХрдИ рдлрд╛рдпрджреЗ рд╣реИрдВ: </p><br><ul><li>  "рддрд┐рдерд┐" рдЬреИрд╕реЗ "рд╡рд╛рдпрд░реНрдб" рдореВрд▓реНрдпреЛрдВ рдХреЗ рдмрдЬрд╛рдп рдПрдХ рдореЗрдЯрд╛рдореЙрдбрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреА рдХреНрд╖рдорддрд╛ </li><li>  рдЕрдиреБрд░реЛрдз рдХреЗ рдирд┐рд░реНрдорд╛рдг рдореЗрдВ рдХреБрдЫ рддреНрд░реБрдЯрд┐рдпрд╛рдВ рд╕рдВрдХрд▓рди рддреНрд░реБрдЯрд┐рдпрд╛рдВ рд╣реИрдВ, рдЕрд░реНрдерд╛рддреН, рд▓рд┐рдЦрддреЗ рд╕рдордп рдЙрдиреНрд╣реЗрдВ рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдкрддрд╛ рдЪрд▓ рдЬрд╛рддрд╛ рд╣реИ </li><li>  рдХреЛрдб рдмреЗрд╡рдХреВрдл рдЪрд┐рдкрдХрд╛рдиреЗ рд╡рд╛рд▓реЗ рддрд╛рд░ рдХреА рддреБрд▓рдирд╛ рдореЗрдВ рдЫреЛрдЯрд╛ рдФрд░ рдЕрдзрд┐рдХ рд╕рдордЭрджрд╛рд░ рд╣реИ </li></ul><br><p>  рдЗрд╕рдХреЗ рдиреБрдХрд╕рд╛рди рднреА рд╣реИрдВ: </p><br><ul><li>  рдХреЛрдб рд╕рдордЭрдиреЗ рдХреЗ рд▓рд┐рдП рдкрд░реНрдпрд╛рдкреНрдд рдЬрдЯрд┐рд▓ рд╣реИ </li><li>  рдЗрд╕ рддрд░рд╣ рдХреЗ рдкреНрд░рд╢реНрдиреЛрдВ рдХреЛ рд▓рд┐рдЦрдиреЗ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЬрд╛рдирдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЛ рдЕрдкрдирд╛ рд╣рд╛рде рднрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ (рдореБрдЭреЗ рдпрд╛рдж рд╣реИ рдХрд┐ рдЬрдм рдореБрдЭреЗ рдкрд╣рд▓реА рдмрд╛рд░ рдЗрд╕ рддрд░рд╣ рдХреЗ рдкреНрд░рд╢реНрдиреЛрдВ рдореЗрдВ рддреНрд░реБрдЯрд┐ рд╕реБрдзрд╛рд░ рд╕реЗ рдирд┐рдкрдЯрдирд╛ рдкрдбрд╝рд╛ рдерд╛, рддреЛ рдХрднреА-рдХрднреА 100-150 рд▓рд╛рдЗрдиреЛрдВ рд╕реЗ рдпреБрдХреНрдд рд╣реЛрддрд╛ рд╣реИ, рдмреНрд░рд╛рдВрдЪрд┐рдВрдЧ рдХреЗ рд╕рд╛рде, рдЖрджрд┐) </li><li>  рдПрдХ рдЬрдЯрд┐рд▓ рдХреНрд╡реЗрд░реА рдмрд▓реНрдХрд┐ рдмреЛрдЭрд┐рд▓ рд╣реИ (50 рд▓рд╛рдЗрдиреЗрдВ рд╕реАрдорд╛ рд╕реЗ рдмрд╣реБрдд рджреВрд░ рд╣реИрдВ) </li></ul><br><p>  рдореИрдВ рдЗрд╕реЗ рдЖрд╕рд╛рдиреА рд╕реЗ рдФрд░ рдЖрдирдВрдж рдХреЗ рд╕рд╛рде рд╡рд┐рдХрд╕рд┐рдд рдХрд░рдирд╛ рдЪрд╛рд╣рддрд╛ рд╣реВрдВ, рдЗрд╕рд▓рд┐рдП рдореИрдВ рдЗрди рджреЛрдиреЛрдВ рддрд░реАрдХреЛрдВ рдХреА рддрд░рд╣ рдирд╣реАрдВ рд╣реВрдВред </p><br><p>  рдЖрдЗрдП рд╣рдо рдЕрдкрдиреЗ рджреНрд╡рд╛рд░рд╛ рдкрд╣рд▓реЗ рд╕реЗ рдЬрд╛рдБрдЪреА рдЧрдИ рдЗрдХрд╛рдИ рдХреЛ рджреЗрдЦреЗрдВ: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Entity</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Child</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Long id; <span class="hljs-meta"><span class="hljs-meta">@JoinColumn</span></span>(name = <span class="hljs-string"><span class="hljs-string">"parent_id"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@ManyToOne</span></span>(fetch = FetchType.LAZY, cascade = CascadeType.ALL) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Parent parent; <span class="hljs-comment"><span class="hljs-comment">//... @OneToMany(mappedBy = "owner", cascade = CascadeType.ALL) @LazyCollection(value = LazyCollectionOption.EXTRA) private List&lt;Toy&gt; toys = new ArrayList&lt;&gt;(); }</span></span></code> </pre> <br><p>  рдореИрдВ рдЕрд▓рдЧ-рдЕрд▓рдЧ рдореЛрдб (рдФрд░ рдЙрдирдХреЗ рд╕рдВрдпреЛрдЬрди) рдореЗрдВ рдПрдХ рдЗрдХрд╛рдИ рдХреЛ рд▓реЛрдб рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдирд╛ рдЪрд╛рд╣реВрдВрдЧрд╛: </p><br><ul><li>  рд▓реЛрдб (рдпрд╛ рдирд╣реАрдВ) рдЬрдирдХ </li><li>  рд▓реЛрдб (рдпрд╛ рдирд╣реАрдВ) рдЦрд┐рд▓реМрдиреЗ </li><li>  рдмрдЪреНрдЪреЛрдВ рдХреЛ рдЙрдореНрд░ рдХреЗ рдЕрдиреБрд╕рд╛рд░ рдХреНрд░рдордмрджреНрдз рдХрд░реЗрдВ </li></ul><br><p>  рдпрджрд┐ рдЖрдк рдЗрд╕ рд╕рдорд╕реНрдпрд╛ рдХреЛ рд╣рд▓ рдХрд░рддреЗ рд╣реИрдВ, рдЕрд░реНрдерд╛рддреН, рдмрд╣реБрдд рд╕рд╛рд░реЗ рдкреНрд░рд╢реНрдиреЛрдВ рдХреЛ рд▓рд┐рдЦрдХрд░ рдЬреЛ рдЪрдпрдирд┐рдд рд▓реЛрдбрд┐рдВрдЧ рдореЛрдб рдХреЗ рдЕрдиреБрд░реВрдк рд╣реИрдВ, рддреЛ рдмрд╣реБрдд рдЬрд▓реНрджреА рдпрд╣ рдПрдХ рджрд╣рдирд╢реАрд▓ рд╡рд┐рд╕реНрдлреЛрдЯ рдХреА рдУрд░ рд▓реЗ рдЬрд╛рдПрдЧрд╛: </p><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Query</span></span>(<span class="hljs-string"><span class="hljs-string">"select c from Child c join fetch c.parent order by c.age"</span></span>) <span class="hljs-function"><span class="hljs-function">List&lt;Child&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findWithParentOrderByAge</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-meta"><span class="hljs-meta">@Query</span></span>(<span class="hljs-string"><span class="hljs-string">"select c from Child c join fetch c.toys order by c.age"</span></span>) <span class="hljs-function"><span class="hljs-function">List&lt;Child&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findWithToysOrderByAge</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-meta"><span class="hljs-meta">@Query</span></span>(<span class="hljs-string"><span class="hljs-string">"select c from Child c join fetch c.parent join fetch c.toys"</span></span>) <span class="hljs-function"><span class="hljs-function">List&lt;Child&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findWithParentAndToys</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">//...</span></span></code> </pre> <br><p>  рдЗрд╕ рд╕рдорд╕реНрдпрд╛ рдХреЛ рд╣рд▓ рдХрд░рдиреЗ рдХрд╛ рдПрдХ рд╕рд░рд▓ рдФрд░ рд╕реБрд░реБрдЪрд┐рдкреВрд░реНрдг рддрд░реАрдХрд╛ рд╣реИ: SQL / HQL рдФрд░ рдЯреЗрдореНрдкрд▓реЗрдЯ рдЗрдВрдЬрди рдХрд╛ рдПрдХ рд╕рдВрдпреЛрдЬрдиред  "рдлреНрд░реАрдорд╛рд░реНрдХрд░" рдХрд╛ рдЙрдкрдпреЛрдЧ рдореЗрд░реА рдкрд░рд┐рдпреЛрдЬрдирд╛рдУрдВ рдкрд░ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛, рд╣рд╛рд▓рд╛рдВрдХрд┐ рдЕрдиреНрдп рд╕рдорд╛рдзрд╛рдиреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ ("рдЯрд┐рдорд▓рд┐рдлрд╝", "рдорд╕реНрдЯреИрд╢", рдЖрджрд┐)ред </p><br><p>  рдЪрд▓рд┐рдП рдмрдирд╛рдирд╛ рд╢реБрд░реВ рдХрд░рддреЗ рд╣реИрдВред  рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ, рд╣рдореЗрдВ рдПрдХ рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рдХреНрд╡реЗрд░реА рдХрд╛ рд╡рд░реНрдгрди рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ рдЬреЛ <code>*.hql.ftl</code> рдпрд╛ <code>*.sql.ftl</code> (рдпрджрд┐ "рд╢реБрджреНрдз" рдПрд╕рдХреНрдпреВрдПрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░) рдкреНрд░рд╛рдкреНрдд рдХрд░рддрд╛ рд╣реИ: </p><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">#* @vtlvariable name="fetchParent" type="java.lang.Boolean" *# #* @vtlvariable name="fetchToys" type="java.lang.Boolean" *# #* @vtlvariable name="orderByAge" type="java.lang.Boolean" *# select child from Child child #if($fetchParent) left join fetch child.parent #end #if($fetchToys) left join fetch child.toys #end #if($orderByAge) order by child.age #end</span></span></code> </pre> <br><p>  рдЕрдм рдЖрдкрдХреЛ рдПрдХ рд╣реИрдВрдбрд▓рд░ рдХреА рдЬрд░реВрд░рдд рд╣реИ: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Component</span></span> <span class="hljs-meta"><span class="hljs-meta">@RequiredArgsConstructor</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TemplateParser</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Configuration configuration; <span class="hljs-meta"><span class="hljs-meta">@SneakyThrows</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prepareQuery</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String templateName, Map&lt;String, Object&gt; params)</span></span></span></span>{ Template template = configuration.getTemplate(templateName); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> FreeMarkerTemplateUtils.processTemplateIntoString(template, params); } }</code> </pre> <br><p>  рдХреБрдЫ рднреА рдЬрдЯрд┐рд▓ рдирд╣реАрдВ рд╣реИред  рднрдВрдбрд╛рд░ рдХреЗ рд▓рд┐рдП рд╣реЛ рд░рд╣реА рд╣реИред  рдЬрд╛рд╣рд┐рд░ рд╣реИ, <code>JpaRepository</code> рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рд╡рд╛рд▓рд╛ рдЗрдВрдЯрд░рдлрд╝реЗрд╕ рд╣рдореЗрдВ рд╕реВрдЯ рдирд╣реАрдВ рдХрд░рддрд╛ рд╣реИред  рдЗрд╕рдХреЗ рдмрдЬрд╛рдп, рд╣рдо рдЕрдкрдиреЗ рд╕реНрд╡рдпрдВ рдХреЗ рд░рд┐рдкреЛрдЬрд┐рдЯрд░реА рдмрдирд╛рдиреЗ рдХреЗ рдЕрд╡рд╕рд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВрдЧреЗ: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ChildRepositoryCustom</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">List&lt;Child&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findAll</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fetchParent, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fetchToys, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> order)</span></span></span></span>; } <span class="hljs-meta"><span class="hljs-meta">@RequiredArgsConstructor</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ChildRepositoryImpl</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseDao</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ChildRepositoryCustom</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> TemplateParser templateParser; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> List&lt;Child&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findAll</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fetchParent, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fetchToys, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> order)</span></span></span><span class="hljs-function"> </span></span>{ Map&lt;String, Object&gt; params = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap&lt;&gt;(); params.put(<span class="hljs-string"><span class="hljs-string">"fetchParent"</span></span>, fetchParent); params.put(<span class="hljs-string"><span class="hljs-string">"fetchToys"</span></span>, fetchToys); params.put(<span class="hljs-string"><span class="hljs-string">"orderByAge"</span></span>, orderByAge); String query = templateParser.prepareQuery(BASE_CHILD_TEMPLATE.name, params); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> em.createQuery(query, Child.class).getResultList(); } <span class="hljs-meta"><span class="hljs-meta">@RequiredArgsConstructor</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> RepositoryTemplates { BASE_CHILD_TEMPLATE(<span class="hljs-string"><span class="hljs-string">"BaseChildTemplate.hql.ftl"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String name; } }</code> </pre> <br><p>  <code>findUsingTemplate</code> рд╕реЗ <code>findUsingTemplate</code> рд╡рд┐рдзрд┐ рдХреЛ рд╕реБрд▓рдн рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП <code>ChildRepository</code> рдЖрдкрдХреЛ рдпрд╣ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ChildRepository</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseJpaRepository</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Child</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Long</span></span></span><span class="hljs-class">&gt;, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ChildRepositoryCustom</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//... }</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">рдирд╛рдо рд╕реЗ рдЬреБрдбрд╝реА рдПрдХ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╡рд┐рд╢реЗрд╖рддрд╛</b> <div class="spoiler_text"><p>  рд╡рд╕рдВрдд рд╣рдорд╛рд░реА рдХрдХреНрд╖рд╛ рдФрд░ рдЗрдВрдЯрд░рдлреЗрд╕ рдХреЛ рдХреЗрд╡рд▓ рд╕рд╣реА рдирд╛рдо рдХреЗ рд╕рд╛рде рдЬреЛрдбрд╝ рджреЗрдЧрд╛: </p><br><ul><li>  ChildRepository </li><li>  рдЪрд╛рдЗрд▓реНрдбрд░реЗрдкреЛрд╕рд┐рдЯрд░реА <strong>рдХрд╕реНрдЯрдо</strong> </li><li>  рдЪрд╛рдЗрд▓реНрдбрд░реЗрдкреЛрд╕рд┐рдЯрд░реА рдЗрдВрдкреНрд▓рд╛рдВрдЯ </li></ul><br><p>  рдЗрд╕реЗ рдпрд╛рдж рд░рдЦреЗрдВ, рдХреНрдпреЛрдВрдХрд┐ рдирд╛рдо рдореЗрдВ рддреНрд░реБрдЯрд┐ рдХреЗ рдорд╛рдорд▓реЗ рдореЗрдВ рдПрдХ рдЕрдирдЬрд╛рдиреЗ рдЕрдкрд╡рд╛рдж рдХреЛ рдлреЗрдВрдХ рджрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛, рдЬрд┐рд╕рд╕реЗ рддреНрд░реБрдЯрд┐ рдХреЗ рдХрд╛рд░рдг рдХреЛ рд╕рдордЭрдирд╛ рдЕрд╕рдВрднрд╡ рд╣реИред </p></div></div><br><p>  рдЕрдм рдЗрд╕ рджреГрд╖реНрдЯрд┐рдХреЛрдг рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЖрдк рдЕрдзрд┐рдХ рдЬрдЯрд┐рд▓ рд╕рдорд╕реНрдпрд╛рдУрдВ рдХреЛ рд╣рд▓ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред  рдорд╛рди рд▓реАрдЬрд┐рдП рдХрд┐ рд╣рдореЗрдВ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛-рдЪрдпрдирд┐рдд рд╡рд┐рд╢реЗрд╖рддрд╛рдУрдВ рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рдЪрдпрди рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред  рджреВрд╕рд░реЗ рд╢рдмреНрджреЛрдВ рдореЗрдВ, рдпрджрд┐ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдиреЗ "рд╕реЗ" рдФрд░ "рд╕реЗ" рддрд╛рд░реАрдЦреЛрдВ рдХреЛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдирд╣реАрдВ рдХрд┐рдпрд╛ рд╣реИ, рддреЛ рдХреЛрдИ рд╕рдордп рдлрд╝рд┐рд▓реНрдЯрд░ рдирд╣реАрдВ рд╣реЛрдЧрд╛ред  рдпрджрд┐ рдХреЗрд╡рд▓ рджрд┐рдирд╛рдВрдХ "рд╕реЗ" рдпрд╛ рдХреЗрд╡рд▓ рджрд┐рдирд╛рдВрдХ "рд╕реЗ" рдирд┐рд░реНрджрд┐рд╖реНрдЯ рд╣реИ, рддреЛ рдлрд╝рд┐рд▓реНрдЯрд░рд┐рдВрдЧ рдПрдХ рддрд░рдлрд╝рд╛ рд╣реЛрдЧреАред  рдпрджрд┐ рджреЛрдиреЛрдВ рддрд┐рдерд┐рдпрд╛рдВ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХреА рдЬрд╛рддреА рд╣реИрдВ, рддреЛ рдХреЗрд╡рд▓ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рддрд┐рдерд┐рдпреЛрдВ рдХреЗ рдмреАрдЪ рд░рд┐рдХреЙрд░реНрдб рдЪрдпрди рдореЗрдВ рдЖрдПрдЧрд╛: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Getter</span></span> <span class="hljs-meta"><span class="hljs-meta">@RequiredArgsConstructor</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RequestDto</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> LocalDate from; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> LocalDate to; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hasDateFrom</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> from != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hasDateTo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> to != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> List&lt;Child&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findAll</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ChildRequest request)</span></span></span><span class="hljs-function"> </span></span>{ Map&lt;String, Object&gt; params = singletonMap(<span class="hljs-string"><span class="hljs-string">"request"</span></span>, request); String query = templateParser.prepareQuery(TEMPLATE.name, params); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> em.createQuery(query, Child.class).getResultList(); }</code> </pre> <br><p>  рдЕрдм рдЯреЗрдореНрдкрд▓реЗрдЯ: </p><br><pre> <code class="sql hljs">&lt;<span class="hljs-comment"><span class="hljs-comment">#-- @ftlvariable name="request" type="...RequestDto" --&gt; select child from Child child &lt;#if request.hasDateFrom() &amp;&amp; request.hasDateTo()&gt; where child.birthDate &gt;= :dateFrom and child.birthDate &lt;= :dateTo &lt;#elseif request.hasDateFrom()&gt; where child.birthDate &gt;= :dateFrom &lt;#elseif request.hasDateTo()&gt; where child.birthDate &lt;= :dateTo &lt;/#if&gt;</span></span></code> </pre> <br><h4 id="orakl-i-nvl">  рдУрд░реЗрдХрд▓ рдФрд░ рдПрдирд╡реАрдПрд▓ </h4><br><p>  рд╕рд╛рд░ рдкрд░ рд╡рд┐рдЪрд╛рд░ рдХрд░реЗрдВ: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Entity</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DailyRecord</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Long id; <span class="hljs-meta"><span class="hljs-meta">@Column</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String currency; <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"record_rate"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> BigDecimal rate; <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"fixed_rate"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> BigDecimal fxRate; <span class="hljs-meta"><span class="hljs-meta">@Setter</span></span>(value = AccessLevel.PRIVATE) <span class="hljs-meta"><span class="hljs-meta">@Formula</span></span>(<span class="hljs-string"><span class="hljs-string">"select avg(r.record_rate) from daily_record r where r.currency = currency"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> BigDecimal avgRate; }</code> </pre> <br><p>  рдЗрд╕ рдЗрдХрд╛рдИ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХреНрд╡реЗрд░реА рдореЗрдВ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ (DBMS, рдЬреИрд╕рд╛ рдХрд┐ рд╣рдо рдпрд╛рдж рдХрд░рддреЗ рд╣реИрдВ, рд╣рдорд╛рд░реЗ рдкрд╛рд╕ Oracle рд╣реИ): </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Query</span></span>(<span class="hljs-string"><span class="hljs-string">"select nvl(record.fxRate, record.avgRate) "</span></span> + <span class="hljs-string"><span class="hljs-string">" from DailyRecord record "</span></span> + <span class="hljs-string"><span class="hljs-string">"where record.currency = :currency"</span></span>) <span class="hljs-function"><span class="hljs-function">BigDecimal </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findRateByCurrency</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Param(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"currency"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> String currency)</span></span>;</code> </pre> <br><p>  рдпрд╣ рдПрдХ рдХрд╛рдордХрд╛рдЬреА, рд╡реИрдз рдЕрдиреБрд░реЛрдз рд╣реИред  рд▓реЗрдХрд┐рди рдЗрд╕рдХреЗ рд╕рд╛рде рдПрдХ рдЫреЛрдЯреА рд╕рдорд╕реНрдпрд╛ рд╣реИ, рдЬрд┐рд╕реЗ SQL рд╡рд┐рд╢реЗрд╖рдЬреНрдЮ рд╢рд╛рдпрдж рдЗрдВрдЧрд┐рдд рдХрд░реЗрдВрдЧреЗред  рддрдереНрдп рдпрд╣ рд╣реИ рдХрд┐ рдУрд░реЗрдХрд▓ рдореЗрдВ <code>nvl</code> рдЖрд▓рд╕реА рдирд╣реАрдВ рд╣реИред  рджреВрд╕рд░реЗ рд╢рдмреНрджреЛрдВ рдореЗрдВ, рдЬрдм рд╣рдо <code>findRateByCurrency</code> рд╡рд┐рдзрд┐ рдХреЛ рдХреЙрд▓ рдХрд░рддреЗ рд╣реИрдВ, рддреЛ <code>findRateByCurrency</code> рд▓реЙрдЧ <code>findRateByCurrency</code> рд╣реЛрдЧрд╛ </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> nvl( dr.fixed_rate, <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span>(r.record_rate) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> daily_record r <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> r.currency = dr.currency ) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> daily_record dr <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> dr.currency = ?</code> </pre> <br><p>  рднрд▓реЗ рд╣реА <code>dr.fixed_rate</code> рдорд╛рди рдореМрдЬреВрдж рд╣реЛ, рд▓реЗрдХрд┐рди DBMS рдЕрднреА рднреА <code>nvl</code> рдореЗрдВ рджреВрд╕рд░реА рдЕрднрд┐рд╡реНрдпрдХреНрддрд┐ рджреНрд╡рд╛рд░рд╛ рд▓реМрдЯрд╛рдП рдЧрдП рдореВрд▓реНрдп рдХреА рдЧрдгрдирд╛ рдХрд░рддрд╛ рд╣реИ, рдЬреЛ рд╣рдорд╛рд░реЗ рдорд╛рдорд▓реЗ рдореЗрдВ </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span>(r.record_rate) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> daily_record r <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> r.currency = dr.currency)</code> </pre> <br><p>  рдкрд╛рдардХ рд╢рд╛рдпрдж рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдЬрд╛рдирддрд╛ рд╣реИ рдХрд┐ рдЕрдиреБрд░реЛрдз рдХреЗ рдЕрдирд╛рд╡рд╢реНрдпрдХ рднрд╛рд░ рдХреЛ рдХреИрд╕реЗ рдЪрдХрдорд╛ рджреЗрдирд╛ рд╣реИ: рдмреЗрд╢рдХ, рдпрд╣ рдХреАрд╡рд░реНрдб <code>nvl</code> , рдЬреЛ рдЕрдкрдиреЗ рдЖрд▓рд╕реНрдп рдХреЗ рд╕рд╛рде <code>nvl</code> рдЕрдиреБрдХреВрд▓рддрд╛ рдХреА рддреБрд▓рдирд╛ рдХрд░рддрд╛ рд╣реИ, рд╕рд╛рде рд╣реА 2 рд╕реЗ рдЕрдзрд┐рдХ рдЕрднрд┐рд╡реНрдпрдХреНрддрд┐рдпреЛрдВ рдХреЛ рд╕реНрд╡реАрдХрд╛рд░ рдХрд░рдиреЗ рдХреА рдХреНрд╖рдорддрд╛ рд╣реИред  рдЪрд▓реЛ рд╣рдорд╛рд░реЗ рдЕрдиреБрд░реЛрдз рдХреЛ рд╕рд╣реА рдХрд░реЗрдВ: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Query</span></span>(<span class="hljs-string"><span class="hljs-string">"select coalesce(record.fxRate, record.avgRate) "</span></span> + <span class="hljs-string"><span class="hljs-string">" from DailyRecord record "</span></span> + <span class="hljs-string"><span class="hljs-string">"where record.currency = :currency"</span></span>) <span class="hljs-function"><span class="hljs-function">BigDecimal </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findRateByCurrency</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Param(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"currency"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> String currency)</span></span>;</code> </pre> <br><p>  рдФрд░ рдлрд┐рд░, рдЬреИрд╕рд╛ рдХрд┐ рд╡реЗ рдХрд╣рддреЗ рд╣реИрдВ, рдЕрдЪрд╛рдирдХ: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> nvl(dr.fixed_rate, <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span>(r.record_rate) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> daily_record r <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> r.currency = dr.currency) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> daily_record dr <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> dr.currency = ?</code> </pre> <br><p>  рдЕрдиреБрд░реЛрдз рд╡рд╣реА рд░рд╣рд╛ред  рдРрд╕рд╛ рдЗрд╕рд▓рд┐рдП рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдмреЙрдХреНрд╕ рд╕реЗ рджреИрд╡реАрдп рдмреЛрд▓реА рдПрдХ <code>nvl</code> рд╢реНрд░реГрдВрдЦрд▓рд╛ рдореЗрдВ рддрдмреНрджреАрд▓ рд╣реЛ <code>nvl</code> рд╣реИред </p><br><div class="spoiler">  <b class="spoiler_title">рдЯрд┐рдкреНрдкрдгреА</b> <div class="spoiler_text"><p>  рдпрджрд┐ рдЖрдк рдЗрд╕ рд╡реНрдпрд╡рд╣рд╛рд░ рдХреЛ рдкреБрди: рдЙрддреНрдкрдиреНрди рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ, рддреЛ <a href="">CustomOracleDialect</a> рд╡рд░реНрдЧ рдХреЗ рдирд┐рд░реНрдорд╛рддрд╛ рдореЗрдВ рджреВрд╕рд░реА рдкрдВрдХреНрддрд┐ рд╣рдЯрд╛рдПрдВ рдФрд░ <code>DailyRecordRepositoryTest::findRateByCurrency</code> </p></div></div><br><p>  рдЗрд╕реЗ рдЪрдХрдорд╛ рджреЗрдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЛ рдЕрдкрдиреА рдмреЛрд▓реА рдмрдирд╛рдиреЗ рдФрд░ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдореЗрдВ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomOracleDialect</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Oracle12cDialect</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CustomOracleDialect</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(); registerFunction(<span class="hljs-string"><span class="hljs-string">"coalesce"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StandardSQLFunction(<span class="hljs-string"><span class="hljs-string">"coalesce"</span></span>)); } }</code> </pre> <br><p>  рд╣рд╛рдВ, рдпрд╣ рдмрд╣реБрдд рдЖрд╕рд╛рди рд╣реИред  рдЕрдм рд╣рдо рдмрдирд╛рдИ рдЧрдИ рдмреЛрд▓реА рдХреЛ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдкрд░ рдмрд╛рдБрдзрддреЗ рд╣реИрдВ: </p><br><pre> <code class="plaintext hljs">spring: jpa: database-platform: com.luxoft.logeek.config.CustomOracleDialect</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">рдПрдХ рдФрд░ (рдкрджрд╛рд╡рдирдд) рддрд░реАрдХрд╛:</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">spring: jpa: properties: hibernate.dialect: com.luxoft.logeek.config.CustomOracleDialect</code> </pre> </div></div><br><p>  рдЕрдиреБрд░реЛрдз рдХреЛ рдмрд╛рд░-рдмрд╛рд░ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рд╕реЗ рдкреНрд░рддрд┐рд╖реНрдард┐рдд рдХреЛрд▓реЗрд╕рд╕реНрдХ рдкреНрд░рд╛рдкреНрдд рд╣реЛрддрд╛ рд╣реИ: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">coalesce</span></span>(dr.fixed_rate, <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span>(r.record_rate) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> daily_record r <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> r.currency = dr.currency) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> daily_record dr <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> dr.currency = ?</code> </pre> <br><h4 id="orakl-i-postranichnye-zaprosy">  рдУрд░реЗрдХрд▓ рдФрд░ рдкреЗрдЬ рдЕрдиреБрд░реЛрдз </h4><br><p>  рд╕рд╛рдорд╛рдиреНрдп рддреМрд░ рдкрд░, рдмреЛрд▓реА рдХреЗ рдкреВрд░рд╛ рд╣реЛрдиреЗ рд╕реЗ рдХреНрд╡реЗрд░реА рд╣реЗрд░рдлреЗрд░ рдХреЗ рд▓рд┐рдП рд╕рдореГрджреНрдз рдЕрд╡рд╕рд░ рдорд┐рд▓рддреЗ рд╣реИрдВред  рдЕрдХреНрд╕рд░ рдПрдХ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдФрд░ рдПрдХ рд╡реЗрдм рдЪреЗрд╣рд░реЗ рдХреЛ рд╡рд┐рдХрд╕рд┐рдд рдХрд░рддреЗ рд╕рдордп, рдбреЗрдЯрд╛ рдХреЗ рдкреЗрдЬ-рд╡рд╛рд░ рдЕрдкрд▓реЛрдб рдХрд░рдиреЗ рдХрд╛ рдХрд╛рд░реНрдп рд╕рд╛рдордирд╛ рдХрд░рдирд╛ рдкрдбрд╝рддрд╛ рд╣реИред  рджреВрд╕рд░реЗ рд╢рдмреНрджреЛрдВ рдореЗрдВ, рдбреЗрдЯрд╛рдмреЗрд╕ рдореЗрдВ рд╣рдорд╛рд░реЗ рдХрдИ рд╕реМ рд╣рдЬрд╛рд░ рд░рд┐рдХреЙрд░реНрдб рд╣реИрдВ, рд▓реЗрдХрд┐рди рд╡реЗ рдкреНрд░рддрд┐ рдкреГрд╖реНрда 10/50/100 рд░рд┐рдХреЙрд░реНрдб рдХреЗ рдкреИрдХ рдореЗрдВ рдкреНрд░рджрд░реНрд╢рд┐рдд рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВред  рдмреЙрдХреНрд╕ рд╕реЗ рд╕реНрдкреНрд░рд┐рдВрдЧ рдбреЗрдЯ рдбреЗрд╡рд▓рдкрд░ рдХреЛ рд╕рдорд╛рди рдХрд╛рд░реНрдпрдХреНрд╖рдорддрд╛ рдкреНрд░рджрд╛рди рдХрд░рддреА рд╣реИ: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Query</span></span>(<span class="hljs-string"><span class="hljs-string">"select new com.luxoft.logeek.data.BriefChildData("</span></span> + <span class="hljs-string"><span class="hljs-string">"c.id, "</span></span> + <span class="hljs-string"><span class="hljs-string">"c.age "</span></span> + <span class="hljs-string"><span class="hljs-string">") from Child c "</span></span> + <span class="hljs-string"><span class="hljs-string">" join c.parent p "</span></span> + <span class="hljs-string"><span class="hljs-string">"where p.name = ''"</span></span>) <span class="hljs-function"><span class="hljs-function">Page&lt;BriefChildData&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">browse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Pageable pageable)</span></span></span></span>;</code> </pre> <br><p>  рдЗрд╕ рджреГрд╖реНрдЯрд┐рдХреЛрдг рдореЗрдВ рдПрдХ рдорд╣рддреНрд╡рдкреВрд░реНрдг рдХрдореА рд╣реИ, рдЕрд░реНрдерд╛рддреН, рджреЛ рдкреНрд░рд╢реНрдиреЛрдВ рдХрд╛ рдирд┐рд╖реНрдкрд╛рджрди, рдЬрд┐рдирдореЗрдВ рд╕реЗ рдкрд╣рд▓рд╛ рдбреЗрдЯрд╛ рдкреНрд░рд╛рдкреНрдд рдХрд░рддрд╛ рд╣реИ, рдФрд░ рджреВрд╕рд░рд╛ рдбреЗрдЯрд╛рдмреЗрд╕ рдореЗрдВ рдЙрдирдХреА рдХреБрд▓ рд╕рдВрдЦреНрдпрд╛ рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХрд░рддрд╛ рд╣реИ ( <code>Page</code> рдСрдмреНрдЬреЗрдХреНрдЯ рдореЗрдВ рдбреЗрдЯрд╛ рдХреА рдХреБрд▓ рдорд╛рддреНрд░рд╛ рдкреНрд░рджрд░реНрд╢рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдпрд╣ рдЖрд╡рд╢реНрдпрдХ рд╣реИ)ред  рд╣рдорд╛рд░реЗ рдорд╛рдорд▓реЗ рдореЗрдВ, рдЗрд╕ рд╡рд┐рдзрд┐ рдХреЗ рд▓рд┐рдП рдПрдХ рдХреЙрд▓ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЕрдиреБрд░реЛрдз рджреЗрддрд╛ рд╣реИ (p6spy рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд▓реЙрдЧрд┐рдВрдЧ): </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> c.id, c.age <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">child</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">inner</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span> p <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> c.parent_id = p.id <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> p.name = <span class="hljs-string"><span class="hljs-string">''</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rownum</span></span> &lt;= <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(c.id) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">child</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">inner</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span> p <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> c.parent_id = p.id <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> p.name = <span class="hljs-string"><span class="hljs-string">''</span></span></code> </pre> <br><p>  рдпрджрд┐ рдХреНрд╡реЗрд░реА рднрд╛рд░реА рд╣реИ (рдХрдИ рддрд╛рд▓рд┐рдХрд╛рдУрдВ рдХреЛ рдПрдХ рдЧреИрд░-рдЕрдиреБрдХреНрд░рдорд┐рдХ рд╕реНрддрдВрдн рд╕реЗ рдЬреЛрдбрд╝рд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдмрд╕ рдмрд╣реБрдд рд╕рд╛рд░реЗ рдЬреЛрдбрд╝, рдПрдХ рдХрдард┐рди рдЪрдпрди рд╕реНрдерд┐рддрд┐, рдЖрджрд┐), рддреЛ рдпрд╣ рдПрдХ рд╕рдорд╕реНрдпрд╛ рдмрди рд╕рдХрддреА рд╣реИред  рд▓реЗрдХрд┐рди рдЪреВрдВрдХрд┐ рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рдУрд░реЗрдХрд▓ рд╣реИ, рддреЛ рдЖрдк рдПрдХ рдЕрдиреБрд░реЛрдз рдХреЗ рд╕рд╛рде рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдкрдВрдХреНрддрд┐рдмрджреНрдз рдЫрджреНрдо-рд╕реНрддрдВрдн рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ред </p><br><p>  рдРрд╕рд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рд╣рдореЗрдВ рдЕрдкрдиреА рдмреЛрд▓реА рд╕рдорд╛рдкреНрдд рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ, рдФрд░ рд╕рднреА рд░рд┐рдХреЙрд░реНрдбреЛрдВ рдХреЛ рдЧрд┐рдирдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЬрд╛рдиреЗ рд╡рд╛рд▓реЗ рдлрд╝рдВрдХреНрд╢рди рдХрд╛ рд╡рд░реНрдгрди рдХрд░реЗрдВ: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomOracleDialect</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Oracle12cDialect</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CustomOracleDialect</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(); registerFunction(<span class="hljs-string"><span class="hljs-string">"coalesce"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StandardSQLFunction(<span class="hljs-string"><span class="hljs-string">"coalesce"</span></span>)); registerFunction(<span class="hljs-string"><span class="hljs-string">"total_count"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TotalCountFunc()); } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TotalCountFunc</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SQLFunction</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hasArguments</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hasParenthesesIfNoArguments</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Type </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getReturnType</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Type type, Mapping mapping)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> StandardBasicTypes.LONG; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">render</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Type type, List arguments, SessionFactoryImplementor factory)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (arguments.size() != <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalArgumentException(<span class="hljs-string"><span class="hljs-string">"Only 1 argument acceptable"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">" count("</span></span> + arguments.get(<span class="hljs-number"><span class="hljs-number">0</span></span>) + <span class="hljs-string"><span class="hljs-string">") over () "</span></span>; } }</code> </pre> <br><p>  рдЕрдм рдПрдХ рдирдИ рдХреНрд╡реЗрд░реА ( <code>ChildRepositoryImpl</code> рд╡рд░реНрдЧ рдореЗрдВ) <code>ChildRepositoryImpl</code> : </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Page&lt;BriefChildData&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">browseWithTotalCount</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Pageable pageable)</span></span></span><span class="hljs-function"> </span></span>{ String query = <span class="hljs-string"><span class="hljs-string">"select "</span></span> + <span class="hljs-string"><span class="hljs-string">" c.id as id,"</span></span> + <span class="hljs-string"><span class="hljs-string">" c.age as age, "</span></span> + <span class="hljs-string"><span class="hljs-string">" total_count(c.id) as totalCount"</span></span> + <span class="hljs-string"><span class="hljs-string">" from Child c "</span></span> + <span class="hljs-string"><span class="hljs-string">"join c.parent p "</span></span> + <span class="hljs-string"><span class="hljs-string">"where p.name = ''"</span></span>; List&lt;BriefChildData&gt; list = em.unwrap(Session.class) .createQuery(query) .setFirstResult((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) pageable.getOffset()) .setMaxResults(pageable.getPageSize()) .setResultTransformer(Transformers.aliasToBean(BriefChildData.class)) .getResultList(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (list.isEmpty()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PageImpl(Collections.emptyList()); } <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> totalCount = list.get(<span class="hljs-number"><span class="hljs-number">0</span></span>).getTotalCount(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PageImpl&lt;&gt;(list, pageable, totalCount); }</code> </pre> <br><p>  рдЗрд╕ рдХреЛрдб рдХреЛ рдХреЙрд▓ рдХрд░рддреЗ рд╕рдордп, рдПрдХ рдЕрдиреБрд░реЛрдз рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> c.id, c.age, <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(c.id) <span class="hljs-keyword"><span class="hljs-keyword">over</span></span> () <span class="hljs-comment"><span class="hljs-comment">-- &lt;----- from child c inner join parent p on c.parent_id = p.id where p.name = '') where rownum &lt;= 3</span></span></code> </pre> <br><p>  рдЕрднрд┐рд╡реНрдпрдХреНрддрд┐ <code>count(c.id) over ()</code> рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ <code>count(c.id) over ()</code> рдЖрдк рдбреЗрдЯрд╛ рдХреА рдХреБрд▓ рд░рд╛рд╢рд┐ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдЗрд╕реЗ <code>PageImpl</code> рдХрдВрд╕реНрдЯреНрд░рдХреНрдЯрд░ рдХреЛ рдкрд╛рд╕ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдбреЗрдЯрд╛ рд╡рд░реНрдЧ рд╕реЗ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред  рдбреЗрдЯрд╛ рд╢реНрд░реЗрдгреА рдореЗрдВ рдХрд┐рд╕реА рдЕрдиреНрдп рдлрд╝реАрд▓реНрдб рдХреЛ рд╢рд╛рдорд┐рд▓ рдХрд┐рдП рдмрд┐рдирд╛ рдЗрд╕реЗ рдЕрдзрд┐рдХ рд╕реБрд░реБрдЪрд┐рдкреВрд░реНрдг рдврдВрдЧ рд╕реЗ рдХрд░рдиреЗ рдХрд╛ рдПрдХ рддрд░реАрдХрд╛ рд╣реИ, рдЗрд╕реЗ рд╣реЛрдорд╡рд░реНрдХ рдкрд░ рд╡рд┐рдЪрд╛рд░ рдХрд░реЗрдВ :) рдЖрдк <a href="">ProjectionVsDataTest</a> рдкрд░реАрдХреНрд╖рдг рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╕рдорд╛рдзрд╛рди рдХрд╛ рдкрд░реАрдХреНрд╖рдг рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред </p><br><h4 id="podvodnye-kamni-kastomizacii">  рдЕрдиреБрдХреВрд▓рди рдХреЗ рдиреБрдХрд╕рд╛рди </h4><br><p>  рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рдУрд░реЗрдХрд▓ рдФрд░ рд╕реНрдкреНрд░рд┐рдВрдЧ рдбреЗрдЯ рдХреЗ рд╕рд╛рде рдПрдХ рдЕрдЪреНрдЫрд╛ рдкреНрд░реЛрдЬреЗрдХреНрдЯ рд╣реИред  рд╣рдорд╛рд░рд╛ рдХрд╛рд░реНрдп рдЗрд╕ рддрд░рд╣ рдХреЗ рдХреЛрдб рдХреЗ рдкреНрд░рджрд░реНрд╢рди рдореЗрдВ рд╕реБрдзрд╛рд░ рдХрд░рдирд╛ рд╣реИ: </p><br><pre> <code class="java hljs">List&lt;Long&gt; ids = getIds(); ids.stream() .map(repository::findById) .filter(Optional::isPresent) .map(Optional::get) .forEach(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>::sendToSchool);</code> </pre> <br><p>  рдиреБрдХрд╕рд╛рди рд╕рддрд╣ рдкрд░ рд╣реИ: рдбреЗрдЯрд╛рдмреЗрд╕ рдкреНрд░рд╢реНрдиреЛрдВ рдХреА рд╕рдВрдЦреНрдпрд╛ рдЕрджреНрд╡рд┐рддреАрдп рдХреБрдВрдЬрд┐рдпреЛрдВ рдХреА рд╕рдВрдЦреНрдпрд╛ рдХреЗ рдмрд░рд╛рдмрд░ рд╣реИред  рдЗрд╕ рдХрдард┐рдирд╛рдИ рдкрд░ рдХрд╛рдмреВ рдкрд╛рдиреЗ рдХреА рдПрдХ рдЬреНрдЮрд╛рдд рд╡рд┐рдзрд┐ рд╣реИ: </p><br><pre> <code class="java hljs">List&lt;Long&gt; ids = getIds(); repository .findAllById(ids) .forEach(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>::sendToSchool);</code> </pre> <br><p>  рдПрдХрд╛рдзрд┐рдХ рдирдореВрдиреЗ рдХрд╛ рд▓рд╛рдн рд╕реНрдкрд╖реНрдЯ рд╣реИ: рдпрджрд┐ рдкрд╣рд▓реЗ рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рдлреЙрд░реНрдо рдХреЗ рдХрдИ рд╕рдорд╛рди рдкреНрд░рд╢реНрди рдереЗ </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> p.* <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> Pupil p <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> p.id = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> p.* <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> Pupil p <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> p.id = <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> p.* <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> Pupil p <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> p.id = <span class="hljs-number"><span class="hljs-number">3</span></span></code> </pre> <br><p>  рддрдм рдЕрдм рд╡реЗ рдПрдХ рдХреЗ рд▓рд┐рдП рдврд╣ рдЧрдП рд╣реИрдВ </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> p.* <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> Pupil p <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> p.id <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, ... )</code> </pre> <br><p>  рдпрд╣ рдЖрд╕рд╛рди рд╣реЛ рдЧрдпрд╛ рд╣реИ рдФрд░ рдЕрдЪреНрдЫрд╛ рд╣реЛ рдЧрдпрд╛ рд╣реИред  рдкреНрд░реЛрдЬреЗрдХреНрдЯ рдмрдврд╝рддрд╛ рд╣реИ, рд╡рд┐рдХрд╕рд┐рдд рд╣реЛрддрд╛ рд╣реИ, рдбреЗрдЯрд╛ рдмрдврд╝рддрд╛ рд╣реИ рдФрд░ рдПрдХ рдмрд╛рд░ рдЕрдкрд░рд┐рд╣рд╛рд░реНрдп рдЖрддрд╛ рд╣реИ: </p><br><div class="spoiler">  <b class="spoiler_title">рд╕рд╛рдл рдЖрд╕рдорд╛рди рдореЗрдВ рдЕрдХреА рдЧрд░рдЬ</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">ERROR - ORA-01795: maximum number of expressions in a list is 1000</code> </pre> </div></div><br><p>  рд╣рдореЗрдВ рдлрд┐рд░ рд╕реЗ рдПрдХ рд░рд╛рд╕реНрддрд╛ рддрд▓рд╛рд╢рдиреЗ рдХреА рдЬрд░реВрд░рдд рд╣реИ (рдкреБрд░рд╛рдиреЗ рд╕рдВрд╕реНрдХрд░рдг рдкрд░ рд╡рд╛рдкрд╕ рдирд╣реАрдВ)ред  рдЪреВрдВрдХрд┐ рдУрд░реЗрдХрд▓ рдЙрд╕реЗ 1000 рд╕реЗ рдЕрдзрд┐рдХ рдХреБрдВрдЬрд┐рдпреЛрдВ рдХреЛ рдЦрд┐рд▓рд╛рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдирд╣реАрдВ рджреЗрддрд╛ рд╣реИ, рддреЛ рдЖрдк рдкреВрд░реЗ рдбреЗрдЯрд╛ рдХреЛ 1000 рд╕реЗ рдЕрдзрд┐рдХ рдирд╣реАрдВ рдХреЗ рдмрд░рд╛рдмрд░ рд╢реЗрдпрд░реЛрдВ рдореЗрдВ рд╡рд┐рднрд╛рдЬрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдХрдИ рдкреНрд░рд╢реНрдиреЛрдВ рдХреА рд╕рдВрдЦреНрдпрд╛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ: </p><br><pre> <code class="java hljs">List&lt;List&lt;Long&gt;&gt; idChunks = cgccLists.partition(ids, <span class="hljs-number"><span class="hljs-number">1000</span></span>); <span class="hljs-comment"><span class="hljs-comment">//* idChunks.forEach(idChunk -&gt; repository.findAllById(idChunk).forEach(this::sendToSchool) ); //* cgccLists = com.google.common.collect.Lists</span></span></code> </pre> <br><p>  рдпрд╣ рд╡рд┐рдзрд┐ рдХрд╛рдо рдХрд░рддреА рд╣реИ, рд▓реЗрдХрд┐рди рдпрд╣ рдереЛрдбрд╝рд╛ рдмрджрдмреВ рдЖ рд░рд╣реА рд╣реИ (рдпрд╣ рд╣реИ?): рдпрджрд┐ рдЖрдк рдЕрдиреНрдп рдЬрдЧрд╣реЛрдВ рдкрд░ рдРрд╕реА рдХрдард┐рдирд╛рдЗрдпреЛрдВ рдХрд╛ рд╕рд╛рдордирд╛ рдХрд░рддреЗ рд╣реИрдВ рддреЛ рдЖрдкрдХреЛ рдЙрд╕реА рдмрдЧреАрдЪреЗ рдореЗрдВ рдмрд╛рдбрд╝ рд▓рдЧрд╛рдирд╛ рд╣реЛрдЧрд╛ред  рдЪрд▓рд┐рдП <code>BaseJpaRepositoryImpl</code> рдХреЛ <code>BaseJpaRepositoryImpl</code> рдХрд░рдХреЗ рд╕рдорд╕реНрдпрд╛ рдХреЛ рдЕрдзрд┐рдХ рд╕реБрд░реБрдЪрд┐рдкреВрд░реНрдг рдврдВрдЧ рд╕реЗ рд╣рд▓ рдХрд░рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░рддреЗ рд╣реИрдВред  рдРрд╕рд╛ рдХрд░рдиреЗ рдХрд╛ рд╕рдмрд╕реЗ рдЖрд╕рд╛рди рддрд░реАрдХрд╛ рдпрд╣ рд╣реИ рдХрд┐ рдЙрдкрд░реЛрдХреНрдд рддрд░реНрдХ рдХреЛ рднреАрддрд░ рд╕реЗ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд░рдирд╛, рдЗрд╕реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕реЗ рдЫрд┐рдкрд╛рдПрдВ: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> List&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findAllById</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Iterable&lt;ID&gt; ids)</span></span></span><span class="hljs-function"> </span></span>{ Assert.notNull(ids, <span class="hljs-string"><span class="hljs-string">"The given Iterable of Id's must not be null!"</span></span>); Set&lt;ID&gt; idsCopy = Sets.newHashSet(ids); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (idsCopy.size() &lt;= OracleConstants.MAX_IN_COUNT) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.findAllById(ids); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> findAll(idsCopy); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> List&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findAll</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Collection&lt;ID&gt; ids)</span></span></span><span class="hljs-function"> </span></span>{ List&lt;List&lt;ID&gt;&gt; idChunks = Lists.partition(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;&gt;(ids), <span class="hljs-number"><span class="hljs-number">1000</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> idChunks .stream() .map(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>::findAllById) .flatMap(List::stream) .collect(Collectors.toList()); }</code> </pre> <br><p>  рдпрд╣ рдмреЗрд╣рддрд░ рд╣реЛ рдЧрдпрд╛: рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ, рд╣рдордиреЗ рдмреБрдирд┐рдпрд╛рджреА рдврд╛рдВрдЪреЗ рдХреА рдкрд░рддреЛрдВ рд╕реЗ рдХрд╛рдо рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рдХреЛрдб рдХреЛ рд╕рд╛рдл рдХрд┐рдпрд╛, рдФрд░ рджреВрд╕рд░реА рдмрд╛рдд, рд╣рдордиреЗ рдЕрдкрдиреЗ рд╕рдорд╛рдзрд╛рди рдХреЗ рджрд╛рдпрд░реЗ рдХрд╛ рд╡рд┐рд╕реНрддрд╛рд░ рд╕рднреА рдкрд░рд┐рдпреЛрдЬрдирд╛ рд░рд┐рдкреЙрдЬрд┐рдЯрд░реА рдореЗрдВ рдХрд┐рдпрд╛ рдЬреЛ <code>BaseJpaRepository</code> рд╡рд┐рд╕реНрддрд╛рд░ <code>BaseJpaRepository</code> ред  рдЗрд╕рдХреЗ рдиреБрдХрд╕рд╛рди рднреА рд╣реИрдВред  рдореБрдЦреНрдп рдПрдХ рдХреЗ рдмрдЬрд╛рдп рдХрдИ рдЕрдиреБрд░реЛрдз рд╣реИрдВ, рдФрд░ рдпрд╣ рднреА (рдореБрдЦреНрдп рдПрдХ рд╕реЗ рдЙрдкрдЬрд╛ рд╣реИ) - рдХреБрдВрдЬреА рдХреЛ рдлрд╝рд┐рд▓реНрдЯрд░ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ рдпрджрд┐ рдРрд╕рд╛ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдПрдХ рд╣реА рдХреБрдВрдЬреА рдЕрд▓рдЧ-рдЕрд▓рдЧ <code>idChunks</code> рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ рд╕рдХрддреА рд╣реИред  рдпрд╣, рдмрджрд▓реЗ рдореЗрдВ, рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рдПрдХ рд╣реА рдЗрдХрд╛рдИ рдХреЛ рджреЛ рдмрд╛рд░ рд╕реВрдЪреА рдореЗрдВ рд╢рд╛рдорд┐рд▓ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛, рдФрд░, рддрджрдиреБрд╕рд╛рд░, рджреЛ рдмрд╛рд░ рд╕рдВрд╕рд╛рдзрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред  рд╣рдореЗрдВ рдЗрд╕рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдпрд╣рд╛рдВ рдПрдХ рдФрд░, рдЕрдзрд┐рдХ рдкрд░рд┐рд╖реНрдХреГрдд рд╕рдорд╛рдзрд╛рди рд╣реИ: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> List&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findAllById</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Iterable&lt;ID&gt; ids)</span></span></span><span class="hljs-function"> </span></span>{ Assert.notNull(ids, <span class="hljs-string"><span class="hljs-string">"The given Iterable of Id's must not be null!"</span></span>); ArrayList&lt;ID&gt; idsCopy = Lists.newArrayList(ids); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (idsCopy.size() &lt;= OracleConstants.MAX_IN_COUNT) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.findAllById(ids); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> findAll(idsCopy); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> List&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findAll</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ArrayList&lt;ID&gt; ids)</span></span></span><span class="hljs-function"> </span></span>{ CriteriaBuilder cb = entityManager.getCriteriaBuilder(); CriteriaQuery&lt;T&gt; query = cb.createQuery(getDomainClass()); Root&lt;T&gt; from = query.from(getDomainClass()); Predicate predicate = toPredicate(cb, ids, from); query = query.select(from).where(predicate); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> entityManager.createQuery(query).getResultList(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Predicate </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toPredicate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CriteriaBuilder cb, ArrayList&lt;ID&gt; ids, Root&lt;T&gt; root)</span></span></span><span class="hljs-function"> </span></span>{ List&lt;List&lt;ID&gt;&gt; chunks = Lists.partition(ids, OracleConstants.MAX_IN_COUNT); SingularAttribute&lt;? <span class="hljs-keyword"><span class="hljs-keyword">super</span></span> T, ?&gt; id = entityInfo.getIdAttribute(); Predicate[] predicates = chunks.stream() .map(chunk -&gt; root.get(id).in(chunk)) .toArray(Predicate[]::<span class="hljs-keyword"><span class="hljs-keyword">new</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cb.or(predicates); }</code> </pre> <br><p>  рдпрд╣ рдХреНрд░рд╛рдЗрдЯреЗрд░рд┐рдпрд╛ рдПрдкреАрдЖрдИ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рдлреЙрд░реНрдо рдХреА рдПрдХ рдЕрдВрддрд┐рдо рдХреНрд╡реЗрд░реА рдмрдирд╛рдирд╛ рд╕рдВрднрд╡ рд╣реЛ рдЬрд╛рддрд╛ рд╣реИ </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> p.* <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> Pupil p <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> p.id <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, ... , <span class="hljs-number"><span class="hljs-number">1000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> p.id <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> (<span class="hljs-number"><span class="hljs-number">1001</span></span>, ... , <span class="hljs-number"><span class="hljs-number">2000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> p.id <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> (<span class="hljs-number"><span class="hljs-number">2001</span></span>, ... , <span class="hljs-number"><span class="hljs-number">3000</span></span>)</code> </pre> <br><p>  рдПрдХ рд╕реВрдХреНрд╖реНрдорддрд╛ рд╣реИ: рдПрдХ рд╕рдорд╛рди рдЕрдиреБрд░реЛрдз рдмреЛрдЭрд┐рд▓ рдкрд░рд┐рд╕реНрдерд┐рддрд┐рдпреЛрдВ рдХреЗ рдХрд╛рд░рдг рд╕рд╛рдорд╛рдиреНрдп рд╕реЗ рдЕрдзрд┐рдХ рд╕рдордп рддрдХ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдкрд╣рд▓реА рд╡рд┐рдзрд┐ (рдХрднреА-рдХрднреА) рдмреЗрд╣рддрд░ рд╣реЛ рд╕рдХрддреА рд╣реИред </p><br><p>  рдпрд╣ рд╕рдм, рдореБрдЭреЗ рдЖрд╢рд╛ рд╣реИ рдХрд┐ рдЙрджрд╛рд╣рд░рдг рдЖрдкрдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧреА рдереЗ рдФрд░ рд░реЛрдЬрдорд░реНрд░рд╛ рдХреЗ рд╡рд┐рдХрд╛рд╕ рдореЗрдВ рдЙрдкрдпреЛрдЧреА рдереЗред  рдЯрд┐рдкреНрдкрдгрд┐рдпрд╛рдБ рдФрд░ рдкрд░рд┐рд╡рд░реНрдзрди рдХрд╛ рд╕реНрд╡рд╛рдЧрдд рд╣реИред </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/hi444240/">https://habr.com/ru/post/hi444240/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../hi444226/index.html">@Pythonetc рд╕рдВрдХрд▓рди 2019 рдлрд░рд╡рд░реА</a></li>
<li><a href="../hi444228/index.html">рдореЗрд░реЗ рдЯреЗрд▓реАрдЧреНрд░рд╛рдо-рдЪреИрдирд▓ @pythonetc рд╕реЗ рдЯрд┐рдкреНрд╕ рдПрдВрдб рдЯреНрд░рд┐рдХреНрд╕, рдлрд░рд╡рд░реА 2019</a></li>
<li><a href="../hi444230/index.html">рд╕реНрдЯреЗрдЯ рдЗрдВрдЯрд░рдиреЗрдЯ: рдЪрд╛рдЗрдирд╛ рд░рд┐рдореЛрдЯ рд╡реАрдкреАрдПрди рд╕реНрдЯреЛрд░реА</a></li>
<li><a href="../hi444234/index.html">рдбреАрдкрдорд╛рдЗрдВрдб рдФрд░ рдЧреВрдЧрд▓: рдордЬрдмреВрдд рдПрдЖрдИ рдкрд░ рдирд┐рдпрдВрддреНрд░рдг рдХреЗ рд▓рд┐рдП рд▓рдбрд╝рд╛рдИ</a></li>
<li><a href="../hi444238/index.html">рдПрдХ рдХреНрд▓рд┐рдХ рдореЗрдВ рдЗрдирдХрд╛рд░, рдпрд╛ рдХреИрд╕реЗ рдПрдХ рдбрд┐рдЬрд╛рдЗрдирд░ рдПрдХ рд╕рдкрдирд╛ рдиреМрдХрд░реА рдкрд╛рдиреЗ рдХреЗ рд▓рд┐рдП</a></li>
<li><a href="../hi444242/index.html">PVS-Studio рд╡рд┐рд╢реНрд▓реЗрд╖рдХ рдХреЗ рд╕рд╛рде FreeRDP рдХреА рдЬрд╛рдБрдЪ рдХрд░рдирд╛</a></li>
<li><a href="../hi444244/index.html">рдЕрдВрддрд░рд┐рдХреНрд╖ рдФрд░ рд╕рдордп рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЖрдЧреЗ рдмрдврд╝ рд░рд╣рд╛ рд╣реИ</a></li>
<li><a href="../hi444246/index.html">рдкреАрд╡реАрдПрд╕-рд╕реНрдЯреВрдбрд┐рдпреЛ рдХреЗ рд╕рд╛рде рдлреНрд░реАрдЖрд░рдбреАрдкреА рдХреА рдЬрд╛рдБрдЪ</a></li>
<li><a href="../hi444248/index.html">рдПрдХ рдмреНрд░рд╛рдЙрдЬрд╝рд░ рдореЗрдВ рдмрд┐рдирд╛ рдкрд░реАрдХреНрд╖рдг рдХреЗред рдкреЗрд╢реЗрд╡рд░реЛрдВ рдФрд░ рд╡рд┐рдкрдХреНрд╖</a></li>
<li><a href="../hi444250/index.html">рдХреНрдпрд╛ рдмрдбрд╝реЗ рдкреИрдорд╛рдиреЗ рдкрд░ рдЧреЛрдж рд▓реЗрдиреЗ рдХреЗ рд▓рд┐рдП рд▓реЛрдЧ рдмрд┐рдЯрдХреЙрдЗрди рдпрд╛ рдмрд┐рдЯрдХреЙрдЗрди рдХреЗ рд▓рд┐рдП рддреИрдпрд╛рд░ рдирд╣реАрдВ рд╣реИрдВ?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>