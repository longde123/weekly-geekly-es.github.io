<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üóùÔ∏è üíß üöÄ C√≥mo compilar un archivo COM de DOS con el compilador GCC üëµüèª üëãüèΩ üå†</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Art√≠culo publicado el 9 de diciembre de 2014 
 Actualizaci√≥n para 2018: Ren√©Rebe hizo un video interesante basado en este art√≠culo ( parte 2 ) 

 El f...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>C√≥mo compilar un archivo COM de DOS con el compilador GCC</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/412867/"> <font color="gray">Art√≠culo publicado el 9 de diciembre de 2014</font> <br>  <i>Actualizaci√≥n para 2018: Ren√©Rebe hizo un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">video interesante</a> basado en este art√≠culo ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">parte 2</a> )</i> <br><br>  El fin de semana pasado particip√© en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Ludum Dare # 31</a> .  Pero incluso antes de que se anunciara la conferencia, debido a mi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">reciente pasatiempo,</a> quer√≠a hacer un juego de la vieja escuela bajo DOS.  La plataforma de destino es DOSBox.  Esta es la forma m√°s pr√°ctica de ejecutar aplicaciones de DOS, a pesar del hecho de que todos los procesadores x86 modernos son totalmente compatibles con versiones anteriores, hasta el 8086 de 16 bits. <br><br>  Cre√© y mostr√© con √©xito el juego <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">DOS Defender</a> en la conferencia.  El programa funciona en el modo real del 80386 de 32 bits. Todos los recursos est√°n integrados en el archivo COM ejecutable, sin dependencias externas, por lo que todo el juego est√° empaquetado en un binario de 10 kilobytes. <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://github.com/skeeto/dosdefender-ld31</a> </li><li>  <a href="">DOSDEF.COM</a> (10 KB, v1.1.0, funciona en DOSBox) </li></ul><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ay/na/qs/aynaqsaenvt32x5oa8y7z4fmnfy.gif"></div><a name="habracut"></a><br>  Necesitar√°s un joystick o un gamepad para jugar.  Inclu√≠ soporte para mouse en el lanzamiento de Ludum Dare por el bien de la presentaci√≥n, pero luego lo elimin√© porque no funcion√≥ muy bien. <br><br>  ¬°La parte m√°s interesante t√©cnicamente es que <b><i>no</i> se necesitaban herramientas de desarrollo de DOS para crear el juego</b> !  Solo utilic√© el compilador regular de Linux C (gcc).  En realidad, ni siquiera puedes construir un Defender de DOS para DOS.  Veo DOS solo como una plataforma incrustada, que es la √∫nica forma en que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">DOS todav√≠a existe hoy</a> .  Junto con DOSBox y DOSEMU, este es un conjunto de herramientas bastante conveniente. <br><br>  Si solo est√° interesado en la parte pr√°ctica del desarrollo, vaya a la secci√≥n "Cheat on GCC", donde escribiremos el programa COM de DOS "Hello, World" con GCC Linux. <br><br><h1>  Encontrar las herramientas adecuadas </h1><br>  Cuando comenc√© este proyecto, no pensaba en GCC.  En realidad, segu√≠ este camino cuando descubr√≠ el paquete <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">bcc</a> (Compilador C de Bruce) para Debian, que recopila binarios de 16 bits para 8086. Se almacena para compilar cargadores de arranque x86 y otras cosas, pero bcc tambi√©n se puede usar para compilar archivos COM de DOS.  Me intereso <br><br>  Como referencia: el microprocesador Intel 8086 de 16 bits se lanz√≥ en 1978.  No ten√≠a caracter√≠sticas extra√±as de los procesadores modernos: sin protecci√≥n de memoria, sin instrucciones de coma flotante, y solo 1 MB de RAM direccionable.  Todas las computadoras de escritorio y computadoras port√°tiles modernas x86 a√∫n pueden pretender ser este procesador de 16 bits 8086 hace cuarenta a√±os, con el mismo direccionamiento limitado y todo eso.  Esta es una compatibilidad bastante hacia atr√°s.  Tal funci√≥n se llama <i>modo real</i> .  Este es el modo en que se inician todas las computadoras x86.  Los sistemas operativos modernos cambian inmediatamente al <i>modo protegido</i> con direccionamiento virtual y multitarea segura.  DOS no hizo eso. <br><br>  Desafortunadamente, bcc no es un compilador ANSI C. Admite un subconjunto de K&amp;R C, as√≠ como un c√≥digo de ensamblador x86 incorporado.  A diferencia de otros compiladores 8086 C, no tiene el concepto de punteros "lejanos" o "largos", por lo que se necesita un c√≥digo ensamblador incorporado para acceder a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">otros segmentos de memoria</a> (VGA, relojes, etc.).  Nota: los restos de estos "punteros largos" 8086 a√∫n se conservan en la API de Win32: <code>LPSTR</code> , <code>LPWORD</code> , <code>LPDWORD</code> , etc. Ese ensamblador incorporado ni siquiera se compara estrechamente con el ensamblador incorporado GCC.  En el ensamblador, debe cargar manualmente las variables de la pila, y dado que bcc admite dos convenciones de llamada diferentes, las variables en el c√≥digo deben estar codificadas de acuerdo con una u otra convenci√≥n. <br><br>  Dadas estas limitaciones, decid√≠ buscar alternativas. <br><br><h1>  DJGPP </h1><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">DJGPP</a> : puerto GCC en DOS.  Un proyecto realmente muy impresionante que transfiere casi todo el POSIX bajo DOS.  Muchos programas portados por DOS est√°n hechos en DJGPP.  Pero solo crea programas de 32 bits para el modo protegido.  Si en modo protegido necesita trabajar con hardware (por ejemplo, VGA), el programa realiza solicitudes al servicio de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">la interfaz de modo protegido de DOS</a> (DPMI).  Si tom√© DJGPP, no podr√≠a haberme limitado a un solo binario independiente, porque tendr√≠a que tener un servidor DPMI.  El rendimiento tambi√©n sufre de solicitudes de DPMI. <br><br>  Obtener las herramientas necesarias para DJGPP es dif√≠cil, por decir lo menos.  Afortunadamente, encontr√© un √∫til proyecto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">build-djgpp</a> que ejecuta todo, al menos en Linux. <br><br>  O hubo un grave error, o los archivos binarios oficiales de DJGPP se <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">infectaron nuevamente con el virus</a> , pero cuando comenc√© mis programas en DOSBox, apareci√≥ constantemente el error "No COFF: buscar virus".  Para verificar a√∫n m√°s que los virus no est√°n en mi propia m√°quina, configur√© el entorno DJGPP en mi Raspberry Pi, que act√∫a como una sala limpia.  Este dispositivo basado en ARM no puede infectarse con el virus x86.  Y todav√≠a surgi√≥ el mismo problema, y ‚Äã‚Äãtodos los hash binarios eran iguales entre las m√°quinas, por lo que no es mi culpa. <br><br>  Dado esto y el problema DPMI, comenc√© a buscar m√°s. <br><br><h1>  Enga√±ando a gcc </h1><br>  Lo que finalmente decid√≠ fue el truco complicado de "enga√±ar" a GCC para construir archivos COM de DOS en modo real.  El truco funciona hasta 80386 (que generalmente es lo que necesitas).  El procesador 80386 se lanz√≥ en 1985 y se convirti√≥ en el primer microprocesador x86 de 32 bits.  GCC todav√≠a se adhiere a este conjunto de instrucciones, incluso en entornos x86-64.  Desafortunadamente, GCC no puede producir c√≥digo de 16 bits de ninguna manera, as√≠ que tuve que abandonar el objetivo original de hacer un juego para 8086.  Sin embargo, esto no importa, porque la plataforma DOSBox de destino es esencialmente un emulador 80386. <br><br>  En teor√≠a, el truco tambi√©n deber√≠a funcionar en el compilador MinGW, pero hay un error de larga data que impide que funcione correctamente ("no se pueden realizar operaciones PE en un archivo de salida que no sea PE").  Sin embargo, se puede omitir, y lo hice yo mismo: debe eliminar la directiva <code>OUTPUT_FORMAT</code> y agregar un paso adicional de <code>objcopy</code> ( <code>objcopy -O binary</code> ). <br><br><h3>  Hola mundo en DOS </h3><br>  Para la demostraci√≥n, crearemos el programa COM de DOS "Hello, World" usando GCC en Linux. <br><br>  Hay un obst√°culo importante y significativo en este m√©todo: <b>no habr√° una biblioteca est√°ndar</b> .  Es como escribir un sistema operativo desde cero, con la excepci√≥n de algunos servicios que proporciona DOS.  Eso significa que no hay <code>printf()</code> o similar.  En cambio, le pedimos a DOS que imprima la cadena en la consola.  ¬°Crear una solicitud de DOS requiere una interrupci√≥n, lo que significa c√≥digo de ensamblador en l√≠nea! <br><br>  DOS tiene nueve interrupciones: 0x20, 0x21, 0x22, 0x23, 0x24, 0x25, 0x26, 0x27, 0x2F.  Lo m√°s importante que nos interesa es 0x21, la funci√≥n 0x09 (imprimir una l√≠nea).  Entre DOS y BIOS, hay <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">miles de funciones nombradas despu√©s de este patr√≥n</a> .  No voy a tratar de explicar el ensamblador x86, pero en pocas palabras el n√∫mero de funci√≥n se queda atascado en el registro <code>ah</code> , y la interrupci√≥n 0x21 se dispara.  La funci√≥n 0x09 tambi√©n toma un argumento: un puntero a una l√≠nea para imprimir, que se pasa en los registros <code>dx</code> y <code>ds</code> . <br><br>  Aqu√≠ est√° la funci√≥n <code>print()</code> del ensamblador en l√≠nea GCC.  Las l√≠neas pasadas a esta funci√≥n deben terminar con el car√°cter $.  Por qu√©  Porque DOS. <br><br><pre> <code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">print</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">asm</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">volatile</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"mov $0x09, %%ah\n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"int $0x21\n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> : </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* no output */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> : </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"d"</span></span></span></span><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">) : </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"ah"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; }</code> </pre> <br>  El c√≥digo se declara <code>volatile</code> porque tiene un efecto secundario (impresi√≥n de l√≠nea).  Para GCC, el c√≥digo del ensamblador es opaco y el optimizador se basa en restricciones de salida / entrada / clobber (√∫ltimas tres l√≠neas).  Para tales programas de DOS, cualquier ensamblador incorporado tendr√° efectos secundarios.  Esto se debe a que no est√° escrito para optimizaci√≥n, sino para acceso a recursos de hardware y DOS, cosas inaccesibles para C. <br><br>  Tambi√©n debe ocuparse de la declaraci√≥n de llamada, porque GCC no sabe que la memoria apuntada por <code>string</code> alguna vez ha sido le√≠da.  Es probable que una matriz que admita la cadena tambi√©n deba declararse <code>volatile</code> .  Todo esto presagia lo inevitable: cualquier acci√≥n en dicho entorno se convierte en una lucha interminable con el optimizador.  No todas estas batallas se pueden ganar. <br><br>  Ahora a la funci√≥n principal.  Su nombre no es importante en principio, pero evito llamarlo <code>main()</code> , porque MinGW tiene ideas divertidas sobre c√≥mo procesar dichos caracteres espec√≠ficamente, incluso si le piden que no lo haga. <br><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dosmain</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span></span><span class="hljs-function">)</span></span> { print(<span class="hljs-string"><span class="hljs-string">"Hello, World!\n$"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br>  Los archivos COM est√°n limitados a 65279 bytes de tama√±o.  Esto se debe a que el segmento de memoria x86 es de 64 KB, y DOS simplemente descarga los archivos COM a la direcci√≥n del segmento 0x0100 y se ejecuta.  Sin encabezados, solo un binario limpio.  Dado que el programa COM, en principio, no puede tener un tama√±o significativo, entonces no debe ocurrir un dise√±o real (independiente), todo se compila como una sola unidad de traducci√≥n.  Esta ser√° una llamada GCC con un mont√≥n de par√°metros. <br><br><h3>  Opciones del compilador </h3><br>  Aqu√≠ est√°n las principales opciones del compilador. <br><br> <code>-std=gnu99 -Os -nostdlib -m32 -march=i386 -ffreestanding</code> <br> <br>  Como las bibliotecas est√°ndar no se usan, la √∫nica diferencia entre gnu99 y c99 son los trigrafos deshabilitados (como deber√≠a ser), y el ensamblador incorporado se puede escribir como <code>asm</code> lugar de <code>__asm__</code> .  Este no es el contenedor de Newton.  El proyecto estar√° tan estrechamente relacionado con GCC que todav√≠a no estoy preocupado por las extensiones de GCC. <br><br>  La opci√≥n <code>-Os</code> reduce el resultado de la compilaci√≥n tanto como sea posible.  Entonces el programa funcionar√° m√°s r√°pido.  Esto es importante teniendo en cuenta DOSBox, porque el emulador predeterminado se ejecuta lentamente como una m√°quina de los 80.  Quiero encajar en esta limitaci√≥n.  Si el optimizador est√° causando problemas, <code>-O0</code> temporalmente <code>-O0</code> para determinar si su error o el optimizador est√° aqu√≠. <br><br>  Como puede ver, el optimizador no comprende que el programa funcionar√° en modo real con las restricciones de direccionamiento correspondientes.  <b>Realiza todo tipo de optimizaciones inv√°lidas que rompen sus programas perfectamente v√°lidos.</b>  Esto no es un error de GCC, porque nosotros mismos estamos haciendo locuras aqu√≠.  Tuve que rehacer el c√≥digo varias veces para evitar que el optimizador rompa el programa.  Por ejemplo, tuvimos que evitar devolver estructuras complejas de las funciones porque a veces se llenaban de basura.  El verdadero peligro es que la versi√≥n futura de GCC se volver√° a√∫n m√°s inteligente y romper√° a√∫n m√°s c√≥digo.  Aqu√≠ est√° tu amigo <code>volatile</code> . <br><br>  El siguiente par√°metro es <code>-nostdlib</code> , ya que no podremos vincular a ninguna biblioteca v√°lida, ni siquiera est√°ticamente. <br><br>  Los par√°metros <code>-m32-march=i386</code> compilador que emita el c√≥digo 80386. Si escrib√≠ el gestor de arranque para una computadora moderna, entonces la vista en 80686 tambi√©n ser√≠a normal, pero el DOSBox es 80386. <br><br>  El argumento <code>-ffreestanding</code> requiere que GCC no emita c√≥digo que acceda a las funciones auxiliares de la biblioteca est√°ndar incorporada.  A veces, en lugar de trabajar realmente con el c√≥digo, produce un c√≥digo para invocar una funci√≥n incorporada, especialmente con operadores matem√°ticos.  Tuve uno de los principales problemas con bcc, donde este comportamiento no se puede deshabilitar.  Esta opci√≥n se usa con mayor frecuencia al escribir cargadores de arranque y n√∫cleos del sistema operativo.  Y ahora los archivos dos dos .com. <br><br><h3>  Opciones de vinculador </h3><br>  La <code>-Wl</code> usa para pasar argumentos al enlazador ( <code>ld</code> ).  Necesitamos esto porque hacemos todo en una llamada a GCC. <br><br><pre> <code class="hljs powershell"><span class="hljs-literal"><span class="hljs-literal">-Wl</span></span>,-<span class="hljs-literal"><span class="hljs-literal">-nmagic</span></span>,-<span class="hljs-literal"><span class="hljs-literal">-script</span></span>=com.ld</code> </pre> <br>  <code>--nmagic</code> deshabilita la alineaci√≥n de la p√°gina de secci√≥n.  En primer lugar, no lo necesitamos.  En segundo lugar, desperdicia un espacio precioso.  En mis pruebas, esto no parece ser una medida necesaria, pero por si acaso, dejo esta opci√≥n. <br><br>  El par√°metro <code>--script</code> indica que queremos usar un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">script de enlace</a> especial.  Esto le permite colocar con precisi√≥n las secciones ( <code>text</code> , <code>data</code> , <code>bss</code> , <code>rodata</code> ) de nuestro programa.  Aqu√≠ est√° el script <code>com.ld</code> <br><br><pre> <code class="hljs haskell"><span class="hljs-type"><span class="hljs-type">OUTPUT_FORMAT</span></span>(binary) <span class="hljs-type"><span class="hljs-type">SECTIONS</span></span> { . = <span class="hljs-number"><span class="hljs-number">0x0100</span></span>; .text : { *(.text); } .<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class"> : { *(.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">); *(.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bss</span></span></span><span class="hljs-class">); *(.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rodata</span></span></span><span class="hljs-class">); } _heap = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ALIGN</span></span></span><span class="hljs-class">(4); }</span></span></code> </pre> <br>  <code>OUTPUT_FORMAT(binary)</code> le dice que no coloque esto en un archivo ELF (o PE, etc.).  El enlazador solo debe restablecer el c√≥digo limpio.  Un archivo COM es solo c√≥digo limpio, es decir, le damos el comando al vinculador para crear un archivo COM. <br><br>  Dije que los archivos COM se cargan a <code>0x0100</code> .  La cuarta l√≠nea desplaza el binario all√≠.  El primer byte del archivo COM sigue siendo el primer byte del c√≥digo, pero se iniciar√° desde este desplazamiento de memoria. <br><br>  Luego siguen todas las secciones: <code>text</code> (programa), <code>data</code> ( <code>data</code> est√°ticos), <code>bss</code> (datos con inicializaci√≥n cero), <code>rodata</code> (cadenas).  Finalmente, marco el final del binario con el s√≠mbolo <code>_heap</code> .  Esto ser√° √∫til m√°s adelante cuando escriba <code>sbrk()</code> cuando hayamos terminado con "Hello, World".  <code>_heap</code> alinear <code>_heap</code> con 4 bytes. <br><br>  Casi terminado <br><br><h3>  Lanzamiento del programa </h3><br>  El enlazador generalmente conoce nuestro punto de entrada ( <code>main</code> ) y lo configura para nosotros.  Pero como solicitamos un problema "binario", tendremos que resolverlo nosotros mismos.  Si la funci√≥n <code>print()</code> es la primera en ejecutarse, el programa comenzar√° desde all√≠, lo cual es incorrecto.  El programa necesita un peque√±o encabezado para comenzar. <br><br>  Hay una opci√≥n de <code>STARTUP</code> en el script del vinculador para tales cosas, pero por simplicidad la implementaremos directamente en el programa.  Por lo general, tales cosas se llaman <code>crt0.o</code> o <code>Boot.o</code> , en caso de que las encuentres en alguna parte.  Nuestro c√≥digo <i>debe</i> comenzar con este ensamblador incorporado, antes de cualquier inclusi√≥n y similares.  DOS har√° la mayor parte de la instalaci√≥n por nosotros, solo tenemos que ir al punto de entrada. <br><br><pre> <code class="hljs perl">asm (<span class="hljs-string"><span class="hljs-string">".code16gcc\n"</span></span> <span class="hljs-string"><span class="hljs-string">"call dosmain\n"</span></span> <span class="hljs-string"><span class="hljs-string">"mov $0x4C, %ah\n"</span></span> <span class="hljs-string"><span class="hljs-string">"int $0x21\n"</span></span>);</code> </pre> <br>  <code>.code16gcc</code> le dice al ensamblador que vamos a trabajar en modo real, para que haga la configuraci√≥n correcta.  A pesar del nombre, ¬° <i>no</i> producir√° c√≥digo de 16 bits!  Primero, se <code>dosmain</code> funci√≥n <code>dosmain</code> , que escribimos anteriormente.  Luego le dice a DOS usando la funci√≥n 0x4C ("terminar con el c√≥digo de retorno") que hemos terminado pasando el c√≥digo de salida <code>al</code> registro <code>al</code> 1 byte (ya establecido por <code>dosmain</code> ).  Este ensamblador incorporado es autom√°ticamente <code>volatile</code> porque no tiene entradas ni salidas. <br><br><h3>  Todos juntos </h3><br>  Aqu√≠ est√° todo el programa en C. <br><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">asm</span></span> (<span class="hljs-string"><span class="hljs-string">".code16gcc\n"</span></span> <span class="hljs-string"><span class="hljs-string">"call dosmain\n"</span></span> <span class="hljs-string"><span class="hljs-string">"mov $0x4C,%ah\n"</span></span> <span class="hljs-string"><span class="hljs-string">"int $0x21\n"</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">print</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">asm</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">volatile</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"mov $0x09, %%ah\n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"int $0x21\n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> : </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* no output */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> : </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"d"</span></span></span></span><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">) : </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"ah"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dosmain</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ print(<span class="hljs-string"><span class="hljs-string">"Hello, World!\n$"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br>  No repetir√© <code>com.ld</code>  Aqu√≠ est√° el desaf√≠o del CCG. <br><br><pre> <code class="hljs powershell">gcc <span class="hljs-literal"><span class="hljs-literal">-std</span></span>=gnu99 <span class="hljs-literal"><span class="hljs-literal">-Os</span></span> <span class="hljs-literal"><span class="hljs-literal">-nostdlib</span></span> <span class="hljs-literal"><span class="hljs-literal">-m32</span></span> <span class="hljs-literal"><span class="hljs-literal">-march</span></span>=i386 <span class="hljs-literal"><span class="hljs-literal">-ffreestanding</span></span> \ <span class="hljs-literal"><span class="hljs-literal">-o</span></span> hello.com <span class="hljs-literal"><span class="hljs-literal">-Wl</span></span>,-<span class="hljs-literal"><span class="hljs-literal">-nmagic</span></span>,-<span class="hljs-literal"><span class="hljs-literal">-script</span></span>=com.ld hello.c</code> </pre> <br>  Y su prueba en DOSBox: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4c5/478/358/4c5478358be0cdd9cc05eafd66bd44d2.png"><br><br>  Entonces, si desea gr√°ficos hermosos, la √∫nica pregunta es llamar a la interrupci√≥n y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">escribir en la memoria VGA</a> .  Si desea sonido, use PC Speaker interrupt.  No he descubierto c√≥mo llamar a Sound Blaster.  Desde ese momento, DOS Defender creci√≥. <br><br><h1>  Asignaci√≥n de memoria </h1><br>  Para cubrir otro tema, ¬ørecuerdas ese <code>_heap</code> ?  Podemos usarlo para implementar <code>sbrk()</code> y asignar memoria din√°micamente en la secci√≥n principal del programa.  Este es un modo real y no hay memoria virtual, por lo que podemos escribir en cualquier memoria a la que podamos acceder en cualquier momento.  Algunas √°reas est√°n reservadas (por ejemplo, memoria inferior y superior) para el equipo.  Por lo tanto, no hay necesidad <i>real</i> de usar sbrk (), pero es interesante intentarlo. <br><br>  Como es habitual en x86, su programa y particiones est√°n en la memoria inferior (0x0100 en este caso), y la pila est√° en la memoria superior (en nuestro caso, en la regi√≥n 0xffff).  En sistemas tipo Unix, la memoria devuelta por <code>malloc()</code> proviene de dos lugares: <code>sbrk()</code> y <code>mmap()</code> .  Lo que hace <code>sbrk()</code> es asignar memoria justo por encima de los segmentos de programa / datos, increment√°ndola "hacia arriba" hacia la pila.  Cada llamada a <code>sbrk()</code> aumentar√° este espacio (o lo dejar√° exactamente igual).  Esta memoria ser√° administrada por <code>malloc()</code> y similares. <br><br>  Aqu√≠ se explica c√≥mo implementar <code>sbrk()</code> en un programa COM.  Tenga en cuenta que debe definir su propio <code>size_t</code> , porque no tenemos una biblioteca est√°ndar. <br><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> _heap; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *hbreak = &amp;_heap; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sbrk</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> size)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *ptr = hbreak; hbreak += size; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ptr; }</code> </pre> <br>  Simplemente establece el puntero en <code>_heap</code> y lo incrementa seg√∫n sea necesario.  Un poco m√°s inteligente <code>sbrk()</code> tambi√©n tendr√° cuidado con la alineaci√≥n. <br><br>  Algo interesante sucedi√≥ durante la creaci√≥n de DOS Defender.  (Incorrectamente) consider√© que la memoria de mi <code>sbrk()</code> restableci√≥.  As√≠ fue despu√©s del primer juego.  Sin embargo, DOS no restablece esta memoria entre programas.  Cuando comenc√© el juego nuevamente, <i>continu√≥ exactamente donde me detuve</i> , porque las mismas estructuras de datos con el mismo contenido se cargaron en su lugar.  Muy buena coincidencia!  Esto es parte de lo que hace que esta plataforma integrada sea divertida. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es412867/">https://habr.com/ru/post/es412867/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es412855/index.html">Las vulnerabilidades CSRF siguen siendo relevantes</a></li>
<li><a href="../es412859/index.html">Autenticaci√≥n de dos factores en Windows y encriptaci√≥n de datos sin una autoridad de certificaci√≥n y dominio</a></li>
<li><a href="../es412861/index.html">Crear un mapa de ruta de usuario para dummies</a></li>
<li><a href="../es412863/index.html">Dialogflower - Google Dialogflow para Yandex Alice</a></li>
<li><a href="../es412865/index.html">C√≥mo disparar una c√°mara Motion Eye en el Sony Xperia XZ2</a></li>
<li><a href="../es412869/index.html">Entrevista con un experto en ingenier√≠a de tejidos y medicina regenerativa, el profesor Tal Tal Dvir</a></li>
<li><a href="../es412871/index.html">Eclair - Biblioteca de registro declarativo Java Spring</a></li>
<li><a href="../es412873/index.html">Discos duros estropeados por el sonido de los altavoces comunes</a></li>
<li><a href="../es412877/index.html">Rutenio (Ru): el cuarto elemento con propiedades ferromagn√©ticas a temperatura ambiente</a></li>
<li><a href="../es412879/index.html">Problema n. ¬∞ 24: capacitaci√≥n en TI: problemas y desaf√≠os actuales de compa√±√≠as l√≠deres</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>