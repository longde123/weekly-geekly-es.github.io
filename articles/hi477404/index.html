<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ЁЯдЬЁЯП╗ ЁЯМ║ ЁЯзС C ++ рдореЗрдВ рдСрдмреНрдЬреЗрдХреНрдЯреНрд╕ рдХреЛ рдЕрдХреНрд╕рд░ рдмрдирд╛рдиреЗ рдФрд░ рд╣рдЯрд╛рдиреЗ рдХреА рд╕рдорд╕реНрдпрд╛ тШЭЁЯП╛ тЫ╣ЁЯП╛ ЁЯзб</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="рдЬрд┐рд╕ рдХрдВрдкрдиреА рдХреЗ рд▓рд┐рдП рдореИрдВ рдХрд╛рдо рдХрд░рддрд╛ рд╣реВрдВ, рд╡рд╣ рдЦреБрдж рдХрд╛ рдЯреНрд░реИрдлрд┐рдХ рдлрд┐рд▓реНрдЯрд░рд┐рдВрдЧ рд╕рд┐рд╕реНрдЯрдо рд▓рд┐рдЦрддреА рд╣реИ рдФрд░ рдбреАрдбреАрдУрдПрд╕ рдХреЗ рд╣рдорд▓реЛрдВ, рдмреЙрдЯреНрд╕, рдкрд░реНрд╕рд░реНрд╕ рдФрд░ рдмрд╣реБрдд рдХреБрдЫ рд╕реЗ рд╡реНрдпрд╛рдкрд╛рд░ рдХреЛ рдмрдЪрд╛рддреА рд╣реИред...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>C ++ рдореЗрдВ рдСрдмреНрдЬреЗрдХреНрдЯреНрд╕ рдХреЛ рдЕрдХреНрд╕рд░ рдмрдирд╛рдиреЗ рдФрд░ рд╣рдЯрд╛рдиреЗ рдХреА рд╕рдорд╕реНрдпрд╛</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/477404/"><img src="https://habrastorage.org/webt/fb/bt/53/fbbt53apqltc7isyigy39vkizmk.jpeg" alt="рдЫрд╡рд┐"><br><br>  рдЬрд┐рд╕ рдХрдВрдкрдиреА рдХреЗ рд▓рд┐рдП рдореИрдВ рдХрд╛рдо рдХрд░рддрд╛ рд╣реВрдВ, рд╡рд╣ рдЦреБрдж рдХрд╛ рдЯреНрд░реИрдлрд┐рдХ рдлрд┐рд▓реНрдЯрд░рд┐рдВрдЧ рд╕рд┐рд╕реНрдЯрдо рд▓рд┐рдЦрддреА рд╣реИ рдФрд░ рдбреАрдбреАрдУрдПрд╕ рдХреЗ рд╣рдорд▓реЛрдВ, рдмреЙрдЯреНрд╕, рдкрд░реНрд╕рд░реНрд╕ рдФрд░ рдмрд╣реБрдд рдХреБрдЫ рд╕реЗ рд╡реНрдпрд╛рдкрд╛рд░ рдХреЛ рдмрдЪрд╛рддреА рд╣реИред  рдЙрддреНрдкрд╛рдж <a href="https://en.wikipedia.org/wiki/Reverse_proxy" rel="nofollow">рд░рд┐рд╡рд░реНрд╕ рдкреНрд░реЙрдХреНрд╕рд┐рдВрдЧ рдХреЗ</a> рд░реВрдк рдореЗрдВ рдЗрд╕ рддрд░рд╣ рдХреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдкрд░ рдЖрдзрд╛рд░рд┐рдд рд╣реИ, рдЬрд┐рд╕рдХреА рдорджрдж рд╕реЗ рд╣рдо рд╡рд╛рд╕реНрддрд╡рд┐рдХ рд╕рдордп рдореЗрдВ рдпрд╛рддрд╛рдпрд╛рдд рдХреЗ рдмрдбрд╝реЗ рд╕рдВрд╕реНрдХрд░рдгреЛрдВ рдХрд╛ рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдХрд░рддреЗ рд╣реИрдВ рдФрд░ рдЕрдВрдд рдореЗрдВ, рдХреЗрд╡рд▓ рд╡реИрдз рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЕрдиреБрд░реЛрдзреЛрдВ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреЗ рд╣реИрдВ, рд╕рднреА рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг рд▓реЛрдЧреЛрдВ рдХреЛ рдлрд╝рд┐рд▓реНрдЯрд░ рдХрд░рддреЗ рд╣реИрдВред <br><br>  рдореБрдЦреНрдп рд╡рд┐рд╢реЗрд╖рддрд╛ рдпрд╣ рд╣реИ рдХрд┐ рд╣рдорд╛рд░реА рд╕реЗрд╡рд╛рдПрдВ рдЕрд╕реАрдорд┐рдд рдЖрдиреЗ рд╡рд╛рд▓реЗ рдЯреНрд░реИрдлрд╝рд┐рдХ рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рддреА рд╣реИрдВ, рдЗрд╕рд▓рд┐рдП рд╡рд░реНрдХрд╕реНрдЯреЗрд╢рди рдХреЗ рд╕рднреА рд╕рдВрд╕рд╛рдзрдиреЛрдВ рдХрд╛ рдпрдерд╛рд╕рдВрднрд╡ рдХреБрд╢рд▓рддрд╛рдкреВрд░реНрд╡рдХ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рдмрд╣реБрдд рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реИред  рдЖрдзреБрдирд┐рдХ рд╕реА ++ рдореЗрдВ рд╡рд┐рдХрд╛рд╕ рдХрд╛ рдмрд╣реБрдд рдЕрдиреБрднрд╡ рд╣рдореЗрдВ рдЗрд╕рдХреА рдорджрдж рдХрд░рддрд╛ рд╣реИ, рдЬрд┐рд╕рдореЗрдВ рдирд╡реАрдирддрдо рдорд╛рдирдХ рдФрд░ рдмреВрд╕реНрдЯ рдирд╛рдордХ рдкреБрд╕реНрддрдХрд╛рд▓рдпреЛрдВ рдХрд╛ рдПрдХ рд╕реЗрдЯ рд╢рд╛рдорд┐рд▓ рд╣реИред <br><a name="habracut"></a><br><h3>  рдкреНрд░реЙрдХреНрд╕реА рдХреЛ рдЙрд▓рдЯ рджреЗрдВ </h3><br>  рдЖрдЗрдП, рд░рд┐рд╡рд░реНрд╕ рдкреНрд░реЙрдХреНрд╕рд┐рдВрдЧ рдкрд░ рдЬрд╛рдПрдВ рдФрд░ рджреЗрдЦреЗрдВ рдХрд┐ рдЖрдк рдЗрд╕реЗ C ++ рдореЗрдВ рдХреИрд╕реЗ рд▓рд╛рдЧреВ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдХреИрд╕реЗ рдмрдврд╝рд╛ рд╕рдХрддреЗ рд╣реИрдВред  рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ, рд╣рдореЗрдВ рд╕рд░реНрд╡рд░ рдФрд░ рдХреНрд▓рд╛рдЗрдВрдЯ рд╕реЗрд╢рди рдирд╛рдордХ рджреЛ рдСрдмреНрдЬреЗрдХреНрдЯ рдЪрд╛рд╣рд┐рдПред  рд╕рд░реНрд╡рд░ рд╕рддреНрд░ рдмреНрд░рд╛рдЙрдЬрд╝рд░ рдХреЗ рд╕рд╛рде рд╕рдВрдмрдВрдз рд╕реНрдерд╛рдкрд┐рдд рдХрд░рддрд╛ рд╣реИ рдФрд░ рдмрдирд╛рдП рд░рдЦрддрд╛ рд╣реИ; рдЧреНрд░рд╛рд╣рдХ рд╕рддреНрд░ рд╕реЗрд╡рд╛ рдХреЗ рд╕рд╛рде рд╕рдВрдмрдВрдз рд╕реНрдерд╛рдкрд┐рдд рдХрд░рддрд╛ рд╣реИ рдФрд░ рдмрдирд╛рдП рд░рдЦрддрд╛ рд╣реИред  рдЖрдкрдХреЛ рдПрдХ рд╕реНрдЯреНрд░реАрдо рдмрдлрд░ рдХреА рднреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрдЧреА рдЬреЛ рдХрд╛рдо рдХреЛ рдЕрдВрджрд░ рдореЗрдореЛрд░реА рдХреЗ рд╕рд╛рде рдПрдирдХреИрдкреНрд╕реБрд▓реЗрдЯ рдХрд░рддрд╛ рд╣реИ, рдЬрд┐рд╕рдореЗрдВ рд╕рд░реНрд╡рд░ рд╕рддреНрд░ рд╕реЙрдХреЗрдЯ рд╕реЗ рдкрдврд╝рддрд╛ рд╣реИ рдФрд░ рдЬрд┐рд╕рдореЗрдВ рд╕реЗ рдХреНрд▓рд╛рдЗрдВрдЯ рд╕рддреНрд░ рд╕реЙрдХреЗрдЯ рдХреЛ рд▓рд┐рдЦрддрд╛ рд╣реИред  рд╕рд░реНрд╡рд░ рдФрд░ рдХреНрд▓рд╛рдЗрдВрдЯ рд╕рддреНрд░ рдХреЗ рдЙрджрд╛рд╣рд░рдг рдмреВрд╕реНрдЯ.рдЖрд╕рд┐рдпреЛ рдХреЗ рд▓рд┐рдП рдкреНрд░рд▓реЗрдЦрди рдореЗрдВ рдкрд╛рдП рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВред  рд╕реНрдЯреНрд░реАрдо рдмрдлрд░ рдХреЗ рд╕рд╛рде рдХреИрд╕реЗ рдХрд╛рдо рдХрд┐рдпрд╛ рдЬрд╛рдП, рд╡рд╣рд╛рдВ рдкрд╛рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред <br><br>  рд╣рдо рдЙрджрд╛рд╣рд░рдгреЛрдВ рд╕реЗ рд░рд┐рд╡рд░реНрд╕ рдкреНрд░реЙрдХреНрд╕реА рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдХреЛ рдЗрдХрдЯреНрдард╛ рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж, рдпрд╣ рд╕реНрдкрд╖реНрдЯ рд╣реЛ рдЬрд╛рдПрдЧрд╛ рдХрд┐ рдЗрд╕ рддрд░рд╣ рдХрд╛ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рд╕рдВрднрд╡рддрдГ рдЕрд╕реАрдорд┐рдд рдЖрдиреЗ рд╡рд╛рд▓реЗ рдЯреНрд░реИрдлрд╝рд┐рдХ рдХреА рд╕реЗрд╡рд╛ рдирд╣реАрдВ рджреЗрдЧрд╛ред  рдлрд┐рд░ рд╣рдо рдХреЛрдб рдХреА рдЬрдЯрд┐рд▓рддрд╛ рдХреЛ рдмрдврд╝рд╛рдирд╛ рд╢реБрд░реВ рдХрд░реЗрдВрдЧреЗред  рдЖрдЗрдП io рд╕рдВрджрд░реНрднреЛрдВ рдХреЗ рд▓рд┐рдП рдорд▓реНрдЯреАрдереНрд░реЗрдбрд┐рдВрдЧ, рд╡реЛрдХрд░ рдФрд░ рдкреВрд▓ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рд╕реЛрдЪрддреЗ рд╣реИрдВ, рдФрд░ рдмрд╣реБрдд рдХреБрдЫред  рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ, рд╕рд░реНрд╡рд░ рдФрд░ рдХреНрд▓рд╛рдЗрдВрдЯ рд╕рддреНрд░реЛрдВ рдХреЗ рдмреАрдЪ рдореЗрдореЛрд░реА рдХреА рдирдХрд▓ рдХрд░рдиреЗ рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд рд╕рдордпрдкреВрд░реНрд╡ рдЕрдиреБрдХреВрд▓рди рдХреЗ рдмрд╛рд░реЗ рдореЗрдВред <br><br>  рд╣рдо рдХрд┐рд╕ рддрд░рд╣ рдХреА рдореЗрдореЛрд░реА рдХреЙрдкреА рдХрд░ рд░рд╣реЗ рд╣реИрдВ?  рддрдереНрдп рдпрд╣ рд╣реИ рдХрд┐ рдлрд╝рд┐рд▓реНрдЯрд░ рдХрд░рддреЗ рд╕рдордп, рдЯреНрд░реИрдлрд╝рд┐рдХ рд╣рдореЗрд╢рд╛ рдЕрдкрд░рд┐рд╡рд░реНрддрд┐рдд рдирд╣реАрдВ рд╣реЛрддрд╛ рд╣реИред  рдиреАрдЪреЗ рджрд┐рдП рдЧрдП рдЙрджрд╛рд╣рд░рдг рдХреЛ рджреЗрдЦреЗрдВ: рдЗрд╕рдореЗрдВ рд╣рдо рдПрдХ рд╣реЗрдбрд░ рдХреЛ рд╣рдЯрд╛рддреЗ рд╣реИрдВ рдФрд░ рдЗрд╕рдХреЗ рдмрдЬрд╛рдп рджреЛ рдЬреЛрдбрд╝рддреЗ рд╣реИрдВред  рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреНрд╡реЗрд░реА рдХреА рд╕рдВрдЦреНрдпрд╛ рдЬрд┐рд╕ рдкрд░ рд╕рдорд╛рди рдХрд╛рд░реНрдп рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВ, рд╕реЗрд╡рд╛ рдХреЗ рдЕрдВрджрд░ рддрд░реНрдХ рдХреА рдЬрдЯрд┐рд▓рддрд╛ рдХреЗ рд╕рд╛рде рдмрдврд╝ рдЬрд╛рддреА рд╣реИред  рдХрд┐рд╕реА рднреА рд╕реНрдерд┐рддрд┐ рдореЗрдВ рдЖрдк рдРрд╕реЗ рдорд╛рдорд▓реЛрдВ рдореЗрдВ рдбреЗрдЯрд╛ рдХреА рдирдХрд▓ рдирд╣реАрдВ рдХрд░ рд╕рдХрддреЗ!  рдпрджрд┐ рдХреБрд▓ рдЕрдиреБрд░реЛрдз рдХрд╛ рдХреЗрд╡рд▓ 1% рдмрджрд▓рддрд╛ рд╣реИ, рдФрд░ 99% рдЕрдкрд░рд┐рд╡рд░реНрддрд┐рдд рд░рд╣рддреЗ рд╣реИрдВ, рддреЛ рдЖрдкрдХреЛ рдХреЗрд╡рд▓ 1% рдХреЗ рд▓рд┐рдП рдирдИ рдореЗрдореЛрд░реА рдЖрд╡рдВрдЯрд┐рдд рдХрд░рдиреА рдЪрд╛рд╣рд┐рдПред  рдпрд╣ рдЖрдкрдХреЛ рдЗрд╕ рдмрдврд╝рд╛рд╡рд╛ рдХреЗ рд╕рд╛рде рдорджрдж рдХрд░реЗрдЧрд╛ :: asio :: const_buffer рдФрд░ boost :: asio :: mutable_buffer, рдЬрд┐рд╕рдХреА рдорджрдж рд╕реЗ рдЖрдк рдПрдХ рдЗрдХрд╛рдИ рдХреЗ рд╕рд╛рде рдореЗрдореЛрд░реА рдХреЗ рдХрдИ рдирд┐рд░рдВрддрд░ рдмреНрд▓реЙрдХреЛрдВ рдХрд╛ рдкреНрд░рддрд┐рдирд┐рдзрд┐рддреНрд╡ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред <br><br>  рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЕрдиреБрд░реЛрдз: <br><br><pre><code class="plaintext hljs">Browser -&gt; Proxy: &gt; POST / HTTP/1.1 &gt; User-Agent: curl/7.29.0 &gt; Host: 127.0.0.1:50080 &gt; Accept: */* &gt; Content-Length: 5888903 &gt; Content-Type: application/x-www-form-urlencoded &gt; ... Proxy -&gt; Service: &gt; POST / HTTP/1.1 &gt; User-Agent: curl/7.29.0 &gt; Host: 127.0.0.1:50080 &gt; Accept: */* &gt; Transfer-Encoding: chunked &gt; Content-Type: application/x-www-form-urlencoded &gt; Expect: 100-continue &gt; ... Service -&gt; Proxy: &lt; HTTP/1.1 200 OK Proxy -&gt; Browser &lt; HTTP/1.1 200 OK</code> </pre> <br><h3>  рд╕рдорд╕реНрдпрд╛ </h3><br>  рдирддреАрдЬрддрди, рд╣рдореЗрдВ рдПрдХ рддреИрдпрд╛рд░-рддреИрдпрд╛рд░ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдорд┐рд▓рд╛ рдЬреЛ рдЕрдЪреНрдЫреА рддрд░рд╣ рд╕реЗ рд╕реНрдХреЗрд▓ рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рд╕рднреА рдкреНрд░рдХрд╛рд░ рдХреЗ рдЕрдиреБрдХреВрд▓рди рдХреЗ рд╕рд╛рде рд╕рдВрдкрдиреНрди рд╣реИред  рдЗрд╕реЗ рдкреНрд░реЛрдбрдХреНрд╢рди рдореЗрдВ рд▓реЙрдиреНрдЪ рдХрд░рдХреЗ, рд╣рдо рдЗрд╕ рдмрд╛рдд рд╕реЗ рдХрд╛рдлреА рдЦреБрд╢ рдереЗ рдХрд┐ рдЗрд╕рдиреЗ рдХрд┐рддрдиреЗ рд╕рдордп рддрдХ рдЕрдЪреНрдЫрд╛ рдХрд╛рдо рдХрд┐рдпрд╛ рд╣реИред <br><br>  рд╕рдордп рдХреЗ рд╕рд╛рде, рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рдЕрдзрд┐рдХ рд╕реЗ рдЕрдзрд┐рдХ рдЧреНрд░рд╛рд╣рдХ рд╣реЛрдиреЗ рд▓рдЧреЗ, рдЬрд┐рд╕рдХреЗ рдЖрдЧрдорди рдХреЗ рд╕рд╛рде рдпрд╛рддрд╛рдпрд╛рдд рднреА рдмрдврд╝рд╛ рд╣реИред  рдХреБрдЫ рдмрд┐рдВрджреБ рдкрд░, рд╣рдореЗрдВ рдмрдбрд╝реЗ рд╣рдорд▓реЛрдВ рдХреЛ рджреЛрд╣рд░рд╛рддреЗ рд╣реБрдП рдкреНрд░рджрд░реНрд╢рди рдХреА рдХрдореА рдХреА рд╕рдорд╕реНрдпрд╛ рдХрд╛ рд╕рд╛рдордирд╛ рдХрд░рдирд╛ рдкрдбрд╝рд╛ред  рд╕рдВрдкреВрд░реНрдг рдЙрдкрдпреЛрдЧрд┐рддрд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╕реЗрд╡рд╛ рдХрд╛ рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж, рд╣рдордиреЗ рджреЗрдЦрд╛ рдХрд┐ рдвреЗрд░ рдХреЗ рдиреАрдЪреЗ рд▓реЛрдб рдХреЗ рд╕рд╛рде рд╕рднреА рдСрдкрд░реЗрд╢рди рд╢реАрд░реНрд╖ рдореЗрдВ рд╣реИрдВред  рдлрд┐рд░ рд╣рдордиреЗ рдкрд░реАрдХреНрд╖рдг рд╕рд░реНрдХрд┐рдЯ рдкрд░ рдПрдХ рд╕рдорд╛рди рд╕реНрдерд┐рддрд┐ рдХреЛ рдлрд┐рд░ рд╕реЗ рдмрдирд╛рдпрд╛, рдЬрд┐рд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рд╡рд╛рд╕реНрддрд╡рд┐рдХ рдЯреНрд░реИрдлрд┐рдХ рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рдЙрддреНрдкрдиреНрди <a href="https://github.com/yandex/yandex-tank" rel="nofollow">рдпреИрдВрдбреЗрдХреНрд╕-рдЯреИрдВрдХ</a> рдФрд░ рдХрд╛рд░рддреВрд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдХрд┐рдпрд╛ рдЧрдпрд╛ред  <a href="https://software.intel.com/en-us/vtune" rel="nofollow">рдПрдореНрдкрд▓реАрдлрд╛рдпрд░ рдХреЗ</a> рдорд╛рдзреНрдпрдо рд╕реЗ рдПрдХ рд╕реЗрд╡рд╛ рдкрд░ рд╣реБрдХрд┐рдВрдЧ рдХрд░рддреЗ рд╣реБрдП <a href="https://software.intel.com/en-us/vtune" rel="nofollow">,</a> рд╣рдордиреЗ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЪрд┐рддреНрд░ рджреЗрдЦрд╛ ... <br><br>  рдПрдореНрдкрд▓реАрдлрд╛рдпрд░ рдХрд╛ рд╕реНрдХреНрд░реАрдирд╢реЙрдЯ (рд╡реЛрд╕реНрд▓реИрдм): <br><br><img src="https://habrastorage.org/webt/tz/ks/d9/tzksd9oddf-rhcfphtkxkun-pdg.png"><br><br>  рд╕реНрдХреНрд░реАрдирд╢реЙрдЯ рдореЗрдВ, рдСрдкрд░реЗрдЯрд░ рдирдП рдиреЗ 67 рд╕реЗрдХрдВрдб рдХрд╛рдо рдХрд┐рдпрд╛, рдФрд░ рдСрдкрд░реЗрдЯрд░ рдиреЗ рдФрд░ рднреА рдЕрдзрд┐рдХ - 97 рд╕реЗрдХрдВрдб рд╣рдЯрд╛ рджрд┐рдПред <br><br>  рдЗрд╕ рд╕реНрдерд┐рддрд┐ рдиреЗ рд╣рдореЗрдВ рдкрд░реЗрд╢рд╛рди рдХрд░ рджрд┐рдпрд╛ред  рдСрдкрд░реЗрдЯрд░ рдиреНрдпреВ рдФрд░ рдСрдкрд░реЗрдЯрд░ рдбрд┐рд▓реАрдЯ рдореЗрдВ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рд╕реНрдЯреЗ рдЯрд╛рдЗрдо рдХреЛ рдХреИрд╕реЗ рдХрдо рдХрд░реЗрдВ?  рдпрд╣ рддрд░реНрдХрд╕рдВрдЧрдд рд╣реИ рдХрд┐ рдпрд╣ рдвреЗрд░ рдкрд░ рдЕрдХреНрд╕рд░ рдмрдирд╛рдП рдЧрдП рдФрд░ рд╣рдЯрд╛рдП рдЧрдП рдСрдмреНрдЬреЗрдХреНрдЯреНрд╕ рдХреЗ рдирд┐рд░рдВрддрд░ рдЖрд╡рдВрдЯрди рдХреЛ рдЫреЛрдбрд╝ рдХрд░ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред  рд╣рдо рддреАрди рджреГрд╖реНрдЯрд┐рдХреЛрдг рдкрд░ рдмрд╕ рдЧрдПред  рдЙрдирдореЗрдВ рд╕реЗ рджреЛ рдорд╛рдирдХ рд╣реИрдВ: <a href="https://en.wikipedia.org/wiki/Object_pool_pattern" rel="nofollow">рдСрдмреНрдЬреЗрдХреНрдЯ рдкреВрд▓</a> рдФрд░ <a href="https://en.wikipedia.org/wiki/Stack-based_memory_allocation" rel="nofollow">рд╕реНрдЯреИрдХ рдЖрд╡рдВрдЯрди</a> ред  рдХреНрд▓рд╛рдЗрдВрдЯ рд╕рддреНрд░ рдЬреЛ рдЕрдиреБрдкреНрд░рдпреЛрдЧ рд╕реНрдЯрд╛рд░реНрдЯ-рдЕрдк рдЪрд░рдг рдореЗрдВ рдПрдХ рдкреВрд▓ рдореЗрдВ рдЖрдпреЛрдЬрд┐рдд рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВ, рдкрд╣рд▓реЗ рджреГрд╖реНрдЯрд┐рдХреЛрдг рдкрд░ рдЕрдЪреНрдЫреА рддрд░рд╣ рд╕реЗ рд░рдЦреЗ рдЬрд╛рддреЗ рд╣реИрдВред  рджреВрд╕рд░реЗ рджреГрд╖реНрдЯрд┐рдХреЛрдг рдХрд╛ рдЙрдкрдпреЛрдЧ рд╣рд░ рдЬрдЧрд╣ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдЬрд╣рд╛рдВ рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЕрдиреБрд░реЛрдз рдЙрд╕реА рд╕реНрдЯреИрдХ рдореЗрдВ рд╢реБрд░реВ рд╕реЗ рдЕрдВрдд рддрдХ рд╕рдВрд╕рд╛рдзрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рджреВрд╕рд░реЗ рд╢рдмреНрджреЛрдВ рдореЗрдВ, рд╕рдорд╛рди рдЖрдИрдУрдЖрдИ рд╣реИрдВрдбрд▓рд░ рдореЗрдВред  рд╣рдо рдЗрд╕ рдкрд░ рдЕрдзрд┐рдХ рд╡рд┐рд╕реНрддрд╛рд░ рд╕реЗ рдзреНрдпрд╛рди рдирд╣реАрдВ рджреЗрдВрдЧреЗред  рд╣рдо рддреАрд╕рд░реЗ рджреГрд╖реНрдЯрд┐рдХреЛрдг рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдмреЗрд╣рддрд░ рдмрд╛рдд рдХрд░рддреЗ рд╣реИрдВ, рд╕рдмрд╕реЗ рдЬрдЯрд┐рд▓ рдФрд░ рджрд┐рд▓рдЪрд╕реНрдк рдХреЗ рд░реВрдк рдореЗрдВред  рдЗрд╕реЗ <a href="https://en.wikipedia.org/wiki/Slab_allocation" rel="nofollow">рд╕реНрд▓реИрдм рдЖрд╡рдВрдЯрди</a> рдпрд╛ рд╕реНрд▓реИрдм рд╡рд┐рддрд░рдг рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИред <br><br>  рд╕реНрд▓реИрдм рд╡рд┐рддрд░рдг рдХрд╛ рд╡рд┐рдЪрд╛рд░ рдирдпрд╛ рдирд╣реАрдВ рд╣реИред  рдпрд╣ рдЖрд╡рд┐рд╖реНрдХрд╛рд░ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ рдФрд░ рд╕реЛрд▓рд╛рд░рд┐рд╕ рдореЗрдВ рд▓рд╛рдЧреВ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛, рдмрд╛рдж рдореЗрдВ рд▓рд┐рдирдХреНрд╕ рдХрд░реНрдиреЗрд▓ рдореЗрдВ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рд╣реЛ рдЧрдпрд╛, рдФрд░ рдЗрд╕ рддрдереНрдп рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реИ рдХрд┐ рдЕрдХреНрд╕рд░ рдПрдХ рд╣реА рдкреНрд░рдХрд╛рд░ рдХреА рд╡рд╕реНрддреБрдУрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдкреВрд▓ рдореЗрдВ рд╕реНрдЯреЛрд░ рдХрд░рдирд╛ рдЖрд╕рд╛рди рд╣реЛрддрд╛ рд╣реИред  рд╣рдореЗрдВ рдЬрд░реВрд░рдд рдкрдбрд╝рдиреЗ рдкрд░ рд╣рдо рдкреВрд▓ рд╕реЗ рд╣реА рд╡рд╕реНрддреБ рд▓реЗрддреЗ рд╣реИрдВ рдФрд░ рдХрд╛рдо рдкреВрд░рд╛ рд╣реЛрдиреЗ рдкрд░ рд╣рдо рдЙрд╕реЗ рд╡рд╛рдкрд╕ рд▓реМрдЯрд╛ рджреЗрддреЗ рд╣реИрдВред  рдСрдкрд░реЗрдЯрд░ рдирдП рдФрд░ рдСрдкрд░реЗрдЯрд░ рдХреЛ рд╣рдЯрд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдХреЛрдИ рдХреЙрд▓ рдирд╣реАрдВ!  рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдкреНрд░рд╛рд░рдВрдн рдХрд╛ рдПрдХ рдиреНрдпреВрдирддрдоред  рд╕реНрд▓реИрдм рдХреЛрд░ рдореЗрдВ, рд╡рд┐рддрд░рдг рдХрд╛ рдЙрдкрдпреЛрдЧ рд╕реЗрдорд╛рдлреЛрд░, рдлрд╝рд╛рдЗрд▓ рдбрд┐рд╕реНрдХреНрд░рд┐рдкреНрдЯрд░, рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдФрд░ рдереНрд░реЗрдбреНрд╕ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред  рд╣рдорд╛рд░реЗ рдорд╛рдорд▓реЗ рдореЗрдВ, рдпрд╣ рд╕рд░реНрд╡рд░ рдФрд░ рдХреНрд▓рд╛рдЗрдВрдЯ рд╕рддреНрд░реЛрдВ рдкрд░ рдкреВрд░реА рддрд░рд╣ рд╕реЗ рдЧрд┐рд░ рдЧрдпрд╛, рд╕рд╛рде рд╣реА рд╕рд╛рде рд╕рдм рдХреБрдЫ рдЬреЛ рдЙрдирдХреЗ рдЕрдВрджрд░ рд╣реИред <br><br>  рдЪрд╛рд░реНрдЯ (рд╕реНрд▓реИрдм рд╡рд┐рддрд░рдг): <br><br><img src="https://habrastorage.org/webt/zb/k2/u8/zbk2u8m0jexhso3nmkttzxkvrw0.png"><br><br>  рдЗрд╕ рддрдереНрдп рдХреЗ рдЕрд▓рд╛рд╡рд╛ рдХрд┐ рд╕реНрд▓реИрдм рдЖрд╡рдВрдЯрди рдХрд░реНрдиреЗрд▓ рдореЗрдВ рд╣реИрдВ, рдЙрдирдХреЗ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕реНрдерд╛рди рдореЗрдВ рднреА рдореМрдЬреВрдж рд╣реИрдВред  рдЙрдирдореЗрдВ рд╕реЗ рдХреБрдЫ рд╣реИрдВ, рдФрд░ рдЬреЛ рд╕рдХреНрд░рд┐рдп рд░реВрдк рд╕реЗ рд╡рд┐рдХрд╕рд┐рдд рд╣реЛ рд░рд╣реЗ рд╣реИрдВ рд╡реЗ рдЖрдо рддреМрд░ рдкрд░ рдХрдо рд╣реИрдВред  рд╣рдо рдПрдХ рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдкрд░ рдЧрдП рд╣реИрдВ рдЬрд┐рд╕реЗ <a href="https://github.com/tarantool/small" rel="nofollow">рд▓рд┐рдмрд╕реНрдореЙрд▓</a> рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬреЛ <a href="https://github.com/tarantool/small" rel="nofollow">рдЯрд╛рд░рдирдЯреВрд▓</a> рдХрд╛ рд╣рд┐рд╕реНрд╕рд╛ рд╣реИред  рдЗрд╕рдореЗрдВ рд╡рд╣ рд╕рдм рдХреБрдЫ рд╣реИ рдЬреЛ рдЖрдкрдХреЛ рдЪрд╛рд╣рд┐рдПред <br><br><ul><li>  рдЫреЛрдЯрд╛ :: рдЖрд╡рдВрдЯрдирдХрд░реНрддрд╛ </li><li>  рдЫреЛрдЯрд╛ :: slab_cache (рд╕реНрдерд╛рдиреАрдп рд╕реНрдерд╛рдиреАрдп) </li><li>  рдЫреЛрдЯрд╛ :: рд╕реНрд▓реИрдм </li><li>  рдЫреЛрдЯрд╛ :: рдЕрдЦрд╛рдбрд╝рд╛ </li><li>  рдЫреЛрдЯрд╛ :: рдХреЛрдЯрд╛ </li></ul><br>  рдЫреЛрдЯрд╛ :: рд╕реНрд▓реИрдм рд╕рдВрд░рдЪрдирд╛ рдПрдХ рдкреВрд▓ рд╣реИ рдЬрд┐рд╕рдореЗрдВ рдПрдХ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдкреНрд░рдХрд╛рд░ рдХреА рд╡рд╕реНрддреБ рд╣реЛрддреА рд╣реИред  рд╕рдВрд░рдЪрдирд╛ рдЫреЛрдЯрд╛ :: slab_cache рдПрдХ рдХреИрд╢ рд╣реИ рдЬрд┐рд╕рдореЗрдВ рдПрдХ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдкреНрд░рдХрд╛рд░ рдХреА рд╡рд╕реНрддреБрдУрдВ рдХреЗ рд╕рд╛рде рдкреВрд▓реЛрдВ рдХреА рд╡рд┐рднрд┐рдиреНрди рд╕реВрдЪрд┐рдпрд╛рдБ рд╣реЛрддреА рд╣реИрдВред  рд╕рдВрд░рдЪрдирд╛ рдЫреЛрдЯрд╛ :: рдЖрд╡рдВрдЯрдирдХрд░реНрддрд╛ рдПрдХ рдХреЛрдб рд╣реИ рдЬреЛ рдЖрд╡рд╢реНрдпрдХ рдХреИрд╢ рдХрд╛ рдЪрдпрди рдХрд░рддрд╛ рд╣реИ, рдЗрд╕рдореЗрдВ рдПрдХ рдЙрдкрдпреБрдХреНрдд рдкреВрд▓ рдХреА рддрд▓рд╛рд╢ рдХрд░рддрд╛ рд╣реИ, рдЬрд┐рд╕рдореЗрдВ рдЕрдиреБрд░реЛрдзрд┐рдд рд╡рд╕реНрддреБ рд╡рд┐рддрд░рд┐рдд рдХреА рдЬрд╛рддреА рд╣реИред  рдХреНрдпрд╛ рдЫреЛрдЯреЗ :: рдЕрдЦрд╛рдбрд╝рд╛ рдФрд░ рдЫреЛрдЯреА :: рдХреЛрдЯрд╛ рд╡рд╕реНрддреБрдПрдВ рдиреАрдЪреЗ рджрд┐рдП рдЧрдП рдЙрджрд╛рд╣рд░рдгреЛрдВ рд╕реЗ рд╕реНрдкрд╖реНрдЯ рд╣реЛрдВрдЧреАред <br><br><h3>  рд▓рдкреЗрдЯрдирд╛ </h3><br>  рд▓рд┐рдмрд╕реНрдореЙрд▓ рд▓рд╛рдЗрдмреНрд░реЗрд░реА C рдореЗрдВ рд▓рд┐рдЦреА рдЧрдИ рд╣реИ, C ++ рдореЗрдВ рдирд╣реАрдВ, рдЗрд╕рд▓рд┐рдП рд╣рдореЗрдВ рдорд╛рдирдХ C ++ рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдореЗрдВ рдкрд╛рд░рджрд░реНрд╢реА рдПрдХреАрдХрд░рдг рдХреЗ рд▓рд┐рдП рдХрдИ рдЖрд╡рд░рдг рд╡рд┐рдХрд╕рд┐рдд рдХрд░рдиреЗ рдкрдбрд╝реЗред <br><br><ul><li>  variti :: slab_allocator </li><li>  variti :: рд╕реНрд▓реИрдм </li><li>  variti :: thread_local_slab </li><li>  variti :: slab_allocate_sared </li></ul><br>  Variti :: slab_allocator рд╡рд░реНрдЧ рдиреНрдпреВрдирддрдо рдЖрд╡рд╢реНрдпрдХрддрд╛рдУрдВ рдХреЛ рд▓рд╛рдЧреВ рдХрд░рддрд╛ рд╣реИ рдЬреЛ рдорд╛рдирдХ рджреНрд╡рд╛рд░рд╛ рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВ рдЬрдм рд╡рд╣ рд╕реНрд╡рдпрдВ рдХреЛ рдЖрд╡рдВрдЯрд┐рдд рдХрд░рддрд╛ рд╣реИред  рдЕрдВрджрд░ рд╡рд╛рд░рд┐рдЯреА :: рд╕реНрд▓реИрдм рдХреНрд▓рд╛рд╕реЗрд╕, рд▓рд┐рдмрд╛рд╕рд╛рдорд▓ рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдХреЗ рд╕рд╛рде рд╕рднреА рдХрд╛рдо рд╕рдордЭрд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред  рд╡реЗрд░рд╛рдЗрдЯреА :: рдереНрд░реЗрдб_рд▓реЛрдХрд▓_рд╕реНрд▓реИрдм рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдХреНрдпреЛрдВ рд╣реИ?  рддрдереНрдп рдпрд╣ рд╣реИ рдХрд┐ рд╡рд┐рддрд░рдг рд╕реНрд▓реИрдм рдХреИрд╢ рдереНрд░реЗрдб рд╕реНрдерд╛рдиреАрдп рдСрдмреНрдЬреЗрдХреНрдЯ рд╣реИрдВред  рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рдкреНрд░рддреНрдпреЗрдХ рдереНрд░реЗрдб рдореЗрдВ рдХреИрд╢ рдХрд╛ рдЕрдкрдирд╛ рд╕реЗрдЯ рд╣реЛрддрд╛ рд╣реИред  рдпрд╣ рдПрдХ рдирдИ рд╡рд╕реНрддреБ рдХреЛ рд╡рд┐рддрд░рд┐рдд рдХрд░рддреЗ рд╕рдордп рдЕрд╡рд░реБрджреНрдз рдХрд╛рд░реНрдпреЛрдВ рдХреА рд╕рдВрдЦреНрдпрд╛ рдХреЛ рд╢реВрдиреНрдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред  рдЗрд╕рд▓рд┐рдП, рдкреНрд░рддреНрдпреЗрдХ рдереНрд░реЗрдб рдХреА рд╕реНрдореГрддрд┐ рдореЗрдВ, рд╣рдо рдЕрдкрдиреЗ рдЙрджрд╛рд╣рд░рдг рдХреЛ variti :: рд╕реНрд▓реИрдм рдХреНрд▓рд╛рд╕ рдореЗрдВ рд░рдЦрддреЗ рд╣реИрдВ, рдФрд░ рдЙрд╕ рддрдХ рдкрд╣реБрдБрдЪ рдХреЛ variti :: thread_local_slab рдЖрд╡рд░рдг рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╡рд┐рдирд┐рдпрдорд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред  рдореИрдВ рдЖрдкрдХреЛ рдЯреЗрдореНрдкрд▓реЗрдЯ рдлрдВрдХреНрд╢рди variti :: slab_allocate_sared рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдмрддрд╛рдКрдВрдЧрд╛ред <br><br>  рд╡реЗрд░рд╛рдЗрдЯреА рдХреЗ рдЕрдВрджрд░ :: slab_allocator рд╡рд░реНрдЧ, рд╕рдм рдХреБрдЫ рдХрд╛рдлреА рд╕рд░рд▓ рд╣реИред  рдЙрд╕рдХреЗ рдкрд╛рд╕ рдПрдХ рдкреНрд░рдХрд╛рд░ рд╕реЗ рджреВрд╕рд░реЗ рдкреНрд░рдХрд╛рд░ рддрдХ рд╡рд┐рджреНрд░реЛрд╣ рдХрд░рдиреЗ рдХреА рдХреНрд╖рдорддрд╛ рд╣реИ, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рд╢реВрдиреНрдп рд╕реЗ рдЪрд╛рд░ рддрдХред  рджрд┐рд▓рдЪрд╕реНрдк рд╣реИ, рдЖрдк nullptr рдХреА рд╡реНрдпрд╛рдкрдХрддрд╛ рдкрд░ рдзреНрдпрд╛рди рджреЗ рд╕рдХрддреЗ рд╣реИрдВ рдЕрдкрд╡рд╛рдж std :: bad_alloc рдорд╛рдорд▓реЗ рдореЗрдВ рдЬрдм рдореЗрдореЛрд░реА рд╡рд┐рддрд░рдг рд╕реНрд▓реИрдм рд╕реЗ рдмрд╛рд╣рд░ рдирд┐рдХрд▓рддреА рд╣реИред  рдмрд╛рдХреА рд╡реИрд░рд╛рдЗрдЯреА :: рдереНрд░реЗрдб_рд▓реЛрдХрд▓_рд╕реНрд▓реИрдм рд░реИрдкрд░ рдХреЗ рдЕрдВрджрд░ рдХреЙрд▓ рдлреЙрд░рд╡рд░реНрдб рдХрд░ рд░рд╣рд╛ рд╣реИред <br><br>  рд╕реНрдирд┐рдкреЗрдЯ (slab_allocator.hpp): <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">slab_allocator</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> value_type = T; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> pointer = value_type*; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> const_pointer = <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> value_type*; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> reference = value_type&amp;; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> const_reference = <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> value_type&amp;; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> U&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rebind</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> other = slab_allocator&lt;U&gt;; }; slab_allocator() {} <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> U&gt; slab_allocator(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> slab_allocator&lt;U&gt;&amp; other) {} <span class="hljs-function"><span class="hljs-function">T* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">allocate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> n, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">* = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">nullptr</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> p = <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;T*&gt;(thread_local_slab::allocate(<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(T) * n)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!p &amp;&amp; n) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::bad_alloc(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> p; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deallocate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(T* p, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> n)</span></span></span><span class="hljs-function"> </span></span>{ thread_local_slab::deallocate(p, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(T) * n); } }; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">slab_allocator</span></span></span><span class="hljs-class">&lt;void&gt; {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> value_type = <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> pointer = <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>*; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> const_pointer = <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>*; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> U&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rebind</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> slab_allocator&lt;U&gt; other; }; };</code> </pre> <br>  рдЖрдЗрдП рджреЗрдЦреЗрдВ рдХрд┐ рдХрдВрд╕реНрдЯреНрд░рдХреНрдЯрд░ рдФрд░ рдбрд┐рд╕реНрдЯреНрд░рдХреНрдЯрд░ рд╡реЗрд░рд┐рдЯреА :: рд╕реНрд▓реИрдм рдХреИрд╕реЗ рд▓рд╛рдЧреВ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред  рдХрдВрд╕реНрдЯреНрд░рдХреНрдЯрд░ рдореЗрдВ, рд╣рдо рд╕рднреА рд╡рд╕реНрддреБрдУрдВ рдХреЗ рд▓рд┐рдП рдореЗрдореЛрд░реА рдХреЗ 1 GiB рд╕реЗ рдЕрдзрд┐рдХ рдХреБрд▓ рдЖрд╡рдВрдЯрд┐рдд рдХрд░рддреЗ рд╣реИрдВред  рд╣рдорд╛рд░реЗ рдорд╛рдорд▓реЗ рдореЗрдВ рдкреНрд░рддреНрдпреЗрдХ рдкреВрд▓ рдХрд╛ рдЖрдХрд╛рд░ 1 MiB рд╕реЗ рдЕрдзрд┐рдХ рдирд╣реАрдВ рд╣реИред  рдиреНрдпреВрдирддрдо рд╡рд╕реНрддреБ рдЬрд┐рд╕реЗ рд╣рдо рд╡рд┐рддрд░рд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рд╡рд╣ рдЖрдХрд╛рд░ рдореЗрдВ 2 рдмрд╛рдЗрдЯреНрд╕ рд╣реИ (рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ, рд▓реАрдмрд╕реНрдореЙрд▓ рдЗрд╕реЗ рдиреНрдпреВрдирддрдо рдЖрд╡рд╢реНрдпрдХ - 8 рдмрд╛рдЗрдЯреНрд╕ рддрдХ рдмрдврд╝рд╛ рджреЗрдЧрд╛)ред  рд╣рдорд╛рд░реЗ рд╕реНрд▓реИрдм рд╡рд┐рддрд░рдг рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЙрдкрд▓рдмреНрдз рд╢реЗрд╖ рд╡рд╕реНрддреБрдПрдВ рджреЛ рдореЗрдВ рд╕реЗ рдХрдИ (рд╕реНрдерд┐рд░ 2.f рджреНрд╡рд╛рд░рд╛ рдирд┐рд░реНрдзрд╛рд░рд┐рдд) рд╣реЛрдВрдЧреАред  рдХреБрд▓, рдЖрдк рдЖрдХрд╛рд░ 8, 16, 32, рдЖрджрд┐ рдХреА рд╡рд╕реНрддреБрдУрдВ рдХреЛ рд╡рд┐рддрд░рд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред  рдпрджрд┐ рдЕрдиреБрд░реЛрдзрд┐рдд рд╡рд╕реНрддреБ 24 рдмрд╛рдЗрдЯ рдЖрдХрд╛рд░ рдореЗрдВ рд╣реИ, рддреЛ рд╕реНрдореГрддрд┐ рд╕реЗ рдПрдХ рдУрд╡рд░рд╣реЗрдб рд╣реЛрдЧрд╛ред  рд╡рд┐рддрд░рдг рдЗрд╕ рдСрдмреНрдЬреЗрдХреНрдЯ рдХреЛ рдЖрдкрдХреЗ рдкрд╛рд╕ рд▓реМрдЯрд╛ рджреЗрдЧрд╛, рд▓реЗрдХрд┐рди рдЗрд╕реЗ рдПрдХ рдкреВрд▓ рдореЗрдВ рд░рдЦрд╛ рдЬрд╛рдПрдЧрд╛ рдЬреЛ рдЖрдХрд╛рд░ рдореЗрдВ 32 рдмрд╛рдЗрдЯреНрд╕ рдХреЗ рдСрдмреНрдЬреЗрдХреНрдЯ рд╕реЗ рдореЗрд▓ рдЦрд╛рддреА рд╣реИред  рд╢реЗрд╖ 8 рдмрд╛рдЗрдЯреНрд╕ рдмреЗрдХрд╛рд░ рд╣реЛ рдЬрд╛рдПрдВрдЧреЗред <br><br>  рд╕реНрдирд┐рдкреЗрдЯ (slab.hpp): <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function">* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">phys_to_virt_p</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">* p)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">reinterpret_cast</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>*&gt;(p) + <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::thread::id); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> size_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">phys_to_virt_n</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> n)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> n - <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::thread::id); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function">* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">virt_to_phys_p</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">* p)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">reinterpret_cast</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>*&gt;(p) - <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::thread::id); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> size_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">virt_to_phys_n</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> n)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> n + <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::thread::id); } <span class="hljs-keyword"><span class="hljs-keyword">inline</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::thread::<span class="hljs-function"><span class="hljs-function">id&amp; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">phys_thread_id</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">* p)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> *<span class="hljs-keyword"><span class="hljs-keyword">reinterpret_cast</span></span>&lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::thread::id*&gt;(p); } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">slab</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> noncopyable { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: slab() { small::quota_init(&amp; quota_, <span class="hljs-number"><span class="hljs-number">1024</span></span> * <span class="hljs-number"><span class="hljs-number">1024</span></span> * <span class="hljs-number"><span class="hljs-number">1024</span></span>); small::slab_arena_create(&amp;arena_, &amp; quota_, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1024</span></span> * <span class="hljs-number"><span class="hljs-number">1024</span></span>, MAP_PRIVATE); small::slab_cache_create(&amp;cache_, &amp;arena_); small::allocator_create(&amp;allocator_, &amp;cache_, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">2.f</span></span>); } ~slab() { small::allocator_destroy(&amp;allocator_); small::slab_cache_destroy(&amp;cache_); small::slab_arena_destroy(&amp;arena_); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function">* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">allocate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> n)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> phys_n = virt_to_phys_n(n); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> phys_p = small::<span class="hljs-built_in"><span class="hljs-built_in">malloc</span></span>(&amp;allocator_, phys_n); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!phys_p) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>; phys_thread_id(phys_p) = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::this_thread::get_id(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> phys_to_virt_p(phys_p); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deallocate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">* p, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> n)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> phys_p = virt_to_phys_p(<span class="hljs-keyword"><span class="hljs-keyword">const_cast</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>*&gt;(p)); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> phys_n = virt_to_phys_n(n); assert(phys_thread_id(phys_p) == <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::this_thread::get_id()); small::<span class="hljs-built_in"><span class="hljs-built_in">free</span></span>(&amp;allocator_, phys_p, phys_n); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: small::quota quota_; small::slab_arena arena_; small::slab_cache cache_; small::allocator allocator_; };</code> </pre> <br>  рдпреЗ рд╕рднреА рдкреНрд░рддрд┐рдмрдВрдз рдПрдХ рд╡рд┐рд╢реЗрд╖ рдЙрджрд╛рд╣рд░рдг рдХреЗ рд╡реИрд░рд╛рдЗрдЯреА :: рд╕реНрд▓реИрдм рд╡рд░реНрдЧ рдкрд░ рд▓рд╛рдЧреВ рд╣реЛрддреЗ рд╣реИрдВред  рдЪреВрдВрдХрд┐ рдкреНрд░рддреНрдпреЗрдХ рдереНрд░реЗрдб рдХрд╛ рдЕрдкрдирд╛ (рдереНрд░реЗрдб рд▓реЛрдХрд▓ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рд╕реЛрдЪрдирд╛) рд╣реЛрддрд╛ рд╣реИ, рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдкрд░ рдХреБрд▓ рд╕реАрдорд╛ 1 GiB рдирд╣реАрдВ рд╣реЛрдЧреА, рд▓реЗрдХрд┐рди рд╕реНрд▓реИрдм рд╡рд┐рддрд░рдг рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рдереНрд░реЗрдбреНрд╕ рдХреА рд╕рдВрдЦреНрдпрд╛ рдХреЗ рд▓рд┐рдП рд╕реАрдзреЗ рдЖрдиреБрдкрд╛рддрд┐рдХ рд╣реЛрдЧреАред <br><br>  рдЪрд╛рд░реНрдЯ (std :: рдереНрд░реЗрдб :: id): <br><br><img src="https://habrastorage.org/webt/_8/65/jy/_865jyoyp0qqoz7-tgsgmjsc9b0.png"><br><br>  рдПрдХ рддрд░рдл, рдереНрд░реЗрдб рд▓реЛрдХрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рд╕реЗ рдЖрдкрдХреЛ рдорд▓реНрдЯреА-рдереНрд░реЗрдбреЗрдб рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдореЗрдВ рд╕реНрд▓реИрдм рд╡рд┐рддрд░рдг рдХреЗ рдХрд╛рдо рдореЗрдВ рддреЗрдЬреА рд▓рд╛рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдорд┐рд▓рддреА рд╣реИ, рджреВрд╕рд░реА рдУрд░, рдпрд╣ рдПрд╕рд┐рдВрдХреНрд░реЛрдирд╕ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЗ рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░ рдкрд░ рдЧрдВрднреАрд░ рдкреНрд░рддрд┐рдмрдВрдз рд▓рдЧрд╛рддрд╛ рд╣реИред  рдЖрдкрдХреЛ рдЕрдиреБрд░реЛрдз рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдП рдФрд░ рдЙрд╕реА рд╕реНрдЯреНрд░реАрдо рдореЗрдВ рдСрдмреНрдЬреЗрдХреНрдЯ рд╡рд╛рдкрд╕ рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдПред  рдЗрд╕реЗ рдмрдврд╝рд╛рд╡рд╛ рджреЗрдиреЗ рдХреЗ рд╣рд┐рд╕реНрд╕реЗ рдХреЗ рд░реВрдк рдореЗрдВ рдХрд░рдирд╛ред рдХрднреА-рдХрднреА рдмрд╣реБрдд рд╕рдорд╕реНрдпрд╛рдЧреНрд░рд╕реНрдд рд╣реЛрддрд╛ рд╣реИред  рд╕реНрдкрд╖реНрдЯ рд░реВрдк рд╕реЗ рдЧрд▓рдд рд╕реНрдерд┐рддрд┐рдпреЛрдВ рдХреЛ рдЯреНрд░реИрдХ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдкреНрд░рддреНрдпреЗрдХ рдСрдмреНрдЬреЗрдХреНрдЯ рдХреА рд╢реБрд░реБрдЖрдд рдореЗрдВ рд╣рдо рдЙрд╕ рд╕реНрдЯреНрд░реАрдо рдХреЗ рдкрд╣рдЪрд╛рдирдХрд░реНрддрд╛ рдХреЛ рдЖрд╡рдВрдЯрд┐рдд рдХрд░рддреЗ рд╣реИрдВ рдЬрд┐рд╕рдореЗрдВ рдЖрд╡рдВрдЯрд┐рдд рд╡рд┐рдзрд┐ рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИред  рдЗрд╕ рдкрд╣рдЪрд╛рдирдХрд░реНрддрд╛ рдХреЛ рддрдм рдбреАрд▓рд▓реЛрдХреЗрдЯ рд╡рд┐рдзрд┐ рдореЗрдВ рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред  рдЗрд╕рдореЗрдВ рдорджрдж рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рдЪрд┐рдХрд┐рддреНрд╕рдХ_рддреЛ_рд╡рд┐рд░рдд_рдкрдж рдФрд░ рдЧреБрдг_рддреЛ_рдкреНрдпрд╛рд░реА_рдкреА рдорджрдж рдХрд░рддреЗ рд╣реИрдВред <br><br>  рд╕реНрдирд┐рдкреЗрдЯ (рдереНрд░реЗрдб_рд▓реЛрдХрд▓_рд╕реНрд▓реИрдм.рд╣рдк): <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">thread_local_slab</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> noncopyable { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initialize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">finalize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function">* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">allocate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> n)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deallocate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">* p, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> n)</span></span></span></span>; };</code> </pre> <br>  рд╕реНрдирд┐рдкреЗрдЯ (рдереНрд░реЗрдб_рд▓реЛрдХрд▓_рд╕реНрд▓реИрдм.рдХреИрдк): <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">thread_local</span></span> slab* slab_; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> thread_local_slab::initialize() { slab_ = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> slab(slab_cfg_); } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> thread_local_slab::finalize() { <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> slab_; } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>* thread_local_slab::<span class="hljs-built_in"><span class="hljs-built_in">malloc</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> n) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> slab_-&gt;<span class="hljs-built_in"><span class="hljs-built_in">malloc</span></span>(n); } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> thread_local_slab::<span class="hljs-built_in"><span class="hljs-built_in">free</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>* p, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> n) { slab_-&gt;<span class="hljs-built_in"><span class="hljs-built_in">free</span></span>(p, n); }</code> </pre> <br>  рдЬрдм рд╕реНрдЯреНрд░реАрдо рдкрд░ рдирд┐рдпрдВрддреНрд░рдг рдЦреЛ рдЬрд╛рддрд╛ рд╣реИ (рдЬрдм рд╡рд┐рднрд┐рдиреНрди рдЖрдИрдУрдИ рд╕рдВрджрд░реНрднреЛрдВ рдХреЗ рдмреАрдЪ рдХрд┐рд╕реА рд╡рд╕реНрддреБ рдХреЛ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд░рдирд╛), рддреЛ рдПрдХ рд╕реНрдорд╛рд░реНрдЯ рдкреЙрдЗрдВрдЯрд░ рдСрдмреНрдЬреЗрдХреНрдЯ рдХреЗ рд╕рд╣реА рд░рд┐рд▓реАрдЬ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред  рд╡рд╣ рдЬреЛ рдХреБрдЫ рднреА рдХрд░рддрд╛ рд╣реИ, рд╡рд╣ рд╡рд╕реНрддреБ рдХреЛ рдЙрд╕рдХреЗ io рд╕рдВрджрд░реНрдн рдХреЛ рдпрд╛рдж рдХрд░рддреЗ рд╣реБрдП рд╡рд┐рддрд░рд┐рдд рдХрд░рддрд╛ рд╣реИ, рдФрд░ рдлрд┐рд░ рдЗрд╕реЗ std рдореЗрдВ рд▓рдкреЗрдЯрддрд╛ рд╣реИ :: рдПрдХ рдХрд╕реНрдЯрдо рд╡рд┐рднрдХреНрдд рдХреЗ рд╕рд╛рде рд╕рд╛рдЭрд╛ рдХрд┐рдпрд╛ рдЧрдпрд╛, рдЬреЛ рд╡рд┐рддрд░рдг рдХреЛ рд╡рд╕реНрддреБ рдХреЛ рддреБрд░рдВрдд рд╡рд╛рдкрд╕ рдирд╣реАрдВ рдХрд░рддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдЗрд╕реЗ рдкрд╣рд▓реЗ рд╕рд╣реЗрдЬреЗ рдЧрдП io рд╕рдВрджрд░реНрдн рдореЗрдВ рдХрд░рддрд╛ рд╣реИред  рдпрд╣ рдЕрдЪреНрдЫреА рддрд░рд╣ рд╕реЗ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ рдЬрдм рдкреНрд░рддреНрдпреЗрдХ io рд╕рдВрджрд░реНрдн рдПрдХ рд╣реА рдзрд╛рдЧреЗ рдкрд░ рдЪрд▓рддрд╛ рд╣реИред  рдЕрдиреНрдпрдерд╛, рджреБрд░реНрднрд╛рдЧреНрдп рд╕реЗ, рдпрд╣ рджреГрд╖реНрдЯрд┐рдХреЛрдг рд▓рд╛рдЧреВ рдирд╣реАрдВ рд╣реИред <br><br>  рд╕реНрдирд┐рдкреЗрдЯ (slab_helper.hpp): <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Allocator, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span>... Args&gt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>&lt;T&gt; slab_allocate_shared(Allocator allocator, Args... args) { T* p = allocator.allocate(<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ((<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>*)p) T(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::forward&lt;Args&gt;(args)...); <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>&lt;T&gt; ptr(p, [allocator](T* p) { p-&gt;~T(); allocator.deallocate(p); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ptr; }; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> Allocator, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span>... Args&gt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>&lt;T&gt; slab_allocate_shared(Allocator allocator, boost::asio::io_service* io, Args... args) { T* p = allocator.allocate(<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ((<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>*)p) T(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::forward&lt;Args&gt;(args)...); <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">shared_ptr</span></span>&lt;T&gt; ptr(p, [allocator, io](T* p) { io-&gt;post([allocator, p]() { p-&gt;~T(); allocator.deallocate(p); }); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ptr; };</code> </pre> <br><h3>  рдирд┐рд░реНрдгрдп </h3><br>  рдкрд░рд┐рд╡рд╛рдж рд░реИрдкрд┐рдВрдЧ рдХрд╛ рдХрд╛рдо рдкреВрд░рд╛ рд╣реЛрдиреЗ рдХреЗ рдмрд╛рдж, рд╣рдо рдкрд╣рд▓реА рдмрд╛рд░ рдЪреВрди рдЖрдмрдВрдЯрдХреЛрдВ рдХреЛ рд╕реНрдЯреНрд░реАрдо рдмрдлрд░ рдХреЗ рдЕрдВрджрд░ рд╕реНрд▓реИрдм рдореЗрдВ рд▓реЗ рдЧрдПред  рдпрд╣ рдХрд░рдирд╛ рдмрд╣реБрдд рдЖрд╕рд╛рди рдерд╛ред  рдПрдХ рд╕рдХрд╛рд░рд╛рддреНрдордХ рдкрд░рд┐рдгрд╛рдо рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж, рд╣рдо рдЖрдЧреЗ рдмрдврд╝реЗ рдФрд░ рд╕реНрд▓реИрдм рдЖрд╡рдВрдЯрдирдХрд░реНрддрд╛рдУрдВ рдХреЛ рдкрд╣рд▓реЗ рд╕реНрдЯреНрд░реАрдо рдмрдлрд░ рдкрд░ рд▓рд╛рдЧреВ рдХрд┐рдпрд╛, рдФрд░ рдлрд┐рд░ рд╕рд░реНрд╡рд░ рдФрд░ рдХреНрд▓рд╛рдЗрдВрдЯ рд╕рддреНрд░ рдХреЗ рдЕрдВрджрд░ рд╕рднреА рдСрдмреНрдЬреЗрдХреНрдЯреНрд╕ рдкрд░ рд▓рд╛рдЧреВ рдХрд┐рдпрд╛ред <br><br><ul><li>  variti :: рдЪрдВрдХ </li><li>  variti :: streambuf </li><li>  variti :: server_session </li><li>  variti :: client_session </li></ul><br>  рдЙрд╕реА рд╕рдордп, рдЕрддрд┐рд░рд┐рдХреНрдд рд╕рдорд╕реНрдпрд╛рдУрдВ рдХреЛ рд╣рд▓ рдХрд░рдирд╛ рдЖрд╡рд╢реНрдпрдХ рдерд╛, рдЕрд░реНрдерд╛рддреН: рд╕рд░рд▓ рд╡рд╕реНрддреБрдУрдВ, рд╕рдордЧреНрд░ рд╡рд╕реНрддреБрдУрдВ рдФрд░ рд╕рдВрдЧреНрд░рд╣ рдХреЛ рд╕реНрд▓реИрдм рдЖрд╡рдВрдЯрдирдХрд░реНрддрд╛рдУрдВ рдореЗрдВ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд░рдирд╛ред  рдФрд░ рдЕрдЧрд░ рд╡рд╕реНрддреБрдУрдВ рдХреЗ рдкрд╣рд▓реЗ рджреЛ рд╡рд░реНрдЧреЛрдВ рдХреЗ рд╕рд╛рде рдХреЛрдИ рдЧрдВрднреАрд░ рдХрдард┐рдирд╛рдЗрдпрд╛рдБ рдирд╣реАрдВ рдереАрдВ (рд╕рдордЧреНрд░ рд╡рд╕реНрддреБрдУрдВ рдХреЛ рд╕рд░рд▓ рд▓реЛрдЧреЛрдВ рдХреЗ рд▓рд┐рдП рдХрдо рдХрд░ рджрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ), рддреЛ рд╕рдВрдЧреНрд░рд╣ рдХрд╛ рдЕрдиреБрд╡рд╛рдж рдХрд░рддреЗ рд╕рдордп рд╣рдо рдЧрдВрднреАрд░ рдХрдард┐рдирд╛рдЗрдпреЛрдВ рдореЗрдВ рднрд╛рдЧ рдЧрдПред <br><br><ul><li>  рдПрд╕рдЯреАрдбреА :: рд╕реВрдЪреА </li><li>  std :: deque </li><li>  рдПрд╕рдЯреАрдбреА :: рд╡реЗрдХреНрдЯрд░ </li><li>  рдПрд╕рдЯреАрдбреА :: рд╕реНрдЯреНрд░рд┐рдВрдЧ </li><li>  рдПрд╕рдЯреАрдбреА :: рдирдХреНрд╢рд╛ </li><li>  std :: unordered_map </li></ul><br>  рд╕реНрд▓реИрдм рд╡рд┐рддрд░рдг рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рддреЗ рд╕рдордп рдореБрдЦреНрдп рд╕реАрдорд╛рдУрдВ рдореЗрдВ рд╕реЗ рдПрдХ рдпрд╣ рд╣реИ рдХрд┐ рд╡рд┐рднрд┐рдиреНрди рдкреНрд░рдХрд╛рд░реЛрдВ рдХреА рд╡рд╕реНрддреБрдУрдВ рдХреА рд╕рдВрдЦреНрдпрд╛ рдмрд╣реБрдд рдмрдбрд╝реА рдирд╣реАрдВ рд╣реЛрдиреА рдЪрд╛рд╣рд┐рдП (рдпрд╣ рдЬрд┐рддрдирд╛ рдЫреЛрдЯрд╛ рд╣реЛрддрд╛ рд╣реИ, рдЙрддрдирд╛ рдмреЗрд╣рддрд░)ред  рдЗрд╕ рд╕рдВрджрд░реНрдн рдореЗрдВ, рдХреБрдЫ рд╕рдВрдЧреНрд░рд╣ рд╕реНрд▓реИрдм рдЖрд╡рдВрдЯрдирдХрд░реНрддрд╛рдУрдВ рдХреА рдЕрд╡рдзрд╛рд░рдгрд╛ рдкрд░ рдЕрдЪреНрдЫреА рддрд░рд╣ рд╕реЗ рдЧрд┐рд░ рд╕рдХрддреЗ рд╣реИрдВ, рдЬрдмрдХрд┐ рдХреБрдЫ рдирд╣реАрдВ рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВред <br><br>  рдПрд╕рдЯреАрдбреА :: рд╕реВрдЪреА рд╕реНрд▓реИрдм рдХреЗ рд▓рд┐рдП, рдЖрд╡рдВрдЯрдирдХрд░реНрддрд╛ рдорд╣рд╛рди рдХрд╛рдо рдХрд░рддреЗ рд╣реИрдВред  рдпрд╣ рд╕рдВрдЧреНрд░рд╣ рдПрдХ рд▓рд┐рдВрдХ рдХреА рдЧрдИ рд╕реВрдЪреА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЖрдВрддрд░рд┐рдХ рд░реВрдк рд╕реЗ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬрд┐рд╕рдХреЗ рдкреНрд░рддреНрдпреЗрдХ рддрддреНрд╡ рдХрд╛ рдПрдХ рдирд┐рд╢реНрдЪрд┐рдд рдЖрдХрд╛рд░ рд╣реЛрддрд╛ рд╣реИред  рдЗрд╕ рдкреНрд░рдХрд╛рд░, std рдореЗрдВ рдирдП рдбреЗрдЯрд╛ рдХреЗ рд╕рд╛рде :: рд╕реНрд▓реИрдм рд╡рд┐рддрд░рдг рдореЗрдВ рд╕реВрдЪреА, рдирдИ рдкреНрд░рдХрд╛рд░ рдХреА рд╡рд╕реНрддреБрдПрдВ рдирд╣реАрдВ рджрд┐рдЦрд╛рдИ рджреЗрддреА рд╣реИрдВред  рдКрдкрд░ рдмрддрд╛рдИ рдЧрдИ рд╢рд░реНрдд рд╕рдВрддреБрд╖реНрдЯ рд╣реИ!  рдПрд╕рдЯреАрдбреА :: рдорд╛рдирдЪрд┐рддреНрд░ рд╕рдорд╛рди рд░реВрдк рд╕реЗ рд╡реНрдпрд╡рд╕реНрдерд┐рдд рд╣реИред  рдЕрдВрддрд░ рдХреЗрд╡рд▓ рдЗрддрдирд╛ рд╣реИ рдХрд┐ рдЗрд╕рдХреЗ рдЕрдВрджрд░ рдПрдХ рд▓рд┐рдВрдХ рдХреА рдЧрдИ рд╕реВрдЪреА рдирд╣реАрдВ рд╣реИ, рдмрд▓реНрдХрд┐ рдПрдХ рдкреЗрдбрд╝ рд╣реИред <br><br>  Std :: deque рдХреЗ рдорд╛рдорд▓реЗ рдореЗрдВ, рдЪреАрдЬреЗрдВ рдЕрдзрд┐рдХ рдЬрдЯрд┐рд▓ рд╣реИрдВред  рдпрд╣ рд╕рдВрдЧреНрд░рд╣ рдореЗрдореЛрд░реА рдХреЗ рдПрдХ рд╕рдиреНрдирд┐рд╣рд┐рдд рдмреНрд▓реЙрдХ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдЬрд┐рд╕рдореЗрдВ рдЪреЛрдВрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреЙрдЗрдВрдЯрд░реНрд╕ рд╣реЛрддреЗ рд╣реИрдВред  рдЬрдмрдХрд┐ рдЪрдВрдХреНрд╕ рдмрд╣реБрдд рд╕рдЯреАрдХ рд╣реИрдВ, std :: deque std :: list рдХреЗ рд╕рдорд╛рди рд╡реНрдпрд╡рд╣рд╛рд░ рдХрд░рддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдЬрдм рд╡реЗ рд╕рдорд╛рдкреНрдд рд╣реЛрддреЗ рд╣реИрдВ, рддреЛ рд╕реНрдореГрддрд┐ рдХрд╛ рдпрд╣ рдПрдХ рд╣реА рдмреНрд▓реЙрдХ рдкреБрдирд░реНрд╡рд┐рддрд░рд┐рдд рд╣реЛрддрд╛ рд╣реИред  рд╕реНрд▓реИрдм рдЖрдмрдВрдЯрдХреЛрдВ рдХреЗ рджреГрд╖реНрдЯрд┐рдХреЛрдг рд╕реЗ, рдкреНрд░рддреНрдпреЗрдХ рдореЗрдореЛрд░реА рдкреБрдирд░реНрд╡рд┐рддрд░рдг рдПрдХ рдирдП рдкреНрд░рдХрд╛рд░ рдХреЗ рд╕рд╛рде рдПрдХ рд╡рд╕реНрддреБ рд╣реИред  рд╕рдВрдЧреНрд░рд╣ рдореЗрдВ рдЬреЛрдбрд╝реА рдЧрдИ рд╡рд╕реНрддреБрдУрдВ рдХреА рд╕рдВрдЦреНрдпрд╛ рд╕реАрдзреЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдкрд░ рдирд┐рд░реНрднрд░ рдХрд░рддреА рд╣реИ рдФрд░ рдЕрдирд┐рдпрдВрддреНрд░рд┐рдд рд░реВрдк рд╕реЗ рдмрдврд╝ рд╕рдХрддреА рд╣реИред  рдпрд╣ рд╕реНрдерд┐рддрд┐ рд╕реНрд╡реАрдХрд╛рд░реНрдп рдирд╣реАрдВ рд╣реИ, рдЗрд╕рд▓рд┐рдП рд╣рдо рдпрд╛ рддреЛ std :: deque рдХрд╛ рдЖрдХрд╛рд░ рд╕реАрдорд┐рдд рдХрд░рддреЗ рд╣реИрдВ рдЬрд╣рд╛рдБ рдпрд╣ рд╕рдВрднрд╡ рдерд╛, рдпрд╛ рдкрд╕рдВрджреАрджрд╛ std :: рд╕реВрдЪреАред <br><br>  рдЕрдЧрд░ рд╣рдо std :: рд╡реЗрдХреНрдЯрд░ рдФрд░ std :: string рд▓реЗрддреЗ рд╣реИрдВ, рддреЛ рд╡реЗ рдЕрднреА рднреА рдЕрдзрд┐рдХ рдЬрдЯрд┐рд▓ рд╣реИрдВред  рдЗрди рд╕рдВрдЧреНрд░рд╣реЛрдВ рдХрд╛ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рдХреБрдЫ рд╣рдж рддрдХ std :: deque рдХреЗ рд╕рдорд╛рди рд╣реИ, рд╕рд┐рд╡рд╛рдп рдЗрд╕рдХреЗ рдХрд┐ рдЙрдирдХрд╛ рдирд┐рд░рдВрддрд░ рдореЗрдореЛрд░реА рдмреНрд▓реЙрдХ рдХрд╛рдлреА рддреЗрдЬреА рд╕реЗ рдмрдврд╝рддрд╛ рд╣реИред  рд╣рдордиреЗ std :: рд╡реЗрдХреНрдЯрд░ рдФрд░ std :: std рдХреЗ рд╕рд╛рде рд╕реНрдЯреНрд░рд┐рдВрдЧ :: deque, рдФрд░ std :: рд╕реВрдЪреА рдХреЗ рд╕рд╛рде рд╕рдмрд╕реЗ рдЦрд░рд╛рдм рд╕реНрдерд┐рддрд┐ рдореЗрдВ рдкреНрд░рддрд┐рд╕реНрдерд╛рдкрд┐рдд рдХрд┐рдпрд╛ред  рд╣рд╛рдВ, рд╣рдо рдХрд╛рд░реНрдпрдХреНрд╖рдорддрд╛ рдореЗрдВ рдЦреЛ рдЧрдП рдФрд░ рдХрд╣реАрдВ рди рдХрд╣реАрдВ рдкреНрд░рджрд░реНрд╢рди рдореЗрдВ рднреА, рд▓реЗрдХрд┐рди рдЗрд╕рдиреЗ рдЕрдВрддрд┐рдо рддрд╕реНрд╡реАрд░ рдХреЛ рдЙрди рдЕрдиреБрдХреВрд▓рди рд╕реЗ рдмрд╣реБрдд рдХрдо рдкреНрд░рднрд╛рд╡рд┐рдд рдХрд┐рдпрд╛ рдЬрд┐рдирдХреЗ рд▓рд┐рдП рд╕рдм рдХреБрдЫ рдХрд▓реНрдкрдирд╛ рдХреА рдЧрдИ рдереАред <br><br>  рд╣рдордиреЗ std :: unordered_map рдХреЗ рд╕рд╛рде рдареАрдХ рд╡реИрд╕рд╛ рд╣реА рдХрд┐рдпрд╛, рд╕реНрд╡-рд▓рд┐рдЦрд┐рдд рд╡реИрд░рд╛рдЗрдЯреА рдХреЗ рдкрдХреНрд╖ рдореЗрдВ рдЗрд╕реЗ рдЫреЛрдбрд╝рддреЗ рд╣реБрдП :: flat_map рдХреЛ std :: deque рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд▓рд╛рдЧреВ рдХрд┐рдпрд╛ рдЧрдпрд╛ред  рдЙрд╕реА рд╕рдордп, рд╣рдордиреЗ рдмрд╕ рдЕрд▓рдЧ-рдЕрд▓рдЧ рдЪрд░ рдореЗрдВ рдЕрдХреНрд╕рд░ рдЙрдкрдпреЛрдЧ рдХреА рдЬрд╛рдиреЗ рд╡рд╛рд▓реА рдХреБрдВрдЬрд┐рдпреЛрдВ рдХреЛ рдХреИрд╢ рдХрд┐рдпрд╛, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдЬреИрд╕рд╛ рдХрд┐ nginx рдореЗрдВ http рдЕрдиреБрд░реЛрдз рд╣реЗрдбрд░ рдХреЗ рд╕рд╛рде рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред <br><br><h3>  рдирд┐рд╖реНрдХрд░реНрд╖ </h3><br>  рд╕реНрд▓реИрдм рдЖрд╡рдВрдЯрди рдХреЗ рд▓рд┐рдП рд╕рд░реНрд╡рд░ рдФрд░ рдХреНрд▓рд╛рдЗрдВрдЯ рд╕рддреНрд░реЛрдВ рдХрд╛ рдкреВрд░рд╛ рд╣рд╕реНрддрд╛рдВрддрд░рдг рд╕рдорд╛рдкреНрдд рд╣реЛрдиреЗ рдХреЗ рдмрд╛рдж, рд╣рдордиреЗ рдПрдХ рдЧреБрдЪреНрдЫрд╛ рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рдиреЗ рдореЗрдВ рд▓рдЧрдиреЗ рд╡рд╛рд▓реЗ рд╕рдордп рдХреЛ рдбреЗрдврд╝ рдЧреБрдирд╛ рд╕реЗ рдХрдо рдХрд░ рджрд┐рдпрд╛ред <br><br>  рдПрдореНрдкрд▓реАрдлрд╛рдпрд░ (рдХреЛрд▓рдбрд╕реНрд▓реИрдм) рдХрд╛ рд╕реНрдХреНрд░реАрдирд╢реЙрдЯ: <br><br><img src="https://habrastorage.org/webt/ls/yx/l_/lsyxl_b6xngl5xap-t5erwn4now.png"><br><br>  рд╕реНрдХреНрд░реАрдирд╢реЙрдЯ рдореЗрдВ, рдСрдкрд░реЗрдЯрд░ рдирдП рдиреЗ 32 рд╕реЗрдХрдВрдб рдХрд╛рдо рдХрд┐рдпрд╛ рдФрд░ рдСрдкрд░реЗрдЯрд░ рдиреЗ 24 рд╕реЗрдХрдВрдб рд╣рдЯрд╛ рджрд┐рдПред  рдЗрд╕ рд╕рдордп рддрдХ, рдвреЗрд░ рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЕрдиреНрдп рдХрд╛рд░реНрдп рдЬреЛрдбрд╝реЗ рдЧрдП рдереЗ: рд╕реНрдореЙрд▓реЛрдХ - 21 рд╕реЗрдХрдВрдб, mslab_alloc - 37 рд╕реЗрдХрдВрдб, smfree - 8 рд╕реЗрдХрдВрдб, mslab_free - 21 рд╕реЗрдХрдВрдбред  рдХреБрд▓, 143 рд╕реЗрдХрдВрдб рдмрдирд╛рдо 161 рд╕реЗрдХрдВрдбред <br><br>  рд▓реЗрдХрд┐рди рд╕реНрд▓реИрдм рд╡рд┐рддрд░рдг рдореЗрдВ рдХреИрд╢ рдХреЛ рд╢реБрд░реВ рдХрд┐рдП рдмрд┐рдирд╛ рд╕реЗрд╡рд╛ рд╢реБрд░реВ рдХрд░рдиреЗ рдХреЗ рддреБрд░рдВрдд рдмрд╛рдж рдпреЗ рдорд╛рдк рдХрд┐рдП рдЧрдП рдереЗред  рдПрдХ рдпреИрдВрдбреЗрдХреНрд╕-рдЯреИрдВрдХ рд╕реЗ рдмрд╛рд░-рдмрд╛рд░ рдЧреЛрд▓реАрдмрд╛рд░реА рдХреЗ рдмрд╛рдж, рд╕рдордЧреНрд░ рддрд╕реНрд╡реАрд░ рдореЗрдВ рд╕реБрдзрд╛рд░ рд╣реБрдЖред <br><br>  рдПрдореНрдкрд▓реАрдлрд╛рдпрд░ рдХрд╛ рд╕реНрдХреНрд░реАрдирд╢реЙрдЯ (hotslab): <br><br><img src="https://habrastorage.org/webt/gc/zj/kt/gczjkt5r8yedhniu5afswdjqk2y.png"><br><br>  рд╕реНрдХреНрд░реАрдирд╢реЙрдЯ рдореЗрдВ, рдСрдкрд░реЗрдЯрд░ рдирдП рдиреЗ 20 рд╕реЗрдХрдВрдб, рд╕реНрдореЙрд▓реЛрдХ - 16 рд╕реЗрдХрдВрдб, mslab_alloc - 27 рд╕реЗрдХрдВрдб, рдСрдкрд░реЗрдЯрд░ рдбрд┐рд▓реАрдЯ - 16 рд╕реЗрдХрдВрдб, smfree - 7 рд╕реЗрдХрдВрдб, mslab_free - 17 рд╕реЗрдХрдВрдб рдХрд╛рдо рдХрд┐рдпрд╛ред  161 рд╕реЗрдХрдВрдб рдХреЗ рдореБрдХрд╛рдмрд▓реЗ рдХреБрд▓ 103 рд╕реЗрдХрдВрдбред <br><br>  рдорд╛рдк рддрд╛рд▓рд┐рдХрд╛: <br><br><pre> <code class="plaintext hljs"> woslab coldslab hotslab operator new 67s 32s 20s smalloc - 21s 16s mslab_alloc - 37s 27s operator delete 94s 24s 16s smfree - 8s 7s mslab_free - 21s 17s summary 161s 143s 103s</code> </pre><br>  рд╡рд╛рд╕реНрддрд╡рд┐рдХ рдЬреАрд╡рди рдореЗрдВ, рдкрд░рд┐рдгрд╛рдо рдФрд░ рднреА рдмреЗрд╣рддрд░ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП, рдХреНрдпреЛрдВрдХрд┐ рд╕реНрд▓реИрдм рдЖрд╡рдВрдЯрдирдХрд░реНрддрд╛ рди рдХреЗрд╡рд▓ рд▓рдВрдмреА рдореЗрдореЛрд░реА рдЖрд╡рдВрдЯрди рдФрд░ рдореБрдХреНрдд рд╣реЛрдиреЗ рдХреА рд╕рдорд╕реНрдпрд╛ рдХреЛ рд╣рд▓ рдХрд░рддреЗ рд╣реИрдВ, рдмрд▓реНрдХрд┐ рд╡рд┐рдЦрдВрдбрди рдХреЛ рднреА рдХрдо рдХрд░рддреЗ рд╣реИрдВред  рд╕реНрд▓реИрдм рдХреЗ рдмрд┐рдирд╛, рд╕рдордп рдХреЗ рд╕рд╛рде, рдСрдкрд░реЗрдЯрд░ рдирдП рдФрд░ рдСрдкрд░реЗрдЯрд░ рд╣рдЯрд╛рдиреЗ рдХрд╛ рд╕рдВрдЪрд╛рд▓рди рдХреЗрд╡рд▓ рдзреАрдорд╛ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдПред  рд╕реНрд▓реИрдм рдХреЗ рд╕рд╛рде - рдпрд╣ рд╣рдореЗрд╢рд╛ рдПрдХ рд╣реА рд╕реНрддрд░ рдкрд░ рд░рд╣реЗрдЧрд╛ред <br><br>  рдЬреИрд╕рд╛ рдХрд┐ рд╣рдо рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ, рд╕реНрд▓реИрдм рдЖрд╡рдВрдЯрди рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рдЙрдкрдпреЛрдЧ рдХреА рдЬрд╛рдиреЗ рд╡рд╛рд▓реА рд╡рд╕реНрддреБрдУрдВ рдХреА рдореЗрдореЛрд░реА рдЖрд╡рдВрдЯрди рд╕рдорд╕реНрдпрд╛ рдХреЛ рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рд╣рд▓ рдХрд░рддреЗ рд╣реИрдВред  рдЙрди рдкрд░ рдзреНрдпрд╛рди рджреЗрдВ рдпрджрд┐ рд▓рдЧрд╛рддрд╛рд░ рдирд┐рд░реНрдорд╛рдг рдФрд░ рд╡рд╕реНрддреБрдУрдВ рдХреЛ рд╣рдЯрд╛рдиреЗ рдХрд╛ рдореБрджреНрджрд╛ рдЖрдкрдХреЗ рд▓рд┐рдП рдкреНрд░рд╛рд╕рдВрдЧрд┐рдХ рд╣реИред  рд▓реЗрдХрд┐рди рдЙрди рд╕реАрдорд╛рдУрдВ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдордд рднреВрд▓реЛ рдЬреЛ рд╡реЗ рдЖрдкрдХреЗ рдЖрд╡реЗрджрди рдХреА рд╡рд╛рд╕реНрддреБрдХрд▓рд╛ рдкрд░ рд▓рдЧрд╛рддреЗ рд╣реИрдВ!  рд╕рднреА рдЬрдЯрд┐рд▓ рд╡рд╕реНрддреБрдУрдВ рдХреЛ рдмрд╕ рд╕реНрд▓реИрдм рд╡рд┐рддрд░рдг рдореЗрдВ рдирд╣реАрдВ рд░рдЦрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред  рдХрднреА-рдХрднреА рдЖрдкрдХреЛ рдмрд╣реБрдд рдХреБрдЫ рдЫреЛрдбрд╝рдирд╛ рдкрдбрд╝рддрд╛ рд╣реИ!  рдареАрдХ рд╣реИ, рдЖрдкрдХреЗ рдЖрд╡реЗрджрди рдХреА рд╡рд╛рд╕реНрддреБрдХрд▓рд╛ рдЬрд┐рддрдиреА рдЬрдЯрд┐рд▓ рд╣реИ, рдЙрддрдиреА рдмрд╛рд░ рдЖрдкрдХреЛ рдорд▓реНрдЯреАрдереНрд░реЗрдбрд┐рдВрдЧ рдХреЗ рд╕рдВрджрд░реНрдн рдореЗрдВ рдСрдмреНрдЬреЗрдХреНрдЯ рдХреЛ рд╕рд╣реА рдХреИрд╢ рдкрд░ рд▓реМрдЯрдиреЗ рдХрд╛ рдзреНрдпрд╛рди рд░рдЦрдирд╛ рд╣реЛрдЧрд╛ред  рдпрд╣ рд╕рд░рд▓ рд╣реЛ рд╕рдХрддрд╛ рд╣реИ рдЬрдм рдЖрдкрдиреЗ рддреБрд░рдВрдд рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░ рдкрд░ рдХрд╛рдо рдХрд┐рдпрд╛ рдерд╛, рд╕реНрд▓реИрдм рдЖрд╡рдВрдЯрдирдХрд░реНрддрд╛рдУрдВ рдХреЗ рдЙрдкрдпреЛрдЧ рдХреЛ рдзреНрдпрд╛рди рдореЗрдВ рд░рдЦрддреЗ рд╣реБрдП, рд▓реЗрдХрд┐рди рдпрд╣ рдирд┐рд╢реНрдЪрд┐рдд рд░реВрдк рд╕реЗ рдХрдард┐рдирд╛рдЗрдпреЛрдВ рдХрд╛ рдХрд╛рд░рдг рд╣реЛрдЧрд╛ рдЬрдм рдЖрдк рдЙрдиреНрд╣реЗрдВ рджреЗрд░ рд╕реЗ рдордВрдЪ рдкрд░ рдПрдХреАрдХреГрдд рдХрд░рдиреЗ рдХрд╛ рдирд┐рд░реНрдгрдп рд▓реЗрддреЗ рд╣реИрдВред <br><br><h3>  рдЖрд╡реЗрджрди </h3><br>  <a href="https://github.com/sonntex/slab-allocator" rel="nofollow">рдпрд╣рд╛рдБ</a> рд╕реНрд░реЛрдд рдХреЛрдб рдХреА рдЬрд╛рдБрдЪ <a href="https://github.com/sonntex/slab-allocator" rel="nofollow">рдХрд░реЗрдВ</a> ! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/hi477404/">https://habr.com/ru/post/hi477404/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../hi477390/index.html">рдбрд┐рдмрдЧрд┐рдВрдЧ рдиреЗрдЯрд╡рд░реНрдХ рдХреБрдмреЗрд░рдиреЗрдЯреНрд╕ рдореЗрдВ рджреЗрд░реА рдХрд░рддрд╛ рд╣реИ</a></li>
<li><a href="../hi477392/index.html">рдУрдкрди рдорд╛рдЗрдХреНрд░реЛрдлреЛрди: рдмреИрдХрдПрдВрдбред рд╣рдо рд╡рдХреНрддрд╛рдУрдВ рдХреЛ рдЖрдордВрддреНрд░рд┐рдд рдХрд░рддреЗ рд╣реИрдВ</a></li>
<li><a href="../hi477396/index.html">рдПрдХ рдХреЛрд░реНрд╕ рдореЗрдВ рдирд╛рдорд╛рдВрдХрди рдХреИрд╕реЗ рдХрд░реЗрдВ рдФрд░ ... рдЕрдВрдд рдореЗрдВ рдЬрд╛рдПрдВ</a></li>
<li><a href="../hi477400/index.html">рдЙрддреНрдкрд╛рдж рдкреНрд░рдмрдВрдзрдХ рдХреЗ рдкреЗрд╢реЗ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ: рдЖрджрд░реНрд╢ рдХреИрд╕реЗ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ?</a></li>
<li><a href="../hi477402/index.html">рдкрд╛рдпрд╕ рд╡реЗрдм рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЗ рд░реВрдк рдореЗрдВ рдХреЗрд░рд╕ рдбреАрдк рд▓рд░реНрдирд┐рдВрдЧ рдореЙрдбрд▓ рдХреА рддреИрдирд╛рддреА</a></li>
<li><a href="../hi477406/index.html">рддрдХрдиреАрдХреА рд╕рд╣рд╛рдпрддрд╛ рдФрд░ рд╕рдорд░реНрдердиред рдиреМрдХрд░реА рдмрд╛рдЬрд╛рд░ рдФрд░ рд╡реЗрддрди рдкрд░ рдорд╣рд╛рди рд╢реЛрдзред 2 рд╡рд░реНрд╖реЛрдВ рдореЗрдВ рдХреНрдпрд╛ рдмрджрд▓ рдЧрдпрд╛ рд╣реИ?</a></li>
<li><a href="../hi477408/index.html">JavaFX рдЯреНрдпреВрдЯреЛрд░рд┐рдпрд▓: рдЙрдиреНрдирдд рд▓реЗрдЖрдЙрдЯ</a></li>
<li><a href="../hi477414/index.html">рдбреЗрдЯрд╛ рдЗрдВрдЬреАрдирд┐рдпрд░ - 21 рд╡реАрдВ рд╕рджреА рдХрд╛ рд╕рдмрд╕реЗ рд╕реЗрдХреНрд╕реА рдкреЗрд╢рд╛</a></li>
<li><a href="../hi477416/index.html">рдЬрдм рдпрд╣ рд╣реИрд╢ рдХреЗ рд▓рд┐рдП рд╣рд╛рдирд┐рдХрд╛рд░рдХ рд╣реИ</a></li>
<li><a href="../hi477418/index.html">рддреАрди рдЪрд░рдгреЛрдВ рдореЗрдВ рддреАрди рддрд░рдлрд╛ рдЕрдкрд╡рд░реНрддрди</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>