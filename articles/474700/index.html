<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>   Cloud Smart Home. Parte 2: Servicio en la nube   锔</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Contin煤o la serie de tres art铆culos sobre el hogar inteligente en la nube. 

 En un art铆culo anterior , se consideraron equipos para detectar un hogar...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Cloud Smart Home. Parte 2: Servicio en la nube</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/474700/"><img src="https://habrastorage.org/webt/iq/e3/kt/iqe3kte_k_di5dqmevpvprwojee.jpeg" alt="imagen"><br><br>  Contin煤o la serie de tres art铆culos sobre el hogar inteligente en la nube. <br><br>  En un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">art铆culo anterior</a> , se consideraron equipos para detectar un hogar inteligente, as铆 como algoritmos para convertir datos sensoriales en comandos de control para dispositivos ejecutivos.  El componente principal de una casa inteligente es un controlador, que la mayor铆a de las veces funciona de forma aut贸noma de acuerdo con la l贸gica establecida en la etapa de configuraci贸n.  Varios dispositivos (c谩maras IP, sensores, actuadores) est谩n conectados al controlador, que env铆a los datos recibidos de estos dispositivos a la nube. <br><br>  Ahora hablemos de la arquitectura de un servicio en la nube para almacenar y procesar informaci贸n de sensores y c谩maras. <br><a name="habracut"></a><br><h2>  Beneficios del servicio en la nube </h2><br>  Un servicio en la nube para el hogar inteligente ofrece una forma simple, flexible y econ贸mica de almacenar y acceder a los datos recibidos de los dispositivos dom茅sticos inteligentes.  El usuario del servicio en la nube no necesita preocuparse por la seguridad de sus datos.  Las capacidades de un servidor de medios multiprocesador, equipado con una canasta de discos con una matriz RAID de varias unidades de 10-12 TB, superan con creces la capacidad de una tarjeta SD o Flash dentro de un controlador dom茅stico inteligente.  Adem谩s, las tarjetas de memoria no son confiables porque tienen un n煤mero limitado de ciclos de reescritura y a menudo fallan.  La profundidad del almacenamiento de datos en la nube est谩 determinada por la tarifa del usuario y se configura f谩cilmente en su cuenta personal. <br><br>  Adem谩s, para acceder a los datos no hay necesidad de "reenv铆o de puertos" en el enrutador del usuario cuando el protocolo NAT oculta los dispositivos dom茅sticos inteligentes de las redes externas.  En su cuenta personal, accesible desde dispositivos m贸viles, puede configurar f谩cilmente la configuraci贸n y la l贸gica del hogar inteligente. <br><br>  Es conveniente no solo almacenar datos en la nube, sino tambi茅n procesarlos, proporcionando al usuario estad铆sticas para varios per铆odos de tiempo.  A continuaci贸n, consideraremos un ejemplo de c谩lculo de la temperatura ambiente promedio por semana basada en mediciones multisensor. <br><br><h2>  Arquitectura de servicio en la nube </h2><br>  En un art铆culo anterior, hablamos sobre un controlador dom茅stico inteligente que est谩 instalado en el lado del usuario e interact煤a con un servicio en la nube utilizando varios protocolos: <br><br><ul><li>  MQTT se usa para intercambiar mensajes JSON entre el controlador y el servidor de l贸gica de negocios; </li><li>  HTTP para obtener la direcci贸n IP del servidor de medios menos cargado del equilibrador de carga del cl煤ster de servidores de medios; </li><li>  RTMP para transferir la secuencia H.264 + AAC al servidor de medios. </li></ul><br>  Ahora consideraremos el servicio en la nube de un hogar inteligente: los componentes principales en los que consiste y c贸mo se produce la interacci贸n con el controlador del hogar inteligente. <br><br> <a href=""><img src="https://habrastorage.org/webt/os/bd/xi/osbdxiktvu-cla3sizuxjoaxbfu.png"></a> <br>  <font color="grey">(haga clic en la imagen para abrir en una resoluci贸n m谩s alta)</font> <br><br>  <b>El servidor de l贸gica de negocios</b> es un elemento clave en todo el esquema de intercambio de informaci贸n dentro del servicio en la nube.  Su objetivo principal es administrar varios subsistemas de servidor a trav茅s de las interfaces RESTful API.  Implementa la l贸gica del servicio en la nube en funci贸n <b>del modelo del usuario</b> : grabar un archivo de video y mediciones del sensor seg煤n la tarifa seleccionada, la interacci贸n entre el usuario y el controlador del hogar inteligente, etc. <br><br>  <b>El intermediario MQTT es</b> necesario para intercambiar mensajes JSON entre controladores dom茅sticos inteligentes instalados en el lado del cliente y el servidor de l贸gica de negocios.  Los clientes se suscriben a temas dentro del agente que sirven como canales de mensajes.  Como corredor de MQTT, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">se utiliza Eclipse Mosquitto</a> . <br><br>  <b>Un cl煤ster de servidores de medios</b> es un sistema distribuido para almacenar, procesar, buscar y reproducir informaci贸n de video para c谩maras IP de un hogar inteligente nublado.  Un equilibrador de carga especial recopila informaci贸n sobre el rendimiento actual de cada servidor en el cl煤ster, calcula el menos cargado e informa su direcci贸n IP al controlador dom茅stico inteligente, que transfiere el video de las c谩maras al mismo. <br><br>  <b>Se</b> necesita <b>una base de datos en la nube</b> para almacenar el modelo de usuario del servicio en la nube, la configuraci贸n y el estado actual de su equipo, as铆 como la metainformaci贸n sobre las entradas del archivo de video.  Como implementaci贸n de la base de datos en la nube, se utiliza MySQL DBMS. <br><br>  <b>Touch Database</b> es una base de datos NoSQL no relacional.  Almacena eventos y mediciones de sensores dom茅sticos inteligentes, ordenados por tiempo.  El uso de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">InfluxDB</a> DBMS, optimizado para trabajar con este tipo de datos, mejora significativamente el rendimiento del servicio en la nube. <br><br>  <b>El backend de la aplicaci贸n cliente</b> es una aplicaci贸n de servidor cuya funci贸n principal es proporcionar los datos recibidos de la nube y las bases de datos t谩ctiles en un formato conveniente para su posterior visualizaci贸n por la aplicaci贸n cliente en el dispositivo del usuario.  El backend tambi茅n genera comandos de control en formato JSON para el controlador dom茅stico inteligente.  El backend est谩 basado en el framework PHP <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Laravel</a> .  Se discutir谩 con m谩s detalle en el pr贸ximo art铆culo sobre una aplicaci贸n cliente para interactuar con un hogar inteligente en la nube. <br><br>  <b>El proveedor de notificaciones push</b> entrega mensajes sobre los eventos de la casa inteligente al dispositivo m贸vil del usuario para que pueda intervenir r谩pidamente en la situaci贸n (por ejemplo, cuando aparece una fuga de agua o humo, llame a los servicios de respuesta apropiados).  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">El</a> servicio <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">OneSignal</a> fue elegido como el proveedor de notificaciones Push, que tiene una interfaz API RESTful conveniente y la funci贸n de identificaci贸n de dispositivos m贸viles, que es necesaria para el correcto funcionamiento de las notificaciones dentro de la cuenta personal del usuario. <br><br><h2>  Servidor de l贸gica de negocios </h2><br>  Como se mencion贸 anteriormente, el servidor de l贸gica de negocios es un componente clave del hogar inteligente en la nube.  Basado en <b>el modelo de usuario</b> (descripci贸n informativa del usuario del sistema, que incluye caracter铆sticas del sistema, personales, financieras y l贸gicas), administra una variedad de servicios dentro de la nube que tienen diferentes implementaciones y funcionalidades y se comunican entre s铆 a trav茅s de interfaces API RESTful. <br><br><img src="https://habrastorage.org/webt/m0/vl/vj/m0vlvjztjnmvtrckqgvefi2ht80.png"><br><br>  El m贸dulo de l贸gica de negocios dentro del servidor es responsable de las siguientes operaciones: <br><br><ol><li>  gestionar el almacenamiento de mediciones de sensores y eventos de detectores de movimiento de c谩maras IP de una casa inteligente dentro de una base de datos t谩ctil; </li><li>  gestionar la grabaci贸n de la transmisi贸n de medios de la c谩mara IP transmitida por el controlador dom茅stico inteligente en el archivo del servidor de medios (constante / por detector de movimiento); </li><li>  traducci贸n de comandos desde la aplicaci贸n del cliente al controlador del hogar inteligente; </li><li>  difundir la configuraci贸n del controlador dom茅stico inteligente (dispositivos conectados, reglas de l贸gica de producci贸n definidas por el usuario); </li><li>  enviando notificaciones push sobre el estado del controlador dom茅stico inteligente y los dispositivos conectados a la aplicaci贸n cliente. </li></ol><br>  Una caracter铆stica del servidor de l贸gica de negocios es la comunicaci贸n entre procesos con aplicaciones remotas que se ejecutan en varios servidores en Internet.  La mayor铆a de las veces, la aplicaci贸n del servidor de l贸gica de negocios est谩 inactiva en bloqueos de E / S, por lo que est谩 dise帽ada en base a una arquitectura de subprocesos m煤ltiples y consta de un conjunto de subtareas finitas. <br><br>  Para garantizar la m谩xima eficiencia, la implementaci贸n interna del servidor de l贸gica de negocios deber铆a ser la m谩s simple ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">principio KISS</a> ).  Dado que el modelo de usuario es completamente determinista y no contiene relaciones cambiantes entre las caracter铆sticas, no hay necesidad de un mecanismo de inferencia flexible (como en un controlador dom茅stico inteligente, donde el usuario configura la l贸gica del usuario).  Por lo tanto, la operaci贸n del m贸dulo de l贸gica de negocios dentro del servidor puede describirse mediante un diagrama de bloques algor铆tmico convencional con transiciones condicionales. <br><br> <a href=""><img src="https://habrastorage.org/webt/fh/xf/70/fhxf703hqjqjjhzg9i_uuxv2qqo.png"></a> <br>  <font color="grey">(haga clic en la imagen para abrir en una resoluci贸n m谩s alta)</font> <br><br>  Inmediatamente despu茅s de iniciarse, el servidor de l贸gica de negocios pasa al estado de espera para recibir mensajes utilizando los protocolos MQTT (de los controladores dom茅sticos inteligentes) y HTTP (desde el back-end de la aplicaci贸n cliente).  En caso de que el mensaje llegue a trav茅s de HTTP, esto significa que el usuario interact煤a con la aplicaci贸n cliente y env铆a comandos al controlador dom茅stico inteligente o actualiza su configuraci贸n.  Para que el mensaje del cliente caiga en el controlador de inicio inteligente, el servidor de l贸gica de negocios lo transmite al tema correspondiente del agente MQTT, al que est谩 suscrito el controlador ( <b>subtarea SendGatewayMessage</b> ). <br><br>  En la etapa de inicializaci贸n, el controlador dom茅stico inteligente espera a que el usuario lo registre en su cuenta personal.  Por lo tanto, se realiza la subtarea <b>CheckGatewayExistance</b> , que verifica el estado correspondiente en la base de datos en la nube MySQL.  Para registrarse en su cuenta personal, el controlador env铆a su configuraci贸n completa al servidor de l贸gica de negocios y, a su vez, transmite su backend a la aplicaci贸n cliente ( <b>subtarea SendBackend</b> ), que crea y actualiza los registros de configuraci贸n en la nube y las bases de datos t谩ctiles. <br><br>  Cuando el controlador dom茅stico inteligente se registra con 茅xito en la cuenta personal del usuario, el servidor de l贸gica de negocios carga el modelo de usuario de la base de datos en la nube en su RAM y comienza a procesar mensajes de c谩maras IP y sensores Z-Wave de acuerdo con el siguiente algoritmo de l贸gica de negocios. <br><br>  Mensaje JSON del sensor Z-Wave con campos de informaci贸n: <br><br><pre><code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"vendor"</span></span>: <span class="hljs-string"><span class="hljs-string">"*****"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"version"</span></span>: <span class="hljs-string"><span class="hljs-string">"3.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"timestampMs"</span></span>: <span class="hljs-string"><span class="hljs-string">"1571754749561"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"clientType"</span></span>: <span class="hljs-string"><span class="hljs-string">"gateway"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"deviceId"</span></span>: <span class="hljs-string"><span class="hljs-string">"c8e8de37-d301-45f4-ba01-************"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"deviceType"</span></span>: <span class="hljs-string"><span class="hljs-string">"sensor"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"protocol"</span></span>: <span class="hljs-string"><span class="hljs-string">"zwave"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"messageType"</span></span>: <span class="hljs-string"><span class="hljs-string">"sensorData"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"homeId"</span></span>: <span class="hljs-string"><span class="hljs-string">"0xefa0cfa7"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"nodeId"</span></span>: <span class="hljs-string"><span class="hljs-string">"19"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"sensorType"</span></span>: <span class="hljs-string"><span class="hljs-string">"SENSOR MULTILEVEL"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"label"</span></span>: <span class="hljs-string"><span class="hljs-string">"Temperature"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"sensorData"</span></span>: <span class="hljs-string"><span class="hljs-string">"26.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"units"</span></span>: <span class="hljs-string"><span class="hljs-string">"C"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"gatewayId"</span></span>: <span class="hljs-string"><span class="hljs-string">"6774f85a-0a5b-4059-9b68-************"</span></span> }</code> </pre> <br>  Cuando llega un mensaje del sensor Z-Wave a trav茅s del protocolo MQTT, se realizan las siguientes subtareas: <br><br><ul><li>  <b>StoreSensorDataMySQL</b> actualiza (ACTUALIZA) un registro existente en la base de datos en la nube MySQL, donde se almacena la informaci贸n sobre el estado actual y las mediciones del sensor.  Esto es necesario para una aplicaci贸n cliente que muestra el estado actual de la casa inteligente para el usuario; </li><li>  <b>StoreSensorDataInfluxDB</b> agrega (INSERTAR) un nuevo registro a la base de datos t谩ctil InfluxDB, donde se almacena el historial de mediciones del sensor.  Esta informaci贸n se utiliza en el c谩lculo de datos estad铆sticos para varios per铆odos de tiempo (por ejemplo, consumo de energ铆a por d铆a, mes o a帽o) y se muestra en la aplicaci贸n del cliente en forma de gr谩ficos y tablas; </li><li>  <b>SendPushNotification</b> genera un mensaje JSON que contiene una marca de tiempo, un nombre de sensor, una descripci贸n de texto del evento, el identificador del tel茅fono inteligente del usuario con el que ingres贸 a su cuenta personal, el identificador interno de la aplicaci贸n en el sistema del proveedor OneSignal.  Adem谩s, este mensaje se env铆a al proveedor de notificaciones push a trav茅s de la API RESTful <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://onesignal.com/api/v1/notifications</a> , que lo entrega al tel茅fono inteligente del usuario. </li></ul><br>  Un ejemplo de un mensaje JSON de una c谩mara IP con campos de informaci贸n: <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"vendor"</span></span>: <span class="hljs-string"><span class="hljs-string">"*****"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"version"</span></span>: <span class="hljs-string"><span class="hljs-string">"3.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"timestampMs"</span></span>: <span class="hljs-string"><span class="hljs-string">"1571753150317"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"clientType"</span></span>: <span class="hljs-string"><span class="hljs-string">"gateway"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"deviceId"</span></span>: <span class="hljs-string"><span class="hljs-string">"1616453d-30cd-44b7-9bf0-************"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"deviceType"</span></span>: <span class="hljs-string"><span class="hljs-string">"camera"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"protocol"</span></span>: <span class="hljs-string"><span class="hljs-string">"onvif"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"messageType"</span></span>: <span class="hljs-string"><span class="hljs-string">"deviceState"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"deviceState"</span></span>: <span class="hljs-string"><span class="hljs-string">"streamingOn"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"mediaserverIp"</span></span>: <span class="hljs-string"><span class="hljs-string">"***.***.***.***"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"applicationName"</span></span>: <span class="hljs-string"><span class="hljs-string">"rtp-live-iot"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"gatewayId"</span></span>: <span class="hljs-string"><span class="hljs-string">"6774f85a-0a5b-4059-9b68-************"</span></span> }</code> </pre><br>  Cuando llega un mensaje de la c谩mara IP utilizando el protocolo MQTT, el servidor de l贸gica de negocios extrae su tipo del campo <b>messageType</b> .  Dependiendo del valor de este campo, se realizan las siguientes acciones: <br><br><ul><li>  <b>"MessageType": "deviceState"</b> : el mensaje contiene informaci贸n sobre el cambio de estado de la c谩mara IP.  Se realiza la subtarea <b>UpdateCameraState</b> , actualizando la informaci贸n en la base de datos en la nube.  Si el campo <b>deviceState</b> es <b>streamingOn</b> o <b>streamingOff</b> (la c谩mara IP env铆a / detiene el flujo de datos al servidor de medios), se <b>ejecuta</b> la <b>subtarea RecordMediaStream</b> , que genera un comando para habilitar / deshabilitar el modo de grabaci贸n de archivo y lo env铆a al servidor de medios; </li><li>  <b>"MessageType": "sensorData"</b> : informaci贸n sobre el funcionamiento del detector de movimiento en la c谩mara IP.  Si en el modelo de usuario el modo de grabaci贸n de archivo se establece en "por detector de movimiento", se <b>ejecuta la</b> subtarea <b>RecordMediaStream</b> .  A continuaci贸n, se <b>realizan</b> las subtareas <b>StoreSensorDataInfluxDB</b> (guardar el historial del detector en la base de datos t谩ctil) y <b>SendPushNotification</b> (enviar notificaciones push a trav茅s del proveedor); </li><li>  <b>"MessageType": "vista previa"</b> : el mensaje contiene un cuadro de una imagen en miniatura de la c谩mara IP, que se env铆a peri贸dicamente a la nube.  La subtarea <b>StorePreview lo</b> guarda en una base de datos en la nube.  Luego se usa en la aplicaci贸n cliente cuando se muestra una lista de c谩maras; </li><li>  <b>"MessageType": "comando"</b> : un comando enviado por el controlador del hogar inteligente cuando el usuario cambia su configuraci贸n a trav茅s de la interfaz web.  Se realiza la subtarea <b>RecordMediaStream</b> , que, seg煤n el modelo de usuario, activa / desactiva el modo de grabaci贸n en el servidor de medios. </li></ul><br> <a href=""><img src="https://habrastorage.org/webt/8o/_u/gy/8o_ugygyf5hm0nlyd6aw8zwge8s.png"></a> <br>  <font color="grey">(haga clic en la imagen para abrir en una resoluci贸n m谩s alta)</font> <br><br>  Como resultado del trabajo del m贸dulo de l贸gica de negocios, se forma una <b>cola de tareas</b> , una secuencia de secciones m铆nimas de c贸digo que se ejecutan independientemente entre s铆.  La cola de tareas se transfiere al grupo de <b>subprocesos</b> , que distribuye las tareas entre los n煤cleos libres del procesador central.  Cuando se produce un bloqueo de E / S durante la ejecuci贸n, el subproceso se detiene y entra en el estado inactivo y libera el n煤cleo del procesador central, lo que permite que el grupo de subprocesos inicie la ejecuci贸n inmediata de la siguiente tarea desde la cola.  En el momento en que se libera el bloqueo de E / S, el subproceso bloqueado cambia su estado a funcionamiento y contin煤a la ejecuci贸n tan pronto como se libera uno de los n煤cleos del procesador central. <br><br>  Por lo tanto, al descomponer la tarea de l贸gica de negocios en muchas subtareas separadas que se ejecutan simult谩neamente, aumenta el rendimiento del servidor de l贸gica de negocios.  El escalado del sistema se logra aumentando el n煤mero de n煤cleos del procesador central y aumentando el n煤mero de servidores de l贸gica de negocios en el sistema. <br><br>  La aplicaci贸n de servidor de l贸gica de negocios se desarrolla en C ++ y se ejecuta como el servicio <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">systemd</a> del sistema operativo Linux Debian Sarge.  Para la supervisi贸n adicional del rendimiento, se utiliza el sistema de supervisi贸n de recursos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">monit</a> , que reinicia el servicio en caso de problemas de rendimiento. <br><br>  Actualmente, el servicio en la nube ejecuta un servidor de l贸gica de negocios que se ejecuta en la m谩quina virtual Yandex.  Par谩metros de la m谩quina virtual: 4 n煤cleos de vCPU con una cuota garantizada del 20%, 2 GB de RAM, 100 GB de disco duro.  Seg煤n los c谩lculos, este rendimiento es suficiente para procesar mensajes de ~ 1000 controladores dom茅sticos inteligentes con 3 c谩maras IP y 5 sensores Z-Wave cada uno (los c谩lculos se aclarar谩n durante el funcionamiento del sistema). <br><br><h2>  Servidor de medios </h2><br>  Un servidor de medios es un servidor dedicado en el que se instala un software especial para: <br><br><ul><li>  recibir flujos de datos de video y audio desde dispositivos codificadores utilizando protocolos de red especializados; </li><li>  almacenar datos en forma de archivos en su sistema de archivos; </li><li>  Transmita informaci贸n de archivos en un formato de transmisi贸n est谩ndar para reproducir en dispositivos cliente. </li></ul><br>  El <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Wowza Streaming Engine 4.7.2</a> con m贸dulos adicionales desarrollados en el lenguaje Java se usa como un servidor de medios en el sistema dom茅stico inteligente en la nube para grabar datos de transmisi贸n en un archivo y para trabajar con una base de datos en la nube. <br><br> <a href=""><img src="https://habrastorage.org/webt/va/du/c-/vaduc-wwi67k2367aoez0bnqx_s.png"></a> <br>  <font color="grey">(haga clic en la imagen para abrir en una resoluci贸n m谩s alta)</font> <br><br>  El flujo de medios desde el controlador dom茅stico inteligente en formato RTMP ingresa al servidor de medios y se alinea con las marcas de tiempo en el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">b煤fer de fluctuaci贸n</a> .  Esto es necesario para compensar el efecto de los retrasos en los paquetes de red al transmitir el flujo de datos a trav茅s de Internet. <br><br>  Para grabar la transmisi贸n de video en el sistema de archivos del servidor de medios como un archivo MP4, el servidor de l贸gica de negocios env铆a el siguiente comando al servidor de medios a trav茅s de la API RESTful HTTP: <br><br><pre> <code class="json hljs">http://&lt;mediaserverIp&gt;:&lt;port&gt;/v<span class="hljs-number"><span class="hljs-number">2</span></span>/servers/_defaultServer_/vhosts/_defaultVHost_/applications/rtp-live-iot/instances/_definst_/streamrecorders/<span class="hljs-number"><span class="hljs-number">1616453</span></span>d<span class="hljs-number"><span class="hljs-number">-30</span></span>cd<span class="hljs-number"><span class="hljs-number">-44</span></span>b<span class="hljs-number"><span class="hljs-number">7</span></span><span class="hljs-number"><span class="hljs-number">-9</span></span>bf<span class="hljs-number"><span class="hljs-number">0</span></span>-************ { <span class="hljs-attr"><span class="hljs-attr">"instanceName"</span></span>: <span class="hljs-string"><span class="hljs-string">"_definst_"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"fileVersionDelegateName"</span></span>: <span class="hljs-string"><span class="hljs-string">"CustomFileVersionDelegate"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"serverName"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"recorderName"</span></span>: <span class="hljs-string"><span class="hljs-string">"1616453d-30cd-44b7-9bf0-************"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"segmentSchedule"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"outputPath"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"currentFile"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"applicationName"</span></span>: <span class="hljs-string"><span class="hljs-string">"rtp-live-iot"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"fileTemplate"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"segmentationType"</span></span>: <span class="hljs-string"><span class="hljs-string">"SegmentByDuration"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"fileFormat"</span></span>: <span class="hljs-string"><span class="hljs-string">"MP4"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"recorderState"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"option"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"currentSize"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"segmentSize"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"segmentDuration"</span></span>: <span class="hljs-string"><span class="hljs-string">"1800000"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"backBufferTime"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"currentDuration"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"startOnKeyFrame"</span></span>: <span class="hljs-string"><span class="hljs-string">"true"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"recordData"</span></span>: <span class="hljs-string"><span class="hljs-string">"false"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"moveFirstVideoFrameToZero"</span></span>: <span class="hljs-string"><span class="hljs-string">"true"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"defaultRecorder"</span></span>: <span class="hljs-string"><span class="hljs-string">"false"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"splitOnTcDiscontinuity"</span></span>: <span class="hljs-string"><span class="hljs-string">"false"</span></span> }</code> </pre><br>  En el campo <b>recorderName</b> , el nombre de la transmisi贸n de video (identificador de c谩mara IP en el controlador dom茅stico inteligente) se <b>indica</b> , en el campo <b>fileVersionDelegateName</b> , el nombre de la clase heredada para determinar la ruta de la carpeta y el nombre del archivo.  El c贸digo de clase Java se muestra en la siguiente lista: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.File; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Calendar; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.TimeZone; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.wowza.wms.livestreamrecord.manager.IStreamRecorder; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.wowza.wms.livestreamrecord.manager.IStreamRecorderFileVersionDelegate; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.wowza.wms.logging.WMSLoggerFactory; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomFileVersionDelegate</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IStreamRecorderFileVersionDelegate</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getFilename</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(IStreamRecorder recorder)</span></span></span><span class="hljs-function"> </span></span>{ String sDisk = GetDisk(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(sDisk == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { WMSLoggerFactory.getLogger(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>).error(<span class="hljs-string"><span class="hljs-string">"CustomFileVersionDelegate::getFilename(): No drive chosen"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } String sStreamName = recorder.getStreamName(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> nCameraId = Integer.parseUnsignedInt(ServiceQueries.GetCameraId(sStreamName)); TimeZone tz = TimeZone.getTimeZone(<span class="hljs-string"><span class="hljs-string">"Europe/Moscow"</span></span>); Calendar now = Calendar.getInstance(tz); String sDirPath = ServerParams.m_sServerContentPath + <span class="hljs-string"><span class="hljs-string">"/"</span></span> + sDisk + <span class="hljs-string"><span class="hljs-string">"/"</span></span> + Integer.toString(nCameraId / <span class="hljs-number"><span class="hljs-number">200</span></span>) + <span class="hljs-string"><span class="hljs-string">"/"</span></span> + sStreamName + <span class="hljs-string"><span class="hljs-string">"/"</span></span> + String.format(<span class="hljs-string"><span class="hljs-string">"%1$tY/%1$tm/%1$td"</span></span>, now); String sFullFilePath = sDirPath + <span class="hljs-string"><span class="hljs-string">"/"</span></span> + sStreamName + <span class="hljs-string"><span class="hljs-string">"_"</span></span> + String.format(<span class="hljs-string"><span class="hljs-string">"%1$tH_%1$tM_%1$tS"</span></span>, now) + <span class="hljs-string"><span class="hljs-string">".mp4"</span></span>; File dirs = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> File(sDirPath); dirs.setExecutable(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); dirs.setWritable(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); dirs.mkdirs(); WMSLoggerFactory.getLogger(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>).info( <span class="hljs-string"><span class="hljs-string">"CustomFileVersionDelegate::getFilename(): Filename created: "</span></span> + sFullFilePath); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sFullFilePath; } }</code> </pre><br>  En la clase <b>CustomFileVersionDelegate</b> , la funci贸n virtual <b>getFilename</b> de la clase base <b>IStreamRecorderFileVersionDelegate</b> est谩 <b>sobrecargada</b> , que el servidor de medios llama antes de que la secuencia comience a escribir en el archivo.  La funci贸n crea una carpeta en el disco con la ruta <b>sDirPath</b> y devuelve la ruta completa al archivo <b>sFullFilePath</b> . <br><br>  Dado que el volumen de datos multimedia es muy grande, el sistema de archivos incluye varios discos f铆sicos de gran volumen (8-12 TB) montados como subdirectorios.  El disco con la mayor cantidad de espacio libre se selecciona como el disco de destino durante la grabaci贸n.  Para un funcionamiento 贸ptimo del sistema de archivos al acceder al archivo, la ruta a la carpeta de destino se forma de la siguiente manera: <br><br><pre> <code class="plaintext hljs">/content/&lt;diskId&gt;/&lt;cameraIdDivideBy200&gt;/&lt;streamUuid&gt;/&lt;year&gt;/&lt;month&gt;/&lt;day&gt;/</code> </pre><br>  donde <b>diskId</b> es el identificador del disco (carpeta montada), <br>  <b>cameraIdDivideBy200</b> : el resultado de una divisi贸n entera del identificador de la c谩mara por 200, <br>  <b>streamUuid</b> : identificador de flujo de medios, <br>  <b>a帽o, mes, d铆a</b> : a帽o, mes y d铆a de grabaci贸n, respectivamente. <br><br>  Esto evita una gran cantidad de subcarpetas dentro de una carpeta y, en consecuencia, una ca铆da dram谩tica en el rendimiento de todo el sistema de archivos con un aumento en el n煤mero de c谩maras IP en hogares inteligentes nublados. <br><br>  La informaci贸n sobre la direcci贸n IP del servidor de medios, la ruta al archivo con datos de medios, la hora de inicio y finalizaci贸n de la escritura en el archivo se almacena en la base de datos en la nube y luego la aplicaci贸n cliente la utiliza para mostrar la l铆nea de tiempo del archivo en el que se puede seleccionar y reproducir el video. <br><br>  Para obtener la transmisi贸n de video, el front-end de la aplicaci贸n cliente accede al servidor de medios, enviando los siguientes comandos a trav茅s del protocolo HTTP.  Para una transmisi贸n de video "en vivo": <br><br><pre> <code class="plaintext hljs">https://&lt;mediaserverIp&gt;:&lt;port&gt;/rtp-live-iot/&lt;streamUuid&gt;/playlist.m3u8</code> </pre><br>  Para la secuencia de video archivada: <br><br><pre> <code class="plaintext hljs">https://&lt;mediaserverIp&gt;:&lt;port&gt;/vod/_definst_/mp4:&lt;diskId&gt;/&lt;cameraIdDivideBy200&gt;/&lt;streamUuid&gt;/&lt;year&gt;/&lt;month&gt;/&lt;day&gt;/&lt;fileName&gt;/playlist.m3u8?wowzaplaystart=&lt;offsetMs&gt;&amp;wowzaplayduration=&lt;durationMs&gt;</code> </pre><br>  donde <b>fileName</b> es el nombre del archivo en el disco, <br>  <b>offsetMs</b> : desplazamiento de reproducci贸n relativo al comienzo del archivo en milisegundos, <br>  <b>duraci贸nMs</b> - duraci贸n de la reproducci贸n en milisegundos. <br><br>  El servidor de medios env铆a una transmisi贸n en formato <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">HLS</a> , que le permite mostrar video H.264 + AAC en todos los navegadores modernos y dispositivos m贸viles con sistemas operativos iOS y Android.  El paquete de paquetes HLS codifica el flujo en forma de fragmentos separados y lo env铆a a trav茅s de HTTP como respuesta a una solicitud de una aplicaci贸n m贸vil. <br><br>  Para optimizar los costos de almacenamiento y el acceso a los archivos de almacenamiento, el servidor de medios dom茅sticos inteligentes en la nube se desarroll贸 en la plataforma de hardware Supermicro CSE-825TQ, placa base X8DT6, 2xCPU Intel Xeon E5645 2.4 GHz, 32 GB de RAM, 44 TB HDD Adaptec AAC-RAID.  El servidor de medios se instala como un servidor dedicado en el sitio de alojamiento y se conecta al canal de Internet con un ancho garantizado de 400 Mbps.  El rendimiento de un servidor de medios es suficiente para procesar transmisiones de medios de ~ 400 c谩maras IP con el c贸dec H.264, resoluci贸n de cuadro de 720p y velocidad de bits de 1 Mbps. <br><br><img src="https://habrastorage.org/webt/zr/-n/sy/zr-nsyuedb8wtbakou5rzfnsyo8.png"><br><br>  En consecuencia, para poder procesar transmisiones de 1000 c谩maras IP, es necesario instalar 3 servidores de medios y distribuir uniformemente la carga entre ellos.  Para esto, se utiliza un equilibrador de carga, que est谩 conectado al servidor de medios Wowza Streaming Engine como un complemento <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">adicional de Dynamic Load Balancing AddOn</a> .  Esto distingue, de hecho, el equilibrador de carga (o <b>servidor de origen</b> ), que recibe peri贸dicamente las m茅tricas de rendimiento de los servidores de medios finales (o <b>servidores perimetrales</b> ) y, seg煤n esta informaci贸n, encuentra el servidor menos cargado en el cl煤ster. <br><br>  El controlador dom茅stico inteligente accede al equilibrador a trav茅s de HTTP y, en respuesta, recibe la direcci贸n IP de este servidor, a la cual el controlador transmite el flujo de medios desde la c谩mara IP a trav茅s de RTMP.  La m茅trica de rendimiento incluye el n煤mero de conexiones establecidas con fuentes y consumidores de transmisiones de medios y el ancho de banda actual del canal de Internet en el servidor.  En la configuraci贸n del equilibrador, tambi茅n puede especificar la elecci贸n del servidor perimetral, teniendo en cuenta su posici贸n geoespacial, que le permite alojar servidores en diferentes ciudades y pa铆ses para crear una red distribuida para entregar contenido <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">CDN</a> . <br><br><h2>  Base de datos t谩ctil </h2><br>  Como se mencion贸 anteriormente en el art铆culo anterior, las lecturas de los sensores Z-Wave, as铆 como el estado actual y los eventos de las c谩maras IP, se env铆an en formato JSON a la nube mediante el protocolo MQTT.  El servidor de l贸gica de negocios decodifica estos mensajes y ejecuta la subtarea <b>StoreSensorDataInfluxDB</b> , que transmite datos a la base de datos t谩ctil a trav茅s de HTTP. <br><br> <a href=""><img src="https://habrastorage.org/webt/14/lv/rv/14lvrvrra0js_mzifmrwszu9c68.png"></a> <br>  <font color="grey">(haga clic en la imagen para abrir en una resoluci贸n m谩s alta)</font> <br><br>  La base de datos de sensores del hogar inteligente en la nube se desarrolla sobre la base de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">InfluxDB 1.7.x</a> , un sistema de gesti贸n de bases de datos de c贸digo abierto para trabajar con secuencias de tiempo, que se utiliza en muchos proyectos de Internet de las Cosas para almacenar datos de sensores y an谩lisis.  Las consultas a la base de datos t谩ctil se generan en el lenguaje <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">InfluxQL</a> similar al SQL tradicional. <br><br>  El tiempo de almacenamiento de datos en el hogar inteligente en la nube est谩 determinado por la tarifa seleccionada de acuerdo con el modelo de usuario.  Debido a la diferencia significativa en la cantidad de datos de video y datos del sensor, su tiempo de almacenamiento ser谩 diferente.  El tama帽o del archivo de video se mide en d铆as (7, 14, 30 d铆as a diferentes velocidades), y el tama帽o del archivo de sensores se mide en a帽os (3, 5, 7 a帽os, respectivamente).  Por lo tanto, para cada controlador dom茅stico inteligente, cuando se registra en la cuenta personal del usuario, se crean 2 bases de datos separadas con diferentes pol铆ticas de retenci贸n dentro de la base de datos t谩ctil: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> <span class="hljs-string"><span class="hljs-string">"gateway_6774f85a_0a5b_4059_9b68_************_cameras"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DURATION</span></span> <span class="hljs-number"><span class="hljs-number">720</span></span>h SHARD <span class="hljs-keyword"><span class="hljs-keyword">DURATION</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>h; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> <span class="hljs-string"><span class="hljs-string">"gateway_6774f85a_0a5b_4059_9b68_************_sensors"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DURATION</span></span> <span class="hljs-number"><span class="hljs-number">61320</span></span>h SHARD <span class="hljs-keyword"><span class="hljs-keyword">DURATION</span></span> <span class="hljs-number"><span class="hljs-number">24</span></span>h;</code> </pre><br>  El backend de la aplicaci贸n cliente es responsable de crear, editar y eliminar la base de datos dentro de la base de datos t谩ctil.  Por ejemplo, si un usuario dom茅stico inteligente en la nube cambia la tarifa, el servidor env铆a los siguientes comandos para realizar cambios en la pol铆tica de almacenamiento: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RETENTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">POLICY</span></span> <span class="hljs-string"><span class="hljs-string">"autogen"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-string"><span class="hljs-string">"gateway_6774f85a_0a5b_4059_9b68_************_cameras"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DURATION</span></span> <span class="hljs-number"><span class="hljs-number">168</span></span>h SHARD <span class="hljs-keyword"><span class="hljs-keyword">DURATION</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>h;</code> </pre><br>  Al eliminar el controlador de casa inteligente de la cuenta personal del usuario, el servidor elimina las bases de datos correspondientes: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> <span class="hljs-string"><span class="hljs-string">"gateway_6774f85a_0a5b_4059_9b68_************_cameras"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> <span class="hljs-string"><span class="hljs-string">"gateway_6774f85a_0a5b_4059_9b68_************_sensors"</span></span>;</code> </pre><br>  Al recibir un mensaje informativo del controlador del hogar inteligente, el servidor de l贸gica de negocios realiza una solicitud para insertar datos en la base de datos t谩ctil: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> device_20873eb0_dd5e_4213_a175_************,<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>=METER,label=Energy,units=kWh value_float=<span class="hljs-number"><span class="hljs-number">0.05</span></span> <span class="hljs-number"><span class="hljs-number">1572194550125</span></span>;</code> </pre><br>  Un ejemplo de una tabla con datos de sensores Z-Wave para un controlador dom茅stico inteligente: <br><br><img src="https://habrastorage.org/webt/bc/ic/ht/bcicht3izpojrvpo2bsp2347p5w.png"><br><br>  Una de las caracter铆sticas m谩s 煤tiles de una casa en la nube es el c谩lculo de estad铆sticas basadas en los datos recibidos.  El usuario necesita saber la temperatura promedio en la habitaci贸n o cu谩nta electricidad gast贸 por mes. <br><br>  El lenguaje InfluxQL le permite realizar consultas utilizando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">funciones anal铆ticas</a> .  Por ejemplo, para calcular la temperatura promedio durante una semana, debe ejecutar la siguiente consulta: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> MEAN(<span class="hljs-string"><span class="hljs-string">"value_float"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> device_63c660da_f0e8_4eca_8d5f_************ <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> label = <span class="hljs-string"><span class="hljs-string">'Temperature'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> &gt;= <span class="hljs-string"><span class="hljs-string">'2019-10-21T00:00:00.000Z'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> &lt;= <span class="hljs-string"><span class="hljs-string">'2019-10-27T23:59:59.999Z'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>d) fill(<span class="hljs-literal"><span class="hljs-literal">null</span></span>);</code> </pre><br>  Los resultados de esta consulta se muestran en la tabla: <br><br><img src="https://habrastorage.org/webt/ze/ac/wb/zeacwb7cqvnei_raajemgoebauq.png"><br><br>  En el pr贸ximo art铆culo, que est谩 dedicado por completo a la aplicaci贸n del cliente, consideraremos en detalle el c谩lculo de estad铆sticas para varios par谩metros y la construcci贸n de tablas y gr谩ficos basados en 茅l. <br><br>  En el sistema de casa inteligente en la nube, el DBMS InfluxDB se implementa en una m谩quina virtual Yandex. Cloud con los siguientes par谩metros: 4 n煤cleos de vCPU con una participaci贸n garantizada del 20%, 2 GB de RAM, 100 GB de disco duro.  Seg煤n los c谩lculos de esta configuraci贸n, es suficiente almacenar datos de sensores de 3.000 c谩maras IP y 5.000 sensores Z-Wave durante 7 a帽os. <br><br><h2>  Conclusi贸n </h2><br>  El art铆culo examin贸 la arquitectura de un servicio en la nube para un hogar inteligente, el algoritmo de un servidor de l贸gica de negocios, la arquitectura de un servidor de medios para grabar, almacenar y reproducir transmisiones de medios desde c谩maras IP, as铆 como la arquitectura de una base de datos t谩ctil para almacenar y analizar datos de sensores de hogares inteligentes.  El sistema de servicio en la nube funciona tanto en servidores dedicados como virtuales, para una mayor estabilidad ubicada en diferentes sitios de alojamiento.  El sistema se encuentra actualmente en operaci贸n de prueba. <br><br>  Mientras m谩s antiguos sean los datos almacenados en la nube, con menos frecuencia el usuario accede a ellos.  En la pr贸xima versi贸n del servicio en la nube, se propone utilizar el mecanismo de adelgazamiento (o sobremuestreo) de datos mediante <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">consultas continuas InfluxDB</a> para reducir la cantidad de datos almacenados mediante funciones de agregaci贸n y, por lo tanto, aumentar la capacidad de la base de datos t谩ctil. <br><br><img src="https://habrastorage.org/webt/4x/s-/jl/4xs-jlindsjesrddtgfb8nbstxu.png"><br><br>  Adem谩s, en la pr贸xima versi贸n del servicio en la nube, se implementar谩 un grupo de servidores de l贸gica de negocios de acuerdo con el principio de un grupo de servidores de medios, discutido en este art铆culo.  La figura muestra la arquitectura de dicho cl煤ster, donde varios servidores perimetrales (cada uno de los cuales tiene un agente MQTT y un software de servidor de l贸gica de negocios) env铆an m茅tricas de rendimiento al servidor de origen, que calcula la direcci贸n IP del servidor menos cargado.  Esto le permitir谩 escalar el sistema en mayor medida y superar el l铆mite existente de 1000 hogares inteligentes. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/474700/">https://habr.com/ru/post/474700/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../474690/index.html">Crear una consola con una altura variable para un trabajo m谩s conveniente en una computadora</a></li>
<li><a href="../474692/index.html">Revisi贸n de Skaffold para el desarrollo de Kubernetes</a></li>
<li><a href="../474694/index.html">C贸mo seleccionamos y torcimos el marco para las pruebas de rendimiento</a></li>
<li><a href="../474696/index.html">Boleto de aceite o boleto de Rosneft para el desaf铆o s铆smico</a></li>
<li><a href="../474698/index.html">Usar ventanas modales en interfaces de usuario</a></li>
<li><a href="../474702/index.html">Programaci贸n funcional desde el punto de vista de EcmaScript. Funciones puras, lambdas, inmunidad.</a></li>
<li><a href="../474704/index.html">Entrevista de Playboy: Steve Jobs, Parte 2</a></li>
<li><a href="../474706/index.html">Algoritmo de b煤squeda difusa de TextRadar: enfoques b谩sicos</a></li>
<li><a href="../474708/index.html">Internet est谩 m谩s fragmentado que nunca: 驴a d贸nde "llegan" m谩s de un mill贸n de nuevos usuarios diariamente? Parte 1</a></li>
<li><a href="../474710/index.html">c.tech: Frontend Meetup # 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>