<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>游뱜游 游꿭 丘멆잺 Redireccionar printf () de STM32 a Qt Creator Console 游뚬 游눊 游냚</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A menudo, al depurar el software del microcontrolador, es necesario enviar mensajes de depuraci칩n, registros, datos capturados y otras cosas a la pant...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Redireccionar printf () de STM32 a Qt Creator Console</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/440024/"><p><img src="https://habrastorage.org/webt/gg/yw/ol/ggywoln37vevtn3jnep_hcahfhu.png" alt="kdpv.svg"></p><br><p>  A menudo, al depurar el software del microcontrolador, es necesario enviar mensajes de depuraci칩n, registros, datos capturados y otras cosas a la pantalla de la PC.  Al mismo tiempo, quiero que la salida sea m치s r치pida y que las l칤neas no se muestren en ning칰n lado, sino directamente en el IDE, sin apartarse del c칩digo, por as칤 decirlo.  En realidad, se trata del art칤culo: c칩mo intent칠 imprimir printf () para mostrar y mostrar dentro de mi entorno favorito, pero no muy microcontrolador, Qt Creator. </p><a name="habracut"></a><br><p>  En general, puede encontrar una gran cantidad de formas de generar informaci칩n de texto desde el microcontrolador.  Sin embargo, las t칠cnicas m치s utilizadas no son tantas: </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Semihosting</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Segger rtt</a> </li><li>  USB CDC </li><li>  UART </li><li>  ITM </li></ul><br><p>  El semihosting es bastante lento, RTT est치 vinculado a las soluciones de hardware y software Segger *, el USB no est치 en todos los microcontroladores.  Por lo tanto, por lo general, prefiero los dos 칰ltimos: el uso de UART e ITM.  Sobre ellos y se discutir치 a continuaci칩n. </p><br><p>  * <em>Upd.</em>  <em>- De hecho, como se sugiere en los comentarios, esto no es as칤.</em>  <em>Hay opciones tanto en el lado del software como del hardware.</em>  <em>Por lo tanto, de los m칠todos anteriores, RTT ser치 quiz치s el m치s universal.</em> </p><br><p>  Y enseguida alguna explicaci칩n sobre el software que se usar치 a continuaci칩n.  Ahora tengo Fedora 28 como sistema operativo, y el paquete actual de software para trabajar con microcontroladores es: </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Qt Creator 4.8.1</a> (enlace directo a lanzamientos, bastante cuidadosamente oculto en el sitio) </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">GNU Arm Embedded Toolchain 7</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">OpenOCD 0.10.0 + dev</a> </li></ul><br><h3 id="perenapravlenie-printf-v-gcc">  Redirigir printf () en GCC </h3><br><p>  Entonces, para redirigir la salida de printf () en GCC, debe agregar claves de enlazador </p><br><pre><code class="plaintext hljs">-specs=nosys.specs -specs=nano.specs</code> </pre> <br><p>  Si necesita mostrar n칰meros de coma flotante, debe recordar la clave </p><br><pre> <code class="plaintext hljs">-u_printf_float</code> </pre> <br><p>  E implemente la funci칩n _write ().  Por ejemplo, algo como esto </p><br><pre> <code class="plaintext hljs">int _write(int fd, char* ptr, int len) { (void)fd; int i = 0; while (ptr[i] &amp;&amp; (i &lt; len)) { retarget_put_char((int)ptr[i]); if (ptr[i] == '\n') { retarget_put_char((int)'\r'); } i++; } return len; }</code> </pre> <br><p>  donde retarget_put_char () es una funci칩n que cargar치 el car치cter directamente en la interfaz deseada. </p><br><h3 id="printf---itm---qt-creator">  printf () -&gt; ITM -&gt; Qt Creator </h3><br><p>  Instrumentation Trace Macrocell (ITM) es un bloque dentro del n칰cleo Cortex-M3 / M4 / M7 utilizado para la salida no invasiva (rastreo) de varios tipos de informaci칩n de diagn칩stico.  Para implementar printf () sobre ITM, debe saber lo siguiente: </p><br><ul><li>  Utiliza el reloj TRACECLKIN, cuya frecuencia suele ser igual a la frecuencia central </li><li>  Tiene 32 piezas de los llamados puertos de est칤mulo para la salida de datos </li><li>  CMSIS incorpora la funci칩n ITM_SendChar (), que carga un s칤mbolo en el puerto de est칤mulo 0 </li><li>  Los datos se emiten a trav칠s de un bus s칤ncrono (TRACEDATA, TRACECLK) o de una l칤nea SWO as칤ncrona de un solo cable (TRACESWO) </li><li>  La l칤nea SWO generalmente se multiplexa con JTDO, lo que significa que solo funciona en modo de depuraci칩n por SWD </li><li>  La retirada por SWO se lleva a cabo utilizando el c칩digo Manchester o NRZ (UART 8N1) </li><li>  Los datos se transmiten en cuadros de cierto formato: necesita un analizador en el lado receptor </li><li>  ITM generalmente se configura desde el IDE o la utilidad correspondiente (sin embargo, nadie proh칤be configurarlo en el c칩digo del programa; luego, la salida a SWO funcionar치 sin una sesi칩n de depuraci칩n elevada) </li></ul><br><p>  La forma m치s conveniente de usar ITM es emitir a trav칠s de SWO usando la codificaci칩n NRZ; por lo tanto, solo necesita una l칤nea, y ser치 posible recibir datos no solo usando un depurador con una entrada especial, sino tambi칠n un adaptador USB-UART normal, aunque a una velocidad menor. </p><br><p>  Segu칤 el camino usando un depurador, y me vi obligado a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">modificar</a> mi STLink-V2 chino para admitir SWO.  Entonces todo es simple: conectamos el microcontrolador JTDO / TRACESWO al pin del depurador correspondiente y vamos a configurar el software. </p><br><p>  Openocd tiene el comando "tpiu config": con 칠l puede configurar el m칠todo para mostrar informaci칩n de rastreo (con m치s detalle en la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Gu칤a del usuario de OpenOCD</a> ).  Entonces, por ejemplo, usando argumentos </p><br><pre> <code class="plaintext hljs">tpiu config internal /home/esynr3z/itm.fifo uart off 168000000</code> </pre> <br><p>  configure la salida en el archivo /home/esynr3z/itm.fifo, use la codificaci칩n NRZ y calcule la velocidad de transferencia m치xima en funci칩n de la frecuencia TRACECLKIN de 168 MHz, para STLink es de 2 MHz.  Y otro equipo </p><br><pre> <code class="plaintext hljs">itm port 0 1</code> </pre> <br><p>  habilitar치 el puerto cero para la transferencia de datos. </p><br><p>  El c칩digo fuente de OpenOCD incluye la utilidad itmdump (contrib / itmdump.c): con ella puede analizar cadenas de los datos recibidos. </p><br><p>  Para compilar entramos </p><br><pre> <code class="plaintext hljs">gcc itmdump.c -o itmdump</code> </pre> <br><p>  Al inicio, especifique el archivo / pipe / ttyUSB * necesario y el modificador -d1 para mostrar los bytes de datos recibidos como cadenas </p><br><pre> <code class="plaintext hljs">./itmdump -f /home/esynr3z/itm.fifo -d1</code> </pre> <br><p>  Y el 칰ltimo.  Para enviar un car치cter a trav칠s de SWO, complementamos _write (), descrito anteriormente, con una funci칩n </p><br><pre> <code class="plaintext hljs">int retarget_put_char(int ch) { ITM_SendChar((uint32_t)ch); return 0; }</code> </pre> <br><p>  Entonces, el plan general es el siguiente: dentro de Qt Creator, configuramos openocd para guardar toda la informaci칩n recibida en SWO en una tuber칤a nombrada previamente creada, y podemos leer tuber칤as, analizar cadenas y mostrarlas usando itmdump, que se ejecuta como una herramienta externa.  Por supuesto, hay una forma m치s elegante de resolver el problema: escribir el complemento apropiado para Qt Creator.  Sin embargo, espero que el enfoque descrito a continuaci칩n resulte 칰til para alguien. </p><br><p>  Vaya a la configuraci칩n del complemento Bare Metal (Herramientas-&gt; Opciones-&gt; Dispositivos-&gt; Bare Metal). </p><br><p><img src="https://habrastorage.org/webt/_t/0e/vz/_t0evzgzyymortwmhhwnvumadrq.png" alt="config_baremetal.png"></p><br><p>  Seleccione el servidor GDB usado y agregue los comandos de inicializaci칩n de l칤nea al final de la lista </p><br><pre> <code class="plaintext hljs">monitor tpiu config internal /home/esynr3z/itm.fifo uart off 168000000 monitor itm port 0 1</code> </pre> <br><p>  Ahora, justo antes de que el depurador coloque el cursor al principio de main (), se configurar치 ITM. </p><br><p>  Agregue itmdump como la herramienta externa (Herramientas-&gt; Externo-&gt; Configurar ...). </p><br><p><img src="https://habrastorage.org/webt/tx/18/mk/tx18mk_cx8zdqhxajwxsoh2ivlk.png" alt="external_itmdump.png"></p><br><p>  No olvides configurar la variable </p><br><pre> <code class="plaintext hljs">QT_LOGGING_TO_CONSOLE=1</code> </pre> <br><p>  para mostrar la salida de la utilidad a la consola Qt Creator (panel 7 Mensajes generales). </p><br><p>  Ahora encienda itmdump, active el modo de depuraci칩n, inicie la ejecuci칩n del c칩digo y ... no pasa nada.  Sin embargo, si interrumpe la depuraci칩n, la ejecuci칩n de itmdump finalizar치 y todas las l칤neas impresas a trav칠s de printf () aparecer치n en la pesta침a Mensajes generales. </p><br><p>  Despu칠s de una breve investigaci칩n, se descubri칩 que las l칤neas de itmdump deben almacenarse en b칰fer y mostrarse en stderr, luego aparecen en la consola de forma interactiva, mientras se depura el programa.  Sub칤 una versi칩n modificada de itmdump a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">GitHub</a> . </p><br><p>  Hay una advertencia m치s.  La depuraci칩n en el inicio depender치 de la ejecuci칩n del comando "monitor tpiu config ..." si itmdump no se ejecut칩 previamente.  Esto sucede debido al hecho de que la apertura de la tuber칤a (/home/esynr3z/itm.fifo) dentro de openocd para escritura est치 bloqueando, y el depurador se bloquear치 hasta que la tuber칤a se abra para leer desde el otro extremo. </p><br><p>  Esto es algo desagradable, especialmente si en alg칰n momento no se necesita ITM, pero tiene que ejecutarlo inactivo, cambiar constantemente el servidor GDB o eliminar / agregar l칤neas en su configuraci칩n.  Por lo tanto, tuve que cavar un poco de fuentes abiertas y encontrar el lugar donde necesita sustituir una peque침a muleta. </p><br><p>  En el archivo src / target / armv7m_trace.c hay una l칤nea con el procedimiento de apertura deseado </p><br><pre> <code class="plaintext hljs">armv7m-&gt;trace_config.trace_file = fopen(CMD_ARGV[cmd_idx], "ab");</code> </pre> <br><p>  necesita ser reemplazado por </p><br><pre> <code class="plaintext hljs">int fd = open(CMD_ARGV[cmd_idx], O_CREAT | O_RDWR, 0664); armv7m-&gt;trace_config.trace_file = fdopen(fd, "ab");</code> </pre> <br><p>  Ahora nuestra pipa se abrir치 inmediatamente y no brillar치.  Por lo tanto, puede dejar la configuraci칩n de Bare Metal sola y ejecutarla solo cuando sea necesario. </p><br><p>  Como resultado, la salida de mensajes durante la depuraci칩n se ve as칤 </p><br><p><img src="https://habrastorage.org/webt/lz/-x/po/lz-xpo5ujcbkrga3al-pnsectme.png" alt="debug.png"></p><br><h2 id="printf---uart---qt-creator">  printf () -&gt; UART -&gt; Qt Creator </h2><br><p>  En este caso, todo es aproximadamente igual: </p><br><ul><li>  Agregue una funci칩n con inicializaci칩n UART al c칩digo </li><li>  Implementamos retarget_put_char (), donde el car치cter se enviar치 al b칰fer del transceptor </li><li>  Conectamos el adaptador USB-UART </li><li>  Agregue una utilidad a Herramientas externas que leer치 l칤neas del puerto COM virtual y las mostrar치 en la pantalla. </li></ul><br><p>  Bosquej칠 tal utilidad en C - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">uartdump</a> .  El uso es bastante simple: solo necesita especificar el nombre del puerto y la velocidad en baudios. </p><br><p><img src="https://habrastorage.org/webt/wm/ov/mf/wmovmfhdw33hahv1mdaubq0432u.png" alt="external_uartdump.png"></p><br><p>  Sin embargo, vale la pena se침alar una caracter칤stica.  Esta utilidad no depende de la depuraci칩n, y Qt Creator no ofrece ninguna opci칩n para cerrar la ejecuci칩n de herramientas externas.  Por lo tanto, para dejar de leer el puerto COM, agregu칠 otra herramienta externa. </p><br><p><img src="https://habrastorage.org/webt/k8/ee/1p/k8ee1pim_owcrvyuvz3jrsezta8.png" alt="external_uartdump_close.png"></p><br><p>  Bueno, por si acaso, adjuntar칠 un enlace a la plantilla CMake para el proyecto que apareci칩 en las capturas de pantalla: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">GitHub</a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/440024/">https://habr.com/ru/post/440024/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../440014/index.html">Habilidades, autoeducaci칩n y lenguajes de programaci칩n para desarrolladores principiantes: HackerRank Research</a></li>
<li><a href="../440016/index.html">Cuando se puede tocar la lectura: ONYX BOOX Monte Cristo 4 review</a></li>
<li><a href="../440018/index.html">Exposici칩n local din치mica</a></li>
<li><a href="../440020/index.html">Regresi칩n o regresi칩n en pruebas</a></li>
<li><a href="../440022/index.html">Un peque침o Ferrari: Fintech-startup Rally Rd te permitir치 comprar "acciones" de autos raros</a></li>
<li><a href="../440026/index.html">Kaggle: no puede caminar - corramos</a></li>
<li><a href="../440030/index.html">Identifique el bloqueo de PKH en un enrutador OpenWrt con WireGuard y DNSCrypt</a></li>
<li><a href="../440032/index.html">Inteligencia Artificial Horizon Zero Dawn</a></li>
<li><a href="../440034/index.html">BESO Arquitectura. Del microservicio al monolito</a></li>
<li><a href="../440036/index.html">Mecanograf칤a t치ctil</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>