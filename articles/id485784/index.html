<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👃🏿 🎅🏾 ⛹🏽 Membuat proses apa pun bekerja dengan NTFS transaksional: langkah pertama saya untuk membuat kotak pasir untuk Windows 💇🏻 👊🏾 💇🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ada modul di kernel Windows yang bertanggung jawab untuk mendukung pengelompokan operasi file ke dalam beberapa entitas yang disebut transaksi . Tinda...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Membuat proses apa pun bekerja dengan NTFS transaksional: langkah pertama saya untuk membuat kotak pasir untuk Windows</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/485784/"><p><img src="https://habrastorage.org/webt/p0/-s/fi/p0-sfitxnzzpywfqxuc4arx1fps.png" align="right" alt="TransactionMaster">  Ada modul di kernel Windows yang bertanggung jawab untuk mendukung pengelompokan operasi file ke dalam beberapa entitas yang disebut <strong>transaksi</strong> .  Tindakan pada entitas ini terisolasi dan atom: tindakan itu dapat <em>diterapkan</em> dengan menjadikannya permanen, atau <em>dibatalkan</em> .  Sangat nyaman saat menginstal program, setuju?  Kami selalu berpindah dari satu negara yang disepakati ke negara lain, dan jika terjadi kesalahan, semua perubahan dibatalkan. </p><br><p> Karena saya belajar tentang dukungan fungsi seperti itu, saya selalu ingin melihat dunia dari dalam transaksi ini.  Dan Anda tahu apa: Saya menemukan metode sederhana dan benar-benar luar biasa untuk membuat proses apa pun bekerja di dalam transaksi file, <del>  tetapi margin bukunya terlalu sempit untuknya </del>  .  Dalam kebanyakan kasus, ini bahkan tidak memerlukan hak administratif. </p><br><p>  Mari kita cari tahu cara kerjanya, bereksperimen dengan program saya, dan memahami apa itu kotak pasir. </p><a name="habracut"></a><br><h2 id="repozitoriy">  Repositori </h2><br><p>  Bagi mereka yang ingin mencoba: <a href="https://github.com/diversenok/TransactionMaster">TransactionMaster on GitHub</a> . </p><br><h2 id="teoriya">  Teori </h2><br><p>  Dukungan untuk transaksional NTFS, atau <strong>TxF</strong> , muncul di Windows Vista, dan memungkinkan untuk menyederhanakan secara signifikan kode yang bertanggung jawab untuk memulihkan dari kesalahan selama proses pembaruan perangkat lunak dan OS itu sendiri.  Bahkan, tugas restorasi dipindahkan ke kernel sistem operasi, yang mulai menerapkan <a href="https://ru.wikipedia.org/wiki/ACID">semantik <abbr title="Atomicity, Konsistensi, Isolasi, Daya Tahan">ACID</abbr></a> penuh untuk mengajukan operasi - tanyakan saja. </p><br><p> Untuk mendukung teknologi ini, fungsi API baru ditambahkan yang menggandakan fungsi yang ada, menambahkan satu parameter baru - transaksi.  Transaksi itu sendiri telah menjadi salah satu dari banyak objek kernel di OS, bersama dengan file, proses, dan objek sinkronisasi.  Dalam kasus paling sederhana, urutan tindakan ketika bekerja dengan transaksi terdiri dalam membuat objek transaksi dengan memanggil <a href="https://docs.microsoft.com/ru-ru/windows/win32/api/ktmw32/nf-ktmw32-createtransaction"><code>CreateTransaction</code></a> , bekerja dengan file (menggunakan fungsi seperti <a href="https://docs.microsoft.com/ru-ru/windows/win32/api/winbase/nf-winbase-createfiletransactedw"><code>CreateFileTransacted</code></a> , <a href="https://docs.microsoft.com/ru-ru/windows/win32/api/winbase/nf-winbase-movefiletransactedw"><code>MoveFileTransacted</code></a> , <a href="https://docs.microsoft.com/ru-ru/windows/win32/api/winbase/nf-winbase-deletefiletransactedw"><code>DeleteFileTransacted</code></a> dan sejenisnya), dan menerapkan / memutar kembali transaksi menggunakan <a href="https://docs.microsoft.com/ru-ru/windows/win32/api/ktmw32/nf-ktmw32-committransaction"><code>CommitTransaction</code></a> / <a href="https://docs.microsoft.com/ru-ru/windows/win32/api/ktmw32/nf-ktmw32-rollbacktransaction"><code>RollbackTransaction</code></a> . </p><br><p>  Sekarang mari kita lihat arsitektur dari fitur-fitur ini.  Kita tahu bahwa lapisan API yang terdokumentasi, dari perpustakaan seperti <code>kernel32.dll</code> , tidak secara langsung mentransfer kontrol ke kernel OS, tetapi mengacu pada lapisan abstraksi yang mendasari dalam mode pengguna - <code>ntdll.dll</code> , yang sudah melakukan panggilan sistem.  Dan di sini kejutan menunggu kita: <u>tidak ada duplikasi fungsi untuk bekerja dengan file dalam konteks transaksi di <strong>ntdll</strong> , seperti di kernel</u> . </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ke/ql/5q/keql5q2xtkbwehzymrrnivsniq8.png" alt="Lapisan API"></div><br><p>  Namun demikian, prototipe fungsi-fungsi ini dari API Asli belum berubah sejak dahulu kala, yang berarti mereka akan belajar dari tempat lain dalam konteks transaksi yang akan dilakukan operasi.  Tapi dari mana?  Jawabannya adalah bahwa setiap utas memiliki bidang khusus di mana pegangan transaksi saat ini disimpan.  Area memori di mana ia berada disebut <abbr title="Blok lingkungan thread">TEB</abbr> , blok lingkungan aliran.  Dari hal-hal yang diketahui, <a href="https://docs.microsoft.com/ru-ru/windows/win32/api/errhandlingapi/nf-errhandlingapi-getlasterror">kode kesalahan terakhir</a> dan <a href="https://docs.microsoft.com/ru-ru/windows/win32/api/processthreadsapi/nf-processthreadsapi-getcurrentthreadid">pengidentifikasi aliran</a> juga disimpan di sana. </p><br><p>  Dengan demikian, fungsi dengan suffix <code>*Transacted</code> mengatur bidang transaksi saat ini, memanggil fungsi serupa tanpa suffix, dan kemudian mengembalikan nilai sebelumnya.  Mereka melakukan ini menggunakan sepasang <a href=""><code>RtlSetCurrentTransaction</code></a> / <a href=""><code>RtlSetCurrentTransaction</code></a> dari <code>ntdll</code> .  Kode fungsi itu sendiri sangat mudah, dengan pengecualian pada kasus dengan <abbr title="Windows-on-Windows 64-bit">WoW64</abbr> , yang akan <abbr title="Windows-on-Windows 64-bit">dibahas di</abbr> bawah. </p><br><p>  Apa artinya semua ini bagi kita?  <strong>Dengan mengubah variabel dalam memori proses, kita dapat mengontrol dalam konteks transaksi mana ia bekerja dengan sistem file.</strong>  Anda tidak perlu mengatur jebakan dan panggilan fungsi intersepsi, cukup kirimkan deskriptor transaksi ke proses target dan koreksi beberapa byte dalam memorinya untuk masing-masing utas.  Kedengarannya dasar, mari kita lakukan! </p><br><h2 id="podvodnye-kamni">  Perangkap </h2><br><p>  Eksperimen pertama menunjukkan bahwa idenya bisa diterapkan: <a href="https://farmanager.com/">Far Manager</a> , yang saya gunakan sebagai pengganti Windows Explorer, dengan sempurna selamat dari penggantian transaksi dengan cepat, dan memungkinkan Anda untuk melihat dunia dalam konteksnya.  Tetapi ada juga program yang terus-menerus membuat utas baru untuk operasi file.  Dan dalam skenario asli, ini adalah celah, karena tidak nyaman untuk melacak pembuatan utas di proses lain (belum lagi fakta bahwa "keterlambatan" sangat penting di sini).  Contoh aplikasi dari kelas kedua adalah <a href="https://github.com/microsoft/winfile">WinFile yang</a> baru-baru ini porting. </p><br><h3 id="otslezhivayuschaya-dll">  Pelacakan DLL </h3><br><p>  Untungnya, pelacakan sinkron pembuatan utas dan konfigurasi transaksi berikutnya untuk mereka benar-benar dasar dari dalam proses target.  Cukup dengan menanamkan DLL di dalamnya, dan pemuat modul akan memanggil titik masuknya dengan parameter <a href="https://docs.microsoft.com/ru-ru/windows/win32/dlls/dllmain"><code>DLL_THREAD_ATTACH</code></a> setiap kali ketika membuat utas baru.  Dengan menerapkan fungsi ini, saya memperbaiki kompatibilitas dengan selusin program lagi. </p><br><p>  <strong>*</strong> Secara teknis, panggilan tidak selalu berfungsi, dan perilaku ini terkadang dapat diamati di antarmuka program saya.  Sebagian besar, pengecualian adalah utas dari kumpulan kerja pemuat modul itu sendiri.  Masalahnya adalah pustaka DLL diberitahu di bawah kunci bootloader, dan ini berarti: Anda tidak dapat memuat modul baru saat ini.  Dan thread loader, seperti yang Anda tahu, melakukan hal itu, memparalelkan akses ke sistem file.  Pengecualian diberikan untuk kasus-kasus seperti ini: jika Anda menentukan <a href=""><code>THREAD_CREATE_FLAGS_SKIP_THREAD_ATTACH</code></a> sebagai bendera saat memanggil <a href=""><code>NtCreateThreadEx</code></a> , Anda dapat menghindari menambahkan utas baru ke DLL yang ada, dan, masing-masing, kebuntuan.  Tentang inilah yang terjadi di sini. </p><br><h3 id="zapuskaem-provodnik">  Luncurkan Explorer </h3><br><p>  Masih ada kategori ketiga, program terakhir yang masih macet ketika mencoba membuatnya bekerja di dalam suatu transaksi.  Salah satu dari program ini adalah Windows Explorer.  Saya tidak dapat mendiagnosis masalah secara akurat, tetapi aplikasi ini rumit, dan perpindahan panas di dalam transaksi tidak terlalu berpengaruh.  Mungkin alasannya adalah karena memiliki banyak deskriptor file terbuka, beberapa di antaranya tidak berlaku lagi dalam konteks baru.  Atau mungkin itu sesuatu yang lain.  Dalam situasi seperti itu, memulai kembali proses akan membantu, sehingga berfungsi sejak awal dalam transaksi.  Maka tidak ada inkonsistensi yang muncul. </p><br><p>  Dan oleh karena itu, saya menambahkan kemampuan untuk memulai proses baru pada program, yang untuknya transaksi dan pelacakan arus baru dikonfigurasikan sebelum mencapai titik masuk, sementara prosesnya ditangguhkan.  Dan Anda tahu, itu berhasil!  Benar, karena Explorer secara aktif menggunakan objek COM di luar proses, pratinjau rusak saat memindahkan file.  Tetapi sebaliknya, semuanya stabil. </p><br><h3 id="chto-tam-s-wow64">  Ada apa dengan WoW64? </h3><br><p>  Subsistem ini untuk meluncurkan program 32-bit pada sistem 64-bit adalah alat yang sangat nyaman, tetapi kebutuhan untuk mempertimbangkan fitur-fiturnya sering mempersulit pemrograman sistem.  Saya sebutkan di atas bahwa perilaku <code>Rtl[Get/Set]CurrentTransaction</code> sangat berbeda dalam hal proses serupa.  Alasan untuk ini terletak pada kenyataan bahwa utas dalam proses WoW64 memiliki sebanyak dua blok lingkungan.  Mereka memiliki ukuran pointer yang berbeda, dan diinginkan untuk mempertahankannya dalam keadaan yang konsisten, meskipun, dalam kasus transaksi, TEB 64-bit lebih diutamakan.  Ketika kami melakukan transaksi dari jarak jauh, kami harus mereproduksi perilaku fungsi-fungsi ini.  Ini tidak sulit, tetapi Anda tidak boleh melupakannya, dan detailnya dapat ditemukan di <a href="">sini</a> .  Akhirnya, proses WoW64 memerlukan salinan tambahan 32-bit dari DLL pelacakan kami. </p><br><h3 id="nereshyonnye-problemy">  Masalah yang belum terselesaikan </h3><br><p>  Terpaksa bersedih - skenario paling awal yang muncul di pikiran, yaitu peluncuran program installer dalam mode ini - belum operasional.  Pertama, itu tidak dikonfigurasi untuk menangkap proses anak dalam transaksi yang sama.  Ada beberapa solusi di sini, saya sedang mengerjakan ini.  Tetapi jika aplikasi menciptakan beberapa proses, masih terlalu dini untuk menggunakannya dalam kombinasi dengan transaksi. </p><br><p>  Kedua, kasus dengan file yang dapat dieksekusi yang tidak ada di luar transaksi patut mendapat perhatian khusus.  Saya ingat ada beberapa jenis virus yang menipu antivirus yang naif dengan cara ini: itu dibongkar menjadi suatu transaksi, diluncurkan sendiri, dan kemudian memutar kembali transaksi.  Ada proses, tetapi tidak ada file yang dapat dieksekusi.  Antivirus dapat memutuskan bahwa tidak ada yang dipindai, dan mengabaikan ancaman.  Kita juga perlu mengerjakan solusi kreatif, karena, untuk beberapa alasan, <a href=""><code>NtCreateUserProcess</code></a> (dan, karenanya, <a href="https://docs.microsoft.com/ru-ru/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessw"><code>CreateProcess</code></a> ) mengabaikan transaksi saat ini.  Tentu saja, <a href=""><code>NtCreateProcessEx</code></a> selalu tetap, tetapi banyak kerepotan diharapkan untuk memperbaiki masalah kompatibilitas.  Saya akan memikirkan sesuatu. </p><br><h2 id="prichyom-tut-pesochnicy">  Dan di mana kotak pasirnya? </h2><br><p>  Lihatlah gambarnya.  Di sini, tiga program berbeda memperlihatkan isi folder yang sama dari tiga transaksi berbeda.  Keren kan? </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/9f/ml/ds/9fmldsooc30vlqq7plchzoxystc.png" alt="Pandangan dari dalam transaksi"></div><br><p>  Namun, program saya sama sekali bukan kotak pasir, tidak memiliki satu detail penting - <strong>perbatasan keamanan</strong> .  Tentu saja, ini tidak mencegah beberapa perusahaan menjual kerajinan serupa dengan kedok kotak pasir penuh, memalukan bagi mereka, apa yang bisa saya katakan.  Dan, terlepas dari kenyataan bahwa ini tampaknya benar-benar mustahil, bagaimana kita dapat mencegah suatu program mengubah variabel di memori kita bahkan jika kita bahkan seorang debugger?  - Saya punya satu trik yang menyenangkan di toko yang memungkinkan saya untuk menyelesaikan apa yang saya mulai dan membuat kotak pasir pertama yang saya tahu, yang tidak akan memerlukan driver, tetapi akan memvirtualisasi sistem file.  Sampai saat itu, tunggu pembaruan, gunakan <a href="https://sandboxie.com/">Sandboxie</a> dan bereksperimen dengan teknologi <a href="https://docs.microsoft.com/ru-ru/windows/win32/secauthz/appcontainer-isolation">AppContainer</a> .  Terima kasih atas perhatian anda </p><br><p>  Repositori proyek di GitHub: <strong><a href="https://github.com/diversenok/TransactionMaster">TransactionMaster</a></strong> . <br>  <a href="https://habr.com/en/post/485788/">Artikel yang sama dalam bahasa Inggris</a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id485784/">https://habr.com/ru/post/id485784/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id485768/index.html">Tren Web 2020 Layak Dicoba</a></li>
<li><a href="../id485770/index.html">Polemik salah</a></li>
<li><a href="../id485772/index.html">Dari desktop ke pusat data virtual - bagaimana kami menuju virtualisasi</a></li>
<li><a href="../id485776/index.html">Seluruh geografi: tugas navigasi dan geodetik dalam berbagai bahasa</a></li>
<li><a href="../id485780/index.html">Robot, resonator kuarsa, mikrokontroler ... apa yang dilakukan Epson?</a></li>
<li><a href="../id485786/index.html">Pekerjaan rumah aritmatika</a></li>
<li><a href="../id485790/index.html">Wawancara: harapan vs kenyataan</a></li>
<li><a href="../id485792/index.html">Ivan Lilekvist dan Kim Dotkom, sebuah wawancara besar: kisah Megaupload, ekstradisi ke Amerika Serikat, kebebasan, bitcoin. Bagian 2</a></li>
<li><a href="../id485794/index.html">Apakah Anda mengembangkan .NET Core? Ayo pergi ke Ubuntu, saya sudah menyiapkan semuanya</a></li>
<li><a href="../id485800/index.html">Digitalisasi vs. Otomasi</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>