<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üåó üö© üë®üèΩ‚Äçüè´ GraphQL - API de uma nova maneira üë®üèº‚Äçüç≥ üë®üèº‚Äçüíº ü§öüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Qual √© a linguagem de consulta do GraphQL? Quais vantagens essa tecnologia oferece e quais problemas os desenvolvedores enfrentar√£o ao us√°-la? Como us...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>GraphQL - API de uma nova maneira</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/jugru/blog/428517/">  Qual √© a linguagem de consulta do GraphQL?  Quais vantagens essa tecnologia oferece e quais problemas os desenvolvedores enfrentar√£o ao us√°-la?  Como usar o GraphQL efetivamente?  Sobre tudo isso sob o corte. <br><br><img src="https://habrastorage.org/webt/d4/w4/cg/d4w4cgweq81ewi6vo51e1kbw9tu.jpeg"><br><br>  O artigo √© baseado no relat√≥rio de n√≠vel introdut√≥rio de <b>Vladimir Tsukur</b> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">volodymyrtsukur</a> ) da confer√™ncia <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Joker 2017</a> . <br><a name="habracut"></a><br><iframe width="560" height="315" src="https://www.youtube.com/embed/YgRmgHPTXr4" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Meu nome √© Vladimir, lidero o desenvolvimento de um dos departamentos do WIX.  Mais de cem milh√µes de usu√°rios do WIX criam sites de v√°rias dire√ß√µes - de sites e lojas de cart√µes de visita a aplicativos web complexos, nos quais voc√™ pode escrever c√≥digo e l√≥gica arbitr√°ria.  Como exemplo vivo de um projeto no WIX, gostaria de mostrar a loja de sucesso <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">unicornadoptions.com</a> , que oferece a oportunidade de comprar um kit para domar um unic√≥rnio - um √≥timo presente para uma crian√ßa. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2a9/7ec/db8/2a97ecdb8542ecb4aff1213a5b8690b9.jpg"><br><br>  Um visitante deste site pode escolher um kit que gosta de domar um unic√≥rnio, digamos rosa, e ver o que exatamente est√° neste kit: brinquedo, certificado, crach√°.  Al√©m disso, o comprador tem a oportunidade de adicionar mercadorias √† cesta, visualizar seu conte√∫do e fazer um pedido.  Este √© um exemplo simples de site de loja e temos muitas centenas de milhares desses sites.  Todos eles s√£o criados na mesma plataforma, com um back-end, com um conjunto de clientes que suportamos usando a API para isso.  √â sobre a API que ser√° discutida mais adiante. <br><br><h2>  API simples e seus problemas </h2><br>  Vamos imaginar qual API de uso geral (ou seja, uma API para todas as lojas na parte superior da plataforma) poder√≠amos criar para fornecer a funcionalidade da loja.  Vamos nos concentrar apenas na obten√ß√£o de dados. <br><br>  Para uma p√°gina de produto em tal site, o nome do produto, pre√ßo, fotos, descri√ß√£o, informa√ß√µes adicionais e muito mais devem ser retornados.  Em uma solu√ß√£o completa para lojas no WIX, existem mais de duas d√∫zias desses campos de dados.  A solu√ß√£o padr√£o para uma tarefa desse tipo na API HTTP √© descrever o recurso <code>/products/:id</code> , que retorna os dados do produto na solicita√ß√£o <code>GET</code> .  A seguir, √© apresentado um exemplo de dados de resposta: <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-string"><span class="hljs-string">"59eb83c0040fa80b29938e3f"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Combo Pack with Dreamy Eyes 12\" (Pink) Soft Toy"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"price"</span></span>: <span class="hljs-number"><span class="hljs-number">26.99</span></span>, <span class="hljs-attr"><span class="hljs-attr">"description"</span></span>: <span class="hljs-string"><span class="hljs-string">"Spread Unicorn love amongst your friends and family by purchasing a Unicorn adoption combo pack today. You'll receive your very own fabulous adoption pack and a 12\" Dreamy Eyes (Pink) cuddly toy. It makes the perfect gift for loved ones. Go on, you know you want to, adopt today!"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"sku"</span></span>:<span class="hljs-string"><span class="hljs-string">"010"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"images"</span></span>: [   <span class="hljs-string"><span class="hljs-string">"http://localhost:8080/img/918d8d4cc83d4e5f8680ca4edfd5b6b2.jpg"</span></span>,   <span class="hljs-string"><span class="hljs-string">"http://localhost:8080/img/f343889c0bb94965845e65d3f39f8798.jpg"</span></span>,   <span class="hljs-string"><span class="hljs-string">"http://localhost:8080/img/dd55129473e04f489806db0dc6468dd9.jpg"</span></span>,   <span class="hljs-string"><span class="hljs-string">"http://localhost:8080/img/64eba4524a1f4d5d9f1687a815795643.jpg"</span></span>,   <span class="hljs-string"><span class="hljs-string">"http://localhost:8080/img/5727549e9131440dbb3cd707dce45d0f.jpg"</span></span>,   <span class="hljs-string"><span class="hljs-string">"http://localhost:8080/img/28ae9369ec3c442dbfe6901434ad15af.jpg"</span></span> ] }</code> </pre> <br><img src="https://habrastorage.org/getpro/habr/post_images/ecf/5d6/4ac/ecf5d64acd1da66df56b6aa49f5eb6be.jpg"><br><br>  Vamos dar uma olhada na p√°gina do cat√°logo de produtos agora.  Para esta p√°gina, voc√™ precisa da cole√ß√£o de recursos <i>/ products</i> .  Mas apenas na exibi√ß√£o da cole√ß√£o de produtos na p√°gina do cat√°logo, nem todos os dados do produto s√£o necess√°rios, mas apenas o pre√ßo, o nome e a imagem principal.  Por exemplo, a descri√ß√£o, informa√ß√µes adicionais, imagens de plano de fundo etc. n√£o nos interessam. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/aa4/82b/0ed/aa482b0edf598fcc605eee75216e963b.png"><br><br>  Suponhamos, por simplicidade, que decidamos usar o mesmo modelo de dados do produto para os recursos <code>/products</code> e <code>/products/:id</code> .  No caso de uma cole√ß√£o desses produtos, haver√° potencialmente v√°rios.  O esquema de resposta pode ser representado da seguinte maneira: <br><br><pre> <code class="javascript hljs">GET /products [ {   title   price   images   description   info   ... } ]</code> </pre><br>  Agora, vejamos a "carga √∫til" da resposta do servidor para a cole√ß√£o de produtos.  Aqui est√° o que √© realmente usado pelo cliente entre mais de duas dezenas de campos: <br><br> <code>{ <br> <s>"id": "59eb83c0040fa80b29938e3f",</s> <br> "title": "Combo Pack with Dreamy Eyes 12\" (Pink) Soft Toy", <br> "price": 26.99, <br> <s>"info": "Spread Unicorn love amongst your friends and family by purchasing a Unicorn adoption combo pack today. You'll receive your very own fabulous adoption pack and a 12\" Dreamy Eyes (Pink) cuddly toy. It makes the perfect gift for loved ones. Go on, you know you want to, adopt todayl",</s> <br> " <s>description": "Your fabulous Unicorn adoption combo pack contains:\nA 12\" Dreamy Eyes (Pink) Unicorn Soft Toy\nA blank Unicorn adoption certificate ‚Äî name your Unicorn!\nA confirmation letter\nA Unicorn badge\nA Unicorn key ring\nA Unicorn face mask (self assembly)\nA Unicorn bookmark\nA Unicorn colouring in sheet\nA A4 Unicorn posters\n2 x Unicorn postcards\n3 x Unicorn stickers",</s> <br> "images": [ <br> "http://localhost:8080/img/918d8d4cc83d4e5f8680ca4edfd5b6b2.jpg", <br> <s>"http://localhost:8080/img/f343889c0bb94965845e65d3f39f8798.jpg",</s> <br> <s>"http://localhost:8080/img/dd55129473604f489806db0dC6468dd9.jpg",</s> <br> <s>"http://localhost:8080/img/64eba4524a1f4d5d9f1687a815795643.jpg",</s> <br> <s>"http://localhost:8080/img/5727549e9l3l440dbb3cd707dce45d0f.jpg",</s> <br> <s>"http://localhost:8080/img/28ae9369ec3c442dbfe6901434ad15af.jpg"</s> <br> ], <br> <s>...</s> <br> }</code> <br> <br>  Obviamente, se eu quiser manter o modelo do produto simples retornando os mesmos dados, acabo com um problema de busca excessiva, obtendo, em alguns casos, mais dados do que preciso.  Nesse caso, isso apareceu na p√°gina de cat√°logo do produto, mas, em geral, qualquer tela de interface do usu√°rio que esteja de alguma forma conectada ao produto exigir√° dele apenas parte (e n√£o todos) dos dados. <br><br>  Vamos dar uma olhada na p√°gina do carrinho agora.  Na cesta, al√©m dos pr√≥prios produtos, h√° tamb√©m a quantidade (nesta cesta), pre√ßo e o custo total de todo o pedido: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/653/da1/ad3/653da1ad36872dff8cda2d13b28b5f45.png"><br><br>  Se continuarmos a abordagem de modelagem simples da API HTTP, a cesta poder√° ser representada atrav√©s do recurso <i>/ carrinhos /: id</i> , cuja apresenta√ß√£o se refere aos recursos dos produtos adicionados a esta cesta: <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">"items"</span></span>: [   {     <span class="hljs-attr"><span class="hljs-attr">"product"</span></span>: <span class="hljs-string"><span class="hljs-string">"/products/59eb83c0040fa80b29938e3f"</span></span>,     <span class="hljs-attr"><span class="hljs-attr">"quantity"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>,     <span class="hljs-attr"><span class="hljs-attr">"total"</span></span>: <span class="hljs-number"><span class="hljs-number">26.99</span></span>   },   {     <span class="hljs-attr"><span class="hljs-attr">"product"</span></span>: <span class="hljs-string"><span class="hljs-string">"/products/59eb83c0040fa80b29938e40"</span></span>,     <span class="hljs-attr"><span class="hljs-attr">"quantity"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>,     <span class="hljs-attr"><span class="hljs-attr">"total"</span></span>: <span class="hljs-number"><span class="hljs-number">25.98</span></span>   },   {     <span class="hljs-attr"><span class="hljs-attr">"product"</span></span>: <span class="hljs-string"><span class="hljs-string">"/products/59eb88bd040fa8125aa9c400"</span></span>,     <span class="hljs-attr"><span class="hljs-attr">"quantity"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>,     <span class="hljs-attr"><span class="hljs-attr">"total"</span></span>: <span class="hljs-number"><span class="hljs-number">26.99</span></span>   } ], <span class="hljs-attr"><span class="hljs-attr">"subTotal"</span></span>: <span class="hljs-number"><span class="hljs-number">79.96</span></span> }</code> </pre><br>  Agora, por exemplo, para desenhar uma cesta com tr√™s produtos no front-end, voc√™ precisa fazer quatro solicita√ß√µes: uma para carregar a pr√≥pria cesta e tr√™s solicita√ß√µes para carregar dados do produto (nome, pre√ßo e n√∫mero de SKU). <br><br>  O segundo problema que tivemos √© a busca insuficiente.  A diferencia√ß√£o de responsabilidades entre a cesta e os recursos do produto levou √† necessidade de fazer solicita√ß√µes adicionais.  Obviamente, h√° v√°rias desvantagens aqui: devido <i>a um</i> n√∫mero maior de solicita√ß√µes, pousamos a bateria do celular mais rapidamente e obtemos a resposta completa mais lentamente.  E a escalabilidade da nossa solu√ß√£o tamb√©m levanta quest√µes. <br><br>  Obviamente, esta solu√ß√£o n√£o √© adequada para produ√ß√£o.  Uma maneira de se livrar do problema √© adicionar suporte de proje√ß√£o para a cesta.  Uma dessas proje√ß√µes poderia, al√©m dos dados da pr√≥pria cesta, retornar dados sobre produtos.  Al√©m disso, essa proje√ß√£o ser√° muito espec√≠fica, pois √© na p√°gina da cesta que voc√™ precisa do n√∫mero de invent√°rio (SKU) do produto.  Em nenhum outro lugar o SKU era necess√°rio em qualquer outro lugar. <br><br><pre> <code class="plaintext hljs">GET /carts/1?projection=with-products</code> </pre> <br><img src="https://habrastorage.org/getpro/habr/post_images/a5f/3d7/901/a5f3d7901a3d60622575ae1fdf6787d1.png"><br><br>  Esse "ajuste" de recursos para uma interface do usu√°rio espec√≠fica geralmente n√£o termina, e come√ßamos a gerar outras proje√ß√µes: informa√ß√µes breves na cesta, a proje√ß√£o da cesta para a web m√≥vel e, depois disso, a proje√ß√£o para unic√≥rnios. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/9ff/6b5/dad/9ff6b5dad7ee3ec4e7d95790dcd2eb05.png"><br><br>  (Em geral, no WIX Designer, voc√™ como usu√°rio pode configurar quais dados do produto voc√™ deseja exibir na p√°gina do produto e quais dados mostrar na cesta) <br><br>  E aqui as dificuldades nos esperam: estamos emoldurando o jardim e procurando solu√ß√µes complexas.  Existem poucas solu√ß√µes padr√£o do ponto de vista da API para essa tarefa e geralmente dependem muito da estrutura ou da biblioteca de descri√ß√£o de recursos HTTP. <br><br>  O que √© ainda mais importante, agora est√° ficando mais dif√≠cil trabalhar, porque quando os requisitos do lado do cliente mudam, o back-end deve constantemente "acompanhar" e satisfaz√™-los. <br><br>  Como uma ‚Äúcereja no bolo‚Äù, vejamos outra quest√£o importante.  No caso de uma API HTTP simples, o desenvolvedor do servidor n√£o tem id√©ia de que tipo de dados o cliente est√° usando.  O pre√ßo √© usado?  Descri√ß√£o?  Uma ou todas as imagens? <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1f1/943/2d4/1f19432d49f8577cc70197bdb74a7987.png"><br><br>  Nesse sentido, v√°rias quest√µes surgem.  Como trabalhar com dados obsoletos / obsoletos?  Como sei quais dados n√£o est√£o mais sendo usados?  Como √© relativamente seguro remover dados da resposta sem interromper a maioria dos clientes?  N√£o h√° resposta para essas perguntas com a API HTTP usual.  Apesar de estarmos otimistas e a API parecer simples, a situa√ß√£o n√£o parece t√£o quente.  Esse intervalo de problemas de API n√£o √© exclusivo do WIX.  Um grande n√∫mero de empresas teve que lidar com eles.  Agora, √© interessante procurar uma solu√ß√£o em potencial. <br><br><h2>  GraphQL.  Iniciar </h2><br>  Em 2012, no processo de desenvolvimento de um aplicativo m√≥vel, o Facebook enfrentou um problema semelhante.  Os engenheiros queriam atingir o n√∫mero m√≠nimo de chamadas de aplicativos m√≥veis para o servidor, enquanto em cada etapa eles recebiam apenas os dados necess√°rios e nada al√©m deles.  O resultado de seus esfor√ßos foi o GraphQL, apresentado na confer√™ncia React Conf 2015.  O GraphQL √© uma linguagem de descri√ß√£o de consulta, bem como um ambiente de tempo de execu√ß√£o para essas consultas. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/052/9fc/00c/0529fc00c59b43faf40c8cbd4064d1ac.png"><br><br>  Considere uma abordagem t√≠pica para trabalhar com servidores GraphQL. <br><br><h3>  N√≥s descrevemos o esquema </h3><br>  O esquema de dados no GraphQL define os tipos e relacionamentos entre eles e o faz de uma maneira fortemente tipada.  Por exemplo, imagine um modelo simples de rede social.  <code>User</code> conhece amigos <code>friends</code> .  Os usu√°rios moram na cidade e a cidade conhece seus habitantes atrav√©s do campo de <code>citizens</code> .  Aqui est√° o gr√°fico de um modelo desse tipo no GraphQL: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ae4/5e8/2e9/ae45e82e9610ff7abb7291fbe4671062.png"><br><br>  Obviamente, para que o gr√°fico seja √∫til, tamb√©m s√£o necess√°rios os chamados "pontos de entrada".  Por exemplo, esse ponto de entrada pode estar recebendo um usu√°rio pelo nome. <br><br><h3>  Solicitar dados </h3><br>  Vamos ver qual √© a ess√™ncia da linguagem de consulta GraphQL.  Vamos traduzir esta pergunta para este idioma: <i>‚ÄúPara um usu√°rio chamado Vanya Unicorn, quero saber os nomes de seus amigos, bem como o nome e a popula√ß√£o da cidade em que Vanya vive‚Äù</i> : <br><br><pre> <code class="javascript hljs">{ user(name: <span class="hljs-string"><span class="hljs-string">"Vanya Unicorn"</span></span>) {   friends {     name   }   city {     name     population   } } }</code> </pre> <br>  E aqui vem a resposta do servidor GraphQL: <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"data"</span></span>: {   <span class="hljs-attr"><span class="hljs-attr">"user"</span></span>: {     <span class="hljs-attr"><span class="hljs-attr">"friends"</span></span>: [       { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Lena"</span></span> },       { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Stas"</span></span> }     ]     <span class="hljs-string"><span class="hljs-string">"city"</span></span>: {       <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Kyiv"</span></span>,       <span class="hljs-attr"><span class="hljs-attr">"population"</span></span>: <span class="hljs-number"><span class="hljs-number">2928087</span></span>     }   } } }</code> </pre><br>  Observe como o formul√°rio de solicita√ß√£o √© "consoante" com o formul√°rio de resposta.  Parece que essa linguagem de consulta foi criada para JSON.  Com digita√ß√£o forte.  E tudo isso √© feito em uma solicita√ß√£o HTTP POST - n√£o √© necess√°rio fazer v√°rias chamadas para o servidor. <br><br>  Vamos ver como fica na pr√°tica.  Vamos abrir o console padr√£o para o servidor GraphQL, chamado Graph <i>i</i> QL ("graph").  Para solicitar uma cesta, preencherei a seguinte solicita√ß√£o: <i>"Quero obter uma cesta pelo identificador 1, estou interessado em todas as posi√ß√µes dessa cesta e nas informa√ß√µes do produto.</i>  <i>A partir das informa√ß√µes, o nome, o pre√ßo, o n√∫mero do invent√°rio e as imagens s√£o importantes (e apenas o primeiro).</i>  <i>Tamb√©m estou interessado na quantidade desses produtos, qual √© o pre√ßo e o custo total da cesta "</i> . <br><br><pre> <code class="javascript hljs">{ cart(id: <span class="hljs-number"><span class="hljs-number">1</span></span>) {   items {     product {       title       price       sku       images(limit: <span class="hljs-number"><span class="hljs-number">1</span></span>)     }     quantity     total   }   subTotal } }</code> </pre> <br>  Ap√≥s a conclus√£o bem-sucedida da solicita√ß√£o, obtemos exatamente o que foi solicitado: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/cf7/c04/a8e/cf7c04a8ef9d309387a6bcc935d40d10.png"><br><br><h2>  Principais Benef√≠cios </h2><br><ul><li>  <b>Amostragem flex√≠vel.</b>  O cliente pode fazer uma solicita√ß√£o de acordo com seus requisitos espec√≠ficos. <br></li><li>  <b>Amostragem eficaz.</b>  A resposta retorna apenas os dados solicitados. <br></li><li>  <b>Desenvolvimento mais r√°pido.</b>  Muitas mudan√ßas no cliente podem ocorrer sem a necessidade de alterar nada no lado do servidor.  Por exemplo, com base em nosso exemplo, voc√™ pode mostrar facilmente uma visualiza√ß√£o diferente da cesta da Web para dispositivos m√≥veis. <br></li><li>  <b>An√°lise √∫til.</b>  Como o cliente deve indicar os campos explicitamente na solicita√ß√£o, o servidor sabe exatamente quais campos s√£o realmente necess√°rios.  E essas s√£o informa√ß√µes importantes para a pol√≠tica de descontinua√ß√£o. <br></li><li>  <b>Funciona sobre qualquer fonte de dados e transporte.</b>  √â importante que o GraphQL permita que voc√™ trabalhe sobre qualquer fonte de dados e qualquer transporte.  Nesse caso, o HTTP n√£o √© uma panac√©ia, o GraphQL tamb√©m pode funcionar atrav√©s do WebSocket e abordaremos esse ponto um pouco mais tarde. <br></li></ul><br>  Hoje, um servidor GraphQL pode ser fabricado em praticamente qualquer idioma.  A vers√£o mais completa do servidor <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">GraphQL</a> √© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">GraphQL.js</a> para a plataforma Node.  Na comunidade Java, a implementa√ß√£o de refer√™ncia √© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">GraphQL Java</a> . <br><br><h2>  Crie a API GraphQL </h2><br>  Vamos ver como criar um servidor GraphQL em um exemplo de vida concreto. <br><br>  Considere uma vers√£o simplificada de uma loja online com base em uma arquitetura de microsservi√ßo com dois componentes: <br><br><ul><li>  Servi√ßo de carrinho que fornece trabalho com uma cesta personalizada.  Armazena dados em um banco de dados relacional e usa SQL para acessar dados.  Servi√ßo muito simples, sem muita magia :) <br></li><li>  Servi√ßo de produto que fornece acesso ao cat√°logo de produtos, a partir do qual, de fato, a cesta est√° cheia.  Fornece uma API HTTP para acessar dados do produto. <br></li></ul><br>  Ambos os servi√ßos s√£o implementados sobre o cl√°ssico Spring Boot e j√° cont√™m toda a l√≥gica b√°sica. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5f0/1e9/560/5f01e95602be2c3d88178f1327f791c6.png"><br><br>  Pretendemos criar a API GraphQL sobre o servi√ßo Cart.  Essa API foi projetada para fornecer acesso aos dados da cesta e aos produtos adicionados a ela. <br><br><h3>  Primeira vers√£o </h3><br>  A implementa√ß√£o de refer√™ncia GraphQL para o ecossistema Java, que mencionamos anteriormente - GraphQL Java, nos ajudar√°. <br><br>  Adicione algumas depend√™ncias ao <code>pom.xml:</code> <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span>   <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>com.graphql-java<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>   <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>graphql-java<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>   <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>9.3<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span>   <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>com.graphql-java<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>   <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>graphql-java-tools<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>   <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>5.2.4<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span>   <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>com.graphql-java<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>   <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>graphql-spring-boot-starter<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>   <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>5.0.2<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span>   <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>com.graphql-java<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>   <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>graphiql-spring-boot-starter<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>   <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>5.0.2<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Al√©m do <code>graphql-java</code> mencionado anteriormente <code>graphql-java</code> precisaremos de uma biblioteca de <code>graphql-java-tools,</code> bem como dos ‚Äúiniciantes‚Äù do Spring Boot para GraphQL, que simplificar√£o bastante os primeiros passos para criar um servidor GraphQL: <br><br><ul><li>  <i>O graphql-spring-boot-starter</i> fornece um mecanismo para conectar rapidamente o GraphQL Java ao Spring Boot; <br></li><li>  <i>O graphiql-spring-boot-starter</i> adiciona um console da web interativo Graph <i>i</i> QL para executar consultas GraphQL. <br></li></ul><br>  O pr√≥ximo passo importante √© determinar o esquema de servi√ßo graphQL, nosso gr√°fico.  Os n√≥s deste gr√°fico s√£o descritos usando <i>tipos</i> e as arestas usando <i>campos</i> .  Uma defini√ß√£o de gr√°fico vazia √© assim: <br><br><pre> <code class="javascript hljs">schema { }</code> </pre> <br>  Nesse mesmo esquema, como voc√™ se lembra, existem "pontos de entrada" ou consultas de n√≠vel superior.  Eles s√£o definidos atrav√©s do campo de <i>consulta</i> no esquema.  Ligue para o nosso tipo de <i>pontos de</i> entrada <i>EntryPoints</i> : <br><br><pre> <code class="javascript hljs">schema { <span class="hljs-attr"><span class="hljs-attr">query</span></span>: EntryPoints }</code> </pre><br>  Definimos nela uma pesquisa de cesta por identificador como o primeiro ponto de entrada: <br><br><pre> <code class="javascript hljs">type EntryPoints { cart(id: Long!): Cart }</code> </pre><br>  <code>Cart</code> nada mais √© do que um <i>campo</i> em termos do GraphQL.  <code>id</code> √© um par√¢metro desse campo com o tipo escalar <code>Long</code> .  Ponto de exclama√ß√£o <code>!</code>  depois de especificar o tipo significa que o par√¢metro √© necess√°rio. <br><br>  √â hora de identificar e digitar o <code>Cart</code> : <br><br><pre> <code class="javascript hljs">type Cart { <span class="hljs-attr"><span class="hljs-attr">id</span></span>: Long! items: [CartItem!]! subTotal: BigDecimal! }</code> </pre><br>  Al√©m da <code>id</code> padr√£o, a cesta inclui seus elementos de itens e a quantia para todos os produtos <code>subTotal</code> .  Observe que os <i>itens s√£o</i> definidos como uma lista, conforme indicado entre colchetes <code>[]</code> .  Os elementos desta lista s√£o os tipos <code>CartItem</code> .  A presen√ßa de um ponto de exclama√ß√£o ap√≥s o nome do tipo de campo <code>!</code>  indica que o campo √© obrigat√≥rio.  Isso significa que o servidor concorda em retornar um valor n√£o vazio para esse campo, se um tiver sido solicitado. <br><br>  Resta examinar a defini√ß√£o do tipo <code>CartItem</code> , que inclui um link para o produto ( <i>productId</i> ), quantas vezes ele √© adicionado √† cesta ( <code>quantity</code> ) e a quantidade do produto, calculada no n√∫mero ( <code>total</code> ): <br><br><pre> <code class="javascript hljs">type CartItem { <span class="hljs-attr"><span class="hljs-attr">productId</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>! quantity: Int! total: BigDecimal! }</code> </pre><br>  Tudo √© simples aqui - todos os campos dos tipos escalares s√£o obrigat√≥rios. <br><br>  Este esquema n√£o foi escolhido por acaso.  O servi√ßo Cart j√° definiu a cesta do carrinho e seus elementos <code>CartItem</code> com exatamente os mesmos nomes e tipos de campos do esquema GraphQL.  O modelo de carrinho usa a biblioteca Lombok para gerar automaticamente getters / setters, construtores e outros m√©todos.  O JPA √© usado para persist√™ncia no banco de dados. <br><br>  Classe do <code>Cart</code> : <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> lombok.Data; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.persistence.*; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.math.BigDecimal; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.ArrayList; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.List; <span class="hljs-meta"><span class="hljs-meta">@Entity</span></span> <span class="hljs-meta"><span class="hljs-meta">@Data</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Cart</span></span></span><span class="hljs-class"> </span></span>{   <span class="hljs-meta"><span class="hljs-meta">@Id</span></span>   <span class="hljs-meta"><span class="hljs-meta">@GeneratedValue</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Long id;   <span class="hljs-meta"><span class="hljs-meta">@ElementCollection</span></span>(fetch = FetchType.EAGER)   <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;CartItem&gt; items = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;&gt;();   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> BigDecimal </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getSubTotal</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{       <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> getItems().stream()               .map(Item::getTotal)               .reduce(BigDecimal.ZERO, BigDecimal::add);   } }</code> </pre><br>  Classe <code>CartItem</code> : <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> lombok.AllArgsConstructor; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> lombok.Data; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.persistence.Column; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.persistence.Embeddable; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.math.BigDecimal; <span class="hljs-meta"><span class="hljs-meta">@Embeddable</span></span> <span class="hljs-meta"><span class="hljs-meta">@Data</span></span> <span class="hljs-meta"><span class="hljs-meta">@AllArgsConstructor</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CartItem</span></span></span><span class="hljs-class"> </span></span>{   <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(nullable = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)   <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String productId;   <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(nullable = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)   <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> quantity;   <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(nullable = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)   <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> BigDecimal total; }</code> </pre><br>  Portanto, os elementos basket ( <code>Cart</code> ) e basket ( <code>CartItem</code> ) s√£o descritos no diagrama GraphQL e no c√≥digo e s√£o ‚Äúcompat√≠veis‚Äù entre si de acordo com o conjunto de campos e seus tipos.  Mas isso ainda n√£o √© suficiente para o nosso servi√ßo funcionar. <br><br>  Precisamos esclarecer exatamente como o ponto de entrada " <code>cart(id: Long!): Cart</code> " funcionar√°.  Para fazer isso, crie uma configura√ß√£o Java extremamente simples para o Spring com um bean do tipo GraphQLQueryResolver.  GraphQLQueryResolver descreve apenas os "pontos de entrada" no esquema.  Definimos um m√©todo com um nome id√™ntico ao campo no ponto de entrada ( <code>cart</code> ), o tornamos compat√≠vel com o tipo de par√¢metros e usamos <code>cartService</code> para encontrar o mesmo carrinho por identificador: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> GraphQLQueryResolver </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">queryResolver</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GraphQLQueryResolver () {       <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Cart </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cart</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Long id)</span></span></span><span class="hljs-function"> </span></span>{           <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cartService.findCart(id);       }   } }</code> </pre><br>  Essas mudan√ßas s√£o suficientes para obtermos um aplicativo funcional.  Ap√≥s reiniciar o servi√ßo Cart no console do GraphiQL, a seguinte consulta come√ßar√° a ser executada com √™xito: <br><br><pre> <code class="javascript hljs">{ cart(id: <span class="hljs-number"><span class="hljs-number">1</span></span>) {   items {     productId     quantity     total   }   subTotal } }</code> </pre> <br><h3>  Nota </h3><br><ul><li>  Usamos os tipos escalares <code>Long</code> e <code>String</code> como identificadores exclusivos para a cesta e o produto.  O GraphQL possui um tipo especial para esses prop√≥sitos - <code>ID</code> .  Semanticamente, essa √© uma escolha melhor para uma API real.  Valores do tipo <code>ID</code> podem ser usados ‚Äã‚Äãcomo uma chave para armazenamento em cache. <br></li><li>  Nesta fase do desenvolvimento de nossa aplica√ß√£o, os modelos de dom√≠nio interno e externo s√£o completamente id√™nticos.  Estamos falando das <code>CartItem</code> <code>Cart</code> e <code>CartItem</code> e seu uso direto nos resolvedores do GraphQL.  Em aplica√ß√µes de combate, recomenda-se que esses modelos sejam separados.  Para os resolvedores do GraphQL, um modelo separado da √°rea de assunto interna deve existir. <br></li></ul><br><h3>  Tornando a API √∫til </h3><br>  Ent√£o, obtivemos o primeiro resultado, e isso √© maravilhoso.  Mas agora nossa API √© muito primitiva.  Por exemplo, at√© o momento n√£o h√° como solicitar dados √∫teis sobre um produto, como nome, pre√ßo, artigo, fotos e assim por diante.  Em vez disso, existe apenas um <code>productId</code> .  Vamos tornar a API realmente √∫til e adicionar suporte completo ao conceito do produto.  Aqui est√° a apar√™ncia de sua defini√ß√£o no diagrama: <br><br><pre> <code class="javascript hljs">type Product { <span class="hljs-attr"><span class="hljs-attr">id</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>! title: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>! price: BigDecimal! description: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> sku: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>! images: [<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>!]! }</code> </pre><br>  Inclua o campo obrigat√≥rio em <code>CartItem</code> e <code>productId</code> campo productId como obsoleto: <br><br><pre> <code class="javascript hljs">type Item { <span class="hljs-attr"><span class="hljs-attr">quantity</span></span>: Int! product: Product! productId: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>! @deprecated(reason: <span class="hljs-string"><span class="hljs-string">"don't use it!"</span></span>) total: BigDecimal! }</code> </pre> <br>  N√≥s descobrimos o esquema.  E agora √© hora de descrever como a sele√ß√£o para o campo do <code>product</code> funcionar√°.  Anteriormente, <code>CartItem</code> com getters nas <code>CartItem</code> <code>Cart</code> e <code>CartItem</code> , o que permitia ao GraphQL Java vincular valores automaticamente.  Mas aqui deve ser lembrado que apenas a propriedade do <code>product</code> na classe <code>CartItem</code> n√£o <code>CartItem</code> : <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Embeddable</span></span> <span class="hljs-meta"><span class="hljs-meta">@Data</span></span> <span class="hljs-meta"><span class="hljs-meta">@AllArgsConstructor</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CartItem</span></span></span><span class="hljs-class"> </span></span>{   <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(nullable = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)   <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String productId;   <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(nullable = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)   <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> quantity;   <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(nullable = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)   <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> BigDecimal total; }</code> </pre><br>  Temos uma escolha: <br><br><ol><li>  Adicione a propriedade do <i>produto</i> ao <i>CartItem</i> e "ensine" como receber dados do produto; <br></li><li>  Determine como obter o <i>produto</i> sem alterar a classe <i>CartItem</i> . <br></li></ol><br>  A segunda maneira √© prefer√≠vel, porque o modelo da descri√ß√£o do dom√≠nio interno (classe <code>CartItem</code> ) nesse caso n√£o ser√° abordado com detalhes da implementa√ß√£o da API Graph <i>i</i> QL. <br><br>  Para atingir esse objetivo, a interface do marcador GraphQLResolver ajudar√°.  Ao implement√°-lo, voc√™ pode determinar (ou substituir) como obter os valores do campo para o tipo <code>T</code>  √â assim que o bean correspondente se parece na configura√ß√£o do Spring: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> GraphQLResolver&lt;CartItem&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cartItemResolver</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GraphQLResolver&lt;CartItem&gt;() {       <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Product </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">product</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CartItem item)</span></span></span><span class="hljs-function"> </span></span>{           <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> http.getForObject(<span class="hljs-string"><span class="hljs-string">"http://localhost:9090/products/{id}"</span></span>,                   Product.class,                   item.getProductId());       }   }; }</code> </pre> <br>  O nome do m√©todo do <code>product</code> n√£o foi escolhido por acaso.  O GraphQL Java est√° procurando m√©todos de download de dados pelo nome do campo, e n√≥s apenas precisamos definir um carregador para o campo do <code>product</code> !  Um objeto do tipo <code>CartItem</code> passado como par√¢metro define o contexto em que o produto √© selecionado.  Em seguida √© uma quest√£o de tecnologia.  Usando um cliente <code>http</code> , como <code>RestTemplate</code> fazemos uma solicita√ß√£o GET para o servi√ßo Produto e convertemos o resultado em <code>Product</code> , que se parece com isso: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Data</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Product</span></span></span><span class="hljs-class"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String id;   <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String title;   <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> BigDecimal price;   <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String description;   <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String sku;   <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;String&gt; images; }</code> </pre> <br>  Essas altera√ß√µes devem ser suficientes para implementar uma amostra mais interessante, que inclui o verdadeiro relacionamento entre a cesta e os produtos adicionados a ela. <br><br>  Ap√≥s reiniciar o aplicativo, voc√™ pode tentar uma nova consulta no console do Graph <i>i</i> QL. <br><br><pre> <code class="javascript hljs">{ cart(id: <span class="hljs-number"><span class="hljs-number">1</span></span>) {   items {     product {       title       price       sku       images     }     quantity     total   }   subTotal } }</code> </pre><br>  E aqui est√° o resultado da execu√ß√£o da consulta: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0c8/778/3f4/0c87783f4f843696b9900771c2b2860e.png"><br><br>  Embora <code>productId</code> sido marcado como <code>@deprecated</code> , as consultas indicando esse campo continuar√£o funcionando.  Mas o console do Graph <i>i</i> QL n√£o oferecer√° preenchimento autom√°tico para esses campos e destacar√° seu uso de uma maneira especial: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/afc/96a/d45/afc96ad45f3f4372a8e86cf78b892acd.png"><br><br>  √â hora de mostrar o Document Explorer, parte do console do Graph <i>i</i> QL, que √© constru√≠do com base no esquema GraphQL e exibe informa√ß√µes sobre todos os tipos definidos.  Aqui est√° a apar√™ncia do Document Explorer para o tipo <code>CartItem</code> : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f83/c04/38b/f83c0438b2f906b34414b764182a37fc.png"><br><br>  Mas voltando ao exemplo.  Para obter a mesma funcionalidade da primeira demonstra√ß√£o, ainda n√£o h√° limite suficiente para o n√∫mero de imagens retornadas.  De fato, para uma cesta, por exemplo, voc√™ precisa de apenas uma imagem para cada produto: <br><br><pre> <code class="javascript hljs">images(limit: <span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre> <br>  Para fazer isso, altere o esquema e adicione um novo par√¢metro para o campo <i>images</i> ao tipo <i>Product</i> : <br><br><pre> <code class="javascript hljs">type Product { <span class="hljs-attr"><span class="hljs-attr">id</span></span>: ID! title: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>! price: BigDecimal! description: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> sku: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>! images(limit: Int = <span class="hljs-number"><span class="hljs-number">0</span></span>): [<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>!]! }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">E no c√≥digo do aplicativo, vamos us√°-lo novamente </font></font><code>GraphQLResolver</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, apenas desta vez por tipo </font></font><code>Product</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> GraphQLResolver&lt;Product&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">productResolver</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GraphQLResolver&lt;Product&gt;() {       <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> List&lt;String&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">images</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Product product, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> limit)</span></span></span><span class="hljs-function"> </span></span>{           List&lt;String&gt; images = product.getImages();           <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> normalizedLimit = limit &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> ? limit : images.size();           <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> images.subList(<span class="hljs-number"><span class="hljs-number">0</span></span>, Math.min(normalizedLimit, images.size()));       }   }; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mais uma vez, chamo a aten√ß√£o para o fato de o nome do m√©todo n√£o ser acidental: ele coincide com o nome do campo </font></font><code>images</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">O objeto de contexto </font></font><code>Product</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fornece acesso √†s imagens e </font></font><code>limit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√© um par√¢metro do pr√≥prio campo. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se o cliente n√£o especificou nada como o valor </font></font><code>limit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, nosso servi√ßo retornar√° todas as imagens do produto. </font><font style="vertical-align: inherit;">Se o cliente especificou um valor espec√≠fico, o servi√ßo retornar√° exatamente o mesmo (mas n√£o mais do que existe no produto). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Compilamos o projeto e esperamos at√© o servidor reiniciar. </font><font style="vertical-align: inherit;">Reiniciando o circuito no console e executando a solicita√ß√£o, vemos que uma solicita√ß√£o completa realmente funciona.</font></font><br><br><pre> <code class="javascript hljs">{ cart(id: <span class="hljs-number"><span class="hljs-number">1</span></span>) {   items {     product {       title       price       sku       images(limit: <span class="hljs-number"><span class="hljs-number">1</span></span>)     }     quantity     total   }   subTotal } }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Concordo, tudo isso √© muito legal. </font><font style="vertical-align: inherit;">Em pouco tempo, aprendemos n√£o apenas o que √© o GraphQL, mas tamb√©m transferimos um sistema simples de microsservi√ßo para suportar essa API. </font><font style="vertical-align: inherit;">E n√£o nos importava de onde vinham os dados: as APIs SQL e HTTP se encaixavam bem sob o mesmo teto.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Abordagem Code-First e GraphQL SPQR </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Voc√™ deve ter notado que durante o processo de desenvolvimento houve alguns inconvenientes, como a necessidade de manter constantemente o esquema e o c√≥digo do GraphQL em sincronia. As altera√ß√µes de tipo sempre tinham que ser feitas em dois lugares. Em muitos casos, √© mais conveniente usar a abordagem de primeiro c√≥digo. Sua ess√™ncia √© que o esquema para o GraphQL √© gerado automaticamente a partir do c√≥digo. Nesse caso, voc√™ n√£o precisa manter o circuito separadamente. Agora vou mostrar como fica. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apenas os recursos b√°sicos do GraphQL Java n√£o s√£o suficientes para n√≥s, tamb√©m precisaremos da biblioteca GraphQL SPQR. A boa not√≠cia √© que o GraphQL SPQR √© um complemento para o GraphQL Java, e n√£o uma implementa√ß√£o alternativa do servidor GraphQL em Java. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adicione a depend√™ncia desejada a </font></font><code>pom.xml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span>   <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>io.leangen.graphql<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>   <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>spqr<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>   <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>0.9.8<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Aqui est√° o c√≥digo que implementa a mesma funcionalidade baseada em GraphQL SPQR para a cesta: </font></font><br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Component</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CartGraph</span></span></span><span class="hljs-class"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> CartService cartService;   <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span>   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CartGraph</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CartService cartService)</span></span></span><span class="hljs-function"> </span></span>{       <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.cartService = cartService;   }   <span class="hljs-meta"><span class="hljs-meta">@GraphQLQuery</span></span>(name = <span class="hljs-string"><span class="hljs-string">"cart"</span></span>)   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Cart </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cart</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@GraphQLArgument(name = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"id"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> Long id) </span></span>{       <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cartService.findCart(id);   } }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> E para o produto: </font></font><br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Component</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProductGraph</span></span></span><span class="hljs-class"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> RestTemplate http;   <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span>   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProductGraph</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(RestTemplate http)</span></span></span><span class="hljs-function"> </span></span>{       <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.http = http;   }   <span class="hljs-meta"><span class="hljs-meta">@GraphQLQuery</span></span>(name = <span class="hljs-string"><span class="hljs-string">"product"</span></span>)   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Product </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">product</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@GraphQLContext CartItem cartItem)</span></span></span><span class="hljs-function"> </span></span>{       <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> http.getForObject(               <span class="hljs-string"><span class="hljs-string">"http://localhost:9090/products/{id}"</span></span>,               Product.class,               cartItem.getProductId()       );   }   <span class="hljs-meta"><span class="hljs-meta">@GraphQLQuery</span></span>(name = <span class="hljs-string"><span class="hljs-string">"images"</span></span>)   <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> List&lt;String&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">images</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@GraphQLContext Product product,                              @GraphQLArgument(name = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"limit"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, defaultValue = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"0"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> limit) </span></span>{       List&lt;String&gt; images = product.getImages();       <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> normalizedLimit = limit &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> ? limit : images.size();       <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> images.subList(<span class="hljs-number"><span class="hljs-number">0</span></span>, Math.min(normalizedLimit, images.size()));   } }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A anota√ß√£o @GraphQLQuery √© usada para sinalizar m√©todos do carregador de campo. </font><font style="vertical-align: inherit;">A anota√ß√£o </font></font><code>@GraphQLContext</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">define o tipo de sele√ß√£o para o campo. </font><font style="vertical-align: inherit;">E a anota√ß√£o </font></font><code>@GraphQLArgument</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">marca claramente os par√¢metros do argumento. </font><font style="vertical-align: inherit;">Tudo isso faz parte de um mecanismo que ajuda o GraphQL SPQR a gerar um esquema automaticamente. </font><font style="vertical-align: inherit;">Agora, se voc√™ excluir a configura√ß√£o e o esquema Java antigos, reinicie o servi√ßo Cart usando os novos chips do GraphQL SPQR, assegure-se de que tudo funcione funcionalmente da mesma maneira que antes.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Resolvemos o problema de N + 1 </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√â hora de olhar para b </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">em</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> detalhe lshih como a implementa√ß√£o de todo o pedido "sob a capa". Criamos rapidamente a API GraphQL, mas ela est√° funcionando com efici√™ncia? </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Considere o seguinte exemplo: </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/05c/626/303/05c62630323d9ad9eeb97999c19fcd04.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Obter a cesta </font></font><code>cart</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">acontece em uma consulta SQL ao banco de dados. Os dados </font></font><code>items</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s√£o </font></font><code>subtotal</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">retornados l√°, porque os elementos da cesta s√£o carregados com toda a cole√ß√£o, com base na estrat√©gia JPA de busca r√°pida:</font></font><br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Data</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Cart</span></span></span><span class="hljs-class"> </span></span>{   <span class="hljs-meta"><span class="hljs-meta">@ElementCollection</span></span>(fetch = FetchType.EAGER)   <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;Item&gt; items = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;&gt;();   ... }</code> </pre> <br><img src="https://habrastorage.org/getpro/habr/post_images/674/0e4/863/6740e4863b4847f782f64588e52ecc36.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quando se trata de baixar dados de produtos, as solicita√ß√µes de servi√ßo do Produto ser√£o executadas exatamente da mesma forma que nesta cesta de produtos. Se houver tr√™s produtos diferentes na cesta, receberemos tr√™s solicita√ß√µes para a API HTTP do servi√ßo do produto e, se houver dez, o mesmo servi√ßo ter√° que responder a dez solicita√ß√µes. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/92c/9c0/b1a/92c9c0b1a06c15f081c0eb9dc9ce8a1f.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aqui est√° a comunica√ß√£o entre o servi√ßo Carrinho e o servi√ßo Produto no Charles Proxy: </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/c15/8df/d08/c158dfd08badf133f49499baa43c1970.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Portanto, voltamos ao problema cl√°ssico de N + 1. Exatamente aquele do qual eles tentaram tanto fugir no come√ßo do relat√≥rio. Sem d√∫vida, temos progresso, porque exatamente uma solicita√ß√£o √© executada entre o cliente final e nosso sistema. Mas dentro do ecossistema de servidores, o desempenho claramente precisa ser aprimorado.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quero resolver esse problema obtendo todos os produtos certos em uma solicita√ß√£o. </font><font style="vertical-align: inherit;">Felizmente, o servi√ßo Produto j√° suporta esse recurso por meio de um par√¢metro </font></font><code>ids</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no recurso de coleta:</font></font><br><br><pre> <code class="plaintext hljs">GET /products?ids=:id1,:id2,...,:idn</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vamos ver como voc√™ pode modificar o c√≥digo do m√©todo de amostra para o campo do </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">produto</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Vers√£o anterior:</font></font><br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@GraphQLQuery</span></span>(name = <span class="hljs-string"><span class="hljs-string">"product"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Product </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">product</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@GraphQLContext CartItem cartItem)</span></span></span><span class="hljs-function"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> http.getForObject(           <span class="hljs-string"><span class="hljs-string">"http://localhost:9090/products/{id}"</span></span>,           Product.class,           cartItem.getProductId()   ); }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Substitua por um mais eficaz: </font></font><br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@GraphQLQuery</span></span>(name = <span class="hljs-string"><span class="hljs-string">"product"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Batched</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> List&lt;Product&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">products</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@GraphQLContext List&lt;Item&gt; items)</span></span></span><span class="hljs-function"> </span></span>{   String productIds = items.stream()           .map(Item::getProductId)           .collect(Collectors.joining(<span class="hljs-string"><span class="hljs-string">","</span></span>));   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> http.getForObject(           <span class="hljs-string"><span class="hljs-string">"http://localhost:9090/products?ids={ids}"</span></span>,           Products.class,           productIds   ).getProducts(); }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Fizemos exatamente tr√™s coisas: </font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">marcou o m√©todo do carregador de inicializa√ß√£o com anota√ß√£o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">@Batched</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , deixando claro para o GraphQL SPQR que o carregamento deve ocorrer com um lote;</font></font><br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> alterou o tipo de retorno e o par√¢metro de contexto para uma lista, porque trabalhar com o lote pressup√µe que v√°rios objetos sejam aceitos e retornados; </font></font><br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mudou o corpo do m√©todo, implementando uma sele√ß√£o de todos os produtos necess√°rios ao mesmo tempo. </font></font><br></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Essas mudan√ßas s√£o suficientes para resolver o nosso problema de N + 1. </font><font style="vertical-align: inherit;">A janela do aplicativo Charles Proxy agora mostra uma solicita√ß√£o para o servi√ßo Produto, que retorna tr√™s produtos ao mesmo tempo:</font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/5c2/806/98d/5c280698dfbdf383cf44052f51a09ae8.png"><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Amostras de campo eficazes </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resolvemos o problema principal, mas voc√™ pode tornar a sele√ß√£o ainda mais r√°pida! </font><font style="vertical-align: inherit;">Agora, o servi√ßo do produto retorna todos os dados, independentemente do que o cliente final precisa. </font><font style="vertical-align: inherit;">Poder√≠amos melhorar a consulta e retornar apenas os campos solicitados. </font><font style="vertical-align: inherit;">Por exemplo, se o cliente final n√£o solicitou a imagem, por que precisamos transferi-las para o servi√ßo de carrinho? </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√â √≥timo que a API HTTP do servi√ßo Produto j√° suporte esse recurso por meio do par√¢metro </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">include</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para o mesmo recurso de cole√ß√£o:</font></font><br><br><pre> <code class="plaintext hljs">GET /products?ids=...?include=:field1,:field2,...,:fieldN</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para o m√©todo do carregador de inicializa√ß√£o, adicione um par√¢metro do tipo Set com anota√ß√£o </font></font><code>@GraphQLEnvironment</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">O GraphQL SPQR entende que o c√≥digo nesse caso "solicita" uma lista de nomes de campos solicitados para o produto e os preenche automaticamente:</font></font><br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@GraphQLQuery</span></span>(name = <span class="hljs-string"><span class="hljs-string">"product"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Batched</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> List&lt;Product&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">products</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@GraphQLContext List&lt;Item&gt; items,                             @GraphQLEnvironment Set&lt;String&gt; fields)</span></span></span><span class="hljs-function"> </span></span>{   String productIds = items.stream()           .map(Item::getProductId)           .collect(Collectors.joining(<span class="hljs-string"><span class="hljs-string">","</span></span>));   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> http.getForObject(           <span class="hljs-string"><span class="hljs-string">"http://localhost:9090/products?ids={ids}&amp;include={fields}"</span></span>,           Products.class,           productIds,           String.join(<span class="hljs-string"><span class="hljs-string">","</span></span>, fields)   ).getProducts(); }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Agora, nossa amostra √© realmente eficaz, sem o problema N + 1 e usa apenas os dados necess√°rios: </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/242/592/98f/24259298fe8acb19d21e04083689d5dd.png"><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Consultas "pesadas" </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Imagine trabalhar com um gr√°fico de usu√°rio em uma rede social cl√°ssica como o Facebook. </font><font style="vertical-align: inherit;">Se esse sistema fornecer a API GraphQL, nada impedir√° o cliente de enviar uma solicita√ß√£o da seguinte natureza:</font></font><br><br><pre> <code class="javascript hljs">{ user(name: <span class="hljs-string"><span class="hljs-string">"Vova Unicorn"</span></span>) {   friends {     name     friends {       name       friends {         name         friends {            name            ...         }       }     }   } } }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No n√≠vel de aninhamento de 5 a 6, a implementa√ß√£o completa de uma solicita√ß√£o desse tipo levar√° a uma sele√ß√£o de todos os usu√°rios no mundo. </font><font style="vertical-align: inherit;">O servidor certamente n√£o ser√° capaz de lidar com essa tarefa de uma s√≥ vez e provavelmente ir√° "cair". </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">H√° v√°rias medidas que devem ser tomadas para se proteger de tais situa√ß√µes:</font></font><br><br><ul><li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Limite a profundidade da solicita√ß√£o. </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em outras palavras, os clientes n√£o devem ter permiss√£o para solicitar dados de aninhamento arbitr√°rio.</font></font><br></li><li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Limite a complexidade da solicita√ß√£o. </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Atribuindo um peso a cada campo e calculando a soma dos pesos de todos os campos na solicita√ß√£o, voc√™ pode aceitar ou rejeitar essas solicita√ß√µes no servidor.</font></font><br></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Por exemplo, considere a seguinte consulta: </font></font><br><br><pre> <code class="javascript hljs">{ cart(id: <span class="hljs-number"><span class="hljs-number">1</span></span>) {   items {     product {       title     }     quantity   }   subTotal } }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Obviamente, a profundidade dessa solicita√ß√£o √© 4, porque o caminho mais longo est√° dentro dela </font></font><code>cart -&gt; items -&gt; product -&gt; title</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se assumirmos que o peso de cada campo √© 1, levando em considera√ß√£o 7 campos na consulta, sua complexidade tamb√©m √© 7. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No GraphQL Java, a superposi√ß√£o de verifica√ß√µes √© alcan√ßada indicando instrumenta√ß√£o adicional ao criar o objeto </font></font><code>GraphQL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="java hljs">GraphQL.newGraphQL(schema)       .instrumentation(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ChainedInstrumentation(Arrays.asList(               <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MaxQueryComplexityInstrumentation(<span class="hljs-number"><span class="hljs-number">20</span></span>),               <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MaxQueryDepthInstrumentation(<span class="hljs-number"><span class="hljs-number">3</span></span>)       )))       .build();</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A instrumenta√ß√£o </font></font><code>MaxQueryDepthInstrumentation</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">verifica a profundidade da solicita√ß√£o e n√£o permite que solicita√ß√µes muito "profundas" sejam iniciadas (nesse caso, com uma profundidade maior que 3). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A instrumenta√ß√£o </font></font><code>MaxQueryComplexityInstrumentation</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">antes de executar uma consulta conta e verifica sua complexidade. Se esse n√∫mero exceder o valor especificado (20), essa solicita√ß√£o ser√° rejeitada. Voc√™ pode redefinir o peso de cada campo, porque alguns deles obviamente ficam "mais dif√≠ceis" do que outros. Por exemplo, o campo do produto pode ser atribu√≠do √† complexidade 10 por meio da anota√ß√£o </font></font><code>@GraphQLComplexity,</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">suportada no GraphQL SPQR:</font></font><br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@GraphQLQuery</span></span>(name = <span class="hljs-string"><span class="hljs-string">"product"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@GraphQLComplexity</span></span>(<span class="hljs-string"><span class="hljs-string">"10"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> List&lt;Product&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">products</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(...)</span></span></span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aqui est√° um exemplo de uma verifica√ß√£o de profundidade quando excede claramente o valor especificado: </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/54c/c39/584/54cc39584792997b198370c40e8b2431.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A prop√≥sito, o mecanismo de instrumenta√ß√£o n√£o se limita a impor restri√ß√µes. </font><font style="vertical-align: inherit;">Tamb√©m pode ser usado para outros fins, como registro ou rastreamento. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Examinamos as medidas de ‚Äúprote√ß√£o‚Äù espec√≠ficas do GraphQL. </font><font style="vertical-align: inherit;">No entanto, h√° v√°rios truques que vale a pena prestar aten√ß√£o, independentemente do tipo de API:</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> limita√ß√£o / limita√ß√£o de taxa - limite o n√∫mero de solicita√ß√µes por unidade de tempo </font></font><br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> timeouts - limite de tempo para opera√ß√µes com outros servi√ßos, bancos de dados, etc; </font></font><br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pagina√ß√£o - suporte √† pagina√ß√£o. </font></font><br></li></ul><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Muta√ß√£o de dados </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">At√© agora, estamos considerando puramente a amostragem de dados. </font><font style="vertical-align: inherit;">Mas o GraphQL permite que voc√™ organize organicamente n√£o apenas o recebimento de dados, mas tamb√©m suas altera√ß√µes. </font><font style="vertical-align: inherit;">Existe um mecanismo para isso </font></font><code></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">No esquema, um lugar especial √© reservado para isso - o campo </font></font><code>mutation</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="javascript hljs">schema { <span class="hljs-attr"><span class="hljs-attr">query</span></span>: EntryPoints, <span class="hljs-attr"><span class="hljs-attr">mutation</span></span>: Mutations }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Por exemplo, a adi√ß√£o de um produto a uma cesta pode ser organizada atrav√©s da seguinte muta√ß√£o: </font></font><br><br><pre> <code class="javascript hljs">type Mutations {   addProductToCart(cartId: Long!,                    <span class="hljs-attr"><span class="hljs-attr">productId</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>!,                    <span class="hljs-attr"><span class="hljs-attr">count</span></span>: Int = <span class="hljs-number"><span class="hljs-number">1</span></span>): Cart }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Isso √© semelhante √† defini√ß√£o de um campo, porque uma muta√ß√£o tamb√©m possui par√¢metros e um valor de retorno. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A implementa√ß√£o de uma muta√ß√£o no c√≥digo do servidor usando o GraphQL SPQR √© a seguinte:</font></font><br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@GraphQLMutation</span></span>(name = <span class="hljs-string"><span class="hljs-string">"addProductToCart"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Cart </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addProductToCart</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(       @GraphQLArgument(name = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"cartId"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> Long cartId,       @</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GraphQLArgument</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(name = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"productId"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> String productId,       @</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GraphQLArgument</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(name = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"quantity"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, defaultValue = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"1"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> quantity) </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cartService.addProductToCart(cartId, productId, quantity); }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Obviamente, a maior parte do trabalho √∫til √© feita internamente </font></font><code>cartService</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. E a tarefa desse m√©todo intercalar √© associ√°-lo √† API. Como no caso da amostragem de dados, gra√ßas √†s anota√ß√µes, √© </font></font><code>@GraphQL*</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">muito f√°cil entender qual esquema do GraphQL √© gerado a partir dessa defini√ß√£o de m√©todo. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No console do GraphQL, agora voc√™ pode executar uma solicita√ß√£o de muta√ß√£o para adicionar um produto espec√≠fico √† nossa cesta em uma quantidade de 2:</font></font><br><br><pre> <code class="javascript hljs">mutation { addProductToCart(     cartId: <span class="hljs-number"><span class="hljs-number">1</span></span>,     <span class="hljs-attr"><span class="hljs-attr">productId</span></span>: <span class="hljs-string"><span class="hljs-string">"59eb83c0040fa80b29938e3f"</span></span>,     <span class="hljs-attr"><span class="hljs-attr">quantity</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>) {   items {     product {       title     }     quantity     total   }   subTotal } }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como a muta√ß√£o tem um valor de retorno, √© poss√≠vel solicitar campos de acordo com as mesmas regras que fizemos para amostras comuns. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V√°rias equipes de desenvolvimento do WIX est√£o usando ativamente o GraphQL com o Scala e a biblioteca Sangria, a principal implementa√ß√£o do GraphQL nessa linguagem. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uma das t√©cnicas √∫teis usadas no WIX √© o suporte para consultas GraphQL ao renderizar HTML. </font><font style="vertical-align: inherit;">Fazemos isso para gerar JSON diretamente no c√≥digo da p√°gina. </font><font style="vertical-align: inherit;">Aqui est√° um exemplo de preenchimento de um modelo HTML:</font></font><br><br><pre> <code class="xml hljs">// Pre-rendered <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data-embedded-graphiql</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"><span class="undefined"> {   product(productId: $productId)     title     description     price     ...   } } </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> E aqui est√° a sa√≠da: </font></font><br><br><pre> <code class="xml hljs">// Rendered <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="javascript"> </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">window</span></span></span><span class="javascript">.DATA = {   </span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">product</span></span></span><span class="javascript">: {          </span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">title</span></span></span><span class="javascript">: </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'GraphQL Sticker'</span></span></span><span class="javascript">,          </span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">description</span></span></span><span class="javascript">: </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'High quality sticker'</span></span></span><span class="javascript">,           </span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">price</span></span></span><span class="javascript">: </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'$2'</span></span></span><span class="javascript">           ... } } </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Essa combina√ß√£o de renderizador HTML e servidor GraphQL nos permite reutilizar nossa API ao m√°ximo e n√£o criar uma camada adicional de controladores. </font><font style="vertical-align: inherit;">Al√©m disso, essa t√©cnica geralmente se mostra vantajosa em termos de desempenho, porque ap√≥s o carregamento da p√°gina, o aplicativo JavaScript n√£o precisa ir para o back-end para os primeiros dados necess√°rios - ele j√° est√° na p√°gina.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Desvantagens do GraphQL </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hoje, o GraphQL usa um grande n√∫mero de empresas, incluindo gigantes como GitHub, Yelp, Facebook e muitas outras. </font><font style="vertical-align: inherit;">E se voc√™ decidir juntar o n√∫mero deles, deve conhecer n√£o apenas as vantagens do GraphQL, mas tamb√©m suas desvantagens, e existem muitas delas:</font></font><br><br><ul><li> -,  GraphQL <b>     </b> .  GraphQL      ,   HTTP API.  <i>Cache-Control</i>  <i>Last-Modified</i>    HTTP      GraphQL API.         ,  proxy  gateways (Varnish, Fastly  ).   , GraphQL    ,    ,   . <br></li><li>   GraphQL ‚Äî <b>    </b> .    ,         API,    ,       . <br></li><li> <b> </b>  GraphQL       .        . <br></li><li>  <b>     </b> . GraphQL ‚Äî       .     JSON  XML, , ,          GraphQL,       . <br></li><li>  GraphQL <b>   </b> . ,       HTTP   <i>PUT</i>     <i>POST</i>  -.   ,       .    GraphQL       .        . <br></li><li> <b>   </b> . ,     -: ¬´delete¬ª  ¬´kill¬ª, ¬´annihilate¬ª  ¬´terminate¬ª,    .   GraphQL API    .   HTTP          <i>DELETE</i> . <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Joker 2016   </a>   .  GraphQL <b>      </b> .  API-   ,   ,    ,     HATEOAS,     ,   ¬´ REST¬ª. ,     ,  GraphQL     . <br></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tamb√©m vale lembrar que, se voc√™ n√£o conseguiu desenvolver bem a API HTTP, provavelmente n√£o poder√° desenvolver a API GraphQL. Afinal, o que √© mais importante no desenvolvimento de qualquer API? Separe o modelo de dom√≠nio interno do modelo de API externa. Crie uma API com base nos cen√°rios de uso, n√£o no dispositivo interno do aplicativo. Abra apenas as informa√ß√µes m√≠nimas necess√°rias, e nem todas seguidas. Escolha os nomes certos. Descreva o gr√°fico corretamente. H√° um gr√°fico de recurso na API HTTP e um gr√°fico de campo na API GraphQL. Nos dois casos, esse gr√°fico deve ser realizado qualitativamente.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Existem alternativas no mundo da API HTTP, e voc√™ nem sempre precisa usar o GraphQL quando precisar de sele√ß√µes complexas. </font><font style="vertical-align: inherit;">Por exemplo, existe o padr√£o OData, que suporta sele√ß√µes parciais e expans√≠veis, como GraphQL, e funciona sobre HTTP. </font><font style="vertical-align: inherit;">Existe uma API JSON padr√£o que funciona com JSON e suporta recursos de busca hiperm√≠dia e complexos. </font><font style="vertical-align: inherit;">H√° tamb√©m o LinkRest, sobre o qual voc√™ pode aprender mais no </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://youtu.be/EsldBtrb1Qc "&gt; relat√≥rio de Andrus Adamchik</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> no Joker 2017. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para aqueles que desejam experimentar o GraphQL, recomendo vivamente a leitura de artigos de compara√ß√£o de engenheiros versados ‚Äã‚Äãem REST e GraphQL de um ponto de vista pr√°tico e filos√≥fico:</font></font><br><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://philsturgeon.uk/api/2017/01/24/graphql-vs-rest-overview/</font></font></a> <br></li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://blog.runscope.com/posts/you-might-not-need-graphql</font></font></a> <br></li></ul><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Finalmente, sobre assinaturas e </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">adiar</font></font></a> </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O GraphQL tem uma vantagem interessante sobre as APIs padr√£o. </font><font style="vertical-align: inherit;">No GraphQL, os casos de uso s√≠ncronos e ass√≠ncronos podem ficar sob o mesmo teto. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pensamos em receber dados atrav√©s de voc√™ </font></font><code>query</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, alterando o status do servidor </font></font><code>mutation</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, mas h√° mais uma coisa boa. </font><font style="vertical-align: inherit;">Por exemplo, a capacidade de organizar assinaturas </font></font><code>subscriptions</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Imagine que um cliente deseja receber notifica√ß√µes sobre como adicionar um produto √† cesta de forma ass√≠ncrona. </font><font style="vertical-align: inherit;">Atrav√©s da API GraphQL, isso pode ser feito com base em um esquema:</font></font><br><br><pre> <code class="javascript hljs">schema { <span class="hljs-attr"><span class="hljs-attr">query</span></span>: Queries, <span class="hljs-attr"><span class="hljs-attr">mutation</span></span>: Mutations, <span class="hljs-attr"><span class="hljs-attr">subscription</span></span>: Subscriptions } type Subscriptions { productAdded(cartId: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>!): Cart }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> O cliente pode se inscrever atrav√©s da seguinte solicita√ß√£o: </font></font><br><br><pre> <code class="javascript hljs">subscription { productAdded(cart: <span class="hljs-number"><span class="hljs-number">1</span></span>) {   items {     product ...   }   subTotal } }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Agora, toda vez que um produto for adicionado √† cesta 1, o servidor enviar√° a cada cliente inscrito uma mensagem no WebSocket com os dados solicitados na cesta. </font><font style="vertical-align: inherit;">Novamente, continuando a pol√≠tica do GraphQL, apenas os dados que o cliente solicitou ao se inscrever vir√£o:</font></font><br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"data"</span></span>: {   <span class="hljs-attr"><span class="hljs-attr">"productAdded"</span></span>: {     <span class="hljs-attr"><span class="hljs-attr">"items"</span></span>: [       { <span class="hljs-attr"><span class="hljs-attr">"product"</span></span>: ‚Ä¶, <span class="hljs-attr"><span class="hljs-attr">"subTotal"</span></span>: ‚Ä¶ },       { <span class="hljs-attr"><span class="hljs-attr">"product"</span></span>: ‚Ä¶, <span class="hljs-attr"><span class="hljs-attr">"subTotal"</span></span>: ‚Ä¶ },       { <span class="hljs-attr"><span class="hljs-attr">"product"</span></span>: ‚Ä¶, <span class="hljs-attr"><span class="hljs-attr">"subTotal"</span></span>: ‚Ä¶ },       { <span class="hljs-attr"><span class="hljs-attr">"product"</span></span>: ‚Ä¶, <span class="hljs-attr"><span class="hljs-attr">"subTotal"</span></span>: ‚Ä¶ }     ],     <span class="hljs-attr"><span class="hljs-attr">"subTotal"</span></span>: <span class="hljs-number"><span class="hljs-number">289.33</span></span>   } } }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O cliente agora pode redesenhar a cesta, n√£o necessariamente redesenhando a p√°gina inteira. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Isso √© conveniente porque a API s√≠ncrona (HTTP) e a API ass√≠ncrona (WebSocket) podem ser descritas atrav√©s do GraphQL. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Outro exemplo de uso da comunica√ß√£o ass√≠ncrona √© o mecanismo de </font></font><i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">adiamento</font></font></a></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">A id√©ia principal √© que o cliente escolha quais dados ele deseja receber imediatamente (de forma s√≠ncrona) e aqueles que ele est√° pronto para receber posteriormente (de forma s√≠ncrona). </font><font style="vertical-align: inherit;">Por exemplo, para tal solicita√ß√£o:</font></font><br><br><pre> <code class="javascript hljs">query { feedStories {   author { name }   message   comments @defer {     author { name }     message   } } }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> O servidor retornar√° primeiro o autor e uma mensagem para cada hist√≥ria: </font></font><br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"data"</span></span>: {   <span class="hljs-attr"><span class="hljs-attr">"feedStories"</span></span>: [     {       <span class="hljs-attr"><span class="hljs-attr">"author"</span></span>: ‚Ä¶,       <span class="hljs-attr"><span class="hljs-attr">"message"</span></span>: ‚Ä¶     },     {       <span class="hljs-attr"><span class="hljs-attr">"author"</span></span>: ‚Ä¶,       <span class="hljs-attr"><span class="hljs-attr">"message"</span></span>: ‚Ä¶     }   ] } }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Depois disso, o servidor, ap√≥s receber os dados nos coment√°rios, os entregar√° ao cliente via WebSocket de forma ass√≠ncrona, indicando o caminho para o qual os coment√°rios do hist√≥rico est√£o prontos: </font></font><br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"path"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"feedStories"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"comments"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"data"</span></span>: [   {     <span class="hljs-attr"><span class="hljs-attr">"author"</span></span>: ‚Ä¶,     <span class="hljs-attr"><span class="hljs-attr">"message"</span></span>: ‚Ä¶   } ] }</code> </pre> <br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Origem da amostra </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O c√≥digo usado para preparar este relat√≥rio pode </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ser encontrado no GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mais recentemente, anunciamos o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JPoint 2019</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que ser√° realizado de 5 a 6 de abril de 2019. </font><font style="vertical-align: inherit;">Voc√™ pode aprender mais sobre o que esperar da confer√™ncia em nosso </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">At√© o dia primeiro de dezembro, os </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ingressos para Early Bird</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ainda est√£o dispon√≠veis </font><font style="vertical-align: inherit;">pelo menor pre√ßo.</font></font></blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt428517/">https://habr.com/ru/post/pt428517/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt428507/index.html">N√≥s escrevemos um chat de bot para o VKontakte em python usando longpoll</a></li>
<li><a href="../pt428509/index.html">Como a H&M est√° tentando se salvar com IA e Big Data</a></li>
<li><a href="../pt428511/index.html">Energia de hidrog√™nio: o come√ßo de um longo caminho</a></li>
<li><a href="../pt428513/index.html">500 ponteiros laser em um s√≥ lugar</a></li>
<li><a href="../pt428515/index.html">Top 3D Shop: como mudamos ao longo do ano - resultados de 2018</a></li>
<li><a href="../pt428521/index.html">Por que n√£o h√° amigos no GitHub. Sobre Robbie Barrath, √ìbvio e Direitos autorais</a></li>
<li><a href="../pt428523/index.html">ShadowCloud - cliente universal de nuvem</a></li>
<li><a href="../pt428525/index.html">RecyclerView na velocidade m√°xima: analisando bibliotecas</a></li>
<li><a href="../pt428526/index.html">Taxa do Google: 180 ¬∞ de volta</a></li>
<li><a href="../pt428528/index.html">Por que revolucion√°rios gostam de comida apimentada ou como o chili chegou √† China</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>