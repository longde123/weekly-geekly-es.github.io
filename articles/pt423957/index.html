<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®‚Äçüç≥ ü§¥üèº üë®üèø‚Äçüî¨ Gera√ß√£o de tr√°fego no espa√ßo do usu√°rio ‚úäüèø ‚úçüèº üéá</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Gera√ß√£o de tr√°fego usando MoonGen + DPDK + Lua na vis√£o do artista 

 A neutraliza√ß√£o dos ataques DDoS em condi√ß√µes reais requer testes preliminares e...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Gera√ß√£o de tr√°fego no espa√ßo do usu√°rio</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/qrator/blog/423957/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/d4/ab/qb/d4abqbslioh-eskinpe4jhet0y4.jpeg"></div><br>  <i>Gera√ß√£o de tr√°fego usando MoonGen + DPDK + Lua na vis√£o do artista</i> <br><br>  A neutraliza√ß√£o dos ataques DDoS em condi√ß√µes reais requer testes preliminares e testes de v√°rias t√©cnicas.  O equipamento e o software de rede devem ser testados em condi√ß√µes artificiais pr√≥ximas √†s reais - com fluxos intensivos de tr√°fego simulando ataques.  Sem essas experi√™ncias, √© extremamente dif√≠cil obter informa√ß√µes confi√°veis ‚Äã‚Äãsobre os recursos e limita√ß√µes espec√≠ficos de qualquer ferramenta complexa. <br><br>  Neste artigo, revelaremos alguns dos m√©todos de gera√ß√£o de tr√°fego usados ‚Äã‚Äãno Qrator Labs. <br><br>  <b>ATEN√á√ÉO</b> <br><br>  √â altamente recomend√°vel que o leitor n√£o tente usar as ferramentas mencionadas para atacar objetos de infraestrutura real.  A organiza√ß√£o dos ataques DoS √© pun√≠vel por lei e pode levar a penalidades severas.  O Qrator Labs realiza todos os testes em um ambiente de laborat√≥rio isolado. <br><a name="habracut"></a><br><h2>  N√≠vel t√©cnico moderno </h2><br>  Uma tarefa significativa em nossa √°rea √© saturar a interface Ethernet 10G com pacotes pequenos, o que significa processar 14,88 Mpps (milh√µes de pacotes por segundo).  A seguir, consideramos os menores pacotes de rede Ethernet - 64 bytes -, pois nosso principal interesse √© maximizar o n√∫mero de pacotes transmitidos por unidade de tempo.  Um c√°lculo simples mostra que temos apenas 67 nanossegundos para processar um desses pacotes. <br><br>  Apenas para compara√ß√£o, esse tempo est√° pr√≥ximo do que um processador moderno precisa para obter um peda√ßo de dados da mem√≥ria, se perder o cache.  Tudo se torna ainda mais complicado quando come√ßamos a trabalhar com interfaces Ethernet 40G e 100G e tentamos satur√°-las completamente at√© a taxa de linha (o m√°ximo desempenho poss√≠vel declarado do dispositivo de rede). <br><br>  Como, no caso usual, o fluxo de dados passa pelo aplicativo no espa√ßo do usu√°rio (espa√ßo do usu√°rio), depois pelo kernel, finalmente entrando no controlador de rede (NIC), a primeira e mais direta id√©ia √© tentar configurar a gera√ß√£o de pacotes diretamente no kernel.  Um exemplo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">dessa solu√ß√£o</a> √© o m√≥dulo nuclear <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">pktgen</a> [2].  Esse m√©todo permite melhorar significativamente o desempenho, mas n√£o √© flex√≠vel o suficiente, pois a menor altera√ß√£o no c√≥digo-fonte no kernel leva a um longo ciclo de compila√ß√£o, reinicializa√ß√£o dos m√≥dulos do kernel ou mesmo de todo o sistema e, de fato, testes, o que reduz a produtividade geral (ou seja, requer mais tempo do programador) e esfor√ßo). <br><br>  Outra abordagem poss√≠vel √© obter acesso direto do espa√ßo do usu√°rio aos buffers de mem√≥ria do controlador de rede.  Esse caminho √© mais complicado, mas vale o esfor√ßo para obter maior produtividade.  As desvantagens incluem alta complexidade e baixa flexibilidade.  Exemplos dessa abordagem s√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">netmap</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">PF_RING</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">DPDK</a> [4]. <br><br>  Outra maneira eficaz, embora muito cara, de obter alto desempenho √© usar equipamentos n√£o universais, mas especializados.  Exemplo: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Ixia</a> . <br><br>  Tamb√©m existem solu√ß√µes baseadas no DPDK usando scripts, o que aumenta a flexibilidade no controle dos par√¢metros do gerador e tamb√©m permite variar o tipo de pacotes gerados durante a inicializa√ß√£o.  Abaixo, descrevemos nossa pr√≥pria experi√™ncia com uma dessas ferramentas - MoonGen. <br><br><h2>  Arquitetura MoonGen </h2><br>  Os recursos distintos do MoonGen s√£o: <br><br><ol><li>  O processamento de dados DPDK no espa√ßo do usu√°rio √© a principal raz√£o para o ganho de desempenho; </li><li>  Lua [ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">5</a> ] empilha com scripts simples no n√≠vel superior e liga√ß√µes √† biblioteca DPDK escrita em C, na parte inferior; </li><li>  Gra√ßas √† tecnologia JIT (just in time), os scripts Lua funcionam r√°pido o suficiente, o que contradiz as id√©ias geralmente aceitas sobre a efic√°cia das linguagens de script. </li></ol><br>  MoonGen pode ser pensado como um wrapper Lua em torno da biblioteca DPDK.  Pelo menos as seguintes opera√ß√µes do DPDK s√£o vis√≠veis no n√≠vel da interface do usu√°rio Lua: <br><br><ul><li>  Configurando controladores de rede; </li><li>  Aloca√ß√£o e acesso direto a pools e buffers de mem√≥ria que, para fins de otimiza√ß√£o, devem ser alocados em √°reas alinhadas cont√≠nuas; </li><li>  Acesso direto √†s filas RSS dos controladores de rede; </li><li>  API para gerenciamento de fluxos computacionais, levando em considera√ß√£o a heterogeneidade do acesso √† mem√≥ria (afinidade NUMA e CPU) [ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">12</a> ]. </li></ul><br><img src="https://habrastorage.org/webt/qg/vh/ij/qgvhijgvyv0fe5m9vntekmwggxo.png"><br><br>  Arquitetura MoonGen, esquema de material [ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">1</a> ]. <br><br><h3>  Moongen </h3><br>  MoonGen √© um gerador de pacotes de alta velocidade com script baseado na biblioteca DPDK.  Os scripts Lua controlam todo o processo: o script criado pelo usu√°rio √© respons√°vel por criar, modificar e enviar pacotes.  Gra√ßas √† r√°pida biblioteca de processamento de pacotes LuaJIT e DPDK, essa arquitetura permite saturar uma interface Ethernet de 10 gigabits com pacotes de 64 bytes usando apenas um n√∫cleo da CPU.  MoonGen permite que voc√™ atinja essa velocidade mesmo quando o script Lua modifica cada pacote.  Ele n√£o usa truques como reutilizar o mesmo buffer do controlador de rede. <br><br>  O MoonGen tamb√©m pode receber pacotes, ou seja, verificar quais pacotes foram descartados pelo sistema em teste.  Como a recep√ß√£o de pacotes √© controlada exclusivamente por um script Lua personalizado, ela tamb√©m pode ser usada para criar scripts de teste mais complexos.  Por exemplo, voc√™ pode usar duas inst√¢ncias do MoonGen para estabelecer uma conex√£o entre si.  Essa configura√ß√£o pode ser usada, em particular, para testar as chamadas caixas do meio (equipamentos entre o ponto de envio e recebimento de tr√°fego), por exemplo, firewalls.  O MoonGen foca em quatro √°reas principais: <br><br><ul><li>  Alto desempenho e dimensionamento de v√°rios n√∫cleos: mais de 20 milh√µes de pacotes por segundo em um √∫nico n√∫cleo de CPU; </li><li>  Flexibilidade: cada pacote √© gerado em tempo real com base em um script Lua criado pelo usu√°rio; </li><li>  Carimbos de data e hora exatos: no hardware comum (de mercadorias), a marca√ß√£o de tempo √© executada com precis√£o de milissegundos; </li><li>  Controle exato dos intervalos entre pacotes enviados: gera√ß√£o confi√°vel dos padr√µes e tipos de tr√°fego necess√°rios no hardware comum. </li></ul><br><h3>  DPDK </h3><br>  DPDK significa Data Plane Development Kit e consiste em bibliotecas cujas principais fun√ß√µes s√£o aumentar o desempenho da gera√ß√£o de pacotes de rede em uma ampla variedade de arquiteturas de processador central. <br><br>  Em um mundo em que as redes de computadores est√£o se tornando a base da comunica√ß√£o humana, desempenho, largura de banda e lat√™ncia, est√£o se tornando par√¢metros cada vez mais cr√≠ticos para sistemas como redes sem fio e infraestrutura de cabos, incluindo todos os seus componentes individuais: roteadores, balanceadores de carga, firewalls;  bem como √°reas de aplica√ß√£o: transfer√™ncia de m√≠dia (streaming), VoIP, etc. <br><br>  O DPDK √© uma maneira leve e conveniente de criar testes e scripts.  A transfer√™ncia de dados no espa√ßo do usu√°rio √© algo que n√£o observamos com tanta frequ√™ncia, principalmente porque a maioria dos aplicativos se comunica com o equipamento de rede por meio do sistema operacional e da pilha do kernel, que √© o oposto do modelo DPDK. <br><br><h3>  Lua </h3><br>  O principal objetivo da exist√™ncia de Lua √© fornecer ferramentas expressivas simples e flex√≠veis, expans√≠veis para tarefas atuais espec√≠ficas, em vez de um conjunto de primitivas aplic√°veis ‚Äã‚Äãem apenas um paradigma de programa√ß√£o.  Como resultado, a linguagem base √© muito leve - o int√©rprete inteiro ocupa apenas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">180 kB</a> na forma compilada e se adapta facilmente a uma ampla variedade de implementa√ß√µes poss√≠veis. <br><br>  Lua √© uma linguagem din√¢mica.  √â t√£o compacto que pode ser colocado em praticamente qualquer dispositivo.  Lua suporta um pequeno conjunto de tipos: valores booleanos, n√∫meros (ponto flutuante de precis√£o dupla) e seq√º√™ncias de caracteres.  Estruturas de dados convencionais, como matrizes, conjuntos e listas, podem ser representadas pela √∫nica estrutura de dados interna em Lua - uma tabela, que √© uma matriz associativa heterog√™nea. <br><br>  Lua usa a compila√ß√£o JIT (just in time), portanto, sendo uma linguagem de script, mostra desempenho compar√°vel a linguagens compiladas como C [ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">10</a> ]. <br><br><h2>  Por que moongen </h2><br>  Como uma empresa especializada em neutralizar ataques DDoS, o Qrator Labs precisa de uma maneira confi√°vel de criar, atualizar e testar suas pr√≥prias solu√ß√µes de seguran√ßa.  √â para o √∫ltimo teste, que s√£o necess√°rios v√°rios m√©todos de gera√ß√£o de tr√°fego que simulam ataques reais.  No entanto, n√£o √© t√£o f√°cil simular um ataque de inunda√ß√£o perigoso, mas direto, nos n√≠veis 2-3 do modelo OSI, principalmente devido √†s dificuldades em obter alto desempenho na gera√ß√£o de pacotes. <br><br>  Em outras palavras, para uma empresa envolvida na disponibilidade e neutraliza√ß√£o cont√≠nuas de DDoS, simular v√°rios ataques de DoS em um ambiente isolado de laborat√≥rio √© uma maneira de entender como os v√°rios equipamentos que fazem parte dos sistemas de hardware da empresa se comportar√£o na realidade. <br><br>  MoonGen √© uma boa maneira de gerar valores de tr√°fego pr√≥ximos ao limite para o controlador de rede em um m√≠nimo de n√∫cleos de CPU.  A transfer√™ncia de dados no espa√ßo do usu√°rio melhora significativamente o desempenho da pilha em quest√£o (MoonGen + DPDK), em compara√ß√£o com muitas outras op√ß√µes para gerar altos valores de tr√°fego.  O uso do DPDK puro exige muito mais esfor√ßo; portanto, voc√™ n√£o deve se surpreender com o nosso desejo de otimizar o desempenho.  Tamb√©m suportamos um clone [ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">7</a> ] do reposit√≥rio MoonGen original para expandir a funcionalidade e implementa√ß√£o de nossos pr√≥prios testes. <br><br>  Para obter a m√°xima flexibilidade, a l√≥gica para gerar pacotes √© definida pelo usu√°rio usando o script Lua, que √© um dos principais recursos do MoonGen.  No caso de processamento de pacotes relativamente simples, esta solu√ß√£o funciona r√°pido o suficiente para saturar a interface 10G em um √∫nico n√∫cleo da CPU.  Uma maneira t√≠pica de modificar pacotes recebidos e criar novos √© trabalhar com pacotes do mesmo tipo, nos quais apenas alguns dos campos s√£o alterados. <br><br>  Um exemplo √© o teste l3-tcp-syn-ack-flood, descrito abaixo.  Observe que qualquer modifica√ß√£o do pacote pode ser feita no mesmo buffer, onde o pacote gerado ou recebido na etapa anterior acabou sendo.  De fato, essas convers√µes de pacotes s√£o executadas muito rapidamente, uma vez que n√£o envolvem opera√ß√µes caras, como chamadas do sistema, acesso a se√ß√µes de mem√≥ria potencialmente n√£o armazenadas em cache e similares. <br><br><h2>  Testes no hardware do Qrator Labs </h2><br>  O Qrator Labs realiza todos os testes em laborat√≥rio em v√°rios equipamentos.  Nesse caso, usamos os seguintes controladores de interface de rede: <br><br><ul><li>  Intel 82599ES 10G </li><li>  Mellanox ConnectX-4 40G </li><li>  Mellanox ConnectX-5 100G </li></ul><br>  Observamos separadamente que, ao trabalhar com controladores de rede que operam em padr√µes acima de 10G, o problema de desempenho est√° se tornando mais agudo.  Hoje n√£o √© poss√≠vel saturar a interface 40G com um n√∫cleo, embora com um pequeno n√∫mero de n√∫cleos isso j√° seja realista. <br><br>  No caso de controladores de rede fabricados pela Mellanox, √© poss√≠vel alterar alguns par√¢metros e configura√ß√µes do dispositivo usando o guia de ajuste [ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">3</a> ] fornecido pelo fabricante.  Isso permite aumentar o desempenho e, em alguns casos especiais, aprofundar o comportamento da NIC.  Outros fabricantes podem ter documentos semelhantes para seus pr√≥prios dispositivos de alto desempenho destinados ao uso profissional.  Mesmo que voc√™ n√£o consiga encontrar esse documento em dom√≠nio p√∫blico, sempre faz sentido entrar em contato diretamente com o fabricante.  No nosso caso, os representantes da Mellanox foram muito gentis e, al√©m de fornecer documenta√ß√£o, responderam rapidamente √†s nossas perguntas, pelas quais conseguimos obter 100% de utiliza√ß√£o da tira, o que foi muito importante para n√≥s. <br><br><h3>  Teste de inunda√ß√£o TCP SYN </h3><br>  O L3-tcp-syn-ack-flood √© um exemplo de simula√ß√£o de um ataque como o SYN flood [ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">6</a> ].  Esta √© uma vers√£o estendida do Qrator Labs do teste l3-tcp-syn-flood do reposit√≥rio principal MoonGen, que √© armazenado em nosso clone do reposit√≥rio. <br><br>  Nosso teste pode executar tr√™s tipos de processos: <br><br><ol><li>  Gere o fluxo de pacotes TCP SYN do zero, variando os campos obrigat√≥rios, como endere√ßo IP de origem, n√∫mero da porta de origem, etc. </li><li>  Crie uma resposta ACK v√°lida para cada pacote SYN recebido de acordo com o TCP; </li><li>  Crie uma resposta SYN-ACK v√°lida para cada pacote ACK recebido, de acordo com o protocolo TCP. </li></ol><br>  Por exemplo, o loop de c√≥digo interno (respectivamente, o "mais quente") para criar respostas ACK √© o seguinte: <br><br><pre><code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> tx = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> rx = rxQ:recv(rxBufs) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i = <span class="hljs-number"><span class="hljs-number">1</span></span>, rx <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> buf = rxBufs[i] <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> pkt = buf:getTcpPacket(ipv4) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> pkt.ip4:getProtocol() == ip4.PROTO_TCP <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> pkt.tcp:getSyn() <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (pkt.tcp:getAck() <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> synack) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> seq = pkt.tcp:getSeqNumber() <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> ack = pkt.tcp:getAckNumber() pkt.tcp:unsetSyn() pkt.tcp:setAckNumber(seq+<span class="hljs-number"><span class="hljs-number">1</span></span>) pkt.tcp:setSeqNumber(ack) <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> tmp = pkt.ip4.src:get() pkt.ip4.src:set(pkt.ip4.dst:get()) pkt.ip4.dst:set(tmp) ‚Ä¶ <span class="hljs-comment"><span class="hljs-comment">-- some more manipulations with packet fields tx = tx + 1 txBufs[tx] = buf end end if tx &gt; 0 then txBufs:resize(tx) txBufs:offloadTcpChecksums(ipv4) -- offload checksums to NIC txQ:send(txBufs) end</span></span></code> </pre> <br>  A id√©ia geral de criar um pacote de resposta √© a seguinte.  Primeiro, voc√™ precisa remover o pacote da fila RX e verificar se o tipo de pacote corresponde ao esperado.  Em caso de coincid√™ncia, prepare uma resposta modificando alguns campos da embalagem original.  Por fim, coloque o pacote criado na fila TX usando o mesmo buffer.  Para melhorar o desempenho, em vez de pegar pacotes um por um e modific√°-los um por um, agregamos-os, extraindo todos os pacotes dispon√≠veis da fila RX, criamos as respostas correspondentes e colocamos todos na fila TX.  Apesar de um n√∫mero bastante grande de manipula√ß√µes em um pacote, o desempenho permanece alto, principalmente devido ao fato de o Lua JIT compilar todas essas opera√ß√µes em um pequeno n√∫mero de instru√ß√µes do processador.  Muitos outros testes, n√£o apenas o TCP SYN / ACK, funcionam com o mesmo princ√≠pio. <br><br>  A tabela abaixo mostra os resultados do teste de inunda√ß√£o SYN (gera√ß√£o SYN sem tentativas de resposta) usando o Mellanox ConnectX-4.  Essa placa de rede possui duas portas 40G com um limite te√≥rico de desempenho de 59,52 Mpps em uma porta e 2 * 50 Mpps para duas portas.  A implementa√ß√£o espec√≠fica de conectar a NIC ao PCIe limita um pouco a largura de banda (fornecendo 2 * 50 em vez dos 2 * 59.52 esperados). <br><table><tbody><tr><td>  <b>n√∫cleos por porta</b> </td><td>  <b>1 porta, Mpps</b> </td><td>  <b>2 portas, Mpps por cada porta</b> </td></tr><tr><td>  1 </td><td>  20 </td><td>  19 </td></tr><tr><td>  2 </td><td>  38. </td><td>  36. </td></tr><tr><td>  3 </td><td>  56,5 </td><td>  47 </td></tr><tr><td>  4 </td><td>  59,5 </td><td>  50. </td></tr></tbody></table><br>  <i>Teste de inunda√ß√£o SYN;</i>  <i>NIC: Fam√≠lia Mellanox Technologies MT27700 (ConnectX-4), porta dupla de 40G;</i>  <i>CPU: CPU Intel¬Æ Xeon¬Æ Silver 4114 a 2,20GHz</i> <br><br>  A tabela a seguir mostra os resultados do mesmo teste de inunda√ß√£o SYN realizado em um Mellanox ConnectX-5 com uma porta 100G. <br><table><tbody><tr><td>  <b>n√∫cleos</b> </td><td>  <b>Mpps</b> </td></tr><tr><td>  1 </td><td>  35 </td></tr><tr><td>  2 </td><td>  69 </td></tr><tr><td>  3 </td><td>  104 </td></tr><tr><td>  4 </td><td>  127 </td></tr><tr><td>  5 </td><td>  120 </td></tr><tr><td>  6 </td><td>  131 </td></tr><tr><td>  7 </td><td>  132 </td></tr><tr><td>  8 </td><td>  144 </td></tr></tbody></table><br>  <i>Teste de inunda√ß√£o SYN;</i>  <i>NIC: Fam√≠lia Mellanox Technologies MT27800 (ConnectX-5), porta √∫nica de 100G;</i>  <i>CPU: CPU Intel¬Æ Xeon¬Æ Silver 4114 a 2,20GHz</i> <br><br>  Observe que em todos os casos atingimos mais de 96% do limite te√≥rico de desempenho em um pequeno n√∫mero de n√∫cleos de processador. <br><br><h3>  Capture o tr√°fego recebido e salve em arquivos PCAP </h3><br>  Outro exemplo do teste √© o rx-to -capcap, que tenta capturar todo o tr√°fego recebido e salvar em um determinado n√∫mero de arquivos PCAP [ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">8</a> ].  Embora esse teste n√£o se refira especificamente √† gera√ß√£o de pacotes, ele serve como demonstra√ß√£o do fato de que o elo mais fraco da organiza√ß√£o da transfer√™ncia de dados pelo espa√ßo do usu√°rio √© o sistema de arquivos.  At√© o sistema de arquivos virtual tmpfs diminui significativamente o fluxo.  Nesse caso, s√£o necess√°rios 8 n√∫cleos do processador central para a utiliza√ß√£o de 14,88 Mpps, enquanto apenas um n√∫cleo √© suficiente para receber (e redefinir ou redirecionar) a mesma quantidade de tr√°fego. <br><br>  A tabela a seguir mostra a quantidade de tr√°fego (em Mpps) recebido e salvo nos arquivos PCAP localizados no sistema de arquivos ext2 no SSD (segunda coluna) ou no sistema de arquivos tmpfs (terceira coluna). <br><table><tbody><tr><td>  <b>n√∫cleos</b> </td><td>  <b>em SSD, Mpps</b> </td><td>  <b>em tmpfs, Mpps</b> </td></tr><tr><td>  1 </td><td>  1,48 </td><td>  1,62 </td></tr><tr><td>  2 </td><td>  4 </td><td>  4.6 </td></tr><tr><td>  3 </td><td>  6,94 </td><td>  8.1 </td></tr><tr><td>  4 </td><td>  9,75 </td><td>  11,65 </td></tr><tr><td>  5 </td><td>  12,1 </td><td>  13,8 </td></tr><tr><td>  6 </td><td>  13,38 </td><td>  14,47 </td></tr><tr><td>  7 </td><td>  14,4 </td><td>  14,86 </td></tr><tr><td>  8 </td><td>  14,88 </td><td>  14,88 </td></tr></tbody></table><br>  <i>Teste de Rx para pcap;</i>  <i>NIC: Intel 82599ES 10 Gigabit;</i>  <i>CPU: CPU Intel¬Æ Xeon¬Æ E5-2683 v4 a 2.10GHz</i> <br><br><h2>  Modifica√ß√£o MoonGen: Gerenciador de tarefas tman </h2><br>  Tamb√©m gostar√≠amos de apresentar ao leitor nossa pr√≥pria extens√£o da funcionalidade MoonGen, que fornece outra maneira de iniciar um grupo de tarefas para teste.  A id√©ia principal aqui √© separar a configura√ß√£o geral e as configura√ß√µes espec√≠ficas de cada tarefa, permitindo executar um n√∫mero arbitr√°rio de tarefas diferentes (por exemplo, scripts Lua) ao mesmo tempo.  No nosso clone do reposit√≥rio MoonGen, √© apresentada a implementa√ß√£o do MoonGen com o gerenciador de tarefas [ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">9</a> ], aqui apenas listaremos brevemente suas principais fun√ß√µes. <br><br>  A nova interface da linha de comandos permite executar v√°rias tarefas de diferentes tipos simultaneamente.  O cen√°rio b√°sico √© o seguinte: <br><br><pre> <code class="bash hljs">./build/tman [tman options...] [-- &lt;task1-file&gt; [task1 options...]] [-- &lt;task2-file&gt; [task2 options...]] [-- ...]</code> </pre> <br>  Al√©m disso, ./build/tman -h fornece ajuda detalhada. <br><br>  No entanto, h√° uma limita√ß√£o - os arquivos regulares de tarefas Lua n√£o s√£o compat√≠veis com a interface <i>tman</i> .  O <i>arquivo de</i> trabalho <i>tman</i> deve definir claramente os seguintes objetos: <br><br><ul><li>  A fun√ß√£o configure (analisador) que descreve os par√¢metros do trabalho; </li><li>  A fun√ß√£o de tarefa (taskNum, txInfo, rxInfo, args), que descreve o processo real da tarefa.  Aqui txInfo e rxInfo s√£o matrizes de filas RX e TX, respectivamente;  args cont√©m os par√¢metros do gerenciador de tarefas e da pr√≥pria tarefa. </li><li>  Exemplos podem ser encontrados em examples / tman. </li></ul><br>  O uso do gerenciador de tarefas oferece mais flexibilidade na execu√ß√£o de testes heterog√™neos. <br><br><h3>  Conclus√µes </h3><br>  O m√©todo oferecido pela MoonGen mostrou-se bem adequado aos nossos objetivos e satisfez os funcion√°rios com os resultados obtidos.  Temos uma ferramenta com alto desempenho, mantendo o ambiente de teste e o idioma bastante simples.  O alto desempenho dessa configura√ß√£o √© alcan√ßado gra√ßas a dois recursos principais: acesso direto aos buffers do controlador de interface de rede e t√©cnica de compila√ß√£o Just-In-Time em Lua. <br><br>  Como regra, atingir um teto te√≥rico para o desempenho de um controlador de interface de rede √© uma tarefa vi√°vel.  Como mostramos, um √∫nico n√∫cleo pode ser suficiente para saturar uma porta 10G, enquanto uma carga completa de uma porta 100G n√£o √© um problema com um n√∫mero maior de n√∫cleos. <br><br>  Somos especialmente gratos √† equipe da Mellanox por sua ajuda com seus equipamentos e √† equipe MoonGen por sua rea√ß√£o √† corre√ß√£o dos erros. <br><br><h2>  Materiais </h2><br><ol><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">MoonGen: um gerador de pacotes de alta velocidade com script - Paul Emmerich et al., Internet Measurement Conference 2015 (IMC'15), 2015</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Pktgen</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Guia de ajuste da Mellanox</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Kit de desenvolvimento de plano de dados</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Lua</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Syn flood</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Clone do reposit√≥rio MoonGen do Qrator Labs</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Formato de arquivo PCAP</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Gerenciador de tarefas</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Desempenho Lua</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">White paper sobre virtualiza√ß√£o de fun√ß√µes de rede</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">NUMA, acesso n√£o uniforme √† mem√≥ria</a> </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt423957/">https://habr.com/ru/post/pt423957/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt423945/index.html">A Suprema Corte especificou o procedimento para considerar casos com republica√ß√µes e curtidas</a></li>
<li><a href="../pt423947/index.html">Nossos dados pessoais n√£o custam nada</a></li>
<li><a href="../pt423949/index.html">Um universo consistente com nossas cren√ßas atuais pode n√£o ser poss√≠vel.</a></li>
<li><a href="../pt423953/index.html">Fun√ß√£o humana ou parar de contratar tecnologia</a></li>
<li><a href="../pt423955/index.html">Como criamos um produto tecnol√≥gico e ca√≠mos no fundo</a></li>
<li><a href="../pt423959/index.html">Caixas Subaqu√°ticas - Para Rob√¥s</a></li>
<li><a href="../pt423961/index.html">N√£o se perca: um novo m√©todo para diagnosticar dem√™ncia</a></li>
<li><a href="../pt423963/index.html">Kelvin Point Prologue</a></li>
<li><a href="../pt423965/index.html">Voc√™ comprou o SIEM e tem certeza de que o SOC est√° no seu bolso, certo?</a></li>
<li><a href="../pt423967/index.html">Toda a verdade sobre o RTOS. Artigo 10. Agendador: recursos avan√ßados e preserva√ß√£o de contexto</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>