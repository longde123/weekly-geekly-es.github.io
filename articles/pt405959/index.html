<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®‚Äçüè≠ üë©‚Äçüè´ üëêüèº LED piscando no STM32 na montadora üè∏ üë©üèæ‚Äçüç≥ ü§û</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Algum tempo atr√°s, eu queria aprender montador e, depois de ler a literatura relevante, era hora de praticar. Na verdade, ser√° discutido mais adiante....">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>LED piscando no STM32 na montadora</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/405959/">  Algum tempo atr√°s, eu queria aprender montador e, depois de ler a literatura relevante, era hora de praticar.  Na verdade, ser√° discutido mais adiante.  No come√ßo, pratiquei no Arduino Uno (Atmega328p), agora decidi seguir em frente e assumi o STM32.  O STM32F103C8 realmente caiu em minhas m√£os e outras experi√™ncias ser√£o realizadas. <br><br><h2>  As ferramentas </h2><br>  Eu usei as seguintes ferramentas: <br><br><ul><li>  Notepad ++ - para escrever c√≥digo </li><li>  Compilador GNU Assembler </li><li>  Utilit√°rio STM32 ST-LINK + ST-LINK V2 - para exibir o c√≥digo no microcontrolador e depurar </li></ul><br><h2>  Iniciar </h2><br>  O principal objetivo da linguagem assembly para mim √© aprender.  Como voc√™ nunca sabe onde encontrar outro problema interessante, foi decidido escrever tudo do zero.  A principal tarefa foi entender como o vetor de interrup√ß√£o funciona.  Diferentemente do Atmega no STM32, o vetor de interrup√ß√£o n√£o cont√©m instru√ß√µes de salto: <br><br><pre><code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">jmp</span></span> main</code> </pre> <br>  Endere√ßos espec√≠ficos est√£o escritos nele e, durante a interrup√ß√£o, o pr√≥prio processador substitui o endere√ßo especificado no vetor no registro do PC.  Aqui est√° um exemplo do meu vetor de interrup√ß√£o: <br><br><pre> <code class="hljs css"><span class="hljs-selector-class"><span class="hljs-selector-class">.org</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x00000000</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SP</span></span>: <span class="hljs-selector-class"><span class="hljs-selector-class">.word</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">STACKINIT</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">RESET</span></span>: <span class="hljs-selector-class"><span class="hljs-selector-class">.word</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">main</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">NMI_HANDLER</span></span>: <span class="hljs-selector-class"><span class="hljs-selector-class">.word</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">nmi_fault</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">HARD_FAULT</span></span>: <span class="hljs-selector-class"><span class="hljs-selector-class">.word</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">hard_fault</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">MEMORY_FAULT</span></span>: <span class="hljs-selector-class"><span class="hljs-selector-class">.word</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">memory_fault</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">BUS_FAULT</span></span>: <span class="hljs-selector-class"><span class="hljs-selector-class">.word</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">bus_fault</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">USAGE_FAULT</span></span>: <span class="hljs-selector-class"><span class="hljs-selector-class">.word</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">usage_fault</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.org</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x000000B0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">TIMER2_INTERRUPT</span></span>: <span class="hljs-selector-class"><span class="hljs-selector-class">.word</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">timer2_interupt</span></span> + 1</code> </pre><br>  Quero chamar a aten√ß√£o do leitor para o fato de que a primeira linha n√£o √© o vetor de redefini√ß√£o, mas os valores pelos quais a pilha ser√° inicializada.  Imediatamente ap√≥s, h√° um vetor de redefini√ß√£o seguido por 5 vetores de interrup√ß√£o obrigat√≥rios (NMI_HANDLER - USAGE_FAULT). <br><a name="habracut"></a><br><h2>  Desenvolvimento </h2><br>  A primeira coisa com a qual fiquei presa foi a sintaxe do assembler do ARM.  Mesmo durante o estudo do vetor de interrup√ß√£o, me deparei com refer√™ncias ao fato de o ARM ter 2 tipos de instru√ß√µes Thumb e n√£o Thumb.  E que o Cortex-M3 (STM32F103C8, ou seja, o Cortex-M3) suporta apenas um conjunto de instru√ß√µes Thumb.  Escrevi as instru√ß√µes estritamente de acordo com a documenta√ß√£o, mas por alguma raz√£o o montador as xingou. <blockquote>  registro n√£o deslocado necess√°rio </blockquote>  Verificou-se que no in√≠cio do programa <blockquote>  .syntax unificado </blockquote>  isso informa ao montador que voc√™ pode usar as instru√ß√µes Thumb e n√£o Thumb ao mesmo tempo. <br><br>  A pr√≥xima coisa que me deparei foi com as portas GPOI padr√£o desativadas.  Para faz√™-los funcionar, entre outras coisas, voc√™ precisa definir os valores apropriados nos registros RCC (reset e controle de rel√≥gio).  Eu usei o PORT C, ele pode ser ativado configurando o bit 4 (a numera√ß√£o de bits come√ßa do zero) em RCC_APB2ENR (registro de ativa√ß√£o do rel√≥gio perif√©rico 2). <br><br>  Mais LED piscando.  Primeiro de tudo, como no Arduino, voc√™ precisa definir um pino para a grava√ß√£o.  Isso √© feito via GPIOx_CRL (registro de controle baixo) ou GPIOx_CRH (registro de controle alto).  Aqui √© necess√°rio cancelar que, para cada pino, 4 bits sejam respons√°veis ‚Äã‚Äãem um desses registros (registros de 32 bits).  2 bits (MODEy) determinam a taxa m√°xima de dados e a configura√ß√£o de pinos de 2 bits (CNF).  Usei o pino C da PORTA 14, para isso defino os bits [25:24] = 10 e os bits [27:26] = 00 no registro GPIOx_CRH. <br><br>  Para o diodo queimar, √© necess√°rio definir o bit correspondente em GPIOx_ODR (registro de dados de sa√≠da).  No meu caso, bit 14. Isso poderia encerrar este exemplo simples, criando uma fun√ß√£o de atraso e colocando tudo em um loop, mas eu n√£o poderia fazer isso.  Decidi definir interrup√ß√µes no temporizador ... Como se viu, foi em v√£o, principalmente porque os temporizadores s√£o muito r√°pidos para esse tipo de tarefa. <br><br>  N√£o descreverei em detalhes as configura√ß√µes do timer, que est√£o interessadas no c√≥digo no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Github</a> .  A id√©ia era simples: em um ciclo, envie o processador para Idle, saia do Idle pelo timer para ligar / desligar o LED e novamente para Idle.  Mas o timer funcionou muito mais r√°pido do que eu consegui fazer todas as op√ß√µes acima, por causa do qual tive que inserir um contador adicional. <br><br>  O contador √© uma vari√°vel de 32 bits que deveria estar na SRAM.  E ent√£o outro ancinho estava me esperando.  Quando programei no Atmega para colocar uma vari√°vel na SRAM, atrav√©s do .org, defina o endere√ßo do in√≠cio da mem√≥ria onde o bloco de dados foi realmente colocado.  Agora, depois de ler um pouco sobre a inicializa√ß√£o da mem√≥ria, n√£o tenho certeza se isso estava correto, mas funcionou.  E eu decidi p√¥r em marcha a mesma coisa com o STM32.  O endere√ßo inicial da mem√≥ria no STM32F103C8 √© 0x20000000.  E quando eu fiz .org neste endere√ßo, recebi um bin√°rio de 512mb.  Isso me enviou algumas noites para fumar manuais.  Ainda n√£o entendo 100% como isso funciona, mas at√© onde eu entendo a se√ß√£o .data coloca os valores pelos quais as vari√°veis ‚Äã‚Äãdevem ser inicializadas em um arquivo execut√°vel, mas, em tempo de execu√ß√£o, o programador deve inicializar os valores das vari√°veis ‚Äã‚Äãna mem√≥ria.  Corrija-me, por favor, se eu estiver errado.  Acabei criando uma vari√°vel como esta: <br><br><pre> <code class="hljs css"><span class="hljs-selector-class"><span class="hljs-selector-class">.section</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.bss</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.offset</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x20000000</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">flash_counter</span></span>: <span class="hljs-selector-class"><span class="hljs-selector-class">.word</span></span></code> </pre><br>  Inicializou no in√≠cio da fun√ß√£o principal e o LED piscou.  Espero que este artigo ajude algu√©m.  Se voc√™ tiver d√∫vidas, terei prazer em respond√™-las. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt405959/">https://habr.com/ru/post/pt405959/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt405949/index.html">Como um copo de el√©tron matou</a></li>
<li><a href="../pt405951/index.html">Moderniza√ß√£o da "placa" sob a l√¢mpada GX70</a></li>
<li><a href="../pt405953/index.html">Not√≠cias de neurobiologia: o c√©rebro sem sono come a si pr√≥prio, o chap√©u m√°gico de Elon Mask, o cortador de chaves e algo mais</a></li>
<li><a href="../pt405955/index.html">As tentativas dos cientistas de dissipar os mitos da vacina√ß√£o apenas fortaleceram as ilus√µes das pessoas</a></li>
<li><a href="../pt405957/index.html">Um erro de software travou centenas de bloqueios inteligentes</a></li>
<li><a href="../pt405961/index.html">ARMOR BOOT 2017: maior, mais frio, mais forte</a></li>
<li><a href="../pt405963/index.html">Uma liga√ß√£o da lua: uma startup alem√£ est√° prestes a instalar uma esta√ß√£o base LTE no sat√©lite da Terra</a></li>
<li><a href="../pt405965/index.html">APIs de geolocaliza√ß√£o: geolocaliza√ß√£o IP ou W3C?</a></li>
<li><a href="../pt405967/index.html">Armas secretas ou por que pin√°culos de arranha-c√©us</a></li>
<li><a href="../pt405969/index.html">Os quatro grandes operadores n√£o cumpriram o requisito da FAS de cancelar o roaming nacional na Federa√ß√£o Russa</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>