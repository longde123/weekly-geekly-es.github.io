<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üõçÔ∏è üåæ üë≥ O que acontece ao conectar dentro e fora de um t√∫nel VPN üìé üë®üèª‚Äç‚öñÔ∏è üçì</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Das cartas ao suporte t√©cnico de Tucha, esses artigos nascem. Portanto, recentemente, um cliente entrou em contato conosco com uma solicita√ß√£o para es...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>O que acontece ao conectar dentro e fora de um t√∫nel VPN</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/477854/"> Das cartas ao suporte t√©cnico de Tucha, esses artigos nascem.  Portanto, recentemente, um cliente entrou em contato conosco com uma solicita√ß√£o para esclarecer o que acontece ao conectar-se dentro de um t√∫nel VPN entre o escrit√≥rio do usu√°rio e o ambiente na nuvem, bem como ao conectar-se fora do t√∫nel VPN.  Portanto, o texto inteiro abaixo √© uma carta real que enviamos a um dos clientes em resposta √† sua pergunta.  Evidentemente, alteramos os endere√ßos IP para n√£o anonimizar o cliente.  Mas, sim, o suporte t√©cnico da Tucha √© realmente famoso por suas respostas abrangentes e cartas informativas.  :-) <br><br>  Obviamente, entendemos que, para muitos, este artigo n√£o ser√° uma revela√ß√£o.  Por√©m, como os artigos para administradores iniciantes aparecem periodicamente no Habr e tamb√©m porque esse artigo apareceu de uma carta real para um cliente real, ainda compartilharemos essas informa√ß√µes aqui.  H√° uma alta probabilidade de que seja √∫til para algu√©m. <br>  Portanto, explicamos em detalhes o que acontece entre o servidor na nuvem e o escrit√≥rio se eles estiverem conectados por uma rede site a site.  Observe que, nesse caso, parte dos servi√ßos est√° dispon√≠vel apenas no escrit√≥rio e parte - de qualquer lugar da Internet. <br><br>  Explicaremos imediatamente que nosso cliente desejava poder <b>acessar</b> o servidor <b>192.168.A.1</b> de qualquer lugar via RDP, conectando-se ao <b>AAA2: 13389</b> e a outros servi√ßos apenas do escrit√≥rio <b>(192.168.B.0 / 24)</b> conectado por meio de VPN  Al√©m disso, o cliente foi configurado inicialmente para que a m√°quina <b>192.168.B.2</b> no escrit√≥rio tamb√©m pudesse ser acessada via RDP de qualquer lugar, conectando-se ao <b>BBB1: 11111</b> .  Ajudamos a organizar as conex√µes IPSec entre a nuvem e o escrit√≥rio, e o especialista em TI do cliente come√ßou a fazer perguntas sobre o que aconteceria neste ou naquele caso.  Para responder a todas essas perguntas, de fato, escrevemos para ele tudo o que voc√™ pode ler abaixo. <br><a name="habracut"></a><br><img src="https://habrastorage.org/webt/yi/h8/nm/yih8nmxyw3h1kvhvrv8grwlqt14.jpeg"><br><p>  Agora considere esses processos com mais detalhes. </p><br><h3>  Primeira posi√ß√£o </h3><br>  Quando algo √© enviado de <b>192.168.B.0 / 24</b> para <b>192.168.A.0 / 24</b> ou de <b>192.168.A.0 / 24</b> para <b>192.168.B.0 / 24</b> , ele entra na VPN.  Ou seja, esse pacote √© adicionalmente criptografado e transmitido entre <b>BBB1</b> e <b>AAA1</b> , mas <b>192.168.A.1</b> v√™ exatamente o pacote de <b>192.168.B.1</b> .  Eles podem se comunicar atrav√©s de qualquer protocolo.  As respostas de retorno tamb√©m s√£o transmitidas via VPN da mesma maneira, o que significa que o pacote de <b>192.168.A.1</b> para <b>192.168.B.1</b> ser√° enviado como um datagrama ESP de <b>AAA1</b> para <b>BBB1</b> , que o roteador implantar√° do outro lado, <b>pegar√°</b> esse pacote e o enviar√° para <b>192.168.B.1</b> como um pacote de <b>192.168.A.1</b> . <br><br>  Exemplo concreto: <br><br>  1) <b>192.168.B.1</b> acessa <b>192.168.A.1</b> , deseja estabelecer uma conex√£o TCP com <b>192.168.A.1: 3389</b> ; <br><br>  2) <b>192.168.B.1</b> envia uma solicita√ß√£o para estabelecer uma conex√£o a partir de <b>192.168.B.1: 55555</b> (ele seleciona a porta para feedback, a seguir usaremos o n√∫mero 55555 como exemplo do n√∫mero da porta que o sistema seleciona ao gerar TCP- conex√µes) a <b>192.168.A.1: 3389</b> ; <br><br>  3) o sistema operacional executado no computador com o endere√ßo <b>192.168.B.1</b> decide transferir este pacote para o endere√ßo de gateway do roteador ( <b>192.168.B.254</b> no nosso caso), porque existem outras rotas mais espec√≠ficas para <b>192.168.A.1</b> , portanto, ele n√£o passa o pacote ao longo da rota padr√£o (0.0.0.0/0); <br><br>  4) para isso, ela tenta encontrar o endere√ßo MAC para o endere√ßo IP <b>192.168.B.254</b> na tabela de cache do protocolo ARP.  Se n√£o for encontrado, envia do endere√ßo <b>192.168.B.1 uma</b> transmiss√£o que possui solicita√ß√£o para a rede <b>192.168.B.0 / 24</b> .  Quando <b>192.168.B.254</b> devolve seu endere√ßo MAC, o sistema envia um pacote Ethernet para ele e armazena essas informa√ß√µes em sua tabela de cache; <br><br>  5) o roteador recebe esse pacote e decide para onde envi√°-lo: possui uma pol√≠tica de transmiss√£o de todos os pacotes entre <b>192.168.B.0 / 24</b> e <b>192.168.A.0 / 24</b> atrav√©s de uma conex√£o VPN entre <b>BBB1</b> e <b>AAA1</b> ; <br><br>  6) o roteador gera um datagrama ESP de <b>BBB1</b> a <b>AAA1</b> ; <br><br>  7) o roteador decide a quem enviar esse pacote, enviando-o para, digamos, <b>BBB254</b> (gateway do provedor de Internet), porque n√£o possui rotas mais espec√≠ficas para <b>AAA1</b> que 0.0.0.0/0; <br><br>  8) da mesma forma como j√° mencionado, encontra o endere√ßo MAC para <b>BBB254</b> e envia o pacote para o gateway do provedor de Internet; <br><br>  9) Os provedores de Internet transmitem atrav√©s de suas redes o datagrama ESP de <b>BBB1</b> a <b>AAA1</b> ; <br><br>  10) o roteador virtual em <b>AAA1</b> recebe esse datagrama, descriptografa-o e recebe um pacote de <b>192.168.B.1: 55555</b> para <b>192.168.A.1: 3389</b> ; <br><br>  11) o roteador virtual verifica para quem deve ser enviado, encontra a rede <b>192.168.A.0 / 24</b> na tabela de roteamento e a envia diretamente para <b>192.168.A.1</b> , pois possui uma interface <b>192.168.A.254 / 24</b> ; <br><br>  12) para isso, o roteador virtual encontra o endere√ßo MAC para <b>192.168.A.1</b> e passa esse pacote para ele atrav√©s da rede Ethernet virtual; <br><br>  13) <b>192.168.A.1</b> recebe esse pacote na porta 3389, concorda em estabelecer uma conex√£o e forma um pacote em resposta de <b>192.168.A.1: 3389</b> a <b>192.168.B.1: 55555</b> ; <br><br>  14) seu sistema envia esse pacote para o endere√ßo de gateway do roteador virtual ( <b>192.168.A.254</b> no nosso caso), porque n√£o possui outras rotas mais espec√≠ficas para <b>192.168.B.1</b> ; portanto, ele deve transmitir o pacote ao longo da rota padr√£o (0.0.0.0/0); <br><br>  15) da mesma maneira que nos casos anteriores, o sistema que roda no servidor com o endere√ßo <b>192.168.A.1</b> encontra o endere√ßo MAC <b>192.168.A.254</b> , pois est√° na mesma rede com sua interface <b>192.168.A.1 / 24</b> ; <br><br>  16) o roteador virtual recebe esse pacote e decide para onde envi√°-lo: possui uma pol√≠tica de transmiss√£o de todos os pacotes entre <b>192.168.A.0 / 24</b> e <b>192.168.B.0 / 24</b> atrav√©s de uma conex√£o VPN entre <b>AAA1</b> e <b>BBB1</b> ; <br><br>  17) o roteador virtual gera um datagrama ESP de <b>AAA1</b> para <b>BBB1</b> ; <br><br>  18) o roteador virtual decide para quem esse pacote deve ser enviado, o envia para <b>AAA254</b> (o gateway do provedor de Internet, neste caso, tamb√©m somos n√≥s), porque n√£o possui rotas mais espec√≠ficas para <b>BBB1 do</b> que 0.0.0.0/0; <br><br>  19) Os provedores de Internet transmitem atrav√©s de suas redes um datagrama ESP de <b>AAA1</b> para <b>BBB1</b> ; <br><br>  20) o roteador no <b>BBB1</b> recebe esse datagrama, descriptografa-o e recebe um pacote de <b>192.168.A.1: 3389</b> para <b>192.168.B.1: 55555</b> ; <br><br>  21) ele entende que deve ser transmitido para <b>192.168.B.1</b> , pois ele est√° na mesma rede com ele, portanto, ele tem uma entrada correspondente na tabela de roteamento que o obriga a enviar pacotes para todo o <b>192.168.B.0 / 24</b> diretamente; <br><br>  22) o roteador encontra o endere√ßo MAC para <b>192.168.B.1</b> e envia esse pacote; <br><br>  23) o sistema operacional no computador com o endere√ßo <b>192.168.B.1</b> recebe um pacote de <b>192.168.A.1: 3389</b> para <b>192.168.B.1: 55555</b> e inicia as seguintes etapas para estabelecer uma conex√£o TCP. <br><br>  Este exemplo √© bastante conciso e simplista (e aqui voc√™ pode se lembrar de v√°rios detalhes) descrevendo o que acontece nos n√≠veis 2-4.  Os n√≠veis 1, 5-7 n√£o s√£o considerados. <br><br><h3>  Segunda posi√ß√£o </h3><br>  Se algo for enviado especificamente para <b>AAA2 a</b> partir de <b>192.168.B.0 / 24</b> , ele n√£o ser√° direcionado √† VPN, mas diretamente.  Ou seja, se um usu√°rio do endere√ßo <b>192.168.B.1</b> acessa <b>AAA2: 13389</b> , esse pacote √© desfiado do endere√ßo <b>BBB1</b> , passa para <b>AAA2</b> , e a√≠ o roteador o recebe e envia para <b>192.168.A.1</b> .  <b>192.168.A.1</b> n√£o sabe nada sobre <b>192.168.B.1</b> , ele v√™ um pacote do <b>BBB1</b> , porque ele o entendeu.  Portanto, a resposta a esta solicita√ß√£o segue a rota geral, exatamente o mesmo vai do endere√ßo <b>AAA2</b> e vai para <b>BBB1</b> , e esse roteador fornece essa resposta para <b>192.168.B.1</b> , e v√™ a resposta de <b>AAA2</b> , para a qual se dirigiu. <br><br>  Exemplo concreto: <br><br>  1) <b>192.168.B.1</b> endere√ßa <b>AAA2</b> , deseja estabelecer uma conex√£o TCP com <b>AAA2: 13389</b> ; <br><br>  2) <b>192.168.B.1</b> envia uma solicita√ß√£o para estabelecer uma conex√£o de <b>192.168.B.1: 55555</b> (esse n√∫mero, como no exemplo anterior, pode ser diferente) para <b>AAA2: 13389</b> ; <br><br>  3) o sistema operacional que √© executado no computador com o endere√ßo <b>192.168.B.1</b> decide transferir esse pacote para o endere√ßo de gateway do roteador ( <b>192.168.B.254</b> no nosso caso), porque n√£o possui outras rotas mais espec√≠ficas para <b>AAA2</b> , o que significa que ele envia o pacote ao longo da rota padr√£o (0.0.0.0/0); <br><br>  4) para isso, ela, como mencionamos no exemplo anterior, tenta encontrar o endere√ßo MAC para o endere√ßo IP <b>192.168.B.254</b> na tabela de cache do protocolo ARP.  Se n√£o for encontrado, envia do endere√ßo <b>192.168.B.1 uma</b> transmiss√£o que possui solicita√ß√£o para a rede <b>192.168.B.0 / 24</b> .  Quando <b>192.168.B.254</b> devolve seu endere√ßo MAC, o sistema envia um pacote Ethernet para ele e armazena essas informa√ß√µes em sua tabela de cache; <br><br>  5) o roteador recebe esse pacote e decide para onde envi√°-lo: possui uma pol√≠tica que deve encaminhar (substituindo o endere√ßo de retorno) todos os pacotes de <b>192.168.B.0 / 24</b> para outros n√≥s da Internet; <br><br>  6) como essa pol√≠tica implica que o endere√ßo de retorno deve coincidir com o endere√ßo mais baixo na interface atrav√©s da qual esse pacote ser√° transmitido, o roteador primeiro decide para quem exatamente esse pacote deve ser transmitido e ele, como no exemplo anterior, deve envi√°-lo para <b>BBB254</b> (Gateway de Provedor de Servi√ßos de Internet), porque n√£o possui rotas mais espec√≠ficas para <b>AAA2</b> que 0.0.0.0/0; <br><br>  7) portanto, o roteador substitui o endere√ßo de retorno do pacote, doravante o pacote de <b>BBB1: 44444</b> (o n√∫mero da porta, √© claro, pode ser diferente) para <b>AAA2: 13389</b> ; <br><br>  8) o roteador lembra o que fez, o que significa que, quando uma <b>resposta √© recebida</b> de <b>AAA2: 13389</b> para <b>BBB1: 44444</b> , ele saber√° que deve alterar o endere√ßo e a porta do destinat√°rio para <b>192.168.B.1: 55555</b> . <br><br>  9) agora o roteador deve transferi-lo para a rede do provedor de Internet via <b>BBB254</b> ; portanto, da mesma forma que j√° mencionamos, encontra o endere√ßo MAC para <b>BBB254</b> e envia o pacote para o gateway do provedor de Internet; <br><br>  10) Os provedores de Internet transferem um pacote de <b>BBB1</b> para <b>AAA2</b> em suas redes; <br><br>  11) o roteador virtual no <b>AAA2</b> recebe esse pacote na porta 13389; <br><br>  12) existe uma regra no roteador virtual que estipula que os pacotes que vieram de qualquer remetente para esta porta devem ser enviados para <b>192.168.A.1: 3389</b> ; <br><br>  13) o roteador virtual encontra a rede <b>192.168.A.0 / 24</b> na tabela de roteamento e a envia diretamente para <b>192.168.A.</b>  1, porque possui uma interface <b>192.168.A.254 / 24</b> ; <br><br>  14) para isso, o roteador virtual encontra o endere√ßo MAC para <b>192.168.A.1</b> e passa esse pacote para ele atrav√©s da rede Ethernet virtual; <br><br>  15) <b>192.168.A.1</b> recebe esse pacote na porta 3389, concorda em estabelecer uma conex√£o e forma um pacote em resposta a <b>192.168.A.1: 3389</b> no <b>BBB1: 44444</b> ; <br><br>  16) seu sistema envia esse pacote para o endere√ßo de gateway do roteador virtual ( <b>192.168.A.254</b> no nosso caso), porque n√£o possui outras rotas mais espec√≠ficas para <b>BBB1</b> , portanto, deve transmitir o pacote ao longo da rota padr√£o (0.0. 0,0 / 0); <br><br>  17) da mesma maneira que nos casos anteriores, o sistema que roda no servidor com o endere√ßo <b>192.168.A.1</b> encontra o endere√ßo MAC <b>192.168.A.254</b> , pois est√° na mesma rede com sua interface <b>192.168.A.1 / 24</b> ; <br><br>  18) O roteador virtual aceita este pacote.  Deve-se observar que ele lembra que recebeu um pacote de <b>BBB1: 44444</b> em <b>AAA2: 13389</b> e alterou o endere√ßo e a porta do destinat√°rio para <b>192.168.A.1: 3389</b> ; portanto, ele altera o pacote de <b>192.168.A.1: 3389</b> para <b>BBB1: 44444</b> endere√ßo do remetente em <b>AAA2: 13389</b> ; <br><br>  19) o roteador virtual decide para quem esse pacote deve ser enviado; ele o envia para <b>AAA254</b> (o gateway do provedor de Internet, neste caso, tamb√©m somos n√≥s), porque n√£o possui rotas mais espec√≠ficas para <b>BBB1 do</b> que 0.0.0.0/0; <br><br>  20) Os provedores de Internet transferem um pacote de <b>AAA2</b> para <b>BBB1</b> em suas redes; <br><br>  21) o roteador no <b>BBB1</b> recebe esse pacote e lembra que, quando enviou o pacote de <b>192.168.B.1: 55555</b> para <b>AAA2: 13389</b> , mudou seu endere√ßo e porta de remetente para <b>BBB1: 44444</b> , o que significa que esta √© a resposta que precisa ser transmitida em <b>192.168.B.1: 55555</b> (de fato, h√° v√°rias outras verifica√ß√µes, mas n√£o fazemos isso); <br><br>  22) ele entende que eles devem ser enviados diretamente para <b>192.168.B.1</b> , uma vez que ele est√° na mesma rede com ele, portanto, ele tem uma entrada correspondente na tabela de roteamento que o obriga a enviar pacotes para todo o <b>192.168.B.0 / 24</b> diretamente; <br><br>  23) o roteador encontra o endere√ßo MAC para <b>192.168.B.1</b> e envia esse pacote; <br><br>  24) o sistema operacional no computador com o endere√ßo <b>192.168.B.1</b> recebe um pacote de <b>AAA2: 13389</b> para <b>192.168.B.1: 55555</b> e inicia as seguintes etapas para estabelecer uma conex√£o TCP. <br><br>  Observe que, nesse caso, o computador com o endere√ßo <b>192.168.B.1</b> n√£o sabe nada sobre o servidor com o endere√ßo <b>192.168.A.1</b> , ele se comunica apenas com o <b>AAA2</b> .  Da mesma forma, o servidor com o endere√ßo <b>192.168.A.1</b> n√£o sabe nada sobre o computador com o endere√ßo <b>192.168.B.1</b> .  Ele acredita que eles se conectaram a ele pelo endere√ßo <b>BBB1</b> , e ele n√£o sabe mais nada, por assim dizer. <br><br>  Observe tamb√©m que, se este computador acessar <b>AAA2: 1540</b> , a conex√£o n√£o ser√° estabelecida, porque o encaminhamento de conex√£o para a porta 1540 n√£o est√° configurado no roteador virtual, mesmo que em servidores da rede virtual <b>192.168.A.0 / 24</b> (por exemplo, em um servidor com o endere√ßo <b>192.168.A.1</b> ) e existem alguns servi√ßos que est√£o aguardando uma conex√£o nessa porta.  Se o usu√°rio do computador com o endere√ßo <b>192.168.B.1 for</b> absolutamente necess√°rio para estabelecer uma conex√£o com este servi√ßo, ele dever√° usar uma VPN, ou seja,  entre em contato diretamente no <b>192.168.A.1: 1540</b> . <br><br>  Deve-se enfatizar que quaisquer tentativas de estabelecer uma conex√£o com <b>AAA1</b> (exceto a conex√£o IPSec de <b>BBB1</b> n√£o ser√£o bem-sucedidas. Todas as tentativas de estabelecer uma conex√£o com <b>AAA2</b> , exceto as conex√µes com a porta 13389, tamb√©m falhar√£o. <br>  Observe tamb√©m que, se algu√©m <b>chamar AAA2</b> (por exemplo, UDP), tudo o que √© indicado nos par√°grafos 10 a 20 tamb√©m se aplicar√° a ele.  O que acontece antes e depois depende do que exatamente est√° por tr√°s disso. N√£o possu√≠mos essas informa√ß√µes, portanto, recomendamos que voc√™ consulte os administradores do site com o endere√ßo do endere√ßo. <br><br><h3>  Terceira posi√ß√£o </h3><br>  E vice-versa, se algo √© enviado de <b>192.168.A.1</b> para alguma porta configurada para ser encaminhada para o BBB1 (por exemplo, 11111), ele tamb√©m n√£o entra na VPN, mas apenas <b>pega o AAA1</b> e acaba no <b>BBB1</b> e esse j√° est√° sendo transferido para algum lugar, digamos, <b>192.168.B.2: 3389</b> .  Ele v√™ este pacote n√£o de <b>192.168.A.1</b> , mas de <b>AAA1</b> .  E, quando <b>192.168.B.2</b> responde, o pacote passa de <b>BBB1</b> a <b>AAA1</b> e depois chega ao iniciador de conex√£o - <b>192.168.A.1</b> . <br><br>  Exemplo concreto: <br><br>  1) <b>192.168.A.1</b> aborda <b>BBB1</b> , deseja estabelecer uma conex√£o TCP com <b>BBB1: 11111</b> ; <br><br>  2) <b>192.168.A.1</b> envia uma solicita√ß√£o para estabelecer uma conex√£o a partir de <b>192.168.A.1: 55555</b> (esse n√∫mero, como no exemplo anterior, pode ser diferente) no <b>BBB1: 11111</b> ; <br><br>  3) o sistema operacional que roda no servidor com o endere√ßo <b>192.168.A.1</b> decide transferir esse pacote para o endere√ßo de gateway do roteador ( <b>192.168.A.254</b> no nosso caso), porque n√£o possui outras rotas mais espec√≠ficas para <b>BBB1</b> , portanto, ele envia o pacote ao longo da rota padr√£o (0.0.0.0/0); <br><br>  4) para isso, ela, como mencionamos nos exemplos anteriores, tenta encontrar o endere√ßo MAC para o endere√ßo IP <b>192.168.A.254</b> na tabela de cache do protocolo ARP.  Se n√£o for encontrado, envia do endere√ßo <b>192.168.A.1 uma</b> transmiss√£o que possui solicita√ß√£o para a rede <b>192.168.A.0 / 24</b> .  Quando <b>192.168.A.254</b> devolve seu endere√ßo MAC, o sistema transmite um pacote Ethernet para ele e insere essas informa√ß√µes em sua tabela de cache; <br><br>  5) o roteador virtual recebe esse pacote e decide para onde transferi-lo: possui uma pol√≠tica que deve encaminhar (substituindo o endere√ßo de retorno) todos os pacotes de <b>192.168.A.0 / 24</b> para outros n√≥s da Internet; <br><br>  6) como essa pol√≠tica assume que o endere√ßo de retorno deve coincidir com o endere√ßo mais baixo na interface pela qual esse pacote ser√° transmitido, o roteador virtual decide primeiro a quem exatamente esse pacote deve ser transmitido e ele, como no exemplo anterior, deve envi√°-lo no <b>AAA254</b> (o gateway do provedor de Internet, neste caso, tamb√©m somos n√≥s), porque n√£o possui rotas mais espec√≠ficas para <b>BBB1 do</b> que 0.0.0.0/0; <br><br>  7) significa que o roteador virtual substitui o endere√ßo de retorno do pacote; doravante, √© um pacote de <b>AAA1: 44444</b> (o n√∫mero da porta, √© claro, pode ser diferente) para <b>BBB1: 11111</b> ; <br><br>  8) o roteador virtual se lembra do que fez, portanto, quando uma <b>resposta √© recebida</b> de <b>BBB1: 11111</b> para <b>AAA1: 44444</b> , ele saber√° que deve alterar o endere√ßo e a porta do destinat√°rio para <b>192.168.A.1: 55555</b> . <br><br>  9) agora o roteador virtual deve transferi-lo para a rede do provedor de Internet atrav√©s do <b>AAA254</b> , o que significa que, como j√° mencionamos, ele encontra o endere√ßo MAC do <b>AAA254</b> e envia o pacote ao gateway do provedor de Internet; <br><br>  10) Os provedores de Internet transferem em suas redes um pacote de <b>AAA1 para BBB1</b> ; <br><br>  11) o roteador no <b>BBB1</b> recebe esse pacote na porta 11111; <br><br>  12) existe uma regra no roteador virtual, que estipula que os pacotes recebidos de qualquer remetente para essa porta sejam transmitidos para <b>192.168.B.2: 3389</b> ; <br><br>  13) o roteador encontra a rede <b>192.168.B.0 / 24</b> na tabela de roteamento e a envia diretamente para <b>192.168.B.2</b> , uma vez que possui uma interface <b>192.168.B.254 / 24</b> ; <br><br>  14) para isso, o roteador virtual encontra o endere√ßo MAC para <b>192.168.B.2</b> e passa esse pacote para ele atrav√©s da rede Ethernet virtual; <br><br>  15) <b>192.168.B.2</b> recebe esse pacote na porta 3389, concorda em estabelecer uma conex√£o e forma um pacote em resposta de <b>192.168.B.2: 3389</b> a <b>AAA1: 44444</b> ; <br><br>  16) seu sistema envia esse pacote para o endere√ßo de gateway do roteador ( <b>192.168.B.254</b> no nosso caso), porque n√£o possui outras rotas mais espec√≠ficas para <b>AAA1</b> ; portanto, deve passar o pacote pela rota padr√£o (0.0.0.0 / 0); <br><br>  17) da mesma forma que nos casos anteriores, o sistema que roda no computador com o endere√ßo <b>192.168.B.2</b> encontra o endere√ßo MAC <b>192.168.B.254</b> , pois est√° na mesma rede com sua interface <b>192.168.B.2 / 24</b> ; <br><br>  18) O roteador aceita este pacote.  Deve-se observar que ele lembra que recebeu um pacote de <b>AAA1</b> no <b>BBB1: 11111</b> e alterou o endere√ßo e a porta do destinat√°rio para <b>192.168.B.2: 3389</b> , portanto, ele altera o endere√ßo do remetente para um pacote de <b>192.168.B.2: 3389</b> para <b>AAA1: 44444</b> no <b>BBB1: 11111</b> ; <br><br>  19) O roteador decide para quem encaminhar este pacote.  Ele o envia para, digamos, <b>BBB254</b> (o gateway do provedor de Internet, cujo endere√ßo exato n√£o sabemos), porque ele n√£o possui rotas mais espec√≠ficas para <b>AAA1</b> que 0.0.0.0/0; <br><br>  20) Os provedores de Internet transferem um pacote de <b>BBB1</b> para <b>AAA1</b> em suas redes; <br><br>  21) o roteador virtual no <b>AAA1</b> recebe esse pacote e lembra que, quando enviou o pacote de <b>192.168.A.1: 55555</b> para <b>BBB1: 11111</b> , alterou o endere√ßo e a porta do remetente para <b>AAA1: 44444</b> .  Portanto, esta √© a resposta que precisa ser transmitida para <b>192.168.A.1: 55555</b> (de fato, como mencionamos no exemplo anterior, tamb√©m h√° mais algumas verifica√ß√µes por l√°, mas desta vez n√£o as analisamos tamb√©m); <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">22) ele entende que deve ser enviado diretamente para </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.A.1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , j√° que ele est√° na mesma rede com ele, o que significa que ele tem uma entrada correspondente na tabela de roteamento que o obriga a enviar pacotes para todo o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.A.0 / 24</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> diretamente; </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23) o roteador encontra o endere√ßo MAC para </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.A.1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e envia esse pacote; </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">24) o sistema operacional no servidor com o endere√ßo </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.A.1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> recebe um pacote de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BBB1: 1111</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 1 para </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.A.1: 55555</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e inicia as seguintes etapas para estabelecer uma conex√£o TCP. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Da mesma forma que no caso anterior, neste caso, o servidor com o endere√ßo </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.A.1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n√£o sabe nada sobre o computador com o endere√ßo </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.B.1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , ele se comunica apenas com </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BBB1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">O computador com o endere√ßo </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.B.1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tamb√©m n√£o sabe nada sobre o servidor com o endere√ßo </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.A.1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Ele acredita que eles se conectaram a ele pelo endere√ßo </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AAA1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , e o resto est√° oculto.</font></font><br><br><h3>  Conclus√£o </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√â assim que acontece ao conectar-se dentro de um t√∫nel VPN entre o escrit√≥rio do cliente e o ambiente na nuvem, bem como ao conectar-se fora do t√∫nel VPN. </font><font style="vertical-align: inherit;">E se voc√™ ainda tiver d√∫vidas ou precisar de nossa ajuda para solucionar problemas na nuvem, </font><a href="https://tucha.ua/ru/contacts"><font style="vertical-align: inherit;">entre em contato 24 horas por dia</font></a><font style="vertical-align: inherit;"> , </font></font><a href="https://tucha.ua/ru/contacts"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7 dias por semana.</font></font></a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt477854/">https://habr.com/ru/post/pt477854/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt477844/index.html">5 etapas da ideia √† aplica√ß√£o pr√°tica de aprendizado de m√°quina com o SAP Data Intelligence</a></li>
<li><a href="../pt477846/index.html">Resumo de eventos para profissionais de RH em TI de dezembro de 2019</a></li>
<li><a href="../pt477848/index.html">O pequeno segredo de um grande cora√ß√£o: o primeiro cardiograma de baleia azul da hist√≥ria</a></li>
<li><a href="../pt477850/index.html">Reagir nativo - uma bala de prata para todos os problemas? Como escolhemos uma ferramenta de plataforma cruzada para o Profi.ru</a></li>
<li><a href="../pt477852/index.html">Hipocrisia n√£o t√≥xica</a></li>
<li><a href="../pt477856/index.html">Aceleradores de flash PCI-E de 800 GB a 6,4 TB: do amanhecer √† vida em um PC / servidor comum</a></li>
<li><a href="../pt477858/index.html">Trabalho fora da mesa: que projetos realmente surgiram ap√≥s a pr√©-acelera√ß√£o?</a></li>
<li><a href="../pt477860/index.html">Como os servi√ßos de banco de dados gerenciados s√£o organizados no Yandex.</a></li>
<li><a href="../pt477862/index.html">E assim foi poss√≠vel? Ci√™ncia e TI em uma confer√™ncia</a></li>
<li><a href="../pt477864/index.html">TabPy para trabalhar com dados no ClickHouse do Tableau</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>